# Issue 20494: shortcut coercion for Integer-Rational operations

archive/issues_020494.json:
```json
{
    "body": "CC:  @jdemeyer\n\nKeywords: sd74\n\nDoing some shortcut to coercion actually fasten the code\n\nOld version\n\n```\nsage: z = 2\nsage: q = QQ((-1,5))\nsage: %timeit z + q\nsage: %timeit q + z\nsage: %timeit z - q\nsage: %timeit q - z\nsage: %timeit z * q\nsage: %timeit q * z\nsage: %timeit z / q\nsage: %timeit q / z\n```\n\nNew version\n\n```\nsage: z = 2\nsage: q = QQ((-1,5))\nsage: %timeit z + q\n1000000 loops, best of 3: 265 ns per loop\nsage: %timeit q + z\n1000000 loops, best of 3: 323 ns per loop\nsage: %timeit z - q\n1000000 loops, best of 3: 261 ns per loop\nsage: %timeit q - z\n1000000 loops, best of 3: 319 ns per loop\nsage: %timeit z * q\n1000000 loops, best of 3: 341 ns per loop\nsage: %timeit q * z\n1000000 loops, best of 3: 446 ns per loop\nsage: %timeit z / q\n1000000 loops, best of 3: 341 ns per loop\nsage: %timeit q / z\n1000000 loops, best of 3: 396 ns per loop\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20731\n\n",
    "created_at": "2016-05-31T13:38:42Z",
    "labels": [
        "coercion",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "shortcut coercion for Integer-Rational operations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20494",
    "user": "@videlec"
}
```
CC:  @jdemeyer

Keywords: sd74

Doing some shortcut to coercion actually fasten the code

Old version

```
sage: z = 2
sage: q = QQ((-1,5))
sage: %timeit z + q
sage: %timeit q + z
sage: %timeit z - q
sage: %timeit q - z
sage: %timeit z * q
sage: %timeit q * z
sage: %timeit z / q
sage: %timeit q / z
```

New version

```
sage: z = 2
sage: q = QQ((-1,5))
sage: %timeit z + q
1000000 loops, best of 3: 265 ns per loop
sage: %timeit q + z
1000000 loops, best of 3: 323 ns per loop
sage: %timeit z - q
1000000 loops, best of 3: 261 ns per loop
sage: %timeit q - z
1000000 loops, best of 3: 319 ns per loop
sage: %timeit z * q
1000000 loops, best of 3: 341 ns per loop
sage: %timeit q * z
1000000 loops, best of 3: 446 ns per loop
sage: %timeit z / q
1000000 loops, best of 3: 341 ns per loop
sage: %timeit q / z
1000000 loops, best of 3: 396 ns per loop
```


Issue created by migration from https://trac.sagemath.org/ticket/20731





---

archive/issue_comments_282765.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-05-31T13:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282765",
    "user": "@videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_282766.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-31T13:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282766",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282767.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-05-31T19:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282767",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282768.json:
```json
{
    "body": "Move `src/sage/rings/binop.pyx` to `src/sage/libs/gmp` since it has nothing to with rings. And I would just use a `.pxd` file with inline functions, no `.pyx` file.",
    "created_at": "2016-06-01T08:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282768",
    "user": "@jdemeyer"
}
```

Move `src/sage/rings/binop.pyx` to `src/sage/libs/gmp` since it has nothing to with rings. And I would just use a `.pxd` file with inline functions, no `.pyx` file.



---

archive/issue_comments_282769.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-01T08:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282769",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282770.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-01T08:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282770",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282771.json:
```json
{
    "body": "I think that `mpq_mul_z` and `mpq_div_z` are overkill. Why don't you just multiply the numerator or denominator with the integer and call `mpq_canonicalize`, similar to what you do for `Integer/Integer` division?",
    "created_at": "2016-06-01T15:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282771",
    "user": "@jdemeyer"
}
```

I think that `mpq_mul_z` and `mpq_div_z` are overkill. Why don't you just multiply the numerator or denominator with the integer and call `mpq_canonicalize`, similar to what you do for `Integer/Integer` division?



---

archive/issue_comments_282772.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-01T15:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282772",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_282773.json:
```json
{
    "body": "`QQ((2^100, 3^100)) * 3^100`",
    "created_at": "2016-06-01T16:24:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282773",
    "user": "@videlec"
}
```

`QQ((2^100, 3^100)) * 3^100`



---

archive/issue_comments_282774.json:
```json
{
    "body": "Right, but that's a rather artificial example. What about simple cases?",
    "created_at": "2016-06-01T16:28:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282774",
    "user": "@jdemeyer"
}
```

Right, but that's a rather artificial example. What about simple cases?



---

archive/issue_comments_282775.json:
```json
{
    "body": "In `src/sage/repl/interpreter.py`, there is a good reason that the line numbers were changed to `...`",
    "created_at": "2016-06-01T16:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282775",
    "user": "@jdemeyer"
}
```

In `src/sage/repl/interpreter.py`, there is a good reason that the line numbers were changed to `...`



---

archive/issue_comments_282776.json:
```json
{
    "body": "I just thought about the following very simple algorithm for the multiplication (division is analogous):\n\nTo compute `(A/B) * C`, you initialize the result as `C/B`, canonicalize it and then multiply the numerator by `A`.\n\nYou don't need to canonicalize the final result, since `gcd(A,B) = 1` by assumption.",
    "created_at": "2016-06-01T19:55:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282776",
    "user": "@jdemeyer"
}
```

I just thought about the following very simple algorithm for the multiplication (division is analogous):

To compute `(A/B) * C`, you initialize the result as `C/B`, canonicalize it and then multiply the numerator by `A`.

You don't need to canonicalize the final result, since `gcd(A,B) = 1` by assumption.



---

archive/issue_comments_282777.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-02T02:44:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282777",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282778.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-02T07:19:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282778",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_282779.json:
```json
{
    "body": "[comment:10]",
    "created_at": "2016-06-02T08:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282779",
    "user": "@jdemeyer"
}
```

[comment:10]



---

archive/issue_comments_282780.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-02T08:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282780",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_282781.json:
```json
{
    "body": "Which line numbers?",
    "created_at": "2016-06-02T08:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282781",
    "user": "@videlec"
}
```

Which line numbers?



---

archive/issue_comments_282782.json:
```json
{
    "body": "I see...",
    "created_at": "2016-06-02T08:20:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282782",
    "user": "@videlec"
}
```

I see...



---

archive/issue_comments_282783.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-02T08:25:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282783",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282784.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-02T08:26:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282784",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_282785.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-02T08:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282785",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_282786.json:
```json
{
    "body": "`12883`",
    "created_at": "2016-06-02T08:36:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282786",
    "user": "@jdemeyer"
}
```

`12883`



---

archive/issue_comments_282787.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-02T08:40:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282787",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282788.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-02T08:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282788",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_282789.json:
```json
{
    "body": "Given that the block\n\n```\n        mpz_set(mpq_numref(X), A)\n        mpz_set(mpq_denref(X), B)\n        mpq_canonicalize(X)\n```\n\noccurs many times, you should probably make it a separate inline function too, let's call it `mpq_div_zz`.",
    "created_at": "2016-06-02T09:34:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282789",
    "user": "@jdemeyer"
}
```

Given that the block

```
        mpz_set(mpq_numref(X), A)
        mpz_set(mpq_denref(X), B)
        mpq_canonicalize(X)
```

occurs many times, you should probably make it a separate inline function too, let's call it `mpq_div_zz`.



---

archive/issue_comments_282790.json:
```json
{
    "body": "I'm still not convinced by the `if type(x) is type(y)`. That would break if somebody wants to subclass `Integer` for some reason. You can check the types first as an optimization, but you should still support the case where `isinstance(x, Integer) and isinstance(y, Integer)`.",
    "created_at": "2016-06-02T09:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282790",
    "user": "@jdemeyer"
}
```

I'm still not convinced by the `if type(x) is type(y)`. That would break if somebody wants to subclass `Integer` for some reason. You can check the types first as an optimization, but you should still support the case where `isinstance(x, Integer) and isinstance(y, Integer)`.



---

archive/issue_comments_282791.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-02T12:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282791",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282792.json:
```json
{
    "body": "Replying to [comment:23 jdemeyer]:\n> I'm still not convinced by the `if type(x) is type(y)`. That would break if somebody wants to subclass `Integer` for some reason. You can check the types first as an optimization, but you should still support the case where `isinstance(x, Integer) and isinstance(y, Integer)`.\n\nIt perfectly works ;-)\n\n```\nsage: class A(Integer): pass\nsage: A() + 1\n1\nsage: 1 + A()\n1\n```\n",
    "created_at": "2016-06-02T13:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282792",
    "user": "@videlec"
}
```

Replying to [comment:23 jdemeyer]:
> I'm still not convinced by the `if type(x) is type(y)`. That would break if somebody wants to subclass `Integer` for some reason. You can check the types first as an optimization, but you should still support the case where `isinstance(x, Integer) and isinstance(y, Integer)`.

It perfectly works ;-)

```
sage: class A(Integer): pass
sage: A() + 1
1
sage: 1 + A()
1
```




---

archive/issue_comments_282793.json:
```json
{
    "body": "Right, subclassing `Integer` works because `__add__` calls the coercion model and the coercion model calls `_add_` (single underscore).",
    "created_at": "2016-06-03T08:25:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282793",
    "user": "@jdemeyer"
}
```

Right, subclassing `Integer` works because `__add__` calls the coercion model and the coercion model calls `_add_` (single underscore).



---

archive/issue_comments_282794.json:
```json
{
    "body": "Some ---hopefully final--- notes:\n\n1. Check documentation (for example, `Rational.__sub__` documents plus)\n\n2. In `mpq_div_z`, you do not need to check the sign since the denominator is the product of two denominators, so it must be positive.\n\n3. I would remove functions `mpq_sub_z` and `mpq_div_z` since they do not commute and are less useful: just implement them directly. Then you can also avoid `mpq_neg` and `mpq_inv` if you do it correctly.",
    "created_at": "2016-06-03T08:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282794",
    "user": "@jdemeyer"
}
```

Some ---hopefully final--- notes:

1. Check documentation (for example, `Rational.__sub__` documents plus)

2. In `mpq_div_z`, you do not need to check the sign since the denominator is the product of two denominators, so it must be positive.

3. I would remove functions `mpq_sub_z` and `mpq_div_z` since they do not commute and are less useful: just implement them directly. Then you can also avoid `mpq_neg` and `mpq_inv` if you do it correctly.



---

archive/issue_comments_282795.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-03T08:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282795",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_282796.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-04T11:20:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282796",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282797.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-04T11:26:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282797",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_282798.json:
```json
{
    "body": "Curiously `Integer + Rational` is faster than `Rational + Integer`\n\n```\nsage: z = 2\nsage: q = QQ((-1,5))\nsage: %timeit z + q\n1000000 loops, best of 3: 251 ns per loop\nsage: %timeit q + z\n1000000 loops, best of 3: 323 ns per loop\n```\n",
    "created_at": "2016-06-04T11:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282798",
    "user": "@videlec"
}
```

Curiously `Integer + Rational` is faster than `Rational + Integer`

```
sage: z = 2
sage: q = QQ((-1,5))
sage: %timeit z + q
1000000 loops, best of 3: 251 ns per loop
sage: %timeit q + z
1000000 loops, best of 3: 323 ns per loop
```




---

archive/issue_comments_282799.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-06-25T04:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282799",
    "user": "@tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_282800.json:
```json
{
    "body": "Changing keywords from \"sd74\" to \"days74\".",
    "created_at": "2016-06-25T04:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282800",
    "user": "@tscrim"
}
```

Changing keywords from "sd74" to "days74".



---

archive/issue_comments_282801.json:
```json
{
    "body": "I'm not quite sure without looking through it. It might be something at a lower level than Sage.\n\nHowever, this needs rebasing.",
    "created_at": "2016-06-25T04:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282801",
    "user": "@tscrim"
}
```

I'm not quite sure without looking through it. It might be something at a lower level than Sage.

However, this needs rebasing.



---

archive/issue_comments_282802.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-06-26T20:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282802",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282803.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-06-26T20:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282803",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_282804.json:
```json
{
    "body": "Replying to [comment:32 tscrim]:\n> I'm not quite sure without looking through it. It might be something at a lower level than Sage.\n\nI really do not understand this comment.\n\n> However, this needs rebasing.\n\nThis I understood. Done!",
    "created_at": "2016-06-26T20:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282804",
    "user": "@videlec"
}
```

Replying to [comment:32 tscrim]:
> I'm not quite sure without looking through it. It might be something at a lower level than Sage.

I really do not understand this comment.

> However, this needs rebasing.

This I understood. Done!



---

archive/issue_comments_282805.json:
```json
{
    "body": "Replying to [comment:34 vdelecroix]:\n> Replying to [comment:32 tscrim]:\n> > I'm not quite sure without looking through it. It might be something at a lower level than Sage.\n> \n> I really do not understand this comment.\n\nThis was in reference to comment:31, where I was thinking the issue with the time difference might be something in mpz instead of something we are doing in Sage. It might be better to take the faster version and utilize that addition/multiplication is commutative to get that extra little bit of speed.",
    "created_at": "2016-06-26T21:29:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282805",
    "user": "@tscrim"
}
```

Replying to [comment:34 vdelecroix]:
> Replying to [comment:32 tscrim]:
> > I'm not quite sure without looking through it. It might be something at a lower level than Sage.
> 
> I really do not understand this comment.

This was in reference to comment:31, where I was thinking the issue with the time difference might be something in mpz instead of something we are doing in Sage. It might be better to take the faster version and utilize that addition/multiplication is commutative to get that extra little bit of speed.



---

archive/issue_comments_282806.json:
```json
{
    "body": "Replying to [comment:35 tscrim]:\n> Replying to [comment:34 vdelecroix]:\n> > Replying to [comment:32 tscrim]:\n> > > I'm not quite sure without looking through it. It might be something at a lower level than Sage.\n> > \n> > I really do not understand this comment.\n> \n> This was in reference to comment:31, where I was thinking the issue with the time difference might be something in mpz instead of something we are doing in Sage. It might be better to take the faster version and utilize that addition/multiplication is commutative to get that extra little bit of speed.\n\nThere is no fundamental difference between `z+q` and `q+z`. The code is copy paste calling the very same functions. [comment:31 comment:31] is just something that I do not understand.",
    "created_at": "2016-06-27T05:45:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282806",
    "user": "@videlec"
}
```

Replying to [comment:35 tscrim]:
> Replying to [comment:34 vdelecroix]:
> > Replying to [comment:32 tscrim]:
> > > I'm not quite sure without looking through it. It might be something at a lower level than Sage.
> > 
> > I really do not understand this comment.
> 
> This was in reference to comment:31, where I was thinking the issue with the time difference might be something in mpz instead of something we are doing in Sage. It might be better to take the faster version and utilize that addition/multiplication is commutative to get that extra little bit of speed.

There is no fundamental difference between `z+q` and `q+z`. The code is copy paste calling the very same functions. [comment:31 comment:31] is just something that I do not understand.



---

archive/issue_comments_282807.json:
```json
{
    "body": "Ah, I see it now. I guess the only difference is checking `isinstance` for `Integer` is longer than that of `Rational` because of a longer MRO:\n\n```\nsage: p = 2\nsage: p.__class__.__mro__\n(<type 'sage.rings.integer.Integer'>,\n <type 'sage.structure.element.EuclideanDomainElement'>,\n <type 'sage.structure.element.PrincipalIdealDomainElement'>,\n <type 'sage.structure.element.DedekindDomainElement'>,\n <type 'sage.structure.element.IntegralDomainElement'>,\n <type 'sage.structure.element.CommutativeRingElement'>,\n <type 'sage.structure.element.RingElement'>,\n <type 'sage.structure.element.ModuleElement'>,\n <type 'sage.structure.element.Element'>,\n <type 'sage.structure.sage_object.SageObject'>,\n <type 'object'>)\nsage: q = 2/3\nsage: q.__class__.__mro__\n(<type 'sage.rings.rational.Rational'>,\n <type 'sage.structure.element.FieldElement'>,\n <type 'sage.structure.element.CommutativeRingElement'>,\n <type 'sage.structure.element.RingElement'>,\n <type 'sage.structure.element.ModuleElement'>,\n <type 'sage.structure.element.Element'>,\n <type 'sage.structure.sage_object.SageObject'>,\n <type 'object'>)\n```\n\n\nI'm happy with this ticket as-is. Jeroen, any more comments?",
    "created_at": "2016-06-27T13:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282807",
    "user": "@tscrim"
}
```

Ah, I see it now. I guess the only difference is checking `isinstance` for `Integer` is longer than that of `Rational` because of a longer MRO:

```
sage: p = 2
sage: p.__class__.__mro__
(<type 'sage.rings.integer.Integer'>,
 <type 'sage.structure.element.EuclideanDomainElement'>,
 <type 'sage.structure.element.PrincipalIdealDomainElement'>,
 <type 'sage.structure.element.DedekindDomainElement'>,
 <type 'sage.structure.element.IntegralDomainElement'>,
 <type 'sage.structure.element.CommutativeRingElement'>,
 <type 'sage.structure.element.RingElement'>,
 <type 'sage.structure.element.ModuleElement'>,
 <type 'sage.structure.element.Element'>,
 <type 'sage.structure.sage_object.SageObject'>,
 <type 'object'>)
sage: q = 2/3
sage: q.__class__.__mro__
(<type 'sage.rings.rational.Rational'>,
 <type 'sage.structure.element.FieldElement'>,
 <type 'sage.structure.element.CommutativeRingElement'>,
 <type 'sage.structure.element.RingElement'>,
 <type 'sage.structure.element.ModuleElement'>,
 <type 'sage.structure.element.Element'>,
 <type 'sage.structure.sage_object.SageObject'>,
 <type 'object'>)
```


I'm happy with this ticket as-is. Jeroen, any more comments?



---

archive/issue_comments_282808.json:
```json
{
    "body": "One way to shortcut the `isinstance(right, Rational)` is to instead do `type(right) is Rational`. That would actually be the fastest. (And it will still work with an element that inherits from `Rational` since `_add_`, `_mul_` etc are properly implemented.) What do you think?",
    "created_at": "2016-07-08T20:37:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282808",
    "user": "@videlec"
}
```

One way to shortcut the `isinstance(right, Rational)` is to instead do `type(right) is Rational`. That would actually be the fastest. (And it will still work with an element that inherits from `Rational` since `_add_`, `_mul_` etc are properly implemented.) What do you think?



---

archive/issue_comments_282809.json:
```json
{
    "body": "I was originally thinking that we should keep it as `isinstance`, but since we explicitly construct a new `Rational` (and I don't think it could be made to work with subtypes [easily]), I think we should only test against `Rational`. Plus those extra little nanoseconds can matter at this level. Subclasses can just fall into the coercion framework.",
    "created_at": "2016-07-09T19:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282809",
    "user": "@tscrim"
}
```

I was originally thinking that we should keep it as `isinstance`, but since we explicitly construct a new `Rational` (and I don't think it could be made to work with subtypes [easily]), I think we should only test against `Rational`. Plus those extra little nanoseconds can matter at this level. Subclasses can just fall into the coercion framework.



---

archive/issue_comments_282810.json:
```json
{
    "body": "hum... with `isinstance(X,Y)`\n\n```\nsage: %timeit z+q                                                              \n1000000 loops, best of 3: 242 ns per loop\nsage: %timeit q+z                                                              \n1000000 loops, best of 3: 306 ns per loop\n```\n\nwith `type(X) is Y`\n\n```\nsage: %timeit z+q\n1000000 loops, best of 3: 243 ns per loop                                      \nsage: %timeit q+z\n1000000 loops, best of 3: 334 ns per loop\n```\n",
    "created_at": "2016-07-09T20:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282810",
    "user": "@videlec"
}
```

hum... with `isinstance(X,Y)`

```
sage: %timeit z+q                                                              
1000000 loops, best of 3: 242 ns per loop
sage: %timeit q+z                                                              
1000000 loops, best of 3: 306 ns per loop
```

with `type(X) is Y`

```
sage: %timeit z+q
1000000 loops, best of 3: 243 ns per loop                                      
sage: %timeit q+z
1000000 loops, best of 3: 334 ns per loop
```




---

archive/issue_comments_282811.json:
```json
{
    "body": "Independent time testing with a Cython class (without inheritance)\n\n|  code | relative time |\n|:-------:|:---------------:|\n| `type(a) == A`      | 10500000ns|\n| `isinstance(a,A)`   |   559000ns|\n| `type(a) is A`      |       55ns|\nI guess something else is happening with `z+q` versus `q+z`...",
    "created_at": "2016-07-09T20:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282811",
    "user": "@videlec"
}
```

Independent time testing with a Cython class (without inheritance)

|  code | relative time |
|:-------:|:---------------:|
| `type(a) == A`      | 10500000ns|
| `isinstance(a,A)`   |   559000ns|
| `type(a) is A`      |       55ns|
I guess something else is happening with `z+q` versus `q+z`...



---

archive/issue_comments_282812.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-09T20:51:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282812",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282813.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-10T18:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282813",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_282814.json:
```json
{
    "body": "That really suggests that it has to do with the MRO length (comment:37), but I am somewhat surprised that does matter. Well, this is a definite improvement and should get into 7.3.",
    "created_at": "2016-07-10T18:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282814",
    "user": "@tscrim"
}
```

That really suggests that it has to do with the MRO length (comment:37), but I am somewhat surprised that does matter. Well, this is a definite improvement and should get into 7.3.



---

archive/issue_comments_282815.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2016-07-10T21:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282815",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_282816.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/repl/interpreter.py\n**********************************************************************\nFile \"src/sage/repl/interpreter.py\", line 77, in sage.repl.interpreter\nFailed example:\n    shell.run_cell('1/0')\nExpected:\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    <ipython-input-...> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:...)()\n       ...          if type(left) is type(right):\n       ...              if mpz_sgn((<Integer>right).value) == 0:\n    -> ...                  raise ZeroDivisionError(\"rational division by zero\")\n       ...              x = <Rational> Rational.__new__(Rational)\n       ...              mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\nGot:\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    <ipython-input-1-6f88eab09598> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    /home/buildslave-sage/slave/sage_git/build/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/rings/integer.c:12882)()\n       1841         if type(left) is type(right):\n       1842             if mpz_sgn((<Integer>right).value) == 0:\n    -> 1843                 raise ZeroDivisionError(\"rational division by zero\")\n       1844             x = <Rational> Rational.__new__(Rational)\n       1845             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\n**********************************************************************\n1 item had failures:\n   1 of   5 in sage.repl.interpreter\n    [133 tests, 1 failure, 3.60 s]\n```\n",
    "created_at": "2016-07-10T21:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282816",
    "user": "@vbraun"
}
```


```
sage -t --long src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    shell.run_cell('1/0')
Expected:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-...> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:...)()
       ...          if type(left) is type(right):
       ...              if mpz_sgn((<Integer>right).value) == 0:
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...              x = <Rational> Rational.__new__(Rational)
       ...              mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-6f88eab09598> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /home/buildslave-sage/slave/sage_git/build/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/rings/integer.c:12882)()
       1841         if type(left) is type(right):
       1842             if mpz_sgn((<Integer>right).value) == 0:
    -> 1843                 raise ZeroDivisionError("rational division by zero")
       1844             x = <Rational> Rational.__new__(Rational)
       1845             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
1 item had failures:
   1 of   5 in sage.repl.interpreter
    [133 tests, 1 failure, 3.60 s]
```




---

archive/issue_comments_282817.json:
```json
{
    "body": "Dear Volker,\n\nI am not able to reproduce this... could you tell us on which kind of configuration you obtained that?\n\nVincent",
    "created_at": "2016-07-11T16:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282817",
    "user": "@videlec"
}
```

Dear Volker,

I am not able to reproduce this... could you tell us on which kind of configuration you obtained that?

Vincent



---

archive/issue_comments_282818.json:
```json
{
    "body": "I think the test is just fragile:\n\n```\n    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:...)()\n```\n\nvs the actual output:\n\n```\n    /home/buildslave-sage/slave/sage_git/build/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/rings/integer.c:12882)()\n```\n\nNote the path is `.../build/src/...` and compare with the previous doctest output format.",
    "created_at": "2016-07-15T20:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282818",
    "user": "@tscrim"
}
```

I think the test is just fragile:

```
    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:...)()
```

vs the actual output:

```
    /home/buildslave-sage/slave/sage_git/build/src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (/home/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/rings/integer.c:12882)()
```

Note the path is `.../build/src/...` and compare with the previous doctest output format.



---

archive/issue_comments_282819.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-22T22:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282819",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_282820.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-07-22T22:42:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282820",
    "user": "@videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_282821.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-22T22:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282821",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_282822.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-23T18:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20494",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20494#issuecomment-282822",
    "user": "@vbraun"
}
```

Resolution: fixed
