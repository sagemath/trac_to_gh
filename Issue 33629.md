# Issue 33629: Upgrade jupyter_jsmol, make jupyter_packaging standard

Issue created by migration from https://trac.sagemath.org/ticket/33866

Original creator: mkoeppe

Original creation time: 2022-05-18 05:46:42

CC:  egourgoulhon dimpase jhpalmieri fbissey arojas tornaria

`jupyter_packaging` is a new dependency, so it needs to become standard


---

Comment by mkoeppe created at 2022-05-27 04:16:09

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-05-27 04:16:09

New commits:


---

Comment by git created at 2022-06-26 20:11:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-06-26 21:54:37

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-06-26 21:55:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-06-26 21:57:02

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-06-26 21:57:24

Deferred the actual update of `jupyter_jsmol` to a follow-up ticket.


---

Comment by git created at 2022-06-26 22:19:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-27 00:58:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-27 20:39:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-27 20:40:16

The `setuptools_scm` upgrade made `matplotlib` think that it is version 0.0


---

Comment by dimpase created at 2022-06-28 20:55:11

lgtm


---

Comment by dimpase created at 2022-06-28 20:55:11

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2022-06-28 20:59:31

Nitpick, you did not list a license for `hatchling`

```
diff --git a/build/pkgs/hatchling/SPKG.rst b/build/pkgs/hatchling/SPKG.rst
new file mode 100644
index 00000000..23d86bd
--- /dev/null
+++ b/build/pkgs/hatchling/SPKG.rst
@@ -0,0 +1,16 @@
+hatchling: Modern, extensible Python build backend
+==================================================
+
+Description
+-----------
+
+Modern, extensible Python build backend
+
+License
+-------
+
+Upstream Contact
+----------------
+
+https://pypi.org/project/hatchling/
+
```

It is `MIT`.


---

Comment by git created at 2022-06-28 23:58:23

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-06-28 23:58:23

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2022-06-28 23:58:50

Thanks!


---

Comment by mkoeppe created at 2022-06-28 23:58:50

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-06-30 04:39:15

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2022-06-30 04:39:15

Doctest failures, I think because of the `pip` upgrade:

```
sage -t --random-seed=40701510628761718232931312764279214628 src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 146, in sage.misc.package.pip_installed_packages
Failed example:
    'scipy' in d  # optional - sage_spkg
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/misc/package.py", line 148, in sage.misc.package.pip_installed_packages
Failed example:
    d['scipy']  # optional - sage_spkg
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta3/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta3/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.pip_installed_packages[3]>", line 1, in <module>
        d['scipy']  # optional - sage_spkg
    KeyError: 'scipy'
```



---

Comment by jhpalmieri created at 2022-06-30 04:40:21

The issue is that the dictionary `pip_installed_packages()` now has a key `"SciPy"` rather than `"scipy"`. I suggested several possible fixes at ticket:33530#comment:68 and ticket:33530#comment:69.


---

Comment by git created at 2022-06-30 17:50:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-30 18:02:21

Thanks for catching this and your suggestions. I have made similar changes to the doctests. The doctests now accept both formats. I think it's not necessary to track down which of the updated packages is responsible for this change. I wouldn't want to have to tighten version bounds in `install-requires.txt` for this package just for this doctest.


---

Comment by mkoeppe created at 2022-06-30 18:06:12

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-06-30 18:31:44

Looks good, thank you.


---

Comment by jhpalmieri created at 2022-06-30 18:31:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-06-30 18:33:03

Thanks!


---

Comment by vbraun created at 2022-07-03 22:06:00

Resolution: fixed


---

Comment by dimpase created at 2022-08-24 10:31:03

as it turns out, jupyter_jsmol installation process fetches more js stuff than there is in the tarball:

```
jjupyter_jsmol-2022.1.0] Building wheels for collected packages: jupyter-jsmol
[jupyter_jsmol-2022.1.0]   WARNING: Ignoring --build-option when building jupyter-jsmol using PEP 517
[jupyter_jsmol-2022.1.0]   Building wheel for jupyter-jsmol (pyproject.toml): started
[jupyter_jsmol-2022.1.0]   Running command Building wheel for jupyter-jsmol (pyproject.toml)
[jupyter_jsmol-2022.1.0]   setup.py entered
[jupyter_jsmol-2022.1.0]   $PATH=/mnt/opt/Sage/sage-dev/build/bin:/mnt/opt/Sage/sage-dev/local/var/lib/sage/venv-python3.10/bin:/mnt/opt/Sage/sage-dev/local/bin:/mnt/opt/Sage/sage-dev/build/bin:/mnt/opt/Sage/sage-dev/local/bin:/mnt/opt/Sage/sage-dev/local/var/lib/sage/venv-python3.10/bin:/mnt/opt/Sage/sage-dev/build/bin:/mnt/opt/Sage/sage-dev/src/bin:/mnt/opt/Sage/sage-dev/local/bin:/home/dima/.elan/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin:/usr/lib/llvm/14/bin:/home/dima/.local/bin:/home/dima/.local/bin
[jupyter_jsmol-2022.1.0]   <string>:47: DeprecatedWarning: create_cmdclass is deprecated as of 0.8 and will be removed in 1.0. "
[jupyter_jsmol-2022.1.0]   Use `wrap_installers` to handle prebuild steps in cmdclass.
[jupyter_jsmol-2022.1.0]   Use `get_data_files` to handle data files.
[jupyter_jsmol-2022.1.0]   Use `include_package_data=True` and `MANIFEST.in` for package data.
[jupyter_jsmol-2022.1.0] 
[jupyter_jsmol-2022.1.0]   <string>:49: DeprecatedWarning: install_npm is deprecated as of 0.8 and will be removed in 1.0. Use `npm_builder` and `wrap_installers`
[jupyter_jsmol-2022.1.0]   running bdist_wheel
[jupyter_jsmol-2022.1.0]   running jsdeps
[jupyter_jsmol-2022.1.0]   Installing build dependencies with npm.  This may take a while...
[jupyter_jsmol-2022.1.0]   > yarn install
[jupyter_jsmol-2022.1.0]   yarn install v1.22.19
[jupyter_jsmol-2022.1.0]   warning package.json: No license field
[jupyter_jsmol-2022.1.0]   warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.
[jupyter_jsmol-2022.1.0]   warning jupyter-jsmol@2022.1.0: No license field
[jupyter_jsmol-2022.1.0]   [1/4] Resolving packages...
[jupyter_jsmol-2022.1.0]   [2/4] Fetching packages...
[jupyter_jsmol-2022.1.0]   info There appears to be trouble with your network connection. Retrying...
...
```


aand it hangs - even tough the network is OK :-(


---

Comment by dimpase created at 2022-08-24 11:10:14

follow-up on #34421
