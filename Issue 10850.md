# Issue 10850: numpy matrices indexed by sage integers are wrong

Issue created by migration from https://trac.sagemath.org/ticket/10928

Original creator: flawrence

Original creation time: 2011-03-14 01:32:59

Assignee: tbd

CC:  jason mkoeppe slelievre

When using numpy matrices, indexing behaves differently depending on whether sage integers or python integers are used to do the indexing

```
sage: mymat = numpy.matrix(numpy.arange(6).reshape(3,2))
sage: mymat[:,0]
matrix([[0, 2, 4]])
sage: mymat[:,int(0)]
matrix([[0],
        [2],
        [4]])
```


The second behaviour is correct, i.e. int(0) gives the correct answer.


---

Comment by dsm created at 2011-03-14 04:58:21

It's not a Sage-specific issue.  E.g. using gmpy's mpz has the same issue:


```
Python 2.7 (r27:82500, Aug 18 2010, 23:33:57) 
[GCC 4.2.1 (Apple Inc. build 5664)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> 
>>> import numpy, gmpy
>>> 
>>> m = numpy.matrix(numpy.arange(6)).reshape(3,2)
>>> m
matrix([[0, 1],
        [2, 3],
        [4, 5]])
>>> m[:,0]
matrix([[0],
        [2],
        [4]])
>>> m[:,gmpy.mpz(0)]
matrix([[0, 2, 4]])
```


The underlying issue is that numpy doesn't recognize Sage integers as scalars:


```
sage: numpy.isscalar(int(0))
True
sage: numpy.isscalar((0))
False
sage: numpy.ScalarType
(<type 'int'>, <type 'float'>, <type 'complex'>, <type 'long'>, <type 'bool'>, <type 'str'>, <type 'unicode'>, <type 'buffer'>, <type 'numpy.int64'>, <type 'numpy.int16'>, <type 'numpy.complex128'>, <type 'numpy.void'>, <type 'numpy.int32'>, <type 'numpy.uint32'>, <type 'numpy.float128'>, <type 'numpy.string_'>, <type 'numpy.int8'>, <type 'numpy.uint8'>, <type 'numpy.float32'>, <type 'numpy.bool_'>, <type 'numpy.uint64'>, <type 'numpy.int64'>, <type 'numpy.uint64'>, <type 'numpy.complex64'>, <type 'numpy.unicode_'>, <type 'numpy.uint16'>, <type 'numpy.float64'>, <type 'numpy.object_'>, <type 'numpy.complex256'>)
```


because it doesn't recognize it as a generic and it's not listed in the acceptable scalar types.  This means the wrong branch is taken here:


```
# numpy/matrixlib/defmatrix.py
        if out.ndim == 1:
            sh = out.shape[0]
            # Determine when we should have a column array
            try:
                n = len(index)
            except:
                n = 0
            if n > 1 and isscalar(index[1]):
                out.shape = (sh,1)
            else:
                out.shape = (1,sh)
```


n=2, but isscalar(Integer(0)) is False.


---

Comment by jason created at 2011-03-14 13:43:20

possibly (but maybe marginally) related ticket: #6506


---

Comment by jason created at 2011-03-14 13:46:49

Numpy comparing to a set list of types also makes this inconsistency with a standard python type:


```
sage: import fractions
sage: a=fractions.Fraction(2,1)
sage: a
Fraction(2, 1)
sage: a==int(2)
True
sage: np.isscalar(a)
False
```



---

Comment by jason created at 2011-03-14 13:48:00

Somebody ought to probably post to the numpy mailing list...


---

Comment by dsm created at 2011-03-15 00:19:12

Replying to [comment:5 jason]:
> Somebody ought to probably post to the numpy mailing list...

Done.


---

Comment by jason created at 2011-05-14 15:30:10

The thread link is here: http://article.gmane.org/gmane.comp.python.numeric.general/42994

However, there didn't seem to be replies.  We should probably re-raise the subject (or submit a pull request with a fix)...


---

Comment by jason created at 2011-05-14 15:32:17

Here is a relevant thread from a while ago about the same sorts of issues: http://comments.gmane.org/gmane.comp.python.scientific.devel/13936


---

Comment by rws created at 2014-08-11 06:16:21

Replying to [comment:4 jason]:
> Numpy comparing to a set list of types also makes this inconsistency with a standard python type:
> 
Now even `Fraction` does not take `Integer`s anymore:

```
sage: a=fractions.Fraction(2,1)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-17-a64d83a7a828> in <module>()
----> 1 a=fractions.Fraction(Integer(2),Integer(1))

/home/ralf/sage/local/lib/python/fractions.pyc in __new__(cls, numerator, denominator)
    156                 )
    157         else:
--> 158             raise TypeError("both arguments should be "
    159                             "Rational instances")
    160 

TypeError: both arguments should be Rational instances
```



---

Comment by mkoeppe created at 2020-10-08 21:04:58

Changing priority from critical to major.


---

Comment by slelievre created at 2020-10-08 21:10:21

Changing keywords from "" to "numpy".


---

Comment by slelievre created at 2020-10-08 21:10:21

Demoted from 'critical' to 'major': fixed already in Sage 8.2, maybe before.

Doctest needed. Tentative doctest:

```
sage: import numpy as np
sage: m = np.matrix(np.arange(4).reshape(2, 2))
sage: a = m[:, int(0)]
sage: b = m[:, Integer(0)]
sage: print('{}\n{}\n{}'.format(m, a, b))
[[0 1]
 [2 3]]
[[0]
 [2]]
[[0]
 [2]]
```


Where could such a doctest go?

Related:

- #29728: improve compatibility with the Python library


---

Comment by slelievre created at 2021-03-25 00:52:23

Replying to [comment:14 rws]:
> Now even `Fraction` does not take `Integer`s anymore:

Dedicated ticket for that issue:

- #28234: Sage Integers are incompatible with Python Fractions


---

Comment by slelievre created at 2021-03-25 00:54:51

Is there a file dedicated to testing Sage's compatibility
with the Python ecosystem?

If not, should we create one?


---

Comment by slelievre created at 2021-03-25 00:58:55

Or should this go somewhere in `src/sage/matrix`?


---

Comment by mkoeppe created at 2021-03-26 16:06:51

Replying to [comment:18 slelievre]:
> Is there a file dedicated to testing Sage's compatibility
> with the Python ecosystem?
> 
> If not, should we create one?

I would think that the best place for this would be `src/sage/tests`, which already has files such as `sympy.py` and `parigp.py`. 

So a new file `numpy.py` would make sense.


---

Comment by slelievre created at 2021-03-26 20:01:53

Here is a branch. Ready for review.
----
New commits:


---

Comment by mkoeppe created at 2021-03-26 21:30:15

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by vdelecroix created at 2021-04-08 15:19:00

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-04-08 15:22:59

Merci!


---

Comment by vbraun created at 2021-05-27 20:30:45

Resolution: fixed
