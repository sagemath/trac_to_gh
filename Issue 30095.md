# Issue 30095: Merge sage_brial into sagelib

Issue created by migration from https://trac.sagemath.org/ticket/30332

Original creator: mkoeppe

Original creation time: 2020-08-11 00:14:52

CC:  fbissey mjo tscrim

As discussed in #29369 and #28918.




---

Comment by fbissey created at 2020-08-11 00:25:43

I propose to copy the current sage-brial code under `sage/rings/polynomial`. This is based on the fact all (but one) imports of brial happen there.

```
$ grep -r brial src/sage/*
src/sage/rings/polynomial/pbori.pyx:# distutils: libraries = brial brial_groebner M4RI_LIBRARIES LIBPNG_LIBRARIES
src/sage/rings/polynomial/pbori.pyx:    sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:        #from brial.interpolate import interpolate_smallest_lex
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import BooleanMonomialMonoid, BooleanMonomial
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid, BooleanMonomial
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleSet
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import BooleanPolynomial
src/sage/rings/polynomial/pbori.pyx:        from brial.parallel import _encode_polynomial
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleSet
src/sage/rings/polynomial/pbori.pyx:        from brial import red_tail
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:        from brial.gbcore import groebner_basis
src/sage/rings/polynomial/pbori.pyx:        from brial import red_tail
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import BooleSet
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleSet
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleSet
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import groebner_basis
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanPolynomialVector
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import groebner_basis
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import GroebnerStrategy
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleanMonomialMonoid
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import map_every_x_to_x_plus_one
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import zeros
src/sage/rings/polynomial/pbori.pyx:        sage: from brial.interpolate import *
src/sage/rings/polynomial/pbori.pyx:        sage: from brial.interpolate import *
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import ll_red_nf_redsb
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import ll_red_nf_noredsb
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import ll_red_nf_noredsb_single_recursive_call
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import if_then_else
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import top_index
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import substitute_variables
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import substitute_variables
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import random_set, set_random_seed
src/sage/rings/polynomial/pbori.pyx:        sage: from brial import random_set, set_random_seed
src/sage/rings/polynomial/pbori.pyx:# todo: merge with pickling from brial.parallel
src/sage/rings/polynomial/pbori.pyx:# todo: merge with pickling from brial.parallel
src/sage/rings/polynomial/pbori.pyx:    from brial.parallel import _decode_polynomial
src/sage/rings/polynomial/pbori.pyx:# todo: merge with pickling from brial.parallel
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import BooleConstant
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/pbori.pyx:            sage: from brial import *
src/sage/rings/polynomial/multi_polynomial_sequence.py:        from brial import gauss_on_polys
src/sage/rings/polynomial/multi_polynomial_sequence.py:        from brial.ll import eliminate,ll_encode,ll_red_nf_redsb
src/sage/rings/polynomial/multi_polynomial_sequence.py:            from brial.interred import interred as inter_red
src/sage/sat/converters/__init__.py:from brial.cnf import CNFEncoder as PolyBoRiCNFEncoder
```

but other suggestions based on best practices will be given the priority.


---

Comment by mkoeppe created at 2020-08-11 00:37:20

So there's a Cython interface `sage.libs.polybori`, then a Python library `brial`, and also `sage.rings.polynomial.pbori`? What is depending on what?


---

Comment by fbissey created at 2020-08-11 00:50:40

I thought that sage-brial depends on `sage.libs.polybori` but that may not be the case. It imports `sage.all` and specifically `sage.rings.polynomial.pbori` and that's the only sage specific bits it imports.

`sage.rings.polynomial.pbori` itself relies on `sage.libs.polybori` (through `sage.libs.polybori.decl`) and both need the C++ brial library.

Does that answer your question?


---

Comment by mkoeppe created at 2020-08-11 01:06:04

Thanks. I agree that `sage.rings.polynomial` seems to be a good place for the Python code from sage-brial. Perhaps it would be best to create a package `sage.rings.polynomial.brial` and to move the current `pbori.pyx` inside it (leaving deprecated reimport behind). There are only a few places in Sage where things are imported from `sage.rings.polynomial.pbori` and they could be easily update. Or, if you don't mind keep the old name `pbori`, the same could be done with `sage.rings.polynomial.pbori` instead of `...brial`.

One thing to keep in mind is the context of the planned modularization of sagelib. 
In Sage 9.3 I would hope to be able to create a separate distribution (distutils package) `sage-brial`, which would then package `sage.rings.polynomial.{brial,pbori}`, `sage.libs.polybori`, `sage.libs.fes`, `sage.crypto.boolean_function` -- everything that has a compile-time dependency on `libbrial`. This will make it possible to separately compile `sagelib` on systems without brial.


---

Comment by fbissey created at 2020-08-11 01:14:00

On the legal side, the code is GPL2.0 or later. Although I will need to fix the license on github. It seems I changed it from 2+ to 2 carelessly back in 2017 (probably by copying a template). I obviously had no rights to do that.

The only thing I may need guidance with is the deprecated re-import. Otherwise moving stuff, including `pbori.{pyx,pxd}`, in `sage.rings.polynomial.pbori` seems to be a good idea and hopefully will help with modularization.


---

Comment by mkoeppe created at 2020-08-11 01:17:22

Replying to [comment:5 fbissey]:
> On the legal side, the code is GPL2.0 or later. Although I will need to fix the license on github. It seems I changed it from 2+ to 2 carelessly back in 2017 (probably by copying a template). I obviously had no rights to do that.

I think GitHub takes the position that there is no such thing as "GPL 2 only": That the license includes "... or any later version" no matter whether you write these words in the files or not.


---

Comment by fbissey created at 2020-08-11 01:28:26

Replying to [comment:6 mkoeppe]:
> Replying to [comment:5 fbissey]:
> > On the legal side, the code is GPL2.0 or later. Although I will need to fix the license on github. It seems I changed it from 2+ to 2 carelessly back in 2017 (probably by copying a template). I obviously had no rights to do that.
> 
> I think GitHub takes the position that there is no such thing as "GPL 2 only": That the license includes "... or any later version" no matter whether you write these words in the files or not.

Very nice of them. But they are not lawyers and I think the "LICENSE" file should be explicit for people who look for these subtle clarification (distros). The GPL FAQ https://www.gnu.org/licenses/old-licenses/gpl-2.0-faq.html#VersionTwoOrLater seem to imply that you should explicitly state it.


---

Comment by fbissey created at 2020-08-12 00:17:49

Tests included inside `sage-brial` will have to be moved to sage doctesting. More generally it will have to be documented properly as much as possible. This will be so much fun.

It looks like that will take much more than just drag and drop in place with a few cosmetic changes.


---

Comment by mkoeppe created at 2020-08-12 00:25:36

I suppose you could prepare the change to using the sage doctester first, before merging into Sage.


---

Comment by mkoeppe created at 2020-08-12 00:53:50

Given that sage_brial has no Cython bits, I think it could in fact be removed from the dependencies of sagelib, as it won't really be needed while installing sagelib, only later for docbuild and doctest.


---

Comment by fbissey created at 2020-08-12 01:22:27

Replying to [comment:10 mkoeppe]:
> Given that sage_brial has no Cython bits, I think it could in fact be removed from the dependencies of sagelib, as it won't really be needed while installing sagelib, only later for docbuild and doctest.

Technically correct.


---

Comment by fbissey created at 2020-08-12 22:58:24

This is not ready for review. I am just pushing my work in progress so it is not just on my workstation, it is visible and open to others contribution.

There is a lot to do:
1. update paths
2. convert docstrings and tests to sage framework

This may take some time and I doubt it will be ready in time for 9.2 but we can only try.
----
New commits:


---

Comment by git created at 2020-08-13 00:10:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-13 02:06:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-18 22:54:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-08-18 23:54:27

I am currently converting docstrings :( I am also doing some selective code deletion as I come along across it. There is a module for memory usage, it is imported once but never used and even less tested. So, I am removing it. It will be worth another look after that first pass.


---

Comment by git created at 2020-08-19 00:20:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-19 00:36:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-08-19 00:48:54

I suspect the building of the html doc will break at this stage. If it doesn't the output may very well be useless. Once I figure that out, I'll do the doctesting to see what's broken. I am expecting a lot of breaking in the newly imported tests.


---

Comment by git created at 2020-08-19 02:04:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-19 23:11:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 00:25:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 00:50:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 00:51:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-08-20 00:55:32

At this point documentation builds and is identical to the old one. doctesting gets a lot of failures. There is still quite a bit of cleaning to be done, including removing files that should have been trashed long ago.


---

Comment by fbissey created at 2020-08-20 02:32:27

More joy! I found a subtle coding error while fixing the test suite. I guess it won't have an impact on the rest of sage because that code path just error-ed out when taken. So it is probably a dead code path anyway.


---

Comment by git created at 2020-08-20 04:26:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 05:07:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 09:33:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 10:07:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-20 23:06:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-08-20 23:08:04

Changing status from new to needs_review.


---

Comment by fbissey created at 2020-08-20 23:08:04

This is ready for a first review. I am not expecting it to make it as is. But other people should comment now.


---

Comment by git created at 2020-08-20 23:09:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-08-20 23:10:09

Last commit to burn the bridges :)


---

Comment by mkoeppe created at 2020-08-21 01:15:51

`BooleanPolynomialRing_constructor` vs. `BooleanPolynomialRing` looks a bit confusing


---

Comment by fbissey created at 2020-08-21 01:19:26

Replying to [comment:35 mkoeppe]:
> `BooleanPolynomialRing_constructor` vs. `BooleanPolynomialRing` looks a bit confusing

Not my code, I am only the messenger. I certainly agree that this largely decade old code would need a good fleeing - apart from the trimming I already did on import. I assumed we could do it after merging it.


---

Comment by mkoeppe created at 2020-08-21 01:20:40

Sure, just trying to figure out what the high level interface is intended to be.


---

Comment by mkoeppe created at 2020-08-21 01:38:25

`build/pkgs/sagelib/dependencies` still has `sage_brial`


---

Comment by fbissey created at 2020-08-21 01:40:02

Right. I remember thinking about that last night. Forgot to remove it. Will do in a few hours if no one beats me to it.


---

Comment by git created at 2020-08-21 01:41:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-08-27 05:17:23

Replying to [comment:36 fbissey]:
> Replying to [comment:35 mkoeppe]:
> > `BooleanPolynomialRing_constructor` vs. `BooleanPolynomialRing` looks a bit confusing
> 
> Not my code, I am only the messenger. I certainly agree that this largely decade old code would need a good fleeing - apart from the trimming I already did on import. I assumed we could do it after merging it.

Indeed, this is a known problem that needs some attention: #21892, #24748, possibly #27019, #23310, #23312, possibly #23311, #15223.

My idea is to scrap `BooleanPolynomialRing_constructor` and just have `BooleanPolynomialRing` be a `UniqueRepresentation` object, possibly just being a subclass of the monoid algebra parent.


---

Comment by fbissey created at 2020-08-27 21:44:58

My idea was to merge this in 9.2 and work on improving things in 9.3. However, if you know exactly what to do, we can work on this now.


---

Comment by git created at 2020-08-27 21:59:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2020-08-27 22:01:58

I think that is a better plan. I am too stretched for time right now to work on this.


---

Comment by mkoeppe created at 2020-08-27 22:03:07

I agree with this plan - it will also be a good basis for modularization work in 9.3


---

Comment by mkoeppe created at 2020-08-27 22:03:07

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2020-08-27 22:06:45

I am in the process of looking at adding some of the documentation from sage-brial to the sage documentation. At least to see how it looks like.

If you think that's not worth adding now, it is fine.


---

Comment by git created at 2020-08-27 22:34:22

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-08-27 22:34:22

Changing status from positive_review to needs_review.


---

Comment by fbissey created at 2020-08-27 22:38:58

Just a touch up. One doctest was commented out so I decided to enable it. Building documentation revealed formatting issues in docstrings. All in the same file.

I built the doc with some added files from brial and we definitely should keep that for later work. Individual files need sensible title blocks for a start.


---

Comment by mkoeppe created at 2020-08-27 23:18:57

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-09-01 22:59:44

Resolution: fixed
