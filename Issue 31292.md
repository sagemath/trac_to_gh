# Issue 31292: texlive: Add spkg-configure.m4 and system package information

Issue created by migration from https://trac.sagemath.org/ticket/31529

Original creator: mkoeppe

Original creation time: 2021-03-20 18:00:59

CC:  slelievre jhpalmieri vbraun vdelecroix slabbe fbissey arojas tornaria

Right now presence of tex is not tested, and texlive is included in system packages of `_recommended`. 

We also test presence of latex packages that are needed for building the sage pdf documentation


---

Comment by slelievre created at 2021-03-20 18:05:00

To build the documentation in all languages I think we need

```
texlive-lang-cyrillic
texlive-lang-english
texlive-lang-european
texlive-lang-french
texlive-lang-german
texlive-lang-italian
texlive-lang-japanese
texlive-lang-polish
texlive-lang-portuguese
texlive-lang-spanish
```



---

Comment by mkoeppe created at 2021-09-22 02:43:22

New commits:


---

Comment by dimpase created at 2021-12-07 12:55:50

as far as I am concerned it's almost ready - I'd only ask for spkg-install printing something meaningul.


---

Comment by mkoeppe created at 2021-12-09 01:51:51

Changing status from new to needs_info.


---

Comment by mkoeppe created at 2021-12-09 01:51:51

This would need info whether the package is involved in building the binary distribution.


---

Comment by dimpase created at 2021-12-09 08:39:21

I don't think our binary builds ship TeX.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-01-24 19:18:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-01-24 19:21:38

The file `build/pkgs/texlive/package-list.txt` contains a list of packages.

```
$ git log --follow build/pkgs/texlive/package-list.txt 
commit 152d1348b35e23f0b675aa2eaddc09db1f8063e0
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Sat Jan 9 14:15:49 2016 +0100

    Move the texlive install script to a script-type package

commit 37ca6434c6af9c72cf0e524377131aab34fa077b
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Tue Mar 31 11:49:56 2015 +0200

    add two more texlive packages

commit 9f69d3af5bf8c4aeb9a53ca681786d4c1a15a1e5
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Fri Mar 20 20:10:09 2015 +0100

    add tkz to texlive packages

commit ef0319feee59186bf4139673e72c1234434aeba6
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Sun Mar 15 20:07:06 2015 +0100

    add packages required by IPython nbconvert

commit e8ac6085104bed4bcc0b3f56e830fa806f034def
Author: Volker Braun <vbraun.name@gmail.com>
Date:   Sat Feb 28 15:12:47 2015 +0100

    Initial version of the TeXlive install script
```


It does not appear to be used anywhere.


---

Comment by jhpalmieri created at 2022-01-24 19:27:07

In the `develop` branch, that file is used in `build/pkgs/texlive/spkg-install.py`:

```py
def install_packages():
    package_list_txt = os.path.join(
        os.path.dirname(__file__),
        'package-list.txt'
    )
    with open(package_list_txt) as f:
        package_list = f.read()
    ...
```



---

Comment by jhpalmieri created at 2022-01-24 19:28:05

But I agree, once `spkg-install.py` is deleted, it doesn't appear to be used.


---

Comment by mkoeppe created at 2022-01-24 19:41:47

Sorry, yes, that's what I meant. It's not used _otherwise_; it can give us information on what system tex packages will be needed. But I'm not sure if the file is up to date, as the last edit is from 2015.


---

Comment by vbraun created at 2022-01-24 21:25:29

Its not up to date but the necessary changes are going to be relatively small, I don't remember needing any extra packages except for the japanese tour.


---

Comment by slabbe created at 2022-01-25 15:20:11

Just to say that with 9.5.rc4, the current `sage -i texlive` is broken for me and finishes with:


```
[texlive-none] Traceback (most recent call last):
[texlive-none]   File "/home/slabbe/GitBox/sage/build/pkgs/texlive/spkg-install.py", line 133, in <module>
[texlive-none]     install_packages()
[texlive-none]   File "/home/slabbe/GitBox/sage/build/pkgs/texlive/spkg-install.py", line 122, in install_packages
[texlive-none]     check_call(['tlmgr', 'install'] + packages)
[texlive-none]   File "/home/slabbe/GitBox/sage/local/lib/python3.9/subprocess.py", line 373, in check_call
[texlive-none]     raise CalledProcessError(retcode, cmd)
[texlive-none] subprocess.CalledProcessError: Command '['tlmgr', 'install', 'latex', 'titlesec', 'framed', 'threeparttable', 'wrapfig', 'multirow', 'makecmds', 'collection-fontsrecommended', 'tkz-berge', 'tkz-graph', 'cmap', 'fancybox', 'fancyvrb', 'mdwtools', 'parskip', 'jknapltx', 'etoolbox', 'adjustbox', 'xkeyval', 'booktabs', 'collectbox', 'ucs', 'collection-langcyrillic', 'babel-basque', 'babel-catalan', 'babel-czech', 'babel-english', 'babel-french', 'babel-galician', 'babel-german', 'babel-hungarian', 'babel-italian', 'babel-polish', 'babel-portuges', 'babel-russian', 'babel-slovak', 'babel-spanish', 'jsclasses', 'ptex']' returned non-zero exit status 2.
Makefile:2885: recipe for target 'texlive-SAGE_LOCAL-no-deps' failed
make[2]: *** [texlive-SAGE_LOCAL-no-deps] Error 1
```


I am fine with removing a broken install script. Is the status still "needs info"?


---

Comment by slabbe created at 2022-01-25 15:33:36

With the branch, `sage -i texlive` says:


```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG texlive...
checking for latex package required_latex_packages... no
configure: will use system package and not install SPKG texlive
-----------------------------------------------------------------------------
```

Is it normal that it says "no" instead of "yes"?


---

Comment by dimpase created at 2022-01-26 13:49:56

no, this looks like a bug in m4 code.


---

Comment by dimpase created at 2022-01-26 14:27:09

I'll push a fix soon.


---

Comment by dimpase created at 2022-01-26 14:37:16

New commits:


---

Comment by dimpase created at 2022-01-26 14:37:16

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2022-01-26 19:35:50

ok, I now see:


```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG texlive...
checking for latex package fontspec... yes
checking for latex package xunicode... yes
checking for latex package xltxtra... yes
checking for latex package amssymb... yes
checking for latex package amsfonts... yes
checking for latex package graphicx... yes
checking for latex package mathrsfs... yes
checking for latex package textcomp... yes
checking for latex package tikz... yes
checking for latex package tikz-qtree... yes
checking for latex package iftex... yes
checking for latex package tkz-berge... yes
checking for latex package tkz-graph... yes
checking for latex package xy... yes
checking for latex package babel... yes
checking for latex package subfigure... yes
checking for latex package hyperref... yes
checking for latex package hypcap... yes
checking for latex package xr... yes
configure: will use system package and not install SPKG texlive
-----------------------------------------------------------------------------
```



---

Comment by slabbe created at 2022-01-26 19:43:48

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2022-01-26 19:43:48

on github patchbot, code style check with relint fails with 2000 lines of the form


```
1294>        from sage.graphs.all import Graph
sage/groups/perm_gps/partn_ref/refinement_graphs.pyx:1564 namespace_pkg_all_import: import from .all of a namespace package
Hint: Sage library code should not import from sage.PAC.KAGE.all when sage.PAC.KAGE is an implicit
Hint: namespace package. Type import_statements("SOME_IDENTIFIER") to find a more specific import.
```


This is unrelated to the current ticket.


---

Comment by mkoeppe created at 2022-01-27 05:16:55

Our PDF docbuild also needs `latexmk` (as seen in the failure in https://github.com/mkoeppe/sage/runs/4960465123?check_suite_focus=true), so `spkg-configure.m4` should check for this executable

And system package information (for debian, fedora, ...) needs to be added as the ticket promised


---

Comment by mkoeppe created at 2022-01-27 05:16:55

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-01-27 06:28:33

Here's a rough draft of the system package information. Unknown whether necessary or sufficient
----
New commits:


---

Comment by slabbe created at 2022-01-27 08:09:23

ok


---

Comment by mkoeppe created at 2022-01-27 16:58:33

What I added for Debian/Ubuntu is not sufficient:

```
  [sagemath_doc_pdf-none] error installing, exit status 2. End of log file:
  [sagemath_doc_pdf-none]   
  [sagemath_doc_pdf-none]   Enter file name: 
  [sagemath_doc_pdf-none]   ! Emergency stop.
  [sagemath_doc_pdf-none]   <read *> 
  [sagemath_doc_pdf-none]            
  [sagemath_doc_pdf-none]   l.37 \usepackage
  [sagemath_doc_pdf-none]                   {tgheros}^^M
  [sagemath_doc_pdf-none]   !  ==> Fatal error occurred, no output PDF file produced!
  [sagemath_doc_pdf-none]   Transcript written on a_tour_of_sage.log.
  [sagemath_doc_pdf-none]   Latexmk: Missing input file: 'tgtermes.sty' from line
  [sagemath_doc_pdf-none]     '! LaTeX Error: File `tgtermes.sty' not found.'
  [sagemath_doc_pdf-none]   Collected error summary (may duplicate other messages):
  [sagemath_doc_pdf-none]     pdflatex: Command for 'pdflatex' gave return code 1
  [sagemath_doc_pdf-none]         Refer to 'a_tour_of_sage.log' for details
```

https://github.com/mkoeppe/sage/runs/4962385749?check_suite_focus=true


---

Comment by mkoeppe created at 2022-01-27 17:00:55

I forgot that `build/pkgs/_recommended/distros/*.txt` has some lines with the needed system packages - which should be moved into into `build/pkgs/texlive/distros`


---

Comment by git created at 2022-01-27 17:14:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-27 20:41:12

Still the same error in the PDF build after adding `texlive-latex-extra`.

According to https://bugs.debian.org/997448, package `tex-gyre` provides what is needed


---

Comment by git created at 2022-01-27 20:43:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-27 20:47:24

Any takers for the other distributions?


---

Comment by mkoeppe created at 2022-01-28 07:55:41

Next failure on `ubuntu-focal`:

```
/usr/share/texlive/texmf-dist/web2c/mktexnam: Could not map source abbreviation  for rsfs10.
/usr/share/texlive/texmf-dist/web2c/mktexnam: Need to update ?
mktextfm: Running mf-nowin -progname=mf \mode:=ljfour; mag:=1; nonstopmode; input rsfs10
This is METAFONT, Version 2.7182818 (TeX Live 2019/Debian) (preloaded base=mf)

kpathsea: Running mktexmf rsfs10

! I can't find file `rsfs10'.
```



---

Comment by mkoeppe created at 2022-01-28 07:57:37

So we may need `texlive-fonts-recommended` 
(https://tex.stackexchange.com/questions/97123/problem-finding-metafonts-at-compilation)


---

Comment by fbissey created at 2022-01-28 08:12:27

Just reading the git branch so far. How do we deal with language support? Do binary distro just ship all languages in one drop? In Gentoo languages are split and associated with the languages you may decide to setup your system for. If you want to build all the languages in sage you need to have `L10N="ca de en es fr hu it ja pt ru tr"` when you install `texlive`, it brings all those

```
[I] dev-texlive/texlive-langcjk (2021@08/23/21): TeXLive Chinese/Japanese/Korean (base)
[I] dev-texlive/texlive-langcyrillic (2021@08/23/21): TeXLive Cyrillic
[I] dev-texlive/texlive-langenglish (2021@08/23/21): TeXLive US and UK English
[I] dev-texlive/texlive-langeuropean (2021@08/23/21): TeXLive Other European languages
[I] dev-texlive/texlive-langfrench (2021@08/23/21): TeXLive French
[I] dev-texlive/texlive-langgerman (2021@08/23/21): TeXLive German
[I] dev-texlive/texlive-langitalian (2021@08/23/21): TeXLive Italian
[I] dev-texlive/texlive-langjapanese (2021@08/23/21): TeXLive Japanese
[I] dev-texlive/texlive-langportuguese (2021@08/23/21): TeXLive Portuguese
[I] dev-texlive/texlive-langspanish (2021@08/23/21): TeXLive Spanish
```



---

Comment by git created at 2022-01-28 08:16:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-28 17:52:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-30 07:39:26

On `fedora-26`:

```
  [sagemath_doc_pdf-none]   l.43 \usepackage
  [sagemath_doc_pdf-none]                   {sphinx}^^M
  [sagemath_doc_pdf-none]   !  ==> Fatal error occurred, no output PDF file produced!
  [sagemath_doc_pdf-none]   Transcript written on faq.log.
  [sagemath_doc_pdf-none]   ===========Latexmk: Missing input file: 'fncychap.sty' from line
  [sagemath_doc_pdf-none]     '! LaTeX Error: File `fncychap.sty' not found.'
  [sagemath_doc_pdf-none]   Latexmk: Missing input file: 'fncychap.sty' from line
  [sagemath_doc_pdf-none]     '! LaTeX Error: File `fncychap.sty' not found.'
```

----
New commits:


---

Comment by fbissey created at 2022-01-30 07:43:48

That's from `texlive-latexextra`.


---

Comment by mkoeppe created at 2022-01-30 19:40:22

New commits:


---

Comment by git created at 2022-01-30 19:49:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-31 17:50:17

Fedora now works, as tested with `TARGETS_PRE=build-local tox -e docker-fedora-34-recommended -- doc-pdf`


---

Comment by git created at 2022-01-31 22:55:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-01-31 22:55:58

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-01-31 22:59:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-31 23:05:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-02-01 00:03:36

Should add the Gentoo stuff before it gets reviewed.
----
New commits:


---

Comment by mkoeppe created at 2022-02-04 23:37:22

Let's get this in


---

Comment by dimpase created at 2022-02-05 04:34:47

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-02-05 04:34:47

good to go


---

Comment by mkoeppe created at 2022-02-05 05:32:04

Thanks!


---

Comment by @sheerluck created at 2022-02-08 08:31:04

Replying to [comment:57 fbissey]:
> Should add the Gentoo stuff before it gets reviewed.
I think gentoo.txt needs `app-text/dvipng`:

```
Checking whether SageMath should install SPKG texlive...
checking for pdflatex... /usr/bin/pdflatex
checking for latexmk... /usr/bin/latexmk
checking for dvipng... no                <--------- HERE!
checking for latex package fontspec... yes
checking for latex package xunicode... yes
checking for latex package xltxtra... yes
checking for latex package amssymb... yes
checking for latex package amsfonts... yes
checking for latex package graphicx... yes
checking for latex package mathrsfs... yes
checking for latex package textcomp... yes
checking for latex package tikz... yes
checking for latex package tikz-qtree... yes
checking for latex package iftex... yes
checking for latex package tkz-berge... yes
checking for latex package tkz-graph... yes
checking for latex package xy... yes
checking for latex package babel... yes
checking for latex package subfigure... yes
checking for latex package hyperref... yes
checking for latex package hypcap... yes
checking for latex package xr... yes
checking for latex package tgtermes... yes
checking for latex package fncychap... yes
configure: no suitable system package found for SPKG texlive
```



---

Comment by fbissey created at 2022-02-08 08:33:56

darn missed that. It is a dependency of `texlive` if you have the `png` useflag which is of course not guaranteed by the distro file.


---

Comment by git created at 2022-02-08 08:42:52

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-02-08 08:42:52

Changing status from positive_review to needs_review.


---

Comment by fbissey created at 2022-02-08 08:44:46

`@`gh-sheerluck can you double check my last commit and if everything is in right order put the ticket back to positive review. You can also add your name to the reviewer field if you wish.


---

Comment by @sheerluck created at 2022-02-08 08:58:41

Changing status from needs_review to positive_review.


---

Comment by @sheerluck created at 2022-02-08 08:58:41


```
Checking whether SageMath should install SPKG texlive...
checking for pdflatex... /usr/bin/pdflatex
checking for latexmk... /usr/bin/latexmk
checking for dvipng... /usr/bin/dvipng
checking for latex package fontspec... yes
...
configure: will use system package and not install SPKG texlive
```



---

Comment by slelievre created at 2022-02-08 11:48:48

Changing keywords from "" to "texlive, spkg-configure.m4".


---

Comment by mkoeppe created at 2022-02-11 19:50:49

Changing priority from major to critical.


---

Comment by vbraun created at 2022-02-13 10:17:55

Resolution: fixed
