# Issue 22948: A polynomial ring embeds into its fraction field

archive/issues_022948.json:
```json
{
    "body": "Currently, this fails:\n```\nsage: R.<x> = QQ[]\nsage: K.<x> = FractionField(QQ)\nsage: R.is_subring(K)\nNotImplementedError\n```\n\nbut it should return ``True``.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23185\n\n",
    "created_at": "2017-06-09T06:00:05Z",
    "labels": [
        "commutative algebra",
        "minor",
        "bug"
    ],
    "title": "A polynomial ring embeds into its fraction field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22948",
    "user": "saraedum"
}
```
Currently, this fails:
```
sage: R.<x> = QQ[]
sage: K.<x> = FractionField(QQ)
sage: R.is_subring(K)
NotImplementedError
```

but it should return ``True``.

Issue created by migration from https://trac.sagemath.org/ticket/23185





---

archive/issue_comments_321068.json:
```json
{
    "body": "Most likely, we need to patch `_coerce_map_from_` of function fields to return an injective homomorphism.",
    "created_at": "2017-06-09T06:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321068",
    "user": "saraedum"
}
```

Most likely, we need to patch `_coerce_map_from_` of function fields to return an injective homomorphism.



---

archive/issue_comments_321069.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd86.5\".",
    "created_at": "2017-06-09T06:14:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321069",
    "user": "saraedum"
}
```

Changing keywords from "" to "sd86.5".



---

archive/issue_comments_321070.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-06-27T23:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321070",
    "user": "saraedum"
}
```

New commits:



---

archive/issue_comments_321071.json:
```json
{
    "body": "I expect quite a few doctest failures because error messages change.",
    "created_at": "2017-06-27T23:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321071",
    "user": "saraedum"
}
```

I expect quite a few doctest failures because error messages change.



---

archive/issue_comments_321072.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-06-27T23:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321072",
    "user": "saraedum"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_321073.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-06-27T23:53:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321073",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321074.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-06-28T02:23:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321074",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321075.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-14T04:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321075",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321076.json:
```json
{
    "body": "Changing keywords from \"sd86.5\" to \"sd86.5, sd87\".",
    "created_at": "2017-07-17T17:44:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321076",
    "user": "roed"
}
```

Changing keywords from "sd86.5" to "sd86.5, sd87".



---

archive/issue_comments_321077.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-19T23:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321077",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321078.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-20T18:12:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321078",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-20T21:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321079",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321080.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-21T19:31:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321080",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-21T19:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321081",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321082.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-21T19:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321082",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321083.json:
```json
{
    "body": "This has a lot of doctests that fail:\n\n```\nsage -t --warn-long 100.3 src/sage/manifolds/differentiable/metric.py  # 1 doctest failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_rational_field.py  # 5 doctests failed\nsage -t --warn-long 100.3 src/sage/symbolic/expression.pyx  # 3 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py  # 11 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/projective/projective_morphism.py  # 38 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/sha_tate.py  # 1 doctest failed\nsage -t --warn-long 100.3 src/sage/tests/gosper-sum.py  # 12 doctests failed\nsage -t --warn-long 100.3 src/sage/modules/free_module_element.pyx  # 16 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/padics.py  # 2 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_point.py  # 5 doctests failed\nsage -t --warn-long 100.3 src/sage/modules/free_module.py  # 8 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/curves/affine_curve.py  # 16 doctests failed\nsage -t --warn-long 100.3 src/sage/combinat/perfect_matching.py  # 2 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/constructor.py  # 4 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_egros.py  # 3 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/projective/projective_point.py  # 1 doctest failed\nsage -t --warn-long 100.3 src/sage/schemes/affine/affine_morphism.py  # 29 doctests failed\nsage -t --warn-long 100.3 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 1 doctest failed\nsage -t --warn-long 100.3 src/sage/rings/morphism.pyx  # 2 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_tate_curve.py  # 5 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/generic/morphism.py  # 9 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/affine/affine_point.py  # 6 doctests failed\nsage -t --warn-long 100.3 src/sage/rings/polynomial/skew_polynomial_element.pyx  # 8 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/projective/endPN_minimal_model.py  # 2 doctests failed\nsage -t --warn-long 100.3 src/sage/schemes/projective/projective_morphism_helper.pyx  # 3 doctests failed\n\n```\n\n\nIn particular, things that have non-unit denominators are failing to factor.",
    "created_at": "2017-07-21T21:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321083",
    "user": "aly.deines"
}
```

This has a lot of doctests that fail:

```
sage -t --warn-long 100.3 src/sage/manifolds/differentiable/metric.py  # 1 doctest failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_rational_field.py  # 5 doctests failed
sage -t --warn-long 100.3 src/sage/symbolic/expression.pyx  # 3 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py  # 11 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/projective/projective_morphism.py  # 38 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/sha_tate.py  # 1 doctest failed
sage -t --warn-long 100.3 src/sage/tests/gosper-sum.py  # 12 doctests failed
sage -t --warn-long 100.3 src/sage/modules/free_module_element.pyx  # 16 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/padics.py  # 2 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_point.py  # 5 doctests failed
sage -t --warn-long 100.3 src/sage/modules/free_module.py  # 8 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/curves/affine_curve.py  # 16 doctests failed
sage -t --warn-long 100.3 src/sage/combinat/perfect_matching.py  # 2 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/constructor.py  # 4 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_egros.py  # 3 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/projective/projective_point.py  # 1 doctest failed
sage -t --warn-long 100.3 src/sage/schemes/affine/affine_morphism.py  # 29 doctests failed
sage -t --warn-long 100.3 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 1 doctest failed
sage -t --warn-long 100.3 src/sage/rings/morphism.pyx  # 2 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/elliptic_curves/ell_tate_curve.py  # 5 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/generic/morphism.py  # 9 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/affine/affine_point.py  # 6 doctests failed
sage -t --warn-long 100.3 src/sage/rings/polynomial/skew_polynomial_element.pyx  # 8 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/projective/endPN_minimal_model.py  # 2 doctests failed
sage -t --warn-long 100.3 src/sage/schemes/projective/projective_morphism_helper.pyx  # 3 doctests failed

```


In particular, things that have non-unit denominators are failing to factor.



---

archive/issue_comments_321084.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-21T21:56:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321084",
    "user": "aly.deines"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321085.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2017-07-22T03:59:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321085",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_321086.json:
```json
{
    "body": "Last 10 new commits:\n----\nLast 10 new commits:",
    "created_at": "2017-07-22T04:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321086",
    "user": "saraedum"
}
```

Last 10 new commits:
----
Last 10 new commits:



---

archive/issue_comments_321087.json:
```json
{
    "body": "There is no speed regression:\n\n```\nsage: R.<x> = ZpCA(2)[]\nsage: K=R.fraction_field()\nsage: a = x/K(3)\nsage: %timeit R(a)\n10000 loops, best of 3: 98.8 \u00b5s per loop # before\n10000 loops, best of 3: 84.3 \u00b5s per loop # after\nsage: o = K.one()\nsage: %timeit R(o)\n10000 loops, best of 3: 96.5 \u00b5s per loop # before\n10000 loops, best of 3: 82.2 \u00b5s per loop # after\n```\n",
    "created_at": "2017-07-22T04:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321087",
    "user": "saraedum"
}
```

There is no speed regression:

```
sage: R.<x> = ZpCA(2)[]
sage: K=R.fraction_field()
sage: a = x/K(3)
sage: %timeit R(a)
10000 loops, best of 3: 98.8 µs per loop # before
10000 loops, best of 3: 84.3 µs per loop # after
sage: o = K.one()
sage: %timeit R(o)
10000 loops, best of 3: 96.5 µs per loop # before
10000 loops, best of 3: 82.2 µs per loop # after
```




---

archive/issue_comments_321088.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-22T04:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321088",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321089.json:
```json
{
    "body": "The tests pass for the files that failed before.",
    "created_at": "2017-07-22T04:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321089",
    "user": "saraedum"
}
```

The tests pass for the files that failed before.



---

archive/issue_comments_321090.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-22T05:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321090",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321091.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-22T05:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321091",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321092.json:
```json
{
    "body": "The code looks good. Doctests in sage/rings pass. When the patchbot is happy I can give it a positive review.",
    "created_at": "2017-07-22T06:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321092",
    "user": "mmasdeu"
}
```

The code looks good. Doctests in sage/rings pass. When the patchbot is happy I can give it a positive review.



---

archive/issue_comments_321093.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-22T21:52:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321093",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321094.json:
```json
{
    "body": "Julian, quick (possibly stupid) question.  In the class FractionFieldEmbeddingSection, is _call_with_args doing anything that _call_ isn't?  Currently it's the function lacking coverage in fraction_field.py, but maybe we don't need this function?",
    "created_at": "2017-07-22T22:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321094",
    "user": "aly.deines"
}
```

Julian, quick (possibly stupid) question.  In the class FractionFieldEmbeddingSection, is _call_with_args doing anything that _call_ isn't?  Currently it's the function lacking coverage in fraction_field.py, but maybe we don't need this function?



---

archive/issue_comments_321095.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-23T06:49:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321095",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321096.json:
```json
{
    "body": "Replying to [comment:34 aly.deines]:\n> Julian, quick (possibly stupid) question.  In the class FractionFieldEmbeddingSection, is _call_with_args doing anything that _call_ isn't?  Currently it's the function lacking coverage in fraction_field.py, but maybe we don't need this function?\nSome code in schemes does essentially:\n\n```\nsage: K = some_ring.fraction_field()\nsage: some_ring(K.some_element(), check=False)\n```\n\nI guess it was put there for performance reasons. The `check` used to get passed on to the `element_constructor` of `R`. Now there is a proper map, so we need to consume the extra argument. This is done by implementing `_call_with_args`. It does not do anything that `_call_` does not but `Parent` is calling `_call_with_args` if there is any arguments. (I don't really know why `Parent` can't just call `_call_` with arguments.)",
    "created_at": "2017-07-23T06:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321096",
    "user": "saraedum"
}
```

Replying to [comment:34 aly.deines]:
> Julian, quick (possibly stupid) question.  In the class FractionFieldEmbeddingSection, is _call_with_args doing anything that _call_ isn't?  Currently it's the function lacking coverage in fraction_field.py, but maybe we don't need this function?
Some code in schemes does essentially:

```
sage: K = some_ring.fraction_field()
sage: some_ring(K.some_element(), check=False)
```

I guess it was put there for performance reasons. The `check` used to get passed on to the `element_constructor` of `R`. Now there is a proper map, so we need to consume the extra argument. This is done by implementing `_call_with_args`. It does not do anything that `_call_` does not but `Parent` is calling `_call_with_args` if there is any arguments. (I don't really know why `Parent` can't just call `_call_` with arguments.)



---

archive/issue_comments_321097.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-23T06:54:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321097",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321098.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-23T06:55:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321098",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321099.json:
```json
{
    "body": "Looks good once tests pass.",
    "created_at": "2017-07-23T06:56:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321099",
    "user": "roed"
}
```

Looks good once tests pass.



---

archive/issue_comments_321100.json:
```json
{
    "body": "One should avoid comparison of types. Using isinstance is the correct way of doing that.",
    "created_at": "2017-07-23T07:34:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321100",
    "user": "chapoton"
}
```

One should avoid comparison of types. Using isinstance is the correct way of doing that.



---

archive/issue_comments_321101.json:
```json
{
    "body": "chapoton: Do you refer to `_richcmp_`? So, in general I agree that `isinstance` is often better than equality of type. In this case, however, I don't see how someone would inherit from this class and mix this class and its subtype in the same homset \u2013 after all this is a coercion, so how should there be another coercion with the same domain and codomain around? At the same time, rewriting this to use `isinstance` makes the code more complicated.",
    "created_at": "2017-07-23T08:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321101",
    "user": "saraedum"
}
```

chapoton: Do you refer to `_richcmp_`? So, in general I agree that `isinstance` is often better than equality of type. In this case, however, I don't see how someone would inherit from this class and mix this class and its subtype in the same homset – after all this is a coercion, so how should there be another coercion with the same domain and codomain around? At the same time, rewriting this to use `isinstance` makes the code more complicated.



---

archive/issue_comments_321102.json:
```json
{
    "body": "Well, I just wanted to say that comparison of types is not allowed in python3. I spend a lot of time trying to make progress towards python3, and seeing yet more work to be done makes me rather unhappy.\n\nhttps://stackoverflow.com/questions/707674/how-to-compare-type-of-an-object-in-python",
    "created_at": "2017-07-23T09:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321102",
    "user": "chapoton"
}
```

Well, I just wanted to say that comparison of types is not allowed in python3. I spend a lot of time trying to make progress towards python3, and seeing yet more work to be done makes me rather unhappy.

https://stackoverflow.com/questions/707674/how-to-compare-type-of-an-object-in-python



---

archive/issue_comments_321103.json:
```json
{
    "body": "Sure. I thought you were talking about `==` and `!=` but of course we should do something about `<=` and friends here.",
    "created_at": "2017-07-23T15:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321103",
    "user": "saraedum"
}
```

Sure. I thought you were talking about `==` and `!=` but of course we should do something about `<=` and friends here.



---

archive/issue_comments_321104.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-07-23T15:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321104",
    "user": "saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_321105.json:
```json
{
    "body": "There is no need for a new kind of richcmp variant. Just do not compare types, but use isinstance.",
    "created_at": "2017-07-23T18:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321105",
    "user": "chapoton"
}
```

There is no need for a new kind of richcmp variant. Just do not compare types, but use isinstance.



---

archive/issue_comments_321106.json:
```json
{
    "body": "This is a very common task and it is apparently very easy to get wrong. So, I think there is a point in providing a helper that makes this easy to write (and mentioning it in `Element._richcmp_`) I'd like to keep this one line of code without caring about what `op` is exactly, so I'd like to have the new implementation be:\n\n```\nreturn richcmp_unordered((type(self),self.domain(),self.codomain()) == (type(other),other.domain(),other.codomain()), op)\n```\n\n\nOr do you have an idea for a similarly short implementation that gets all the cases right?",
    "created_at": "2017-07-23T21:12:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321106",
    "user": "saraedum"
}
```

This is a very common task and it is apparently very easy to get wrong. So, I think there is a point in providing a helper that makes this easy to write (and mentioning it in `Element._richcmp_`) I'd like to keep this one line of code without caring about what `op` is exactly, so I'd like to have the new implementation be:

```
return richcmp_unordered((type(self),self.domain(),self.codomain()) == (type(other),other.domain(),other.codomain()), op)
```


Or do you have an idea for a similarly short implementation that gets all the cases right?



---

archive/issue_comments_321107.json:
```json
{
    "body": "Actually\n\n```\nreturn richcmp_unordered(type(self) == type(other) and (self.domain(),self.codomain()) == (other.domain(),other.codomain()))\n```\n",
    "created_at": "2017-07-24T01:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321107",
    "user": "saraedum"
}
```

Actually

```
return richcmp_unordered(type(self) == type(other) and (self.domain(),self.codomain()) == (other.domain(),other.codomain()))
```




---

archive/issue_comments_321108.json:
```json
{
    "body": "Replying to [comment:50 saraedum]:\n> Actually\n> {{{\n> return richcmp_unordered(type(self) == type(other) and (self.domain(),self.codomain()) == (other.domain(),other.codomain()))\n> }}}\nIf you want to do just that (go through a boolean), then use `rich_to_bool`\n\nIn most of the cases, one really wants to compare (for inequalities) the rest, once the type is checked to be correct.\n\n***EDIT*** maybe rich_to_bool is not the correct solution here. It is rather used to take as input the result of an oldstyle cmp.",
    "created_at": "2017-07-24T06:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321108",
    "user": "chapoton"
}
```

Replying to [comment:50 saraedum]:
> Actually
> {{{
> return richcmp_unordered(type(self) == type(other) and (self.domain(),self.codomain()) == (other.domain(),other.codomain()))
> }}}
If you want to do just that (go through a boolean), then use `rich_to_bool`

In most of the cases, one really wants to compare (for inequalities) the rest, once the type is checked to be correct.

***EDIT*** maybe rich_to_bool is not the correct solution here. It is rather used to take as input the result of an oldstyle cmp.



---

archive/issue_comments_321109.json:
```json
{
    "body": "Trying to find a solution that both of us would agree on, I would suggest :\n\n0) Do no use your new proposal for a richmp_unordered here, but keep this ticket independent from that. You can then try elsewhere to convince that this is a good idea, without preventing the ticket here to be fixed.\n\n1) use here the standard way to implement richcmp, looking like\n\n```\nif not isinstance(other, FractionFieldEmbeddingSection):\n    return NotImplemented\nreturn richcmp((self.domain(), self.codomain()), (other.domain(), other.codomain()), op)\n```\n",
    "created_at": "2017-07-24T09:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321109",
    "user": "chapoton"
}
```

Trying to find a solution that both of us would agree on, I would suggest :

0) Do no use your new proposal for a richmp_unordered here, but keep this ticket independent from that. You can then try elsewhere to convince that this is a good idea, without preventing the ticket here to be fixed.

1) use here the standard way to implement richcmp, looking like

```
if not isinstance(other, FractionFieldEmbeddingSection):
    return NotImplemented
return richcmp((self.domain(), self.codomain()), (other.domain(), other.codomain()), op)
```




---

archive/issue_comments_321110.json:
```json
{
    "body": "Ok. I think that I am fine with your proposal 1). The only thing I don't like about it is that if domain and codomain implement `<=` for whatever reason, then `self` will do as well. I am not sure if that's a good idea but I also don't mind.",
    "created_at": "2017-07-24T11:40:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321110",
    "user": "saraedum"
}
```

Ok. I think that I am fine with your proposal 1). The only thing I don't like about it is that if domain and codomain implement `<=` for whatever reason, then `self` will do as well. I am not sure if that's a good idea but I also don't mind.



---

archive/issue_comments_321111.json:
```json
{
    "body": "Shouldn't we raise a `TypeError` instead of `NotImplemented`? That seems to be what Python3 does:\n\n```\n>>> \"\" < 0\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: '<' not supported between instances of 'str' and 'int'\n```\n",
    "created_at": "2017-07-24T11:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321111",
    "user": "saraedum"
}
```

Shouldn't we raise a `TypeError` instead of `NotImplemented`? That seems to be what Python3 does:

```
>>> "" < 0
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: '<' not supported between instances of 'str' and 'int'
```




---

archive/issue_comments_321112.json:
```json
{
    "body": "Replying to [comment:54 saraedum]:\n> Shouldn't we raise a `TypeError` instead of `NotImplemented`? That seems to be what Python3 does:\n> {{{\n> >>> \"\" < 0\n> Traceback (most recent call last):\n>   File \"<stdin>\", line 1, in <module>\n> TypeError: '<' not supported between instances of 'str' and 'int'\n> }}}\n\nNo, I do not think so. It seems that NotImplemented is what one should answer when not knowing how to compare. Python will know what to do with that, hopefuly.",
    "created_at": "2017-07-24T12:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321112",
    "user": "chapoton"
}
```

Replying to [comment:54 saraedum]:
> Shouldn't we raise a `TypeError` instead of `NotImplemented`? That seems to be what Python3 does:
> {{{
> >>> "" < 0
> Traceback (most recent call last):
>   File "<stdin>", line 1, in <module>
> TypeError: '<' not supported between instances of 'str' and 'int'
> }}}

No, I do not think so. It seems that NotImplemented is what one should answer when not knowing how to compare. Python will know what to do with that, hopefuly.



---

archive/issue_comments_321113.json:
```json
{
    "body": "Replying to [comment:54 saraedum]:\n> Shouldn't we raise a `TypeError` instead of `NotImplemented`?\n\nNo and let me elaborate on that:\n\nWhen doing `A < B`, Python first calls `A.__lt__(B)` (*). If that returns a value different from `NotImplemented`, or if this raises an exception, this value or exception is the result of `A < B`. On the other hand, if `A.__lt__(B)` returns `NotImplemented`, then Python calls `B.__gt__(A)` (*). If that also returns `NotImplemented`, then Python 3 raises a `TypeError`. Python 2 falls back to `__cmp__` instead.\n\nWhat I just described is the Python behaviour. In this case, if the parents are not equal, the coercion model is involved too and that by itself does a fallback in case of `NotImplemented`.\n\n(*) NOTE: to be very precise, it actually does `type(A).__lt__(A, B)`, but that is equivalent to `A.__lt__(B)`, except that it does not look in `A.__dict__`.",
    "created_at": "2017-07-24T12:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321113",
    "user": "jdemeyer"
}
```

Replying to [comment:54 saraedum]:
> Shouldn't we raise a `TypeError` instead of `NotImplemented`?

No and let me elaborate on that:

When doing `A < B`, Python first calls `A.__lt__(B)` (*). If that returns a value different from `NotImplemented`, or if this raises an exception, this value or exception is the result of `A < B`. On the other hand, if `A.__lt__(B)` returns `NotImplemented`, then Python calls `B.__gt__(A)` (*). If that also returns `NotImplemented`, then Python 3 raises a `TypeError`. Python 2 falls back to `__cmp__` instead.

What I just described is the Python behaviour. In this case, if the parents are not equal, the coercion model is involved too and that by itself does a fallback in case of `NotImplemented`.

(*) NOTE: to be very precise, it actually does `type(A).__lt__(A, B)`, but that is equivalent to `A.__lt__(B)`, except that it does not look in `A.__dict__`.



---

archive/issue_comments_321114.json:
```json
{
    "body": "Thanks for explaining, I was not aware of that.\n\nReplying to [comment:57 jdemeyer]:\n> Replying to [comment:54 saraedum]:\n> When doing `A < B`, Python first calls `A.__lt__(B)` (*). If that returns a value different from `NotImplemented`, or if this raises an exception, this value or exception is the result of `A < B`. On the other hand, if `A.__lt__(B)` returns `NotImplemented`, then Python calls `B.__gt__(A)` (*). If that also returns `NotImplemented`, then Python 3 raises a `TypeError`. Python 2 falls back to `__cmp__` instead.\n\nDoes that not mean that we should favor\n\n```\nif type(self) != type(other): return NotImplemented\n\u2026\n```\n\nover\n\n```\nif isinstance(other, MyType): return NotImplemented\n\u2026\n```\n\nas the former means that a subclass can override `_richcmp_` with a more specific check and it will always get called? Whereas in the latter it depends on the order of arguments what happens?",
    "created_at": "2017-07-27T23:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321114",
    "user": "saraedum"
}
```

Thanks for explaining, I was not aware of that.

Replying to [comment:57 jdemeyer]:
> Replying to [comment:54 saraedum]:
> When doing `A < B`, Python first calls `A.__lt__(B)` (*). If that returns a value different from `NotImplemented`, or if this raises an exception, this value or exception is the result of `A < B`. On the other hand, if `A.__lt__(B)` returns `NotImplemented`, then Python calls `B.__gt__(A)` (*). If that also returns `NotImplemented`, then Python 3 raises a `TypeError`. Python 2 falls back to `__cmp__` instead.

Does that not mean that we should favor

```
if type(self) != type(other): return NotImplemented
…
```

over

```
if isinstance(other, MyType): return NotImplemented
…
```

as the former means that a subclass can override `_richcmp_` with a more specific check and it will always get called? Whereas in the latter it depends on the order of arguments what happens?



---

archive/issue_comments_321115.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-07-27T23:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321115",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_321116.json:
```json
{
    "body": "New commits:\n----\nNew commits:",
    "created_at": "2017-07-27T23:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321116",
    "user": "saraedum"
}
```

New commits:
----
New commits:



---

archive/issue_comments_321117.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-07-27T23:22:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321117",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_321118.json:
```json
{
    "body": "I've changed the hashes, since there could be multiple rings with the same fraction field.  I ran tests, so if you're happy with these changes, feel free to give a positive review.",
    "created_at": "2017-08-04T05:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321118",
    "user": "roed"
}
```

I've changed the hashes, since there could be multiple rings with the same fraction field.  I ran tests, so if you're happy with these changes, feel free to give a positive review.



---

archive/issue_comments_321119.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-08T16:43:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321119",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_321120.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-08-11T18:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22948",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22948#issuecomment-321120",
    "user": "vbraun"
}
```

Resolution: fixed
