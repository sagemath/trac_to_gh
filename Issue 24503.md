# Issue 24503: py3: numerous string fixes to sage.numerical.backends

Issue created by migration from https://trac.sagemath.org/ticket/24740

Original creator: embray

Original creation time: 2018-02-15 14:50:51

Trying to make progress on my backlog of Python 3 fixes I haven't made tickets for...

This one is slightly questionable in that there were many `cpdef` functions in this package that take `char *` arguments, and I changed them to take non-typed arguments (effectively `str`).

I'm not exactly sure what implication this has for the C interfaces that were exported for these methods, or if we care.


---

Comment by git created at 2018-02-15 14:51:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-15 14:51:41

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-27 09:43:02

Replying to [ticket:24740 embray]:
> This one is slightly questionable in that there were many `cpdef` functions in this package that take `char *` arguments, and I changed them to take non-typed arguments (effectively `str`).

They don't seem to be performance-critical methods, so I'm fine with it.

One potential problem for reviewing this ticket is that it involves several external packages, some of which are not even free to install.


---

Comment by jdemeyer created at 2018-02-27 09:46:41

This ticket makes me think of a general problem with `str_to_bytes`: I think you should always accept `bytes` for filenames (Python generally does that). So it might be a good idea to allow `str_to_bytes` to accept `bytes` input (I said this before but you refused that). What do you think?


---

Comment by jdemeyer created at 2018-02-27 09:47:21

In `src/sage/numerical/backends/gurobi_backend.pyx` I see a `if name` which should be `if name is not None`


---

Comment by jdemeyer created at 2018-02-27 09:47:21

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-27 09:50:29

Several "vertex" methods in `glpk_graph_backend.pyx` used a take a `char*` as argument. To me, it's not obvious to me that the canonical replacement is `str` (as opposed to `bytes`). In any case, it feels wrong to disallow `bytes`.


---

Comment by embray created at 2018-02-27 11:56:36

Replying to [comment:4 jdemeyer]:
> This ticket makes me think of a general problem with `str_to_bytes`: I think you should always accept `bytes` for filenames (Python generally does that). So it might be a good idea to allow `str_to_bytes` to accept `bytes` input (I said this before but you refused that). What do you think?

That would actually be bad because it would break most cases which explicitly should not accept bytes.  Specifically for filenames, it's better to just make a special case for accepting bytes.  Though I don't think high-level file handling functions need accept bytes in most cases either unless there were an explicit reason to.


---

Comment by embray created at 2018-02-27 12:07:46

Replying to [comment:6 jdemeyer]:
> Several "vertex" methods in `glpk_graph_backend.pyx` used a take a `char*` as argument. To me, it's not obvious to me that the canonical replacement is `str` (as opposed to `bytes`). In any case, it feels wrong to disallow `bytes`.

I can't say I'm 100% clear on that myself since it's not obvious that this code is even used anywhere in Sage.  But it's duplicating the Sage Graph API and I don't see what makes you think it should accept bytes.


---

Comment by embray created at 2018-02-27 12:10:52

Replying to [comment:3 jdemeyer]:
> Replying to [ticket:24740 embray]:
> > This one is slightly questionable in that there were many `cpdef` functions in this package that take `char *` arguments, and I changed them to take non-typed arguments (effectively `str`).
> 
> They don't seem to be performance-critical methods, so I'm fine with it.
> 
> One potential problem for reviewing this ticket is that it involves several external packages, some of which are not even free to install.

It is a problem, and some of these modules are not well tested because of it.  Though in the cases I've changed it should be fairly clear that it's the right approach in general (i.e. we are passing python `str`s to interfaces that expect `char *`).


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by jdemeyer created at 2018-08-07 12:48:23

Replying to [comment:7 embray]:
> Specifically for filenames, it's better to just make a special case for accepting bytes.

How about a new function `filename_to_bytes()`? I never liked the look of `str_to_bytes(fname, FS_ENCODING, 'surrogateescape')` anyway, `filename_to_bytes(fname)` would look much better.


---

Comment by embray created at 2018-08-16 11:01:28

How does this ticket now relate to #26020?  It wasn't clear to me why it needed to broken into a separate ticket in the first place.

Are we still going to add `filename_to_bytes()`?  I like the idea but it should probably be done separately.


---

Comment by embray created at 2018-08-16 11:01:36

Changing status from needs_work to needs_info.


---

Comment by mkoeppe created at 2018-10-07 22:42:09

These changes look fine to me (but I haven't tested anything).


---

Comment by chapoton created at 2018-11-23 16:36:13

`@`embray, will you be able to finish this one and #24741 ?


---

Comment by embray created at 2018-11-28 08:14:14

Sorry, yeah, I'll take care of it.  I think I stalled on this one because Jeroen had made some comments earlier, which seemed to suggest a course of action he preferred, and I was waiting for confirmation from him but it never came.  I'll just clean up the existing fixes here and worry about the `filename_to_bytes()` thing later.


---

Comment by chapoton created at 2018-12-07 19:50:59

Changing status from needs_info to needs_work.


---

Comment by git created at 2018-12-10 13:34:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-12-10 13:36:56

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-12-10 13:36:56

I just rebased the existing branch on 8.5.beta6.

I can see that there's a case to be made for still allowing some of these methods to accept filenames as bytes, but I think this is fine for now until and unless a specific need for it arises.


---

Comment by chapoton created at 2018-12-13 11:02:09

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2018-12-13 11:02:09

the import of `char_to_str` seem not to be used in `backends/coin_backend.pyx`


---

Comment by git created at 2018-12-13 11:21:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-12-13 11:23:29

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-12-13 15:39:12

in src/sage/numerical/backends/cvxopt_sdp_backend.pyx,
the INPUT field must be modified

same in src/sage/numerical/backends/generic_sdp_backend.pyx

otherwise, looks good to me (as far as I can tell)


---

Comment by chapoton created at 2018-12-13 15:39:12

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-12-13 16:04:13

Ah, very true (not that many people are likely to read that, but best to be consistent).


---

Comment by embray created at 2018-12-13 16:08:16

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-12-13 16:08:16

No, they're fine.  I checked the code and it doesn't need updating in those cases.  For some reason they already correctly read `str` instead of `char *`.


---

Comment by chapoton created at 2018-12-13 18:51:05

oh, well. Let it be.

`@`vbraun: probably safer to keep this one for 8.6.beta0


---

Comment by chapoton created at 2018-12-13 18:51:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-23 23:41:08

Resolution: fixed


---

Comment by slabbe created at 2019-01-03 10:15:15

Maybe the problem described in ticket #26999 was produced by the numerous string fixes made here. Can you take a look?
