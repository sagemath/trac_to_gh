# Issue 17182: SageDoctestTextFormatter: remove @warn_format_error

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2014-11-30 13:42:56

CC:  vbraun

In the command line:

```
sage: plot(x, typeset='garbage')
[...]
ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
```


However, in a doctest, this becomes

```
sage: plot(x, typeset='garbage')
doctest:...: FormatterWarning: Exception in text/plain formatter: 
typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
None
```


For consistency, I propose to remove the ``@`warn_format_error` from `SageDoctestTextFormatter.__call__`


---

Comment by vbraun created at 2014-11-30 14:06:49

No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. 

Really, the issue is that plots are terrible at validation. It is way too easy to construct plots that then fail later, potentially after combining them with other plots.


---

Comment by vbraun created at 2014-11-30 14:08:33

PS: in 6.5.beta1 I get

```
sage: plot(x, typeset='garbage')
/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
```

I propose to close as fixed.


---

Comment by jdemeyer created at 2014-11-30 14:21:21

I now get (sage-6.5.beta1):

```
sage: plot(x, typeset='garbage')
/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
  FormatterWarning,
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-1-37a028c62b8b> in <module>()
----> 1 plot(x, typeset='garbage')

/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    251             self.write_output_prompt()
    252             format_dict, md_dict = self.compute_format_data(result)
--> 253             self.write_format_data(format_dict, md_dict)
    254             self.update_user_ns(result)
    255             self.log_output(format_dict)

/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in write_format_data(self, format_dict, md_dict)
    172         # newline, even if all the prompt separators are ''. This is the
    173         # standard IPython behavior.
--> 174         result_repr = format_dict['text/plain']
    175         if '\n' in result_repr:
    176             # So that multi-line strings line up with the left column of

KeyError: 'text/plain'
```



---

Comment by vbraun created at 2014-11-30 14:23:07

Yes, the traceback is as expected, too. There is no 'text/plain' output because that raised an exception.


---

Comment by jdemeyer created at 2014-11-30 14:26:35

Sorry for the confusion, I was testing the IPython master.

Then the `ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'` traceback in shown in any case (both the command line and the doctest). So it seems that ``@`warn_format_error` stopped working...


---

Comment by jdemeyer created at 2014-11-30 14:27:57

Replying to [comment:1 vbraun]:
> No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. 
It's not `__repr__()` which fails here, it's `_graphics_()` which fails. An important distinction.


---

Comment by jdemeyer created at 2014-11-30 14:29:14

Since `_graphics_()` is sort of the main point of `Graphics` objects, I doubt that we should downgrade exceptions to warnings. So my proposal would be the opposite of yours: always treat `_graphics_()` exceptions as true exceptions.


---

Comment by vbraun created at 2014-11-30 14:32:17

No, it works as expected. Well, IPython could show a nicer diagnostic in case `text/plain` fails, but really you shouldn't build a UI around objects that fall flat on their face when you print them. 

Right now we only use `_graphics_` in IPython's plain text formatter. This is part of the stupid design for how graphics shows itself as a side effect of calling `__repr__`. Should be fixed by #17234 when its ready.


---

Comment by jdemeyer created at 2014-12-01 09:42:29

When you're redesigning the IPython interface, could you try to make it compatible with IPython master?


---

Comment by vbraun created at 2014-12-01 09:43:00

Is there a ticket for the IPython 3.0 upgrade, or even an upstream release?

IMHO it is a bug if upstream master doesn't catch the exception.


---

Comment by jdemeyer created at 2014-12-01 09:45:27

Replying to [comment:11 vbraun]:
> Is there a ticket for the IPython 3.0 upgrade
Not yet, but if you want I can easily create one...

In any case, there is no IPython 3 release yet, but that doesn't mean we shouldn't anticipate it.

> IMHO it is a bug if upstream master doesn't catch the exception.
It catches the exception and prints a traceback. Which to the user is indistinguishable from not catching the exception.


---

Comment by jdemeyer created at 2014-12-01 09:50:24

Feel free to submit an upstream bug about the changed behaviour of `warn_format_error`.


---

Comment by gagern created at 2015-03-11 21:57:35

[IPython 3 has been released](http://ipython.org/ipython-doc/3/whatsnew/version3.html#release-3-0).

A while ago, upstream renamed the `warn_format_error` decorator to `catch_format_error` in [f3d60](https://github.com/ipython/ipython/commit/f3d604d86088fcd6aa7b09a691edc0fde26e5573) in response to [the upstream bug report](https://github.com/ipython/ipython/issues/7072) which has been declared closed in the process. [04bb1](https://github.com/ipython/ipython/commit/04bb1e712ab39a61adecad1153e8afee79402c66) which changed the behavior to show a backtrace instead of a warning has not been reverted.

The name change means that at the moment we get an import error for [formatter.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/repl/display/formatter.py?h=develop&id=2d915f086b25c7c72cf1fc9d0dd441015abd9fad#n64) when running with IPython 3, as I do on Gentoo.


---

Comment by vbraun created at 2015-03-11 22:26:06

Fixed in #17826


---

Comment by vbraun created at 2015-03-11 22:26:38

propose to close as duplicate/fixed


---

Comment by vbraun created at 2015-03-11 22:27:04

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-03-11 22:28:51

PS: Actual output after #17826

```
sage: plot(x, typeset='garbage')
.../display_manager.py:541: RichReprWarning: Exception in _rich_repr_ while displaying object: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
  RichReprWarning,
Graphics object consisting of 1 graphics primitive
```



---

Comment by jdemeyer created at 2015-03-13 08:39:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-03-13 09:02:49

Resolution: fixed
