# Issue 17182: SageDoctestTextFormatter: remove @warn_format_error

archive/issues_017182.json:
```json
{
    "body": "CC:  vbraun\n\nIn the command line:\n\n```\nsage: plot(x, typeset='garbage')\n[...]\nValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n```\n\n\nHowever, in a doctest, this becomes\n\n```\nsage: plot(x, typeset='garbage')\ndoctest:...: FormatterWarning: Exception in text/plain formatter: \ntypeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\nNone\n```\n\n\nFor consistency, I propose to remove the ``@`warn_format_error` from `SageDoctestTextFormatter.__call__`\n\nIssue created by migration from https://trac.sagemath.org/ticket/17419\n\n",
    "created_at": "2014-11-30T13:42:56Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "title": "SageDoctestTextFormatter: remove @warn_format_error",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17182",
    "user": "jdemeyer"
}
```
CC:  vbraun

In the command line:

```
sage: plot(x, typeset='garbage')
[...]
ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
```


However, in a doctest, this becomes

```
sage: plot(x, typeset='garbage')
doctest:...: FormatterWarning: Exception in text/plain formatter: 
typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
None
```


For consistency, I propose to remove the ``@`warn_format_error` from `SageDoctestTextFormatter.__call__`

Issue created by migration from https://trac.sagemath.org/ticket/17419





---

archive/issue_comments_228388.json:
```json
{
    "body": "No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. \n\nReally, the issue is that plots are terrible at validation. It is way too easy to construct plots that then fail later, potentially after combining them with other plots.",
    "created_at": "2014-11-30T14:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228388",
    "user": "vbraun"
}
```

No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. 

Really, the issue is that plots are terrible at validation. It is way too easy to construct plots that then fail later, potentially after combining them with other plots.



---

archive/issue_comments_228389.json:
```json
{
    "body": "PS: in 6.5.beta1 I get\n\n```\nsage: plot(x, typeset='garbage')\n/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n```\n\nI propose to close as fixed.",
    "created_at": "2014-11-30T14:08:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228389",
    "user": "vbraun"
}
```

PS: in 6.5.beta1 I get

```
sage: plot(x, typeset='garbage')
/home/vbraun/Code/sage.git/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
```

I propose to close as fixed.



---

archive/issue_comments_228390.json:
```json
{
    "body": "I now get (sage-6.5.beta1):\n\n```\nsage: plot(x, typeset='garbage')\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n  FormatterWarning,\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n<ipython-input-1-37a028c62b8b> in <module>()\n----> 1 plot(x, typeset='garbage')\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)\n    251             self.write_output_prompt()\n    252             format_dict, md_dict = self.compute_format_data(result)\n--> 253             self.write_format_data(format_dict, md_dict)\n    254             self.update_user_ns(result)\n    255             self.log_output(format_dict)\n\n/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in write_format_data(self, format_dict, md_dict)\n    172         # newline, even if all the prompt separators are ''. This is the\n    173         # standard IPython behavior.\n--> 174         result_repr = format_dict['text/plain']\n    175         if '\\n' in result_repr:\n    176             # So that multi-line strings line up with the left column of\n\nKeyError: 'text/plain'\n```\n",
    "created_at": "2014-11-30T14:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228390",
    "user": "jdemeyer"
}
```

I now get (sage-6.5.beta1):

```
sage: plot(x, typeset='garbage')
/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/formatters.py:239: FormatterWarning: Exception in text/plain formatter: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
  FormatterWarning,
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-1-37a028c62b8b> in <module>()
----> 1 plot(x, typeset='garbage')

/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in __call__(self, result)
    251             self.write_output_prompt()
    252             format_dict, md_dict = self.compute_format_data(result)
--> 253             self.write_format_data(format_dict, md_dict)
    254             self.update_user_ns(result)
    255             self.log_output(format_dict)

/usr/local/src/sage-config/local/lib/python2.7/site-packages/IPython/core/displayhook.pyc in write_format_data(self, format_dict, md_dict)
    172         # newline, even if all the prompt separators are ''. This is the
    173         # standard IPython behavior.
--> 174         result_repr = format_dict['text/plain']
    175         if '\n' in result_repr:
    176             # So that multi-line strings line up with the left column of

KeyError: 'text/plain'
```




---

archive/issue_comments_228391.json:
```json
{
    "body": "Yes, the traceback is as expected, too. There is no 'text/plain' output because that raised an exception.",
    "created_at": "2014-11-30T14:23:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228391",
    "user": "vbraun"
}
```

Yes, the traceback is as expected, too. There is no 'text/plain' output because that raised an exception.



---

archive/issue_comments_228392.json:
```json
{
    "body": "Sorry for the confusion, I was testing the IPython master.\n\nThen the `ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'` traceback in shown in any case (both the command line and the doctest). So it seems that ``@`warn_format_error` stopped working...",
    "created_at": "2014-11-30T14:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228392",
    "user": "jdemeyer"
}
```

Sorry for the confusion, I was testing the IPython master.

Then the `ValueError: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'` traceback in shown in any case (both the command line and the doctest). So it seems that ``@`warn_format_error` stopped working...



---

archive/issue_comments_228393.json:
```json
{
    "body": "Replying to [comment:1 vbraun]:\n> No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. \nIt's not `__repr__()` which fails here, it's `_graphics_()` which fails. An important distinction.",
    "created_at": "2014-11-30T14:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228393",
    "user": "jdemeyer"
}
```

Replying to [comment:1 vbraun]:
> No, we should have the ``@`warn_format_error` everywhere. It makes it clear that `__repr__` failed, not the object creation. 
It's not `__repr__()` which fails here, it's `_graphics_()` which fails. An important distinction.



---

archive/issue_comments_228394.json:
```json
{
    "body": "Since `_graphics_()` is sort of the main point of `Graphics` objects, I doubt that we should downgrade exceptions to warnings. So my proposal would be the opposite of yours: always treat `_graphics_()` exceptions as true exceptions.",
    "created_at": "2014-11-30T14:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228394",
    "user": "jdemeyer"
}
```

Since `_graphics_()` is sort of the main point of `Graphics` objects, I doubt that we should downgrade exceptions to warnings. So my proposal would be the opposite of yours: always treat `_graphics_()` exceptions as true exceptions.



---

archive/issue_comments_228395.json:
```json
{
    "body": "No, it works as expected. Well, IPython could show a nicer diagnostic in case `text/plain` fails, but really you shouldn't build a UI around objects that fall flat on their face when you print them. \n\nRight now we only use `_graphics_` in IPython's plain text formatter. This is part of the stupid design for how graphics shows itself as a side effect of calling `__repr__`. Should be fixed by #17234 when its ready.",
    "created_at": "2014-11-30T14:32:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228395",
    "user": "vbraun"
}
```

No, it works as expected. Well, IPython could show a nicer diagnostic in case `text/plain` fails, but really you shouldn't build a UI around objects that fall flat on their face when you print them. 

Right now we only use `_graphics_` in IPython's plain text formatter. This is part of the stupid design for how graphics shows itself as a side effect of calling `__repr__`. Should be fixed by #17234 when its ready.



---

archive/issue_comments_228396.json:
```json
{
    "body": "When you're redesigning the IPython interface, could you try to make it compatible with IPython master?",
    "created_at": "2014-12-01T09:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228396",
    "user": "jdemeyer"
}
```

When you're redesigning the IPython interface, could you try to make it compatible with IPython master?



---

archive/issue_comments_228397.json:
```json
{
    "body": "Is there a ticket for the IPython 3.0 upgrade, or even an upstream release?\n\nIMHO it is a bug if upstream master doesn't catch the exception.",
    "created_at": "2014-12-01T09:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228397",
    "user": "vbraun"
}
```

Is there a ticket for the IPython 3.0 upgrade, or even an upstream release?

IMHO it is a bug if upstream master doesn't catch the exception.



---

archive/issue_comments_228398.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> Is there a ticket for the IPython 3.0 upgrade\nNot yet, but if you want I can easily create one...\n\nIn any case, there is no IPython 3 release yet, but that doesn't mean we shouldn't anticipate it.\n\n> IMHO it is a bug if upstream master doesn't catch the exception.\nIt catches the exception and prints a traceback. Which to the user is indistinguishable from not catching the exception.",
    "created_at": "2014-12-01T09:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228398",
    "user": "jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> Is there a ticket for the IPython 3.0 upgrade
Not yet, but if you want I can easily create one...

In any case, there is no IPython 3 release yet, but that doesn't mean we shouldn't anticipate it.

> IMHO it is a bug if upstream master doesn't catch the exception.
It catches the exception and prints a traceback. Which to the user is indistinguishable from not catching the exception.



---

archive/issue_comments_228399.json:
```json
{
    "body": "Feel free to submit an upstream bug about the changed behaviour of `warn_format_error`.",
    "created_at": "2014-12-01T09:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228399",
    "user": "jdemeyer"
}
```

Feel free to submit an upstream bug about the changed behaviour of `warn_format_error`.



---

archive/issue_comments_228400.json:
```json
{
    "body": "[IPython 3 has been released](http://ipython.org/ipython-doc/3/whatsnew/version3.html#release-3-0).\n\nA while ago, upstream renamed the `warn_format_error` decorator to `catch_format_error` in [f3d60](https://github.com/ipython/ipython/commit/f3d604d86088fcd6aa7b09a691edc0fde26e5573) in response to [the upstream bug report](https://github.com/ipython/ipython/issues/7072) which has been declared closed in the process. [04bb1](https://github.com/ipython/ipython/commit/04bb1e712ab39a61adecad1153e8afee79402c66) which changed the behavior to show a backtrace instead of a warning has not been reverted.\n\nThe name change means that at the moment we get an import error for [formatter.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/repl/display/formatter.py?h=develop&id=2d915f086b25c7c72cf1fc9d0dd441015abd9fad#n64) when running with IPython 3, as I do on Gentoo.",
    "created_at": "2015-03-11T21:57:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228400",
    "user": "gagern"
}
```

[IPython 3 has been released](http://ipython.org/ipython-doc/3/whatsnew/version3.html#release-3-0).

A while ago, upstream renamed the `warn_format_error` decorator to `catch_format_error` in [f3d60](https://github.com/ipython/ipython/commit/f3d604d86088fcd6aa7b09a691edc0fde26e5573) in response to [the upstream bug report](https://github.com/ipython/ipython/issues/7072) which has been declared closed in the process. [04bb1](https://github.com/ipython/ipython/commit/04bb1e712ab39a61adecad1153e8afee79402c66) which changed the behavior to show a backtrace instead of a warning has not been reverted.

The name change means that at the moment we get an import error for [formatter.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/repl/display/formatter.py?h=develop&id=2d915f086b25c7c72cf1fc9d0dd441015abd9fad#n64) when running with IPython 3, as I do on Gentoo.



---

archive/issue_comments_228401.json:
```json
{
    "body": "Fixed in #17826",
    "created_at": "2015-03-11T22:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228401",
    "user": "vbraun"
}
```

Fixed in #17826



---

archive/issue_comments_228402.json:
```json
{
    "body": "propose to close as duplicate/fixed",
    "created_at": "2015-03-11T22:26:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228402",
    "user": "vbraun"
}
```

propose to close as duplicate/fixed



---

archive/issue_comments_228403.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-03-11T22:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228403",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_228404.json:
```json
{
    "body": "PS: Actual output after #17826\n\n```\nsage: plot(x, typeset='garbage')\n.../display_manager.py:541: RichReprWarning: Exception in _rich_repr_ while displaying object: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.\n  RichReprWarning,\nGraphics object consisting of 1 graphics primitive\n```\n",
    "created_at": "2015-03-11T22:28:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228404",
    "user": "vbraun"
}
```

PS: Actual output after #17826

```
sage: plot(x, typeset='garbage')
.../display_manager.py:541: RichReprWarning: Exception in _rich_repr_ while displaying object: typeset must be set to one of 'default', 'latex', or 'type1'; got 'garbage'.
  RichReprWarning,
Graphics object consisting of 1 graphics primitive
```




---

archive/issue_comments_228405.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-03-13T08:39:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228405",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_228406.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-03-13T09:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17182",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17182#issuecomment-228406",
    "user": "vbraun"
}
```

Resolution: fixed
