# Issue 12893: simon_two_descent not working

Issue created by migration from https://trac.sagemath.org/ticket/13065

Original creator: alexc

Original creation time: 2012-05-30 20:21:27

Assignee: cremona

Keywords: EllipticCurve simon_two_descent gp pari

In certain cases simon_two_descent produces an error. For example:


```
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: poly = CyclotomicField(43).subfields(3)[0][0].polynomial()
sage: poly
x^3 + x^2 - 14*x + 8
sage: K = NumberField(poly, 'a')
sage: E = EllipticCurve(K, '37')
sage: E
Elliptic Curve defined by y^2 + y = x^3 + (-1)*x over Number Field in
a with defining polynomial x^3 + x^2 - 14*x + 8
sage: E.simon_two_descent()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call
last)
| Sage Version 5.0, Release Date: 2012-05-14                         |
| Type notebook() for the GUI, and license() for information.        |
/home/blatm/<ipython console> in <module>()

/home/blatm/sage/sage-5.0-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/
local/lib/python2.7/site-packages/sage/schemes/elliptic_curves/
ell_number_field.pyc in simon_two_descent(self, verbose, lim1, lim3,
limtriv, maxprob, limbigprime)
    281                               verbose=verbose, lim1=lim1,
lim3=lim3, limtriv=limtriv,
    282                               maxprob=maxprob,
limbigprime=limbigprime)
--> 283         prob_rank = Integer(t[0])
    284         two_selmer_rank = Integer(t[1])
    285         prob_gens = [self(P) for P in t[2]]

/home/blatm/sage/sage-5.0-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/
local/lib/python2.7/site-packages/sage/rings/integer.so in
sage.rings.integer.Integer.__init__ (sage/rings/integer.c:6865)()

TypeError: unable to convert x (=f) to an integer
```


I have tried Simon's scripts in gp directly, and this case fails there as well:


```
sage: gp.console()
Reading GPRC: /home/blatm/sage/sage-5.0-linux-64bit-ubuntu_10.04.3_lts-x86_64-Linux/local/etc/gprc.expect ...Done.

           GP/PARI CALCULATOR Version 2.5.1 (development git-5c5e253)
          amd64 running linux (x86-64/GMP-5.0.2 kernel) 64-bit version
                    compiled: May 14 2012, gcc-4.6.3 (GCC) 
                 (readline v6.2 enabled, extended help enabled)

                     Copyright (C) 2000-2011 The PARI Group

PARI/GP is free software, covered by the GNU General Public License, and comes 
WITHOUT ANY WARRANTY WHATSOEVER.

Type ? for help, \q to quit.
Type ?12 for how to get moral (and possibly technical) support.

parisize = 8000000, primelimit = 500509
? \r ~/pari/pari-2.5.1/examples/ell.gp \\This is Simon's 2-descent script, taken from his webpage.
? K = bnfinit(y^3+y^2-14*y+8);
? E37A = [0,0,1,-1,0];
? bnfellrank(K,E37A)
  ***   at top-level: bnfellrank(K,E37A)
  ***                 ^------------------
  ***   in function bnfellrank: ...eqtheta,rnfeq,bbnf];rang=
  ***   bnfell2descent_gen(b
  ***   ^--------------------
  ***   in function bnfell2descent_gen: ...und,r=nfsqrt(nf,norm(zc))
  ***   [1];if(DEBUGLEVEL_el
  ***   ^--------------------
  ***   array index (1) out of allowed range [none].
? 
```


I am running Sage 5.0 on Ubuntu 11.04 64bit.


---

Comment by cremona created at 2012-05-30 21:42:01

Thanks for the report, I will report it "upstream" to Denis Simon.


---

Comment by cremona created at 2012-05-31 08:39:51

Replying to [comment:1 cremona]:
> Thanks for the report, I will report it "upstream" to Denis Simon.

I have done so.


---

Comment by fwclarke created at 2012-05-31 16:40:53

As well as the problem with the gp script, there are errors in the sage code which meant that the gp error didn't get reported as was intended:

At line 283 of `schemes/elliptic_curves/ell_number_field.py` (Sage-5.0):

```
    prob_rank = Integer(t[0]) 
```

`t` has the value `'fail'`, from the previous line.  But the error should have been detected earlier.  If lines 104--105 of `schemes/elliptic_curves/gp_simon.py`:

```
    if s.find("###") != -1:
        raise RuntimeError, "%s\nAn error occurred while running Simon's 2-descent program"%s
```

are changed to:

```
    if s.find("***") != -1:
        raise RuntimeError, "\n%s\nAn error occurred while running Simon's 2-descent program"%s
```

then:

```
sage: K = CyclotomicField(43).subfields(3)[0][0]
sage: E = EllipticCurve(K, '37')
sage: E.simon_two_descent()
Traceback (most recent call last):
...
RuntimeError: 
  ***   at top-level: ans=bnfellrank(K,[0,0,1,
  ***                     ^--------------------
  ***   in function bnfellrank: ...eqtheta,rnfeq,bbnf];rang=
  ***   bnfell2descent_gen(b
  ***   ^--------------------
  ***   in function bnfell2descent_gen: ...riv,r=nfsqrt(nf,norm(zc))
  ***   [1];if(DEBUGLEVEL_el
  ***   ^--------------------
  ***   array index (1) out of allowed range [none].
An error occurred while running Simon's 2-descent program
```

 
There's another error at line 276 of `schemes/elliptic_curves/ell_number_field.py`, where a `KeyError` has to be allowed for as well as an `AttributeError`.  Thus trying `E.simon_two_descent()` again leads to

```
sage: E.simon_two_descent()
Traceback (most recent call last):
...
KeyError: (5, 50, 10, 20, 30)
```



---

Comment by fwclarke created at 2012-06-23 18:28:13

The patch corrects the caching and error-handling problems.  Reporting the error with the PARI/GP script is given as a doctest.  This will need changing when the script is revised.


---

Comment by fwclarke created at 2012-06-23 18:28:13

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2012-07-27 20:39:55

Please fill in your real name as Author.


---

Comment by cremona created at 2012-09-10 16:06:56

Sorry I took so long to get to this.  I applied the patch to 5.4.beta0 and had no problems.  But I have two comments: 

First,  we should document which version of the simon script the problem occurs in (when we put a failing case into the doctest).  Checking, I find that rather incredibly the version of ell.gp shopped with Sage now is dated 25/03/2009.  I'm sure that we have newer versions but tey have failed to be put into Sage since our attempts (most recently by Martin Raum and me at the Sage Days in Warwick in December 2011) to do that failed for reasons I will not attempt to recall here.

Secondly, I see that the patch deletes the definition of 'x'.  I am very wary of doing that since there have been issues in the past where converting strings from pari to Sage required Sage knowning what 'x' is.  For that reason I am doing a full test, and will report back.


---

Comment by cremona created at 2012-09-11 13:00:27

PS The full test worked without a hitch so perhaps I was unnecessarily cautious (about deleting the line which defines x).

This just leaves adding a comment about the version of the scripts which cuase that error.

What then with this ticket?  I cannot exactly be closed since the error has not been fixed, just flagged better.  Perhaps the thing to do is to close this ticket but to open a similar one which refers back to this one.


---

Comment by fwclarke created at 2012-09-19 01:47:14

Replaces previous patch, rebased on 5.3


---

Attachment

Replying to [comment:10 cremona]:
> PS The full test worked without a hitch so perhaps I was unnecessarily cautious (about deleting the line which defines x).

It looks as though that line has been there from the beginning (sage-2.6).  

> This just leaves adding a comment about the version of the scripts which cause that error.

I've replaced the patch with one that refers to the version.

> What then with this ticket?  I cannot exactly be closed since the error has not been fixed, just flagged better.  Perhaps the thing to do is to close this ticket but to open a similar one which refers back to this one.

Seems like a good idea.  From the point of view of Sage, the error was in the implementation of reporting errors in the script(s) (plus one or two other things).  A new ticket could (re-)document the upstream report.


---

Comment by cremona created at 2012-09-20 09:36:05

New patch looks good, applies fine to 5.4.beta1, tests still pass.


---

Comment by cremona created at 2012-09-20 09:36:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-09-23 16:21:59

Resolution: fixed


---

Comment by jdemeyer created at 2012-09-23 16:46:45

Obviously that was a mistake indeed :-)
