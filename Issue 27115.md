# Issue 27115: Add checks for matrix multiplication

archive/issues_027115.json:
```json
{
    "body": "CC:  slelievre\n\nIt seems the compatibility of dimensions is not always tested\nwhen multiplying matrices.\n\nThis ticket is opened following the report at\n- [Ask Sage question 45547: Strange matrix product](https://ask.sagemath.org/question/45547)\n\nIn particular, multiplying two 3 by 2 matrices should fail, but:\n\n```\nsage: A = matrix(QQ, [[1, 2], [-1, 0], [1, 1]])\nsage: B = matrix(QQ, [[0, 4], [1, -1], [1, 2]])\nsage: A\n[ 1  2]\n[-1  0]\n[ 1  1]\nsage: B\n[ 0  4]\n[ 1 -1]\n[ 1  2]\nsage: A*B\n[ 1  0]\n[ 1 -2]\n[ 1  3]\n```\n\n\nIn this case `A * B` amounts to `A.__mul__(B)` which ends up calling `A._multiply_flint(B)`.\n\nFor matrices over the integers, the multiplication above fails as it should:\n\n```\nsage: A = matrix(ZZ, [[1, 2], [-1, 0], [1, 1]])\nsage: B = matrix(ZZ, [[0, 4], [1, -1], [1, 2]])\nsage: A * B\nTraceback (most recent call last)\n...\nIndexError: Number of columns of self must equal number of rows of right.\n```\n\nbut we get a similar surprise by calling\n\n```\nsage: A._multiply_linbox(B)\n[ 2  2]\n[ 0 -4]\n[ 1  3]\n```\n\n\nIn case `_multiply_linbox` and `_multiply_flint` skip dimension tests for speed,\ntests should be performed before calling them, which seems to be the case for\n`_multiply_linbox` but not `_multiply_flint`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27352\n\n",
    "created_at": "2019-02-25T19:17:42Z",
    "labels": [
        "linear algebra",
        "major",
        "bug"
    ],
    "title": "Add checks for matrix multiplication",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27115",
    "user": "slelievre"
}
```
CC:  slelievre

It seems the compatibility of dimensions is not always tested
when multiplying matrices.

This ticket is opened following the report at
- [Ask Sage question 45547: Strange matrix product](https://ask.sagemath.org/question/45547)

In particular, multiplying two 3 by 2 matrices should fail, but:

```
sage: A = matrix(QQ, [[1, 2], [-1, 0], [1, 1]])
sage: B = matrix(QQ, [[0, 4], [1, -1], [1, 2]])
sage: A
[ 1  2]
[-1  0]
[ 1  1]
sage: B
[ 0  4]
[ 1 -1]
[ 1  2]
sage: A*B
[ 1  0]
[ 1 -2]
[ 1  3]
```


In this case `A * B` amounts to `A.__mul__(B)` which ends up calling `A._multiply_flint(B)`.

For matrices over the integers, the multiplication above fails as it should:

```
sage: A = matrix(ZZ, [[1, 2], [-1, 0], [1, 1]])
sage: B = matrix(ZZ, [[0, 4], [1, -1], [1, 2]])
sage: A * B
Traceback (most recent call last)
...
IndexError: Number of columns of self must equal number of rows of right.
```

but we get a similar surprise by calling

```
sage: A._multiply_linbox(B)
[ 2  2]
[ 0 -4]
[ 1  3]
```


In case `_multiply_linbox` and `_multiply_flint` skip dimension tests for speed,
tests should be performed before calling them, which seems to be the case for
`_multiply_linbox` but not `_multiply_flint`.


Issue created by migration from https://trac.sagemath.org/ticket/27352





---

archive/issue_comments_381875.json:
```json
{
    "body": "With 8.7.beta5, I actually get random (?) answers:\n\n```\nsage: A = matrix(QQ, [[1, 2], [-1, 0], [1, 1]])\nsage: B = matrix(QQ, [[0, 4], [1, -1], [1, 2]])\nsage: A * B\n[          1           0]\n[          1          -2]\n[13204699393 26409398787]\nsage: A * B\n[          1           0]\n[          1          -2]\n[13226416241 26452832483]\nsage: A * B\n[          1           0]\n[          1          -2]\n[13226415713 26452831427]\nsage: A * B\n[          1           0]\n[          1          -2]\n[13226429585 26452859171]\nsage: A * B\n[          1           0]\n[          1          -2]\n[13226415905 26452831811]\nsage: A * B\n[                    1                     0]\n[                    1                    -2]\n[ -6917529027641081855 -13835058055282163709]\nsage: A * B\n[                  1                   0]\n[                  1                  -2]\n[-411335435850571967 -822670871701143933]\nsage: A * B\n[              1               0]\n[              1              -2]\n[140331841062305 280663682124611]\nsage: A * B\n[ 1  0]\n[ 1 -2]\n[ 1  3]\n```\n",
    "created_at": "2019-02-25T19:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381875",
    "user": "jhpalmieri"
}
```

With 8.7.beta5, I actually get random (?) answers:

```
sage: A = matrix(QQ, [[1, 2], [-1, 0], [1, 1]])
sage: B = matrix(QQ, [[0, 4], [1, -1], [1, 2]])
sage: A * B
[          1           0]
[          1          -2]
[13204699393 26409398787]
sage: A * B
[          1           0]
[          1          -2]
[13226416241 26452832483]
sage: A * B
[          1           0]
[          1          -2]
[13226415713 26452831427]
sage: A * B
[          1           0]
[          1          -2]
[13226429585 26452859171]
sage: A * B
[          1           0]
[          1          -2]
[13226415905 26452831811]
sage: A * B
[                    1                     0]
[                    1                    -2]
[ -6917529027641081855 -13835058055282163709]
sage: A * B
[                  1                   0]
[                  1                  -2]
[-411335435850571967 -822670871701143933]
sage: A * B
[              1               0]
[              1              -2]
[140331841062305 280663682124611]
sage: A * B
[ 1  0]
[ 1 -2]
[ 1  3]
```




---

archive/issue_comments_381876.json:
```json
{
    "body": "Those random answers are likely because upstream uses whatever is in that next spot in memory. I think this also has a chance of causing a segfault or destroying some other computation for the same reason.",
    "created_at": "2019-02-25T22:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381876",
    "user": "tscrim"
}
```

Those random answers are likely because upstream uses whatever is in that next spot in memory. I think this also has a chance of causing a segfault or destroying some other computation for the same reason.



---

archive/issue_comments_381877.json:
```json
{
    "body": "Regarding the ticket description, is `_multiply_linbox` used anywhere? `_multiply_flint` is funny because it has a doctest\n\n```\n            sage: matrix(QQ, 2, 3) * matrix(QQ, 4, 5)\n            Traceback (most recent call last):\n            ...\n            TypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 3 dense matrices over Rational Field' and 'Full MatrixSpace of 4 by 5 dense matrices over Rational Field'\n```\n\nbut I think if the two matrices have the same parent, then the shapes aren't checked.",
    "created_at": "2019-02-25T23:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381877",
    "user": "jhpalmieri"
}
```

Regarding the ticket description, is `_multiply_linbox` used anywhere? `_multiply_flint` is funny because it has a doctest

```
            sage: matrix(QQ, 2, 3) * matrix(QQ, 4, 5)
            Traceback (most recent call last):
            ...
            TypeError: unsupported operand parent(s) for *: 'Full MatrixSpace of 2 by 3 dense matrices over Rational Field' and 'Full MatrixSpace of 4 by 5 dense matrices over Rational Field'
```

but I think if the two matrices have the same parent, then the shapes aren't checked.



---

archive/issue_comments_381878.json:
```json
{
    "body": "Can we just do something like this?\n\n```diff\ndiff --git a/src/sage/structure/element.pyx b/src/sage/structure/element.pyx\nindex 1b167b7ab4..eef1798d54 100644\n--- a/src/sage/structure/element.pyx\n+++ b/src/sage/structure/element.pyx\n@@ -3676,7 +3676,10 @@ cdef class Matrix(ModuleElement):\n         \"\"\"\n         cdef int cl = classify_elements(left, right)\n         if HAVE_SAME_PARENT(cl):\n-            return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+            if left.ncols() == right.nrows():\n+                return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n+            else:\n+                raise ValueError\n         if BOTH_ARE_ELEMENT(cl):\n             return coercion_model.bin_op(left, right, mul)\n \n```\n\n(with an appropriate message for the `ValueError`)? I don't know the `element.pyx` code well. Or should the change be done in `_matrix_times_matrix` in `matrix_rational_dense.pyx`?",
    "created_at": "2019-02-25T23:57:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381878",
    "user": "jhpalmieri"
}
```

Can we just do something like this?

```diff
diff --git a/src/sage/structure/element.pyx b/src/sage/structure/element.pyx
index 1b167b7ab4..eef1798d54 100644
--- a/src/sage/structure/element.pyx
+++ b/src/sage/structure/element.pyx
@@ -3676,7 +3676,10 @@ cdef class Matrix(ModuleElement):
         """
         cdef int cl = classify_elements(left, right)
         if HAVE_SAME_PARENT(cl):
-            return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+            if left.ncols() == right.nrows():
+                return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
+            else:
+                raise ValueError
         if BOTH_ARE_ELEMENT(cl):
             return coercion_model.bin_op(left, right, mul)
 
```

(with an appropriate message for the `ValueError`)? I don't know the `element.pyx` code well. Or should the change be done in `_matrix_times_matrix` in `matrix_rational_dense.pyx`?



---

archive/issue_comments_381879.json:
```json
{
    "body": "Replying to [comment:4 jhpalmieri]:\n> Can we just do something like this?\n> {{{\n> #!diff\n> diff --git a/src/sage/structure/element.pyx b/src/sage/structure/element.pyx\n> index 1b167b7ab4..eef1798d54 100644\n> --- a/src/sage/structure/element.pyx\n> +++ b/src/sage/structure/element.pyx\n> `@``@` -3676,7 +3676,10 `@``@` cdef class Matrix(ModuleElement):\n>          \"\"\"\n>          cdef int cl = classify_elements(left, right)\n>          if HAVE_SAME_PARENT(cl):\n> -            return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n> +            if left.ncols() == right.nrows():\n> +                return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n> +            else:\n> +                raise ValueError\n>          if BOTH_ARE_ELEMENT(cl):\n>              return coercion_model.bin_op(left, right, mul)\n>  \n> }}}\n> (with an appropriate message for the `ValueError`)? I don't know the `element.pyx` code well. Or should the change be done in `_matrix_times_matrix` in `matrix_rational_dense.pyx`?\n\nYes but use `self._ncols` (`Py_ssize_t` attribute) instead of `ncols()` (Python function).\n\nNote that the coercion model raises `TypeError`\n\n```\nsage: Zmod(3).an_element() * Zmod(2).an_element()\n```\n\nand I think it is better to follow this convention.",
    "created_at": "2019-02-27T19:27:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381879",
    "user": "vdelecroix"
}
```

Replying to [comment:4 jhpalmieri]:
> Can we just do something like this?
> {{{
> #!diff
> diff --git a/src/sage/structure/element.pyx b/src/sage/structure/element.pyx
> index 1b167b7ab4..eef1798d54 100644
> --- a/src/sage/structure/element.pyx
> +++ b/src/sage/structure/element.pyx
> `@``@` -3676,7 +3676,10 `@``@` cdef class Matrix(ModuleElement):
>          """
>          cdef int cl = classify_elements(left, right)
>          if HAVE_SAME_PARENT(cl):
> -            return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
> +            if left.ncols() == right.nrows():
> +                return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
> +            else:
> +                raise ValueError
>          if BOTH_ARE_ELEMENT(cl):
>              return coercion_model.bin_op(left, right, mul)
>  
> }}}
> (with an appropriate message for the `ValueError`)? I don't know the `element.pyx` code well. Or should the change be done in `_matrix_times_matrix` in `matrix_rational_dense.pyx`?

Yes but use `self._ncols` (`Py_ssize_t` attribute) instead of `ncols()` (Python function).

Note that the coercion model raises `TypeError`

```
sage: Zmod(3).an_element() * Zmod(2).an_element()
```

and I think it is better to follow this convention.



---

archive/issue_comments_381880.json:
```json
{
    "body": "Replying to [comment:5 vdelecroix]:\n> Replying to [comment:4 jhpalmieri]:\n> \n> Yes but use `self._ncols` (`Py_ssize_t` attribute) instead of `ncols()` (Python function).\n> \n\nThis won't work, use\n\n```\n(<Matrix> left)._nrows != (<Matrix> left)._ncols\n```\n\n(note that since `left` and `right` have the same parent we want them to be square matrices)",
    "created_at": "2019-02-27T19:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381880",
    "user": "vdelecroix"
}
```

Replying to [comment:5 vdelecroix]:
> Replying to [comment:4 jhpalmieri]:
> 
> Yes but use `self._ncols` (`Py_ssize_t` attribute) instead of `ncols()` (Python function).
> 

This won't work, use

```
(<Matrix> left)._nrows != (<Matrix> left)._ncols
```

(note that since `left` and `right` have the same parent we want them to be square matrices)



---

archive/issue_comments_381881.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-02-27T20:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381881",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_381882.json:
```json
{
    "body": "Here's a first draft. Feel free to modify it.\n----\nNew commits:",
    "created_at": "2019-02-27T20:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381882",
    "user": "jhpalmieri"
}
```

Here's a first draft. Feel free to modify it.
----
New commits:



---

archive/issue_comments_381883.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-02-27T20:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381883",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_381884.json:
```json
{
    "body": "``trac`:27352:` should be `:trac:`27352``",
    "created_at": "2019-02-27T20:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381884",
    "user": "vdelecroix"
}
```

``trac`:27352:` should be `:trac:`27352``



---

archive/issue_comments_381885.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-02-27T20:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381885",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_381886.json:
```json
{
    "body": "Fixed. (I built the reference manual, but of course this doesn't appear in the reference manual, so I didn't catch it.)",
    "created_at": "2019-02-27T20:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381886",
    "user": "jhpalmieri"
}
```

Fixed. (I built the reference manual, but of course this doesn't appear in the reference manual, so I didn't catch it.)



---

archive/issue_comments_381887.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-02-27T21:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381887",
    "user": "vdelecroix"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_381888.json:
```json
{
    "body": "Indeed...",
    "created_at": "2019-02-27T21:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381888",
    "user": "vdelecroix"
}
```

Indeed...



---

archive/issue_comments_381889.json:
```json
{
    "body": "Usually, no space between the type declaration `<Matrix>` and the name `left` or `right`.\n\nSee other uses elsewhere in the source code as found by `search_src(\"<matrix>\")`:\n\n```\nmatrix/action.pyx:248:        cdef Matrix A = <Matrix>g\nmatrix/action.pyx:249:        cdef Matrix B = <Matrix>s\nmatrix/action.pyx:305:        cdef Matrix A = <Matrix>g\nmatrix/action.pyx:356:        cdef Matrix A = <Matrix>g\nmatrix/action.pyx:367:        return (<Matrix>A)._vector_times_matrix_(v) # v * A\nmatrix/args.pyx:652:                M = <Matrix>self.entries\nmatrix/args.pyx:880:            m = <Matrix>self.entries\nmatrix/matrix1.pyx:1461:            other = <Matrix>bottom\nmatrix/matrix1.pyx:1503:        cdef Matrix other = <Matrix>bottom\nmatrix/matrix2.pyx:790:        return (<Matrix>A)._elementwise_product(B)\nmatrix/matrix2.pyx:2450:        cdef Matrix M  = <Matrix> self\nmatrix/matrix2.pyx:2478:        cdef Matrix a = <Matrix> matrix(R, n-1, n)\nmatroids/lean_matrix.pyx:1033:                        if int((<Matrix>M).get_unsafe(i, j)) & 1:\nmatroids/lean_matrix.pyx:1655:                        s = int((<Matrix>M).get_unsafe(i, j)) % 3\nmatroids/lean_matrix.pyx:2208:                self._gf4 = (<Matrix>M).base_ring()\nmatroids/lean_matrix.pyx:2215:                        self.set(i, j, (<Matrix>M).get_unsafe(i, j))\nstructure/element.pyx:3679:            return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)\n```\n\n\nNot sure if it's still time to change this here or it should happen in a follow-up ticket or we don't care.",
    "created_at": "2019-03-01T17:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381889",
    "user": "slelievre"
}
```

Usually, no space between the type declaration `<Matrix>` and the name `left` or `right`.

See other uses elsewhere in the source code as found by `search_src("<matrix>")`:

```
matrix/action.pyx:248:        cdef Matrix A = <Matrix>g
matrix/action.pyx:249:        cdef Matrix B = <Matrix>s
matrix/action.pyx:305:        cdef Matrix A = <Matrix>g
matrix/action.pyx:356:        cdef Matrix A = <Matrix>g
matrix/action.pyx:367:        return (<Matrix>A)._vector_times_matrix_(v) # v * A
matrix/args.pyx:652:                M = <Matrix>self.entries
matrix/args.pyx:880:            m = <Matrix>self.entries
matrix/matrix1.pyx:1461:            other = <Matrix>bottom
matrix/matrix1.pyx:1503:        cdef Matrix other = <Matrix>bottom
matrix/matrix2.pyx:790:        return (<Matrix>A)._elementwise_product(B)
matrix/matrix2.pyx:2450:        cdef Matrix M  = <Matrix> self
matrix/matrix2.pyx:2478:        cdef Matrix a = <Matrix> matrix(R, n-1, n)
matroids/lean_matrix.pyx:1033:                        if int((<Matrix>M).get_unsafe(i, j)) & 1:
matroids/lean_matrix.pyx:1655:                        s = int((<Matrix>M).get_unsafe(i, j)) % 3
matroids/lean_matrix.pyx:2208:                self._gf4 = (<Matrix>M).base_ring()
matroids/lean_matrix.pyx:2215:                        self.set(i, j, (<Matrix>M).get_unsafe(i, j))
structure/element.pyx:3679:            return (<Matrix>left)._matrix_times_matrix_(<Matrix>right)
```


Not sure if it's still time to change this here or it should happen in a follow-up ticket or we don't care.



---

archive/issue_comments_381890.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-03-01T18:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381890",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_381891.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2019-03-01T18:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381891",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_381892.json:
```json
{
    "body": "I don't care much, but it's easy to change. If Volker complains, we will know it was too late.",
    "created_at": "2019-03-01T18:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381892",
    "user": "jhpalmieri"
}
```

I don't care much, but it's easy to change. If Volker complains, we will know it was too late.



---

archive/issue_comments_381893.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-03-01T18:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381893",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_381894.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-03-03T22:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27115",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27115#issuecomment-381894",
    "user": "vbraun"
}
```

Resolution: fixed
