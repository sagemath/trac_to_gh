# Issue 15694: Implement a proper hash function for (combinatorial) free module elements

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2014-03-13 14:51:16

CC:  sage-combinat hivert simonking tscrim aschilling bump

Up to now, CombinatorialFreeModule elements used the (horrible)
default implementation of __hash__ provided by Element which uses the
string representation. This was slow! And further fragile! Indeed, the
string representation depends on a sorting of the support of the
elements.  In #14102 we got bitten by this with elements whose support
mixed int's, Integer's and string. The result of:

```
    sage: sorted([int(0), 'delta', 1])
    [0, 1, 'delta']
```

depends on the platform (that's ok) but also on which of 0 and 1 are
int's or Integer, whereas the corresponding lists test as equal.
This led to equal element with distinct hash values.

This ticket adds an implementation of `__hash__` inspired from that
proposed for frozendicts in PEP 0416. In particular this
implementation does not rely on sorting.

Some timings:

```
    sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
    sage: B = F.basis()
    sage: f = B['a'] + 3*B['c']
    sage: %timeit hash(f)                         # new hash function
    100000 loops, best of 3: 3.57 µs per loop
    sage: %timeit hash(f._repr_())                # equivalent to the previous one
    10000 loops, best of 3: 85 µs per loop
```


There used to be a custom hash function for ambient space elements in
root systems, but this is not needed anymore:

```
    sage: F = RootSystem(['A',2]).ambient_space()
    sage: f = F.simple_root(0)
    sage: %timeit hash(f)                         # new hash function
    100000 loops, best of 3: 3.63 µs per loop
    sage: %timeit hash(f._repr_())                # equivalent to the previous one
    10000 loops, best of 3: 42.3 µs per loop
```



---

Comment by nthiery created at 2014-03-13 14:59:07

Changing status from new to needs_review.


---

Comment by nthiery created at 2014-03-13 14:59:07

New commits:


---

Comment by nthiery created at 2014-03-13 15:00:26

Simon: I don't remember the status: would it be possible now to use cached_method on `__hash__`?


---

Comment by nthiery created at 2014-03-13 15:10:43

Apparently, yes; here is the timing after adding a `@`cached_method:

```
    sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
    sage: B = F.basis()
    sage: f = B['a'] + 3*B['c']
    sage: %timeit hash(f) 
    1000000 loops, best of 3: 582 ns per loop
```


It's almost an order of magnitude faster (more with larger elements), assuming we often recompute the hash value of elements.
Do we want to do this?


---

Comment by SimonKing created at 2014-03-13 15:29:25

Replying to [comment:4 nthiery]:
> It's almost an order of magnitude faster (more with larger elements), assuming we often recompute the hash value of elements.

Glad to see that the decorator is useful on magical Python methods (by the way, `__len__` and so on can now be cached as well).

> Do we want to do this?

I guess I am biased... ;-) (take that as "yes, from my viewpoint")

It reminds me, though, that I should investigate a potentially nasty detail. Assume that `@`cached_method is applied to the hash. Then an instance `O` is created, that has the hash `h1`. Then we save `O`. Later, the `__hash__` is changed, so that a newly created copy of `O` should have hash `h2!=h1`. Would it be the case that _reloading_ `O` from the old pickle still has `hash(O)==h1`, i.e., would the old hash value be part of the pickle? This would be bad.


---

Comment by hivert created at 2014-03-13 15:44:21

Replying to [comment:4 nthiery]:
> It's almost an order of magnitude faster (more with larger elements), assuming we often recompute the hash value of elements.
> Do we want to do this?

Since `CombinatorialFreeModuleElement` are already large objects dict(index, coeff)) the size of a cached methods without any arguments seems to be 128 byte on a 64bits machine as of Sage 6.1.1. It probably could be lowered (Simon: do you have any idea ?). I'm tempted to say: add the cached method by default.

For the info, here are the Cython struct of a `CachedMethodNoArgs`:

```
cdef class CachedFunction(object):
    cdef public str __name__
    cdef public str __module__
    cdef object _argument_fixer
    cdef public object _fix_to_pos
    cdef public object f
    # cache is not always of type "dict"!
    cdef public object cache
    cdef tuple _default_key
    cdef bint is_classmethod

cdef class CachedMethodCallerNoArgs(CachedFunction):
    cdef public object _instance
}}} 
Simon: Wouldn't be possible to replace some attributes such as `__name__`, `__module__` which are seldom used by a slower property ?


---

Comment by SimonKing created at 2014-03-13 15:54:57

Replying to [comment:6 hivert]:
> For the info, here are the Cython struct of a `CachedMethodNoArgs`:
> {{{
> cdef class CachedFunction(object):
>     cdef public str __name__
>     cdef public str __module__
>     cdef object _argument_fixer
>     cdef public object _fix_to_pos
>     cdef public object f
>     # cache is not always of type "dict"!
>     cdef public object cache
>     cdef tuple _default_key
>     cdef bint is_classmethod
> 
> cdef class CachedMethodCallerNoArgs(CachedFunction):
>     cdef public object _instance
> }}} 
> Simon: Wouldn't be possible to replace some attributes such as `__name__`, `__module__` which are seldom used by a slower property ?

Ask Nicolas! I think he was the one who recently added `__name__` and `__module__` to cached methods.


---

Comment by hivert created at 2014-03-13 16:07:14

Replying to [comment:7 SimonKing]:
> > Simon: Wouldn't be possible to replace some attributes such as `__name__`, `__module__` which are seldom used by a slower property ?
> 
> Ask Nicolas! I think he was the one who recently added `__name__` and `__module__` to cached methods.

To bad for you ;-) According the git blame he added indeed them on `CachedMethod` whereas here I'm speaking about `CachedFunction` which seems to have been written by you.


---

Comment by git created at 2014-03-13 16:31:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2014-03-13 16:37:56

Replying to [comment:8 hivert]:
> To bad for you ;-) According the git blame he added indeed them on `CachedMethod` whereas here I'm speaking about `CachedFunction` which seems to have been written by you.

I did a short experiment. This seems to work: see #15936. So I'm Ok with caching here.
----
New commits:


---

Comment by git created at 2014-03-13 16:59:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by hivert created at 2014-03-13 17:00:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-03-14 01:50:46

I get multiple doctest failures


---

Comment by nthiery created at 2014-03-17 11:27:10

Changing status from positive_review to needs_work.


---

Comment by nthiery created at 2014-03-17 11:27:10

Changing the hash value of combinatorial free module elements changes the order in which they get sorted when printing, e.g., sets. This causes a bunch of trivial doctest failures that are not deterministic, in particular in crystals and weyl character rings. I am in the process of fixing those, trying at this occasion to make the tests more deterministic when easy. Further work on making those tests deterministic would be desirable in later tickets. 

Also, for now, I removed the hash value of the parent from the hash value of the elements. See #15959. Travis: please check it out!

Cheers,


---

Comment by git created at 2014-03-17 15:22:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-17 15:24:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-17 16:54:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-17 17:14:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2014-03-17 17:23:09

Hopefully I have been through all the failing doctests. Anne, Travis, Dan, please check them!

Using pprint makes the order depend on the comparison function of free module elements rather than their hash, which should be more robust.

Well, I get a bunch of other failures in the dev scripts, but those also fail for me on the current branch develop; so I assume they are unrelated.

```
sage -t --long src/sage/dev/sagedev.py  # 273 doctests failed
sage -t --long src/sage/dev/git_interface.py  # 27 doctests failed
sage -t --long src/sage/dev/trac_interface.py  # 27 doctests failed
sage -t --long src/sage/dev/test/server_proxy.py  # 26 doctests failed
sage -t --long src/sage/dev/test/sagedev.py  # 10 doctests failed
sage -t --long src/sage/dev/patch.py  # 9 doctests failed
sage -t --long src/sage/dev/config.py  # 18 doctests failed
sage -t --long src/sage/dev/cmd_line_interface.py  # 14 doctests failed
sage -t --long src/sage/dev/test/trac_interface.py  # 8 doctests failed
sage -t --long src/sage/dev/user_interface.py  # 13 doctests failed
sage -t --long src/sage/dev/sagedev_wrapper.py  # 4 doctests failed
sage -t --long src/sage/dev/test/trac_server.py  # 2 doctests failed
sage -t --long src/sage/dev/test/user_interface.py  # 4 doctests failed
sage -t --long src/sage/dev/sagedev_instance.py  # 1 doctest failed
sage -t --long src/sage/dev/test/config.py  # 2 doctests failed
```



---

Comment by nthiery created at 2014-03-17 17:23:09

Changing status from needs_work to needs_review.


---

Comment by aschilling created at 2014-03-17 23:59:53

Travis and I fixed some doc tests and TAB characters. Looks good otherwise.
----
New commits:


---

Comment by aschilling created at 2014-03-17 23:59:53

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2014-03-18 14:54:36

Thanks Anne, Travis for the review! I double checked your changes and am indeed happy with them.


---

Comment by vbraun created at 2014-03-20 20:07:48

Resolution: fixed


---

Comment by vbraun created at 2014-03-22 15:46:27

Still fails on 32-bit

```
sage -t --long src/sage/combinat/free_module.py
**********************************************************************
File "src/sage/combinat/free_module.py", line 116, in sage.combinat.free_module.CombinatorialFreeModuleElement.__hash__
Failed example:
    hash(f)
Expected:
    3765996081                    
Got:
    -528971215
```



---

Comment by vbraun created at 2014-03-22 15:46:48

Changing status from closed to new.


---

Comment by vbraun created at 2014-03-22 15:46:48

Resolution changed from fixed to 


---

Comment by nthiery created at 2014-03-25 11:14:29

Shoot; I don't have a 32bits machine under hand, and I was hoping the hash value on 32bits would be the hash value on 64bits mod 2^32.

Volker: can you confirm that there is no other failure in 32 bits? If yes, I'll just fix the doctest and push.


---

Comment by vbraun created at 2014-03-25 12:07:13

I didn't see any other test failures...


---

Comment by nthiery created at 2014-03-27 18:51:37

Changing status from new to needs_review.


---

Comment by nthiery created at 2014-03-27 18:51:37

Thanks Volker.

Finally having a working connection to push my change ...
----
New commits:


---

Comment by git created at 2014-03-27 18:54:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-04-02 01:49:55

Nicolas, do you want to merge in my fix for the Kyoto path model on #15959 or just let this ticket pass in as is?


---

Comment by nthiery created at 2014-04-02 20:02:22

No strong opinion. Since we have two tickets anyway, me might maybe as well get them in one by one.

Thanks for your fixes on the Kyoto path model! 

Cheers,
                    Nicolas


---

Comment by tscrim created at 2014-04-02 20:03:26

Okay, then back to positive review here.


---

Comment by tscrim created at 2014-04-02 20:03:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-04-04 18:52:20

Resolution: fixed
