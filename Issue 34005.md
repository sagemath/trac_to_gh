# Issue 34005: Update docker build

Issue created by migration from https://trac.sagemath.org/ticket/34242

Original creator: saraedum

Original creation time: 2022-07-29 06:06:15

CC:  vdelecroix martinpepin

The docker images are using Ubuntu impish. We should instead build against the latest LTS version jammy.

Also, the README on Docker Hub is quite outdated.

Finally, we drop the CircleCI setup here. To my knowledge nobody is using it and I it's likely broken by now anyway.


---

Comment by git created at 2022-07-29 06:15:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2022-07-29 06:17:38

This needs review, once I checked that this actually works with the 9.6 build.


---

Comment by @RefurioAnachro created at 2022-08-14 12:56:04

I just checked with 9.6, it works without ARTIFACT_BASE.

When I do set ARTIFACT_BASE=sagemath/sagemath-dev:develop then docker build errors out with


```
ImportError: libssl.so.1.1: cannot open shared object file: No such file or directory
```


which is to be expected, since ubuntu jammy switches to openssl 3.

This is a critical change: without it, building with docker fails.


---

Comment by @RefurioAnachro created at 2022-08-14 12:56:04

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-15 14:58:34

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2022-08-15 17:14:28

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2022-08-15 17:14:28

mkoeppe, why the "needs work"?


---

Comment by saraedum created at 2022-08-15 17:15:54

Replying to [comment:5 gh-RefurioAnachro]:
> I just checked with 9.6, it works without ARTIFACT_BASE.
> 
> When I do set ARTIFACT_BASE=sagemath/sagemath-dev:develop then docker build errors out with
> 
> {{{
> ImportError: libssl.so.1.1: cannot open shared object file: No such file or directory
> }}}
> 
> which is to be expected, since ubuntu jammy switches to openssl 3.
> 
> This is a critical change: without it, building with docker fails.

I guess that's only a temporary issue. Once a newer image has been uploaded that shouldn't be an issue anymore.


---

Comment by mkoeppe created at 2022-08-15 19:19:43

Replying to [comment:9 saraedum]:
> I guess that's only a temporary issue. [...]

I'd suggest that you build the images and make them available for testing. Maybe then reviewers will step up.


---

Comment by saraedum created at 2022-08-16 13:52:47

Yes, but unfortunately, the build failed.


---

Comment by mkoeppe created at 2022-08-16 15:53:02

Changing status from needs_review to needs_work.


---

Comment by MartinPepin created at 2022-09-10 05:46:47

Replying to [comment:11 Julian Rueth]:
> Yes, but unfortunately, the build failed.

It seems to have failed for a weird reason not related to the docker configuration (`apt-get` not being able to install some packages).
I think it has been fixed on the `develop` branch, maybe merging/rebasing will be enough to fix the build ?

BTW: I also managed to build the docker images on my system using your updated dockerfile so +1 for merging this patch


---

Comment by MartinPepin created at 2022-09-17 10:16:58

Replying to [comment:11 Julian RÃ¼th]:
> Yes, but unfortunately, the build failed.

I took the liberty to rebase on develop to check whether this fixes the CI issue, and updated the ticket. Feel free to re-enable your branch at any time!
----
New commits:


---

Comment by MartinPepin created at 2022-09-17 13:26:40

Changing status from needs_work to needs_review.


---

Comment by MartinPepin created at 2022-09-21 13:15:33

Looks good to me, I had no problem building and using the images


---

Comment by MartinPepin created at 2022-09-21 13:15:33

Changing status from needs_review to positive_review.


---

Comment by MartinPepin created at 2022-09-21 13:54:49

For anyone willing to test the images, I put them here (very temporarily):
 
- sagemath
  - weight: 3.5G 
  - image: https://ironlung.wkerl.me/tmp-uGibUdLaomUOIRC1/sagemath.tar
  - sha512sum: d59debd3e73fe0f623d362800a94614e3a3209dcebd377878719bbceeb2149c63ad928a7a5224bb082eafa568984ccd1702a4e7d9097dc186e5e160bb2e81e3f

- sagemath-dev
  - weight: 8.5G
  - images: https://ironlung.wkerl.me/tmp-uGibUdLaomUOIRC1/sagemath-dev.tar
  - sha512sum: e0b1ea39e91d7c11e8c791404aab150fc3b97980986ac8cc16d3b737c92953d22102a8b78f6ae7f0329e60b4bed981fd41f8b7de6176262287df89c499dc7db4


---

Comment by @j2kun created at 2022-09-21 22:15:36

What a timely update! I just ran into this problem when trying to derive a container from sagemath:9.5 with an additional git clone to fetch a dependency (installing git fails due to apt, and git is not installed by default on this container).

I fetched the sagemath container in comment20, and it works great. Looking forward to the push of the updated image.


---

Comment by vbraun created at 2022-09-25 16:34:19

Resolution: fixed


---

Comment by saraedum created at 2022-10-26 21:07:08

The images on DockerHub are now also updated.
