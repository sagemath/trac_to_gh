# Issue 34005: Update docker build

archive/issues_034005.json:
```json
{
    "body": "CC:  vdelecroix martinpepin\n\nThe docker images are using Ubuntu impish. We should instead build against the latest LTS version jammy.\n\nAlso, the README on Docker Hub is quite outdated.\n\nFinally, we drop the CircleCI setup here. To my knowledge nobody is using it and I it's likely broken by now anyway.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34242\n\n",
    "created_at": "2022-07-29T06:06:15Z",
    "labels": [
        "docker",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Update docker build",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34005",
    "user": "saraedum"
}
```
CC:  vdelecroix martinpepin

The docker images are using Ubuntu impish. We should instead build against the latest LTS version jammy.

Also, the README on Docker Hub is quite outdated.

Finally, we drop the CircleCI setup here. To my knowledge nobody is using it and I it's likely broken by now anyway.

Issue created by migration from https://trac.sagemath.org/ticket/34242





---

archive/issue_comments_482661.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-29T06:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482661",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482662.json:
```json
{
    "body": "This needs review, once I checked that this actually works with the 9.6 build.",
    "created_at": "2022-07-29T06:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482662",
    "user": "saraedum"
}
```

This needs review, once I checked that this actually works with the 9.6 build.



---

archive/issue_comments_482663.json:
```json
{
    "body": "I just checked with 9.6, it works without ARTIFACT_BASE.\n\nWhen I do set ARTIFACT_BASE=sagemath/sagemath-dev:develop then docker build errors out with\n\n\n```\nImportError: libssl.so.1.1: cannot open shared object file: No such file or directory\n```\n\n\nwhich is to be expected, since ubuntu jammy switches to openssl 3.\n\nThis is a critical change: without it, building with docker fails.",
    "created_at": "2022-08-14T12:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482663",
    "user": "@RefurioAnachro"
}
```

I just checked with 9.6, it works without ARTIFACT_BASE.

When I do set ARTIFACT_BASE=sagemath/sagemath-dev:develop then docker build errors out with


```
ImportError: libssl.so.1.1: cannot open shared object file: No such file or directory
```


which is to be expected, since ubuntu jammy switches to openssl 3.

This is a critical change: without it, building with docker fails.



---

archive/issue_comments_482664.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-14T12:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482664",
    "user": "@RefurioAnachro"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482665.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-15T14:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482665",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_482666.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-15T17:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482666",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_482667.json:
```json
{
    "body": "mkoeppe, why the \"needs work\"?",
    "created_at": "2022-08-15T17:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482667",
    "user": "saraedum"
}
```

mkoeppe, why the "needs work"?



---

archive/issue_comments_482668.json:
```json
{
    "body": "Replying to [comment:5 gh-RefurioAnachro]:\n> I just checked with 9.6, it works without ARTIFACT_BASE.\n> \n> When I do set ARTIFACT_BASE=sagemath/sagemath-dev:develop then docker build errors out with\n> \n> {{{\n> ImportError: libssl.so.1.1: cannot open shared object file: No such file or directory\n> }}}\n> \n> which is to be expected, since ubuntu jammy switches to openssl 3.\n> \n> This is a critical change: without it, building with docker fails.\n\nI guess that's only a temporary issue. Once a newer image has been uploaded that shouldn't be an issue anymore.",
    "created_at": "2022-08-15T17:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482668",
    "user": "saraedum"
}
```

Replying to [comment:5 gh-RefurioAnachro]:
> I just checked with 9.6, it works without ARTIFACT_BASE.
> 
> When I do set ARTIFACT_BASE=sagemath/sagemath-dev:develop then docker build errors out with
> 
> {{{
> ImportError: libssl.so.1.1: cannot open shared object file: No such file or directory
> }}}
> 
> which is to be expected, since ubuntu jammy switches to openssl 3.
> 
> This is a critical change: without it, building with docker fails.

I guess that's only a temporary issue. Once a newer image has been uploaded that shouldn't be an issue anymore.



---

archive/issue_comments_482669.json:
```json
{
    "body": "Replying to [comment:9 saraedum]:\n> I guess that's only a temporary issue. [...]\n\nI'd suggest that you build the images and make them available for testing. Maybe then reviewers will step up.",
    "created_at": "2022-08-15T19:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482669",
    "user": "mkoeppe"
}
```

Replying to [comment:9 saraedum]:
> I guess that's only a temporary issue. [...]

I'd suggest that you build the images and make them available for testing. Maybe then reviewers will step up.



---

archive/issue_comments_482670.json:
```json
{
    "body": "Yes, but unfortunately, the build failed.",
    "created_at": "2022-08-16T13:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482670",
    "user": "saraedum"
}
```

Yes, but unfortunately, the build failed.



---

archive/issue_comments_482671.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-16T15:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482671",
    "user": "mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_482672.json:
```json
{
    "body": "Replying to [comment:11 Julian Rueth]:\n> Yes, but unfortunately, the build failed.\n\nIt seems to have failed for a weird reason not related to the docker configuration (`apt-get` not being able to install some packages).\nI think it has been fixed on the `develop` branch, maybe merging/rebasing will be enough to fix the build ?\n\nBTW: I also managed to build the docker images on my system using your updated dockerfile so +1 for merging this patch",
    "created_at": "2022-09-10T05:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482672",
    "user": "MartinPepin"
}
```

Replying to [comment:11 Julian Rueth]:
> Yes, but unfortunately, the build failed.

It seems to have failed for a weird reason not related to the docker configuration (`apt-get` not being able to install some packages).
I think it has been fixed on the `develop` branch, maybe merging/rebasing will be enough to fix the build ?

BTW: I also managed to build the docker images on my system using your updated dockerfile so +1 for merging this patch



---

archive/issue_comments_482673.json:
```json
{
    "body": "Replying to [comment:11 Julian R\u00fcth]:\n> Yes, but unfortunately, the build failed.\n\nI took the liberty to rebase on develop to check whether this fixes the CI issue, and updated the ticket. Feel free to re-enable your branch at any time!\n----\nNew commits:",
    "created_at": "2022-09-17T10:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482673",
    "user": "MartinPepin"
}
```

Replying to [comment:11 Julian RÃ¼th]:
> Yes, but unfortunately, the build failed.

I took the liberty to rebase on develop to check whether this fixes the CI issue, and updated the ticket. Feel free to re-enable your branch at any time!
----
New commits:



---

archive/issue_comments_482674.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-17T13:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482674",
    "user": "MartinPepin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_482675.json:
```json
{
    "body": "Looks good to me, I had no problem building and using the images",
    "created_at": "2022-09-21T13:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482675",
    "user": "MartinPepin"
}
```

Looks good to me, I had no problem building and using the images



---

archive/issue_comments_482676.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-21T13:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482676",
    "user": "MartinPepin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_482677.json:
```json
{
    "body": "For anyone willing to test the images, I put them here (very temporarily):\n \n- sagemath\n  - weight: 3.5G \n  - image: https://ironlung.wkerl.me/tmp-uGibUdLaomUOIRC1/sagemath.tar\n  - sha512sum: d59debd3e73fe0f623d362800a94614e3a3209dcebd377878719bbceeb2149c63ad928a7a5224bb082eafa568984ccd1702a4e7d9097dc186e5e160bb2e81e3f\n\n- sagemath-dev\n  - weight: 8.5G\n  - images: https://ironlung.wkerl.me/tmp-uGibUdLaomUOIRC1/sagemath-dev.tar\n  - sha512sum: e0b1ea39e91d7c11e8c791404aab150fc3b97980986ac8cc16d3b737c92953d22102a8b78f6ae7f0329e60b4bed981fd41f8b7de6176262287df89c499dc7db4",
    "created_at": "2022-09-21T13:54:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482677",
    "user": "MartinPepin"
}
```

For anyone willing to test the images, I put them here (very temporarily):
 
- sagemath
  - weight: 3.5G 
  - image: https://ironlung.wkerl.me/tmp-uGibUdLaomUOIRC1/sagemath.tar
  - sha512sum: d59debd3e73fe0f623d362800a94614e3a3209dcebd377878719bbceeb2149c63ad928a7a5224bb082eafa568984ccd1702a4e7d9097dc186e5e160bb2e81e3f

- sagemath-dev
  - weight: 8.5G
  - images: https://ironlung.wkerl.me/tmp-uGibUdLaomUOIRC1/sagemath-dev.tar
  - sha512sum: e0b1ea39e91d7c11e8c791404aab150fc3b97980986ac8cc16d3b737c92953d22102a8b78f6ae7f0329e60b4bed981fd41f8b7de6176262287df89c499dc7db4



---

archive/issue_comments_482678.json:
```json
{
    "body": "What a timely update! I just ran into this problem when trying to derive a container from sagemath:9.5 with an additional git clone to fetch a dependency (installing git fails due to apt, and git is not installed by default on this container).\n\nI fetched the sagemath container in comment20, and it works great. Looking forward to the push of the updated image.",
    "created_at": "2022-09-21T22:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482678",
    "user": "@j2kun"
}
```

What a timely update! I just ran into this problem when trying to derive a container from sagemath:9.5 with an additional git clone to fetch a dependency (installing git fails due to apt, and git is not installed by default on this container).

I fetched the sagemath container in comment20, and it works great. Looking forward to the push of the updated image.



---

archive/issue_comments_482679.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-25T16:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482679",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_482680.json:
```json
{
    "body": "The images on DockerHub are now also updated.",
    "created_at": "2022-10-26T21:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34005",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34005#issuecomment-482680",
    "user": "saraedum"
}
```

The images on DockerHub are now also updated.
