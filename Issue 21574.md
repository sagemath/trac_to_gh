# Issue 21574: libecl does not install with OpenSuSE gcc5

Issue created by migration from https://trac.sagemath.org/ticket/21811

Original creator: rws

Original creation time: 2016-11-03 14:49:11

CC:  crmafra@gmail.com mkoeppe fbissey

Compile on OpenSuSE 42.2 with gcc set to gcc5 stops at

```
[ecl-16.1.2.p2] gcc -DECLDIR="\"/home/ralf/sage/local/lib/ecl-16.1.2\"" -I. -I/h
ome/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/build -I/home/ralf/sage
/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c -I../ecl/gc -DECL_API -DECL_NO
_LEGACY   -I/home/ralf/sage/local/include  -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 
-g -O2  -fPIC -Dlinux -c -o ffi.o ffi.o.c
[ecl-16.1.2.p2] /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c
/ffi.d:148:44: error: 'FFI_SYSV' undeclared here (not in a function)
[ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed
```


Log is attached to #21804.

See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU


---

Comment by rws created at 2016-11-03 16:10:36

The incompatible libffi change happened here:

```
commit ef76205647bca77796882d31f6ab5e889f461f07
Author: Richard Henderson <rth@twiddle.net>
Date:   Thu Oct 30 12:13:31 2014 -0700

    x86: Tidy ffi_abi
    
    The x86_64 unix port only handles one ABI; don't define all of the
    other symbols.  The UNIX64 symbol retains the same value.
    
    The i386 ports ought to have the same symbols, even if we can't yet
    unify the values without incrementing the libffi soname.
```


This means all libffi versions from 3.2 up are incompatible.


---

Comment by dimpase created at 2016-11-03 17:31:22

Have you reported this upstream?


---

Comment by rws created at 2016-11-03 17:50:43

What would be upstream here? Libffi or libecl? Remember also that it shows only on OpenSUSE so maybe we're missing something about these flags.


---

Comment by jdemeyer created at 2016-11-03 19:01:47

I know nothing about ffi nor ecl but I think this should be reported to ecl.


---

Comment by dimpase created at 2016-11-03 22:17:31

given that libffi is used all over the place, including CPython, it's most probably ECL-specific issue, or OpenSUSE-specific issue...


---

Comment by dimpase created at 2019-05-28 13:01:10

is this still relevant (the OS most probably has been updated...)


---

Comment by mafra created at 2019-05-28 14:06:05

Replying to [comment:15 dimpase]:
> is this still relevant (the OS most probably has been updated...)

It is still relevant. I am using the modern openSUSE Leap 15.0 and compiling sage gives the same error as in this bug report (a google search on the error led me here).
I had to uninstall libffi-devel from openSUSE.


---

Comment by dimpase created at 2019-05-28 20:45:24

One thing in the ticket description is buffling - that building Sage's gcc package is another workaround. As well, the topic still says gcc5 - aren't you on gcc7 meanwhile?

So all this needs an update, I suppose.


---

Comment by rws created at 2019-08-27 07:32:48

Confirm this happens on OpenSuSE Leap 15.1/gcc-7.4.1 as well, and the deinstall workaround is still valid.


---

Comment by rws created at 2019-08-27 07:32:48

Changing priority from major to critical.


---

Comment by dimpase created at 2019-08-27 07:54:29

does it help to build Sage's libffi, rather than use the system's one?
(i.e., do `./sage -f libffi` followed by a rebuild?) 

---

UPDATE - no, it does not, according to
https://groups.google.com/d/msg/sage-devel/h0BhI2HPUb0/tEXci95CAgAJ


---

Comment by @timokau created at 2019-12-14 12:30:02

I'm seeing the same issue on NixOS since the recent (https://github.com/libffi/libffi/releases) libffi v3.3 update. More specifically, git-bisect shows https://github.com/libffi/libffi/commit/982b89c01aca99c7bc229914fc1521f96930919b to be responsible. The headers were formerly installed in the lib dir, and are how (correctly) installed in the include dir.

Its possible that OpenSuSE had already adopted a patch to fix this. Can anybody else confirm that ecl fails with libffi v3.3?


---

Comment by @timokau created at 2019-12-16 22:01:59

I made a mistake when bisecting. Now I also end up at the same commit `@`rws reported a couple of years ago. I was able to fix it by replacing the usage of FFI_SYSV as suggested by gentoo: https://wiki.gentoo.org/wiki/Libffi_3.3_porting_notes/FFI_SYSV

Curiously enough, gentoo hasn't patched ecl themselves yet. But they haven't marked libffi 3.3 as stable either yet.


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by dimpase created at 2020-01-31 22:53:51

We're going to fix the Sage side of this on #29128 (ECL must get the prefix of libffi intallation, so that the good one can be used).


---

Comment by dimpase created at 2020-02-03 17:20:12

See https://gitlab.com/embeddable-common-lisp/ecl/commit/b2f09b4809441a92d6c11a2b39d5399580e56ae7

for upstream fix, pointed by https://gitlab.com/embeddable-common-lisp/ecl/issues/302


---

Comment by dimpase created at 2020-02-03 18:24:03

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-02-03 18:24:03

I'll close  #29128 as won't fix and work here instead. 
----
New commits:


---

Comment by dimpase created at 2020-02-03 23:35:54

tested with system libffi 3.3 on Debian 11 (x86_64), as well as on various x86_64 and i386 linuxis with libffi 3.2.


---

Comment by mkoeppe created at 2020-02-06 15:07:56

Testing at https://github.com/mkoeppe/sage/pull/2


---

Comment by mkoeppe created at 2020-02-06 21:04:48

and at https://github.com/mkoeppe/sage/actions/runs/35630769


---

Comment by mkoeppe created at 2020-02-07 20:02:04

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-02-07 20:02:04

Looking good.


---

Comment by charpent created at 2020-02-08 20:33:52

FWIW, I just checked that 9.1.beta3 + #21811 can be built after `make distclean` On Debian testing running on core i7 + 16 GB RAM.

HTH,


---

Comment by vbraun created at 2020-02-10 20:06:06

Resolution: fixed
