# Issue 21574: libecl does not install with OpenSuSE gcc5

archive/issues_021574.json:
```json
{
    "body": "CC:  crmafra@gmail.com mkoeppe fbissey\n\nCompile on OpenSuSE 42.2 with gcc set to gcc5 stops at\n\n```\n[ecl-16.1.2.p2] gcc -DECLDIR=\"\\\"/home/ralf/sage/local/lib/ecl-16.1.2\\\"\" -I. -I/h\nome/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/build -I/home/ralf/sage\n/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c -I../ecl/gc -DECL_API -DECL_NO\n_LEGACY   -I/home/ralf/sage/local/include  -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 \n-g -O2  -fPIC -Dlinux -c -o ffi.o ffi.o.c\n[ecl-16.1.2.p2] /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c\n/ffi.d:148:44: error: 'FFI_SYSV' undeclared here (not in a function)\n[ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed\n```\n\n\nLog is attached to #21804.\n\nSee also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU\n\nIssue created by migration from https://trac.sagemath.org/ticket/21811\n\n",
    "created_at": "2016-11-03T14:49:11Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "libecl does not install with OpenSuSE gcc5",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/21574",
    "user": "rws"
}
```
CC:  crmafra@gmail.com mkoeppe fbissey

Compile on OpenSuSE 42.2 with gcc set to gcc5 stops at

```
[ecl-16.1.2.p2] gcc -DECLDIR="\"/home/ralf/sage/local/lib/ecl-16.1.2\"" -I. -I/h
ome/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/build -I/home/ralf/sage
/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c -I../ecl/gc -DECL_API -DECL_NO
_LEGACY   -I/home/ralf/sage/local/include  -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 
-g -O2  -fPIC -Dlinux -c -o ffi.o ffi.o.c
[ecl-16.1.2.p2] /home/ralf/sage/local/var/tmp/sage/build/ecl-16.1.2.p2/src/src/c
/ffi.d:148:44: error: 'FFI_SYSV' undeclared here (not in a function)
[ecl-16.1.2.p2] Makefile:85: recipe for target 'ffi.o' failed
```


Log is attached to #21804.

See also https://groups.google.com/forum/#!topic/sage-devel/_doJLj5GIEU

Issue created by migration from https://trac.sagemath.org/ticket/21811





---

archive/issue_comments_299521.json:
```json
{
    "body": "The incompatible libffi change happened here:\n\n```\ncommit ef76205647bca77796882d31f6ab5e889f461f07\nAuthor: Richard Henderson <rth@twiddle.net>\nDate:   Thu Oct 30 12:13:31 2014 -0700\n\n    x86: Tidy ffi_abi\n    \n    The x86_64 unix port only handles one ABI; don't define all of the\n    other symbols.  The UNIX64 symbol retains the same value.\n    \n    The i386 ports ought to have the same symbols, even if we can't yet\n    unify the values without incrementing the libffi soname.\n```\n\n\nThis means all libffi versions from 3.2 up are incompatible.",
    "created_at": "2016-11-03T16:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299521",
    "user": "rws"
}
```

The incompatible libffi change happened here:

```
commit ef76205647bca77796882d31f6ab5e889f461f07
Author: Richard Henderson <rth@twiddle.net>
Date:   Thu Oct 30 12:13:31 2014 -0700

    x86: Tidy ffi_abi
    
    The x86_64 unix port only handles one ABI; don't define all of the
    other symbols.  The UNIX64 symbol retains the same value.
    
    The i386 ports ought to have the same symbols, even if we can't yet
    unify the values without incrementing the libffi soname.
```


This means all libffi versions from 3.2 up are incompatible.



---

archive/issue_comments_299522.json:
```json
{
    "body": "Have you reported this upstream?",
    "created_at": "2016-11-03T17:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299522",
    "user": "dimpase"
}
```

Have you reported this upstream?



---

archive/issue_comments_299523.json:
```json
{
    "body": "What would be upstream here? Libffi or libecl? Remember also that it shows only on OpenSUSE so maybe we're missing something about these flags.",
    "created_at": "2016-11-03T17:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299523",
    "user": "rws"
}
```

What would be upstream here? Libffi or libecl? Remember also that it shows only on OpenSUSE so maybe we're missing something about these flags.



---

archive/issue_comments_299524.json:
```json
{
    "body": "I know nothing about ffi nor ecl but I think this should be reported to ecl.",
    "created_at": "2016-11-03T19:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299524",
    "user": "jdemeyer"
}
```

I know nothing about ffi nor ecl but I think this should be reported to ecl.



---

archive/issue_comments_299525.json:
```json
{
    "body": "given that libffi is used all over the place, including CPython, it's most probably ECL-specific issue, or OpenSUSE-specific issue...",
    "created_at": "2016-11-03T22:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299525",
    "user": "dimpase"
}
```

given that libffi is used all over the place, including CPython, it's most probably ECL-specific issue, or OpenSUSE-specific issue...



---

archive/issue_comments_299526.json:
```json
{
    "body": "is this still relevant (the OS most probably has been updated...)",
    "created_at": "2019-05-28T13:01:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299526",
    "user": "dimpase"
}
```

is this still relevant (the OS most probably has been updated...)



---

archive/issue_comments_299527.json:
```json
{
    "body": "Replying to [comment:15 dimpase]:\n> is this still relevant (the OS most probably has been updated...)\n\nIt is still relevant. I am using the modern openSUSE Leap 15.0 and compiling sage gives the same error as in this bug report (a google search on the error led me here).\nI had to uninstall libffi-devel from openSUSE.",
    "created_at": "2019-05-28T14:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299527",
    "user": "mafra"
}
```

Replying to [comment:15 dimpase]:
> is this still relevant (the OS most probably has been updated...)

It is still relevant. I am using the modern openSUSE Leap 15.0 and compiling sage gives the same error as in this bug report (a google search on the error led me here).
I had to uninstall libffi-devel from openSUSE.



---

archive/issue_comments_299528.json:
```json
{
    "body": "One thing in the ticket description is buffling - that building Sage's gcc package is another workaround. As well, the topic still says gcc5 - aren't you on gcc7 meanwhile?\n\nSo all this needs an update, I suppose.",
    "created_at": "2019-05-28T20:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299528",
    "user": "dimpase"
}
```

One thing in the ticket description is buffling - that building Sage's gcc package is another workaround. As well, the topic still says gcc5 - aren't you on gcc7 meanwhile?

So all this needs an update, I suppose.



---

archive/issue_comments_299529.json:
```json
{
    "body": "Confirm this happens on OpenSuSE Leap 15.1/gcc-7.4.1 as well, and the deinstall workaround is still valid.",
    "created_at": "2019-08-27T07:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299529",
    "user": "rws"
}
```

Confirm this happens on OpenSuSE Leap 15.1/gcc-7.4.1 as well, and the deinstall workaround is still valid.



---

archive/issue_comments_299530.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2019-08-27T07:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299530",
    "user": "rws"
}
```

Changing priority from major to critical.



---

archive/issue_comments_299531.json:
```json
{
    "body": "does it help to build Sage's libffi, rather than use the system's one?\n(i.e., do `./sage -f libffi` followed by a rebuild?) \n\n---\n\nUPDATE - no, it does not, according to\nhttps://groups.google.com/d/msg/sage-devel/h0BhI2HPUb0/tEXci95CAgAJ",
    "created_at": "2019-08-27T07:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299531",
    "user": "dimpase"
}
```

does it help to build Sage's libffi, rather than use the system's one?
(i.e., do `./sage -f libffi` followed by a rebuild?) 

---

UPDATE - no, it does not, according to
https://groups.google.com/d/msg/sage-devel/h0BhI2HPUb0/tEXci95CAgAJ



---

archive/issue_comments_299532.json:
```json
{
    "body": "I'm seeing the same issue on NixOS since the recent (https://github.com/libffi/libffi/releases) libffi v3.3 update. More specifically, git-bisect shows https://github.com/libffi/libffi/commit/982b89c01aca99c7bc229914fc1521f96930919b to be responsible. The headers were formerly installed in the lib dir, and are how (correctly) installed in the include dir.\n\nIts possible that OpenSuSE had already adopted a patch to fix this. Can anybody else confirm that ecl fails with libffi v3.3?",
    "created_at": "2019-12-14T12:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299532",
    "user": "@timokau"
}
```

I'm seeing the same issue on NixOS since the recent (https://github.com/libffi/libffi/releases) libffi v3.3 update. More specifically, git-bisect shows https://github.com/libffi/libffi/commit/982b89c01aca99c7bc229914fc1521f96930919b to be responsible. The headers were formerly installed in the lib dir, and are how (correctly) installed in the include dir.

Its possible that OpenSuSE had already adopted a patch to fix this. Can anybody else confirm that ecl fails with libffi v3.3?



---

archive/issue_comments_299533.json:
```json
{
    "body": "I made a mistake when bisecting. Now I also end up at the same commit `@`rws reported a couple of years ago. I was able to fix it by replacing the usage of FFI_SYSV as suggested by gentoo: https://wiki.gentoo.org/wiki/Libffi_3.3_porting_notes/FFI_SYSV\n\nCuriously enough, gentoo hasn't patched ecl themselves yet. But they haven't marked libffi 3.3 as stable either yet.",
    "created_at": "2019-12-16T22:01:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299533",
    "user": "@timokau"
}
```

I made a mistake when bisecting. Now I also end up at the same commit `@`rws reported a couple of years ago. I was able to fix it by replacing the usage of FFI_SYSV as suggested by gentoo: https://wiki.gentoo.org/wiki/Libffi_3.3_porting_notes/FFI_SYSV

Curiously enough, gentoo hasn't patched ecl themselves yet. But they haven't marked libffi 3.3 as stable either yet.



---

archive/issue_comments_299534.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299534",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_299535.json:
```json
{
    "body": "We're going to fix the Sage side of this on #29128 (ECL must get the prefix of libffi intallation, so that the good one can be used).",
    "created_at": "2020-01-31T22:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299535",
    "user": "dimpase"
}
```

We're going to fix the Sage side of this on #29128 (ECL must get the prefix of libffi intallation, so that the good one can be used).



---

archive/issue_comments_299536.json:
```json
{
    "body": "See https://gitlab.com/embeddable-common-lisp/ecl/commit/b2f09b4809441a92d6c11a2b39d5399580e56ae7\n\nfor upstream fix, pointed by https://gitlab.com/embeddable-common-lisp/ecl/issues/302",
    "created_at": "2020-02-03T17:20:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299536",
    "user": "dimpase"
}
```

See https://gitlab.com/embeddable-common-lisp/ecl/commit/b2f09b4809441a92d6c11a2b39d5399580e56ae7

for upstream fix, pointed by https://gitlab.com/embeddable-common-lisp/ecl/issues/302



---

archive/issue_comments_299537.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299537",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_299538.json:
```json
{
    "body": "I'll close  #29128 as won't fix and work here instead. \n----\nNew commits:",
    "created_at": "2020-02-03T18:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299538",
    "user": "dimpase"
}
```

I'll close  #29128 as won't fix and work here instead. 
----
New commits:



---

archive/issue_comments_299539.json:
```json
{
    "body": "tested with system libffi 3.3 on Debian 11 (x86_64), as well as on various x86_64 and i386 linuxis with libffi 3.2.",
    "created_at": "2020-02-03T23:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299539",
    "user": "dimpase"
}
```

tested with system libffi 3.3 on Debian 11 (x86_64), as well as on various x86_64 and i386 linuxis with libffi 3.2.



---

archive/issue_comments_299540.json:
```json
{
    "body": "Testing at https://github.com/mkoeppe/sage/pull/2",
    "created_at": "2020-02-06T15:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299540",
    "user": "mkoeppe"
}
```

Testing at https://github.com/mkoeppe/sage/pull/2



---

archive/issue_comments_299541.json:
```json
{
    "body": "and at https://github.com/mkoeppe/sage/actions/runs/35630769",
    "created_at": "2020-02-06T21:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299541",
    "user": "mkoeppe"
}
```

and at https://github.com/mkoeppe/sage/actions/runs/35630769



---

archive/issue_comments_299542.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-07T20:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299542",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_299543.json:
```json
{
    "body": "Looking good.",
    "created_at": "2020-02-07T20:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299543",
    "user": "mkoeppe"
}
```

Looking good.



---

archive/issue_comments_299544.json:
```json
{
    "body": "FWIW, I just checked that 9.1.beta3 + #21811 can be built after `make distclean` On Debian testing running on core i7 + 16 GB RAM.\n\nHTH,",
    "created_at": "2020-02-08T20:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299544",
    "user": "charpent"
}
```

FWIW, I just checked that 9.1.beta3 + #21811 can be built after `make distclean` On Debian testing running on core i7 + 16 GB RAM.

HTH,



---

archive/issue_comments_299545.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-02-10T20:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/21574",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/21574#issuecomment-299545",
    "user": "vbraun"
}
```

Resolution: fixed
