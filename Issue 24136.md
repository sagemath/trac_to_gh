# Issue 24136: fix building Sage's Mac-app on OSX 10.13

archive/issues_024136.json:
```json
{
    "body": "CC:  jhpalmieri mgoerner\n\nKeywords: OSX\n\nIt is [confirmed](https://groups.google.com/d/msg/sage-devel/OF6-I4lMkQE/3i-Qk8WGCgAJ) broken; a fix appears to be a small change in its makefile:\n\n```\ndiff --git a/src/mac-app/Makefile b/src/mac-app/Makefile\nindex 430121647a..d0c8238cbc 100644\n--- a/src/mac-app/Makefile\n+++ b/src/mac-app/Makefile\n@@ -103,7 +103,7 @@ $(TARGET)/README.txt: $(SAGE_ROOT)/src/bin/sage-README-osx.txt\n \n non_app_files: $(TARGET)/README.txt $(TARGET)/.background/sage.png $(TARGET)/Applications\n \n-sage_symlink: $(APP)/Contents/Resources/sage/sage\n+sage_symlink: $(APP)/Contents/Resources/sage\n        rm -f $(APP)/sage\n        ln -s Contents/Resources/sage/sage $(APP)/sage\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24373\n\n",
    "created_at": "2017-12-14T09:46:53Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "fix building Sage's Mac-app on OSX 10.13",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24136",
    "user": "dimpase"
}
```
CC:  jhpalmieri mgoerner

Keywords: OSX

It is [confirmed](https://groups.google.com/d/msg/sage-devel/OF6-I4lMkQE/3i-Qk8WGCgAJ) broken; a fix appears to be a small change in its makefile:

```
diff --git a/src/mac-app/Makefile b/src/mac-app/Makefile
index 430121647a..d0c8238cbc 100644
--- a/src/mac-app/Makefile
+++ b/src/mac-app/Makefile
@@ -103,7 +103,7 @@ $(TARGET)/README.txt: $(SAGE_ROOT)/src/bin/sage-README-osx.txt
 
 non_app_files: $(TARGET)/README.txt $(TARGET)/.background/sage.png $(TARGET)/Applications
 
-sage_symlink: $(APP)/Contents/Resources/sage/sage
+sage_symlink: $(APP)/Contents/Resources/sage
        rm -f $(APP)/sage
        ln -s Contents/Resources/sage/sage $(APP)/sage
```


Issue created by migration from https://trac.sagemath.org/ticket/24373





---

archive/issue_comments_338296.json:
```json
{
    "body": "OK, this works on 10.12 as well. Anyone to test on OSX 10.11 ? (We most probably don't need to go any further)\n----\nNew commits:",
    "created_at": "2017-12-14T10:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338296",
    "user": "dimpase"
}
```

OK, this works on 10.12 as well. Anyone to test on OSX 10.11 ? (We most probably don't need to go any further)
----
New commits:



---

archive/issue_comments_338297.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-12-14T10:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338297",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_338298.json:
```json
{
    "body": "Just a build fix, not a run fix?  Remind me the process for testing this and I can try it out.",
    "created_at": "2017-12-15T13:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338298",
    "user": "kcrisman"
}
```

Just a build fix, not a run fix?  Remind me the process for testing this and I can try it out.



---

archive/issue_comments_338299.json:
```json
{
    "body": "Replying to [comment:2 kcrisman]:\n> Just a build fix, not a run fix?  Remind me the process for testing this and I can try it out.\n\nafter building Sage, cd to src/mac-app/ and type `make`. After a while you'd get a `sage-8*.dmg` file which you can test by opening, installing (in the usual OSX way) and running.",
    "created_at": "2017-12-15T13:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338299",
    "user": "dimpase"
}
```

Replying to [comment:2 kcrisman]:
> Just a build fix, not a run fix?  Remind me the process for testing this and I can try it out.

after building Sage, cd to src/mac-app/ and type `make`. After a while you'd get a `sage-8*.dmg` file which you can test by opening, installing (in the usual OSX way) and running.



---

archive/issue_comments_338300.json:
```json
{
    "body": "> after building Sage, cd to src/mac-app/ and type `make`. After a while you'd get a `sage-8*.dmg` file which you can test by opening, installing (in the usual OSX way) and running.\n\nGreat, I just upgraded to the first beta so I can try this quite soon.",
    "created_at": "2017-12-16T00:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338300",
    "user": "kcrisman"
}
```

> after building Sage, cd to src/mac-app/ and type `make`. After a while you'd get a `sage-8*.dmg` file which you can test by opening, installing (in the usual OSX way) and running.

Great, I just upgraded to the first beta so I can try this quite soon.



---

archive/issue_comments_338301.json:
```json
{
    "body": "It works for me on OS X 10.13, as reported on sage-devel. (Actually, there I just reported building correctly, but it also unpacks and then runs successfully.)",
    "created_at": "2017-12-16T01:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338301",
    "user": "jhpalmieri"
}
```

It works for me on OS X 10.13, as reported on sage-devel. (Actually, there I just reported building correctly, but it also unpacks and then runs successfully.)



---

archive/issue_comments_338302.json:
```json
{
    "body": "It seems to work on 10.11, but I got\n\n```\nERROR:  The Sage installation tree has moved\n\nfrom /Users/.../sage\n  to /Applications/SageMath-8.2.beta0.app/Contents/Resources/sage\n\nThis is not supported, and Sage will not work.\n```\n\nwhich is weird because I took the dmg in question, opened it, then dragged the Sage app to `/Applications` so it shouldn't have run before that.  I guess only `binary-pkg` can make even that minimal relocation work.  But in that case I'm not sure how to test it running properly.  If it helps, the app part opens fine - it's only running Sage itself from that binary that doesn't for that reason.  So my guess is we are fine.\n\nBy the way, what's up with the file `tmp-sage-8.2.beta0-OSX_10.11.6_x86_64.app.dmg` worth 8.2 GB when I finish `make`?  Shouldn't that disappear at some point?  It seems obscenely huge ... though I guess the unpacked app is that big, too.  Why is 8.1.rc2.app about 3.5 GB but this is more than twice as big? Maybe because I didn't use `binary-pkg` for the current test?",
    "created_at": "2017-12-16T05:06:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338302",
    "user": "kcrisman"
}
```

It seems to work on 10.11, but I got

```
ERROR:  The Sage installation tree has moved

from /Users/.../sage
  to /Applications/SageMath-8.2.beta0.app/Contents/Resources/sage

This is not supported, and Sage will not work.
```

which is weird because I took the dmg in question, opened it, then dragged the Sage app to `/Applications` so it shouldn't have run before that.  I guess only `binary-pkg` can make even that minimal relocation work.  But in that case I'm not sure how to test it running properly.  If it helps, the app part opens fine - it's only running Sage itself from that binary that doesn't for that reason.  So my guess is we are fine.

By the way, what's up with the file `tmp-sage-8.2.beta0-OSX_10.11.6_x86_64.app.dmg` worth 8.2 GB when I finish `make`?  Shouldn't that disappear at some point?  It seems obscenely huge ... though I guess the unpacked app is that big, too.  Why is 8.1.rc2.app about 3.5 GB but this is more than twice as big? Maybe because I didn't use `binary-pkg` for the current test?



---

archive/issue_comments_338303.json:
```json
{
    "body": "Replying to [comment:6 kcrisman]:\n> It seems to work on 10.11, but I got\n> {{{\n> ERROR:  The Sage installation tree has moved\n\nDoes it work on 10.11 if you revert this branch back?\nIt is not hard to detect the version and use the code that\nworks for each version...\n\nOr perhaps it's broken on 10.11 anyway?\nThe  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.\n\n\n----\nSo I gather that the patch is needed and works on 10.12 and 10.13, and it remains to see what's happening on 10.11 (whether it causes a regression or not)",
    "created_at": "2017-12-16T08:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338303",
    "user": "dimpase"
}
```

Replying to [comment:6 kcrisman]:
> It seems to work on 10.11, but I got
> {{{
> ERROR:  The Sage installation tree has moved

Does it work on 10.11 if you revert this branch back?
It is not hard to detect the version and use the code that
works for each version...

Or perhaps it's broken on 10.11 anyway?
The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.


----
So I gather that the patch is needed and works on 10.12 and 10.13, and it remains to see what's happening on 10.11 (whether it causes a regression or not)



---

archive/issue_comments_338304.json:
```json
{
    "body": "The whole story is probably due to the format changes in .DS_store that happened as 10.12 was released.\nSee https://bitbucket.org/al45tair/ds_store/issues/7",
    "created_at": "2017-12-16T10:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338304",
    "user": "dimpase"
}
```

The whole story is probably due to the format changes in .DS_store that happened as 10.12 was released.
See https://bitbucket.org/al45tair/ds_store/issues/7



---

archive/issue_comments_338305.json:
```json
{
    "body": "> Does it work on 10.11 if you revert this branch back?\nI'll check that out - hopefully my power cord will work properly ;-)\n> Or perhaps it's broken on 10.11 anyway?\nI highly doubt it, since I built 8.1.rc2 with `binary-pkg` and tested the binary and it seemed to work fine.\n> The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.\nWell, it does in the sense that both of them build the Mac app if requested.  I think that since my only issue is the relocation that this is probably why it didn't work.  Where did you open your app.dmg (what folder)?",
    "created_at": "2017-12-16T14:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338305",
    "user": "kcrisman"
}
```

> Does it work on 10.11 if you revert this branch back?
I'll check that out - hopefully my power cord will work properly ;-)
> Or perhaps it's broken on 10.11 anyway?
I highly doubt it, since I built 8.1.rc2 with `binary-pkg` and tested the binary and it seemed to work fine.
> The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.
Well, it does in the sense that both of them build the Mac app if requested.  I think that since my only issue is the relocation that this is probably why it didn't work.  Where did you open your app.dmg (what folder)?



---

archive/issue_comments_338306.json:
```json
{
    "body": "Replying to [comment:9 kcrisman]:\n> > Does it work on 10.11 if you revert this branch back?\n> I'll check that out - hopefully my power cord will work properly ;-)\n> > Or perhaps it's broken on 10.11 anyway?\n> I highly doubt it, since I built 8.1.rc2 with `binary-pkg` and tested the binary and it seemed to work fine.\n> > The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.\n\nWell, I mean it is an extra level of complexity that should not be mixed up with the issue at hand.\n\n> Well, it does in the sense that both of them build the Mac app if requested.  I think that since my only issue is the relocation that this is probably why it didn't work.  Where did you open your app.dmg (what folder)?\n\nI have installed the resulting dmg into /Applications (i.e. you open it, it gets checked and mounted, you see an invitation to move Sage into /Applications, you do it, then you\nopen Sage.app in /Applications).\n\nPS. As I said I won't be surprised if 10.11 needs to be handled differently from the later versions.",
    "created_at": "2017-12-16T15:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338306",
    "user": "dimpase"
}
```

Replying to [comment:9 kcrisman]:
> > Does it work on 10.11 if you revert this branch back?
> I'll check that out - hopefully my power cord will work properly ;-)
> > Or perhaps it's broken on 10.11 anyway?
> I highly doubt it, since I built 8.1.rc2 with `binary-pkg` and tested the binary and it seemed to work fine.
> > The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.

Well, I mean it is an extra level of complexity that should not be mixed up with the issue at hand.

> Well, it does in the sense that both of them build the Mac app if requested.  I think that since my only issue is the relocation that this is probably why it didn't work.  Where did you open your app.dmg (what folder)?

I have installed the resulting dmg into /Applications (i.e. you open it, it gets checked and mounted, you see an invitation to move Sage into /Applications, you do it, then you
open Sage.app in /Applications).

PS. As I said I won't be surprised if 10.11 needs to be handled differently from the later versions.



---

archive/issue_comments_338307.json:
```json
{
    "body": "Even if I open the binary that isn't in the app, but the one created in `src/mac-app` before compression, I get\n\n```\nERROR:  The Sage installation tree has moved\n\nfrom /Users/.../sage\n  to /Users/.../sage/src/mac-app/sage-8.2.beta0-OSX_10.11.6_x86_64/SageMath-8.2.beta0.app/Contents/Resources/sage\n```\n\nAnyway, you may be right that 10.11 needs different handling.  \n> I have installed the resulting dmg into /Applications (i.e. you open it, it gets checked and mounted, you see an invitation to move Sage into /Applications, you do it, then you open Sage.app in /Applications).\nYup, that's exactly what I did.\n\nAnyway, trying again without this change (had to delete all previous long Sage-named folders and app.dmg first).  Probably can report back tonight EST.",
    "created_at": "2017-12-16T15:25:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338307",
    "user": "kcrisman"
}
```

Even if I open the binary that isn't in the app, but the one created in `src/mac-app` before compression, I get

```
ERROR:  The Sage installation tree has moved

from /Users/.../sage
  to /Users/.../sage/src/mac-app/sage-8.2.beta0-OSX_10.11.6_x86_64/SageMath-8.2.beta0.app/Contents/Resources/sage
```

Anyway, you may be right that 10.11 needs different handling.  
> I have installed the resulting dmg into /Applications (i.e. you open it, it gets checked and mounted, you see an invitation to move Sage into /Applications, you do it, then you open Sage.app in /Applications).
Yup, that's exactly what I did.

Anyway, trying again without this change (had to delete all previous long Sage-named folders and app.dmg first).  Probably can report back tonight EST.



---

archive/issue_comments_338308.json:
```json
{
    "body": "In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).\nA [better installer](https://stackoverflow.com/questions/11487596/making-os-x-installer-packages-like-a-pro-xcode-developer-id-ready-pkg) would directly move Sage.app to `/Applications`, rather than \ninviting to move it there. Something for another ticket.\n\nAs well, the existing Sage tree, related to this build, must not be moved/deleted.",
    "created_at": "2017-12-16T19:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338308",
    "user": "dimpase"
}
```

In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).
A [better installer](https://stackoverflow.com/questions/11487596/making-os-x-installer-packages-like-a-pro-xcode-developer-id-ready-pkg) would directly move Sage.app to `/Applications`, rather than 
inviting to move it there. Something for another ticket.

As well, the existing Sage tree, related to this build, must not be moved/deleted.



---

archive/issue_comments_338309.json:
```json
{
    "body": "It doesn't work this way for me without this patch either, so I guess we are okay.  (I checked the package `Contents/Resources/sage/src/mac-app/Makefile` just to be sure it really was the \"right\" one.)\n> In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).\n> As well, the existing Sage tree, related to this build, must not be moved/deleted.\n?  Here is my exact procedure:\n* I have stuff in `Downloads/sage`\n* I `git pull trac develop`, and the switched branches or not ...\n* I `cd src/mac-app` and `make` as you said\n* There is a magically appearing couple of `app.dmg`.\n* I double-click on the appropriate one, which verifies fine and opens to the window suggesting dragging to `Applications`\n* I do so\n* Opening the app to start Jupyter works (at least, it serves up Jupyter, I didn't try to evaluate anything) and if I have the binary pointing to `Downloads/sage/sage` it works fine\n* But letting it point to the default confuses it because it thinks it's supposed to live in `Downloads/sage/sage`, even though I thought it lived in `src/mac-app`.  (As described above.)\nAgain, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my \"development\" version.",
    "created_at": "2017-12-17T00:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338309",
    "user": "kcrisman"
}
```

It doesn't work this way for me without this patch either, so I guess we are okay.  (I checked the package `Contents/Resources/sage/src/mac-app/Makefile` just to be sure it really was the "right" one.)
> In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).
> As well, the existing Sage tree, related to this build, must not be moved/deleted.
?  Here is my exact procedure:
* I have stuff in `Downloads/sage`
* I `git pull trac develop`, and the switched branches or not ...
* I `cd src/mac-app` and `make` as you said
* There is a magically appearing couple of `app.dmg`.
* I double-click on the appropriate one, which verifies fine and opens to the window suggesting dragging to `Applications`
* I do so
* Opening the app to start Jupyter works (at least, it serves up Jupyter, I didn't try to evaluate anything) and if I have the binary pointing to `Downloads/sage/sage` it works fine
* But letting it point to the default confuses it because it thinks it's supposed to live in `Downloads/sage/sage`, even though I thought it lived in `src/mac-app`.  (As described above.)
Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my "development" version.



---

archive/issue_comments_338310.json:
```json
{
    "body": "By the way, I think it's worth having a ticket that this creates a `tmp-...` dmg file in `src/mac-app` that is not eventually trashed.\n\nSeparately, I have no idea why making the app this way makes one that is 7.3 GB and not the usual 3.4 GB; something is being doubled, probably by the way I'm doing it, but I have no idea what.  Maybe it's packaging up an extra dmg in the dmg, who knows.",
    "created_at": "2017-12-17T00:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338310",
    "user": "kcrisman"
}
```

By the way, I think it's worth having a ticket that this creates a `tmp-...` dmg file in `src/mac-app` that is not eventually trashed.

Separately, I have no idea why making the app this way makes one that is 7.3 GB and not the usual 3.4 GB; something is being doubled, probably by the way I'm doing it, but I have no idea what.  Maybe it's packaging up an extra dmg in the dmg, who knows.



---

archive/issue_comments_338311.json:
```json
{
    "body": "About comment 14: the tmp-...dmg file is read-write so that we can mount it and call AppleScript in the mounted directory to set the background image. Read-write dmg's cannot be compressed. After we call AppleScript, we can compress it resulting in a read-only dmg.\n\nI refer to comment 2 in Ticket #23426 for more.",
    "created_at": "2017-12-17T01:50:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338311",
    "user": "mgoerner"
}
```

About comment 14: the tmp-...dmg file is read-write so that we can mount it and call AppleScript in the mounted directory to set the background image. Read-write dmg's cannot be compressed. After we call AppleScript, we can compress it resulting in a read-only dmg.

I refer to comment 2 in Ticket #23426 for more.



---

archive/issue_comments_338312.json:
```json
{
    "body": "Replying to [comment:13 kcrisman]:\n> It doesn't work this way for me without this patch either, so I guess we are okay.  (I checked the package `Contents/Resources/sage/src/mac-app/Makefile` just to be sure it really was the \"right\" one.)\n> > In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).\n> > As well, the existing Sage tree, related to this build, must not be moved/deleted.\n> ?  Here is my exact procedure:\n> * I have stuff in `Downloads/sage`\n> * I `git pull trac develop`, and the switched branches or not ...\n\nyou have to build Sage first, and only after that\nbuild mac-app.\n\n> * I `cd src/mac-app` and `make` as you said\n\n> * There is a magically appearing couple of `app.dmg`.\n> * I double-click on the appropriate one, which verifies fine and opens to the window suggesting dragging to `Applications`\n> * I do so\n> * Opening the app to start Jupyter works (at least, it serves up Jupyter, I didn't try to evaluate anything) and if I have the binary pointing to `Downloads/sage/sage` it works fine\n> * But letting it point to the default confuses it because it thinks it's supposed to live in `Downloads/sage/sage`, even though I thought it lived in `src/mac-app`.  (As described above.)\n> Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my \"development\" version.\n\nNo, the original Sage does not have to be in /Applications",
    "created_at": "2017-12-17T02:10:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338312",
    "user": "dimpase"
}
```

Replying to [comment:13 kcrisman]:
> It doesn't work this way for me without this patch either, so I guess we are okay.  (I checked the package `Contents/Resources/sage/src/mac-app/Makefile` just to be sure it really was the "right" one.)
> > In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).
> > As well, the existing Sage tree, related to this build, must not be moved/deleted.
> ?  Here is my exact procedure:
> * I have stuff in `Downloads/sage`
> * I `git pull trac develop`, and the switched branches or not ...

you have to build Sage first, and only after that
build mac-app.

> * I `cd src/mac-app` and `make` as you said

> * There is a magically appearing couple of `app.dmg`.
> * I double-click on the appropriate one, which verifies fine and opens to the window suggesting dragging to `Applications`
> * I do so
> * Opening the app to start Jupyter works (at least, it serves up Jupyter, I didn't try to evaluate anything) and if I have the binary pointing to `Downloads/sage/sage` it works fine
> * But letting it point to the default confuses it because it thinks it's supposed to live in `Downloads/sage/sage`, even though I thought it lived in `src/mac-app`.  (As described above.)
> Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my "development" version.

No, the original Sage does not have to be in /Applications



---

archive/issue_comments_338313.json:
```json
{
    "body": "> > * I `git pull trac develop`, and the switched branches or not ...\n> \n> you have to build Sage first, and only after that\n> build mac-app.\nRight, I did do that but forgot to say so.\n\n> > Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my \"development\" version.\n> \n> No, the original Sage does not have to be in /Applications\n\nThen I have no explanation for this behavior.",
    "created_at": "2017-12-19T19:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338313",
    "user": "kcrisman"
}
```

> > * I `git pull trac develop`, and the switched branches or not ...
> 
> you have to build Sage first, and only after that
> build mac-app.
Right, I did do that but forgot to say so.

> > Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my "development" version.
> 
> No, the original Sage does not have to be in /Applications

Then I have no explanation for this behavior.



---

archive/issue_comments_338314.json:
```json
{
    "body": "I am told that Mac-app building does not work on OSX 10.11 without the patch.\nThus the question whether this patch introduces a regression there is moot.",
    "created_at": "2018-01-08T15:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338314",
    "user": "dimpase"
}
```

I am told that Mac-app building does not work on OSX 10.11 without the patch.
Thus the question whether this patch introduces a regression there is moot.



---

archive/issue_comments_338315.json:
```json
{
    "body": "That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.",
    "created_at": "2018-01-08T18:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338315",
    "user": "kcrisman"
}
```

That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.



---

archive/issue_comments_338316.json:
```json
{
    "body": "Replying to [comment:19 kcrisman]:\n> That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.\n\nthis ticket needs a reviewer :-)\n\ndo you say that this patch breaks is for you on 10.11 ?",
    "created_at": "2018-01-08T18:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338316",
    "user": "dimpase"
}
```

Replying to [comment:19 kcrisman]:
> That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.

this ticket needs a reviewer :-)

do you say that this patch breaks is for you on 10.11 ?



---

archive/issue_comments_338317.json:
```json
{
    "body": "Replying to [comment:20 dimpase]:\n> Replying to [comment:19 kcrisman]:\n> > That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.\n> \n> this ticket needs a reviewer :-)\n\nI thought that was you.\n> \n> do you say that this patch breaks is for you on 10.11 ?\nNot at all, I'm saying that I wasn't able to test it properly for some reason alluded to above I don't fully understand.  But once it's merged I can use binary-pkg to test it.",
    "created_at": "2018-01-09T02:05:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338317",
    "user": "kcrisman"
}
```

Replying to [comment:20 dimpase]:
> Replying to [comment:19 kcrisman]:
> > That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.
> 
> this ticket needs a reviewer :-)

I thought that was you.
> 
> do you say that this patch breaks is for you on 10.11 ?
Not at all, I'm saying that I wasn't able to test it properly for some reason alluded to above I don't fully understand.  But once it's merged I can use binary-pkg to test it.



---

archive/issue_comments_338318.json:
```json
{
    "body": "the ticket has fields author and reviewer, check them :-)\n\nwhy would you need it merged for testing?",
    "created_at": "2018-01-09T08:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338318",
    "user": "dimpase"
}
```

the ticket has fields author and reviewer, check them :-)

why would you need it merged for testing?



---

archive/issue_comments_338319.json:
```json
{
    "body": "> the ticket has fields author and reviewer, check them :-)\nSorry, I wasn't paying attention to that.  Since I don't have access to 10.12/13 and I couldn't get it to work on 10.11, I can't give that review.  Though John said it was okay on 10.13.\n> why would you need it merged for testing?\nI don't understand it either, but for some reason it is not working for me following the directions you provided.  When I use `binary-pkg`, which requires me to provide either the `develop` or `master` branch on Trac, then I can build the mac app in such a fashion that I can put it in `Applications/` and test it.  I don't know what (if anything) I'm doing wrong, but don't have time to mess around with it, unfortunately.",
    "created_at": "2018-01-09T13:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338319",
    "user": "kcrisman"
}
```

> the ticket has fields author and reviewer, check them :-)
Sorry, I wasn't paying attention to that.  Since I don't have access to 10.12/13 and I couldn't get it to work on 10.11, I can't give that review.  Though John said it was okay on 10.13.
> why would you need it merged for testing?
I don't understand it either, but for some reason it is not working for me following the directions you provided.  When I use `binary-pkg`, which requires me to provide either the `develop` or `master` branch on Trac, then I can build the mac app in such a fashion that I can put it in `Applications/` and test it.  I don't know what (if anything) I'm doing wrong, but don't have time to mess around with it, unfortunately.



---

archive/issue_comments_338320.json:
```json
{
    "body": "Replying to [comment:23 kcrisman]:\n> > the ticket has fields author and reviewer, check them :-)\n> Sorry, I wasn't paying attention to that.  Since I don't have access to 10.12/13 and I couldn't get it to work on 10.11, I can't give that review.  Though John said it was okay on 10.13.\n> > why would you need it merged for testing?\n> I don't understand it either, but for some reason it is not working for me following the directions you provided.  When I use `binary-pkg`, which requires me to provide either the `develop` or `master` branch on Trac, then I can build the mac app in such a fashion that I can put it in `Applications/` and test it.\n\ngit branch and repo used by `binary-pkg` is controlled by lines 3 and 4 of [sage.yaml](https://github.com/sagemath/binary-pkg/blob/master/sage.yaml) - you can change them to whatever you like.\n\nNamely, setting  them to \n\n```\nrepository: https://github.com/sagemath/sagetrac-mirror.git\nbranch: u/dimpase/mac-appfix\n```\n\nshould do the trick.",
    "created_at": "2018-01-09T14:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338320",
    "user": "dimpase"
}
```

Replying to [comment:23 kcrisman]:
> > the ticket has fields author and reviewer, check them :-)
> Sorry, I wasn't paying attention to that.  Since I don't have access to 10.12/13 and I couldn't get it to work on 10.11, I can't give that review.  Though John said it was okay on 10.13.
> > why would you need it merged for testing?
> I don't understand it either, but for some reason it is not working for me following the directions you provided.  When I use `binary-pkg`, which requires me to provide either the `develop` or `master` branch on Trac, then I can build the mac app in such a fashion that I can put it in `Applications/` and test it.

git branch and repo used by `binary-pkg` is controlled by lines 3 and 4 of [sage.yaml](https://github.com/sagemath/binary-pkg/blob/master/sage.yaml) - you can change them to whatever you like.

Namely, setting  them to 

```
repository: https://github.com/sagemath/sagetrac-mirror.git
branch: u/dimpase/mac-appfix
```

should do the trick.



---

archive/issue_comments_338321.json:
```json
{
    "body": "> git branch and repo used by `binary-pkg` is controlled by lines 3 and 4 of [sage.yaml](https://github.com/sagemath/binary-pkg/blob/master/sage.yaml) - you can change them to whatever you like.\n> \n> Namely, setting  them to \n> {{{\n> repository: https://github.com/sagemath/sagetrac-mirror.git\n> branch: u/dimpase/mac-appfix\n> }}}\n> should do the trick.\nAh, I didn't know I could access the branch that way!  I do edit this file but typically only in stupid ways.  There was another thread where we were warned not to use `sagetrac-mirror` ;-) but this is a good use of it.\n\nWith some luck before I leave work today I might have something useful to say about this on 10.11.",
    "created_at": "2018-01-09T16:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338321",
    "user": "kcrisman"
}
```

> git branch and repo used by `binary-pkg` is controlled by lines 3 and 4 of [sage.yaml](https://github.com/sagemath/binary-pkg/blob/master/sage.yaml) - you can change them to whatever you like.
> 
> Namely, setting  them to 
> {{{
> repository: https://github.com/sagemath/sagetrac-mirror.git
> branch: u/dimpase/mac-appfix
> }}}
> should do the trick.
Ah, I didn't know I could access the branch that way!  I do edit this file but typically only in stupid ways.  There was another thread where we were warned not to use `sagetrac-mirror` ;-) but this is a good use of it.

With some luck before I leave work today I might have something useful to say about this on 10.11.



---

archive/issue_comments_338322.json:
```json
{
    "body": "\n```\nsubprocess.CalledProcessError: Command '['git', 'checkout', 'u/dimpase/mac-appfix']' returned non-zero exit status 1\n```\n",
    "created_at": "2018-01-09T16:26:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338322",
    "user": "kcrisman"
}
```


```
subprocess.CalledProcessError: Command '['git', 'checkout', 'u/dimpase/mac-appfix']' returned non-zero exit status 1
```




---

archive/issue_comments_338323.json:
```json
{
    "body": "Are you trying with a fresh clone of https://github.com/sagemath/binary-pkg ?\nDoes it work with these lines in sage.yaml unchanged?\n\nIt works for me on Linux and on OSX 10.13:\n\n1) change these lines in sage.yaml as follows:\n\n\n```\nrepository: https://github.com/sagemath/sagetrac-mirror.git\nbranch: u/dimpase/mac-appfix\n```\n\n\n2) run `make package-sage`\n\n3) ...",
    "created_at": "2018-01-09T16:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338323",
    "user": "dimpase"
}
```

Are you trying with a fresh clone of https://github.com/sagemath/binary-pkg ?
Does it work with these lines in sage.yaml unchanged?

It works for me on Linux and on OSX 10.13:

1) change these lines in sage.yaml as follows:


```
repository: https://github.com/sagemath/sagetrac-mirror.git
branch: u/dimpase/mac-appfix
```


2) run `make package-sage`

3) ...



---

archive/issue_comments_338324.json:
```json
{
    "body": "I didn't have an updated `binary-pkg`.  After doing so, now I get\n\n```\n  File \"/Users/.../binary-pkg/binary_pkg/os_information.py\", line 4, in <module>\n    import ld\nModuleNotFoundError: No module named 'ld'\nmake[1]: *** [checkout-sage] Error 1\nmake: *** [bdist-sage-osx] Error 2\n```\n\n\nSo I just completely did a new `git clone`.  Hopefully this will do better!",
    "created_at": "2018-01-09T17:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338324",
    "user": "kcrisman"
}
```

I didn't have an updated `binary-pkg`.  After doing so, now I get

```
  File "/Users/.../binary-pkg/binary_pkg/os_information.py", line 4, in <module>
    import ld
ModuleNotFoundError: No module named 'ld'
make[1]: *** [checkout-sage] Error 1
make: *** [bdist-sage-osx] Error 2
```


So I just completely did a new `git clone`.  Hopefully this will do better!



---

archive/issue_comments_338325.json:
```json
{
    "body": "Indeed, binary-pkg installs a miniconda to get a good python, and perhaps some stale files prevented this from being updated properly. On OSX 10.13 I see\n\n```\n$ ./tools/binary-pkg/bin/python\nPython 3.6.4 | packaged by conda-forge | (default, Dec 23 2017, 16:54:01) \n[GCC 4.2.1 Compatible Apple LLVM 6.1.0 (clang-602.0.53)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import ld\n>>> \n```\n\nworking.",
    "created_at": "2018-01-09T18:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338325",
    "user": "dimpase"
}
```

Indeed, binary-pkg installs a miniconda to get a good python, and perhaps some stale files prevented this from being updated properly. On OSX 10.13 I see

```
$ ./tools/binary-pkg/bin/python
Python 3.6.4 | packaged by conda-forge | (default, Dec 23 2017, 16:54:01) 
[GCC 4.2.1 Compatible Apple LLVM 6.1.0 (clang-602.0.53)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import ld
>>> 
```

working.



---

archive/issue_comments_338326.json:
```json
{
    "body": "Probably that's what happened.  Currently building, but of course `SAGE_INSTALL_GCC='yes'` or something in `binary-pkg` and I didn't want to mess with that setting, so this will take a **long** time.",
    "created_at": "2018-01-09T19:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338326",
    "user": "kcrisman"
}
```

Probably that's what happened.  Currently building, but of course `SAGE_INSTALL_GCC='yes'` or something in `binary-pkg` and I didn't want to mess with that setting, so this will take a **long** time.



---

archive/issue_comments_338327.json:
```json
{
    "body": "I presume you do `make package-sage PACKAGE=\"OSX mac app\"` - I forgot abou the last parameter.",
    "created_at": "2018-01-09T19:14:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338327",
    "user": "dimpase"
}
```

I presume you do `make package-sage PACKAGE="OSX mac app"` - I forgot abou the last parameter.



---

archive/issue_comments_338328.json:
```json
{
    "body": "Not only did it work, it saved my ... rear end, because the wireless at the Joint Meetings was sketchy enough I couldn't have given my talk using Sage in number theory without running my local Sage, which ended up being this very dmg :-)",
    "created_at": "2018-01-12T21:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338328",
    "user": "kcrisman"
}
```

Not only did it work, it saved my ... rear end, because the wireless at the Joint Meetings was sketchy enough I couldn't have given my talk using Sage in number theory without running my local Sage, which ended up being this very dmg :-)



---

archive/issue_comments_338329.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-01-12T21:40:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338329",
    "user": "kcrisman"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_338330.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-01-14T10:14:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24136",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24136#issuecomment-338330",
    "user": "vbraun"
}
```

Resolution: fixed
