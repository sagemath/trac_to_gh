# Issue 24136: fix building Sage's Mac-app on OSX 10.13

Issue created by migration from Trac.

Original creator: dimpase

Original creation time: 2017-12-14 09:46:53

CC:  jhpalmieri mgoerner

Keywords: OSX

It is [confirmed](https://groups.google.com/d/msg/sage-devel/OF6-I4lMkQE/3i-Qk8WGCgAJ) broken; a fix appears to be a small change in its makefile:

```
diff --git a/src/mac-app/Makefile b/src/mac-app/Makefile
index 430121647a..d0c8238cbc 100644
--- a/src/mac-app/Makefile
+++ b/src/mac-app/Makefile
`@``@` -103,7 +103,7 `@``@` $(TARGET)/README.txt: $(SAGE_ROOT)/src/bin/sage-README-osx.txt
 
 non_app_files: $(TARGET)/README.txt $(TARGET)/.background/sage.png $(TARGET)/Applications
 
-sage_symlink: $(APP)/Contents/Resources/sage/sage
+sage_symlink: $(APP)/Contents/Resources/sage
        rm -f $(APP)/sage
        ln -s Contents/Resources/sage/sage $(APP)/sage
```



---

Comment by dimpase created at 2017-12-14 10:28:47

OK, this works on 10.12 as well. Anyone to test on OSX 10.11 ? (We most probably don't need to go any further)
----
New commits:


---

Comment by dimpase created at 2017-12-14 10:28:47

Changing status from new to needs_review.


---

Comment by kcrisman created at 2017-12-15 13:22:46

Just a build fix, not a run fix?  Remind me the process for testing this and I can try it out.


---

Comment by dimpase created at 2017-12-15 13:36:23

Replying to [comment:2 kcrisman]:
> Just a build fix, not a run fix?  Remind me the process for testing this and I can try it out.

after building Sage, cd to src/mac-app/ and type `make`. After a while you'd get a `sage-8*.dmg` file which you can test by opening, installing (in the usual OSX way) and running.


---

Comment by kcrisman created at 2017-12-16 00:38:06

> after building Sage, cd to src/mac-app/ and type `make`. After a while you'd get a `sage-8*.dmg` file which you can test by opening, installing (in the usual OSX way) and running.

Great, I just upgraded to the first beta so I can try this quite soon.


---

Comment by jhpalmieri created at 2017-12-16 01:02:57

It works for me on OS X 10.13, as reported on sage-devel. (Actually, there I just reported building correctly, but it also unpacks and then runs successfully.)


---

Comment by kcrisman created at 2017-12-16 05:06:56

It seems to work on 10.11, but I got

```
ERROR:  The Sage installation tree has moved

from /Users/.../sage
  to /Applications/SageMath-8.2.beta0.app/Contents/Resources/sage

This is not supported, and Sage will not work.
```

which is weird because I took the dmg in question, opened it, then dragged the Sage app to `/Applications` so it shouldn't have run before that.  I guess only `binary-pkg` can make even that minimal relocation work.  But in that case I'm not sure how to test it running properly.  If it helps, the app part opens fine - it's only running Sage itself from that binary that doesn't for that reason.  So my guess is we are fine.

By the way, what's up with the file `tmp-sage-8.2.beta0-OSX_10.11.6_x86_64.app.dmg` worth 8.2 GB when I finish `make`?  Shouldn't that disappear at some point?  It seems obscenely huge ... though I guess the unpacked app is that big, too.  Why is 8.1.rc2.app about 3.5 GB but this is more than twice as big? Maybe because I didn't use `binary-pkg` for the current test?


---

Comment by dimpase created at 2017-12-16 08:30:59

Replying to [comment:6 kcrisman]:
> It seems to work on 10.11, but I got
> {{{
> ERROR:  The Sage installation tree has moved

Does it work on 10.11 if you revert this branch back?
It is not hard to detect the version and use the code that
works for each version...

Or perhaps it's broken on 10.11 anyway?
The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.


----
So I gather that the patch is needed and works on 10.12 and 10.13, and it remains to see what's happening on 10.11 (whether it causes a regression or not)


---

Comment by dimpase created at 2017-12-16 10:19:42

The whole story is probably due to the format changes in .DS_store that happened as 10.12 was released.
See https://bitbucket.org/al45tair/ds_store/issues/7


---

Comment by kcrisman created at 2017-12-16 14:55:16

> Does it work on 10.11 if you revert this branch back?
I'll check that out - hopefully my power cord will work properly ;-)
> Or perhaps it's broken on 10.11 anyway?
I highly doubt it, since I built 8.1.rc2 with `binary-pkg` and tested the binary and it seemed to work fine.
> The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.
Well, it does in the sense that both of them build the Mac app if requested.  I think that since my only issue is the relocation that this is probably why it didn't work.  Where did you open your app.dmg (what folder)?


---

Comment by dimpase created at 2017-12-16 15:11:48

Replying to [comment:9 kcrisman]:
> > Does it work on 10.11 if you revert this branch back?
> I'll check that out - hopefully my power cord will work properly ;-)
> > Or perhaps it's broken on 10.11 anyway?
> I highly doubt it, since I built 8.1.rc2 with `binary-pkg` and tested the binary and it seemed to work fine.
> > The  [binary-pkg](https://github.com/sagemath/binary-pkg) is a completely different story, and has nothing to do on this ticket.

Well, I mean it is an extra level of complexity that should not be mixed up with the issue at hand.

> Well, it does in the sense that both of them build the Mac app if requested.  I think that since my only issue is the relocation that this is probably why it didn't work.  Where did you open your app.dmg (what folder)?

I have installed the resulting dmg into /Applications (i.e. you open it, it gets checked and mounted, you see an invitation to move Sage into /Applications, you do it, then you
open Sage.app in /Applications).

PS. As I said I won't be surprised if 10.11 needs to be handled differently from the later versions.


---

Comment by kcrisman created at 2017-12-16 15:25:52

Even if I open the binary that isn't in the app, but the one created in `src/mac-app` before compression, I get

```
ERROR:  The Sage installation tree has moved

from /Users/.../sage
  to /Users/.../sage/src/mac-app/sage-8.2.beta0-OSX_10.11.6_x86_64/SageMath-8.2.beta0.app/Contents/Resources/sage
```

Anyway, you may be right that 10.11 needs different handling.  
> I have installed the resulting dmg into /Applications (i.e. you open it, it gets checked and mounted, you see an invitation to move Sage into /Applications, you do it, then you open Sage.app in /Applications).
Yup, that's exactly what I did.

Anyway, trying again without this change (had to delete all previous long Sage-named folders and app.dmg first).  Probably can report back tonight EST.


---

Comment by dimpase created at 2017-12-16 19:11:44

In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).
A [better installer](https://stackoverflow.com/questions/11487596/making-os-x-installer-packages-like-a-pro-xcode-developer-id-ready-pkg) would directly move Sage.app to `/Applications`, rather than 
inviting to move it there. Something for another ticket.

As well, the existing Sage tree, related to this build, must not be moved/deleted.


---

Comment by kcrisman created at 2017-12-17 00:53:39

It doesn't work this way for me without this patch either, so I guess we are okay.  (I checked the package `Contents/Resources/sage/src/mac-app/Makefile` just to be sure it really was the "right" one.)
> In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).
> As well, the existing Sage tree, related to this build, must not be moved/deleted.
?  Here is my exact procedure:
* I have stuff in `Downloads/sage`
* I `git pull trac develop`, and the switched branches or not ...
* I `cd src/mac-app` and `make` as you said
* There is a magically appearing couple of `app.dmg`.
* I double-click on the appropriate one, which verifies fine and opens to the window suggesting dragging to `Applications`
* I do so
* Opening the app to start Jupyter works (at least, it serves up Jupyter, I didn't try to evaluate anything) and if I have the binary pointing to `Downloads/sage/sage` it works fine
* But letting it point to the default confuses it because it thinks it's supposed to live in `Downloads/sage/sage`, even though I thought it lived in `src/mac-app`.  (As described above.)
Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my "development" version.


---

Comment by kcrisman created at 2017-12-17 00:56:02

By the way, I think it's worth having a ticket that this creates a `tmp-...` dmg file in `src/mac-app` that is not eventually trashed.

Separately, I have no idea why making the app this way makes one that is 7.3 GB and not the usual 3.4 GB; something is being doubled, probably by the way I'm doing it, but I have no idea what.  Maybe it's packaging up an extra dmg in the dmg, who knows.


---

Comment by mgoerner created at 2017-12-17 01:50:04

About comment 14: the tmp-...dmg file is read-write so that we can mount it and call AppleScript in the mounted directory to set the background image. Read-write dmg's cannot be compressed. After we call AppleScript, we can compress it resulting in a read-only dmg.

I refer to comment 2 in Ticket #23426 for more.


---

Comment by dimpase created at 2017-12-17 02:10:36

Replying to [comment:13 kcrisman]:
> It doesn't work this way for me without this patch either, so I guess we are okay.  (I checked the package `Contents/Resources/sage/src/mac-app/Makefile` just to be sure it really was the "right" one.)
> > In fact, if you have a look at the Makefile in question, you will see that it explicitly sets Sage.app to be located in `/Applications`. Other locations won't work (it's something not well-documented it seems).
> > As well, the existing Sage tree, related to this build, must not be moved/deleted.
> ?  Here is my exact procedure:
> * I have stuff in `Downloads/sage`
> * I `git pull trac develop`, and the switched branches or not ...

you have to build Sage first, and only after that
build mac-app.

> * I `cd src/mac-app` and `make` as you said

> * There is a magically appearing couple of `app.dmg`.
> * I double-click on the appropriate one, which verifies fine and opens to the window suggesting dragging to `Applications`
> * I do so
> * Opening the app to start Jupyter works (at least, it serves up Jupyter, I didn't try to evaluate anything) and if I have the binary pointing to `Downloads/sage/sage` it works fine
> * But letting it point to the default confuses it because it thinks it's supposed to live in `Downloads/sage/sage`, even though I thought it lived in `src/mac-app`.  (As described above.)
> Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my "development" version.

No, the original Sage does not have to be in /Applications


---

Comment by kcrisman created at 2017-12-19 19:18:15

> > * I `git pull trac develop`, and the switched branches or not ...
> 
> you have to build Sage first, and only after that
> build mac-app.
Right, I did do that but forgot to say so.

> > Again, as data point, when I use `binary-pkg` to create a binary I don't have problems with relocation, so there is something I'm doing wrong in this process.  Maybe because my original Sage doesn't live in `Applications`?  But I don't want it there, because it's not an app, it's the command line and my "development" version.
> 
> No, the original Sage does not have to be in /Applications

Then I have no explanation for this behavior.


---

Comment by dimpase created at 2018-01-08 15:04:09

I am told that Mac-app building does not work on OSX 10.11 without the patch.
Thus the question whether this patch introduces a regression there is moot.


---

Comment by kcrisman created at 2018-01-08 18:18:50

That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.


---

Comment by dimpase created at 2018-01-08 18:24:56

Replying to [comment:19 kcrisman]:
> That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.

this ticket needs a reviewer :-)

do you say that this patch breaks is for you on 10.11 ?


---

Comment by kcrisman created at 2018-01-09 02:05:24

Replying to [comment:20 dimpase]:
> Replying to [comment:19 kcrisman]:
> > That's weird because I am successful on 10.11.  But go ahead and I can test it once merged too - let me know.
> 
> this ticket needs a reviewer :-)

I thought that was you.
> 
> do you say that this patch breaks is for you on 10.11 ?
Not at all, I'm saying that I wasn't able to test it properly for some reason alluded to above I don't fully understand.  But once it's merged I can use binary-pkg to test it.


---

Comment by dimpase created at 2018-01-09 08:00:35

the ticket has fields author and reviewer, check them :-)

why would you need it merged for testing?


---

Comment by kcrisman created at 2018-01-09 13:28:03

> the ticket has fields author and reviewer, check them :-)
Sorry, I wasn't paying attention to that.  Since I don't have access to 10.12/13 and I couldn't get it to work on 10.11, I can't give that review.  Though John said it was okay on 10.13.
> why would you need it merged for testing?
I don't understand it either, but for some reason it is not working for me following the directions you provided.  When I use `binary-pkg`, which requires me to provide either the `develop` or `master` branch on Trac, then I can build the mac app in such a fashion that I can put it in `Applications/` and test it.  I don't know what (if anything) I'm doing wrong, but don't have time to mess around with it, unfortunately.


---

Comment by dimpase created at 2018-01-09 14:09:07

Replying to [comment:23 kcrisman]:
> > the ticket has fields author and reviewer, check them :-)
> Sorry, I wasn't paying attention to that.  Since I don't have access to 10.12/13 and I couldn't get it to work on 10.11, I can't give that review.  Though John said it was okay on 10.13.
> > why would you need it merged for testing?
> I don't understand it either, but for some reason it is not working for me following the directions you provided.  When I use `binary-pkg`, which requires me to provide either the `develop` or `master` branch on Trac, then I can build the mac app in such a fashion that I can put it in `Applications/` and test it.

git branch and repo used by `binary-pkg` is controlled by lines 3 and 4 of [sage.yaml](https://github.com/sagemath/binary-pkg/blob/master/sage.yaml) - you can change them to whatever you like.

Namely, setting  them to 

```
repository: https://github.com/sagemath/sagetrac-mirror.git
branch: u/dimpase/mac-appfix
```

should do the trick.


---

Comment by kcrisman created at 2018-01-09 16:18:23

> git branch and repo used by `binary-pkg` is controlled by lines 3 and 4 of [sage.yaml](https://github.com/sagemath/binary-pkg/blob/master/sage.yaml) - you can change them to whatever you like.
> 
> Namely, setting  them to 
> {{{
> repository: https://github.com/sagemath/sagetrac-mirror.git
> branch: u/dimpase/mac-appfix
> }}}
> should do the trick.
Ah, I didn't know I could access the branch that way!  I do edit this file but typically only in stupid ways.  There was another thread where we were warned not to use `sagetrac-mirror` ;-) but this is a good use of it.

With some luck before I leave work today I might have something useful to say about this on 10.11.


---

Comment by kcrisman created at 2018-01-09 16:26:42


```
subprocess.CalledProcessError: Command '['git', 'checkout', 'u/dimpase/mac-appfix']' returned non-zero exit status 1
```



---

Comment by dimpase created at 2018-01-09 16:57:43

Are you trying with a fresh clone of https://github.com/sagemath/binary-pkg ?
Does it work with these lines in sage.yaml unchanged?

It works for me on Linux and on OSX 10.13:

1) change these lines in sage.yaml as follows:


```
repository: https://github.com/sagemath/sagetrac-mirror.git
branch: u/dimpase/mac-appfix
```


2) run `make package-sage`

3) ...


---

Comment by kcrisman created at 2018-01-09 17:43:57

I didn't have an updated `binary-pkg`.  After doing so, now I get

```
  File "/Users/.../binary-pkg/binary_pkg/os_information.py", line 4, in <module>
    import ld
ModuleNotFoundError: No module named 'ld'
make[1]: *** [checkout-sage] Error 1
make: *** [bdist-sage-osx] Error 2
```


So I just completely did a new `git clone`.  Hopefully this will do better!


---

Comment by dimpase created at 2018-01-09 18:38:30

Indeed, binary-pkg installs a miniconda to get a good python, and perhaps some stale files prevented this from being updated properly. On OSX 10.13 I see

```
$ ./tools/binary-pkg/bin/python
Python 3.6.4 | packaged by conda-forge | (default, Dec 23 2017, 16:54:01) 
[GCC 4.2.1 Compatible Apple LLVM 6.1.0 (clang-602.0.53)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> import ld
>>> 
```

working.


---

Comment by kcrisman created at 2018-01-09 19:12:10

Probably that's what happened.  Currently building, but of course `SAGE_INSTALL_GCC='yes'` or something in `binary-pkg` and I didn't want to mess with that setting, so this will take a *long* time.


---

Comment by dimpase created at 2018-01-09 19:14:47

I presume you do `make package-sage PACKAGE="OSX mac app"` - I forgot abou the last parameter.


---

Comment by kcrisman created at 2018-01-12 21:40:46

Not only did it work, it saved my ... rear end, because the wireless at the Joint Meetings was sketchy enough I couldn't have given my talk using Sage in number theory without running my local Sage, which ended up being this very dmg :-)


---

Comment by kcrisman created at 2018-01-12 21:40:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-01-14 10:14:33

Resolution: fixed
