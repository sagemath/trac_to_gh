# Issue 31089: homebrew-macos-11.0-xcode-minimal: scipy build fails

Issue created by migration from https://trac.sagemath.org/ticket/31326

Original creator: mkoeppe

Original creation time: 2021-02-02 17:32:25

CC:  jhpalmieri @zlscherr dimpase @kliem isuruf

(from #31227)


---

Comment by mkoeppe created at 2021-03-14 23:40:04

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-03-15 00:10:41

It seems like `numpy.distutils` gets confused by extra whitespace in the result of `gfortran -dumpversion`. This might be related to the use of `zsh` as the shell. 

This will need investigation by someone who has already made the switch to Big Sur...


---

Comment by @zlscherr created at 2021-03-15 02:04:32

just want to point out that this problem exists on bash as well.  For anyone wanting to test you can, after configuring, do:



```
make toolchain
make gfortran
FC="local/bin/gfortran" make numpy
```


to see the error.


---

Comment by @zlscherr created at 2021-03-15 03:37:00

I haven't tested the full homebrew-macos-11.0-xcode-minimal build, but I'm guessing it's related to MACOSX_DEPLOYMENT_TARGET.

As I noted above, I can recreate the error with numpy by using sage's gfortran 9.2.0 on my machine with homebrew.  As per usual I think this is because python was built with MACOSX_DEPLOYMENT_TARGET 11.0 and gfortran 9.2.0 can't recognize this value.

Now I know that at some point scipy's spkg-install.in file was changed to contain the lines:



```
if [ $MACOSX_VERSION -ge 20 ]; then
     export MACOSX_DEPLOYMENT_TARGET=11.0
fi
```


I'm not exactly sure what is in homebrew-macos-11.0-xcode-minimal, but if sage is building its own gfortran and its own python using a different MACOSX_DEPLOYMENT_TARGET then I would guess that this line might be causing the problems.

It's been a while since I've thought about this problem, but it's possible that the above export might not be needed anymore since homebrew patched GCC.


---

Comment by @zlscherr created at 2021-03-15 03:39:53

Actually it probably shouldn't matter whether or not sage is building its own python.  gfortran 9.2.0 just can't recognize MACOSX_DEPLOYMENT_TARGET=11.0.


---

Comment by @zlscherr created at 2021-03-15 03:41:25

Sorry for the spam, but the ticket that introduced that if statement is #31183


---

Comment by mkoeppe created at 2021-03-15 03:43:28

Could you check if the gcc upgrade in #29827 fixes this issue?


---

Comment by mkoeppe created at 2021-03-15 03:46:07

Replying to [comment:5 gh-zlscherr]:
> I'm not exactly sure what is in homebrew-macos-11.0-xcode-minimal, but if sage is building its own gfortran 

Yes, that's right. This configuration uses a minimal installation of homebrew, plus the packages listed in `build/pkgs/_bootstrap/distros/homebrew.txt`, namely `gettext autoconf automake libtool pkg-config`


---

Comment by @zlscherr created at 2021-03-15 03:54:55

I also just saw that the error reported on top is in numpy and not in scipy.  I'll take a look at #29827 when I get a chance, but I know that homebrew had to specifically patch GCC to avoid this sort of problem.  A viable solution might be to track the legacy option to see if sage is building its own Fortran, and if so we set MACOSX_DEPLOYMENT_TARGET to 10.something


---

Comment by mkoeppe created at 2021-03-15 03:56:01

No, it's an error building scipy -- which uses numpy.distutils, which you see in the lines of the log


---

Comment by @zlscherr created at 2021-03-15 04:11:36

Ah okay. Also, do you know if the homebrew minimal test uses system for python? That might be responsible for why the deployment Target is set to 11, whereas when sage builds it's own python the deployment Target is set lower.


---

Comment by mkoeppe created at 2021-03-15 04:18:59

From https://groups.google.com/g/sage-release/c/KdSKg6RdZok/m/GXfB1rW1AgAJ: Runs in which scipy fails to build:

- local-macos (homebrew-macos, minimal, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782309 -- Sage installs python3 from spkg

- local-macos (conda-forge-macos, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda

- local-macos (homebrew-macos-python3_pythonorg, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782375 - uses somewhat dated python3 from python.org - https://www.python.org/ftp/python/3.7.7/python-3.7.7-macosx10.9.pkg


---

Comment by jhpalmieri created at 2021-03-15 04:27:21

For what it's worth, if I do

```
% make distclean && ./configure --with-system-gfortran=no && make
```

then the build fails on `numpy`, not `scipy`, but with the same sort of error:

```
ValueError: A valid Fortran version was not found in this string:

9.2.0
```



---

Comment by mkoeppe created at 2021-03-15 04:35:18

I think there are extra newlines in this version string, which confuses the numpy.distutils code


---

Comment by @zlscherr created at 2021-03-16 02:16:23

It's actually worse than just extra newlines.  I tried manually patching to strip all whitespace from both ends, but that didn't solve the problem.  I dumped the contents of the version_string which is causing numpy to fail into a text file and it turned out to be

"gfortran: warning: couldn't understand version 11

9.3.0"

(I tested with gcc 9.3, but the same happens with 9.2)

I can get numpy and scipy to build by manually forcing MACOSX_DEPLOYMENT_TARGET to be 10.16 but it seems that 11 and 11.0 both cause problems.

Here is a proposal for how to deal with this:

1.  Remove the if statements from scipy's spkg-install to set MACOSX_DEPLOYMENT_TARGET to 11.0.  I don't think this is needed anymore since Homebrew patched GCC 10 but I can do some testing on that.

2.  At some point in the build process we take a look at MACOSX_DEPLOYMENT_TARGET, which can be easily done with something like



```
python3 -c "import sysconfig; print(sysconfig.get_config_var('MACOSX_DEPLOYMENT_TARGET'))"
```


if we get back a value of 11 and yet the version of gfortran we are using is less than 10.2.0 then we change MACOSX_DEPLOYMENT_TARGET to 10.16 or something like that.


---

Comment by @zlscherr created at 2021-03-16 02:18:27

But probably the second step is not necessary, it would only be needed if the user has python3 from Homebrew and yet gfortran from sage.  I think just fixing up scipy's spkg-install should fix everything.


---

Comment by git created at 2021-03-16 02:32:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @zlscherr created at 2021-03-16 02:33:08

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-16 02:33:47

Thanks for investigating! 

To test this in various configurations, it would be enough to merge the branch of #31492 and then push a tag to your github fork of sage.


---

Comment by @zlscherr created at 2021-03-16 02:45:06

I think I did that correctly.  I'll report on what happens in the CI on my repo.


---

Comment by @zlscherr created at 2021-03-16 03:23:27

I'm not sure if there is something I need to do to get the CI working, but some of the homebrew's are already failing because of an error like:

curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to homebrew.bintray.com:443

Is there something I need to do to avoid this?


---

Comment by mkoeppe created at 2021-03-16 03:34:23

There are various ways how these CI runs can intermittently fail. It's nothing that we can fix on our side as far as I can tell. 

By the way, if you want, you can remove the unnecessary runs (for linux, cygwin) by editing files in `.github/workflows/`. Also `max-parallel` can be edited so that more macOS jobs are run in parallel.


---

Comment by mkoeppe created at 2021-03-16 07:01:28

Replying to [comment:13 mkoeppe]:
> - local-macos (conda-forge-macos, standard, default, macos-11.0) https://github.com/mkoeppe/sage/runs/2103782333 - uses python3 from conda

`@`isuruf: Also this build using conda-forge is affected


---

Comment by dimpase created at 2021-03-20 20:59:50

yes, my student also reports getting

```
[scipy-1.5.4]     clang: error: invalid version number in 'MACOSX_DEPLOYMENT_TARGET=11.0'
```



---

Comment by @zlscherr created at 2021-03-20 21:22:12

I tried running on github CI, but it quit after a few days and only got through 10.15.  I just took out 10.15 and am trying again...


---

Comment by @zlscherr created at 2021-03-21 19:31:27

I tried to run the CI tests on 11.0 but I got the following error message:

"No runner matching the specified labels was found: macos-11.0"

Is there a different way I should get the tests to run on Big Sur?


---

Comment by mkoeppe created at 2021-03-21 19:45:33

https://github.com/actions/virtual-environments/issues/2486
"macOS 11.0 pools will be transited to private preview"


---

Comment by @zlscherr created at 2021-03-21 19:47:05

gotcha.  I've tried some local testing and the reversion seems to be fine, but I'll leave it to others to do more extensive testing.


---

Comment by mkoeppe created at 2021-03-21 19:48:05

Some of my recent runs in https://github.com/mkoeppe/sage/actions/workflows/tox.yml have used branches that merged this ticket and may contain some useful results for 11.0


---

Comment by mkoeppe created at 2021-03-21 21:43:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-03-21 21:43:44

- local-macos (homebrew-macos, minimal, default, macos-11.0) - 
 https://github.com/mkoeppe/sage/runs/2156548349 - OK

- local-macos (homebrew-macos, standard, default, macos-11.0) - https://github.com/mkoeppe/sage/runs/2156548388 - OK


---

Comment by mkoeppe created at 2021-03-21 21:47:19

Also 

- local-macos (conda-forge-macos, standard, default, macos-11.0) - https://github.com/mkoeppe/sage/runs/2135024636 - OK (except for an unrelated error in docbuild)


---

Comment by jhpalmieri created at 2021-03-22 02:57:34

I agree it works with various Pythons on OS X 11. comment:14 has not been addressed, but I guess that's not for this ticket.


---

Comment by mkoeppe created at 2021-03-22 03:08:33

Replying to [comment:35 jhpalmieri]:
> comment:14 has not been addressed, but I guess that's not for this ticket.
Yes, to fix that we need to upgrade our gcc/gfortran - that's #29703.


---

Comment by vbraun created at 2021-03-23 23:49:36

Resolution: fixed
