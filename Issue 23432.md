# Issue 23432: Sparse matrix-matrix multiplication mod p may overflow

Issue created by migration from Trac.

Original creator: roche

Original creation time: 2017-08-22 04:28:20

CC:  kedlaya

Keywords: sparse matrix multiplication matrix_modn_sparse

Multiplying two sparse matrices over a small prime field sometimes produces incorrect results. Small example:


```
sage: p = next_prime(2**15); p
32771
sage: M = Matrix(GF(p), 1,3, lambda i,j: -1, sparse=True); M
[32770 32770 32770]
sage: M*M.transpose()
[32738] # INCORRECT, should be 3
```


In fact, the result in this case is off by 2<sup>32</sup> (mod p) indicating an int overflow.


---

Comment by roche created at 2017-08-22 04:29:21

I believe the error is on line 387 of matrix_modn_sparse.pyx and I will try fixing.


---

Comment by git created at 2017-08-22 05:02:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roche created at 2017-08-22 05:04:09

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2017-08-22 09:09:00

David,

You should add a doctest to the documentation string that give an example of the bug that you fixed. This has to go in the `TESTS` section (see http://doc.sagemath.org/html/en/developer/coding_basics.html#documentation-strings). A reasonable template is

```
TESTS:

The following was wrong prior to :trac:`23669`::

    sage: the_example_that_used_to_fail_but_is_now_ok()
    output
```



---

Comment by kedlaya created at 2017-08-23 18:34:23

I added a docstring consisting of the example from the ticket description.
----
New commits:


---

Comment by vdelecroix created at 2017-08-23 19:06:45

Indentation issue

```
EXAMPLES:

A nice sentence::

 +---- FOUR SPACES HERE
 |
 v
    sage: print('hello')
    bouh
```



---

Comment by git created at 2017-08-23 20:26:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2017-08-23 20:26:39

Replying to [comment:9 vdelecroix]:
> Indentation issue
> {{{
> EXAMPLES:
> 
> A nice sentence::
> 
>  +---- FOUR SPACES HERE
>  |
>  v
>     sage: print('hello')
>     bouh
> }}}

Should be fixed now, thanks!


---

Comment by vdelecroix created at 2017-08-23 20:32:50

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2017-08-23 20:32:50

Changing keywords from "sparse matrix multiplication matrix_modn_sparse" to "sparse matrix multiplication, matrix_modn_sparse, days88".


---

Comment by vbraun created at 2017-08-29 19:51:25

Resolution: fixed
