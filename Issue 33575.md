# Issue 33575: Refactor distributions sage-setup, sagemath-{objects,categories} through sagemath-{environment,repl}

Issue created by migration from https://trac.sagemath.org/ticket/33812

Original creator: mkoeppe

Original creation time: 2022-05-05 17:54:37

CC:  klee

Currently *sagemath-categories* distributes a superset of *sagemath-objects*, and both distributions include a copy of the doctester for their doctesting. We remove this duplication by declaring install-requires and extras-require.

*sage-setup* currently calls into the Sage package that it installs by manipulating the load path. We replace it by an install-requires on *sagemath-environment*.


---

Comment by git created at 2022-05-08 03:14:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 03:16:06

Now that we are testing *sagemath-objects* with the stuff now in *sagemath-environment* stripped away, dependencies become apparent that need to be removed.

```
[sagemath_objects-9.6.rc3]   File "sage/misc/lazy_import.pyx", line 69, in init sage.misc.lazy_import (build/cythonized/sage/misc/lazy_import.c:10965)
[sagemath_objects-9.6.rc3]     from . import sageinspect
[sagemath_objects-9.6.rc3]   File "/Users/mkoeppe/s/sage/sage-rebasing/pkgs/sagemath-objects/.tox/sagepython-norequirements-sagewheels-nopypi/lib/python3.10/site-packages/sage/misc/sageinspect.py", line 122, in <module>
[sagemath_objects-9.6.rc3]     from sage.env import SAGE_LIB
[sagemath_objects-9.6.rc3] ModuleNotFoundError: No module named 'sage.env'
```



---

Comment by mkoeppe created at 2022-05-08 03:31:38

So this needs #33037 (Remove use of `SAGE_LIB`)


---

Comment by git created at 2022-05-08 04:58:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 05:56:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 06:15:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 06:42:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 07:26:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 07:49:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 08:05:47

Next dependency

```
[sagemath_objects-9.6.rc3]   File "sage/structure/sage_object.pyx", line 9, in init sage.structure.sage_object (build/cythonized/sage/structure/sage_object.c:12337)
[sagemath_objects-9.6.rc3]     from sage.misc.lazy_import import LazyImport
[sagemath_objects-9.6.rc3]   File "sage/misc/lazy_import.pyx", line 71, in init sage.misc.lazy_import (build/cythonized/sage/misc/lazy_import.c:11032)
[sagemath_objects-9.6.rc3]     from sage.features import FeatureNotPresentError
[sagemath_objects-9.6.rc3] ModuleNotFoundError: No module named 'sage.features'
```



---

Comment by git created at 2022-05-08 08:13:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 12:34:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-08 12:49:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-08 13:07:56

Changing status from new to needs_review.


---

Comment by git created at 2022-05-08 18:21:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-09 18:59:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-09 19:19:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-09 19:33:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-09 19:43:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-09 20:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-09 20:13:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-10 00:06:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-10 02:45:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-10 03:12:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-10 03:50:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-10 04:22:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-10 05:08:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-10 05:12:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-10 05:23:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-30 04:45:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-30 05:17:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-12 19:04:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-25 22:09:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-25 23:16:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-09 23:32:19

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-07-09 23:32:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-11 00:21:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 20:38:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-25 22:37:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-26 01:14:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-26 19:56:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-07-26 20:13:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-08-22 16:39:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-21 20:25:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-09-25 00:05:42

Questions:

1. In `dependencies` files, `sagemath-categories` depends on `cysignals gmpy2 sagemath_objects` and `sagemath-objects` depends on `cysignals gmpy2`. Does `cysignals gmpy2` need to be repeated?

2. In the hierarchy diagram, `sagemath-repl` depends on both `sagemath-environment` and `sagemath-objects`, but in the `dependencies` file of `sagemath-repl` spkg, I see `sagemath_objects ipython`. Why `sagemath-environment` is missing?


---

Comment by git created at 2022-09-25 00:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-09-25 00:45:48

Replying to [comment:60 Kwankyu Lee]:
> 2. In the hierarchy diagram, `sagemath-repl` depends on both `sagemath-environment` and `sagemath-objects`, but in the `dependencies` file of `sagemath-repl` spkg, I see `sagemath_objects ipython`. Why `sagemath-environment` is missing?

Sorry.. The hierarchy diagram is the hierarchy of the distribution pkgs. I now see the correct dependencies in `install_requires`.
----
New commits:


---

Comment by mkoeppe created at 2022-09-25 00:57:47

The distribution packages declare runtime dependencies (setup.cfg install_requires) and also build-time dependencies (pyproject.toml). I think in the diagram I only show the (covers of) runtime dependencies.


---

Comment by klee created at 2022-09-25 01:37:28

Then perhaps the change of the commit `996461a` is not strictly necessary? (if it is practically no-op and does not create any overhead, then no problem).


---

Comment by mkoeppe created at 2022-09-25 01:40:34

No, you spotted it correctly in comment:62. `sagemath_environment` was missing, and 996461a corrected that. (Also `ipywidgets` was missing.)


---

Comment by klee created at 2022-09-25 01:46:33

New commits:


---

Comment by klee created at 2022-09-25 06:25:48

What is the logic of the changes in `lazy_import.pyx`? I have no idea...


---

Comment by klee created at 2022-09-25 07:00:12

Replying to [comment:68 Kwankyu Lee]:
> What is the logic of the changes in `lazy_import.pyx`? I have no idea...

It seems a provision to avoid `ImportError` in the situation when `sage.misc.lazy_import` is used when `sage.features` package is not present...

How about adding a comment to the code to explain the situation more concretely?


---

Comment by klee created at 2022-09-26 01:19:04

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-09-26 01:19:04

Thanks for the comment.

`9.7b6` below is `9.7` in other files, though I think it doesn't matter as explained in the comment.

```diff
+++ b/build/pkgs/sagemath_repl/install-requires.txt
@@ -0,0 +1,2 @@
+# This file is updated on every release by the sage-update-version script
+sagemath-repl ~= 9.7b6
```


I tested this ticket in several ways. It works well. It looks good to me.


----
New commits:


---

Comment by mkoeppe created at 2022-09-26 01:32:35

Thank you!


---

Comment by vbraun created at 2022-09-28 23:04:24

Resolution: fixed
