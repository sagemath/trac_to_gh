# Issue 25774: Copying package files is really slow

archive/issues_025774.json:
```json
{
    "body": "CC:  @embray\n\nFor some packages (especially databases containing just files), the \"Copying package files\" bit of the install process takes a very long time. For example, the `pari_galpol` package (see #26010) needs\n\n```\nreal    3m19.377s\nuser    2m22.153s\nsys     0m36.311s\n```\n\nto install. This is just a database package containing 14681 files to be installed. Ideally, this requires only I/O operations to install and the user CPU time should be close to 0.\n\nThe reason is probably that the code to keep track of the installed files is actually `O(n^2)` in the number of files.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26011\n\n",
    "created_at": "2018-08-06T11:36:35Z",
    "labels": [
        "component: build",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "Copying package files is really slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25774",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @embray

For some packages (especially databases containing just files), the "Copying package files" bit of the install process takes a very long time. For example, the `pari_galpol` package (see #26010) needs

```
real    3m19.377s
user    2m22.153s
sys     0m36.311s
```

to install. This is just a database package containing 14681 files to be installed. Ideally, this requires only I/O operations to install and the user CPU time should be close to 0.

The reason is probably that the code to keep track of the installed files is actually `O(n^2)` in the number of files.

Issue created by migration from https://trac.sagemath.org/ticket/26011





---

archive/issue_comments_363454.json:
```json
{
    "body": "I admit, I wasn't sure how well-optimized substitutions like `FOO=\"${FOO} ...\"` are in bash.  I assume that's the part you're saying is O(n<sup>2</sup>)?\n\nI think I was trying to avoid a second loop there and crossing my fingers that there would be some optimization for that case, but I didn't exactly do much performance testing.  It would probably be much better to use an array there, and then loop over it when writing the actual file list to the stamp file.  Better O(2n) then O(n<sup>2</sup>).\n\nThat said, I wonder how much effort it would be to just rewrite `sage-spkg` in Python...\nFor starters though I'll see how much improvement can be made with what we already have.",
    "created_at": "2018-08-06T14:11:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363454",
    "user": "https://github.com/embray"
}
```

I admit, I wasn't sure how well-optimized substitutions like `FOO="${FOO} ..."` are in bash.  I assume that's the part you're saying is O(n<sup>2</sup>)?

I think I was trying to avoid a second loop there and crossing my fingers that there would be some optimization for that case, but I didn't exactly do much performance testing.  It would probably be much better to use an array there, and then loop over it when writing the actual file list to the stamp file.  Better O(2n) then O(n<sup>2</sup>).

That said, I wonder how much effort it would be to just rewrite `sage-spkg` in Python...
For starters though I'll see how much improvement can be made with what we already have.



---

archive/issue_comments_363455.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2018-08-06T14:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363455",
    "user": "https://github.com/embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_363456.json:
```json
{
    "body": "Replying to [comment:2 embray]:\n> That said, I wonder how much effort it would be to just rewrite `sage-spkg` in Python...\n\nThat wouldn't be that hard, but it would be a boring job.\n\nMaybe start with factoring out just the copy-from-DESTDIR stuff? That way, one could fix #26011 and #26018 at the same time.",
    "created_at": "2018-08-07T10:22:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363456",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:2 embray]:
> That said, I wonder how much effort it would be to just rewrite `sage-spkg` in Python...

That wouldn't be that hard, but it would be a boring job.

Maybe start with factoring out just the copy-from-DESTDIR stuff? That way, one could fix #26011 and #26018 at the same time.



---

archive/issue_comments_363457.json:
```json
{
    "body": "For my own records, I tried this with just the existing `database_pari` package and got\n\n\n```\nreal    2m40.827s\nuser    0m46.358s\nsys     0m31.482s\n```\n\n\n(the majority of which, as you note, was spent in the \"Copying files\" phase).\n\nI'm going to see what I can do to improve this a little bit without having to rewrite too much (yet).",
    "created_at": "2018-08-10T11:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363457",
    "user": "https://github.com/embray"
}
```

For my own records, I tried this with just the existing `database_pari` package and got


```
real    2m40.827s
user    0m46.358s
sys     0m31.482s
```


(the majority of which, as you note, was spent in the "Copying files" phase).

I'm going to see what I can do to improve this a little bit without having to rewrite too much (yet).



---

archive/issue_comments_363458.json:
```json
{
    "body": "This brought the time for database_pari down to:\n\n\n```\nreal    0m32.636s\nuser    0m24.156s\nsys     0m3.019s\n```\n\n\n(still with the majority spent in copying).  It should also fix #26013 at the same time (conflicting with the branch currently there).\n\nI am concerned about the possibility of race conditions with `cp`, and the sed call is cryptic even for my liking but I still plan to replace more of this with Python.\n----\nNew commits:",
    "created_at": "2018-08-10T14:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363458",
    "user": "https://github.com/embray"
}
```

This brought the time for database_pari down to:


```
real    0m32.636s
user    0m24.156s
sys     0m3.019s
```


(still with the majority spent in copying).  It should also fix #26013 at the same time (conflicting with the branch currently there).

I am concerned about the possibility of race conditions with `cp`, and the sed call is cryptic even for my liking but I still plan to replace more of this with Python.
----
New commits:



---

archive/issue_comments_363459.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-10T14:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363459",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_363460.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-22T03:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363460",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_363461.json:
```json
{
    "body": "There are merge conflicts.",
    "created_at": "2018-08-22T03:41:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363461",
    "user": "https://github.com/saraedum"
}
```

There are merge conflicts.



---

archive/issue_comments_363462.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-23T10:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363462",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_363463.json:
```json
{
    "body": "I rebased this, but I'm having some other build issues on this branch, and I need to look into what's going on and if it's related to the change.",
    "created_at": "2018-08-23T10:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363463",
    "user": "https://github.com/embray"
}
```

I rebased this, but I'm having some other build issues on this branch, and I need to look into what's going on and if it's related to the change.



---

archive/issue_comments_363464.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-23T10:07:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_363465.json:
```json
{
    "body": "Using `cp` instead of `mv` is also a regression because moving should be a lot faster than copying. Why not use the `sed` script but keep moving as before?",
    "created_at": "2018-08-28T15:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363465",
    "user": "https://github.com/jdemeyer"
}
```

Using `cp` instead of `mv` is also a regression because moving should be a lot faster than copying. Why not use the `sed` script but keep moving as before?



---

archive/issue_comments_363466.json:
```json
{
    "body": "You're right of course, but the problem is that `mv` does not handle moving whole directory trees very well.  For example, if you try to `mv` a directory over a directory of the same name that already exists you'll just get an annoying \"Directory not empty\" error.\n\nIf you know a way to efficiently `mv` a directory tree on top of an existing one I'm all for it; off the top of my head I just don't know how to do that.  There is no `mv --recursive` (perhaps there should be).",
    "created_at": "2018-08-28T15:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363466",
    "user": "https://github.com/embray"
}
```

You're right of course, but the problem is that `mv` does not handle moving whole directory trees very well.  For example, if you try to `mv` a directory over a directory of the same name that already exists you'll just get an annoying "Directory not empty" error.

If you know a way to efficiently `mv` a directory tree on top of an existing one I'm all for it; off the top of my head I just don't know how to do that.  There is no `mv --recursive` (perhaps there should be).



---

archive/issue_comments_363467.json:
```json
{
    "body": "I mean, the code I originally had was essentially a hand-rolled recursive `mv`, but it was slow for one--in part just due to the use of some shell idioms.  Perhaps I could rewrite just that part in Python though then you have the overhead of starting up Python (perl would be better but I'm not sure we want to start introducing perl into the build process :) \n\nBut regardless how it's implemented it seems there are also some tricky pitfalls to it, like handling symlinks properly (though if that's the only issue then it's easy enough to handle it).",
    "created_at": "2018-08-28T16:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363467",
    "user": "https://github.com/embray"
}
```

I mean, the code I originally had was essentially a hand-rolled recursive `mv`, but it was slow for one--in part just due to the use of some shell idioms.  Perhaps I could rewrite just that part in Python though then you have the overhead of starting up Python (perl would be better but I'm not sure we want to start introducing perl into the build process :) 

But regardless how it's implemented it seems there are also some tricky pitfalls to it, like handling symlinks properly (though if that's the only issue then it's easy enough to handle it).



---

archive/issue_comments_363468.json:
```json
{
    "body": "I put a `time` in front of the `cp` call in the current version of this branch and it shows:\n\n\n```\n[database_pari-20161017] Moving package files from temporary location /home/embray/src/sagemath/sage/local/var/tmp/sage/build/database_pari-20161017/inst to /home/embray/src/sagemath/sage/local\n[database_pari-20161017]\n[database_pari-20161017] real   0m2.204s\n[database_pari-20161017] user   0m0.010s\n[database_pari-20161017] sys    0m0.619s\n```\n\n\nwhich seems fine.  But with the `for` loop calling `mv` for each file (and also creating directories and removing symlinks as necessary) I get:\n\n\n```\n[database_pari-20161017] Moving package files from temporary location /home/embray/src/sagemath/sage/local/var/tmp/sage/build/database_pari-20161017/inst to /home/embray/src/sagemath/sage/local\n[database_pari-20161017]\n[database_pari-20161017] real   0m17.014s\n[database_pari-20161017] user   0m1.847s\n[database_pari-20161017] sys    0m11.742s\n```\n\n\nOf course, if I wrote a dedicated program to do this it would probably be a lot faster.  If nothing else just running `mv` for every file probably adds enormous overhead when there are a lot of files; at least that's my guess.",
    "created_at": "2018-08-28T16:46:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363468",
    "user": "https://github.com/embray"
}
```

I put a `time` in front of the `cp` call in the current version of this branch and it shows:


```
[database_pari-20161017] Moving package files from temporary location /home/embray/src/sagemath/sage/local/var/tmp/sage/build/database_pari-20161017/inst to /home/embray/src/sagemath/sage/local
[database_pari-20161017]
[database_pari-20161017] real   0m2.204s
[database_pari-20161017] user   0m0.010s
[database_pari-20161017] sys    0m0.619s
```


which seems fine.  But with the `for` loop calling `mv` for each file (and also creating directories and removing symlinks as necessary) I get:


```
[database_pari-20161017] Moving package files from temporary location /home/embray/src/sagemath/sage/local/var/tmp/sage/build/database_pari-20161017/inst to /home/embray/src/sagemath/sage/local
[database_pari-20161017]
[database_pari-20161017] real   0m17.014s
[database_pari-20161017] user   0m1.847s
[database_pari-20161017] sys    0m11.742s
```


Of course, if I wrote a dedicated program to do this it would probably be a lot faster.  If nothing else just running `mv` for every file probably adds enormous overhead when there are a lot of files; at least that's my guess.



---

archive/issue_comments_363469.json:
```json
{
    "body": "I tried dropping this Python script into `sage-spkg` to do the moves:\n\n\n```\n    time cat <<_EOF_ | python - \"$PREFIX\" \"$SAGE_LOCAL\"\nimport os\nimport sys\n\nsrc, dst = sys.argv[1:]\n\nfor dirpath, dirnames, filenames in os.walk(src):\n    dst_path = os.path.join(dst, os.path.relpath(dirpath, src))\n    for dirname in dirnames:\n        dst_dirname = os.path.join(dst_path, dirname)\n        if not os.path.exists(dst_dirname):\n            os.makedirs(dst_dirname)\n\n    for filename in filenames:\n        src_filename = os.path.join(dirpath, filename)\n        dst_filename = os.path.join(dst_path, filename)\n\n        if os.path.islink(dst_filename):\n            os.remove(dst_filename)\n\n        os.rename(src_filename, dst_filename)\n_EOF_\n```\n\n\nand got\n\n\n```\n[database_pari-20161017] real   0m3.960s\n[database_pari-20161017] user   0m0.463s\n[database_pari-20161017] sys    0m0.312s\n```\n\n\nso still slower than the single `cp` call, but much faster than the shell loop.  \nI think in the case of database_pari a lot of the overhead is just in the large number of files (over 8000) than in overall size of the files.  Although in this case the total size of the files is still quite large (> 250 MB) most of the individual files are small, and moving has the same or nearly the same cost as copying.  Whereas, if we had a package with a single very large file moving would definitely be faster.\n\nOne almost certain advantage to using mv/rename is that it's supposed to be atomic, whereas cp is not.  This may have some implications for parallel builds but I'm not sure.",
    "created_at": "2018-08-29T10:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363469",
    "user": "https://github.com/embray"
}
```

I tried dropping this Python script into `sage-spkg` to do the moves:


```
    time cat <<_EOF_ | python - "$PREFIX" "$SAGE_LOCAL"
import os
import sys

src, dst = sys.argv[1:]

for dirpath, dirnames, filenames in os.walk(src):
    dst_path = os.path.join(dst, os.path.relpath(dirpath, src))
    for dirname in dirnames:
        dst_dirname = os.path.join(dst_path, dirname)
        if not os.path.exists(dst_dirname):
            os.makedirs(dst_dirname)

    for filename in filenames:
        src_filename = os.path.join(dirpath, filename)
        dst_filename = os.path.join(dst_path, filename)

        if os.path.islink(dst_filename):
            os.remove(dst_filename)

        os.rename(src_filename, dst_filename)
_EOF_
```


and got


```
[database_pari-20161017] real   0m3.960s
[database_pari-20161017] user   0m0.463s
[database_pari-20161017] sys    0m0.312s
```


so still slower than the single `cp` call, but much faster than the shell loop.  
I think in the case of database_pari a lot of the overhead is just in the large number of files (over 8000) than in overall size of the files.  Although in this case the total size of the files is still quite large (> 250 MB) most of the individual files are small, and moving has the same or nearly the same cost as copying.  Whereas, if we had a package with a single very large file moving would definitely be faster.

One almost certain advantage to using mv/rename is that it's supposed to be atomic, whereas cp is not.  This may have some implications for parallel builds but I'm not sure.



---

archive/issue_comments_363470.json:
```json
{
    "body": "Using `python -S` also speeds things up a bit, but not dramatically.",
    "created_at": "2018-08-29T10:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363470",
    "user": "https://github.com/embray"
}
```

Using `python -S` also speeds things up a bit, but not dramatically.



---

archive/issue_comments_363471.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-09-03T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363471",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_363472.json:
```json
{
    "body": "Jeroen, do you know off the top of your head a better solution for `mv`-ing an entire directory tree?\n\nOtherwise, I'm not sure there's a huge advantage to it over just using `cp -r`, except in the case of very large files.\n\nThere's also the possibility of using the above Python snippet, which seems to work well (but is more complicated obviously).\n\nI'm not convinced one way or the other what the best thing to do here is so I'm curious what solution you prefer.",
    "created_at": "2018-09-03T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363472",
    "user": "https://github.com/embray"
}
```

Jeroen, do you know off the top of your head a better solution for `mv`-ing an entire directory tree?

Otherwise, I'm not sure there's a huge advantage to it over just using `cp -r`, except in the case of very large files.

There's also the possibility of using the above Python snippet, which seems to work well (but is more complicated obviously).

I'm not convinced one way or the other what the best thing to do here is so I'm curious what solution you prefer.



---

archive/issue_comments_363473.json:
```json
{
    "body": "Changing priority from minor to blocker.",
    "created_at": "2018-09-12T16:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363473",
    "user": "https://github.com/embray"
}
```

Changing priority from minor to blocker.



---

archive/issue_comments_363474.json:
```json
{
    "body": "Changing the priority of this ticket since I am proposing it also as a solution to #26153.\n\nMinus some resolution on this ticket I can make a more targeted fix just to #26153, but it seems unnecessary.",
    "created_at": "2018-09-12T16:07:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363474",
    "user": "https://github.com/embray"
}
```

Changing the priority of this ticket since I am proposing it also as a solution to #26153.

Minus some resolution on this ticket I can make a more targeted fix just to #26153, but it seems unnecessary.



---

archive/issue_comments_363475.json:
```json
{
    "body": "it looks good.",
    "created_at": "2018-09-25T11:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363475",
    "user": "https://github.com/dimpase"
}
```

it looks good.



---

archive/issue_comments_363476.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-09-25T11:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363476",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_064995.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-09-27T17:41:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25774#event-64995"
}
```



---

archive/issue_comments_363477.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-09-27T17:41:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363477",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_363478.json:
```json
{
    "body": "The solution for problems with `cp` at #14166 and #14236 was to use `tar` instead.\n\nOther `cp` related tickets were #7464 and #16155.",
    "created_at": "2018-09-29T01:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363478",
    "user": "https://github.com/slel"
}
```

The solution for problems with `cp` at #14166 and #14236 was to use `tar` instead.

Other `cp` related tickets were #7464 and #16155.



---

archive/issue_comments_363479.json:
```json
{
    "body": "See #26642 for a blocker follow-up.",
    "created_at": "2018-11-05T13:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25774",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25774#issuecomment-363479",
    "user": "https://github.com/jdemeyer"
}
```

See #26642 for a blocker follow-up.
