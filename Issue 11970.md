# Issue 11970: Speed up Pari finite field operations

Issue created by migration from https://trac.sagemath.org/ticket/12142

Original creator: johanbosman

Original creation time: 2011-12-10 22:57:49

Assignee: AlexGhitza

CC:  mderickx jpflori

Let us perform a simple addition of finite field elements that are represented using Pari.

```
sage: F.<a> = GF(3^11)
sage: x = F.random_element()
sage: y = F.random_element()
sage: %timeit x + y
625 loops, best of 3: 13.2 µs per loop
```

Let us now measure how much time the *actual* addition takes:

```
sage: vx = x._FiniteField_ext_pariElement__value
sage: vy = y._FiniteField_ext_pariElement__value
sage: %timeit vx + vy
625 loops, best of 3: 4.6 µs per loop
```

This means two thirds of the execution time is used to wrap a ribbon around the result and only one third for the actual addition!

But in fact Pari has a faster implementation for finite fields than this!  This was already mentioned at http://groups.google.com/group/sage-nt/browse_thread/thread/e2dbbc72caeb589a

```
sage: def pari_ffelt(x): parix=pari(x); return parix.lift().subst(parix.variable(), "ffgen((%s).mod)"%parix) 

sage: px = pari_ffelt(x)
sage: py = pari_ffelt(y)
sage: %timeit px + py
625 loops, best of 3: 2.43 µs per loop
```

For multiplication, we have the following timings:

```
sage: %timeit x * y
625 loops, best of 3: 18.2 µs per loop
sage: %timeit vx * vy
625 loops, best of 3: 8.4 µs per loop
sage: %timeit px * py
625 loops, best of 3: 3.33 µs per loop
```



---

Comment by jpflori created at 2013-05-30 09:00:02

Just a reminder for myself, it would also be nice to have a common cython interface to deal with finite fields elements, surely using templates as for polynomials.


---

Comment by pbruin created at 2013-06-24 19:49:29

I have been working on an interface to PARI's implementation of finite fields (`t_FFELT`).  Like for the other interfaces (except the existing PARI polmod implementation), the field class is written in Python and the element class in Cython.  I hope to upload a patch soon after cleaning up the documentation and fixing a minor problem.

The speed improvement for addition and multiplication relative to the current implementation appears to vary roughly from a factor 3 to a factor 12, depending on the size of the field.

For small fields, this PARI interface is (of course) much slower than Givaro (a factor 4-6 for *F*_{3<sup>10</sup>}).  For fields of characteristic 2, it is slower than NTL+gf2x, but the difference is not that dramatic.


---

Comment by pbruin created at 2013-06-27 08:09:23

This ticket led to several other patches, which I put into separate tickets; see the list of dependencies.  The dependence on #14817 is optional.

A patch for this ticket is now practically ready.


---

Comment by pbruin created at 2013-06-27 11:56:50

The attached patch implements a new class `FiniteField_pari_ffelt` and associated element class `FiniteFieldElement_pari_ffelt`.  There is currently one doctest failure, related to conversion from and to Singular.


---

Attachment

OK, converting between `FiniteFieldElement` and Singular was an easy generalisation of existing code.  I will try to make a small table comparing the performance of the various implementations.  In the meantime this is ready to be reviewed.


---

Comment by pbruin created at 2013-06-27 19:19:55

Changing status from new to needs_review.


---

Comment by pbruin created at 2013-06-27 21:46:44

Here are some timings for addition and multiplication in the various implementations:

```
x, y random elements of a field of p^n elements
all times in microseconds

Addition:  %timeit -c -r 1 x + y

(p, n)     ntl/gf2e  givaro  pari_ffelt  pari_mod

(2, 15)    0.85      0.45    0.95        15.1
(2, 5000)  1.06      ----    1.84        3300

(3, 10)    ----      0.47    1.14        12.5
(3, 80)    ----      ----    1.75        44

(251, 2)   ----      0.51    1.30        9.0

Multiplication:  %timeit -c -r 1 x * y

(p, n)     ntl/gf2e  givaro  pari_ffelt  pari_mod

(2, 15)    1.11      0.61    1.51        22
(2, 1000)  5.0       ----    61          1060

(3, 10)    ----      0.57    4.0         19
(3, 80)    ----      ----    36          99

(251, 2)   ----      0.56    1.69        12.1

```



---

Comment by pbruin created at 2013-06-29 09:36:35

Initialisation of finite field elements is too slow, and computing _a_/_b_ raises a `ZeroDivisionError` if _a_ = 0...  A fix will be ready soon.


---

Comment by pbruin created at 2013-06-29 09:36:35

Changing status from needs_review to needs_work.


---

Comment by pbruin created at 2013-06-29 21:20:34

based on 5.11.beta3


---

Attachment


---

Comment by pbruin created at 2013-06-29 21:21:15

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2013-07-02 19:42:44

more speedups in element construction; initialisation from None allowed


---

Attachment


---

Attachment

Reviewer patch, trivial typo.


---

Comment by jpflori created at 2013-07-15 12:10:15

Patches look fine, doctests pass and there is indeed a very nice speedup.


---

Comment by jpflori created at 2013-07-15 12:10:15

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2013-07-16 11:56:40

For patchbot:

Apply trac_12142-FiniteField_pari_ffelt.improved.patch, trac_12142-singular_conversion.patch, trac_12142-reviewer.patch


---

Comment by pbruin created at 2013-07-17 07:39:51


```
Apply trac_12142-FiniteField_pari_ffelt.improved.patch, trac_12142-singular_conversion.patch, trac_12142-reviewer.patch 
```



---

Comment by pbruin created at 2013-07-17 14:10:57

add doctest


---

Attachment

The next patch removes the Cython constructor `__cinit__()`, which is unnecessary since it just sets an attribute to NULL which is already guaranteed to be NULL.  Actually, it just comments it out with an explanation for future reference.  This should fix the remaining doctest failure and may give another slight speed improvement.


---

Attachment


---

Comment by pbruin created at 2013-07-17 14:46:04

Changing status from positive_review to needs_work.


---

Comment by pbruin created at 2013-07-17 14:46:11

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2013-07-17 14:49:05

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2013-07-17 14:49:05

This change looks ok to me, and is very well documented.

I did not really pay attention to the doctests missing as you were copying from a large previous Sage file.
Maybe we could take this opportunity to fix it as well and so increase coverage.


---

Comment by jdemeyer created at 2013-07-21 21:33:02

Haven't read the code of #12142, but does pickling work properly and has it been doctested? If not, then #14888 should be set back to needs_work.


---

Comment by pbruin created at 2013-07-21 21:58:26

Yes, it works and there are doctests.  Finite field elements are not implemented as type `gen` (as in `libs/pari/gen.pyx`), so the fact that pickling does not work for a `gen` that happens to be a `t_FFELT` does not affect this ticket.


---

Comment by pbruin created at 2013-07-22 14:54:17

Replying to [comment:19 jpflori]:
> I did not really pay attention to the doctests missing as you were copying from a large previous Sage file.
> Maybe we could take this opportunity to fix it as well and so increase coverage.
Actually the doctest coverage of all files in `sage/rings/finite_rings` is 100%, except `integer_mod.pyx`, which has a coverage of only 99/150 functions.  Apart from that, I think I saw one or two colons that should be double colons.  I don't think it is really worth the trouble to spend time on that in this ticket.


---

Comment by jdemeyer created at 2013-08-20 12:55:32

Resolution: fixed
