# Issue 30097: MatrixSpace.submodule does not work

Issue created by migration from https://trac.sagemath.org/ticket/30334

Original creator: mkoeppe

Original creation time: 2020-08-11 14:00:28

CC:  dimpase tscrim @ivo-maffei

Currently `MatrixSpace` does not fully implement the category of modules with bases (see (`sage.categories.modules_with_basis`) that it claims to belong to.

```
sage: M = MatrixSpace(QQ, 3, 3)
sage: M in ModulesWithBasis(QQ)
True
sage: A = M([[0, 0, 1], [0, 0, 0], [0, 0, 0]])
sage: A
[0 0 1]
[0 0 0]
[0 0 0]
sage: M.submodule([A])
AttributeError: 'MatrixSpace_with_category' object has no attribute 'get_order'
```



---

Comment by @Ivo-Maffei created at 2020-08-11 15:33:00

I might be wrong, but the issue is not the missing `get_order` method as the method `_compute_support_order` assumes that `get_order` may not exists and simply decide an arbitrary order (it seems order is intended as ordering rather than the order of an element in a group). The only exception not handled is 

```
AttributeError: 'tuple' object has no attribute 'support'
}}} 
which is caused by `sage.categories.finite_dimensional_modules_with_basis.echelon_form` because it calls `_compute_support_order` with the wrong arguments.

I think
{{{#!diff
diff --git a/src/sage/categories/finite_dimensional_modules_with_basis.py b/src/sage/categories/finite_dimensional_modules_with_basis.py

--- a/src/sage/categories/finite_dimensional_modules_with_basis.py
+++ b/src/sage/categories/finite_dimensional_modules_with_basis.py
@@ -337,15 +337,30 @@ class FiniteDimensionalModulesWithBasis(CategoryWithAxiom_over_base_ring):
                 sage: C.echelon_form([x[0] - x[1], 2*x[1] - 2*x[2], x[0] - x[2]])
                 [x[0] - x[2], x[1] - x[2]]
             """
             if order is not None:
-                order = self._compute_support_order(order)
+                order = self._compute_support_order(elements, order)
+
+            # order may be an ordering of the support of elements
+            # hence not an ordering of the whole basis as needed below
+            # so we extend order to an ordering of the whole basis
+            orderList = list(order)
+            for k in self.basis().keys():
+                if k not in orderList:
+                    orderList.append(k)
+
+            full_order = tuple(orderList)
+
             from sage.matrix.constructor import matrix
-            mat = matrix(self.base_ring(), [g._vector_(order=order) for g in elements])
+            mat = matrix(self.base_ring(), [g._vector_(order=full_order) for g in elements])
             # Echelonizing a matrix over a field returned the rref
             if row_reduced and self.base_ring() not in Fields():
                 try:
                     mat = mat.rref().change_ring(self.base_ring())
                 except (ValueError, TypeError):
                     raise ValueError("unable to compute the row reduced echelon form")
             else:
                 mat.echelonize()
-            ret = [self.from_vector(vec, order=order) for vec in mat if vec]
+            ret = [self.from_vector(vec, order=full_order) for vec in mat if vec]
}}}
is a needed fix regardless of this ticket.

In addition if we add something silly like
{{{#!python
for m in ret:
    try:
        m.__hash__()
    except TypeError:
        m.set_immutable()
}}}
then the `submodule` method returns something (still wrong, though):
{{{#!sage
sage: MS = MatrixSpace(GF(2),2,2)
sage: A = MS([[1,0],[1,0]])                                                                                                                                                                                                                   
sage: MS.submodule([A])
Free module generated by {0} over Finite Field of size 2
sage: FM = _                                                                                                                                                                                                                                  
sage: FM.gens()                                                                                                                                                                                                                               
(B[0],)
sage: list(FM)
AttributeError: 'SubmoduleWithBasis_with_category' object has no attribute 'list'
}}}


---

Comment by mkoeppe created at 2020-08-11 15:40:48

Replying to [comment:1 gh-Ivo-Maffei]:
> it seems order is intended as ordering 

That's right


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-06-18 20:43:28

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-18 20:43:28

dup of #31995


---

Comment by tscrim created at 2021-06-18 22:20:57

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-06-24 20:15:37

Resolution: invalid
