# Issue 27230: weak order of permutations broken

archive/issues_027230.json:
```json
{
    "body": "CC:  sage-combinat @nthiery @fchapoton @darijgr jeremy.l.martin\n\nKeywords: Coxeter group\n\nFrom https://groups.google.com/forum/#!topic/sage-support/6kuvliWzi84:\n\n```\nsage: for w in Permutations(3):\n....:     w, w.weak_covers()\n....:\n([1, 2, 3], [])\n([1, 3, 2], [[1, 2, 3]])\n([2, 1, 3], [[1, 2, 3]])\n([2, 3, 1], [[3, 2, 1]])\n([3, 1, 2], [[3, 2, 1]])\n([3, 2, 1], [[3, 1, 2], [2, 3, 1]])\n\nThe fourth and fifth lines of the output are incorrect.  The correct values should be\n\n([2, 3, 1], [[2, 1, 3]])\n([3, 1, 2], [[1, 3, 2]])\n```\n\n\nThis manifests also in creating the weak order poset:\n\n```\nsage: Permutations(3).weak_poset()\n...\nValueError: Hasse diagram contains cycles\n```\n\n\nMost likely a left-vs-right issue. Possibly related to #23299.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27467\n\n",
    "created_at": "2019-03-11T23:43:03Z",
    "labels": [
        "component: combinatorics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "weak order of permutations broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27230",
    "user": "https://github.com/tscrim"
}
```
CC:  sage-combinat @nthiery @fchapoton @darijgr jeremy.l.martin

Keywords: Coxeter group

From https://groups.google.com/forum/#!topic/sage-support/6kuvliWzi84:

```
sage: for w in Permutations(3):
....:     w, w.weak_covers()
....:
([1, 2, 3], [])
([1, 3, 2], [[1, 2, 3]])
([2, 1, 3], [[1, 2, 3]])
([2, 3, 1], [[3, 2, 1]])
([3, 1, 2], [[3, 2, 1]])
([3, 2, 1], [[3, 1, 2], [2, 3, 1]])

The fourth and fifth lines of the output are incorrect.  The correct values should be

([2, 3, 1], [[2, 1, 3]])
([3, 1, 2], [[1, 3, 2]])
```


This manifests also in creating the weak order poset:

```
sage: Permutations(3).weak_poset()
...
ValueError: Hasse diagram contains cycles
```


Most likely a left-vs-right issue. Possibly related to #23299.

Issue created by migration from https://trac.sagemath.org/ticket/27467





---

archive/issue_comments_383228.json:
```json
{
    "body": "The problem is the multiplication for a permutation seems to have the oppose effect (by default):\n\n```\nsage: W = Permutations(3)\nsage: w = W([2,3,1])\nsage: w.reduced_word()\n[1, 2]\nsage: w.descents(side='right')\n[2]\nsage: w.apply_simple_reflection_right(2)\n[3, 2, 1]\n```\n\nSo we need to override `apply_simple_reflection_*` for `Permutation`.",
    "created_at": "2019-03-11T23:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383228",
    "user": "https://github.com/tscrim"
}
```

The problem is the multiplication for a permutation seems to have the oppose effect (by default):

```
sage: W = Permutations(3)
sage: w = W([2,3,1])
sage: w.reduced_word()
[1, 2]
sage: w.descents(side='right')
[2]
sage: w.apply_simple_reflection_right(2)
[3, 2, 1]
```

So we need to override `apply_simple_reflection_*` for `Permutation`.



---

archive/issue_comments_383229.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-12T00:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383229",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_383230.json:
```json
{
    "body": "So the only way forward that I could see to make this work is to gut out the multiplication option for `has_*_descent`. With this, I do not think anything for Coxeter combiantorics now uses the multiplication convention.\n----\nNew commits:",
    "created_at": "2019-03-12T00:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383230",
    "user": "https://github.com/tscrim"
}
```

So the only way forward that I could see to make this work is to gut out the multiplication option for `has_*_descent`. With this, I do not think anything for Coxeter combiantorics now uses the multiplication convention.
----
New commits:



---

archive/issue_comments_383231.json:
```json
{
    "body": "Moving all blocker/critical issues from 8.7 to 8.8.",
    "created_at": "2019-03-25T10:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383231",
    "user": "https://github.com/embray"
}
```

Moving all blocker/critical issues from 8.7 to 8.8.



---

archive/issue_comments_383232.json:
```json
{
    "body": "Can someone review this?",
    "created_at": "2019-05-24T22:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383232",
    "user": "https://github.com/tscrim"
}
```

Can someone review this?



---

archive/issue_comments_383233.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-24T23:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383233",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383234.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-05-24T23:16:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383234",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383235.json:
```json
{
    "body": "Green patchbot.",
    "created_at": "2019-05-25T23:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383235",
    "user": "https://github.com/tscrim"
}
```

Green patchbot.



---

archive/issue_comments_383236.json:
```json
{
    "body": "* deprecation should appear in doctests, no ?\n\n* \"switching the entries i and i+1\" (remove \"equal\" ?) in the doc of apply_simple_reflection_right\n\n* I am worried that this seems to be a source of incoherence.. But maybe the situation gets no worse than what it is right now ?",
    "created_at": "2019-05-26T05:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383236",
    "user": "https://github.com/fchapoton"
}
```

* deprecation should appear in doctests, no ?

* "switching the entries i and i+1" (remove "equal" ?) in the doc of apply_simple_reflection_right

* I am worried that this seems to be a source of incoherence.. But maybe the situation gets no worse than what it is right now ?



---

archive/issue_comments_383237.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-05T00:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383237",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383238.json:
```json
{
    "body": "Replying to [comment:10 chapoton]:\n> * deprecation should appear in doctests, no ?\n\nAdded.\n\n> * \"switching the entries i and i+1\" (remove \"equal\" ?) in the doc of apply_simple_reflection_right\n\nFixed.\n\n> * I am worried that this seems to be a source of incoherence.. But maybe the situation gets no worse than what it is right now ?\n\nIt is at least no worse than what it is currently, but I think this makes it more consistent overall. Plus it fixes a definite bug.",
    "created_at": "2019-06-05T00:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383238",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:10 chapoton]:
> * deprecation should appear in doctests, no ?

Added.

> * "switching the entries i and i+1" (remove "equal" ?) in the doc of apply_simple_reflection_right

Fixed.

> * I am worried that this seems to be a source of incoherence.. But maybe the situation gets no worse than what it is right now ?

It is at least no worse than what it is currently, but I think this makes it more consistent overall. Plus it fixes a definite bug.



---

archive/issue_comments_383239.json:
```json
{
    "body": "ok, then.\n\nOne should suggest somewhere loudly to use `SymmetricGroup(n)` instead of `Permutations(n)` when doing Coxeter-related work.",
    "created_at": "2019-06-05T08:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383239",
    "user": "https://github.com/fchapoton"
}
```

ok, then.

One should suggest somewhere loudly to use `SymmetricGroup(n)` instead of `Permutations(n)` when doing Coxeter-related work.



---

archive/issue_comments_383240.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-05T08:43:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383240",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_383241.json:
```json
{
    "body": "Replying to [comment:13 chapoton]:\n> ok, then.\n\nThank you.\n\n> One should suggest somewhere loudly to use `SymmetricGroup(n)` instead of `Permutations(n)` when doing Coxeter-related work.\n\nAlso referencing `CoxeterGroup` or `WeylGroup` as well. Another ticket.\n\nI am adding Darij as a reviewer since he gave me some comments on the ticket.",
    "created_at": "2019-06-05T09:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383241",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:13 chapoton]:
> ok, then.

Thank you.

> One should suggest somewhere loudly to use `SymmetricGroup(n)` instead of `Permutations(n)` when doing Coxeter-related work.

Also referencing `CoxeterGroup` or `WeylGroup` as well. Another ticket.

I am adding Darij as a reviewer since he gave me some comments on the ticket.



---

archive/issue_comments_383242.json:
```json
{
    "body": "Possibly due to #27899, I'm getting \n\n```\nsage -t --warn-long 57.2 src/sage/combinat/dyck_word.py\n**********************************************************************\nFile \"src/sage/combinat/dyck_word.py\", line 1997, in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation\nFailed example:\n    p = DyckWord([1,1,0,1,0,0,1,1,0,1,0,1,0,0]).to_312_avoiding_permutation(); p\nExpected:\n    [2, 3, 1, 5, 6, 7, 4]\nGot:\n    [3, 1, 2, 7, 4, 5, 6]\n**********************************************************************\nFile \"src/sage/combinat/dyck_word.py\", line 2007, in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation\nFailed example:\n    all(pi.avoids([3,1,2]) for pi in PD)\nExpected:\n    True\nGot:\n    False\n**********************************************************************\nFile \"src/sage/combinat/dyck_word.py\", line 2197, in sage.combinat.dyck_word.DyckWord_complete.to_permutation\nFailed example:\n    D.to_permutation(map=\"Bandlow-Killpatrick\")\nExpected:\n    [3, 4, 2, 1]\nGot:\n    [4, 3, 1, 2]\n**********************************************************************\n2 items had failures:\n   2 of   9 in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation\n   1 of   7 in sage.combinat.dyck_word.DyckWord_complete.to_permutation\n    [581 tests, 3 failures, 1.27 s]\n----------------------------------------------------------------------\nsage -t --warn-long 57.2 src/sage/combinat/dyck_word.py  # 3 doctests failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2019-06-05T22:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383242",
    "user": "https://github.com/vbraun"
}
```

Possibly due to #27899, I'm getting 

```
sage -t --warn-long 57.2 src/sage/combinat/dyck_word.py
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 1997, in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation
Failed example:
    p = DyckWord([1,1,0,1,0,0,1,1,0,1,0,1,0,0]).to_312_avoiding_permutation(); p
Expected:
    [2, 3, 1, 5, 6, 7, 4]
Got:
    [3, 1, 2, 7, 4, 5, 6]
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 2007, in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation
Failed example:
    all(pi.avoids([3,1,2]) for pi in PD)
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 2197, in sage.combinat.dyck_word.DyckWord_complete.to_permutation
Failed example:
    D.to_permutation(map="Bandlow-Killpatrick")
Expected:
    [3, 4, 2, 1]
Got:
    [4, 3, 1, 2]
**********************************************************************
2 items had failures:
   2 of   9 in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation
   1 of   7 in sage.combinat.dyck_word.DyckWord_complete.to_permutation
    [581 tests, 3 failures, 1.27 s]
----------------------------------------------------------------------
sage -t --warn-long 57.2 src/sage/combinat/dyck_word.py  # 3 doctests failed
----------------------------------------------------------------------
```




---

archive/issue_comments_383243.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-06-05T22:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383243",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_383244.json:
```json
{
    "body": "Yes, probably correlated to this replacement in #27899 :\n\n```diff\n         n = self.semilength()\n         area = self.to_area_sequence()\n-        from sage.groups.perm_gps.permgroup_named import SymmetricGroup\n-        pi = SymmetricGroup(n).one()\n+        pi = Permutations(n).one()\n         for j in range(n):\n             for i in range(area[j]):\n-                pi = pi.apply_simple_reflection(j-i)\n-        return Permutation(~pi)\n+                pi = pi.apply_simple_reflection(j - i)\n+        return ~pi\n```\n",
    "created_at": "2019-06-06T05:58:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383244",
    "user": "https://github.com/fchapoton"
}
```

Yes, probably correlated to this replacement in #27899 :

```diff
         n = self.semilength()
         area = self.to_area_sequence()
-        from sage.groups.perm_gps.permgroup_named import SymmetricGroup
-        pi = SymmetricGroup(n).one()
+        pi = Permutations(n).one()
         for j in range(n):
             for i in range(area[j]):
-                pi = pi.apply_simple_reflection(j-i)
-        return Permutation(~pi)
+                pi = pi.apply_simple_reflection(j - i)
+        return ~pi
```




---

archive/issue_comments_383245.json:
```json
{
    "body": "I concur, and it should just be a matter of swapping the left/right convention (which I guess should just mean returning `pi` instead of `~pi`). I can do this tomorrow.",
    "created_at": "2019-06-06T07:20:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383245",
    "user": "https://github.com/tscrim"
}
```

I concur, and it should just be a matter of swapping the left/right convention (which I guess should just mean returning `pi` instead of `~pi`). I can do this tomorrow.



---

archive/issue_comments_383246.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-10T23:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383246",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383247.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-10T23:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383247",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_383248.json:
```json
{
    "body": "Sorry, I got sidetracked from this and forgot to do this last week. This is now fixed (although unfortunately we might have missed the next release cutoff...). Volker, it would be really nice if this could slip in to 8.8 since this is a relatively big bug in the combinatorics code.",
    "created_at": "2019-06-10T23:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383248",
    "user": "https://github.com/tscrim"
}
```

Sorry, I got sidetracked from this and forgot to do this last week. This is now fixed (although unfortunately we might have missed the next release cutoff...). Volker, it would be really nice if this could slip in to 8.8 since this is a relatively big bug in the combinatorics code.



---

archive/issue_comments_383249.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-06-10T23:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383249",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_383250.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-11T07:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383250",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_383251.json:
```json
{
    "body": "set to positive again",
    "created_at": "2019-06-11T07:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383251",
    "user": "https://github.com/fchapoton"
}
```

set to positive again



---

archive/issue_comments_383252.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2019-06-11T08:59:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383252",
    "user": "https://github.com/vbraun"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_383253.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-12T21:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27230#issuecomment-383253",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_025274.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-12T21:41:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27230",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27230#event-25274"
}
```
