# Issue 27230: weak order of permutations broken

Issue created by migration from https://trac.sagemath.org/ticket/27467

Original creator: tscrim

Original creation time: 2019-03-11 23:43:03

CC:  sage-combinat nthiery chapoton darij jeremy.l.martin

Keywords: Coxeter group

From https://groups.google.com/forum/#!topic/sage-support/6kuvliWzi84:

```
sage: for w in Permutations(3):
....:     w, w.weak_covers()
....:
([1, 2, 3], [])
([1, 3, 2], [[1, 2, 3]])
([2, 1, 3], [[1, 2, 3]])
([2, 3, 1], [[3, 2, 1]])
([3, 1, 2], [[3, 2, 1]])
([3, 2, 1], [[3, 1, 2], [2, 3, 1]])

The fourth and fifth lines of the output are incorrect.  The correct values should be

([2, 3, 1], [[2, 1, 3]])
([3, 1, 2], [[1, 3, 2]])
```


This manifests also in creating the weak order poset:

```
sage: Permutations(3).weak_poset()
...
ValueError: Hasse diagram contains cycles
```


Most likely a left-vs-right issue. Possibly related to #23299.


---

Comment by tscrim created at 2019-03-11 23:52:34

The problem is the multiplication for a permutation seems to have the oppose effect (by default):

```
sage: W = Permutations(3)
sage: w = W([2,3,1])
sage: w.reduced_word()
[1, 2]
sage: w.descents(side='right')
[2]
sage: w.apply_simple_reflection_right(2)
[3, 2, 1]
```

So we need to override `apply_simple_reflection_*` for `Permutation`.


---

Comment by tscrim created at 2019-03-12 00:21:41

Changing status from new to needs_review.


---

Comment by tscrim created at 2019-03-12 00:21:41

So the only way forward that I could see to make this work is to gut out the multiplication option for `has_*_descent`. With this, I do not think anything for Coxeter combiantorics now uses the multiplication convention.
----
New commits:


---

Comment by embray created at 2019-03-25 10:41:19

Moving all blocker/critical issues from 8.7 to 8.8.


---

Comment by tscrim created at 2019-05-24 22:55:51

Can someone review this?


---

Comment by git created at 2019-05-24 23:11:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-05-24 23:16:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-05-25 23:21:27

Green patchbot.


---

Comment by chapoton created at 2019-05-26 05:57:32

* deprecation should appear in doctests, no ?

* "switching the entries i and i+1" (remove "equal" ?) in the doc of apply_simple_reflection_right

* I am worried that this seems to be a source of incoherence.. But maybe the situation gets no worse than what it is right now ?


---

Comment by git created at 2019-06-05 00:36:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-06-05 00:37:36

Replying to [comment:10 chapoton]:
> * deprecation should appear in doctests, no ?

Added.

> * "switching the entries i and i+1" (remove "equal" ?) in the doc of apply_simple_reflection_right

Fixed.

> * I am worried that this seems to be a source of incoherence.. But maybe the situation gets no worse than what it is right now ?

It is at least no worse than what it is currently, but I think this makes it more consistent overall. Plus it fixes a definite bug.


---

Comment by chapoton created at 2019-06-05 08:43:01

ok, then.

One should suggest somewhere loudly to use `SymmetricGroup(n)` instead of `Permutations(n)` when doing Coxeter-related work.


---

Comment by chapoton created at 2019-06-05 08:43:01

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-06-05 09:04:43

Replying to [comment:13 chapoton]:
> ok, then.

Thank you.

> One should suggest somewhere loudly to use `SymmetricGroup(n)` instead of `Permutations(n)` when doing Coxeter-related work.

Also referencing `CoxeterGroup` or `WeylGroup` as well. Another ticket.

I am adding Darij as a reviewer since he gave me some comments on the ticket.


---

Comment by vbraun created at 2019-06-05 22:25:58

Possibly due to #27899, I'm getting 

```
sage -t --warn-long 57.2 src/sage/combinat/dyck_word.py
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 1997, in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation
Failed example:
    p = DyckWord([1,1,0,1,0,0,1,1,0,1,0,1,0,0]).to_312_avoiding_permutation(); p
Expected:
    [2, 3, 1, 5, 6, 7, 4]
Got:
    [3, 1, 2, 7, 4, 5, 6]
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 2007, in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation
Failed example:
    all(pi.avoids([3,1,2]) for pi in PD)
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/combinat/dyck_word.py", line 2197, in sage.combinat.dyck_word.DyckWord_complete.to_permutation
Failed example:
    D.to_permutation(map="Bandlow-Killpatrick")
Expected:
    [3, 4, 2, 1]
Got:
    [4, 3, 1, 2]
**********************************************************************
2 items had failures:
   2 of   9 in sage.combinat.dyck_word.DyckWord_complete.to_312_avoiding_permutation
   1 of   7 in sage.combinat.dyck_word.DyckWord_complete.to_permutation
    [581 tests, 3 failures, 1.27 s]
----------------------------------------------------------------------
sage -t --warn-long 57.2 src/sage/combinat/dyck_word.py  # 3 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2019-06-05 22:25:58

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2019-06-06 05:58:25

Yes, probably correlated to this replacement in #27899 :

```diff
         n = self.semilength()
         area = self.to_area_sequence()
-        from sage.groups.perm_gps.permgroup_named import SymmetricGroup
-        pi = SymmetricGroup(n).one()
+        pi = Permutations(n).one()
         for j in range(n):
             for i in range(area[j]):
-                pi = pi.apply_simple_reflection(j-i)
-        return Permutation(~pi)
+                pi = pi.apply_simple_reflection(j - i)
+        return ~pi
```



---

Comment by tscrim created at 2019-06-06 07:20:34

I concur, and it should just be a matter of swapping the left/right convention (which I guess should just mean returning `pi` instead of `~pi`). I can do this tomorrow.


---

Comment by git created at 2019-06-10 23:46:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-06-10 23:47:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-06-10 23:48:51

Sorry, I got sidetracked from this and forgot to do this last week. This is now fixed (although unfortunately we might have missed the next release cutoff...). Volker, it would be really nice if this could slip in to 8.8 since this is a relatively big bug in the combinatorics code.


---

Comment by tscrim created at 2019-06-10 23:48:51

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-06-11 07:23:38

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-06-11 07:23:38

set to positive again


---

Comment by vbraun created at 2019-06-11 08:59:14

Changing priority from critical to blocker.


---

Comment by vbraun created at 2019-06-12 21:41:43

Resolution: fixed
