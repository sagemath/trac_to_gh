# Issue 26718: bug in polynomial real root

archive/issues_026718.json:
```json
{
    "body": "CC:  cwitty @mezzarobba @orlitzky\n\n\n```\nl = [1, -1, 0, 1, 0, 1, -14, 6, 1, 12, 0,\n     2, -4, 0, -1, 0, 0, -1188, -12, 1, 1,\n     -6, -1, -1, 18, 0, -1, 15, 0, 1, 1, -1,\n     1, 1, 2, -1, -8, -2, -2, 2, 1, -1, 4, 0,\n     -2, -2, 122, 0, 0, 1, -1, -1, 2, 0, 0, -1,\n    -2, 1]\np = ZZ['x'](l)\np.roots(AA)\n```\n\nleads to\n\n```\nAssertionError                            Traceback (most recent call last)\n<ipython-input-11-31650a84a6a3> in <module>()\n      6     -Integer(2), Integer(1)]\n      7 p = ZZ['x'](l)\n----> 8 p.roots(AA)\n\n/usr/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:62263)()\n   7748 \n   7749                 if is_AlgebraicRealField(L):\n-> 7750                     rts = real_roots(self, retval='algebraic_real')\n   7751                 else:\n   7752                     diam = ~(ZZ(1) << L.prec())\n\n/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.real_roots (build/cythonized/sage/rings/polynomial/real_roots.c:44168)()\n   4053 \n   4054             oc = ocean(ctx, bernstein_polynomial_factory_ratlist(b), linear_map(left, right))\n-> 4055             oc.find_roots()\n   4056             oceans.append((oc, factor, exp))\n   4057 \n\n/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.ocean.find_roots (build/cythonized/sage/rings/polynomial/real_roots.c:33063)()\n   3070         while not self.all_done():\n   3071             self.refine_all()\n-> 3072             self.increase_precision()\n   3073 \n   3074     def roots(self):\n\n/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.ocean.increase_precision (build/cythonized/sage/rings/polynomial/real_roots.c:34225)()\n   3205                 targets += [(isle.lgap, isle.rgap, isle.bp.scale_log2)]\n   3206                 self.ctx.dc_log_append(('splitting', (isle.lgap.lower, isle.lgap.upper), (isle.rgap.lower, isle.rgap.upper), isle.bp.scale_log2))\n-> 3207             bps = split_for_targets(self.ctx, p, targets)\n   3208             for i in range(len(active_islands)):\n   3209                 bp = bps[i]\n\n/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.split_for_targets (build/cythonized/sage/rings/polynomial/real_roots.c:31094)()\n   2880     split = wordsize_rational(split_targets[best_index][0], split_targets[best_index][1], ctx.wordsize)\n   2881 \n-> 2882     (p1_, p2_, ok) = bp.de_casteljau(ctx, split, msign=split_targets[best_index][2])\n   2883     assert(ok)\n   2884 \n\n/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.interval_bernstein_polynomial_integer.de_casteljau (build/cythonized/sage/rings/polynomial/real_roots.c:9195)()\n    728             msign = sign\n    729         elif sign != 0:\n--> 730             assert(msign == sign)\n    731 \n    732         cdef Rational absolute_mid = self.lower + mid * (self.upper - self.lower)\n\nAssertionError: \n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26955\n\n",
    "created_at": "2018-12-25T16:33:41Z",
    "labels": [
        "component: algebra",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "bug in polynomial real root",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26718",
    "user": "https://github.com/videlec"
}
```
CC:  cwitty @mezzarobba @orlitzky


```
l = [1, -1, 0, 1, 0, 1, -14, 6, 1, 12, 0,
     2, -4, 0, -1, 0, 0, -1188, -12, 1, 1,
     -6, -1, -1, 18, 0, -1, 15, 0, 1, 1, -1,
     1, 1, 2, -1, -8, -2, -2, 2, 1, -1, 4, 0,
     -2, -2, 122, 0, 0, 1, -1, -1, 2, 0, 0, -1,
    -2, 1]
p = ZZ['x'](l)
p.roots(AA)
```

leads to

```
AssertionError                            Traceback (most recent call last)
<ipython-input-11-31650a84a6a3> in <module>()
      6     -Integer(2), Integer(1)]
      7 p = ZZ['x'](l)
----> 8 p.roots(AA)

/usr/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:62263)()
   7748 
   7749                 if is_AlgebraicRealField(L):
-> 7750                     rts = real_roots(self, retval='algebraic_real')
   7751                 else:
   7752                     diam = ~(ZZ(1) << L.prec())

/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.real_roots (build/cythonized/sage/rings/polynomial/real_roots.c:44168)()
   4053 
   4054             oc = ocean(ctx, bernstein_polynomial_factory_ratlist(b), linear_map(left, right))
-> 4055             oc.find_roots()
   4056             oceans.append((oc, factor, exp))
   4057 

/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.ocean.find_roots (build/cythonized/sage/rings/polynomial/real_roots.c:33063)()
   3070         while not self.all_done():
   3071             self.refine_all()
-> 3072             self.increase_precision()
   3073 
   3074     def roots(self):

/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.ocean.increase_precision (build/cythonized/sage/rings/polynomial/real_roots.c:34225)()
   3205                 targets += [(isle.lgap, isle.rgap, isle.bp.scale_log2)]
   3206                 self.ctx.dc_log_append(('splitting', (isle.lgap.lower, isle.lgap.upper), (isle.rgap.lower, isle.rgap.upper), isle.bp.scale_log2))
-> 3207             bps = split_for_targets(self.ctx, p, targets)
   3208             for i in range(len(active_islands)):
   3209                 bp = bps[i]

/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.split_for_targets (build/cythonized/sage/rings/polynomial/real_roots.c:31094)()
   2880     split = wordsize_rational(split_targets[best_index][0], split_targets[best_index][1], ctx.wordsize)
   2881 
-> 2882     (p1_, p2_, ok) = bp.de_casteljau(ctx, split, msign=split_targets[best_index][2])
   2883     assert(ok)
   2884 

/usr/lib/python2.7/site-packages/sage/rings/polynomial/real_roots.pyx in sage.rings.polynomial.real_roots.interval_bernstein_polynomial_integer.de_casteljau (build/cythonized/sage/rings/polynomial/real_roots.c:9195)()
    728             msign = sign
    729         elif sign != 0:
--> 730             assert(msign == sign)
    731 
    732         cdef Rational absolute_mid = self.lower + mid * (self.upper - self.lower)

AssertionError: 
```


Issue created by migration from https://trac.sagemath.org/ticket/26955





---

archive/issue_comments_375376.json:
```json
{
    "body": "Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.",
    "created_at": "2019-01-15T18:15:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375376",
    "user": "https://github.com/embray"
}
```

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.



---

archive/issue_comments_375377.json:
```json
{
    "body": "Moving all blocker/critical issues from 8.7 to 8.8.",
    "created_at": "2019-03-25T10:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375377",
    "user": "https://github.com/embray"
}
```

Moving all blocker/critical issues from 8.7 to 8.8.



---

archive/issue_comments_375378.json:
```json
{
    "body": "Moving open critical and blocker issues to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:39:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375378",
    "user": "https://github.com/embray"
}
```

Moving open critical and blocker issues to the next release milestone (optimistically).



---

archive/issue_comments_375379.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375379",
    "user": "https://github.com/embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_375380.json:
```json
{
    "body": "test for the bugs in #26955 and #26957",
    "created_at": "2020-03-13T05:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375380",
    "user": "https://github.com/DaveWitteMorris"
}
```

test for the bugs in #26955 and #26957



---

archive/issue_comments_375381.json:
```json
{
    "body": "Attachment [26955test.pyx](tarball://root/attachments/some-uuid/ticket26955/26955test.pyx) by @DaveWitteMorris created at 2020-03-13 05:44:03\n\nIn case it is useful information: The bugs in this ticket and #26957 seem to be gone in 9.0(Py3) (tested on `CoCalc`) and 9.1b6(Py3) (tested on my computer - Mac 10.15.1). However, the bug reappears when I doctest with `./sage -t`. (I discovered this after I wrote a doctest to show that the bugs are gone, and was very surprised to see the errors again when I ran the doctest. At first, I thought I must have been running 8.9 by mistake.)\n\nIf I run `./sage 26955text.pyx` on the attached file, I get good output. However, if I run `./sage -t 26955text.pyx`, then I get the errors. Thus, it appears to me (a very naive observer) that some change made by the `-t` option is a part of the problem. I hope this information will be useful to an expert, even though it doesn't mean anything to me.",
    "created_at": "2020-03-13T05:44:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375381",
    "user": "https://github.com/DaveWitteMorris"
}
```

Attachment [26955test.pyx](tarball://root/attachments/some-uuid/ticket26955/26955test.pyx) by @DaveWitteMorris created at 2020-03-13 05:44:03

In case it is useful information: The bugs in this ticket and #26957 seem to be gone in 9.0(Py3) (tested on `CoCalc`) and 9.1b6(Py3) (tested on my computer - Mac 10.15.1). However, the bug reappears when I doctest with `./sage -t`. (I discovered this after I wrote a doctest to show that the bugs are gone, and was very surprised to see the errors again when I ran the doctest. At first, I thought I must have been running 8.9 by mistake.)

If I run `./sage 26955text.pyx` on the attached file, I get good output. However, if I run `./sage -t 26955text.pyx`, then I get the errors. Thus, it appears to me (a very naive observer) that some change made by the `-t` option is a part of the problem. I hope this information will be useful to an expert, even though it doesn't mean anything to me.



---

archive/issue_comments_375382.json:
```json
{
    "body": "Replying to [comment:9 gh-DaveWitteMorris]:\n> In case it is useful information: The bugs in this ticket and #26957 seem to be gone in 9.0(Py3) (tested on `CoCalc`) and 9.1b6(Py3) (tested on my computer - Mac 10.15.1). However, the bug reappears when I doctest with `./sage -t`. (I discovered this after I wrote a doctest to show that the bugs are gone, and was very surprised to see the errors again when I ran the doctest. At first, I thought I must have been running 8.9 by mistake.)\n> \n> If I run `./sage 26955text.pyx` on the attached file, I get good output. However, if I run `./sage -t 26955text.pyx`, then I get the errors. Thus, it appears to me (a very naive observer) that some change made by the `-t` option is a part of the problem. I hope this information will be useful to an expert, even though it doesn't mean anything to me.\n\nThanks for testing this. I don't understand how `./sage -t 26955text.pyx` could trigger an error since the file does not contain any doctest.",
    "created_at": "2020-03-13T09:36:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375382",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:9 gh-DaveWitteMorris]:
> In case it is useful information: The bugs in this ticket and #26957 seem to be gone in 9.0(Py3) (tested on `CoCalc`) and 9.1b6(Py3) (tested on my computer - Mac 10.15.1). However, the bug reappears when I doctest with `./sage -t`. (I discovered this after I wrote a doctest to show that the bugs are gone, and was very surprised to see the errors again when I ran the doctest. At first, I thought I must have been running 8.9 by mistake.)
> 
> If I run `./sage 26955text.pyx` on the attached file, I get good output. However, if I run `./sage -t 26955text.pyx`, then I get the errors. Thus, it appears to me (a very naive observer) that some change made by the `-t` option is a part of the problem. I hope this information will be useful to an expert, even though it doesn't mean anything to me.

Thanks for testing this. I don't understand how `./sage -t 26955text.pyx` could trigger an error since the file does not contain any doctest.



---

archive/issue_comments_375383.json:
```json
{
    "body": "It seems that `./sage -t <filename>` executes all of the code in the file, not just the doctests. For example, if I put `print(\"*** hello ***\")` in a file, then the result of running `./sage -t` on that file is\n\n```\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2020-03-13-13-46-22-4cbd34d1.\nGit branch: develop\nUsing --optional=build,ccache,dochtml,fricas,sage\nDoctesting 1 file.\n*** hello ***\nsage -t /Users/dmorris/tmp/hello.py\n    [0 tests, 0.00 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.0 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\n```\n",
    "created_at": "2020-03-13T19:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375383",
    "user": "https://github.com/DaveWitteMorris"
}
```

It seems that `./sage -t <filename>` executes all of the code in the file, not just the doctests. For example, if I put `print("*** hello ***")` in a file, then the result of running `./sage -t` on that file is

```
too many failed tests, not using stored timings
Running doctests with ID 2020-03-13-13-46-22-4cbd34d1.
Git branch: develop
Using --optional=build,ccache,dochtml,fricas,sage
Doctesting 1 file.
*** hello ***
sage -t /Users/dmorris/tmp/hello.py
    [0 tests, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
```




---

archive/issue_comments_375384.json:
```json
{
    "body": "Replying to [comment:11 gh-DaveWitteMorris]:\n> It seems that `./sage -t <filename>` executes all of the code in the file, not just the doctests. For example, if I put `print(\"*** hello ***\")` in a file, then the result of running `./sage -t` on that file is\n> {{{\n> too many failed tests, not using stored timings\n> Running doctests with ID 2020-03-13-13-46-22-4cbd34d1.\n> Git branch: develop\n> Using --optional=build,ccache,dochtml,fricas,sage\n> Doctesting 1 file.\n> *** hello ***\n> sage -t /Users/dmorris/tmp/hello.py\n>     [0 tests, 0.00 s]\n> ----------------------------------------------------------------------\n> All tests passed!\n> ----------------------------------------------------------------------\n> Total time for all tests: 0.0 seconds\n>     cpu time: 0.0 seconds\n>     cumulative wall time: 0.0 seconds\n> }}}\n\nTrue, the code is executed (as the doctests could depend on it). There is an argument `--force-lib` to `sage -t` to avoid that automatic execution.",
    "created_at": "2020-03-13T20:03:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375384",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:11 gh-DaveWitteMorris]:
> It seems that `./sage -t <filename>` executes all of the code in the file, not just the doctests. For example, if I put `print("*** hello ***")` in a file, then the result of running `./sage -t` on that file is
> {{{
> too many failed tests, not using stored timings
> Running doctests with ID 2020-03-13-13-46-22-4cbd34d1.
> Git branch: develop
> Using --optional=build,ccache,dochtml,fricas,sage
> Doctesting 1 file.
> *** hello ***
> sage -t /Users/dmorris/tmp/hello.py
>     [0 tests, 0.00 s]
> ----------------------------------------------------------------------
> All tests passed!
> ----------------------------------------------------------------------
> Total time for all tests: 0.0 seconds
>     cpu time: 0.0 seconds
>     cumulative wall time: 0.0 seconds
> }}}

True, the code is executed (as the doctests could depend on it). There is an argument `--force-lib` to `sage -t` to avoid that automatic execution.



---

archive/issue_comments_375385.json:
```json
{
    "body": "This is essentially a duplicate of #20390, although I think the failing test case here is a bit nicer. You can also turn this example into a recursion error (see #26957, too) by increasing the precision as I've remarked on #20390.",
    "created_at": "2020-08-31T01:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375385",
    "user": "https://github.com/orlitzky"
}
```

This is essentially a duplicate of #20390, although I think the failing test case here is a bit nicer. You can also turn this example into a recursion error (see #26957, too) by increasing the precision as I've remarked on #20390.



---

archive/issue_comments_375386.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-08-31T01:21:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375386",
    "user": "https://github.com/orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_375387.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-05T11:40:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375387",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_375388.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2020-09-15T15:51:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26718",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26718#issuecomment-375388",
    "user": "https://github.com/fchapoton"
}
```

Resolution: duplicate
