# Issue 28630: 1 imagemagick failing doctest in misc/latex.py

Issue created by migration from https://trac.sagemath.org/ticket/28867

Original creator: slabbe

Original creation time: 2019-12-10 08:40:39

CC:  chapoton


```
sage -t --optional=sage,imagemagick src/sage/misc/latex.py
```


gives


```
Using --optional=imagemagick,memlimit,sage
Doctesting 1 file.
sage -t src/sage/misc/latex.py
**********************************************************************
File "src/sage/misc/latex.py", line 1086, in sage.misc.latex.Latex.?
Failed example:
    latex.eval("\ThisIsAnInvalidCommand", {}) # optional -- ImageMagick
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.latex.Latex.?[1]>", line 1, in <module>
        latex.eval("\ThisIsAnInvalidCommand", {}) # optional -- ImageMagick
      File "/home/slabbe/GitBox/sage/local/lib/python3.7/site-packages/sage/misc/latex.py", line 1115, in eval
        O.write(str_to_bytes(x, encoding='utf-8'))
    TypeError: write() argument must be str, not bytes
**********************************************************************
1 item had failures:
   1 of   3 in sage.misc.latex.Latex.?
    [303 tests, 1 failure, 0.93 s]
----------------------------------------------------------------------
sage -t src/sage/misc/latex.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by slabbe created at 2020-02-01 14:37:54

Fredéric, I think you solved something similar in the past. Do you see easily a fix?


---

Comment by chapoton created at 2020-02-01 16:47:42

Voilà. Y a de grandes chances que ca casse les doctests sous python2. A mon avis, y a pas moyen d'avoir les deux. Et c'est un doctest optionnel..
----
New commits:


---

Comment by chapoton created at 2020-02-01 16:47:42

Changing status from new to needs_review.


---

Comment by slabbe created at 2020-02-02 14:27:10

I confirm it fixes the issue for that optional doctest (9.1.beta2 running Python 3).


---

Comment by slabbe created at 2020-02-02 14:27:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-02-10 20:05:56

Resolution: fixed
