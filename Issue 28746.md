# Issue 28746: Possible bug in residue and series

Issue created by migration from https://trac.sagemath.org/ticket/28983

Original creator: @dkwo

Original creation time: 2020-01-10 15:32:34

Keywords: residue, series, factor

We are interested in computing the (iterated) residue of a function. First, we can use the fact that the pole is always simple to multiply and take the limit.

```
br(x) = 1-x
q1,q2,q3,m = var('q1,q2,q3,m')
assume(q1>0,q2>0,q3>0,m>0)
q4 = (q1*q2*q3)^-1
k = 2
rho = [1,q4]
X = [var("x%d" % i) for i in range(k)]
chi1 = prod([ br(X[j]/m)/(br(X[j])*X[j]) for j in range(k)])
chi2 = prod([ prod([ br(q1*q2*X[i]/X[j])*br(q1*q3*X[i]/X[j])*br(q2*q3*X[i]/X[j]) for i in range(k) if i != j]) for j in range(k)])
chi3 = prod([ prod([ br(q1*X[i]/X[j])*br(q2*X[i]/X[j])*br(q3*X[i]/X[j])*br(q4*X[i]/X[j]) for i in range(k) if i != j]) for j in range (k)])
chi = (chi1*chi2/chi3).factor()
for xi,rhoi in zip(X,rho):
#    chi = chi.residue(xi==rhoi).combine().factor()
    chi = (chi*(xi-rhoi)).factor().subs({xi: rhoi})
chi.factor()
```

This gives the correct result.
If we instead employ the residue method

```
br(x) = 1-x
q1,q2,q3,m = var('q1,q2,q3,m')
assume(q1>0,q2>0,q3>0,m>0)
q4 = (q1*q2*q3)^-1
k = 2
rho = [1,q4]
X = [var("x%d" % i) for i in range(k)]
chi1 = prod([ br(X[j]/m)/(br(X[j])*X[j]) for j in range(k)])
chi2 = prod([ prod([ br(q1*q2*X[i]/X[j])*br(q1*q3*X[i]/X[j])*br(q2*q3*X[i]/X[j]) for i in range(k) if i != j]) for j in range(k)])
chi3 = prod([ prod([ br(q1*X[i]/X[j])*br(q2*X[i]/X[j])*br(q3*X[i]/X[j])*br(q4*X[i]/X[j]) for i in range(k) if i != j]) for j in range (k)])
chi = (chi1*chi2/chi3).factor()
for xi,rhoi in zip(X,rho):
    chi = chi.residue(xi==rhoi).combine().factor()
#    chi = (chi*(xi-rhoi)).factor().subs({xi: rhoi})
chi
```

it is wrong. I believe this is a bug in residue that comes from series.

As a side note, if we replace

```
br(x) = 1-x
```

with

```
br(x) = sqrt(x)-1/sqrt(x)
```

then the first method is still the only correct one, but it does not factorize all square roots to the simplest form.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-05-10 17:42:09

Moving to 9.4, as 9.3 has been released.


---

Comment by @DaveWitteMorris created at 2021-06-23 17:57:06

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2021-06-23 17:57:06

Changing keywords from "residue, series, factor" to "residue, series, factor, pynac".


---

Comment by @DaveWitteMorris created at 2021-06-23 17:57:06

This can be closed as a **duplicate** of #31479 (and #31679), which was fixed in 9.3.rc5.

To verify this, note that the bug on this ticket has gone away (i.e., both code snippets in the ticket description give the same result), and remains fixed even if you remove all of the files except `disable_poly_mul_expand.patch` from the `build/pkgs/pynac/patches/` directory (and do `./sage -f pynac`). However, the bug comes back if you remove this final pynac patch (and do `./sage -f pynac`).


---

Comment by @dkwo created at 2021-06-24 09:21:30

Thanks for pointing out.
I have not yet installed sage 9.3.


---

Comment by @dkwo created at 2021-06-24 09:22:40

Please go ahead and close.


---

Comment by @DaveWitteMorris created at 2021-06-28 04:45:41

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-06-29 19:17:15

Resolution: invalid
