# Issue 21081: recognizable series: basic arithmetic

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2016-08-23 17:13:13

- Make recognizable series space a module (addition, scalar multiplication)
- Hadamard product
- Subsequences

See also meta ticket #21202


---

Comment by dkrenn created at 2016-08-23 17:17:08

Last 10 new commits:


---

Comment by git created at 2016-08-23 17:30:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-23 17:33:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-08-24 08:59:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-25 11:19:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2016-08-25 11:21:16

Changing status from new to needs_review.


---

Comment by git created at 2016-08-26 11:22:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-26 11:25:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-26 11:28:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-26 11:55:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2017-01-05 12:14:48

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2017-01-05 12:14:48

patchbot python3 plugin failuree


---

Comment by git created at 2017-01-24 13:10:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2017-01-24 13:10:47

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2017-01-24 13:10:47

Replying to [comment:12 cheuberg]:
> patchbot python3 plugin failuree

Should be fixed. Is now on 7.5.


---

Comment by git created at 2018-04-06 07:38:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-03-29 08:49:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2021-05-07 16:59:42

`@`dkrenn: could you please merge the current version of #21203? Currently, there are some conflicts, and I would prefer to review a version where these conflicts are resolved.


---

Comment by cheuberg created at 2021-05-07 16:59:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-05-10 11:32:36

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dkrenn created at 2021-05-10 11:35:56

Replying to [comment:17 cheuberg]:
> `@`dkrenn: could you please merge the current version of #21203? Currently, there are some conflicts, and I would prefer to review a version where these conflicts are resolved.

Done; it is now based on the current #21203 which itself is on [SageMath](SageMath) 9.3.


---

Comment by git created at 2021-05-11 14:01:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-05-11 14:02:19

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2021-05-11 14:02:19

Fixup due to changes in #21203. So again ready for "needs review".


---

Comment by cheuberg created at 2021-05-14 14:53:53

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2021-05-14 14:53:53

1. Please reconsider punctuation in input and output blocks.

2. I am not sure whether handling of automatic minimization is best done in the methods `_add_` and `hadamard_product` (especially unsure about the first because it would be rather painful to call it with disabled minimization, overriding the convention about private methods). Perhaps the parent could have a flag whether minimization should always be performed or not?

3. `_add_`: in the example, the (new) method `linear_representation` introduced during review of a previous ticket could be used instead of extracting the information manually.

4. `_add_`: parameter `minimize=False` is not tested.

5. `_neg_`: in the example, `.is_trivial_zero()` could be used.

6. `_rmul_`: in the example, the (new) method `linear_representation` introduced during review of a previous ticket could be used instead of extracting the information manually.

7. `_rmul_`: I am not convinced that this method is called by the tests: In order to understand the problems with the tests of `_lmul_`, I deliberately introduced an error here and it was not raised in the tests.

8. `_lmul_`: The available (untested) test does not seem to be completely rewritten to this case; the last lines seem to belong to the test of `_rmul_`.

9. `_lmul_`: please add a test where `_lmul_` is called explicitly.

10. `hadamard_product`: in the examples and tests, the (new) method `linear_representation` introduced during review of a previous ticket could be used instead of extracting the information manually.

11. `hadamard_product`: I think that

```python
Matrix(tuple(
    srow.outer_product(orow).list()
    for srow in self.mu[a].rows()
    for orow in other.mu[a].rows())))

```

    could be simplified to `self.mu[a].tensor_product(other.mu[a])` which I consider to be more concise and clearer. I am not sure whether rewriting the left vectors to matrices, then calling `tensor_product` on the two single-row matrices and then extracting the first row would be more readable, too (similarly for the right vectors).

12. `one_hadamard`: I do not think that `one = ZZ(1)` is appropriate for all values of `coefficient_ring`.


---

Comment by git created at 2021-06-24 08:04:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 11:17:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-06-25 11:17:51

Replying to [comment:22 cheuberg]:
> 1. Please reconsider punctuation in input and output blocks.

Done.

> 2. I am not sure whether handling of automatic minimization is best done in the methods `_add_` and `hadamard_product` (especially unsure about the first because it would be rather painful to call it with disabled minimization, overriding the convention about private methods). Perhaps the parent could have a flag whether minimization should always be performed or not?

I agree that this is not optimal. I've now written a decorator `minimize_result` and introduce a flag in the parent for controlling the behavior.

> 3. `_add_`: in the example, the (new) method `linear_representation` introduced during review of a previous ticket could be used instead of extracting the information manually.

Done.

> 4. `_add_`: parameter `minimize=False` is not tested.

Now tested (indirectly) in the new decorator `minimize_result`

> 5. `_neg_`: in the example, `.is_trivial_zero()` could be used.

Indeed. Done.

> 6. `_rmul_`: in the example, the (new) method `linear_representation` introduced during review of a previous ticket could be used instead of extracting the information manually.

Done.

> 7. `_rmul_`: I am not convinced that this method is called by the tests: In order to understand the problems with the tests of `_lmul_`, I deliberately introduced an error here and it was not raised in the tests.

The problem was, that the `RecognizableSeries` was derived from `Element` and not `ModuleElement`, therefore, a fall-back action using a double-and-add algorithm where doubling is done by addition, was used and so `_rmul_` and `_lmul_` were actually never called.

Fixed now and added a test to make sure these methods are called.

Also, left and right was switched; fixed.

> 8. `_lmul_`: The available (untested) test does not seem to be completely rewritten to this case; the last lines seem to belong to the test of `_rmul_`.

Output removed.

> 9. `_lmul_`: please add a test where `_lmul_` is called explicitly.

Not needed anymore, as `_lmul_` is now properly tested.

> 10. `hadamard_product`: in the examples and tests, the (new) method `linear_representation` introduced during review of a previous ticket could be used instead of extracting the information manually.

Done.
 
> 11. `hadamard_product`: I think that
> {{{
> #!python
> Matrix(tuple(
>     srow.outer_product(orow).list()
>     for srow in self.mu[a].rows()
>     for orow in other.mu[a].rows())))
> 
> }}}
>     could be simplified to `self.mu[a].tensor_product(other.mu[a])` which I consider to be more concise and clearer. I am not sure whether rewriting the left vectors to matrices, then calling `tensor_product` on the two single-row matrices and then extracting the first row would be more readable, too (similarly for the right vectors).

Indeed, using `tensor_product` improves the code a lot. It is now used for the vectors, too.

> 12. `one_hadamard`: I do not think that `one = ZZ(1)` is appropriate for all values of `coefficient_ring`.

Changed.


---

Comment by dkrenn created at 2021-06-25 11:18:04

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-06-25 12:08:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cheuberg created at 2021-06-26 15:26:37

Thank you. Do you have any idea why `E * 2` calls `E._lmul_` twice (for `2 * E`, `E._rmul_` is called once, as expected) in the newly written test in `_rmul_`?

Apart from that question, I think that this ticket is ready to be merged once a patchbot is happy (might be some time because of #32048).


---

Comment by cheuberg created at 2021-06-26 15:26:37

Changing status from needs_review to needs_info.


---

Comment by dkrenn created at 2021-06-27 09:49:09

Replying to [comment:28 cheuberg]:
> Thank you. Do you have any idea why `E * 2` calls `E._lmul_` twice (for `2 * E`, `E._rmul_` is called once, as expected) in the newly written test in `_rmul_`?

Yes. The first left and right, resp., scalar multiplication that is performed in a session has one additional call coming from the coercion framework after discovering the action, because, when I remember correctly, a dummy multiplication is performed to check if that works. Now `2 * E` is computed earlier in the test, so this additional call of `_rmul_` is done there (but not seen). Removing the tests `2 * E` and also `1 * E` results in the same behavior for both `_rmul_` and `_lmul_`.

> Apart from that question, I think that this ticket is ready to be merged once a patchbot is happy (might be some time because of #32048).

I'll put it to positive_review.


---

Comment by dkrenn created at 2021-06-27 09:49:09

Changing status from needs_info to positive_review.


---

Comment by dkrenn created at 2021-06-27 09:49:59

Replying to [comment:29 dkrenn]:
> I'll put it to positive_review.

Back to needs_review as the patchbot has not run yet.


---

Comment by dkrenn created at 2021-06-27 09:49:59

Changing status from positive_review to needs_review.


---

Comment by cheuberg created at 2021-07-04 14:43:09

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2021-07-04 14:43:09

The `pyflakes` finding by the patchbot should be adressed:

```
src/sage/combinat/recognizable_series.py:1672:9 'sage.rings.integer_ring.ZZ' imported but unused
```



---

Comment by git created at 2021-07-06 11:15:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2021-07-06 11:16:14

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2021-07-06 11:16:14

Replying to [comment:31 cheuberg]:
> The `pyflakes` finding by the patchbot should be adressed:
> {{{
> src/sage/combinat/recognizable_series.py:1672:9 'sage.rings.integer_ring.ZZ' imported but unused
> }}}

Done.


---

Comment by cheuberg created at 2021-07-06 11:36:23

Thank you. Feel free to set to positive review once the patchbot is happy.


---

Comment by cheuberg created at 2021-07-06 17:00:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-07-09 20:24:00

Resolution: fixed
