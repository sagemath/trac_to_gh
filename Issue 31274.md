# Issue 31274: Memory leak in srange

Issue created by migration from https://trac.sagemath.org/ticket/31511

Original creator: mderickx

Original creation time: 2021-03-18 15:58:38

The following shows that there is a huge memory leak in the srange command, at least in the cocalc enhanced version of sage-9.2 on ubuntu 20.04:



```
~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2, Release Date: 2020-10-24                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.8.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: M = 3000 
....: import gc 
....: gc.collect() 
....: mem = get_memory_usage() 
....: for i in range(10000): 
....:     R = srange(M) 
....: gc.collect() 
....: print("memory usage 10k:", get_memory_usage(mem)) 
....: mem = get_memory_usage() 
....: for i in range(20000): 
....:     R = srange(M) 
....: gc.collect() 
....: print("memory usage 20k:", get_memory_usage(mem))                                                                   
434
0
memory usage 10k: 884.4296875
0
memory usage 20k: 1770.71875
```


on my macbook with OS X 10.13.6 there seems to be no problem:


```
~ mderickx$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2, Release Date: 2020-10-24                     │
│ Using Python 3.8.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: M = 3000 
....: import gc 
....: gc.collect() 
....: mem = get_memory_usage() 
....: for i in range(10000): 
....:     R = srange(M) 
....: gc.collect() 
....: print("memory usage 10k:", get_memory_usage(mem)) 
....: mem = get_memory_usage() 
....: for i in range(20000): 
....:     R = srange(M) 
....: gc.collect() 
....: print("memory usage 20k:", get_memory_usage(mem))                         
353
0
memory usage 10k: 0.5
0
memory usage 20k: 0.0
```


on https://groups.google.com/g/sage-devel/c/K4EQiwyIRHQ/m/KzkiondSAQAJ there are confirmations that the problem also exists on Arch linux and the non cocalc enhanced version of sage.


---

Comment by dimpase created at 2021-03-18 16:41:30

I also see this bug on Debian 11, Sage 9.3.beta8 (Python 3.9.1)
But no problem on Fedora 30 and Sage 9.3.beta9 (Python 3.7.7)


---

Comment by mderickx created at 2021-03-18 18:36:48

Looking at the code of srange which just calls xsrange and digging a bit deeper seems to show that something strange is going on when you store more then 100 sage integers in a python list:


```
~$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2, Release Date: 2020-10-24                     │
│ Create a "Sage Worksheet" file for the notebook interface.         │
│ Enhanced for CoCalc.                                               │
│ Using Python 3.8.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: for M in range(90,110): 
....:     R = [ZZ(z) for z in range(500,500+M)] 
....:     a = 0 
....:     b = 1 
....:     import gc 
....:     _ = gc.collect() 
....:     mem = get_memory_usage() 
....:     for i in range(10^5): 
....:         R = [ZZ(z) for z in range(500,500+M)] 
....:     _ = gc.collect() 
....:     print("memory usage %s:"%M, get_memory_usage(mem)) 
....:                                                                                                                     
memory usage 90: 0.0
memory usage 91: 0.0
memory usage 92: 0.0
memory usage 93: 0.0
memory usage 94: 0.0
memory usage 95: 0.0
memory usage 96: 0.0
memory usage 97: 0.0
memory usage 98: 0.0
memory usage 99: 0.0
memory usage 100: 0.0
memory usage 101: 1.41796875
memory usage 102: 6.1875
memory usage 103: 9.15234375
memory usage 104: 12.1171875
memory usage 105: 15.33984375
memory usage 106: 18.3046875
memory usage 107: 21.3984375
memory usage 108: 24.36328125
memory usage 109: 27.45703125
```



---

Comment by vbraun created at 2021-03-18 20:29:56

Probably dupe of #31340

The 100 is surely the Sage integer allocation pool in sage/rings/integer.pyx


---

Comment by mderickx created at 2021-03-18 21:12:28

I agree that it's a duplicate.


---

Comment by mderickx created at 2021-03-18 21:12:28

Resolution: duplicate
