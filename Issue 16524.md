# Issue 16524: Error message bad when trying to make vector symbolic expression

Issue created by migration from https://trac.sagemath.org/ticket/16761

Original creator: kcrisman

Original creation time: 2014-08-05 01:36:04

CC:  tscrim


```
sage: symbolic_expression(vector([1,2]))
<boom>
TypeError:
```

This is pretty uninformative, esp. when it is in [the midst of a larger computation](http://ask.sagemath.org/question/23690/how-to-fit-data-to-an-arrhenius-equation/).

I'm not suggesting we make a vector a symbolic expression, though of course 

```
sage: vector([x,2*x])
```

works so we could go that way.


---

Comment by mkoeppe created at 2021-07-06 05:03:33

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-07-06 05:03:33

New commits:


---

Comment by kcrisman created at 2021-07-06 12:05:40

It's always so great to wake up to someone working on a ticket from seven years ago :-)

I agree that this is the preferred way to handle it, and on a first pass the code looks good for it.  I do have two usage questions.

```
sage: f = symbolic_expression(lambda z: z^2 + 1); f
```

Am I correct that this does _not_ inject `z` into the global namespace?  This seems to be how you constructed it with `SR.var`.

Also, I'm not familiar with `SR.subring(no_variables=True)`, which is presumably what generates the "Symbolic Constants Subring".  If someone later wanted to take something like `symbolic_expression(vector(QQ, 0))` and then add it to another (zero-dimensional) vector, how would that behave?  Would it complain because it has a different base ring?  Or would it do the "obvious" thing in any of these degenerate cases?  I don't know if there is a "right" answer here (for degenerate cases), but I wanted to ask.

Finally, it could be fun to exemplify the recursive nature of the code by having a vector composed of vector functions or something.  Though I doubt that would be a real use case; this ticket is more to make sure that if people insist on making everything "symbolic" that nothing goes boom.


---

Comment by mkoeppe created at 2021-07-06 12:34:35

Replying to [comment:5 kcrisman]:
> {{{
> sage: f = symbolic_expression(lambda z: z^2 + 1); f
> }}}
> Am I correct that this does _not_ inject `z` into the global namespace?  This seems to be how you constructed it with `SR.var`.

That's right. (Note this is from #32103, not the present ticket.)


---

Comment by mkoeppe created at 2021-07-06 12:36:26

Replying to [comment:5 kcrisman]:
> Also, I'm not familiar with `SR.subring(no_variables=True)`, which is presumably what generates the "Symbolic Constants Subring".  If someone later wanted to take something like `symbolic_expression(vector(QQ, 0))` and then add it to another (zero-dimensional) vector, how would that behave?
The coercion system takes care of it:

```
sage: vector(SR.subring(no_variables=True), 0) + vector(SR, 0) + vector(ZZ, 0)
()
sage: _.parent()
Vector space of dimension 0 over Symbolic Ring
```



---

Comment by mkoeppe created at 2021-07-06 12:43:38

Replying to [comment:5 kcrisman]:
 > it could be fun to exemplify the recursive nature of the code by having a vector composed of vector functions or something.  Though I doubt that would be a real use case; this ticket is more to make sure that if people insist on making everything "symbolic" that nothing goes boom.

I think I'd rather not advertise more complicated possible uses of this function at this point. I only became aware of its existence when I was looking for a preparser-less idiom for creating callable symbolic expressions (#32103).


---

Comment by kcrisman created at 2021-07-06 12:49:41

> I only became aware of its existence when I was looking for a preparser-less idiom for creating callable symbolic expressions (#32103). 

I see now.  I certainly can give positive review to the changes for this ticket (modulo green patchbot).  I'll make one or two other comments there.  Thanks for fixing this!


---

Comment by git created at 2021-07-06 13:41:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-26 17:55:14

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-07-26 17:55:14

Doctest failures


---

Comment by git created at 2021-07-26 20:14:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-26 20:15:03

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2021-07-26 22:43:37

Do we also want to support the case when a list of lists is passed to create a symbolic matrix? It could be done by

```diff
     elif isinstance(x, (tuple, list)) or is_FreeModuleElement(x):
         expressions = [symbolic_expression(item) for item in x]
         if not expressions:
             # Make sure it is symbolic also when length is 0
             return vector(SR.subring(no_variables=True), 0)
+        if is_FreeModuleElement(expressions[0]):
+            return matrix(expressions)
         return vector(expressions)
```



---

Comment by git created at 2021-07-26 23:45:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-26 23:46:07

Good idea, done


---

Comment by tscrim created at 2021-07-27 01:53:10

Thanks. Green bot => positive review.


---

Comment by mkoeppe created at 2021-08-03 19:13:58

Using the symbolic constants ring actually depends on #31999, #31988


---

Comment by git created at 2021-08-03 19:32:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-03 19:37:35

Another issue remains - symbolic matrices have no `function` method

```
sage -t --random-seed=0 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 3186, in sage.symbolic.expression.Expression.__nonzero__
Failed example:
    f(x) = matrix()
Exception raised:
    Traceback (most recent call last):
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 718, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/src/sage/doctest/forker.py", line 1137, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression.Expression.__nonzero__[87]>", line 1, in <module>
        __tmp__=var("x"); f = symbolic_expression(matrix()).function(x)
      File "sage/structure/element.pyx", line 493, in sage.structure.element.Element.__getattr__
        return self.getattr_from_category(name)
      File "sage/structure/element.pyx", line 506, in sage.structure.element.Element.getattr_from_category
        return getattr_from_other_class(self, cls, name)
      File "sage/cpython/getattr.pyx", line 372, in sage.cpython.getattr.getattr_from_other_class
        raise AttributeError(dummy_error_message)
    AttributeError: 'sage.matrix.matrix_symbolic_dense.Matrix_symbolic_dense' object has no attribute 'function'
```



---

Comment by git created at 2021-08-03 19:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-03 20:03:23

This works now but it is not perfect yet because we do not have a matrix element class in analogy to `Vector_callable_symbolic_dense`, so the repr of such callable symbolic matrices does not look nice. But this is a cosmetic wishlist item that is already noted in #31988.


---

Comment by tscrim created at 2021-08-05 22:40:02

I have noticed in the past other inconsistencies between matrices and vectors over symbolic rings with elements in SR. I just can't remember them now. We can just add any missing functionality as we come across it.

Anyways, the current branch LGTM.


---

Comment by tscrim created at 2021-08-05 22:40:02

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-08-09 20:01:26

Thanks!


---

Comment by vbraun created at 2021-08-29 09:37:59

Resolution: fixed
