# Issue 11703: Correct general brokenness of Farey symbols

archive/issues_011703.json:
```json
{
    "body": "Assignee: @craigcitro\n\nCC:  mraum @monien\n\nKeywords: modular subgroup\n\nThe new Farey symbols code from #11709 needs some serious work before it can be allowed into a production release of Sage. \n\nSee [this sage-devel thread](http://groups.google.com/group/sage-devel/browse_thread/thread/e6b65915cde174b).\n\nAs an absolute minimum, we should:\n\n* remove the file \"sage.modular.arithgroup.noncongruence_example\" (which is makes outrageously false mathematical statements in its docstrings -- the \"example noncongruence subgroup\" is actually the congruence subgroup `GammaH(8, [5])` -- and is implemented in a stupidly broken way with no doctests and no usable methods whatsoever)\n\n* bring doctest coverage for the Python and Cython files in sage/modular/arithgroup back up to 100%, and make sure there are loads/dumps tests for all the classes;\n\n* make sure that the Farey symbol code works with all of the subclasses of ArithmeticSubgroup and add doctests to prove it;\n\n* add a warning in the documentation that commands like \"index\" and \"generators\" in Farey symbol code return the index, generators etc of the image of the group in PSL2Z, whereas Sage's general design is to work with subgroups of SL2Z.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11875\n\n",
    "created_at": "2011-09-30T07:05:30Z",
    "labels": [
        "component: modular forms",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Correct general brokenness of Farey symbols",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11703",
    "user": "https://github.com/loefflerd"
}
```
Assignee: @craigcitro

CC:  mraum @monien

Keywords: modular subgroup

The new Farey symbols code from #11709 needs some serious work before it can be allowed into a production release of Sage. 

See [this sage-devel thread](http://groups.google.com/group/sage-devel/browse_thread/thread/e6b65915cde174b).

As an absolute minimum, we should:

* remove the file "sage.modular.arithgroup.noncongruence_example" (which is makes outrageously false mathematical statements in its docstrings -- the "example noncongruence subgroup" is actually the congruence subgroup `GammaH(8, [5])` -- and is implemented in a stupidly broken way with no doctests and no usable methods whatsoever)

* bring doctest coverage for the Python and Cython files in sage/modular/arithgroup back up to 100%, and make sure there are loads/dumps tests for all the classes;

* make sure that the Farey symbol code works with all of the subclasses of ArithmeticSubgroup and add doctests to prove it;

* add a warning in the documentation that commands like "index" and "generators" in Farey symbol code return the index, generators etc of the image of the group in PSL2Z, whereas Sage's general design is to work with subgroups of SL2Z.

Issue created by migration from https://trac.sagemath.org/ticket/11875





---

archive/issue_comments_132221.json:
```json
{
    "body": "It gets worse :-(\n\n- For SL2Z, the code returns a malformed Farey symbol with too many vertices (there are 2 rational vertices, so the side-pairing data should be a list of length 3, but it has only 2 entries). This can be fixed by removing the entry \"1\" from the Farey symbol.\n\n- For the unique index 2 subgroup of PSL2Z (denoted by `Gamma_2` in the article by Kurth and Long) this code returns the wrong Farey symbol (corresponding to another completely different subgroup of index 6).",
    "created_at": "2011-10-01T15:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132221",
    "user": "https://github.com/loefflerd"
}
```

It gets worse :-(

- For SL2Z, the code returns a malformed Farey symbol with too many vertices (there are 2 rational vertices, so the side-pairing data should be a list of length 3, but it has only 2 entries). This can be fixed by removing the entry "1" from the Farey symbol.

- For the unique index 2 subgroup of PSL2Z (denoted by `Gamma_2` in the article by Kurth and Long) this code returns the wrong Farey symbol (corresponding to another completely different subgroup of index 6).



---

archive/issue_comments_132222.json:
```json
{
    "body": "Here's a case where it crashes completely:\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nsage: G = ArithmeticSubgroup_Permutation(L = \"(1,2,3)\", R = \"(1,2,4)\")\nsage: FareySymbol(G)\nterminate called after throwing an instance of 'std::string'\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |\n| Type notebook() for the GUI, and license() for information.        |\n/storage/masiao/sage-4.7.2.alpha3/devel/sage-main/sage/modular/arithgroup/<ipython console> in <module>()\n\n/storage/masiao/sage-4.7.2.alpha3/local/lib/python2.6/site-packages/sage/modular/arithgroup/farey_symbol.so in sage.modular.arithgroup.farey_symbol.Farey.__cinit__ (sage/modular/arithgroup/farey_symbol.cpp:1993)()\n    191         cdef int p\n    192         if hasattr(group, \"level\"): p=group.level()\n--> 193         sig_on()\n    194         if group == SL2Z:\n    195             self.this_ptr = new cpp_farey()\n\nRuntimeError: Aborted\n```",
    "created_at": "2011-10-01T16:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132222",
    "user": "https://github.com/loefflerd"
}
```

Here's a case where it crashes completely:

```
----------------------------------------------------------------------
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
sage: G = ArithmeticSubgroup_Permutation(L = "(1,2,3)", R = "(1,2,4)")
sage: FareySymbol(G)
terminate called after throwing an instance of 'std::string'
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
| Sage Version 4.7.2.alpha3, Release Date: 2011-09-28                |
| Type notebook() for the GUI, and license() for information.        |
/storage/masiao/sage-4.7.2.alpha3/devel/sage-main/sage/modular/arithgroup/<ipython console> in <module>()

/storage/masiao/sage-4.7.2.alpha3/local/lib/python2.6/site-packages/sage/modular/arithgroup/farey_symbol.so in sage.modular.arithgroup.farey_symbol.Farey.__cinit__ (sage/modular/arithgroup/farey_symbol.cpp:1993)()
    191         cdef int p
    192         if hasattr(group, "level"): p=group.level()
--> 193         sig_on()
    194         if group == SL2Z:
    195             self.this_ptr = new cpp_farey()

RuntimeError: Aborted
```



---

archive/issue_comments_132223.json:
```json
{
    "body": "Some more testing suggests that the above crash occurs for any group of index > 2 containing the element \n\n```\n[-1 1]\n[-1 0].\n```",
    "created_at": "2011-10-01T17:24:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132223",
    "user": "https://github.com/loefflerd"
}
```

Some more testing suggests that the above crash occurs for any group of index > 2 containing the element 

```
[-1 1]
[-1 0].
```



---

archive/issue_comments_132224.json:
```json
{
    "body": "Hi all,\n\nthe structural data of an arithmetic subgroup, that one needs to compute for the modular symbols \"integrality algorithm\", is more or less the same than what one needs for Farey symbols (for some discussion of the former, see http://groups.google.com/group/sage-nt/browse_thread/thread/a653b4498fa5cb67#).\n\nFWIW, I have put some \"needs work\" code for that (pure Python, building upon the existing ArithmeticSubgroup framework in Sage) at trac #10857.\n\nIt needs quite some polishing (especially a renaming and a complete reordering of the functions), but works for all arithmetic subgroups, features examples of non-congruence subgroups (taken elsewhere from Sage), and for certain classes of groups (Gamma, Gamma_1, Gamma_0) there are special algorithms that compute this structural data in linear time (w.r.t. to the subgroup index in SL2Z), not quadratic time (which is the generic case).\n\nExplicitly, on my 2 GHz machine, the code there computed generators and coset representatives for Gamma(64) in about 17 seconds and for Gamma(128) in about 478 seconds.\n\nSince then, I didn't find the time to continue the work on that code (if I had free time to spare for Sage, I'd rather review #5048, sigh), or else I would have finished e.g. the dummy \"def z_farey_symbol_data(self):\" there ...\n\nMy proposal for continuing with #11709 and this #11875 here, would be to separate off the \"plotting\" parts of #11709 (which I dearly would like to have ready in Sage), which seem to be uncontroversial, and get them into Sage.\n\nHaving done that, and Hartmut and Martin still being \"on fire\", the next step might be to do the reality check, whether using C++ for computing the Farey symbol structural data really gives the speed advantage, worth all the trouble not coding these algorithms directly in Python (or Cython).\n\nPlease don't get me wrong, you have my greatest respect for executing the addition of a new cpp file to the Sage library! There are probably lots of places in the Sage development documentation that could benefit from this experience, think not only of the last necessary patches from Leif, but also all this \"module_list.py\" stuff, let alone the .rst documentation (kudos to you for including pictures!!), and what not ...",
    "created_at": "2011-10-11T22:02:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132224",
    "user": "https://trac.sagemath.org/admin/accounts/users/GeorgSWeber"
}
```

Hi all,

the structural data of an arithmetic subgroup, that one needs to compute for the modular symbols "integrality algorithm", is more or less the same than what one needs for Farey symbols (for some discussion of the former, see http://groups.google.com/group/sage-nt/browse_thread/thread/a653b4498fa5cb67#).

FWIW, I have put some "needs work" code for that (pure Python, building upon the existing ArithmeticSubgroup framework in Sage) at trac #10857.

It needs quite some polishing (especially a renaming and a complete reordering of the functions), but works for all arithmetic subgroups, features examples of non-congruence subgroups (taken elsewhere from Sage), and for certain classes of groups (Gamma, Gamma_1, Gamma_0) there are special algorithms that compute this structural data in linear time (w.r.t. to the subgroup index in SL2Z), not quadratic time (which is the generic case).

Explicitly, on my 2 GHz machine, the code there computed generators and coset representatives for Gamma(64) in about 17 seconds and for Gamma(128) in about 478 seconds.

Since then, I didn't find the time to continue the work on that code (if I had free time to spare for Sage, I'd rather review #5048, sigh), or else I would have finished e.g. the dummy "def z_farey_symbol_data(self):" there ...

My proposal for continuing with #11709 and this #11875 here, would be to separate off the "plotting" parts of #11709 (which I dearly would like to have ready in Sage), which seem to be uncontroversial, and get them into Sage.

Having done that, and Hartmut and Martin still being "on fire", the next step might be to do the reality check, whether using C++ for computing the Farey symbol structural data really gives the speed advantage, worth all the trouble not coding these algorithms directly in Python (or Cython).

Please don't get me wrong, you have my greatest respect for executing the addition of a new cpp file to the Sage library! There are probably lots of places in the Sage development documentation that could benefit from this experience, think not only of the last necessary patches from Leif, but also all this "module_list.py" stuff, let alone the .rst documentation (kudos to you for including pictures!!), and what not ...



---

archive/issue_comments_132225.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132225",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_132226.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-21T11:38:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132226",
    "user": "https://github.com/loefflerd"
}
```

Changing status from new to needs_review.



---

archive/issue_events_031383.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2012-03-21T11:38:22Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11703#event-31383"
}
```



---

archive/issue_comments_132227.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-21T11:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132227",
    "user": "https://github.com/loefflerd"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_031384.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-21T12:45:41Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11703#event-31384"
}
```



---

archive/issue_events_031385.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-21T12:45:41Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11703#event-31385"
}
```



---

archive/issue_comments_132228.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2012-04-04T13:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11703#issuecomment-132228",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: duplicate



---

archive/issue_events_031386.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-04T13:22:22Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11703",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11703#event-31386"
}
```
