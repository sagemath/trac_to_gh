# Issue 33162: Bug in ExpressionNIce with composite variables

archive/issues_033162.json:
```json
{
    "body": "CC:  @tscrim\n\nIn Sage 9.6.beta2, we have\n\n```\nsage: from sage.manifolds.utilities import ExpressionNice\nsage: u, v = var('u v')\nsage: f = function('F')(u + v)\nsage: f\nF(u + v)\nsage: ExpressionNice(diff(f, u))\nd(F)/d(u + v)\n```\n\nSo far, so good, but\n\n```\nsage: f = function('F')(u - v)\nsage: ExpressionNice(diff(f, u))\nd(F)/du - v\n```\n\nThis bug has been reported in https://groups.google.com/g/sage-support/c/fbE0APqThEk\n\nIssue created by migration from https://trac.sagemath.org/ticket/33399\n\n",
    "created_at": "2022-02-22T12:50:36Z",
    "labels": [
        "component: manifolds",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Bug in ExpressionNIce with composite variables",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33162",
    "user": "https://github.com/egourgoulhon"
}
```
CC:  @tscrim

In Sage 9.6.beta2, we have

```
sage: from sage.manifolds.utilities import ExpressionNice
sage: u, v = var('u v')
sage: f = function('F')(u + v)
sage: f
F(u + v)
sage: ExpressionNice(diff(f, u))
d(F)/d(u + v)
```

So far, so good, but

```
sage: f = function('F')(u - v)
sage: ExpressionNice(diff(f, u))
d(F)/du - v
```

This bug has been reported in https://groups.google.com/g/sage-support/c/fbE0APqThEk

Issue created by migration from https://trac.sagemath.org/ticket/33399





---

archive/issue_comments_471871.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-22T13:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471871",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471872.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-02-22T13:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471872",
    "user": "https://github.com/egourgoulhon"
}
```

New commits:



---

archive/issue_comments_471873.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-23T00:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471873",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2022-02-23T13:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471874",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_471875.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-02-23T13:00:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471875",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_471876.json:
```json
{
    "body": "Thank you for the review. Here is a new version, which avoids `import re`.",
    "created_at": "2022-02-23T13:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471876",
    "user": "https://github.com/egourgoulhon"
}
```

Thank you for the review. Here is a new version, which avoids `import re`.



---

archive/issue_comments_471877.json:
```json
{
    "body": "What do you think about the new version? Sorry for having pushed it after your positive review, but I thought this rewriting was better than the quick fix I first submitted, especially because it relies on standard Python, without the need of importing the `re` module.",
    "created_at": "2022-02-28T21:53:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471877",
    "user": "https://github.com/egourgoulhon"
}
```

What do you think about the new version? Sorry for having pushed it after your positive review, but I thought this rewriting was better than the quick fix I first submitted, especially because it relies on standard Python, without the need of importing the `re` module.



---

archive/issue_comments_471878.json:
```json
{
    "body": "This version is also fine. Note though that `re` *is* part of the Python standard library.",
    "created_at": "2022-02-28T21:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471878",
    "user": "https://github.com/mkoeppe"
}
```

This version is also fine. Note though that `re` *is* part of the Python standard library.



---

archive/issue_comments_471879.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-28T21:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471879",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471880.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> This version is also fine. \n\nThank you!\n\n>Note though that `re` *is* part of the Python standard library.\n\nYou are right; I should have said *basic* Python, instead of *standard* Python. My concern was actually the CPU performance: it's always better to avoid an import, isn't it? (unless of course the function you import does the job more efficiently).",
    "created_at": "2022-02-28T22:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471880",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:8 mkoeppe]:
> This version is also fine. 

Thank you!

>Note though that `re` *is* part of the Python standard library.

You are right; I should have said *basic* Python, instead of *standard* Python. My concern was actually the CPU performance: it's always better to avoid an import, isn't it? (unless of course the function you import does the job more efficiently).



---

archive/issue_comments_471881.json:
```json
{
    "body": "This module is already widely used by pretty much everything, so it's likely to be already loaded. And it's likely to be faster than doing the loop over the characters in the new version. But I don't think it matters.",
    "created_at": "2022-02-28T22:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471881",
    "user": "https://github.com/mkoeppe"
}
```

This module is already widely used by pretty much everything, so it's likely to be already loaded. And it's likely to be faster than doing the loop over the characters in the new version. But I don't think it matters.



---

archive/issue_comments_471882.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-01T21:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33162#issuecomment-471882",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_029993.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-03-01T21:31:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/33162",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/33162#event-29993"
}
```
