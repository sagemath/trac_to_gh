# Issue 25433: py3: fixing various issues

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2018-06-27 08:13:01

CC:  tscrim embray jdemeyer

in cones, graphs, polynomials, elliptic


---

Comment by chapoton created at 2018-06-27 08:14:27

this makes a failing doctest in elliptic curves..
----
New commits:


---

Comment by git created at 2018-06-27 08:33:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-27 08:33:52

should be good now


---

Comment by chapoton created at 2018-06-27 08:33:52

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-06-27 09:53:39

LGTM except I am not sure about the change in `ell_rational_field.py`. Can you explain one that a little bit?


---

Comment by embray created at 2018-06-27 11:00:13

This


```diff
`@``@` -6544,7 +6543,7 `@``@` def random_cone(lattice=None, min_ambient_dim=0, max_ambient_dim=None,
 
                     # rays has immutable elements
                     from copy import copy
-                    rays = map(copy, rays)
+                    rays = list(map(copy, rays))
 
                     for i, ray in enumerate(rays):
                         rays[i][0] = pm * (ray[0].abs() + 1)
```


could just be a list comprehension.


---

Comment by embray created at 2018-06-27 11:11:20

For this


```diff
diff --git a/src/sage/graphs/graph_generators.py b/src/sage/graphs/graph_generators.py
index f05d8e2..8bb59e6 100644
--- a/src/sage/graphs/graph_generators.py
+++ b/src/sage/graphs/graph_generators.py
`@``@` -17,6 +17,7 `@``@` build by typing ``graphs.`` in Sage and then hitting tab.
 """
 from __future__ import print_function, absolute_import, division
 from six.moves import range
+from sage.cpython.string import bytes_to_str
 
 # This method appends a list of methods to the doc as a 3xN table.
 
`@``@` -911,7 +912,7 `@``@` class GraphGenerators():
             except StopIteration:
                 # Exhausted list of graphs from nauty geng
                 return
-            G = graph.Graph(s[:-1], format='graph6')
+            G = graph.Graph(bytes_to_str(s)[:-1], format='graph6')
             yield G
```


I leave it up to you what to do, but it would be more consistent to follow the pattern I've taken in other Popen cases of passing encoding arguments on Python 3, as in: https://git.sagemath.org/sage.git/commit?id=faa92a74f4143b0618c8578dd0b426105b3bbe79

An advantage to this approach is that in the (untested) case where lines are returned from `stderr` they will also be returned as `str`, not `bytes` (though this is a good case to use `errors='surrogateescape'` in case something goes completely wrong and the stream contains garbage).

In fact this pattern is common enough (I've used it in some other places as well) that we probably ought to have a convenience function for it.  But I haven't done so because I didn't want to get delayed by bikeshedding over its interface...


---

Comment by chapoton created at 2018-06-27 18:03:03

Replying to [comment:4 tscrim]:
> LGTM except I am not sure about the change in `ell_rational_field.py`. Can you explain one that a little bit?

well, range in python3 is not happy with float arguments anymore, so we feed it with ints instead


---

Comment by git created at 2018-06-27 18:14:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-28 07:00:05

all remarks have been answered, I think


---

Comment by tscrim created at 2018-06-28 07:04:24

LGTM.


---

Comment by tscrim created at 2018-06-28 07:04:24

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-06-28 15:26:17

Sorry to nitpick, but I don't like that these are global variables (much less non-underscored ones):


```diff
diff --git a/src/sage/graphs/graph_generators.py b/src/sage/graphs/graph_generators.py
index 8bb59e6..bee63a1 100644
--- a/src/sage/graphs/graph_generators.py
+++ b/src/sage/graphs/graph_generators.py
`@``@` -17,7 +17,14 `@``@` build by typing ``graphs.`` in Sage and then hitting tab.
 """
 from __future__ import print_function, absolute_import, division
 from six.moves import range
-from sage.cpython.string import bytes_to_str
+from six import PY2
+
+if PY2:
+    enc_kwargs = {}
+else:
+    enc_kwargs = {'encoding': 'latin-1'}
+
+import subprocess
```


I think it was just fine as in my previous example as locals (though I agree with removing the `import subprocess` to the module level).


---

Comment by embray created at 2018-06-28 15:26:17

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-06-28 17:12:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-28 17:12:45

better like this ?


---

Comment by chapoton created at 2018-06-29 07:20:55

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-06-29 09:04:02

Thanks! I'm just gonna squash the commit history a bit.


---

Comment by embray created at 2018-06-29 09:05:37

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-06-29 09:05:37

New commits:


---

Comment by vbraun created at 2018-06-30 15:21:14

Resolution: fixed
