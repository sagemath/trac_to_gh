# Issue 22336: _act_on_() should not return None by default

archive/issues_022336.json:
```json
{
    "body": "CC:  pelegm\n\nThis should be an error:\n\n\n```\nsage: [1,2,3]/2\n```\n\n\nI traced this to\n\n```\nsage: (1/2)._act_on_([1,2,3], False)\n```\n\nwhich uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:\n\n```python\n    cpdef _act_on_(self, x, bint self_on_left):\n        \"\"\"\n        Use this method to implement ``self`` acting on ``x``.\n\n        Return None or raise a CoercionException if no\n        such action is defined here.\n        \"\"\"\n        return None\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/22573\n\n",
    "created_at": "2017-03-10T14:52:32Z",
    "labels": [
        "coercion",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "_act_on_() should not return None by default",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22336",
    "user": "jdemeyer"
}
```
CC:  pelegm

This should be an error:


```
sage: [1,2,3]/2
```


I traced this to

```
sage: (1/2)._act_on_([1,2,3], False)
```

which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:

```python
    cpdef _act_on_(self, x, bint self_on_left):
        """
        Use this method to implement ``self`` acting on ``x``.

        Return None or raise a CoercionException if no
        such action is defined here.
        """
        return None
```


Issue created by migration from https://trac.sagemath.org/ticket/22573





---

archive/issue_comments_310492.json:
```json
{
    "body": "Replying to [ticket:22573 jdemeyer]:\n> I traced this to\n> {{{\n> sage: (1/2)._act_on_([1,2,3], False)\n> }}}\n> which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:\n> {{{\n> #!python\n>     cpdef _act_on_(self, x, bint self_on_left):\n>         \"\"\"\n>         Use this method to implement ``self`` acting on ``x``.\n> \n>         Return None or raise a CoercionException if no\n>         such action is defined here.\n>         \"\"\"\n>         return None\n> }}}\n\nWhen I see this correctly, this is does not cause the problem. \n\nThere is an action of an integer (from `ZZ`) on an list as in pure Python (repeating the list). But clearly there is no such action of `QQ`.\n`discover_action` in `sage.structure.coerce` discovers an action in the following way: We have a list divided by `ZZ`-integer; the code says we do as with `mul`, but then precompose the action by the natural embedding of `ZZ` in `QQ` and use an inverse action. \n\nI am not sure what the correct solution would be. In some sense, the correct discovered action should be `QQ` on `list` and precompose it with invert element first.",
    "created_at": "2017-03-10T16:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310492",
    "user": "dkrenn"
}
```

Replying to [ticket:22573 jdemeyer]:
> I traced this to
> {{{
> sage: (1/2)._act_on_([1,2,3], False)
> }}}
> which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:
> {{{
> #!python
>     cpdef _act_on_(self, x, bint self_on_left):
>         """
>         Use this method to implement ``self`` acting on ``x``.
> 
>         Return None or raise a CoercionException if no
>         such action is defined here.
>         """
>         return None
> }}}

When I see this correctly, this is does not cause the problem. 

There is an action of an integer (from `ZZ`) on an list as in pure Python (repeating the list). But clearly there is no such action of `QQ`.
`discover_action` in `sage.structure.coerce` discovers an action in the following way: We have a list divided by `ZZ`-integer; the code says we do as with `mul`, but then precompose the action by the natural embedding of `ZZ` in `QQ` and use an inverse action. 

I am not sure what the correct solution would be. In some sense, the correct discovered action should be `QQ` on `list` and precompose it with invert element first.



---

archive/issue_comments_310493.json:
```json
{
    "body": "Replying to [comment:1 dkrenn]:\n> Replying to [ticket:22573 jdemeyer]:\n> > I traced this to\n> > {{{\n> > sage: (1/2)._act_on_([1,2,3], False)\n> > }}}\n> > which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:\n> > {{{\n> > #!python\n> >     cpdef _act_on_(self, x, bint self_on_left):\n> >         \"\"\"\n> >         Use this method to implement ``self`` acting on ``x``.\n> > \n> >         Return None or raise a CoercionException if no\n> >         such action is defined here.\n> >         \"\"\"\n> >         return None\n> > }}}\n> \n> When I see this correctly, this is does not cause the problem.\n\nYes, maybe you are right. The problem is that not all places calling `_act_on_` check for `None`. I still think that the `return None` convention is fragile, but it's used in many places. So maybe you should keep that.",
    "created_at": "2017-03-14T11:39:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310493",
    "user": "jdemeyer"
}
```

Replying to [comment:1 dkrenn]:
> Replying to [ticket:22573 jdemeyer]:
> > I traced this to
> > {{{
> > sage: (1/2)._act_on_([1,2,3], False)
> > }}}
> > which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:
> > {{{
> > #!python
> >     cpdef _act_on_(self, x, bint self_on_left):
> >         """
> >         Use this method to implement ``self`` acting on ``x``.
> > 
> >         Return None or raise a CoercionException if no
> >         such action is defined here.
> >         """
> >         return None
> > }}}
> 
> When I see this correctly, this is does not cause the problem.

Yes, maybe you are right. The problem is that not all places calling `_act_on_` check for `None`. I still think that the `return None` convention is fragile, but it's used in many places. So maybe you should keep that.



---

archive/issue_comments_310494.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-14T12:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310494",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_310495.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-14T12:57:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310495",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_310496.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-14T13:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310496",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310497.json:
```json
{
    "body": "Looks good, assuming that the patchbots are happy.",
    "created_at": "2017-03-14T13:05:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310497",
    "user": "saraedum"
}
```

Looks good, assuming that the patchbots are happy.



---

archive/issue_comments_310498.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Replying to [comment:1 dkrenn]:\n> > Replying to [ticket:22573 jdemeyer]:\n> > > I traced this to\n> > > {{{\n> > > sage: (1/2)._act_on_([1,2,3], False)\n> > > }}}\n> > > which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:\n> > > {{{\n> > > #!python\n> > >     cpdef _act_on_(self, x, bint self_on_left):\n> > >         \"\"\"\n> > >         Use this method to implement ``self`` acting on ``x``.\n> > > \n> > >         Return None or raise a CoercionException if no\n> > >         such action is defined here.\n> > >         \"\"\"\n> > >         return None\n> > > }}}\n> > \n> > When I see this correctly, this is does not cause the problem.\n> \n> Yes, maybe you are right. The problem is that not all places calling `_act_on_` check for `None`. I still think that the `return None` convention is fragile, but it's used in many places. So maybe you should keep that.\n\nI think it is quite safe to replace the `return None` in all `_act_on_` (there are only 11 occurrences) by a `NotImplementedError` or similar. Usually they should not be called as the coercion model determines in a different way if there is an action; it is called only when computing the actual value. Thus, if \"accidentally\" called, at least the error appears.",
    "created_at": "2017-03-14T13:06:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310498",
    "user": "dkrenn"
}
```

Replying to [comment:4 jdemeyer]:
> Replying to [comment:1 dkrenn]:
> > Replying to [ticket:22573 jdemeyer]:
> > > I traced this to
> > > {{{
> > > sage: (1/2)._act_on_([1,2,3], False)
> > > }}}
> > > which uses the default implementation of `_act_on_` from `src/sage/structure/element.pyx`:
> > > {{{
> > > #!python
> > >     cpdef _act_on_(self, x, bint self_on_left):
> > >         """
> > >         Use this method to implement ``self`` acting on ``x``.
> > > 
> > >         Return None or raise a CoercionException if no
> > >         such action is defined here.
> > >         """
> > >         return None
> > > }}}
> > 
> > When I see this correctly, this is does not cause the problem.
> 
> Yes, maybe you are right. The problem is that not all places calling `_act_on_` check for `None`. I still think that the `return None` convention is fragile, but it's used in many places. So maybe you should keep that.

I think it is quite safe to replace the `return None` in all `_act_on_` (there are only 11 occurrences) by a `NotImplementedError` or similar. Usually they should not be called as the coercion model determines in a different way if there is an action; it is called only when computing the actual value. Thus, if "accidentally" called, at least the error appears.



---

archive/issue_comments_310499.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> New commits:\n> ||[e18c726](https://git.sagemath.org/sage.git/commit?id=e18c726d30af85869e56778c1192277858499180)||`Only invert an action if it is invertible`||\n\n\n```\n-            else:\n-                K = G._pseudo_fraction_field()\n-                Action.__init__(self, K, action.underlying_set(), action._is_left)\n-                self._action = action\n-                return\n```\n\nI am not convinced that this is a good solution. Overall, the coercion model correctly determines the way to deal with the situation in general, but in our particular example, there simply is no such action implemented. Deleting the code above prevents finding such an action at all, which is also not good.",
    "created_at": "2017-03-14T13:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310499",
    "user": "dkrenn"
}
```

Replying to [comment:7 jdemeyer]:
> New commits:
> ||[e18c726](https://git.sagemath.org/sage.git/commit?id=e18c726d30af85869e56778c1192277858499180)||`Only invert an action if it is invertible`||


```
-            else:
-                K = G._pseudo_fraction_field()
-                Action.__init__(self, K, action.underlying_set(), action._is_left)
-                self._action = action
-                return
```

I am not convinced that this is a good solution. Overall, the coercion model correctly determines the way to deal with the situation in general, but in our particular example, there simply is no such action implemented. Deleting the code above prevents finding such an action at all, which is also not good.



---

archive/issue_comments_310500.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2017-03-14T13:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310500",
    "user": "dkrenn"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_310501.json:
```json
{
    "body": "Replying to [comment:10 dkrenn]:\n> Replying to [comment:7 jdemeyer]:\n> > New commits:\n> > ||[e18c726](https://git.sagemath.org/sage.git/commit?id=e18c726d30af85869e56778c1192277858499180)||`Only invert an action if it is invertible`||\n> \n> {{{\n> -            else:\n> -                K = G._pseudo_fraction_field()\n> -                Action.__init__(self, K, action.underlying_set(), action._is_left)\n> -                self._action = action\n> -                return\n> }}}\n> I am not convinced that this is a good solution. Overall, the coercion model correctly determines the way to deal with the situation in general, but in our particular example, there simply is no such action implemented. Deleting the code above prevents finding such an action at all, which is also not good.\n\nMaybe something along the lines of\n\n```\ncm = sage.structure.element.get_coercion_model()\naction = cm.get_action(K, action.underlying_set(), operator.mul)\nif action is not None:\n    self._action = action\n    ...\n```\n\ncould do it, but I am not sure, if it is intended to call `get_action`, etc. at this level (in the action-class itself). And I am very doubtful about `operator.mul` as at the level of the action-class, everything is somehow independent of the operator.",
    "created_at": "2017-03-14T13:15:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310501",
    "user": "dkrenn"
}
```

Replying to [comment:10 dkrenn]:
> Replying to [comment:7 jdemeyer]:
> > New commits:
> > ||[e18c726](https://git.sagemath.org/sage.git/commit?id=e18c726d30af85869e56778c1192277858499180)||`Only invert an action if it is invertible`||
> 
> {{{
> -            else:
> -                K = G._pseudo_fraction_field()
> -                Action.__init__(self, K, action.underlying_set(), action._is_left)
> -                self._action = action
> -                return
> }}}
> I am not convinced that this is a good solution. Overall, the coercion model correctly determines the way to deal with the situation in general, but in our particular example, there simply is no such action implemented. Deleting the code above prevents finding such an action at all, which is also not good.

Maybe something along the lines of

```
cm = sage.structure.element.get_coercion_model()
action = cm.get_action(K, action.underlying_set(), operator.mul)
if action is not None:
    self._action = action
    ...
```

could do it, but I am not sure, if it is intended to call `get_action`, etc. at this level (in the action-class itself). And I am very doubtful about `operator.mul` as at the level of the action-class, everything is somehow independent of the operator.



---

archive/issue_comments_310502.json:
```json
{
    "body": "Replying to [comment:10 dkrenn]:\n> Overall, the coercion model correctly determines the way to deal with the situation in general\n\nI don't agree with this. The code is assuming that, if there is an action of ZZ on X, there is also an action of QQ on X. There is no reason at all in general why that should be the case. Instead, it should start from an action of QQ on X and then invert that (which is what the already-existing code in the coercion model does).",
    "created_at": "2017-03-14T14:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310502",
    "user": "jdemeyer"
}
```

Replying to [comment:10 dkrenn]:
> Overall, the coercion model correctly determines the way to deal with the situation in general

I don't agree with this. The code is assuming that, if there is an action of ZZ on X, there is also an action of QQ on X. There is no reason at all in general why that should be the case. Instead, it should start from an action of QQ on X and then invert that (which is what the already-existing code in the coercion model does).



---

archive/issue_comments_310503.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-03-14T14:10:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310503",
    "user": "jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_310504.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> Replying to [comment:10 dkrenn]:\n> > Overall, the coercion model correctly determines the way to deal with the situation in general\n> \n> I don't agree with this. The code is assuming that, if there is an action of ZZ on X, there is also an action of QQ on X. There is no reason at all in general why that should be the case. Instead, it should start from an action of QQ on X and then invert that (which is what the already-existing code in the coercion model does).\n\nThis was formulated too unprecise of me, sorry. What I meant is, that the coercion model is at the moment able to discover an action, if it exists (but maybe discovers one that does not exist as no implentation or math-sense). By your changes, you eliminate the discovering of this situation at all (also if there would be an action of `QQ` (or `K`). Thus I suggest to search for the action at this point more carefully; I am just not sure how to do this correctly.",
    "created_at": "2017-03-14T14:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310504",
    "user": "dkrenn"
}
```

Replying to [comment:12 jdemeyer]:
> Replying to [comment:10 dkrenn]:
> > Overall, the coercion model correctly determines the way to deal with the situation in general
> 
> I don't agree with this. The code is assuming that, if there is an action of ZZ on X, there is also an action of QQ on X. There is no reason at all in general why that should be the case. Instead, it should start from an action of QQ on X and then invert that (which is what the already-existing code in the coercion model does).

This was formulated too unprecise of me, sorry. What I meant is, that the coercion model is at the moment able to discover an action, if it exists (but maybe discovers one that does not exist as no implentation or math-sense). By your changes, you eliminate the discovering of this situation at all (also if there would be an action of `QQ` (or `K`). Thus I suggest to search for the action at this point more carefully; I am just not sure how to do this correctly.



---

archive/issue_comments_310505.json:
```json
{
    "body": "Replying to [comment:14 dkrenn]:\n> By your changes, you eliminate the discovering of this situation at all\n\nOf course I do, because it is the right thing to do.\n\nIf I want an action of QQ on X, there is no point in looking for an action of ZZ on X. Because even if an action of ZZ on X exists, it does not imply that there is an action of QQ on X.\n\nNote that the code in the coercion model already looks for an action from the fraction field:\n\n```python\n        if op is div:\n            # Division on right is the same acting on right by inverse, if it is so defined.\n            right_mul = None\n            try:\n                right_mul = self.get_action(R, S, mul)\n            except NotImplementedError:\n                self._record_exception()\n\n            if right_mul is not None and not right_mul.is_left():\n                try:\n                    action = ~right_mul\n                    if action.right_domain() != S:\n                        action = PrecomposedAction(action, None,\n                                                   action.right_domain()._internal_coerce_map_from(S))\n                    return action\n                except TypeError: # action may not be invertible\n                    self._record_exception()\n\n            # It's possible an action is defined on the fraction field itself.\n            try:\n                K = S._pseudo_fraction_field()\n            except AttributeError:\n                pass\n            else:\n                if K is not S:\n                    try:\n                        right_mul = self.get_action(R, K, mul)\n                    except NotImplementedError:\n                        self._record_exception()\n\n                    if right_mul is not None and not right_mul.is_left():\n                        try:\n                            return PrecomposedAction(~right_mul, None, K.coerce_map_from(S))\n                        except TypeError: # action may not be invertible\n                            self._record_exception()\n```\n",
    "created_at": "2017-03-14T14:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310505",
    "user": "jdemeyer"
}
```

Replying to [comment:14 dkrenn]:
> By your changes, you eliminate the discovering of this situation at all

Of course I do, because it is the right thing to do.

If I want an action of QQ on X, there is no point in looking for an action of ZZ on X. Because even if an action of ZZ on X exists, it does not imply that there is an action of QQ on X.

Note that the code in the coercion model already looks for an action from the fraction field:

```python
        if op is div:
            # Division on right is the same acting on right by inverse, if it is so defined.
            right_mul = None
            try:
                right_mul = self.get_action(R, S, mul)
            except NotImplementedError:
                self._record_exception()

            if right_mul is not None and not right_mul.is_left():
                try:
                    action = ~right_mul
                    if action.right_domain() != S:
                        action = PrecomposedAction(action, None,
                                                   action.right_domain()._internal_coerce_map_from(S))
                    return action
                except TypeError: # action may not be invertible
                    self._record_exception()

            # It's possible an action is defined on the fraction field itself.
            try:
                K = S._pseudo_fraction_field()
            except AttributeError:
                pass
            else:
                if K is not S:
                    try:
                        right_mul = self.get_action(R, K, mul)
                    except NotImplementedError:
                        self._record_exception()

                    if right_mul is not None and not right_mul.is_left():
                        try:
                            return PrecomposedAction(~right_mul, None, K.coerce_map_from(S))
                        except TypeError: # action may not be invertible
                            self._record_exception()
```




---

archive/issue_comments_310506.json:
```json
{
    "body": "Replying to [comment:15 jdemeyer]:\n> Replying to [comment:14 dkrenn]:\n> > By your changes, you eliminate the discovering of this situation at all\n> \n> Of course I do, because it is the right thing to do.\n> \n> If I want an action of QQ on X, there is no point in looking for an action of ZZ on X. Because even if an action of ZZ on X exists, it does not imply that there is an action of QQ on X.\n> \n> Note that the code in the coercion model already looks for an action from the fraction field: [...]\n\nOk, I see. Sorry for the noise. Patch is good then. (modulo patchbot; I'd be happy to put it (back) to positive review once the patchbot agrees).",
    "created_at": "2017-03-14T14:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310506",
    "user": "dkrenn"
}
```

Replying to [comment:15 jdemeyer]:
> Replying to [comment:14 dkrenn]:
> > By your changes, you eliminate the discovering of this situation at all
> 
> Of course I do, because it is the right thing to do.
> 
> If I want an action of QQ on X, there is no point in looking for an action of ZZ on X. Because even if an action of ZZ on X exists, it does not imply that there is an action of QQ on X.
> 
> Note that the code in the coercion model already looks for an action from the fraction field: [...]

Ok, I see. Sorry for the noise. Patch is good then. (modulo patchbot; I'd be happy to put it (back) to positive review once the patchbot agrees).



---

archive/issue_comments_310507.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-14T16:12:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310507",
    "user": "saraedum"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_310508.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-14T16:16:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310508",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310509.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:41:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22336",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22336#issuecomment-310509",
    "user": "vbraun"
}
```

Resolution: fixed
