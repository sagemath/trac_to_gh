# Issue 22685: Faster implementation of LLT polynomials

Issue created by migration from https://trac.sagemath.org/ticket/22922

Original creator: wpoh

Original creation time: 2017-05-01 19:38:44

CC:  mariamonks tscrim aschilling saliola phubert

Keywords: LLT polynomials

This ticket implements the LLT polynomials via the inv statistic.


---

Comment by aschilling created at 2017-06-10 00:45:02

Hi Wencin,

Thank you for working on this feature! You need to stick to the Sage coding conventions to get your code into Sage, see http://doc.sagemath.org/html/en/developer/coding_basics.html

In particular, you need a one sentence description of each method, followed by a longer description and INPUT and OUTPUT. But most importantly, you need

```
EXAMPLES::

    sage: Sym = SymmetricFunction(QQ)
    sage: LLT = Sym.llt(3)
```

etc which shows how to use the code and what output is expected. This serves also as tests that are run and checked with every new release, so this part is very important!

It would also be good if your code was integrated into the symmetric function setup, so that it can eventually used from there and replace the current implementation (if it is indeed correct and faster than the current implementation).

Anne


---

Comment by aschilling created at 2017-08-21 16:21:31

Changing keywords from "LLT polynomials" to "LLT polynomials, days88, IMA coding sprints".


---

Comment by git created at 2017-09-14 04:11:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wpoh created at 2017-09-14 04:44:24

Hi Anne, Franco and Maria,

I have just pushed the latest version of the code that computes the LLT polynomial using the inversion statistic. It has now been integrated in llt.py and no longer depends on the length of alphabet x_1,x_2,x_3,... Kindly take a look, try it out, or let me know if there are areas that could be improved.

Best regards, 
Wencin


---

Comment by aschilling created at 2017-09-14 04:46:06

Hi Wencin,

Thank you! Could you please also post your timings of the new code compared to the old code?

Anne


---

Attachment

Running times for computing LLT polynomials based on tuples of partitions for up to a sequence of 3 partitions, with partition sizes at most 3. Timings are reported with existing implementation in Sage first, followed by the proposed implementation, based on the timeit command.


---

Comment by wpoh created at 2017-09-15 05:17:05

Hi Anne,

I have just attached a list of the running times with the running time for the existing implementation listed first, followed by the proposed one. Here are some selected examples:


```
sage: Sym = SymmetricFunctions(FractionField(QQ['t']))
sage: L = Sym.llt(3)
sage: timeit("g1 = L.cospin([[3],[3],[3]])")
5 loops, best of 3: 6.09 s per loop
sage: timeit("g2 = L.llt_inv([[3],[3],[3]])")
5 loops, best of 3: 5.94 s per loop
```



```
sage: Sym = SymmetricFunctions(FractionField(QQ['t']))
sage: L = Sym.llt(3)
sage: timeit("g1 = L.cospin([[1,1,1],[1,1,1],[1,1,1]])")
5 loops, best of 3: 3.26 s per loop
sage: timeit("g2 = L.llt_inv([[1,1,1],[1,1,1],[1,1,1]])")
5 loops, best of 3: 3.58 s per loop
```



```
sage: Sym = SymmetricFunctions(FractionField(QQ['t']))
sage: L = Sym.llt(3)
sage: timeit("g1 = L.cospin([[2,1],[1,1],[2,1]])")
5 loops, best of 3: 4.76 s per loop
sage: timeit("g2 = L.llt_inv([[2,1],[1,1],[2,1]])")
5 loops, best of 3: 2.98 s per loop
```



```
sage: Sym = SymmetricFunctions(FractionField(QQ['t']))
sage: L = Sym.llt(3)
sage: timeit("g1 = L.cospin([[],[],[]])")
625 loops, best of 3: 354 Âµs per loop
sage: timeit("g2 = L.llt_inv([[],[],[]])")
125 loops, best of 3: 3.66 ms per loop
```


Best regards,
Wencin


---

Comment by aschilling created at 2017-09-15 05:45:17

Hi Wencin,

Thank you for the timings. However, I am a little confused about the diff file for your branch. I was expecting to see just a new method in the file sage/combinat/sf/llt.py. Instead it looks like you put a new file called llt.py in the root of sage (plus some other new files). I suggest that you remove these files for the ticket and instead replace the file sage/combinat/sf/llt.py with your new version. Otherwise the commands

```
sage: Sym = SymmetricFunctions(FractionField(QQ['t']))
sage: L = Sym.llt(3)
L.llt_inv([[],[],[]])
```

do not actually work.

Thank you,

Anne


---

Comment by git created at 2017-09-21 04:17:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-24 04:32:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-24 04:43:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-09-24 16:51:18

Something else you might be interested in for profiling code is `%lprun`:

http://doc.sagemath.org/html/en/thematic_tutorials/profiling.html#python-level-line-by-line-profiling-lprun


```
sage: R = algebras.Schur(QQ, 4, 2)
sage: x = R.an_element()
sage: %lprun -f R.product_on_basis x * x
```

You can also simultaneously profile multiple functions by adding an extra `-f function_name`.


---

Comment by tscrim created at 2017-10-08 01:33:35

I did some old-school optimization of the current LLT polynomials. Since Wencin and Anne noticed that the current version uses the same mathematical algorithm as Wencin's newer version, we decided to focus more on doing the current improvements. This also includes some improvements to partitions. We now get

```
sage: L = SymmetricFunctions(FractionField(QQ['t'])).llt(3)
sage: %timeit g1 = L.cospin([[1,1,1],[1,1,1],[1,1,1]])
1 loop, best of 3: 853 ms per loop
sage: %timeit g1 = L.cospin([[3],[3],[3]])
1 loop, best of 3: 2.05 s per loop
sage: L = SymmetricFunctions(FractionField(QQ['t'])).llt(4)
sage: %timeit g1 = L.cospin([[1,1],[3],[1],[2,1]])
1 loop, best of 3: 10.1 s per loop
```

versus the old

```
sage: L = SymmetricFunctions(FractionField(QQ['t'])).llt(3)
sage: %timeit g1 = L.cospin([[1,1,1],[1,1,1],[1,1,1]])
1 loop, best of 3: 2.69 s per loop
sage: %timeit g1 = L.cospin([[3],[3],[3]])
1 loop, best of 3: 5.13 s per loop
sage: L = SymmetricFunctions(FractionField(QQ['t'])).llt(4)
sage: %timeit g1 = L.cospin([[1,1],[3],[1],[2,1]])
1 loop, best of 3: 24.4 s per loop
```


I did also do some optimizations to Wencin's code, which is available on this branch:

```
public/combinat/faster_llt_polynomials-old
```

However, it was only around a 10-15% improvement.
----
New commits:


---

Comment by tscrim created at 2017-10-08 01:33:35

Changing status from new to needs_review.


---

Comment by aschilling created at 2017-10-08 04:18:27

Changing status from needs_review to needs_work.


---

Comment by aschilling created at 2017-10-08 04:19:14

There is a doctest failure in integer_matrices.py

```
sage -t integer_matrices.py
**********************************************************************
File "integer_matrices.py", line 219, in sage.combinat.integer_matrices.IntegerMatrices.cardinality
Failed example:
    len(IntegerMatrices([0], [0]).list())
Exception raised:
    Traceback (most recent call last):
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.integer_matrices.IntegerMatrices.cardinality[11]>", line 1, in <module>
        len(IntegerMatrices([Integer(0)], [Integer(0)]).list())
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/categories/finite_enumerated_sets.py", line 255, in list
        return self._list_from_iterator()
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/categories/finite_enumerated_sets.py", line 359, in _list_from_iterator
        result = list(self.__iter__())
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/combinat/integer_matrices.py", line 139, in __iter__
        yield matrix(ZZ, x)
      File "sage/matrix/constructor.pyx", line 797, in sage.matrix.constructor.MatrixFactory.__call__ (build/cythonized/sage/matrix/constructor.c:7281)
        return MatrixSpace(ring, nrows, ncols, sparse=sparse)(entries)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 554, in __call__
        return self.matrix(entries, coerce, copy)
      File "/Applications/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py", line 1563, in matrix
        return MC(self, x, copy=copy, coerce=coerce)
      File "sage/matrix/matrix_integer_dense.pyx", line 367, in sage.matrix.matrix_integer_dense.Matrix_integer_dense.__init__ (build/cythonized/sage/matrix/matrix_integer_dense.c:7156)
        x = ZZ(entries_list[k])
      File "sage/structure/parent.pyx", line 940, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9573)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 154, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4919)
        raise
      File "sage/structure/coerce_maps.pyx", line 149, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4781)
        return C._element_constructor(x)
      File "sage/rings/integer.pyx", line 721, in sage.rings.integer.Integer.__init__ (build/cythonized/sage/rings/integer.c:6673)
        raise TypeError("unable to coerce %s to an integer" % type(x))
    TypeError: unable to coerce <class 'sage.combinat.composition.Compositions_all_with_category.element_class'> to an integer
**********************************************************************
1 item had failures:
   1 of  13 in sage.combinat.integer_matrices.IntegerMatrices.cardinality
    [51 tests, 1 failure, 0.79 s]
----------------------------------------------------------------------
sage -t integer_matrices.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.8 seconds
    cpu time: 0.8 seconds
    cumulative wall time: 0.8 seconds
```



---

Comment by git created at 2017-10-08 07:52:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-10-08 07:54:41

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-10-08 07:54:41

This should fix it. There was a case that was missed that was not returning a list of a list.


---

Comment by aschilling created at 2017-10-08 17:23:45

Thank you! I can confirm that the new code gives a factor 2-3 speed up over the old version.


---

Comment by aschilling created at 2017-10-08 17:24:04

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-16 22:44:46

Resolution: fixed
