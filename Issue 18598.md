# Issue 18598: Fix #18691 fix to #17572 fix to R.

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2015-07-01 13:38:07

Keywords: r-project

#18691 is broken on fresh install because the `sage-env}} script is invoked at a point where {{{$DOT_SAGE` does not exist yet.


---

Comment by kcrisman created at 2015-07-01 13:54:21

Changing priority, just change back if I misunderstand the severity of the problem.


---

Comment by kcrisman created at 2015-07-01 13:54:21

Changing priority from major to blocker.


---

Comment by jdemeyer created at 2015-07-01 14:17:20

Should this

```
if [ -d "$SAGE_LOCAL" ] ; then
    R_MAKEVARS_SITE="$SAGE_LOCAL/lib/R/share/Makevars.site" && export R_MAKEVARS_SITE
```

be

```
if [ -d "$SAGE_LOCAL/lib/R/share" ] ; then
    export R_MAKEVARS_SITE="$SAGE_LOCAL/lib/R/share/Makevars.site"
```

----
New commits:


---

Comment by charpent created at 2015-07-01 14:26:01

Jeroen : I'm afraid you mixed this ticket with #18820. I do not understand what the hell `9a9c4cc`, `769fc49` and `b46fa1a`, which belong to #18820, are doing in the present #18835.

Please tell me how to undo this mess...


---

Comment by jdemeyer created at 2015-07-01 14:30:36

Replying to [comment:5 charpent]:
> Jeroen : I'm afraid you mixed this ticket with #18820.
*I* didn't do anything, I just made a comment...

> Please tell me how to undo this mess...
Just cherry-pick the relevant commit on top of #18691.


---

Comment by jhpalmieri created at 2015-07-01 15:10:06

Changing priority from blocker to minor.


---

Comment by jhpalmieri created at 2015-07-01 15:10:06

I lowered the priority. The build is not broken, but a needless error message is (prominently) displayed when building from scratch.


---

Comment by jhpalmieri created at 2015-07-01 15:12:04

I know this is not marked as needing review yet, but the proposed change

```
if [ -d "$SAGE_LOCAL" ] ; then
```

is not good enough: you need to check whether the directory `$SAGE_LOCAL/lib/R/share` exists before doing `echo foo > "$R_MAKEVARS_SITE"`.


---

Comment by charpent created at 2015-07-01 15:14:58

I managed to hose my branch. I still have to learn how to revert certain commits.

Stay tuned (but not until tomorrow or  late tonight). And accept my apologies.

Emmanuel Charpentier


---

Comment by kcrisman created at 2015-07-01 16:48:04

> I lowered the priority. The build is not broken, but a needless error message is (prominently) displayed when building from scratch.
Got it!  Thanks for clarifying.


---

Comment by git created at 2015-07-02 05:07:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-02 05:13:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2015-07-02 05:17:05

Changing status from new to needs_review.


---

Comment by charpent created at 2015-07-02 05:17:05

Reading the `git` doc was ... instructive ...

This one seems good (builds from `make distclean` without error and passes all tests of `make ptestlong`  `==> needs_review`.


---

Comment by jdemeyer created at 2015-07-02 07:04:36

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-07-02 07:04:36

I think `git` might get confused when merging this...

Please just *remove* the bad commits instead of reverting them.


---

Comment by charpent created at 2015-07-02 07:05:52

Replying to [comment:14 jdemeyer]:
> I think `git` might get confused when merging this...
> 
> Please just *remove* the bad commits instead of reverting them.

How do you do that ?


---

Comment by jdemeyer created at 2015-07-02 07:54:35

There are many possibilities, I guess

```
git rebase -i
```

would be the easiest. Then you can edit, squash, remove, reorder commits...

Of course, this qualifies as "rewriting history" which is something you normally should not do for a ticket under review. However, in this case, it is the best solution.


---

Comment by git created at 2015-07-02 12:01:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by charpent created at 2015-07-02 12:09:17

Done. I learned something useful. `needs_review`, again.

However, something worries me. I've read again and again and again (in the Developer's guide, on `sage-devel` threads, on various ticket brawls...err...discussions) thar "rewriting history" was, //a priori// a bad idea. I suppose that, in the present case, it is admissible because nobody has yet merged this contribution in anything else. Is this correct ?

Update : this, on top of 6.8beta6, builds with no errors and passes testlong successfully


---

Comment by charpent created at 2015-07-02 12:09:17

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2015-07-03 17:32:46

Update : on top of 6.8beta7, this gives one ptestlong failure :


```
----------------------------------------------------------------------
sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py  # 2 doctests failed
----------------------------------------------------------------------
```


However, this doctest passes standalone :


```
charpent`@`asus16-ec:/usr/local/sage-6.8$ sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py
Running doctests with ID 2015-07-03-19-21-20-3619480c.
Git branch: mabranche
Using --optional=mpir,python2,sage,scons
Doctesting 1 file.
sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py
    [69 tests, 0.23 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.3 seconds
    cpu time: 0.2 seconds
    cumulative wall time: 0.2 seconds
```


So I think it's a glitch possibly due to high load.

Still `needs_review`


---

Comment by jhpalmieri created at 2015-07-03 17:39:42

I get the same doctest failure in plain 6.8.beta7. I don't think it's related to this ticket.


---

Comment by jhpalmieri created at 2015-07-03 21:57:05

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2015-07-03 21:57:05

This looks good to me now.


---

Comment by vbraun created at 2015-07-04 08:19:55

Resolution: fixed
