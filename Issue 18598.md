# Issue 18598: Fix #18691 fix to #17572 fix to R.

archive/issues_018598.json:
```json
{
    "body": "Keywords: r-project\n\n#18691 is broken on fresh install because the `sage-env}} script is invoked at a point where {{{$DOT_SAGE` does not exist yet.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18835\n\n",
    "created_at": "2015-07-01T13:38:07Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Fix #18691 fix to #17572 fix to R.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18598",
    "user": "charpent"
}
```
Keywords: r-project

#18691 is broken on fresh install because the `sage-env}} script is invoked at a point where {{{$DOT_SAGE` does not exist yet.

Issue created by migration from https://trac.sagemath.org/ticket/18835





---

archive/issue_comments_253059.json:
```json
{
    "body": "Changing priority, just change back if I misunderstand the severity of the problem.",
    "created_at": "2015-07-01T13:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253059",
    "user": "kcrisman"
}
```

Changing priority, just change back if I misunderstand the severity of the problem.



---

archive/issue_comments_253060.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2015-07-01T13:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253060",
    "user": "kcrisman"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_253061.json:
```json
{
    "body": "Should this\n\n```\nif [ -d \"$SAGE_LOCAL\" ] ; then\n    R_MAKEVARS_SITE=\"$SAGE_LOCAL/lib/R/share/Makevars.site\" && export R_MAKEVARS_SITE\n```\n\nbe\n\n```\nif [ -d \"$SAGE_LOCAL/lib/R/share\" ] ; then\n    export R_MAKEVARS_SITE=\"$SAGE_LOCAL/lib/R/share/Makevars.site\"\n```\n\n----\nNew commits:",
    "created_at": "2015-07-01T14:17:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253061",
    "user": "jdemeyer"
}
```

Should this

```
if [ -d "$SAGE_LOCAL" ] ; then
    R_MAKEVARS_SITE="$SAGE_LOCAL/lib/R/share/Makevars.site" && export R_MAKEVARS_SITE
```

be

```
if [ -d "$SAGE_LOCAL/lib/R/share" ] ; then
    export R_MAKEVARS_SITE="$SAGE_LOCAL/lib/R/share/Makevars.site"
```

----
New commits:



---

archive/issue_comments_253062.json:
```json
{
    "body": "Jeroen : I'm afraid you mixed this ticket with #18820. I do not understand what the hell `9a9c4cc`, `769fc49` and `b46fa1a`, which belong to #18820, are doing in the present #18835.\n\nPlease tell me how to undo this mess...",
    "created_at": "2015-07-01T14:26:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253062",
    "user": "charpent"
}
```

Jeroen : I'm afraid you mixed this ticket with #18820. I do not understand what the hell `9a9c4cc`, `769fc49` and `b46fa1a`, which belong to #18820, are doing in the present #18835.

Please tell me how to undo this mess...



---

archive/issue_comments_253063.json:
```json
{
    "body": "Replying to [comment:5 charpent]:\n> Jeroen : I'm afraid you mixed this ticket with #18820.\n**I** didn't do anything, I just made a comment...\n\n> Please tell me how to undo this mess...\nJust cherry-pick the relevant commit on top of #18691.",
    "created_at": "2015-07-01T14:30:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253063",
    "user": "jdemeyer"
}
```

Replying to [comment:5 charpent]:
> Jeroen : I'm afraid you mixed this ticket with #18820.
**I** didn't do anything, I just made a comment...

> Please tell me how to undo this mess...
Just cherry-pick the relevant commit on top of #18691.



---

archive/issue_comments_253064.json:
```json
{
    "body": "Changing priority from blocker to minor.",
    "created_at": "2015-07-01T15:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253064",
    "user": "jhpalmieri"
}
```

Changing priority from blocker to minor.



---

archive/issue_comments_253065.json:
```json
{
    "body": "I lowered the priority. The build is not broken, but a needless error message is (prominently) displayed when building from scratch.",
    "created_at": "2015-07-01T15:10:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253065",
    "user": "jhpalmieri"
}
```

I lowered the priority. The build is not broken, but a needless error message is (prominently) displayed when building from scratch.



---

archive/issue_comments_253066.json:
```json
{
    "body": "I know this is not marked as needing review yet, but the proposed change\n\n```\nif [ -d \"$SAGE_LOCAL\" ] ; then\n```\n\nis not good enough: you need to check whether the directory `$SAGE_LOCAL/lib/R/share` exists before doing `echo foo > \"$R_MAKEVARS_SITE\"`.",
    "created_at": "2015-07-01T15:12:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253066",
    "user": "jhpalmieri"
}
```

I know this is not marked as needing review yet, but the proposed change

```
if [ -d "$SAGE_LOCAL" ] ; then
```

is not good enough: you need to check whether the directory `$SAGE_LOCAL/lib/R/share` exists before doing `echo foo > "$R_MAKEVARS_SITE"`.



---

archive/issue_comments_253067.json:
```json
{
    "body": "I managed to hose my branch. I still have to learn how to revert certain commits.\n\nStay tuned (but not until tomorrow or  late tonight). And accept my apologies.\n\nEmmanuel Charpentier",
    "created_at": "2015-07-01T15:14:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253067",
    "user": "charpent"
}
```

I managed to hose my branch. I still have to learn how to revert certain commits.

Stay tuned (but not until tomorrow or  late tonight). And accept my apologies.

Emmanuel Charpentier



---

archive/issue_comments_253068.json:
```json
{
    "body": "> I lowered the priority. The build is not broken, but a needless error message is (prominently) displayed when building from scratch.\nGot it!  Thanks for clarifying.",
    "created_at": "2015-07-01T16:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253068",
    "user": "kcrisman"
}
```

> I lowered the priority. The build is not broken, but a needless error message is (prominently) displayed when building from scratch.
Got it!  Thanks for clarifying.



---

archive/issue_comments_253069.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-02T05:07:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253069",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253070.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-07-02T05:13:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253070",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_253071.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-07-02T05:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253071",
    "user": "charpent"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_253072.json:
```json
{
    "body": "Reading the `git` doc was ... instructive ...\n\nThis one seems good (builds from `make distclean` without error and passes all tests of `make ptestlong`  `==> needs_review`.",
    "created_at": "2015-07-02T05:17:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253072",
    "user": "charpent"
}
```

Reading the `git` doc was ... instructive ...

This one seems good (builds from `make distclean` without error and passes all tests of `make ptestlong`  `==> needs_review`.



---

archive/issue_comments_253073.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-07-02T07:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253073",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_253074.json:
```json
{
    "body": "I think `git` might get confused when merging this...\n\nPlease just **remove** the bad commits instead of reverting them.",
    "created_at": "2015-07-02T07:04:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253074",
    "user": "jdemeyer"
}
```

I think `git` might get confused when merging this...

Please just **remove** the bad commits instead of reverting them.



---

archive/issue_comments_253075.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> I think `git` might get confused when merging this...\n> \n> Please just **remove** the bad commits instead of reverting them.\n\nHow do you do that ?",
    "created_at": "2015-07-02T07:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253075",
    "user": "charpent"
}
```

Replying to [comment:14 jdemeyer]:
> I think `git` might get confused when merging this...
> 
> Please just **remove** the bad commits instead of reverting them.

How do you do that ?



---

archive/issue_comments_253076.json:
```json
{
    "body": "There are many possibilities, I guess\n\n```\ngit rebase -i\n```\n\nwould be the easiest. Then you can edit, squash, remove, reorder commits...\n\nOf course, this qualifies as \"rewriting history\" which is something you normally should not do for a ticket under review. However, in this case, it is the best solution.",
    "created_at": "2015-07-02T07:54:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253076",
    "user": "jdemeyer"
}
```

There are many possibilities, I guess

```
git rebase -i
```

would be the easiest. Then you can edit, squash, remove, reorder commits...

Of course, this qualifies as "rewriting history" which is something you normally should not do for a ticket under review. However, in this case, it is the best solution.



---

archive/issue_comments_253077.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-07-02T12:01:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253077",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_253078.json:
```json
{
    "body": "Done. I learned something useful. `needs_review`, again.\n\nHowever, something worries me. I've read again and again and again (in the Developer's guide, on `sage-devel` threads, on various ticket brawls...err...discussions) thar \"rewriting history\" was, //a priori// a bad idea. I suppose that, in the present case, it is admissible because nobody has yet merged this contribution in anything else. Is this correct ?\n\nUpdate : this, on top of 6.8beta6, builds with no errors and passes testlong successfully",
    "created_at": "2015-07-02T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253078",
    "user": "charpent"
}
```

Done. I learned something useful. `needs_review`, again.

However, something worries me. I've read again and again and again (in the Developer's guide, on `sage-devel` threads, on various ticket brawls...err...discussions) thar "rewriting history" was, //a priori// a bad idea. I suppose that, in the present case, it is admissible because nobody has yet merged this contribution in anything else. Is this correct ?

Update : this, on top of 6.8beta6, builds with no errors and passes testlong successfully



---

archive/issue_comments_253079.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-07-02T12:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253079",
    "user": "charpent"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_253080.json:
```json
{
    "body": "Update : on top of 6.8beta7, this gives one ptestlong failure :\n\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py  # 2 doctests failed\n----------------------------------------------------------------------\n```\n\n\nHowever, this doctest passes standalone :\n\n\n```\ncharpent@asus16-ec:/usr/local/sage-6.8$ sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py\nRunning doctests with ID 2015-07-03-19-21-20-3619480c.\nGit branch: mabranche\nUsing --optional=mpir,python2,sage,scons\nDoctesting 1 file.\nsage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py\n    [69 tests, 0.23 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.3 seconds\n    cpu time: 0.2 seconds\n    cumulative wall time: 0.2 seconds\n```\n\n\nSo I think it's a glitch possibly due to high load.\n\nStill `needs_review`",
    "created_at": "2015-07-03T17:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253080",
    "user": "charpent"
}
```

Update : on top of 6.8beta7, this gives one ptestlong failure :


```
----------------------------------------------------------------------
sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py  # 2 doctests failed
----------------------------------------------------------------------
```


However, this doctest passes standalone :


```
charpent@asus16-ec:/usr/local/sage-6.8$ sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py
Running doctests with ID 2015-07-03-19-21-20-3619480c.
Git branch: mabranche
Using --optional=mpir,python2,sage,scons
Doctesting 1 file.
sage -t --long --warn-long 67.6 src/sage/structure/dynamic_class.py
    [69 tests, 0.23 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.3 seconds
    cpu time: 0.2 seconds
    cumulative wall time: 0.2 seconds
```


So I think it's a glitch possibly due to high load.

Still `needs_review`



---

archive/issue_comments_253081.json:
```json
{
    "body": "I get the same doctest failure in plain 6.8.beta7. I don't think it's related to this ticket.",
    "created_at": "2015-07-03T17:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253081",
    "user": "jhpalmieri"
}
```

I get the same doctest failure in plain 6.8.beta7. I don't think it's related to this ticket.



---

archive/issue_comments_253082.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-07-03T21:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253082",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_253083.json:
```json
{
    "body": "This looks good to me now.",
    "created_at": "2015-07-03T21:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253083",
    "user": "jhpalmieri"
}
```

This looks good to me now.



---

archive/issue_comments_253084.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-07-04T08:19:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18598",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18598#issuecomment-253084",
    "user": "vbraun"
}
```

Resolution: fixed
