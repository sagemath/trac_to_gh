# Issue 13963: UniqueRepresentation using default arguments

Issue created by migration from https://trac.sagemath.org/ticket/14167

Original creator: SimonKing

Original creation time: 2013-02-22 23:56:01

Assignee: jason

CC:  nthiery tscrim nbruin egourgoulhon

Keywords: UniqueRepresentation default arguments

Currently, if the `__init__` method has default arguments, they are not taken into account by `UniqueRepresentation`'s `__classcall__` method. The purpose of this ticket is to implement this.

Hence, with the patch, one has

```
sage: class Test(UniqueRepresentation, Parent):
....:     def __init__(self, a, b=3):
....:         pass
....:     
sage: Test(1) is Test(1,3) is Test(1,b=3)
True
```



---

Attachment


---

Comment by SimonKing created at 2013-02-23 00:27:35

This ticket builds upon #14054, namely it uses the distinction of `UniqueRepresentation` and `CachedRepresentation`.

The idea to make default arguments work is as follows. Let C be a subclass of `CachedRepresentation`, and assume that it overrides `__init__`.

- I changed `weak_chached_function`, so that a function can be passed as an optional parameter from which the argspec is taken.

- `CachedRepresentation.__classcall__` used to be a cached function, stored as an attribute of `CachedRepresentation`. This will still be the case. Of course, `CachedRepresentation` does not know about `C.__init__`. Hence, `CachedRepresentation.__classcall__` has no default arguments.

- However, when the first instance of C is created, then `CachedRepresentation.__classcall__` is called with C. In that moment, `C.__init__` is available. `CachedRepresentation.__classcall__` will then create a new weak_cached_function that uses the argspec of `C.__init__`. This new weak_cached_function will override the cdef attribute `C.classcall`, provided that `C.classcall` is the same as `CachedRepresentation.__classcall__` (hence, a custom `__classcall__` or `__classcall_private__` will be respected). The new weak_cached_function creates, caches and returns the first instance of C.

- When the second instance of C is created, the new weak_cached_function is called, and `CachedRepresentation.__classcall__` is not involved any more.

- Since only `C.classcall` is overridden, but not `C.__classcall__`, it is no problem to subclass C: If D is a subclass of C, then the first instance of D will be created in `CachedRepresentation.__classcall__`, which will override D.classcall, but does not affect C.classcall.

__Smaller changes__

- `ClasscallMetaclass` gets methods `_get_caller_` and `_overload_caller_`, so that one can retrieve or overload C.classcall from a Python module.
- `WeakCachedFunction.__init__` gets a new optional argument `argspec_from`, which is supposed to be a function from which the cached function gets its defaults. `argspec_from` is passed down to the weak cached function's "_argument_fixer`, whose job it is to take care of default arguments.
- In `sage.misc.superseded._check_trac_number`, I remove the import of `is_Integer`. Namely, at least with some preliminary version of the patch, this import used to crash Sage during startup. What we want to know in this function is whether the given trac number is a positive integer. I suggest to do a very similar thing to the default containment test of parents: trac_number is an integer if `int(trac_number)==trac_number` returns True and does not raise an error.
- I use `.. TODO::` and similar directives in a couple of cases.

Needs review, then!


---

Comment by SimonKing created at 2013-02-23 00:27:35

Changing status from new to needs_review.


---

Comment by SimonKing created at 2013-02-23 08:43:02

Changing status from needs_review to needs_info.


---

Comment by SimonKing created at 2013-02-23 08:43:02

OTOH, I think that my original approach is too intrusive.

New ideas, where C is again a subclass of `CachedRepresentation`:

__What we need__

1. Given `C.__init__`, we need a way to "normalise" given arguments `(*args,**kwds)` by taking into account the defaults of `C.__init__`. The result should be a pair of tuples `(Args,Kwds)` such that Args provides all positional arguments available for `C.__init__` (including those provided by name in `(*args,**kwds)`), and Kwds provides the remaining named arguments, sorted by name.
2. The normalised arguments should then be used as cache keys for `type.__call__(C,*args,**kwds)`, in a weak value dictionary.

__How to achieve it__

Normalizing arguments is the job of `sage.misc.function_mangling.ArgumentFixer.fix_to_pos()`. I suggest to define `CachedRepresentation` not by applying the ``@`weak_cached_function` decorator, but to define it in `sage.misc.function_mangling`, which is in Cython and may thus be faster anyway.

There should be a dictionary `arg_fix_dict` of `ArgumentFixer`s, such that `arg_fix_dict[C.__init__]` returns an `ArgumentFixer` for the default arguments of `C.__init__`. This is then used to process the arguments similar to what is done in `sage.misc.cachefunc.CachedFunction.__call__` using a weak value dictionary as cache, and use `typecall` to create new instance of C if it can't be found in the cache.

__Advantages__

I think this approach should be less intrusive, more memory friendly (because only one `ArgumentFixer`s are created for each `C.__init__`, rather than one `WeakCacheFunction`, including an `ArgumentFixer`, for each C), and faster (because we have `CachedRepresentation.__classcall__` defined in Cython).

I'll try to implement the second approach, and then we'll see what is better.


---

Comment by @mjungmath created at 2021-01-24 14:06:00

`cached_method` already provides this feature. I don't know whether this had been added after Sage 5.11. Does this help?


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
