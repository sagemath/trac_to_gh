# Issue 7946: Fix TestSuite failures for schemes

archive/issues_007946.json:
```json
{
    "body": "Consider the following situation:\n\n```\nsage: S = Spec(ZZ)\nsage: x = S.an_element()\n```\nRunning `TestSuite(S)` and `TestSuite(x)` yields several failures.  A related problem is\n\n```\nsage: S\nSpectrum of Integer Ring\nsage: parent(x)\nSet of rational points of Spectrum of Integer Ring\n```\nwhereas we expect `parent(x) is S`.\n\nHere is the complete `TestSuite` report:\n\n```\nsage: TestSuite(S).run()\nFailure in _test_an_element:\nTraceback (most recent call last):\n...\nNotImplementedError\n------------------------------------------------------------\n  Failure in _test_category:\n  Traceback (most recent call last):\n  ...\n  AssertionError: False is not true\n  ------------------------------------------------------------\n  Failure in _test_pickling:\n  Traceback (most recent call last):\n  ...\n  AssertionError: Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring != Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring\n  ------------------------------------------------------------\n  The following tests failed: _test_category, _test_pickling\nFailure in _test_elements\nFailure in _test_some_elements:\nTraceback (most recent call last):\n...\nNotImplementedError\n------------------------------------------------------------\nThe following tests failed: _test_an_element, _test_elements, _test_some_elements\n```\n\n```\nsage: TestSuite(x).run()\nFailure in _test_category:\nTraceback (most recent call last):\n...\nAssertionError: False is not true\n------------------------------------------------------------\nFailure in _test_pickling:\nTraceback (most recent call last):\n...\nAssertionError: Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring != Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring\n------------------------------------------------------------\nThe following tests failed: _test_category, _test_pickling\n```\n\n(Note: the `NotImplementedError` that one gets after applying #16158 is a different one than before.)\n\n\nAssignee: @aghitza\n\nCC:  @vbraun\n\nBranch/Commit: 5fd92eed3024163fa068bea8e3644d677f151adc\n\nReviewer: Travis Scrimshaw\n\nAuthor: Peter Bruin\n\nDependencies: #16158\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/7946\n\n",
    "closed_at": "2014-11-14T21:01:45Z",
    "created_at": "2010-01-16T12:37:52Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Fix TestSuite failures for schemes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/7946",
    "user": "https://github.com/nthiery"
}
```
Consider the following situation:

```
sage: S = Spec(ZZ)
sage: x = S.an_element()
```
Running `TestSuite(S)` and `TestSuite(x)` yields several failures.  A related problem is

```
sage: S
Spectrum of Integer Ring
sage: parent(x)
Set of rational points of Spectrum of Integer Ring
```
whereas we expect `parent(x) is S`.

Here is the complete `TestSuite` report:

```
sage: TestSuite(S).run()
Failure in _test_an_element:
Traceback (most recent call last):
...
NotImplementedError
------------------------------------------------------------
  Failure in _test_category:
  Traceback (most recent call last):
  ...
  AssertionError: False is not true
  ------------------------------------------------------------
  Failure in _test_pickling:
  Traceback (most recent call last):
  ...
  AssertionError: Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring != Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring
  ------------------------------------------------------------
  The following tests failed: _test_category, _test_pickling
Failure in _test_elements
Failure in _test_some_elements:
Traceback (most recent call last):
...
NotImplementedError
------------------------------------------------------------
The following tests failed: _test_an_element, _test_elements, _test_some_elements
```

```
sage: TestSuite(x).run()
Failure in _test_category:
Traceback (most recent call last):
...
AssertionError: False is not true
------------------------------------------------------------
Failure in _test_pickling:
Traceback (most recent call last):
...
AssertionError: Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring != Point on Spectrum of Integer Ring defined by the Principal ideal (991) of Integer Ring
------------------------------------------------------------
The following tests failed: _test_category, _test_pickling
```

(Note: the `NotImplementedError` that one gets after applying #16158 is a different one than before.)


Assignee: @aghitza

CC:  @vbraun

Branch/Commit: 5fd92eed3024163fa068bea8e3644d677f151adc

Reviewer: Travis Scrimshaw

Author: Peter Bruin

Dependencies: #16158

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/7946





---

archive/issue_events_019014.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2010-01-17T22:21:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-4.3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19014"
}
```



---

archive/issue_comments_069206.json:
```json
{
    "body": "<a id='comment:3'></a>#11599 claims to fix this, but I am not entirely sure what would it take to fix this ticket - the reported category is now schemes and only 3 of the `TestSuite` tests fail.",
    "created_at": "2012-02-20T00:36:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69206",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:3'></a>#11599 claims to fix this, but I am not entirely sure what would it take to fix this ticket - the reported category is now schemes and only 3 of the `TestSuite` tests fail.



---

archive/issue_events_019015.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-4.3.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19015"
}
```



---

archive/issue_events_019016.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19016"
}
```



---

archive/issue_events_019017.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19017"
}
```



---

archive/issue_events_019018.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19018"
}
```



---

archive/issue_comments_069207.json:
```json
{
    "body": "<a id='comment:6'></a>What is `Spec` intended to mean in the first place?  The definition currently starts with\n\n```\nclass Spec(AffineScheme):\n    ....\n```\nThis suggests that `Spec` is a special kind of affine scheme.  But aren't \"the spectrum of a ring\" and \"an affine scheme\" exactly the same thing?\n\nThis code probably predates the category framework.  A more modern design would perhaps be something like the following:\n- define the category `AffineSchemes` (or `Schemes().Affine()`) of affine schemes;\n- designate `AffineScheme` as the \"canonical\" type for objects in this category, and move functionality from `Spec` to `AffineScheme` as appropriate;\n- convert `Spec` into a functor from `CommutativeRings` to `AffineSchemes`.\n(Mathematically speaking, Spec [as a functor from commutative rings to schemes, or even locally ringed spaces] can be defined as the adjoint functor of the global sections functor *X* -> *O<sub>X</sub>*(*X*) from schemes to commutative rings, and this gives an anti-equivalence of categories from commutative rings to affine schemes; I wonder if this could somehow be formalised in Sage's category framework, but that's another story...)\n\n[Edit: the above idea is now essentially #16158, although there is no category of affine schemes yet.]",
    "created_at": "2014-04-12T14:23:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69207",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:6'></a>What is `Spec` intended to mean in the first place?  The definition currently starts with

```
class Spec(AffineScheme):
    ....
```
This suggests that `Spec` is a special kind of affine scheme.  But aren't "the spectrum of a ring" and "an affine scheme" exactly the same thing?

This code probably predates the category framework.  A more modern design would perhaps be something like the following:
- define the category `AffineSchemes` (or `Schemes().Affine()`) of affine schemes;
- designate `AffineScheme` as the "canonical" type for objects in this category, and move functionality from `Spec` to `AffineScheme` as appropriate;
- convert `Spec` into a functor from `CommutativeRings` to `AffineSchemes`.
(Mathematically speaking, Spec [as a functor from commutative rings to schemes, or even locally ringed spaces] can be defined as the adjoint functor of the global sections functor *X* -> *O<sub>X</sub>*(*X*) from schemes to commutative rings, and this gives an anti-equivalence of categories from commutative rings to affine schemes; I wonder if this could somehow be formalised in Sage's category framework, but that's another story...)

[Edit: the above idea is now essentially #16158, although there is no category of affine schemes yet.]



---

archive/issue_comments_069208.json:
```json
{
    "body": "<a id='comment:7'></a>To show that the first part of the original ticket is fixed:\n\n```\nsage: S = Spec(ZZ)\nsage: S.category()\nCategory of Schemes\nsage: isinstance(S, S.category().parent_class) \nTrue\n```",
    "created_at": "2014-05-03T15:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69208",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:7'></a>To show that the first part of the original ticket is fixed:

```
sage: S = Spec(ZZ)
sage: S.category()
Category of Schemes
sage: isinstance(S, S.category().parent_class) 
True
```



---

archive/issue_comments_069209.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-03T21:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69209",
    "user": "https://github.com/pjbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_069210.json:
```json
{
    "body": "<a id='comment:8'></a>The attached branch makes affine schemes, and points on them, cooperate better with the category and coercion code.  The `TestSuite` now runs without failures.",
    "created_at": "2014-05-03T21:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69210",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:8'></a>The attached branch makes affine schemes, and points on them, cooperate better with the category and coercion code.  The `TestSuite` now runs without failures.



---

archive/issue_events_019019.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19019"
}
```



---

archive/issue_events_019020.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19020"
}
```



---

archive/issue_events_019021.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19021"
}
```



---

archive/issue_events_019022.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19022"
}
```



---

archive/issue_comments_069211.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:8 pbruin]:\n> The attached branch makes affine schemes, and points on them, cooperate better with the category and coercion code.  The `TestSuite` now runs without failures.\n\n\nIs there some way you can get rid of that custom `__call__` method in `AffineScheme`, or at least passes things up through the `Parent.__call__` when trying to construct an element? If not, then I think we're okay setting this to positive review as it fixes the issues as stated in the ticket description (you can do this on my behalf).\n\nAlso, I think that comment:6 (from the *very* limited understanding I have of the math) is the correct way to do things. However that would be a major overhaul to be done on a separate ticket, and perhaps the above change to `__call__` would fit into that.",
    "created_at": "2014-11-03T07:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69211",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Replying to [comment:8 pbruin]:
> The attached branch makes affine schemes, and points on them, cooperate better with the category and coercion code.  The `TestSuite` now runs without failures.


Is there some way you can get rid of that custom `__call__` method in `AffineScheme`, or at least passes things up through the `Parent.__call__` when trying to construct an element? If not, then I think we're okay setting this to positive review as it fixes the issues as stated in the ticket description (you can do this on my behalf).

Also, I think that comment:6 (from the *very* limited understanding I have of the math) is the correct way to do things. However that would be a major overhaul to be done on a separate ticket, and perhaps the above change to `__call__` would fit into that.



---

archive/issue_comments_069212.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:11 tscrim]:\n> Replying to [comment:8 pbruin]:\n> > The attached branch makes affine schemes, and points on them, cooperate better with the category and coercion code.  The `TestSuite` now runs without failures.\n\n> \n> Is there some way you can get rid of that custom `__call__` method in `AffineScheme`, or at least passes things up through the `Parent.__call__` when trying to construct an element? If not, then I think we're okay setting this to positive review as it fixes the issues as stated in the ticket description (you can do this on my behalf).\n\nThe reason this is done via the `__call__()` method is that an affine scheme *S* accepts two kinds of input; only one of them (input is a prime ideal) constructs an element with *S* as its parent.  In the other case (input is a list of coordinates) the `__call__()` syntax constructs an element of a suitable scheme homset.  I don't see an easy way to avoid a custom `__call__()` method; it may be possible (and would be nice) to get rid of it, but it is better to do this on separate ticket.  (Note also that the `__call__()` method was already present, I just improved it as necessary.)\n> Also, I think that comment:6 (from the *very* limited understanding I have of the math) is the correct way to do things. However that would be a major overhaul to be done on a separate ticket, and perhaps the above change to `__call__` would fit into that.\n\nWhat I was talking about in that comment was mostly done on #16158 (closed a couple of months ago).  I think the remaining issue of making a category `AffineSchemes` would probably be disjoint from getting rid of the `__call__()` method.\n\nI'm setting this to positive review since you gave the green light.",
    "created_at": "2014-11-03T14:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69212",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:12'></a>Replying to [comment:11 tscrim]:
> Replying to [comment:8 pbruin]:
> > The attached branch makes affine schemes, and points on them, cooperate better with the category and coercion code.  The `TestSuite` now runs without failures.

> 
> Is there some way you can get rid of that custom `__call__` method in `AffineScheme`, or at least passes things up through the `Parent.__call__` when trying to construct an element? If not, then I think we're okay setting this to positive review as it fixes the issues as stated in the ticket description (you can do this on my behalf).

The reason this is done via the `__call__()` method is that an affine scheme *S* accepts two kinds of input; only one of them (input is a prime ideal) constructs an element with *S* as its parent.  In the other case (input is a list of coordinates) the `__call__()` syntax constructs an element of a suitable scheme homset.  I don't see an easy way to avoid a custom `__call__()` method; it may be possible (and would be nice) to get rid of it, but it is better to do this on separate ticket.  (Note also that the `__call__()` method was already present, I just improved it as necessary.)
> Also, I think that comment:6 (from the *very* limited understanding I have of the math) is the correct way to do things. However that would be a major overhaul to be done on a separate ticket, and perhaps the above change to `__call__` would fit into that.

What I was talking about in that comment was mostly done on #16158 (closed a couple of months ago).  I think the remaining issue of making a category `AffineSchemes` would probably be disjoint from getting rid of the `__call__()` method.

I'm setting this to positive review since you gave the green light.



---

archive/issue_comments_069213.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-11-03T14:34:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69213",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_069214.json:
```json
{
    "body": "<a id='comment:13'></a>> The reason this is done via the `__call__()` method is that an affine scheme *S* accepts two kinds of input; only one of them (input is a prime ideal) constructs an element with *S* as its parent.  In the other case (input is a list of coordinates) the `__call__()` syntax constructs an element of a suitable scheme homset.  I don't see an easy way to avoid a custom `__call__()` method; it may be possible (and would be nice) to get rid of it, but it is better to do this on separate ticket.  (Note also that the `__call__()` method was already present, I just improved it as necessary.)\n\n\nThat's what I was thinking from a quick look through. Anyways, for later.\n\n> What I was talking about in that comment was mostly done on #16158 (closed a couple of months ago).  I think the remaining issue of making a category `AffineSchemes` would probably be disjoint from getting rid of the `__call__()` method.\n\n\nI knew the last one was done, but forgot that it moved the functionality. Unfortunately I think you're right, but we can at least do a followup to create the category of `AffineSchemes`.\n\n> I'm setting this to positive review since you gave the green light.\n\n\nThanks.",
    "created_at": "2014-11-03T15:44:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69214",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>> The reason this is done via the `__call__()` method is that an affine scheme *S* accepts two kinds of input; only one of them (input is a prime ideal) constructs an element with *S* as its parent.  In the other case (input is a list of coordinates) the `__call__()` syntax constructs an element of a suitable scheme homset.  I don't see an easy way to avoid a custom `__call__()` method; it may be possible (and would be nice) to get rid of it, but it is better to do this on separate ticket.  (Note also that the `__call__()` method was already present, I just improved it as necessary.)


That's what I was thinking from a quick look through. Anyways, for later.

> What I was talking about in that comment was mostly done on #16158 (closed a couple of months ago).  I think the remaining issue of making a category `AffineSchemes` would probably be disjoint from getting rid of the `__call__()` method.


I knew the last one was done, but forgot that it moved the functionality. Unfortunately I think you're right, but we can at least do a followup to create the category of `AffineSchemes`.

> I'm setting this to positive review since you gave the green light.


Thanks.



---

archive/issue_events_019023.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-11-14T21:01:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7946#event-19023"
}
```



---

archive/issue_comments_069215.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-11-14T21:01:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7946",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7946#issuecomment-69215",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
