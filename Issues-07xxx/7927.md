# Issue 7927: Extend coleman integration to handle Weierstrass points

archive/issues_007927.json:
```json
{
    "body": "\n\n**Assignee:** @williamstein\n\n**CC:**  @jbalakrishnan\n\n**Reviewer:** Kiran Kedlaya\n\n**Author:** Jennifer Balakrishnan, Robert Bradshaw\n\n**Merged:** sage-4.3.4.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/7927\n\n",
    "closed_at": "2010-03-03T14:40:32Z",
    "created_at": "2010-01-14T06:53:58Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.3.4",
    "title": "Extend coleman integration to handle Weierstrass points",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/7927",
    "user": "https://github.com/robertwb"
}
```


**Assignee:** @williamstein

**CC:**  @jbalakrishnan

**Reviewer:** Kiran Kedlaya

**Author:** Jennifer Balakrishnan, Robert Bradshaw

**Merged:** sage-4.3.4.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/7927





---

archive/issue_comments_062112.json:
```json
{
    "body": "some code, probably needs to be cleaned up",
    "created_at": "2010-01-14T06:54:39Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62112",
    "user": "https://github.com/robertwb"
}
```

some code, probably needs to be cleaned up



---

archive/attachments_009711.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13535.patch",
    "asset_url": "tarball://root/attachments/ticket7927/13535.patch",
    "created_at": "2010-01-15T13:59:11Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket7927/13535.patch",
    "user": "https://github.com/jbalakrishnan"
}
```



---

archive/issue_comments_062113.json:
```json
{
    "body": "Attachment [13535.patch](https://github.com/sagemath/sage/files/ticket7927/13535.patch) by @jbalakrishnan created at 2010-01-15 13:59:11\n\nmore Weierstrass code",
    "created_at": "2010-01-15T13:59:11Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62113",
    "user": "https://github.com/jbalakrishnan"
}
```

Attachment [13535.patch](https://github.com/sagemath/sage/files/ticket7927/13535.patch) by @jbalakrishnan created at 2010-01-15 13:59:11

more Weierstrass code



---

archive/issue_comments_062114.json:
```json
{
    "body": "<a id='comment:1'></a>\nHere's a first attempt at some more code, with a little bit of overlap with Robert's code. I like his incorporation of the non-Teichmuller algorithm as an optional parameter in the main Coleman integral function, so we can mostly ignore what I do instead.\n\nThe main functions of interest are \ncoleman_integral_from_weierstrass_via_boundary and\ncoleman_integral_from_weierstrass ; the latter can only be used for odd differentials, while the former is pretty slow, dependent on p-adic extensions. \n\nThe auxiliary functions (e.g., P_to_S, S_to_Q, etc.) aren't likely to be of much interest to the user, but they give us good consistency checks. I'd appreciate input on renaming/restructuring things.\n\nAnd my apologies for the messed-up line breaks in hyperelliptic_generic -- just noticed them now, but boxen.math (where I've been editing) has been difficult to access in the last hour from Guam. I can fix this (my) tomorrow morning.",
    "created_at": "2010-01-15T14:05:39Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62114",
    "user": "https://github.com/jbalakrishnan"
}
```

<a id='comment:1'></a>
Here's a first attempt at some more code, with a little bit of overlap with Robert's code. I like his incorporation of the non-Teichmuller algorithm as an optional parameter in the main Coleman integral function, so we can mostly ignore what I do instead.

The main functions of interest are 
coleman_integral_from_weierstrass_via_boundary and
coleman_integral_from_weierstrass ; the latter can only be used for odd differentials, while the former is pretty slow, dependent on p-adic extensions. 

The auxiliary functions (e.g., P_to_S, S_to_Q, etc.) aren't likely to be of much interest to the user, but they give us good consistency checks. I'd appreciate input on renaming/restructuring things.

And my apologies for the messed-up line breaks in hyperelliptic_generic -- just noticed them now, but boxen.math (where I've been editing) has been difficult to access in the last hour from Guam. I can fix this (my) tomorrow morning.



---

archive/attachments_009712.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13536.patch",
    "asset_url": "tarball://root/attachments/ticket7927/13536.patch",
    "created_at": "2010-01-16T00:33:24Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket7927/13536.patch",
    "user": "https://github.com/jbalakrishnan"
}
```



---

archive/issue_comments_062115.json:
```json
{
    "body": "Attachment [13536.patch](https://github.com/sagemath/sage/files/ticket7927/13536.patch) by @jbalakrishnan created at 2010-01-16 00:33:24\n\napply after 13535 to fix line break problems",
    "created_at": "2010-01-16T00:33:24Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62115",
    "user": "https://github.com/jbalakrishnan"
}
```

Attachment [13536.patch](https://github.com/sagemath/sage/files/ticket7927/13536.patch) by @jbalakrishnan created at 2010-01-16 00:33:24

apply after 13535 to fix line break problems



---

archive/issue_events_055001.json:
```json
{
    "actor": "https://github.com/kedlaya",
    "created_at": "2010-01-30T06:50:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55001"
}
```



---

archive/issue_comments_062116.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe overlap needs to be taken care of somehow. It might be easiest for Jen to incorporate whatever is appropriate from Robert's patch.\n\nI'm dubious about the treatment of points in the infinite disc, on several counts. One is whether the Frobenius gets the y-coordinate right, since I think in both patches the check passes for trivial reasons whether or not the y-coordinate is right. Under Robert's patch, one gets lucky: you win as long as the square root of a p-adic number with unit part congruent to 1 mod p is guaranteed to be congruent to 1 mod p. This is undocumented but appears to be true. Under Jen's patch, one does not get lucky:\n\n```\nsage: K = pAdicField(11, 5)\nsage: x = polygen(K)\nsage: C = HyperellipticCurve(x^5 + 33/16*x^4 + 3/4*x^3 + 3/8*x^2 - 1/4*x + 1/16)\nsage: P = C.lift_x(11^(-2))\nsage: C.frobenius(P)\n(11^-22 + O(11^-17) : 10*11^-55 + 10*11^-54 + 10*11^-53 + 10*11^-52 + 10*11^-51 + O(11^-50) : 1 + O(11^5))\n```\n\nMore seriously, computing Coleman integrals even between two points in the infinite disc seems to be broken. Under Robert's patch, we have:\n\n```\nsage: K = pAdicField(11, 5)\nsage: x = polygen(K)\nsage: C = HyperellipticCurve(x^5 + 33/16*x^4 + 3/4*x^3 + 3/8*x^2 - 1/4*x + 1/16)\nsage: P = C.lift_x(11^(-2))\nsage: Q = C.lift_x(3*11^(-2))\nsage: C.tiny_integrals_on_basis(P,Q)\n[9*11^3 + 11^4 + 2*11^5 + 2*11^6 + 11^7 + O(11^8), 11^2 + 5*11^4 + 3*11^5 + O(11^6), 8*11^-1 + 5 + 5*11 + 5*11^2 + 6*11^3 + O(11^4), 10*11^-3 + 3*11^-2 + 7*11^-1 + 5 + 8*11 + O(11^2)]\nsage: C.coleman_integrals_on_basis(P, Q)\n(10*11^-102 + 2*11^-101 + 9*11^-100 + 3*11^-99 + O(11^-98), 8*11^-102 + 2*11^-101 + 2*11^-100 + O(11^-98), 10*11^-103 + 8*11^-102 + 3*11^-101 + 6*11^-100 + 7*11^-99 + O(11^-98), 2*11^-103 + 5*11^-102 + 8*11^-100 + 5*11^-99 + O(11^-98))\n```\nThe last two lines should be the same; right now, they aren't even of the same return type (one is a list, one is a tuple).\n\nUnder Jen's patch, the last call returns an error instead:\n\n```\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/scratch/sage-4.3.2.alpha0/<ipython console> in <module>()\n\n/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in coleman_integrals_on_basis(self, P, Q)\n    136 \n    137         prof(\"tiny integrals\")\n--> 138         TP = self.teichmuller(P)\n    139 #        print \"TP\", TP\n    140         P_to_TP = V(self.tiny_integrals_on_basis(P, TP))\n\n/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in teichmuller(self, P)\n    117         \"\"\"\n    118         K = P[0].parent()\n--> 119         x = K.teichmuller(P[0])\n    120         pts = self.lift_x(x, all=True)\n    121         p = K.prime()\n\n/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/rings/padics/padic_generic.pyc in teichmuller(self, x, prec)\n    376             prec = min(Integer(prec), self.precision_cap())\n    377         ans = self(x, prec)\n--> 378         ans._teichmuller_set()\n    379         return ans\n    380 \n\n/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/rings/padics/padic_capped_relative_element.so in sage.rings.padics.padic_capped_relative_element.pAdicCappedRelativeElement._teichmuller_set (sage/rings/padics/padic_capped_relative_element.c:17195)()\n\nValueError: cannot set negative valuation element to Teichmuller representative.\n```",
    "created_at": "2010-01-30T06:50:43Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62116",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:2'></a>
The overlap needs to be taken care of somehow. It might be easiest for Jen to incorporate whatever is appropriate from Robert's patch.

I'm dubious about the treatment of points in the infinite disc, on several counts. One is whether the Frobenius gets the y-coordinate right, since I think in both patches the check passes for trivial reasons whether or not the y-coordinate is right. Under Robert's patch, one gets lucky: you win as long as the square root of a p-adic number with unit part congruent to 1 mod p is guaranteed to be congruent to 1 mod p. This is undocumented but appears to be true. Under Jen's patch, one does not get lucky:

```
sage: K = pAdicField(11, 5)
sage: x = polygen(K)
sage: C = HyperellipticCurve(x^5 + 33/16*x^4 + 3/4*x^3 + 3/8*x^2 - 1/4*x + 1/16)
sage: P = C.lift_x(11^(-2))
sage: C.frobenius(P)
(11^-22 + O(11^-17) : 10*11^-55 + 10*11^-54 + 10*11^-53 + 10*11^-52 + 10*11^-51 + O(11^-50) : 1 + O(11^5))
```

More seriously, computing Coleman integrals even between two points in the infinite disc seems to be broken. Under Robert's patch, we have:

```
sage: K = pAdicField(11, 5)
sage: x = polygen(K)
sage: C = HyperellipticCurve(x^5 + 33/16*x^4 + 3/4*x^3 + 3/8*x^2 - 1/4*x + 1/16)
sage: P = C.lift_x(11^(-2))
sage: Q = C.lift_x(3*11^(-2))
sage: C.tiny_integrals_on_basis(P,Q)
[9*11^3 + 11^4 + 2*11^5 + 2*11^6 + 11^7 + O(11^8), 11^2 + 5*11^4 + 3*11^5 + O(11^6), 8*11^-1 + 5 + 5*11 + 5*11^2 + 6*11^3 + O(11^4), 10*11^-3 + 3*11^-2 + 7*11^-1 + 5 + 8*11 + O(11^2)]
sage: C.coleman_integrals_on_basis(P, Q)
(10*11^-102 + 2*11^-101 + 9*11^-100 + 3*11^-99 + O(11^-98), 8*11^-102 + 2*11^-101 + 2*11^-100 + O(11^-98), 10*11^-103 + 8*11^-102 + 3*11^-101 + 6*11^-100 + 7*11^-99 + O(11^-98), 2*11^-103 + 5*11^-102 + 8*11^-100 + 5*11^-99 + O(11^-98))
```
The last two lines should be the same; right now, they aren't even of the same return type (one is a list, one is a tuple).

Under Jen's patch, the last call returns an error instead:

```
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/scratch/sage-4.3.2.alpha0/<ipython console> in <module>()

/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in coleman_integrals_on_basis(self, P, Q)
    136 
    137         prof("tiny integrals")
--> 138         TP = self.teichmuller(P)
    139 #        print "TP", TP
    140         P_to_TP = V(self.tiny_integrals_on_basis(P, TP))

/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in teichmuller(self, P)
    117         """
    118         K = P[0].parent()
--> 119         x = K.teichmuller(P[0])
    120         pts = self.lift_x(x, all=True)
    121         p = K.prime()

/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/rings/padics/padic_generic.pyc in teichmuller(self, x, prec)
    376             prec = min(Integer(prec), self.precision_cap())
    377         ans = self(x, prec)
--> 378         ans._teichmuller_set()
    379         return ans
    380 

/scratch/sage-4.3.2.alpha0/local/lib/python2.6/site-packages/sage/rings/padics/padic_capped_relative_element.so in sage.rings.padics.padic_capped_relative_element.pAdicCappedRelativeElement._teichmuller_set (sage/rings/padics/padic_capped_relative_element.c:17195)()

ValueError: cannot set negative valuation element to Teichmuller representative.
```



---

archive/issue_comments_062117.json:
```json
{
    "body": "<a id='comment:3'></a>\nFollowup: the p-adic square root is computed using pari, which always chooses the branch of the square root so that the leading p-adic digit is in [0, p/2]. So Robert's treatment of the ambiguity does seem to work.",
    "created_at": "2010-01-30T12:06:36Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62117",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:3'></a>
Followup: the p-adic square root is computed using pari, which always chooses the branch of the square root so that the leading p-adic digit is in [0, p/2]. So Robert's treatment of the ambiguity does seem to work.



---

archive/issue_comments_062118.json:
```json
{
    "body": "merged Robert's patch with mine, though still a work in progress",
    "created_at": "2010-02-07T16:33:55Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62118",
    "user": "https://github.com/jbalakrishnan"
}
```

merged Robert's patch with mine, though still a work in progress



---

archive/attachments_009713.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13538.patch",
    "asset_url": "tarball://root/attachments/ticket7927/13538.patch",
    "created_at": "2010-02-16T21:21:47Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket7927/13538.patch",
    "user": "https://github.com/jbalakrishnan"
}
```



---

archive/issue_comments_062119.json:
```json
{
    "body": "Attachment [13538.patch](https://github.com/sagemath/sage/files/ticket7927/13538.patch) by @jbalakrishnan created at 2010-02-16 21:21:47\n\nfixing precision issues in the infinite disc",
    "created_at": "2010-02-16T21:21:47Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62119",
    "user": "https://github.com/jbalakrishnan"
}
```

Attachment [13538.patch](https://github.com/sagemath/sage/files/ticket7927/13538.patch) by @jbalakrishnan created at 2010-02-16 21:21:47

fixing precision issues in the infinite disc



---

archive/issue_comments_062120.json:
```json
{
    "body": "<a id='comment:4'></a>\nThe good news is, this looks fine on mathematical grounds. However, there are a few procedural issues before I can issue a positive review.\n\nI am getting some doctest failures in hyperelliptic_padic_field.py. I think the problem is the indentation in the doctest for is_same_disc. If I fix that by hand, the doctests all pass.\n\nIn other news, coverage checking points up some missing documentation/doctests.\nFor hyperelliptic_padic_field.py:\n\n```\nMissing documentation:\n\t * invariant_differential(self):\n\nMissing doctests:\n\t * is_in_weierstrass_disc(self,P):\n\t * is_weierstrass(self,P):\n\t * tiny_integrals(self, F, P, Q):\n```\nFor hyperelliptic_generic.py:\n\n```\nMissing documentation:\n\t * __init__(self, PP, f, h=None, names=None, genus=None):\n\t * change_ring(self, R):\n\t * __cmp__(self, other):\n\t * lift_x(self, x, all=False):\n\t * genus(self):\n\t * jacobian(self):\n\t * monsky_washnitzer_gens(self):\n\nMissing doctests:\n\t * local_coord(self, P, prec = 20, name = 't'):\n\nPossibly wrong (function name doesn't occur in doctests):\n\t * _repr_(self):\n\t * _magma_init_(self, magma):\n```\nOf these, the ones that are new (is_in_weierstrass_disc, is_weierstrass, and maybe some others) absolutely need doctests. Improving the coverage for older functions would be helpful but is not an obstacle to a positive review on this ticket (we could create a separate ticket for that).\n\nAnother minor note: various release managers have requested that the commit line for patches start with the number of the relevant ticket, e.g.,\n\n#7927: Extend coleman integration to handle Weierstrass points\n\nThis is helpful in case a rollback is needed after applying a whole bunch of disparate patches. This comment can be ignored unless you decide to build a single patch encompassing all of the changes so far.",
    "created_at": "2010-02-16T23:18:36Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62120",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:4'></a>
The good news is, this looks fine on mathematical grounds. However, there are a few procedural issues before I can issue a positive review.

I am getting some doctest failures in hyperelliptic_padic_field.py. I think the problem is the indentation in the doctest for is_same_disc. If I fix that by hand, the doctests all pass.

In other news, coverage checking points up some missing documentation/doctests.
For hyperelliptic_padic_field.py:

```
Missing documentation:
	 * invariant_differential(self):

Missing doctests:
	 * is_in_weierstrass_disc(self,P):
	 * is_weierstrass(self,P):
	 * tiny_integrals(self, F, P, Q):
```
For hyperelliptic_generic.py:

```
Missing documentation:
	 * __init__(self, PP, f, h=None, names=None, genus=None):
	 * change_ring(self, R):
	 * __cmp__(self, other):
	 * lift_x(self, x, all=False):
	 * genus(self):
	 * jacobian(self):
	 * monsky_washnitzer_gens(self):

Missing doctests:
	 * local_coord(self, P, prec = 20, name = 't'):

Possibly wrong (function name doesn't occur in doctests):
	 * _repr_(self):
	 * _magma_init_(self, magma):
```
Of these, the ones that are new (is_in_weierstrass_disc, is_weierstrass, and maybe some others) absolutely need doctests. Improving the coverage for older functions would be helpful but is not an obstacle to a positive review on this ticket (we could create a separate ticket for that).

Another minor note: various release managers have requested that the commit line for patches start with the number of the relevant ticket, e.g.,

#7927: Extend coleman integration to handle Weierstrass points

This is helpful in case a rollback is needed after applying a whole bunch of disparate patches. This comment can be ignored unless you decide to build a single patch encompassing all of the changes so far.



---

archive/issue_comments_062121.json:
```json
{
    "body": "<a id='comment:5'></a>\nIt appears I spoke to soon. An example which used to work but is now broken:\n\n```\nsage: R.<x> = QQ['x']\nsage: H = HyperellipticCurve(x^3+1)\nsage: K = Qp(5,8)\nsage: HK = H.change_ring(K)                                              \nsage: P = HK(0,1)                                                        \nsage: Q = HK.lift_x(5)                                                   \nsage: HK.tiny_integrals_on_basis(P,Q)                                    \n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/home/r1/kedlaya/.sage/temp/dwork.mit.edu/31681/_home_r1_kedlaya__sage_init_sage_0.py in <module>()\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in tiny_integrals_on_basis(self, P, Q)\n    298         R = PolynomialRing(self.base_ring(), ['x', 'y'])\n    299         x, y = R.gens()\n--> 300         return self.tiny_integrals([x**i for i in range(2*self.genus())], P, Q)\n    301 \n    302                \n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in tiny_integrals(self, F, P, Q)\n    250         P and Q MUST be in the same residue disk for this result to make sense. \n    251         \"\"\"\n--> 252         x, y, z = self.local_analytic_interpolation(P, Q)  #homogeneous coordinates\n    253         x = x/z\n    254         y = y/z\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in local_analytic_interpolation(self, P, Q)\n     82         \"\"\"\n     83         prec = self.base_ring().precision_cap()\n---> 84         if self.is_same_disc(P,Q) == False:\n     85             raise ValueError, \"%s and %s are not in the same residue disc\"%(P,Q)\n     86         disc = self.residue_disc(P)\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in is_same_disc(self, P, Q)\n    238             False        \n    239         \"\"\"\n--> 240         if self.residue_disc(P) == self.residue_disc(Q):\n    241             return True\n    242         else:\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in residue_disc(self, P)\n    203         yPv = P[1].valuation()\n    204         F = self.base_ring().residue_field()\n--> 205         HF = self.change_ring(F)\n    206         if P == self(0,1,0):\n    207             return HF(0,1,0)\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.pyc in change_ring(self, R)\n     78         y = self._printing_ring.gen()\n     79         x = self._printing_ring.base_ring().gen()\n---> 80         return HyperellipticCurve(f.change_ring(R), h, \"%s,%s\"%(x,y))\n     81 \n     82     def _repr_(self):\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/constructor.pyc in HyperellipticCurve(f, h, names, PP)\n     94             return HyperellipticCurve_g2_finite_field(PP, f, h, names=names, genus=g)\n     95         else:\n---> 96             return HyperellipticCurve_finite_field(PP, f, h, names=names, genus=g)\n     97     elif is_RationalField(R):\n     98         if g == 2:\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.pyc in __init__(self, PP, f, h, names, genus)\n     66             names = names.split(\",\")\n     67         self._names = names\n---> 68         P1 = PolynomialRing(R,name=names[0])\n     69         P2 = PolynomialRing(P1,name=names[1])\n     70         self._PP = PP\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, implementation)\n    341                 raise TypeError, \"if second arguments is a string with no commas, then there must be no other non-optional arguments\"\n    342             name = arg1\n--> 343             R = _single_variate(base_ring, name, sparse, implementation)\n    344         else:\n    345             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)\n    393 def _single_variate(base_ring, name, sparse, implementation):\n    394     import sage.rings.polynomial.polynomial_ring as m\n--> 395     name = normalize_names(1, name)\n    396     key = (base_ring, name, sparse, implementation)\n    397     R = _get_from_cache(key)\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2089)()\n\n/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:1647)()\n\nValueError: variable names must be alphanumeric, but one is '(1 + O(5^8))*x' which is not.\n```",
    "created_at": "2010-02-17T16:07:50Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62121",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:5'></a>
It appears I spoke to soon. An example which used to work but is now broken:

```
sage: R.<x> = QQ['x']
sage: H = HyperellipticCurve(x^3+1)
sage: K = Qp(5,8)
sage: HK = H.change_ring(K)                                              
sage: P = HK(0,1)                                                        
sage: Q = HK.lift_x(5)                                                   
sage: HK.tiny_integrals_on_basis(P,Q)                                    
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/home/r1/kedlaya/.sage/temp/dwork.mit.edu/31681/_home_r1_kedlaya__sage_init_sage_0.py in <module>()

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in tiny_integrals_on_basis(self, P, Q)
    298         R = PolynomialRing(self.base_ring(), ['x', 'y'])
    299         x, y = R.gens()
--> 300         return self.tiny_integrals([x**i for i in range(2*self.genus())], P, Q)
    301 
    302                

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in tiny_integrals(self, F, P, Q)
    250         P and Q MUST be in the same residue disk for this result to make sense. 
    251         """
--> 252         x, y, z = self.local_analytic_interpolation(P, Q)  #homogeneous coordinates
    253         x = x/z
    254         y = y/z

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in local_analytic_interpolation(self, P, Q)
     82         """
     83         prec = self.base_ring().precision_cap()
---> 84         if self.is_same_disc(P,Q) == False:
     85             raise ValueError, "%s and %s are not in the same residue disc"%(P,Q)
     86         disc = self.residue_disc(P)

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in is_same_disc(self, P, Q)
    238             False        
    239         """
--> 240         if self.residue_disc(P) == self.residue_disc(Q):
    241             return True
    242         else:

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.pyc in residue_disc(self, P)
    203         yPv = P[1].valuation()
    204         F = self.base_ring().residue_field()
--> 205         HF = self.change_ring(F)
    206         if P == self(0,1,0):
    207             return HF(0,1,0)

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.pyc in change_ring(self, R)
     78         y = self._printing_ring.gen()
     79         x = self._printing_ring.base_ring().gen()
---> 80         return HyperellipticCurve(f.change_ring(R), h, "%s,%s"%(x,y))
     81 
     82     def _repr_(self):

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/constructor.pyc in HyperellipticCurve(f, h, names, PP)
     94             return HyperellipticCurve_g2_finite_field(PP, f, h, names=names, genus=g)
     95         else:
---> 96             return HyperellipticCurve_finite_field(PP, f, h, names=names, genus=g)
     97     elif is_RationalField(R):
     98         if g == 2:

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.pyc in __init__(self, PP, f, h, names, genus)
     66             names = names.split(",")
     67         self._names = names
---> 68         P1 = PolynomialRing(R,name=names[0])
     69         P2 = PolynomialRing(P1,name=names[1])
     70         self._PP = PP

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in PolynomialRing(base_ring, arg1, arg2, sparse, order, names, name, implementation)
    341                 raise TypeError, "if second arguments is a string with no commas, then there must be no other non-optional arguments"
    342             name = arg1
--> 343             R = _single_variate(base_ring, name, sparse, implementation)
    344         else:
    345             # 2-4. PolynomialRing(base_ring, names, order='degrevlex'):

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/rings/polynomial/polynomial_ring_constructor.pyc in _single_variate(base_ring, name, sparse, implementation)
    393 def _single_variate(base_ring, name, sparse, implementation):
    394     import sage.rings.polynomial.polynomial_ring as m
--> 395     name = normalize_names(1, name)
    396     key = (base_ring, name, sparse, implementation)
    397     R = _get_from_cache(key)

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens.normalize_names (sage/structure/parent_gens.c:2089)()

/scratch/sage-4.2.1/local/lib/python2.6/site-packages/sage/structure/parent_gens.so in sage.structure.parent_gens._certify_names (sage/structure/parent_gens.c:1647)()

ValueError: variable names must be alphanumeric, but one is '(1 + O(5^8))*x' which is not.
```



---

archive/issue_comments_062122.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [kedlaya](#comment%3A5):\n> It appears I spoke to soon. An example which used to work but is now broken:\n\n...\n\nThis failure occurred using 4.2.1. I can't reproduce it using 4.3.3.alpha0, so it may be an artifact.",
    "created_at": "2010-02-17T17:19:26Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62122",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:6'></a>
Replying to [kedlaya](#comment%3A5):
> It appears I spoke to soon. An example which used to work but is now broken:

...

This failure occurred using 4.2.1. I can't reproduce it using 4.3.3.alpha0, so it may be an artifact.



---

archive/issue_comments_062123.json:
```json
{
    "body": "fixing things in comment #4 (doctests, etc.)",
    "created_at": "2010-02-18T16:45:19Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62123",
    "user": "https://github.com/jbalakrishnan"
}
```

fixing things in comment #4 (doctests, etc.)



---

archive/attachments_009714.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13539.patch",
    "asset_url": "tarball://root/attachments/ticket7927/13539.patch",
    "created_at": "2010-02-19T01:58:06Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket7927/13539.patch",
    "user": "https://github.com/jbalakrishnan"
}
```



---

archive/issue_comments_062124.json:
```json
{
    "body": "Attachment [13539.patch](https://github.com/sagemath/sage/files/ticket7927/13539.patch) by @jbalakrishnan created at 2010-02-19 01:58:06\n\ndoctesting exceptions; formatting of docstrings",
    "created_at": "2010-02-19T01:58:06Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62124",
    "user": "https://github.com/jbalakrishnan"
}
```

Attachment [13539.patch](https://github.com/sagemath/sage/files/ticket7927/13539.patch) by @jbalakrishnan created at 2010-02-19 01:58:06

doctesting exceptions; formatting of docstrings



---

archive/attachments_009715.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13540.patch",
    "asset_url": "tarball://root/attachments/ticket7927/13540.patch",
    "created_at": "2010-02-19T01:58:31Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket7927/13540.patch",
    "user": "https://github.com/jbalakrishnan"
}
```



---

archive/issue_comments_062125.json:
```json
{
    "body": "<a id='comment:7'></a>\nAttachment [13540.patch](https://github.com/sagemath/sage/files/ticket7927/13540.patch) by @jbalakrishnan created at 2010-02-19 01:58:31",
    "created_at": "2010-02-19T01:58:31Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62125",
    "user": "https://github.com/jbalakrishnan"
}
```

<a id='comment:7'></a>
Attachment [13540.patch](https://github.com/sagemath/sage/files/ticket7927/13540.patch) by @jbalakrishnan created at 2010-02-19 01:58:31



---

archive/issue_events_055002.json:
```json
{
    "actor": "https://github.com/jbalakrishnan",
    "created_at": "2010-02-19T01:58:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55002"
}
```



---

archive/issue_events_055003.json:
```json
{
    "actor": "https://github.com/jbalakrishnan",
    "created_at": "2010-02-19T01:58:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55003"
}
```



---

archive/issue_comments_062126.json:
```json
{
    "body": "removed coleman_integrals_on_basis in ell_padic_field.py",
    "created_at": "2010-02-19T15:26:27Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62126",
    "user": "https://github.com/jbalakrishnan"
}
```

removed coleman_integrals_on_basis in ell_padic_field.py



---

archive/attachments_009716.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "13541.patch",
    "asset_url": "tarball://root/attachments/ticket7927/13541.patch",
    "created_at": "2010-02-19T16:08:16Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket7927/13541.patch",
    "user": "https://github.com/kedlaya"
}
```



---

archive/issue_comments_062127.json:
```json
{
    "body": "<a id='comment:8'></a>\nAttachment [13541.patch](https://github.com/sagemath/sage/files/ticket7927/13541.patch) by @kedlaya created at 2010-02-19 16:08:16\n\nAfter applying 13535.patch through 13541.patch against 4.3.3.alpha0, I get no long doctest failures anywhere in sage/schemes/. Positive review.\n\nFor other issues with Coleman integration, see tickets #8304 and #8305.",
    "created_at": "2010-02-19T16:08:16Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62127",
    "user": "https://github.com/kedlaya"
}
```

<a id='comment:8'></a>
Attachment [13541.patch](https://github.com/sagemath/sage/files/ticket7927/13541.patch) by @kedlaya created at 2010-02-19 16:08:16

After applying 13535.patch through 13541.patch against 4.3.3.alpha0, I get no long doctest failures anywhere in sage/schemes/. Positive review.

For other issues with Coleman integration, see tickets #8304 and #8305.



---

archive/issue_events_055004.json:
```json
{
    "actor": "https://github.com/kedlaya",
    "created_at": "2010-02-19T16:08:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55004"
}
```



---

archive/issue_events_055005.json:
```json
{
    "actor": "https://github.com/kedlaya",
    "created_at": "2010-02-19T16:08:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55005"
}
```



---

archive/issue_comments_062128.json:
```json
{
    "body": "**Merged:** sage-4.3.4.alpha0",
    "created_at": "2010-03-03T14:40:32Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62128",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Merged:** sage-4.3.4.alpha0



---

archive/issue_comments_062129.json:
```json
{
    "body": "<a id='comment:9'></a>\nMerged in this order:\n\n1. [13535.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13535.patch)\n2. [13536.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13536.patch)\n3. [13537.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13537.patch)\n4. [13538.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13538.patch)\n5. [13539.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13539.patch)\n6. [13540.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13540.patch)\n7. [13541.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13541.patch)\n\nJennifer: you should put the ticket number in your patch.",
    "created_at": "2010-03-03T14:40:32Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62129",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:9'></a>
Merged in this order:

1. [13535.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13535.patch)
2. [13536.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13536.patch)
3. [13537.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13537.patch)
4. [13538.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13538.patch)
5. [13539.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13539.patch)
6. [13540.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13540.patch)
7. [13541.patch](http://trac.sagemath.org/sage_trac/attachment/ticket/7927/13541.patch)

Jennifer: you should put the ticket number in your patch.



---

archive/issue_comments_062130.json:
```json
{
    "body": "**Author:** Jennifer Balakrishnan, Robert Bradshaw",
    "created_at": "2010-03-03T14:40:32Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62130",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Author:** Jennifer Balakrishnan, Robert Bradshaw



---

archive/issue_comments_062131.json:
```json
{
    "body": "**Reviewer:** Kiran Kedlaya",
    "created_at": "2010-03-03T14:40:32Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62131",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Reviewer:** Kiran Kedlaya



---

archive/issue_events_055006.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2010-03-03T14:40:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55006"
}
```



---

archive/issue_events_055007.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2010-03-03T14:40:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7927#event-55007"
}
```



---

archive/issue_comments_062132.json:
```json
{
    "body": "<a id='comment:10'></a>\nWhat's up with this condition:\n\n```\n            x = f.parent().variable_name()\n            if x!='a' :  #this is to distinguish between extensions of Qp that are finite vs. not\n```\nI totally cannot understand why you check whether the variable name is `\"a\"`. That makes no sense to me.",
    "created_at": "2017-11-22T13:39:27Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62132",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:10'></a>
What's up with this condition:

```
            x = f.parent().variable_name()
            if x!='a' :  #this is to distinguish between extensions of Qp that are finite vs. not
```
I totally cannot understand why you check whether the variable name is `"a"`. That makes no sense to me.



---

archive/issue_comments_062133.json:
```json
{
    "body": "<a id='comment:11'></a>\nSee #24267 for a follow-up.",
    "created_at": "2017-11-22T14:10:42Z",
    "issue": "https://github.com/sagemath/sage/issues/7927",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7927#issuecomment-62133",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:11'></a>
See #24267 for a follow-up.
