# Issue 7103: fix "mysterious error" in parallel doctesting first time: see ticket #7079

archive/issues_007103.json:
```json
{
    "assignees": [],
    "body": "See #7079\n\nComponent: **doctest coverage**\n\nAuthor: **John Palmieri**\n\nReviewer: **William Stein**\n\nMerged: **sage-4.2.1.rc0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/7103_\n\n",
    "closed_at": "2009-11-13T04:57:34Z",
    "created_at": "2009-10-03T23:58:08Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.2.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "fix \"mysterious error\" in parallel doctesting first time: see ticket #7079",
    "type": "issue",
    "updated_at": "2009-11-13T04:57:34Z",
    "url": "https://github.com/sagemath/sage/issues/7103",
    "user": "https://github.com/williamstein"
}
```
See #7079

Component: **doctest coverage**

Author: **John Palmieri**

Reviewer: **William Stein**

Merged: **sage-4.2.1.rc0**

_Issue created by migration from https://trac.sagemath.org/ticket/7103_





---

archive/issue_events_086521.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-10-03T23:58:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "milestone_number": null,
    "milestone_title": "sage-4.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86521"
}
```



---

archive/issue_events_086522.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-10-03T23:58:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86522"
}
```



---

archive/issue_events_086523.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-10-03T23:58:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86523"
}
```



---

archive/issue_events_086524.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-10-03T23:58:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86524"
}
```



---

archive/issue_events_086525.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-10-03T23:58:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86525"
}
```



---

archive/issue_comments_051027.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nHere's an attempt.  If init.sage isn't present, then run the script \"sage-starts\".  I think this makes all of the appropriate subdirectories of .sage.  In any case, it seems to fix the problem for me.",
    "created_at": "2009-10-04T00:30:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51027",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:1" align="right">comment:1</div>

Here's an attempt.  If init.sage isn't present, then run the script "sage-starts".  I think this makes all of the appropriate subdirectories of .sage.  In any case, it seems to fix the problem for me.



---

archive/issue_comments_051028.json:
```json
{
    "body": "Attachment: **[trac_7103-scripts.patch.gz](https://github.com/sagemath/sage/files/ticket7103/trac_7103-scripts.patch.gz)**\n\napply to scripts repository",
    "created_at": "2009-10-04T00:34:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51028",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[trac_7103-scripts.patch.gz](https://github.com/sagemath/sage/files/ticket7103/trac_7103-scripts.patch.gz)**

apply to scripts repository



---

archive/issue_events_086526.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2009-10-10T13:58:04Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86526"
}
```



---

archive/issue_events_086527.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2009-10-10T13:58:04Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86527"
}
```



---

archive/issue_comments_051029.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nApplied patch, ran the test and still got the errors. `sage-starts` does not create the directories, at least in my system.",
    "created_at": "2009-10-10T13:58:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51029",
    "user": "https://github.com/TimDumol"
}
```

<div id="comment:2" align="right">comment:2</div>

Applied patch, ran the test and still got the errors. `sage-starts` does not create the directories, at least in my system.



---

archive/issue_comments_051030.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nCan you tell me what your system is and exactly what you did to test this?  (What directories did you delete before you started?)",
    "created_at": "2009-10-10T17:42:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51030",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:3" align="right">comment:3</div>

Can you tell me what your system is and exactly what you did to test this?  (What directories did you delete before you started?)



---

archive/issue_events_086528.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-11-11T17:42:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "milestone_number": null,
    "milestone_title": "sage-4.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86528"
}
```



---

archive/issue_events_086529.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-11-11T17:42:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "milestone_number": null,
    "milestone_title": "sage-4.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86529"
}
```



---

archive/issue_comments_051031.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nCalling \"make ptestlong\" (as suggested in ticket #7079), we already call \"sage-starts\", as this is a part of the TESTPRELIMS in the makefile.\n\nSo the test case(s) for this ticket seems to be for directly calling \"sage -tp ..\" from the commandline.\n\nI don't understand the intention of the attached patch, however. If I delete the file \"./sage/init.sage\" and then call \"sage -tp ...\", the file would have been created anew before the patch, but *not* after the patch. Even if I delete the whole \".sage\" directory, this file will not be recreated (after the patch).\n\nIs it possible that the creation of \"init.sage\" (which should exist at least as an empty file IIRC) somehow originally did cause the problems?\n\nAnother thought: Might the presence (or not ...) of these infamous \".DS_Store\" files (Mac OS X only, there's an open ticket to remove them IIRC) break the parallel building, causing somehow these \"mysterious memory failures\"?",
    "created_at": "2009-11-11T21:39:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51031",
    "user": "https://github.com/sagetrac-GeorgSWeber"
}
```

<div id="comment:5" align="right">comment:5</div>

Calling "make ptestlong" (as suggested in ticket #7079), we already call "sage-starts", as this is a part of the TESTPRELIMS in the makefile.

So the test case(s) for this ticket seems to be for directly calling "sage -tp .." from the commandline.

I don't understand the intention of the attached patch, however. If I delete the file "./sage/init.sage" and then call "sage -tp ...", the file would have been created anew before the patch, but *not* after the patch. Even if I delete the whole ".sage" directory, this file will not be recreated (after the patch).

Is it possible that the creation of "init.sage" (which should exist at least as an empty file IIRC) somehow originally did cause the problems?

Another thought: Might the presence (or not ...) of these infamous ".DS_Store" files (Mac OS X only, there's an open ticket to remove them IIRC) break the parallel building, causing somehow these "mysterious memory failures"?



---

archive/issue_comments_051032.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI don't think the \".DS_Store\" files have anything to do it: I can recreate this problem on sage.math by deleting my .sage directory and then doing \"sage -tp 4 devel/sage/sage/algebras\", for example.\n\nAs far as I could tell, the presence (or lack) of init.sage was unrelated to the problem, so it wasn't in the patch.  I'm attaching a new patch which puts those lines back, just in case.  This patch runs \"sage-starts\" at the beginning no matter what: a few extra seconds to run this shouldn't be a big deal.\n\n(As I said on #7079, I think the issue is that doctesting creates various subdirectories of .sage, and if two processes both try to create .sage/gap at the same time, they clash and one of them bombs.  So running sage-starts to create most of the relevant directories seems like a solution.  In some bizarre set of circumstances, I can imagine that someone will have deleted everything in .sage except for init.sage, so we don't want to put sage-starts inside that \"if\" clause.  I suppose instead we could look for the directories .sage/db, .sage/gap, .sage/ipython, .sage/temp, .sage/tmp, and .sage/valgrind individually, creating whichever ones are missing.  Do we need to create any subdirectories of those in addition?  It seems cleaner to just run sage-starts.)",
    "created_at": "2009-11-12T22:15:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51032",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:6" align="right">comment:6</div>

I don't think the ".DS_Store" files have anything to do it: I can recreate this problem on sage.math by deleting my .sage directory and then doing "sage -tp 4 devel/sage/sage/algebras", for example.

As far as I could tell, the presence (or lack) of init.sage was unrelated to the problem, so it wasn't in the patch.  I'm attaching a new patch which puts those lines back, just in case.  This patch runs "sage-starts" at the beginning no matter what: a few extra seconds to run this shouldn't be a big deal.

(As I said on #7079, I think the issue is that doctesting creates various subdirectories of .sage, and if two processes both try to create .sage/gap at the same time, they clash and one of them bombs.  So running sage-starts to create most of the relevant directories seems like a solution.  In some bizarre set of circumstances, I can imagine that someone will have deleted everything in .sage except for init.sage, so we don't want to put sage-starts inside that "if" clause.  I suppose instead we could look for the directories .sage/db, .sage/gap, .sage/ipython, .sage/temp, .sage/tmp, and .sage/valgrind individually, creating whichever ones are missing.  Do we need to create any subdirectories of those in addition?  It seems cleaner to just run sage-starts.)



---

archive/issue_comments_051033.json:
```json
{
    "body": "Attachment: **[trac_7103-scripts-v2.patch.gz](https://github.com/sagemath/sage/files/ticket7103/trac_7103-scripts-v2.patch.gz)**\n\napply to scripts repository",
    "created_at": "2009-11-12T22:15:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51033",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment: **[trac_7103-scripts-v2.patch.gz](https://github.com/sagemath/sage/files/ticket7103/trac_7103-scripts-v2.patch.gz)**

apply to scripts repository



---

archive/issue_comments_051034.json:
```json
{
    "body": "Author: **John Palmieri**",
    "created_at": "2009-11-13T04:37:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51034",
    "user": "https://github.com/mwhansen"
}
```

Author: **John Palmieri**



---

archive/issue_events_086530.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-11-13T04:37:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86530"
}
```



---

archive/issue_events_086531.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-11-13T04:37:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86531"
}
```



---

archive/issue_comments_051035.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\n> \"(As I said on #7079, I think the issue is that doctesting creates \n> various subdirectories of .sage, and if two processes both try to \n> create .sage/gap at the same time, they clash and one of them bombs. ...\"\n\nThat's exactly right!",
    "created_at": "2009-11-13T04:49:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51035",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:8" align="right">comment:8</div>

> "(As I said on #7079, I think the issue is that doctesting creates 
> various subdirectories of .sage, and if two processes both try to 
> create .sage/gap at the same time, they clash and one of them bombs. ..."

That's exactly right!



---

archive/issue_events_086532.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-11-13T04:57:00Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86532"
}
```



---

archive/issue_events_086533.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-11-13T04:57:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86533"
}
```



---

archive/issue_comments_051036.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThis seems logical, the patch causes no harm, seems like a good idea, is eloquent.\n\nI don't know if it fixes the \"mysterious error\" issue, since I couldn't cause that error to occur.  However, I can understand in theory how it could fix that.  Positive review.",
    "created_at": "2009-11-13T04:57:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51036",
    "user": "https://github.com/williamstein"
}
```

<div id="comment:9" align="right">comment:9</div>

This seems logical, the patch causes no harm, seems like a good idea, is eloquent.

I don't know if it fixes the "mysterious error" issue, since I couldn't cause that error to occur.  However, I can understand in theory how it could fix that.  Positive review.



---

archive/issue_events_086534.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-11-13T04:57:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86534"
}
```



---

archive/issue_events_086535.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-11-13T04:57:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7103#event-86535"
}
```



---

archive/issue_comments_051037.json:
```json
{
    "body": "Reviewer: **William Stein**",
    "created_at": "2009-11-13T04:57:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51037",
    "user": "https://github.com/mwhansen"
}
```

Reviewer: **William Stein**



---

archive/issue_comments_051038.json:
```json
{
    "body": "Merged: **sage-4.2.1.rc0**",
    "created_at": "2009-11-13T04:57:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7103",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7103#issuecomment-51038",
    "user": "https://github.com/mwhansen"
}
```

Merged: **sage-4.2.1.rc0**
