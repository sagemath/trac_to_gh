# Issue 7483: notebook: move preparsing to the worksheet process and out of the server (was: weird pointless line)

archive/issues_007483.json:
```json
{
    "body": "In worksheet.py (at the end of `start_next_comp(self)`) in sagenb we have these lines:\n\n```\n        self.__comp_is_running = True\n        'exec _support_.preparse(base64.b64decode(\"%s\"))'%base64.b64encode(input)\n        self.sage().execute(input, os.path.abspath(self.data_directory()))\n```\n\nThat 'exec ' line in the middle is just sitting there making a string that is just discarded?\n\nThe issue is that I thought I had fully implemented moving all preparsing to the worksheet process (out of the server).  Unfortunately, I didn't -- in fact, I only figured out how to do it, but didn't finish. \n\nAssignee: boothby\n\nResolution: fixed\n\nAuthor: William Stein\n\nReviewer: Mitesh Patel\n\nMerged: sage-4.3.1.alpha0\n\nIssue created by migration from https://trac.sagemath.org/ticket/7483\n\n",
    "closed_at": "2010-01-04T06:34:13Z",
    "created_at": "2009-11-17T22:28:15Z",
    "labels": [
        "component: notebook"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.3.1",
    "title": "notebook: move preparsing to the worksheet process and out of the server (was: weird pointless line)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/7483",
    "user": "https://github.com/williamstein"
}
```
In worksheet.py (at the end of `start_next_comp(self)`) in sagenb we have these lines:

```
        self.__comp_is_running = True
        'exec _support_.preparse(base64.b64decode("%s"))'%base64.b64encode(input)
        self.sage().execute(input, os.path.abspath(self.data_directory()))
```

That 'exec ' line in the middle is just sitting there making a string that is just discarded?

The issue is that I thought I had fully implemented moving all preparsing to the worksheet process (out of the server).  Unfortunately, I didn't -- in fact, I only figured out how to do it, but didn't finish. 

Assignee: boothby

Resolution: fixed

Author: William Stein

Reviewer: Mitesh Patel

Merged: sage-4.3.1.alpha0

Issue created by migration from https://trac.sagemath.org/ticket/7483





---

archive/issue_comments_065218.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -6,7 +6,7 @@\n         self.sage().execute(input, os.path.abspath(self.data_directory()))\n \\`\\`\\`\n \n-That 'exec ' line in the middle is just sitting there making a string that is just discareded!?!?\n+That 'exec ' line in the middle is just sitting there making a string that is just discarded!?!?\n \n Comment: 1\n \n```\n",
    "created_at": "2009-11-17T22:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65218",
    "user": "https://github.com/williamstein"
}
```

Description changed:
```diff
--- 
+++ 
@@ -6,7 +6,7 @@
         self.sage().execute(input, os.path.abspath(self.data_directory()))
 \`\`\`
 
-That 'exec ' line in the middle is just sitting there making a string that is just discareded!?!?
+That 'exec ' line in the middle is just sitting there making a string that is just discarded!?!?
 
 Comment: 1
 
```




---

archive/issue_comments_065219.json:
```json
{
    "body": "<a id='comment:2'></a>I think I meant\n\n```\ninput = 'exec _support_.preparse(base64.b64decode(\"%s\"))'%base64.b64encode(input)\n```\nand to get rid of preparsing input at all done by the server.  In fact, I know for a fact I implemented things that way so that this wouldn't be broken:\n\n```\nimplicit_multiplication(True)\n///\nTraceback (most recent call last):\n...\nNotImplementedError: Implicit multiplication not implemented for the notebook.\n```\n\nBut now it seems to be broken again. \n\nI can only conclude that a serious mismerge or mangling has occurred to the code I originally wrote, since I definitely had the above working in an earlier version of sagenb.  \n\nHence, this ticket.",
    "created_at": "2009-11-17T22:33:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65219",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>I think I meant

```
input = 'exec _support_.preparse(base64.b64decode("%s"))'%base64.b64encode(input)
```
and to get rid of preparsing input at all done by the server.  In fact, I know for a fact I implemented things that way so that this wouldn't be broken:

```
implicit_multiplication(True)
///
Traceback (most recent call last):
...
NotImplementedError: Implicit multiplication not implemented for the notebook.
```

But now it seems to be broken again. 

I can only conclude that a serious mismerge or mangling has occurred to the code I originally wrote, since I definitely had the above working in an earlier version of sagenb.  

Hence, this ticket.



---

archive/issue_comments_065220.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+In worksheet.py (at the end of \\`start_next_comp(self)\\`) in sagenb we have these lines:\n \n+\\`\\`\\`\n+        self.__comp_is_running = True\n+        'exec _support_.preparse(base64.b64decode(\"%s\"))'%base64.b64encode(input)\n+        self.sage().execute(input, os.path.abspath(self.data_directory()))\n+\\`\\`\\`\n+\n+That 'exec ' line in the middle is just sitting there making a string that is just discarded?\n+\n+The issue is that I thought I had fully implemented moving all preparsing to the worksheet process (out of the server).  Unfortunately, I didn't -- in fact, I only figured out how to do it, but didn't finish. \n \n Comment: 1\n \n```\n",
    "created_at": "2009-11-17T23:53:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65220",
    "user": "https://github.com/williamstein"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+In worksheet.py (at the end of \`start_next_comp(self)\`) in sagenb we have these lines:
 
+\`\`\`
+        self.__comp_is_running = True
+        'exec _support_.preparse(base64.b64decode("%s"))'%base64.b64encode(input)
+        self.sage().execute(input, os.path.abspath(self.data_directory()))
+\`\`\`
+
+That 'exec ' line in the middle is just sitting there making a string that is just discarded?
+
+The issue is that I thought I had fully implemented moving all preparsing to the worksheet process (out of the server).  Unfortunately, I didn't -- in fact, I only figured out how to do it, but didn't finish. 
 
 Comment: 1
 
```




---

archive/issue_comments_065221.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2009-11-17T23:53:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65221",
    "user": "https://github.com/williamstein"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_065222.json:
```json
{
    "body": "apply to the sagenb spkg",
    "created_at": "2009-11-18T00:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65222",
    "user": "https://github.com/williamstein"
}
```

apply to the sagenb spkg



---

archive/issue_comments_065223.json:
```json
{
    "body": "Attachment [sagenb_7483.patch](tarball://root/attachments/some-uuid/ticket7483/sagenb_7483.patch) by @williamstein created at 2009-11-18 00:35:45\n\napply to the core sage library",
    "created_at": "2009-11-18T00:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65223",
    "user": "https://github.com/williamstein"
}
```

Attachment [sagenb_7483.patch](tarball://root/attachments/some-uuid/ticket7483/sagenb_7483.patch) by @williamstein created at 2009-11-18 00:35:45

apply to the core sage library



---

archive/issue_comments_065224.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2009-11-18T00:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65224",
    "user": "https://github.com/williamstein"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_065225.json:
```json
{
    "body": "<a id='comment:5'></a>Attachment [sagelib-7483.patch](tarball://root/attachments/some-uuid/ticket7483/sagelib-7483.patch) by @williamstein created at 2009-11-18 00:35:52",
    "created_at": "2009-11-18T00:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65225",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:5'></a>Attachment [sagelib-7483.patch](tarball://root/attachments/some-uuid/ticket7483/sagelib-7483.patch) by @williamstein created at 2009-11-18 00:35:52



---

archive/issue_comments_065226.json:
```json
{
    "body": "<a id='comment:6'></a>So the attached patch moves all the preparsing from the notebook server to the worksheet process.   I had thought I had made this change long ago, but I definitely hadn't.  It's *extremely* important from a security/robustness/speed/flexibility point of view.  Why?  Because it means the possibly time consuming and definitely _dangerous_ preparsing work gets pushed off to the worksheet processes, which will often be running on some remote virtual machines.  That's what we want!\n\nThis patch also makes it so the following are now fully supported in the notebook.  Note that they both used to not work at all:\n\n* implicit_multiplication -- turning on and off implicit multiplication\n\n* preparser -- turning on and off the preparser",
    "created_at": "2009-11-18T00:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65226",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:6'></a>So the attached patch moves all the preparsing from the notebook server to the worksheet process.   I had thought I had made this change long ago, but I definitely hadn't.  It's *extremely* important from a security/robustness/speed/flexibility point of view.  Why?  Because it means the possibly time consuming and definitely _dangerous_ preparsing work gets pushed off to the worksheet processes, which will often be running on some remote virtual machines.  That's what we want!

This patch also makes it so the following are now fully supported in the notebook.  Note that they both used to not work at all:

* implicit_multiplication -- turning on and off implicit multiplication

* preparser -- turning on and off the preparser



---

archive/issue_comments_065227.json:
```json
{
    "body": "<a id='comment:7'></a>I've put a new sagenb spkg with just this patch (and the one from 7483) here:\n\n   http://wstein.org/home/wstein/patches/sagenb/sagenb-0.4.3.p1.spkg",
    "created_at": "2009-11-18T03:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65227",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>I've put a new sagenb spkg with just this patch (and the one from 7483) here:

   http://wstein.org/home/wstein/patches/sagenb/sagenb-0.4.3.p1.spkg



---

archive/issue_comments_065228.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2009-11-18T06:36:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65228",
    "user": "https://github.com/qed777"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_065229.json:
```json
{
    "body": "<a id='comment:8'></a>The Selenium test results are unchanged in FF3.5.5 on Linux.  \n\n`make ptest` on sage.math passes.",
    "created_at": "2009-11-18T06:36:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65229",
    "user": "https://github.com/qed777"
}
```

<a id='comment:8'></a>The Selenium test results are unchanged in FF3.5.5 on Linux.  

`make ptest` on sage.math passes.



---

archive/issue_comments_065230.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2009-11-18T07:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65230",
    "user": "https://github.com/qed777"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_065231.json:
```json
{
    "body": "<a id='comment:9'></a>It seems that `load` and `save` are now broken in the notebook.\n\nWere `attach` and `detach` already broken in the notebook?",
    "created_at": "2009-11-18T07:25:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65231",
    "user": "https://github.com/qed777"
}
```

<a id='comment:9'></a>It seems that `load` and `save` are now broken in the notebook.

Were `attach` and `detach` already broken in the notebook?



---

archive/issue_comments_065232.json:
```json
{
    "body": "<a id='comment:10'></a>> It seems that load and save are now broken in the notebook.\n> Were attach and detach already broken in the notebook?\n\n\nNo, this broke them.  I'll fix the problem now.",
    "created_at": "2009-11-22T00:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65232",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:10'></a>> It seems that load and save are now broken in the notebook.
> Were attach and detach already broken in the notebook?


No, this broke them.  I'll fix the problem now.



---

archive/issue_comments_065233.json:
```json
{
    "body": "<a id='comment:11'></a>Clarification: load and save still work on .sage files, but don't work on .py. This is related to #4474.  But I'll fix it here now, hopefully.",
    "created_at": "2009-11-22T00:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65233",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>Clarification: load and save still work on .sage files, but don't work on .py. This is related to #4474.  But I'll fix it here now, hopefully.



---

archive/issue_comments_065234.json:
```json
{
    "body": "<a id='comment:12'></a>OK, I went a bit crazy and spent 8 hours completely rewriting and unifying and refactoring all the load/save/attach code.  This is at #7514.  With that, the above mentioned issued is gone.",
    "created_at": "2009-11-22T08:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65234",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:12'></a>OK, I went a bit crazy and spent 8 hours completely rewriting and unifying and refactoring all the load/save/attach code.  This is at #7514.  With that, the above mentioned issued is gone.



---

archive/issue_comments_065235.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2009-11-22T08:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65235",
    "user": "https://github.com/williamstein"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_065236.json:
```json
{
    "body": "<a id='comment:13'></a>Positive review, once #7514 passes.\n\nShould we also move \"docbrowser\" generation to a worksheet process?",
    "created_at": "2009-12-10T03:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65236",
    "user": "https://github.com/qed777"
}
```

<a id='comment:13'></a>Positive review, once #7514 passes.

Should we also move "docbrowser" generation to a worksheet process?



---

archive/issue_comments_065237.json:
```json
{
    "body": "<a id='comment:14'></a>> Should we also move \"docbrowser\" generation to a worksheet process? \n\n\nDefinitely!  The more that is done by worksheet processes, the better -- for scalability, security, etc.  Every spec of work done by the server is a potential speed and security problem.  The more that can be offloaded to worksheets, the better.",
    "created_at": "2009-12-10T18:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65237",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:14'></a>> Should we also move "docbrowser" generation to a worksheet process? 


Definitely!  The more that is done by worksheet processes, the better -- for scalability, security, etc.  Every spec of work done by the server is a potential speed and security problem.  The more that can be offloaded to worksheets, the better.



---

archive/issue_comments_065238.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2010-01-01T07:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65238",
    "user": "https://github.com/qed777"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_065239.json:
```json
{
    "body": "<a id='comment:16'></a>I've merged the sagelib patch in 4.3.1.alpha0",
    "created_at": "2010-01-03T22:31:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65239",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:16'></a>I've merged the sagelib patch in 4.3.1.alpha0



---

archive/issue_comments_065240.json:
```json
{
    "body": "<a id='comment:17'></a>I've merged this into sagenb-0.4.8.",
    "created_at": "2010-01-04T06:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65240",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:17'></a>I've merged this into sagenb-0.4.8.



---

archive/issue_comments_065241.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2010-01-04T06:34:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7483#issuecomment-65241",
    "user": "https://github.com/williamstein"
}
```

Resolution: fixed



---

archive/issue_events_017742.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2010-01-04T06:34:13Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/7483",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7483#event-17742"
}
```
