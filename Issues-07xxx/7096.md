# Issue 7096: bug in dual isogeny computation

archive/issues_007096.json:
```json
{
    "assignees": [],
    "body": "\n```\nsage: p = 1019\nsage: F = GF(p)\nsage: E = EllipticCurve(F,[1,-1,0,1,1])\nsage: psi = E.division_polynomial(7).factor()[3][0]\nsage: phi = E.isogeny(kernel=psi)\nsage: assert phi.degree()==7\nsage: phi.dual()\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n\n/home/jec/.sage/temp/selmer/14232/_home_jec__sage_init_sage_0.py in <module>()\n\n/home/jec/sage-4.1.2.rc0/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.pyc in dual(self)\n   2998\n   2999         phi_hat.set_pre_isomorphism(pre_isom)\n-> 3000         phi_hat.set_post_isomorphism(post_isom)\n   3001\n   3002         self.__dual = phi_hat\n\n/home/jec/sage-4.1.2.rc0/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.pyc in set_post_isomorphism(self, postWI)\n   2627\n   2628         if (self.__E2 != WIdom):\n-> 2629             raise ValueError, \"Invalid parameter: isomorphism must have domain curve equal to this isogenies'codomain.\"\n   2630\n   2631         if (None == self.__post_isomorphism):\n\nValueError: Invalid parameter: isomorphism must have domain curve equal to this isogenies' codomain.\n```\n\nThis looks like something which should be easy to fix.\n\nOne month of hard work later:  first impressions were deceptive! \n\nCC:  @shumow\n\nKeywords: **elliptic curve isogeny**\n\nReviewer: **John Cremona**\n\nAuthor: **Chris Wuthrich**\n\nMerged: **sage-4.2.1.alpha0**\n\nComponent: **elliptic curves**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/7096_\n\n",
    "closed_at": "2009-11-02T04:49:07Z",
    "created_at": "2009-10-02T15:05:02Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.2.1",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "bug in dual isogeny computation",
    "type": "issue",
    "updated_at": "2023-01-14T13:51:03Z",
    "url": "https://github.com/sagemath/sage/issues/7096",
    "user": "https://github.com/JohnCremona"
}
```

```
sage: p = 1019
sage: F = GF(p)
sage: E = EllipticCurve(F,[1,-1,0,1,1])
sage: psi = E.division_polynomial(7).factor()[3][0]
sage: phi = E.isogeny(kernel=psi)
sage: assert phi.degree()==7
sage: phi.dual()
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)

/home/jec/.sage/temp/selmer/14232/_home_jec__sage_init_sage_0.py in <module>()

/home/jec/sage-4.1.2.rc0/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.pyc in dual(self)
   2998
   2999         phi_hat.set_pre_isomorphism(pre_isom)
-> 3000         phi_hat.set_post_isomorphism(post_isom)
   3001
   3002         self.__dual = phi_hat

/home/jec/sage-4.1.2.rc0/local/lib/python2.6/site-packages/sage/schemes/elliptic_curves/ell_curve_isogeny.pyc in set_post_isomorphism(self, postWI)
   2627
   2628         if (self.__E2 != WIdom):
-> 2629             raise ValueError, "Invalid parameter: isomorphism must have domain curve equal to this isogenies'codomain."
   2630
   2631         if (None == self.__post_isomorphism):

ValueError: Invalid parameter: isomorphism must have domain curve equal to this isogenies' codomain.
```

This looks like something which should be easy to fix.

One month of hard work later:  first impressions were deceptive! 

CC:  @shumow

Keywords: **elliptic curve isogeny**

Reviewer: **John Cremona**

Author: **Chris Wuthrich**

Merged: **sage-4.2.1.alpha0**

Component: **elliptic curves**

_Issue created by migration from https://trac.sagemath.org/ticket/7096_





---

archive/issue_events_085739.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-10-02T15:05:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "milestone_number": null,
    "milestone_title": "sage-4.2.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85739"
}
```



---

archive/issue_events_085740.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-10-02T15:05:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20elliptic%20curves",
    "label_color": "0000ff",
    "label_name": "c: elliptic curves",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85740"
}
```



---

archive/issue_events_085741.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-10-02T15:05:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85741"
}
```



---

archive/issue_events_085742.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-10-02T15:05:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85742"
}
```



---

archive/issue_events_085743.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2009-10-02T15:05:02Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "subject": "https://github.com/JohnCremona",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85743"
}
```



---

archive/issue_events_085744.json:
```json
{
    "actor": "https://github.com/loefflerd",
    "created_at": "2009-10-09T09:10:20Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "subject": "https://github.com/loefflerd",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85744"
}
```



---

archive/issue_comments_050904.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nWhile looking at the code of `{dual()`, I found a second bug in this\n\n```\nE = EllipticCurve(GF(7),[1,-1,1,-3,3])\nphi = E.isogeny(E([1,0]))\nphi.dual()\n```\n\ngives a ZeroDivisionError. Only separable isogenies are implented, so one can not possibly take the dual of this separable isogeny of degree 7 in chracteristic 7. A quick check should be introduced here.",
    "created_at": "2009-10-09T09:24:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50904",
    "user": "https://github.com/categorie"
}
```

<div id="comment:2" align="right">comment:2</div>

While looking at the code of `{dual()`, I found a second bug in this

```
E = EllipticCurve(GF(7),[1,-1,1,-3,3])
phi = E.isogeny(E([1,0]))
phi.dual()
```

gives a ZeroDivisionError. Only separable isogenies are implented, so one can not possibly take the dual of this separable isogeny of degree 7 in chracteristic 7. A quick check should be introduced here.



---

archive/issue_comments_050905.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nYet another, bigger problem with dual() : Say E -> E' is an isogeny of degree d, then all the algorithm does is creating an isogeny E' -> E of degree d. This does not guarantee that it is the dual; it could be the dual composed with an automorphism, like [-1]. This probably happens quite often as it uses `WeierstrassIsomorphism(E,E')`. This returns one of the isomorphisms without any control of it, hence often the sign will be wrong.\n\nThe function dual definitely needs a lot of work.\n\nNow, the actual bug reported in this ticket is not in dual but occurs as\n\n```\nE1 = EllipticCurve(GF(1013),[1,-1,0,288,19])\nE2 = EllipticCurve(GF(1013),[7,970,0,363,464])\nEllipticCurveIsogeny(E1,None,E2,7)\n```",
    "created_at": "2009-10-09T10:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50905",
    "user": "https://github.com/categorie"
}
```

<div id="comment:3" align="right">comment:3</div>

Yet another, bigger problem with dual() : Say E -> E' is an isogeny of degree d, then all the algorithm does is creating an isogeny E' -> E of degree d. This does not guarantee that it is the dual; it could be the dual composed with an automorphism, like [-1]. This probably happens quite often as it uses `WeierstrassIsomorphism(E,E')`. This returns one of the isomorphisms without any control of it, hence often the sign will be wrong.

The function dual definitely needs a lot of work.

Now, the actual bug reported in this ticket is not in dual but occurs as

```
E1 = EllipticCurve(GF(1013),[1,-1,0,288,19])
E2 = EllipticCurve(GF(1013),[7,970,0,363,464])
EllipticCurveIsogeny(E1,None,E2,7)
```



---

archive/issue_comments_050906.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nOf course the field in the previous lines should be 1019. The output is\n\n```\nIsogeny of degree 7 from Elliptic Curve defined by y^2 + x*y = x^3 + 1018*x^2 + 288*x + 19 over Finite Field of size 1019 to Elliptic Curve defined by y^2 + 7*x*y + 850*y = x^3 + 970*x^2 + 445*x + 202 over Finite Field of size 1019\n```\n\nwhich has visibly the wrong, but an isomorphic codomain.\nAfter 1 hour of chasing through the code, I was not able to find the error. I include the author as CC in the hope that he might have an idea.",
    "created_at": "2009-10-09T11:52:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50906",
    "user": "https://github.com/categorie"
}
```

<div id="comment:4" align="right">comment:4</div>

Of course the field in the previous lines should be 1019. The output is

```
Isogeny of degree 7 from Elliptic Curve defined by y^2 + x*y = x^3 + 1018*x^2 + 288*x + 19 over Finite Field of size 1019 to Elliptic Curve defined by y^2 + 7*x*y + 850*y = x^3 + 970*x^2 + 445*x + 202 over Finite Field of size 1019
```

which has visibly the wrong, but an isomorphic codomain.
After 1 hour of chasing through the code, I was not able to find the error. I include the author as CC in the hope that he might have an idea.



---

archive/issue_comments_050907.json:
```json
{
    "body": "applies to 4.1.2. after trac #6886. this is only a provisional patch.",
    "created_at": "2009-10-17T23:10:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50907",
    "user": "https://github.com/categorie"
}
```

applies to 4.1.2. after trac #6886. this is only a provisional patch.



---

archive/issue_comments_050908.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAttachment: **[trac_7096.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096.patch.gz)**\n\nI worked on the bugs for isogenies and I found two. They should be corrected with the above patch. But I have to do some more work and test it carefully, before it is ready for a review.",
    "created_at": "2009-10-17T23:13:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50908",
    "user": "https://github.com/categorie"
}
```

<div id="comment:5" align="right">comment:5</div>

Attachment: **[trac_7096.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096.patch.gz)**

I worked on the bugs for isogenies and I found two. They should be corrected with the above patch. But I have to do some more work and test it carefully, before it is ready for a review.



---

archive/issue_comments_050909.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nI started implementing some more related to this ticket. Especially the `formal()` for isogeny. Then there are two ideas how to compute the dual.\n\n* I can take the implementation as it is now. This yields **a** isogeny of the correct degree\n  in the opposite direction. Then I can compute the leading term of the composition in the \n  formal expansion (or simply check to what multiple the differential is pulled-back to). This \n  gives me the `WeierstrassIsomorphism` to use. I am not 100 % sure if this will work in\n  all cases. Say the elliptic curve is defined over a finite field and has a cyclic isogeny of\n  degree *n<sup>2</sup>* to itself. It is certain that our current implementation gives back a cyclic \n  isogeny and not just *[n]*. I fear one could find counterexamples... I have to do some \n  testings.\n* Otherwise, I will try to implement the full computation of the dual via the formal group. I \n  believe that there is an algorithm with running time *O(n)* for an isogeny of prime degree \n  *n*. Though I have not checked this in details. It would only involve to compute the first \n  *2n* coefficients in *[n]* and the `division_polynomial` in the formal expansion. The \n  one example I have computed so far by hand was a failure :(. One obstacle here will be the \n  fact that `.reversion()` is only defined for power-series with coefficients in **Q**.\n\n\u00e0 suivre.",
    "created_at": "2009-10-23T09:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50909",
    "user": "https://github.com/categorie"
}
```

<div id="comment:6" align="right">comment:6</div>

I started implementing some more related to this ticket. Especially the `formal()` for isogeny. Then there are two ideas how to compute the dual.

* I can take the implementation as it is now. This yields **a** isogeny of the correct degree
  in the opposite direction. Then I can compute the leading term of the composition in the 
  formal expansion (or simply check to what multiple the differential is pulled-back to). This 
  gives me the `WeierstrassIsomorphism` to use. I am not 100 % sure if this will work in
  all cases. Say the elliptic curve is defined over a finite field and has a cyclic isogeny of
  degree *n<sup>2</sup>* to itself. It is certain that our current implementation gives back a cyclic 
  isogeny and not just *[n]*. I fear one could find counterexamples... I have to do some 
  testings.
* Otherwise, I will try to implement the full computation of the dual via the formal group. I 
  believe that there is an algorithm with running time *O(n)* for an isogeny of prime degree 
  *n*. Though I have not checked this in details. It would only involve to compute the first 
  *2n* coefficients in *[n]* and the `division_polynomial` in the formal expansion. The 
  one example I have computed so far by hand was a failure :(. One obstacle here will be the 
  fact that `.reversion()` is only defined for power-series with coefficients in **Q**.

à suivre.



---

archive/issue_comments_050910.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI found another issue with isogenies.\n\n```\nE = EllipticCurve('11a1')\nE2 = EllipticCurve('11a2')\nE2.isogeny(None,codomain=E1,degree=5)\n```\n\nfails with \n\n```\nValueError: Codomain parameter must be isomorphic to computed codomain isogeny\n```\n\nwhile `E.isogeny(None,codomain=E2,degree=5)` works fine. The reason is that the algorithm for computing the kernel polynomial in `compute_isogeny_starks` is only valid for **normalised** isogenies. \n\nStark's algorithm is implemented in ell_curve_isogeny.py from scratch and so it contains the computation of the formal expansion of the Weierstrass p function. I wonder if we should add as another possible algorithm to do the same sort of computation, but using the already existing code for formal groups instead. ....",
    "created_at": "2009-10-23T23:47:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50910",
    "user": "https://github.com/categorie"
}
```

<div id="comment:7" align="right">comment:7</div>

I found another issue with isogenies.

```
E = EllipticCurve('11a1')
E2 = EllipticCurve('11a2')
E2.isogeny(None,codomain=E1,degree=5)
```

fails with 

```
ValueError: Codomain parameter must be isomorphic to computed codomain isogeny
```

while `E.isogeny(None,codomain=E2,degree=5)` works fine. The reason is that the algorithm for computing the kernel polynomial in `compute_isogeny_starks` is only valid for **normalised** isogenies. 

Stark's algorithm is implemented in ell_curve_isogeny.py from scratch and so it contains the computation of the formal expansion of the Weierstrass p function. I wonder if we should add as another possible algorithm to do the same sort of computation, but using the already existing code for formal groups instead. ....



---

archive/issue_comments_050911.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nYet another bug with `dual`. I have to chase that. It does not look like being related to the previously reported bugs.\n\n```\nk = GF(103)\nE = EllipticCurve(k,[1,0,0,1,-1])\nP = E(60,85)\nphi = E.isogeny(P)\nphi.dual()\n```\n\ngives\n\n```\nIndexError: list index out of range\n```\n\nin  line 3789.\n\n(I keep on adding these bugs here and I try to resolve as many as I can with the patch for this. Only then I will open new tickets for the remaining ones)",
    "created_at": "2009-10-24T17:29:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50911",
    "user": "https://github.com/categorie"
}
```

<div id="comment:8" align="right">comment:8</div>

Yet another bug with `dual`. I have to chase that. It does not look like being related to the previously reported bugs.

```
k = GF(103)
E = EllipticCurve(k,[1,0,0,1,-1])
P = E(60,85)
phi = E.isogeny(P)
phi.dual()
```

gives

```
IndexError: list index out of range
```

in  line 3789.

(I keep on adding these bugs here and I try to resolve as many as I can with the patch for this. Only then I will open new tickets for the remaining ones)



---

archive/issue_comments_050912.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nThanks for your work on this.  Perhaps we should make dual raise a NotImplementedError since it fails in so many different ways?\n\nI think that when Dan Shumow implemented all the isogeny stuff he was mainly interested in certain kinds of isogenies (over finite fields?) so did not test as much in other situations.  Just guessing.  [For example, he added the model parameter on my request, over Q only;  I would have made that the default over Q.]",
    "created_at": "2009-10-24T19:19:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50912",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:9" align="right">comment:9</div>

Thanks for your work on this.  Perhaps we should make dual raise a NotImplementedError since it fails in so many different ways?

I think that when Dan Shumow implemented all the isogeny stuff he was mainly interested in certain kinds of isogenies (over finite fields?) so did not test as much in other situations.  Just guessing.  [For example, he added the model parameter on my request, over Q only;  I would have made that the default over Q.]



---

archive/issue_comments_050913.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nThe problem is that most errors go back to problems for the `EllipticCurveIsogeny` constructor itself. So they can be recreated without `dual`. Of course, I don't want `isogeny()` to raise a `NotImplementedError`. But I will include warnings in the documentation...",
    "created_at": "2009-10-24T20:22:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50913",
    "user": "https://github.com/categorie"
}
```

<div id="comment:10" align="right">comment:10</div>

The problem is that most errors go back to problems for the `EllipticCurveIsogeny` constructor itself. So they can be recreated without `dual`. Of course, I don't want `isogeny()` to raise a `NotImplementedError`. But I will include warnings in the documentation...



---

archive/issue_comments_050914.json:
```json
{
    "body": "Attachment: **[trac_7096_2.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096_2.patch.gz)**\n\nAnother preliminary version. Replaces the previous patch.",
    "created_at": "2009-10-29T13:37:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50914",
    "user": "https://github.com/categorie"
}
```

Attachment: **[trac_7096_2.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096_2.patch.gz)**

Another preliminary version. Replaces the previous patch.



---

archive/issue_comments_050915.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nOK. Here we go. That is a patch for this ticket that I would like to be reviewed.\n\nI explain all the changes it introduces as it is quite a long and complicated patch. (I like the fact that the initial comment on the ticket was *\"This looks like something which should be easy to fix.\"* while it took me a month of quite hard work.)\n\n* I moved the computation of the weierstrass p-function into a seperate file ell_wp.py.\n  I also completely clean it. It used to contain a lot of functions on power series that\n  are already implemented in sage. There is an option now to call the pari version.\n* I added a `weierstrass_p` to ell_field.py.\n* Having redone all the weierstrass_p with laurent and power series rather than with \n  polynomials, also got rid of the `IndexError` mentioned above.\n* The dual is now correct and not just up to an automorphism.\n* When trying to give an isogeny with a codomain, it now checks if the algorithm fails\n  (typically because there is no cyclic normalized isogeny of this degree). This eliminates a\n  bad bug that was known in the code.\n* We can now take duals of non-normalized isogenies\n* There is a new function `formal` that computes the formal expansion of the isogeny.\n* This `formal` can be used to check if the isogeny is normalized; this simplifies and\n  corrects the previous code (which is still there but deprecated).\n* I included a check to forbid `dual` of isogenies of degree divisible by the \n  charactersitic.\n* I updated a lot of the documentation of isogenies.\n* And I also changed the starting documentation of ell_generic.py to clarify what we mean by\n  an elliptic curve in sage.\n \nThere is still a lot that should be done about isogenies for elliptic curves. I hope this patch corrects and clarifies what is possible right now. For further things that one could wish for in sage concerning isogenies and endomorphisms I opened ticket #7368 as a follow up.\n\nNote that this ticket also includes the correction asked for in #7307.",
    "created_at": "2009-11-01T14:28:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50915",
    "user": "https://github.com/categorie"
}
```

<div id="comment:11" align="right">comment:11</div>

OK. Here we go. That is a patch for this ticket that I would like to be reviewed.

I explain all the changes it introduces as it is quite a long and complicated patch. (I like the fact that the initial comment on the ticket was *"This looks like something which should be easy to fix."* while it took me a month of quite hard work.)

* I moved the computation of the weierstrass p-function into a seperate file ell_wp.py.
  I also completely clean it. It used to contain a lot of functions on power series that
  are already implemented in sage. There is an option now to call the pari version.
* I added a `weierstrass_p` to ell_field.py.
* Having redone all the weierstrass_p with laurent and power series rather than with 
  polynomials, also got rid of the `IndexError` mentioned above.
* The dual is now correct and not just up to an automorphism.
* When trying to give an isogeny with a codomain, it now checks if the algorithm fails
  (typically because there is no cyclic normalized isogeny of this degree). This eliminates a
  bad bug that was known in the code.
* We can now take duals of non-normalized isogenies
* There is a new function `formal` that computes the formal expansion of the isogeny.
* This `formal` can be used to check if the isogeny is normalized; this simplifies and
  corrects the previous code (which is still there but deprecated).
* I included a check to forbid `dual` of isogenies of degree divisible by the 
  charactersitic.
* I updated a lot of the documentation of isogenies.
* And I also changed the starting documentation of ell_generic.py to clarify what we mean by
  an elliptic curve in sage.
 
There is still a lot that should be done about isogenies for elliptic curves. I hope this patch corrects and clarifies what is possible right now. For further things that one could wish for in sage concerning isogenies and endomorphisms I opened ticket #7368 as a follow up.

Note that this ticket also includes the correction asked for in #7307.



---

archive/issue_comments_050916.json:
```json
{
    "body": "patch for this ticket exported against 4.2.alpha1. (in particular after #6886). This patch should be reviewed while the previously submitted should be ignored.",
    "created_at": "2009-11-01T14:29:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50916",
    "user": "https://github.com/categorie"
}
```

patch for this ticket exported against 4.2.alpha1. (in particular after #6886). This patch should be reviewed while the previously submitted should be ignored.



---

archive/issue_events_085745.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2009-11-01T14:30:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85745"
}
```



---

archive/issue_comments_050917.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nAttachment: **[trac_7096_3.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096_3.patch.gz)**",
    "created_at": "2009-11-01T14:30:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50917",
    "user": "https://github.com/categorie"
}
```

<div id="comment:12" align="right">comment:12</div>

Attachment: **[trac_7096_3.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096_3.patch.gz)**



---

archive/issue_events_085746.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2009-11-01T14:33:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85746"
}
```



---

archive/issue_events_085747.json:
```json
{
    "actor": "https://github.com/categorie",
    "created_at": "2009-11-01T14:33:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85747"
}
```



---

archive/issue_comments_050918.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nSorry I saw that the patch does not include the new file ell_wp.py.",
    "created_at": "2009-11-01T14:33:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50918",
    "user": "https://github.com/categorie"
}
```

<div id="comment:13" align="right">comment:13</div>

Sorry I saw that the patch does not include the new file ell_wp.py.



---

archive/issue_comments_050919.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nYou have done a great job, and I look forward to studying it in detail.  Unfortunately other work prevents me from doing so for quite a while, so although I was the one who posted this (complete with under-estimation of the work involved) I would be very happy if someone else interested reviews it first.",
    "created_at": "2009-11-01T15:06:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50919",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:14" align="right">comment:14</div>

You have done a great job, and I look forward to studying it in detail.  Unfortunately other work prevents me from doing so for quite a while, so although I was the one who posted this (complete with under-estimation of the work involved) I would be very happy if someone else interested reviews it first.



---

archive/issue_comments_050920.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -31,3 +31,4 @@\n \n This looks like something which should be easy to fix.\n \n+One month of hard work later:  first impressions were deceptive! \n``````\n",
    "created_at": "2009-11-01T15:06:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50920",
    "user": "https://github.com/JohnCremona"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -31,3 +31,4 @@
 
 This looks like something which should be easy to fix.
 
+One month of hard work later:  first impressions were deceptive! 
``````




---

archive/issue_events_085748.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-11-01T15:06:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85748"
}
```



---

archive/issue_events_085749.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-11-01T15:06:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85749"
}
```



---

archive/issue_comments_050921.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nAfter writing the above I went ahead anyway and read the patch -- when ell_wp.py is added too I'll try test to test it as well.",
    "created_at": "2009-11-01T15:15:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50921",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:16" align="right">comment:16</div>

After writing the above I went ahead anyway and read the patch -- when ell_wp.py is added too I'll try test to test it as well.



---

archive/issue_comments_050922.json:
```json
{
    "body": "Attachment: **[trac_7096_4.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096_4.patch.gz)**\n\nReplaces all previous patches.",
    "created_at": "2009-11-01T15:19:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50922",
    "user": "https://github.com/categorie"
}
```

Attachment: **[trac_7096_4.patch.gz](https://github.com/sagemath/sage/files/ticket7096/trac_7096_4.patch.gz)**

Replaces all previous patches.



---

archive/issue_comments_050923.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nOk that was easy. now it should be review-able.",
    "created_at": "2009-11-01T15:23:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50923",
    "user": "https://github.com/categorie"
}
```

<div id="comment:17" align="right">comment:17</div>

Ok that was easy. now it should be review-able.



---

archive/issue_comments_050924.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nOK, I relented and have reviewed the patch.  It is great.  It applies fine to 4.2 and builds and tests ok.  (Even better, my not-yet-complete patch for #6887 applied OK on top of this, so a large piece of work which uses isogenies a lot still works fine;  that is a very good test, I think).  I also built and read through the documentation, which is good -- better than before in several respects.  I may have spotted a typo or too but did not note them down so will not delay things by hunting them down.\n\nPositive review: and gives me a spur to finish #6887.",
    "created_at": "2009-11-01T17:06:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50924",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:18" align="right">comment:18</div>

OK, I relented and have reviewed the patch.  It is great.  It applies fine to 4.2 and builds and tests ok.  (Even better, my not-yet-complete patch for #6887 applied OK on top of this, so a large piece of work which uses isogenies a lot still works fine;  that is a very good test, I think).  I also built and read through the documentation, which is good -- better than before in several respects.  I may have spotted a typo or too but did not note them down so will not delay things by hunting them down.

Positive review: and gives me a spur to finish #6887.



---

archive/issue_events_085750.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-11-01T17:06:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85750"
}
```



---

archive/issue_events_085751.json:
```json
{
    "actor": "https://github.com/JohnCremona",
    "created_at": "2009-11-01T17:06:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85751"
}
```



---

archive/issue_comments_050925.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThat was quick ! Thanks a lot.\n\nChris.",
    "created_at": "2009-11-01T17:37:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50925",
    "user": "https://github.com/categorie"
}
```

<div id="comment:19" align="right">comment:19</div>

That was quick ! Thanks a lot.

Chris.



---

archive/issue_events_085752.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-11-02T04:49:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85752"
}
```



---

archive/issue_events_085753.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-11-02T04:49:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7096#event-85753"
}
```



---

archive/issue_comments_050926.json:
```json
{
    "body": "Reviewer: **John Cremona**",
    "created_at": "2009-11-02T04:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50926",
    "user": "https://github.com/mwhansen"
}
```

Reviewer: **John Cremona**



---

archive/issue_comments_050927.json:
```json
{
    "body": "Author: **Christian Wuthrich**",
    "created_at": "2009-11-02T04:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50927",
    "user": "https://github.com/mwhansen"
}
```

Author: **Christian Wuthrich**



---

archive/issue_comments_050928.json:
```json
{
    "body": "Merged: **sage-4.2.1.alpha0**",
    "created_at": "2009-11-02T04:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50928",
    "user": "https://github.com/mwhansen"
}
```

Merged: **sage-4.2.1.alpha0**



---

archive/issue_comments_050929.json:
```json
{
    "body": "Changed author from **Christian Wuthrich** to **Chris Wuthrich**",
    "created_at": "2016-10-31T16:54:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7096",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7096#issuecomment-50929",
    "user": "https://github.com/fchapoton"
}
```

Changed author from **Christian Wuthrich** to **Chris Wuthrich**
