# Issue 7630: Require email confirmation before account activation

archive/issues_007630.json:
```json
{
    "body": "Right now it says in the Settings page \"Require e-mail for account registration\".  This implies to me that an account will not be activated until a valid email address is added.  Furthermore, when this is checked, a new account screen says: \"Your email address is required for account confirmation and recovery. You will be emailed a confirmation link right after you successfully sign up.\"  This definitely implies that an account will not be activated until the user clicks on a link.\n\nHowever, the account is activated, whether or not the user clicks on the link in the email.\n\nIf we're going through the trouble of making a link and confirming email addresses, it makes sense to follow the well-established practice of not letting the user log in until they confirm their email address.\n\nIt seems that this could be a very easy check in the login stage, too.  Just check to see if \"require email address\" is set, and if so, check to make sure the user's email address is confirmed.\n\n\n\n**Assignee:** @williamstein\n\n**Reviewer:** Jeroen Demeyer\n\n**Resolution:** invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/7630\n\n",
    "closed_at": "2013-02-08T13:23:54Z",
    "created_at": "2009-12-08T20:04:21Z",
    "labels": [
        "component: notebook",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Require email confirmation before account activation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/7630",
    "user": "https://github.com/jasongrout"
}
```
Right now it says in the Settings page "Require e-mail for account registration".  This implies to me that an account will not be activated until a valid email address is added.  Furthermore, when this is checked, a new account screen says: "Your email address is required for account confirmation and recovery. You will be emailed a confirmation link right after you successfully sign up."  This definitely implies that an account will not be activated until the user clicks on a link.

However, the account is activated, whether or not the user clicks on the link in the email.

If we're going through the trouble of making a link and confirming email addresses, it makes sense to follow the well-established practice of not letting the user log in until they confirm their email address.

It seems that this could be a very easy check in the login stage, too.  Just check to see if "require email address" is set, and if so, check to make sure the user's email address is confirmed.



**Assignee:** @williamstein

**Reviewer:** Jeroen Demeyer

**Resolution:** invalid

Issue created by migration from https://trac.sagemath.org/ticket/7630





---

archive/issue_comments_082413.json:
```json
{
    "body": "<a id='comment:1'></a>\nPatch up, please review. Sorry for the whitespace noise in the patch, I have nuke-trailing-whitespace on in emacs.\n\nSeveral issues I noticed while working on this:\n\n* The confirmation tokens are not saved across sessions, so if a user signs up, then you quit the notebook and restart, then the user clicks on the confirmation URL, the server says it doesn't know about that confirmation token. This may or may not be something we want to fix.\n* We should have a way of letting the admin user bypass the email confirmation, since email can get lost, etc. Perhaps another column in the suspend/reset user account page, so that the admin can just click to consider the email confirmed, or to bypass email confirmation for that user. Or, we might have a \"resend confirmation email\" feature. Perhaps we should have both.",
    "created_at": "2010-02-08T12:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82413",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:1'></a>
Patch up, please review. Sorry for the whitespace noise in the patch, I have nuke-trailing-whitespace on in emacs.

Several issues I noticed while working on this:

* The confirmation tokens are not saved across sessions, so if a user signs up, then you quit the notebook and restart, then the user clicks on the confirmation URL, the server says it doesn't know about that confirmation token. This may or may not be something we want to fix.
* We should have a way of letting the admin user bypass the email confirmation, since email can get lost, etc. Perhaps another column in the suspend/reset user account page, so that the admin can just click to consider the email confirmed, or to bypass email confirmation for that user. Or, we might have a "resend confirmation email" feature. Perhaps we should have both.



---

archive/issue_comments_082414.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2010-02-08T12:05:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82414",
    "user": "https://github.com/dandrake"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_082415.json:
```json
{
    "body": "<a id='comment:2'></a>\nReplying to [ddrake](#comment%3A1):\n> Patch up, please review. Sorry for the whitespace noise in the patch, I have nuke-trailing-whitespace on in emacs.\n> \n\n\n...\n\n>   * We should have a way of letting the admin user bypass the email confirmation, since email can get lost, etc. \n\n\n\nI totally agree. IMHO this is not a good feature unless it can be turned off. I also am unclear how the email is to be sent out. \nInstall a mail server too? (a) This is not allowed where I work, except on certain machines. (b) If I am using Sage on a local lan set up for a specific computer lab then I am not interested in wasting class time with confirmation emails. In my opinion, there should be something like accounts_with_confirmation=True to implement this and accounts = True does not. If the only option to setting up accounts once this patch is applied is to require email confirmation then I think this patch \"needs work\".\n\nHopefully I am just completely misunderstanding the entire purpose of this ticket.",
    "created_at": "2010-02-08T12:26:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82415",
    "user": "https://github.com/wdjoyner"
}
```

<a id='comment:2'></a>
Replying to [ddrake](#comment%3A1):
> Patch up, please review. Sorry for the whitespace noise in the patch, I have nuke-trailing-whitespace on in emacs.
> 


...

>   * We should have a way of letting the admin user bypass the email confirmation, since email can get lost, etc. 



I totally agree. IMHO this is not a good feature unless it can be turned off. I also am unclear how the email is to be sent out. 
Install a mail server too? (a) This is not allowed where I work, except on certain machines. (b) If I am using Sage on a local lan set up for a specific computer lab then I am not interested in wasting class time with confirmation emails. In my opinion, there should be something like accounts_with_confirmation=True to implement this and accounts = True does not. If the only option to setting up accounts once this patch is applied is to require email confirmation then I think this patch "needs work".

Hopefully I am just completely misunderstanding the entire purpose of this ticket.



---

archive/issue_comments_082416.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [wdj](#comment%3A2):\n\n> >   * We should have a way of letting the admin user bypass the email confirmation, since email can get lost, etc.  \n \n> \n> I totally agree. IMHO this is not a good feature unless it can be turned off. I also am unclear how the email is to be sent out.\n\n\nTwisted includes an SMTP server.\n\n (b) If I am using Sage on a local lan set up for a specific computer lab then I am not interested in wasting class time with confirmation emails. In my opinion, there should be something like accounts_with_confirmation=True to implement this and accounts = True does not.\n\nAs the admin user, go to Settings -> Notebook Settings -> Require email for account registration. You can tick the box to require it, or leave it unticked.\n\n> Hopefully I am just completely misunderstanding the entire purpose of this ticket.\n\n\nRight now, the notebook server has the option to require email confirmation before logging in -- but you can log in anyway, even before the email has been confirmed. That's the purpose of this ticket. No one will be forced to do anything with email registration / confirmation.",
    "created_at": "2010-02-08T13:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82416",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:3'></a>
Replying to [wdj](#comment%3A2):

> >   * We should have a way of letting the admin user bypass the email confirmation, since email can get lost, etc.  
 
> 
> I totally agree. IMHO this is not a good feature unless it can be turned off. I also am unclear how the email is to be sent out.


Twisted includes an SMTP server.

 (b) If I am using Sage on a local lan set up for a specific computer lab then I am not interested in wasting class time with confirmation emails. In my opinion, there should be something like accounts_with_confirmation=True to implement this and accounts = True does not.

As the admin user, go to Settings -> Notebook Settings -> Require email for account registration. You can tick the box to require it, or leave it unticked.

> Hopefully I am just completely misunderstanding the entire purpose of this ticket.


Right now, the notebook server has the option to require email confirmation before logging in -- but you can log in anyway, even before the email has been confirmed. That's the purpose of this ticket. No one will be forced to do anything with email registration / confirmation.



---

archive/issue_comments_082417.json:
```json
{
    "body": "<a id='comment:4'></a>\nBTW, with this patch, if the admin user adds a user on the \"Manage Users\" page when \"require email\" is checked, that user cannot log in until his email is confirmed...and since there's no email associated to the user, it's spectacularly unlikely that the user will ever be able to login.\n\nAlso, I don't know how this will work with existing users who have never had their email addresses confirmed. For backwards compatibility, it would be nice if there was some kind of \"has_logged_in_at_least_once\" boolean that we could test; if the user has already logged in somehow, email confirmation gets bypassed.",
    "created_at": "2010-02-08T13:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82417",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:4'></a>
BTW, with this patch, if the admin user adds a user on the "Manage Users" page when "require email" is checked, that user cannot log in until his email is confirmed...and since there's no email associated to the user, it's spectacularly unlikely that the user will ever be able to login.

Also, I don't know how this will work with existing users who have never had their email addresses confirmed. For backwards compatibility, it would be nice if there was some kind of "has_logged_in_at_least_once" boolean that we could test; if the user has already logged in somehow, email confirmation gets bypassed.



---

archive/issue_comments_082418.json:
```json
{
    "body": "<a id='comment:5'></a>\nattachment:trac_7630-with-debugging.patch is, I think, a working patch. It is still full of print statements that I used while working on this, and doesn't have any updated docstrings yet. But I think it works. It's against 4.3.2 (sagenb 0.7.4). \n\nIn this setup, if the admin user adds a user, no email confirmation is ever required. Each regular user has a email_confirmation variable, which replaces the old email_confirmed boolean, and can be one of three states: not_required, pending, and confirmed. All users get not_required, except those that register themselves while email confirmation is turned on; they get 'pending'.\n\nThis patch is not ready for a \"real\" review yet, but please test and look over the code.",
    "created_at": "2010-02-24T03:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82418",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:5'></a>
attachment:trac_7630-with-debugging.patch is, I think, a working patch. It is still full of print statements that I used while working on this, and doesn't have any updated docstrings yet. But I think it works. It's against 4.3.2 (sagenb 0.7.4). 

In this setup, if the admin user adds a user, no email confirmation is ever required. Each regular user has a email_confirmation variable, which replaces the old email_confirmed boolean, and can be one of three states: not_required, pending, and confirmed. All users get not_required, except those that register themselves while email confirmation is turned on; they get 'pending'.

This patch is not ready for a "real" review yet, but please test and look over the code.



---

archive/issue_comments_082419.json:
```json
{
    "body": "version 2 of patch, with lots of print statements",
    "created_at": "2010-02-24T07:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82419",
    "user": "https://github.com/dandrake"
}
```

version 2 of patch, with lots of print statements



---

archive/issue_comments_082420.json:
```json
{
    "body": "<a id='comment:6'></a>\nAttachment [trac_7630-with-debugging.patch](tarball://root/attachments/some-uuid/ticket7630/trac_7630-with-debugging.patch) by @dandrake created at 2010-02-24 07:59:33\n\nCurrent version should pass doctests if you comment out the print statement in `add_user` in notebook.py (line 509).",
    "created_at": "2010-02-24T07:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82420",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:6'></a>
Attachment [trac_7630-with-debugging.patch](tarball://root/attachments/some-uuid/ticket7630/trac_7630-with-debugging.patch) by @dandrake created at 2010-02-24 07:59:33

Current version should pass doctests if you comment out the print statement in `add_user` in notebook.py (line 509).



---

archive/issue_comments_082421.json:
```json
{
    "body": "<a id='comment:7'></a>\nIn #8454, we are updating the docstring for `notebook()`, which uses an outdated call for `add_user`. Since this patch alters that function's parameters, we should also make sure to update the generic instructions for `notebook()` if necessary.",
    "created_at": "2010-03-06T08:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82421",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:7'></a>
In #8454, we are updating the docstring for `notebook()`, which uses an outdated call for `add_user`. Since this patch alters that function's parameters, we should also make sure to update the generic instructions for `notebook()` if necessary.



---

archive/issue_comments_082422.json:
```json
{
    "body": "<a id='comment:8'></a>\nIs this really \"needs review\"?  The last few comments seem to indicate that it is still \"needs work\".",
    "created_at": "2010-04-15T03:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82422",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:8'></a>
Is this really "needs review"?  The last few comments seem to indicate that it is still "needs work".



---

archive/issue_comments_082423.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [jason](#comment%3A8):\n> Is this really \"needs review\"?  The last few comments seem to indicate that it is still \"needs work\".\n\n\nWell, there's lots of print statements throughout the code, and I decided to leave those in for reviewing purposes. When I was working on this, I found it very hard to follow the execution path, so I put in lots of \"prints\" -- it seems like a reviewer would also appreciate the help in seeing what's happening.\n\nAfter the patch gets a good review, I can add a small remove-all-the-prints patch.\n\n(Although I would like to see the notebook print more information; some kind of verbose logging option would be really useful.)",
    "created_at": "2010-04-15T11:47:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82423",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:9'></a>
Replying to [jason](#comment%3A8):
> Is this really "needs review"?  The last few comments seem to indicate that it is still "needs work".


Well, there's lots of print statements throughout the code, and I decided to leave those in for reviewing purposes. When I was working on this, I found it very hard to follow the execution path, so I put in lots of "prints" -- it seems like a reviewer would also appreciate the help in seeing what's happening.

After the patch gets a good review, I can add a small remove-all-the-prints patch.

(Although I would like to see the notebook print more information; some kind of verbose logging option would be really useful.)



---

archive/issue_comments_082424.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [ddrake](#comment%3A9):\n> Replying to [jason](#comment%3A8):\n> > Is this really \"needs review\"?  The last few comments seem to indicate that it is still \"needs work\".\n\n> \n> Well, there's lots of print statements throughout the code, and I decided to leave those in for reviewing purposes. When I was working on this, I found it very hard to follow the execution path, so I put in lots of \"prints\" -- it seems like a reviewer would also appreciate the help in seeing what's happening.\n> \n> After the patch gets a good review, I can add a small remove-all-the-prints patch.\n\n\nPlease make all the print statements conditional, e.g., write a function\n\n```\n   def log_devel(s):\n        if VERBOSE: print s\n```\nand call that function everywhere.    Then make a file-scope variable VERBOSE which is False in your patch.\nExplain here (and in a comment) that by setting it to True, the reviewer can enable devel logging.  This'll get\nused elsewhere too. \n\n -- William",
    "created_at": "2010-04-24T23:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82424",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:10'></a>
Replying to [ddrake](#comment%3A9):
> Replying to [jason](#comment%3A8):
> > Is this really "needs review"?  The last few comments seem to indicate that it is still "needs work".

> 
> Well, there's lots of print statements throughout the code, and I decided to leave those in for reviewing purposes. When I was working on this, I found it very hard to follow the execution path, so I put in lots of "prints" -- it seems like a reviewer would also appreciate the help in seeing what's happening.
> 
> After the patch gets a good review, I can add a small remove-all-the-prints patch.


Please make all the print statements conditional, e.g., write a function

```
   def log_devel(s):
        if VERBOSE: print s
```
and call that function everywhere.    Then make a file-scope variable VERBOSE which is False in your patch.
Explain here (and in a comment) that by setting it to True, the reviewer can enable devel logging.  This'll get
used elsewhere too. 

 -- William



---

archive/issue_comments_082425.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2010-04-24T23:53:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82425",
    "user": "https://github.com/williamstein"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_082426.json:
```json
{
    "body": "Attachment [trac_7630.patch](tarball://root/attachments/some-uuid/ticket7630/trac_7630.patch) by @dandrake created at 2010-04-26 07:41:26\n\nversion 3 of patch. Apply only this.",
    "created_at": "2010-04-26T07:41:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82426",
    "user": "https://github.com/dandrake"
}
```

Attachment [trac_7630.patch](tarball://root/attachments/some-uuid/ticket7630/trac_7630.patch) by @dandrake created at 2010-04-26 07:41:26

version 3 of patch. Apply only this.



---

archive/issue_comments_082427.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2010-04-26T07:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82427",
    "user": "https://github.com/dandrake"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_082428.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [was](#comment%3A10):\n> Please make all the print statements conditional, e.g., write a function\n> \n> ```\n>    def log_devel(s):\n>         if VERBOSE: print s\n> ```\n> and call that function everywhere.    Then make a file-scope variable VERBOSE which is False in your patch.\n> Explain here (and in a comment) that by setting it to True, the reviewer can enable devel logging.  This'll get\n> used elsewhere too. \n\n\nOkay, done. I've rebased the patch so it applies to sagenb 0.8.1 (see #8727).",
    "created_at": "2010-04-26T07:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82428",
    "user": "https://github.com/dandrake"
}
```

<a id='comment:11'></a>
Replying to [was](#comment%3A10):
> Please make all the print statements conditional, e.g., write a function
> 
> ```
>    def log_devel(s):
>         if VERBOSE: print s
> ```
> and call that function everywhere.    Then make a file-scope variable VERBOSE which is False in your patch.
> Explain here (and in a comment) that by setting it to True, the reviewer can enable devel logging.  This'll get
> used elsewhere too. 


Okay, done. I've rebased the patch so it applies to sagenb 0.8.1 (see #8727).



---

archive/issue_comments_082429.json:
```json
{
    "body": "<a id='comment:12'></a>\nPlease fill in your real name as Author.",
    "created_at": "2012-07-27T20:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82429",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Please fill in your real name as Author.



---

archive/issue_events_022885.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-05T19:33:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7630#event-22885"
}
```



---

archive/issue_comments_082430.json:
```json
{
    "body": "**Reviewer:** Jeroen Demeyer",
    "created_at": "2013-02-05T19:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82430",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Jeroen Demeyer



---

archive/issue_comments_082431.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-02-05T19:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82431",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_082432.json:
```json
{
    "body": "<a id='comment:13'></a>\nI think this should be closed since the notebook is now a separate project and in any case, there is work on a completely new frontend.",
    "created_at": "2013-02-05T19:33:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82432",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
I think this should be closed since the notebook is now a separate project and in any case, there is work on a completely new frontend.



---

archive/issue_events_022886.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-08T13:23:54Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7630#event-22886"
}
```



---

archive/issue_comments_082433.json:
```json
{
    "body": "**Resolution:** invalid",
    "created_at": "2013-02-08T13:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7630",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7630#issuecomment-82433",
    "user": "https://github.com/jdemeyer"
}
```

**Resolution:** invalid
