# Issue 7646: preparsing file should start *after* the module docstring (factoring constants out messed things up)

archive/issues_007646.json:
```json
{
    "assignees": [],
    "body": "\n```\nHello William,\nI've done some more snooping\ninto this, and the preparse_file function is messing up the file by adding\nlines of the form\n\n _sage_const_2 = Integer(2); _sage_const_3 = Integer(3)\n\nto the {top} of the file. Thus, in most cases, the function\n\n find_position_right_after_docstring\n\nnever really gets to do its thing properly. I've temporarily fixed this by\nsetting the default value of numeric_literals to False in sage-preparse.\nThis problem still seems to be around in version 4.2....\n\nBest,\n\n---\nSubject: SAGE: is the preparser really supposed to be messing up my module docstrings?\n\nHello William,\n\nI poked around a bit in the sage source code, for the preparser, and it seems\nthat the intention is not to mess up module docstrings:\n\n file: $SAGE_ROOT/local/bin/sage-preparse, lines: 125ff\n -----------------------------------------------------\n   ...\n   # Put the Sage library include along with a autogen message in the file.\n   # It is ** critical ** that we put this after the mdoule docstring, since\n   # otherwise the module docstring will disappear.\n   insert = '%s%s.\\nfrom sage.all_cmdline import *   # import sage library\\n'%(AUTOGEN_MSG, f)\n   i = find_position_right_after_module_docstring(G)\n   ...\n\nhowever, with regard to the subject line, see the sage session below.\n\n$ ./sage-4.0.2/sage\n----------------------------------------------------------------------\n| Sage Version 4.0.2, Release Date: 2009-06-18                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nsage: cat my_mod.sage\n\"\"\"\nThis is the module docstring for my_mod.sage. There is one function\n\n my_func()\n\nand one variable\n\n my_var\n\"\"\"\n\ndef my_func():\n   return 7\n\nmy_var = 8\nsage: !./sage-4.0.2/sage -preparse my_mod.sage\nsage: cat my_mod.py\n# This file was *autogenerated* from the file my_mod.sage.\nfrom sage.all_cmdline import *   # import sage library\n_sage_const_8 = Integer(8); _sage_const_7 = Integer(7)\n\"\"\"\nThis is the module docstring for my_mod.sage. There is one function\n\n my_func()\n\nand one variable\n\n my_var\n\"\"\"\n\ndef my_func():\n   return _sage_const_7\n\nmy_var = _sage_const_8\nsage: import my_mod\nsage: my_mod?\nType:           module\nBase Class:     <type 'module'>\nString Form:    <module 'my_mod' from 'my_mod.py'>\nNamespace:      Interactive\nFile:           /home/defu/my_mod.py\nDocstring:\n   x.__init__(...) initializes x; see x.__class__.__doc__ for signature\n\nsage:\n```\n\n**Assignee:** @williamstein\n\nIssue created by migration from https://trac.sagemath.org/ticket/7646\n\n",
    "created_at": "2009-12-10T01:04:03Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20user%20interface",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.4",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "preparsing file should start *after* the module docstring (factoring constants out messed things up)",
    "type": "issue",
    "updated_at": "2014-08-10T16:51:03Z",
    "url": "https://github.com/sagemath/sage/issues/7646",
    "user": "https://github.com/williamstein"
}
```

```
Hello William,
I've done some more snooping
into this, and the preparse_file function is messing up the file by adding
lines of the form

 _sage_const_2 = Integer(2); _sage_const_3 = Integer(3)

to the {top} of the file. Thus, in most cases, the function

 find_position_right_after_docstring

never really gets to do its thing properly. I've temporarily fixed this by
setting the default value of numeric_literals to False in sage-preparse.
This problem still seems to be around in version 4.2....

Best,

---
Subject: SAGE: is the preparser really supposed to be messing up my module docstrings?

Hello William,

I poked around a bit in the sage source code, for the preparser, and it seems
that the intention is not to mess up module docstrings:

 file: $SAGE_ROOT/local/bin/sage-preparse, lines: 125ff
 -----------------------------------------------------
   ...
   # Put the Sage library include along with a autogen message in the file.
   # It is ** critical ** that we put this after the mdoule docstring, since
   # otherwise the module docstring will disappear.
   insert = '%s%s.\nfrom sage.all_cmdline import *   # import sage library\n'%(AUTOGEN_MSG, f)
   i = find_position_right_after_module_docstring(G)
   ...

however, with regard to the subject line, see the sage session below.

$ ./sage-4.0.2/sage
----------------------------------------------------------------------
| Sage Version 4.0.2, Release Date: 2009-06-18                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
sage: cat my_mod.sage
"""
This is the module docstring for my_mod.sage. There is one function

 my_func()

and one variable

 my_var
"""

def my_func():
   return 7

my_var = 8
sage: !./sage-4.0.2/sage -preparse my_mod.sage
sage: cat my_mod.py
# This file was *autogenerated* from the file my_mod.sage.
from sage.all_cmdline import *   # import sage library
_sage_const_8 = Integer(8); _sage_const_7 = Integer(7)
"""
This is the module docstring for my_mod.sage. There is one function

 my_func()

and one variable

 my_var
"""

def my_func():
   return _sage_const_7

my_var = _sage_const_8
sage: import my_mod
sage: my_mod?
Type:           module
Base Class:     <type 'module'>
String Form:    <module 'my_mod' from 'my_mod.py'>
Namespace:      Interactive
File:           /home/defu/my_mod.py
Docstring:
   x.__init__(...) initializes x; see x.__class__.__doc__ for signature

sage:
```

**Assignee:** @williamstein

Issue created by migration from https://trac.sagemath.org/ticket/7646





---

archive/issue_events_078728.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-12-10T01:04:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78728"
}
```



---

archive/issue_events_078729.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-12-10T01:04:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20user%20interface",
    "label_color": "08517b",
    "label_name": "component: user interface",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78729"
}
```



---

archive/issue_events_078730.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-12-10T01:04:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78730"
}
```



---

archive/issue_events_078731.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78731"
}
```



---

archive/issue_events_078732.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78732"
}
```



---

archive/issue_events_078733.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78733"
}
```



---

archive/issue_events_078734.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78734"
}
```



---

archive/issue_events_078735.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78735"
}
```



---

archive/issue_events_078736.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78736"
}
```



---

archive/issue_events_078737.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78737"
}
```



---

archive/issue_events_078738.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7646",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7646#event-78738"
}
```
