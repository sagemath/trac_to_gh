# Issue 7997: Use ast to replace display hook hack, and replace pexpect based WorksheetProcess classes with Pipe-based ones

archive/issues_007997.json:
```json
{
    "assignees": [],
    "body": "Please see ticket:7997:comment:10 for more details.\n\n**Assignee:** @williamstein\n\n**CC:**  @TimDumol acleone @qed777 @williamstein boothby @jasongrout @fchapoton\n\n**Reviewer:** Dima Pasechnik\n\n**Author:** Alex Leone, Tim Dumol\n\nIssue created by migration from https://trac.sagemath.org/ticket/7997\n\n",
    "closed_at": "2020-08-29T15:27:48Z",
    "created_at": "2010-01-19T15:09:00Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20notebook",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Use ast to replace display hook hack, and replace pexpect based WorksheetProcess classes with Pipe-based ones",
    "type": "issue",
    "updated_at": "2020-08-29T15:27:48Z",
    "url": "https://github.com/sagemath/sage/issues/7997",
    "user": "https://github.com/sagetrac-acleone"
}
```
Please see ticket:7997:comment:10 for more details.

**Assignee:** @williamstein

**CC:**  @TimDumol acleone @qed777 @williamstein boothby @jasongrout @fchapoton

**Reviewer:** Dima Pasechnik

**Author:** Alex Leone, Tim Dumol

Issue created by migration from https://trac.sagemath.org/ticket/7997





---

archive/issue_events_083157.json:
```json
{
    "actor": "https://github.com/sagetrac-acleone",
    "created_at": "2010-01-19T15:09:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20notebook",
    "label_color": "08517b",
    "label_name": "component: notebook",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83157"
}
```



---

archive/issue_events_083158.json:
```json
{
    "actor": "https://github.com/sagetrac-acleone",
    "created_at": "2010-01-19T15:09:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83158"
}
```



---

archive/issue_events_083159.json:
```json
{
    "actor": "https://github.com/sagetrac-acleone",
    "created_at": "2010-01-19T15:09:00Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "008080",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83159"
}
```



---

archive/issue_comments_062931.json:
```json
{
    "body": "Incomplete implementation",
    "created_at": "2010-01-19T16:08:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62931",
    "user": "https://github.com/TimDumol"
}
```

Incomplete implementation



---

archive/issue_comments_062932.json:
```json
{
    "body": "<a id='comment:1'></a>\n**Attachment:** [trac_7997-ast-display-hook-incomplete.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook-incomplete.patch.gz)\n\nHey, are you working on the pexpect stuff yet? If not, I'll start work on it as soon as you reply.",
    "created_at": "2010-01-20T23:59:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62932",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:1'></a>
**Attachment:** [trac_7997-ast-display-hook-incomplete.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook-incomplete.patch.gz)

Hey, are you working on the pexpect stuff yet? If not, I'll start work on it as soon as you reply.



---

archive/issue_comments_062933.json:
```json
{
    "body": "<a id='comment:2'></a>\nOk, you should probably work on this.  I think this patch should just change the way `%sage`/`%python` is executed:\n1. Preparse to valid python\n2. Save to a file.\n   * Not base64 encoded, etc, just straight the straight unicode text after Preparsing\n   * (So the file matches the cell exactly except for preparsing)\n3. Parse the source into an ast\n   * syntax errors are caught here\n4. Unless `%no_print_exprs` or something, add in `print_if_not_none` calls with the `ast.NodeTransformer` for any `Expr` nodes that aren't in function def's.\n5. exec the ast tree, with globals set to a dictionary built from all previously evaluated cells and sage globals",
    "created_at": "2010-01-21T02:28:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62933",
    "user": "https://github.com/sagetrac-acleone"
}
```

<a id='comment:2'></a>
Ok, you should probably work on this.  I think this patch should just change the way `%sage`/`%python` is executed:
1. Preparse to valid python
2. Save to a file.
   * Not base64 encoded, etc, just straight the straight unicode text after Preparsing
   * (So the file matches the cell exactly except for preparsing)
3. Parse the source into an ast
   * syntax errors are caught here
4. Unless `%no_print_exprs` or something, add in `print_if_not_none` calls with the `ast.NodeTransformer` for any `Expr` nodes that aren't in function def's.
5. exec the ast tree, with globals set to a dictionary built from all previously evaluated cells and sage globals



---

archive/issue_comments_062934.json:
```json
{
    "body": "<a id='comment:3'></a>\nHey, I think I'm gonna be pretty busy till I graduate this March, so if anyone wants to work on this patch, I'm posting an updated incomplete patch now. The new interface based on multiprocessing seems to work quite well, with a 300ms speed boost (really makes things seem lightning fast on local calculation of cheap stuff), but I haven't quite found out exactly how to get file saving to work properly. It would be great if anyone could do so.\n\nPlease note that this patch does not work well with the pexpect implementation (changing location of preparsing, etc. means that it probably won't work at all), and so even after fixing the pipes implementation, either the remote pexpect implementation should be fixed, or a new remote implementation should be made (I'm thinking a quick Twisted [or even `asyncore`] server/client should do the job, with a similar interface as the pipes interface between server & client).",
    "created_at": "2010-02-01T10:06:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62934",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:3'></a>
Hey, I think I'm gonna be pretty busy till I graduate this March, so if anyone wants to work on this patch, I'm posting an updated incomplete patch now. The new interface based on multiprocessing seems to work quite well, with a 300ms speed boost (really makes things seem lightning fast on local calculation of cheap stuff), but I haven't quite found out exactly how to get file saving to work properly. It would be great if anyone could do so.

Please note that this patch does not work well with the pexpect implementation (changing location of preparsing, etc. means that it probably won't work at all), and so even after fixing the pipes implementation, either the remote pexpect implementation should be fixed, or a new remote implementation should be made (I'm thinking a quick Twisted [or even `asyncore`] server/client should do the job, with a similar interface as the pipes interface between server & client).



---

archive/issue_events_083160.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-02-01T10:06:48Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83160"
}
```



---

archive/issue_comments_062935.json:
```json
{
    "body": "Incomplete implementation. See comments for elaboration.",
    "created_at": "2010-02-01T10:07:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62935",
    "user": "https://github.com/TimDumol"
}
```

Incomplete implementation. See comments for elaboration.



---

archive/issue_comments_062936.json:
```json
{
    "body": "<a id='comment:4'></a>\n**Attachment:** [trac_7997-ast-display-hook-incomplete.2.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook-incomplete.2.patch.gz)\n\nI'd like to work on this patch.  At this point we're doing a lot more than just replacing the display hook hack - what should the scope of this patch be?\n\n(Tom, correct me if I'm wrong) The patch currently:\n1. Replaces the display hook hack with a much more robust implementation using python's [ast library](http://docs.python.org/library/ast.html).\n2. Adds a new process implementation that passes a data object across\n   * The old implementation passed a string to get exec-ed.  The string was \"write this base64 encoded string to a file and exec it\".\n   * The new implementation gets the data object, writes the preparsed string to a file (just so exec will have line numbers), and exec's the string.  This is faster because it's only one exec.",
    "created_at": "2010-02-01T18:11:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62936",
    "user": "https://github.com/sagetrac-acleone"
}
```

<a id='comment:4'></a>
**Attachment:** [trac_7997-ast-display-hook-incomplete.2.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook-incomplete.2.patch.gz)

I'd like to work on this patch.  At this point we're doing a lot more than just replacing the display hook hack - what should the scope of this patch be?

(Tom, correct me if I'm wrong) The patch currently:
1. Replaces the display hook hack with a much more robust implementation using python's [ast library](http://docs.python.org/library/ast.html).
2. Adds a new process implementation that passes a data object across
   * The old implementation passed a string to get exec-ed.  The string was "write this base64 encoded string to a file and exec it".
   * The new implementation gets the data object, writes the preparsed string to a file (just so exec will have line numbers), and exec's the string.  This is faster because it's only one exec.



---

archive/issue_comments_062937.json:
```json
{
    "body": "<a id='comment:5'></a>\nActually I'm assuming it's faster due to the reduced I/O (less files) and post-processing (filtering things out with pexpect).\n\nI'd say the scope should be getting a working local and remote WorksheetProcess implementation, changing the interface as judged as needed. The resulting implementation should have functionality that is at least equivalent, if not a superset of, the local and remote pexpect interfaces. There should be no noticeable change in output for clients, except for speed differences. Notably, the traceback output should remain properly.\n\nBy the way, it's Tim.",
    "created_at": "2010-02-06T11:22:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62937",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:5'></a>
Actually I'm assuming it's faster due to the reduced I/O (less files) and post-processing (filtering things out with pexpect).

I'd say the scope should be getting a working local and remote WorksheetProcess implementation, changing the interface as judged as needed. The resulting implementation should have functionality that is at least equivalent, if not a superset of, the local and remote pexpect interfaces. There should be no noticeable change in output for clients, except for speed differences. Notably, the traceback output should remain properly.

By the way, it's Tim.



---

archive/issue_comments_062938.json:
```json
{
    "body": "<a id='comment:6'></a>\nHi, has there been any progress on this? I'd love to assist/continue any work done here.",
    "created_at": "2010-03-09T15:48:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62938",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:6'></a>
Hi, has there been any progress on this? I'd love to assist/continue any work done here.



---

archive/issue_comments_062939.json:
```json
{
    "body": "<a id='comment:7'></a>\nUnfortunately not - I overestimated the amount of time I had.",
    "created_at": "2010-03-09T16:40:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62939",
    "user": "https://github.com/sagetrac-acleone"
}
```

<a id='comment:7'></a>
Unfortunately not - I overestimated the amount of time I had.



---

archive/issue_comments_062940.json:
```json
{
    "body": "**Attachment:** [trac_7997-ast-display-hook-incomplete.1.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook-incomplete.1.patch.gz)\n\nCompletely working (hopefully) implementation of a local WorksheetProcess. Need to implement a remote version too, before this patch is ready.",
    "created_at": "2010-04-02T11:40:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62940",
    "user": "https://github.com/TimDumol"
}
```

**Attachment:** [trac_7997-ast-display-hook-incomplete.1.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook-incomplete.1.patch.gz)

Completely working (hopefully) implementation of a local WorksheetProcess. Need to implement a remote version too, before this patch is ready.



---

archive/issue_comments_062941.json:
```json
{
    "body": "<a id='comment:8'></a>\nHi,\n\nI have managed to finish the local implementation of WorksheetProcess_PipesImplementation (WPPI), and I have found it to be roughly 251.3 ms faster than WorksheetProcess_ExpectImplementation (WPEI). The patch, however, makes WPEI and its remote equivalent useless, due to an API change on the WorksheetProcess interface. This means that to finish this patch, a remote implementation must be made, and that both be *very* thoroughly tested.\n\nHere are the benchmark results, if anyone's interested:\n\n```\nsage: from sagenb.interfaces.pipes_interface import WorksheetProcess_PipesImpl as WPPI\nsage: wp = WPPI()\n\n# This is without the print_expressions, which is not equivalent to what WPEI does. Mean: 251.53 \u00b5s\nsage: timeit(\"\"\"wp.execute('print 1', preparse=False, print_expressions=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 488 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('print 1', preparse=False, print_expressions=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 451 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('print 1', preparse=False, print_expressions=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 424 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('print 1', preparse=False, print_expressions=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 481 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('print 1', preparse=False, print_expressions=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 479 \u00b5s per loop\n\nsage: wp.execute('from sage.all_notebook import *; import sagenb', preparse=False, print_expressions=False)\n\n# This, on the other hand, is. Mean: 680 \u00b5s\nsage: timeit(\"\"\"wp.execute('1', preparse=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 664 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('1', preparse=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 734 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('1', preparse=False)\\nwhile wp.is_computing(): pass\"\"\")\n5 loops, best of 3: 601 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('1', preparse=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 739 \u00b5s per loop\nsage: timeit(\"\"\"wp.execute('1', preparse=False)\\nwhile wp.is_computing(): pass\"\"\")\n625 loops, best of 3: 664 \u00b5s per loop\n\n# Note, this has preparsing. This checks to see if the speedup scales. It does not.\nsage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): pass\"\"\")\n5 loops, best of 3: 21.5 ms per loop\nsage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): pass\"\"\")\n25 loops, best of 3: 19.6 ms per loop\nsage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): pass\"\"\")\n25 loops, best of 3: 19.5 ms per loop\nsage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): pass\"\"\")\n25 loops, best of 3: 17.7 ms per loop\nsage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): pass\"\"\")\n25 loops, best of 3: 19.7 ms per loop\n```\n\nBy contrast, here is the benchmark for WPEI:\n\n```\nsage: from sagenb.interfaces.expect import WorksheetProcess_ExpectImplementation as WPEI\nsage: wp = WPEI()\n\nsage: timeit(\"\"\"wp.execute('1')\\nwhile wp.is_computing():\\n    wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: timeit(\"\"\"wp.execute('1')\\nwhile wp.is_computing():\\n    wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: timeit(\"\"\"wp.execute('1')\\nwhile wp.is_computing():\\n    wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: timeit(\"\"\"wp.execute('1')\\nwhile wp.is_computing():\\n    wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: timeit(\"\"\"wp.execute('1')\\nwhile wp.is_computing():\\n    wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\n\n# Transmission lag is much slower than computation time, which accounts for the lack of difference, I think.\nsage: sage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: sage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: sage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: sage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\nsage: sage: timeit(\"\"\"wp.execute('[x for x in primes(1e4)]')\\nwhile wp.is_computing(): wp.output_status()\"\"\")\n5 loops, best of 3: 252 ms per loop\n```",
    "created_at": "2010-04-02T12:04:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62941",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:8'></a>
Hi,

I have managed to finish the local implementation of WorksheetProcess_PipesImplementation (WPPI), and I have found it to be roughly 251.3 ms faster than WorksheetProcess_ExpectImplementation (WPEI). The patch, however, makes WPEI and its remote equivalent useless, due to an API change on the WorksheetProcess interface. This means that to finish this patch, a remote implementation must be made, and that both be *very* thoroughly tested.

Here are the benchmark results, if anyone's interested:

```
sage: from sagenb.interfaces.pipes_interface import WorksheetProcess_PipesImpl as WPPI
sage: wp = WPPI()

# This is without the print_expressions, which is not equivalent to what WPEI does. Mean: 251.53 µs
sage: timeit("""wp.execute('print 1', preparse=False, print_expressions=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 488 µs per loop
sage: timeit("""wp.execute('print 1', preparse=False, print_expressions=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 451 µs per loop
sage: timeit("""wp.execute('print 1', preparse=False, print_expressions=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 424 µs per loop
sage: timeit("""wp.execute('print 1', preparse=False, print_expressions=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 481 µs per loop
sage: timeit("""wp.execute('print 1', preparse=False, print_expressions=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 479 µs per loop

sage: wp.execute('from sage.all_notebook import *; import sagenb', preparse=False, print_expressions=False)

# This, on the other hand, is. Mean: 680 µs
sage: timeit("""wp.execute('1', preparse=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 664 µs per loop
sage: timeit("""wp.execute('1', preparse=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 734 µs per loop
sage: timeit("""wp.execute('1', preparse=False)\nwhile wp.is_computing(): pass""")
5 loops, best of 3: 601 µs per loop
sage: timeit("""wp.execute('1', preparse=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 739 µs per loop
sage: timeit("""wp.execute('1', preparse=False)\nwhile wp.is_computing(): pass""")
625 loops, best of 3: 664 µs per loop

# Note, this has preparsing. This checks to see if the speedup scales. It does not.
sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): pass""")
5 loops, best of 3: 21.5 ms per loop
sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): pass""")
25 loops, best of 3: 19.6 ms per loop
sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): pass""")
25 loops, best of 3: 19.5 ms per loop
sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): pass""")
25 loops, best of 3: 17.7 ms per loop
sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): pass""")
25 loops, best of 3: 19.7 ms per loop
```

By contrast, here is the benchmark for WPEI:

```
sage: from sagenb.interfaces.expect import WorksheetProcess_ExpectImplementation as WPEI
sage: wp = WPEI()

sage: timeit("""wp.execute('1')\nwhile wp.is_computing():\n    wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: timeit("""wp.execute('1')\nwhile wp.is_computing():\n    wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: timeit("""wp.execute('1')\nwhile wp.is_computing():\n    wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: timeit("""wp.execute('1')\nwhile wp.is_computing():\n    wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: timeit("""wp.execute('1')\nwhile wp.is_computing():\n    wp.output_status()""")
5 loops, best of 3: 252 ms per loop

# Transmission lag is much slower than computation time, which accounts for the lack of difference, I think.
sage: sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): wp.output_status()""")
5 loops, best of 3: 252 ms per loop
sage: sage: timeit("""wp.execute('[x for x in primes(1e4)]')\nwhile wp.is_computing(): wp.output_status()""")
5 loops, best of 3: 252 ms per loop
```



---

archive/issue_comments_062942.json:
```json
{
    "body": "<a id='comment:9'></a>\nWow - that's awesome - great work Tim!  I definitely need to read up on the `multiprocessing` module.  Using `multiprocessing.Pipe()` and `multiprocessing.Connection()` is definitely the way to go.  Also it should be fairly easy to create a remote implementation with `multiprocessing.connection.Client()`.\n\nJust a note for others on how this works: The worker process that executes the code has a `multiprocessing.Connection()` back to the manager process.  That connection can `send(obj)` and `recv() -> obj`, where `obj` is a picklable object, in this case:\n* Manager to Worker: `ExecutionData(preparse, print_expressions, string, tempdir, temp_file.name, transaction_number)` objects\n* Worker to Manager: either `(transaction_number, data)` where `data` is a string from `sys.stdout` or `sys.stderr`, or `(transaction_number, 0)` where the `0` means that the computation is finished.",
    "created_at": "2010-04-02T17:40:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62942",
    "user": "https://github.com/sagetrac-acleone"
}
```

<a id='comment:9'></a>
Wow - that's awesome - great work Tim!  I definitely need to read up on the `multiprocessing` module.  Using `multiprocessing.Pipe()` and `multiprocessing.Connection()` is definitely the way to go.  Also it should be fairly easy to create a remote implementation with `multiprocessing.connection.Client()`.

Just a note for others on how this works: The worker process that executes the code has a `multiprocessing.Connection()` back to the manager process.  That connection can `send(obj)` and `recv() -> obj`, where `obj` is a picklable object, in this case:
* Manager to Worker: `ExecutionData(preparse, print_expressions, string, tempdir, temp_file.name, transaction_number)` objects
* Worker to Manager: either `(transaction_number, data)` where `data` is a string from `sys.stdout` or `sys.stderr`, or `(transaction_number, 0)` where the `0` means that the computation is finished.



---

archive/issue_comments_062943.json:
```json
{
    "body": "Completely working implementation of a remote WorksheetProcess. Deprecates pexepct-based WP's. See comments for more.",
    "created_at": "2010-04-03T15:22:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62943",
    "user": "https://github.com/TimDumol"
}
```

Completely working implementation of a remote WorksheetProcess. Deprecates pexepct-based WP's. See comments for more.



---

archive/issue_comments_062944.json:
```json
{
    "body": "<a id='comment:10'></a>\n**Attachment:** [trac_7997-ast-display-hook.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.patch.gz)\n\nTom Boothby, I'm adding you to the CC since this also fixes the problem with the tracebacks you mentioned to me last January.\n\nThis version of the patch is hopefully the final version of the patch. It does the following:\n\n* Uses ast to replace the displayhook_hack in `sagenb.misc.format`, this was achieved through the efforts of me and Alex Leone (thank you!).\n\n  * The new version, now named `parse_display_expr`, can now print either the last expression, as before:\n\n```\n1\n2\n3\n----\n3\n```\n\n  or all root level expressions:\n\n```\n1\n2\nfor x in range(3):\n    x\n3\n-----\n1\n2\n3\n```\n\n  or all expressions:\n\n```\n1\n2\nfor x in range(2):\n    x\n3\n-----\n1\n2\n0\n1\n3\n```\n\n     This new functionality is customizable via the Notebook Settings page.\n\n* Adds new WorksheetProcess implementations based on `multiprocessing`, and deprecates the pexpect based ones, since this also changes the WorksheetProcess API. The blocking reference implementation has been updated to the new API.\n\n  * The local implementation (`WorksheetProcess_PipesImpl`) is on average 251.3 ms faster than the pexpect based one.\n\n  * The remote implementation ('WorksheetProcess_RemoteSSHPipesImpl`) is on average 212 ms faster than the remote pexpect based one. For now, it has the same vulnerabilities as the old one, with one additional: the connection between the main server and the computing server is unencrypted, and thus may be snooped on. It is trivial to fix this, however I am not sure whether the speed (and extra computing load) tradeoffs are worth it.\n\n* It now formats tracebacks as:\n\n```\nTraceback (most recent call last):\n  Line 7, in <module>\n    bar()\n  Line 5, in bar\n    foo()\n  Line 2, in foo\n    raise Exception(\"Hello\")\nException: Hello\n```\n\ninstead of:\n\n```\nTraceback (most recent call last):    def baz():\n  File \"\", line 1, in <module>\n    \n  File \"/tmp/tmpfzcGzr/___code___.py\", line 13, in <module>\n    baz()\n  File \"\", line 1, in <module>\n    \n  File \"/tmp/tmpfzcGzr/___code___.py\", line 10, in baz\n    bar()\n  File \"/tmp/tmpfzcGzr/___code___.py\", line 7, in bar\n    foo()\n  File \"/tmp/tmpfzcGzr/___code___.py\", line 4, in foo\n    raise Exception(\"Hello\")\nException: Hello\n```\n\nwhich have their line numbers offset by +2, also.",
    "created_at": "2010-04-03T15:44:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62944",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:10'></a>
**Attachment:** [trac_7997-ast-display-hook.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.patch.gz)

Tom Boothby, I'm adding you to the CC since this also fixes the problem with the tracebacks you mentioned to me last January.

This version of the patch is hopefully the final version of the patch. It does the following:

* Uses ast to replace the displayhook_hack in `sagenb.misc.format`, this was achieved through the efforts of me and Alex Leone (thank you!).

  * The new version, now named `parse_display_expr`, can now print either the last expression, as before:

```
1
2
3
----
3
```

  or all root level expressions:

```
1
2
for x in range(3):
    x
3
-----
1
2
3
```

  or all expressions:

```
1
2
for x in range(2):
    x
3
-----
1
2
0
1
3
```

     This new functionality is customizable via the Notebook Settings page.

* Adds new WorksheetProcess implementations based on `multiprocessing`, and deprecates the pexpect based ones, since this also changes the WorksheetProcess API. The blocking reference implementation has been updated to the new API.

  * The local implementation (`WorksheetProcess_PipesImpl`) is on average 251.3 ms faster than the pexpect based one.

  * The remote implementation ('WorksheetProcess_RemoteSSHPipesImpl`) is on average 212 ms faster than the remote pexpect based one. For now, it has the same vulnerabilities as the old one, with one additional: the connection between the main server and the computing server is unencrypted, and thus may be snooped on. It is trivial to fix this, however I am not sure whether the speed (and extra computing load) tradeoffs are worth it.

* It now formats tracebacks as:

```
Traceback (most recent call last):
  Line 7, in <module>
    bar()
  Line 5, in bar
    foo()
  Line 2, in foo
    raise Exception("Hello")
Exception: Hello
```

instead of:

```
Traceback (most recent call last):    def baz():
  File "", line 1, in <module>
    
  File "/tmp/tmpfzcGzr/___code___.py", line 13, in <module>
    baz()
  File "", line 1, in <module>
    
  File "/tmp/tmpfzcGzr/___code___.py", line 10, in baz
    bar()
  File "/tmp/tmpfzcGzr/___code___.py", line 7, in bar
    foo()
  File "/tmp/tmpfzcGzr/___code___.py", line 4, in foo
    raise Exception("Hello")
Exception: Hello
```

which have their line numbers offset by +2, also.



---

archive/issue_comments_062945.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,34 +1 @@\n-See http://docs.python.org/library/ast.html#ast.NodeTransformer\n-\n-Replace any Expr node in the ast tree with a function call to\n-\n-```\n-def __print_if_not_none(expr):\n-    if expr is not None:\n-        print expr\n-```\n-An Expr node is anything like\n-\n-```\n-123\n-do_foo()\n-for i in range(10):\n-    i\n-```\n-Which will be replaced by\n-\n-```\n-__print_if_not_none(123)\n-__print_if_not_none(do_foo())\n-for i in range(10):\n-    __print_if_not_none(i)\n-```\n-Which will output\n-\n-```\n-123\n-0\n-1\n-...\n-9\n-```\n+Please see ticket:7997:comment:10 for more details.\n``````\n",
    "created_at": "2010-04-03T15:44:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62945",
    "user": "https://github.com/TimDumol"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,34 +1 @@
-See http://docs.python.org/library/ast.html#ast.NodeTransformer
-
-Replace any Expr node in the ast tree with a function call to
-
-```
-def __print_if_not_none(expr):
-    if expr is not None:
-        print expr
-```
-An Expr node is anything like
-
-```
-123
-do_foo()
-for i in range(10):
-    i
-```
-Which will be replaced by
-
-```
-__print_if_not_none(123)
-__print_if_not_none(do_foo())
-for i in range(10):
-    __print_if_not_none(i)
-```
-Which will output
-
-```
-123
-0
-1
-...
-9
-```
+Please see ticket:7997:comment:10 for more details.
``````




---

archive/issue_events_083161.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-03T15:44:17Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "rename": {
        "from": "Use ast to replace display hook hack",
        "to": "Use ast to replace display hook hack, and replace pexpect based WorksheetProcess classes with Pipe-based ones"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83161"
}
```



---

archive/issue_events_083162.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-03T15:44:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83162"
}
```



---

archive/issue_events_083163.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-03T15:44:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83163"
}
```



---

archive/issue_comments_062946.json:
```json
{
    "body": "Fixed bug with empty input to parse_display_expr.",
    "created_at": "2010-04-09T12:22:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62946",
    "user": "https://github.com/TimDumol"
}
```

Fixed bug with empty input to parse_display_expr.



---

archive/issue_comments_062947.json:
```json
{
    "body": "<a id='comment:11'></a>\n**Attachment:** [trac_7997-ast-display-hook.2.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.2.patch.gz)",
    "created_at": "2010-04-14T18:20:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62947",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:11'></a>
**Attachment:** [trac_7997-ast-display-hook.2.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.2.patch.gz)



---

archive/issue_events_083164.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-14T18:20:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83164"
}
```



---

archive/issue_events_083165.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-17T18:05:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83165"
}
```



---

archive/issue_events_083166.json:
```json
{
    "actor": "https://github.com/TimDumol",
    "created_at": "2010-04-17T18:05:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-4.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83166"
}
```



---

archive/issue_comments_062948.json:
```json
{
    "body": "**Attachment:** [trac_7908-pub_interact_c11-rebase.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7908-pub_interact_c11-rebase.patch.gz)\n\nFixes a doctest.",
    "created_at": "2010-04-18T07:42:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62948",
    "user": "https://github.com/TimDumol"
}
```

**Attachment:** [trac_7908-pub_interact_c11-rebase.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7908-pub_interact_c11-rebase.patch.gz)

Fixes a doctest.



---

archive/issue_comments_062949.json:
```json
{
    "body": "Fixes a doctest.",
    "created_at": "2010-04-18T07:42:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62949",
    "user": "https://github.com/TimDumol"
}
```

Fixes a doctest.



---

archive/issue_comments_062950.json:
```json
{
    "body": "<a id='comment:14'></a>\n**Attachment:** [trac_7997-ast-display-hook.3.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.3.patch.gz)\n\nThis patch fixes a doctest. Please ignore [attachment:trac_7908-pub_interact_c11-rebase.patch.](https://github.com/sagemath/sage/files/ticket7997/trac_7908-pub_interact_c11-rebase.patch.)",
    "created_at": "2010-04-18T07:43:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62950",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:14'></a>
**Attachment:** [trac_7997-ast-display-hook.3.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.3.patch.gz)

This patch fixes a doctest. Please ignore [attachment:trac_7908-pub_interact_c11-rebase.patch.](https://github.com/sagemath/sage/files/ticket7997/trac_7908-pub_interact_c11-rebase.patch.)



---

archive/issue_comments_062951.json:
```json
{
    "body": "Fixes a bug with %time.",
    "created_at": "2010-04-21T20:31:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62951",
    "user": "https://github.com/TimDumol"
}
```

Fixes a bug with %time.



---

archive/issue_comments_062952.json:
```json
{
    "body": "<a id='comment:15'></a>\n**Attachment:** [trac_7997-ast-display-hook.4.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.4.patch.gz)\n\nHow's the refactoring going?",
    "created_at": "2010-05-04T04:27:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62952",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:15'></a>
**Attachment:** [trac_7997-ast-display-hook.4.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.4.patch.gz)

How's the refactoring going?



---

archive/issue_comments_062953.json:
```json
{
    "body": "<a id='comment:16'></a>\nTim: Can you split this into 2 patches:\n1. The AST stuff and API changes.\n2. Adding the multiprocessing interface.\n\nWilliam mentioned that we should keep the pexpect interface working.",
    "created_at": "2010-05-20T08:26:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62953",
    "user": "https://github.com/sagetrac-acleone"
}
```

<a id='comment:16'></a>
Tim: Can you split this into 2 patches:
1. The AST stuff and API changes.
2. Adding the multiprocessing interface.

William mentioned that we should keep the pexpect interface working.



---

archive/issue_comments_062954.json:
```json
{
    "body": "**Attachment:** [trac_7997-ast-display-hook.5.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.5.patch.gz)\n\nMakes the pexpect implementation conform to the new API, and adds backend configuration.",
    "created_at": "2010-05-23T13:05:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62954",
    "user": "https://github.com/TimDumol"
}
```

**Attachment:** [trac_7997-ast-display-hook.5.patch.gz](https://github.com/sagemath/sage/files/ticket7997/trac_7997-ast-display-hook.5.patch.gz)

Makes the pexpect implementation conform to the new API, and adds backend configuration.



---

archive/issue_comments_062955.json:
```json
{
    "body": "<a id='comment:17'></a>\nThis new patch lets the pexpect interface work again, and allows one to configure the backend to pexpect, pipes or reference (defaulting to pipes). Is this enough, or shall I split it?",
    "created_at": "2010-05-23T13:08:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62955",
    "user": "https://github.com/TimDumol"
}
```

<a id='comment:17'></a>
This new patch lets the pexpect interface work again, and allows one to configure the backend to pexpect, pipes or reference (defaulting to pipes). Is this enough, or shall I split it?



---

archive/issue_comments_062956.json:
```json
{
    "body": "<a id='comment:18'></a>\nping about reviewing.  If the two of you wrote this together, what do you want from a third reviewer?  I don't have time to read and understand it all right now.  But I can install and test it.\n\nI had a student complain the other day that Sage only did one thing at a time, so this patch would be appreciated!",
    "created_at": "2010-09-28T21:07:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62956",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:18'></a>
ping about reviewing.  If the two of you wrote this together, what do you want from a third reviewer?  I don't have time to read and understand it all right now.  But I can install and test it.

I had a student complain the other day that Sage only did one thing at a time, so this patch would be appreciated!



---

archive/issue_comments_062957.json:
```json
{
    "body": "<a id='comment:19'></a>\nI have a setup where I have apache forward port 80 to port 8000, and Sage runs the notebook on port 8000.  I also use the server_pool option.  I applied this patch to a slightly modified 4.5.2.  I logged in.  When I tried to open a new worksheet, I got the following error in the log (and I got an error page in the browser):\n\n```\n2010-09-28 16:42:52-0500 [HTTPChannel,0,127.0.0.1] User 'jason.grout' logged in.\n2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] ERROR initializing compute process:\n2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] \n2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] find_next_available_port() takes at least 2 arguments (1 given)\n2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] Exception rendering:\n2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] Unhandled Error\n\tTraceback (most recent call last):\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py\", line 181, in addCallbacks\n\t    self._runCallbacks()\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py\", line 323, in _runCallbacks\n\t    self.result = callback(self.result, *args, **kw)\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py\", line 284, in _continue\n\t    self.unpause()\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py\", line 280, in unpause\n\t    self._runCallbacks()\n\t--- <exception caught here> ---\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py\", line 323, in _runCallbacks\n\t    self.result = callback(self.result, *args, **kw)\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/server.py\", line 296, in <lambda>\n\t    d.addCallback(lambda res, req: res.renderHTTP(req), self)\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/resource.py\", line 85, in renderHTTP\n\t    return method(request)\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/resource.py\", line 202, in http_GET\n\t    return super(Resource, self).http_GET(request)\n\t  File \"/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/resource.py\", line 128, in http_GET\n\t    return self.render(request)\n\t  File \"/home/sageserver/sage-4.5.2-test/devel/sagenb-main/sagenb/notebook/twist.py\", line 1534, in render\n\t    self.worksheet.sage()\n\t  File \"/home/sageserver/sage-4.5.2-test/devel/sagenb-main/sagenb/notebook/worksheet.py\", line 2836, in sage\n\t    self.initialize_sage()\n\t  File \"/home/sageserver/sage-4.5.2-test/devel/sagenb-main/sagenb/notebook/worksheet.py\", line 2806, in initialize_sage\n\t    raise RuntimeError(msg)\n\texceptions.RuntimeError: find_next_available_port() takes at least 2 arguments (1 given)\n```",
    "created_at": "2010-09-28T21:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62957",
    "user": "https://github.com/jasongrout"
}
```

<a id='comment:19'></a>
I have a setup where I have apache forward port 80 to port 8000, and Sage runs the notebook on port 8000.  I also use the server_pool option.  I applied this patch to a slightly modified 4.5.2.  I logged in.  When I tried to open a new worksheet, I got the following error in the log (and I got an error page in the browser):

```
2010-09-28 16:42:52-0500 [HTTPChannel,0,127.0.0.1] User 'jason.grout' logged in.
2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] ERROR initializing compute process:
2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] 
2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] find_next_available_port() takes at least 2 arguments (1 given)
2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] Exception rendering:
2010-09-28 16:42:58-0500 [HTTPChannel,1,127.0.0.1] Unhandled Error
	Traceback (most recent call last):
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py", line 181, in addCallbacks
	    self._runCallbacks()
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py", line 323, in _runCallbacks
	    self.result = callback(self.result, *args, **kw)
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py", line 284, in _continue
	    self.unpause()
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py", line 280, in unpause
	    self._runCallbacks()
	--- <exception caught here> ---
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/internet/defer.py", line 323, in _runCallbacks
	    self.result = callback(self.result, *args, **kw)
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/server.py", line 296, in <lambda>
	    d.addCallback(lambda res, req: res.renderHTTP(req), self)
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/resource.py", line 85, in renderHTTP
	    return method(request)
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/resource.py", line 202, in http_GET
	    return super(Resource, self).http_GET(request)
	  File "/home/sageserver/sage/local/lib/python2.6/site-packages/Twisted-9.0.0-py2.6-linux-x86_64.egg/twisted/web2/resource.py", line 128, in http_GET
	    return self.render(request)
	  File "/home/sageserver/sage-4.5.2-test/devel/sagenb-main/sagenb/notebook/twist.py", line 1534, in render
	    self.worksheet.sage()
	  File "/home/sageserver/sage-4.5.2-test/devel/sagenb-main/sagenb/notebook/worksheet.py", line 2836, in sage
	    self.initialize_sage()
	  File "/home/sageserver/sage-4.5.2-test/devel/sagenb-main/sagenb/notebook/worksheet.py", line 2806, in initialize_sage
	    raise RuntimeError(msg)
	exceptions.RuntimeError: find_next_available_port() takes at least 2 arguments (1 given)
```



---

archive/issue_events_083167.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-09-28T21:49:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83167"
}
```



---

archive/issue_events_083168.json:
```json
{
    "actor": "https://github.com/jasongrout",
    "created_at": "2010-09-28T21:49:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83168"
}
```



---

archive/issue_events_083169.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83169"
}
```



---

archive/issue_events_083170.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83170"
}
```



---

archive/issue_events_083171.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83171"
}
```



---

archive/issue_events_083172.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83172"
}
```



---

archive/issue_events_083173.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83173"
}
```



---

archive/issue_events_083174.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83174"
}
```



---

archive/issue_events_083175.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83175"
}
```



---

archive/issue_events_083176.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83176"
}
```



---

archive/issue_comments_062958.json:
```json
{
    "body": "<a id='comment:24'></a>\nProposing to close all sagenb tickets as outdated, so that all remaining open tickets in the notebook component are about the Jupyter notebook.",
    "created_at": "2020-08-18T00:36:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62958",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
Proposing to close all sagenb tickets as outdated, so that all remaining open tickets in the notebook component are about the Jupyter notebook.



---

archive/issue_events_083177.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-18T00:36:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83177"
}
```



---

archive/issue_events_083178.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-18T00:36:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "008080",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83178"
}
```



---

archive/issue_events_083179.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2020-08-18T00:36:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83179"
}
```



---

archive/issue_events_083180.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-08-25T09:35:31Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83180"
}
```



---

archive/issue_events_083181.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2020-08-25T09:35:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83181"
}
```



---

archive/issue_comments_062959.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2020-08-25T09:35:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7997#issuecomment-62959",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_events_083182.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-08-29T15:27:48Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83182"
}
```



---

archive/issue_events_083183.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2020-08-29T15:27:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/7997",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7997#event-83183"
}
```
