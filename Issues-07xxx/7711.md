# Issue 7711: integral() does not reduce coefficients in finite field

archive/issues_007711.json:
```json
{
    "body": "Consider the following example:\n\n```\nsage: P.<x,z> = PolynomialRing(GF(2147483647))\nsage: Q.<y> = PolynomialRing(P)\nsage: p=x+y+z   \nsage: p.integral()\n1/2*y^2 + (x + z)*y\n```\nNote the leading coefficient 1/2 is not reduced mod 2147483647.\n\nFor smaller p this seems to work:\n\n```\nsage: P.<x,z> = PolynomialRing(GF(2147483629))\nsage: Q.<y> = PolynomialRing(P)\nsage: p=x+y+z\nsage: p.integral()\n-1073741814*y^2 + (x + z)*y\n```\nIt works also when the smaller ring P has only one variable:\n\n```\nsage: P.<x> = PolynomialRing(GF(2147483647))\nsage: Q.<y> = PolynomialRing(P)\nsage: p=x+y\nsage: p.integral()\n1073741824*y^2 + x*y\n```\n\n**Assignee:** @malb\n\n**Reviewer:** Paul Zimmermann\n\n**Author:** Alex Ghitza\n\n**Merged:** sage-5.0.beta12\n\nIssue created by migration from https://trac.sagemath.org/ticket/7711\n\n",
    "closed_at": "2012-04-02T15:23:49Z",
    "created_at": "2009-12-16T12:21:31Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "integral() does not reduce coefficients in finite field",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/7711",
    "user": "https://github.com/zimmermann6"
}
```
Consider the following example:

```
sage: P.<x,z> = PolynomialRing(GF(2147483647))
sage: Q.<y> = PolynomialRing(P)
sage: p=x+y+z   
sage: p.integral()
1/2*y^2 + (x + z)*y
```
Note the leading coefficient 1/2 is not reduced mod 2147483647.

For smaller p this seems to work:

```
sage: P.<x,z> = PolynomialRing(GF(2147483629))
sage: Q.<y> = PolynomialRing(P)
sage: p=x+y+z
sage: p.integral()
-1073741814*y^2 + (x + z)*y
```
It works also when the smaller ring P has only one variable:

```
sage: P.<x> = PolynomialRing(GF(2147483647))
sage: Q.<y> = PolynomialRing(P)
sage: p=x+y
sage: p.integral()
1073741824*y^2 + x*y
```

**Assignee:** @malb

**Reviewer:** Paul Zimmermann

**Author:** Alex Ghitza

**Merged:** sage-5.0.beta12

Issue created by migration from https://trac.sagemath.org/ticket/7711





---

archive/issue_comments_075747.json:
```json
{
    "body": "<a id='comment:1'></a>\nI'm declaring a total feature freeze on sage-4.3.",
    "created_at": "2009-12-24T07:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75747",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:1'></a>
I'm declaring a total feature freeze on sage-4.3.



---

archive/issue_events_023337.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-12-24T07:07:56Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "milestone": "sage-4.3.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7711#event-23337"
}
```



---

archive/issue_comments_075748.json:
```json
{
    "body": "<a id='comment:2'></a>\nNote also that in Paul's first example we have:\n\n```\nsage: p.integral().parent()\nUnivariate Polynomial Ring in y over Fraction Field of Multivariate Polynomial Ring in x, z over Finite Field of size 2147483647\n```\n\nwhereas in the second:\n\n```\nsage: p.integral().parent()\nUnivariate Polynomial Ring in y over Multivariate Polynomial Ring in x, z over Finite Field of size 2147483629\n```\n\nThis is probably where the issue is.",
    "created_at": "2010-01-02T11:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75748",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:2'></a>
Note also that in Paul's first example we have:

```
sage: p.integral().parent()
Univariate Polynomial Ring in y over Fraction Field of Multivariate Polynomial Ring in x, z over Finite Field of size 2147483647
```

whereas in the second:

```
sage: p.integral().parent()
Univariate Polynomial Ring in y over Multivariate Polynomial Ring in x, z over Finite Field of size 2147483629
```

This is probably where the issue is.



---

archive/issue_comments_075749.json:
```json
{
    "body": "<a id='comment:3'></a>\nThe bug is still there in 4.3.1.",
    "created_at": "2010-02-05T20:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75749",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:3'></a>
The bug is still there in 4.3.1.



---

archive/issue_comments_075750.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2012-03-19T18:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75750",
    "user": "https://github.com/jbalakrishnan"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_075751.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"rd2\".",
    "created_at": "2012-03-19T18:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75751",
    "user": "https://github.com/jbalakrishnan"
}
```

**Changing keywords** from "" to "rd2".



---

archive/issue_events_023338.json:
```json
{
    "actor": "https://github.com/jbalakrishnan",
    "created_at": "2012-03-19T18:28:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "milestone": "sage-4.3.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7711#event-23338"
}
```



---

archive/issue_events_023339.json:
```json
{
    "actor": "https://github.com/jbalakrishnan",
    "created_at": "2012-03-19T18:28:17Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7711#event-23339"
}
```



---

archive/issue_comments_075752.json:
```json
{
    "body": "<a id='comment:4'></a>\nThis is no longer an issue:\n\n```\nsage: P.<x,z> = PolynomialRing(GF(2147483647))\nsage: Q.<y> = PolynomialRing(P)\nsage: p=x+y+z   \nsage: p.integral()\n-1073741823*y^2 + (x + z)*y\nsage: P(-1073741823*2)\n1\n```",
    "created_at": "2012-03-19T18:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75752",
    "user": "https://github.com/jbalakrishnan"
}
```

<a id='comment:4'></a>
This is no longer an issue:

```
sage: P.<x,z> = PolynomialRing(GF(2147483647))
sage: Q.<y> = PolynomialRing(P)
sage: p=x+y+z   
sage: p.integral()
-1073741823*y^2 + (x + z)*y
sage: P(-1073741823*2)
1
```



---

archive/issue_comments_075753.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-03-19T18:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75753",
    "user": "https://github.com/jbalakrishnan"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_075754.json:
```json
{
    "body": "<a id='comment:6'></a>\nI don't agree that this has been fixed.  In 5.0.beta8, I only have to go up to the next prime:\n\n\n```\n\nsage: def f(N):\n....:     P.<x,z> = PolynomialRing(GF(N))\n....:     Q.<y> = PolynomialRing(P)\n....:     p=x+y+z   \n....:     return p.integral()\n....: \nsage: N = 2147483647\nsage: f(N)\n-1073741823*y^2 + (x + z)*y\nsage: N = next_prime(N)\nsage: N\n2147483659\nsage: f(N)\n1/2*y^2 + (x + z)*y\n\n```",
    "created_at": "2012-03-19T18:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75754",
    "user": "https://trac.sagemath.org/admin/accounts/users/dsm"
}
```

<a id='comment:6'></a>
I don't agree that this has been fixed.  In 5.0.beta8, I only have to go up to the next prime:


```

sage: def f(N):
....:     P.<x,z> = PolynomialRing(GF(N))
....:     Q.<y> = PolynomialRing(P)
....:     p=x+y+z   
....:     return p.integral()
....: 
sage: N = 2147483647
sage: f(N)
-1073741823*y^2 + (x + z)*y
sage: N = next_prime(N)
sage: N
2147483659
sage: f(N)
1/2*y^2 + (x + z)*y

```



---

archive/issue_comments_075755.json:
```json
{
    "body": "<a id='comment:7'></a>\nGood catch. I'll change it back to \"needs work.\"",
    "created_at": "2012-03-19T18:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75755",
    "user": "https://github.com/jbalakrishnan"
}
```

<a id='comment:7'></a>
Good catch. I'll change it back to "needs work."



---

archive/issue_comments_075756.json:
```json
{
    "body": "**Changing keywords** from \"rd2\" to \"\".",
    "created_at": "2012-03-19T18:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75756",
    "user": "https://github.com/jbalakrishnan"
}
```

**Changing keywords** from "rd2" to "".



---

archive/issue_comments_075757.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2012-03-19T18:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75757",
    "user": "https://github.com/jbalakrishnan"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_events_023340.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2012-03-24T03:20:45Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7711#event-23340"
}
```



---

archive/issue_events_023341.json:
```json
{
    "actor": "https://github.com/aghitza",
    "created_at": "2012-03-24T03:20:45Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7711#event-23341"
}
```



---

archive/issue_comments_075758.json:
```json
{
    "body": "<a id='comment:9'></a>\nFor large primes, Sage uses polydicts for representing multivariate polynomials, instead of using Singular.  The trouble here is that dividing a polydict by another polydict automatically creates the fraction field, even when the denominator is actually an element of the coefficient ring.\n\nThe attached patch tries to detect this (relatively common) special case and perform the division in the coefficient ring instead of going to the fraction field of the ring of polynomials.  This fixes the problems with `integral()` reported here.",
    "created_at": "2012-03-24T05:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75758",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:9'></a>
For large primes, Sage uses polydicts for representing multivariate polynomials, instead of using Singular.  The trouble here is that dividing a polydict by another polydict automatically creates the fraction field, even when the denominator is actually an element of the coefficient ring.

The attached patch tries to detect this (relatively common) special case and perform the division in the coefficient ring instead of going to the fraction field of the ring of polynomials.  This fixes the problems with `integral()` reported here.



---

archive/issue_comments_075759.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2012-03-24T05:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75759",
    "user": "https://github.com/aghitza"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_075760.json:
```json
{
    "body": "**Author:** Alex Ghitza",
    "created_at": "2012-03-24T05:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75760",
    "user": "https://github.com/aghitza"
}
```

**Author:** Alex Ghitza



---

archive/issue_comments_075761.json:
```json
{
    "body": "<a id='comment:11'></a>\nAlex,\n\nthere is something I don't understand with your patch. You check that `right` is in the base\nring, but not `1/right`, thus what happens the base ring is not a field? Compare for example:\n\n```\nsage: P.<x,z> = PolynomialRing(ZZ)\nsage: Q.<y> = PolynomialRing(P)\nsage: p=x+y+z\nsage: t=p/2\nsage: t.parent()\nUnivariate Polynomial Ring in y over Multivariate Polynomial Ring in x, z over Rational Field\nsage: u=p.integral()\nsage: u.parent()\nUnivariate Polynomial Ring in y over Fraction Field of Multivariate Polynomial Ring in x, z over Integer Ring\n```\nWhy do t and u have different parents?\n\nPaul",
    "created_at": "2012-03-24T08:59:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75761",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:11'></a>
Alex,

there is something I don't understand with your patch. You check that `right` is in the base
ring, but not `1/right`, thus what happens the base ring is not a field? Compare for example:

```
sage: P.<x,z> = PolynomialRing(ZZ)
sage: Q.<y> = PolynomialRing(P)
sage: p=x+y+z
sage: t=p/2
sage: t.parent()
Univariate Polynomial Ring in y over Multivariate Polynomial Ring in x, z over Rational Field
sage: u=p.integral()
sage: u.parent()
Univariate Polynomial Ring in y over Fraction Field of Multivariate Polynomial Ring in x, z over Integer Ring
```
Why do t and u have different parents?

Paul



---

archive/issue_comments_075762.json:
```json
{
    "body": "**Changing status** from needs_review to needs_info.",
    "created_at": "2012-03-24T09:00:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75762",
    "user": "https://github.com/zimmermann6"
}
```

**Changing status** from needs_review to needs_info.



---

archive/issue_comments_075763.json:
```json
{
    "body": "**Reviewer:** Paul Zimmermann",
    "created_at": "2012-03-24T09:01:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75763",
    "user": "https://github.com/zimmermann6"
}
```

**Reviewer:** Paul Zimmermann



---

archive/issue_comments_075764.json:
```json
{
    "body": "<a id='comment:14'></a>\nI guess I always found the following strange:\n\n```\nsage: type(3)\n<type 'sage.rings.integer.Integer'>\nsage: type(3/1)\n<type 'sage.rings.rational.Rational'>\n```\n\nand that influenced me in writing this patch.  I don't however have a strong opinion about this, and I'm happy to change it to make things more consistent by working in the fraction field of base_ring.  I'll replace the patch with one having this behavior soon.",
    "created_at": "2012-03-24T09:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75764",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:14'></a>
I guess I always found the following strange:

```
sage: type(3)
<type 'sage.rings.integer.Integer'>
sage: type(3/1)
<type 'sage.rings.rational.Rational'>
```

and that influenced me in writing this patch.  I don't however have a strong opinion about this, and I'm happy to change it to make things more consistent by working in the fraction field of base_ring.  I'll replace the patch with one having this behavior soon.



---

archive/issue_comments_075765.json:
```json
{
    "body": "<a id='comment:15'></a>\nBy the way, the issue you point out with ZZ coefficients is apparently orthogonal to this patch.  Multivariate polynomials over ZZ are handled by Singular, and the patch does not touch them.  It only modifies the behavior for multivariate polynomials that are implemented as polydict's, such as the ones over finite fields of huge characteristic that this ticket started with.\n\nYour ZZ example behaves the same with or without this patch.  If you find it really bothersome, maybe it can be on a new ticket.",
    "created_at": "2012-03-24T09:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75765",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:15'></a>
By the way, the issue you point out with ZZ coefficients is apparently orthogonal to this patch.  Multivariate polynomials over ZZ are handled by Singular, and the patch does not touch them.  It only modifies the behavior for multivariate polynomials that are implemented as polydict's, such as the ones over finite fields of huge characteristic that this ticket started with.

Your ZZ example behaves the same with or without this patch.  If you find it really bothersome, maybe it can be on a new ticket.



---

archive/issue_comments_075766.json:
```json
{
    "body": "**Changing status** from needs_info to needs_review.",
    "created_at": "2012-03-24T09:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75766",
    "user": "https://github.com/aghitza"
}
```

**Changing status** from needs_info to needs_review.



---

archive/issue_comments_075767.json:
```json
{
    "body": "<a id='comment:17'></a>\nAlex, can you add an example where your patch is called with coefficients in a ring?\n\nAbout `3/1` giving a rational, this is ok for me. Indeed, you don't want the type of the result\nto differ when the division is exact or not: `3/2` and `3/1` should give both rationals.\n\nPaul",
    "created_at": "2012-03-24T09:52:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75767",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:17'></a>
Alex, can you add an example where your patch is called with coefficients in a ring?

About `3/1` giving a rational, this is ok for me. Indeed, you don't want the type of the result
to differ when the division is exact or not: `3/2` and `3/1` should give both rationals.

Paul



---

archive/issue_comments_075768.json:
```json
{
    "body": "**Changing status** from needs_review to needs_info.",
    "created_at": "2012-03-24T10:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75768",
    "user": "https://github.com/aghitza"
}
```

**Changing status** from needs_review to needs_info.



---

archive/issue_comments_075769.json:
```json
{
    "body": "<a id='comment:18'></a>\nAlright, I'm starting to see what you are objecting to, and I agree with you.  Just to make sure I get this right: even the documented examples from the docstring of integral are inconsistent in this way\n\n```\n        EXAMPLES::\n        \n            sage: R.<x> = ZZ[]\n            sage: R(0).integral()\n            0\n            sage: f = R(2).integral(); f\n            2*x\n        \n        Note that since the integral is defined over the same base ring the\n        integral is actually in the base ring.\n        \n        ::\n        \n            sage: f.parent()\n            Univariate Polynomial Ring in x over Integer Ring\n        \n        If the integral isn't defined over the same base ring, then the\n        base ring is extended::\n        \n            sage: f = x^3 + x - 2\n            sage: g = f.integral(); g\n            1/4*x^4 + 1/2*x^2 - 2*x\n            sage: g.parent()\n            Univariate Polynomial Ring in x over Rational Field\n```\n\nWe want Sage to be less clever and more consistent, so the integral of 2 should be 2x in QQ[x] rather than in ZZ[x].\n\nOf course, this is fun to implement, because you might have something like:\n\n```\nsage: A.<a, b> = PolynomialRing(ZZ)\nsage: C.<c> = PolynomialRing(A)\nsage: D.<d> = PowerSeriesRing(C)\nsage: R.<x> = PolynomialRing(D)\nsage: f = a*x^2 + c*x\nsage: f.parent()\nUnivariate Polynomial Ring in x over Power Series Ring in d over \nUnivariate Polynomial Ring in c over Multivariate Polynomial Ring \nin a, b over Integer Ring\n```\n\nWhat I would like to do is have f.integral() live in\n\n```\nUnivariate Polynomial Ring in x over Power Series Ring in d over \nUnivariate Polynomial Ring in c over Multivariate Polynomial Ring \nin a, b over Rational Field\n```\n\nSo I want to change to the fraction field at the very bottom of the chain of extensions.  This means starting with R and going down to ZZ step by step, then changing ZZ to QQ and walking back up, changing all the intermediate rings along the way.  It can get expensive, but I guess that's the price to pay for working with such monstrosities.\n\nIf my outline agrees with what you had in mind, I'll produce a new patch based on it.",
    "created_at": "2012-03-24T10:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75769",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:18'></a>
Alright, I'm starting to see what you are objecting to, and I agree with you.  Just to make sure I get this right: even the documented examples from the docstring of integral are inconsistent in this way

```
        EXAMPLES::
        
            sage: R.<x> = ZZ[]
            sage: R(0).integral()
            0
            sage: f = R(2).integral(); f
            2*x
        
        Note that since the integral is defined over the same base ring the
        integral is actually in the base ring.
        
        ::
        
            sage: f.parent()
            Univariate Polynomial Ring in x over Integer Ring
        
        If the integral isn't defined over the same base ring, then the
        base ring is extended::
        
            sage: f = x^3 + x - 2
            sage: g = f.integral(); g
            1/4*x^4 + 1/2*x^2 - 2*x
            sage: g.parent()
            Univariate Polynomial Ring in x over Rational Field
```

We want Sage to be less clever and more consistent, so the integral of 2 should be 2x in QQ[x] rather than in ZZ[x].

Of course, this is fun to implement, because you might have something like:

```
sage: A.<a, b> = PolynomialRing(ZZ)
sage: C.<c> = PolynomialRing(A)
sage: D.<d> = PowerSeriesRing(C)
sage: R.<x> = PolynomialRing(D)
sage: f = a*x^2 + c*x
sage: f.parent()
Univariate Polynomial Ring in x over Power Series Ring in d over 
Univariate Polynomial Ring in c over Multivariate Polynomial Ring 
in a, b over Integer Ring
```

What I would like to do is have f.integral() live in

```
Univariate Polynomial Ring in x over Power Series Ring in d over 
Univariate Polynomial Ring in c over Multivariate Polynomial Ring 
in a, b over Rational Field
```

So I want to change to the fraction field at the very bottom of the chain of extensions.  This means starting with R and going down to ZZ step by step, then changing ZZ to QQ and walking back up, changing all the intermediate rings along the way.  It can get expensive, but I guess that's the price to pay for working with such monstrosities.

If my outline agrees with what you had in mind, I'll produce a new patch based on it.



---

archive/issue_comments_075770.json:
```json
{
    "body": "<a id='comment:19'></a>\nAlex,\n\nin fact I guess your initial patch did what we want. Indeed with your latest example:\n\n```\nsage: g=f/2\nsage: g.parent()\nUnivariate Polynomial Ring in x over Power Series Ring in d over Univariate Polynomial Ring in c over Multivariate Polynomial Ring in a, b over Rational Field\n```\nthus the fact of dividing f by an element of the base ring automatically extends it to the corresponding\nfraction field if necessary.\n\nThus I suggest you revert to your first patch (sorry) and add the above example as test.\n\nPaul",
    "created_at": "2012-03-24T11:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75770",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:19'></a>
Alex,

in fact I guess your initial patch did what we want. Indeed with your latest example:

```
sage: g=f/2
sage: g.parent()
Univariate Polynomial Ring in x over Power Series Ring in d over Univariate Polynomial Ring in c over Multivariate Polynomial Ring in a, b over Rational Field
```
thus the fact of dividing f by an element of the base ring automatically extends it to the corresponding
fraction field if necessary.

Thus I suggest you revert to your first patch (sorry) and add the above example as test.

Paul



---

archive/issue_comments_075771.json:
```json
{
    "body": "<a id='comment:20'></a>\nDoes this patch break a major fundamental design decision in both Sage and Magma, namely that / is a constructor for elements of the fraction field.   E.g.,  3/1 has parent QQ.",
    "created_at": "2012-03-24T11:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75771",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:20'></a>
Does this patch break a major fundamental design decision in both Sage and Magma, namely that / is a constructor for elements of the fraction field.   E.g.,  3/1 has parent QQ.



---

archive/issue_comments_075772.json:
```json
{
    "body": "<a id='comment:21'></a>\nWilliam, I don't think this patch (still not ready) will break anything, since I believe it will just\nreturn f/c where f is a polynomial and c an element of the base ring.\n\nAnyway your advice how to best solve this problem is welcome.\n\nPaul",
    "created_at": "2012-03-24T14:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75772",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:21'></a>
William, I don't think this patch (still not ready) will break anything, since I believe it will just
return f/c where f is a polynomial and c an element of the base ring.

Anyway your advice how to best solve this problem is welcome.

Paul



---

archive/issue_comments_075773.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [was](#comment%3A20):\n> Does this patch break a major fundamental design decision in both Sage and Magma, namely that / is a constructor for elements of the fraction field.   E.g.,  3/1 has parent QQ.\n\n\nHi William, can you have a look at the docstring for p.integral() as it stands now and tell me whether you think it complies with this design decision?  Here is an example:\n\n```\nsage: S.<x> = ZZ[]\nsage: p = 2*x\nsage: p.integral()\nx^2\nsage: p.integral().parent()\nUnivariate Polynomial Ring in x over Integer Ring\n```\n\nBehind the scenes Sage performed 2/2 and decided that the answer was 1 in ZZ rather than 1 in QQ, so this seems to break the convention.  Also, the answer has a different parent than (3*x).integral(), which is the type of inconsistency that Paul was pointing out before.  So should this stay the way it is, or should this be changed to be more consistent?\n\nBut it gets a tiny bit more complicated than this.  Suppose your coefficients are not ZZ, but rather ZZ[y], where y is a vector of 200 variables.  The integral of 2*x is still `x^2`, but where do we want this `x^2` to live?  Possible answers are (a) ZZ[y][x], (b) Frac(ZZ[y])[x], (c) QQ[y][x].\nThe current behavior is (a) for 2*x and (b) for 3*x, and I am currently leaning toward changing both to (c).  Here's why: you have p in R[x], where R is some coefficient ring.  When you do p.integral(), you are not really dividing p by integers n, but rather the coefficients of p by integers n.  So maybe we should look at what division by n in the coefficient ring R does:\n\n```\nsage: R.<y0,y1,y2,y3> = ZZ[]\nsage: S.<x> = R[]\nsage: p = 2*y0\nsage: p.parent()\nMultivariate Polynomial Ring in y0, y1, y2, y3 over Integer Ring\nsage: (p/2).parent()\nMultivariate Polynomial Ring in y0, y1, y2, y3 over Rational Field\nsage: p = 3*y0\nsage: (p/2).parent()\nMultivariate Polynomial Ring in y0, y1, y2, y3 over Rational Field\n```\n\nSo p/2 is not in the fraction field of R.  This is what I would like integral() to do as well.\n\nThoughts?",
    "created_at": "2012-03-24T21:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75773",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:22'></a>
Replying to [was](#comment%3A20):
> Does this patch break a major fundamental design decision in both Sage and Magma, namely that / is a constructor for elements of the fraction field.   E.g.,  3/1 has parent QQ.


Hi William, can you have a look at the docstring for p.integral() as it stands now and tell me whether you think it complies with this design decision?  Here is an example:

```
sage: S.<x> = ZZ[]
sage: p = 2*x
sage: p.integral()
x^2
sage: p.integral().parent()
Univariate Polynomial Ring in x over Integer Ring
```

Behind the scenes Sage performed 2/2 and decided that the answer was 1 in ZZ rather than 1 in QQ, so this seems to break the convention.  Also, the answer has a different parent than (3*x).integral(), which is the type of inconsistency that Paul was pointing out before.  So should this stay the way it is, or should this be changed to be more consistent?

But it gets a tiny bit more complicated than this.  Suppose your coefficients are not ZZ, but rather ZZ[y], where y is a vector of 200 variables.  The integral of 2*x is still `x^2`, but where do we want this `x^2` to live?  Possible answers are (a) ZZ[y][x], (b) Frac(ZZ[y])[x], (c) QQ[y][x].
The current behavior is (a) for 2*x and (b) for 3*x, and I am currently leaning toward changing both to (c).  Here's why: you have p in R[x], where R is some coefficient ring.  When you do p.integral(), you are not really dividing p by integers n, but rather the coefficients of p by integers n.  So maybe we should look at what division by n in the coefficient ring R does:

```
sage: R.<y0,y1,y2,y3> = ZZ[]
sage: S.<x> = R[]
sage: p = 2*y0
sage: p.parent()
Multivariate Polynomial Ring in y0, y1, y2, y3 over Integer Ring
sage: (p/2).parent()
Multivariate Polynomial Ring in y0, y1, y2, y3 over Rational Field
sage: p = 3*y0
sage: (p/2).parent()
Multivariate Polynomial Ring in y0, y1, y2, y3 over Rational Field
```

So p/2 is not in the fraction field of R.  This is what I would like integral() to do as well.

Thoughts?



---

archive/issue_comments_075774.json:
```json
{
    "body": "<a id='comment:23'></a>\nOK, I have changed the patch to a new one that achieves objective (c) in the previous comment.  It is also simpler and cleaner than the previous patches.  `integral` now relies on the coefficient rings to do the right thing.  They mostly do, except for polydict, whose behavior is fixed by the patch as well.",
    "created_at": "2012-03-24T23:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75774",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:23'></a>
OK, I have changed the patch to a new one that achieves objective (c) in the previous comment.  It is also simpler and cleaner than the previous patches.  `integral` now relies on the coefficient rings to do the right thing.  They mostly do, except for polydict, whose behavior is fixed by the patch as well.



---

archive/issue_comments_075775.json:
```json
{
    "body": "**Changing status** from needs_info to needs_review.",
    "created_at": "2012-03-24T23:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75775",
    "user": "https://github.com/aghitza"
}
```

**Changing status** from needs_info to needs_review.



---

archive/issue_comments_075776.json:
```json
{
    "body": "<a id='comment:25'></a>\nAlex, I tried to apply your patch to sage-5.0.beta9 but it failed:\n\n```\n\nsage: hg_sage.import_patch(\"trac7711.patch\")\ncd \"/localdisk/tmp/sage-5.0.beta9/devel/sage\" && sage --hg import   \"/localdisk/tmp/sage-5.0.beta9/trac7711.patch\"\napplying /localdisk/tmp/sage-5.0.beta9/trac7711.patch\npatching file sage/rings/polynomial/polynomial_element.pyx\nHunk #1 FAILED at 2369\n1 out of 1 hunks FAILED -- saving rejects to file sage/rings/polynomial/polynomial_element.pyx.rej\nabort: patch failed to apply\n```\nFor which version is this patch?\n\nPaul",
    "created_at": "2012-03-26T07:49:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75776",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:25'></a>
Alex, I tried to apply your patch to sage-5.0.beta9 but it failed:

```

sage: hg_sage.import_patch("trac7711.patch")
cd "/localdisk/tmp/sage-5.0.beta9/devel/sage" && sage --hg import   "/localdisk/tmp/sage-5.0.beta9/trac7711.patch"
applying /localdisk/tmp/sage-5.0.beta9/trac7711.patch
patching file sage/rings/polynomial/polynomial_element.pyx
Hunk #1 FAILED at 2369
1 out of 1 hunks FAILED -- saving rejects to file sage/rings/polynomial/polynomial_element.pyx.rej
abort: patch failed to apply
```
For which version is this patch?

Paul



---

archive/issue_comments_075777.json:
```json
{
    "body": "<a id='comment:26'></a>\n> For which version is this patch?\n\n\nIt's based on sage-4.8.  I have a sage-5.0.beta10 somewhere, I'll rebase it on that soon.",
    "created_at": "2012-03-26T07:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75777",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:26'></a>
> For which version is this patch?


It's based on sage-4.8.  I have a sage-5.0.beta10 somewhere, I'll rebase it on that soon.



---

archive/issue_comments_075778.json:
```json
{
    "body": "<a id='comment:27'></a>\nit seems my sage-5.0.beta9 was corrupted. I'll compile sage-5.0.beta10 from source and try\nagain.\n\nPaul",
    "created_at": "2012-03-26T07:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75778",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:27'></a>
it seems my sage-5.0.beta9 was corrupted. I'll compile sage-5.0.beta10 from source and try
again.

Paul



---

archive/issue_comments_075779.json:
```json
{
    "body": "<a id='comment:28'></a>\nI tried on a clean sage-5.0.beta10 and the previous version of the patch did not apply correctly.  I have rebased it now and it should work.",
    "created_at": "2012-03-26T08:10:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75779",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:28'></a>
I tried on a clean sage-5.0.beta10 and the previous version of the patch did not apply correctly.  I have rebased it now and it should work.



---

archive/issue_comments_075780.json:
```json
{
    "body": "<a id='comment:29'></a>\nreplying to comment [comment:22]: I guess we should just return `p/2` and let the coercion\nmechanism decide the corresponding parent. In such a way it will ensure that `p.integral()` and `p/2` have the same type.\n\nPaul",
    "created_at": "2012-03-26T15:04:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75780",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:29'></a>
replying to comment [comment:22]: I guess we should just return `p/2` and let the coercion
mechanism decide the corresponding parent. In such a way it will ensure that `p.integral()` and `p/2` have the same type.

Paul



---

archive/issue_comments_075781.json:
```json
{
    "body": "<a id='comment:30'></a>\nI confirm the rebased patch applies cleanly to sage-5.0.beta10.\n\nHowever there is still an issue:\n\n```\nsage: R.<x> = ZZ[]\nsage: R(0).integral().parent()\nUnivariate Polynomial Ring in x over Integer Ring\nsage: R(3).integral().parent()\nUnivariate Polynomial Ring in x over Rational Field\n```\nWhy do we get a different parent for zero?\n\nPaul",
    "created_at": "2012-03-26T16:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75781",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:30'></a>
I confirm the rebased patch applies cleanly to sage-5.0.beta10.

However there is still an issue:

```
sage: R.<x> = ZZ[]
sage: R(0).integral().parent()
Univariate Polynomial Ring in x over Integer Ring
sage: R(3).integral().parent()
Univariate Polynomial Ring in x over Rational Field
```
Why do we get a different parent for zero?

Paul



---

archive/issue_comments_075782.json:
```json
{
    "body": "**Changing status** from needs_review to needs_info.",
    "created_at": "2012-03-26T16:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75782",
    "user": "https://github.com/zimmermann6"
}
```

**Changing status** from needs_review to needs_info.



---

archive/attachments_009374.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac7711.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket7711/trac7711.patch",
    "created_at": "2012-03-26T21:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/aghitza"
}
```



---

archive/issue_comments_075783.json:
```json
{
    "body": "",
    "created_at": "2012-03-26T21:43:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75783",
    "user": "https://github.com/aghitza"
}
```





---

archive/issue_comments_075784.json:
```json
{
    "body": "<a id='comment:31'></a>\nAh, that's because the degree of R(0) is negative.  Sorry.  It's fixed in the new patch, and I've added `R(0).integral().parent()` to the doctests.",
    "created_at": "2012-03-26T21:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75784",
    "user": "https://github.com/aghitza"
}
```

<a id='comment:31'></a>
Ah, that's because the degree of R(0) is negative.  Sorry.  It's fixed in the new patch, and I've added `R(0).integral().parent()` to the doctests.



---

archive/issue_comments_075785.json:
```json
{
    "body": "**Changing status** from needs_info to needs_review.",
    "created_at": "2012-03-26T21:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75785",
    "user": "https://github.com/aghitza"
}
```

**Changing status** from needs_info to needs_review.



---

archive/issue_comments_075786.json:
```json
{
    "body": "<a id='comment:32'></a>\nI get only one doctest failure, but it also fails with vanilla sage-5.0.beta10 and seems\nunrelated:\n\n```\nsage -t  \"devel/sage-7711/sage/misc/sagedoc.py\"             \n\n**********************************************************************\nFile \"/localdisk/tmp/sage-5.0.beta10/devel/sage-7711/sage/misc/sagedoc.py\", line 566:\n    sage: 'abvar/homology' in _search_src_or_doc('doc', 'homology', 'variety', interact=False)\nExpected:\n    True\nGot:\n    Warning, the following Sage documentation hasn't been built,\n    so documentation search results may be incomplete:\n    <BLANKLINE>\n    /localdisk/tmp/sage-5.0.beta10/devel/sage/doc/output/html/de/tutorial\n...\n```\n\nThis patch not only fixes the original issue, but improves the coherence of Sage results.\nGood job Alex!\n\nPaul",
    "created_at": "2012-03-27T11:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75786",
    "user": "https://github.com/zimmermann6"
}
```

<a id='comment:32'></a>
I get only one doctest failure, but it also fails with vanilla sage-5.0.beta10 and seems
unrelated:

```
sage -t  "devel/sage-7711/sage/misc/sagedoc.py"             

**********************************************************************
File "/localdisk/tmp/sage-5.0.beta10/devel/sage-7711/sage/misc/sagedoc.py", line 566:
    sage: 'abvar/homology' in _search_src_or_doc('doc', 'homology', 'variety', interact=False)
Expected:
    True
Got:
    Warning, the following Sage documentation hasn't been built,
    so documentation search results may be incomplete:
    <BLANKLINE>
    /localdisk/tmp/sage-5.0.beta10/devel/sage/doc/output/html/de/tutorial
...
```

This patch not only fixes the original issue, but improves the coherence of Sage results.
Good job Alex!

Paul



---

archive/issue_comments_075787.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2012-03-27T11:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75787",
    "user": "https://github.com/zimmermann6"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_023342.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-04-02T15:23:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/7711#event-23342"
}
```



---

archive/issue_comments_075788.json:
```json
{
    "body": "**Merged:** sage-5.0.beta12",
    "created_at": "2012-04-02T15:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/7711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/7711#issuecomment-75788",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.0.beta12
