# Issue 7022: os x -- 10.6 -- generated the matplotlib font cache crashes sage

archive/issues_007022.json:
```json
{
    "body": "This is a huge problem and total blocker:\n\n```\nflat:.matplotlib wstein$ mv fontList.cache fontList.cache.XXX\nflat:.matplotlib wstein$ cd\nflat:~ wstein$ sage\n----------------------------------------------------------------------\n| Sage Version 4.1.1, Release Date: 2009-08-14                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nLoading Sage library. Current Mercurial branch is: parallel\nsage: import pylab\n/Users/wstein/sage/build/64bit/sage/local/bin/sage-sage: line 199: 58213 Abort trap              sage-ipython \"$@\" -i\n\nflat:.matplotlib wstein$ mv fontList.cache.XXX fontList.cache\nflat:.matplotlib wstein$ cd ..\nflat:~ wstein$ sage\n----------------------------------------------------------------------\n| Sage Version 4.1.1, Release Date: 2009-08-14                       |\n| Type notebook() for the GUI, and license() for information.        |\n----------------------------------------------------------------------\nLoading Sage library. Current Mercurial branch is: parallel\nsage: import pylab\nsage: \n```\n\nIdeas for solution: \n\n  (1) track down exactly where the problem happens in the matplotlib/freetype(?) code and fix it.\n\n  (2) Just ship the font cache with Sage until this gets resolved upstream\n\n\nA working version of the fontcache is here:\n\n   http://wstein.org/home/wstein/tmp/fontList.cache\n\n\n\n**Assignee:** @williamstein\n\n**Author:** William Stein\n\n**Reviewer:** Mike Hansen\n\n**Merged:** Sage 4.1.2.rc0\n\nIssue created by migration from https://trac.sagemath.org/ticket/7022\n\n",
    "closed_at": "2009-09-30T12:05:42Z",
    "created_at": "2009-09-27T01:34:49Z",
    "labels": [
        "component: graphics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-4.1.2",
    "title": "os x -- 10.6 -- generated the matplotlib font cache crashes sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/7022",
    "user": "https://github.com/williamstein"
}
```
This is a huge problem and total blocker:

```
flat:.matplotlib wstein$ mv fontList.cache fontList.cache.XXX
flat:.matplotlib wstein$ cd
flat:~ wstein$ sage
----------------------------------------------------------------------
| Sage Version 4.1.1, Release Date: 2009-08-14                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
Loading Sage library. Current Mercurial branch is: parallel
sage: import pylab
/Users/wstein/sage/build/64bit/sage/local/bin/sage-sage: line 199: 58213 Abort trap              sage-ipython "$@" -i

flat:.matplotlib wstein$ mv fontList.cache.XXX fontList.cache
flat:.matplotlib wstein$ cd ..
flat:~ wstein$ sage
----------------------------------------------------------------------
| Sage Version 4.1.1, Release Date: 2009-08-14                       |
| Type notebook() for the GUI, and license() for information.        |
----------------------------------------------------------------------
Loading Sage library. Current Mercurial branch is: parallel
sage: import pylab
sage: 
```

Ideas for solution: 

  (1) track down exactly where the problem happens in the matplotlib/freetype(?) code and fix it.

  (2) Just ship the font cache with Sage until this gets resolved upstream


A working version of the fontcache is here:

   http://wstein.org/home/wstein/tmp/fontList.cache



**Assignee:** @williamstein

**Author:** William Stein

**Reviewer:** Mike Hansen

**Merged:** Sage 4.1.2.rc0

Issue created by migration from https://trac.sagemath.org/ticket/7022





---

archive/issue_comments_051972.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -28,6 +28,11 @@\n \n   (1) track down exactly where the problem happens in the matplotlib/freetype(?) code and fix it.\n \n-  (2) Just ship the font cache with Sage until this gets resolved upstream. \n+  (2) Just ship the font cache with Sage until this gets resolved upstream\n \n \n+A working version of the fontcache is here:\n+\n+   http://wstein.org/home/wstein/tmp/fontList.cache\n+\n+\n``````\n",
    "created_at": "2009-09-27T01:35:37Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51972",
    "user": "https://github.com/williamstein"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -28,6 +28,11 @@
 
   (1) track down exactly where the problem happens in the matplotlib/freetype(?) code and fix it.
 
-  (2) Just ship the font cache with Sage until this gets resolved upstream. 
+  (2) Just ship the font cache with Sage until this gets resolved upstream
 
 
+A working version of the fontcache is here:
+
+   http://wstein.org/home/wstein/tmp/fontList.cache
+
+
``````




---

archive/issue_comments_051973.json:
```json
{
    "body": "<a id='comment:2'></a>\nThe spkg is here:\n\n    http://wstein.org/home/wstein/patches/matplotlib-0.99.1.p1.spkg\n\nThis supersedes what is at #6994.\n\nThe attached package *only* patches Matplotlib on OS X 10.6 by changing one line to use",
    "created_at": "2009-09-27T03:43:50Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51973",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:2'></a>
The spkg is here:

    http://wstein.org/home/wstein/patches/matplotlib-0.99.1.p1.spkg

This supersedes what is at #6994.

The attached package *only* patches Matplotlib on OS X 10.6 by changing one line to use



---

archive/issue_events_046784.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-27T03:43:50Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "rename": {
        "from": "os x -- 10.6 -- generated the matplotlib font cache crashes sage",
        "to": "[not yet ready for review] os x -- 10.6 -- generated the matplotlib font cache crashes sage"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46784"
}
```



---

archive/issue_comments_051974.json:
```json
{
    "body": "<a id='comment:3'></a>\nDoctesting reveals that just using FONTCONFIG is not enough, e.g., any saving to pdf still breaks. \n\nHere is the problem narrowed down more:\n\n```\nsage: import ft2font; ft2font.FT2Font('/Library/Fonts/NISC18030.ttf')\n/Users/wstein/sage/build/64bit/sage-4.1.2.alpha1/local/bin/sage-sage: line 199: 65960 Abort trap              sage-ipython \"$@\" -i\n```\n\nft2font.so is a C extension in matplotlib.",
    "created_at": "2009-09-27T04:11:32Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51974",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:3'></a>
Doctesting reveals that just using FONTCONFIG is not enough, e.g., any saving to pdf still breaks. 

Here is the problem narrowed down more:

```
sage: import ft2font; ft2font.FT2Font('/Library/Fonts/NISC18030.ttf')
/Users/wstein/sage/build/64bit/sage-4.1.2.alpha1/local/bin/sage-sage: line 199: 65960 Abort trap              sage-ipython "$@" -i
```

ft2font.so is a C extension in matplotlib.



---

archive/issue_comments_051975.json:
```json
{
    "body": "<a id='comment:4'></a>\nabove it should be\n\n```\nsage: import matplotlib.ft2font; ft2font.FT2Font('/Library/Fonts/NISC18030.ttf')\n/Users/wstein/sage/build/64bit/sage-4.1.2.alpha1/local/bin/sage-sage: line 199: 65960 Abort trap    \n```",
    "created_at": "2009-09-27T04:17:29Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51975",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:4'></a>
above it should be

```
sage: import matplotlib.ft2font; ft2font.FT2Font('/Library/Fonts/NISC18030.ttf')
/Users/wstein/sage/build/64bit/sage-4.1.2.alpha1/local/bin/sage-sage: line 199: 65960 Abort trap    
```



---

archive/issue_comments_051976.json:
```json
{
    "body": "<a id='comment:5'></a>\nHow about\n\n```\nimport matplotlib.ft2font; matplotlib.ft2font.FT2Font('/Library/Fonts/NISC18030.ttf')\n```",
    "created_at": "2009-09-27T04:18:00Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51976",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:5'></a>
How about

```
import matplotlib.ft2font; matplotlib.ft2font.FT2Font('/Library/Fonts/NISC18030.ttf')
```



---

archive/issue_events_046785.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-27T05:45:01Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "rename": {
        "from": "[not yet ready for review] os x -- 10.6 -- generated the matplotlib font cache crashes sage",
        "to": "os x -- 10.6 -- generated the matplotlib font cache crashes sage"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46785"
}
```



---

archive/issue_events_046786.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-27T05:45:01Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46786"
}
```



---

archive/issue_comments_051977.json:
```json
{
    "body": "<a id='comment:7'></a>\nI found yet another issue (X11 must be in the PATH), but this spkg fixes that issue too:\n\n  http://wstein.org/home/wstein/patches/matplotlib-0.99.1.p1.spkg",
    "created_at": "2009-09-27T06:33:51Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51977",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:7'></a>
I found yet another issue (X11 must be in the PATH), but this spkg fixes that issue too:

  http://wstein.org/home/wstein/patches/matplotlib-0.99.1.p1.spkg



---

archive/issue_events_046787.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-28T03:52:08Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46787"
}
```



---

archive/issue_events_046788.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-28T03:52:08Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46788"
}
```



---

archive/issue_comments_051978.json:
```json
{
    "body": "<a id='comment:8'></a>\nOK, even this doesn't fix the problem on all machines.  E.g., on bsd.math.washington.edu it does not fix the problem.",
    "created_at": "2009-09-28T03:52:08Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51978",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:8'></a>
OK, even this doesn't fix the problem on all machines.  E.g., on bsd.math.washington.edu it does not fix the problem.



---

archive/issue_comments_051979.json:
```json
{
    "body": "<a id='comment:9'></a>\nComment -- upgrading freetype doesn't fix the problems at all.  Also, upgrading freetype is itself broken, and the only workaround that I found that worked was to alias \"rm\" to be \"rm -f\" -- then freetype built and installed fine.",
    "created_at": "2009-09-28T04:21:00Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51979",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:9'></a>
Comment -- upgrading freetype doesn't fix the problems at all.  Also, upgrading freetype is itself broken, and the only workaround that I found that worked was to alias "rm" to be "rm -f" -- then freetype built and installed fine.



---

archive/issue_comments_051980.json:
```json
{
    "body": "<a id='comment:10'></a>\nSee http://groups.google.com/group/sage-devel/browse_thread/thread/2c538915abc99946",
    "created_at": "2009-09-30T04:22:03Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51980",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:10'></a>
See http://groups.google.com/group/sage-devel/browse_thread/thread/2c538915abc99946



---

archive/issue_comments_051981.json:
```json
{
    "body": "<a id='comment:11'></a>\nThis spkg fixes the problems on all my test systems:\n\n   http://sage.math.washington.edu/home/wstein/patches/matplotlib-0.99.1.p2.spkg\n\nAll it does is take the plane vanilla matplotlib-0.99.1.spkg spkg and add a little script that simply rebuilds f2font.so again using *exactly* the same command lines used by distutils to build that extension.  That's it.  For some reason -- probably involving environment variables (?) -- this fixes the problem.  I consider this a temporary 1-sage release solution until the matplotlib developers (or me) come up with a real fix.",
    "created_at": "2009-09-30T04:49:55Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51981",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:11'></a>
This spkg fixes the problems on all my test systems:

   http://sage.math.washington.edu/home/wstein/patches/matplotlib-0.99.1.p2.spkg

All it does is take the plane vanilla matplotlib-0.99.1.spkg spkg and add a little script that simply rebuilds f2font.so again using *exactly* the same command lines used by distutils to build that extension.  That's it.  For some reason -- probably involving environment variables (?) -- this fixes the problem.  I consider this a temporary 1-sage release solution until the matplotlib developers (or me) come up with a real fix.



---

archive/issue_events_046789.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-30T04:49:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46789"
}
```



---

archive/issue_events_046790.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2009-09-30T04:49:55Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46790"
}
```



---

archive/issue_comments_051982.json:
```json
{
    "body": "<a id='comment:12'></a>\nBy the way, here is a simple test that things are working:\n\n```\nsage: import pylab\nsage: plot(sin).save('a.pdf')\n```",
    "created_at": "2009-09-30T04:50:51Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51982",
    "user": "https://github.com/williamstein"
}
```

<a id='comment:12'></a>
By the way, here is a simple test that things are working:

```
sage: import pylab
sage: plot(sin).save('a.pdf')
```



---

archive/issue_comments_051983.json:
```json
{
    "body": "<a id='comment:13'></a>\nLooks good to me.  Everything worked for me on bsd.",
    "created_at": "2009-09-30T05:31:19Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51983",
    "user": "https://github.com/mwhansen"
}
```

<a id='comment:13'></a>
Looks good to me.  Everything worked for me on bsd.



---

archive/issue_events_046791.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-09-30T05:31:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46791"
}
```



---

archive/issue_events_046792.json:
```json
{
    "actor": "https://github.com/mwhansen",
    "created_at": "2009-09-30T05:31:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46792"
}
```



---

archive/issue_comments_051984.json:
```json
{
    "body": "**Merged:** Sage 4.1.2.rc0",
    "created_at": "2009-09-30T12:05:42Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51984",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Merged:** Sage 4.1.2.rc0



---

archive/issue_comments_051985.json:
```json
{
    "body": "**Author:** William Stein",
    "created_at": "2009-09-30T12:05:42Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51985",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Author:** William Stein



---

archive/issue_comments_051986.json:
```json
{
    "body": "<a id='comment:14'></a>\nMerged `matplotlib-0.99.1.p2.spkg` in the standard packages repository.",
    "created_at": "2009-09-30T12:05:42Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51986",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

<a id='comment:14'></a>
Merged `matplotlib-0.99.1.p2.spkg` in the standard packages repository.



---

archive/issue_events_046793.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2009-09-30T12:05:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46793"
}
```



---

archive/issue_events_046794.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2009-09-30T12:05:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46794"
}
```



---

archive/issue_comments_051987.json:
```json
{
    "body": "**Reviewer:** Mike Hansen",
    "created_at": "2009-09-30T12:05:42Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51987",
    "user": "https://trac.sagemath.org/admin/accounts/users/mvngu"
}
```

**Reviewer:** Mike Hansen



---

archive/issue_events_046795.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/mvngu",
    "created_at": "2009-09-30T12:05:42Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/7022#event-46795"
}
```



---

archive/issue_comments_051988.json:
```json
{
    "body": "<a id='comment:15'></a>\nI'm still getting a crash with lines like these:\n\n```\nsage: import pylab\nsage: plot(sin).save('a.pdf')\n```\nI made a related comment at #7095 because I didn't know about this ticket.  Also, as opposed to this ticket, #7095 is still open, so further discussion should continue there (or on a new ticket?).",
    "created_at": "2009-12-21T17:54:31Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51988",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:15'></a>
I'm still getting a crash with lines like these:

```
sage: import pylab
sage: plot(sin).save('a.pdf')
```
I made a related comment at #7095 because I didn't know about this ticket.  Also, as opposed to this ticket, #7095 is still open, so further discussion should continue there (or on a new ticket?).



---

archive/issue_comments_051989.json:
```json
{
    "body": "<a id='comment:16'></a>\nThe matplotlib problem may be in its spkg file: it says\n\n```\nif [ $UNAME = \"Darwin\" -a `uname -r` = \"10.0.0\" ]; then\n    echo \"Running a horrible hack to force ft2font.so to build in a way that doen't crash.\"\n    echo \"This is of course temporary.  See https://github.com/sagemath/sage/issues/7022\"\n    ../patches/osx10.6hack\nfi\n```\nBut with my computer, \"uname -r\" returns \"10.2.0\", not \"10.0.0\".  How do you modify a shell script like this to make it work for a range of version numbers?  (We don't just want \"10.0.0\" or \"10.2.0\", I'm guessing.)",
    "created_at": "2010-01-06T04:27:49Z",
    "issue": "https://github.com/sagemath/sage/issues/7022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/7022#issuecomment-51989",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:16'></a>
The matplotlib problem may be in its spkg file: it says

```
if [ $UNAME = "Darwin" -a `uname -r` = "10.0.0" ]; then
    echo "Running a horrible hack to force ft2font.so to build in a way that doen't crash."
    echo "This is of course temporary.  See https://github.com/sagemath/sage/issues/7022"
    ../patches/osx10.6hack
fi
```
But with my computer, "uname -r" returns "10.2.0", not "10.0.0".  How do you modify a shell script like this to make it work for a range of version numbers?  (We don't just want "10.0.0" or "10.2.0", I'm guessing.)
