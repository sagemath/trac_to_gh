# Issue 24498: upgrade Singular to 4.1.1

archive/issues_024498.json:
```json
{
    "body": "CC:  @kiwifb @antonio-rojas @timokau @mezzarobba\n\nSingular 4.1.1 is out. \nThe changes for it can be found at:\nhttps://www.singular.uni-kl.de/index.php/news/release-of-singular-4-1-1.html\n\nThe tarball:\nhttp://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-1-1/singular-4.1.1.tar.gz\n\nIssue created by migration from https://trac.sagemath.org/ticket/24735\n\n",
    "created_at": "2018-02-15T12:17:06Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "upgrade Singular to 4.1.1",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24498",
    "user": "https://github.com/dimpase"
}
```
CC:  @kiwifb @antonio-rojas @timokau @mezzarobba

Singular 4.1.1 is out. 
The changes for it can be found at:
https://www.singular.uni-kl.de/index.php/news/release-of-singular-4-1-1.html

The tarball:
http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-1-1/singular-4.1.1.tar.gz

Issue created by migration from https://trac.sagemath.org/ticket/24735





---

archive/issue_comments_343278.json:
```json
{
    "body": "One immediate issue is https://github.com/Singular/Sources/issues/855",
    "created_at": "2018-02-15T14:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343278",
    "user": "https://github.com/dimpase"
}
```

One immediate issue is https://github.com/Singular/Sources/issues/855



---

archive/issue_comments_343279.json:
```json
{
    "body": "Replying to [comment:1 dimpase]:\n> One immediate issue is https://github.com/Singular/Sources/issues/855\n\nFixed upstream.",
    "created_at": "2018-02-15T16:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343279",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:1 dimpase]:
> One immediate issue is https://github.com/Singular/Sources/issues/855

Fixed upstream.



---

archive/issue_comments_343280.json:
```json
{
    "body": "A patch that makes Sage build with the API changes in 4.1.1 is available at [1]\n\nHowever, the removal of singclap_pmod and singclap_pdivide for polynomials with integer coefficients [2] causes some regressions:\n\n\n\n```\nsage: R.<x,y>=ZZ[] \nsage: a=x+y \nsage: b=x-y \nsage: a.gcd(b) \n1 \nsage: a.quo_rem(b) \n( 0, x + y ) \nsage: a.gcd(b) \n0 \nsage: singular(a).gcd(b) \n1 \n```\n\n\n\n[1] https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-singular-4.1.1.patch?h=packages/sagemath\n\n[2] https://github.com/Singular/Sources/commit/4c1e770238d949fb0c7debc00998d507df876751",
    "created_at": "2018-02-28T18:35:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343280",
    "user": "https://github.com/antonio-rojas"
}
```

A patch that makes Sage build with the API changes in 4.1.1 is available at [1]

However, the removal of singclap_pmod and singclap_pdivide for polynomials with integer coefficients [2] causes some regressions:



```
sage: R.<x,y>=ZZ[] 
sage: a=x+y 
sage: b=x-y 
sage: a.gcd(b) 
1 
sage: a.quo_rem(b) 
( 0, x + y ) 
sage: a.gcd(b) 
0 
sage: singular(a).gcd(b) 
1 
```



[1] https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-singular-4.1.1.patch?h=packages/sagemath

[2] https://github.com/Singular/Sources/commit/4c1e770238d949fb0c7debc00998d507df876751



---

archive/issue_comments_343281.json:
```json
{
    "body": "Changing keywords from \"\" to \"days94\".",
    "created_at": "2018-06-29T13:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343281",
    "user": "https://github.com/jdemeyer"
}
```

Changing keywords from "" to "days94".



---

archive/issue_comments_343282.json:
```json
{
    "body": "Singular no longer supports singclap_pmod and singclap_pdivide for polynomials with integer coefficients. This change\n\n\n```\n--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n@@ -4888,7 +4888,7 @@ cdef class MPolynomial_libsingular(MPolynomial):\n         if right.is_zero():\n             raise ZeroDivisionError\n \n-        if not self._parent._base.is_field() and not is_IntegerRing(self._parent._base):\n+        if not self._parent._base.is_field():\n             py_quo = self//right\n             py_rem = self - right*py_quo\n             return py_quo, py_rem\n```\n\nmakes Sage not call Singular's singclap_pdivide for integer coefficients in quo_rem. With this, most test pass again (modulo some output format changes and generators ordering). There is another singclap_pdivide call in __floordiv__ in\nhttps://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx?h=develop#n4073\nthat should also be avoided for the integer coefficients case. I'm unsure what Sage should return here, since I'm unsure what the correct definition of floordiv would be. Should it just return NotImplementedError?",
    "created_at": "2018-06-29T15:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343282",
    "user": "https://github.com/antonio-rojas"
}
```

Singular no longer supports singclap_pmod and singclap_pdivide for polynomials with integer coefficients. This change


```
--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
@@ -4888,7 +4888,7 @@ cdef class MPolynomial_libsingular(MPolynomial):
         if right.is_zero():
             raise ZeroDivisionError
 
-        if not self._parent._base.is_field() and not is_IntegerRing(self._parent._base):
+        if not self._parent._base.is_field():
             py_quo = self//right
             py_rem = self - right*py_quo
             return py_quo, py_rem
```

makes Sage not call Singular's singclap_pdivide for integer coefficients in quo_rem. With this, most test pass again (modulo some output format changes and generators ordering). There is another singclap_pdivide call in __floordiv__ in
https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx?h=develop#n4073
that should also be avoided for the integer coefficients case. I'm unsure what Sage should return here, since I'm unsure what the correct definition of floordiv would be. Should it just return NotImplementedError?



---

archive/issue_comments_343283.json:
```json
{
    "body": "Pushing WIP patch. Still needs a decision on what to do for __floordiv__, gcd and lcm in the integers coefficient case in multi_polynomial_libsingular.pyx.\n\nUnfortunately starting from 8.3.beta7 there are many more test failures caused by the upgrade due to #23909 \n----\nNew commits:",
    "created_at": "2018-07-12T17:07:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343283",
    "user": "https://github.com/antonio-rojas"
}
```

Pushing WIP patch. Still needs a decision on what to do for __floordiv__, gcd and lcm in the integers coefficient case in multi_polynomial_libsingular.pyx.

Unfortunately starting from 8.3.beta7 there are many more test failures caused by the upgrade due to #23909 
----
New commits:



---

archive/issue_comments_343284.json:
```json
{
    "body": "With my limited knowledge of the topic and based on `git log`, it seems like we basically have to revert #25313.\n\nMark, do you have more information about that? The issue explained [comment:7 here].",
    "created_at": "2018-07-20T13:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343284",
    "user": "https://github.com/timokau"
}
```

With my limited knowledge of the topic and based on `git log`, it seems like we basically have to revert #25313.

Mark, do you have more information about that? The issue explained [comment:7 here].



---

archive/issue_comments_343285.json:
```json
{
    "body": "Okay in addition to the revert of #25313 it was also necessary to convert integral polynomials to rationals in `lcm`. I also updated the remaining doctests. I'm not qualified to say that the results are equivalent, but at least they look reasonable enough. If nobody spots an error, I guess we can trust singular here.\n\nI'm still running `ptestlong`, but at least the tests in `src/sgae/rings/polynomial` pass. [Here's my branch](https://git.sagemath.org/sage.git/log/?h=u/gh-timokau/upgrade_singular_to_4_1_1) (`u/gh-timokau/upgrade_singular_to_4_1_1`).\n\n`@`arojas I don't want to \"steal\" your work, so feel free to pick those commits in your branch and rebase them if nobody objects.",
    "created_at": "2018-07-20T16:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343285",
    "user": "https://github.com/timokau"
}
```

Okay in addition to the revert of #25313 it was also necessary to convert integral polynomials to rationals in `lcm`. I also updated the remaining doctests. I'm not qualified to say that the results are equivalent, but at least they look reasonable enough. If nobody spots an error, I guess we can trust singular here.

I'm still running `ptestlong`, but at least the tests in `src/sgae/rings/polynomial` pass. [Here's my branch](https://git.sagemath.org/sage.git/log/?h=u/gh-timokau/upgrade_singular_to_4_1_1) (`u/gh-timokau/upgrade_singular_to_4_1_1`).

`@`arojas I don't want to "steal" your work, so feel free to pick those commits in your branch and rebase them if nobody objects.



---

archive/issue_comments_343286.json:
```json
{
    "body": "Replying to [comment:13 gh-timokau]:\n> Okay in addition to the revert of #25313 it was also necessary to convert integral polynomials to rationals in `lcm`. I also updated the remaining doctests. I'm not qualified to say that the results are equivalent, but at least they look reasonable enough. If nobody spots an error, I guess we can trust singular here.\n\nWhat about gcd? AFAICS this is still calling singular's singclap_gcd for ZZ coefficients. \n\nFeel free to pick up my branch where I left it, I'm glad to see this move along.",
    "created_at": "2018-07-20T16:49:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343286",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:13 gh-timokau]:
> Okay in addition to the revert of #25313 it was also necessary to convert integral polynomials to rationals in `lcm`. I also updated the remaining doctests. I'm not qualified to say that the results are equivalent, but at least they look reasonable enough. If nobody spots an error, I guess we can trust singular here.

What about gcd? AFAICS this is still calling singular's singclap_gcd for ZZ coefficients. 

Feel free to pick up my branch where I left it, I'm glad to see this move along.



---

archive/issue_comments_343287.json:
```json
{
    "body": "Replying to [comment:14 arojas]:\n> Replying to [comment:13 gh-timokau]:\n> > Okay in addition to the revert of #25313 it was also necessary to convert integral polynomials to rationals in `lcm`. I also updated the remaining doctests. I'm not qualified to say that the results are equivalent, but at least they look reasonable enough. If nobody spots an error, I guess we can trust singular here.\n> \n> What about gcd? AFAICS this is still calling singular's singclap_gcd for ZZ coefficients.\n\nThe tests succeed, including the one over `ZZ`:\n\n\n```\nsage: Pol.<x,y,z> = ZZ[]\nsage: p = x*y - 5*y^2 + x*z - z^2 + z\nsage: q = -3*x^2*y^7*z + 2*x*y^6*z^3 + 2*x^2*y^3*z^4 + x^2*y^5 - 7*x*y^5*z\nsage: (21^3*p^2*q).gcd(35^2*p*q^2) == -49*p*q\nTrue\n```\n",
    "created_at": "2018-07-20T17:00:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343287",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:14 arojas]:
> Replying to [comment:13 gh-timokau]:
> > Okay in addition to the revert of #25313 it was also necessary to convert integral polynomials to rationals in `lcm`. I also updated the remaining doctests. I'm not qualified to say that the results are equivalent, but at least they look reasonable enough. If nobody spots an error, I guess we can trust singular here.
> 
> What about gcd? AFAICS this is still calling singular's singclap_gcd for ZZ coefficients.

The tests succeed, including the one over `ZZ`:


```
sage: Pol.<x,y,z> = ZZ[]
sage: p = x*y - 5*y^2 + x*z - z^2 + z
sage: q = -3*x^2*y^7*z + 2*x*y^6*z^3 + 2*x^2*y^3*z^4 + x^2*y^5 - 7*x*y^5*z
sage: (21^3*p^2*q).gcd(35^2*p*q^2) == -49*p*q
True
```




---

archive/issue_comments_343288.json:
```json
{
    "body": "This gives a wrong answer\n\n```\nsage: A.<x,y>=ZZ[]\nsage: lcm(2*x,2*x*y)\n4*x*y\n```\n\nThat is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents.",
    "created_at": "2018-07-20T18:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343288",
    "user": "https://github.com/antonio-rojas"
}
```

This gives a wrong answer

```
sage: A.<x,y>=ZZ[]
sage: lcm(2*x,2*x*y)
4*x*y
```

That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents.



---

archive/issue_comments_343289.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-21T09:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343289",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343290.json:
```json
{
    "body": "There are still many test failures which are unrelated to the sinclap_pdivide issue. They seem caused by singular now returning an warning when computing groebner bases over CC, so Sage falls back to the toy implementation:\n\n```\nsage: A.<x,y>=CC[]\nsage: I=A.ideal(x-y)\nsage: I._groebner_basis_singular()\n```\n\nnow returns\n\n```\nTypeError: Singular error:\n// ** groebner base computations with inexact coefficients can not be trusted due to rounding errors\n```\n\nWith singular 4.1.0 it gives\n\n```\nsage: I._groebner_basis_singular()\n[x - y]\n```\n\n\nThe problem is that the Singular warning\n\"groebner base computations with inexact coefficients can not be trusted due to rounding errors\" matches\n\n```\n       if s.find(\"error\") != -1 or s.find(\"Segment fault\") != -1:\n```\n\nfrom singular.py so Sage (incorrectly) throws a SingularError. The test for errors in singular.py should be made more reliable.",
    "created_at": "2018-07-21T18:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343290",
    "user": "https://github.com/antonio-rojas"
}
```

There are still many test failures which are unrelated to the sinclap_pdivide issue. They seem caused by singular now returning an warning when computing groebner bases over CC, so Sage falls back to the toy implementation:

```
sage: A.<x,y>=CC[]
sage: I=A.ideal(x-y)
sage: I._groebner_basis_singular()
```

now returns

```
TypeError: Singular error:
// ** groebner base computations with inexact coefficients can not be trusted due to rounding errors
```

With singular 4.1.0 it gives

```
sage: I._groebner_basis_singular()
[x - y]
```


The problem is that the Singular warning
"groebner base computations with inexact coefficients can not be trusted due to rounding errors" matches

```
       if s.find("error") != -1 or s.find("Segment fault") != -1:
```

from singular.py so Sage (incorrectly) throws a SingularError. The test for errors in singular.py should be made more reliable.



---

archive/issue_comments_343291.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-21T23:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343291",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343292.json:
```json
{
    "body": "> That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents. \n\nWhy? My understanding of the theory here is very limited, but shouldn't the lcm be `2 * x * y` in both cases?\n\n> There are still many test failures which are unrelated to the sinclap_pdivide issue.\n\nYeah I didn't have time to finish the tests unfortunately. Thanks for continuing to work on this.\n\n\nWhat's the status? Are there still remaining failures?",
    "created_at": "2018-07-23T12:09:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343292",
    "user": "https://github.com/timokau"
}
```

> That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents. 

Why? My understanding of the theory here is very limited, but shouldn't the lcm be `2 * x * y` in both cases?

> There are still many test failures which are unrelated to the sinclap_pdivide issue.

Yeah I didn't have time to finish the tests unfortunately. Thanks for continuing to work on this.


What's the status? Are there still remaining failures?



---

archive/issue_comments_343293.json:
```json
{
    "body": "Replying to [comment:20 gh-timokau]:\n> > That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents. \n> \n> Why? My understanding of the theory here is very limited, but shouldn't the lcm be `2 * x * y` in both cases?\n\nThe lcm is well defined only up to multiplication by a unit. Both `2*x*y` and `4*x*y` are correct over QQ[x,y], since they differ by 2 which is a unit in QQ[x,y]. But on ZZ[x,y] the only correct answers are `2*x*y` and `-2*x*y`\n\n \n> What's the status? Are there still remaining failures?\n\n\n```\nsage -t src/sage/libs/ntl/error.pyx  # Bad exit: 2\nsage -t src/sage/libs/ntl/ntl_ZZ_pX.pyx  # Bad exit: 2\nsage -t src/sage/schemes/jacobians/abstract_jacobian.py  # 1 doctest failed\nsage -t src/sage/schemes/projective/projective_morphism.py  # 3 doctests failed\nsage -t src/sage/modular/modform_hecketriangle/graded_ring_element.py  # 7 doctests failed\nsage -t src/sage/matrix/matrix_integer_dense.pyx  # Bad exit: 2\nsage -t src/sage/interfaces/singular.py  # 1 doctests failed\n```\n\n\nThe ntl ones are going to need some serious debugging.",
    "created_at": "2018-07-23T21:28:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343293",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:20 gh-timokau]:
> > That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents. 
> 
> Why? My understanding of the theory here is very limited, but shouldn't the lcm be `2 * x * y` in both cases?

The lcm is well defined only up to multiplication by a unit. Both `2*x*y` and `4*x*y` are correct over QQ[x,y], since they differ by 2 which is a unit in QQ[x,y]. But on ZZ[x,y] the only correct answers are `2*x*y` and `-2*x*y`

 
> What's the status? Are there still remaining failures?


```
sage -t src/sage/libs/ntl/error.pyx  # Bad exit: 2
sage -t src/sage/libs/ntl/ntl_ZZ_pX.pyx  # Bad exit: 2
sage -t src/sage/schemes/jacobians/abstract_jacobian.py  # 1 doctest failed
sage -t src/sage/schemes/projective/projective_morphism.py  # 3 doctests failed
sage -t src/sage/modular/modform_hecketriangle/graded_ring_element.py  # 7 doctests failed
sage -t src/sage/matrix/matrix_integer_dense.pyx  # Bad exit: 2
sage -t src/sage/interfaces/singular.py  # 1 doctests failed
```


The ntl ones are going to need some serious debugging.



---

archive/issue_comments_343294.json:
```json
{
    "body": "Replying to [comment:21 arojas]:\n> The lcm is well defined only up to multiplication by a unit. Both `2*x*y` and `4*x*y` are correct over QQ[x,y], since they differ by 2 which is a unit in QQ[x,y]. But on ZZ[x,y] the only correct answers are `2*x*y` and `-2*x*y`\n\nAh I didn't know / forgot that. That makes sense.\n\n> That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents. \n\nBut how does this solve the problem? E.g. let's determine the lcm of 2*x*y and 4*x*y using that technique. The contents would be 2 and 4, respectively. So we'd take `lcm(x*y, x*y)` in `Q[]`, which may be `42 * x * y`. We'd then multiply by `lcm(2, 4) = 4`, resulting in `168 * x * y`. Since `168` is not a unit in `Z`, this would still be wrong.\n\nDid I miss something?\n\nAnd do you know why Singular removed support for integer coefficients? I feel like we shouldn't have to hack around this.",
    "created_at": "2018-07-24T11:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343294",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:21 arojas]:
> The lcm is well defined only up to multiplication by a unit. Both `2*x*y` and `4*x*y` are correct over QQ[x,y], since they differ by 2 which is a unit in QQ[x,y]. But on ZZ[x,y] the only correct answers are `2*x*y` and `-2*x*y`

Ah I didn't know / forgot that. That makes sense.

> That is technically correct on Q[x,y] (although the coefficient is strange), but not on ZZ[x,y]. For the lcm, we should probably factor out the contents, take the lcm of the primitive parts over QQ and multiply by the lcm (on Z) of the contents. 

But how does this solve the problem? E.g. let's determine the lcm of 2*x*y and 4*x*y using that technique. The contents would be 2 and 4, respectively. So we'd take `lcm(x*y, x*y)` in `Q[]`, which may be `42 * x * y`. We'd then multiply by `lcm(2, 4) = 4`, resulting in `168 * x * y`. Since `168` is not a unit in `Z`, this would still be wrong.

Did I miss something?

And do you know why Singular removed support for integer coefficients? I feel like we shouldn't have to hack around this.



---

archive/issue_comments_343295.json:
```json
{
    "body": "Replying to [comment:22 gh-timokau]:\n> But how does this solve the problem? E.g. let's determine the lcm of 2*x*y and 4*x*y using that technique. The contents would be 2 and 4, respectively. So we'd take `lcm(x*y, x*y)` in `Q[]`, which may be `42 * x * y`. We'd then multiply by `lcm(2, 4) = 4`, resulting in `168 * x * y`. Since `168` is not a unit in `Z`, this would still be wrong.\n\nYes, of course you're right, this is all under the assumption that, when computing the gcd of two polynomials in QQ[] with integer coefficients and primitive, Singular will return a polynomial with the same properties. This sounds reasonable to me, but may very well not be true in all cases.\n\nAn alternative would be to simply return `self * g / self.gcd(g)`. This is an exact division so `__floordiv__` is not involved. Not sure about the computational cost though. \n\n> And do you know why Singular removed support for integer coefficients? I feel like we shouldn't have to hack around this.\n\nNo idea, the commit message doesn't say much. But I wonder if it even makes sense at all to define `__floordiv__` and `__mod__` for polynomials with integer coefficients. And if it does in some non-canonical way, the lcm (which is unambiguously well defined) shouldn't depend on it.",
    "created_at": "2018-07-24T11:57:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343295",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:22 gh-timokau]:
> But how does this solve the problem? E.g. let's determine the lcm of 2*x*y and 4*x*y using that technique. The contents would be 2 and 4, respectively. So we'd take `lcm(x*y, x*y)` in `Q[]`, which may be `42 * x * y`. We'd then multiply by `lcm(2, 4) = 4`, resulting in `168 * x * y`. Since `168` is not a unit in `Z`, this would still be wrong.

Yes, of course you're right, this is all under the assumption that, when computing the gcd of two polynomials in QQ[] with integer coefficients and primitive, Singular will return a polynomial with the same properties. This sounds reasonable to me, but may very well not be true in all cases.

An alternative would be to simply return `self * g / self.gcd(g)`. This is an exact division so `__floordiv__` is not involved. Not sure about the computational cost though. 

> And do you know why Singular removed support for integer coefficients? I feel like we shouldn't have to hack around this.

No idea, the commit message doesn't say much. But I wonder if it even makes sense at all to define `__floordiv__` and `__mod__` for polynomials with integer coefficients. And if it does in some non-canonical way, the lcm (which is unambiguously well defined) shouldn't depend on it.



---

archive/issue_comments_343296.json:
```json
{
    "body": "Or we can compute the gcd over ZZ and *then* coerce to QQ[] to perform the division with `singclap_pdivide`. This should give the correct answer and be computationally equivalent to the current (no longer working) method.",
    "created_at": "2018-07-24T12:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343296",
    "user": "https://github.com/antonio-rojas"
}
```

Or we can compute the gcd over ZZ and *then* coerce to QQ[] to perform the division with `singclap_pdivide`. This should give the correct answer and be computationally equivalent to the current (no longer working) method.



---

archive/issue_comments_343297.json:
```json
{
    "body": "I've [involved upstream](https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2768). They seem to be pretty responsive in that forum (and you don't actually need to register, which is a bonus).",
    "created_at": "2018-07-24T12:26:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343297",
    "user": "https://github.com/timokau"
}
```

I've [involved upstream](https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2768). They seem to be pretty responsive in that forum (and you don't actually need to register, which is a bonus).



---

archive/issue_comments_343298.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-24T17:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343298",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343299.json:
```json
{
    "body": "Down to the three ntl failures\n\n```\nsage -t src/sage/libs/ntl/error.pyx  # Bad exit: 2\nsage -t src/sage/libs/ntl/ntl_ZZ_pX.pyx  # Bad exit: 2\nsage -t src/sage/matrix/matrix_integer_dense.pyx  # Bad exit: 2\n```\n",
    "created_at": "2018-07-24T17:18:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343299",
    "user": "https://github.com/antonio-rojas"
}
```

Down to the three ntl failures

```
sage -t src/sage/libs/ntl/error.pyx  # Bad exit: 2
sage -t src/sage/libs/ntl/ntl_ZZ_pX.pyx  # Bad exit: 2
sage -t src/sage/matrix/matrix_integer_dense.pyx  # Bad exit: 2
```




---

archive/issue_comments_343300.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-24T17:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343300",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343301.json:
```json
{
    "body": "The NTL issue is probably related to the NTL upgrade. Especially this line in the singular changelog is interesting:\n\n> port to NTL 10 with threads (needs also C++11: gcc6 or -std=c++11) \n\nSo we probably have to fix the C++11 issue and update NTL.",
    "created_at": "2018-07-24T19:07:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343301",
    "user": "https://github.com/timokau"
}
```

The NTL issue is probably related to the NTL upgrade. Especially this line in the singular changelog is interesting:

> port to NTL 10 with threads (needs also C++11: gcc6 or -std=c++11) 

So we probably have to fix the C++11 issue and update NTL.



---

archive/issue_comments_343302.json:
```json
{
    "body": "Replying to [comment:29 gh-timokau]:\n> The NTL issue is probably related to the NTL upgrade. Especially this line in the singular changelog is interesting:\n> \n> > port to NTL 10 with threads (needs also C++11: gcc6 or -std=c++11) \n> \n> So we probably have to fix the C++11 issue and update NTL.\n\nNo, this is unrelated to the NTL version (I can reproduce both on the Sage distribution with NTL 10.3 and on Arch with NTL 11.2). It is caused by\nhttps://github.com/Singular/Sources/commit/28d88317\n\nSomeone who understands the error handling code should take a look at it",
    "created_at": "2018-07-24T19:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343302",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:29 gh-timokau]:
> The NTL issue is probably related to the NTL upgrade. Especially this line in the singular changelog is interesting:
> 
> > port to NTL 10 with threads (needs also C++11: gcc6 or -std=c++11) 
> 
> So we probably have to fix the C++11 issue and update NTL.

No, this is unrelated to the NTL version (I can reproduce both on the Sage distribution with NTL 10.3 and on Arch with NTL 11.2). It is caused by
https://github.com/Singular/Sources/commit/28d88317

Someone who understands the error handling code should take a look at it



---

archive/issue_comments_343303.json:
```json
{
    "body": "> ErrorCallback=HALT;\n\nIf that does what it sounds like, that would explain the issue. Sounds like a bad idea to me. We should probably also discuss that with upstream.",
    "created_at": "2018-07-24T22:04:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343303",
    "user": "https://github.com/timokau"
}
```

> ErrorCallback=HALT;

If that does what it sounds like, that would explain the issue. Sounds like a bad idea to me. We should probably also discuss that with upstream.



---

archive/issue_comments_343304.json:
```json
{
    "body": "Upstream: https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2769",
    "created_at": "2018-07-24T22:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343304",
    "user": "https://github.com/timokau"
}
```

Upstream: https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2769



---

archive/issue_comments_343305.json:
```json
{
    "body": "Upstream has replied:\n\n- the callback issue is now fixed by moving it out of libSingular into the executable singular. I've asked the author about a new release.\n\n- the singclap_pdivide issue looks like it wasn't a regression. According to the author, integer coefficients were never properly supported. He suggests using `p_Divide` (which uses `singclap_pdivide` internally) instead. That will return the division result without rest (`0` if it isn't divisible).",
    "created_at": "2018-07-25T13:15:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343305",
    "user": "https://github.com/timokau"
}
```

Upstream has replied:

- the callback issue is now fixed by moving it out of libSingular into the executable singular. I've asked the author about a new release.

- the singclap_pdivide issue looks like it wasn't a regression. According to the author, integer coefficients were never properly supported. He suggests using `p_Divide` (which uses `singclap_pdivide` internally) instead. That will return the division result without rest (`0` if it isn't divisible).



---

archive/issue_comments_343306.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-25T15:00:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343306",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343307.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-25T16:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343307",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343308.json:
```json
{
    "body": "Tests are good now.",
    "created_at": "2018-07-25T16:45:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343308",
    "user": "https://github.com/antonio-rojas"
}
```

Tests are good now.



---

archive/issue_comments_343309.json:
```json
{
    "body": "Great! I'm already testing this on nix. However if want to backport the patch, we need to document it in the SPKG.txt file.",
    "created_at": "2018-07-25T19:53:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343309",
    "user": "https://github.com/timokau"
}
```

Great! I'm already testing this on nix. However if want to backport the patch, we need to document it in the SPKG.txt file.



---

archive/issue_comments_343310.json:
```json
{
    "body": "Replying to [comment:37 gh-timokau]:\n> Great! I'm already testing this on nix. However if want to backport the patch, we need to document it in the SPKG.txt file.\n\nIs that mandatory? I see lots of patches which aren't documented in SPKG.txt (including the ones removed in this branch) and many of those who are are outdated.",
    "created_at": "2018-07-25T20:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343310",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:37 gh-timokau]:
> Great! I'm already testing this on nix. However if want to backport the patch, we need to document it in the SPKG.txt file.

Is that mandatory? I see lots of patches which aren't documented in SPKG.txt (including the ones removed in this branch) and many of those who are are outdated.



---

archive/issue_comments_343311.json:
```json
{
    "body": "It should be. Unfortunately that hasn't always been the case, but at least Jeroen agreed with me on that point (on some trac ticket). It is especially important for us package maintainers, at least those not directly involved with the upgrade. It is also important for future sage contributors who might otherwise just rather not touch the patch because they don't know why it was introduced.\n\nAlthough the second point is pretty much moot in this case, since the patch will no longer apply on the next singular version. Still, the first point holds and I think such guildelines work best if they are adhered to unconditionally.",
    "created_at": "2018-07-25T20:29:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343311",
    "user": "https://github.com/timokau"
}
```

It should be. Unfortunately that hasn't always been the case, but at least Jeroen agreed with me on that point (on some trac ticket). It is especially important for us package maintainers, at least those not directly involved with the upgrade. It is also important for future sage contributors who might otherwise just rather not touch the patch because they don't know why it was introduced.

Although the second point is pretty much moot in this case, since the patch will no longer apply on the next singular version. Still, the first point holds and I think such guildelines work best if they are adhered to unconditionally.



---

archive/issue_comments_343312.json:
```json
{
    "body": "Did you run the long doctests? With the nix package I'm getting the following error:\n\n\n```\nFile \"/nix/store/qpb654994xa2cv2r4xwxwj7gbv5by5ki-sage-src-8.3.rc2/src/sage/schemes/elliptic_curves/padics.py\", line 876, in sage.schemes.elliptic_curves.padics.padic_height_via_multiply\nFailed example:\n    for prec in range(2, max_prec):                 # long time\n        assert E.padic_height_via_multiply(5, prec)(P) == full   # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 573, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py\", line 983, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.schemes.elliptic_curves.padics.padic_height_via_multiply[13]>\", line 2, in <module>\n        assert E.padic_height_via_multiply(Integer(5), prec)(P) == full   # long time\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py\", line 906, in padic_height_via_multiply\n        sigma = self.padic_sigma_truncated(p, N=adjusted_prec, E2=E2, lamb=lamb)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py\", line 1282, in padic_sigma_truncated\n        E2 = self.padic_E2(p, N-2, check_hypotheses=False)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py\", line 1503, in padic_E2\n        frob_p = self.matrix_of_frobenius(p, prec, check, check_hypotheses, algorithm).change_ring(Integers(p**prec))\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py\", line 1653, in matrix_of_frobenius\n        Q, p, adjusted_prec, trace)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py\", line 1658, in matrix_of_frobenius\n        F1_reduced = reduce_all(Q, p, F1_coeffs, offset)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py\", line 1024, in reduce_all\n        exact_form = reduce_negative(Q, p, coeffs, offset, exact_form)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py\", line 799, in reduce_negative\n        a[0] = base_ring(lift(a[0]) / (j+1))\n      File \"sage/structure/parent.pyx\", line 920, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9728)\n        return mor._call_(x)\n      File \"sage/structure/coerce_maps.pyx\", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4555)\n        raise\n      File \"sage/structure/coerce_maps.pyx\", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4423)\n        return C._element_constructor(x)\n      File \"/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py\", line 1167, in _element_constructor_\n        return integer_mod.IntegerMod(self, x)\n      File \"sage/rings/finite_rings/integer_mod.pyx\", line 197, in sage.rings.finite_rings.integer_mod.IntegerMod (build/cythonized/sage/rings/finite_rings/integer_mod.c:4554)\n        return t(parent, value)\n      File \"sage/rings/finite_rings/integer_mod.pyx\", line 361, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.__init__ (build/cythonized/sage/rings/finite_rings/integer_mod.c:5735)\n        z = value % self.__modulus.sageInteger\n      File \"sage/rings/rational.pyx\", line 2869, in sage.rings.rational.Rational.__mod__ (build/cythonized/sage/rings/rational.c:25815)\n        d = d.inverse_mod(other)\n      File \"sage/rings/integer.pyx\", line 6574, in sage.rings.integer.Integer.inverse_mod (build/cythonized/sage/rings/integer.c:41093)\n        raise ZeroDivisionError(\"Inverse does not exist.\")\n    ZeroDivisionError: Inverse does not exist.\n```\n\n\nThis might of course be due to packaging, I haven't tested it with sage-the-distribution. But the only thing I changed was the singular update.",
    "created_at": "2018-07-25T20:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343312",
    "user": "https://github.com/timokau"
}
```

Did you run the long doctests? With the nix package I'm getting the following error:


```
File "/nix/store/qpb654994xa2cv2r4xwxwj7gbv5by5ki-sage-src-8.3.rc2/src/sage/schemes/elliptic_curves/padics.py", line 876, in sage.schemes.elliptic_curves.padics.padic_height_via_multiply
Failed example:
    for prec in range(2, max_prec):                 # long time
        assert E.padic_height_via_multiply(5, prec)(P) == full   # long time
Exception raised:
    Traceback (most recent call last):
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.padics.padic_height_via_multiply[13]>", line 2, in <module>
        assert E.padic_height_via_multiply(Integer(5), prec)(P) == full   # long time
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 906, in padic_height_via_multiply
        sigma = self.padic_sigma_truncated(p, N=adjusted_prec, E2=E2, lamb=lamb)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 1282, in padic_sigma_truncated
        E2 = self.padic_E2(p, N-2, check_hypotheses=False)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 1503, in padic_E2
        frob_p = self.matrix_of_frobenius(p, prec, check, check_hypotheses, algorithm).change_ring(Integers(p**prec))
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/elliptic_curves/padics.py", line 1653, in matrix_of_frobenius
        Q, p, adjusted_prec, trace)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 1658, in matrix_of_frobenius
        F1_reduced = reduce_all(Q, p, F1_coeffs, offset)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 1024, in reduce_all
        exact_form = reduce_negative(Q, p, coeffs, offset, exact_form)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 799, in reduce_negative
        a[0] = base_ring(lift(a[0]) / (j+1))
      File "sage/structure/parent.pyx", line 920, in sage.structure.parent.Parent.__call__ (build/cythonized/sage/structure/parent.c:9728)
        return mor._call_(x)
      File "sage/structure/coerce_maps.pyx", line 145, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4555)
        raise
      File "sage/structure/coerce_maps.pyx", line 140, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (build/cythonized/sage/structure/coerce_maps.c:4423)
        return C._element_constructor(x)
      File "/nix/store/4r6y3kcvb6l54krs7ajyf9kyns8mlwad-python-2.7.15-env/lib/python2.7/site-packages/sage/rings/finite_rings/integer_mod_ring.py", line 1167, in _element_constructor_
        return integer_mod.IntegerMod(self, x)
      File "sage/rings/finite_rings/integer_mod.pyx", line 197, in sage.rings.finite_rings.integer_mod.IntegerMod (build/cythonized/sage/rings/finite_rings/integer_mod.c:4554)
        return t(parent, value)
      File "sage/rings/finite_rings/integer_mod.pyx", line 361, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.__init__ (build/cythonized/sage/rings/finite_rings/integer_mod.c:5735)
        z = value % self.__modulus.sageInteger
      File "sage/rings/rational.pyx", line 2869, in sage.rings.rational.Rational.__mod__ (build/cythonized/sage/rings/rational.c:25815)
        d = d.inverse_mod(other)
      File "sage/rings/integer.pyx", line 6574, in sage.rings.integer.Integer.inverse_mod (build/cythonized/sage/rings/integer.c:41093)
        raise ZeroDivisionError("Inverse does not exist.")
    ZeroDivisionError: Inverse does not exist.
```


This might of course be due to packaging, I haven't tested it with sage-the-distribution. But the only thing I changed was the singular update.



---

archive/issue_comments_343313.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-25T20:36:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343313",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343314.json:
```json
{
    "body": "Replying to [comment:40 gh-timokau]:\n> Did you run the long doctests? With the nix package I'm getting the following error:\n> \n\nWorks for me, both on the Sage distribution and on the Arch package.",
    "created_at": "2018-07-25T20:38:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343314",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:40 gh-timokau]:
> Did you run the long doctests? With the nix package I'm getting the following error:
> 

Works for me, both on the Sage distribution and on the Arch package.



---

archive/issue_comments_343315.json:
```json
{
    "body": "I cannot reproduce the failure when doctesting only that one file. My system was under load at the time. Maybe its an unrelated transient issue (which would arguably be worse).\n\nIf you don't want to do it, I'll add the patch documentation tomorrow.",
    "created_at": "2018-07-25T20:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343315",
    "user": "https://github.com/timokau"
}
```

I cannot reproduce the failure when doctesting only that one file. My system was under load at the time. Maybe its an unrelated transient issue (which would arguably be worse).

If you don't want to do it, I'll add the patch documentation tomorrow.



---

archive/issue_comments_343316.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-25T20:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343316",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343317.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-25T20:46:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343317",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_343318.json:
```json
{
    "body": "Perfect, thank you :)\n\nFor what it's worth: looks good to me.",
    "created_at": "2018-07-25T20:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343318",
    "user": "https://github.com/timokau"
}
```

Perfect, thank you :)

For what it's worth: looks good to me.



---

archive/issue_comments_343319.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-25T22:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343319",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343320.json:
```json
{
    "body": "What does\n\n```\n(see forum: \"NTL error handling\", for SAGE)\n```\n\nmean in the patch? You'll have to be more clear than that.",
    "created_at": "2018-07-25T22:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343320",
    "user": "https://github.com/jdemeyer"
}
```

What does

```
(see forum: "NTL error handling", for SAGE)
```

mean in the patch? You'll have to be more clear than that.



---

archive/issue_comments_343321.json:
```json
{
    "body": "Replying to [comment:47 jdemeyer]:\n> What does\n> {{{\n> (see forum: \"NTL error handling\", for SAGE)\n> }}}\n> mean in the patch? You'll have to be more clear than that.\n\nThis is the literal upstream commit message",
    "created_at": "2018-07-25T22:30:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343321",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:47 jdemeyer]:
> What does
> {{{
> (see forum: "NTL error handling", for SAGE)
> }}}
> mean in the patch? You'll have to be more clear than that.

This is the literal upstream commit message



---

archive/issue_comments_343322.json:
```json
{
    "body": "OK maybe but you at least for some link or explanation in the patch (and remove the explanation of the patch in `SPKG.txt`).",
    "created_at": "2018-07-25T22:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343322",
    "user": "https://github.com/jdemeyer"
}
```

OK maybe but you at least for some link or explanation in the patch (and remove the explanation of the patch in `SPKG.txt`).



---

archive/issue_comments_343323.json:
```json
{
    "body": "Replying to [comment:39 gh-timokau]:\n> It should be. Unfortunately that hasn't always been the case, but at least Jeroen agreed with me on that point (on some trac ticket). It is especially important for us package maintainers, at least those not directly involved with the upgrade. It is also important for future sage contributors who might otherwise just rather not touch the patch because they don't know why it was introduced.\n\nReplying to [comment:49 jdemeyer]:\n> OK maybe but you at least for some link or explanation in the patch (and remove the explanation of the patch in `SPKG.txt`).\n\nIm getting contradictory instructions here... should I or shouldn't I document patches in SPKG.txt?",
    "created_at": "2018-07-26T08:50:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343323",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:39 gh-timokau]:
> It should be. Unfortunately that hasn't always been the case, but at least Jeroen agreed with me on that point (on some trac ticket). It is especially important for us package maintainers, at least those not directly involved with the upgrade. It is also important for future sage contributors who might otherwise just rather not touch the patch because they don't know why it was introduced.

Replying to [comment:49 jdemeyer]:
> OK maybe but you at least for some link or explanation in the patch (and remove the explanation of the patch in `SPKG.txt`).

Im getting contradictory instructions here... should I or shouldn't I document patches in SPKG.txt?



---

archive/issue_comments_343324.json:
```json
{
    "body": "documenting patches in patches themselves is better.\n\nas well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.",
    "created_at": "2018-07-26T09:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343324",
    "user": "https://github.com/dimpase"
}
```

documenting patches in patches themselves is better.

as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.



---

archive/issue_comments_343325.json:
```json
{
    "body": "Replying to [comment:50 arojas]:\n> should I or shouldn't I document patches in SPKG.txt?\n\nDo not document it in `SPKG.txt`, but document it in the `.patch` file itself. And please include links to upstream (if applicable) and to this ticket.",
    "created_at": "2018-07-26T09:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343325",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:50 arojas]:
> should I or shouldn't I document patches in SPKG.txt?

Do not document it in `SPKG.txt`, but document it in the `.patch` file itself. And please include links to upstream (if applicable) and to this ticket.



---

archive/issue_comments_343326.json:
```json
{
    "body": "Running `make ptestlong` now...",
    "created_at": "2018-07-26T09:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343326",
    "user": "https://github.com/jdemeyer"
}
```

Running `make ptestlong` now...



---

archive/issue_comments_343327.json:
```json
{
    "body": "`rest` -> `remainder`",
    "created_at": "2018-07-26T09:27:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343327",
    "user": "https://github.com/jdemeyer"
}
```

`rest` -> `remainder`



---

archive/issue_comments_343328.json:
```json
{
    "body": "Replying to [comment:47 jdemeyer]:\n> What does\n> {{{\n> (see forum: \"NTL error handling\", for SAGE)\n> }}}\n> mean in the patch? You'll have to be more clear than that.\n\nThat is the upstream commit message, referencing my forum post [here](https://www.singular.uni-kl.de/forum/viewtopic.php?t=2769)..\n\nReplying to [comment:50 arojas]:\n> Im getting contradictory instructions here... should I or shouldn't I document patches in SPKG.txt?\n\nI'm happy with both versions as long as it's documented. Of course there is value in locality.\n\nReplying to [comment:51 dimpase]:\n> documenting patches in patches themselves is better.\n> \n> as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.\n\nI think the patch is re-based. What git facility are you talking about? I usually just redirect `git show` into a file.",
    "created_at": "2018-07-26T12:20:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343328",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:47 jdemeyer]:
> What does
> {{{
> (see forum: "NTL error handling", for SAGE)
> }}}
> mean in the patch? You'll have to be more clear than that.

That is the upstream commit message, referencing my forum post [here](https://www.singular.uni-kl.de/forum/viewtopic.php?t=2769)..

Replying to [comment:50 arojas]:
> Im getting contradictory instructions here... should I or shouldn't I document patches in SPKG.txt?

I'm happy with both versions as long as it's documented. Of course there is value in locality.

Replying to [comment:51 dimpase]:
> documenting patches in patches themselves is better.
> 
> as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.

I think the patch is re-based. What git facility are you talking about? I usually just redirect `git show` into a file.



---

archive/issue_comments_343329.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-26T13:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343329",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_343330.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-07-26T13:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343330",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_343331.json:
```json
{
    "body": "Replying to [comment:54 jdemeyer]:\n> `rest` -> `remainder`\n\nFixed (this was taken verbatim from Singular's header)\n\nReplying to [comment:55 gh-timokau]:\n> > as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.\n> \n> I think the patch is re-based. What git facility are you talking about? I usually just redirect `git show` into a file.\n\nIndeed the patch doesn't apply cleanly on top of 4.1.1.p2 and required rebasing.",
    "created_at": "2018-07-26T13:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343331",
    "user": "https://github.com/antonio-rojas"
}
```

Replying to [comment:54 jdemeyer]:
> `rest` -> `remainder`

Fixed (this was taken verbatim from Singular's header)

Replying to [comment:55 gh-timokau]:
> > as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.
> 
> I think the patch is re-based. What git facility are you talking about? I usually just redirect `git show` into a file.

Indeed the patch doesn't apply cleanly on top of 4.1.1.p2 and required rebasing.



---

archive/issue_comments_343332.json:
```json
{
    "body": "Replying to [comment:57 arojas]:\n> Replying to [comment:54 jdemeyer]:\n> > `rest` -> `remainder`\n> \n> Fixed (this was taken verbatim from Singular's header)\n\nThat's German: https://de.wikipedia.org/wiki/Division_mit_Rest",
    "created_at": "2018-07-26T13:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343332",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:57 arojas]:
> Replying to [comment:54 jdemeyer]:
> > `rest` -> `remainder`
> 
> Fixed (this was taken verbatim from Singular's header)

That's German: https://de.wikipedia.org/wiki/Division_mit_Rest



---

archive/issue_comments_343333.json:
```json
{
    "body": "Replying to [comment:55 gh-timokau]:\n \n> Replying to [comment:51 dimpase]:\n> > documenting patches in patches themselves is better.\n> > \n> > as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.\n> \n> I think the patch is re-based. What git facility are you talking about? I usually just redirect `git show` into a file.\n\nsee\nhttps://trac.sagemath.org/ticket/21781",
    "created_at": "2018-07-26T14:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343333",
    "user": "https://github.com/dimpase"
}
```

Replying to [comment:55 gh-timokau]:
 
> Replying to [comment:51 dimpase]:
> > documenting patches in patches themselves is better.
> > 
> > as well, if a patch is lifted off upstream git repo, it is best to use git's facility to wrap the patch accordingly.
> 
> I think the patch is re-based. What git facility are you talking about? I usually just redirect `git show` into a file.

see
https://trac.sagemath.org/ticket/21781



---

archive/issue_comments_343334.json:
```json
{
    "body": "I made a few fixes to improve style and optimization. I also put back the `p * q // q == p` doctests which were removed (why?).\n\nSo you can set positive review if you agree with my last commit.\n----\nNew commits:",
    "created_at": "2018-07-28T15:37:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343334",
    "user": "https://github.com/jdemeyer"
}
```

I made a few fixes to improve style and optimization. I also put back the `p * q // q == p` doctests which were removed (why?).

So you can set positive review if you agree with my last commit.
----
New commits:



---

archive/issue_comments_343335.json:
```json
{
    "body": "Upstream [said on Thursday](https://www.singular.uni-kl.de/forum/viewtopic.php?t=2769)\n\n> Singular 4.1.1p3 will appear within the next week\n\n\nAlso I'm still getting that one test failure I reported above. Only when running the whole testsuite (not when testing that file individually). I'll see if I can find the root cause of that.",
    "created_at": "2018-07-29T16:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343335",
    "user": "https://github.com/timokau"
}
```

Upstream [said on Thursday](https://www.singular.uni-kl.de/forum/viewtopic.php?t=2769)

> Singular 4.1.1p3 will appear within the next week


Also I'm still getting that one test failure I reported above. Only when running the whole testsuite (not when testing that file individually). I'll see if I can find the root cause of that.



---

archive/issue_comments_343336.json:
```json
{
    "body": "> > Singular 4.1.1p3 will appear within the next week\n\nI wouldn't wait for that, this ticket is essentially ready to go.\n\n> Also I'm still getting that one test failure I reported above. I'll see if I can find the root cause of that.\n\nDo you mean [comment:40]? That seems unrelated to this ticket, see #25969. That being said, if you can deterministically reproduce that failure, that would be really awesome since I don't know how to reproduce it. Please follow up at #25969.",
    "created_at": "2018-07-29T18:50:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343336",
    "user": "https://github.com/jdemeyer"
}
```

> > Singular 4.1.1p3 will appear within the next week

I wouldn't wait for that, this ticket is essentially ready to go.

> Also I'm still getting that one test failure I reported above. I'll see if I can find the root cause of that.

Do you mean [comment:40]? That seems unrelated to this ticket, see #25969. That being said, if you can deterministically reproduce that failure, that would be really awesome since I don't know how to reproduce it. Please follow up at #25969.



---

archive/issue_comments_343337.json:
```json
{
    "body": "Replying to [comment:63 jdemeyer]:\n> > > Singular 4.1.1p3 will appear within the next week\n> \n> I wouldn't wait for that, this ticket is essentially ready to go.\n\nThat would avoid having to patch singular. In this case its a bit of a special case since singular already needs special attention anyways, so I'm not very invested.\n\nBut since we can't merge this before 8.3 anyways, maybe it'll sort itself out.\n\n> > Also I'm still getting that one test failure I reported above. I'll see if I can find the root cause of that.\n> \n> Do you mean [comment:40]? That seems unrelated to this ticket, see #25969. That being said, if you can deterministically reproduce that failure, that would be really awesome since I don't know how to reproduce it. Please follow up at #25969.\n\nDid that.",
    "created_at": "2018-07-29T20:02:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343337",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:63 jdemeyer]:
> > > Singular 4.1.1p3 will appear within the next week
> 
> I wouldn't wait for that, this ticket is essentially ready to go.

That would avoid having to patch singular. In this case its a bit of a special case since singular already needs special attention anyways, so I'm not very invested.

But since we can't merge this before 8.3 anyways, maybe it'll sort itself out.

> > Also I'm still getting that one test failure I reported above. I'll see if I can find the root cause of that.
> 
> Do you mean [comment:40]? That seems unrelated to this ticket, see #25969. That being said, if you can deterministically reproduce that failure, that would be really awesome since I don't know how to reproduce it. Please follow up at #25969.

Did that.



---

archive/issue_comments_343338.json:
```json
{
    "body": "Replying to [comment:64 gh-timokau]:\n> That would avoid having to patch singular.\n\nWe are already patching Singular, so that argument is meaningless.",
    "created_at": "2018-07-29T22:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343338",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:64 gh-timokau]:
> That would avoid having to patch singular.

We are already patching Singular, so that argument is meaningless.



---

archive/issue_comments_343339.json:
```json
{
    "body": "Replying to [comment:65 jdemeyer]:\n> Replying to [comment:64 gh-timokau]:\n> > That would avoid having to patch singular.\n> \n> We are already patching Singular, so that argument is meaningless.\n\nNot anymore after the new singular release. And just because its not perfect doesn't mean we have to make it worse.",
    "created_at": "2018-07-30T11:26:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343339",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:65 jdemeyer]:
> Replying to [comment:64 gh-timokau]:
> > That would avoid having to patch singular.
> 
> We are already patching Singular, so that argument is meaningless.

Not anymore after the new singular release. And just because its not perfect doesn't mean we have to make it worse.



---

archive/issue_comments_343340.json:
```json
{
    "body": "Replying to [comment:66 gh-timokau]:\n> Not anymore after the new singular release.\n\nOf course, but how is that relevant to this ticket? In case it wasn't clear: I agree to upgrade to 4.1.1p3 eventually. The question is not whether we should upgrade to 4.1.1p3, but whether we should upgrade to 4.1.1p2 first. Given that the work is already done, I would argue that we should do that.",
    "created_at": "2018-07-30T13:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343340",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:66 gh-timokau]:
> Not anymore after the new singular release.

Of course, but how is that relevant to this ticket? In case it wasn't clear: I agree to upgrade to 4.1.1p3 eventually. The question is not whether we should upgrade to 4.1.1p3, but whether we should upgrade to 4.1.1p2 first. Given that the work is already done, I would argue that we should do that.



---

archive/issue_comments_343341.json:
```json
{
    "body": "Especially given the fact that 4.1.1p3 is not released yet, I see no reason to wait.",
    "created_at": "2018-07-30T13:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343341",
    "user": "https://github.com/jdemeyer"
}
```

Especially given the fact that 4.1.1p3 is not released yet, I see no reason to wait.



---

archive/issue_comments_343342.json:
```json
{
    "body": "Replying to [comment:66 gh-timokau]:\n> And just because its not perfect doesn't mean we have to make it worse.\n\nI don't understand you here: how is this ticket (as it is right now) making anything worse?",
    "created_at": "2018-07-30T13:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343342",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:66 gh-timokau]:
> And just because its not perfect doesn't mean we have to make it worse.

I don't understand you here: how is this ticket (as it is right now) making anything worse?



---

archive/issue_comments_343343.json:
```json
{
    "body": "Replying to [comment:67 jdemeyer]:\n> Replying to [comment:66 gh-timokau]:\n> > Not anymore after the new singular release.\n> \n> Of course, but how is that relevant to this ticket? In case it wasn't clear: I agree to upgrade to 4.1.1p3 eventually. The question is not whether we should upgrade to 4.1.1p3, but whether we should upgrade to 4.1.1p2 first. Given that the work is already done, I would argue that we should do that.\n\nI'm arguing mostly on principle: I still think the principle should be to only apply patches very conservatively. If we need a feature or a fix, we should\n\n1) report upstream\n\n2) ask upstream for a release containing that fix/feature\n\n3) if the fix/feature isn't essential, default to waiting for that upstream release. Maybe work around the issue feature within sage until then if possible.\n\nOf course this doesn't 100% apply to this case, since this actually removes patches from singular and the update isn't possible without this. Again, I'm not strongly opposed and mostly arguing on principle.\n\n\nReplying to [comment:68 jdemeyer]:\n> Especially given the fact that 4.1.1p3 is not released yet, I see no reason to wait.\n\nI see no reason to hurry either.\n\n\nReplying to [comment:69 jdemeyer]:\n> Replying to [comment:66 gh-timokau]:\n> > And just because its not perfect doesn't mean we have to make it worse.\n> \n> I don't understand you here: how is this ticket (as it is right now) making anything worse?\n\nNo it's definitely making things better, I worded that poorly. But first updating to p2 and then to p3 puts additional load on the package maintainers. I'm assuming that package maintainers have until now pinned their singular dependency to an older version (although I think only gentoo and nix do that). Then after updating to p2, the mainteinrs will have to remove the version pin and apply the patch to singular. After p3 they'll have to remove the singular patch again. If we just update to p3 directly, action will only be required once.\n\nThat assumes that p2 and p3 would land in different (pre-) releases of sage. That's unlikely so the entire argument is pretty theoretical. Also since I was involved here I already applied the patch for nix anyways.",
    "created_at": "2018-07-30T18:08:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343343",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:67 jdemeyer]:
> Replying to [comment:66 gh-timokau]:
> > Not anymore after the new singular release.
> 
> Of course, but how is that relevant to this ticket? In case it wasn't clear: I agree to upgrade to 4.1.1p3 eventually. The question is not whether we should upgrade to 4.1.1p3, but whether we should upgrade to 4.1.1p2 first. Given that the work is already done, I would argue that we should do that.

I'm arguing mostly on principle: I still think the principle should be to only apply patches very conservatively. If we need a feature or a fix, we should

1) report upstream

2) ask upstream for a release containing that fix/feature

3) if the fix/feature isn't essential, default to waiting for that upstream release. Maybe work around the issue feature within sage until then if possible.

Of course this doesn't 100% apply to this case, since this actually removes patches from singular and the update isn't possible without this. Again, I'm not strongly opposed and mostly arguing on principle.


Replying to [comment:68 jdemeyer]:
> Especially given the fact that 4.1.1p3 is not released yet, I see no reason to wait.

I see no reason to hurry either.


Replying to [comment:69 jdemeyer]:
> Replying to [comment:66 gh-timokau]:
> > And just because its not perfect doesn't mean we have to make it worse.
> 
> I don't understand you here: how is this ticket (as it is right now) making anything worse?

No it's definitely making things better, I worded that poorly. But first updating to p2 and then to p3 puts additional load on the package maintainers. I'm assuming that package maintainers have until now pinned their singular dependency to an older version (although I think only gentoo and nix do that). Then after updating to p2, the mainteinrs will have to remove the version pin and apply the patch to singular. After p3 they'll have to remove the singular patch again. If we just update to p3 directly, action will only be required once.

That assumes that p2 and p3 would land in different (pre-) releases of sage. That's unlikely so the entire argument is pretty theoretical. Also since I was involved here I already applied the patch for nix anyways.



---

archive/issue_comments_343344.json:
```json
{
    "body": "p3 has been released: http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-1-1/singular-4.1.1p3.tar.gz",
    "created_at": "2018-07-31T19:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343344",
    "user": "https://github.com/timokau"
}
```

p3 has been released: http://www.mathematik.uni-kl.de/ftp/pub/Math/Singular/SOURCES/4-1-1/singular-4.1.1p3.tar.gz



---

archive/issue_comments_343345.json:
```json
{
    "body": "OK, I'm having a look at the upgrade.",
    "created_at": "2018-08-01T09:59:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343345",
    "user": "https://github.com/jdemeyer"
}
```

OK, I'm having a look at the upgrade.



---

archive/issue_comments_343346.json:
```json
{
    "body": "The upgrade is breaking because of https://www.singular.uni-kl.de:8005/trac/ticket/834\n\nSo I would still upgrade to 4.1.1p2 for now and let upstream handle that bug.",
    "created_at": "2018-08-01T11:03:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343346",
    "user": "https://github.com/jdemeyer"
}
```

The upgrade is breaking because of https://www.singular.uni-kl.de:8005/trac/ticket/834

So I would still upgrade to 4.1.1p2 for now and let upstream handle that bug.



---

archive/issue_comments_343347.json:
```json
{
    "body": "Well upstream fixed that quick, but that still means we would have an upstream patch.",
    "created_at": "2018-08-01T22:42:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343347",
    "user": "https://github.com/kiwifb"
}
```

Well upstream fixed that quick, but that still means we would have an upstream patch.



---

archive/issue_comments_343348.json:
```json
{
    "body": "That's fine by me. Judging by past release dates, its unlikely we'll get a quick new patch release with a fix. And this ticket is a great improvement over the status quo.\n\nThanks for updating and reporting the bug.",
    "created_at": "2018-08-02T18:40:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343348",
    "user": "https://github.com/timokau"
}
```

That's fine by me. Judging by past release dates, its unlikely we'll get a quick new patch release with a fix. And this ticket is a great improvement over the status quo.

Thanks for updating and reporting the bug.



---

archive/issue_comments_343349.json:
```json
{
    "body": "Let me just try to apply that patch. If it's the only issue, we might as well upgrade to 4.1.1p3 with that patch.",
    "created_at": "2018-08-03T07:30:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343349",
    "user": "https://github.com/jdemeyer"
}
```

Let me just try to apply that patch. If it's the only issue, we might as well upgrade to 4.1.1p3 with that patch.



---

archive/issue_comments_343350.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-08-03T07:30:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343350",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343351.json:
```json
{
    "body": "4.1.1p3 is also breaking `p_group_cohomology` optional tests.\n\nI still suggest to upgrade to 4.1.1p2. I already created a new ticket for later Singular upgrades: #25993",
    "created_at": "2018-08-03T10:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343351",
    "user": "https://github.com/jdemeyer"
}
```

4.1.1p3 is also breaking `p_group_cohomology` optional tests.

I still suggest to upgrade to 4.1.1p2. I already created a new ticket for later Singular upgrades: #25993



---

archive/issue_comments_343352.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-03T10:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343352",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_343353.json:
```json
{
    "body": "I opened an issue on the Singular Trac about their versioning scheme: https://www.singular.uni-kl.de:8005/trac/ticket/836",
    "created_at": "2018-08-03T12:03:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343353",
    "user": "https://github.com/jdemeyer"
}
```

I opened an issue on the Singular Trac about their versioning scheme: https://www.singular.uni-kl.de:8005/trac/ticket/836



---

archive/issue_comments_343354.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-05T08:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343354",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_343355.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-06T15:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343355",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_343356.json:
```json
{
    "body": "I noted a regression at #26023, though I might still unmerge this ticket...",
    "created_at": "2018-08-07T23:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343356",
    "user": "https://github.com/vbraun"
}
```

I noted a regression at #26023, though I might still unmerge this ticket...



---

archive/issue_comments_343357.json:
```json
{
    "body": "Replying to [comment:83 vbraun]:\n> though I might still unmerge this ticket...\n\nWhat are you unsure about? Either you consider #26023 serious enough to warrant unmerging this ticket, or you don't.",
    "created_at": "2018-08-08T08:06:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343357",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:83 vbraun]:
> though I might still unmerge this ticket...

What are you unsure about? Either you consider #26023 serious enough to warrant unmerging this ticket, or you don't.



---

archive/issue_comments_343358.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2018-08-10T22:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343358",
    "user": "https://github.com/vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_343359.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2018-08-10T22:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343359",
    "user": "https://github.com/vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_343360.json:
```json
{
    "body": "I'm assuming that you reopened this because of #26023.",
    "created_at": "2018-08-11T11:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343360",
    "user": "https://github.com/jdemeyer"
}
```

I'm assuming that you reopened this because of #26023.



---

archive/issue_comments_343361.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2018-08-11T13:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343361",
    "user": "https://github.com/jdemeyer"
}
```

Last 10 new commits:



---

archive/issue_comments_343362.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-08-11T13:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343362",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343363.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-11T16:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343363",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_343364.json:
```json
{
    "body": "Thanks!",
    "created_at": "2018-08-11T16:55:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343364",
    "user": "https://github.com/vbraun"
}
```

Thanks!



---

archive/issue_comments_343365.json:
```json
{
    "body": "Replying to [comment:11 gh-timokau]:\n> With my limited knowledge of the topic and based on `git log`, it seems like we basically have to revert #25313.\n> \n> Mark, do you have more information about that? The issue explained [comment:7 here].\n\nThanks for the notice, and sorry for having taken so long to react.\n\nUnfortunately, I know very, very little about Singular. But I saw that, in `lcm()`, Antonio replaced the call to `singclap_pdivide()` to one to `p_Divide()`. This seems to be a new Singular function that does support polynomials over\u00a0\u2124. Wouldn't it be possible to use it in `__floordiv__()` too (on a new ticket, of course)?",
    "created_at": "2018-08-15T10:46:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343365",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:11 gh-timokau]:
> With my limited knowledge of the topic and based on `git log`, it seems like we basically have to revert #25313.
> 
> Mark, do you have more information about that? The issue explained [comment:7 here].

Thanks for the notice, and sorry for having taken so long to react.

Unfortunately, I know very, very little about Singular. But I saw that, in `lcm()`, Antonio replaced the call to `singclap_pdivide()` to one to `p_Divide()`. This seems to be a new Singular function that does support polynomials over ℤ. Wouldn't it be possible to use it in `__floordiv__()` too (on a new ticket, of course)?



---

archive/issue_comments_343366.json:
```json
{
    "body": "It may be, I don't recall the details of how it is used in that function. I don't think the `p_Divide` function is new, we just didn't use it in sage before.",
    "created_at": "2018-08-15T11:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343366",
    "user": "https://github.com/timokau"
}
```

It may be, I don't recall the details of how it is used in that function. I don't think the `p_Divide` function is new, we just didn't use it in sage before.



---

archive/issue_comments_343367.json:
```json
{
    "body": "Replying to [comment:91 gh-timokau]:\n> It may be, I don't recall the details of how it is used in that function. I don't think the `p_Divide` function is new, we just didn't use it in sage before.\n\nThanks! It seems to work, though the resulting code is slower than before this ticket. See #26067.",
    "created_at": "2018-08-15T16:11:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343367",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:91 gh-timokau]:
> It may be, I don't recall the details of how it is used in that function. I don't think the `p_Divide` function is new, we just didn't use it in sage before.

Thanks! It seems to work, though the resulting code is slower than before this ticket. See #26067.



---

archive/issue_comments_343368.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-17T21:14:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24498",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24498#issuecomment-343368",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
