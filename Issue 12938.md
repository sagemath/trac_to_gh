# Issue 12938: ComplexNumber should be able to accept the Python complex type

Issue created by migration from Trac.

Original creator: eviatarbach

Original creation time: 2012-06-13 00:43:14

Assignee: jason, jkantor

`ComplexNumber` does not know how to convert from the Python `complex` type:


```
sage: ComplexNumber(complex('13.8+6.2j'))
TypeError: unable to coerce to a ComplexNumber: <type 'str'>
```



---

Comment by tscrim created at 2013-02-09 20:47:43

Changing keywords from "" to "complex, beginner".


---

Comment by tscrim created at 2013-02-09 20:47:43

Changing status from new to needs_review.


---

Comment by tscrim created at 2013-02-09 20:47:43

Simple fix and easy to review.


---

Comment by nbruin created at 2013-02-09 21:02:34

Don't you want it more along the lines of

```
    if s_imag is None: 
        if isinstance(s_real, complex): 
            s_imag = s_real.imag 
            s_real = s_real.real 
        else:
            s_imag = 0 
```

to avoid accepting malformed input such as

```
ComplexNumber(complex(1,1),1)
```

perhaps?


---

Comment by eviatarbach created at 2013-02-09 21:11:07

Also, a typo; 'fixzed'>'fixed'


---

Comment by tscrim created at 2013-02-09 21:44:16

That is a good idea. Updated (and typo fixzed :P) and now it will also work for `CDF` and `ComplexField` elements as well.


---

Comment by chapoton created at 2013-04-03 20:02:34

It seems to me that you should explain in the doc that a new kind of input is now allowed. So far, the doc says that the only possible input is a pair of numbers.


---

Attachment

I've updated the documentation and added a (quick 'n' dirty) parser for string inputs as well.


---

Comment by eviatarbach created at 2013-04-04 04:19:52

This is really nice, but I think the string parser should be more strict in order to enforce a more consistent syntax. How about just accepting the Python `complex` syntax?


---

Comment by tscrim created at 2013-04-08 13:53:08

Replying to [comment:7 eviatarbach]:
> This is really nice, but I think the string parser should be more strict in order to enforce a more consistent syntax. How about just accepting the Python `complex` syntax?

I disagree since the output from `ComplexNumber(1, 1)` is `1.0... + 1.0...*I`, so we should allow this as valid input to be consistent with python's `complex` function and because we do accept python `complex` strings.


---

Comment by eviatarbach created at 2013-04-08 17:09:10

This makes sense, but `2.0+5.0I` isn't valid syntax in either Python or Sage.


---

Comment by tscrim created at 2013-04-08 17:44:11

True, but it's the "natural" in between since python complex strings are `2 + 2j` and I think a typical user is likely to try `2 + 2i` first. However, if you feel strongly about it, I'll remove it since it is easier to add functionality into sage than to remove it; and I'm 95% certain there's a bug in my current implementation that I have to fix (it should fail on `2 + -2*I`).


---

Comment by nbruin created at 2013-04-08 18:40:21

We already have a clash

```
sage: 2.0j
2.00000000000000*I
sage: implicit_multiplication(True)
sage: 2.0j
NameError: name 'j' is not defined
```

and I'm pretty sure you won't get to predefine `i` and `j`.


---

Comment by vbraun created at 2013-05-11 19:48:43

I'm a bit scared by the included number parser ;-) Can we use a regex? This would also be better at validating input.


---

Comment by nbruin created at 2013-05-11 20:31:30

The ticket states that `ComplexNumber(complex(...))` doesn't work and proceeds by implementing a more elaborate string parser. That's not the most obvious way of soving the ticket:
 - a python `complex` already has a nice `.real()` and `.imag()`, so stuffing them together in a string to just pry them apart is not a smart move. Doing

```
    if isinstance(s_real, complex):
        s_real, s_imag = s_real.real(), s_real.imag()
```

makes much more sense to solve the problem at hand.
 - The fact that `ComplexNumber` would assemble a complex number from numerical input by converting to a string is ludicrous in its own right: If you're handed real and imaginary parts in numerical form, you should NOT be converting to strings as an intermediate. That's just asking for precision loss (and horrible performance).

I realize that we have the documentation:

```
def create_ComplexNumber(s_real, s_imag=None, int pad=0, min_prec=53):
    Return the complex number defined by the strings s_real and
    s_imag as an element of ``ComplexField(prec=n)``,
    where n potentially has slightly more (controlled by pad) bits than
    given by s.
```

According to that documentation, the proposed input is not valid anyway. By changing that you're changing the interface the routine offers. That's fine, but once you start changing it, you should _improve_ it.

Note that `CC(complex("1+2j"))` already works. By the looks of it, `CC.__call__` is already taking a much saner approach. Perhaps `ComplexNumber` should share more with that routine? Or be documented that people should really use `CC(...)`? or perhaps `ComplexNumber` can be deprecated altogether?


---

Comment by tscrim created at 2013-05-11 21:07:11

Replying to [comment:13 nbruin]:
> The ticket states that `ComplexNumber(complex(...))` doesn't work and proceeds by implementing a more elaborate string parser. That's not the most obvious way of soving the ticket:
>  - a python `complex` already has a nice `.real()` and `.imag()`, so stuffing them together in a string to just pry them apart is not a smart move. Doing
> {{{
>     if isinstance(s_real, complex):
>         s_real, s_imag = s_real.real(), s_real.imag()
> }}}
>    makes much more sense to solve the problem at hand.

This is already how I've done it done in the current patch.

>  - The fact that `ComplexNumber` would assemble a complex number from numerical input by converting to a string is ludicrous in its own right: If you're handed real and imaginary parts in numerical form, you should NOT be converting to strings as an intermediate. That's just asking for precision loss (and horrible performance).

That was the original implementation with two reals as input, and I haven't changed that. Nevertheless, I agree that it should be changed (see below).

> 
> I realize that we have the documentation:
> {{{
> def create_ComplexNumber(s_real, s_imag=None, int pad=0, min_prec=53):
>     Return the complex number defined by the strings s_real and
>     s_imag as an element of ``ComplexField(prec=n)``,
>     where n potentially has slightly more (controlled by pad) bits than
>     given by s.
> }}}
>    According to that documentation, the proposed input is not valid anyway. By changing that you're changing the interface the routine offers. That's fine, but once you start changing it, you should _improve_ it.
> 
> Note that `CC(complex("1+2j"))` already works. By the looks of it, `CC.__call__` is already taking a much saner approach. Perhaps `ComplexNumber` should share more with that routine? Or be documented that people should really use `CC(...)`? or perhaps `ComplexNumber` can be deprecated altogether?

How about we check if the input is a (pair of) `str`, and if not, then it just feeds it to `CC` in an appropriate fashion? I don't think we should deprecate it because the naive person IMO would likely look for `ComplexNumber` before `CC`.


Volker, good point. I don't use regex too often so it's never really something I think of. I'll do that on the next patch.


---

Comment by vbraun created at 2013-05-11 21:45:56

`CC._element_constructor_` is probably slow for string input since it evaluates the input. I'm a bit uncomfortable with that security-wise, though there are certainly bigger fish to fry.

I agree that it would be best if `ComplexNumber` would just delegate everything to `CC`. The latter even handles two strings as input. The docstring should reflect that and say that it is preferred to use `CC` / `CDF` directly.


---

Comment by eviatarbach created at 2013-05-11 23:23:52

Hmm. What do you all think of just making `ComplexNumber` an alias for `CC`? In fact, I think this could also be done to `RealNumber` with `RR`.


---

Comment by nbruin created at 2013-05-12 01:09:46

Replying to [comment:15 vbraun]:
> `CC._element_constructor_` is probably slow for string input since it evaluates the input. I'm a bit uncomfortable with that security-wise, though there are certainly bigger fish to fry.

Yes, indeed. That very "eval" instruction is marked with a "TODO", indicating that it could use improvements. I'd say that's the place to a string interpretation routine, rather than in `create_ComplexNumber`. Note, by the way, that most machinery for making complex numbers sits in `sage.rings.complex_number.ComplexNumber.__init__`. It can deal with various inputs, including strings for real and imag, by virtue of just calling `RR(real)` and `RR(imag)` (where `RR` is the underlying real field). Thus, the only thing a "complex number" parser would have to do is locate the likely real and imaginary part in the string and pass them on. This could even be put in this routine itself.

There is one thing that `create_ComplexNumber` does that other routines don't: It takes the string lengths as an indication of the number of bits required in the representation. None of the other routines do that. It also indicates that `create_ComplexNumber` perhaps shouldn't be used for anything more general, or in its other roles, take a hint from its input to choose what precision to use.

I think in general, guessing precision from number of digits written down is rarely going to produce desirable results, so I'd be for providing the user interface with a default precision (complex) field.


---

Comment by kcrisman created at 2013-06-12 19:14:12

Changing status from needs_review to needs_work.


---

Comment by eviatarbach created at 2013-08-19 23:08:08

For reference, Python's built-in function for generating a `complex` from a string is defined at http://hg.python.org/cpython/file/c6880edaf6f3/Objects/complexobject.c as `complex_subtype_from_string`. We should probably try to emulate that for our parser.


---

Comment by jdemeyer created at 2014-10-16 17:38:09

Changing component from numerical to coercion.


---

Comment by jdemeyer created at 2014-10-16 17:44:14

Changing component from coercion to numerical.


---

Comment by jdemeyer created at 2014-10-16 17:44:14

Sorry, I shouldn't have taken over this ticket, it's about something else.


---

Comment by souravsingh created at 2016-11-24 14:45:30

I am interested on working on the issue. How do I start?


---

Comment by zonova created at 2016-11-27 00:23:57

I believe all that is needed is changing the [ComplexNumber](ComplexNumber) function and the RealNumber function to point to CC and RR instead.


---

Comment by epilys created at 2017-03-15 18:07:02

I modified `create_ComplexNumber` to allow the input as stated in the ticket description as a temporary fix. How should [ComplexNumber](ComplexNumber) and RealNumber point to CC and RR? Just make them aliases or eg call CC with the same input inside `create_ComplexNumber`?  
----
New commits:


---

Comment by epilys created at 2017-03-15 18:07:52

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-03-21 09:37:00

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-03-21 09:37:00

Replying to [comment:30 epilys]:
> I modified `create_ComplexNumber` to allow the input as stated in the ticket description as a temporary fix.

But why? I don't think there is much reason to allow `RealNumber()` and `ComplexNumber`, that's why I think they should be deprecated instead.


---

Comment by zonova created at 2017-03-21 14:40:37

Replying to [comment:30 epilys]:
> I modified `create_ComplexNumber` to allow the input as stated in the ticket description as a temporary fix. How should [ComplexNumber](ComplexNumber) and RealNumber point to CC and RR? Just make them aliases or eg call CC with the same input inside `create_ComplexNumber`?  
> ----
> New commits:
> ||[c1995f1](https://git.sagemath.org/sage.git/commit?id=c1995f12a8529bdb5c5ff25288b481caf01a40c9)||`Allow type complex input in ComplexNumber()`||


Yes, I was suggesting that [ComplexNumber](ComplexNumber) and RealNumber be aliases for CC and RR. Unless I am missing some functionality that these are supposed to provide that CC and RR don't. I think that, for a lot of students, they would easily recognize the command [ComplexNumber](ComplexNumber), but might not recognize the command CC, so I think it is useful as an alias.


---

Comment by jdemeyer created at 2017-03-21 15:44:49

Replying to [comment:33 zonova]:
> I think that, for a lot of students, they would easily recognize the command [ComplexNumber](ComplexNumber)

Why _should_ they recognize the command `ComplexNumber`? Most likely they will type something like `1.2 + 3.4 * I` and that works fine.


---

Comment by vdelecroix created at 2018-01-17 17:12:19

Replying to [comment:34 jdemeyer]:
> Replying to [comment:33 zonova]:
> > I think that, for a lot of students, they would easily recognize the command [ComplexNumber](ComplexNumber)
> 
> Why _should_ they recognize the command `ComplexNumber`? Most likely they will type something like `1.2 + 3.4 * I` and that works fine.

That does not

```
sage: parent(1.2 + 3.4 * I)
Symbolic Ring
```



---

Comment by vdelecroix created at 2018-01-17 17:16:10

I think that the simplest would just be to remove `RealNumber` and `ComplexNumber` from the global namespace (ie deprecate them). These functions are intended to parse a very special kind of strings in a very particular way. This can be achieved by other means in the console like `RR(my_string)`/`CC(my_string)` as was suggested.


---

Comment by vdelecroix created at 2018-01-17 17:19:39

Changing keywords from "complex, beginner" to "".


---

Comment by vdelecroix created at 2018-01-17 17:23:25

If we decide to keep `RealNumber`/`ComplexNumber` in the global namespace, I think that what they should be would better be left to #24456 and #24457. This is one more reason to make this ticket used only for deprecation.


---

Comment by vdelecroix created at 2018-01-25 15:57:26

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2018-01-25 15:57:26

New commits:


---

Comment by vdelecroix created at 2018-01-25 15:59:10

Mostly setting to needs review in order to let patchbots test it!


---

Comment by jdemeyer created at 2018-01-25 16:07:06

I don't like the verbosity of `sage.rings.real_mpfr.create_RealNumber`. I would suggest still keeping it in the global namespace but under a (short) private name like `_Real`.


---

Comment by vdelecroix created at 2018-01-25 16:09:08

Replying to [comment:41 jdemeyer]:
> I don't like the verbosity of `sage.rings.real_mpfr.create_RealNumber`. I would suggest still keeping it in the global namespace but under a (short) private name like `_Real`.

Fine for me.


---

Comment by vdelecroix created at 2018-01-25 16:13:18

Replying to [comment:42 vdelecroix]:
> Replying to [comment:41 jdemeyer]:
> > I don't like the verbosity of `sage.rings.real_mpfr.create_RealNumber`. I would suggest still keeping it in the global namespace but under a (short) private name like `_Real`.
> 
> Fine for me.

Though a problem is that names starting with underscore in `all.py` files are not imported.


---

Comment by git created at 2018-01-25 18:12:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-25 21:14:21

Replying to [comment:43 vdelecroix]:
> Though a problem is that names starting with underscore in `all.py` files are not imported.

Not a big problem, just import `_Real` and `_Complex` explicitly.


---

Comment by vdelecroix created at 2018-01-25 21:15:30

Replying to [comment:45 jdemeyer]:
> Replying to [comment:43 vdelecroix]:
> > Though a problem is that names starting with underscore in `all.py` files are not imported.
> 
> Not a big problem, just import `_Real` and `_Complex` explicitly.

From where? This is about the preparser...


---

Comment by jdemeyer created at 2018-01-25 21:48:02

Replying to [comment:46 vdelecroix]:
> From where?

Put this in `sage.all`:

```
from sage.rings.real_mpfr import create_RealNumber as _Real
```



---

Comment by vdelecroix created at 2018-01-25 21:51:20

Replying to [comment:47 jdemeyer]:
> Replying to [comment:46 vdelecroix]:
> > From where?
> 
> Put this in `sage.all`:
> {{{
> from sage.rings.real_mpfr import create_RealNumber as _Real
> }}}

Does not work. Names starting with an underscore are ignored by the `import *` syntax.


---

Comment by vdelecroix created at 2018-01-25 23:26:18

Replying to [comment:48 vdelecroix]:
> Replying to [comment:47 jdemeyer]:
> > Replying to [comment:46 vdelecroix]:
> > > From where?
> > 
> > Put this in `sage.all`:
> > {{{
> > from sage.rings.real_mpfr import create_RealNumber as _Real
> > }}}
> 
> Does not work. Names starting with an underscore are ignored by the `import *` syntax.

This would be a (not very elegant) solution

```diff
diff --git a/src/sage/repl/ipython_extension.py b/src/sage/repl/ipython_extension.py
index 90a8049d72..22110fe5ac 100644
--- a/src/sage/repl/ipython_extension.py
+++ b/src/sage/repl/ipython_extension.py
`@``@` -476,8 +476,12 `@``@` class SageCustomizations(object):
         Set up Sage command-line environment
         """
         # import outside of cell so we don't get a traceback
-        from sage.repl.user_globals import initialize_globals
+        from sage.repl.user_globals import initialize_globals, set_global
+        from sage.rings.real_mpfr import create_RealNumber
+        from sage.rings.complex_number import create_ComplexNumber
         initialize_globals(self.all_globals(), self.shell.user_ns)
+        set_global('_Real', create_RealNumber)
+        set_global('_Complex', create_ComplexNumber)
         self.run_init()
```



---

Comment by chapoton created at 2018-02-09 15:40:01

does not apply


---

Comment by chapoton created at 2018-02-09 15:40:01

Changing status from needs_review to needs_work.
