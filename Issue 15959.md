# Issue 15959: dedent pasted sage prompts

Issue created by migration from https://trac.sagemath.org/ticket/16196

Original creator: vbraun

Original creation time: 2014-04-21 12:32:52

CC:  ohanar

Sage prompts with leading whitespace are not removed correctly:

```
sage:    1+1     # works
2
sage: sage: 1+1     # works
2
sage:    sage: 1+1     # indent + prompt = fail
  File "<ipython-input-34-360e106e9b2f>", line 1
    sage: Integer(1)+Integer(1)     # indent + prompt = fail
        ^
SyntaxError: invalid syntax
}}}o
Possibly due to #16050


---

Comment by ohanar created at 2014-04-21 18:36:03

It looks like the change from #16154 broke this (ipython's leading indent stripper is now being run after our prompt stripper). I can look into this sometime later this week.


---

Comment by ohanar created at 2014-04-24 22:28:18

Changing status from new to needs_review.


---

Comment by ohanar created at 2014-04-24 22:28:18

This should work for now, although I looked a bit into the upstream code, and that should probably be changed to be more configurable (since after all the prompt is configurable).
----
New commits:


---

Comment by jhpalmieri created at 2014-04-24 22:46:36

Oh, sorry, I didn't see this ticket and introduced #16232 which strips leading whitespace. Do we close that one as a duplicate? (Meanwhile, it has a positive review, by the way.)

- Why only strip one prompt? I see the explanation that we are trying to match IPython's behavior, but do we need to preserve backward-compatibility?

- What is the point of the change to `src/sage/repl/ipython_extension.py`? Just changing the regular expression (as at #16232) seems to solve the problem.


---

Comment by ohanar created at 2014-04-24 22:59:57

Replying to [comment:5 jhpalmieri]:
> Oh, sorry, I didn't see this ticket and introduced #16232 which strips leading whitespace. Do we close that one as a duplicate? (Meanwhile, it has a positive review, by the way.)
> 
> - Why only strip one prompt? I see the explanation that we are trying to match IPython's behavior, but do we need to preserve backward-compatibility?

Is there sage code that is being written with sage (duplicate) prompts? Really duplicate prompts should only come about by copying something into a terminal session, and then copying that pasted content again -- this seems like a complete edge case that wouldn't (and certainly shouldn't) show up in some code that is meant to be used for a long period of time.

> 
> - What is the point of the change to `src/sage/repl/ipython_extension.py`? Just changing the regular expression (as at #16232) seems to solve the problem.

IPython already has a dedenter, and it is smart (it strips an equal amount from each line), so all we need to do is strip our prompts after ipython dedents, and for the moment, that means insert after position 0 (and before position 1, so as to not re-break #16154).


---

Comment by ohanar created at 2014-04-24 23:03:24

Like I mentioned, this should just be configurable with IPython itself -- we shouldn't have to be pulling this internal `_strip_prompts` function in the first place. I'll make a patch if I ever find the time to fix this upstream, but I'm much to busy at the moment.


---

Comment by jhpalmieri created at 2014-04-30 22:52:01

Rebased (w.r.t. #16232).


---

Comment by jhpalmieri created at 2014-04-30 22:52:01

Changing status from needs_review to positive_review.


---

Comment by git created at 2014-04-30 22:53:43

Changing status from positive_review to needs_review.


---

Comment by git created at 2014-04-30 22:53:43

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by jhpalmieri created at 2014-04-30 22:54:34

Changing status from needs_review to positive_review.


---

Comment by leif created at 2014-04-30 23:14:39

Ah, ok... :-)


---

Comment by vbraun created at 2014-05-04 13:56:38

Resolution: fixed
