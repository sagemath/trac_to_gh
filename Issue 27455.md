# Issue 27455: py3: fix src/sage/misc/nested_class.pyx

archive/issues_027455.json:
```json
{
    "body": "CC:  @embray @jdemeyer @kiwifb\n\ntraceback:\n\n```\nsage -t --long src/sage/misc/nested_class.pyx\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 39, in sage.misc.nested_class\nFailed example:\n    A1.A2.A3\nExpected:\n    <class sage.misc.nested_class.A3 at ...>\nGot:\n    <class 'sage.misc.nested_class.A1.A2.A3'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 42, in sage.misc.nested_class\nFailed example:\n    nested_pickle(A1)\nExpected:\n    <class sage.misc.nested_class.A1 at ...>\nGot:\n    <class 'sage.misc.nested_class.A1'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 45, in sage.misc.nested_class\nFailed example:\n    A1.A2\nExpected:\n    <class sage.misc.nested_class.A1.A2 at ...>\nGot:\n    <class 'sage.misc.nested_class.A1.A2'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 48, in sage.misc.nested_class\nFailed example:\n    A1.A2.A3\nExpected:\n    <class sage.misc.nested_class.A1.A2.A3 at ...>\nGot:\n    <class 'sage.misc.nested_class.A1.A2.A3'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 131, in sage.misc.nested_class.modify_for_nested_pickle\nFailed example:\n    getattr(module, 'A.B', 'Not found')\nExpected:\n    <class '__main__.X.A.B'>\nGot:\n    <class '__main__.A.B'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 133, in sage.misc.nested_class.modify_for_nested_pickle\nFailed example:\n    getattr(module, 'X.A.B', 'Not found')\nExpected:\n    <class '__main__.X.A.B'>\nGot:\n    <class '__main__.A.B'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 219, in sage.misc.nested_class.nested_pickle\nFailed example:\n    getattr(module, 'A.B', 'Not found')\nExpected:\n    <class __main__.A.B at ...>\nGot:\n    <class '__main__.A.B'>\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 259, in sage.misc.nested_class.NestedClassMetaclass\nFailed example:\n    A3.B.__name__\nExpected:\n    'A3.B'\nGot:\n    'B'\n**********************************************************************\nFile \"src/sage/misc/nested_class.pyx\", line 261, in sage.misc.nested_class.NestedClassMetaclass\nFailed example:\n    getattr(sys.modules['__main__'], 'A3.B', 'Not found')\nExpected:\n    <class '__main__.A3.B'>\nGot:\n    'Not found'\n**********************************************************************\n4 items had failures:\n   4 of  14 in sage.misc.nested_class\n   2 of   6 in sage.misc.nested_class.NestedClassMetaclass\n   2 of  23 in sage.misc.nested_class.modify_for_nested_pickle\n   1 of   9 in sage.misc.nested_class.nested_pickle\n    [68 tests, 9 failures, 1.77 s]\n\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/27692\n\n",
    "created_at": "2019-04-17T16:30:07Z",
    "labels": [
        "python3",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "py3: fix src/sage/misc/nested_class.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27455",
    "user": "@fchapoton"
}
```
CC:  @embray @jdemeyer @kiwifb

traceback:

```
sage -t --long src/sage/misc/nested_class.pyx
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 39, in sage.misc.nested_class
Failed example:
    A1.A2.A3
Expected:
    <class sage.misc.nested_class.A3 at ...>
Got:
    <class 'sage.misc.nested_class.A1.A2.A3'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 42, in sage.misc.nested_class
Failed example:
    nested_pickle(A1)
Expected:
    <class sage.misc.nested_class.A1 at ...>
Got:
    <class 'sage.misc.nested_class.A1'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 45, in sage.misc.nested_class
Failed example:
    A1.A2
Expected:
    <class sage.misc.nested_class.A1.A2 at ...>
Got:
    <class 'sage.misc.nested_class.A1.A2'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 48, in sage.misc.nested_class
Failed example:
    A1.A2.A3
Expected:
    <class sage.misc.nested_class.A1.A2.A3 at ...>
Got:
    <class 'sage.misc.nested_class.A1.A2.A3'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 131, in sage.misc.nested_class.modify_for_nested_pickle
Failed example:
    getattr(module, 'A.B', 'Not found')
Expected:
    <class '__main__.X.A.B'>
Got:
    <class '__main__.A.B'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 133, in sage.misc.nested_class.modify_for_nested_pickle
Failed example:
    getattr(module, 'X.A.B', 'Not found')
Expected:
    <class '__main__.X.A.B'>
Got:
    <class '__main__.A.B'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 219, in sage.misc.nested_class.nested_pickle
Failed example:
    getattr(module, 'A.B', 'Not found')
Expected:
    <class __main__.A.B at ...>
Got:
    <class '__main__.A.B'>
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 259, in sage.misc.nested_class.NestedClassMetaclass
Failed example:
    A3.B.__name__
Expected:
    'A3.B'
Got:
    'B'
**********************************************************************
File "src/sage/misc/nested_class.pyx", line 261, in sage.misc.nested_class.NestedClassMetaclass
Failed example:
    getattr(sys.modules['__main__'], 'A3.B', 'Not found')
Expected:
    <class '__main__.A3.B'>
Got:
    'Not found'
**********************************************************************
4 items had failures:
   4 of  14 in sage.misc.nested_class
   2 of   6 in sage.misc.nested_class.NestedClassMetaclass
   2 of  23 in sage.misc.nested_class.modify_for_nested_pickle
   1 of   9 in sage.misc.nested_class.nested_pickle
    [68 tests, 9 failures, 1.77 s]

```


Issue created by migration from https://trac.sagemath.org/ticket/27692





---

archive/issue_comments_387064.json:
```json
{
    "body": "To get the same repr for a class (without \"at ...\") in both Py2 and Py3, it may be as simple as defining the classes with `class A(object):`. It looks like the difference in printing is between old-style and new-style classes, and python3 has only new style classes. So, including the `(object)` brings the example in Py2 closer to what it does in Py3.\n\nThe problem with \"name\" might need more work.",
    "created_at": "2019-04-17T19:09:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387064",
    "user": "@nbruin"
}
```

To get the same repr for a class (without "at ...") in both Py2 and Py3, it may be as simple as defining the classes with `class A(object):`. It looks like the difference in printing is between old-style and new-style classes, and python3 has only new style classes. So, including the `(object)` brings the example in Py2 closer to what it does in Py3.

The problem with "name" might need more work.



---

archive/issue_comments_387065.json:
```json
{
    "body": "At some point I definitely fixed or changed something related to this but I'm wracking my brain to remember where.",
    "created_at": "2019-04-19T17:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387065",
    "user": "@embray"
}
```

At some point I definitely fixed or changed something related to this but I'm wracking my brain to remember where.



---

archive/issue_comments_387066.json:
```json
{
    "body": "IIRC one of the main issues here is that I (?) fixed pickling of nested classes such that `NestedClassMetaclass` is all but unnecessary.  But I might have dreamed it; it's all a bit foggy.",
    "created_at": "2019-04-19T17:19:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387066",
    "user": "@embray"
}
```

IIRC one of the main issues here is that I (?) fixed pickling of nested classes such that `NestedClassMetaclass` is all but unnecessary.  But I might have dreamed it; it's all a bit foggy.



---

archive/issue_comments_387067.json:
```json
{
    "body": "Here it is--it turns out that the issue this is trying to work around just isn't relevant on Python 3, so it makes `NestedClassMetaclass` a no-op to be removed whenever we drop Python 2 support.\n\n\n```diff\ndiff --git a/src/sage/misc/nested_class.pyx b/src/sage/misc/nested_class.pyx\nindex 3cd3dfc..cf9c352 100644\n--- a/src/sage/misc/nested_class.pyx\n+++ b/src/sage/misc/nested_class.pyx\n@@ -36,23 +36,27 @@ EXAMPLES::\n\n     sage: A1.A2.A3.__name__\n     'A3'\n-    sage: A1.A2.A3\n+    sage: A1.A2.A3  # py2\n     <class sage.misc.nested_class.A3 at ...>\n\n-    sage: nested_pickle(A1)\n+    sage: nested_pickle(A1)  # py2\n     <class sage.misc.nested_class.A1 at ...>\n\n-    sage: A1.A2\n+    sage: A1.A2  # py2\n     <class sage.misc.nested_class.A1.A2 at ...>\n+    sage: A1.A2  # py3 - note: here we have he desired name for free\n+    <class 'sage.misc.nested_class.A1.A2'>\n\n-    sage: A1.A2.A3\n+    sage: A1.A2.A3  # py2\n     <class sage.misc.nested_class.A1.A2.A3 at ...>\n-    sage: A1.A2.A3.__name__\n+    sage: A1.A2.A3  # py3\n+    <class 'sage.misc.nested_class.A1.A2.A3'>\n+    sage: A1.A2.A3.__name__  # py2\n     'A1.A2.A3'\n\n-    sage: sage.misc.nested_class.__dict__['A1.A2'] is A1.A2\n+    sage: sage.misc.nested_class.__dict__['A1.A2'] is A1.A2  # py2\n     True\n-    sage: sage.misc.nested_class.__dict__['A1.A2.A3'] is A1.A2.A3\n+    sage: sage.misc.nested_class.__dict__['A1.A2.A3'] is A1.A2.A3  # py2\n     True\n\n All of this is not perfect. In the following scenario::\n@@ -85,6 +89,8 @@ cpdef modify_for_nested_pickle(cls, str name_prefix, module, first_run=True):\n     giving them a mangled name and putting the mangled name in the\n     module namespace.\n\n+    On Python 3 this is a no-op and does not perform any mangling.\n+\n     INPUT:\n\n     - ``cls`` - The class to modify.\n@@ -111,26 +117,26 @@ cpdef modify_for_nested_pickle(cls, str name_prefix, module, first_run=True):\n         sage: getattr(module, 'A.B', 'Not found')\n         'Not found'\n         sage: modify_for_nested_pickle(A, 'A', sys.modules['__main__'])\n-        sage: A.B.__name__\n+        sage: A.B.__name__  # py2\n         'A.B'\n-        sage: getattr(module, 'A.B', 'Not found')\n+        sage: getattr(module, 'A.B', 'Not found')  # py2\n         <class '__main__.A.B'>\n\n     Here we demonstrate the effect of the ``first_run`` argument::\n\n         sage: modify_for_nested_pickle(A, 'X', sys.modules['__main__'])\n-        sage: A.B.__name__ # nothing changed\n+        sage: A.B.__name__ # py2: nothing changed\n         'A.B'\n         sage: modify_for_nested_pickle(A, 'X', sys.modules['__main__'], first_run=False)\n-        sage: A.B.__name__\n+        sage: A.B.__name__  # py2\n         'X.A.B'\n\n     Note that the class is now found in the module under both its old and\n     its new name::\n\n-        sage: getattr(module, 'A.B', 'Not found')\n+        sage: getattr(module, 'A.B', 'Not found')  # py2\n         <class '__main__.X.A.B'>\n-        sage: getattr(module, 'X.A.B', 'Not found')\n+        sage: getattr(module, 'X.A.B', 'Not found')  # py2\n         <class '__main__.X.A.B'>\n\n\n@@ -151,17 +157,20 @@ cpdef modify_for_nested_pickle(cls, str name_prefix, module, first_run=True):\n\n     Before :trac:`9107`, the name of ``A1.B1.C1`` would have been wrong::\n\n-        sage: A1.B1.C1.__name__\n+        sage: A1.B1.C1.__name__  # py2\n         'A1.B1.C1'\n-        sage: A1.B2.C2.__name__\n+        sage: A1.B2.C2.__name__  # py2\n         'A1.B2.C2'\n         sage: A_module = sys.modules[A1.__module__]\n-        sage: getattr(A_module, 'A1.B1.C1', 'Not found').__name__\n+        sage: getattr(A_module, 'A1.B1.C1', 'Not found').__name__  # py2\n         'A1.B1.C1'\n-        sage: getattr(A_module, 'A1.B2.C2', 'Not found').__name__\n+        sage: getattr(A_module, 'A1.B2.C2', 'Not found').__name__  # py2\n         'A1.B2.C2'\n\n     \"\"\"\n+    IF PY_MAJOR_VERSION >= 3:\n+        return\n+\n     cdef str name, dotted_name\n     cdef str mod_name = module.__name__\n     cdef str cls_name = cls.__name__+'.'\n@@ -214,9 +223,9 @@ def nested_pickle(cls):\n     then the name of class ``\"B\"`` will be modified to ``\"A.B\"``, and the ``\"A.B\"``\n     attribute of the module will be set to class ``\"B\"``::\n\n-        sage: A.B.__name__\n+        sage: A.B.__name__  # py2\n         'A.B'\n-        sage: getattr(module, 'A.B', 'Not found')\n+        sage: getattr(module, 'A.B', 'Not found')  # py2\n         <class __main__.A.B at ...>\n\n     In Python 2.6, decorators work with classes; then ``@nested_pickle``\n@@ -245,6 +254,9 @@ cdef class NestedClassMetaclass(type):\n     r\"\"\"\n     A metaclass for nested pickling.\n\n+    On Python 3 this is just a direct wrapper around the base `type` and does\n+    not do anything.\n+\n     Check that one can use a metaclass to ensure nested_pickle\n     is called on any derived subclass::\n\n@@ -256,11 +268,12 @@ cdef class NestedClassMetaclass(type):\n         ....:     class B(object):\n         ....:         pass\n         ...\n-        sage: A3.B.__name__\n+        sage: A3.B.__name__  # py2\n         'A3.B'\n-        sage: getattr(sys.modules['__main__'], 'A3.B', 'Not found')\n+        sage: getattr(sys.modules['__main__'], 'A3.B', 'Not found')  # py2\n         <class '__main__.A3.B'>\n     \"\"\"\n+\n     def __init__(self, *args):\n         r\"\"\"\n         This invokes the nested_pickle on construction.\n@@ -273,7 +286,7 @@ cdef class NestedClassMetaclass(type):\n         ...\n         sage: A.B\n         <class '__main__.A.B'>\n-        sage: getattr(sys.modules['__main__'], 'A.B', 'Not found')\n+        sage: getattr(sys.modules['__main__'], 'A.B', 'Not found')  # py2\n         <class '__main__.A.B'>\n         \"\"\"\n         modify_for_nested_pickle(self, self.__name__, sys_modules[self.__module__])\n@@ -306,9 +319,9 @@ class MainClass(object, metaclass=NestedClassMetaclass):\n                 sage: from sage.misc.nested_class import *\n                 sage: loads(dumps(MainClass.NestedClass.NestedSubClass()))\n                 <sage.misc.nested_class.MainClass.NestedClass.NestedSubClass object at 0x...>\n-                sage: getattr(sage.misc.nested_class, 'MainClass.NestedClass.NestedSubClass')\n+                sage: getattr(sage.misc.nested_class, 'MainClass.NestedClass.NestedSubClass')  # py2\n                 <class 'sage.misc.nested_class.MainClass.NestedClass.NestedSubClass'>\n-                sage: MainClass.NestedClass.NestedSubClass.__name__\n+                sage: MainClass.NestedClass.NestedSubClass.__name__  # py2\n                 'MainClass.NestedClass.NestedSubClass'\n             \"\"\"\n             def dummy(self, x, *args, r=(1,2,3.4), **kwds):\n@@ -321,7 +334,7 @@ class MainClass(object, metaclass=NestedClassMetaclass):\n                     sage: from sage.misc.nested_class import MainClass\n                     sage: print(MainClass.NestedClass.NestedSubClass.dummy.__doc__)\n                     NestedSubClass.dummy(self, x, *args, r=(1, 2, 3.4), **kwds)\n-                    File: sage/misc/nested_class.pyx (starting at line 314)\n+                    File: sage/misc/nested_class.pyx (starting at line 327)\n                     <BLANKLINE>\n                                     A dummy method to demonstrate the embedding of\n                                     method signature for nested classes.\n```\n",
    "created_at": "2019-04-19T17:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387067",
    "user": "@embray"
}
```

Here it is--it turns out that the issue this is trying to work around just isn't relevant on Python 3, so it makes `NestedClassMetaclass` a no-op to be removed whenever we drop Python 2 support.


```diff
diff --git a/src/sage/misc/nested_class.pyx b/src/sage/misc/nested_class.pyx
index 3cd3dfc..cf9c352 100644
--- a/src/sage/misc/nested_class.pyx
+++ b/src/sage/misc/nested_class.pyx
@@ -36,23 +36,27 @@ EXAMPLES::

     sage: A1.A2.A3.__name__
     'A3'
-    sage: A1.A2.A3
+    sage: A1.A2.A3  # py2
     <class sage.misc.nested_class.A3 at ...>

-    sage: nested_pickle(A1)
+    sage: nested_pickle(A1)  # py2
     <class sage.misc.nested_class.A1 at ...>

-    sage: A1.A2
+    sage: A1.A2  # py2
     <class sage.misc.nested_class.A1.A2 at ...>
+    sage: A1.A2  # py3 - note: here we have he desired name for free
+    <class 'sage.misc.nested_class.A1.A2'>

-    sage: A1.A2.A3
+    sage: A1.A2.A3  # py2
     <class sage.misc.nested_class.A1.A2.A3 at ...>
-    sage: A1.A2.A3.__name__
+    sage: A1.A2.A3  # py3
+    <class 'sage.misc.nested_class.A1.A2.A3'>
+    sage: A1.A2.A3.__name__  # py2
     'A1.A2.A3'

-    sage: sage.misc.nested_class.__dict__['A1.A2'] is A1.A2
+    sage: sage.misc.nested_class.__dict__['A1.A2'] is A1.A2  # py2
     True
-    sage: sage.misc.nested_class.__dict__['A1.A2.A3'] is A1.A2.A3
+    sage: sage.misc.nested_class.__dict__['A1.A2.A3'] is A1.A2.A3  # py2
     True

 All of this is not perfect. In the following scenario::
@@ -85,6 +89,8 @@ cpdef modify_for_nested_pickle(cls, str name_prefix, module, first_run=True):
     giving them a mangled name and putting the mangled name in the
     module namespace.

+    On Python 3 this is a no-op and does not perform any mangling.
+
     INPUT:

     - ``cls`` - The class to modify.
@@ -111,26 +117,26 @@ cpdef modify_for_nested_pickle(cls, str name_prefix, module, first_run=True):
         sage: getattr(module, 'A.B', 'Not found')
         'Not found'
         sage: modify_for_nested_pickle(A, 'A', sys.modules['__main__'])
-        sage: A.B.__name__
+        sage: A.B.__name__  # py2
         'A.B'
-        sage: getattr(module, 'A.B', 'Not found')
+        sage: getattr(module, 'A.B', 'Not found')  # py2
         <class '__main__.A.B'>

     Here we demonstrate the effect of the ``first_run`` argument::

         sage: modify_for_nested_pickle(A, 'X', sys.modules['__main__'])
-        sage: A.B.__name__ # nothing changed
+        sage: A.B.__name__ # py2: nothing changed
         'A.B'
         sage: modify_for_nested_pickle(A, 'X', sys.modules['__main__'], first_run=False)
-        sage: A.B.__name__
+        sage: A.B.__name__  # py2
         'X.A.B'

     Note that the class is now found in the module under both its old and
     its new name::

-        sage: getattr(module, 'A.B', 'Not found')
+        sage: getattr(module, 'A.B', 'Not found')  # py2
         <class '__main__.X.A.B'>
-        sage: getattr(module, 'X.A.B', 'Not found')
+        sage: getattr(module, 'X.A.B', 'Not found')  # py2
         <class '__main__.X.A.B'>


@@ -151,17 +157,20 @@ cpdef modify_for_nested_pickle(cls, str name_prefix, module, first_run=True):

     Before :trac:`9107`, the name of ``A1.B1.C1`` would have been wrong::

-        sage: A1.B1.C1.__name__
+        sage: A1.B1.C1.__name__  # py2
         'A1.B1.C1'
-        sage: A1.B2.C2.__name__
+        sage: A1.B2.C2.__name__  # py2
         'A1.B2.C2'
         sage: A_module = sys.modules[A1.__module__]
-        sage: getattr(A_module, 'A1.B1.C1', 'Not found').__name__
+        sage: getattr(A_module, 'A1.B1.C1', 'Not found').__name__  # py2
         'A1.B1.C1'
-        sage: getattr(A_module, 'A1.B2.C2', 'Not found').__name__
+        sage: getattr(A_module, 'A1.B2.C2', 'Not found').__name__  # py2
         'A1.B2.C2'

     """
+    IF PY_MAJOR_VERSION >= 3:
+        return
+
     cdef str name, dotted_name
     cdef str mod_name = module.__name__
     cdef str cls_name = cls.__name__+'.'
@@ -214,9 +223,9 @@ def nested_pickle(cls):
     then the name of class ``"B"`` will be modified to ``"A.B"``, and the ``"A.B"``
     attribute of the module will be set to class ``"B"``::

-        sage: A.B.__name__
+        sage: A.B.__name__  # py2
         'A.B'
-        sage: getattr(module, 'A.B', 'Not found')
+        sage: getattr(module, 'A.B', 'Not found')  # py2
         <class __main__.A.B at ...>

     In Python 2.6, decorators work with classes; then ``@nested_pickle``
@@ -245,6 +254,9 @@ cdef class NestedClassMetaclass(type):
     r"""
     A metaclass for nested pickling.

+    On Python 3 this is just a direct wrapper around the base `type` and does
+    not do anything.
+
     Check that one can use a metaclass to ensure nested_pickle
     is called on any derived subclass::

@@ -256,11 +268,12 @@ cdef class NestedClassMetaclass(type):
         ....:     class B(object):
         ....:         pass
         ...
-        sage: A3.B.__name__
+        sage: A3.B.__name__  # py2
         'A3.B'
-        sage: getattr(sys.modules['__main__'], 'A3.B', 'Not found')
+        sage: getattr(sys.modules['__main__'], 'A3.B', 'Not found')  # py2
         <class '__main__.A3.B'>
     """
+
     def __init__(self, *args):
         r"""
         This invokes the nested_pickle on construction.
@@ -273,7 +286,7 @@ cdef class NestedClassMetaclass(type):
         ...
         sage: A.B
         <class '__main__.A.B'>
-        sage: getattr(sys.modules['__main__'], 'A.B', 'Not found')
+        sage: getattr(sys.modules['__main__'], 'A.B', 'Not found')  # py2
         <class '__main__.A.B'>
         """
         modify_for_nested_pickle(self, self.__name__, sys_modules[self.__module__])
@@ -306,9 +319,9 @@ class MainClass(object, metaclass=NestedClassMetaclass):
                 sage: from sage.misc.nested_class import *
                 sage: loads(dumps(MainClass.NestedClass.NestedSubClass()))
                 <sage.misc.nested_class.MainClass.NestedClass.NestedSubClass object at 0x...>
-                sage: getattr(sage.misc.nested_class, 'MainClass.NestedClass.NestedSubClass')
+                sage: getattr(sage.misc.nested_class, 'MainClass.NestedClass.NestedSubClass')  # py2
                 <class 'sage.misc.nested_class.MainClass.NestedClass.NestedSubClass'>
-                sage: MainClass.NestedClass.NestedSubClass.__name__
+                sage: MainClass.NestedClass.NestedSubClass.__name__  # py2
                 'MainClass.NestedClass.NestedSubClass'
             """
             def dummy(self, x, *args, r=(1,2,3.4), **kwds):
@@ -321,7 +334,7 @@ class MainClass(object, metaclass=NestedClassMetaclass):
                     sage: from sage.misc.nested_class import MainClass
                     sage: print(MainClass.NestedClass.NestedSubClass.dummy.__doc__)
                     NestedSubClass.dummy(self, x, *args, r=(1, 2, 3.4), **kwds)
-                    File: sage/misc/nested_class.pyx (starting at line 314)
+                    File: sage/misc/nested_class.pyx (starting at line 327)
                     <BLANKLINE>
                                     A dummy method to demonstrate the embedding of
                                     method signature for nested classes.
```




---

archive/issue_comments_387068.json:
```json
{
    "body": "And most of the tests are skipped on Python 3 as they are not relevant.",
    "created_at": "2019-04-19T17:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387068",
    "user": "@embray"
}
```

And most of the tests are skipped on Python 3 as they are not relevant.



---

archive/issue_comments_387069.json:
```json
{
    "body": "branch please",
    "created_at": "2019-04-24T06:02:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387069",
    "user": "@fchapoton"
}
```

branch please



---

archive/issue_comments_387070.json:
```json
{
    "body": "Here you go.  With this, all the tests for `src/sage/misc/nested_class.pyx` pass on Python 3 (though many of them are simply skipped as inapplicable).\n\nThere might be some other minor failures related to this in miscellaneous modules, but I am not sure.  Everything in python3-known-passing.txt still passes.\n----\nNew commits:",
    "created_at": "2019-04-24T13:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387070",
    "user": "@embray"
}
```

Here you go.  With this, all the tests for `src/sage/misc/nested_class.pyx` pass on Python 3 (though many of them are simply skipped as inapplicable).

There might be some other minor failures related to this in miscellaneous modules, but I am not sure.  Everything in python3-known-passing.txt still passes.
----
New commits:



---

archive/issue_comments_387071.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-04-24T13:19:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387071",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_387072.json:
```json
{
    "body": "one failing doctest in src/sage/misc/sageinspect.py, see patchbot",
    "created_at": "2019-04-24T17:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387072",
    "user": "@fchapoton"
}
```

one failing doctest in src/sage/misc/sageinspect.py, see patchbot



---

archive/issue_comments_387073.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-04-24T17:06:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387073",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_387074.json:
```json
{
    "body": "I fixed the doctest\n----\nNew commits:",
    "created_at": "2019-04-25T11:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387074",
    "user": "@fchapoton"
}
```

I fixed the doctest
----
New commits:



---

archive/issue_comments_387075.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-04-25T11:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387075",
    "user": "@fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_387076.json:
```json
{
    "body": "Right...there's always one of those...",
    "created_at": "2019-04-25T12:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387076",
    "user": "@embray"
}
```

Right...there's always one of those...



---

archive/issue_comments_387077.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-25T12:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387077",
    "user": "@embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_387078.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-04-25T12:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387078",
    "user": "@embray"
}
```

New commits:



---

archive/issue_comments_387079.json:
```json
{
    "body": "ok, great. Thx",
    "created_at": "2019-04-25T14:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387079",
    "user": "@fchapoton"
}
```

ok, great. Thx



---

archive/issue_comments_387080.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-29T12:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387080",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_387081.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2019-05-02T13:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387081",
    "user": "@vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_387082.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2019-05-02T13:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387082",
    "user": "@vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_387083.json:
```json
{
    "body": "This ticket breaks docbuild on python3 (only); I don't know why but it does. Error is:\n\n```\n$ make doc-clean && make -j40 && make doc-html\n[...]\n[dochtml] Error building the documentation.\n[dochtml] multiprocessing.pool.RemoteTraceback: \n[dochtml] \"\"\"\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py\", line 121, in worker\n[dochtml]     result = (True, func(*args, **kwds))\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py\", line 44, in mapstar\n[dochtml]     return list(map(*args))\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 79, in build_ref_doc\n[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 761, in _wrapper\n[dochtml]     getattr(DocBuilder, build_type)(self, *args, **kwds)\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py\", line 133, in f\n[dochtml]     runsphinx()\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 314, in runsphinx\n[dochtml]     sys.stderr.raise_errors()\n[dochtml]   File \"/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py\", line 249, in raise_errors\n[dochtml]     raise OSError(self._error)\n[dochtml] OSError: /var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/combinat/ncsf_qsym/qsym.py:docstring of sage.combinat.ncsf_qsym.qsym.QuasiSymmetricFunctions.Fundamental.Eulerian:55: WARNING: Duplicate explicit target name: \"sw2010\".\n```\n\n----\nNew commits:",
    "created_at": "2019-05-02T13:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387083",
    "user": "@vbraun"
}
```

This ticket breaks docbuild on python3 (only); I don't know why but it does. Error is:

```
$ make doc-clean && make -j40 && make doc-html
[...]
[dochtml] Error building the documentation.
[dochtml] multiprocessing.pool.RemoteTraceback: 
[dochtml] """
[dochtml] Traceback (most recent call last):
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py", line 121, in worker
[dochtml]     result = (True, func(*args, **kwds))
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/multiprocessing/pool.py", line 44, in mapstar
[dochtml]     return list(map(*args))
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 79, in build_ref_doc
[dochtml]     getattr(ReferenceSubBuilder(doc, lang), format)(*args, **kwds)
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 761, in _wrapper
[dochtml]     getattr(DocBuilder, build_type)(self, *args, **kwds)
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/__init__.py", line 133, in f
[dochtml]     runsphinx()
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 314, in runsphinx
[dochtml]     sys.stderr.raise_errors()
[dochtml]   File "/var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage_setup/docbuild/sphinxbuild.py", line 249, in raise_errors
[dochtml]     raise OSError(self._error)
[dochtml] OSError: /var/lib/buildbot/slave/sage3_git/build/local/lib/python3.7/site-packages/sage/combinat/ncsf_qsym/qsym.py:docstring of sage.combinat.ncsf_qsym.qsym.QuasiSymmetricFunctions.Fundamental.Eulerian:55: WARNING: Duplicate explicit target name: "sw2010".
```

----
New commits:



---

archive/issue_comments_387084.json:
```json
{
    "body": "Set assignee to @embray.",
    "created_at": "2019-05-02T13:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387084",
    "user": "@embray"
}
```

Set assignee to @embray.



---

archive/issue_comments_387085.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2019-05-02T13:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387085",
    "user": "@embray"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_387086.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2019-05-02T13:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387086",
    "user": "@embray"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_387087.json:
```json
{
    "body": "Not sure why I can't just progress straight to needs_work...",
    "created_at": "2019-05-02T13:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387087",
    "user": "@embray"
}
```

Not sure why I can't just progress straight to needs_work...



---

archive/issue_comments_387088.json:
```json
{
    "body": "I suppose it's possible there's some strange interaction between this, and how Sphinx treats nested classes (either in plain Sphinx, or something particular that Sage does with it...)",
    "created_at": "2019-05-02T13:39:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387088",
    "user": "@embray"
}
```

I suppose it's possible there's some strange interaction between this, and how Sphinx treats nested classes (either in plain Sphinx, or something particular that Sage does with it...)



---

archive/issue_comments_387089.json:
```json
{
    "body": "Or how Sphinx treats cached methods? A bandaid (untested) might be to move the citation out of `qsym.py` to the master bibliography file.",
    "created_at": "2019-05-02T17:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387089",
    "user": "@jhpalmieri"
}
```

Or how Sphinx treats cached methods? A bandaid (untested) might be to move the citation out of `qsym.py` to the master bibliography file.



---

archive/issue_comments_387090.json:
```json
{
    "body": "In fact that file has its own bibliography at the start, so this change might fix it:\n\n```diff\ndiff --git a/src/sage/combinat/ncsf_qsym/qsym.py b/src/sage/combinat/ncsf_qsym/qsym.py\nindex ae7d830ed5..61004f24cd 100644\n--- a/src/sage/combinat/ncsf_qsym/qsym.py\n+++ b/src/sage/combinat/ncsf_qsym/qsym.py\n@@ -62,6 +62,10 @@ REFERENCES:\n    Quasisymmetric Functions Expand Positively into Young Quasisymmetric\n    Schur Functions*. :arxiv:`1606.03519`\n \n+.. [SW2010] John Shareshian and Michelle Wachs.\n+   *Eulerian quasisymmetric functions*. (2010).\n+   :arxiv:`0812.0764v2`\n+\n AUTHOR:\n \n - Jason Bandlow\n@@ -2348,12 +2352,6 @@ class QuasiSymmetricFunctions(UniqueRepresentation, Parent):\n             - ``k`` -- (optional) if specified, determines the number of fixed\n               points of the permutations which are being summed over\n \n-            REFERENCES:\n-\n-            .. [SW2010] John Shareshian and Michelle Wachs.\n-               *Eulerian quasisymmetric functions*. (2010).\n-               :arxiv:`0812.0764v2`\n-\n             EXAMPLES::\n \n                 sage: F = QuasiSymmetricFunctions(QQ).F()\n```\n\nAgain, this is just a bandaid.",
    "created_at": "2019-05-02T17:14:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387090",
    "user": "@jhpalmieri"
}
```

In fact that file has its own bibliography at the start, so this change might fix it:

```diff
diff --git a/src/sage/combinat/ncsf_qsym/qsym.py b/src/sage/combinat/ncsf_qsym/qsym.py
index ae7d830ed5..61004f24cd 100644
--- a/src/sage/combinat/ncsf_qsym/qsym.py
+++ b/src/sage/combinat/ncsf_qsym/qsym.py
@@ -62,6 +62,10 @@ REFERENCES:
    Quasisymmetric Functions Expand Positively into Young Quasisymmetric
    Schur Functions*. :arxiv:`1606.03519`
 
+.. [SW2010] John Shareshian and Michelle Wachs.
+   *Eulerian quasisymmetric functions*. (2010).
+   :arxiv:`0812.0764v2`
+
 AUTHOR:
 
 - Jason Bandlow
@@ -2348,12 +2352,6 @@ class QuasiSymmetricFunctions(UniqueRepresentation, Parent):
             - ``k`` -- (optional) if specified, determines the number of fixed
               points of the permutations which are being summed over
 
-            REFERENCES:
-
-            .. [SW2010] John Shareshian and Michelle Wachs.
-               *Eulerian quasisymmetric functions*. (2010).
-               :arxiv:`0812.0764v2`
-
             EXAMPLES::
 
                 sage: F = QuasiSymmetricFunctions(QQ).F()
```

Again, this is just a bandaid.



---

archive/issue_comments_387091.json:
```json
{
    "body": "Good job on Volker to find it out. I couldn't figure which ticket was causing that breakage.",
    "created_at": "2019-05-02T20:53:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387091",
    "user": "@kiwifb"
}
```

Good job on Volker to find it out. I couldn't figure which ticket was causing that breakage.



---

archive/issue_comments_387092.json:
```json
{
    "body": "Hasn't there been some effort I've seen elsewhere to move bibliographies to module top-levels anyways (probably in part to prevent problems like this)?",
    "created_at": "2019-05-03T13:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387092",
    "user": "@embray"
}
```

Hasn't there been some effort I've seen elsewhere to move bibliographies to module top-levels anyways (probably in part to prevent problems like this)?



---

archive/issue_comments_387093.json:
```json
{
    "body": "Or, I guess maybe I'm thinking of #27497, which is not exactly as I described.",
    "created_at": "2019-05-03T13:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387093",
    "user": "@embray"
}
```

Or, I guess maybe I'm thinking of #27497, which is not exactly as I described.



---

archive/issue_comments_387094.json:
```json
{
    "body": "The preferred thing is to move all references to the master bibliography file. `combinat` and `graphs` are the two directories remaining where this needs to be done.",
    "created_at": "2019-05-03T17:32:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387094",
    "user": "@jhpalmieri"
}
```

The preferred thing is to move all references to the master bibliography file. `combinat` and `graphs` are the two directories remaining where this needs to be done.



---

archive/issue_comments_387095.json:
```json
{
    "body": "I think my proposed change in comment:21 fixes the docbuilding problem. Should we incorporate it since it's the right thing to do to collect all of the references, or is it indicative of a further problem that needs investigating? (Do we care how Sphinx handles nested and/or cached methods, if that is indeed the problem?)",
    "created_at": "2019-05-05T21:24:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387095",
    "user": "@jhpalmieri"
}
```

I think my proposed change in comment:21 fixes the docbuilding problem. Should we incorporate it since it's the right thing to do to collect all of the references, or is it indicative of a further problem that needs investigating? (Do we care how Sphinx handles nested and/or cached methods, if that is indeed the problem?)



---

archive/issue_comments_387096.json:
```json
{
    "body": "Replying to [comment:26 jhpalmieri]:\n> I think my proposed change in comment:21 fixes the docbuilding problem. Should we incorporate it since it's the right thing to do to collect all of the references, or is it indicative of a further problem that needs investigating? (Do we care how Sphinx handles nested and/or cached methods, if that is indeed the problem?)\n\nOn one hand, it might be indicative of a deeper problem; on the other hand I don't think it's something I want to place high priority on.  I agree that this change fixes the problem for now.  I just want to confirm that the compiled docs do still look as expected and then I'll update this branch and set it back to positive review.",
    "created_at": "2019-05-06T14:17:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387096",
    "user": "@embray"
}
```

Replying to [comment:26 jhpalmieri]:
> I think my proposed change in comment:21 fixes the docbuilding problem. Should we incorporate it since it's the right thing to do to collect all of the references, or is it indicative of a further problem that needs investigating? (Do we care how Sphinx handles nested and/or cached methods, if that is indeed the problem?)

On one hand, it might be indicative of a deeper problem; on the other hand I don't think it's something I want to place high priority on.  I agree that this change fixes the problem for now.  I just want to confirm that the compiled docs do still look as expected and then I'll update this branch and set it back to positive review.



---

archive/issue_comments_387097.json:
```json
{
    "body": "There does appear to be a legitimate issue here w.r.t. Sphinx.\n\nIn the class `QuasiSymmetricFunctions` the nested class `Fundamental` also has an alias of just `F`.  That is, in the class body it has:\n\n\n```\nF = Fundamental\n```\n\n\njust as a shortcut.  This does not affect the qualified name of the class, which is still correct:\n\n\n```\nsage: QuasiSymmetricFunctions.Fundamental.__qualname__\n'QuasiSymmetricFunctions.Fundamental'\n```\n\n\nbut for some reason Sphinx is outputting the docs for `QuasiSymmetricFunctions` with this nested class listed as just \"F\" instead of \"Fundamental\", whereas in the [current docs](http://doc.sagemath.org/html/en/reference/combinat/sage/combinat/ncsf_qsym/qsym.html#sage.combinat.ncsf_qsym.qsym.QuasiSymmetricFunctions.Fundamental) it's listed correctly as \"Fundamental\".",
    "created_at": "2019-05-07T15:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387097",
    "user": "@embray"
}
```

There does appear to be a legitimate issue here w.r.t. Sphinx.

In the class `QuasiSymmetricFunctions` the nested class `Fundamental` also has an alias of just `F`.  That is, in the class body it has:


```
F = Fundamental
```


just as a shortcut.  This does not affect the qualified name of the class, which is still correct:


```
sage: QuasiSymmetricFunctions.Fundamental.__qualname__
'QuasiSymmetricFunctions.Fundamental'
```


but for some reason Sphinx is outputting the docs for `QuasiSymmetricFunctions` with this nested class listed as just "F" instead of "Fundamental", whereas in the [current docs](http://doc.sagemath.org/html/en/reference/combinat/sage/combinat/ncsf_qsym/qsym.html#sage.combinat.ncsf_qsym.qsym.QuasiSymmetricFunctions.Fundamental) it's listed correctly as "Fundamental".



---

archive/issue_comments_387098.json:
```json
{
    "body": "Back when I was last looking into this I was on the verge of tracking down the issue, but then everything went up in the air for a few weeks and now I'm not exactly sure where I was with this, though the issue did seem to be somewhere in one of Sage's Sphinx extensions.",
    "created_at": "2019-06-07T15:13:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387098",
    "user": "@embray"
}
```

Back when I was last looking into this I was on the verge of tracking down the issue, but then everything went up in the air for a few weeks and now I'm not exactly sure where I was with this, though the issue did seem to be somewhere in one of Sage's Sphinx extensions.



---

archive/issue_comments_387099.json:
```json
{
    "body": "Is there any hope for progress here ? This is now the top-failing file, by number of failures.",
    "created_at": "2019-06-12T08:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387099",
    "user": "@fchapoton"
}
```

Is there any hope for progress here ? This is now the top-failing file, by number of failures.



---

archive/issue_comments_387100.json:
```json
{
    "body": "I think so.  I (or someone) needs to work out exactly what's going on, IIRC in sage_autodoc, such that aliases for some nested classes are being preferred over the class itself.\n\nI think it might just be some dict sorting issue, but it needs to actually explicitly detect cases where an object's attribute name is not the same as its `__name__`.\n\nThat is, when looping over the members of, for example, `QuasiSymmetricFunctions`, you'll find a `Fundamental` member and an `F` member which both point to the same object, the class named `Fundamental`.  The docbuild is failing because this member is being listed as just \"class F\" and not \"class Fundamental\".",
    "created_at": "2019-06-12T08:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387100",
    "user": "@embray"
}
```

I think so.  I (or someone) needs to work out exactly what's going on, IIRC in sage_autodoc, such that aliases for some nested classes are being preferred over the class itself.

I think it might just be some dict sorting issue, but it needs to actually explicitly detect cases where an object's attribute name is not the same as its `__name__`.

That is, when looping over the members of, for example, `QuasiSymmetricFunctions`, you'll find a `Fundamental` member and an `F` member which both point to the same object, the class named `Fundamental`.  The docbuild is failing because this member is being listed as just "class F" and not "class Fundamental".



---

archive/issue_comments_387101.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-13T08:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387101",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_387102.json:
```json
{
    "body": "Rebased.  Going to keep investigating the docbuild issue now.",
    "created_at": "2019-06-13T08:50:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387102",
    "user": "@embray"
}
```

Rebased.  Going to keep investigating the docbuild issue now.



---

archive/issue_comments_387103.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-13T08:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387103",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387104.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-06-13T10:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387104",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387105.json:
```json
{
    "body": "The above commit fixes the docbuild issue for me.  The resulting docs now look as expected: `QuasiSymmetricFunctions.Fundamental` is documented as a nested class in `QuasiSymmetricFunctions`, while `QuasiSymmetricFunctions.F` is documented as an attribute, which is simply an alias for `QuasiSymmetricFunctions.Fundamental`.\n\nNeed to double-check that this still holds on Python 2 with this branch.",
    "created_at": "2019-06-13T10:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387105",
    "user": "@embray"
}
```

The above commit fixes the docbuild issue for me.  The resulting docs now look as expected: `QuasiSymmetricFunctions.Fundamental` is documented as a nested class in `QuasiSymmetricFunctions`, while `QuasiSymmetricFunctions.F` is documented as an attribute, which is simply an alias for `QuasiSymmetricFunctions.Fundamental`.

Need to double-check that this still holds on Python 2 with this branch.



---

archive/issue_comments_387106.json:
```json
{
    "body": "I think this is good for Python 2 as well.  Strangely, the `.F` alias does not get documented in the autodoc for the class on Python 2, and that appears to be the case in the current version of the docs as well. That difference is consistent before and after this change, whereas the Python 3 version seems better so I'm content to leave it at that.",
    "created_at": "2019-06-13T19:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387106",
    "user": "@embray"
}
```

I think this is good for Python 2 as well.  Strangely, the `.F` alias does not get documented in the autodoc for the class on Python 2, and that appears to be the case in the current version of the docs as well. That difference is consistent before and after this change, whereas the Python 3 version seems better so I'm content to leave it at that.



---

archive/issue_comments_387107.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-06-13T19:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387107",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_387108.json:
```json
{
    "body": "This looks okay to me, but others should investigate, too.",
    "created_at": "2019-06-13T21:42:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387108",
    "user": "@jhpalmieri"
}
```

This looks okay to me, but others should investigate, too.



---

archive/issue_comments_387109.json:
```json
{
    "body": "patchbot reports some pyflakes errors (easy to fix) and a docbuild failure:\n\n```\n+[dochtml] OSError: /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/combinat/dyck_word.py:\ndocstring of sage.combinat.dyck_word.DyckWord_complete.pyramid_weight:23:\nWARNING: Duplicate explicit target name: \"ds1992\".\n```\n",
    "created_at": "2019-06-14T06:10:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387109",
    "user": "@fchapoton"
}
```

patchbot reports some pyflakes errors (easy to fix) and a docbuild failure:

```
+[dochtml] OSError: /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/combinat/dyck_word.py:
docstring of sage.combinat.dyck_word.DyckWord_complete.pyramid_weight:23:
WARNING: Duplicate explicit target name: "ds1992".
```




---

archive/issue_comments_387110.json:
```json
{
    "body": "After I fix the references in `dyck_word.py`, I get a ton of other \"Duplicate citation\" and \"Duplicate explicit target names\" from other files in `sage/combinat`. For example:\n\n```\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:376: WARNING: Duplicate explicit target name: \"propp2001\".\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:381: WARNING: Duplicate explicit target name: \"striker2015\".\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element.gyration:9: WARNING: Duplicate explicit target name: \"wieland00\".\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:376: WARNING: duplicate citation Propp2001, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/fully_packed_loop.rst\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:381: WARNING: duplicate citation Striker2015, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/fully_packed_loop.rst\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element.gyration:9: WARNING: duplicate citation Wieland00, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/fully_packed_loop.rst\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/interval_posets.py:docstring of sage.combinat.interval_posets.TamariIntervalPosets_all.Element.cubical_coordinates:14: WARNING: Duplicate explicit target name: \"combe2019\".\n[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/interval_posets.py:docstring of sage.combinat.interval_posets.TamariIntervalPosets_all.Element.cubical_coordinates:14: WARNING: duplicate citation Combe2019, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/interval_posets.rst\n```\n",
    "created_at": "2019-06-14T15:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387110",
    "user": "@jhpalmieri"
}
```

After I fix the references in `dyck_word.py`, I get a ton of other "Duplicate citation" and "Duplicate explicit target names" from other files in `sage/combinat`. For example:

```
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:376: WARNING: Duplicate explicit target name: "propp2001".
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:381: WARNING: Duplicate explicit target name: "striker2015".
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element.gyration:9: WARNING: Duplicate explicit target name: "wieland00".
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:376: WARNING: duplicate citation Propp2001, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/fully_packed_loop.rst
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element:381: WARNING: duplicate citation Striker2015, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/fully_packed_loop.rst
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/fully_packed_loop.py:docstring of sage.combinat.fully_packed_loop.FullyPackedLoops.Element.gyration:9: WARNING: duplicate citation Wieland00, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/fully_packed_loop.rst
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/interval_posets.py:docstring of sage.combinat.interval_posets.TamariIntervalPosets_all.Element.cubical_coordinates:14: WARNING: Duplicate explicit target name: "combe2019".
[combinat ] /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/combinat/interval_posets.py:docstring of sage.combinat.interval_posets.TamariIntervalPosets_all.Element.cubical_coordinates:14: WARNING: duplicate citation Combe2019, other instance in /Users/palmieri/Desktop/Sage_stuff/git/sage/src/doc/en/reference/combinat/sage/combinat/interval_posets.rst
```




---

archive/issue_comments_387111.json:
```json
{
    "body": "This fixes the pyflakes errors:\n\n```diff\ndiff --git a/src/sage_setup/docbuild/ext/sage_autodoc.py b/src/sage_setup/docbuild/ext/sage_autodoc.py\nindex 9cce254a13..b75791de36 100644\n--- a/src/sage_setup/docbuild/ext/sage_autodoc.py\n+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py\n@@ -30,25 +30,21 @@ AUTHORS:\n import inspect\n import re\n import sys\n-import warnings\n \n from docutils.statemachine import ViewList\n-from six import PY2, iteritems, itervalues, text_type, class_types, string_types\n+from six import PY2, itervalues, text_type, class_types, string_types\n \n import sphinx\n-from sphinx.errors import ExtensionError\n from sphinx.ext.autodoc.importer import mock, import_object, get_object_members\n-from sphinx.ext.autodoc.inspector import format_annotation\n from sphinx.locale import _, __\n from sphinx.pycode import ModuleAnalyzer\n-from sphinx.errors import ExtensionError, PycodeError\n+from sphinx.errors import PycodeError\n from sphinx.util import logging\n from sphinx.util import rpartition, force_decode\n from sphinx.util.docstrings import prepare_docstring\n-from sphinx.util.inspect import Signature, isdescriptor, safe_getmembers, \\\n+from sphinx.util.inspect import isdescriptor, safe_getmembers, \\\n     safe_getattr, object_description, is_builtin_class_method, \\\n     isenumattribute, isclassmethod, isstaticmethod, getdoc\n-from sphinx.util.inspect import getargspec\n \n from sage.misc.sageinspect import (sage_getdoc_original,\n                                    sage_getargspec, isclassinstance,\n```\n\nor at least, it fixes the ones that ought to be fixed.",
    "created_at": "2019-06-14T15:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387111",
    "user": "@jhpalmieri"
}
```

This fixes the pyflakes errors:

```diff
diff --git a/src/sage_setup/docbuild/ext/sage_autodoc.py b/src/sage_setup/docbuild/ext/sage_autodoc.py
index 9cce254a13..b75791de36 100644
--- a/src/sage_setup/docbuild/ext/sage_autodoc.py
+++ b/src/sage_setup/docbuild/ext/sage_autodoc.py
@@ -30,25 +30,21 @@ AUTHORS:
 import inspect
 import re
 import sys
-import warnings
 
 from docutils.statemachine import ViewList
-from six import PY2, iteritems, itervalues, text_type, class_types, string_types
+from six import PY2, itervalues, text_type, class_types, string_types
 
 import sphinx
-from sphinx.errors import ExtensionError
 from sphinx.ext.autodoc.importer import mock, import_object, get_object_members
-from sphinx.ext.autodoc.inspector import format_annotation
 from sphinx.locale import _, __
 from sphinx.pycode import ModuleAnalyzer
-from sphinx.errors import ExtensionError, PycodeError
+from sphinx.errors import PycodeError
 from sphinx.util import logging
 from sphinx.util import rpartition, force_decode
 from sphinx.util.docstrings import prepare_docstring
-from sphinx.util.inspect import Signature, isdescriptor, safe_getmembers, \
+from sphinx.util.inspect import isdescriptor, safe_getmembers, \
     safe_getattr, object_description, is_builtin_class_method, \
     isenumattribute, isclassmethod, isstaticmethod, getdoc
-from sphinx.util.inspect import getargspec
 
 from sage.misc.sageinspect import (sage_getdoc_original,
                                    sage_getargspec, isclassinstance,
```

or at least, it fixes the ones that ought to be fixed.



---

archive/issue_comments_387112.json:
```json
{
    "body": "Replying to [comment:40 jhpalmieri]:\n> After I fix the references in `dyck_word.py`, I get a ton of other \"Duplicate citation\" and \"Duplicate explicit target names\" from other files in `sage/combinat`. For example:\n\nI didn't have this problem before, so is it possible it was recently introduced?  Perhaps it's just another citation that needs to be moved to the module-level, or the master citations list?",
    "created_at": "2019-06-14T16:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387112",
    "user": "@embray"
}
```

Replying to [comment:40 jhpalmieri]:
> After I fix the references in `dyck_word.py`, I get a ton of other "Duplicate citation" and "Duplicate explicit target names" from other files in `sage/combinat`. For example:

I didn't have this problem before, so is it possible it was recently introduced?  Perhaps it's just another citation that needs to be moved to the module-level, or the master citations list?



---

archive/issue_comments_387113.json:
```json
{
    "body": "It may only appear if you do `make doc-clean`. My guess is that whatever is forcing us to move the references in `dyck_word.py` to the module-level is also going to force us to move other references. The references in `FullyPackedLoop` are in a class with the decoration ``@`add_metaclass(InheritComparisonClasscallMetaclass)`. The reference `Combe2019` is in a method with ``@`cached_method`. Do we have to move all references in classes, methods, with these decorations to the module-level?",
    "created_at": "2019-06-14T16:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387113",
    "user": "@jhpalmieri"
}
```

It may only appear if you do `make doc-clean`. My guess is that whatever is forcing us to move the references in `dyck_word.py` to the module-level is also going to force us to move other references. The references in `FullyPackedLoop` are in a class with the decoration ``@`add_metaclass(InheritComparisonClasscallMetaclass)`. The reference `Combe2019` is in a method with ``@`cached_method`. Do we have to move all references in classes, methods, with these decorations to the module-level?



---

archive/issue_comments_387114.json:
```json
{
    "body": "Another issue: in `tableau_tuple.py` we have\n\n```\nfrom sage.combinat.tableau import (Tableau, ...)\n```\n\nand later\n\n```\nclass TableauTuple(CombinatorialElement):\n    ...\n    Element = Tableau\n```\n\nand now Sphinx thinks that all of the references in the `Element` class are duplicates of those from `Tableau`. This seems to be fixed by moving all of the references to the master bibliography file.",
    "created_at": "2019-06-14T18:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387114",
    "user": "@jhpalmieri"
}
```

Another issue: in `tableau_tuple.py` we have

```
from sage.combinat.tableau import (Tableau, ...)
```

and later

```
class TableauTuple(CombinatorialElement):
    ...
    Element = Tableau
```

and now Sphinx thinks that all of the references in the `Element` class are duplicates of those from `Tableau`. This seems to be fixed by moving all of the references to the master bibliography file.



---

archive/issue_comments_387115.json:
```json
{
    "body": "I'm getting some doctest failures with Python 3. Does anyone else see them?\n\n```\n----------------------------------------------------------------------\nsage -t --long src/sage/categories/category.py  # 5 doctests failed\nsage -t --long src/sage/categories/primer.py  # 1 doctest failed\nsage -t --long src/sage/categories/category_with_axiom.py  # 5 doctests failed\nsage -t --long src/sage/categories/homsets.py  # 1 doctest failed\nsage -t --long src/sage/categories/polyhedra.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nFor example:\n\n```\nsage -t --long src/sage/categories/homsets.py\n**********************************************************************\nFile \"src/sage/categories/homsets.py\", line 56, in sage.categories.homsets.HomsetsCategory.default_super_categories\nFailed example:\n    type(H)\nExpected:\n    <class 'sage.categories.additive_monoids.AdditiveMonoids.Homsets_with_category'>\nGot:\n    <class 'sage.categories.additive_monoids.Homsets_with_category'>\n```\n\n----\nNew commits:",
    "created_at": "2019-06-14T21:42:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387115",
    "user": "@jhpalmieri"
}
```

I'm getting some doctest failures with Python 3. Does anyone else see them?

```
----------------------------------------------------------------------
sage -t --long src/sage/categories/category.py  # 5 doctests failed
sage -t --long src/sage/categories/primer.py  # 1 doctest failed
sage -t --long src/sage/categories/category_with_axiom.py  # 5 doctests failed
sage -t --long src/sage/categories/homsets.py  # 1 doctest failed
sage -t --long src/sage/categories/polyhedra.py  # 1 doctest failed
----------------------------------------------------------------------
```

For example:

```
sage -t --long src/sage/categories/homsets.py
**********************************************************************
File "src/sage/categories/homsets.py", line 56, in sage.categories.homsets.HomsetsCategory.default_super_categories
Failed example:
    type(H)
Expected:
    <class 'sage.categories.additive_monoids.AdditiveMonoids.Homsets_with_category'>
Got:
    <class 'sage.categories.additive_monoids.Homsets_with_category'>
```

----
New commits:



---

archive/issue_comments_387116.json:
```json
{
    "body": "I can confirm the same failure in categories/ with the present branch here.",
    "created_at": "2019-06-15T06:39:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387116",
    "user": "@fchapoton"
}
```

I can confirm the same failure in categories/ with the present branch here.



---

archive/issue_comments_387117.json:
```json
{
    "body": "This has doctests failure with python3",
    "created_at": "2019-06-18T06:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387117",
    "user": "@fchapoton"
}
```

This has doctests failure with python3



---

archive/issue_comments_387118.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-18T06:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387118",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_387119.json:
```json
{
    "body": "Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).",
    "created_at": "2019-07-03T11:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387119",
    "user": "@embray"
}
```

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).



---

archive/issue_comments_387120.json:
```json
{
    "body": "Is there any hope for progress here ?\n\nEDIT: the branch is now red",
    "created_at": "2019-07-03T12:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387120",
    "user": "@fchapoton"
}
```

Is there any hope for progress here ?

EDIT: the branch is now red



---

archive/issue_comments_387121.json:
```json
{
    "body": "I have made #28105 for just moving the references.",
    "created_at": "2019-07-03T12:27:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387121",
    "user": "@fchapoton"
}
```

I have made #28105 for just moving the references.



---

archive/issue_comments_387122.json:
```json
{
    "body": "Erik, John ? The branch is now red. Is there any hope to make at least a partial progress on this file ?",
    "created_at": "2019-07-10T19:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387122",
    "user": "@fchapoton"
}
```

Erik, John ? The branch is now red. Is there any hope to make at least a partial progress on this file ?



---

archive/issue_comments_387123.json:
```json
{
    "body": "Replying to [comment:28 embray]:\n> There does appear to be a legitimate issue here w.r.t. Sphinx.\n> \n> In the class `QuasiSymmetricFunctions` the nested class `Fundamental` also has an alias of just `F`.  That is, in the class body it has:\n> \n> {{{\n> F = Fundamental\n> }}}\n> \n> just as a shortcut.  This does not affect the qualified name of the class, which is still correct:\n> \n> {{{\n> sage: QuasiSymmetricFunctions.Fundamental.__qualname__\n> 'QuasiSymmetricFunctions.Fundamental'\n> }}}\n> \n> but for some reason Sphinx is outputting the docs for `QuasiSymmetricFunctions` with this nested class listed as just \"F\" instead of \"Fundamental\", whereas in the [current docs](http://doc.sagemath.org/html/en/reference/combinat/sage/combinat/ncsf_qsym/qsym.html#sage.combinat.ncsf_qsym.qsym.QuasiSymmetricFunctions.Fundamental) it's listed correctly as \"Fundamental\".\n\nI don't see this problem, at least with a Python 3 build. I see\n\n```\nF\n    alias of QuasiSymmetricFunctions.Fundamental\n\nclass Fundamental(QSym)\n    ...\n```\n\nWithout this branch, the first two lines are missing, but everything else looks the same.",
    "created_at": "2019-07-10T20:22:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387123",
    "user": "@jhpalmieri"
}
```

Replying to [comment:28 embray]:
> There does appear to be a legitimate issue here w.r.t. Sphinx.
> 
> In the class `QuasiSymmetricFunctions` the nested class `Fundamental` also has an alias of just `F`.  That is, in the class body it has:
> 
> {{{
> F = Fundamental
> }}}
> 
> just as a shortcut.  This does not affect the qualified name of the class, which is still correct:
> 
> {{{
> sage: QuasiSymmetricFunctions.Fundamental.__qualname__
> 'QuasiSymmetricFunctions.Fundamental'
> }}}
> 
> but for some reason Sphinx is outputting the docs for `QuasiSymmetricFunctions` with this nested class listed as just "F" instead of "Fundamental", whereas in the [current docs](http://doc.sagemath.org/html/en/reference/combinat/sage/combinat/ncsf_qsym/qsym.html#sage.combinat.ncsf_qsym.qsym.QuasiSymmetricFunctions.Fundamental) it's listed correctly as "Fundamental".

I don't see this problem, at least with a Python 3 build. I see

```
F
    alias of QuasiSymmetricFunctions.Fundamental

class Fundamental(QSym)
    ...
```

Without this branch, the first two lines are missing, but everything else looks the same.



---

archive/issue_comments_387124.json:
```json
{
    "body": "On the other hand, with this branch I see a new py3 doctest failure:\n\n```\nFile \"src/sage/misc/c3_controlled.pyx\", line 449, in sage.misc.c3_controlled.CmpKey\nFailed example:\n    Sets().Infinite()._cmp_key\nExpected:\n    (4, ...)\nGot:\n    (0, 40)\n**********************************************************************\n1 item had failures:\n   1 of  27 in sage.misc.c3_controlled.CmpKey\n```\n",
    "created_at": "2019-07-10T20:32:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387124",
    "user": "@jhpalmieri"
}
```

On the other hand, with this branch I see a new py3 doctest failure:

```
File "src/sage/misc/c3_controlled.pyx", line 449, in sage.misc.c3_controlled.CmpKey
Failed example:
    Sets().Infinite()._cmp_key
Expected:
    (4, ...)
Got:
    (0, 40)
**********************************************************************
1 item had failures:
   1 of  27 in sage.misc.c3_controlled.CmpKey
```




---

archive/issue_comments_387125.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-10T21:30:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387125",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_387126.json:
```json
{
    "body": "Rebased to 8.9.beta2.",
    "created_at": "2019-07-10T21:31:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387126",
    "user": "@jhpalmieri"
}
```

Rebased to 8.9.beta2.



---

archive/issue_comments_387127.json:
```json
{
    "body": "In my opinion, if the new doctest failure in `c3_controlled.pyx` can be fixed, then this is ready to go. I don't know what's causing it, though.",
    "created_at": "2019-07-10T23:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387127",
    "user": "@jhpalmieri"
}
```

In my opinion, if the new doctest failure in `c3_controlled.pyx` can be fixed, then this is ready to go. I don't know what's causing it, though.



---

archive/issue_comments_387128.json:
```json
{
    "body": "This seems to be an issue with class name of `Sets().Infinite()`\n\nin the flags tables, one sees\n\n```\n{'FacadeSets': 1,\n 'FiniteSets': 2,\n 'Sets.Infinite': 4,\n 'EnumeratedSets': 8,\n```\n\nwhere the second line is the only line with a dot inside.",
    "created_at": "2019-07-11T10:25:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387128",
    "user": "@fchapoton"
}
```

This seems to be an issue with class name of `Sets().Infinite()`

in the flags tables, one sees

```
{'FacadeSets': 1,
 'FiniteSets': 2,
 'Sets.Infinite': 4,
 'EnumeratedSets': 8,
```

where the second line is the only line with a dot inside.



---

archive/issue_comments_387129.json:
```json
{
    "body": "It may be more complicated than that. I made this change:\n\n```diff\ndiff --git a/src/sage/misc/c3_controlled.pyx b/src/sage/misc/c3_controlled.pyx\nindex 323086fb8e..9b404e8b70 100644\n--- a/src/sage/misc/c3_controlled.pyx\n+++ b/src/sage/misc/c3_controlled.pyx\n@@ -375,7 +375,7 @@ from sage.structure.dynamic_class import dynamic_class\n ##############################################################################\n \n cdef tuple atoms = (\"FacadeSets\",\n-                    \"FiniteSets\", \"Sets.Infinite\", \"EnumeratedSets\", \"SetsWithGrading\",\n+                    \"FiniteSets\", \"InfiniteSets\", \"EnumeratedSets\", \"SetsWithGrading\",\n                     \"Posets\", \"LatticePosets\", \"Crystals\", \"AdditiveMagmas\",\n                     \"FiniteDimensionalModules\", \"GradedModules\", \"ModulesWithBasis\",\n                     \"Magmas\", \"Semigroups\", \"Monoids\", \"PermutationGroups\",\n```\n\nand then added a statement to print `flags`. I got this:\n\n```\n{'FacadeSets': 1, 'FiniteSets': 2, 'InfiniteSets': 4, 'EnumeratedSets': 8, 'SetsWithGrading': 16, 'Posets': 32, 'LatticePosets': 64, 'Crystals': 128, 'AdditiveMagmas': 256, 'FiniteDimensionalModules': 512, 'GradedModules': 1024, 'ModulesWithBasis': 2048, 'Magmas': 4096, 'Semigroups': 8192, 'Monoids': 16384, 'PermutationGroups': 32768, 'MagmasAndAdditiveMagmas': 65536, 'Rngs': 131072, 'Domains': 262144, 'HopfAlgebras': 524288}\nsage: Sets().Finite()._cmp_key\n(2, 55)\nsage: Sets().Infinite()._cmp_key\n(0, 40)\nsage: Sets().Enumerated()._cmp_key\n(8, 42)\n```\n\nSo although `InfiniteSets` is now in `flags` with value of 4, the `_cmp_key` is still 0 for `Sets().Infinite()`.",
    "created_at": "2019-07-11T17:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387129",
    "user": "@jhpalmieri"
}
```

It may be more complicated than that. I made this change:

```diff
diff --git a/src/sage/misc/c3_controlled.pyx b/src/sage/misc/c3_controlled.pyx
index 323086fb8e..9b404e8b70 100644
--- a/src/sage/misc/c3_controlled.pyx
+++ b/src/sage/misc/c3_controlled.pyx
@@ -375,7 +375,7 @@ from sage.structure.dynamic_class import dynamic_class
 ##############################################################################
 
 cdef tuple atoms = ("FacadeSets",
-                    "FiniteSets", "Sets.Infinite", "EnumeratedSets", "SetsWithGrading",
+                    "FiniteSets", "InfiniteSets", "EnumeratedSets", "SetsWithGrading",
                     "Posets", "LatticePosets", "Crystals", "AdditiveMagmas",
                     "FiniteDimensionalModules", "GradedModules", "ModulesWithBasis",
                     "Magmas", "Semigroups", "Monoids", "PermutationGroups",
```

and then added a statement to print `flags`. I got this:

```
{'FacadeSets': 1, 'FiniteSets': 2, 'InfiniteSets': 4, 'EnumeratedSets': 8, 'SetsWithGrading': 16, 'Posets': 32, 'LatticePosets': 64, 'Crystals': 128, 'AdditiveMagmas': 256, 'FiniteDimensionalModules': 512, 'GradedModules': 1024, 'ModulesWithBasis': 2048, 'Magmas': 4096, 'Semigroups': 8192, 'Monoids': 16384, 'PermutationGroups': 32768, 'MagmasAndAdditiveMagmas': 65536, 'Rngs': 131072, 'Domains': 262144, 'HopfAlgebras': 524288}
sage: Sets().Finite()._cmp_key
(2, 55)
sage: Sets().Infinite()._cmp_key
(0, 40)
sage: Sets().Enumerated()._cmp_key
(8, 42)
```

So although `InfiniteSets` is now in `flags` with value of 4, the `_cmp_key` is still 0 for `Sets().Infinite()`.



---

archive/issue_comments_387130.json:
```json
{
    "body": "Without this branch:\n\n```\nsage: C = Sets().Infinite()\nsage: C.__class__.__name__\n'Sets.Infinite_with_category'\n```\n\nWith this branch:\n\n```\nsage: C = Sets().Infinite()\nsage: C.__class__.__name__\n'Infinite_with_category'\n```\n\nChanging `Sets.Infinite` to just `Infinite` in `atoms` fixes the doctest, but it doesn't feel like the right thing to do.",
    "created_at": "2019-07-11T17:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387130",
    "user": "@jhpalmieri"
}
```

Without this branch:

```
sage: C = Sets().Infinite()
sage: C.__class__.__name__
'Sets.Infinite_with_category'
```

With this branch:

```
sage: C = Sets().Infinite()
sage: C.__class__.__name__
'Infinite_with_category'
```

Changing `Sets.Infinite` to just `Infinite` in `atoms` fixes the doctest, but it doesn't feel like the right thing to do.



---

archive/issue_comments_387131.json:
```json
{
    "body": "This seems like a direct consequence of the change in `nested_class.pyx`. Do we do:\n\n```\nif PY2:\n    ... define atoms using Sets.Infinite ...\nelse:\n    ... define atoms using Infinite ...\n```\n\nSeems ugly.",
    "created_at": "2019-07-11T17:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387131",
    "user": "@jhpalmieri"
}
```

This seems like a direct consequence of the change in `nested_class.pyx`. Do we do:

```
if PY2:
    ... define atoms using Sets.Infinite ...
else:
    ... define atoms using Infinite ...
```

Seems ugly.



---

archive/issue_comments_387132.json:
```json
{
    "body": "For example:\n\n```diff\ndiff --git a/src/sage/misc/c3_controlled.pyx b/src/sage/misc/c3_controlled.pyx\nindex 323086fb8e..2c7cd0f573 100644\n--- a/src/sage/misc/c3_controlled.pyx\n+++ b/src/sage/misc/c3_controlled.pyx\n@@ -369,13 +369,19 @@ from sage.misc.classcall_metaclass import ClasscallMetaclass, typecall\n from sage.misc.cachefunc import cached_function, cached_method\n from sage.misc.lazy_attribute import lazy_attribute\n from sage.structure.dynamic_class import dynamic_class\n+from six import PY2\n \n ##############################################################################\n # Implementation of the total order between categories\n ##############################################################################\n \n+if PY2:\n+    infinitesets = \"Sets.Infinite\"\n+else:\n+    infinitesets = \"Infinite\"\n+\n cdef tuple atoms = (\"FacadeSets\",\n-                    \"FiniteSets\", \"Sets.Infinite\", \"EnumeratedSets\", \"SetsWithGrading\",\n+                    \"FiniteSets\", infinitesets, \"EnumeratedSets\", \"SetsWithGrading\",\n                     \"Posets\", \"LatticePosets\", \"Crystals\", \"AdditiveMagmas\",\n                     \"FiniteDimensionalModules\", \"GradedModules\", \"ModulesWithBasis\",\n                     \"Magmas\", \"Semigroups\", \"Monoids\", \"PermutationGroups\",\n```\n\nI don't like it, but it works.",
    "created_at": "2019-07-11T17:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387132",
    "user": "@jhpalmieri"
}
```

For example:

```diff
diff --git a/src/sage/misc/c3_controlled.pyx b/src/sage/misc/c3_controlled.pyx
index 323086fb8e..2c7cd0f573 100644
--- a/src/sage/misc/c3_controlled.pyx
+++ b/src/sage/misc/c3_controlled.pyx
@@ -369,13 +369,19 @@ from sage.misc.classcall_metaclass import ClasscallMetaclass, typecall
 from sage.misc.cachefunc import cached_function, cached_method
 from sage.misc.lazy_attribute import lazy_attribute
 from sage.structure.dynamic_class import dynamic_class
+from six import PY2
 
 ##############################################################################
 # Implementation of the total order between categories
 ##############################################################################
 
+if PY2:
+    infinitesets = "Sets.Infinite"
+else:
+    infinitesets = "Infinite"
+
 cdef tuple atoms = ("FacadeSets",
-                    "FiniteSets", "Sets.Infinite", "EnumeratedSets", "SetsWithGrading",
+                    "FiniteSets", infinitesets, "EnumeratedSets", "SetsWithGrading",
                     "Posets", "LatticePosets", "Crystals", "AdditiveMagmas",
                     "FiniteDimensionalModules", "GradedModules", "ModulesWithBasis",
                     "Magmas", "Semigroups", "Monoids", "PermutationGroups",
```

I don't like it, but it works.



---

archive/issue_comments_387133.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-07-11T21:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387133",
    "user": "@kwankyu"
}
```

New commits:



---

archive/issue_comments_387134.json:
```json
{
    "body": "In the commit fb6d5fa, I followed different approach to solve the issue. I keep `NestedClassMetaclass` as it was even with python3, but fixes doctests appropriately for both python2 and python3. See the note in the module docstring.\n\nI think this approach is simple and the right one at this stage.\n\nTo a reviewer: I am not completely sure about what I wrote in the note. Please correct the note.",
    "created_at": "2019-07-11T22:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387134",
    "user": "@kwankyu"
}
```

In the commit fb6d5fa, I followed different approach to solve the issue. I keep `NestedClassMetaclass` as it was even with python3, but fixes doctests appropriately for both python2 and python3. See the note in the module docstring.

I think this approach is simple and the right one at this stage.

To a reviewer: I am not completely sure about what I wrote in the note. Please correct the note.



---

archive/issue_comments_387135.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-11T22:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387135",
    "user": "@kwankyu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_387136.json:
```json
{
    "body": "Tests pass for me. The approach seems okay to me, but I am not an expert on this aspect of the code. What do others think? `@`embray?",
    "created_at": "2019-07-12T15:04:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387136",
    "user": "@jhpalmieri"
}
```

Tests pass for me. The approach seems okay to me, but I am not an expert on this aspect of the code. What do others think? `@`embray?



---

archive/issue_comments_387137.json:
```json
{
    "body": "I add that Erik's approach should be considered when we drop the support on python2 and remove the nested class module altogether.",
    "created_at": "2019-07-15T00:56:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387137",
    "user": "@kwankyu"
}
```

I add that Erik's approach should be considered when we drop the support on python2 and remove the nested class module altogether.



---

archive/issue_comments_387138.json:
```json
{
    "body": "It would be nice to improve the documentation. This is not a new addition, but what do \"save_global\" and \"load_global\" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)",
    "created_at": "2019-07-18T17:32:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387138",
    "user": "@jhpalmieri"
}
```

It would be nice to improve the documentation. This is not a new addition, but what do "save_global" and "load_global" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)



---

archive/issue_comments_387139.json:
```json
{
    "body": "The only issue here is the note added by klee. Is it correct? If so, I think this is ready to go.",
    "created_at": "2019-07-18T17:48:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387139",
    "user": "@jhpalmieri"
}
```

The only issue here is the note added by klee. Is it correct? If so, I think this is ready to go.



---

archive/issue_comments_387140.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-19T02:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387140",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387141.json:
```json
{
    "body": "Replying to [comment:68 jhpalmieri]:\n> It would be nice to improve the documentation. This is not a new addition, but what do \"save_global\" and \"load_global\" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)\n\nThey are C functions in cPickle module (actually cPickle.c), and not visible to a user.",
    "created_at": "2019-07-19T02:13:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387141",
    "user": "@kwankyu"
}
```

Replying to [comment:68 jhpalmieri]:
> It would be nice to improve the documentation. This is not a new addition, but what do "save_global" and "load_global" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)

They are C functions in cPickle module (actually cPickle.c), and not visible to a user.



---

archive/issue_comments_387142.json:
```json
{
    "body": "In the last commit, I corrected the note, after investigating cPickle of python2 and the pickle module of python3. So I am now sure that what it says is correct.\n\nI think this ticket is now good to go.",
    "created_at": "2019-07-19T02:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387142",
    "user": "@kwankyu"
}
```

In the last commit, I corrected the note, after investigating cPickle of python2 and the pickle module of python3. So I am now sure that what it says is correct.

I think this ticket is now good to go.



---

archive/issue_comments_387143.json:
```json
{
    "body": "Replying to [comment:71 klee]:\n> Replying to [comment:68 jhpalmieri]:\n> > It would be nice to improve the documentation. This is not a new addition, but what do \"save_global\" and \"load_global\" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)\n> \n> They are C functions in cPickle module (actually cPickle.c), and not visible to a user.\n\nExactly. Not only not visible to a user, but as I said, not documented anywhere, so having them as part of our documentation is not helpful.",
    "created_at": "2019-07-19T05:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387143",
    "user": "@jhpalmieri"
}
```

Replying to [comment:71 klee]:
> Replying to [comment:68 jhpalmieri]:
> > It would be nice to improve the documentation. This is not a new addition, but what do "save_global" and "load_global" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)
> 
> They are C functions in cPickle module (actually cPickle.c), and not visible to a user.

Exactly. Not only not visible to a user, but as I said, not documented anywhere, so having them as part of our documentation is not helpful.



---

archive/issue_comments_387144.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-19T06:01:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387144",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387145.json:
```json
{
    "body": "Replying to [comment:73 jhpalmieri]:\n> Replying to [comment:71 klee]:\n> > Replying to [comment:68 jhpalmieri]:\n> > > It would be nice to improve the documentation. This is not a new addition, but what do \"save_global\" and \"load_global\" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)\n> > \n> > They are C functions in cPickle module (actually cPickle.c), and not visible to a user.\n> \n> Exactly. Not only not visible to a user, but as I said, not documented anywhere, so having them as part of our documentation is not helpful.\n\nOk. Then let's remove them here.",
    "created_at": "2019-07-19T06:02:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387145",
    "user": "@kwankyu"
}
```

Replying to [comment:73 jhpalmieri]:
> Replying to [comment:71 klee]:
> > Replying to [comment:68 jhpalmieri]:
> > > It would be nice to improve the documentation. This is not a new addition, but what do "save_global" and "load_global" refer to? I guess they are methods in Python's pickle module, but they are undocumented, which makes them less than ideal as reference points. (Fixing this could certainly wait until another ticket.)
> > 
> > They are C functions in cPickle module (actually cPickle.c), and not visible to a user.
> 
> Exactly. Not only not visible to a user, but as I said, not documented anywhere, so having them as part of our documentation is not helpful.

Ok. Then let's remove them here.



---

archive/issue_comments_387146.json:
```json
{
    "body": "I think that it is more than time to move on here.\n\nGiven that John and Kwankyu said \"good to go\", I am setting to positive",
    "created_at": "2019-07-20T10:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387146",
    "user": "@fchapoton"
}
```

I think that it is more than time to move on here.

Given that John and Kwankyu said "good to go", I am setting to positive



---

archive/issue_comments_387147.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-20T10:57:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387147",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_387148.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-07-23T21:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387148",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_387149.json:
```json
{
    "body": "Now it fails on py2 with:\n\n```\n[dochtml] OSError: /var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py:docstring of sage.combinat.tableau.Tableaux.Element.promotion:40: WARNING: Duplicate explicit target name: \"hai1992\".\n```\n",
    "created_at": "2019-07-23T21:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387149",
    "user": "@vbraun"
}
```

Now it fails on py2 with:

```
[dochtml] OSError: /var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py:docstring of sage.combinat.tableau.Tableaux.Element.promotion:40: WARNING: Duplicate explicit target name: "hai1992".
```




---

archive/issue_comments_387150.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-23T23:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387150",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387151.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-07-23T23:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387151",
    "user": "@jhpalmieri"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_387152.json:
```json
{
    "body": "This should fix the problem.",
    "created_at": "2019-07-23T23:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387152",
    "user": "@jhpalmieri"
}
```

This should fix the problem.



---

archive/issue_comments_387153.json:
```json
{
    "body": "Now the pdf docs are broken\n\n```\n[docpdf] Underfull \\hbox (badness 10000) in paragraph at lines 4766--4767\n[docpdf] \\T1/ptm/m/n/10 Bases: [][]\\T1/pcr/m/n/10 sage.categories.category_with_axiom.\n[docpdf] \n[docpdf] ! LaTeX Error: Too deeply nested.\n[docpdf] \n[docpdf] See the LaTeX manual or LaTeX Companion for explanation.\n[docpdf] Type  H <return>  for immediate help.\n[docpdf]  ...                                              \n[docpdf]                                                   \n[docpdf] l.4779 \\begin{itemize}\n[docpdf]                       \n[docpdf] ? \n[docpdf] ! Emergency stop.\n[docpdf]  ...                                              \n```\n",
    "created_at": "2019-07-27T22:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387153",
    "user": "@vbraun"
}
```

Now the pdf docs are broken

```
[docpdf] Underfull \hbox (badness 10000) in paragraph at lines 4766--4767
[docpdf] \T1/ptm/m/n/10 Bases: [][]\T1/pcr/m/n/10 sage.categories.category_with_axiom.
[docpdf] 
[docpdf] ! LaTeX Error: Too deeply nested.
[docpdf] 
[docpdf] See the LaTeX manual or LaTeX Companion for explanation.
[docpdf] Type  H <return>  for immediate help.
[docpdf]  ...                                              
[docpdf]                                                   
[docpdf] l.4779 \begin{itemize}
[docpdf]                       
[docpdf] ? 
[docpdf] ! Emergency stop.
[docpdf]  ...                                              
```




---

archive/issue_comments_387154.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-07-27T22:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387154",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_387155.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-28T17:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387155",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387156.json:
```json
{
    "body": "Seems to have fixed pdf docs.",
    "created_at": "2019-07-28T17:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387156",
    "user": "@kwankyu"
}
```

Seems to have fixed pdf docs.



---

archive/issue_comments_387157.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-07-28T17:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387157",
    "user": "@kwankyu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_387158.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-29T06:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387158",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_387159.json:
```json
{
    "body": "The last commit makes aliases of nested classes documented.\n\nIt looks all good to me. But the nested class stuff of Sage is very subtle, and these changes might have unexpected effects at unexpected places in the documentation. \n\nPlease check the generated docs carefully, before we move on.",
    "created_at": "2019-07-29T06:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387159",
    "user": "@kwankyu"
}
```

The last commit makes aliases of nested classes documented.

It looks all good to me. But the nested class stuff of Sage is very subtle, and these changes might have unexpected effects at unexpected places in the documentation. 

Please check the generated docs carefully, before we move on.



---

archive/issue_comments_387160.json:
```json
{
    "body": "Needs rebasing on top of 8.9.beta4.",
    "created_at": "2019-07-29T07:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387160",
    "user": "@kiwifb"
}
```

Needs rebasing on top of 8.9.beta4.



---

archive/issue_comments_387161.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-07-29T07:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387161",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_387162.json:
```json
{
    "body": "With the new version, attributes appear in the reference manual. This is a change, but it is fine with me.",
    "created_at": "2019-07-29T22:44:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387162",
    "user": "@jhpalmieri"
}
```

With the new version, attributes appear in the reference manual. This is a change, but it is fine with me.



---

archive/issue_comments_387163.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-29T23:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387163",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_387164.json:
```json
{
    "body": "That's the only real difference, as far as I can tell. There may be some small differences in the indices (files like http://doc.sagemath.org/html/en/reference/genindex-A.html), as well, but very minor ones. I am happy with this.\n\n(Edit: I built docs with both Python 2 and Python 3, with and without this branch, and ran `diff -r ...` on the resulting doc directories, so I could see all of the differences. I only checked the `html` and `latex` output.)",
    "created_at": "2019-07-29T23:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387164",
    "user": "@jhpalmieri"
}
```

That's the only real difference, as far as I can tell. There may be some small differences in the indices (files like http://doc.sagemath.org/html/en/reference/genindex-A.html), as well, but very minor ones. I am happy with this.

(Edit: I built docs with both Python 2 and Python 3, with and without this branch, and ran `diff -r ...` on the resulting doc directories, so I could see all of the differences. I only checked the `html` and `latex` output.)



---

archive/issue_comments_387165.json:
```json
{
    "body": "I am also happy with more documentation. Just for the record, more members of a class, like attributes and aliases, now appear in the documentation because of a  change in `skip_member` function defined in `sage/docs/conf.py`, which used to skip them for documentation:\n\n```\n     objname = getattr(obj, \"__name__\", None)\n     if objname is not None:\n-        if objname.find('.') != -1 and objname.split('.')[-1] != name:\n-            return True\n+        # check if name was inserted to the module by NestedClassMetaclass\n+        if name.find('.') != -1 and objname.find('.') != -1:\n+            if objname.split('.')[-1] == name.split('.')[-1]:\n+                return True\n \n     if name.find(\"userchild_download_worksheets.zip\") != -1:\n         return True\n```\n",
    "created_at": "2019-07-30T01:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387165",
    "user": "@kwankyu"
}
```

I am also happy with more documentation. Just for the record, more members of a class, like attributes and aliases, now appear in the documentation because of a  change in `skip_member` function defined in `sage/docs/conf.py`, which used to skip them for documentation:

```
     objname = getattr(obj, "__name__", None)
     if objname is not None:
-        if objname.find('.') != -1 and objname.split('.')[-1] != name:
-            return True
+        # check if name was inserted to the module by NestedClassMetaclass
+        if name.find('.') != -1 and objname.find('.') != -1:
+            if objname.split('.')[-1] == name.split('.')[-1]:
+                return True
 
     if name.find("userchild_download_worksheets.zip") != -1:
         return True
```




---

archive/issue_comments_387166.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-08-01T22:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27455",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27455#issuecomment-387166",
    "user": "@vbraun"
}
```

Resolution: fixed
