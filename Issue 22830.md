# Issue 22830: Upgrade R to 3.4.0

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2017-05-24 04:55:37

CC:  embray jpflori

Keywords: r-project

Usual reasons (working on an u-to-date R is a perequirement to get answers from the R Core Team on r-help...)

The new upstream version has been released almost a month ago.


---

Comment by charpent created at 2017-05-24 05:00:31

Changing status from new to needs_review.


---

Comment by charpent created at 2017-05-24 05:00:31

Merged with #22989 (which `needs_review`, BTW), passes `ptestlong` with the usual transient failure `sage -t --long src/sage/homology/simplicial_complex.py  # 1 doctest failed`, which passes when run standalone.

==>`needs_review`
----
New commits:


---

Comment by charpent created at 2017-05-24 05:07:27

Note : I am not sure that we are still justified to keep `patches/libcurl_https_support.patch`, which drops upstream's requirement of https support in libcurl.

This is unnecessary on Linux. I seem to remember that this was introduced to ease cygwin and/or OS/X compilation. Is that still the case ?


---

Comment by charpent created at 2017-05-24 06:42:16

Forgot to add : This R passes its own test suite (`sage -f -c r` succeeds, i. e. some failures are expected).

Note that in order to pass it, you HAVE to have en_GB.utf8 configured in your locales. This is also true of the original unpatched R. Note also that the test suite passes much more slowly in Sage than it does on the original unpatched R ; I do not yet know why.


---

Comment by charpent created at 2017-05-27 06:53:27

Wups ! Forgot to point to the upstream tarball...  Fixed now.


---

Comment by jpflori created at 2017-05-30 10:23:50

Replying to [comment:3 charpent]:
> Note : I am not sure that we are still justified to keep `patches/libcurl_https_support.patch`, which drops upstream's requirement of https support in libcurl.
> 
> This is unnecessary on Linux. I seem to remember that this was introduced to ease cygwin and/or OS/X compilation. Is that still the case ?
I guess so. Did anything change upstream?
I cannot see anything relevant in the changelog.


---

Comment by charpent created at 2017-06-04 21:53:06

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2017-06-04 21:53:06

This installs cleanly on Debian testing and on Ubuntu-over-WSL, but fails to install on cygwin. Reason nunuderstandable (the installation of the recommended packages "stats" seems to need under Cygwin  a post-compilation step unneeded on Linux, which fails : rebasing needed ?)

==> `needs_work`

Help needed from people knowing cygwin better than I do.

Also : no news from the Maoc OS X front (I don't have that in my zoo...), and Apple's shenanigans with SSL have caused trouble for R in the past...


---

Comment by embray created at 2017-06-20 12:25:36

I'm having a look at the Cygwin build issue.


---

Comment by embray created at 2017-06-20 13:28:29

FWIW the failure I get is:


```
[r-3.4.0.p0] make[7]: Entering directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/r-3.4.0.p0/src/src/library/stats'
[r-3.4.0.p0] byte-compiling package 'stats'
[r-3.4.0.p0] Error in loadNamespace(j <- i[This is the Trac macro *1L* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1L-macro), c(lib.loc, .libPaths()), versionCheck = vI[This is the Trac macro *j* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#j-macro)) :
[r-3.4.0.p0]   object 'vI' not found
[r-3.4.0.p0] Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace
[r-3.4.0.p0] Execution halted
[r-3.4.0.p0] make[7]: *** [../../../share/make/lazycomp.mk:9: ../../../library/stats/R/stats.rdb] Error 1
```


No idea what any of this means.  Still investigating.


---

Comment by charpent created at 2017-06-20 13:43:50

Replying to [comment:9 embray]:
> FWIW the failure I get is:
> 
> {{{
> [r-3.4.0.p0] make[7]: Entering directory '/home/embray/src/sagemath/sage-cygwin/local/var/tmp/sage/build/r-3.4.0.p0/src/src/library/stats'
> [r-3.4.0.p0] byte-compiling package 'stats'
> [r-3.4.0.p0] Error in loadNamespace(j <- i[This is the Trac macro *1L* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1L-macro), c(lib.loc, .libPaths()), versionCheck = vI[This is the Trac macro *j* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#j-macro)) :
> [r-3.4.0.p0]   object 'vI' not found
> [r-3.4.0.p0] Calls: <Anonymous> ... namespaceImportFrom -> asNamespace -> loadNamespace
> [r-3.4.0.p0] Execution halted
> [r-3.4.0.p0] make[7]: *** [../../../share/make/lazycomp.mk:9: ../../../library/stats/R/stats.rdb] Error 1
> }}}

That's //exactly// the error I got (see the logs I sent ~ one week ago...).

> No idea what any of this means.

Neither do I. ISTR that I //thought// it might be a rebasing problem, but I can't remember how I went to this guess, nor what was its rationale...

> Still investigating.

Thank you //very much// : I'm out of my depth, here...


---

Comment by embray created at 2017-06-20 14:30:59

Well for starters there's a bug in R here.  The `object 'vI' not found` is referring to a variable that is defined [here](https://github.com/wch/r-source/blob/R-3-4-branch/src/library/base/R/namespace.R#L375), in a branch that is not being entered because the "package.rds" file, whatever that is, doesn't exist.  There's even a comment that reads:


```
        ## Can we rely on the existence of R-ng 'nsInfo.rds' and
        ## 'package.rds'?
        ## No, not during builds of standard packages
        ## stats4 depends on methods, but exports do not matter
```


I don't fully know what that means, but we are in fact building a standard package (the "stats" package) so this file, apparently, isn't guaranteed to exist.  The fact that later code uses a variable that isn't guaranteed to be defined is a bug.

Why this is being a problem on Cygwin and not on other platforms I don't know.


---

Comment by embray created at 2017-06-20 14:48:01

So on Linux I'm able to reproduce this bug by going into the built source, rm'ing `src/library/stats/Meta/package.rds` and then running `tools:::makeLazyLoading("stats")`.  What's interesting is that on Linux the "package.rds" file _does_ exist by this stage in the build process, whereas it does not on Cygwin.  The comment I quoted that "package.rds" should not be relied on for builds of standard packages seems to contradict the current state of things.

Now just need to figure out where "package.rds" gets generated and see why that's not happening on Cygwin.


---

Comment by embray created at 2017-06-20 15:25:38

Well this escalated quickly.  Turns out the "package.rds" files were not being written due to a segfault occurring during their processing, in the `strsplit` function.  The following snippet reproduces: `strsplit("Package", "\n[ \t\n]*\n", perl = TRUE)`.  It doesn't segfault with `perl = FALSE`.

Even worse, for some reason R's SIGSEGV handler isn't working and it causes R to exit with a zero return code, indicating success.  Weirdly, when I try to find out what was up with that, it seems like something is going horribly wrong in the signal handling.  When I try to run it in gdb it seems like R's SIGSEGV handler is not being called at all.  But when I run the process through strace, its SIGSEGV handler _is_ called.  So there's some shenanigans with the signal stack going on.

Finally, this doesn't break R's `make` because the target that generates these "package.rds" files is just a phony target called `mkdesc`, and the files it outputs are not specified anywhere as real prerequisites, so as far as `make` is concerned this rule succeeded an it proceeds under that assumption.


---

Comment by charpent created at 2017-06-20 15:36:04

Replying to [comment:13 embray]:
> Well this escalated quickly.  Turns out the "package.rds" files were not being written due to a segfault occurring during their processing, in the `strsplit` function.  The following snippet reproduces: `strsplit("Package", "\n[ \t\n]*\n", perl = TRUE)`.  It doesn't segfault with `perl = FALSE`.

Does this happen
    a. on Cygwin only, or
    b. on Linux also ?

> Even worse, for some reason R's SIGSEGV handler isn't working and it causes R to exit with a zero return code, indicating success.  Weirdly, when I try to find out what was up with that, it seems like something is going horribly wrong in the signal handling.  When I try to run it in gdb it seems like R's SIGSEGV handler is not being called at all.  But when I run the process through strace, its SIGSEGV handler _is_ called.  So there's some shenanigans with the signal stack going on.

Same question : is this Cygwin-specific, or can it be reproduced on Linux (the successful compilation of R being just an happenstance) ?

> Finally, this doesn't break R's `make` because the target that generates these "package.rds" files is just a phony target called `mkdesc`, and the files it outputs are not specified anywhere as real prerequisites, so as far as `make` is concerned this rule succeeded an it proceeds under that assumption.

**This** is a bug, notwithstanding it gets triggered on Linux or not. Don't you think that it should be reported upstream ?


---

Comment by embray created at 2017-06-20 15:44:51

I agree, the latter issue is a bug, as is the potentially undefined variable I mentioned earlier.

The other two issues seem to be Cygwin specific.  R is using `signaltstack` for its `SIGSEGV` handling, which Cygwin _does_ support, but I haven't seen too many programs that use this, so it could be buggy.  That's sort of a tangential issue though--the real problem is the segfault itself, which I will investigate now.


---

Comment by embray created at 2017-06-20 16:12:19

Well I can't do anything more with this today.  I've traced the segfault to somewhere deep inside the `pcre_exec` function.  So I'm going to see if I can reproduce a simple example of this outside of R.   That would give us a better idea if it was just an issue with rebase or not.  I suspect not, because if were you wouldn't typically just get a segfault, but who knows.  More likely, since Sage compiles its own libpcre, I wouldn't be surprised if there's a bug in there somewhere.


---

Comment by embray created at 2017-06-21 08:31:00

There's a patch from Cygwin that purports to fix the segfault in pcre.  I'm trying it out now.


---

Comment by embray created at 2017-06-21 08:39:32

I should add, the bug causing the segfault makes such a mess of the stack that it _probably_ explains why the segfault wasn't being handled properly either, though I haven't examined the specifics closely, and it's probably not worth the trouble to.


---

Comment by embray created at 2017-06-21 08:51:59

Added #23291, which seems to fix the immediate build issue on Cygwin.  Still needs to test that the package actually _works_.


---

Comment by embray created at 2017-06-21 08:55:03

Well, the R interpreter at least starts up fine and seems to work.  That doesn't mean it's free of bugs, but the spkg-check for R is already known to have failures (#22866) so I think any other problems are outside the scope of this ticket, so long as it _builds_.


---

Comment by jpflori created at 2017-06-21 08:56:57

I support this statement.


---

Comment by charpent created at 2017-06-21 09:25:12

Do you (embray, jpflori) think that #23067+23291 is ready for review ? (BTW, #23291 is already at `positive_review`).

If so, I can do that tonight.


---

Comment by embray created at 2017-06-21 09:28:21

It looks good to me.  I'm not sure what you're saying you'll do tonight though.


---

Comment by embray created at 2017-06-21 09:28:21

Changing status from needs_work to positive_review.


---

Comment by charpent created at 2017-06-21 09:33:52

BTW : are you aware of a Mac user who might be solicited to test this on Mac OS X : Apple's shenanigans wit SLL (an, more generally, Xcode) has caused touble in the past...

Dima Pasechnik comes to mind, but seems awfukly busy nowadays...

Replying to [comment:22 charpent]:
> Do you (embray, jpflori) think that #23067+23291 is ready for review ? (BTW, #23291 is already at `positive_review`).
> 
> If so, I can do that tonight.


---

Comment by charpent created at 2017-06-21 09:38:40

Replying to [comment:23 embray]:
> It looks good to me.  I'm not sure what you're saying you'll do tonight though.

Just checking that starting from a fresh VM, I can obtain a working system (and install a few dozen R packages I happen to use more or less constantly).

But I agree that's just kicking the tyres... I also think that a similar tyre-kicking might be useful on Macs.

NB : the deletion of "Reviewer" has been done by Trac, not by me ! Setting it back.


---

Comment by vbraun created at 2017-06-25 15:45:21

Resolution: fixed
