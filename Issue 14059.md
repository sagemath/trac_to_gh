# Issue 14059: if build fails, print message about which spkgs failed

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2013-03-13 05:24:40

Assignee: GeorgSWeber

CC:  leif vbraun

Keywords: build fail

As the summary says. Attached is a first attempt at a patch.


---

Comment by jhpalmieri created at 2013-03-13 05:26:31

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2013-03-14 01:33:11

Note that this will give false positives if you try to install a package, it fails, and then you download a later version and install that one: any reports of errors will include the first version. I'm not sure how to deal with this without it getting too complicated.


---

Comment by vbraun created at 2013-03-14 01:58:30

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2013-03-14 01:58:30

Looks good to me. I think its clear enough what you have to do if you want to get rid of the error message (delete the log, that is) if you install different versions of a spkg and some fail.


---

Comment by leif created at 2013-03-14 04:45:57

Replying to [comment:4 vbraun]:
> Looks good to me.

WTF?  Flooding the terminal such that the messages get even less readable (if more than one package failed to build at least, and not necessarily in this attempt).

Why not first inspect `$SAGE_BUILD_DIR` (if set, `$SAGE_ROOT/spkg/build/` otherwise) unless `$SAGE_KEEP_BUILT_SPKGS=yes`?

If `$SAGE_PARALLEL_SPKG_BUILD!=yes`, the error should be obvious from previous messages, so I'd change the behaviour in that case.

IMHO we should really print _a list_ of the spkgs that _may_ have failed to build, along with the locations of their logs and build dirs (taking into account `$SAGE_BUILD_DIR`).

To only check recent logs, we should use `find ... -newer "$SAGE_ROOT/.BUILDSTART" ...` for the files to grep.  (We could in addition check whether `$SAGE_BUILD_DIR/package` is present, which should always be the case unless _the extraction_ of the spkg failed.)

----

`tail -n ...` of course works on Solaris; you just have to use the right one (`/usr/xpg4/bin/tail`). ;-)


---

Comment by vbraun created at 2013-03-14 15:19:32

If you volunteer to implement your feature requests I'll be happy to review the patch. But what we have in this ticket now is still worlds better than the current state (no usable error message at all), hence positive review.


---

Comment by jhpalmieri created at 2013-03-14 15:58:07

Replying to [comment:5 leif]:
> Replying to [comment:4 vbraun]:
> > Looks good to me.
> 
> WTF?  Flooding the terminal such that the messages get even less readable (if more than one package failed to build at least, and not necessarily in this attempt).

Here's a slightly modified version 2, which prints some text, then prints info for each failed package, then prints more text. The output looks like this:


```
***************************************************************
Error building Sage.

The following package(s) may have failed to build:

package: iconv-1.13.1.p4
log file: .../sage-5.8.beta4/spkg/logs/iconv-1.13.1.p4.log
build directory: .../iconv-1.13.1.p4

package: zlib-1.2.6.p0
log file: .../sage-5.8.beta4/spkg/logs/zlib-1.2.6.p0.log
build directory: .../zlib-1.2.6.p0

The build directory may contain configuration files and other potentially
helpful information. WARNING: if you now run 'make' again, the build
directory will, by default, be deleted. Set the environment variable
SAGE_KEEP_BUILT_SPKGS to 'yes' to prevent this.

make: *** [build] Error 1
```


> Why not first inspect `$SAGE_BUILD_DIR` (if set, `$SAGE_ROOT/spkg/build/` otherwise) unless `$SAGE_KEEP_BUILT_SPKGS=yes`?
> 
> If `$SAGE_PARALLEL_SPKG_BUILD!=yes`, the error should be obvious from previous messages, so I'd change the behaviour in that case.

I don't think it's worth making this too complicated.

> IMHO we should really print _a list_ of the spkgs that _may_ have failed to build, along with the locations of their logs and build dirs (taking into account `$SAGE_BUILD_DIR`).

I've tried to do something like that in the version 2 patch.

> To only check recent logs, we should use `find ... -newer "$SAGE_ROOT/.BUILDSTART" ...` for the files to grep.  (We could in addition check whether `$SAGE_BUILD_DIR/package` is present, which should always be the case unless _the extraction_ of the spkg failed.)

I _hate_ the `find` command. Every time I use it, it infuriates me. Someone else will have to write code using `find`.

> `tail -n ...` of course works on Solaris; you just have to use the right one (`/usr/xpg4/bin/tail`). ;-)

Right, so just `tail -n ...` doesn't work on Solaris.  We could of course have code for this which special cases every operating system we support, and it will be ugly and hard to maintain and no one will actually want to write it in the first place.


---

Comment by jhpalmieri created at 2013-03-14 15:59:18

Volker, do you think the "v2" patch is an improvement? I'm leaving the positive review the original patch in place, but if you want to look at the new one, that would be great.


---

Comment by vbraun created at 2013-03-14 18:25:06

Agreed, v2 is better.


---

Comment by jdemeyer created at 2013-03-14 23:14:39

You should use spaces, not TABs to indent Sage code.


---

Comment by jhpalmieri created at 2013-03-14 23:22:44

Sorry about that. Fixed.


---

Comment by jhpalmieri created at 2013-03-14 23:22:56

root repo


---

Comment by jdemeyer created at 2013-03-17 15:32:24

Resolution: fixed


---

Attachment
