# Issue 33862: %%gp magic hangs on useless function with new lines?

Issue created by migration from https://trac.sagemath.org/ticket/34099

Original creator: edgarcosta

Original creation time: 2022-06-29 17:59:21

Keywords: IPython magics gp


```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.4, Release Date: 2021-08-22                     │
│ Using Python 3.9.5. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
sage: %%gp
....: foo(n) = {return n;}
....:
....:

sage: %%gp
....: foo(n) = {
....:           return n;}
....:
^CInterrupting PARI/GP interpreter...
^C---------------------------------------------------------------------------
KeyboardInterrupt                         Traceback (most recent call last)
/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/interfaces/expect.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    982                     else:
--> 983                         E.expect(self._prompt)
    984                 except pexpect.EOF as msg:

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/spawnbase.py in expect(self, pattern, timeout, searchwindowsize, async_, **kw)
    342         compiled_pattern_list = self.compile_pattern_list(pattern)
--> 343         return self.expect_list(compiled_pattern_list,
    344                 timeout, searchwindowsize, async_)

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/spawnbase.py in expect_list(self, pattern_list, timeout, searchwindowsize, async_, **kw)
    371         else:
--> 372             return exp.expect_loop(timeout)
    373

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/expect.py in expect_loop(self, timeout)
    168                 # Still have time left, so read more data
--> 169                 incoming = spawn.read_nonblocking(spawn.maxread, timeout)
    170                 if self.spawn.delayafterread is not None:

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/pty_spawn.py in read_nonblocking(self, size, timeout)
    499         # (possibly timeout=None), we call select() with a timeout.
--> 500         if (timeout != 0) and select(timeout):
    501             return super(spawn, self).read_nonblocking(size)

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/pty_spawn.py in select(timeout)
    449             def select(timeout):
--> 450                 return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]
    451

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/utils.py in select_ignore_interrupts(iwtd, owtd, ewtd, timeout)
    142         try:
--> 143             return select.select(iwtd, owtd, ewtd, timeout)
    144         except InterruptedError:

src/cysignals/signals.pyx in cysignals.signals.python_check_interrupt()

KeyboardInterrupt:

During handling of the above exception, another exception occurred:

KeyboardInterrupt                         Traceback (most recent call last)
<ipython-input-1-5195279f6f1f> in <module>
----> 1 get_ipython().run_cell_magic('gp', '', 'foo(n) = {\n          return n;}\n          \n')

/home/sage/sage-9.4/local/lib/python3.9/site-packages/IPython/core/interactiveshell.py in run_cell_magic(self, magic_name, line, cell)
   2369             with self.builtin_trap:
   2370                 args = (magic_arg_s, cell)
-> 2371                 result = fn(*args, **kwargs)
   2372             return result
   2373

/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/repl/interface_magic.py in cell_magic(line, cell)
    294             if line:
    295                 raise SyntaxError('Interface magics have no options, got "{0}"'.format(line))
--> 296             output = self._interface.eval(cell)
    297             print(output)
    298         cell_magic.__doc__ = CELL_DOCSTRING.format(name=self._name)

/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/interfaces/expect.py in eval(self, code, strip, synchronize, locals, allow_use_file, split_lines, **kwds)
   1379                     return self._eval_line_using_file(code)
   1380                 elif split_lines:
-> 1381                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
   1382                                         for L in code.split('\n') if L != ''])
   1383                 else:

/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/interfaces/expect.py in <listcomp>(.0)
   1379                     return self._eval_line_using_file(code)
   1380                 elif split_lines:
-> 1381                     return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
   1382                                         for L in code.split('\n') if L != ''])
   1383                 else:

/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/interfaces/gp.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
    439         if len(line) == 0:
    440             return ''
--> 441         a = Expect._eval_line(self, line,
    442                               allow_use_file=allow_use_file,
    443                               wait_for_prompt=wait_for_prompt)

/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/interfaces/expect.py in _eval_line(self, line, allow_use_file, wait_for_prompt, restart_if_needed)
   1012                     out = ''
   1013         except KeyboardInterrupt:
-> 1014             self._keyboard_interrupt()
   1015             raise KeyboardInterrupt("Ctrl-c pressed while running %s" % self)
   1016         if self._terminal_echo:

/home/sage/sage-9.4/local/lib/python3.9/site-packages/sage/interfaces/expect.py in _keyboard_interrupt(self)
   1033             self._expect.sendline(chr(3))  # send ctrl-c
   1034             self._expect.expect(self._prompt)
-> 1035             self._expect.expect(self._prompt)
   1036             raise KeyboardInterrupt("Ctrl-c pressed while running %s" % self)
   1037

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/spawnbase.py in expect(self, pattern, timeout, searchwindowsize, async_, **kw)
    341
    342         compiled_pattern_list = self.compile_pattern_list(pattern)
--> 343         return self.expect_list(compiled_pattern_list,
    344                 timeout, searchwindowsize, async_)
    345

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/spawnbase.py in expect_list(self, pattern_list, timeout, searchwindowsize, async_, **kw)
    370             return expect_async(exp, timeout)
    371         else:
--> 372             return exp.expect_loop(timeout)
    373
    374     def expect_exact(self, pattern_list, timeout=-1, searchwindowsize=-1,

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/expect.py in expect_loop(self, timeout)
    167                     return self.timeout()
    168                 # Still have time left, so read more data
--> 169                 incoming = spawn.read_nonblocking(spawn.maxread, timeout)
    170                 if self.spawn.delayafterread is not None:
    171                     time.sleep(self.spawn.delayafterread)

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/pty_spawn.py in read_nonblocking(self, size, timeout)
    498         # is available right now. But if a non-zero timeout is given
    499         # (possibly timeout=None), we call select() with a timeout.
--> 500         if (timeout != 0) and select(timeout):
    501             return super(spawn, self).read_nonblocking(size)
    502

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/pty_spawn.py in select(timeout)
    448         else:
    449             def select(timeout):
--> 450                 return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]
    451
    452         # If there is data available to read right now, read as much as

/home/sage/sage-9.4/local/lib/python3.9/site-packages/pexpect/utils.py in select_ignore_interrupts(iwtd, owtd, ewtd, timeout)
    141     while True:
    142         try:
--> 143             return select.select(iwtd, owtd, ewtd, timeout)
    144         except InterruptedError:
    145             err = sys.exc_info()[1]

src/cysignals/signals.pyx in cysignals.signals.python_check_interrupt()

KeyboardInterrupt:
sage:
Exiting Sage (CPU time 0m0.34s, Wall time 1m7.66s).
Exiting PARI/GP interpreter with PID 1848065 running /home/sage/sage-9.4/local/bin/gp --fast --emacs --quiet --stacksize 10000000
```

