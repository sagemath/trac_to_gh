# Issue 28845: clean generated *.pc files

Issue created by migration from https://trac.sagemath.org/ticket/29082

Original creator: dimpase

Original creation time: 2020-01-26 12:40:13

CC:  embray mkoeppe jhpalmieri vbraun fbissey

#29003 introduced 2-stage installation of generated *.pc files, 
via `src/lib/pkgconfig`- but did not provide a way to clean them up at all. And this is a problem (cf. e.g. #29071).
 
At least `make distclean` should clean them, possibly even `make clean`, not sure about this.


---

Comment by dimpase created at 2020-01-26 12:43:32

Changing status from new to needs_info.


---

Comment by mkoeppe created at 2020-01-28 00:43:23

My suggestion would be to rewrite this as a script package instead of putting things into `src/`. This stuff really does not belong into `src/`.


---

Comment by mkoeppe created at 2020-01-28 01:00:14

Added #29071 as a dependency as it touches the same files.


---

Comment by mkoeppe created at 2020-01-28 01:01:30

Changing status from needs_info to needs_work.


---

Comment by mkoeppe created at 2020-01-28 01:06:32

(deleted a comment that was intended for #29071.)


---

Comment by mkoeppe created at 2020-01-28 01:19:20

(deleted a comment that was intended for #29071.)


---

Comment by dimpase created at 2020-01-28 09:03:08

Replying to [comment:2 mkoeppe]:
> My suggestion would be to rewrite this as a script package instead of putting things into `src/`. This stuff really does not belong into `src/`.

Perhaps we should just create `var/` next to `src/` and put these things there?


---

Comment by mkoeppe created at 2020-01-28 12:22:24

No, I don't think so. These are configure-generated files of sage-the-distribution - like `build/make/Makefile`. There's no need for a new top level.

Let me take care of this ticket after #29071 is done.


---

Comment by mkoeppe created at 2020-01-29 04:26:34

Last 10 new commits:


---

Comment by mkoeppe created at 2020-01-29 04:27:05

Branch is on top of #29051, #29071, #29084.
This is a first version, haven't tested much yet.


---

Comment by mkoeppe created at 2020-01-29 04:31:04

Tests run at https://github.com/mkoeppe/sage/actions/runs/32449719


---

Comment by mkoeppe created at 2020-01-31 15:59:35

Changing priority from blocker to major.


---

Comment by mkoeppe created at 2020-01-31 15:59:35

I will redo this on top of the hot fix - #29121.


---

Comment by git created at 2020-02-16 20:37:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-02-16 20:38:47

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-02-16 20:38:47

Rebased on 9.1.beta4


---

Comment by git created at 2020-02-22 23:52:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-02-22 23:53:38

Needs review.


---

Comment by git created at 2020-03-02 01:51:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2020-03-06 14:40:19

Agreed on the first two points in the description.

Don't agree on sage_system_blas_facade and the changes to Makefile.in.  I don't see how it's "special-purpose code".  It's a quite generic solution that you seem to be _replacing_ with "special-purpose code" that's very specific to openblas.  This ticket was needed for more than just blas.


---

Comment by embray created at 2020-03-06 14:42:49

Changing status from needs_review to needs_info.


---

Comment by mkoeppe created at 2020-03-07 03:32:09

Is my ticket handling the `gsl.pc` correctly? Which packages use this file?


---

Comment by dimpase created at 2020-03-19 03:31:40

I also don't quite understand the need to create a special script package, instead of adjusting `build/make/Makefile.in`.

Is there a technical problem?


---

Comment by mkoeppe created at 2020-03-19 03:49:07

It seemed to be an elegant solution when I wrote this a month ago


---

Comment by dimpase created at 2020-03-19 03:58:36

It seems that your package handles more that blas/lapack pc files, no?
Perhaps it just is wrongly named?


---

Comment by mkoeppe created at 2020-03-19 03:59:24

That's basically my question regarding gsl.pc above, I guess.


---

Comment by dimpase created at 2020-03-19 04:11:28

there is also a bug: PKG_CONFIG_PATH is pointing to the wrong directory, so these
newly installed pc files are not found:

```
(sage-sh) dima@fedora:sagetrac-mirror$ echo $PKG_CONFIG_PATH
/home/dima/sagetrac-mirror/local/lib/pkgconfig:.
(sage-sh) dima@fedora:sagetrac-mirror$ find . -name cblas.pc
./build/pkgs/sage_system_blas_facade/src/cblas.pc
./src/lib/pkgconfig/cblas.pc
```



---

Comment by dimpase created at 2020-03-19 04:14:53

oops, I mean, they are just not installed at all.
PKG_CONFIG_PATH is correct, but pc files are not there, or anywhere, except the old location


---

Comment by mkoeppe created at 2020-03-19 04:29:46

Feel free to make changes -- otherwise I can look into it tomorrow


---

Comment by mkoeppe created at 2020-03-19 04:34:10

What does `build/pkgs/sage_system_blas_facade/spkg-install` look like on your machine?


---

Comment by dimpase created at 2020-03-19 04:40:03

here it is:
{{{#! /usr/bin/env bash
PCFILES="blas.pccblas.pclapack.pc"
SAGE_PKGCONFIG="$SAGE_LOCAL/lib/pkgconfig"
mkdir -p "$SAGE_PKGCONFIG"
if [ -n "$PCFILES" ]; then
   cd build/pkgs/sage_system_blas_facade/src && cp -P $PCFILES "$SAGE_PKGCONFIG"
fi
```

also note that the original openblas.pc is in SAGE_ROOT


---

Comment by mkoeppe created at 2020-03-19 04:58:50

Looks like some spaces are missing


---

Comment by dimpase created at 2020-03-19 06:47:02

indeed, one needs

```diff
--- a/build/pkgs/openblas/spkg-configure.m4
+++ b/build/pkgs/openblas/spkg-configure.m4
@@ -37,7 +37,7 @@ SAGE_SPKG_CONFIGURE([openblas], [dnl CHECK
        m4_foreach([blaslibnam], [blas, cblas, lapack], [
         AS_IF([test x$sage_install_]blaslibnam[_pc = xyes], [
          AC_CONFIG_LINKS([build/pkgs/sage_system_blas_facade/src/]blaslibnam[.pc:$OPENBLASPCDIR/openblas.pc])
-         AS_VAR_APPEND([SAGE_SYSTEM_BLAS_FACADE_PC_FILES], blaslibnam[.pc])])
+         AS_VAR_APPEND([SAGE_SYSTEM_BLAS_FACADE_PC_FILES], [blaslibnam[.pc]' '])])
          AC_SUBST([SAGE_BLAS], [sage_system_blas_facade])
        ])
     ])
```



---

Comment by dimpase created at 2020-03-19 13:39:54

but this does not make any difference. As far as I can see, `spkg-install` of `sage_system_blas_facade` never gets run - I'm lost in untangling the reason for this.


---

Comment by mkoeppe created at 2020-03-19 13:44:01

OK, I'll take care of it later today.


---

Comment by dimpase created at 2020-03-19 15:11:23

Changing status from needs_info to needs_work.


---

Comment by git created at 2020-03-20 22:44:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-20 22:44:34

Branch is on top of #29287


---

Comment by git created at 2020-03-21 02:05:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-21 02:08:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-21 08:13:53

Changing priority from major to blocker.


---

Comment by dimpase created at 2020-03-21 08:13:53

this prevents building on Fedora after distclean


---

Comment by mkoeppe created at 2020-03-21 12:36:31

I'm working on a simpler version of this ticket.


---

Comment by git created at 2020-03-21 18:30:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-03-21 18:31:29

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-03-21 18:34:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-21 19:33:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-22 02:13:23

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-03-22 02:13:23

Error with gsl.pc for `local-homebrew-macos-standard` - https://github.com/mkoeppe/sage/runs/524361197


---

Comment by mkoeppe created at 2020-03-22 02:15:04

also `ubuntu-bionic-standard` (sagelib and cvxopt)


---

Comment by git created at 2020-03-22 02:59:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-22 02:59:20

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-22 02:59:45

Tests run at https://github.com/mkoeppe/sage/actions/runs/60588138


---

Comment by dimpase created at 2020-03-22 09:10:02

OK, this does the needed job. Perhaps the make rules could be made less explicit, but OK.


---

Comment by dimpase created at 2020-03-22 09:10:02

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-22 09:27:10

Thanks!


---

Comment by vbraun created at 2020-03-23 23:22:26

Make distclean deletes `src/lib/pkgconfig/.gitignore`


---

Comment by vbraun created at 2020-03-23 23:22:26

Changing status from positive_review to needs_work.


---

Comment by git created at 2020-03-23 23:26:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-23 23:27:13

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-03-24 03:32:11

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-24 03:32:11

ok. sorry for overlooking this.


---

Comment by mkoeppe created at 2020-03-24 03:33:21

Thanks


---

Comment by vbraun created at 2020-03-29 00:24:26

Resolution: fixed
