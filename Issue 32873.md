# Issue 32873: Some performance improvements in the manifolds code

archive/issues_032873.json:
```json
{
    "body": "Changes include:\n\n- use the first Bianchi identity in the computation of the Riemann tensor\n- compute volume forms with contravariant indices only as needed\n- don't try to simplify trivial expressions consisting only of a single number or symbolic variable\n\nIssue created by migration from https://trac.sagemath.org/ticket/33110\n\n",
    "created_at": "2022-01-02T18:09:09Z",
    "labels": [
        "component: manifolds",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "Some performance improvements in the manifolds code",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32873",
    "user": "https://github.com/spaghettisalat"
}
```
Changes include:

- use the first Bianchi identity in the computation of the Riemann tensor
- compute volume forms with contravariant indices only as needed
- don't try to simplify trivial expressions consisting only of a single number or symbolic variable

Issue created by migration from https://trac.sagemath.org/ticket/33110





---

archive/issue_comments_468270.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-02T18:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468270",
    "user": "https://github.com/spaghettisalat"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_468271.json:
```json
{
    "body": "Thanks for this ticket! I've added it to the metaticket #30525 (fill free to do it yourself for a next ticket related to manifolds) and will take a look in the coming days.",
    "created_at": "2022-01-03T19:24:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468271",
    "user": "https://github.com/egourgoulhon"
}
```

Thanks for this ticket! I've added it to the metaticket #30525 (fill free to do it yourself for a next ticket related to manifolds) and will take a look in the coming days.



---

archive/issue_comments_468272.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-11T13:41:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468272",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_468273.json:
```json
{
    "body": "This is very nice! Thanks a lot! I've just performed some minor tweaks (PEP 8 + adding you to AUTHOR fields) and pushed them in the above commit. \n\nWaiting for the patchbot green light for positive review.",
    "created_at": "2022-01-11T13:45:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468273",
    "user": "https://github.com/egourgoulhon"
}
```

This is very nice! Thanks a lot! I've just performed some minor tweaks (PEP 8 + adding you to AUTHOR fields) and pushed them in the above commit. 

Waiting for the patchbot green light for positive review.



---

archive/issue_comments_468274.json:
```json
{
    "body": "Regarding the computation of the Riemann tensor, I've performed some benchmarks with Kerr, Kerr-Newmann and 5D Kerr-AdS metrics, via these notebooks: [1](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), [2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb) and [3](https://cocalc.com/share/public_paths/9e8e6273e8459a7ee654e124ec5ce50825096b2b) respectively. I've have not noticed any significant speed-up. On your side, do you have any example with some net speed-up?",
    "created_at": "2022-01-11T13:53:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468274",
    "user": "https://github.com/egourgoulhon"
}
```

Regarding the computation of the Riemann tensor, I've performed some benchmarks with Kerr, Kerr-Newmann and 5D Kerr-AdS metrics, via these notebooks: [1](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), [2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb) and [3](https://cocalc.com/share/public_paths/9e8e6273e8459a7ee654e124ec5ce50825096b2b) respectively. I've have not noticed any significant speed-up. On your side, do you have any example with some net speed-up?



---

archive/issue_comments_468275.json:
```json
{
    "body": "On the other side, I've noticed a tremendous speed-up in the vector field plots, due to the treatment of expressions with a single term in simplifying functions. This is very welcome, until vector field plots are improved by using fast callable expressions (this will require a full rewriting of `VectorField.plot`, to make it not depend on `TangentVector.plot`, in some future ticket).",
    "created_at": "2022-01-11T14:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468275",
    "user": "https://github.com/egourgoulhon"
}
```

On the other side, I've noticed a tremendous speed-up in the vector field plots, due to the treatment of expressions with a single term in simplifying functions. This is very welcome, until vector field plots are improved by using fast callable expressions (this will require a full rewriting of `VectorField.plot`, to make it not depend on `TangentVector.plot`, in some future ticket).



---

archive/issue_comments_468276.json:
```json
{
    "body": "Replying to [comment:6 egourgoulhon]:\n> Regarding the computation of the Riemann tensor, I've performed some benchmarks with Kerr, Kerr-Newmann and 5D Kerr-AdS metrics, via these notebooks: [1](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), [2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb) and [3](https://cocalc.com/share/public_paths/9e8e6273e8459a7ee654e124ec5ce50825096b2b) respectively. I've have not noticed any significant speed-up. On your side, do you have any example with some net speed-up?\n\nI find a small speedup (about 3%) for the Kerr metric in the single-threaded case. The multi-threaded case is a little bit slower for me, but that is most certainly because some of the cores are inactive for a little longer due to the naive way that sage distributes the computation across multiple cores. One should really measure CPU usage instead of total time spent.\n\nBut in general my changes reduce the number of components that have to be calculated using contractions of the connection from n<sup>2</sup>(n-1)/2 to n(n<sup>2</sup>-1)/3 which in the best case for large n could be up to 33% faster. Of course, if the computation time is dominated by the final simplification step after the contraction (or subtraction when using the Bianchi-identity) has been performed, then there won't be much of a speedup. I suspect that this is the case in your examples which have quite complicated Riemann tensors.",
    "created_at": "2022-01-11T15:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468276",
    "user": "https://github.com/spaghettisalat"
}
```

Replying to [comment:6 egourgoulhon]:
> Regarding the computation of the Riemann tensor, I've performed some benchmarks with Kerr, Kerr-Newmann and 5D Kerr-AdS metrics, via these notebooks: [1](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), [2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb) and [3](https://cocalc.com/share/public_paths/9e8e6273e8459a7ee654e124ec5ce50825096b2b) respectively. I've have not noticed any significant speed-up. On your side, do you have any example with some net speed-up?

I find a small speedup (about 3%) for the Kerr metric in the single-threaded case. The multi-threaded case is a little bit slower for me, but that is most certainly because some of the cores are inactive for a little longer due to the naive way that sage distributes the computation across multiple cores. One should really measure CPU usage instead of total time spent.

But in general my changes reduce the number of components that have to be calculated using contractions of the connection from n<sup>2</sup>(n-1)/2 to n(n<sup>2</sup>-1)/3 which in the best case for large n could be up to 33% faster. Of course, if the computation time is dominated by the final simplification step after the contraction (or subtraction when using the Bianchi-identity) has been performed, then there won't be much of a speedup. I suspect that this is the case in your examples which have quite complicated Riemann tensors.



---

archive/issue_comments_468277.json:
```json
{
    "body": "Replying to [comment:8 gh-spaghettisalat]:\n\nThanks for your answer.\n\n> Of course, if the computation time is dominated by the final simplification step after the contraction (or subtraction when using the Bianchi-identity) has been performed, then there won't be much of a speedup. I suspect that this is the case in your examples which have quite complicated Riemann tensors.\n\nYes. Most probably, in the case I've considered the computation time is dominated by the `gam_gam` term, which involves multiplication of connection coefficients and which is computed for the full range of indices, irrespective of the Bianchi identity.",
    "created_at": "2022-01-11T16:20:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468277",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:8 gh-spaghettisalat]:

Thanks for your answer.

> Of course, if the computation time is dominated by the final simplification step after the contraction (or subtraction when using the Bianchi-identity) has been performed, then there won't be much of a speedup. I suspect that this is the case in your examples which have quite complicated Riemann tensors.

Yes. Most probably, in the case I've considered the computation time is dominated by the `gam_gam` term, which involves multiplication of connection coefficients and which is computed for the full range of indices, irrespective of the Bianchi identity.



---

archive/issue_comments_468278.json:
```json
{
    "body": "Replying to [comment:5 egourgoulhon]:\n> \n> Waiting for the patchbot green light for positive review. \n\nWell after 2 weeks, the patchbot has not shown up... I am setting the ticket to positive review without waiting any further, since all doctests are passed on my computer and the doc builds (both html and pdf).",
    "created_at": "2022-01-26T16:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468278",
    "user": "https://github.com/egourgoulhon"
}
```

Replying to [comment:5 egourgoulhon]:
> 
> Waiting for the patchbot green light for positive review. 

Well after 2 weeks, the patchbot has not shown up... I am setting the ticket to positive review without waiting any further, since all doctests are passed on my computer and the doc builds (both html and pdf).



---

archive/issue_comments_468279.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-01-26T16:45:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468279",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_468280.json:
```json
{
    "body": "The ticket branch has not been merged in Sage 9.6.beta1. Maybe it is missing some patchbot green light. So I'm setting the status back to \"needs_review\" in order to catch the patchbot's attention.",
    "created_at": "2022-02-13T17:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468280",
    "user": "https://github.com/egourgoulhon"
}
```

The ticket branch has not been merged in Sage 9.6.beta1. Maybe it is missing some patchbot green light. So I'm setting the status back to "needs_review" in order to catch the patchbot's attention.



---

archive/issue_comments_468281.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-02-13T17:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468281",
    "user": "https://github.com/egourgoulhon"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_468282.json:
```json
{
    "body": "There is some order that the tickets get merged in, but I don't quite understand what that is.",
    "created_at": "2022-02-14T04:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468282",
    "user": "https://github.com/tscrim"
}
```

There is some order that the tickets get merged in, but I don't quite understand what that is.



---

archive/issue_comments_468283.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-14T04:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468283",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_029785.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2022-02-16T23:56:35Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32873#event-29785"
}
```



---

archive/issue_comments_468284.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-16T23:56:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32873#issuecomment-468284",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
