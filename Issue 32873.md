# Issue 32873: Some performance improvements in the manifolds code

Issue created by migration from https://trac.sagemath.org/ticket/33110

Original creator: @spaghettisalat

Original creation time: 2022-01-02 18:09:09

Changes include:

- use the first Bianchi identity in the computation of the Riemann tensor
- compute volume forms with contravariant indices only as needed
- don't try to simplify trivial expressions consisting only of a single number or symbolic variable


---

Comment by @spaghettisalat created at 2022-01-02 18:09:18

Changing status from new to needs_review.


---

Comment by egourgoulhon created at 2022-01-03 19:24:14

Thanks for this ticket! I've added it to the metaticket #30525 (fill free to do it yourself for a next ticket related to manifolds) and will take a look in the coming days.


---

Comment by git created at 2022-01-11 13:41:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2022-01-11 13:45:11

This is very nice! Thanks a lot! I've just performed some minor tweaks (PEP 8 + adding you to AUTHOR fields) and pushed them in the above commit. 

Waiting for the patchbot green light for positive review.


---

Comment by egourgoulhon created at 2022-01-11 13:53:32

Regarding the computation of the Riemann tensor, I've performed some benchmarks with Kerr, Kerr-Newmann and 5D Kerr-AdS metrics, via these notebooks: [1](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), [2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb) and [3](https://cocalc.com/share/public_paths/9e8e6273e8459a7ee654e124ec5ce50825096b2b) respectively. I've have not noticed any significant speed-up. On your side, do you have any example with some net speed-up?


---

Comment by egourgoulhon created at 2022-01-11 14:10:01

On the other side, I've noticed a tremendous speed-up in the vector field plots, due to the treatment of expressions with a single term in simplifying functions. This is very welcome, until vector field plots are improved by using fast callable expressions (this will require a full rewriting of `VectorField.plot`, to make it not depend on `TangentVector.plot`, in some future ticket).


---

Comment by @spaghettisalat created at 2022-01-11 15:56:19

Replying to [comment:6 egourgoulhon]:
> Regarding the computation of the Riemann tensor, I've performed some benchmarks with Kerr, Kerr-Newmann and 5D Kerr-AdS metrics, via these notebooks: [1](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr.ipynb), [2](https://nbviewer.org/github/sagemanifolds/SageManifolds/blob/master/Notebooks/SM_Kerr_Newman.ipynb) and [3](https://cocalc.com/share/public_paths/9e8e6273e8459a7ee654e124ec5ce50825096b2b) respectively. I've have not noticed any significant speed-up. On your side, do you have any example with some net speed-up?

I find a small speedup (about 3%) for the Kerr metric in the single-threaded case. The multi-threaded case is a little bit slower for me, but that is most certainly because some of the cores are inactive for a little longer due to the naive way that sage distributes the computation across multiple cores. One should really measure CPU usage instead of total time spent.

But in general my changes reduce the number of components that have to be calculated using contractions of the connection from n<sup>2</sup>(n-1)/2 to n(n<sup>2</sup>-1)/3 which in the best case for large n could be up to 33% faster. Of course, if the computation time is dominated by the final simplification step after the contraction (or subtraction when using the Bianchi-identity) has been performed, then there won't be much of a speedup. I suspect that this is the case in your examples which have quite complicated Riemann tensors.


---

Comment by egourgoulhon created at 2022-01-11 16:20:15

Replying to [comment:8 gh-spaghettisalat]:

Thanks for your answer.

> Of course, if the computation time is dominated by the final simplification step after the contraction (or subtraction when using the Bianchi-identity) has been performed, then there won't be much of a speedup. I suspect that this is the case in your examples which have quite complicated Riemann tensors.

Yes. Most probably, in the case I've considered the computation time is dominated by the `gam_gam` term, which involves multiplication of connection coefficients and which is computed for the full range of indices, irrespective of the Bianchi identity.


---

Comment by egourgoulhon created at 2022-01-26 16:45:50

Replying to [comment:5 egourgoulhon]:
> 
> Waiting for the patchbot green light for positive review. 

Well after 2 weeks, the patchbot has not shown up... I am setting the ticket to positive review without waiting any further, since all doctests are passed on my computer and the doc builds (both html and pdf).


---

Comment by egourgoulhon created at 2022-01-26 16:45:50

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2022-02-13 17:49:47

The ticket branch has not been merged in Sage 9.6.beta1. Maybe it is missing some patchbot green light. So I'm setting the status back to "needs_review" in order to catch the patchbot's attention.


---

Comment by egourgoulhon created at 2022-02-13 17:49:47

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2022-02-14 04:07:05

There is some order that the tickets get merged in, but I don't quite understand what that is.


---

Comment by tscrim created at 2022-02-14 04:07:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-16 23:56:35

Resolution: fixed
