# Issue 12086: Prune .hgtags files

archive/issues_012086.json:
```json
{
    "body": "Assignee: @nexttime\n\nKeywords: .hgtags mercurial repository\n\nOur `.hgtags` files have some cruft in them which I noticed when trying to import the Sage library into git. These patches remove invalid tag references in the `.hgtags` files.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12258\n\n",
    "created_at": "2012-01-03T23:21:14Z",
    "labels": [
        "component: scripts",
        "trivial",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Prune .hgtags files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12086",
    "user": "https://github.com/kini"
}
```
Assignee: @nexttime

Keywords: .hgtags mercurial repository

Our `.hgtags` files have some cruft in them which I noticed when trying to import the Sage library into git. These patches remove invalid tag references in the `.hgtags` files.

Issue created by migration from https://trac.sagemath.org/ticket/12258





---

archive/issue_comments_139927.json:
```json
{
    "body": "Attachment [trac_12258-local-bin.patch](tarball://root/attachments/some-uuid/ticket12258/trac_12258-local-bin.patch) by @kini created at 2012-01-03 23:37:37\n\napply to $SAGE_LOCAL",
    "created_at": "2012-01-03T23:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139927",
    "user": "https://github.com/kini"
}
```

Attachment [trac_12258-local-bin.patch](tarball://root/attachments/some-uuid/ticket12258/trac_12258-local-bin.patch) by @kini created at 2012-01-03 23:37:37

apply to $SAGE_LOCAL



---

archive/issue_comments_139928.json:
```json
{
    "body": "apply to $SAGE_ROOT/devel/sage",
    "created_at": "2012-01-03T23:38:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139928",
    "user": "https://github.com/kini"
}
```

apply to $SAGE_ROOT/devel/sage



---

archive/issue_comments_139929.json:
```json
{
    "body": "Attachment [trac_12258-devel-sage.patch](tarball://root/attachments/some-uuid/ticket12258/trac_12258-devel-sage.patch) by @kini created at 2012-01-03 23:39:21\n\napply to $SAGE_DATA/extcode",
    "created_at": "2012-01-03T23:39:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139929",
    "user": "https://github.com/kini"
}
```

Attachment [trac_12258-devel-sage.patch](tarball://root/attachments/some-uuid/ticket12258/trac_12258-devel-sage.patch) by @kini created at 2012-01-03 23:39:21

apply to $SAGE_DATA/extcode



---

archive/issue_comments_139930.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-01-03T23:41:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139930",
    "user": "https://github.com/kini"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_139931.json:
```json
{
    "body": "Attachment [trac_12258-data-extcode.patch](tarball://root/attachments/some-uuid/ticket12258/trac_12258-data-extcode.patch) by @kini created at 2012-01-03 23:41:09",
    "created_at": "2012-01-03T23:41:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139931",
    "user": "https://github.com/kini"
}
```

Attachment [trac_12258-data-extcode.patch](tarball://root/attachments/some-uuid/ticket12258/trac_12258-data-extcode.patch) by @kini created at 2012-01-03 23:41:09



---

archive/issue_comments_139932.json:
```json
{
    "body": "Oh, here is the code I used to generate this patch:\n\n\n```python\n#!/usr/bin/env python\n\nimport subprocess\n\nreal_tags = subprocess.check_output('hg tags', shell=True).splitlines()\nreal_tags = [x.split(':')[1] for x in real_tags]\n\ninfile = open('.hgtags')\ntags = infile.read().splitlines()\ninfile.close()\noutfile = open('.hgtags', 'w')\n\nfor tag in tags:\n    if tag[:12] in real_tags:\n        outfile.write(tag)\n        outfile.write('\\n')\n\noutfile.close()\n```\n\n\nBasically it checks what tags Mercurial itself is able to find when it reads the `.hgtags` file, against what is actually in the `.hgtags` file, and deletes any invalid tags which Mercurial is not recognizing. I ran the script on all the Mercurial repositories in the Sage source distribution which had a `.hgtags` file.",
    "created_at": "2012-01-04T10:10:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139932",
    "user": "https://github.com/kini"
}
```

Oh, here is the code I used to generate this patch:


```python
#!/usr/bin/env python

import subprocess

real_tags = subprocess.check_output('hg tags', shell=True).splitlines()
real_tags = [x.split(':')[1] for x in real_tags]

infile = open('.hgtags')
tags = infile.read().splitlines()
infile.close()
outfile = open('.hgtags', 'w')

for tag in tags:
    if tag[:12] in real_tags:
        outfile.write(tag)
        outfile.write('\n')

outfile.close()
```


Basically it checks what tags Mercurial itself is able to find when it reads the `.hgtags` file, against what is actually in the `.hgtags` file, and deletes any invalid tags which Mercurial is not recognizing. I ran the script on all the Mercurial repositories in the Sage source distribution which had a `.hgtags` file.



---

archive/issue_comments_139933.json:
```json
{
    "body": "Patches look good. I get the same output as the deleted lines in the patches with the following bash/zsh code:\n\n```\n...ons/sage-4.7.2/devel/sage> hgtags=\"$(hg tags)\"; while read line; do\n    if ! echo -e \"${hgtags}\" | grep -qE \"${line:0:12}$\"; then\n        echo \"$line\"\n    fi\ndone < .hgtags\n```\n\nAfter applying the patches, there is no more output to the above command.",
    "created_at": "2012-01-04T16:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139933",
    "user": "https://github.com/ppurka"
}
```

Patches look good. I get the same output as the deleted lines in the patches with the following bash/zsh code:

```
...ons/sage-4.7.2/devel/sage> hgtags="$(hg tags)"; while read line; do
    if ! echo -e "${hgtags}" | grep -qE "${line:0:12}$"; then
        echo "$line"
    fi
done < .hgtags
```

After applying the patches, there is no more output to the above command.



---

archive/issue_comments_139934.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-01-04T16:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139934",
    "user": "https://github.com/ppurka"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_139935.json:
```json
{
    "body": "Thanks for the review, ppurka!",
    "created_at": "2012-01-04T17:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139935",
    "user": "https://github.com/kini"
}
```

Thanks for the review, ppurka!



---

archive/issue_comments_139936.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-01-05T07:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12086",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12086#issuecomment-139936",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
