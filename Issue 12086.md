# Issue 12086: Prune .hgtags files

Issue created by migration from https://trac.sagemath.org/ticket/12258

Original creator: kini

Original creation time: 2012-01-03 23:21:14

Assignee: leif

Keywords: .hgtags mercurial repository

Our `.hgtags` files have some cruft in them which I noticed when trying to import the Sage library into git. These patches remove invalid tag references in the `.hgtags` files.


---

Attachment

apply to $SAGE_LOCAL


---

Comment by kini created at 2012-01-03 23:38:00

apply to $SAGE_ROOT/devel/sage


---

Attachment

apply to $SAGE_DATA/extcode


---

Comment by kini created at 2012-01-03 23:41:09

Changing status from new to needs_review.


---

Attachment


---

Comment by kini created at 2012-01-04 10:10:27

Oh, here is the code I used to generate this patch:


```python
#!/usr/bin/env python

import subprocess

real_tags = subprocess.check_output('hg tags', shell=True).splitlines()
real_tags = [x.split(':')[1] for x in real_tags]

infile = open('.hgtags')
tags = infile.read().splitlines()
infile.close()
outfile = open('.hgtags', 'w')

for tag in tags:
    if tag[:12] in real_tags:
        outfile.write(tag)
        outfile.write('\n')

outfile.close()
```


Basically it checks what tags Mercurial itself is able to find when it reads the `.hgtags` file, against what is actually in the `.hgtags` file, and deletes any invalid tags which Mercurial is not recognizing. I ran the script on all the Mercurial repositories in the Sage source distribution which had a `.hgtags` file.


---

Comment by ppurka created at 2012-01-04 16:57:33

Patches look good. I get the same output as the deleted lines in the patches with the following bash/zsh code:

```
...ons/sage-4.7.2/devel/sage> hgtags="$(hg tags)"; while read line; do
    if ! echo -e "${hgtags}" | grep -qE "${line:0:12}$"; then
        echo "$line"
    fi
done < .hgtags
```

After applying the patches, there is no more output to the above command.


---

Comment by ppurka created at 2012-01-04 16:57:33

Changing status from needs_review to positive_review.


---

Comment by kini created at 2012-01-04 17:12:10

Thanks for the review, ppurka!


---

Comment by jdemeyer created at 2012-01-05 07:49:15

Resolution: fixed
