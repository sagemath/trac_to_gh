# Issue 18853: cplex backend: return MIP relative gap

archive/issues_018853.json:
```json
{
    "body": "CC:  ncohen\n\nCurrently, when a timelimit is pass to a MIP solver, we can access the best integer solution found. However, we cannot access the best objective value and the optimality gap. This patch enable access to these values.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19090\n\n",
    "created_at": "2015-08-26T08:22:57Z",
    "labels": [
        "linear programming",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "cplex backend: return MIP relative gap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18853",
    "user": "dcoudert"
}
```
CC:  ncohen

Currently, when a timelimit is pass to a MIP solver, we can access the best integer solution found. However, we cannot access the best objective value and the optimality gap. This patch enable access to these values.

Issue created by migration from https://trac.sagemath.org/ticket/19090





---

archive/issue_comments_257985.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-26T09:55:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257985",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257986.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-08-26T10:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257986",
    "user": "dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_257987.json:
```json
{
    "body": "Hello,\n\nthis is the first draft. I can now do the following:\n\n```\nsage: G = graphs.MycielskiGraph(6)\nsage: from sage.numerical.mip import MixedIntegerLinearProgram\nsage: p = MixedIntegerLinearProgram(maximization=False, solver=\"Cplex\")\nsage: x = p.new_variable(binary=True, nonnegative=True)\nsage: obj = p.new_variable(integer=True, nonnegative=True)\nsage: for u in G.vertices():\n    p.add_constraint( p.sum( x[u,i] for i in range(G.order()) ) == 1 )\n....:     \nsage: for i in range(G.order()):\n    p.add_constraint( p.sum( x[u,i] for u in G.vertices() ) == 1 )\n....:     \nsage: for u,v in G.edges(labels=None):\n    p.add_constraint( p.sum( i*(x[u,i] - x[v,i]) for i in range(G.order()) ) <= obj['obj'] )\n    p.add_constraint( p.sum( i*(x[v,i] - x[u,i]) for i in range(G.order()) ) <= obj['obj'] )\n....:     \nsage: p.set_objective(obj['obj'])\nsage: p.solver_parameter(\"timelimit\", 5)\nsage: p.solve(log=1)\nTried aggregator 1 time.\nReduced MIP has 566 rows, 2210 columns, and 48314 nonzeros.\nReduced MIP has 2209 binaries, 1 generals, 0 SOSs, and 0 indicators.\nPresolve time = 0.01 sec. (15.25 ticks)\nFound incumbent of value 1081.000000 after 0.05 sec. (41.34 ticks)\nProbing time = 0.01 sec. (4.65 ticks)\nTried aggregator 1 time.\nReduced MIP has 566 rows, 2210 columns, and 48314 nonzeros.\nReduced MIP has 2209 binaries, 1 generals, 0 SOSs, and 0 indicators.\nPresolve time = 0.02 sec. (17.23 ticks)\nProbing time = 0.01 sec. (4.65 ticks)\nClique table members: 94.\nMIP emphasis: balance optimality and feasibility.\nMIP search method: dynamic search.\nParallel mode: deterministic, using up to 4 threads.\nRoot relaxation solution time = 0.03 sec. (26.66 ticks)\n\n        Nodes                                         Cuts/\n   Node  Left     Objective  IInf  Best Integer    Best Bound    ItCnt     Gap\n\n*     0+    0                         1081.0000        0.0000           100.00%\n*     0+    0                         1068.0000        0.0000           100.00%\n*     0+    0                         1055.0000        0.0000           100.00%\n*     0+    0                         1042.0000        0.0000           100.00%\n*     0+    0                         1029.0000        0.0000           100.00%\n*     0+    0                         1016.0000        0.0000           100.00%\n      0     0        0.0000   139     1016.0000        0.0000      326  100.00%\n*     0+    0                           44.0000        0.0000           100.00%\n*     0+    0                           32.0000        0.0000           100.00%\n      0     0        0.0000   190       32.0000     Cuts: 210     1308  100.00%\n      0     0        1.0000   129       32.0000     Cuts: 124     3312   96.87%\n*     0+    0                           31.0000        1.0000            96.77%\n      0     0        1.0000   213       31.0000     Cuts: 241     3976   96.77%\n*     0+    0                           30.0000        1.0000            96.67%\n*     0+    0                           29.0000        1.0000            96.55%\n\nRoot node processing (before b&c):\n  Real time             =    5.01 sec. (4033.26 ticks)\nParallel b&c, 4 threads:\n  Real time             =    0.00 sec. (0.00 ticks)\n  Sync time (average)   =    0.00 sec.\n  Wait time (average)   =    0.00 sec.\n                          ------------\nTotal (root+branch&cut) =    5.01 sec. (4033.26 ticks)\n29.0\nsage: bb = p.get_backend()\nsage: bb.get_objective_value()\n29.0\nsage: bb.get_best_objective_value()\n1.0\nsage: bb.get_relative_objective_gap()\n0.965517241375981\n```\n\n\nHowever, it's working only with cplex. For GLPK, I have to understand how to access\n\n```\nint glp_ios_best_node(glp_tree *tree);\n/* find active subproblem with best local bound */\n\ndouble glp_ios_mip_gap(glp_tree *tree);\n/* compute relative MIP gap */\n```\n\n\nAlso, I have enabled access to these methods only through the backends. I don't know if I should also add these methods to `mip.pxd/pyx`.\n\nDavid.",
    "created_at": "2015-08-26T10:13:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257987",
    "user": "dcoudert"
}
```

Hello,

this is the first draft. I can now do the following:

```
sage: G = graphs.MycielskiGraph(6)
sage: from sage.numerical.mip import MixedIntegerLinearProgram
sage: p = MixedIntegerLinearProgram(maximization=False, solver="Cplex")
sage: x = p.new_variable(binary=True, nonnegative=True)
sage: obj = p.new_variable(integer=True, nonnegative=True)
sage: for u in G.vertices():
    p.add_constraint( p.sum( x[u,i] for i in range(G.order()) ) == 1 )
....:     
sage: for i in range(G.order()):
    p.add_constraint( p.sum( x[u,i] for u in G.vertices() ) == 1 )
....:     
sage: for u,v in G.edges(labels=None):
    p.add_constraint( p.sum( i*(x[u,i] - x[v,i]) for i in range(G.order()) ) <= obj['obj'] )
    p.add_constraint( p.sum( i*(x[v,i] - x[u,i]) for i in range(G.order()) ) <= obj['obj'] )
....:     
sage: p.set_objective(obj['obj'])
sage: p.solver_parameter("timelimit", 5)
sage: p.solve(log=1)
Tried aggregator 1 time.
Reduced MIP has 566 rows, 2210 columns, and 48314 nonzeros.
Reduced MIP has 2209 binaries, 1 generals, 0 SOSs, and 0 indicators.
Presolve time = 0.01 sec. (15.25 ticks)
Found incumbent of value 1081.000000 after 0.05 sec. (41.34 ticks)
Probing time = 0.01 sec. (4.65 ticks)
Tried aggregator 1 time.
Reduced MIP has 566 rows, 2210 columns, and 48314 nonzeros.
Reduced MIP has 2209 binaries, 1 generals, 0 SOSs, and 0 indicators.
Presolve time = 0.02 sec. (17.23 ticks)
Probing time = 0.01 sec. (4.65 ticks)
Clique table members: 94.
MIP emphasis: balance optimality and feasibility.
MIP search method: dynamic search.
Parallel mode: deterministic, using up to 4 threads.
Root relaxation solution time = 0.03 sec. (26.66 ticks)

        Nodes                                         Cuts/
   Node  Left     Objective  IInf  Best Integer    Best Bound    ItCnt     Gap

*     0+    0                         1081.0000        0.0000           100.00%
*     0+    0                         1068.0000        0.0000           100.00%
*     0+    0                         1055.0000        0.0000           100.00%
*     0+    0                         1042.0000        0.0000           100.00%
*     0+    0                         1029.0000        0.0000           100.00%
*     0+    0                         1016.0000        0.0000           100.00%
      0     0        0.0000   139     1016.0000        0.0000      326  100.00%
*     0+    0                           44.0000        0.0000           100.00%
*     0+    0                           32.0000        0.0000           100.00%
      0     0        0.0000   190       32.0000     Cuts: 210     1308  100.00%
      0     0        1.0000   129       32.0000     Cuts: 124     3312   96.87%
*     0+    0                           31.0000        1.0000            96.77%
      0     0        1.0000   213       31.0000     Cuts: 241     3976   96.77%
*     0+    0                           30.0000        1.0000            96.67%
*     0+    0                           29.0000        1.0000            96.55%

Root node processing (before b&c):
  Real time             =    5.01 sec. (4033.26 ticks)
Parallel b&c, 4 threads:
  Real time             =    0.00 sec. (0.00 ticks)
  Sync time (average)   =    0.00 sec.
  Wait time (average)   =    0.00 sec.
                          ------------
Total (root+branch&cut) =    5.01 sec. (4033.26 ticks)
29.0
sage: bb = p.get_backend()
sage: bb.get_objective_value()
29.0
sage: bb.get_best_objective_value()
1.0
sage: bb.get_relative_objective_gap()
0.965517241375981
```


However, it's working only with cplex. For GLPK, I have to understand how to access

```
int glp_ios_best_node(glp_tree *tree);
/* find active subproblem with best local bound */

double glp_ios_mip_gap(glp_tree *tree);
/* compute relative MIP gap */
```


Also, I have enabled access to these methods only through the backends. I don't know if I should also add these methods to `mip.pxd/pyx`.

David.



---

archive/issue_comments_257988.json:
```json
{
    "body": "> this is the first draft. I can now do the following:\n\nCool!\n\n> However, it's working only with cplex. For GLPK, I have to understand how to access\n> {{{\n> int glp_ios_best_node(glp_tree *tree);\n> /* find active subproblem with best local bound */\n> \n> double glp_ios_mip_gap(glp_tree *tree);\n> /* compute relative MIP gap */\n> }}}\n\nWell, at least it seems possible.\n\n> Also, I have enabled access to these methods only through the backends. I don't know if I should also add these methods to `mip.pxd/pyx`.\n\nIf you figure out how to make it work for GPLK, then I'd say yes. I expect that we will find such a feature in all solvers, eventually.\n\nNathann",
    "created_at": "2015-08-26T10:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257988",
    "user": "ncohen"
}
```

> this is the first draft. I can now do the following:

Cool!

> However, it's working only with cplex. For GLPK, I have to understand how to access
> {{{
> int glp_ios_best_node(glp_tree *tree);
> /* find active subproblem with best local bound */
> 
> double glp_ios_mip_gap(glp_tree *tree);
> /* compute relative MIP gap */
> }}}

Well, at least it seems possible.

> Also, I have enabled access to these methods only through the backends. I don't know if I should also add these methods to `mip.pxd/pyx`.

If you figure out how to make it work for GPLK, then I'd say yes. I expect that we will find such a feature in all solvers, eventually.

Nathann



---

archive/issue_comments_257989.json:
```json
{
    "body": "I did multiple trials to use these methods with GLPK, but failed :(\nI don't know how to access the tree. It should be inside `glp_prob` and so `self.lp.tree` should be of type `glp_tree`, but I'm not able to make it work.",
    "created_at": "2015-08-26T13:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257989",
    "user": "dcoudert"
}
```

I did multiple trials to use these methods with GLPK, but failed :(
I don't know how to access the tree. It should be inside `glp_prob` and so `self.lp.tree` should be of type `glp_tree`, but I'm not able to make it work.



---

archive/issue_comments_257990.json:
```json
{
    "body": "Hellooooooo David !\n\nAt `u/ncohen/19090`, you will find a commit that lets you compute the relatve mip gap in GLPK. From there, more information cab easily be gathered, read and returned.\n\nEven though it seems that this information is gathered at every node, and not only once at the end of the exploring. The good news is that:\n- It is probably cheap.\n- We will see the callback function if we run a profiler, as it cannot be inlined.\n\nNathann",
    "created_at": "2015-08-31T11:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257990",
    "user": "ncohen"
}
```

Hellooooooo David !

At `u/ncohen/19090`, you will find a commit that lets you compute the relatve mip gap in GLPK. From there, more information cab easily be gathered, read and returned.

Even though it seems that this information is gathered at every node, and not only once at the end of the exploring. The good news is that:
- It is probably cheap.
- We will see the callback function if we run a profiler, as it cannot be inlined.

Nathann



---

archive/issue_comments_257991.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-31T12:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257991",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257992.json:
```json
{
    "body": "Thanks Nathann.\nI have completed your work with `GLPK` and added methods to enable access to these methods directly from the mip.\nBest,\nDavid.",
    "created_at": "2015-08-31T12:23:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257992",
    "user": "dcoudert"
}
```

Thanks Nathann.
I have completed your work with `GLPK` and added methods to enable access to these methods directly from the mip.
Best,
David.



---

archive/issue_comments_257993.json:
```json
{
    "body": "Helloooooo David,\n\nI find that the name of `get_best_objective_value` clashes heavily with what the method is supposed to do. When I read `get_best_objective_value`, all I can think of is that it returns the cost of the best solution found so far.\n\nWhat would you think of something like `best_known_objective_bound` instead ?\n\nSimilarly, the description of the function is sometimes confusing. I am not sure that I understand what \"the minimum objective function of all unexplored nodes\" means.\n\nWhat about something like that:\n\n---\nThis method returns the current best upper (resp. lower) bound on the optimal value of the objective function in a maximization (resp. minimization) problem. It is equal to the output of :meth:`get_objective_value` if the MILP found an optimal solution, but it can differ if it was interrupted manually or after a time limit (cf :meth:`solver_parameter`).\n---\n\nJust a proposition of course, we can modify whatever you don't like in this text.\n\nNathann",
    "created_at": "2015-08-31T12:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257993",
    "user": "ncohen"
}
```

Helloooooo David,

I find that the name of `get_best_objective_value` clashes heavily with what the method is supposed to do. When I read `get_best_objective_value`, all I can think of is that it returns the cost of the best solution found so far.

What would you think of something like `best_known_objective_bound` instead ?

Similarly, the description of the function is sometimes confusing. I am not sure that I understand what "the minimum objective function of all unexplored nodes" means.

What about something like that:

---
This method returns the current best upper (resp. lower) bound on the optimal value of the objective function in a maximization (resp. minimization) problem. It is equal to the output of :meth:`get_objective_value` if the MILP found an optimal solution, but it can differ if it was interrupted manually or after a time limit (cf :meth:`solver_parameter`).
---

Just a proposition of course, we can modify whatever you don't like in this text.

Nathann



---

archive/issue_comments_257994.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-31T14:02:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257994",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257995.json:
```json
{
    "body": "agreed.",
    "created_at": "2015-08-31T14:03:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257995",
    "user": "dcoudert"
}
```

agreed.



---

archive/issue_comments_257996.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-08-31T16:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257996",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257997.json:
```json
{
    "body": "Hello again,\n\nI fixed the doc a bit and added a commit on this public branch. If you agree with it, then let's get it merged.\n\nThanks for this ticket,\n\nNathann",
    "created_at": "2015-08-31T16:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257997",
    "user": "ncohen"
}
```

Hello again,

I fixed the doc a bit and added a commit on this public branch. If you agree with it, then let's get it merged.

Thanks for this ticket,

Nathann



---

archive/issue_comments_257998.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-01T08:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257998",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_257999.json:
```json
{
    "body": "Good to go?\n\nNathann",
    "created_at": "2015-09-01T09:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-257999",
    "user": "ncohen"
}
```

Good to go?

Nathann



---

archive/issue_comments_258000.json:
```json
{
    "body": "For me yes.\nThanks,\nDavid.",
    "created_at": "2015-09-01T09:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-258000",
    "user": "dcoudert"
}
```

For me yes.
Thanks,
David.



---

archive/issue_comments_258001.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-01T09:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-258001",
    "user": "ncohen"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_258002.json:
```json
{
    "body": "Okayyyyyyyyyy then!",
    "created_at": "2015-09-01T09:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-258002",
    "user": "ncohen"
}
```

Okayyyyyyyyyy then!



---

archive/issue_comments_258003.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-02T17:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18853",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18853#issuecomment-258003",
    "user": "vbraun"
}
```

Resolution: fixed
