# Issue 11794: lion os x 10.7: Maxima fails to build

Issue created by migration from Trac.

Original creator: was

Original creation time: 2011-10-31 07:04:01

Assignee: drkirkby

CC:  leif

(The home base for this ticket is the Lion ticket #11881.)

See the discussion at #11884.  To fix this we may need to slightly modify the Maxima spkg, at least for now.


---

Comment by was created at 2011-10-31 07:12:29

My first guess about a way to solve this problem was to add the two lines

```
(require :cmp)
(setf c::*compile-in-constants* t)
```

to the top of the file `maxima-5.23.2.p0/src/src/maxima.system`.  This was inspired by reading the error message and this post: http://www.mail-archive.com/ecls-list`@`lists.sourceforge.net/msg01243.html


---

Comment by was created at 2011-10-31 07:40:33

Here's an spkg with the patch.  This built fine for me on OS X 10.7.2 (taking 23 minutes). 

  http://sage.math.washington.edu/home/wstein/patches/maxima-5.23.2.p1.spkg


---

Comment by was created at 2011-10-31 07:40:33

Changing status from new to needs_review.


---

Comment by kcrisman created at 2011-10-31 16:56:13

I realize that Sage doesn't start yet (#11967).  But can you try

```
./sage -maxima
```

and see if the Maxima standalone binary works fine?  If not, we have problems, but presumably it will.


---

Comment by leif created at 2011-10-31 20:17:22

Should we apply the patch on _all_ platforms? (Which the spkg currently does.)


---

Comment by was created at 2011-11-01 17:20:33

Replying to [comment:5 leif]:
> Should we apply the patch on _all_ platforms? (Which the spkg currently does.)

Good question, which I wondered about.    It seems to work on other platforms, and logically it makes sense to me that it should be the right thing to do.    However, I'm not very knowledgable about the subtleties of lisp compilation.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by leif created at 2011-11-04 02:26:39

Replying to [comment:6 was]:
> Replying to [comment:5 leif]:
> > Should we apply the patch on _all_ platforms? (Which the spkg currently does.)
> 
> Good question, which I wondered about.    It seems to work on other platforms, and logically it makes sense to me that it should be the right thing to do.    However, I'm not very knowledgable about the subtleties of lisp compilation.

The patch seems to be necessary (when building with the new ECL from git / #11884) on other platforms as well.


---

Comment by leif created at 2011-11-04 05:16:17

FWIW, I made a ["reviewer" p2 spkg](http://sage.math.washington.edu/home/leif/Sage/spkgs/maxima-5.23.2.p2.spkg) with some fixes to / clean-up of `spkg-install` and some additions to `SPKG.txt`, but doctesting `sage/interfaces/maxima*` immediately segfaults (with both Williams p1 and my p2, with the ECL spkg from #11884):


```sh
$ ./sage -t -long devel/sage/sage/interfaces/maxima*
sage -t -long "devel/sage/sage/interfaces/maxima.py"
...
sage -t -long "devel/sage/sage/interfaces/maxima_lib.py"    
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libcsage.so(print_backtrace+0x31)[0x7f000546c817]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libcsage.so(sigdie+0x14)[0x7f000546c849]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libcsage.so(sage_signal_handler+0x20e)[0x7f000546c474]
/lib/libpthread.so.0(+0xf8f0)[0x7f00070ab8f0]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libgc.so.1(GC_free+0x40)[0x7effd69d1a50]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libecl.so.11.1(ecl_dealloc+0x16)[0x7effd6e3c786]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/python/site-packages/sage/misc/randstate.so(+0x38a8)[0x7f00036268a8]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/python/site-packages/sage/misc/randstate.so(+0x6fd2)[0x7f0003629fd2]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/python/site-packages/sage/misc/randstate.so(+0x7439)[0x7f000362a439]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4dca)[0x7f00073a0e1a]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x888)[0x7f00073a2948]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4ba4)[0x7f00073a0bf4]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x888)[0x7f00073a2948]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(+0x71c2b)[0x7f000732ac2b]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyObject_Call+0x52)[0x7f00073011a2]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(+0x5a8bd)[0x7f00073138bd]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyObject_Call+0x52)[0x7f00073011a2]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x464c)[0x7f00073a069c]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x888)[0x7f00073a2948]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4ba4)[0x7f00073a0bf4]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x888)[0x7f00073a2948]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4ba4)[0x7f00073a0bf4]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x888)[0x7f00073a2948]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalFrameEx+0x4ba4)[0x7f00073a0bf4]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCodeEx+0x888)[0x7f00073a2948]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyEval_EvalCode+0x32)[0x7f00073a2a22]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyRun_FileExFlags+0xb0)[0x7f00073c45a0]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(PyRun_SimpleFileExFlags+0x1ff)[0x7f00073c504f]
/home/leif/Sage/sage-4.7.2.rc0-gcc-4.5.1/local/lib/libpython2.6.so.1.0(Py_Main+0xb2c)[0x7f00073d3d3c]
/lib/libc.so.6(__libc_start_main+0xfd)[0x7f00066adc4d]
python[0x400619]

------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
Segmentation fault

	 [3.4 s]
 
----------------------------------------------------------------------
The following tests failed:


	sage -t -long "devel/sage/sage/interfaces/maxima.py"
	sage -t -long "devel/sage/sage/interfaces/maxima_abstract.py"
	sage -t -long "devel/sage/sage/interfaces/maxima_lib.py"
```


I think that's most probably "just" due to ECL (or Boehm GC?), i.e. #11884, so I could otherwise give this ticket a positive review... ;-)

Anyway, someone would have to look at my reviewer changes.

Btw., there's an `spkg-dist` script apparently nobody used recently (I added a comment on that to `SPKG.txt`), which deletes the following (and creates dummy `Makefile.in`s):

```sh
$ du -sch /home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/{es,pt}*
9.9M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/es
7.3M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/es.utf8
8.2M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt
8.8M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt_BR
6.5M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt_BR.utf8
6.0M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt.utf8
47M	total
```



---

Comment by leif created at 2011-11-04 05:16:17

Changing status from needs_review to needs_info.


---

Attachment

Diff between William's p1 and my p2. For reference / review.


---

Comment by leif created at 2011-11-04 06:20:47

Changing status from needs_info to needs_review.


---

Comment by leif created at 2011-11-04 06:20:47

Replying to [comment:9 leif]:
> FWIW, I made a ["reviewer" p2 spkg](http://sage.math.washington.edu/home/leif/Sage/spkgs/maxima-5.23.2.p2.spkg) with some fixes to / clean-up of `spkg-install` and some additions to `SPKG.txt`, but doctesting `sage/interfaces/maxima*` immediately segfaults (with both Williams p1 and my p2, with the ECL spkg from #11884) [...] 

> I think that's most probably "just" due to ECL (or Boehm GC?), i.e. #11884, so I could otherwise give this ticket a positive review... ;-)

Oooops, one should perhaps run `./sage -b` after installing a new ECL spkg... B)


```sh
$ ./sage -t -long devel/sage/sage/interfaces/maxima*
sage -t -long "devel/sage/sage/interfaces/maxima.py"        
	 [25.7 s]
sage -t -long "devel/sage/sage/interfaces/maxima_abstract.py"
	 [38.4 s]
sage -t -long "devel/sage/sage/interfaces/maxima_lib.py"    
	 [5.2 s]
 
----------------------------------------------------------------------
All tests passed!
```


By the way, the new ECL + patched Maxima spkgs work with both the boehm_gc-7.2.alpha6.p0 (from #11883) and the boehm_gc-7.1.p7 spkg.




> Anyway, someone would have to look at my reviewer changes.

That still applies.




> Btw., there's an `spkg-dist` script apparently nobody used recently (I added a comment on that to `SPKG.txt`), which deletes the following (and creates dummy `Makefile.in`s):

```sh
$ du -sch /home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/{es,pt}*
9.9M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/es
7.3M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/es.utf8
8.2M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt
8.8M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt_BR
6.5M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt_BR.utf8
6.0M	/home/leif/Sage/spkgs/maxima-5.23.2.p2/src/doc/info/pt.utf8
47M	total
```


If nobody objects, I can make a stripped spkg with these files removed (and `SPKG.txt` updated accordingly).

The relevant languages are Portuguese (Portugal and Brazil) and Spanish:

```python
#!/usr/bin/env python

import os, sys, time

def cmd(x):
    print x
    if os.system(x):
        print "(Failed.)"

for X in ['es', 'es.utf8', 'pt', 'pt.utf8', 'pt_BR', 'pt_BR.utf8']:
    cmd('rm -rf "src/doc/info/%s/"*'%X)
    open('src/doc/info/%s/Makefile.in'%X,'w').write('all:\n\tls\n\n')
```



---

Comment by leif created at 2011-11-04 07:42:03

Both spkgs (new ECL and Maxima 5.23.2.p2) also build on Solaris SPARC (32-bit mode), and all long tests pass in `sage/interfaces/maxima*`.

`ptestlong` (also on Ubuntu 10.04.3 x86_64) in progress...


---

Comment by leif created at 2011-11-04 08:12:51

Replying to [comment:13 leif]:
> `ptestlong` (also on Ubuntu 10.04.3 x86_64) in progress...

On Ubuntu 10.04.3 I get:

```
The following tests failed:

	sage -t  -long -force_lib devel/sage/sage/rings/polynomial/multi_polynomial_ideal.py # 1 doctests failed
	sage -t  -long -force_lib devel/sage/sage/rings/number_field/number_field.py # 5 doctests failed
	sage -t  -long -force_lib devel/sage/sage/rings/polynomial/multi_polynomial_element.py # 4 doctests failed
	sage -t  -long -force_lib devel/sage/doc/en/bordeaux_2008/l_series.rst # 3 doctests failed
	sage -t  -long -force_lib devel/sage/doc/en/bordeaux_2008/elliptic_curves.rst # 2 doctests failed
	sage -t  -long -force_lib devel/sage/doc/en/reference/coercion.rst # 2 doctests failed
	sage -t  -long -force_lib devel/sage/sage/schemes/plane_curves/projective_curve.py # 3 doctests failed
	sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/heegner.py # 7 doctests failed
	sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/sha_tate.py # 15 doctests failed
	sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/lseries_ell.py # 2 doctests failed
	sage -t  -long -force_lib devel/sage/sage/schemes/elliptic_curves/BSD.py # 1 doctests failed
	sage -t  -long -force_lib devel/sage/sage/schemes/generic/divisor_group.py # 3 doctests failed
	sage -t  -long -force_lib devel/sage/sage/lfunctions/dokchitser.py # 16 doctests failed
	sage -t  -long -force_lib devel/sage/sage/modular/modform/eis_series.py # 4 doctests failed
	sage -t  -long -force_lib devel/sage/sage/modular/modform/element.py # 10 doctests failed
	sage -t  -long -force_lib devel/sage/sage/interfaces/r.py # 1 doctests failed
----------------------------------------------------------------------
```


(Although I'm not that sure how clean the installation is, but IIRC the last `ptestlong` passed all tests.)


---

Comment by leif created at 2011-11-04 19:01:03

Replying to [comment:14 leif]:
> Replying to [comment:13 leif]:
> > `ptestlong` (also on Ubuntu 10.04.3 x86_64) in progress...
> 
> On Ubuntu 10.04.3 I get:

```
The following tests failed:
...
```

> 

> (Although I'm not that sure how clean the installation is, but IIRC the last `ptestlong` passed all tests.)

Weird.  After building Sage 4.7.2 (final) from scratch with the two spkgs, all tests (`ptestlong`) passed.

`ptestlong` also passed on Solaris SPARC, with Sage 4.7.2.alpha3.


---

Comment by jhpalmieri created at 2011-11-04 20:40:28

By the way, have you tried using this spkg _without_ the ECL spkg from #11884?  It worked for me (with a build from scratch) on sage.math, hawk (OpenSolaris) and various skynet machines (cleo, eno, silius, taurus; tests passed on all of these except for silius, which has other problems, and cleo, because it hasn't made it that far yet, but it's about 90% done and all tests have passed so far).  I'm also building on mark2 (Solaris), but it is really slow; the maxima build just completed successfully.  Maybe some time tomorrow we'll know about doctests there...

I wonder if we should remove the dependency on #11884.


---

Comment by leif created at 2011-11-04 21:30:00

Replying to [comment:16 jhpalmieri]:
> By the way, have you tried using this spkg _without_ the ECL spkg from #11884?

Nope, since it would be surprising if it did _not_ work... :-)

> I wonder if we should remove the dependency on #11884.

Breaking the cycle...


---

Comment by jhpalmieri created at 2011-11-07 16:32:35

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2011-11-07 16:32:35

I've built this on a bunch of different systems, both with and without the new ecl spkg at #11884.  I'm giving it (Leif's changes, in particular) a positive review.


---

Comment by jdemeyer created at 2011-11-10 13:30:22

Resolution: fixed


---

Comment by kcrisman created at 2011-11-15 18:55:50

So, somewhat weirdly, since this was tested a lot on various platforms, with #11884 _and_ this spkg, I get an error on PPC OS X 10.4.   Error is

```

;;; Note:
;;;   Invoking external command:
;;;   ranlib lisp-cache/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/libmaxima.a 
;;; Note:
;;;   Invoking external command:
;;;   gcc -I. -I/Users/student/Desktop/sage-4.8.alpha1/local/include/ -I/Users/student/Desktop/sage-4.8.alpha1/local/include -I/Users/student/Desktop/sage-4.8.alpha1/local/include -g -O2 -mno-altivec -mabi=no-altivec -fPIC -fno-common -Ddarwin -O2 -w -c eclinit4LFMq0.c -o eclinit4LFMq0.o 
/usr/libexec/gcc/powerpc-apple-darwin8/4.0.1/ld: truncated or malformed archive: lisp-cache/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/libmaxima.a at offset 28816248 (archive header of next member extends past the end of the file, can't load from it)
collect2: ld returned 1 exit status
An error occurred during initialization:
Error code 1 when executing
(RUN-PROGRAM "gcc" ("-o"
                    "lisp-cache/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/maxima.fasb"
                    "-L/Users/student/Desktop/sage-4.8.alpha1/local/lib/"
                    "/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/eclinit4LFMq0.o"
                    "lisp-cache/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/libmaxima.a"
                    "-bundle"
                    "-L/Users/student/Desktop/sage-4.8.alpha1/local/lib"
                    "-L/Users/student/Desktop/sage-4.8.alpha1/local/lib"
                    "-L/Users/student/Desktop/sage-4.8.alpha1/local/lib"
                    "-lecl" "-lgmp" "-lgc" "-lm")).
;;; Note:
;;;   Invoking external command:
;;;   gcc -o lisp-cache/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/maxima.fasb -L/Users/student/Desktop/sage-4.8.alpha1/local/lib/ /Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/eclinit4LFMq0.o lisp-cache/Users/student/Desktop/sage-4.8.alpha1/spkg/build/maxima-5.23.2.p2/src/src/libmaxima.a -bundle -L/Users/student/Desktop/sage-4.8.alpha1/local/lib -L/Users/student/Desktop/sage-4.8.alpha1/local/lib -L/Users/student/Desktop/sage-4.8.alpha1/local/lib -lecl -lgmp -lgc -lm ***********************************************************
Error: Failed to build Maxima as an ECL library.
***********************************************************

real    151m29.005s
user    27m50.456s
sys     14m7.400s
************************************************************************
Error installing package maxima-5.23.2.p2
************************************************************************
```

This error looks a LOT like the error in #11884 on the same platform.


---

Comment by kcrisman created at 2011-11-15 18:56:44

And yes, this is _after_ using the correct spkg on #11884.


---

Comment by kcrisman created at 2011-11-15 19:12:45

Incidentally, the binary works fine from the command line; it's just the library that failed to install.


---

Comment by jdemeyer created at 2011-11-16 20:13:58

Important question: does it make sense to merge this _without_ merging the new ECL package (#11884) also?


---

Comment by jdemeyer created at 2011-11-16 20:15:30

Replying to [comment:20 kcrisman]:
> This error looks a LOT like the error in #11884 on the same platform.  

Indeed. And since the problem only occurs with new versions of ECL, it think ECL (not Maxima) is to blaim.


---

Comment by kcrisman created at 2011-11-16 21:17:20

Replying to [comment:24 jdemeyer]:
> Replying to [comment:20 kcrisman]:
> > This error looks a LOT like the error in #11884 on the same platform.  
> 
> Indeed. And since the problem only occurs with new versions of ECL, it think ECL (not Maxima) is to blaim.

I concur.  Which means it's probably okay to merge this?  (Maybe?)


---

Comment by jhpalmieri created at 2011-11-16 21:19:21

I [comment:18 tested this] on a number of systems (not OS X 10.4 PPC, though) without the new ECL package, and it worked just fine.  So except for testing on OS X 10.4 PPC, I think it makes sense to merge it independently of ECL.


---

Comment by kcrisman created at 2011-11-16 21:38:16

And it builds fine with or without #11884 on that platform, and Maxima works, though I didn't run the testsuite - it takes so long to build, and maxima.py times out always :)  And I think Jeroen _has_ tested it on PPC OS X 10.4.


---

Comment by jdemeyer created at 2011-11-16 22:27:23

I am planning to start testing a tentative sage-4.8.alpha2 tomorrow, which includes this ticket.  So if all goes well, the new Maxima will be merged in sage-4.8.alpha2 _without_ the new ECL.  For ECL, we have to see what upstream says...
