# Issue 32888: 'make -n TARGET' is broken

archive/issues_032888.json:
```json
{
    "body": "CC:  @orlitzky\n\n`make -n sagelib` should only print, not run, commands.\n\nBroken by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules\n\nIssue created by migration from https://trac.sagemath.org/ticket/33125\n\n",
    "created_at": "2022-01-06T21:58:01Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "'make -n TARGET' is broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32888",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @orlitzky

`make -n sagelib` should only print, not run, commands.

Broken by #32759 by using `+` in `build/make/Makefile.in` `*-*-no-deps` rules

Issue created by migration from https://trac.sagemath.org/ticket/33125





---

archive/issue_comments_468465.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-01-06T22:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468465",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_468466.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2022-01-06T22:36:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468466",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_468467.json:
```json
{
    "body": "A solution is to do a bit of `MAKEFLAGS` parsing - see e.g. https://stackoverflow.com/questions/19521438/how-to-access-make-options-in-makefile",
    "created_at": "2022-01-07T20:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468467",
    "user": "https://github.com/mkoeppe"
}
```

A solution is to do a bit of `MAKEFLAGS` parsing - see e.g. https://stackoverflow.com/questions/19521438/how-to-access-make-options-in-makefile



---

archive/issue_comments_468468.json:
```json
{
    "body": "Isn't this just because invoking `build/make/install` interrupts the `$MAKE` and `$MAKEFLAGS` magic that normally gets applied to sub-*make*s?\n\nFor example, this fixes `make -n sagelib` for me:\n\n\n```patch\ndiff --git a/Makefile b/Makefile\nindex 444e4f9e4a..9505152830 100644\n--- a/Makefile\n+++ b/Makefile\n@@ -37,7 +37,7 @@ sageruntime: base-toolchain\n \t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n \t$(MAKE) build/make/Makefile --stop\n \t+build/bin/sage-logger \\\n-\t\t\"cd build/make && ./install '$@'\" logs/install.log\n+\t\t\"cd build/make && MAKE=\\\"$(MAKE)\\\" MAKEFLAGS=\\\"$(MAKEFLAGS)\\\" ./install '$@'\" logs/install.log\n \n # CONFIG_FILES lists all files that appear in AC_CONFIG_FILES in configure.ac;\n # except for build/make/Makefile-auto, which is unused by the build system\n```\n",
    "created_at": "2022-01-07T22:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468468",
    "user": "https://github.com/orlitzky"
}
```

Isn't this just because invoking `build/make/install` interrupts the `$MAKE` and `$MAKEFLAGS` magic that normally gets applied to sub-*make*s?

For example, this fixes `make -n sagelib` for me:


```patch
diff --git a/Makefile b/Makefile
index 444e4f9e4a..9505152830 100644
--- a/Makefile
+++ b/Makefile
@@ -37,7 +37,7 @@ sageruntime: base-toolchain
 	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
 	$(MAKE) build/make/Makefile --stop
 	+build/bin/sage-logger \
-		"cd build/make && ./install '$@'" logs/install.log
+		"cd build/make && MAKE=\"$(MAKE)\" MAKEFLAGS=\"$(MAKEFLAGS)\" ./install '$@'" logs/install.log
 
 # CONFIG_FILES lists all files that appear in AC_CONFIG_FILES in configure.ac;
 # except for build/make/Makefile-auto, which is unused by the build system
```




---

archive/issue_comments_468469.json:
```json
{
    "body": "Did you test this on top of #32759?",
    "created_at": "2022-01-07T22:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468469",
    "user": "https://github.com/mkoeppe"
}
```

Did you test this on top of #32759?



---

archive/issue_comments_468470.json:
```json
{
    "body": "No, the problem is that we want to pass jobserver flags to something that is not `make` (and therefore does not handle `-n` etc.), namely the `spkg-install` script.",
    "created_at": "2022-01-07T22:50:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468470",
    "user": "https://github.com/mkoeppe"
}
```

No, the problem is that we want to pass jobserver flags to something that is not `make` (and therefore does not handle `-n` etc.), namely the `spkg-install` script.



---

archive/issue_comments_468471.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> Did you test this on top of #32759?\n\nNo, but the problem with `make -n sagelib` already exists in beta9.",
    "created_at": "2022-01-07T23:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468471",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:7 mkoeppe]:
> Did you test this on top of #32759?

No, but the problem with `make -n sagelib` already exists in beta9.



---

archive/issue_comments_468472.json:
```json
{
    "body": "OK, you are right, there is broader breakage regarding `-n` etc. that has been around for a long time.\n\nBut there's a more specific problem (of blocker quality) caused by #32759. I've opened #33130 for it.\n\nLet's address the broader problem in Sage 9.6.",
    "created_at": "2022-01-08T06:51:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32888#issuecomment-468472",
    "user": "https://github.com/mkoeppe"
}
```

OK, you are right, there is broader breakage regarding `-n` etc. that has been around for a long time.

But there's a more specific problem (of blocker quality) caused by #32759. I've opened #33130 for it.

Let's address the broader problem in Sage 9.6.



---

archive/issue_events_087520.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-01-08T06:51:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32888#event-87520"
}
```



---

archive/issue_events_087521.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "milestone": "sage-9.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32888#event-87521"
}
```



---

archive/issue_events_087522.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-03-05T01:55:27Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32888#event-87522"
}
```



---

archive/issue_events_087523.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "milestone": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32888#event-87523"
}
```



---

archive/issue_events_087524.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-31T02:51:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32888",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32888#event-87524"
}
```
