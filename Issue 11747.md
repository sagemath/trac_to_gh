# Issue 11747: Issue when pickling a formal function

archive/issues_011747.json:
```json
{
    "body": "Assignee: @williamstein\n\nCC:  jpflori @burcin @jasongrout dsm @orlitzky\n\nThere is a problem in symbolic function pickling:\n\n\n```\nsage: x = var('x'); f = function('f',x) ; s = dumps(f) ; loads(s)\nRuntimeError: unknown function 'f' in archive\n```\n\n\nThe error was not present in Sage 4.7 but it is in newer versions.\nIt was suggested (http://groups.google.com/group/sage-support/browse_thread/thread/b439844f2fa0b675) that it is related to Pynac.\nPynac was updated to 0.2.2 (sage-4.7.1.alpha1) and then to 0.2.3 \n(sage-4.7.1.alpha4) according to sage 7.4.1 changelog.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11919\n\n",
    "created_at": "2011-10-13T15:52:44Z",
    "labels": [
        "pickling",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.1",
    "title": "Issue when pickling a formal function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11747",
    "user": "cdsousa"
}
```
Assignee: @williamstein

CC:  jpflori @burcin @jasongrout dsm @orlitzky

There is a problem in symbolic function pickling:


```
sage: x = var('x'); f = function('f',x) ; s = dumps(f) ; loads(s)
RuntimeError: unknown function 'f' in archive
```


The error was not present in Sage 4.7 but it is in newer versions.
It was suggested (http://groups.google.com/group/sage-support/browse_thread/thread/b439844f2fa0b675) that it is related to Pynac.
Pynac was updated to 0.2.2 (sage-4.7.1.alpha1) and then to 0.2.3 
(sage-4.7.1.alpha4) according to sage 7.4.1 changelog.

Issue created by migration from https://trac.sagemath.org/ticket/11919





---

archive/issue_comments_133655.json:
```json
{
    "body": "Changing keywords from \"\" to \"pynac, pickling\".",
    "created_at": "2011-10-15T19:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133655",
    "user": "@nbruin"
}
```

Changing keywords from "" to "pynac, pickling".



---

archive/issue_comments_133656.json:
```json
{
    "body": "Changing assignee from @williamstein to @burcin.",
    "created_at": "2011-10-15T19:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133656",
    "user": "@nbruin"
}
```

Changing assignee from @williamstein to @burcin.



---

archive/issue_comments_133657.json:
```json
{
    "body": "Changing component from pickling to symbolics.",
    "created_at": "2011-10-15T19:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133657",
    "user": "@nbruin"
}
```

Changing component from pickling to symbolics.



---

archive/issue_comments_133658.json:
```json
{
    "body": "I hit this independently using deepcopy(). In sage-4.7:\n\n\n```\nsage: f = function('f',x)\nsage: deepcopy(f)\nf(x)\n```\n\n\nand in 4.8.alpha5:\n\n\n```\nsage: f = function('f',x)\nsage: deepcopy(f)\n...\nRuntimeError: unknown function 'f' in archive\n```\n",
    "created_at": "2011-12-26T21:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133658",
    "user": "@orlitzky"
}
```

I hit this independently using deepcopy(). In sage-4.7:


```
sage: f = function('f',x)
sage: deepcopy(f)
f(x)
```


and in 4.8.alpha5:


```
sage: f = function('f',x)
sage: deepcopy(f)
...
RuntimeError: unknown function 'f' in archive
```




---

archive/issue_comments_133659.json:
```json
{
    "body": "Interestingly, if I take the pynac spkg from 4.7 and install it on 5.0.beta7, it doesn't fix the crash.",
    "created_at": "2012-03-11T02:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133659",
    "user": "@orlitzky"
}
```

Interestingly, if I take the pynac spkg from 4.7 and install it on 5.0.beta7, it doesn't fix the crash.



---

archive/issue_comments_133660.json:
```json
{
    "body": "I built a copy of 4.7.1, and the crash does happen. So the change was introduced between 4.7 and 4.7.1.",
    "created_at": "2012-03-12T18:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133660",
    "user": "@orlitzky"
}
```

I built a copy of 4.7.1, and the crash does happen. So the change was introduced between 4.7 and 4.7.1.



---

archive/issue_comments_133661.json:
```json
{
    "body": "Okay, this broke with #9240. I can fix it with a one-line change in 4.7.1.alpha4:\n\n\n```\ndiff --git a/sage/symbolic/function.pyx b/sage/symbolic/function.pyx\n--- a/sage/symbolic/function.pyx\n+++ b/sage/symbolic/function.pyx\n@@ -127,6 +127,7 @@\n     cdef _register_function(self):\n         cdef GFunctionOpt opt\n         opt = g_function_options_args(self._name, self._nargs)\n+        opt.set_python_func()\n\n         if hasattr(self, '_eval_'):\n             opt.eval_func(self)\n```\n\n\nBut there's no longer a `set_python_func()` method on GFunctionOpt, so I don't know how to fix it in 5.0.beta7. The adventure continues...",
    "created_at": "2012-03-13T02:56:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133661",
    "user": "@orlitzky"
}
```

Okay, this broke with #9240. I can fix it with a one-line change in 4.7.1.alpha4:


```
diff --git a/sage/symbolic/function.pyx b/sage/symbolic/function.pyx
--- a/sage/symbolic/function.pyx
+++ b/sage/symbolic/function.pyx
@@ -127,6 +127,7 @@
     cdef _register_function(self):
         cdef GFunctionOpt opt
         opt = g_function_options_args(self._name, self._nargs)
+        opt.set_python_func()

         if hasattr(self, '_eval_'):
             opt.eval_func(self)
```


But there's no longer a `set_python_func()` method on GFunctionOpt, so I don't know how to fix it in 5.0.beta7. The adventure continues...



---

archive/issue_comments_133662.json:
```json
{
    "body": "Replying to [comment:8 mjo]:\n> But there's no longer a `set_python_func()` method on GFunctionOpt, so I don't know how to fix it in 5.0.beta7. The adventure continues...\n\nDisregard that, I'm a moron. Testing a patch now.",
    "created_at": "2012-03-13T03:23:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133662",
    "user": "@orlitzky"
}
```

Replying to [comment:8 mjo]:
> But there's no longer a `set_python_func()` method on GFunctionOpt, so I don't know how to fix it in 5.0.beta7. The adventure continues...

Disregard that, I'm a moron. Testing a patch now.



---

archive/issue_comments_133663.json:
```json
{
    "body": "Attachment [sage-trac_11919.patch](tarball://root/attachments/some-uuid/ticket11919/sage-trac_11919.patch) by @orlitzky created at 2012-03-13 04:09:42",
    "created_at": "2012-03-13T04:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133663",
    "user": "@orlitzky"
}
```

Attachment [sage-trac_11919.patch](tarball://root/attachments/some-uuid/ticket11919/sage-trac_11919.patch) by @orlitzky created at 2012-03-13 04:09:42



---

archive/issue_comments_133664.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-13T04:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133664",
    "user": "@orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_133665.json:
```json
{
    "body": "I had the same problem on Sage 4.7.1. I applied the patch described above but it didn't work (same error message). I then uninstalled sage and installed version 4.8 instead. I applied the patch again and it still didn't work. Any suggestions?",
    "created_at": "2012-05-09T22:00:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133665",
    "user": "abid_naqvi83"
}
```

I had the same problem on Sage 4.7.1. I applied the patch described above but it didn't work (same error message). I then uninstalled sage and installed version 4.8 instead. I applied the patch again and it still didn't work. Any suggestions?



---

archive/issue_comments_133666.json:
```json
{
    "body": "Replying to [comment:11 abid_naqvi83]:\n> I had the same problem on Sage 4.7.1. I applied the patch described above but it didn't work (same error message). I then uninstalled sage and installed version 4.8 instead. I applied the patch again and it still didn't work. Any suggestions?\n\nDid you remember to run `sage -b` after applying the patch?\n\nI don't remember which version I created the patch against... Does it at least apply cleanly against 4.8?",
    "created_at": "2012-05-09T22:46:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133666",
    "user": "@orlitzky"
}
```

Replying to [comment:11 abid_naqvi83]:
> I had the same problem on Sage 4.7.1. I applied the patch described above but it didn't work (same error message). I then uninstalled sage and installed version 4.8 instead. I applied the patch again and it still didn't work. Any suggestions?

Did you remember to run `sage -b` after applying the patch?

I don't remember which version I created the patch against... Does it at least apply cleanly against 4.8?



---

archive/issue_comments_133667.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-05-09T22:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133667",
    "user": "@nbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_133668.json:
```json
{
    "body": "Fix confirmed! indeed, the patch simply adds back a line that disappeared in #9240 without any reason stated, so probably that was just an accident.\n\nPositive review!\n\n(for abid_naqvi83: note that the patchbot is happy and that the feature is actually doctested. If the fix has no effect, perhaps you forgot to run \"sage -b\"?)",
    "created_at": "2012-05-09T22:49:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133668",
    "user": "@nbruin"
}
```

Fix confirmed! indeed, the patch simply adds back a line that disappeared in #9240 without any reason stated, so probably that was just an accident.

Positive review!

(for abid_naqvi83: note that the patchbot is happy and that the feature is actually doctested. If the fix has no effect, perhaps you forgot to run "sage -b"?)



---

archive/issue_comments_133669.json:
```json
{
    "body": "That was it. Didn't know about \"sage -b\". Sorry for the faux pas and thanks for the fix. Working now.",
    "created_at": "2012-05-10T04:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133669",
    "user": "abid_naqvi83"
}
```

That was it. Didn't know about "sage -b". Sorry for the faux pas and thanks for the fix. Working now.



---

archive/issue_comments_133670.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2012-05-10T07:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133670",
    "user": "@burcin"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_133671.json:
```json
{
    "body": "Replying to [comment:13 nbruin]:\n> Fix confirmed! indeed, the patch simply adds back a line that disappeared in #9240 without any reason stated, so probably that was just an accident.\n\nIt was not an accident. The python_func flag stored in pynac is not a bool any more. It is a bitmask that marks which custom functions are implemented in Python. The rest, if they exist are C++ functions.\n\n> Positive review!\n\nThis patch doesn't fix the problem. It might actually lead to crashes, since pynac will look for a python function to call for evaluation, differentiation, etc. if some bits in `python_func` are set.\n\nThe correct fix will be to get pynac to create a new dummy symbolic function at the point where it raises an error with \"unknown function 'f' in archive.\" Relevant code can be found in `ginac/function.{h,cpp}` in pynac sources.",
    "created_at": "2012-05-10T07:53:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133671",
    "user": "@burcin"
}
```

Replying to [comment:13 nbruin]:
> Fix confirmed! indeed, the patch simply adds back a line that disappeared in #9240 without any reason stated, so probably that was just an accident.

It was not an accident. The python_func flag stored in pynac is not a bool any more. It is a bitmask that marks which custom functions are implemented in Python. The rest, if they exist are C++ functions.

> Positive review!

This patch doesn't fix the problem. It might actually lead to crashes, since pynac will look for a python function to call for evaluation, differentiation, etc. if some bits in `python_func` are set.

The correct fix will be to get pynac to create a new dummy symbolic function at the point where it raises an error with "unknown function 'f' in archive." Relevant code can be found in `ginac/function.{h,cpp}` in pynac sources.



---

archive/issue_comments_133672.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2012-05-10T11:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133672",
    "user": "@burcin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_133673.json:
```json
{
    "body": "I take it back. This is a good workaround, since constructors of `function_options` takes care to clear the function pointers used to store references to the custom methods which can be defined for evalutation, conjugation, etc. Before trying to evaluate any of these custom methods, we check if the pointer is NULL, so a crash can never happen.",
    "created_at": "2012-05-10T11:28:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133673",
    "user": "@burcin"
}
```

I take it back. This is a good workaround, since constructors of `function_options` takes care to clear the function pointers used to store references to the custom methods which can be defined for evalutation, conjugation, etc. Before trying to evaluate any of these custom methods, we check if the pointer is NULL, so a crash can never happen.



---

archive/issue_comments_133674.json:
```json
{
    "body": "Pynac 0.2.4 from #12950 fixes this, without the patch attached to this ticket. I don't know how long it will take to get that reviewed and merged, so I'm not opposed to merging this first.",
    "created_at": "2012-05-15T22:40:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133674",
    "user": "@burcin"
}
```

Pynac 0.2.4 from #12950 fixes this, without the patch attached to this ticket. I don't know how long it will take to get that reviewed and merged, so I'm not opposed to merging this first.



---

archive/issue_comments_133675.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-05-23T21:31:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133675",
    "user": "@jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_133676.json:
```json
{
    "body": "Replying to [comment:18 burcin]:\n> Pynac 0.2.4 from #12950 fixes this, without the patch attached to this ticket. I don't know how long it will take to get that reviewed and merged, so I'm not opposed to merging this first. \n\nNow that #12950 is in, should we remove the line again (but keep the test)?",
    "created_at": "2012-09-10T13:36:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133676",
    "user": "@orlitzky"
}
```

Replying to [comment:18 burcin]:
> Pynac 0.2.4 from #12950 fixes this, without the patch attached to this ticket. I don't know how long it will take to get that reviewed and merged, so I'm not opposed to merging this first. 

Now that #12950 is in, should we remove the line again (but keep the test)?



---

archive/issue_comments_133677.json:
```json
{
    "body": "Replying to [comment:20 mjo]:\n> Replying to [comment:18 burcin]:\n> > Pynac 0.2.4 from #12950 fixes this, without the patch attached to this ticket. I don't know how long it will take to get that reviewed and merged, so I'm not opposed to merging this first. \n> \n> Now that #12950 is in, should we remove the line again (but keep the test)?\n\nYes, though it is mostly harmless AFAICT.",
    "created_at": "2012-09-10T13:42:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133677",
    "user": "@burcin"
}
```

Replying to [comment:20 mjo]:
> Replying to [comment:18 burcin]:
> > Pynac 0.2.4 from #12950 fixes this, without the patch attached to this ticket. I don't know how long it will take to get that reviewed and merged, so I'm not opposed to merging this first. 
> 
> Now that #12950 is in, should we remove the line again (but keep the test)?

Yes, though it is mostly harmless AFAICT.



---

archive/issue_comments_133678.json:
```json
{
    "body": "I've removed it at #13446 (needs review if anyone wants it).",
    "created_at": "2012-09-11T14:14:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11747",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11747#issuecomment-133678",
    "user": "@orlitzky"
}
```

I've removed it at #13446 (needs review if anyone wants it).
