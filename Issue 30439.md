# Issue 30439: Follow up to #30563 too many quotes in maxima.py

Issue created by migration from https://trac.sagemath.org/ticket/30676

Original creator: fbissey

Original creation time: 2020-09-28 06:19:53

CC:  strogdon

In #30563 one particular setting of `MAXIMA` used in sage-on-gentoo (`maximax -l ecl`) was extensively tested when applied to `bin/sage`. It unfortunately hadn't been so thoroughly tested in `interfaces/maxima.py`.

The `__init__` method in `maxima.py` quote the variable `MAXIMA` when building the command for `pexpect`

```
                        command = '"{0}" -p "{1}"'.format(MAXIMA, STARTUP),
```

this leads the whole expression `maxima -l ecl`, with spaces, to be considered a command by pexpect. Removing the double quotes fix the problem and doesn't introduce any issue with more conventional values of `MAXIMA`.
 


---

Comment by fbissey created at 2020-09-28 06:28:00

Changing status from new to needs_review.


---

Comment by fbissey created at 2020-09-28 06:28:00

`@`strogdon, you may have seen that issue.
----
New commits:


---

Comment by mkoeppe created at 2020-09-28 19:45:25

`STARTUP` should probably be quoted in case the directory contains whitespace.


---

Comment by fbissey created at 2020-09-28 20:11:11

OK, I guess someone would have complained already if putting double quote there broke things.

I'll add that in fact sage-on-broken was potentially broken if you had maxima with sbcl and ecl installed - from the day `interfaces/maxima.py` started to use `MAXIMA`. So those improvements were really needed.


---

Comment by fbissey created at 2020-09-28 20:16:17

Hum, then it may break things if `MAXIMA` is a path with spaces in it. A situation which could be common on windows.


---

Comment by fbissey created at 2020-09-28 20:23:02

#30563 would already cause trouble if `MAXIMA` is a path with spaces in it because I didn't double quote in that ticket either. Which may mean no bots has that kind of configuration.


---

Comment by git created at 2020-09-28 20:44:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by fbissey created at 2020-09-28 20:46:04

If there are complaints I have a plan B.


---

Comment by mkoeppe created at 2020-09-28 20:51:13

Well, since `MAXIMA` is used as the beginning of a shell command line (this could be documented...), one would be able to use shell quoting within the value of this variable.


---

Comment by fbissey created at 2020-09-28 20:57:00

Replying to [comment:8 mkoeppe]:
> Well, since `MAXIMA` is used as the beginning of a shell command line (this could be documented...), one would be able to use shell quoting within the value of this variable.

Can you give a concrete example of your line of thought there? I am not completely sure of what your idea is and how to put it in practice.


---

Comment by mkoeppe created at 2020-09-28 21:23:45

If `maxima` lies in `/path with spaces/`, then
`MAXIMA` could be set to `'"/path with spaces/maxima" -l ecl'` and that would work with the current version on the branch.

Unrelated, but perhaps an improvement:

```diff
- command = '{0} -p "{1}"'.format(MAXIMA, STARTUP)
+ command = '{0} -p {1}'.format(MAXIMA, shlex.quote(STARTUP))
```

https://docs.python.org/3/library/shlex.html


---

Comment by fbissey created at 2020-09-28 21:30:36

Thanks for the explanation, that was helpful. 

Using stuff like `shlex` more seems like a good idea to me and `quote` is available from 3.3 so it is ok to use. I'll redo the branch shortly.


---

Comment by git created at 2020-09-28 21:46:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by strogdon created at 2020-09-29 01:01:22

Does `shlex` have to be imported somewhere? `interfaces/maxima.py` fails here on s-o-g unless I explicitly `import shlex`.


---

Comment by fbissey created at 2020-09-29 01:02:53

I'll confess that I thought it would be OK without import and it was foolish. I'll fix that.


---

Comment by git created at 2020-09-29 01:07:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2020-09-29 01:27:07

Done.


---

Comment by strogdon created at 2020-09-29 02:12:09

This works here.

`@`mkoeppe please add yourself if you see fit as I would never have thought of using `shlex`.


---

Comment by strogdon created at 2020-09-29 02:12:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-10-03 22:57:38

Resolution: fixed
