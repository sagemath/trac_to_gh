# Issue 19896: Use pkg-config for Sage setup

Issue created by migration from https://trac.sagemath.org/ticket/20133

Original creator: vbraun

Original creation time: 2016-02-28 14:05:44

CC:  fbissey




---

Comment by git created at 2016-02-28 14:39:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vbraun created at 2016-02-28 14:52:53

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vbraun created at 2016-02-28 14:52:53

Changing component from PLEASE CHANGE to build.


---

Comment by git created at 2016-02-28 15:23:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-02-28 15:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2016-02-28 19:16:48

Changing status from new to needs_review.


---

Comment by fbissey created at 2016-02-28 20:42:05

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2016-02-28 20:42:05

I think there is more to do in `cython.py`. In sage-on-gentoo I added a `libdir` in the output of `pyx_preparse` to take into account potential `blas/lapack` outside of sage.

Which means I had also to add it in `cython`, the extra stuff look like this

```
@@ -208,8 +192,8 @@
         '.../sage/ext',
         '.../cysignals'],
         'c',
-        [], ['-w', '-O2'])
-        sage: s, libs, inc, lang, f, args = pyx_preparse("# clang c++\n #clib foo\n # cinclude bar\n")
+        [], ['-w', '-O2'],...)
+        sage: s, libs, inc, lang, f, args, libdirs = pyx_preparse("# clang c++\n #clib foo\n # cinclude bar\n")
         sage: lang
         'c++'
 
@@ -234,7 +218,7 @@
         '.../sage/ext',
         '.../cysignals']
 
-        sage: s, libs, inc, lang, f, args = pyx_preparse("# cargs -O3 -ggdb\n")
+        sage: s, libs, inc, lang, f, args, libdirs = pyx_preparse("# cargs -O3 -ggdb\n")
         sage: args
         ['-w', '-O2', '-O3', '-ggdb']
 
@@ -263,6 +247,7 @@
     s = """\ninclude "cdefs.pxi"\n""" + s
     s = """\ninclude "cysignals/signals.pxi"  # ctrl-c interrupt block support\ninclude "stdsage.pxi"\n""" + s
     args, s = parse_keywords('cargs', s)
+    libdirs = cblas_library_dirs()
     args = ['-w','-O2'] + args
 
     # Add cysignals directory to includes
@@ -271,7 +256,7 @@
         if os.path.isdir(cysignals_path):
             inc.append(cysignals_path)
 
-    return s, libs, inc, lang, additional_source_files, args
+    return s, libs, inc, lang, additional_source_files, args, libdirs
 
 ################################################################
 # If the user attaches a .spyx file and changes it, we have
@@ -413,7 +398,7 @@
 
     F = open(filename).read()
 
-    F, libs, includes, language, additional_source_files, extra_args = pyx_preparse(F)
+    F, libs, includes, language, additional_source_files, extra_args, libdirs = pyx_preparse(F)
 
     # add the working directory to the includes so custom headers etc. work
     includes.append(os.path.split(os.path.splitext(filename)[0])[0])
@@ -453,19 +438,17 @@
 
 from sage.env import SAGE_LOCAL
 
-extra_link_args =  ['-L' + SAGE_LOCAL + '/lib']
 extra_compile_args = %s
 
 ext_modules = [Extension('%s', sources=['%s.%s', %s],
                      libraries=%s,
-                     library_dirs=[SAGE_LOCAL + '/lib/'],
+                     library_dirs=[SAGE_LOCAL + '/lib/', '%s'],
                      extra_compile_args = extra_compile_args,
-                     extra_link_args = extra_link_args,
                      language = '%s' )]
 
 setup(ext_modules = ext_modules,
       include_dirs = %s)
-    """%(extra_args, name, name, extension, additional_source_files, libs, language, includes)
+    """%(extra_args, name, name, extension, additional_source_files, libs, libdirs, language, includes)
     open('%s/setup.py'%build_dir,'w').write(setup)
     cython_include = ' '.join(["-I '%s'"%x for x in includes if len(x.strip()) > 0 ])
 
```

unless you have that sorted some other way I didn't notice, I would that part to be included.


---

Comment by vbraun created at 2016-02-28 21:41:38

Fine with me; Since you already have it as a patch can you just add a commit so I don't have to apply your diff by hand?


---

Comment by fbissey created at 2016-02-28 22:32:15

Will do as soon as my day job allows me, I'll put it in positive review afterwards.


---

Comment by jdemeyer created at 2016-02-28 23:46:58

I suggest to move the `pkgconfig` stuff you added to `src/module_list.py` to some place within the `sage` package. Then it can more easily be imported by other packages too, analogous to the `sage_include_directories()` function in `src/sage/env.py`.

Suppose I write a spkg which uses Sage and also links against BLAS, then it would be nice if I could reuse that code. That would also remove the need to duplicate that code in `cython.py`.


---

Comment by fbissey created at 2016-02-29 00:36:58

Admittedly, it sounds like a good idea. I guess it should be a new file otherwise `env.py` will end up being a dumping ground. But when you talk about `blas` in particular it is true that we have a straight duplication between `cython.py` and `module_list.py` (even in my original version in sage-on-gentoo). 

On the other hand I am not sure why in your use case you couldn't use the `.pc` files directly. 

Of course that could be more convenient but I have a feeling it is on the slippery slope of putting the kitchen sink into sage.


---

Comment by fbissey created at 2016-02-29 02:24:50

OK pushing branch including changes to `pyx_preparse` note that cblas' include directory is not currently added. It hasn't proved necessary yet but could be in the future.
----
New commits:


---

Comment by fbissey created at 2016-02-29 02:26:26

Changing status from needs_work to positive_review.


---

Comment by git created at 2016-02-29 04:17:08

Changing status from positive_review to needs_review.


---

Comment by git created at 2016-02-29 04:17:08

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by fbissey created at 2016-02-29 04:18:14

Sorry for the noise, I thought I had removed those brackets before the last commit.


---

Comment by fbissey created at 2016-02-29 07:44:38

OK, Volker has done things differently from what I used to do and now I have found that the difference is fairly important.


---

Comment by fbissey created at 2016-02-29 07:44:38

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-02-29 08:04:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-02-29 08:07:26

Not a difference between I have done and Volker has done. It looks like I had a bug for some time that happens not to be triggered in the common case in sage-on-gentoo. Let's see if the patchbot will come clean this time.


---

Comment by vbraun created at 2016-02-29 08:48:02

IMHO in an ideal world you'd just run `pkg-config --libs blas gsl zlib`. By telling pkg-config all dependencies you enable it to order the libraries, too. The current verbosity is just a symptom of not having pc files for all libraries. We should rather work on that than move the current workaround into the Sage library.


---

Comment by jdemeyer created at 2016-02-29 10:05:11

If you need to add flags like

```diff
+              library_dirs = gsl_library_dirs,
+              include_dirs = gsl_include_dirs),
```

you must put them in the `.pxd` files, not in `module_list.py`. The reason is that there are a lot more extensions than the ones in `sage/gsl/*.pyx` which use the gsl library. If you add those dirs and includes to the gsl `.pxd` files, then all extensions using gsl will automatically have the correct flags added.

This currently applies only to gsl, since all other libraries that you changed are listed directly in `module_list.py`.


---

Comment by jdemeyer created at 2016-02-29 10:08:06

Given that you add the BLAS libs to `gsl_libs`, I guess you should also add the BLAS library and include dirs to the GSL library and include dirs.


---

Comment by vbraun created at 2016-02-29 10:37:29

Correctly treating library and include dirs is only relevant for non-Sage, non-system GSL installs. IMHO there is no point in worrying about that at the moment as we can't test it so it isn't going to work no matter what. First we need a way to configure Sage to not build our own GSL...


---

Comment by jdemeyer created at 2016-02-29 10:51:38

Replying to [comment:23 vbraun]:
> IMHO there is no point in worrying about that at the moment
In that case, just leave GSL alone in this branch: either do it right or don't do it at all.

I am very much against adding known-broken code with the excuse that you cannot test it, so you cannot see that it is in fact broken.


---

Comment by fbissey created at 2016-02-29 21:02:23

I must say that I was surprised by Volker carpet bombing of all things that have a `.pc` file when we could have limited ourselves to `blas` and `lapack` (for `coinor`) where we want to be able to use something installed outside of `sage`.

I don't think it would be needed for moving to `hashstack` as you would build everything in same prefix (I think). Now if you want to package for something like `spack` that becomes more interesting. But some other stuff will have to happen before you get anywhere there.


---

Comment by vbraun created at 2016-02-29 22:20:32

IMHO not having a pc file for a shared library is a bug in an of itself. We are just reinventing the wheel if we try to write our own shared library configuration system. Pkgconfig a proven tool, just use it. E.g. look how elegantly xorg and Gnome handle >~100 shared libraries whereas we are to the hilt in a shit creek with just a handful.


---

Comment by vbraun created at 2016-02-29 22:34:46

Correction: Both not having a pc file and not using an existing pc file are a bug in an of itself.


---

Comment by git created at 2016-02-29 23:24:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-02-29 23:28:22

Replying to [comment:27 vbraun]:
> Correction: Both not having a pc file and not using an existing pc file are a bug in an of itself.

Fine it is a bug. But if we are drinking that kool-aid, we'll have to also drink Jeroen's kool-aid about `.pxd` files. Otherwise it would be like "having your cake and eat it too" as the English would say.

And apologies for missing one last bit of my old patch to that doctest.
----
New commits:


---

Comment by fbissey created at 2016-03-01 09:23:46

Migrating building directives to `.pxd` files is an ongoing process. I suggest we merge this ticket as is but start to migrate more aggressively. We have one migration to blas/lapack `.pc` to do on the top of my head and that is `numpy` and `scipy`. Once that is done, use of alternative blas/lapack in vanilla sage will have come a long way.


---

Comment by jdemeyer created at 2016-03-01 09:44:36

Replying to [comment:30 fbissey]:
> Migrating building directives to `.pxd` files is an ongoing process.

In the case of GSL, the library declarations are already migrated to `.pxd` files. So, if you want to fine-tune these declarations (by adding `library_dirs` for example), those fine-tuned declarations should also be in `.pxd` files. Otherwise it's a mess and we're worse off than before.

Concretely, this should be reverted:

```diff
-    Extension('*', ['sage/gsl/*.pyx']),
+    Extension('*', ['sage/gsl/*.pyx'],
+              library_dirs = gsl_library_dirs,
+              include_dirs = gsl_include_dirs),
```



---

Comment by fbissey created at 2016-03-01 09:56:36

OK I will take care of that but that may be in the morning in my time zone.


---

Comment by jdemeyer created at 2016-03-01 13:02:20

Note that this ticket conflicts badly with #17635.


---

Comment by fbissey created at 2016-03-01 21:33:47

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 fbissey]:
> > Migrating building directives to `.pxd` files is an ongoing process.
> 
> In the case of GSL, the library declarations are already migrated to `.pxd` files. So, if you want to fine-tune these declarations (by adding `library_dirs` for example), those fine-tuned declarations should also be in `.pxd` files. Otherwise it's a mess and we're worse off than before.
> 
> Concretely, this should be reverted:
> {{{
> #!diff
> -    Extension('*', ['sage/gsl/*.pyx']),
> +    Extension('*', ['sage/gsl/*.pyx'],
> +              library_dirs = gsl_library_dirs,
> +              include_dirs = gsl_include_dirs),
> }}}

Jeroen, I can see that some distutils stuff is indeed already present for `sage/libs/gsl/*.pxd` files, but there is nothing for `sage/gsl/*.pxd` should I regularise that as well or is there something I am missing (like why is there `sage/libs/gsl/` and `sage/gsl/`)?


---

Comment by jdemeyer created at 2016-03-01 21:50:55

Replying to [comment:34 fbissey]:
> but there is nothing for `sage/gsl/*.pxd`
Indeed and it should be that way. The `# distutils` stuff should be put where the library interface is declared and only there.


---

Comment by git created at 2016-03-01 23:44:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-01 23:46:32

OK, hope I did it all correctly. Three `.pxd` files didn't have any distutils instructions. For those I only added stuff as I was thinking it could be necessary (include directory for two of them)..


---

Comment by fbissey created at 2016-03-02 09:04:13

Anyone has a clue why the librae patchbot has an apparently unrelated doctest failure

```
sage -t --long src/sage/all.py
**********************************************************************
File "src/sage/all.py", line 305, in sage.all._write_started_file
Failed example:
    os.path.isfile(started_file)
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   3 in sage.all._write_started_file
    [20 tests, 1 failure, 0.57 s]
----------------------------------------------------------------------
sage -t --long src/sage/all.py  # 1 doctest failed
----------------------------------------------------------------------
```

All other doctests passing.


---

Comment by jdemeyer created at 2016-03-02 09:17:44

1. You need to define the GSL aliases, note the command line:

> gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC **-Igsl_include_dirs** -I/home/worker/sage-patchbot/local/lib/python2.7/site-packages/cysignals -I/home/worker/sage-patchbot/local/include -I/home/worker/sage-patchbot/local/include/python2.7 -I/home/worker/sage-patchbot/local/lib/python2.7/site-packages/numpy/core/include -I/home/worker/sage-patchbot/src -I/home/worker/sage-patchbot/src/sage/ext -I/home/worker/sage-patchbot/src/build/cythonized -I/home/worker/sage-patchbot/src/build/cythonized/sage/ext -I/home/worker/sage-patchbot/local/include/python2.7 -c /home/worker/sage-patchbot/src/build/cythonized/sage/gsl/gsl_array.c -o build/temp.linux-x86_64-2.7/home/worker/sage-patchbot/src/build/cythonized/sage/gsl/gsl_array.o -DGSL_DISABLE_DEPRECATED -fno-strict-aliasing -w

2. Can you try to not import `pkgconfig` every time that Sage starts?


---

Comment by fbissey created at 2016-03-02 09:28:56

I should have known.
 
I supposed `pkgconfig` is called from `cython.py` somehow at startup. Would putting the `import pkgconfig` in a method stop that problem?


---

Comment by jdemeyer created at 2016-03-02 09:31:12

Replying to [comment:40 fbissey]:
> Would putting the `import pkgconfig` in a method stop that problem?

Yes. Even better, import the whole `cython.py` lazily.


---

Comment by jdemeyer created at 2016-03-02 09:37:05

This should work if you add `import sage.misc.cython` to some doctests:

```diff
diff --git a/src/sage/misc/all.py b/src/sage/misc/all.py
index 25838c1..071c6d5 100644
--- a/src/sage/misc/all.py
+++ b/src/sage/misc/all.py
@@ -76,8 +76,8 @@ from sage_eval import sage_eval, sageobj
 
 from sage_input import sage_input
 
-from cython import cython_lambda, cython_create_local_so
-from cython_c import cython_compile as cython
+lazy_import("sage.misc.cython", ["cython_lambda", "cython_create_local_so"])
+lazy_import("sage.misc.cython_c", "cython_compile", "cython")
 lazy_import("sage.misc.cython_c", "cython_compile", "pyrex", deprecation=9552)
 lazy_import("sage.misc.cython_c", "cython_compile", "sagex", deprecation=9552)
 
```



---

Comment by fbissey created at 2016-03-02 20:36:56

Re-building and running doctests to find any needed `import sage.misc.cython`.


---

Comment by git created at 2016-03-03 04:21:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-03 07:17:11

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2016-03-03 07:17:11

If you would like to have a look and mark it positive Jeroen.


---

Comment by jdemeyer created at 2016-03-03 08:23:03

Replying to [comment:45 fbissey]:
> If you would like to have a look and mark it positive Jeroen.

Can it wait until the next beta? There are already a lot of tickets closed-but-not-yet-in-develop involving the build system, let's not push things...


---

Comment by fbissey created at 2016-03-03 08:38:15

Sure it is turning to be a very busy beta cycle. Not sure where Volker will want to cut things out.


---

Comment by jdemeyer created at 2016-03-03 21:25:54

Is this ticket supposed to make it possible to use openblas instead of ATLAS?


---

Comment by jdemeyer created at 2016-03-03 21:27:45

New commits:


---

Comment by fbissey created at 2016-03-03 21:31:15

Not quite. We still haven't converted numpy/scipy to use `.pc` files - I don't know there is a ticket yet for that. And there is a ticket to select your blas somewhere. But once we deal with numpy/scipy you could get there with a bit of hand holding.


---

Comment by vbraun created at 2016-03-03 21:34:01

There is no way to NOT build ATLAS afaik so thats still missing....


---

Comment by fbissey created at 2016-03-03 21:40:20

Someone determined could link `build/pkgs/atlas` to `build/pkgs/openblas` but I have to agree that's not really something I can recommend.


---

Comment by jdemeyer created at 2016-03-03 22:38:36

Replying to [comment:54 vbraun]:
> There is no way to NOT build ATLAS afaik so thats still missing....

Right, but I meant the `pkgconfig` part...


---

Comment by fbissey created at 2016-03-03 23:29:04

I am looking into getting `numpy` and `scipy` on board. I'll create a ticket when I am satisfied.


---

Comment by fbissey created at 2016-03-04 04:14:32

I have started #20157 for getting `numpy` and `scipy` to use `.pc` files. But to come back to Jeroen's technical question and after working on `numpy` for a bit. If you were to build `openblas` instead `atlas` then yes it should all build and work (but there is at least one doctest producing numerical noise). Note that `numpy` tries `openblas` before `atlas`. So if you have both installed `openblas` will be favored by default.


---

Comment by jdemeyer created at 2016-03-04 06:48:14

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-03-04 06:48:14

The Sage library should depend on `pkgconfig`.


---

Comment by git created at 2016-03-04 07:15:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2016-03-04 07:16:46

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2016-03-04 22:54:28

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-03-05 09:47:53

Resolution: fixed
