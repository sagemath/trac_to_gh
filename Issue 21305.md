# Issue 21305: bispecial_factors_iterator eats all the memory

Issue created by migration from https://trac.sagemath.org/ticket/21542

Original creator: slabbe

Original creation time: 2016-09-19 14:46:10

CC:  sstarosta

This eats all the memory, starts swaping and never halts:


```
    sage: m = WordMorphism({0:[2,1,0,1,2],1:[1,2,1],2:[0]})
    sage: x = m.periodic_point(0)
    sage: it = x[:6000].bispecial_factors_iterator()
    sage: for i in range(20): print i,len(next(it))
    0 0
    1 1
    2 3
    3 7
    4 13
    5 19
    6 25
    7 35
    8 51
    9 67
    10 95
    11 139
    12 183
    13 259
    14 379
    15 499
    16 707
    17 1035
    18 1363
    ---->>> eats lot of memory

```


This one is ok:


```
    sage: m = WordMorphism({0:[2,1,0,1,2],1:[1,0,1],2:[0]})
    sage: x = m.periodic_point(0)
    sage: it = x[:6000].bispecial_factors_iterator()
    sage: for i in range(20): print i,len(next(it))
    0 0
    1 1
    2 3
    3 5
    4 7
    5 11
    6 15
    7 19
    8 23
    9 23
    10 35
    11 47
    12 59
    13 71
    14 75
    15 115
    16 155
    17 195
    18 235
    19 243
```



---

Comment by slabbe created at 2016-09-19 15:06:06

Every computed Rauzy graph is cached, causing the memory problem. With this patch:


```diff
--- a/src/sage/combinat/words/finite_word.py
+++ b/src/sage/combinat/words/finite_word.py
@@ -1355,7 +1355,7 @@ class FiniteWord_class(Word_class):
         from sage.functions.all import log
         return log(pn, base=d)/n
 
-    @cached_method
     def rauzy_graph(self, n):
         r"""
         Return the Rauzy graph of the factors of length ``n`` of ``self``.
```


I get:


```python
sage: m = WordMorphism({0:[2,1,0,1,2],1:[1,2,1],2:[0]})
sage: x = m.periodic_point(0)
sage: it = x[:6000].bispecial_factors_iterator()
sage: %time L = [len(next(it)) for _ in range(20)]
CPU times: user 26.7 s, sys: 168 ms, total: 26.9 s                                       
Wall time: 26.8 s
```



---

Comment by slabbe created at 2016-09-19 15:23:43

Using defaultdict is faster than using rauzy graphs:


```
sage: m = WordMorphism({0:[2,1,0,1,2],1:[1,2,1],2:[0]})
sage: x = m.periodic_point(0)
sage: it = x[:6000].bispecial_factors_iterator()
sage: %time L = [len(next(it)) for _ in range(20)]
CPU times: user 18.5 s, sys: 288 ms, total: 18.7 s
Wall time: 18.7 s
```


Needs review.
----
New commits:


---

Comment by slabbe created at 2016-09-19 15:23:43

Changing status from new to needs_review.


---

Comment by git created at 2016-09-20 07:59:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tmonteil created at 2016-09-30 16:57:17

Two comments:

- don't use `iteritems` since it does not exist anymore in Python3, instead, you could do something like:

```
for i in left:
    if len(left[v]) > 1:
        yield v
```


- be more precise in the name of the dicts : instead of `left`, why not call it `left_extensions`, so that `left_extensions[v]` immediately makes sense.


---

Comment by tmonteil created at 2016-09-30 16:57:17

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-10-04 07:47:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2016-10-04 07:50:22

Changing status from needs_work to needs_review.


---

Comment by tmonteil created at 2016-10-04 20:15:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-10-05 22:41:57

Resolution: fixed
