# Issue 17255: Speedup k-closure

archive/issues_017255.json:
```json
{
    "body": "Assignee: @tscrim\n\nCC:  stefan rudi @chaoxu\n\nKeywords: k-closed\n\nRight now, checking for k-closed is slow because it uses Sage sets whereas we only need python sets.\n\nIssue created by migration from https://trac.sagemath.org/ticket/17492\n\n",
    "created_at": "2014-12-13T02:27:10Z",
    "labels": [
        "component: matroid theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.8",
    "title": "Speedup k-closure",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17255",
    "user": "https://github.com/tscrim"
}
```
Assignee: @tscrim

CC:  stefan rudi @chaoxu

Keywords: k-closed

Right now, checking for k-closed is slow because it uses Sage sets whereas we only need python sets.

Issue created by migration from https://trac.sagemath.org/ticket/17492





---

archive/issue_comments_229393.json:
```json
{
    "body": "With patch:\n\n```\nsage: PR4 = RootSystem(['D',4]).root_lattice().positive_roots()\nsage: m4 = matrix(map(lambda x: x.to_vector(), PR4)).transpose()\nsage: M4 = Matroid(m4)\nsage: %timeit M4.is_k_closed(3)\n10 loops, best of 3: 147 ms per loop\nsage: %timeit M4.is_k_closed(4)\n1 loops, best of 3: 413 ms per loop\nsage: PR5 = RootSystem(['D',5]).root_lattice().positive_roots()\nsage: m5 = matrix(map(lambda x: x.to_vector(), PR5)).transpose()\nsage: M5 = Matroid(m5)\nsage: %timeit M5.is_k_closed(3)\n1 loops, best of 3: 1.45 s per loop\n```\n\nBefore:\n\n```\nsage: %timeit M4.is_k_closed(3)\n1 loops, best of 3: 776 ms per loop\nsage: %timeit M4.is_k_closed(4)\n1 loops, best of 3: 3.09 s per loop\nsage: %timeit M5.is_k_closed(3)\n1 loops, best of 3: 4.16 s per loop\n```\n\nSo we are getting a 3x~4x speedup.\n----\nNew commits:",
    "created_at": "2014-12-13T02:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229393",
    "user": "https://github.com/tscrim"
}
```

With patch:

```
sage: PR4 = RootSystem(['D',4]).root_lattice().positive_roots()
sage: m4 = matrix(map(lambda x: x.to_vector(), PR4)).transpose()
sage: M4 = Matroid(m4)
sage: %timeit M4.is_k_closed(3)
10 loops, best of 3: 147 ms per loop
sage: %timeit M4.is_k_closed(4)
1 loops, best of 3: 413 ms per loop
sage: PR5 = RootSystem(['D',5]).root_lattice().positive_roots()
sage: m5 = matrix(map(lambda x: x.to_vector(), PR5)).transpose()
sage: M5 = Matroid(m5)
sage: %timeit M5.is_k_closed(3)
1 loops, best of 3: 1.45 s per loop
```

Before:

```
sage: %timeit M4.is_k_closed(3)
1 loops, best of 3: 776 ms per loop
sage: %timeit M4.is_k_closed(4)
1 loops, best of 3: 3.09 s per loop
sage: %timeit M5.is_k_closed(3)
1 loops, best of 3: 4.16 s per loop
```

So we are getting a 3x~4x speedup.
----
New commits:



---

archive/issue_comments_229394.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-12-13T02:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229394",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_229395.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-12-20T01:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229395",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_229396.json:
```json
{
    "body": "Hi Travis,\n\nI checked out this patch and it all works as advertised. Positive review, except for one thing:\n\nA merge with 'master' was necessary before sage -b would successfully build this on my sage 6.7.  The logical thing would perhaps be to push the merged branch I created, but I hesitate to do this since my recent experience with git tell me that I might not fully understand how things work when it comes to this. Perhaps there is another, better way, and also I do not want to risk messing up your work.\n\nSo please update the branch to something that compiles out of the box, or argue that this is unnecessary. Then feel free to set this to 'positive review'.",
    "created_at": "2015-05-26T21:19:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229396",
    "user": "https://trac.sagemath.org/admin/accounts/users/Rudi"
}
```

Hi Travis,

I checked out this patch and it all works as advertised. Positive review, except for one thing:

A merge with 'master' was necessary before sage -b would successfully build this on my sage 6.7.  The logical thing would perhaps be to push the merged branch I created, but I hesitate to do this since my recent experience with git tell me that I might not fully understand how things work when it comes to this. Perhaps there is another, better way, and also I do not want to risk messing up your work.

So please update the branch to something that compiles out of the box, or argue that this is unnecessary. Then feel free to set this to 'positive review'.



---

archive/issue_comments_229397.json:
```json
{
    "body": "Replying to [comment:5 Rudi]:\n> I checked out this patch and it all works as advertised. Positive review, except for one thing:\n\nThank you for the review.\n\n> A merge with 'master' was necessary before sage -b would successfully build this on my sage 6.7.  The logical thing would perhaps be to push the merged branch I created, but I hesitate to do this since my recent experience with git tell me that I might not fully understand how things work when it comes to this. Perhaps there is another, better way, and also I do not want to risk messing up your work.\n> \n> So please update the branch to something that compiles out of the box, or argue that this is unnecessary. Then feel free to set this to 'positive review'.\n\nThe branch is merged with the latest `develop` at merge time, so if this works after merging (cleanly, i.e., without having to handle any merge conflicts) with `master` (or now `develop` at 6.8.beta0), there should be no problems.\n\nFor the record, my usual workflow is to always merge the branch into my current `develop` branch as my current spkgs might be incompatible with older versions of Sage. Plus it saves on compilation time. Also if you push it to a different branch and set that, there is no way to corrupt my work on my branch.\n\nThank you again.",
    "created_at": "2015-05-26T21:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229397",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:5 Rudi]:
> I checked out this patch and it all works as advertised. Positive review, except for one thing:

Thank you for the review.

> A merge with 'master' was necessary before sage -b would successfully build this on my sage 6.7.  The logical thing would perhaps be to push the merged branch I created, but I hesitate to do this since my recent experience with git tell me that I might not fully understand how things work when it comes to this. Perhaps there is another, better way, and also I do not want to risk messing up your work.
> 
> So please update the branch to something that compiles out of the box, or argue that this is unnecessary. Then feel free to set this to 'positive review'.

The branch is merged with the latest `develop` at merge time, so if this works after merging (cleanly, i.e., without having to handle any merge conflicts) with `master` (or now `develop` at 6.8.beta0), there should be no problems.

For the record, my usual workflow is to always merge the branch into my current `develop` branch as my current spkgs might be incompatible with older versions of Sage. Plus it saves on compilation time. Also if you push it to a different branch and set that, there is no way to corrupt my work on my branch.

Thank you again.



---

archive/issue_comments_229398.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-26T21:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229398",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_229399.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-05-26T23:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229399",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_229400.json:
```json
{
    "body": "Merge conflict (probably #18429 or #18427).",
    "created_at": "2015-05-26T23:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229400",
    "user": "https://github.com/vbraun"
}
```

Merge conflict (probably #18429 or #18427).



---

archive/issue_comments_229401.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-05-27T04:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229401",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_229402.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-05-27T04:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229402",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_229403.json:
```json
{
    "body": "Conflict was #18429, but I also merged in #18427 to be safe.",
    "created_at": "2015-05-27T04:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229403",
    "user": "https://github.com/tscrim"
}
```

Conflict was #18429, but I also merged in #18427 to be safe.



---

archive/issue_comments_229404.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-27T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17255",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17255#issuecomment-229404",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
