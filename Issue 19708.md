# Issue 19708: Asymptotic Ring: cannot construct (1/2)^n

Issue created by migration from Trac.

Original creator: cheuberg

Original creation time: 2016-01-23 05:08:54

CC:  dkrenn behackl

The following is unexpected:

```
sage: A.<n> = AsymptoticRing('QQ^n * n^QQ', ZZ)
sage: (1/2)^n
Traceback (most recent call last):
...
ValueError: 1/2 is not in Exact Term Monoid QQ^n * n^QQ
with coefficients in Integer Ring.
> *previous* ValueError: Factor 1/2 of 1/2 is neither
a coefficient (in Integer Ring) nor growth
(in Growth Group QQ^n * n^QQ).
sage: 1/2^n
(1/2)^n
```



---

Comment by cheuberg created at 2016-01-23 06:28:58


```
sage: A.<n> = AsymptoticRing('QQ^n*n^QQ', QQ)
sage: (1/2)^n
(1/2)^n
```

does work.


---

Comment by dkrenn created at 2016-01-25 18:50:58

Replying to [ticket:19945 cheuberg]:
> {{{
> sage: A.<n> = AsymptoticRing('QQ^n * n^QQ', ZZ)
> sage: (1/2)^n
> }}}

The problem is that `(1/2)^n` calls `__pow__` of the rational `1/2`. This tries `A(1/2)^n`, which fails since `1/2` is not in `A`. This also explains why it works with coefficient ring `QQ` as in [comment:1 comment:1].

As a workaround you can use

```
sage: n.rpow(1/2)
```



---

Comment by dkrenn created at 2016-01-26 08:42:12

Documented at #19961.


---

Comment by jdemeyer created at 2018-01-08 09:08:00

Changing component from asymptotic expansions to basic arithmetic.


---

Comment by git created at 2018-01-08 10:21:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-01-08 10:21:42

Changing status from new to needs_review.


---

Comment by git created at 2018-01-08 10:41:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-01-08 10:50:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-02-21 12:42:48

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2018-02-21 12:42:48


```
sage -t --long --warn-long 63.9 src/sage/rings/rational.pyx
**********************************************************************
File "src/sage/rings/rational.pyx", line 302, in sage.rings.rational.rational_power_parts
Failed example:
    (-1)^(-1/3)
Expected:
    -(-1)^(2/3)
Got:
    -1.0*(-1)^(2/3)
**********************************************************************
```



---

Comment by jdemeyer created at 2018-02-21 12:44:59

Seriously? How did that happen?


---

Comment by mmezzarobba created at 2018-02-21 13:34:12

Replying to [comment:12 jdemeyer]:
> Seriously? How did that happen?

No idea. I just thought I would review this ticket, merged your branch in the current `develop`, and ran the test suite.


---

Comment by git created at 2018-11-26 12:00:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-11-26 12:25:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-11-26 12:26:24

Rebased to 8.5.beta5.


---

Comment by jdemeyer created at 2018-11-26 12:26:24

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-11-27 03:51:44

In general, this LGTM. Have you run any timings to see if there is any change for *Q*<sup>*Z*</sup>, *Q*<sup>*Q*</sup>, and *Z*<sup>*Q*</sup>? Since these are common operations and they now go through the coercion framework (if I understand everything correctly), I want to make sure they are not (significantly) affected.


---

Comment by jdemeyer created at 2018-11-27 11:10:56

I did some timings with mixed results:

1. `QQ^ZZ` became slower by a factor 1.4 (404ns to 575ns). This is because of the overhead of `IntegerPowAction` and it's really hard to avoid this slow-down. It's also a large relative slow-down because the actual powering is very fast.

2. The old code optimized the case of powering to a rational integer (an element of `QQ` with denominator 1). The new code doesn't, leading to a slow-down for `QQ^QQ` with integral exponent.

3. `QQ^QQ` is faster if the exponent is not a rational integer.

4. `ZZ^QQ` simply delegates to `QQ^QQ` (this code is not changed), so speed gains/losses are similar to the `QQ^QQ` case.

I'm not entirely sure whether I should implement a special case for powering to a rational integer. Is this case common enough to warrant the extra code?

I also noticed that #24500 gives an additional slight slow-down for `QQ^ZZ` (about 5%). This is because powering is always a right action, so the problem that #24500 fixes does not occur for `IntegerPowAction`.


---

Comment by jdemeyer created at 2018-11-27 11:27:17

#26775 should solve most of the slow-down for `QQ^ZZ`.


---

Comment by jdemeyer created at 2018-11-27 11:36:33

Never mind, my analysis at #26775 was wrong.

Still, there is something strange with benchmarks: without changing any code, the old code slowed down from 404ns to 446ns and the new code (on top of #24500) sped up from about 600ns to 515ns. So without really changing anything (but recompiling the new code), I now have a slow-down of a factor only 1.15 for `QQ^ZZ`. Benchmarks are a strange thing...


---

Comment by jdemeyer created at 2018-11-27 11:41:51

The wildly differing timings must be something like a memory layout/cache issue.

Anyway, for `QQ^ZZ`, I give the best timings for

```
sage: a = QQ(25); b = ZZ(2); timeit('a**b', repeat=20, number=100000)
```


Vanilla 8.5.beta5:

```
100000 loops, best of 20: 397 ns per loop
```


With #19945:

```
100000 loops, best of 20: 512 ns per loop
```


With #24500 and #19945:

```
100000 loops, best of 20: 509 ns per loop
```



---

Comment by jdemeyer created at 2018-11-27 11:55:34

Most of the slowdown in this ticket is due to

```
sage: g = coercion_model.get_action; args = (QQ, ZZ, operator.pow)
sage: timeit('g(*args)', repeat=20, number=100000)
100000 loops, best of 20: 133 ns per loop
```



---

Comment by tscrim created at 2018-11-27 12:11:03

That is what I expected. I was wondering if we wanted to special case such things to avoid going through the coercion framework. I also think it is worthwhile to special case rational powers that are integers.


---

Comment by jdemeyer created at 2018-11-27 12:52:36

#26776 should gain about 20ns.


---

Comment by jdemeyer created at 2018-11-28 15:20:49

Replying to [comment:24 tscrim]:
> I was wondering if we wanted to special case such things to avoid going through the coercion framework.

More useful (if you want to do this optimization) would be to special-case integer powering in general in the coercion model.


---

Comment by jdemeyer created at 2018-11-28 15:39:23

With #26776 + #19945:

```
sage: a = QQ(25); b = ZZ(2); timeit('a**b', repeat=20, number=100000)
100000 loops, best of 20: 479 ns per loop
```



---

Comment by jdemeyer created at 2018-11-28 20:24:37

With the improvements from #26776, the slow-down is "only" 20%.


---

Comment by tscrim created at 2018-11-29 00:10:49

Replying to [comment:26 jdemeyer]:
> Replying to [comment:24 tscrim]:
> > I was wondering if we wanted to special case such things to avoid going through the coercion framework.
> 
> More useful (if you want to do this optimization) would be to special-case integer powering in general in the coercion model.

I thought we already had some special casing for this with `IntegerPowAction`?

IMO, it is really easy to accidentally construct integers that are rational numbers, so that is why I think there is some merit to special casing that. However, I don't know how often this occurs in practice. My gut tells me that exponentiation of rationals is usually not a bottleneck in most computations, so I might be being too precious here.


---

Comment by jdemeyer created at 2018-11-29 06:43:38

Replying to [comment:29 tscrim]:
> I thought we already had some special casing for this with `IntegerPowAction`?

No, we don't. It's just an ordinary action.

> IMO, it is really easy to accidentally construct integers that are rational numbers, so that is why I think there is some merit to special casing that.

Sure, I'll do that.


---

Comment by jdemeyer created at 2018-11-29 06:48:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-11-29 12:36:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-11-29 12:37:24

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-11-29 12:37:24

I optimized powering by rational integers, which is now much faster than before.


---

Comment by tscrim created at 2018-11-29 13:44:00

Thank you and also for doing the initial timings as well. When the patchbot comes back green, you can set this to a positive review.


---

Comment by jdemeyer created at 2018-11-29 16:08:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-12-01 13:43:40

Resolution: fixed
