# Issue 16191: Cleanup/reorganization of some c imports (mainly flint)

Issue created by migration from Trac.

Original creator: ohanar

Original creation time: 2014-06-03 08:36:12

This was mainly to satisfy my compulsion for clean code. This was flint focused, but also removes the scary `void *` treatment of gmp/mpir types (and makes the necessary changes to the library so cython doesn't complain -- we were doing some unkosher stuff).


---

Comment by ohanar created at 2014-06-03 08:40:26

Changing status from new to needs_review.


---

Comment by git created at 2014-06-07 04:20:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-01 12:26:57

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-10-13 18:41:20

Resolution: invalid


---

Comment by jdemeyer created at 2014-10-13 18:41:26

Resolution changed from invalid to 


---

Comment by jdemeyer created at 2014-10-13 18:41:26

Changing status from closed to new.


---

Comment by git created at 2014-10-13 18:50:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 19:24:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jpflori created at 2014-10-13 19:40:28

Argh, I basically have a branch doing the same thing...


---

Comment by git created at 2014-10-13 19:48:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 20:27:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 20:43:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 20:51:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 20:58:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 21:14:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 21:20:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 21:29:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 21:47:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-10-13 22:08:54

With the current patch, the Sage library compiles but I get

```
$ ./sage --python
Python 2.7.8 (default, Oct 13 2014, 21:11:06) 
[GCC 4.6.4] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import sage.all
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/all.py", line 87, in <module>
    from sage.misc.all       import *         # takes a while
  File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/all.py", line 89, in <module>
    from functional import (additive_order,
  File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/misc/functional.py", line 32, in <module>
    import sage.interfaces.expect
  File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 60, in <module>
    from sage.interfaces.interface import Interface, InterfaceElement, InterfaceFunction, InterfaceFunctionElement, AsciiArtString
  File "/usr/local/src/sage-git/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 42, in <module>
    from sage.structure.parent_base import ParentWithBase
  File "sage/structure/parent_base.pyx", line 1, in init sage.structure.parent_base (build/cythonized/sage/structure/parent_base.c:2134)
  File "sage/structure/parent_old.pyx", line 1, in init sage.structure.parent_old (build/cythonized/sage/structure/parent_old.c:8811)
  File "sage/structure/element.pxd", line 12, in init sage.structure.parent (build/cythonized/sage/structure/parent.c:28430)
  File "sage/structure/element.pyx", line 3096, in init sage.structure.element (build/cythonized/sage/structure/element.c:34908)
  File "sage/categories/action.pxd", line 6, in init sage.structure.coerce (build/cythonized/sage/structure/coerce.c:17114)
ImportError: dynamic module does not define init function (initaction)
```



---

Comment by jpflori created at 2014-10-14 09:09:26

Very nice error, I think I got the same issue with some of my code.
It had something to do with cython compiled stuff.


---

Comment by jpflori created at 2014-10-14 09:13:59

I'm not really found of moving everything to a "decl" subdir though I'm aware of the fmpz_poly files issue.
I would slightly find it better to move the "Fmpz_poly" class stuff somewhere else and keep the real FLINT C/Cython glue directly in "sage/libs/flint", but I won't fight for such a solution or another one though.


---

Comment by jdemeyer created at 2014-10-14 09:21:50

Replying to [comment:25 jpflori]:
> I would slightly find it better to move the "Fmpz_poly" class stuff somewhere else and keep the real FLINT C/Cython glue directly in "sage/libs/flint"
Would you prefer to move the `Fmpz_poly` class and the `fmpz_poly()` declarations in the same `.pxd` file?


---

Comment by jdemeyer created at 2014-10-14 09:22:09

Anyway, my first concern now is having something which works.


---

Comment by jpflori created at 2014-10-14 09:27:47

Sure, the fmpz_poly thing is a low priority issue (and no, I don't want to see it in the fmpz_poly.pxd file, actually I did something in my branch as you first did, i.e. add some suffix, you chose old, I chose class.)


---

Comment by jdemeyer created at 2014-10-14 09:29:12

Scary, the problem is fixed by `./sage -ba`


---

Comment by jpflori created at 2014-10-14 09:31:33

This is not very helpful but when the same issue happened to me, my browser history tells me I had a look at:
* http://stackoverflow.com/questions/8024805/cython-compiled-c-extension-importerror-dynamic-module-does-not-define-init-fu
* http://stackoverflow.com/questions/24226001/importerror-dynamic-module-does-not-define-init-function-initfizzbuzz
and I also remember it kind of got away randomly.
Maybe it was caused by old compiled files (a lot of files changed names or were moved...)


---

Comment by jdemeyer created at 2014-10-14 09:41:00

Replying to [comment:28 jpflori]:
> and no, I don't want to see it in the fmpz_poly.pxd file
Actually, why not? It's perhaps not what I would have designed initially, but maybe it's the best solution given the current situation (I don't like renaming Cython modules just for the sake of it).


---

Comment by jpflori created at 2014-10-14 10:08:24

Yeah, that might be the solution with the less side effects.
Except that doing `from sage.libs.fmpz_poly cimport *` which should basically do nothing for a `pxd` file just being glue for a C header will now (potentially) pull a bunch of actual Cython dependencies.


---

Comment by git created at 2014-10-14 12:40:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-14 13:58:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jpflori created at 2014-10-14 14:06:06

I see some `mpz_...` functions defined in Sage files have been deleted.
I guess it's because FLINT now provides similar functionalities, or at least the functions using them in Sage have changed to use other flitn functions?


---

Comment by jpflori created at 2014-10-14 14:07:00

Oops...


---

Comment by jdemeyer created at 2014-10-14 14:07:49

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-10-14 14:09:36

Replying to [comment:36 jpflori]:
> I see some `mpz_...` functions defined in Sage files have been deleted.
They were unused. Some of them are actually copied to a proper `.pyx` file where they belong.


---

Comment by jdemeyer created at 2014-10-14 14:10:00

Eventually the whole file `gmp.pxi` (and other similar ones) should be gone.


---

Comment by jpflori created at 2014-10-14 16:43:55

The array things are in the wrong places in the definition of the `nmod...` types in `types.pxd`. Apart from that it looks ok.

Could you correct that in a new commit (that is not doing a forced push).
I'm currently testing the branch in a personal branch using more stuff from flint and merging forced push can be a pain sometimes.

I'll restest everything on top of a vanilla `trac/develop` branch a little later.


---

Comment by jpflori created at 2014-10-14 16:45:54

In fact the array stuff was already misplaced before...


---

Comment by jdemeyer created at 2014-10-15 06:22:30

Replying to [comment:41 jpflori]:
> I'm currently testing the branch in a personal branch using more stuff from flint and merging forced push can be a pain sometimes.
Concerning forced pushes: in my mind (this is not official policy), forced pushes are fine _before_ setting a ticket to needs_review. The alternative is not pushing until you have something ready for review, which is worse.


---

Comment by jdemeyer created at 2014-10-15 06:26:31

Replying to [comment:41 jpflori]:
> The array things are in the wrong places in the definition of the `nmod...` types in `types.pxd`.
Please clarify (or post a reviewer patch), I have no idea what you mean.


---

Comment by jpflori created at 2014-10-15 08:40:05

There are some

```
ctypedef nmod_poly_struct[1] nmod_poly_t
```

or variations and similar
which should be

```
ctypedef nmod_poly_struct nmod_poly_t[1]
```



---

Comment by jpflori created at 2014-10-15 12:55:32

I'm basically happy with Jeroen work.

Jeroen: can you double check my latest changes?
If they suit you, lgtm.
----
New commits:


---

Comment by jdemeyer created at 2014-10-15 20:54:38

Sorry, I have no idea what to do (as reviewer) with [http://git.sagemath.org/sage.git/commit/?id=fc177409e274f01611a4bb7ae71623ee48ce655d](http://git.sagemath.org/sage.git/commit/?id=fc177409e274f01611a4bb7ae71623ee48ce655d)

The other 2 commits obviously make sense.


---

Comment by jpflori created at 2014-10-15 21:30:43

Oops.
In fact `mpir` should read `sage-6.4.beta6` and I just merged your branch into it...


---

Comment by jpflori created at 2014-10-15 21:31:03

So positive_review I assume.


---

Comment by jpflori created at 2014-10-15 21:31:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-16 21:10:26

Resolution: fixed
