# Issue 32667: Installation of sagemath-standard with build isolution

archive/issues_032667.json:
```json
{
    "body": "CC:  mkoeppe jhpalmieri dimpase @kliem\n\nCurrently, if you try to install sagemath-standard using `pip install ./src` (from SAGE_ROOT) then this fails with the following error\n\n```\n  Installing build dependencies: started\n  Installing build dependencies: finished with status 'done'\n  Getting requirements to build wheel: started\n  Getting requirements to build wheel: finished with status 'done'\n    Preparing wheel metadata: started\n    Preparing wheel metadata: finished with status 'error'\n\n  Getting requirements to build wheel ... done\n    Running command /home/tobias/sage/src/.venv/bin/python /home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpj9q6knbr\n    Exception while cythonizing source files: FileNotFoundError(2, 'No such file or directory')\n    Building interpreters for fast_callable\n    ************************************************************************\n    Traceback (most recent call last):\n      File \"/home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 349, in <module>\n        main()\n      File \"/home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 331, in main\n        json_out['return_val'] = hook(**hook_input['kwargs'])\n      File \"/home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 151, in prepare_metadata_for_build_wheel\n        return hook(metadata_directory, config_settings)\n      File \"/tmp/pip-build-env-mke9oai7/overlay/lib/python3.8/site-packages/setuptools/build_meta.py\", line 174, in prepare_metadata_for_build_wheel\n        self.run_setup()\n      File \"/tmp/pip-build-env-mke9oai7/overlay/lib/python3.8/site-packages/setuptools/build_meta.py\", line 158, in run_setup\n        exec(compile(code, __file__, 'exec'), locals())\n      File \"setup.py\", line 114, in <module>\n        aliases=cython_aliases(),\n      File \"/tmp/pip-req-build-tz70fj41/sage/env.py\", line 557, in cython_aliases\n        ecl_cflags = subprocess.run([ECL_CONFIG, \"--cflags\"], check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True).stdout.split()\n      File \"/usr/lib/python3.8/subprocess.py\", line 493, in run\n        with Popen(*popenargs, **kwargs) as process:\n      File \"/usr/lib/python3.8/subprocess.py\", line 858, in __init__\n        self._execute_child(args, executable, preexec_fn, close_fds,\n      File \"/usr/lib/python3.8/subprocess.py\", line 1704, in _execute_child\n        raise child_exception_type(errno_num, err_msg, err_filename)\n    FileNotFoundError: [Errno 2] No such file or directory: '/Users/mkoeppe/s/sage/sage-rebasing/worktree-dist/.tox/local-macos-10.15-nohomebrew-python3_xcode/local/bin/ecl-config'\n```\n\n\nI think, there are two things that should be improved:\n1. Fix the provided wheel of sage_conf. It shouldn't provide Matthias' configuration.\n2. Think about a way to install sagemath-standard with build isolution. For this the build configuration (i.e. everything that is needed for building the wheel) needs to be specified in the sagemath-standard package itself, as one cannot control only the version of the other build_requires packages to installed, but not where they are coming from. This makes it hard to use sage_conf as a build_requires dependency, since it will be usually fetched from pypi and thus doesn't take the users config into account. One option, recommended by https://setuptools.pypa.io/en/latest/deprecated/distutils/configfile.html?highlight=header#writing-the-setup-configuration-file, is \n>  As long as that information is fairly simple\u2014a list of directories to search for C header files or libraries, for example\u2014then providing a configuration file, setup.cfg, for users to edit is a cheap and easy way to solicit it.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32904\n\n",
    "created_at": "2021-11-19T12:43:16Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "title": "Installation of sagemath-standard with build isolution",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32667",
    "user": "@tobiasdiez"
}
```
CC:  mkoeppe jhpalmieri dimpase @kliem

Currently, if you try to install sagemath-standard using `pip install ./src` (from SAGE_ROOT) then this fails with the following error

```
  Installing build dependencies: started
  Installing build dependencies: finished with status 'done'
  Getting requirements to build wheel: started
  Getting requirements to build wheel: finished with status 'done'
    Preparing wheel metadata: started
    Preparing wheel metadata: finished with status 'error'

  Getting requirements to build wheel ... done
    Running command /home/tobias/sage/src/.venv/bin/python /home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpj9q6knbr
    Exception while cythonizing source files: FileNotFoundError(2, 'No such file or directory')
    Building interpreters for fast_callable
    ************************************************************************
    Traceback (most recent call last):
      File "/home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 349, in <module>
        main()
      File "/home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 331, in main
        json_out['return_val'] = hook(**hook_input['kwargs'])
      File "/home/tobias/sage/src/.venv/lib/python3.8/site-packages/pip/_vendor/pep517/in_process/_in_process.py", line 151, in prepare_metadata_for_build_wheel
        return hook(metadata_directory, config_settings)
      File "/tmp/pip-build-env-mke9oai7/overlay/lib/python3.8/site-packages/setuptools/build_meta.py", line 174, in prepare_metadata_for_build_wheel
        self.run_setup()
      File "/tmp/pip-build-env-mke9oai7/overlay/lib/python3.8/site-packages/setuptools/build_meta.py", line 158, in run_setup
        exec(compile(code, __file__, 'exec'), locals())
      File "setup.py", line 114, in <module>
        aliases=cython_aliases(),
      File "/tmp/pip-req-build-tz70fj41/sage/env.py", line 557, in cython_aliases
        ecl_cflags = subprocess.run([ECL_CONFIG, "--cflags"], check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True).stdout.split()
      File "/usr/lib/python3.8/subprocess.py", line 493, in run
        with Popen(*popenargs, **kwargs) as process:
      File "/usr/lib/python3.8/subprocess.py", line 858, in __init__
        self._execute_child(args, executable, preexec_fn, close_fds,
      File "/usr/lib/python3.8/subprocess.py", line 1704, in _execute_child
        raise child_exception_type(errno_num, err_msg, err_filename)
    FileNotFoundError: [Errno 2] No such file or directory: '/Users/mkoeppe/s/sage/sage-rebasing/worktree-dist/.tox/local-macos-10.15-nohomebrew-python3_xcode/local/bin/ecl-config'
```


I think, there are two things that should be improved:
1. Fix the provided wheel of sage_conf. It shouldn't provide Matthias' configuration.
2. Think about a way to install sagemath-standard with build isolution. For this the build configuration (i.e. everything that is needed for building the wheel) needs to be specified in the sagemath-standard package itself, as one cannot control only the version of the other build_requires packages to installed, but not where they are coming from. This makes it hard to use sage_conf as a build_requires dependency, since it will be usually fetched from pypi and thus doesn't take the users config into account. One option, recommended by https://setuptools.pypa.io/en/latest/deprecated/distutils/configfile.html?highlight=header#writing-the-setup-configuration-file, is 
>  As long as that information is fairly simple—a list of directories to search for C header files or libraries, for example—then providing a configuration file, setup.cfg, for users to edit is a cheap and easy way to solicit it.

Issue created by migration from https://trac.sagemath.org/ticket/32904





---

archive/issue_comments_466075.json:
```json
{
    "body": "Which wheel of `sage_conf` are you referring to? \nOn PyPI there are only sdists, not wheels.",
    "created_at": "2021-11-19T17:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466075",
    "user": "mkoeppe"
}
```

Which wheel of `sage_conf` are you referring to? 
On PyPI there are only sdists, not wheels.



---

archive/issue_comments_466076.json:
```json
{
    "body": "The log in the ticket description is not very useful. Best to use `pip install -v -v` so that sufficient detail is presented.",
    "created_at": "2021-11-19T17:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466076",
    "user": "mkoeppe"
}
```

The log in the ticket description is not very useful. Best to use `pip install -v -v` so that sufficient detail is presented.



---

archive/issue_comments_466077.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2021-11-19T17:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466077",
    "user": "mkoeppe"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_466078.json:
```json
{
    "body": "I looked a bit deeper into this, and the problem is that https://pypi.org/project/sage-conf/9.4.post3/#files indeed contains your config (and is automatically used as there is no version specification in the pyproject file). But as far as I could see this is improved in the most recent pre-release.\n\nBut the main question remains, I believe: How to specify the correct build config for sage if you use build isolation (which is the preferred way of installing packages).",
    "created_at": "2021-11-19T19:14:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466078",
    "user": "@tobiasdiez"
}
```

I looked a bit deeper into this, and the problem is that https://pypi.org/project/sage-conf/9.4.post3/#files indeed contains your config (and is automatically used as there is no version specification in the pyproject file). But as far as I could see this is improved in the most recent pre-release.

But the main question remains, I believe: How to specify the correct build config for sage if you use build isolation (which is the preferred way of installing packages).



---

archive/issue_comments_466079.json:
```json
{
    "body": "What's missing is certainly a version constraint for the `sage_conf` dependency (both in `pyproject.toml` and `setup.cfg`). We should add this via `build/pkgs/sage_conf/install-requires.txt`.",
    "created_at": "2021-11-19T20:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466079",
    "user": "mkoeppe"
}
```

What's missing is certainly a version constraint for the `sage_conf` dependency (both in `pyproject.toml` and `setup.cfg`). We should add this via `build/pkgs/sage_conf/install-requires.txt`.



---

archive/issue_comments_466080.json:
```json
{
    "body": "Once there is a proper version constraint, if a correct version of `sage_conf` is already installed, then the isolated build environment should take `sage_conf` from the existing installation instead of building a fresh one from the PyPI sdist.",
    "created_at": "2021-11-19T20:08:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466080",
    "user": "mkoeppe"
}
```

Once there is a proper version constraint, if a correct version of `sage_conf` is already installed, then the isolated build environment should take `sage_conf` from the existing installation instead of building a fresh one from the PyPI sdist.



---

archive/issue_comments_466081.json:
```json
{
    "body": "Looking at the 9.4.post3 tarball, yes, this sdist is not clean.\nThese files (all artifacts generated by `configure`) should not be included:\n- `sage_root/src/bin/sage-env-config`\n- `sage_root/src/bin/sage-src-env-config`\n- `sage_root/build/bin/sage-build-env-config`\n- `sage_root/build/make/Makefile-auto`\n- `sage_root/pkgs/sage-conf/sage_conf.py`\n- `sage_root/pkgs/sage-conf/bin/sage-env-config`\nAlso `sage_root/src/bin` has a bunch of other scripts that don't belong there.\n\nSome of this would just go away by running the sdist building in a clean environment (#32062 does this on GH Actions).\n\nBut it's best to fix it using `MANIFEST.in`.\n\nLet's use the present ticket to address this.",
    "created_at": "2021-11-19T20:24:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466081",
    "user": "mkoeppe"
}
```

Looking at the 9.4.post3 tarball, yes, this sdist is not clean.
These files (all artifacts generated by `configure`) should not be included:
- `sage_root/src/bin/sage-env-config`
- `sage_root/src/bin/sage-src-env-config`
- `sage_root/build/bin/sage-build-env-config`
- `sage_root/build/make/Makefile-auto`
- `sage_root/pkgs/sage-conf/sage_conf.py`
- `sage_root/pkgs/sage-conf/bin/sage-env-config`
Also `sage_root/src/bin` has a bunch of other scripts that don't belong there.

Some of this would just go away by running the sdist building in a clean environment (#32062 does this on GH Actions).

But it's best to fix it using `MANIFEST.in`.

Let's use the present ticket to address this.



---

archive/issue_comments_466082.json:
```json
{
    "body": "Replying to [ticket:32904 gh-tobiasdiez]:\n> One option, recommended by https://setuptools.pypa.io/en/latest/deprecated/distutils/configfile.html?highlight=header#writing-the-setup-configuration-file, is \n> >  As long as that information is fairly simple\u2014a list of directories to search for C header files or libraries, for example\u2014then providing a configuration file, setup.cfg, for users to edit is a cheap and easy way to solicit it. \n\nYeah, no, these are ancient practices and we will not start with this\n----\nLast 10 new commits:",
    "created_at": "2021-11-19T21:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466082",
    "user": "mkoeppe"
}
```

Replying to [ticket:32904 gh-tobiasdiez]:
> One option, recommended by https://setuptools.pypa.io/en/latest/deprecated/distutils/configfile.html?highlight=header#writing-the-setup-configuration-file, is 
> >  As long as that information is fairly simple—a list of directories to search for C header files or libraries, for example—then providing a configuration file, setup.cfg, for users to edit is a cheap and easy way to solicit it. 

Yeah, no, these are ancient practices and we will not start with this
----
Last 10 new commits:



---

archive/issue_comments_466083.json:
```json
{
    "body": "Replying to [ticket:32904 gh-tobiasdiez]:\n> one cannot control only the version of the other build_requires packages to installed,\n> but not where they are coming from. \n\nActually one can, at least in some use cases, by using `--no-index --find-links ...`.\nSee for example `pkgs/sagemath-standard/tox.ini`. \n\n> This makes it hard to use sage_conf as a build_requires dependency, since it will be usually fetched from pypi and thus doesn't take the users config into account.\n\nActually the version of **sage-conf** on PyPI comes from `pkgs/sage-conf_pypi` (from #29039) and runs the `configure` script upon installation.",
    "created_at": "2021-11-19T21:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466083",
    "user": "mkoeppe"
}
```

Replying to [ticket:32904 gh-tobiasdiez]:
> one cannot control only the version of the other build_requires packages to installed,
> but not where they are coming from. 

Actually one can, at least in some use cases, by using `--no-index --find-links ...`.
See for example `pkgs/sagemath-standard/tox.ini`. 

> This makes it hard to use sage_conf as a build_requires dependency, since it will be usually fetched from pypi and thus doesn't take the users config into account.

Actually the version of **sage-conf** on PyPI comes from `pkgs/sage-conf_pypi` (from #29039) and runs the `configure` script upon installation.



---

archive/issue_comments_466084.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2021-11-19T21:27:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466084",
    "user": "mkoeppe"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_466085.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> Once there is a proper version constraint, if a correct version of `sage_conf` is already installed, then the isolated build environment should take `sage_conf` from the existing installation instead of building a fresh one from the PyPI sdist.\n\nI thought so too but it turns out that `pip` specifies `--ignore-installed` when constructing the isolated build environment, see https://github.com/pypa/pip/issues/6482.\nThus it will most likely fetch pypi, or if you are lucky use the a locally cached wheel. So that doesn't seem to work.\n\nThe version constraint makes sense in either case in my opinion.",
    "created_at": "2021-11-19T21:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466085",
    "user": "@tobiasdiez"
}
```

Replying to [comment:7 mkoeppe]:
> Once there is a proper version constraint, if a correct version of `sage_conf` is already installed, then the isolated build environment should take `sage_conf` from the existing installation instead of building a fresh one from the PyPI sdist.

I thought so too but it turns out that `pip` specifies `--ignore-installed` when constructing the isolated build environment, see https://github.com/pypa/pip/issues/6482.
Thus it will most likely fetch pypi, or if you are lucky use the a locally cached wheel. So that doesn't seem to work.

The version constraint makes sense in either case in my opinion.



---

archive/issue_comments_466086.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-19T21:57:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466086",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_466087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-11-19T22:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466087",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_466088.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-11-19T23:25:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466088",
    "user": "mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_466089.json:
```json
{
    "body": "After this patch, it ends up with\n\n```\nSuccessfully installed sagemath-standard-9.5b7\n```\n\n\nWhat's the correct name of the module it installs? (Neither `-` not `.` are allowed in names, as far as I understand, and indeed importing the name above fails).",
    "created_at": "2021-12-05T09:01:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466089",
    "user": "dimpase"
}
```

After this patch, it ends up with

```
Successfully installed sagemath-standard-9.5b7
```


What's the correct name of the module it installs? (Neither `-` not `.` are allowed in names, as far as I understand, and indeed importing the name above fails).



---

archive/issue_comments_466090.json:
```json
{
    "body": "Read the documentation added in #32899, it explains all of that",
    "created_at": "2021-12-05T09:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466090",
    "user": "mkoeppe"
}
```

Read the documentation added in #32899, it explains all of that



---

archive/issue_comments_466091.json:
```json
{
    "body": "Does this really work for you with build isolation?\nFor me it still fetches the locally-cached version or the one from pypi if the version of `sage_conf` specified in `src/pyproject.toml` is available there. That's also the expected behavior as I've outlined above in #32904#comment:7\n\nThus adding the version constraint might work for production (i.e. external people downloading both sagemath and sage-conf from pypi) but not for development. Moreover, if I understand the documentation correctly than sage-conf from pypi is very expensive to install and needs to be done twice (once to be in the final venv and once to build sagemath-standard). Thus this is also not ideal.",
    "created_at": "2021-12-05T10:05:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466091",
    "user": "@tobiasdiez"
}
```

Does this really work for you with build isolation?
For me it still fetches the locally-cached version or the one from pypi if the version of `sage_conf` specified in `src/pyproject.toml` is available there. That's also the expected behavior as I've outlined above in #32904#comment:7

Thus adding the version constraint might work for production (i.e. external people downloading both sagemath and sage-conf from pypi) but not for development. Moreover, if I understand the documentation correctly than sage-conf from pypi is very expensive to install and needs to be done twice (once to be in the final venv and once to build sagemath-standard). Thus this is also not ideal.



---

archive/issue_comments_466092.json:
```json
{
    "body": "Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses \n\nIf you use `--no-index`, it will not fetch the version from PyPI. \n\nIf you combine it with `--find-links=SAGE_VENV/var/lib/sage/wheels`, then it will take the prebuilt `sage_conf` wheel from there, both for build and for install.\n\n(Hence, #32913 - Revert #32713 (Apply \"configure --enable-editable\" to other packages) for sage-conf, sage-setup... waiting for review)",
    "created_at": "2021-12-05T17:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466092",
    "user": "mkoeppe"
}
```

Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses 

If you use `--no-index`, it will not fetch the version from PyPI. 

If you combine it with `--find-links=SAGE_VENV/var/lib/sage/wheels`, then it will take the prebuilt `sage_conf` wheel from there, both for build and for install.

(Hence, #32913 - Revert #32713 (Apply "configure --enable-editable" to other packages) for sage-conf, sage-setup... waiting for review)



---

archive/issue_comments_466093.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> Read the documentation added in #32899, it explains all of that\n\nI don't think it really answers my question - what is the name of the Python module being installed here?",
    "created_at": "2021-12-05T18:17:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466093",
    "user": "dimpase"
}
```

Replying to [comment:19 mkoeppe]:
> Read the documentation added in #32899, it explains all of that

I don't think it really answers my question - what is the name of the Python module being installed here?



---

archive/issue_comments_466094.json:
```json
{
    "body": "It does:\n- \"A distribution that provides Python modules in the :mod:`sage.*` namespace, say mainly from :mod:`sage.PAC.KAGE`, should be named **sagemath-DISTRI-BUTION**.\"\n- \"Other distributions should not use the prefix **sagemath-** in the distribution name.\"\n\nTherefore, **sagemath-standard** provides modules in the `sage.*` namespace.\nNamely, all of the Sage library",
    "created_at": "2021-12-05T18:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466094",
    "user": "mkoeppe"
}
```

It does:
- "A distribution that provides Python modules in the :mod:`sage.*` namespace, say mainly from :mod:`sage.PAC.KAGE`, should be named **sagemath-DISTRI-BUTION**."
- "Other distributions should not use the prefix **sagemath-** in the distribution name."

Therefore, **sagemath-standard** provides modules in the `sage.*` namespace.
Namely, all of the Sage library



---

archive/issue_comments_466095.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses \n\nAs I said above, pip specifies `ignore-installed` while constructing the build environment and thus will build sage-conf twice.\nPlease convince yourself if you don't believe me:\nhttps://github.com/pypa/pip/blob/main/src/pip/_internal/build_env.py#L221\n\nThis is discussed in many issues on the pip repo, some examples:\nhttps://github.com/pypa/pip/issues/6482\nhttps://github.com/pypa/pip/issues/9542\nhttps://github.com/pypa/pip/issues/9439\nAll of these issues deal with (different) problems that come from taking \"build isolation\" as literally as pip is doing. The two major issues being that build and runtime dependencies are downloaded and build twice, and that there is no guarantee that build and runtime dependencies use the same version.\nIt also seems that this is not something that will be fixed relatively soon.\n\nIn particular, the following will definitely build sage-conf twice, especially with the changes in this ticket:\n\n```\npip install sage-conf==9.5\npip install sagemath==9.6\n```\n\nThat may look like a silly example and no user would probably run this directly, but such a situation may happen quickly if you use packages that specify different but compatible versions of sagemath; or if you e.g. build sage-conf yourself locally; or if you upgrade sagemath later (which would trigger another installation of sage-conf).\nAlso note that sagemath 9.6 will probably work well with sage-conf 9.5 since the latter is after installation nothing more than a glorified configuration file and thus rarely changes (once the changes to the build system due to the modularization settle down).\n\n\nYour suggestion to use `no-index` or `find-links` works for development, but not for end-user that want to use the sagemath package from pypi. \n\nThe options I see are:\n- Accept that sage doesn't work with build isolation (which would be unfortunate)\n- Split `sage-conf` into build and runtime configuration. There is still an overlap (and thus duplication) but at built time sage needs less dependencies than at runtime. In addition, maybe directly incorporate the build-time sage-conf in the sagemath package.\n- Merge sage-conf in sagemath (I guess there was a reason to split it out in the first place; which?)\n- Explore different options to pass the built-time configuration to sagemath, e.g. using a script that sets the correct env variables or writes an `env` file; use `package-config` as described in [PEP 517](https://www.python.org/dev/peps/pep-0517/#config-settings) to set the configuration or point to a config file.",
    "created_at": "2021-12-05T19:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466095",
    "user": "@tobiasdiez"
}
```

Replying to [comment:21 mkoeppe]:
> Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses 

As I said above, pip specifies `ignore-installed` while constructing the build environment and thus will build sage-conf twice.
Please convince yourself if you don't believe me:
https://github.com/pypa/pip/blob/main/src/pip/_internal/build_env.py#L221

This is discussed in many issues on the pip repo, some examples:
https://github.com/pypa/pip/issues/6482
https://github.com/pypa/pip/issues/9542
https://github.com/pypa/pip/issues/9439
All of these issues deal with (different) problems that come from taking "build isolation" as literally as pip is doing. The two major issues being that build and runtime dependencies are downloaded and build twice, and that there is no guarantee that build and runtime dependencies use the same version.
It also seems that this is not something that will be fixed relatively soon.

In particular, the following will definitely build sage-conf twice, especially with the changes in this ticket:

```
pip install sage-conf==9.5
pip install sagemath==9.6
```

That may look like a silly example and no user would probably run this directly, but such a situation may happen quickly if you use packages that specify different but compatible versions of sagemath; or if you e.g. build sage-conf yourself locally; or if you upgrade sagemath later (which would trigger another installation of sage-conf).
Also note that sagemath 9.6 will probably work well with sage-conf 9.5 since the latter is after installation nothing more than a glorified configuration file and thus rarely changes (once the changes to the build system due to the modularization settle down).


Your suggestion to use `no-index` or `find-links` works for development, but not for end-user that want to use the sagemath package from pypi. 

The options I see are:
- Accept that sage doesn't work with build isolation (which would be unfortunate)
- Split `sage-conf` into build and runtime configuration. There is still an overlap (and thus duplication) but at built time sage needs less dependencies than at runtime. In addition, maybe directly incorporate the build-time sage-conf in the sagemath package.
- Merge sage-conf in sagemath (I guess there was a reason to split it out in the first place; which?)
- Explore different options to pass the built-time configuration to sagemath, e.g. using a script that sets the correct env variables or writes an `env` file; use `package-config` as described in [PEP 517](https://www.python.org/dev/peps/pep-0517/#config-settings) to set the configuration or point to a config file.



---

archive/issue_comments_466096.json:
```json
{
    "body": "Replying to [comment:24 gh-tobiasdiez]:\n> Replying to [comment:21 mkoeppe]:\n> > Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses \n> \n> As I said above, pip specifies `ignore-installed` while constructing the build environment and thus will build sage-conf twice.\n\nIt reuses `SAGE_LOCAL`, which resides in a subdirectory of `~/.sage`, so it does NOT build the distribution twice.",
    "created_at": "2021-12-05T19:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466096",
    "user": "mkoeppe"
}
```

Replying to [comment:24 gh-tobiasdiez]:
> Replying to [comment:21 mkoeppe]:
> > Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses 
> 
> As I said above, pip specifies `ignore-installed` while constructing the build environment and thus will build sage-conf twice.

It reuses `SAGE_LOCAL`, which resides in a subdirectory of `~/.sage`, so it does NOT build the distribution twice.



---

archive/issue_comments_466097.json:
```json
{
    "body": "With the present ticket, `sagemath-standard` declares the same version constraints on `sage_conf` for both build and install. \n\nHow strict this version constraint has to be will have to be seen as we gain more experience with it. Fixing it to the same version as `sagemath-standard` will be safe but perhaps unnecessarily strict.",
    "created_at": "2021-12-05T19:41:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466097",
    "user": "mkoeppe"
}
```

With the present ticket, `sagemath-standard` declares the same version constraints on `sage_conf` for both build and install. 

How strict this version constraint has to be will have to be seen as we gain more experience with it. Fixing it to the same version as `sagemath-standard` will be safe but perhaps unnecessarily strict.



---

archive/issue_comments_466098.json:
```json
{
    "body": "Replying to [comment:24 gh-tobiasdiez]:\n> - Merge sage-conf in sagemath\n\nThat would be equivalent to just pinning the version of `sage_conf` with `==`,\nand is less flexible.",
    "created_at": "2021-12-05T19:46:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466098",
    "user": "mkoeppe"
}
```

Replying to [comment:24 gh-tobiasdiez]:
> - Merge sage-conf in sagemath

That would be equivalent to just pinning the version of `sage_conf` with `==`,
and is less flexible.



---

archive/issue_comments_466099.json:
```json
{
    "body": "I have narrowed the ticket description to what is being done on the branch.\n\nFor more general discussion of how to improve configuration, let's use Meta-ticket #21707 (\"Split `sage-env` into 5 to clean up sage configuration\")",
    "created_at": "2021-12-05T19:50:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466099",
    "user": "mkoeppe"
}
```

I have narrowed the ticket description to what is being done on the branch.

For more general discussion of how to improve configuration, let's use Meta-ticket #21707 ("Split `sage-env` into 5 to clean up sage configuration")



---

archive/issue_comments_466100.json:
```json
{
    "body": "Replying to [comment:25 mkoeppe]:\n> Replying to [comment:24 gh-tobiasdiez]:\n> > Replying to [comment:21 mkoeppe]:\n> > > Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses \n> > \n> > As I said above, pip specifies `ignore-installed` while constructing the build environment and thus will build sage-conf twice.\n> \n> It reuses `SAGE_LOCAL`, which resides in a subdirectory of `~/.sage`, so it does NOT build the distribution twice.\n\nSo you mean that sage-conf would be installed twice, but the second installation is considerably quicker since most of the built output is 'cached' in SAGE_LOCAL?\n\nThat's nice and probably takes care of the issue for end-user. For development, the workarounds of not using build isolation or no-index/find-files are working.\n\nThe ticket generally looks good to me, especially with the narrowed focus.\nTwo questions:\n> sage-conf ~= 9.5.b6\n\nshouldn't this be `==` to reduce the potential for issues in the future? Once a bit of experience is collected one may play around and see if less strict constraints are sufficient?\n\nWhat's the purpose of the added symlinks?",
    "created_at": "2021-12-05T20:22:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466100",
    "user": "@tobiasdiez"
}
```

Replying to [comment:25 mkoeppe]:
> Replying to [comment:24 gh-tobiasdiez]:
> > Replying to [comment:21 mkoeppe]:
> > > Yes, installing the version from PyPI is expensive, as it is equivalent to building the Sage distribution from source. It is only done once, though, as it reuses 
> > 
> > As I said above, pip specifies `ignore-installed` while constructing the build environment and thus will build sage-conf twice.
> 
> It reuses `SAGE_LOCAL`, which resides in a subdirectory of `~/.sage`, so it does NOT build the distribution twice.

So you mean that sage-conf would be installed twice, but the second installation is considerably quicker since most of the built output is 'cached' in SAGE_LOCAL?

That's nice and probably takes care of the issue for end-user. For development, the workarounds of not using build isolation or no-index/find-files are working.

The ticket generally looks good to me, especially with the narrowed focus.
Two questions:
> sage-conf ~= 9.5.b6

shouldn't this be `==` to reduce the potential for issues in the future? Once a bit of experience is collected one may play around and see if less strict constraints are sufficient?

What's the purpose of the added symlinks?



---

archive/issue_comments_466101.json:
```json
{
    "body": "Replying to [comment:30 gh-tobiasdiez]:\n> Replying to [comment:25 mkoeppe]:\n> > It reuses `SAGE_LOCAL`, which resides in a subdirectory of `~/.sage`, so it does NOT build the distribution twice.\n> \n> So you mean that sage-conf would be installed twice, but the second installation is considerably quicker since most of the built output is 'cached' in SAGE_LOCAL?\n\nYes, that's right.",
    "created_at": "2021-12-05T20:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466101",
    "user": "mkoeppe"
}
```

Replying to [comment:30 gh-tobiasdiez]:
> Replying to [comment:25 mkoeppe]:
> > It reuses `SAGE_LOCAL`, which resides in a subdirectory of `~/.sage`, so it does NOT build the distribution twice.
> 
> So you mean that sage-conf would be installed twice, but the second installation is considerably quicker since most of the built output is 'cached' in SAGE_LOCAL?

Yes, that's right.



---

archive/issue_comments_466102.json:
```json
{
    "body": "Replying to [comment:30 gh-tobiasdiez]:\n> What's the purpose of the added symlinks?\n\nThe branch is replacing the symlink to `src/bin` by separate symlinks to the scripts that it actually needs",
    "created_at": "2021-12-05T20:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466102",
    "user": "mkoeppe"
}
```

Replying to [comment:30 gh-tobiasdiez]:
> What's the purpose of the added symlinks?

The branch is replacing the symlink to `src/bin` by separate symlinks to the scripts that it actually needs



---

archive/issue_comments_466103.json:
```json
{
    "body": "okay, thanks for the clarification.\n\nLGTM. Dima, feel free to set it to positive review if it's working for you.",
    "created_at": "2021-12-05T20:57:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466103",
    "user": "@tobiasdiez"
}
```

okay, thanks for the clarification.

LGTM. Dima, feel free to set it to positive review if it's working for you.



---

archive/issue_comments_466104.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-05T21:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466104",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_466105.json:
```json
{
    "body": "OK",
    "created_at": "2021-12-05T21:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466105",
    "user": "dimpase"
}
```

OK



---

archive/issue_comments_466106.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-12-05T21:23:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466106",
    "user": "mkoeppe"
}
```

Thanks!



---

archive/issue_comments_466107.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-01T00:23:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32667",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32667#issuecomment-466107",
    "user": "vbraun"
}
```

Resolution: fixed
