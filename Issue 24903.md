# Issue 24903: Add spkg-legacy-uninstall scripts for most standard packages

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-04-10 17:42:39

This is a followup to #25139 and represents work that was originally done in #22510 to convert most packages to use `spkg-legacy-uninstall` and remove uninstall-related commands from their `spkg-install` scripts.

This work was brought over from an older branch and still needs some adjustment: It should incorporate the changes from the #24024 metaticket which conflict with some of these changes.  There are also some additional optional and experimental packages (and maybe a couple standard packages) that still need to be updated as well.

Probably won't bother with that until and unless #25139 is approved of in some form that still includes the `spkg-legacy-uninstall` feature.


---

Comment by embray created at 2018-04-10 17:49:32

Changing keywords from "" to "uninstall".


---

Comment by embray created at 2018-04-10 17:49:32

Changing component from PLEASE CHANGE to build.


---

Comment by git created at 2018-07-10 17:22:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-07-10 17:24:37

As a reminder, the goal of this is to make it so that `spkg-install` scripts do not modify the contents of `$SAGE_LOCAL` directly.


---

Comment by embray created at 2018-07-10 17:24:37

Changing status from new to needs_review.


---

Comment by git created at 2018-07-11 16:46:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-11 16:48:35

Added `spkg-legacy-uninstall` for a few packages that could use it.

This is now done for at least most, if not all packages that have DESTDIR support from #24024.  It doesn't make sense to do for packages that haven't been converted to the new install/uninstall method yet.  However, for any remaining packages that need to be converted, they should also get an `spkg-legacy-uninstall` at the same time, where appropriate.


---

Comment by saraedum created at 2018-07-17 15:28:12

Feel free to set this to positive review if you are confident that this still works.


---

Comment by embray created at 2018-07-17 16:35:30

The pyflakes plugin found an actual bug in the elliptic_curves package; it wasn't otherwise caught since I didn't bump the package versions for this (it isn't really necessary to).

I think I should fix that, and test doing a forced-reinstall of all these packages.  I know I did that a long time ago back when this was part of #22510, but that was then...


---

Comment by embray created at 2018-07-17 16:35:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-07-17 16:37:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by embray created at 2018-07-24 09:02:01

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-08-07 12:24:17

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-08-07 12:24:17

First of all, there are merge conflicts.

Second, do we really need this? I understand that you want to clean up the `spkg-install` scripts, but we can do that gradually as we upgrade packages anyway. I don't really see the point of adding a whole new feature only for backwards compatibility in cases where it almost never matters (typically, it's not a problem to skip the uninstall).

I'm not actively against this ticket, it's just that I don't see the point.


---

Comment by embray created at 2018-08-08 13:22:17

Replying to [comment:13 jdemeyer]:
> First of all, there are merge conflicts.

Well I mean, there weren't 2 weeks ago and that's obviously resolvable so it's not a big deal.

> Second, do we really need this? I understand that you want to clean up the `spkg-install` scripts, but we can do that gradually as we upgrade packages anyway. I don't really see the point of adding a whole new feature only for backwards compatibility in cases where it almost never matters (typically, it's not a problem to skip the uninstall).
> 
> I'm not actively against this ticket, it's just that I don't see the point.

I'm not in any hurry on this and am also happy to do it gradually.  Though since it's already done I don't see the point in _not_ just going ahead and merging this now either.  It would be more work at this point not to.


---

Comment by git created at 2018-08-08 13:25:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-08-08 13:25:38

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-08-09 00:01:16

Looks good to me.


---

Comment by saraedum created at 2018-08-09 00:01:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-11 16:55:31

Resolution: fixed


---

Comment by vbraun created at 2018-08-12 09:05:45

Changing status from closed to new.


---

Comment by vbraun created at 2018-08-12 09:05:45

When reinstalling an already installed elliptic_curves:

```
$ ./sage -p elliptic_curves
[...]
No record that 'elliptic_curves' was ever installed; skipping uninstall
Creating database /mnt/disk/home/release/Sage/local/share/cremona/cremona_mini.db
Traceback (most recent call last):
  File "spkg-install.py", line 89, in <module>
    install_cremona()
  File "spkg-install.py", line 31, in install_cremona
    con.execute('CREATE TABLE t_class(rank INTEGER, class TEXT PRIMARY KEY,'
sqlite3.OperationalError: table t_class already exists

real	0m0.161s
user	0m0.053s
sys	0m0.028s
************************************************************************
Error installing package elliptic_curves-0.8.p0
************************************************************************
```

This breaks incremental rebuilds...


---

Comment by vbraun created at 2018-08-12 09:05:45

Resolution changed from fixed to 


---

Comment by vbraun created at 2018-08-12 09:06:53

Please check that all packages can be installed twice before settings back to positive review.


---

Comment by embray created at 2018-08-14 15:45:02

New commits:


---

Comment by git created at 2018-08-14 16:05:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-08-14 16:06:36

Yes, there were still several problems with the spkg-install for elliptic_curves; I think it should just be updated in a separate ticket.  It should not have been included in this ticket in the first place since it was only intending to update packages that already had working DESTDIR support.
----
New commits:


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by git created at 2019-01-09 17:45:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-01-09 17:46:56

Set assignee to embray.


---

Comment by embray created at 2019-01-09 17:46:56

Rebased this, though some of these are now handled in other tickets so I need to clean it up a bit more (focus only on packages that already otherwise have been fixed as part of #24024).


---

Comment by embray created at 2019-03-25 10:44:36

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.
