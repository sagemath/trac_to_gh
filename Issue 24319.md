# Issue 24319: py3: fix raise StopIteration in generator statements

Issue created by migration from https://trac.sagemath.org/ticket/24556

Original creator: embray

Original creation time: 2018-01-17 10:11:10

Since [PEP-479](https://www.python.org/dev/peps/pep-0479/) it's deprecated to call `raise StopIteration` from within a generator (eventually this will cause a `RuntimeError` to be raised).

Per the PEP:

> Finally, the proposal also clears up the confusion about how to terminate a generator: the proper way is `return`, not `raise StopIteration`.

This fixes several generators in Sage (I think all) that used `raise StopIteration` inappropriately according to the PEP.


---

Comment by git created at 2018-01-17 10:11:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-17 14:20:40

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-01-17 15:27:29

Trivial failure in `src/sage/graphs/graph_generators.py` due to change in error message. Once fixed, you can set a positive review on my behalf.


---

Comment by embray created at 2018-01-18 16:39:45

Turns out if you return a value from a generator with the `return` statement it will be passed as the first argument to the implicitly raised `StopIteration` so I should just do that.


---

Comment by embray created at 2018-01-18 16:41:02

Oh, but that only works on Python 3.  In that case I'll special case this one.  The message isn't really important but I'd still rather keep the existing behavior.


---

Comment by git created at 2018-01-18 16:46:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-01-19 08:25:56

No, that still doesn't work.  Having the return statement with a return value inside a generator is a syntax error at compilation time on Python 2.  Strangely my build didn't fail because of that...


---

Comment by git created at 2018-01-19 09:01:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-01-19 09:03:54

Ended up just changing the test.  Not thrilled about that, but I can't think of a good way to support this use case in cross-compatible manner (it's actually technically Python 3.3 where return value from a generator became allowed).  The only way I can think of is a decorator along with a special exception class for returning a value out of the generator, and then re-raising it as a `StopIteration`.  But that's a lot of cognitive overhead for a use case that, in this case anyway, is not very important.  The message is helpful, but not critical.


---

Comment by tscrim created at 2018-01-19 14:51:39

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-01-19 14:51:39

Agreed.


---

Comment by vbraun created at 2018-01-20 20:20:14

Resolution: fixed
