# Issue 28714: Fixing a bug in sage.schemes.cyclic_covers.charpoly_frobenius

Issue created by migration from https://trac.sagemath.org/ticket/28951

Original creator: edgarcosta

Original creation time: 2020-01-04 18:42:25

CC:  alexjbest

This fixes the following error

```
/Applications/sage-dev/local/lib/python2.7/site-packages/sage/schemes/cyclic_covers/charpoly_frobenius.pyc in charpoly_frobenius(frob_matrix, charpoly_prec, p, weight, a, known_factor)
    220         if known_factor != [1]:
    221             raise NotImplementedError()
--> 222         for i in range(degree / 2):
    223             p_power = p**min(
    224                 charpoly_prec[i],

TypeError: range() integer end argument expected, got float.
```


and I also add a test, to verify that the bug has been fixed.


---

Comment by chapoton created at 2020-01-04 19:12:03

you could use `degree // 2`


---

Comment by git created at 2020-01-04 19:15:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2020-01-04 19:15:43

I have replaced the `floor` by `//`.


---

Comment by edgarcosta created at 2020-01-15 22:03:06

Alex, could you review this?


---

Comment by edgarcosta created at 2020-01-15 22:03:06

Changing status from new to needs_review.


---

Comment by tscrim created at 2020-01-16 03:23:31

This is not equivalent:

```diff
-    halfdegree = ceil(degree / 2) + 1
+    halfdegree = degree // 2 + 1
```

Instead you have you use

```python
    halfdegree = (degree + 1) // 2 + 1
```

Also, does the test matrix need to be so big?


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by DavidLowry created at 2020-08-10 18:29:32

I looked into this for a bit today. After rebasing, this works as expected. But there is one aspect I don't understand, related to what tscrim pointed out before.

I notice the current tests pass when the line 


```python
halfdegree = degree // 2 + 1
```


is replaced by the line


```python
halfdegree = (degree + 1) // 2 + 1
```


but not with either `(degree - 1)//2 + 1` or `(degree + 2)//2 + 1`. Thus sometimes the function behaves largely the same even when `halfdegree` differs by 1, but not always. I didn't track this dependence on parity, but this surprises me a little bit.


---

Comment by git created at 2020-08-13 20:31:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-13 20:51:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-08-13 21:21:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2020-08-13 21:29:58

0- I have replaced the original example with a smaller example.

1- I have replaced the original `degree/2` with `(degree + 1)//2`, as I'm comparing the ith coefficient and  (degree - i)th coefficient to figure out the sign of functional equation.
In the case that degree is even, I don't want to compare the middle coefficient against itself.
So, if `degree=2n` the loop ranges over `0,...,n-1`, and if `degree=2n+1`, the degree loops over `0, ..., n`.

2- I replaced `halfdegree = ceil(degree / 2) + 1` with `degree // 2 + 1`. This is the number 
of coefficients that we will compute, so if `degree=2n` or `degree=2n+1` we will compute the coefficients `0, ...,n`. In the previous version we were unecessarily computing one extra coefficient.


---

Comment by chapoton created at 2020-08-14 06:21:01

There is a new division by two in the power of p :

```
p**(a * degree * weight / 2)
```

maybe it could use an exact division `//` ?


---

Comment by git created at 2020-08-14 19:35:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by edgarcosta created at 2020-08-14 19:39:36

Those are irrelevant as degree*weight is always even, but to avoid any confusion I converted every division to integer division


---

Comment by DavidLowry created at 2020-08-14 20:43:47

Excellent. This looks good to me. When patchbot finishes, this can be set to a positive review.


---

Comment by DavidLowry created at 2020-08-14 21:58:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-15 09:41:50

Resolution: fixed
