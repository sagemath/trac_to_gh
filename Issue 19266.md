# Issue 19266: strip TESTS blocks in introspection

Issue created by migration from https://trac.sagemath.org/ticket/19503

Original creator: jhpalmieri

Original creation time: 2015-10-30 04:54:04

CC:  jmantysalo ncohen

When a user types

```
sage: foo?
```

we should hide the `TESTS` block: it should hold doctests which are too technical to be helpful. (They should still be visible from `foo??`: if a user wants to see the source code, we shouldn't hide anything.)

`TESTS` blocks should be shown in the reference manual by default, for completeness, but running `sage --docbuild --no-tests DOCUMENT FORMAT` will cause them to be skipped, as will setting the environment variable `SAGE_SKIP_TESTS_BLOCKS`.


---

Comment by jhpalmieri created at 2015-10-30 04:54:51

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2015-10-30 05:03:47

The branch currently has two commits. One is brief and contains the main code for skipping these blocks. The other is long and does clean up on various TESTS blocks scattered through the Sage library. Some of the clean up just fixes indentation errors. Some is needed to make the blocks work with the skipping code: "TESTS::" (singular or plural, one colon or two) must be on a line by itself, so I changed

```
TESTS: text here::
```

to

```
TESTS:

text here::
```

Also, the end of a "TESTS" block is detected when we come across a word in all capitals followed by a colon ("REFERENCES:") or by a Sphinx directive (two dots, space, word, double colon, ".. TODO::"). In some cases, we had

```
TESTS:

.. note::
```

so I moved the ".. note::" to before the test, if that seemed to make sense.
----
New commits:


---

Comment by jdemeyer created at 2015-10-30 06:00:42

Why did you _remove_ `TESTS:` in some places?


---

Comment by jdemeyer created at 2015-10-30 06:05:55

Do we really need a new environment variable for this? I don't think so.


---

Comment by jdemeyer created at 2015-10-30 06:08:43

This should be in the manual about `TESTS` blocks:

Replying to [comment:3 jhpalmieri]:
> Also, the end of a "TESTS" block is detected when we come across a word in all capitals followed by a colon ("REFERENCES:") or by a Sphinx directive (two dots, space, word, double colon, ".. TODO::").


---

Comment by jhpalmieri created at 2015-10-30 15:13:49

Replying to [comment:5 jdemeyer]:
> Why did you _remove_ `TESTS:` in some places?

I only did this when there was a block like this:

```
TESTS:
   some tests
TESTS:
   more tests
```

Then I removed the second instance.

Regarding the manual, I added something. I can put it more detail if you want.

Regarding the environment variable, is there another good way to control the docbuilding process? (Is it even worth providing the option for skipping these blocks in docbuilding?)


---

Comment by git created at 2015-10-30 16:17:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2015-10-31 19:17:24

Replying to [comment:9 jhpalmieri]:

>(Is it even worth providing the option for skipping these blocks in docbuilding?)

Yes. I would use that option.


---

Comment by jdemeyer created at 2015-11-02 07:05:01

Replying to [comment:9 jhpalmieri]:
> Regarding the environment variable, is there another good way to control the docbuilding process?

OK, _use_ an environment variable for the technical implementation, but don't document it.


---

Comment by ncohen created at 2015-11-02 07:07:49

> OK, _use_ an environment variable for the technical implementation, but don't document it.

`O_o`

Whaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaat ?.....

Nathann


---

Comment by jmantysalo created at 2015-11-02 07:12:11

Replying to [comment:13 ncohen]:
> Whaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaat ?.....

+1 to this.


---

Comment by jdemeyer created at 2015-11-02 08:37:08

I mean: consider the environment variable as an implementation detail, not as part of the public interface.


---

Comment by jdemeyer created at 2015-11-02 13:04:29

Can you explain the change in `src/sage/finance/stock.py`?


---

Comment by jhpalmieri created at 2015-11-02 16:20:13

Replying to [comment:15 jdemeyer]:
> I mean: consider the environment variable as an implementation detail, not as part of the public interface.

So you are suggesting deleting the addition to the installation guide, right? We could also add a target to the makefile that does this, by the way.

> Can you explain the change in src/sage/finance/stock.py?

The lines after the original test,

```
 Classes and methods
 -------------------
```

are not detected by the regular expression for the end of the test, so they would be hidden upon introspection, so I moved the test from the top-level to the class being tested. There is a similar change in src/sage/matroids/basis_exchange_matroid.pyx. Note that those lines provide a header that only really make sense when viewing the full reference manual, so this particular change helps with the reference manual and preserves the old stupid behavior if you type `sage.finance.stock?`. Another option would be to delete

```
 Classes and methods
 -------------------
```



---

Comment by git created at 2015-11-02 19:28:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2015-11-02 19:29:45

Here is a change to the installation guide.


---

Comment by jhpalmieri created at 2015-11-02 19:45:44

By the way, there are many instances in the Sage library of top-level documentation looking like

```
"""
blah
blah

Classes and methods
-------------------
"""
```

so that the page in the reference manual has a nice header but it looks silly if you look at this via introspection. I would suggest that if we want to change this, it belongs on another ticket. My goal here was to preserve the current look of the reference manual and help strings while removing only the TESTS blocks. So I would prefer not deleting "Classes and methods" and similar strings here.

To find other instances of this, do

```
sage: search_src('(---|===)\n"""', multiline=True)
```

I got 97 hits when I did this search.


---

Comment by kcrisman created at 2015-11-03 15:57:59

I disagree with the premise of this ticket.  I am pretty sure that many functions have `TESTS` blocks that have non-trivial functionality demonstrated.  Unless this was also moving all those types of tests to `EXAMPLES` blocks?  This would be a really hard job to identify, I think.


---

Comment by jmantysalo created at 2015-11-03 16:24:55

Replying to [comment:21 kcrisman]:
> I disagree with the premise of this ticket.  I am pretty sure that many functions have `TESTS` blocks that have non-trivial functionality demonstrated.  Unless this was also moving all those types of tests to `EXAMPLES` blocks?  This would be a really hard job to identify, I think.

Isn't the problem actually other way around? That is, `EXAMPLES` contains tests for zero-element graph, empty set and like.


---

Comment by jhpalmieri created at 2015-11-03 16:37:40

For some time, the developer's guide has said that docstrings may include

```
A TESTS block (optional)

Formatted just like EXAMPLES, containing tests that are not relevant to users.
```

So I think we should hide all TESTS blocks now, and if authors of those tests (or other interested developers) want them to be visible, it is their responsibility to move them to EXAMPLES blocks.


---

Comment by kcrisman created at 2015-11-04 02:24:12

> For some time, 
The [very first example](https://github.com/sagemath/sage/blob/master/src/sage/calculus/calculus.py) I looked at has this problem.

```
TESTS:
Substitution::
    sage: f = x
    sage: f(x=5)
    5
Simplifying expressions involving scientific notation::
    sage: k = var('k')
    sage: a0 = 2e-06; a1 = 12
    sage: c = a1 + a0*k; c
    (2.00000000000000e-6)*k + 12
    sage: sqrt(c)
    sqrt((2.00000000000000e-6)*k + 12)
    sage: sqrt(c^3)
    sqrt(((2.00000000000000e-6)*k + 12)^3)
The symbolic calculus package uses its own copy of Maxima for
simplification, etc., which is separate from the default
system-wide version::
    sage: maxima.eval('[x,y]: [1,2]')
    '[1,2]'
    sage: maxima.eval('expand((x+y)^3)')
    '27'
If the copy of maxima used by the symbolic calculus package were
the same as the default one, then the following would return 27,
which would be very confusing indeed!
::
    sage: x, y = var('x,y')
    sage: expand((x+y)^3)
    x^3 + 3*x^2*y + 3*x*y^2 + y^3
Set x to be 5 in maxima::
    sage: maxima('x: 5')
    5
    sage: maxima('x + x + %pi')
    %pi+10
Simplifications like these are now done using Pynac::
    sage: x + x + pi
    pi + 2*x
But this still uses Maxima::
    sage: (x + x + pi).simplify()
    pi + 2*x
Note that ``x`` is still ``x``, since the
maxima used by the calculus package is different than the one in
the interactive interpreter.
```

and so forth.  Obviously a lot of this is not particularly useful to end users, but a lot of this is.  (It also has `TESTS:` and not `TESTS::` though presumably that isn't relevant here.)

More examples:
* [desolvers](https://github.com/sagemath/sage/blob/master/src/sage/calculus/desolvers.py) I assume this could be useful for some users

```
    TESTS:
    :trac:`9961` fixed (allow assumptions on the dependent variable in desolve)::
        sage: y=function('y',x); assume(x>0); assume(y>0)
        sage: sage.calculus.calculus.maxima('domain:real')  # needed since Maxima 5.26.0 to get the answer as below
        real
        sage: desolve(x*diff(y,x)-x*sqrt(y^2+x^2)-y == 0, y, contrib_ode=True)
        [x - arcsinh(y(x)/x) == _C]
```

* Presumably the only documentation for this function [here](https://github.com/sagemath/sage/blob/master/src/sage/plot/animate.py):

```
    def add_frame(self, pngfile, delay=None, delay_denominator=None):
        r"""
        Adds a single frame to the APNG file.
        INPUT:
        - ``pngfile`` -- file name of the PNG file with data for this frame
        - ``delay`` -- numerator of the delay fraction in seconds
        - ``delay_denominator`` -- denominator of the delay in seconds
        If the delay is not specified, the default from the constructor
        applies.
        TESTS::
            sage: from sage.plot.animate import APngAssembler
            sage: from StringIO import StringIO
            sage: buf = StringIO()
            sage: apng = APngAssembler(buf, 2)
            sage: fn = APngAssembler._testData("input1", True)
            sage: apng.add_frame(fn, delay=0x567, delay_denominator=0x1234)
            sage: fn = APngAssembler._testData("input2", True)
            sage: apng.add_frame(fn)
            sage: len(buf.getvalue())
            217
            sage: buf.getvalue() == APngAssembler._testData("anim12", False)
            True
            sage: apng.add_frame(fn)
            Traceback (most recent call last):
            ...
            RuntimeError: Already reached the declared number of frames
```

* End user discovers something _very_ useful to know about this method [here](https://github.com/sagemath/sage/blob/master/src/sage/plot/arc.py):

```
    def plot3d(self):
        r"""
        TESTS::
            sage: from sage.plot.arc import Arc
            sage: Arc(0,0,1,1,0,0,1,{}).plot3d()
            Traceback (most recent call last):
            ...
            NotImplementedError
        """
        raise NotImplementedError
```

  Yeah, I guess I'd want to know that it isn't implemented...

My point: there is an awful lot of stuff grandfathered in under this that will vanish which might end up giving ask.sagemath a lot more (unnecessary) activity.


---

Comment by jhpalmieri created at 2015-11-04 02:46:36

So I guess the question is whether to hide too much now, or to live with the situation where we don't hide anything. (I don't think we will find anyone willing to examine and evaluate each possibly omitted block, which would be the best choice.)


---

Comment by jmantysalo created at 2015-11-04 06:00:10

Replying to [comment:25 jhpalmieri]:
> So I guess the question is whether to hide too much now, or to live with the situation where we don't hide anything. (I don't think we will find anyone willing to examine and evaluate each possibly omitted block, which would be the best choice.)

Then can this be made at least optional? I.e. have an environment variable or something, defaults to `True`, that controls if `TESTS` are shown with `?`? Just what is suggested to html-docs.

Sage will always be unfinished product. That it true for documentation also.


---

Comment by jdemeyer created at 2015-11-04 13:43:54

Replying to [comment:26 jmantysalo]:
> I.e. have an environment variable or something

Please, not yet another useless environment variable.


---

Comment by jdemeyer created at 2015-11-04 13:45:12

`@`kcrisman: I'm not convinced by your examples of `TESTS` blocks. I really do think that the examples you showed contain tests which are not meant for end users.


---

Comment by jdemeyer created at 2015-11-04 13:46:12

Replying to [comment:17 jhpalmieri]:
> The lines after the original test,
> {{{
>  Classes and methods
>  -------------------
> }}}
> are not detected by the regular expression for the end of the test

Then please fix your regular expression or change the docstring. I don't like that you need to move those tests.


---

Comment by jhpalmieri created at 2015-11-04 16:28:00

Replying to [comment:29 jdemeyer]:
> Replying to [comment:17 jhpalmieri]:
> > The lines after the original test,
> > {{{
> >  Classes and methods
> >  -------------------
> > }}}
> > are not detected by the regular expression for the end of the test
> 
> Then please fix your regular expression or change the docstring. I don't like that you need to move those tests.

Why? What's wrong with moving those tests?


---

Comment by kcrisman created at 2015-11-04 18:37:44

> `@`kcrisman: I'm not convinced by your examples of `TESTS` blocks. I really do think that the examples you showed contain tests which are not meant for end users.
Then we may agree to disagree.  I find that those examples have useful syntax examples that are not covered by the original ones.

I just feel like this is covering up the real problem, which is methods/functions which don't have very detailed documentation.  Why do we need to not show these?  It's fixing a problem that isn't a problem.  Things people don't understand they skip anyway; if `TESTS` isn't helpful, it's because they made it to `TESTS` because `EXAMPLES` didn't do its job.


---

Comment by git created at 2015-11-04 19:45:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2015-11-04 19:49:28

I don't want to incorporate an ReST parser into this, but I've attempted to detect when an ReST header ends a "TESTS" block.

I probably won't work on this more unless it is clear that the ticket has enough support.


---

Comment by jmantysalo created at 2015-11-05 06:12:50

Replying to [comment:33 jhpalmieri]:

> I probably won't work on this more unless it is clear that the ticket has enough support.

William Stein has said that we should have foldable `TESTS`-parts in html documentation. So if you mean "support" as "someone else also wants this", then yes, you have it.


---

Comment by jdemeyer created at 2015-11-05 11:32:59

At the very least, we should keep the doc reformatting which was done in this branch.

One the one hand, I think it's good to hide the `TESTS` blocks since I don't think they contain useful information for the user.

On the other hand, I also see some value in `@`kcrisman's comment: are those `TESTS` blocks really bothering people?


---

Comment by jmantysalo created at 2015-11-05 11:46:32

Replying to [comment:35 jdemeyer]:

> On the other hand, I also see some value in `@`kcrisman's comment: are those `TESTS` blocks really bothering people?

This can be argued, but I think that they give kind of unprofessional feeling. They are at least noise to normal user.


---

Comment by jhpalmieri created at 2015-11-05 17:04:24

Should we ask on sage-devel?


---

Comment by jmantysalo created at 2015-11-06 07:33:47

Replying to [comment:37 jhpalmieri]:
> Should we ask on sage-devel?

It will not make any harm. Please ask.


---

Comment by jhpalmieri created at 2015-11-12 19:51:53

The vote on sage-devel: 6 votes for omitting TESTS blocks, 2 votes for keeping them.


---

Comment by jmantysalo created at 2015-11-13 05:14:32

Replying to [comment:39 jhpalmieri]:
> The vote on sage-devel: 6 votes for omitting TESTS blocks, 2 votes for keeping them.

So please proceed.


---

Comment by git created at 2015-11-13 22:11:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2015-11-13 22:12:28

I've fixed the merge conflicts with 6.10.beta4.


---

Comment by jmantysalo created at 2015-11-17 11:14:54

I got


```
            reading sources... [ 94%] sage/repl/rich_output/output_video
            reading sources... [ 97%] sage/repl/rich_output/preferences
            reading sources... [100%] startup
            loading cross citations... 
[repl     ] /home/jm58660/sage/local/lib/python2.7/site-packages/sage/repl/interpreter.py:docstring of sage.repl.interpreter:66: SEVERE: Unexpected section title.
[repl     ] sage: shell.run_cell('1/0')
[repl     ] ---------------------------------------------------------------------------
[repl     ] /home/jm58660/sage/local/lib/python2.7/site-packages/sage/repl/interpreter.py:docstring of sage.repl.interpreter:76: WARNING: Definition list ends without a blank line; unexpected unindent.
Error building the documentation.
Traceback (most recent call last):
  File "/home/jm58660/sage/src/doc/common/builder.py", line 1641, in <module>
    getattr(get_builder(name), type)()
```


from `./sage --docbuild --no-tests all html`.


---

Comment by jmantysalo created at 2015-11-17 11:14:54

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2015-11-17 17:53:31

I see, in a few docstrings, in the middle of a TESTS block there is a line of all hyphens, so my function thought they were ReST headers, and ended the TESTS block prematurely. The new version tests the indentation level.


---

Comment by git created at 2015-11-17 17:53:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2015-11-17 17:54:05

Changing status from needs_work to needs_review.


---

Comment by jmantysalo created at 2015-11-18 07:20:25

This works for me. Patchbot gives two error from `src/sage/rings/real_double.pyx`, but I can not reproduce them on my machine.

I see this as a good addition. However, I know about nothing about Sphinx. Hence I hope someone else to review this.


---

Comment by vbraun created at 2015-11-24 22:29:39

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-11-25 18:01:18

Resolution: fixed
