# Issue 12006: Error in typeset of polynomials

archive/issues_012006.json:
```json
{
    "body": "Assignee: jason\n\nCC:  jzhper@gmail.com\n\nKeywords: latex typeset\n\nThe following code leads to the typeset error:\n\n`Can't find closing delimiter for \\verb`\n\n```\nx = AA['x'].0\nview(factor(x^4 + x^3 + 2 * x^2 + x + 2))\n```\n\nThe latex output is (from notebook interface)\n\n```\n\\newcommand{\\Bold}[1]{\\mathbf{#1}}(x^{2} + \\verb-0.5524369848264019? x + \\verb1.225088535662787?) \\cdot (x^{2} + \\verb1.552436984826402? x + \\verb1.632535071367702?)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/12178\n\n",
    "created_at": "2011-12-18T14:30:55Z",
    "labels": [
        "misc",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-4.8",
    "title": "Error in typeset of polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12006",
    "user": "ppurka"
}
```
Assignee: jason

CC:  jzhper@gmail.com

Keywords: latex typeset

The following code leads to the typeset error:

`Can't find closing delimiter for \verb`

```
x = AA['x'].0
view(factor(x^4 + x^3 + 2 * x^2 + x + 2))
```

The latex output is (from notebook interface)

```
\newcommand{\Bold}[1]{\mathbf{#1}}(x^{2} + \verb-0.5524369848264019? x + \verb1.225088535662787?) \cdot (x^{2} + \verb1.552436984826402? x + \verb1.632535071367702?)
```


Issue created by migration from https://trac.sagemath.org/ticket/12178





---

archive/issue_comments_138693.json:
```json
{
    "body": "Be sure to check this against #12156.",
    "created_at": "2011-12-21T12:21:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138693",
    "user": "jdemeyer"
}
```

Be sure to check this against #12156.



---

archive/issue_comments_138694.json:
```json
{
    "body": "Replying to [comment:1 jdemeyer]:\n> Be sure to check this against #12156.\n\nThe error is still there with #12156. Attaching a potential patch. I will doctest over the next couple of hours.",
    "created_at": "2011-12-21T13:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138694",
    "user": "ppurka"
}
```

Replying to [comment:1 jdemeyer]:
> Be sure to check this against #12156.

The error is still there with #12156. Attaching a potential patch. I will doctest over the next couple of hours.



---

archive/issue_comments_138695.json:
```json
{
    "body": "Doctested. Needs review.",
    "created_at": "2011-12-21T16:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138695",
    "user": "ppurka"
}
```

Doctested. Needs review.



---

archive/issue_comments_138696.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-12-21T16:41:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138696",
    "user": "ppurka"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_138697.json:
```json
{
    "body": "1. Is this indeed the desired behaviour?\n   2. If yes, the comment before that changed line should be expanded to reflect it.\n   3. I still don't quite understand how the above output could appear, even if these numbers were wrapped into verb, it should have been done correctly. Is there another bug?..",
    "created_at": "2011-12-21T17:45:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138697",
    "user": "novoselt"
}
```

1. Is this indeed the desired behaviour?
   2. If yes, the comment before that changed line should be expanded to reflect it.
   3. I still don't quite understand how the above output could appear, even if these numbers were wrapped into verb, it should have been done correctly. Is there another bug?..



---

archive/issue_comments_138698.json:
```json
{
    "body": "Replying to [comment:5 novoselt]:\n>  1. Is this indeed the desired behaviour?\n\nI believe it should be the desired behavior. Numbers by themselves are not sandwiched between a `\\verb| |` construct. So, I don't understand why numbers ending with ? should be displayed as verbatim. With this patch, the only case where ? might be displayed non-verbatim is when one of the following occurs by themselves: `?`, `-?` or `+?`. All three of these are grammatically incorrect and I can't imagine a situation where they can arise by themselves. \n\n>  2. If yes, the comment before that changed line should be expanded to reflect it.\n\nI will do that. Sorry for not noticing it.\n\n>  3. I still don't quite understand how the above output could appear, even if these numbers were wrapped into verb, it should have been done correctly. Is there another bug?..\n\nIt took a while, but I have finally tracked it down to a line in `sage/rings/polynomial/polynomial_element.pyx`, inside the `_latex_()` function of the class `Polynomial`:\n\n```\n        s = s.replace(\"|\",\"\")\n```\n\nI don't know why this replacement has to be performed, but this is the reason why the `|` from `\\verb` is being stripped off. Example print statements are in the following output (I will attach the patch containing the print statements shortly, so that you can reproduce this):\n\n```\nsage: sage.misc.latex.EMBEDDED_MODE=True\nsage: x = AA['x'].0; y = factor(x^2 + x + 1); view(y)\nDEBUG: Factorization._latex_, after for: self.__x[i][0] =  x^2 + x + 1.000000000000000?\nDEBUG: str_function, before return: x =  \\verb|1.000000000000000?| <type 'str'>\nDEBUG: Polynomial._latex_, before s.replace(|): s =   x^{2} + x + \\verb|1.000000000000000?| \nDEBUG: Factorization._latex_, before if not atomic: t =  x^{2} + x + \\verb1.000000000000000?\nDEBUG: Factorization._latex_, after for: self.__x[i][0] =  x^2 + x + 1.000000000000000?\nDEBUG: str_function, before return: x =  \\verb|1.000000000000000?| <type 'str'>\nDEBUG: Polynomial._latex_, before s.replace(|): s =   x^{2} + x + \\verb|1.000000000000000?| \nDEBUG: Factorization._latex_, before if not atomic: t =  x^{2} + x + \\verb1.000000000000000?\n<html><span class=\"math\">\\newcommand{\\Bold}[1]{\\mathbf{#1}}(x^{2} + x + \\verb1.000000000000000?)</span></html>\n```\n\n\nPS: There is a separate issue that can be seen in the above DEBUG output, and that is that the functions are all being called twice.",
    "created_at": "2011-12-22T16:23:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138698",
    "user": "ppurka"
}
```

Replying to [comment:5 novoselt]:
>  1. Is this indeed the desired behaviour?

I believe it should be the desired behavior. Numbers by themselves are not sandwiched between a `\verb| |` construct. So, I don't understand why numbers ending with ? should be displayed as verbatim. With this patch, the only case where ? might be displayed non-verbatim is when one of the following occurs by themselves: `?`, `-?` or `+?`. All three of these are grammatically incorrect and I can't imagine a situation where they can arise by themselves. 

>  2. If yes, the comment before that changed line should be expanded to reflect it.

I will do that. Sorry for not noticing it.

>  3. I still don't quite understand how the above output could appear, even if these numbers were wrapped into verb, it should have been done correctly. Is there another bug?..

It took a while, but I have finally tracked it down to a line in `sage/rings/polynomial/polynomial_element.pyx`, inside the `_latex_()` function of the class `Polynomial`:

```
        s = s.replace("|","")
```

I don't know why this replacement has to be performed, but this is the reason why the `|` from `\verb` is being stripped off. Example print statements are in the following output (I will attach the patch containing the print statements shortly, so that you can reproduce this):

```
sage: sage.misc.latex.EMBEDDED_MODE=True
sage: x = AA['x'].0; y = factor(x^2 + x + 1); view(y)
DEBUG: Factorization._latex_, after for: self.__x[i][0] =  x^2 + x + 1.000000000000000?
DEBUG: str_function, before return: x =  \verb|1.000000000000000?| <type 'str'>
DEBUG: Polynomial._latex_, before s.replace(|): s =   x^{2} + x + \verb|1.000000000000000?| 
DEBUG: Factorization._latex_, before if not atomic: t =  x^{2} + x + \verb1.000000000000000?
DEBUG: Factorization._latex_, after for: self.__x[i][0] =  x^2 + x + 1.000000000000000?
DEBUG: str_function, before return: x =  \verb|1.000000000000000?| <type 'str'>
DEBUG: Polynomial._latex_, before s.replace(|): s =   x^{2} + x + \verb|1.000000000000000?| 
DEBUG: Factorization._latex_, before if not atomic: t =  x^{2} + x + \verb1.000000000000000?
<html><span class="math">\newcommand{\Bold}[1]{\mathbf{#1}}(x^{2} + x + \verb1.000000000000000?)</span></html>
```


PS: There is a separate issue that can be seen in the above DEBUG output, and that is that the functions are all being called twice.



---

archive/issue_comments_138699.json:
```json
{
    "body": "Attachment [12178_latex_debug.patch](tarball://root/attachments/some-uuid/ticket12178/12178_latex_debug.patch) by ppurka created at 2011-12-22 16:25:14\n\nprint DEBUGs",
    "created_at": "2011-12-22T16:25:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138699",
    "user": "ppurka"
}
```

Attachment [12178_latex_debug.patch](tarball://root/attachments/some-uuid/ticket12178/12178_latex_debug.patch) by ppurka created at 2011-12-22 16:25:14

print DEBUGs



---

archive/issue_comments_138700.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2011-12-23T04:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138700",
    "user": "novoselt"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_138701.json:
```json
{
    "body": "Thank you for such a thorough analysis! I wonder why vertical bars are thrown out of latex code, but I guess it should not be an issue anymore. All tests pass, positive review!\n\nP.S. Is it intentional that commit message only has your initial for the first name?",
    "created_at": "2011-12-23T04:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138701",
    "user": "novoselt"
}
```

Thank you for such a thorough analysis! I wonder why vertical bars are thrown out of latex code, but I guess it should not be an issue anymore. All tests pass, positive review!

P.S. Is it intentional that commit message only has your initial for the first name?



---

archive/issue_comments_138702.json:
```json
{
    "body": "Replying to [comment:7 novoselt]:\n> P.S. Is it intentional that commit message only has your initial for the first name?\n\nProbably not intentional. I set up my .hgrc half a year ago when I was a noob to Sage and hg (still am a noob!) by copying from someone else (probably rkirov). I think I never looked at the .hgrc again. :)",
    "created_at": "2011-12-23T05:20:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138702",
    "user": "ppurka"
}
```

Replying to [comment:7 novoselt]:
> P.S. Is it intentional that commit message only has your initial for the first name?

Probably not intentional. I set up my .hgrc half a year ago when I was a noob to Sage and hg (still am a noob!) by copying from someone else (probably rkirov). I think I never looked at the .hgrc again. :)



---

archive/issue_comments_138703.json:
```json
{
    "body": "Could you add a doctest for the problem in the description of this ticket?",
    "created_at": "2011-12-23T11:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138703",
    "user": "jdemeyer"
}
```

Could you add a doctest for the problem in the description of this ticket?



---

archive/issue_comments_138704.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2011-12-23T11:01:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138704",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_138705.json:
```json
{
    "body": "Added doctest under factorization",
    "created_at": "2011-12-23T16:18:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138705",
    "user": "ppurka"
}
```

Added doctest under factorization



---

archive/issue_comments_138706.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-12-23T16:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138706",
    "user": "ppurka"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_138707.json:
```json
{
    "body": "Attachment [trac_12178-fix_printing_questionmark.patch](tarball://root/attachments/some-uuid/ticket12178/trac_12178-fix_printing_questionmark.patch) by ppurka created at 2011-12-23 16:20:46\n\nReplying to [comment:9 jdemeyer]:\n> Could you add a doctest for the problem in the description of this ticket?\n\nAdded a doctest under `_latex_` in factorization.py. I am unable to introduce a ? by itself in polynomials (Sage gives error if I end a number with a hand-typed ?). So, I can't add a doctest in polynomial_element.pyx.",
    "created_at": "2011-12-23T16:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138707",
    "user": "ppurka"
}
```

Attachment [trac_12178-fix_printing_questionmark.patch](tarball://root/attachments/some-uuid/ticket12178/trac_12178-fix_printing_questionmark.patch) by ppurka created at 2011-12-23 16:20:46

Replying to [comment:9 jdemeyer]:
> Could you add a doctest for the problem in the description of this ticket?

Added a doctest under `_latex_` in factorization.py. I am unable to introduce a ? by itself in polynomials (Sage gives error if I end a number with a hand-typed ?). So, I can't add a doctest in polynomial_element.pyx.



---

archive/issue_comments_138708.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2011-12-29T07:06:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12006",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12006#issuecomment-138708",
    "user": "jdemeyer"
}
```

Resolution: fixed
