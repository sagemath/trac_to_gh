# Issue 20004: Separate Sage-specific components from generic C-interface in PariInstance

archive/issues_020004.json:
```json
{
    "body": "CC:  @jdemeyer\n\nIn preparation for #20238, take out of `PariInstance` all components specific to Sage.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20241\n\n",
    "created_at": "2016-03-21T14:34:02Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.4",
    "title": "Separate Sage-specific components from generic C-interface in PariInstance",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20004",
    "user": "https://github.com/defeo"
}
```
CC:  @jdemeyer

In preparation for #20238, take out of `PariInstance` all components specific to Sage.

Issue created by migration from https://trac.sagemath.org/ticket/20241





---

archive/issue_comments_275172.json:
```json
{
    "body": "I'm pushing a failed attempt at splitting `PariInstance` into a generic `PariInstance` cython type, and a Sage-specific `SagePariInstance`.\n\nThis is problematic because of the global `sage.libs.pari.pari_instance.pari` variable: it is not clear where this variable should go.\n\nSome concrete suggestions: `PariInstance` serves three main purposes:\n\n- As a wrapper around the pari stack,\n- As a collection of conversion methods to and from pari types,\n- As a namespace for a handful of functions, for lack of a better place (e.g. `primes`, `genus2_reduction`, ...)\n\nOf these, only the first one really needs a Cython type. I suggest:\n\n- To make a proper abstraction `PariStack` around the pari stack. This should not be handled as a global variable, but rather as a singleton class (we cannot have more than one pari stack, because of global variables).\n- Move conversion functions to a separate namespace, as #20226 started doing.\n- Have `PariInstance` hold a pointer to a `PariStack`. Have `gen`'s hold a pointer to a `PariInstance`. (Maybe this double wrapping is superfluous?)\n\nI don't know quite well what to do with utility functions such as `primes`. They may stay as methods of `PariInstance`, or maybe go to a different namespace as pure functions (they should take a `PariInstance` or `PariStack` as parameter, then).\n----\nLast 10 new commits:",
    "created_at": "2016-03-21T14:48:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275172",
    "user": "https://github.com/defeo"
}
```

I'm pushing a failed attempt at splitting `PariInstance` into a generic `PariInstance` cython type, and a Sage-specific `SagePariInstance`.

This is problematic because of the global `sage.libs.pari.pari_instance.pari` variable: it is not clear where this variable should go.

Some concrete suggestions: `PariInstance` serves three main purposes:

- As a wrapper around the pari stack,
- As a collection of conversion methods to and from pari types,
- As a namespace for a handful of functions, for lack of a better place (e.g. `primes`, `genus2_reduction`, ...)

Of these, only the first one really needs a Cython type. I suggest:

- To make a proper abstraction `PariStack` around the pari stack. This should not be handled as a global variable, but rather as a singleton class (we cannot have more than one pari stack, because of global variables).
- Move conversion functions to a separate namespace, as #20226 started doing.
- Have `PariInstance` hold a pointer to a `PariStack`. Have `gen`'s hold a pointer to a `PariInstance`. (Maybe this double wrapping is superfluous?)

I don't know quite well what to do with utility functions such as `primes`. They may stay as methods of `PariInstance`, or maybe go to a different namespace as pure functions (they should take a `PariInstance` or `PariStack` as parameter, then).
----
Last 10 new commits:



---

archive/issue_comments_275173.json:
```json
{
    "body": "Regarding the utility functions: I think `primes` belongs in `sage.rings.fast_arith` along with `prime_range`, while `genus2red` should be in `sage.schemes.hyperelliptic_curves.HyperellipticCurve_g2_rational_field` which is otherwise completely empty! The other functions don't provide any new functionality (factorials, Chebyshev polynomials, etc.).",
    "created_at": "2016-04-09T05:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275173",
    "user": "https://github.com/kedlaya"
}
```

Regarding the utility functions: I think `primes` belongs in `sage.rings.fast_arith` along with `prime_range`, while `genus2red` should be in `sage.schemes.hyperelliptic_curves.HyperellipticCurve_g2_rational_field` which is otherwise completely empty! The other functions don't provide any new functionality (factorials, Chebyshev polynomials, etc.).



---

archive/issue_comments_275174.json:
```json
{
    "body": "Replying to [comment:3 kedlaya]:\n> Regarding the utility functions: I think `primes` belongs in `sage.rings.fast_arith` along with `prime_range`, while `genus2red` should be in `sage.schemes.hyperelliptic_curves.HyperellipticCurve_g2_rational_field` which is otherwise completely empty! The other functions don't provide any new functionality (factorials, Chebyshev polynomials, etc.).\n\nGood points. These would take a lengthy deprecation process, and are better handled after a successful separation of the interface (something we're still having a hard time with).\n\nI think the best place for this comment is in #20238, hence I'm copying it there.",
    "created_at": "2016-04-09T13:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275174",
    "user": "https://github.com/defeo"
}
```

Replying to [comment:3 kedlaya]:
> Regarding the utility functions: I think `primes` belongs in `sage.rings.fast_arith` along with `prime_range`, while `genus2red` should be in `sage.schemes.hyperelliptic_curves.HyperellipticCurve_g2_rational_field` which is otherwise completely empty! The other functions don't provide any new functionality (factorials, Chebyshev polynomials, etc.).

Good points. These would take a lengthy deprecation process, and are better handled after a successful separation of the interface (something we're still having a hard time with).

I think the best place for this comment is in #20238, hence I'm copying it there.



---

archive/issue_comments_275175.json:
```json
{
    "body": "`@`kedleya: I don't really understand your comment. This ticket is about the *interface* between Sage and PARI (which is a purely technical non-mathematical thing), not about how which PARI functions are used where.",
    "created_at": "2016-04-11T08:27:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275175",
    "user": "https://github.com/jdemeyer"
}
```

`@`kedleya: I don't really understand your comment. This ticket is about the *interface* between Sage and PARI (which is a purely technical non-mathematical thing), not about how which PARI functions are used where.



---

archive/issue_comments_275176.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2016-08-08T21:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275176",
    "user": "https://github.com/defeo"
}
```

Last 10 new commits:



---

archive/issue_comments_275177.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2016-08-09T07:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275177",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_275178.json:
```json
{
    "body": "I don't really know where you are going with this branch, but I thought that we wanted to minimize the use of the global `pari` variable?\n\nFor example, `closure.pyx` should not need it, we just need to make `new_gen` and friends functions instead of methods of `PariInstance`.",
    "created_at": "2016-08-09T07:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275178",
    "user": "https://github.com/jdemeyer"
}
```

I don't really know where you are going with this branch, but I thought that we wanted to minimize the use of the global `pari` variable?

For example, `closure.pyx` should not need it, we just need to make `new_gen` and friends functions instead of methods of `PariInstance`.



---

archive/issue_comments_275179.json:
```json
{
    "body": "Yup. Second step. I needed to know who was using it anyway. Any module importing _pari_instance is doing bad, and I'm fixing it. I just pushed this to get help from patchbot.",
    "created_at": "2016-08-09T08:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275179",
    "user": "https://github.com/defeo"
}
```

Yup. Second step. I needed to know who was using it anyway. Any module importing _pari_instance is doing bad, and I'm fixing it. I just pushed this to get help from patchbot.



---

archive/issue_comments_275180.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-19T17:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275180",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275181.json:
```json
{
    "body": "Hi `@`jdemeyer. I'm having trouble compiling this code. gcc fails while compiling `complex_double.pyx`, but I cannot figure our the problem. Also `matrix_integer_dense.pyx` gives fishy warnings.\n\nChanging slightly L94 in `complex_double.pyx`, i.e., using `cimport .. as` or similar, it gets even worse: compilation freezes midway, I have to Ctrl-C it.\n\nI'm giving up for today. Do you have any idea?",
    "created_at": "2016-08-19T17:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275181",
    "user": "https://github.com/defeo"
}
```

Hi `@`jdemeyer. I'm having trouble compiling this code. gcc fails while compiling `complex_double.pyx`, but I cannot figure our the problem. Also `matrix_integer_dense.pyx` gives fishy warnings.

Changing slightly L94 in `complex_double.pyx`, i.e., using `cimport .. as` or similar, it gets even worse: compilation freezes midway, I have to Ctrl-C it.

I'm giving up for today. Do you have any idea?



---

archive/issue_comments_275182.json:
```json
{
    "body": "For starters, you cannot *declare* a function to be `cdef inline` in a `.pxd` file unless you put the full function body also in the `.pxd` file. So this isn't correct:\n\n```\ncdef inline gen new_gen(GEN x)\n```\n\n\nYou have to understand how the compiler works: the compiler for a different module only sees the `.pxd` file, so it cannot possibly inline the function `new_gen` since it doesn't know what `new_gen` does.\n\nIt's a bit of a mystery why Cython still accepts this code. GCC gives a error (but sometimes just a warning, maybe it depends on the language) like\n\n```\n[sagelib-7.3.rc0] build/cythonized/sage/matrix/matrix_integer_dense.cpp:4828:72: error: \u2018__pyx_f_4sage_4libs_4pari_5stack_clear_stack\u2019 declared as an \u2018inline\u2019 variable\n[sagelib-7.3.rc0]  static CYTHON_INLINE void (*__pyx_f_4sage_4libs_4pari_5stack_clear_stack)(void); /*proto*/\n```\n",
    "created_at": "2016-08-19T19:24:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275182",
    "user": "https://github.com/jdemeyer"
}
```

For starters, you cannot *declare* a function to be `cdef inline` in a `.pxd` file unless you put the full function body also in the `.pxd` file. So this isn't correct:

```
cdef inline gen new_gen(GEN x)
```


You have to understand how the compiler works: the compiler for a different module only sees the `.pxd` file, so it cannot possibly inline the function `new_gen` since it doesn't know what `new_gen` does.

It's a bit of a mystery why Cython still accepts this code. GCC gives a error (but sometimes just a warning, maybe it depends on the language) like

```
[sagelib-7.3.rc0] build/cythonized/sage/matrix/matrix_integer_dense.cpp:4828:72: error: ‘__pyx_f_4sage_4libs_4pari_5stack_clear_stack’ declared as an ‘inline’ variable
[sagelib-7.3.rc0]  static CYTHON_INLINE void (*__pyx_f_4sage_4libs_4pari_5stack_clear_stack)(void); /*proto*/
```




---

archive/issue_comments_275183.json:
```json
{
    "body": "Note that it is perfectly legal to have an inline function in a `.pyx` file and still export it in the `.pxd` file. Just don't put the `inline` in the `.pxd`. This way, the function can be inlined in the `.pyx` file (like the call from `new_gen` to `new_gen_noclear`) but other modules will do a non-inline function call.",
    "created_at": "2016-08-19T19:31:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275183",
    "user": "https://github.com/jdemeyer"
}
```

Note that it is perfectly legal to have an inline function in a `.pyx` file and still export it in the `.pxd` file. Just don't put the `inline` in the `.pxd`. This way, the function can be inlined in the `.pyx` file (like the call from `new_gen` to `new_gen_noclear`) but other modules will do a non-inline function call.



---

archive/issue_comments_275184.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-08-19T19:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275184",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_275185.json:
```json
{
    "body": "Sage at least compiles now. It doesn't actually start, but I'll leave it to you to continue working on this.",
    "created_at": "2016-08-19T19:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275185",
    "user": "https://github.com/jdemeyer"
}
```

Sage at least compiles now. It doesn't actually start, but I'll leave it to you to continue working on this.



---

archive/issue_comments_275186.json:
```json
{
    "body": "Makes perfect sense. What I don't get is why you can put `cdef inline` in METHOD definitions in a `.pxd`. I just cut-pasted that line from the definition of `PariInstance`, and it had been actually compiling, booting, and passing tests (hadn't tried many tests, though) for quite some time before this... that's why I hate Cython!\n\nAnyway, thanks for your help. I'll keep chasing the breakages tomorrow.",
    "created_at": "2016-08-19T20:34:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275186",
    "user": "https://github.com/defeo"
}
```

Makes perfect sense. What I don't get is why you can put `cdef inline` in METHOD definitions in a `.pxd`. I just cut-pasted that line from the definition of `PariInstance`, and it had been actually compiling, booting, and passing tests (hadn't tried many tests, though) for quite some time before this... that's why I hate Cython!

Anyway, thanks for your help. I'll keep chasing the breakages tomorrow.



---

archive/issue_comments_275187.json:
```json
{
    "body": "Ok, fixed the startup bug, and tests (mostly) pass. Next step is to move all those conversion functions out of the way.\n\nI'm scratching my head about `allocatemem` and companions, though. `allocatemem` is a gp function, but it's tied to `gen` by `auto_gen.pxi`, so that you can do\n\n\n```\nsage: size = pari('10^8')\nsage: size.allocatemem()\n```\n\n\nwhich feels very bad. Wouldn't it make sense to blacklist this one?\n\nOn the other hand there is a manually coded `allocatemem` method in `PariInstance` which gives a much more sensible\n\n\n```\nsage: pari.allocatemem(10^8)\n```\n\n\nand also has an additional `silent` parameter to behave more like gp. There are also methods `stacksize` and `stacksizemax` to read the stack sizes. It seems more logical to put these three functions in `stack.pyx`, but if we want the user to call them from the command line, it is better to leave methods in `PariInstance`.\n\nQuestion: given the current handling of PARI's stack, do we still want the user to easily call these functions?\n----\nNew commits:",
    "created_at": "2016-08-20T11:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275187",
    "user": "https://github.com/defeo"
}
```

Ok, fixed the startup bug, and tests (mostly) pass. Next step is to move all those conversion functions out of the way.

I'm scratching my head about `allocatemem` and companions, though. `allocatemem` is a gp function, but it's tied to `gen` by `auto_gen.pxi`, so that you can do


```
sage: size = pari('10^8')
sage: size.allocatemem()
```


which feels very bad. Wouldn't it make sense to blacklist this one?

On the other hand there is a manually coded `allocatemem` method in `PariInstance` which gives a much more sensible


```
sage: pari.allocatemem(10^8)
```


and also has an additional `silent` parameter to behave more like gp. There are also methods `stacksize` and `stacksizemax` to read the stack sizes. It seems more logical to put these three functions in `stack.pyx`, but if we want the user to call them from the command line, it is better to leave methods in `PariInstance`.

Question: given the current handling of PARI's stack, do we still want the user to easily call these functions?
----
New commits:



---

archive/issue_comments_275188.json:
```json
{
    "body": "Replying to [comment:20 defeo]:\n> Wouldn't it make sense to blacklist this one?\n\nSure.",
    "created_at": "2016-08-20T19:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275188",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:20 defeo]:
> Wouldn't it make sense to blacklist this one?

Sure.



---

archive/issue_comments_275189.json:
```json
{
    "body": "Replying to [comment:20 defeo]:\n> Question: given the current handling of PARI's stack, do we still want the user to easily call these functions?\n\nI don't see the problem. They work perfectly fine and make sense. Unless they are problematic for the implementation, I would just keep them as they are. Another reason is that we should focus on finishing this deliverable. We can always clean up such details afterwards.",
    "created_at": "2016-08-20T19:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275189",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:20 defeo]:
> Question: given the current handling of PARI's stack, do we still want the user to easily call these functions?

I don't see the problem. They work perfectly fine and make sense. Unless they are problematic for the implementation, I would just keep them as they are. Another reason is that we should focus on finishing this deliverable. We can always clean up such details afterwards.



---

archive/issue_comments_275190.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-24T14:01:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275191.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-25T00:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275192.json:
```json
{
    "body": "Ok, so I managed to move all Sage-specific conversion functions from `PariInstance` to a separate file. We're getting closer to the goal: the only imports left in `pari_instance.p??` from the sage library are\n\n\n```\nfrom sage.ext.memory import init_memory_functions\nfrom sage.misc.superseded import deprecation, deprecated_function_alias\n```\n\n\nThere's a couple of conversion functions left in `PariInstance` which are not specific to Sage:\n\n\n```\ncdef gen new_gen_from_int(self, int value)\ncdef gen new_t_POL_from_int_star(self, int *vals, int length, long varnum)\ncdef gen double_to_gen_c(self, double)\ncdef GEN double_to_GEN(self, double)\n```\n\n\nplus a python method `PariInstance.double_to_gen`. Should we put these in `convert.pyx`, or maybe another file?\n\nNote that `new_gen_from_int` is only called once in `padic_capped_relative_element.pyx`, and just to create 0.\n\nIt is also not very clear to me what the purpose of `double_to_gen` and `double_to_gen_c` is. `double_to_gen_c` is called only in line 1585 of `real_double.pyx`, and that's in a `def`ed function. Is this really faster than calling `double_to_gen`?\n\nAnd what's the meaning of this, anyway:\n\n\n```\nsage: pari(0.1) == pari.double_to_gen(0.1)\nFalse\nsage: pari(0.1) == pari(0.1)\nTrue\nsage: pari.double_to_gen(0.1) == pari.double_to_gen(0.1)\nTrue\nsage: pari(0.1) - pari.double_to_gen(0.1)\n-5.54975987041018 E-18\nsage: pari(0.1) - pari(0.1)\n0.E-20\nsage: pari.double_to_gen(0.1) - pari.double_to_gen(0.1)\n0.E-20\n```\n\n\n\n----\nNew commits:",
    "created_at": "2016-08-25T01:08:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275192",
    "user": "https://github.com/defeo"
}
```

Ok, so I managed to move all Sage-specific conversion functions from `PariInstance` to a separate file. We're getting closer to the goal: the only imports left in `pari_instance.p??` from the sage library are


```
from sage.ext.memory import init_memory_functions
from sage.misc.superseded import deprecation, deprecated_function_alias
```


There's a couple of conversion functions left in `PariInstance` which are not specific to Sage:


```
cdef gen new_gen_from_int(self, int value)
cdef gen new_t_POL_from_int_star(self, int *vals, int length, long varnum)
cdef gen double_to_gen_c(self, double)
cdef GEN double_to_GEN(self, double)
```


plus a python method `PariInstance.double_to_gen`. Should we put these in `convert.pyx`, or maybe another file?

Note that `new_gen_from_int` is only called once in `padic_capped_relative_element.pyx`, and just to create 0.

It is also not very clear to me what the purpose of `double_to_gen` and `double_to_gen_c` is. `double_to_gen_c` is called only in line 1585 of `real_double.pyx`, and that's in a `def`ed function. Is this really faster than calling `double_to_gen`?

And what's the meaning of this, anyway:


```
sage: pari(0.1) == pari.double_to_gen(0.1)
False
sage: pari(0.1) == pari(0.1)
True
sage: pari.double_to_gen(0.1) == pari.double_to_gen(0.1)
True
sage: pari(0.1) - pari.double_to_gen(0.1)
-5.54975987041018 E-18
sage: pari(0.1) - pari(0.1)
0.E-20
sage: pari.double_to_gen(0.1) - pari.double_to_gen(0.1)
0.E-20
```



----
New commits:



---

archive/issue_comments_275193.json:
```json
{
    "body": "Replying to [comment:25 defeo]:\n> Ok, so I managed to move all Sage-specific conversion functions from `PariInstance` to a separate file. We're getting closer to the goal: the only imports left in `pari_instance.p??` from the sage library are\n> \n> {{{\n> from sage.ext.memory import init_memory_functions\n> from sage.misc.superseded import deprecation, deprecated_function_alias\n> }}}\n> \n> There's a couple of conversion functions left in `PariInstance` which are not specific to Sage:\n> \n> {{{\n> cdef gen new_gen_from_int(self, int value)\n> cdef gen new_t_POL_from_int_star(self, int *vals, int length, long varnum)\n> cdef gen double_to_gen_c(self, double)\n> cdef GEN double_to_GEN(self, double)\n> }}}\n> \n> plus a python method `PariInstance.double_to_gen`. Should we put these in `convert.pyx`\n\nFine for me.\n\n> Note that `new_gen_from_int` is only called once in `padic_capped_relative_element.pyx`, and just to create 0.\n> \n> It is also not very clear to me what the purpose of `double_to_gen` and `double_to_gen_c` is.\n\n`double_to_gen` seems unused and untested. I do not mind removing it.\n\n> `double_to_gen_c` is called only in line 1585 of `real_double.pyx`, and that's in a `def`ed function. Is this really faster than calling `double_to_gen`?\n\nObviously yes. Calling a `cdef` function is much faster than calling a `def` function. It does not matter where it is called from. But I would suggest renaming `double_to_gen_c` to `double_to_gen`.",
    "created_at": "2016-08-27T18:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275193",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 defeo]:
> Ok, so I managed to move all Sage-specific conversion functions from `PariInstance` to a separate file. We're getting closer to the goal: the only imports left in `pari_instance.p??` from the sage library are
> 
> {{{
> from sage.ext.memory import init_memory_functions
> from sage.misc.superseded import deprecation, deprecated_function_alias
> }}}
> 
> There's a couple of conversion functions left in `PariInstance` which are not specific to Sage:
> 
> {{{
> cdef gen new_gen_from_int(self, int value)
> cdef gen new_t_POL_from_int_star(self, int *vals, int length, long varnum)
> cdef gen double_to_gen_c(self, double)
> cdef GEN double_to_GEN(self, double)
> }}}
> 
> plus a python method `PariInstance.double_to_gen`. Should we put these in `convert.pyx`

Fine for me.

> Note that `new_gen_from_int` is only called once in `padic_capped_relative_element.pyx`, and just to create 0.
> 
> It is also not very clear to me what the purpose of `double_to_gen` and `double_to_gen_c` is.

`double_to_gen` seems unused and untested. I do not mind removing it.

> `double_to_gen_c` is called only in line 1585 of `real_double.pyx`, and that's in a `def`ed function. Is this really faster than calling `double_to_gen`?

Obviously yes. Calling a `cdef` function is much faster than calling a `def` function. It does not matter where it is called from. But I would suggest renaming `double_to_gen_c` to `double_to_gen`.



---

archive/issue_comments_275194.json:
```json
{
    "body": "Replying to [comment:25 defeo]:\n> {{{\n> sage: pari(0.1) == pari.double_to_gen(0.1)\n> False\n> }}}\n\nThat's a \"feature\" because of `RealLiteral`:\n\n```\nsage: x = RR(0.1); y = RR(float(0.1))\nsage: x == y\nTrue\nsage: parent(x) is parent(y)\nTrue\nsage: RR64 = RealField(64)\nsage: RR64(x) == RR64(y)\nFalse\nsage: pari(x) == pari(y)\nFalse\n```\n",
    "created_at": "2016-08-27T19:06:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275194",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:25 defeo]:
> {{{
> sage: pari(0.1) == pari.double_to_gen(0.1)
> False
> }}}

That's a "feature" because of `RealLiteral`:

```
sage: x = RR(0.1); y = RR(float(0.1))
sage: x == y
True
sage: parent(x) is parent(y)
True
sage: RR64 = RealField(64)
sage: RR64(x) == RR64(y)
False
sage: pari(x) == pari(y)
False
```




---

archive/issue_comments_275195.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-04T01:04:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275195",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275196.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-04T01:41:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275197.json:
```json
{
    "body": "You might consider a separate ticket for moving the conversion functions.",
    "created_at": "2016-09-04T10:09:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275197",
    "user": "https://github.com/jdemeyer"
}
```

You might consider a separate ticket for moving the conversion functions.



---

archive/issue_comments_275198.json:
```json
{
    "body": "Why did you remove `pari.stacksize()` and similar? I would keep them as methods of `pari`.",
    "created_at": "2016-09-05T15:24:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275198",
    "user": "https://github.com/jdemeyer"
}
```

Why did you remove `pari.stacksize()` and similar? I would keep them as methods of `pari`.



---

archive/issue_comments_275199.json:
```json
{
    "body": "I don't really see the point of this new `init()` function. What's wrong with using the `__init__` method for this?\n----\nNew commits:",
    "created_at": "2016-09-05T15:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275199",
    "user": "https://github.com/jdemeyer"
}
```

I don't really see the point of this new `init()` function. What's wrong with using the `__init__` method for this?
----
New commits:



---

archive/issue_comments_275200.json:
```json
{
    "body": "Agreed to revert to a normal constructor, no `init()` factory method.\n----\nNew commits:",
    "created_at": "2016-09-06T16:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275200",
    "user": "https://github.com/defeo"
}
```

Agreed to revert to a normal constructor, no `init()` factory method.
----
New commits:



---

archive/issue_comments_275201.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-09-06T16:36:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275201",
    "user": "https://github.com/defeo"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_275202.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-09-06T17:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275202",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_275203.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-09-06T17:35:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275203",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_275204.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-06T17:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275204",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275205.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-09-06T21:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275205",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275206.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-09-21T15:21:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275206",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_275207.json:
```json
{
    "body": "Just a reminder: I plan to review this when all dependencies have been merged. Unfortunately, this is currently blocked by #21441.",
    "created_at": "2016-09-21T15:42:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275207",
    "user": "https://github.com/jdemeyer"
}
```

Just a reminder: I plan to review this when all dependencies have been merged. Unfortunately, this is currently blocked by #21441.



---

archive/issue_comments_275208.json:
```json
{
    "body": "Merged latest develop.\n----\nNew commits:",
    "created_at": "2016-10-10T08:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275208",
    "user": "https://github.com/jdemeyer"
}
```

Merged latest develop.
----
New commits:



---

archive/issue_comments_275209.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-11T08:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275209",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275210.json:
```json
{
    "body": "I am wondering what to do with `convert_sage`. First of all, it contains conversions both to/from GMP as well as conversions to/from FLINT. These should be split up in two different modules (I will do that).\n\nBut a bigger question is: should these become part of Sage or part of CyPari? Those conversion routines are not directly related to Sage, but to GMP/FLINT which may be of interest to other libraries too.",
    "created_at": "2016-10-11T09:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275210",
    "user": "https://github.com/jdemeyer"
}
```

I am wondering what to do with `convert_sage`. First of all, it contains conversions both to/from GMP as well as conversions to/from FLINT. These should be split up in two different modules (I will do that).

But a bigger question is: should these become part of Sage or part of CyPari? Those conversion routines are not directly related to Sage, but to GMP/FLINT which may be of interest to other libraries too.



---

archive/issue_comments_275211.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2016-10-11T09:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275211",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_275212.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-11T09:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275212",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275213.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-11T10:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275213",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275214.json:
```json
{
    "body": "Replying to [comment:49 jdemeyer]:\n> I am wondering what to do with `convert_sage`. First of all, it contains conversions both to/from GMP as well as conversions to/from FLINT. These should be split up in two different modules (I will do that).\n\nGood. Thx.\n\n> But a bigger question is: should these become part of Sage or part of CyPari? Those conversion routines are not directly related to Sage, but to GMP/FLINT which may be of interest to other libraries too.\n\nIf they where in CyPari, then CyPari would need GMP/Flint in order to compile, wouldn't it?",
    "created_at": "2016-10-11T13:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275214",
    "user": "https://github.com/defeo"
}
```

Replying to [comment:49 jdemeyer]:
> I am wondering what to do with `convert_sage`. First of all, it contains conversions both to/from GMP as well as conversions to/from FLINT. These should be split up in two different modules (I will do that).

Good. Thx.

> But a bigger question is: should these become part of Sage or part of CyPari? Those conversion routines are not directly related to Sage, but to GMP/FLINT which may be of interest to other libraries too.

If they where in CyPari, then CyPari would need GMP/Flint in order to compile, wouldn't it?



---

archive/issue_comments_275215.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-11T13:58:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275215",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275216.json:
```json
{
    "body": "Replying to [comment:53 defeo]:\n> If they where in CyPari, then CyPari would need GMP/Flint in order to compile, wouldn't it?\n\nYes, but those could be optional dependencies (like optional packages in Sage).",
    "created_at": "2016-10-11T14:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275216",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:53 defeo]:
> If they where in CyPari, then CyPari would need GMP/Flint in order to compile, wouldn't it?

Yes, but those could be optional dependencies (like optional packages in Sage).



---

archive/issue_comments_275217.json:
```json
{
    "body": "Also, `cysignals` currently has an *optional* dependency on PARI. It seems to work fine.",
    "created_at": "2016-10-11T14:54:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275217",
    "user": "https://github.com/jdemeyer"
}
```

Also, `cysignals` currently has an *optional* dependency on PARI. It seems to work fine.



---

archive/issue_comments_275218.json:
```json
{
    "body": "For me, this ticket is good to merge. Luca, can you look at the commits that I added (each of them is relatively small and self-contained)?",
    "created_at": "2016-10-11T14:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275218",
    "user": "https://github.com/jdemeyer"
}
```

For me, this ticket is good to merge. Luca, can you look at the commits that I added (each of them is relatively small and self-contained)?



---

archive/issue_comments_275219.json:
```json
{
    "body": "I think commit [d522155ff2f79eed03f73a637d8164cff9cf6f6c](https://git.sagemath.org/sage.git/commit/?id=d522155ff2f79eed03f73a637d8164cff9cf6f6c) is a little brittle. \n\nIf I understand auto-generation correctly, this doesn't break because no method of `PariInstance_auto` has a `PariArgumentSeriesPrec` argument (prototype `P`). I don't know if it is safe to assume that PARI will never have such a function.",
    "created_at": "2016-10-12T13:57:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275219",
    "user": "https://github.com/defeo"
}
```

I think commit [d522155ff2f79eed03f73a637d8164cff9cf6f6c](https://git.sagemath.org/sage.git/commit/?id=d522155ff2f79eed03f73a637d8164cff9cf6f6c) is a little brittle. 

If I understand auto-generation correctly, this doesn't break because no method of `PariInstance_auto` has a `PariArgumentSeriesPrec` argument (prototype `P`). I don't know if it is safe to assume that PARI will never have such a function.



---

archive/issue_comments_275220.json:
```json
{
    "body": "Also, I'm not completely happy about [4d2ad6a97a3c0750768dfa770c113a7cd30c29de](https://git.sagemath.org/sage.git/commit/?id=4d2ad6a97a3c0750768dfa770c113a7cd30c29de). I feel it's bad cimporting `pari_instace` in `padic_capped_relative_element.pyx`.\n\nIn my opinion, external software should use the \"public\" `pari` API whenever possible, unless it has good reasons to fiddle with the internals of CyPari. Is there any good reason here?",
    "created_at": "2016-10-12T14:25:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275220",
    "user": "https://github.com/defeo"
}
```

Also, I'm not completely happy about [4d2ad6a97a3c0750768dfa770c113a7cd30c29de](https://git.sagemath.org/sage.git/commit/?id=4d2ad6a97a3c0750768dfa770c113a7cd30c29de). I feel it's bad cimporting `pari_instace` in `padic_capped_relative_element.pyx`.

In my opinion, external software should use the "public" `pari` API whenever possible, unless it has good reasons to fiddle with the internals of CyPari. Is there any good reason here?



---

archive/issue_comments_275221.json:
```json
{
    "body": "Concerning `convert_gmp.pyx`, docstrings and function names are a bit schizophrenic on whether these are converstion to/from GMP or MPIR. Presumably they work with both?",
    "created_at": "2016-10-12T14:27:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275221",
    "user": "https://github.com/defeo"
}
```

Concerning `convert_gmp.pyx`, docstrings and function names are a bit schizophrenic on whether these are converstion to/from GMP or MPIR. Presumably they work with both?



---

archive/issue_comments_275222.json:
```json
{
    "body": "Replying to [comment:59 defeo]:\n> In my opinion, external software should use the \"public\" `pari` API whenever possible\n\nI consider this as part of the public API.  Why do you consider the Python API public but the Cython API private?",
    "created_at": "2016-10-12T14:40:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275222",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:59 defeo]:
> In my opinion, external software should use the "public" `pari` API whenever possible

I consider this as part of the public API.  Why do you consider the Python API public but the Cython API private?



---

archive/issue_comments_275223.json:
```json
{
    "body": "Replying to [comment:61 jdemeyer]:\n> Replying to [comment:59 defeo]:\n> > In my opinion, external software should use the \"public\" `pari` API whenever possible\n> \n> I consider this as part of the public API.  Why do you consider the Python API public but the Cython API private?\n\nIt's not exactly that. I consider the Cython API also public (unless there are underscores). But when there is duplication of functionality (e.g., any `def`ed or `cpdef`ed method of `pari_instance`), I give priority to the Python API.\n\nI mean, if all you want is to get PARI's zero, just do like any common mortal and call `pari.zero()`. Shorter, more readable, easier to understand.\n\nOf course, it's not a big deal.",
    "created_at": "2016-10-12T14:55:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275223",
    "user": "https://github.com/defeo"
}
```

Replying to [comment:61 jdemeyer]:
> Replying to [comment:59 defeo]:
> > In my opinion, external software should use the "public" `pari` API whenever possible
> 
> I consider this as part of the public API.  Why do you consider the Python API public but the Cython API private?

It's not exactly that. I consider the Cython API also public (unless there are underscores). But when there is duplication of functionality (e.g., any `def`ed or `cpdef`ed method of `pari_instance`), I give priority to the Python API.

I mean, if all you want is to get PARI's zero, just do like any common mortal and call `pari.zero()`. Shorter, more readable, easier to understand.

Of course, it's not a big deal.



---

archive/issue_comments_275224.json:
```json
{
    "body": "Replying to [comment:62 defeo]:\n> I mean, if all you want is to get PARI's zero, just do like any common mortal and call `pari.zero()`. Shorter, more readable, easier to understand.\n\n...but slower. I don't think it matters in this specific case, but we really want users to call `pari_instance.zero()` using Cython if speed is important.",
    "created_at": "2016-10-12T15:00:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275224",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:62 defeo]:
> I mean, if all you want is to get PARI's zero, just do like any common mortal and call `pari.zero()`. Shorter, more readable, easier to understand.

...but slower. I don't think it matters in this specific case, but we really want users to call `pari_instance.zero()` using Cython if speed is important.



---

archive/issue_comments_275225.json:
```json
{
    "body": "> ...but slower.\n\nBy how much?\n\n> I don't think it matters in this specific case, but we really want users to call `pari_instance.zero()` using Cython if speed is important.\n\nThat's why there is no underscore in front of `pari_instance`. But, as you say, speed is not important here.",
    "created_at": "2016-10-12T15:06:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275225",
    "user": "https://github.com/defeo"
}
```

> ...but slower.

By how much?

> I don't think it matters in this specific case, but we really want users to call `pari_instance.zero()` using Cython if speed is important.

That's why there is no underscore in front of `pari_instance`. But, as you say, speed is not important here.



---

archive/issue_comments_275226.json:
```json
{
    "body": "Replying to [comment:64 defeo]:\n> > ...but slower.\n> \n> By how much?\n\nI haven't profiled, but I would guess at least an order of magnitude. Python methods are slow.\n\nBut that doesn't matter, the point is that `pari_instance` and the `zero()` method are part of the public Cython API.",
    "created_at": "2016-10-12T15:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275226",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:64 defeo]:
> > ...but slower.
> 
> By how much?

I haven't profiled, but I would guess at least an order of magnitude. Python methods are slow.

But that doesn't matter, the point is that `pari_instance` and the `zero()` method are part of the public Cython API.



---

archive/issue_comments_275227.json:
```json
{
    "body": "> > By how much?\n> \n> I haven't profiled, but I would guess at least an order of magnitude. Python methods are slow.\n\nI have. The overhead is ~50ns. `pari_instance.zero()` itself takes ~50ns.\n\n> But that doesn't matter,\n\nAs you say. Who cares about 50ns? So we agree that speed is not an argument here. In my opinion readability is, instead.\n\n> the point is that `pari_instance` and the `zero()` method are part of the public Cython API.\n\nI already replied to this point saying that `pari.zero()` is \"more public\". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is \"public enough\".\n\nI do not want to hold this ticket on this very minor detail. If we cannot convince each other, commit minimality wins, so the code stays as it is now.\n\nMy other two comments are more serious, though.",
    "created_at": "2016-10-12T16:16:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275227",
    "user": "https://github.com/defeo"
}
```

> > By how much?
> 
> I haven't profiled, but I would guess at least an order of magnitude. Python methods are slow.

I have. The overhead is ~50ns. `pari_instance.zero()` itself takes ~50ns.

> But that doesn't matter,

As you say. Who cares about 50ns? So we agree that speed is not an argument here. In my opinion readability is, instead.

> the point is that `pari_instance` and the `zero()` method are part of the public Cython API.

I already replied to this point saying that `pari.zero()` is "more public". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is "public enough".

I do not want to hold this ticket on this very minor detail. If we cannot convince each other, commit minimality wins, so the code stays as it is now.

My other two comments are more serious, though.



---

archive/issue_comments_275228.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-14T09:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275228",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275229.json:
```json
{
    "body": "Replying to [comment:66 defeo]:\n> I already replied to this point saying that `pari.zero()` is \"more public\". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is \"public enough\".\n\nCould you be convinced by\n\n```\nfrom ... cimport pari_instance as pari\n```\n\nand then using `pari.zero()`? IMHO, that would be equally readable as the original code while still being fast.",
    "created_at": "2016-10-14T09:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275229",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:66 defeo]:
> I already replied to this point saying that `pari.zero()` is "more public". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is "public enough".

Could you be convinced by

```
from ... cimport pari_instance as pari
```

and then using `pari.zero()`? IMHO, that would be equally readable as the original code while still being fast.



---

archive/issue_comments_275230.json:
```json
{
    "body": "Replying to [comment:60 defeo]:\n> Concerning `convert_gmp.pyx`, docstrings and function names are a bit schizophrenic on whether these are converstion to/from GMP or MPIR. Presumably they work with both?\n\nI totally agree that function names are really inconsistent. But I would keep the names for now, we can make a new ticket to change the names. I'll have a look at the docstrings.",
    "created_at": "2016-10-14T09:58:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275230",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:60 defeo]:
> Concerning `convert_gmp.pyx`, docstrings and function names are a bit schizophrenic on whether these are converstion to/from GMP or MPIR. Presumably they work with both?

I totally agree that function names are really inconsistent. But I would keep the names for now, we can make a new ticket to change the names. I'll have a look at the docstrings.



---

archive/issue_comments_275231.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-14T10:12:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275231",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275232.json:
```json
{
    "body": "I think this takes care of your other comments. So that leaves the `pari_instance.zero()` issue. What do you think of [comment:68]",
    "created_at": "2016-10-14T11:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275232",
    "user": "https://github.com/jdemeyer"
}
```

I think this takes care of your other comments. So that leaves the `pari_instance.zero()` issue. What do you think of [comment:68]



---

archive/issue_comments_275233.json:
```json
{
    "body": "Replying to [comment:67 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[6f815cd](https://git.sagemath.org/sage.git/commit/?id=6f815cd0dcba998a748b59500d3820ff2efc9716)||`Put back convert_code for PariInstanceArgument`||\n\nOk, this addresses one of my concerns. But I'm curious: what's the rationale behind writing\n\n\n```\ndef ...(self, ...):\n    cdef PariInstance pari_instance = <PariInstance>self\n```\n\n\ninstead of simply writing\n\n\n```\ndef ...(pari_instance, ...):\n```\n",
    "created_at": "2016-10-14T15:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275233",
    "user": "https://github.com/defeo"
}
```

Replying to [comment:67 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[6f815cd](https://git.sagemath.org/sage.git/commit/?id=6f815cd0dcba998a748b59500d3820ff2efc9716)||`Put back convert_code for PariInstanceArgument`||

Ok, this addresses one of my concerns. But I'm curious: what's the rationale behind writing


```
def ...(self, ...):
    cdef PariInstance pari_instance = <PariInstance>self
```


instead of simply writing


```
def ...(pari_instance, ...):
```




---

archive/issue_comments_275234.json:
```json
{
    "body": "Replying to [comment:68 jdemeyer]:\n> Replying to [comment:66 defeo]:\n> > I already replied to this point saying that `pari.zero()` is \"more public\". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is \"public enough\".\n> \n> Could you be convinced by\n> {{{\n> from ... cimport pari_instance as pari\n> }}}\n> and then using `pari.zero()`? IMHO, that would be equally readable as the original code while still being fast.\n\nSo it seems you care about speed, here? I thought you didn't. Why don't you retrun `pari_instance.PARI_ZERO`, then? I personally don't see how speed can matter here: it's a seldom executed if-branch in a function that is probably orders of magnitude slower than the python-call overhead.\n\nI agree that's more readable, though. I'd prefer that to the current situation.",
    "created_at": "2016-10-14T15:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275234",
    "user": "https://github.com/defeo"
}
```

Replying to [comment:68 jdemeyer]:
> Replying to [comment:66 defeo]:
> > I already replied to this point saying that `pari.zero()` is "more public". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is "public enough".
> 
> Could you be convinced by
> {{{
> from ... cimport pari_instance as pari
> }}}
> and then using `pari.zero()`? IMHO, that would be equally readable as the original code while still being fast.

So it seems you care about speed, here? I thought you didn't. Why don't you retrun `pari_instance.PARI_ZERO`, then? I personally don't see how speed can matter here: it's a seldom executed if-branch in a function that is probably orders of magnitude slower than the python-call overhead.

I agree that's more readable, though. I'd prefer that to the current situation.



---

archive/issue_comments_275235.json:
```json
{
    "body": "Replying to [comment:72 defeo]:\n> what's the rationale behind writing\n> \n> {{{\n> def ...(self, ...):\n>     cdef PariInstance pari_instance = <PariInstance>self\n> }}}\n> \n> instead of simply writing\n> \n> {{{\n> def ...(pari_instance, ...):\n> }}}\n\nThe only reason is the usual convention that the \"self\" argument of a method should be called `self`.\n\nAnd ideally, maybe we can get rid of the `pari_instance.get_series_precision()` call to avoid the `pari_instance` argument completely.",
    "created_at": "2016-10-14T16:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275235",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:72 defeo]:
> what's the rationale behind writing
> 
> {{{
> def ...(self, ...):
>     cdef PariInstance pari_instance = <PariInstance>self
> }}}
> 
> instead of simply writing
> 
> {{{
> def ...(pari_instance, ...):
> }}}

The only reason is the usual convention that the "self" argument of a method should be called `self`.

And ideally, maybe we can get rid of the `pari_instance.get_series_precision()` call to avoid the `pari_instance` argument completely.



---

archive/issue_comments_275236.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-10-15T15:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275236",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_275237.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-10-18T13:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275237",
    "user": "https://github.com/defeo"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_275238.json:
```json
{
    "body": "Sorry for the delay, good to go for me.",
    "created_at": "2016-10-18T13:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275238",
    "user": "https://github.com/defeo"
}
```

Sorry for the delay, good to go for me.



---

archive/issue_comments_275239.json:
```json
{
    "body": "Thanks! Could you also have a look at #21703 please?",
    "created_at": "2016-10-18T16:00:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275239",
    "user": "https://github.com/jdemeyer"
}
```

Thanks! Could you also have a look at #21703 please?



---

archive/issue_comments_275240.json:
```json
{
    "body": "yup. looking at it.",
    "created_at": "2016-10-18T16:49:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275240",
    "user": "https://github.com/defeo"
}
```

yup. looking at it.



---

archive/issue_comments_275241.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-10-21T07:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20004",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20004#issuecomment-275241",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
