# Issue 20004: Separate Sage-specific components from generic C-interface in PariInstance

Issue created by migration from Trac.

Original creator: defeo

Original creation time: 2016-03-21 14:34:02

CC:  jdemeyer

In preparation for #20238, take out of `PariInstance` all components specific to Sage.


---

Comment by defeo created at 2016-03-21 14:48:30

I'm pushing a failed attempt at splitting `PariInstance` into a generic `PariInstance` cython type, and a Sage-specific `SagePariInstance`.

This is problematic because of the global `sage.libs.pari.pari_instance.pari` variable: it is not clear where this variable should go.

Some concrete suggestions: `PariInstance` serves three main purposes:

- As a wrapper around the pari stack,
- As a collection of conversion methods to and from pari types,
- As a namespace for a handful of functions, for lack of a better place (e.g. `primes`, `genus2_reduction`, ...)

Of these, only the first one really needs a Cython type. I suggest:

- To make a proper abstraction `PariStack` around the pari stack. This should not be handled as a global variable, but rather as a singleton class (we cannot have more than one pari stack, because of global variables).
- Move conversion functions to a separate namespace, as #20226 started doing.
- Have `PariInstance` hold a pointer to a `PariStack`. Have `gen`'s hold a pointer to a `PariInstance`. (Maybe this double wrapping is superfluous?)

I don't know quite well what to do with utility functions such as `primes`. They may stay as methods of `PariInstance`, or maybe go to a different namespace as pure functions (they should take a `PariInstance` or `PariStack` as parameter, then).
----
Last 10 new commits:


---

Comment by kedlaya created at 2016-04-09 05:18:41

Regarding the utility functions: I think `primes` belongs in `sage.rings.fast_arith` along with `prime_range`, while `genus2red` should be in `sage.schemes.hyperelliptic_curves.HyperellipticCurve_g2_rational_field` which is otherwise completely empty! The other functions don't provide any new functionality (factorials, Chebyshev polynomials, etc.).


---

Comment by defeo created at 2016-04-09 13:52:45

Replying to [comment:3 kedlaya]:
> Regarding the utility functions: I think `primes` belongs in `sage.rings.fast_arith` along with `prime_range`, while `genus2red` should be in `sage.schemes.hyperelliptic_curves.HyperellipticCurve_g2_rational_field` which is otherwise completely empty! The other functions don't provide any new functionality (factorials, Chebyshev polynomials, etc.).

Good points. These would take a lengthy deprecation process, and are better handled after a successful separation of the interface (something we're still having a hard time with).

I think the best place for this comment is in #20238, hence I'm copying it there.


---

Comment by jdemeyer created at 2016-04-11 08:27:03

`@`kedleya: I don't really understand your comment. This ticket is about the _interface_ between Sage and PARI (which is a purely technical non-mathematical thing), not about how which PARI functions are used where.


---

Comment by defeo created at 2016-08-08 21:47:02

Last 10 new commits:


---

Comment by jdemeyer created at 2016-08-09 07:51:10

Changing type from PLEASE CHANGE to enhancement.


---

Comment by jdemeyer created at 2016-08-09 07:57:34

I don't really know where you are going with this branch, but I thought that we wanted to minimize the use of the global `pari` variable?

For example, `closure.pyx` should not need it, we just need to make `new_gen` and friends functions instead of methods of `PariInstance`.


---

Comment by defeo created at 2016-08-09 08:36:40

Yup. Second step. I needed to know who was using it anyway. Any module importing _pari_instance is doing bad, and I'm fixing it. I just pushed this to get help from patchbot.


---

Comment by git created at 2016-08-19 17:46:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-08-19 17:52:06

Hi `@`jdemeyer. I'm having trouble compiling this code. gcc fails while compiling `complex_double.pyx`, but I cannot figure our the problem. Also `matrix_integer_dense.pyx` gives fishy warnings.

Changing slightly L94 in `complex_double.pyx`, i.e., using `cimport .. as` or similar, it gets even worse: compilation freezes midway, I have to Ctrl-C it.

I'm giving up for today. Do you have any idea?


---

Comment by jdemeyer created at 2016-08-19 19:24:05

For starters, you cannot _declare_ a function to be `cdef inline` in a `.pxd` file unless you put the full function body also in the `.pxd` file. So this isn't correct:

```
cdef inline gen new_gen(GEN x)
```


You have to understand how the compiler works: the compiler for a different module only sees the `.pxd` file, so it cannot possibly inline the function `new_gen` since it doesn't know what `new_gen` does.

It's a bit of a mystery why Cython still accepts this code. GCC gives a error (but sometimes just a warning, maybe it depends on the language) like

```
[sagelib-7.3.rc0] build/cythonized/sage/matrix/matrix_integer_dense.cpp:4828:72: error: ‘__pyx_f_4sage_4libs_4pari_5stack_clear_stack’ declared as an ‘inline’ variable
[sagelib-7.3.rc0]  static CYTHON_INLINE void (*__pyx_f_4sage_4libs_4pari_5stack_clear_stack)(void); /*proto*/
```



---

Comment by jdemeyer created at 2016-08-19 19:31:20

Note that it is perfectly legal to have an inline function in a `.pyx` file and still export it in the `.pxd` file. Just don't put the `inline` in the `.pxd`. This way, the function can be inlined in the `.pyx` file (like the call from `new_gen` to `new_gen_noclear`) but other modules will do a non-inline function call.


---

Comment by jdemeyer created at 2016-08-19 19:36:31

New commits:


---

Comment by jdemeyer created at 2016-08-19 19:39:33

Sage at least compiles now. It doesn't actually start, but I'll leave it to you to continue working on this.


---

Comment by defeo created at 2016-08-19 20:34:24

Makes perfect sense. What I don't get is why you can put `cdef inline` in METHOD definitions in a `.pxd`. I just cut-pasted that line from the definition of `PariInstance`, and it had been actually compiling, booting, and passing tests (hadn't tried many tests, though) for quite some time before this... that's why I hate Cython!

Anyway, thanks for your help. I'll keep chasing the breakages tomorrow.


---

Comment by defeo created at 2016-08-20 11:18:37

Ok, fixed the startup bug, and tests (mostly) pass. Next step is to move all those conversion functions out of the way.

I'm scratching my head about `allocatemem` and companions, though. `allocatemem` is a gp function, but it's tied to `gen` by `auto_gen.pxi`, so that you can do


```
sage: size = pari('10^8')
sage: size.allocatemem()
```


which feels very bad. Wouldn't it make sense to blacklist this one?

On the other hand there is a manually coded `allocatemem` method in `PariInstance` which gives a much more sensible


```
sage: pari.allocatemem(10^8)
```


and also has an additional `silent` parameter to behave more like gp. There are also methods `stacksize` and `stacksizemax` to read the stack sizes. It seems more logical to put these three functions in `stack.pyx`, but if we want the user to call them from the command line, it is better to leave methods in `PariInstance`.

Question: given the current handling of PARI's stack, do we still want the user to easily call these functions?
----
New commits:


---

Comment by jdemeyer created at 2016-08-20 19:19:34

Replying to [comment:20 defeo]:
> Wouldn't it make sense to blacklist this one?

Sure.


---

Comment by jdemeyer created at 2016-08-20 19:21:42

Replying to [comment:20 defeo]:
> Question: given the current handling of PARI's stack, do we still want the user to easily call these functions?

I don't see the problem. They work perfectly fine and make sense. Unless they are problematic for the implementation, I would just keep them as they are. Another reason is that we should focus on finishing this deliverable. We can always clean up such details afterwards.


---

Comment by git created at 2016-08-24 14:01:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-25 00:46:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-08-25 01:08:49

Ok, so I managed to move all Sage-specific conversion functions from `PariInstance` to a separate file. We're getting closer to the goal: the only imports left in `pari_instance.p??` from the sage library are


```
from sage.ext.memory import init_memory_functions
from sage.misc.superseded import deprecation, deprecated_function_alias
```


There's a couple of conversion functions left in `PariInstance` which are not specific to Sage:


```
cdef gen new_gen_from_int(self, int value)
cdef gen new_t_POL_from_int_star(self, int *vals, int length, long varnum)
cdef gen double_to_gen_c(self, double)
cdef GEN double_to_GEN(self, double)
```


plus a python method `PariInstance.double_to_gen`. Should we put these in `convert.pyx`, or maybe another file?

Note that `new_gen_from_int` is only called once in `padic_capped_relative_element.pyx`, and just to create 0.

It is also not very clear to me what the purpose of `double_to_gen` and `double_to_gen_c` is. `double_to_gen_c` is called only in line 1585 of `real_double.pyx`, and that's in a `def`ed function. Is this really faster than calling `double_to_gen`?

And what's the meaning of this, anyway:


```
sage: pari(0.1) == pari.double_to_gen(0.1)
False
sage: pari(0.1) == pari(0.1)
True
sage: pari.double_to_gen(0.1) == pari.double_to_gen(0.1)
True
sage: pari(0.1) - pari.double_to_gen(0.1)
-5.54975987041018 E-18
sage: pari(0.1) - pari(0.1)
0.E-20
sage: pari.double_to_gen(0.1) - pari.double_to_gen(0.1)
0.E-20
```



----
New commits:


---

Comment by jdemeyer created at 2016-08-27 18:54:41

Replying to [comment:25 defeo]:
> Ok, so I managed to move all Sage-specific conversion functions from `PariInstance` to a separate file. We're getting closer to the goal: the only imports left in `pari_instance.p??` from the sage library are
> 
> {{{
> from sage.ext.memory import init_memory_functions
> from sage.misc.superseded import deprecation, deprecated_function_alias
> }}}
> 
> There's a couple of conversion functions left in `PariInstance` which are not specific to Sage:
> 
> {{{
> cdef gen new_gen_from_int(self, int value)
> cdef gen new_t_POL_from_int_star(self, int *vals, int length, long varnum)
> cdef gen double_to_gen_c(self, double)
> cdef GEN double_to_GEN(self, double)
> }}}
> 
> plus a python method `PariInstance.double_to_gen`. Should we put these in `convert.pyx`

Fine for me.

> Note that `new_gen_from_int` is only called once in `padic_capped_relative_element.pyx`, and just to create 0.
> 
> It is also not very clear to me what the purpose of `double_to_gen` and `double_to_gen_c` is.

`double_to_gen` seems unused and untested. I do not mind removing it.

> `double_to_gen_c` is called only in line 1585 of `real_double.pyx`, and that's in a `def`ed function. Is this really faster than calling `double_to_gen`?

Obviously yes. Calling a `cdef` function is much faster than calling a `def` function. It does not matter where it is called from. But I would suggest renaming `double_to_gen_c` to `double_to_gen`.


---

Comment by jdemeyer created at 2016-08-27 19:06:08

Replying to [comment:25 defeo]:
> {{{
> sage: pari(0.1) == pari.double_to_gen(0.1)
> False
> }}}

That's a "feature" because of `RealLiteral`:

```
sage: x = RR(0.1); y = RR(float(0.1))
sage: x == y
True
sage: parent(x) is parent(y)
True
sage: RR64 = RealField(64)
sage: RR64(x) == RR64(y)
False
sage: pari(x) == pari(y)
False
```



---

Comment by git created at 2016-09-04 01:04:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-04 01:41:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-04 10:09:33

You might consider a separate ticket for moving the conversion functions.


---

Comment by jdemeyer created at 2016-09-05 15:24:09

Why did you remove `pari.stacksize()` and similar? I would keep them as methods of `pari`.


---

Comment by jdemeyer created at 2016-09-05 15:30:40

I don't really see the point of this new `init()` function. What's wrong with using the `__init__` method for this?
----
New commits:


---

Comment by defeo created at 2016-09-06 16:36:20

Agreed to revert to a normal constructor, no `init()` factory method.
----
New commits:


---

Comment by defeo created at 2016-09-06 16:36:20

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-09-06 17:28:35

New commits:


---

Comment by git created at 2016-09-06 17:35:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-09-06 17:37:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-06 21:55:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-09-21 15:21:39

New commits:


---

Comment by jdemeyer created at 2016-09-21 15:42:25

Just a reminder: I plan to review this when all dependencies have been merged. Unfortunately, this is currently blocked by #21441.


---

Comment by jdemeyer created at 2016-10-10 08:28:29

Merged latest develop.
----
New commits:


---

Comment by git created at 2016-10-11 08:59:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-10-11 09:26:24

I am wondering what to do with `convert_sage`. First of all, it contains conversions both to/from GMP as well as conversions to/from FLINT. These should be split up in two different modules (I will do that).

But a bigger question is: should these become part of Sage or part of CyPari? Those conversion routines are not directly related to Sage, but to GMP/FLINT which may be of interest to other libraries too.


---

Comment by git created at 2016-10-11 09:27:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2016-10-11 09:55:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-10-11 10:11:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-10-11 13:29:31

Replying to [comment:49 jdemeyer]:
> I am wondering what to do with `convert_sage`. First of all, it contains conversions both to/from GMP as well as conversions to/from FLINT. These should be split up in two different modules (I will do that).

Good. Thx.

> But a bigger question is: should these become part of Sage or part of CyPari? Those conversion routines are not directly related to Sage, but to GMP/FLINT which may be of interest to other libraries too.

If they where in CyPari, then CyPari would need GMP/Flint in order to compile, wouldn't it?


---

Comment by git created at 2016-10-11 13:58:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-10-11 14:53:53

Replying to [comment:53 defeo]:
> If they where in CyPari, then CyPari would need GMP/Flint in order to compile, wouldn't it?

Yes, but those could be optional dependencies (like optional packages in Sage).


---

Comment by jdemeyer created at 2016-10-11 14:54:21

Also, `cysignals` currently has an _optional_ dependency on PARI. It seems to work fine.


---

Comment by jdemeyer created at 2016-10-11 14:57:04

For me, this ticket is good to merge. Luca, can you look at the commits that I added (each of them is relatively small and self-contained)?


---

Comment by defeo created at 2016-10-12 13:57:04

I think commit [d522155ff2f79eed03f73a637d8164cff9cf6f6c](https://git.sagemath.org/sage.git/commit/?id=d522155ff2f79eed03f73a637d8164cff9cf6f6c) is a little brittle. 

If I understand auto-generation correctly, this doesn't break because no method of `PariInstance_auto` has a `PariArgumentSeriesPrec` argument (prototype `P`). I don't know if it is safe to assume that PARI will never have such a function.


---

Comment by defeo created at 2016-10-12 14:25:09

Also, I'm not completely happy about [4d2ad6a97a3c0750768dfa770c113a7cd30c29de](https://git.sagemath.org/sage.git/commit/?id=4d2ad6a97a3c0750768dfa770c113a7cd30c29de). I feel it's bad cimporting `pari_instace` in `padic_capped_relative_element.pyx`.

In my opinion, external software should use the "public" `pari` API whenever possible, unless it has good reasons to fiddle with the internals of CyPari. Is there any good reason here?


---

Comment by defeo created at 2016-10-12 14:27:19

Concerning `convert_gmp.pyx`, docstrings and function names are a bit schizophrenic on whether these are converstion to/from GMP or MPIR. Presumably they work with both?


---

Comment by jdemeyer created at 2016-10-12 14:40:03

Replying to [comment:59 defeo]:
> In my opinion, external software should use the "public" `pari` API whenever possible

I consider this as part of the public API.  Why do you consider the Python API public but the Cython API private?


---

Comment by defeo created at 2016-10-12 14:55:32

Replying to [comment:61 jdemeyer]:
> Replying to [comment:59 defeo]:
> > In my opinion, external software should use the "public" `pari` API whenever possible
> 
> I consider this as part of the public API.  Why do you consider the Python API public but the Cython API private?

It's not exactly that. I consider the Cython API also public (unless there are underscores). But when there is duplication of functionality (e.g., any `def`ed or `cpdef`ed method of `pari_instance`), I give priority to the Python API.

I mean, if all you want is to get PARI's zero, just do like any common mortal and call `pari.zero()`. Shorter, more readable, easier to understand.

Of course, it's not a big deal.


---

Comment by jdemeyer created at 2016-10-12 15:00:17

Replying to [comment:62 defeo]:
> I mean, if all you want is to get PARI's zero, just do like any common mortal and call `pari.zero()`. Shorter, more readable, easier to understand.

...but slower. I don't think it matters in this specific case, but we really want users to call `pari_instance.zero()` using Cython if speed is important.


---

Comment by defeo created at 2016-10-12 15:06:11

> ...but slower.

By how much?

> I don't think it matters in this specific case, but we really want users to call `pari_instance.zero()` using Cython if speed is important.

That's why there is no underscore in front of `pari_instance`. But, as you say, speed is not important here.


---

Comment by jdemeyer created at 2016-10-12 15:30:09

Replying to [comment:64 defeo]:
> > ...but slower.
> 
> By how much?

I haven't profiled, but I would guess at least an order of magnitude. Python methods are slow.

But that doesn't matter, the point is that `pari_instance` and the `zero()` method are part of the public Cython API.


---

Comment by defeo created at 2016-10-12 16:16:52

> > By how much?
> 
> I haven't profiled, but I would guess at least an order of magnitude. Python methods are slow.

I have. The overhead is ~50ns. `pari_instance.zero()` itself takes ~50ns.

> But that doesn't matter,

As you say. Who cares about 50ns? So we agree that speed is not an argument here. In my opinion readability is, instead.

> the point is that `pari_instance` and the `zero()` method are part of the public Cython API.

I already replied to this point saying that `pari.zero()` is "more public". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is "public enough".

I do not want to hold this ticket on this very minor detail. If we cannot convince each other, commit minimality wins, so the code stays as it is now.

My other two comments are more serious, though.


---

Comment by git created at 2016-10-14 09:52:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-10-14 09:55:40

Replying to [comment:66 defeo]:
> I already replied to this point saying that `pari.zero()` is "more public". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is "public enough".

Could you be convinced by

```
from ... cimport pari_instance as pari
```

and then using `pari.zero()`? IMHO, that would be equally readable as the original code while still being fast.


---

Comment by jdemeyer created at 2016-10-14 09:58:33

Replying to [comment:60 defeo]:
> Concerning `convert_gmp.pyx`, docstrings and function names are a bit schizophrenic on whether these are converstion to/from GMP or MPIR. Presumably they work with both?

I totally agree that function names are really inconsistent. But I would keep the names for now, we can make a new ticket to change the names. I'll have a look at the docstrings.


---

Comment by git created at 2016-10-14 10:12:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-10-14 11:28:34

I think this takes care of your other comments. So that leaves the `pari_instance.zero()` issue. What do you think of [comment:68]


---

Comment by defeo created at 2016-10-14 15:02:21

Replying to [comment:67 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[6f815cd](https://git.sagemath.org/sage.git/commit/?id=6f815cd0dcba998a748b59500d3820ff2efc9716)||`Put back convert_code for PariInstanceArgument`||

Ok, this addresses one of my concerns. But I'm curious: what's the rationale behind writing


```
def ...(self, ...):
    cdef PariInstance pari_instance = <PariInstance>self
```


instead of simply writing


```
def ...(pari_instance, ...):
```



---

Comment by defeo created at 2016-10-14 15:16:21

Replying to [comment:68 jdemeyer]:
> Replying to [comment:66 defeo]:
> > I already replied to this point saying that `pari.zero()` is "more public". You haven't given an explanation of why my point is not good, other than `pari_instance.zero()` is "public enough".
> 
> Could you be convinced by
> {{{
> from ... cimport pari_instance as pari
> }}}
> and then using `pari.zero()`? IMHO, that would be equally readable as the original code while still being fast.

So it seems you care about speed, here? I thought you didn't. Why don't you retrun `pari_instance.PARI_ZERO`, then? I personally don't see how speed can matter here: it's a seldom executed if-branch in a function that is probably orders of magnitude slower than the python-call overhead.

I agree that's more readable, though. I'd prefer that to the current situation.


---

Comment by jdemeyer created at 2016-10-14 16:04:07

Replying to [comment:72 defeo]:
> what's the rationale behind writing
> 
> {{{
> def ...(self, ...):
>     cdef PariInstance pari_instance = <PariInstance>self
> }}}
> 
> instead of simply writing
> 
> {{{
> def ...(pari_instance, ...):
> }}}

The only reason is the usual convention that the "self" argument of a method should be called `self`.

And ideally, maybe we can get rid of the `pari_instance.get_series_precision()` call to avoid the `pari_instance` argument completely.


---

Comment by git created at 2016-10-15 15:05:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-10-18 13:50:47

Changing status from needs_review to positive_review.


---

Comment by defeo created at 2016-10-18 13:50:47

Sorry for the delay, good to go for me.


---

Comment by jdemeyer created at 2016-10-18 16:00:44

Thanks! Could you also have a look at #21703 please?


---

Comment by defeo created at 2016-10-18 16:49:41

yup. looking at it.


---

Comment by vbraun created at 2016-10-21 07:04:31

Resolution: fixed
