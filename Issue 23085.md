# Issue 23085: py3: richcmp for modular symbols

Issue created by migration from https://trac.sagemath.org/ticket/23322

Original creator: chapoton

Original creation time: 2017-06-23 14:53:23

CC:  tscrim jdemeyer

as another step to python3

using the very newly available decorator `@`richcmp_method


---

Comment by chapoton created at 2017-06-23 14:53:47

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-06-23 14:53:47

New commits:


---

Comment by chapoton created at 2017-06-23 15:06:39


```
sage -t src/sage/modular/abvar/homspace.py  # Timed out
sage -t src/sage/modular/hecke/hecke_operator.py  # 1 doctest failed
```



---

Comment by chapoton created at 2017-06-23 15:06:39

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-06-23 15:15:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-06-24 20:26:52

Jeroen or Travis, could you please help to fix the pickling issue arising here ?

I had to change some classes from old-style classes to SageObject classes in order to benefit from the new ``@`richcmp_method` decorator. This breaks the pickles, but I do not known how to fix that.

See patchbot report for the exact doctest failure.

Maybe this is not the only issue with the branch.


---

Comment by chapoton created at 2017-06-24 20:26:52

Changing status from needs_work to needs_info.


---

Comment by tscrim created at 2017-06-24 23:43:53

I think there might be two issues here. The `H == loads(dumps(H))` might be exposing something with the decorator not being well-behaved wrt pickling. The second might be due to old-style vs new-style classes, but IDK without doing a much deeper investigation than I have time ATM.

Side comment: in `HeckeOperator`, the check

```
if not isinstance(other, HeckeOperator):
```

seems superfluous now because the coercion framework should make them have the same parent, and hence, the same element class (at least if it is a proper, well-behaved parent).


---

Comment by jdemeyer created at 2017-06-26 07:43:16

Replying to [comment:5 tscrim]:
> at least if it is a proper, well-behaved parent

What do you mean with this? There is nothing in the coercion framework which says that "equal parents" should imply "equal Python classes". For _most_ parents, this implication happens to be true, but it's not a general rule.


---

Comment by jdemeyer created at 2017-06-26 09:21:39

Replying to [comment:4 chapoton]:
> Jeroen or Travis, could you please help to fix the pickling issue arising here ?

It would help if you could specify exactly which "issue" you mean.


---

Comment by jdemeyer created at 2017-06-26 09:24:07

Why the `return (op == op_NE)` for non-matching types? The proper Python behaviour is `return NotImplemented` when you cannot decide a comparison.


---

Comment by jdemeyer created at 2017-06-26 11:29:52

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2017-06-26 11:29:52

With the current branch, I get

```
sage -t src/sage/modular/hecke/ambient_module.py
**********************************************************************
File "src/sage/modular/hecke/ambient_module.py", line 167, in sage.modular.hecke.ambient_module.AmbientHeckeModule._hecke_image_of_ith_basis_element
Failed example:
    sage.modular.hecke.ambient_module.AmbientHeckeModule(QQ, 3, 2, 4)._hecke_image_of_ith_basis_element(4, 2)
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: Derived class <class 'sage.modular.hecke.ambient_module.AmbientHeckeModule_with_category'> should implement __cmp__
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 509, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 872, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.hecke.ambient_module.AmbientHeckeModule._hecke_image_of_ith_basis_element[0]>", line 1, in <module>
        sage.modular.hecke.ambient_module.AmbientHeckeModule(QQ, Integer(3), Integer(2), Integer(4))._hecke_image_of_ith_basis_element(Integer(4), Integer(2))
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/ambient_module.py", line 172, in _hecke_image_of_ith_basis_element
        return self.hecke_operator(n)(self.gen(i))
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/hecke_operator.py", line 203, in __call__
        T = self.hecke_module_morphism()
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/hecke_operator.py", line 142, in hecke_module_morphism
        T = self.matrix()
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/hecke_operator.py", line 750, in matrix
        self.__matrix = self.parent().hecke_matrix(self.__n, *args, **kwds)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/algebra.py", line 592, in hecke_matrix
        return self.__M.hecke_matrix(n, *args, **kwds)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/module.py", line 1389, in hecke_matrix
        T = self._compute_hecke_matrix(n)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/module.py", line 220, in _compute_hecke_matrix
        return self._compute_hecke_matrix_prime_power(F[0][0],F[0][1], **kwds)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/module.py", line 148, in _compute_hecke_matrix_prime_power
        self._hecke_matrices[pow] = self._compute_hecke_matrix(pow)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/module.py", line 216, in _compute_hecke_matrix
        return self._compute_hecke_matrix_prime(n, **kwds)
      File "/usr/local/src/sage-config/local/lib/python2.7/site-packages/sage/modular/hecke/module.py", line 239, in _compute_hecke_matrix_prime
        raise NotImplementedError("All subclasses must implement _compute_hecke_matrix_prime")
    NotImplementedError: All subclasses must implement _compute_hecke_matrix_prime
**********************************************************************
```

I think it's sufficient to fix the doctest here.


---

Comment by tscrim created at 2017-06-26 11:47:45

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 tscrim]:
> > at least if it is a proper, well-behaved parent
> 
> What do you mean with this? There is nothing in the coercion framework which says that "equal parents" should imply "equal Python classes". For _most_ parents, this implication happens to be true, but it's not a general rule.

I'm going to use a cop-out and say "well-behaved" `:P`, but yes, fair point. There is also the fact that the Hecke algebra here bypasses the usual coercion and implements its own custom `__call__`. So, we do need to keep the extra type checking and handling by `_richcmp_`.


---

Comment by git created at 2017-07-05 06:49:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-05 06:52:33

I fixed the failing doctest and made the suggested changes (using `NotImplemented`).

There remains the 3 pickling problems, namely in

```
sage -t --long src/sage/structure/sage_object.pyx
```

and more precisely (see patchbot reports for more details):

```
    Failed:
    _class__sage_modular_modform_cuspidal_submodule_CuspidalSubmodule_g1_Q__.sobj
    _class__sage_modular_modsym_manin_symbols_ManinSymbolList_gamma1__.sobj
    _class__sage_modular_modsym_manin_symbols_ManinSymbolList_gamma_h__.sobj
    ----------------------------------------------------------------------
    ** This error is probably due to an old pickle failing to unpickle.
    ** See sage.structure.sage_object.register_unpickle_override for
    ** how to override the default unpickling methods for (old) pickles.
    ** NOTE: pickles should never be removed from the pickle_jar! 
    ----------------------------------------------------------------------
    Successfully unpickled 583 objects.
    Failed to unpickle 3 objects.
```

Please help to fix that, because I am not able to.


---

Comment by chapoton created at 2017-07-07 07:02:08

ping ? any expert on pickling ?


---

Comment by chapoton created at 2017-07-07 13:45:43

maybe we can just update the pickle jar ?


---

Comment by jdemeyer created at 2017-07-07 14:05:53

Replying to [comment:14 chapoton]:
> maybe we can just update the pickle jar ?

No, we really should not do that, at least not without a deprecation of the old pickles.


---

Comment by git created at 2017-07-07 14:51:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-07 14:52:43

ok, I think that I have found a proper solution for the pickling issue. I kept a minimalist old-style class.


---

Comment by chapoton created at 2017-07-07 14:52:43

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-07-07 15:17:47

This is a solution, but IMO it is a complete hack solution. I suspect the issues comes from the fact that the base class is now `SageObject` versus a old-style Python class:

```python
sage: class Foo(object):
....:     def __init__(self, x):
....:         self._x = x
....:     def __eq__(self, other):
....:         return self._x == other._x
sage: F = Foo(5)
sage: F.__class__.__mro__
(<class '__main__.Foo'>, <type 'object'>)
sage: class Foo:
...
sage: F = Foo(5)
sage: F.__class__.__mro__
...
AttributeError: class Foo has no attribute '__mro__'
```

However, I'm not sure exactly how to fix this. Have you tried implementing a custom `__setstate__`?

One way to get around this should be to use a function as the unpickle override, but IIRC, classes need to go to classes, so I think this ends up not working. Yet, there is a close variant of this approach that has a simple target class with a `__setstate__`, that when called and the unpickling is done, it then sets the `self.__class__ = Foo`. I believe this is done somewhere in the codebase...


---

Comment by tscrim created at 2017-07-07 15:17:47

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2017-07-09 10:32:46

I have found something in `src/sage/combinat/skew_tableau.py` but not managed so far to adapt it to the current situation.


---

Comment by chapoton created at 2017-07-09 14:41:33

Trying this

```
class G1list_old:
    """
    This exists solely for unpickling old ``G1list`` objects.

    TESTS::

        sage: L = sage.modular.modsym.g1list.G1list_old(18)
        sage: loads(dumps(L)) == L
        True
    """
    def __setstate__(self, state):
        r"""
        Unpickle old ``G1list`` objects.
        """
        self.__class__ = G1list_new
        self.__init__(state['_N'])
```

fails `unpickle_all()` with error:

```
line 160, in __setstate__
    self.__class__ = G1list_new
TypeError: __class__ must be set to a class
```

When changing the first line to `class G1list_old(object)`, I get another error.


---

Comment by jdemeyer created at 2017-07-10 08:27:12

Replying to [comment:20 chapoton]:
> fails `unpickle_all()` with error:
> {{{
> line 160, in __setstate__
>     self.__class__ = G1list_new
> TypeError: __class__ must be set to a class
> }}}

Writing _complete_ tracebacks in tickets is very useful if people want to understand the issue.


---

Comment by chapoton created at 2017-07-10 09:41:54

Here it is (I am going to push the corresponding branch as `u/chapoton/23322_experimental`):

```
sage: from sage.structure.sage_object import *
sage: unpickle_all()
/home/chapoton/sage/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2881: DeprecationWarning: You unpickled an object which relies on an old data structure. Save it again to update it, for it may break in the future.
See http://trac.sagemath.org/18375 for details.
  exec(code_obj, self.user_global_ns, self.user_ns)
/home/chapoton/sage/src/bin/sage-ipython:1: DeprecationWarning: You unpickled an object which relies on an old data structure. Save it again to update it, for it may break in the future.
See http://trac.sagemath.org/1000 for details.
  #!/usr/bin/env python
/home/chapoton/sage/src/bin/sage-ipython:1: DeprecationWarning: This function is only used to unpickle invalid objects
See http://trac.sagemath.org/18848 for details.
  #!/usr/bin/env python
/home/chapoton/sage/src/bin/sage-ipython:1: DeprecationWarning: OrderedAlphabet is deprecated; use Alphabet instead.
See http://trac.sagemath.org/8920 for details.
  #!/usr/bin/env python
 * unpickle failure: load('/home/chapoton/.sage/temp/pc-chapoton/15061/dir_Ctdi9T//pickle_jar/_class__sage_modular_modform_cuspidal_submodule_CuspidalSubmodule_g1_Q__.sobj')
Traceback (most recent call last):
  File "sage/structure/sage_object.pyx", line 1694, in sage.structure.sage_object.unpickle_all (/home/chapoton/sage/src/build/cythonized/sage/structure/sage_object.c:17663)
    object = load(os.path.join(dir,A))
  File "sage/structure/sage_object.pyx", line 1089, in sage.structure.sage_object.load (/home/chapoton/sage/src/build/cythonized/sage/structure/sage_object.c:13196)
    X = loads(open(filename).read(), compress=compress)
  File "sage/structure/sage_object.pyx", line 1489, in sage.structure.sage_object.loads (/home/chapoton/sage/src/build/cythonized/sage/structure/sage_object.c:15916)
    return unpickler.load()
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/modular/modsym/g1list.py", line 151, in __setstate__
    self.__class__ = G1list_new
TypeError: __class__ must be set to a class
/home/chapoton/sage/src/bin/sage-ipython:1: DeprecationWarning: gen_py.pari is deprecated, use sage.libs.pari.all.pari instead
See http://trac.sagemath.org/17451 for details.
  #!/usr/bin/env python
 * unpickle failure: load('/home/chapoton/.sage/temp/pc-chapoton/15061/dir_Ctdi9T//pickle_jar/_class__sage_modular_modsym_manin_symbols_ManinSymbolList_gamma1__.sobj')
Traceback (most recent call last):
  File "sage/structure/sage_object.pyx", line 1694, in sage.structure.sage_object.unpickle_all (/home/chapoton/sage/src/build/cythonized/sage/structure/sage_object.c:17663)
    object = load(os.path.join(dir,A))
  File "sage/structure/sage_object.pyx", line 1089, in sage.structure.sage_object.load (/home/chapoton/sage/src/build/cythonized/sage/structure/sage_object.c:13196)
    X = loads(open(filename).read(), compress=compress)
  File "sage/structure/sage_object.pyx", line 1489, in sage.structure.sage_object.loads (/home/chapoton/sage/src/build/cythonized/sage/structure/sage_object.c:15916)
    return unpickler.load()
  File "/home/chapoton/sage/local/lib/python2.7/site-packages/sage/modular/modsym/g1list.py", line 151, in __setstate__
    self.__class__ = G1list_new
TypeError: __class__ must be set to a class
/home/chapoton/sage/local/lib/python2.7/site-packages/sage/rings/finite_rings/finite_field_constructor.py:718: DeprecationWarning: The "pari_mod" finite field implementation is deprecated
See http://trac.sagemath.org/17297 for details.
  K = FiniteField_ext_pari(order, name, modulus)
/home/chapoton/sage/src/bin/sage-ipython:1: DeprecationWarning: ANRootOfUnity is deprecated
See http://trac.sagemath.org/19954 for details.
  #!/usr/bin/env python
Failed:
_class__sage_modular_modform_cuspidal_submodule_CuspidalSubmodule_g1_Q__.sobj
_class__sage_modular_modsym_manin_symbols_ManinSymbolList_gamma1__.sobj
----------------------------------------------------------------------
** This error is probably due to an old pickle failing to unpickle.
** See sage.structure.sage_object.register_unpickle_override for
** how to override the default unpickling methods for (old) pickles.
** NOTE: pickles should never be removed from the pickle_jar! 
----------------------------------------------------------------------
Successfully unpickled 584 objects.
Failed to unpickle 2 objects.
```



---

Comment by tscrim created at 2017-07-10 23:30:39

In the case of `SkewTableau`, the old `SkewTableau_class` was being removed and base class changed, which changed the internals and how it dealt with unpickling. So the solution (workaround?) was to subclass and write unpickling within the `__setstate__` as the unpickling did not want to take a function when it was originally a class.

The reason why you are getting an error in your case is because `G1list_old` is an old-style class, which does not have a `__class__` attribute. So I think if you were going to do the `SkewTableau` approach, it should be a subclass of `G1list_new` with a `__setstate__`.

However, I do not think this is a good approach overall as there is no real point in having a class alias and it seems too hacky, at least without trying to handle things directly with a `__setstate__`. Now that I have 2 moments to spend, let me see if I can get something to work.


---

Comment by tscrim created at 2017-07-11 00:08:43

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-07-11 00:08:43

Okay, so how pickles are created for old-style classes is quite different than for new-style:

```
sage: class Foo:
....:     def __init__(self, x):
....:         self._x = x
sage: F = Foo(5)
sage: p = dumps(F)
sage: explain_pickle(p)
pg_Foo = unpickle_global('__main__', 'Foo')
pg = unpickle_instantiate(pg_Foo, ())
pg_make_integer = unpickle_global('sage.rings.integer', 'make_integer')
unpickle_build(pg, {'_x':pg_make_integer('5')})
pg
sage: loads(p)._x
5
sage: class Foo(object):
....:     def __init__(self, x=None):
....:         self._x = x
....:     def __setstate__(self, state):
....:         print(state)
....:         self._x = state['_x']
sage: loads(p)._x
('__init__', None)
{'_x': 5}
5
sage: explain_pickle(dumps(Foo(5)))
pg_Foo = unpickle_global('__main__', 'Foo')
si = unpickle_newobj(pg_Foo, ())
pg_make_integer = unpickle_global('sage.rings.integer', 'make_integer')
unpickle_build(si, {'_x':pg_make_integer('5')})
si
sage: loads(dumps(Foo(5)))._x
('__init__', 5)
{'_x': 5}
5
```

So all of the `__setstate__` logic happens *after* the `__init__` call, which makes it essentially useless for our purpose.

My solution is similar to the `SkewTableau` case, where there is a little dummy class that inherits from the main class `G1list` that just exists to handle pickles and sets its `__class__` to the base class upon `__init__`. This is a little elegant, a little hackish, but it works.
----
New commits:


---

Comment by chapoton created at 2017-07-11 06:13:03

Thanks a lot, Travis. I would never have found that myself.

I did the same for the other similar case. Let me launch my patchbot on it now.
----
New commits:


---

Comment by tscrim created at 2017-07-11 07:11:45

No problem. I'm sorry I didn't have more time to actually sit down and fix it rather than lobbing ideas over.

One other detail, we should add a test in the `__init__` of those classes to make sure the pickling is happening correctly for the new objects. Something like:

```
sage: from sage.modular.modsym.g1list import G1list
sage: L = G1list(6)
sage: Lp = loads(dumps(L))
sage: L == Lp
True
sage: type(Lp) == G1list
True
```

Feel free to add after the patchbot run.


---

Comment by tscrim created at 2017-07-11 07:13:01

Also, positive review if green patchbot (and the added tests pass).


---

Comment by git created at 2017-07-11 08:50:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-07-11 08:51:11

This test fails:

```
type(Lp) == G1list
```

because 

```
sage: type(L)
<class 'sage.modular.modsym.g1list.G1list'>
sage: type(Lp)
<class 'sage.modular.modsym.g1list._G1list_old_pickle'>
```



---

Comment by tscrim created at 2017-07-11 14:36:02

So `SageObject` pickles seem to behave slightly differently than my testing above. So I explicitly added a `__setstate__` and removed the other argument from `__init__` to ensure the corresponding behavior. Now the tests pass:

```
Doctesting 2 files using 8 threads.
sage -t src/sage/modular/modsym/g1list.py
    [21 tests, 0.30 s]
sage -t src/sage/modular/modsym/ghlist.py
    [22 tests, 0.62 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```

----
New commits:


---

Comment by chapoton created at 2017-07-11 16:51:27

green bot. Do we agree that it can be set to positive ?


---

Comment by tscrim created at 2017-07-11 23:46:14

Yep. Done.


---

Comment by tscrim created at 2017-07-11 23:46:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-07-26 22:13:07

Resolution: fixed
