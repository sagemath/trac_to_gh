# Issue 24505: New MatrixInput object to deal with constructing matrices

archive/issues_024505.json:
```json
{
    "body": "CC:  tscrim vdelecroix embray\n\nConstructing matrices is a mess currently. There is a lot of code duplication between\n\n1. The global `matrix()` constructor\n\n2. `MatrixSpace.__call__`\n\n3. The various `Matrix.__init__` methods\n\nSince a lot of parameters are involved (matrix size, entries, ring, sparseness, implementation), I decided to create a new class just for dealing with inputting matrices.\n\nRelated: #20211, #19134\n\nIssue created by migration from https://trac.sagemath.org/ticket/24742\n\n",
    "created_at": "2018-02-15T15:17:26Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "title": "New MatrixInput object to deal with constructing matrices",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24505",
    "user": "jdemeyer"
}
```
CC:  tscrim vdelecroix embray

Constructing matrices is a mess currently. There is a lot of code duplication between

1. The global `matrix()` constructor

2. `MatrixSpace.__call__`

3. The various `Matrix.__init__` methods

Since a lot of parameters are involved (matrix size, entries, ring, sparseness, implementation), I decided to create a new class just for dealing with inputting matrices.

Related: #20211, #19134

Issue created by migration from https://trac.sagemath.org/ticket/24742





---

archive/issue_comments_343839.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-16T18:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343839",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343840.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-17T11:33:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343840",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343841.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-19T14:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343841",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343842.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-20T13:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343842",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343843.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-20T16:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343843",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343844.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-21T15:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343844",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343845.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-21T16:17:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343845",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343846.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-21T16:19:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343846",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343847.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-22T08:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343847",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343848.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-22T11:06:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343848",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343849.json:
```json
{
    "body": "Haven't ready it 100% yet but I get the idea.  Definitely looks like an improvement.",
    "created_at": "2018-02-22T15:08:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343849",
    "user": "embray"
}
```

Haven't ready it 100% yet but I get the idea.  Definitely looks like an improvement.



---

archive/issue_comments_343850.json:
```json
{
    "body": "One very minor comment:\n\n\n```\n+    def __repr__(self):\n+        \"\"\"\n+        Print representation for debugging\n+        \"\"\"\n+        t = \"???\"\n```\n\n\nI know this is mainly just for debugging, but I think instead of \"???\" as the default something more explicit like \"<unfinalized>\" or \"<invalid>\" would be clearer.",
    "created_at": "2018-02-22T15:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343850",
    "user": "embray"
}
```

One very minor comment:


```
+    def __repr__(self):
+        """
+        Print representation for debugging
+        """
+        t = "???"
```


I know this is mainly just for debugging, but I think instead of "???" as the default something more explicit like "<unfinalized>" or "<invalid>" would be clearer.



---

archive/issue_comments_343851.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-22T15:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343851",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343852.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-23T14:30:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343852",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343853.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-23T14:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343853",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343854.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-23T16:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343854",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343855.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-23T21:50:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343855",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343856.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-26T16:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343856",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343857.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-27T06:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343857",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343858.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-27T15:56:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343858",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343859.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-27T16:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343859",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343860.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-27T21:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343860",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343861.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-28T10:18:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343861",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343862.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-28T11:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343862",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343863.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-28T16:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343863",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343864.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-28T19:37:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343864",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343865.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-01T14:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343865",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343866.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-01T16:19:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343866",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343867.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-03-01T16:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343867",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_343868.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-01T19:07:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343868",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343869.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-01T19:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343869",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343870.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-02T11:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343870",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343871.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-02T15:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343871",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343872.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-02T16:11:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343872",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_343873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-03T08:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343873",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343874.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-06T10:13:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343874",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-11T08:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343875",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343876.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-11T08:28:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343876",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343877.json:
```json
{
    "body": "Very nice work! Though I honestly don't understand the new code in detail, it looks reasonable and I trust the tests more than my own judgment to check that it does the right thing. Even if there are small issues, I think it can only be an improvement compared to what we had before.\n\nI have one significant concern with this ticket though: several simple cases of `matrix(...)` apparently became a lot slower. Compare in particular:\n\nSage 8.1:\n\n```\nsage: %timeit matrix(ZZ,3,3)[0,0] = 1 # used to be a fast way to construct a new mutable matrix\nThe slowest run took 62.41 times longer than the fastest. This could mean that an intermediate result is being cached.\n100000 loops, best of 3: 7 \u00b5s per loop\nsage: c = vector(ZZ, [1,2,3])\nsage: %timeit matrix([c])\nThe slowest run took 4.77 times longer than the fastest. This could mean that an intermediate result is being cached.\n10000 loops, best of 3: 33.7 \u00b5s per loop\n```\n\nThis ticket:\n\n```\nsage: %timeit matrix(ZZ,3,3)[0,0] = 1\n10000 loops, best of 3: 110 \u00b5s per loop\nsage: c = vector(ZZ, [1,2,3])\nsage: %timeit matrix([c])\n10000 loops, best of 3: 101 \u00b5s per loop\n```\n\n\nSome nitpicking while I'm at it: it is perhaps not ideal that\n\n```\nsage: matrix(1,1,[[1,2]])\nValueError: inconsistent number of columns: should be 1 but got 2\n```\n\nand\n\n```\nsage: matrix(ZZ,1,1,[[1,2]])\nValueError: sequence too long (expected length 1, got more)\n```\n\nyield different errors.",
    "created_at": "2018-03-11T15:00:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343877",
    "user": "mmezzarobba"
}
```

Very nice work! Though I honestly don't understand the new code in detail, it looks reasonable and I trust the tests more than my own judgment to check that it does the right thing. Even if there are small issues, I think it can only be an improvement compared to what we had before.

I have one significant concern with this ticket though: several simple cases of `matrix(...)` apparently became a lot slower. Compare in particular:

Sage 8.1:

```
sage: %timeit matrix(ZZ,3,3)[0,0] = 1 # used to be a fast way to construct a new mutable matrix
The slowest run took 62.41 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 7 µs per loop
sage: c = vector(ZZ, [1,2,3])
sage: %timeit matrix([c])
The slowest run took 4.77 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 33.7 µs per loop
```

This ticket:

```
sage: %timeit matrix(ZZ,3,3)[0,0] = 1
10000 loops, best of 3: 110 µs per loop
sage: c = vector(ZZ, [1,2,3])
sage: %timeit matrix([c])
10000 loops, best of 3: 101 µs per loop
```


Some nitpicking while I'm at it: it is perhaps not ideal that

```
sage: matrix(1,1,[[1,2]])
ValueError: inconsistent number of columns: should be 1 but got 2
```

and

```
sage: matrix(ZZ,1,1,[[1,2]])
ValueError: sequence too long (expected length 1, got more)
```

yield different errors.



---

archive/issue_comments_343878.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-03-12T00:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343878",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_343879.json:
```json
{
    "body": "There is something very strange going on with the timings:\n\nWith this ticket, constructing a matrix and storing it is an order of magnitude faster than constructing a matrix and *not* storing it:\n\n```\nsage: timeit('matrix(3, 3)', repeat=5, number=10000)\n10000 loops, best of 5: 117 \u00b5s per loop\nsage: timeit('a=matrix(3, 3)', repeat=5, number=10000)\n10000 loops, best of 5: 10.7 \u00b5s per loop\n```\n\nIt doesn't matter if the storing happens inside the `timeit()` or not:\n\n```\nsage: M = matrix(3,3)\nsage: timeit('matrix(3, 3)', repeat=5, number=10000)\n10000 loops, best of 5: 10.5 \u00b5s per loop\nsage: del M\nsage: timeit('matrix(3, 3)', repeat=5, number=10000)\n10000 loops, best of 5: 115 \u00b5s per loop\n```\n\nThere must be some caching issue here...\n\nThe current behaviour (without #24742) does not have this.",
    "created_at": "2018-03-12T00:20:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343879",
    "user": "jdemeyer"
}
```

There is something very strange going on with the timings:

With this ticket, constructing a matrix and storing it is an order of magnitude faster than constructing a matrix and *not* storing it:

```
sage: timeit('matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 117 µs per loop
sage: timeit('a=matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 10.7 µs per loop
```

It doesn't matter if the storing happens inside the `timeit()` or not:

```
sage: M = matrix(3,3)
sage: timeit('matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 10.5 µs per loop
sage: del M
sage: timeit('matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 115 µs per loop
```

There must be some caching issue here...

The current behaviour (without #24742) does not have this.



---

archive/issue_comments_343880.json:
```json
{
    "body": "When a previous matrix is \"cached\", the timings with this ticket are actually better than before.\n\n**Before** (8.2.beta8):\n\n\n```\nsage: M = matrix(ZZ,3,3)\nsage: timeit('matrix(ZZ,3,3)', repeat=5, number=10000)\n10000 loops, best of 5: 13.2 \u00b5s per loop\n```\n\n\n```\nsage: c = vector(ZZ, [1,2,3]); matrix([c])\n[1 2 3]\nsage: timeit('matrix([c])', repeat=5, number=10000)\n10000 loops, best of 5: 46.3 \u00b5s per loop\n```\n\n\n**After** (#24742):\n\n\n```\nsage: M = matrix(ZZ,3,3)\nsage: timeit('matrix(ZZ,3,3)', repeat=5, number=10000)\n10000 loops, best of 5: 10.7 \u00b5s per loop\n```\n\n\n```\nsage: c = vector(ZZ, [1,2,3]); matrix([c])\n[1 2 3]\nsage: timeit('matrix([c])', repeat=5, number=10000)\n10000 loops, best of 5: 14.5 \u00b5s per loop\n```\n",
    "created_at": "2018-03-12T00:29:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343880",
    "user": "jdemeyer"
}
```

When a previous matrix is "cached", the timings with this ticket are actually better than before.

**Before** (8.2.beta8):


```
sage: M = matrix(ZZ,3,3)
sage: timeit('matrix(ZZ,3,3)', repeat=5, number=10000)
10000 loops, best of 5: 13.2 µs per loop
```


```
sage: c = vector(ZZ, [1,2,3]); matrix([c])
[1 2 3]
sage: timeit('matrix([c])', repeat=5, number=10000)
10000 loops, best of 5: 46.3 µs per loop
```


**After** (#24742):


```
sage: M = matrix(ZZ,3,3)
sage: timeit('matrix(ZZ,3,3)', repeat=5, number=10000)
10000 loops, best of 5: 10.7 µs per loop
```


```
sage: c = vector(ZZ, [1,2,3]); matrix([c])
[1 2 3]
sage: timeit('matrix([c])', repeat=5, number=10000)
10000 loops, best of 5: 14.5 µs per loop
```




---

archive/issue_comments_343881.json:
```json
{
    "body": "The slowdown within `timeit()` is tracked at #24954.",
    "created_at": "2018-03-13T16:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343881",
    "user": "jdemeyer"
}
```

The slowdown within `timeit()` is tracked at #24954.



---

archive/issue_comments_343882.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-03-15T10:08:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343882",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_343883.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-15T10:10:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343883",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_343884.json:
```json
{
    "body": "Replying to [comment:55 mmezzarobba]:\n> Some nitpicking while I'm at it: it is perhaps not ideal that\n> {{{\n> sage: matrix(1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))\n> ValueError: inconsistent number of columns: should be 1 but got 2\n> }}}\n> and\n> {{{\n> sage: matrix(ZZ,1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))\n> ValueError: sequence too long (expected length 1, got more)\n> }}}\n> yield different errors.\n\nNot ideal, but it's not clear what the best solution is. The problem is that I'm using different code paths for the case where everything (base ring + matrix dimensions) is known and for when it's not known. In order to determine the base ring, I have to iterate over the entries anyway. It's there that the error \"inconsistent number of columns\" is raised.",
    "created_at": "2018-03-15T10:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343884",
    "user": "jdemeyer"
}
```

Replying to [comment:55 mmezzarobba]:
> Some nitpicking while I'm at it: it is perhaps not ideal that
> {{{
> sage: matrix(1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))
> ValueError: inconsistent number of columns: should be 1 but got 2
> }}}
> and
> {{{
> sage: matrix(ZZ,1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))
> ValueError: sequence too long (expected length 1, got more)
> }}}
> yield different errors.

Not ideal, but it's not clear what the best solution is. The problem is that I'm using different code paths for the case where everything (base ring + matrix dimensions) is known and for when it's not known. In order to determine the base ring, I have to iterate over the entries anyway. It's there that the error "inconsistent number of columns" is raised.



---

archive/issue_comments_343885.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-23T13:38:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343885",
    "user": "mmezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_343886.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2018-03-29T13:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343886",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_343887.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2018-03-29T13:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343887",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_343888.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-29T13:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343888",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_343889.json:
```json
{
    "body": "Trivially rebased.",
    "created_at": "2018-03-29T13:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343889",
    "user": "jdemeyer"
}
```

Trivially rebased.



---

archive/issue_comments_343890.json:
```json
{
    "body": "Failures in src/sage/schemes/riemann_surfaces/riemann_surface.py, possibly due to 24370",
    "created_at": "2018-05-07T17:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343890",
    "user": "vbraun"
}
```

Failures in src/sage/schemes/riemann_surfaces/riemann_surface.py, possibly due to 24370



---

archive/issue_comments_343891.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-07T17:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343891",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_343892.json:
```json
{
    "body": "Replying to [comment:67 vbraun]:\n> Failures in src/sage/schemes/riemann_surfaces/riemann_surface.py, possibly due to 24370\n\nIf #24370 and #24742 conflict, can we instead set #24370 to needs_work?",
    "created_at": "2018-05-07T17:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343892",
    "user": "jdemeyer"
}
```

Replying to [comment:67 vbraun]:
> Failures in src/sage/schemes/riemann_surfaces/riemann_surface.py, possibly due to 24370

If #24370 and #24742 conflict, can we instead set #24370 to needs_work?



---

archive/issue_comments_343893.json:
```json
{
    "body": "I think that #24370 is the ticket that deserved to be set to needs_work, but I'll hear from you if you disagree.",
    "created_at": "2018-05-07T18:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343893",
    "user": "jdemeyer"
}
```

I think that #24370 is the ticket that deserved to be set to needs_work, but I'll hear from you if you disagree.



---

archive/issue_comments_343894.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-05-07T18:05:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343894",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_343895.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-07T19:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343895",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_343896.json:
```json
{
    "body": "Apparently a conflict with #24370. These tickets just need to be calibrated. The fix is clear either way.",
    "created_at": "2018-05-07T19:41:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343896",
    "user": "nbruin"
}
```

Apparently a conflict with #24370. These tickets just need to be calibrated. The fix is clear either way.



---

archive/issue_comments_343897.json:
```json
{
    "body": "With the updated version of #24370, everything works fine! So *both* tickets can get positive review.",
    "created_at": "2018-05-07T21:55:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343897",
    "user": "jdemeyer"
}
```

With the updated version of #24370, everything works fine! So *both* tickets can get positive review.



---

archive/issue_comments_343898.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-05-07T21:56:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343898",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_343899.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-09T09:49:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24505",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24505#issuecomment-343899",
    "user": "vbraun"
}
```

Resolution: fixed
