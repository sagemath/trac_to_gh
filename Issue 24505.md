# Issue 24505: New MatrixInput object to deal with constructing matrices

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-02-15 15:17:26

CC:  tscrim vdelecroix embray

Constructing matrices is a mess currently. There is a lot of code duplication between

1. The global `matrix()` constructor

2. `MatrixSpace.__call__`

3. The various `Matrix.__init__` methods

Since a lot of parameters are involved (matrix size, entries, ring, sparseness, implementation), I decided to create a new class just for dealing with inputting matrices.

Related: #20211, #19134


---

Comment by git created at 2018-02-16 18:08:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-17 11:33:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-19 14:13:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-20 13:39:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-20 16:28:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-21 15:31:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-21 16:17:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-21 16:19:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-22 08:47:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-22 11:06:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-02-22 15:08:17

Haven't ready it 100% yet but I get the idea.  Definitely looks like an improvement.


---

Comment by embray created at 2018-02-22 15:10:58

One very minor comment:


```
+    def __repr__(self):
+        """
+        Print representation for debugging
+        """
+        t = "???"
```


I know this is mainly just for debugging, but I think instead of "???" as the default something more explicit like "<unfinalized>" or "<invalid>" would be clearer.


---

Comment by git created at 2018-02-22 15:51:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-23 14:30:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-23 14:42:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-23 16:11:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-23 21:50:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-26 16:42:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-27 06:34:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-27 15:56:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-27 16:25:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-27 21:08:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-28 10:18:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-28 11:47:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-28 16:31:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-02-28 19:37:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-01 14:21:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-01 16:19:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-01 16:22:20

New commits:


---

Comment by git created at 2018-03-01 19:07:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-01 19:13:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-02 11:43:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-02 15:47:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-02 16:11:34

Changing status from new to needs_review.


---

Comment by git created at 2018-03-03 08:56:38

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-06 10:13:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-11 08:28:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-03-11 08:28:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2018-03-11 15:00:13

Very nice work! Though I honestly don't understand the new code in detail, it looks reasonable and I trust the tests more than my own judgment to check that it does the right thing. Even if there are small issues, I think it can only be an improvement compared to what we had before.

I have one significant concern with this ticket though: several simple cases of `matrix(...)` apparently became a lot slower. Compare in particular:

Sage 8.1:

```
sage: %timeit matrix(ZZ,3,3)[0,0] = 1 # used to be a fast way to construct a new mutable matrix
The slowest run took 62.41 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 7 µs per loop
sage: c = vector(ZZ, [1,2,3])
sage: %timeit matrix([c])
The slowest run took 4.77 times longer than the fastest. This could mean that an intermediate result is being cached.
10000 loops, best of 3: 33.7 µs per loop
```

This ticket:

```
sage: %timeit matrix(ZZ,3,3)[0,0] = 1
10000 loops, best of 3: 110 µs per loop
sage: c = vector(ZZ, [1,2,3])
sage: %timeit matrix([c])
10000 loops, best of 3: 101 µs per loop
```


Some nitpicking while I'm at it: it is perhaps not ideal that

```
sage: matrix(1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))
ValueError: inconsistent number of columns: should be 1 but got 2
```

and

```
sage: matrix(ZZ,1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))
ValueError: sequence too long (expected length 1, got more)
```

yield different errors.


---

Comment by jdemeyer created at 2018-03-12 00:20:54

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-03-12 00:20:54

There is something very strange going on with the timings:

With this ticket, constructing a matrix and storing it is an order of magnitude faster than constructing a matrix and _not_ storing it:

```
sage: timeit('matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 117 µs per loop
sage: timeit('a=matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 10.7 µs per loop
```

It doesn't matter if the storing happens inside the `timeit()` or not:

```
sage: M = matrix(3,3)
sage: timeit('matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 10.5 µs per loop
sage: del M
sage: timeit('matrix(3, 3)', repeat=5, number=10000)
10000 loops, best of 5: 115 µs per loop
```

There must be some caching issue here...

The current behaviour (without #24742) does not have this.


---

Comment by jdemeyer created at 2018-03-12 00:29:07

When a previous matrix is "cached", the timings with this ticket are actually better than before.

*Before* (8.2.beta8):


```
sage: M = matrix(ZZ,3,3)
sage: timeit('matrix(ZZ,3,3)', repeat=5, number=10000)
10000 loops, best of 5: 13.2 µs per loop
```


```
sage: c = vector(ZZ, [1,2,3]); matrix([c])
[1 2 3]
sage: timeit('matrix([c])', repeat=5, number=10000)
10000 loops, best of 5: 46.3 µs per loop
```


*After* (#24742):


```
sage: M = matrix(ZZ,3,3)
sage: timeit('matrix(ZZ,3,3)', repeat=5, number=10000)
10000 loops, best of 5: 10.7 µs per loop
```


```
sage: c = vector(ZZ, [1,2,3]); matrix([c])
[1 2 3]
sage: timeit('matrix([c])', repeat=5, number=10000)
10000 loops, best of 5: 14.5 µs per loop
```



---

Comment by jdemeyer created at 2018-03-13 16:39:29

The slowdown within `timeit()` is tracked at #24954.


---

Comment by git created at 2018-03-15 10:08:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-03-15 10:10:07

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-03-15 10:13:08

Replying to [comment:55 mmezzarobba]:
> Some nitpicking while I'm at it: it is perhaps not ideal that
> {{{
> sage: matrix(1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))
> ValueError: inconsistent number of columns: should be 1 but got 2
> }}}
> and
> {{{
> sage: matrix(ZZ,1,1,[This is the Trac macro *1,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2-macro))
> ValueError: sequence too long (expected length 1, got more)
> }}}
> yield different errors.

Not ideal, but it's not clear what the best solution is. The problem is that I'm using different code paths for the case where everything (base ring + matrix dimensions) is known and for when it's not known. In order to determine the base ring, I have to iterate over the entries anyway. It's there that the error "inconsistent number of columns" is raised.


---

Comment by mmezzarobba created at 2018-03-23 13:38:15

Changing status from needs_review to positive_review.


---

Comment by git created at 2018-03-29 13:13:03

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by git created at 2018-03-29 13:13:03

Changing status from positive_review to needs_review.


---

Comment by jdemeyer created at 2018-03-29 13:13:43

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-03-29 13:13:43

Trivially rebased.


---

Comment by vbraun created at 2018-05-07 17:19:03

Failures in src/sage/schemes/riemann_surfaces/riemann_surface.py, possibly due to 24370


---

Comment by vbraun created at 2018-05-07 17:19:03

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2018-05-07 17:57:52

Replying to [comment:67 vbraun]:
> Failures in src/sage/schemes/riemann_surfaces/riemann_surface.py, possibly due to 24370

If #24370 and #24742 conflict, can we instead set #24370 to needs_work?


---

Comment by jdemeyer created at 2018-05-07 18:05:15

I think that #24370 is the ticket that deserved to be set to needs_work, but I'll hear from you if you disagree.


---

Comment by jdemeyer created at 2018-05-07 18:05:15

Changing status from needs_work to positive_review.


---

Comment by nbruin created at 2018-05-07 19:41:54

Changing status from positive_review to needs_work.


---

Comment by nbruin created at 2018-05-07 19:41:54

Apparently a conflict with #24370. These tickets just need to be calibrated. The fix is clear either way.


---

Comment by jdemeyer created at 2018-05-07 21:55:29

With the updated version of #24370, everything works fine! So _both_ tickets can get positive review.


---

Comment by jdemeyer created at 2018-05-07 21:56:34

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-05-09 09:49:54

Resolution: fixed
