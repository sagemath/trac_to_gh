# Issue 18772: upgrade flint to 2.5

Issue created by migration from https://trac.sagemath.org/ticket/19009

Original creator: vdelecroix

Original creation time: 2015-08-10 11:36:12

CC:  jpflori wbhart

[flint-2.5](http://flintlib.org/flint-2.5.tar.gz) is out!


---

Comment by vdelecroix created at 2015-08-10 12:05:48

The three patches that were written for flint-2.4.5 seem not needed anymore (two modifications are included and I was not sure how to handle the remaining one `flint-2.4.5-test.patch`). Removing them and launching `sage -f flint` I ended up with a failure related to NTL. I do not think that I can not help much more right now.


---

Comment by jpflori created at 2015-08-10 12:32:31

Can you post the failure log here?


---

Attachment

Vincent build failed on the 10th of August


---

Comment by vdelecroix created at 2015-08-10 15:43:21

Replying to [comment:2 jpflori]:
> Can you post the failure log here?

Done. I also give the branch I started from in case.
----
New commits:


---

Comment by vdelecroix created at 2015-08-10 16:27:24

Strange

```
2631	make[2]: Leaving directory '/opt/sage/local/var/tmp/sage/build/flint-2.5/src'
2632	/bin/sh: 2: ldconfig: not found
2633	Makefile:141: recipe for target 'libflint.so.13.5.0' failed
2634	make[1]: *** [libflint.so.13.5.0] Error 127
```

What can be this story with `ldconfig` not being found?


---

Comment by vdelecroix created at 2015-08-10 16:39:05

By replacing `ldconfig` with `/sbin/ldconfig` in `Makefile.in`, I was able to build flint... I am waiting for the rest.

There was a patch about changing a `.o` to a `.lo`. Should I keep it?


---

Attachment

Singular failed build on 10th of August


---

Attachment

Failed eclib build on 10th of August


---

Comment by git created at 2015-08-10 17:40:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-08-10 17:44:11

There seems to be a bug around `nmod_mat_cols` vs `nmod_mat_ncols` that prevents to build both `singular` and `eclib`. A simple substitution does the trick (see commit `5af4274`). I posted a message on [flint-devel](https://groups.google.com/forum/#!forum/flint-devel) but as I just registered my message is moderated.

With the current branch I was able to build the whole Sage from scratch.


---

Comment by git created at 2015-08-10 21:41:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-10 21:41:58

Ready to be tested!


---

Comment by vdelecroix created at 2015-08-10 21:41:58

Changing status from new to needs_review.


---

Comment by fbissey created at 2015-08-11 00:36:49

Have you run the test suite Vincent? I got rather interesting stuff while working on the Gentoo ebuild
 * the old test patch shouldn't be needed anymore (I originally wrote that patch) because the `.o` is explicitly requested to be build for the test (quick clever actually, wish I had thought of that).

Something that I will have to take upstream but from which the spkg should be safe. If a previous libflint is already installed the test suite will fail to link because the old one may miss some symbols that are tested and it will be the one found and linked again first. It shouldn't affect sagemath because `spkg-install` explicitly remove the old flint library before install.


---

Comment by fbissey created at 2015-08-11 01:47:17

The problem is quite linux specific. The `FLINT_LIB` target creates `libflint.so.x.y.z` and link it to `libflint.so.x` but doesn't create `libflint.so`. That last one is only created on installation. So if you configure flint to only build shared libraries on linux and run `make check` you don't have a usable `libflint.so` in your build directory. If you have one in a `-Lpath` or global location it will be used. If not you'll go for a straight failure.


---

Comment by git created at 2015-08-11 08:42:31

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-11 08:43:46

All flint test passed without the first patch (I ran `sage -f -c flint`). Thanks!

I also added some description of the two remaining patches in SPKG.txt. According to Bill Hart, they will be in flint-2.5.1.


---

Comment by fbissey created at 2015-08-11 08:58:02

I think you did a very good job spotting those issues, although I am not sure `ldconfig` should be used but that is a matter of taste. I think this is in good shape to go. Send it to the bots!


---

Comment by vdelecroix created at 2015-08-11 09:01:58

Sadly, the bots will not run it because it is about a package... (e.g. they would have to guess where to download the package)


---

Comment by fbissey created at 2015-08-11 09:04:45

Well I guess you could at least make the location of the tarball more obvious in the description. It took me a few seconds to work it out.


---

Comment by vdelecroix created at 2015-08-11 09:09:03

Sorry for that.


---

Comment by fbissey created at 2015-08-11 21:50:13

Do not work on OS X. Your `ldconfig` fix is not appropriate for OS X and other platform lacking `ldconfig`. I will be in touch with upstream about it.


---

Comment by fbissey created at 2015-08-11 21:50:13

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-08-11 21:58:24

Replying to [comment:20 fbissey]:
> Do not work on OS X. Your `ldconfig` fix is not appropriate for OS X and other platform lacking `ldconfig`. I will be in touch with upstream about it.

Bill did something for !Cygwin/Mingw (setting `LDCONFIG=/dev/null`). But not OS X. The last state of `configure` in the `trunk` branch shows

```
# sometimes LDCONFIG is not to be found in the path. Look at some common places.
case "$OS" in
   MINGW*|CYGWIN*)
      LDCONFIG="/dev/null";;
   *)
      if [ -z "$LDCONFIG" ]; then
         if command -v ldconfig > /dev/null; then
            LDCONFIG="ldconfig"
         elif [ -x /sbin/ldconfig ]; then
            LDCONFIG="/sbin/ldconfig"
         else
            echo "Warning: ldconfig was not found. You can specify a path on the command line with LDCONFIG=<name>";
            exit 1
         fi
      fi;;
esac
```



---

Comment by fbissey created at 2015-08-11 22:01:58

I hadn't noticed that. That's the obvious spot to add something for OS X. Thanks for pointing it out.


---

Comment by vdelecroix created at 2015-08-11 22:04:16

See the discussion here [https://github.com/wbhart/flint2/pull/177](https://github.com/wbhart/flint2/pull/177)


---

Comment by fbissey created at 2015-08-11 22:13:15

I see, I have added stuff to the ongoing conversation I have with Bill in https://github.com/wbhart/flint2/issues/180 I guess if it doesn't pick it up now I should make a further pull request for him to find.


---

Comment by fbissey created at 2015-08-12 01:32:59

Bill has merged my OS X stuff and I compiled/tested trunk inside of sage 6.8 (but not installed in place or rebuild stuff, including sage, against it). It looks like we will have a 2.5.1 release shortly with all those fixes inside. I suggest we move to that.


---

Comment by vdelecroix created at 2015-08-12 16:17:50

Back to needs review with flint-2.5.1!
----
New commits:


---

Comment by vdelecroix created at 2015-08-12 16:17:50

Changing status from needs_work to needs_review.


---

Comment by wbhart created at 2015-08-12 18:48:03

I'm afraid there is going to be a 2.5.2. This soname versioning is causing problems everywhere, even with the fixes.

There's also a bug in gmpcompat.h (fixed in trunk).

I hope it won't take long.

Unfortunately libtool is broken on msys2, so we can't even use that.

And some systems don't make /dev/null executable. What a mess this soname business is!


---

Comment by vdelecroix created at 2015-08-12 18:50:25

Replying to [comment:28 wbhart]:
> I'm afraid there is going to be a 2.5.2. This soname versioning is causing problems everywhere, even with the fixes.

We will wait for that... there is no hurry on the Sage side.


---

Comment by vdelecroix created at 2015-08-12 18:50:33

Changing status from needs_review to needs_work.


---

Comment by wbhart created at 2015-08-13 09:42:39

Can someone verify that "true" is available on OSX as an alternative to /dev/null and that it ignores arguments, i.e.

true blah 1 2 3 "hello"

does nothing. I want to use this instead of /dev/null in lieu of LDCONFIG, since more and more systems are making /dev/null not executable.


---

Comment by fbissey created at 2015-08-13 09:57:34


```
Mirage:~ fbissey$ uname -a
Darwin Mirage.local 14.4.0 Darwin Kernel Version 14.4.0: Thu May 28 11:35:04 PDT 2015; root:xnu-2782.30.5~1/RELEASE_X86_64 x86_64
Mirage:~ fbissey$ which true
/usr/bin/true
Mirage:~ fbissey$ true blah 1 2 3 "hello"
Mirage:~ fbissey$ 
```

More seriously I am not sure where your problem is. On OS X when I found out that `LDCONFIG` needed a value I put `a`.
Nothing will try to execute or run the content of `LDCONFIG` in configure if it is passed as an argument and putting `/dev/null` where you did is just as good. Once `LDCONFIG` is defined the only place it can be executed is in the `Makefile` and then it only happens on system with `FLINT_SOLIB` which should only be true on linux. So not executed on any other platform. Actually if you want to clean that up, only care about `LDCONFIG` if `FLINT_SOLIB` is defined in configure.


---

Comment by wbhart created at 2015-08-13 11:29:31

Sorry, I'm not sure I understand what you mean. LDCONFIG is intended to be executed by the Makefile. I don't see where I said it was to be executed by configure. Of course I meant to use true in lieu of ldconfig, not LDCONFIG.

/dev/null doesn't work on some systems (the build fails) because permission to execute /dev/null is denied. Unfortunately, such systems don't set a meaningful uname and so we can't even detect them. true seems to be more portable than /dev/null, at least until someone decides it is a security threat and stops people executing it, as happened with /dev/null.

I will try to clean up when LDCONFIG is set to something other than true. I think having it bomb out with an error is not the right strategy. Even on systems that set FLINT_SOLIB, if they don't have ldconfig it is most likely because they don't need it, in which case configure shouldn't just exit.


---

Comment by fbissey created at 2015-08-13 12:14:23

Have you thought about using `-` in front of `$LDCONFIG` https://www.gnu.org/software/make/manual/html_node/Errors.html#Errors ? That would help it not to bomb out I think.


---

Comment by wbhart created at 2015-08-13 13:44:35

I don't know why, but putting a - in from of $LDCONFIG didn't actually work. It just said, 

/bin/sh: 2: -ldconfig: not found

So much for removing the minus before passing it to the shell!

Edit: ok it works if I put it earlier. It obviously considers the whole block a "line".


---

Comment by git created at 2015-08-13 16:12:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-13 16:13:45

Changing status from needs_work to needs_review.


---

Comment by wbhart created at 2015-08-13 16:14:56

I have now put up flint-2.5.2. I've tested it on Ubuntu and Msys2 and Cygwin to ensure we didn't break anything there. I'd appreciate testing on OSX to verify that all is fine there.


---

Comment by wbhart created at 2015-08-13 16:22:41

By the way, in case it is relevant, the BSD's use different soname policies than Linux, Cygwin, Msys2 or OSX. So flint is almost certainly broken on BSD. But I recently lost access to the last BSD machine I could use. So there's not much I can do for BSD. No doubt Solaris/SunOS is different again.


---

Comment by git created at 2015-08-13 16:41:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-13 18:37:35

I just installed FreeBSD in a virtual machine. Though I was not able to run the `Makefile`. I got plenty of errors

```
make: "/usr/home/vincent/flint2/Makefile" line 35: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 37: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 39: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 63: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 122: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 126: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 128: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 192: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 198: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 200: Need an operator
make: "/usr/home/vincent/flint2/Makefile" line 201: duplicate script for target "define" ignored
...
```

Looks like the BSD make is not exactly behaving like the linux one.


---

Comment by fbissey created at 2015-08-13 18:53:39

Yes. You should use GNU make rather than BSD make. A common problem not just on BSD. Usually it is found as `gmake` on those platforms.


---

Comment by wbhart created at 2015-08-13 19:19:44

If you can tell me what uname and uname -m return on that particular VM I can at least hack in my best guess (in the next release -- I'm not fixing to issue another patch to 2.5).

And yeah, you'll need a bunch of gnu tools to get anywhere on BSD. gmake and probably others.


---

Comment by jhpalmieri created at 2015-08-13 19:24:52

On OS X, it passes its test suite and all of Sage's tests pass. (The checksums didn't match, though. I had to fix those first.)


---

Comment by vdelecroix created at 2015-08-13 19:36:31

Replying to [comment:45 jhpalmieri]:
> On OS X, it passes its test suite and all of Sage's tests pass. (The checksums didn't match, though. I had to fix those first.)

Where you at commit `70b5107`? The sha1sum of the flint-2.5.2.tar.gz that I downloaded started with `04534a2b`.


---

Comment by wbhart created at 2015-08-13 19:48:47

I sneaked an extra commit into the flint-2.5.2 tarball just a couple of minutes after I announced 2.5.2. It's just an extra line in the NEWS file.

I would rewrite history, but my time machine is currently stuck in subspace and I have a plasma leak on deck 7.


---

Comment by git created at 2015-08-13 20:00:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-08-13 20:00:49

With the good checksum.


---

Comment by fbissey created at 2015-08-13 22:04:03

Replying to [comment:35 wbhart]:
> I don't know why, but putting a - in from of $LDCONFIG didn't actually work. It just said, 
> 
> /bin/sh: 2: -ldconfig: not found
> 
> So much for removing the minus before passing it to the shell!
> 
> Edit: ok it works if I put it earlier. It obviously considers the whole block a "line".

Looking back at it, yes of course not just the `ldconfig` call. I am not even sure I want to call it a block when you use a continuation line.

I am putting this back to positive review.


---

Comment by fbissey created at 2015-08-13 22:04:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-08-14 18:16:53

Resolution: fixed
