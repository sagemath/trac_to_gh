# Issue 31484: Endow parents with __pow__

Issue created by migration from https://trac.sagemath.org/ticket/31721

Original creator: @mjungmath

Original creation time: 2021-04-23 17:31:13

CC:  tscrim mkoeppe slelievre

We equip `structure/parent.pyx` with a method `__pow__` which delegates to a concrete implementation `_pow_`, for example in the corresponding category.

Moreover, we move the `__pow__` in `rings/ring.pyx` to the category file `categories/rings.py` so that any ring can benefit from it and not only those which inherit from `rings/ring.pyx`.


---

Comment by @mjungmath created at 2021-04-23 17:40:16

New commits:


---

Comment by @mjungmath created at 2021-04-23 17:40:16

Changing status from new to needs_review.


---

Comment by @mjungmath created at 2021-04-23 17:45:24

Waiting for patchbot, but unless patchbot does not object, this is ready for review.


---

Comment by vdelecroix created at 2021-04-23 18:40:30

Is it not possible to define `__pow__` directly in the category? Why do we need an indirection via `_pow_`? For elements, it is perfectly understandable since things might have to go through coercion when parents mismatch. But here, what is the point?


---

Comment by @mjungmath created at 2021-04-23 19:02:39

Replying to [comment:4 vdelecroix]:
> Is it not possible to define `__pow__` directly in the category? Why do we need an indirection via `_pow_`? For elements, it is perfectly understandable since things might have to go through coercion when parents mismatch. But here, what is the point?

I just mimicked the behavior of `__mul__` for parents. But perhaps you're right and this is not necessary here because no preprocessing is needed.

Travis, do you know more?


---

Comment by @mjungmath created at 2021-04-23 19:28:16

Okay, it turns out that this indeed doesn't work. I have renamed `_pow_` to `__pow__` in `rings.py` and removed the changes in `parent.pyx` and now get the following error:


```
sage: ZZ**2                                                                     
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-98b583f923b1> in <module>
----> 1 ZZ**Integer(2)

~/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15218)()
   2206             return coercion_model.bin_op(left, right, operator.pow)
   2207         # left is a non-Element: do the powering with a Python int
-> 2208         return left ** int(right)
   2209 
   2210     cpdef _pow_(self, other):

TypeError: unsupported operand type(s) for ** or pow(): 'sage.rings.integer_ring.IntegerRing_class' and 'int'
```


while this works


```
sage: ZZ.__pow__(2)                                                             
Ambient free module of rank 2 over the principal ideal domain Integer Ring
```


Apparently the coercion framework tries to play man in the middle.


---

Comment by git created at 2021-04-23 21:51:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-04-24 05:52:49

The coercion framework works on `Element`s and finds common `Parent`s. Outright, it doesn't get involved. Instead, this is something Python does with trying by swapping the order of the two inputs.

I strongly dislike the `__pow__` implemented in the parent. It will override anything that can be done in a category. Category stuff is called lower in the MRO than an any concrete class. So it restricts any future parent implementation for no reason.

That being said, `Parent`s should _not_ be implementing a `_pow_` because there is no reason to standardize input to the same object. It doesn't make sense.

I don't think the `_pow_int` in the `Fields` category is ever called. So it is good to remove it.

Same comment as in the other ticket about nailing categories into memory should be avoided and the changes to `free_module.py`.


---

Comment by @mjungmath created at 2021-04-24 07:05:52

But then I am clueless. If `__pow__` for `parent.pyx` is not desirable and `__pow__` for `rings.py` causes the above error, how do we proceed?


---

Comment by tscrim created at 2021-04-24 08:22:32

There is basically one very technical issue preventing this from working. Compare `ZZ` with `QQ`. For `QQ` to work, you need to first specify that the `mod` parameter is `None`. Then it works. What is different for `ZZ`? It is a parent that is an extension class (i.e., is a `cdef` class). You can see a big difference between the two when you look at the MRO's.

Now, how does an extension class emulate being in a category, it uses `__getattr__`. However, methods like `__pow__` are special in Python and don't necessarily follow the usual rules. This also applies to infix binary operators like `**`. Here, I believe what is happening is it first sees explicitly (without a call to `__getattr__`) that `ZZ` does not have a `__pow__` method, so it then calls `Integer.__pow__(ZZ, n)`, leading to the error.

You seemed surprised that `ZZ.__pow__(2)` still works, but that involves a call to the `__getattr__`. Things are functioning normally there.

Here is perhaps the interesting thing. What you implemented actually works and might be the best solution because it gets around this issue by letting Python know that every `Parent` has a `__pow__` method and to call that (first). So we have to emulate the `Parent.__mul__` implementation (which is a slightly different issue dealing with inheritance, but likely suffers from the same complications). I also strongly dislike the workaround there too. So I cannot object to this.


---

Comment by @mjungmath created at 2021-04-24 08:53:37

That is subtle. Thank you for investigating this!

So, should I just repair the doctests and that's it?


---

Comment by tscrim created at 2021-04-24 09:10:17

Up to the stuff in `free_module.py`, almost. I would include `ZZ^3` as an example somewhere too, along with some (short) explanation about why we do this.


---

Comment by @mjungmath created at 2021-04-24 09:17:08

As for `free_module.py` I have a different idea. At the current stage, all generic ring methods such as `is_field` are in `ring.pyx`, but not every ring might inherit from this. I suggest to move them to the category. In effect, all `R in _Fields` checks can be replaced by a quicker `R.is_field()` check since the existence of this method is guaranteed. This also avoids cluttering the memory with ´_Fields = Fields()` which is used very often in Sage code.

I'll open another ticket for this soon.


---

Comment by git created at 2021-04-24 09:32:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-04-24 09:33:22

Is that explaination enough or do you prefer more? Moreover, I put a reference to this ticket if someone is interested in more details.


---

Comment by @mjungmath created at 2021-04-24 09:39:28

Replying to [comment:13 gh-mjungmath]:
> As for `free_module.py` I have a different idea. At the current stage, all generic ring methods such as `is_field` are in `ring.pyx`, but not every ring might inherit from this. I suggest to move them to the category. In effect, all `R in _Fields` checks can be replaced by a quicker `R.is_field()` check since the existence of this method is guaranteed. This also avoids cluttering the memory with ´_Fields = Fields()` which is used very often in Sage code.
> 
> I'll open another ticket for this soon.

See #31722.


---

Comment by git created at 2021-04-24 11:28:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2021-04-24 22:25:48

I don't really like that explanation, as well as the text preceding the `ZZ` example. I would do something like this:

```
        This is a power method that directly calls another attribute
        ``_pow_`` (single underscore). This is because extension classes 
        cannot inherit ``__pow__`` from the the parent methods of the
        category and the redirection via ``__getattr__`` is not called
        from Python when performing ``**``. Subsequently, ``__pow__``
        cannot be inherited from the category but ``_pow_`` can.
        See :trac:`31721`.
```


```
        TESTS:

        We check that this works for extension classes::

            sage: ZZ^3
            Ambient free module of rank 3 over the principal ideal domain
             Integer Ring
            sage: isinstance(ZZ, Rings.ParentMethods)  # it is an extension class
            False
```



---

Comment by git created at 2021-04-25 09:15:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-04-25 09:15:19

Thank you Travis! Here we go.
----
New commits:


---

Comment by git created at 2021-04-25 10:55:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-04-25 10:56:37

Sorry, wrong ticket number...


---

Comment by git created at 2021-04-25 11:00:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-04-25 15:44:13

Why `if isinstance(self, Parent)` is inside the `try/except` block?


---

Comment by vdelecroix created at 2021-04-25 15:55:26

Wouldn't it be possible to call `__pow__` from the category by providing the following default implementation in `Parent`

```
def __pow__(self, x, mod):
    return self.getattr_from_category('__pow__')(x, mod)
```



---

Comment by vdelecroix created at 2021-04-25 17:20:03

Concrete implementation with `__pow__` in `public/31721_double_underscore` (a bit more subtle than [comment:28]).


---

Comment by vdelecroix created at 2021-04-25 17:33:31

Changing status from needs_review to needs_info.


---

Comment by git created at 2021-04-25 18:26:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @mjungmath created at 2021-04-25 18:26:57

Sorry, the changes of `is_field` are not supposed to be there. That was for #31722. I accidentally merged them.
----
New commits:


---

Comment by tscrim created at 2021-04-25 23:50:08

We could use `getattr_from_category`, although I think that is slower than calling `_pow_` (but I haven't tested it). Now, it is quite likely that this doesn't need to be so optimized (unlike perhaps `__mul__`). It definitely would make the code more natural. So that would be a better IMO.


---

Comment by vdelecroix created at 2021-04-27 07:42:19

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2021-04-27 07:42:19

Please have a look
----
New commits:


---

Comment by @mjungmath created at 2021-04-27 08:53:42

What exactly is the purpose of that line?


```diff
        try:
+            meth = super(Parent, (<Parent> self)).__pow__
        except AttributeError:
```



---

Comment by vdelecroix created at 2021-04-27 08:59:57

In the case the parent is a Python class, you get the `__pow__` from the category this way.

```
sage: class MyParent(Parent):
....:     def __init__(self):
....:         Parent.__init__(self, category=CommutativeRings())
sage: M = MyParent()
sage: super(Parent, M).__pow__
<bound method Rings.ParentMethods.__pow__ of <__main__.MyParent_with_category object at 0x7f1930f0e4f0>>
```



---

Comment by vdelecroix created at 2021-04-27 09:00:28

Let me add a comment in the code.


---

Comment by git created at 2021-04-27 09:03:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mjungmath created at 2021-04-27 09:11:41

But


```diff
+                meth = (<Parent> self).getattr_from_category('__pow__')
```


works in any case, no? Is 


```diff
+            meth = super(Parent, (<Parent> self)).__pow__
```


somewhat faster in the Python case?


---

Comment by vdelecroix created at 2021-04-27 10:46:09

For the following reason (I am adding a doctest)

```
sage: class A:
....:    def __pow__(self, n):
....:        return 'Apow'
sage: class MyParent(A, Parent):
....:    pass
sage: MyParent()^2
'Apow'
```



---

Comment by git created at 2021-04-27 10:50:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-04-27 10:51:36

When the parent is a Python class and the category does not define a `__pow__` then we catch two `AttributeError` in `Parent.__pow__`.


---

Comment by @mjungmath created at 2021-04-27 11:01:06

Oh right, multiple inheritances. I just lost that out of sight. Perfect, thanks!


---

Comment by @mjungmath created at 2021-04-27 11:06:32

I agree, this looks more natural. Travis, any comments? Otherwise I would give it a positive review when patchbot is giving us his blessing.

What about `__mul__` by the way? Shouldn't that be changed accordingly? Not in this ticket of course, but perhaps in a follow-up?


---

Comment by vdelecroix created at 2021-04-27 20:02:50

After this ticket, all rings have `__pow__`, but the construction is broken

```
sage: ZZ.cartesian_product(ZZ)^3
Traceback (most recent call last):
...
AttributeError: 'CartesianProduct_with_category' object has no attribute 'is_field'
```

This will hopefully be fixed after #31722.


---

Comment by vdelecroix created at 2021-04-27 20:03:16

Concerning `__mul__`, I don't have any opinion.


---

Comment by @mjungmath created at 2021-04-28 00:14:55

Replying to [comment:45 vdelecroix]:
> After this ticket, all rings have `__pow__`, but the construction is broken
> {{{
> sage: ZZ.cartesian_product(ZZ)^3
> Traceback (most recent call last):
> ...
> AttributeError: 'CartesianProduct_with_category' object has no attribute 'is_field'
> }}}
> This will hopefully be fixed after #31722.

Yeah, this is really annoying. Happens all over the place in Sage.

----

As for the ticket, LGTM.


---

Comment by @mjungmath created at 2021-04-28 00:14:55

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2021-04-28 02:39:48

I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.

I also wonder if this would be better put in `CategoryObject` instead of `Parent`. However, that might cause slowdowns with elements, thus we'd need to be a lot more careful with testing. This at least is a clear improvement. Hence, that can be done on a followup and considered at the same time as `__mul__`, which might have other considerations as well.


---

Comment by vdelecroix created at 2021-04-28 06:24:54

Replying to [comment:48 tscrim]:
> I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.

Definitely true.

> I also wonder if this would be better put in `CategoryObject` instead of `Parent`. However, that might cause slowdowns with elements, thus we'd need to be a lot more careful with testing. This at least is a clear improvement. Hence, that can be done on a followup and considered at the same time as `__mul__`, which might have other considerations as well.

That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.


---

Comment by @mjungmath created at 2021-04-28 07:10:42

Replying to [comment:49 vdelecroix]:
> That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.

That's indeed something for another ticket. Who opens it?

Replying to [comment:48 tscrim]:
>I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.

For example? It's already more than in my first draft.


---

Comment by vdelecroix created at 2021-04-28 07:26:52

Replying to [comment:50 gh-mjungmath]:
> Replying to [comment:49 vdelecroix]:
> > That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.
> 
> That's indeed something for another ticket. Who opens it?

#31746

> Replying to [comment:48 tscrim]:
> >I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.
> 
> For example? It's already more than in my first draft.

I added that as a task for #31746 too.


---

Comment by tscrim created at 2021-04-29 05:28:48

Replying to [comment:50 gh-mjungmath]:
> Replying to [comment:48 tscrim]:
> >I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.
> 
> For example? It's already more than in my first draft.

That doesn't necessarily mean it is sufficient. Perhaps something like:

```
Redirect ``__pow__`` either from the MRO or from the category. This
implementation is so extension classes will call the method from
the appropriate category.
```

That way it at least gives some reason for why this implementation exists.


---

Comment by git created at 2021-04-29 07:08:40

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-04-29 07:08:40

Changing status from positive_review to needs_review.


---

Comment by tscrim created at 2021-04-30 00:43:02

Thank you.


---

Comment by tscrim created at 2021-04-30 00:43:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-06-19 20:58:06

Resolution: fixed
