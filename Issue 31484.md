# Issue 31484: Endow parents with __pow__

archive/issues_031484.json:
```json
{
    "body": "CC:  @tscrim @mkoeppe @slel\n\nWe equip `structure/parent.pyx` with a method `__pow__` which delegates to a concrete implementation `_pow_`, for example in the corresponding category.\n\nMoreover, we move the `__pow__` in `rings/ring.pyx` to the category file `categories/rings.py` so that any ring can benefit from it and not only those which inherit from `rings/ring.pyx`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31721\n\n",
    "created_at": "2021-04-23T17:31:13Z",
    "labels": [
        "component: categories"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Endow parents with __pow__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31484",
    "user": "https://github.com/mjungmath"
}
```
CC:  @tscrim @mkoeppe @slel

We equip `structure/parent.pyx` with a method `__pow__` which delegates to a concrete implementation `_pow_`, for example in the corresponding category.

Moreover, we move the `__pow__` in `rings/ring.pyx` to the category file `categories/rings.py` so that any ring can benefit from it and not only those which inherit from `rings/ring.pyx`.

Issue created by migration from https://trac.sagemath.org/ticket/31721





---

archive/issue_comments_449721.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-23T17:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449721",
    "user": "https://github.com/mjungmath"
}
```

New commits:



---

archive/issue_comments_449722.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-23T17:40:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449722",
    "user": "https://github.com/mjungmath"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_449723.json:
```json
{
    "body": "Waiting for patchbot, but unless patchbot does not object, this is ready for review.",
    "created_at": "2021-04-23T17:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449723",
    "user": "https://github.com/mjungmath"
}
```

Waiting for patchbot, but unless patchbot does not object, this is ready for review.



---

archive/issue_comments_449724.json:
```json
{
    "body": "Is it not possible to define `__pow__` directly in the category? Why do we need an indirection via `_pow_`? For elements, it is perfectly understandable since things might have to go through coercion when parents mismatch. But here, what is the point?",
    "created_at": "2021-04-23T18:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449724",
    "user": "https://github.com/videlec"
}
```

Is it not possible to define `__pow__` directly in the category? Why do we need an indirection via `_pow_`? For elements, it is perfectly understandable since things might have to go through coercion when parents mismatch. But here, what is the point?



---

archive/issue_comments_449725.json:
```json
{
    "body": "Replying to [comment:4 vdelecroix]:\n> Is it not possible to define `__pow__` directly in the category? Why do we need an indirection via `_pow_`? For elements, it is perfectly understandable since things might have to go through coercion when parents mismatch. But here, what is the point?\n\nI just mimicked the behavior of `__mul__` for parents. But perhaps you're right and this is not necessary here because no preprocessing is needed.\n\nTravis, do you know more?",
    "created_at": "2021-04-23T19:02:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449725",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:4 vdelecroix]:
> Is it not possible to define `__pow__` directly in the category? Why do we need an indirection via `_pow_`? For elements, it is perfectly understandable since things might have to go through coercion when parents mismatch. But here, what is the point?

I just mimicked the behavior of `__mul__` for parents. But perhaps you're right and this is not necessary here because no preprocessing is needed.

Travis, do you know more?



---

archive/issue_comments_449726.json:
```json
{
    "body": "Okay, it turns out that this indeed doesn't work. I have renamed `_pow_` to `__pow__` in `rings.py` and removed the changes in `parent.pyx` and now get the following error:\n\n\n```\nsage: ZZ**2                                                                     \n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-5-98b583f923b1> in <module>\n----> 1 ZZ**Integer(2)\n\n~/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15218)()\n   2206             return coercion_model.bin_op(left, right, operator.pow)\n   2207         # left is a non-Element: do the powering with a Python int\n-> 2208         return left ** int(right)\n   2209 \n   2210     cpdef _pow_(self, other):\n\nTypeError: unsupported operand type(s) for ** or pow(): 'sage.rings.integer_ring.IntegerRing_class' and 'int'\n```\n\n\nwhile this works\n\n\n```\nsage: ZZ.__pow__(2)                                                             \nAmbient free module of rank 2 over the principal ideal domain Integer Ring\n```\n\n\nApparently the coercion framework tries to play man in the middle.",
    "created_at": "2021-04-23T19:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449726",
    "user": "https://github.com/mjungmath"
}
```

Okay, it turns out that this indeed doesn't work. I have renamed `_pow_` to `__pow__` in `rings.py` and removed the changes in `parent.pyx` and now get the following error:


```
sage: ZZ**2                                                                     
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-5-98b583f923b1> in <module>
----> 1 ZZ**Integer(2)

~/Projekte/sage-devel/local/lib/python3.8/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__pow__ (build/cythonized/sage/rings/integer.c:15218)()
   2206             return coercion_model.bin_op(left, right, operator.pow)
   2207         # left is a non-Element: do the powering with a Python int
-> 2208         return left ** int(right)
   2209 
   2210     cpdef _pow_(self, other):

TypeError: unsupported operand type(s) for ** or pow(): 'sage.rings.integer_ring.IntegerRing_class' and 'int'
```


while this works


```
sage: ZZ.__pow__(2)                                                             
Ambient free module of rank 2 over the principal ideal domain Integer Ring
```


Apparently the coercion framework tries to play man in the middle.



---

archive/issue_comments_449727.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-23T21:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449727",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449728.json:
```json
{
    "body": "The coercion framework works on `Element`s and finds common `Parent`s. Outright, it doesn't get involved. Instead, this is something Python does with trying by swapping the order of the two inputs.\n\nI strongly dislike the `__pow__` implemented in the parent. It will override anything that can be done in a category. Category stuff is called lower in the MRO than an any concrete class. So it restricts any future parent implementation for no reason.\n\nThat being said, `Parent`s should *not* be implementing a `_pow_` because there is no reason to standardize input to the same object. It doesn't make sense.\n\nI don't think the `_pow_int` in the `Fields` category is ever called. So it is good to remove it.\n\nSame comment as in the other ticket about nailing categories into memory should be avoided and the changes to `free_module.py`.",
    "created_at": "2021-04-24T05:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449728",
    "user": "https://github.com/tscrim"
}
```

The coercion framework works on `Element`s and finds common `Parent`s. Outright, it doesn't get involved. Instead, this is something Python does with trying by swapping the order of the two inputs.

I strongly dislike the `__pow__` implemented in the parent. It will override anything that can be done in a category. Category stuff is called lower in the MRO than an any concrete class. So it restricts any future parent implementation for no reason.

That being said, `Parent`s should *not* be implementing a `_pow_` because there is no reason to standardize input to the same object. It doesn't make sense.

I don't think the `_pow_int` in the `Fields` category is ever called. So it is good to remove it.

Same comment as in the other ticket about nailing categories into memory should be avoided and the changes to `free_module.py`.



---

archive/issue_comments_449729.json:
```json
{
    "body": "But then I am clueless. If `__pow__` for `parent.pyx` is not desirable and `__pow__` for `rings.py` causes the above error, how do we proceed?",
    "created_at": "2021-04-24T07:05:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449729",
    "user": "https://github.com/mjungmath"
}
```

But then I am clueless. If `__pow__` for `parent.pyx` is not desirable and `__pow__` for `rings.py` causes the above error, how do we proceed?



---

archive/issue_comments_449730.json:
```json
{
    "body": "There is basically one very technical issue preventing this from working. Compare `ZZ` with `QQ`. For `QQ` to work, you need to first specify that the `mod` parameter is `None`. Then it works. What is different for `ZZ`? It is a parent that is an extension class (i.e., is a `cdef` class). You can see a big difference between the two when you look at the MRO's.\n\nNow, how does an extension class emulate being in a category, it uses `__getattr__`. However, methods like `__pow__` are special in Python and don't necessarily follow the usual rules. This also applies to infix binary operators like `**`. Here, I believe what is happening is it first sees explicitly (without a call to `__getattr__`) that `ZZ` does not have a `__pow__` method, so it then calls `Integer.__pow__(ZZ, n)`, leading to the error.\n\nYou seemed surprised that `ZZ.__pow__(2)` still works, but that involves a call to the `__getattr__`. Things are functioning normally there.\n\nHere is perhaps the interesting thing. What you implemented actually works and might be the best solution because it gets around this issue by letting Python know that every `Parent` has a `__pow__` method and to call that (first). So we have to emulate the `Parent.__mul__` implementation (which is a slightly different issue dealing with inheritance, but likely suffers from the same complications). I also strongly dislike the workaround there too. So I cannot object to this.",
    "created_at": "2021-04-24T08:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449730",
    "user": "https://github.com/tscrim"
}
```

There is basically one very technical issue preventing this from working. Compare `ZZ` with `QQ`. For `QQ` to work, you need to first specify that the `mod` parameter is `None`. Then it works. What is different for `ZZ`? It is a parent that is an extension class (i.e., is a `cdef` class). You can see a big difference between the two when you look at the MRO's.

Now, how does an extension class emulate being in a category, it uses `__getattr__`. However, methods like `__pow__` are special in Python and don't necessarily follow the usual rules. This also applies to infix binary operators like `**`. Here, I believe what is happening is it first sees explicitly (without a call to `__getattr__`) that `ZZ` does not have a `__pow__` method, so it then calls `Integer.__pow__(ZZ, n)`, leading to the error.

You seemed surprised that `ZZ.__pow__(2)` still works, but that involves a call to the `__getattr__`. Things are functioning normally there.

Here is perhaps the interesting thing. What you implemented actually works and might be the best solution because it gets around this issue by letting Python know that every `Parent` has a `__pow__` method and to call that (first). So we have to emulate the `Parent.__mul__` implementation (which is a slightly different issue dealing with inheritance, but likely suffers from the same complications). I also strongly dislike the workaround there too. So I cannot object to this.



---

archive/issue_comments_449731.json:
```json
{
    "body": "That is subtle. Thank you for investigating this!\n\nSo, should I just repair the doctests and that's it?",
    "created_at": "2021-04-24T08:53:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449731",
    "user": "https://github.com/mjungmath"
}
```

That is subtle. Thank you for investigating this!

So, should I just repair the doctests and that's it?



---

archive/issue_comments_449732.json:
```json
{
    "body": "Up to the stuff in `free_module.py`, almost. I would include `ZZ^3` as an example somewhere too, along with some (short) explanation about why we do this.",
    "created_at": "2021-04-24T09:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449732",
    "user": "https://github.com/tscrim"
}
```

Up to the stuff in `free_module.py`, almost. I would include `ZZ^3` as an example somewhere too, along with some (short) explanation about why we do this.



---

archive/issue_comments_449733.json:
```json
{
    "body": "As for `free_module.py` I have a different idea. At the current stage, all generic ring methods such as `is_field` are in `ring.pyx`, but not every ring might inherit from this. I suggest to move them to the category. In effect, all `R in _Fields` checks can be replaced by a quicker `R.is_field()` check since the existence of this method is guaranteed. This also avoids cluttering the memory with \u00b4_Fields = Fields()` which is used very often in Sage code.\n\nI'll open another ticket for this soon.",
    "created_at": "2021-04-24T09:17:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449733",
    "user": "https://github.com/mjungmath"
}
```

As for `free_module.py` I have a different idea. At the current stage, all generic ring methods such as `is_field` are in `ring.pyx`, but not every ring might inherit from this. I suggest to move them to the category. In effect, all `R in _Fields` checks can be replaced by a quicker `R.is_field()` check since the existence of this method is guaranteed. This also avoids cluttering the memory with ´_Fields = Fields()` which is used very often in Sage code.

I'll open another ticket for this soon.



---

archive/issue_comments_449734.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T09:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449734",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449735.json:
```json
{
    "body": "Is that explaination enough or do you prefer more? Moreover, I put a reference to this ticket if someone is interested in more details.",
    "created_at": "2021-04-24T09:33:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449735",
    "user": "https://github.com/mjungmath"
}
```

Is that explaination enough or do you prefer more? Moreover, I put a reference to this ticket if someone is interested in more details.



---

archive/issue_comments_449736.json:
```json
{
    "body": "Replying to [comment:13 gh-mjungmath]:\n> As for `free_module.py` I have a different idea. At the current stage, all generic ring methods such as `is_field` are in `ring.pyx`, but not every ring might inherit from this. I suggest to move them to the category. In effect, all `R in _Fields` checks can be replaced by a quicker `R.is_field()` check since the existence of this method is guaranteed. This also avoids cluttering the memory with \u00b4_Fields = Fields()` which is used very often in Sage code.\n> \n> I'll open another ticket for this soon.\n\nSee #31722.",
    "created_at": "2021-04-24T09:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449736",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:13 gh-mjungmath]:
> As for `free_module.py` I have a different idea. At the current stage, all generic ring methods such as `is_field` are in `ring.pyx`, but not every ring might inherit from this. I suggest to move them to the category. In effect, all `R in _Fields` checks can be replaced by a quicker `R.is_field()` check since the existence of this method is guaranteed. This also avoids cluttering the memory with ´_Fields = Fields()` which is used very often in Sage code.
> 
> I'll open another ticket for this soon.

See #31722.



---

archive/issue_comments_449737.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T11:28:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449737",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449738.json:
```json
{
    "body": "I don't really like that explanation, as well as the text preceding the `ZZ` example. I would do something like this:\n\n```\n        This is a power method that directly calls another attribute\n        ``_pow_`` (single underscore). This is because extension classes \n        cannot inherit ``__pow__`` from the the parent methods of the\n        category and the redirection via ``__getattr__`` is not called\n        from Python when performing ``**``. Subsequently, ``__pow__``\n        cannot be inherited from the category but ``_pow_`` can.\n        See :trac:`31721`.\n```\n\n\n```\n        TESTS:\n\n        We check that this works for extension classes::\n\n            sage: ZZ^3\n            Ambient free module of rank 3 over the principal ideal domain\n             Integer Ring\n            sage: isinstance(ZZ, Rings.ParentMethods)  # it is an extension class\n            False\n```\n",
    "created_at": "2021-04-24T22:25:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449738",
    "user": "https://github.com/tscrim"
}
```

I don't really like that explanation, as well as the text preceding the `ZZ` example. I would do something like this:

```
        This is a power method that directly calls another attribute
        ``_pow_`` (single underscore). This is because extension classes 
        cannot inherit ``__pow__`` from the the parent methods of the
        category and the redirection via ``__getattr__`` is not called
        from Python when performing ``**``. Subsequently, ``__pow__``
        cannot be inherited from the category but ``_pow_`` can.
        See :trac:`31721`.
```


```
        TESTS:

        We check that this works for extension classes::

            sage: ZZ^3
            Ambient free module of rank 3 over the principal ideal domain
             Integer Ring
            sage: isinstance(ZZ, Rings.ParentMethods)  # it is an extension class
            False
```




---

archive/issue_comments_449739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T09:15:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449739",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449740.json:
```json
{
    "body": "Thank you Travis! Here we go.\n----\nNew commits:",
    "created_at": "2021-04-25T09:15:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449740",
    "user": "https://github.com/mjungmath"
}
```

Thank you Travis! Here we go.
----
New commits:



---

archive/issue_comments_449741.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-25T10:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449741",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_449742.json:
```json
{
    "body": "Sorry, wrong ticket number...",
    "created_at": "2021-04-25T10:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449742",
    "user": "https://github.com/mjungmath"
}
```

Sorry, wrong ticket number...



---

archive/issue_comments_449743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T11:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449744.json:
```json
{
    "body": "Why `if isinstance(self, Parent)` is inside the `try/except` block?",
    "created_at": "2021-04-25T15:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449744",
    "user": "https://github.com/videlec"
}
```

Why `if isinstance(self, Parent)` is inside the `try/except` block?



---

archive/issue_comments_449745.json:
```json
{
    "body": "Wouldn't it be possible to call `__pow__` from the category by providing the following default implementation in `Parent`\n\n```\ndef __pow__(self, x, mod):\n    return self.getattr_from_category('__pow__')(x, mod)\n```\n",
    "created_at": "2021-04-25T15:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449745",
    "user": "https://github.com/videlec"
}
```

Wouldn't it be possible to call `__pow__` from the category by providing the following default implementation in `Parent`

```
def __pow__(self, x, mod):
    return self.getattr_from_category('__pow__')(x, mod)
```




---

archive/issue_comments_449746.json:
```json
{
    "body": "Concrete implementation with `__pow__` in `public/31721_double_underscore` (a bit more subtle than [comment:28]).",
    "created_at": "2021-04-25T17:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449746",
    "user": "https://github.com/videlec"
}
```

Concrete implementation with `__pow__` in `public/31721_double_underscore` (a bit more subtle than [comment:28]).



---

archive/issue_comments_449747.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2021-04-25T17:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449747",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_449748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-25T18:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449748",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_449749.json:
```json
{
    "body": "Sorry, the changes of `is_field` are not supposed to be there. That was for #31722. I accidentally merged them.\n----\nNew commits:",
    "created_at": "2021-04-25T18:26:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449749",
    "user": "https://github.com/mjungmath"
}
```

Sorry, the changes of `is_field` are not supposed to be there. That was for #31722. I accidentally merged them.
----
New commits:



---

archive/issue_comments_449750.json:
```json
{
    "body": "We could use `getattr_from_category`, although I think that is slower than calling `_pow_` (but I haven't tested it). Now, it is quite likely that this doesn't need to be so optimized (unlike perhaps `__mul__`). It definitely would make the code more natural. So that would be a better IMO.",
    "created_at": "2021-04-25T23:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449750",
    "user": "https://github.com/tscrim"
}
```

We could use `getattr_from_category`, although I think that is slower than calling `_pow_` (but I haven't tested it). Now, it is quite likely that this doesn't need to be so optimized (unlike perhaps `__mul__`). It definitely would make the code more natural. So that would be a better IMO.



---

archive/issue_comments_449751.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2021-04-27T07:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449751",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_449752.json:
```json
{
    "body": "Please have a look\n----\nNew commits:",
    "created_at": "2021-04-27T07:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449752",
    "user": "https://github.com/videlec"
}
```

Please have a look
----
New commits:



---

archive/issue_comments_449753.json:
```json
{
    "body": "What exactly is the purpose of that line?\n\n\n```diff\n        try:\n+            meth = super(Parent, (<Parent> self)).__pow__\n        except AttributeError:\n```\n",
    "created_at": "2021-04-27T08:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449753",
    "user": "https://github.com/mjungmath"
}
```

What exactly is the purpose of that line?


```diff
        try:
+            meth = super(Parent, (<Parent> self)).__pow__
        except AttributeError:
```




---

archive/issue_comments_449754.json:
```json
{
    "body": "In the case the parent is a Python class, you get the `__pow__` from the category this way.\n\n```\nsage: class MyParent(Parent):\n....:     def __init__(self):\n....:         Parent.__init__(self, category=CommutativeRings())\nsage: M = MyParent()\nsage: super(Parent, M).__pow__\n<bound method Rings.ParentMethods.__pow__ of <__main__.MyParent_with_category object at 0x7f1930f0e4f0>>\n```\n",
    "created_at": "2021-04-27T08:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449754",
    "user": "https://github.com/videlec"
}
```

In the case the parent is a Python class, you get the `__pow__` from the category this way.

```
sage: class MyParent(Parent):
....:     def __init__(self):
....:         Parent.__init__(self, category=CommutativeRings())
sage: M = MyParent()
sage: super(Parent, M).__pow__
<bound method Rings.ParentMethods.__pow__ of <__main__.MyParent_with_category object at 0x7f1930f0e4f0>>
```




---

archive/issue_comments_449755.json:
```json
{
    "body": "Let me add a comment in the code.",
    "created_at": "2021-04-27T09:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449755",
    "user": "https://github.com/videlec"
}
```

Let me add a comment in the code.



---

archive/issue_comments_449756.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-27T09:03:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449756",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449757.json:
```json
{
    "body": "But\n\n\n```diff\n+                meth = (<Parent> self).getattr_from_category('__pow__')\n```\n\n\nworks in any case, no? Is \n\n\n```diff\n+            meth = super(Parent, (<Parent> self)).__pow__\n```\n\n\nsomewhat faster in the Python case?",
    "created_at": "2021-04-27T09:11:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449757",
    "user": "https://github.com/mjungmath"
}
```

But


```diff
+                meth = (<Parent> self).getattr_from_category('__pow__')
```


works in any case, no? Is 


```diff
+            meth = super(Parent, (<Parent> self)).__pow__
```


somewhat faster in the Python case?



---

archive/issue_comments_449758.json:
```json
{
    "body": "For the following reason (I am adding a doctest)\n\n```\nsage: class A:\n....:    def __pow__(self, n):\n....:        return 'Apow'\nsage: class MyParent(A, Parent):\n....:    pass\nsage: MyParent()^2\n'Apow'\n```\n",
    "created_at": "2021-04-27T10:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449758",
    "user": "https://github.com/videlec"
}
```

For the following reason (I am adding a doctest)

```
sage: class A:
....:    def __pow__(self, n):
....:        return 'Apow'
sage: class MyParent(A, Parent):
....:    pass
sage: MyParent()^2
'Apow'
```




---

archive/issue_comments_449759.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-27T10:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_449760.json:
```json
{
    "body": "When the parent is a Python class and the category does not define a `__pow__` then we catch two `AttributeError` in `Parent.__pow__`.",
    "created_at": "2021-04-27T10:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449760",
    "user": "https://github.com/videlec"
}
```

When the parent is a Python class and the category does not define a `__pow__` then we catch two `AttributeError` in `Parent.__pow__`.



---

archive/issue_comments_449761.json:
```json
{
    "body": "Oh right, multiple inheritances. I just lost that out of sight. Perfect, thanks!",
    "created_at": "2021-04-27T11:01:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449761",
    "user": "https://github.com/mjungmath"
}
```

Oh right, multiple inheritances. I just lost that out of sight. Perfect, thanks!



---

archive/issue_comments_449762.json:
```json
{
    "body": "I agree, this looks more natural. Travis, any comments? Otherwise I would give it a positive review when patchbot is giving us his blessing.\n\nWhat about `__mul__` by the way? Shouldn't that be changed accordingly? Not in this ticket of course, but perhaps in a follow-up?",
    "created_at": "2021-04-27T11:06:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449762",
    "user": "https://github.com/mjungmath"
}
```

I agree, this looks more natural. Travis, any comments? Otherwise I would give it a positive review when patchbot is giving us his blessing.

What about `__mul__` by the way? Shouldn't that be changed accordingly? Not in this ticket of course, but perhaps in a follow-up?



---

archive/issue_comments_449763.json:
```json
{
    "body": "After this ticket, all rings have `__pow__`, but the construction is broken\n\n```\nsage: ZZ.cartesian_product(ZZ)^3\nTraceback (most recent call last):\n...\nAttributeError: 'CartesianProduct_with_category' object has no attribute 'is_field'\n```\n\nThis will hopefully be fixed after #31722.",
    "created_at": "2021-04-27T20:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449763",
    "user": "https://github.com/videlec"
}
```

After this ticket, all rings have `__pow__`, but the construction is broken

```
sage: ZZ.cartesian_product(ZZ)^3
Traceback (most recent call last):
...
AttributeError: 'CartesianProduct_with_category' object has no attribute 'is_field'
```

This will hopefully be fixed after #31722.



---

archive/issue_comments_449764.json:
```json
{
    "body": "Concerning `__mul__`, I don't have any opinion.",
    "created_at": "2021-04-27T20:03:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449764",
    "user": "https://github.com/videlec"
}
```

Concerning `__mul__`, I don't have any opinion.



---

archive/issue_comments_449765.json:
```json
{
    "body": "Replying to [comment:45 vdelecroix]:\n> After this ticket, all rings have `__pow__`, but the construction is broken\n> {{{\n> sage: ZZ.cartesian_product(ZZ)^3\n> Traceback (most recent call last):\n> ...\n> AttributeError: 'CartesianProduct_with_category' object has no attribute 'is_field'\n> }}}\n> This will hopefully be fixed after #31722.\n\nYeah, this is really annoying. Happens all over the place in Sage.\n\n----\n\nAs for the ticket, LGTM.",
    "created_at": "2021-04-28T00:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449765",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:45 vdelecroix]:
> After this ticket, all rings have `__pow__`, but the construction is broken
> {{{
> sage: ZZ.cartesian_product(ZZ)^3
> Traceback (most recent call last):
> ...
> AttributeError: 'CartesianProduct_with_category' object has no attribute 'is_field'
> }}}
> This will hopefully be fixed after #31722.

Yeah, this is really annoying. Happens all over the place in Sage.

----

As for the ticket, LGTM.



---

archive/issue_comments_449766.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-28T00:14:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449766",
    "user": "https://github.com/mjungmath"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_449767.json:
```json
{
    "body": "I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.\n\nI also wonder if this would be better put in `CategoryObject` instead of `Parent`. However, that might cause slowdowns with elements, thus we'd need to be a lot more careful with testing. This at least is a clear improvement. Hence, that can be done on a followup and considered at the same time as `__mul__`, which might have other considerations as well.",
    "created_at": "2021-04-28T02:39:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449767",
    "user": "https://github.com/tscrim"
}
```

I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.

I also wonder if this would be better put in `CategoryObject` instead of `Parent`. However, that might cause slowdowns with elements, thus we'd need to be a lot more careful with testing. This at least is a clear improvement. Hence, that can be done on a followup and considered at the same time as `__mul__`, which might have other considerations as well.



---

archive/issue_comments_449768.json:
```json
{
    "body": "Replying to [comment:48 tscrim]:\n> I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.\n\nDefinitely true.\n\n> I also wonder if this would be better put in `CategoryObject` instead of `Parent`. However, that might cause slowdowns with elements, thus we'd need to be a lot more careful with testing. This at least is a clear improvement. Hence, that can be done on a followup and considered at the same time as `__mul__`, which might have other considerations as well.\n\nThat is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.",
    "created_at": "2021-04-28T06:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449768",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:48 tscrim]:
> I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.

Definitely true.

> I also wonder if this would be better put in `CategoryObject` instead of `Parent`. However, that might cause slowdowns with elements, thus we'd need to be a lot more careful with testing. This at least is a clear improvement. Hence, that can be done on a followup and considered at the same time as `__mul__`, which might have other considerations as well.

That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.



---

archive/issue_comments_449769.json:
```json
{
    "body": "Replying to [comment:49 vdelecroix]:\n> That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.\n\nThat's indeed something for another ticket. Who opens it?\n\nReplying to [comment:48 tscrim]:\n>I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.\n\nFor example? It's already more than in my first draft.",
    "created_at": "2021-04-28T07:10:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449769",
    "user": "https://github.com/mjungmath"
}
```

Replying to [comment:49 vdelecroix]:
> That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.

That's indeed something for another ticket. Who opens it?

Replying to [comment:48 tscrim]:
>I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.

For example? It's already more than in my first draft.



---

archive/issue_comments_449770.json:
```json
{
    "body": "Replying to [comment:50 gh-mjungmath]:\n> Replying to [comment:49 vdelecroix]:\n> > That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.\n> \n> That's indeed something for another ticket. Who opens it?\n\n#31746\n\n> Replying to [comment:48 tscrim]:\n> >I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.\n> \n> For example? It's already more than in my first draft.\n\nI added that as a task for #31746 too.",
    "created_at": "2021-04-28T07:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449770",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:50 gh-mjungmath]:
> Replying to [comment:49 vdelecroix]:
> > That is a good suggestion. Since `Element` has its own `__pow__` I don't think there would be any slowdown.
> 
> That's indeed something for another ticket. Who opens it?

#31746

> Replying to [comment:48 tscrim]:
> >I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.
> 
> For example? It's already more than in my first draft.

I added that as a task for #31746 too.



---

archive/issue_comments_449771.json:
```json
{
    "body": "Replying to [comment:50 gh-mjungmath]:\n> Replying to [comment:48 tscrim]:\n> >I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.\n> \n> For example? It's already more than in my first draft.\n\nThat doesn't necessarily mean it is sufficient. Perhaps something like:\n\n```\nRedirect ``__pow__`` either from the MRO or from the category. This\nimplementation is so extension classes will call the method from\nthe appropriate category.\n```\n\nThat way it at least gives some reason for why this implementation exists.",
    "created_at": "2021-04-29T05:28:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449771",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:50 gh-mjungmath]:
> Replying to [comment:48 tscrim]:
> >I would had preferred the `Parent.__pow__` method to have a little bit more in its docstring about what it does since its implementation is a little terse IMO, even with the comments.
> 
> For example? It's already more than in my first draft.

That doesn't necessarily mean it is sufficient. Perhaps something like:

```
Redirect ``__pow__`` either from the MRO or from the category. This
implementation is so extension classes will call the method from
the appropriate category.
```

That way it at least gives some reason for why this implementation exists.



---

archive/issue_comments_449772.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-04-29T07:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449772",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_449773.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-04-29T07:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449773",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_449774.json:
```json
{
    "body": "Thank you.",
    "created_at": "2021-04-30T00:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449774",
    "user": "https://github.com/tscrim"
}
```

Thank you.



---

archive/issue_comments_449775.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-30T00:43:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449775",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_083632.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-06-19T20:58:06Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31484#event-83632"
}
```



---

archive/issue_comments_449776.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-19T20:58:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31484",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31484#issuecomment-449776",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
