# Issue 23213: Smith form of p-adic matrices

Issue created by migration from https://trac.sagemath.org/ticket/23450

Original creator: caruso

Original creation time: 2017-07-18 04:41:54

CC:  roed saraedum tristanvaccon kedlaya

Keywords: sd87

Currently Smith form are not implemented over inexact rings.

This ticket provides a (currently unoptimized) implementation of Smith normal form over complete discrete valuation rings/fields (e.g. p-adic rings/fields), together with a new implementation of the method `determinant` making use of Smith normal form and improving this way its behaviour regarding precision.


---

Comment by saraedum created at 2017-07-18 06:09:29

This is great. I was hoping that you would implement this for a while ;)

Have you thought about not creating a separate class for this but implementing it in the base ring (or in the category), i.e., provide `_matrix_smith_form` on the ring/category and call it from the generic matrix code if it is defined (otherwise fall back to the generic implementation). In other words, do what is already done for things like polynomial factorization.

Also, should this code be used for "exact" CDVRs such as the ones backed by absolute number fields?
----
New commits:


---

Comment by saraedum created at 2017-07-18 15:11:42

Changing component from PLEASE CHANGE to padics.


---

Comment by git created at 2017-07-19 04:57:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2017-07-19 05:14:17

Changing status from new to needs_review.


---

Comment by caruso created at 2017-07-19 05:14:17

Ok, I've moved the code to the category (CDVF and CDVR) as you suggested.

I've also tried to be more rigourous regarding precision and figured out what is the correct precision on the transformation matrices. (My first implementation was too optimistic.) Actually, it turns out that finding the optimal precision is costly, except in the particular case where the input matrix is given at flat precision (i.e. all the entries are given at the same precision). For this reason, I've overestimated the loss of precision for a general input matrix (by reducing to the case of flat precision).

I've also removed the method that computes the determinant of a matrix because again it only worked for matrices given at flat precision.

The ticket is ready for review.


---

Comment by git created at 2017-07-19 20:41:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 02:03:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 05:39:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2017-07-20 05:41:41

I think (hope) that this ticket is now *really* ready for review :-)


---

Comment by saraedum created at 2017-07-20 06:13:01

I'll try to review this tomorrow.


---

Comment by git created at 2017-07-20 15:30:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-20 16:18:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-21 00:42:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-21 15:55:15

Xavier, I am refactoring this a fair bit. Hope you don't mind.


---

Comment by saraedum created at 2017-07-21 15:55:15

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2017-07-21 16:08:56

(and sorry, the category idea was a very bad call. I'm fixing it right now.)


---

Comment by saraedum created at 2017-07-21 16:44:54

New commits:


---

Comment by saraedum created at 2017-07-21 16:48:06


```
sage -t --warn-long 61.6 src/sage/rings/padics/padic_base_leaves.py  # 3 doctests failed
sage -t --warn-long 61.6 src/sage/rings/padics/padic_extension_leaves.py  # 2 doctests failed
```



---

Comment by git created at 2017-07-21 16:49:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-21 16:54:19

The problem is always:

```
    Failure in _test_matrix_smith:
    Traceback (most recent call last):
      File "/projects/da1818ed-996d-4de6-acc6-361415b7725d/Src/sage-saraedum/local/lib/python2.7/site-packages/sage/misc/sage_unittest.py", line 293, in run
        test_method(tester = tester)
      File "/projects/da1818ed-996d-4de6-acc6-361415b7725d/Src/sage-saraedum/local/lib/python2.7/site-packages/sage/rings/padics/local_generic.py", line 768, in _test_matrix_smith
        S,U,V = M.smith_form()
      File "sage/matrix/matrix2.pyx", line 13267, in sage.matrix.matrix2.Matrix.smith_form (/projects/da1818ed-996d-4de6-acc6-361415b7725d/Src/sage-saraedum/src/build/cythonized/sage/matrix/matrix2.c:94870)
        return R._matrix_smith_form(self,transformation=transformation)
      File "/projects/da1818ed-996d-4de6-acc6-361415b7725d/Src/sage-saraedum/local/lib/python2.7/site-packages/sage/rings/padics/local_generic.py", line 727, in _matrix_smith_form
        inv = (S[piv,piv] >> val).inverse_of_unit()
      File "sage/rings/padics/local_generic_element.pyx", line 160, in sage.rings.padics.local_generic_element.LocalGenericElement.inverse_of_unit (build/cythonized/sage/rings/padics/local_generic_element.c:2339)
        raise ZeroDivisionError("Inverse does not exist.")
    ZeroDivisionError: Inverse does not exist.
```



---

Comment by saraedum created at 2017-07-21 20:45:18

Xavier: I am a bit confused. Is `integral_smith_form` the same as `change_ring(integer_ring).smith_form`?


---

Comment by caruso created at 2017-07-21 20:47:31

If the coefficients of the matrix lie in the integer ring, it is. But `integral_smith_form` is defined for any matrix defined over the fraction field.


---

Comment by git created at 2017-07-21 20:51:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-21 21:04:24

Ok. I got confused by the comment:

```
- if `d_i` denotes the `(i,i)` entry of `S`, then `d_i`
divides `d_{i+1}` in the ring of integers for all `i`.
```

----
New commits:


---

Comment by git created at 2017-07-21 21:24:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-21 22:06:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-21 22:20:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2017-07-21 22:27:59

Xavier: That's about what I had in mind. What do you think? (There are still some failing tests.)


---

Comment by saraedum created at 2017-07-21 22:27:59

Changing status from needs_work to needs_review.


---

Comment by caruso created at 2017-07-21 22:56:51

Ok for factoring the code this way if you prefer.

However, I think that the current code doesn't output the expected answer for matrices over Qp with `integral=None` (though I haven't checked it). In that case, I would say that the entries of Smith normal norm should all be 0 or 1.

In the doctest, I think that we should precise that we require (1) that the matrices U and V are invertible over the subring and (2) that d_{i+1}/d_i lies in the subring for all i.


---

Comment by saraedum created at 2017-07-22 15:25:03

Xavier: Could you write something about what it means for an entry on the diagonal to be zero (in the field case)? I mean it is somewhat unclear since we compute with inexact elements.


---

Comment by chapoton created at 2017-08-25 06:58:20

doc does not build

```
+[dochtml] [matrices ] docstring of sage.matrix.matrix2.Matrix.smith_form:26: WARNING: Bullet list ends without a blank line; unexpected unindent.
+[dochtml] [matrices ] docstring of sage.matrix.matrix2.Matrix.smith_form:29: WARNING: Bullet list ends without a blank line; unexpected unindent.
```

The issue is in the INPUT field there.


---

Comment by aly.deines created at 2017-08-25 17:33:05

New commits:


---

Comment by aly.deines created at 2017-08-25 17:33:05

Changing status from needs_review to needs_work.


---

Comment by aly.deines created at 2017-08-25 17:33:19

Changed to needs work because of above issues.


---

Comment by sbrandhorst created at 2017-10-27 10:11:45

*ping* - I could really use this p-adic smith form. (over `ZZp`)
Need help? (not an expert though)


---

Comment by chapoton created at 2017-12-05 14:30:03

New commits:


---

Comment by chapoton created at 2017-12-05 14:30:03

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-12-05 14:30:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-12-08 12:43:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-26 14:36:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-26 15:07:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-26 15:09:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-26 17:29:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-28 13:36:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2018-02-28 13:38:46

Changing status from needs_work to needs_review.


---

Comment by roed created at 2018-02-28 13:38:46

If Xavier is happy with my changes, I'm happy to give this positive review.


---

Comment by git created at 2018-02-28 15:44:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-02-28 16:14:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-02-28 16:17:04

I've fixed a small issue with precision.

Now, everything seems fine to me. I let you give a positive review if you're OK (and if the patchbot is happy)


---

Comment by roed created at 2018-02-28 19:43:05

Changing status from needs_review to positive_review.


---

Comment by roed created at 2018-02-28 19:43:05

Patchbot is green, so positive review.


---

Comment by vbraun created at 2018-03-20 23:22:17

Tests fail

```
    UnboundLocalError: local variable 'precM' referenced before assignment
```



---

Comment by vbraun created at 2018-03-20 23:22:17

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2018-03-21 00:49:17

Let me add a bit of details, 6 doctests fails

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/rings/padics/padic_lattice_element.py  # 4 doctests failed
sage -t --long /usr/lib64/python2.7/site-packages/sage/rings/padics/padic_base_leaves.py  # 2 doctests failed
```

 and they all fail the same way

```
File "/usr/lib64/python2.7/site-packages/sage/rings/padics/padic_base_leaves.py", line 879, in sage.rings.padics.padic_base_leaves.pAdicRingLattice.__init__
Failed example:
    TestSuite(R).run(skip='_test_teichmuller')
Expected nothing
Got:
    Failure in _test_matrix_smith:
    Traceback (most recent call last):
      File "/usr/lib64/python2.7/site-packages/sage/misc/sage_unittest.py", line 294, in run
        test_method(tester = tester)
      File "/usr/lib64/python2.7/site-packages/sage/rings/padics/local_generic.py", line 1248, in _test_matrix_smith
        S,U,V = M.smith_form(integral=base)
      File "sage/matrix/matrix2.pyx", line 13416, in sage.matrix.matrix2.Matrix.smith_form (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/matrix/matrix2.c:96167)
        return R._matrix_smith_form(self, transformation=transformation, integral=integral, exact=exact)
      File "/usr/lib64/python2.7/site-packages/sage/rings/padics/local_generic.py", line 1148, in _matrix_smith_form
        if inexact_ring and not allzero and val >= precM:
    UnboundLocalError: local variable 'precM' referenced before assignment
    ------------------------------------------------------------
    The following tests failed: _test_matrix_smith
```

ending in `local_generic.py`.


---

Comment by git created at 2018-03-22 22:09:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by caruso created at 2018-03-22 22:11:02

Should be fixed.


---

Comment by caruso created at 2018-03-22 22:11:02

Changing status from needs_work to needs_review.


---

Comment by roed created at 2018-03-29 20:04:54

The patchbots continue to be noisy, but this looks good to me.


---

Comment by roed created at 2018-03-29 20:04:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-08 17:27:14

Resolution: fixed
