# Issue 27024: Fix a memory leak in libsingular polynomial arithmetic

archive/issues_027024.json:
```json
{
    "body": "CC:  nbruin malb\n\nKeywords: libsingular polynomial memleak\n\nThe following leaks (I tested in Py3, but in Py2 it's the same):\n\n```\nsage: R.<X,Y> = ZZ[]\nsage: P = (X+Y)^120*Y^100\nsage: import gc\nsage: mem0 = get_memory_usage()\nsage: for i in range(1000):\n....:     Q = P(X,Y)\n....:     del Q\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1>mem0:\n....:         print(i, mem1-mem0)\n....:         mem0 = mem1\n....:         \n0 0.25\n98 0.12890625\n128 0.12890625\n157 0.12890625\n187 0.12890625\n216 0.12890625\n246 0.12890625\n275 0.12890625\n305 0.12890625\n329 2.0\n331 0.12890625\n360 0.12890625\n390 0.12890625\n420 0.1328125\n450 0.12890625\n479 0.12890625\n509 0.12890625\n539 0.1328125\n569 0.12890625\n599 0.1328125\n629 0.12890625\n659 0.1328125\n673 2.0\n689 0.12890625\n718 0.12890625\n748 0.12890625\n778 0.1328125\n808 0.12890625\n822 0.1953125\n866 0.12890625\n896 0.12890625\n925 0.12890625\n955 0.12890625\n984 0.12890625\n```\n\n\nWith #13447 in Py2, the leak is reduced, but still present:\n\n```\nsage: mem0 = get_memory_usage()\nsage: for i in range(1000):\n....:     Q = P(X,Y)\n....:     del Q\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1>mem0:\n....:         print(i, mem1-mem0)\n....:         mem0 = mem1\n....:         \n(147, 0.03125)\n(176, 0.12890625)\n(206, 0.12890625)\n(235, 0.12890625)\n(265, 0.12890625)\n(294, 0.12890625)\n(324, 0.12890625)\n(329, 2.0)\n(350, 0.12890625)\n(379, 0.12890625)\n(409, 0.12890625)\n(438, 0.12890625)\n(468, 0.12890625)\n(497, 0.12890625)\n(527, 0.12890625)\n(556, 0.12890625)\n(586, 0.12890625)\n(615, 0.12890625)\n(645, 0.12890625)\n(672, 0.1328125)\n(673, 2.0)\n(705, 0.12890625)\n(734, 0.12890625)\n(764, 0.12890625)\n(793, 0.12890625)\n(823, 0.12890625)\n(852, 0.12890625)\n(882, 0.12890625)\n(911, 0.12890625)\n(941, 0.12890625)\n(970, 0.12890625)\n```\n\n\nThere is a worse leak (even with #13447):\n\n```\nsage: for i in range(1000):\n....:     Q = P(X+Y,Y)\n....:     del Q\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1>mem0:\n....:         print(i, mem1-mem0)\n....:         mem0 = mem1\n....:         \n(0, 0.546875)\n(2, 0.12890625)\n(3, 0.2578125)\n(4, 0.12890625)\n(5, 0.2578125)\n(6, 2.2578125)\n(7, 0.12890625)\n(8, 0.2578125)\n(9, 0.2578125)\n(10, 0.2578125)\n(11, 0.12890625)\n(12, 0.2578125)\n(13, 2.265625)\n(14, 0.12890625)\n(15, 0.2578125)\n(16, 0.2578125)\n(17, 0.12890625)\n(18, 0.2578125)\n(19, 0.2578125)\n(20, 0.12890625)\n(21, 2.265625)\n(22, 0.2578125)\n(23, 0.12890625)\n(24, 0.2578125)\n(25, 0.2578125)\n```\n\n\nThis was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw)\n\nIssue created by migration from https://trac.sagemath.org/ticket/27261\n\n",
    "created_at": "2019-02-12T14:48:34Z",
    "labels": [
        "memleak",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Fix a memory leak in libsingular polynomial arithmetic",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27024",
    "user": "SimonKing"
}
```
CC:  nbruin malb

Keywords: libsingular polynomial memleak

The following leaks (I tested in Py3, but in Py2 it's the same):

```
sage: R.<X,Y> = ZZ[]
sage: P = (X+Y)^120*Y^100
sage: import gc
sage: mem0 = get_memory_usage()
sage: for i in range(1000):
....:     Q = P(X,Y)
....:     del Q
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1>mem0:
....:         print(i, mem1-mem0)
....:         mem0 = mem1
....:         
0 0.25
98 0.12890625
128 0.12890625
157 0.12890625
187 0.12890625
216 0.12890625
246 0.12890625
275 0.12890625
305 0.12890625
329 2.0
331 0.12890625
360 0.12890625
390 0.12890625
420 0.1328125
450 0.12890625
479 0.12890625
509 0.12890625
539 0.1328125
569 0.12890625
599 0.1328125
629 0.12890625
659 0.1328125
673 2.0
689 0.12890625
718 0.12890625
748 0.12890625
778 0.1328125
808 0.12890625
822 0.1953125
866 0.12890625
896 0.12890625
925 0.12890625
955 0.12890625
984 0.12890625
```


With #13447 in Py2, the leak is reduced, but still present:

```
sage: mem0 = get_memory_usage()
sage: for i in range(1000):
....:     Q = P(X,Y)
....:     del Q
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1>mem0:
....:         print(i, mem1-mem0)
....:         mem0 = mem1
....:         
(147, 0.03125)
(176, 0.12890625)
(206, 0.12890625)
(235, 0.12890625)
(265, 0.12890625)
(294, 0.12890625)
(324, 0.12890625)
(329, 2.0)
(350, 0.12890625)
(379, 0.12890625)
(409, 0.12890625)
(438, 0.12890625)
(468, 0.12890625)
(497, 0.12890625)
(527, 0.12890625)
(556, 0.12890625)
(586, 0.12890625)
(615, 0.12890625)
(645, 0.12890625)
(672, 0.1328125)
(673, 2.0)
(705, 0.12890625)
(734, 0.12890625)
(764, 0.12890625)
(793, 0.12890625)
(823, 0.12890625)
(852, 0.12890625)
(882, 0.12890625)
(911, 0.12890625)
(941, 0.12890625)
(970, 0.12890625)
```


There is a worse leak (even with #13447):

```
sage: for i in range(1000):
....:     Q = P(X+Y,Y)
....:     del Q
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1>mem0:
....:         print(i, mem1-mem0)
....:         mem0 = mem1
....:         
(0, 0.546875)
(2, 0.12890625)
(3, 0.2578125)
(4, 0.12890625)
(5, 0.2578125)
(6, 2.2578125)
(7, 0.12890625)
(8, 0.2578125)
(9, 0.2578125)
(10, 0.2578125)
(11, 0.12890625)
(12, 0.2578125)
(13, 2.265625)
(14, 0.12890625)
(15, 0.2578125)
(16, 0.2578125)
(17, 0.12890625)
(18, 0.2578125)
(19, 0.2578125)
(20, 0.12890625)
(21, 2.265625)
(22, 0.2578125)
(23, 0.12890625)
(24, 0.2578125)
(25, 0.2578125)
```


This was reported [on sage-devel](https://groups.google.com/forum/#!topic/sage-devel/iO1SzoW0kcw)

Issue created by migration from https://trac.sagemath.org/ticket/27261





---

archive/issue_comments_380471.json:
```json
{
    "body": "For testing, I changed the code so that the `id()` of any newly created `MPolynomial_libsingular` instance is stored in some set, and is removed from the set as soon as it becomes garbage collected.\n\nResult: In the above examples, the `MPolynomial_libsingular` instances are correctly garbage collected.\n\nConclusion: The memleak occurs in Sage's usage of libsingular. Apparently the underlying data of a polynomial are not correctly freed when it is deallocated.",
    "created_at": "2019-02-12T16:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380471",
    "user": "SimonKing"
}
```

For testing, I changed the code so that the `id()` of any newly created `MPolynomial_libsingular` instance is stored in some set, and is removed from the set as soon as it becomes garbage collected.

Result: In the above examples, the `MPolynomial_libsingular` instances are correctly garbage collected.

Conclusion: The memleak occurs in Sage's usage of libsingular. Apparently the underlying data of a polynomial are not correctly freed when it is deallocated.



---

archive/issue_comments_380472.json:
```json
{
    "body": "Or, another possibility: Some temporary libsingular data created during the computation of Q is not freed.\n\nTo detect this, I will try to make the example more fine-grained: Test if the leak occurs if the only arithmetic operation involved is `_add_`, `_mul_` or `__pow__`, respectively. `(X+Y)<sup>120*Y</sup>100` mixes these three operations.",
    "created_at": "2019-02-12T16:34:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380472",
    "user": "SimonKing"
}
```

Or, another possibility: Some temporary libsingular data created during the computation of Q is not freed.

To detect this, I will try to make the example more fine-grained: Test if the leak occurs if the only arithmetic operation involved is `_add_`, `_mul_` or `__pow__`, respectively. `(X+Y)<sup>120*Y</sup>100` mixes these three operations.



---

archive/issue_comments_380473.json:
```json
{
    "body": "Interestingly, creating a copy of P from scratch does *not* leak:\n\n```\nsage: import gc\nsage: R.<X,Y> = ZZ[]\nsage: P = (X+Y)^120*Y^100\nsage: mem0 = get_memory_usage()\nsage: for i in range(500):\n....:     Q = (X+Y)^120*Y^100\n....:     del Q\n....:     _ = gc.collect()\n....:     mem1 = get_memory_usage()\n....:     if mem1>mem0:\n....:         print(i, mem1-mem0)\n....:         mem0 = mem1\n....:         \n(0, 0.1484375)\nsage: \n```\n\nSo, it seems that calling the polynomial (i.e., `P(X,Y)`) is what is leaking!",
    "created_at": "2019-02-12T16:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380473",
    "user": "SimonKing"
}
```

Interestingly, creating a copy of P from scratch does *not* leak:

```
sage: import gc
sage: R.<X,Y> = ZZ[]
sage: P = (X+Y)^120*Y^100
sage: mem0 = get_memory_usage()
sage: for i in range(500):
....:     Q = (X+Y)^120*Y^100
....:     del Q
....:     _ = gc.collect()
....:     mem1 = get_memory_usage()
....:     if mem1>mem0:
....:         print(i, mem1-mem0)
....:         mem0 = mem1
....:         
(0, 0.1484375)
sage: 
```

So, it seems that calling the polynomial (i.e., `P(X,Y)`) is what is leaking!



---

archive/issue_comments_380474.json:
```json
{
    "body": "Note that there previously was a leak in polynomial evaluation, as by comment in `sage.libs.singular.polynomial.singular_polynomial_call` - see #16958. So, perhaps it didn't get completely fixed?",
    "created_at": "2019-02-12T16:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380474",
    "user": "SimonKing"
}
```

Note that there previously was a leak in polynomial evaluation, as by comment in `sage.libs.singular.polynomial.singular_polynomial_call` - see #16958. So, perhaps it didn't get completely fixed?



---

archive/issue_comments_380475.json:
```json
{
    "body": "`singular_polynomial_call` copies the input data before doing the actual call. This, I think, is a waste of time. I tested that taking the copy is *not* causing the leak, but while we are at it, it could as well be improved, too.",
    "created_at": "2019-02-12T17:07:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380475",
    "user": "SimonKing"
}
```

`singular_polynomial_call` copies the input data before doing the actual call. This, I think, is a waste of time. I tested that taking the copy is *not* causing the leak, but while we are at it, it could as well be improved, too.



---

archive/issue_comments_380476.json:
```json
{
    "body": "Also, `singular_polynomial_call` has an argument `poly *(*get_element)(object)` that is (at least in the Sage library) always assigned with the function `MPolynomial_libsingular_get_element`, which does nothing more than return the `._poly` of an `MPolynomial_libsingular`.\n\nSo, basically the `get_element` argument is void. Should it be removed?",
    "created_at": "2019-02-12T17:16:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380476",
    "user": "SimonKing"
}
```

Also, `singular_polynomial_call` has an argument `poly *(*get_element)(object)` that is (at least in the Sage library) always assigned with the function `MPolynomial_libsingular_get_element`, which does nothing more than return the `._poly` of an `MPolynomial_libsingular`.

So, basically the `get_element` argument is void. Should it be removed?



---

archive/issue_comments_380477.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380477",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_380478.json:
```json
{
    "body": "As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).",
    "created_at": "2019-06-14T14:54:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380478",
    "user": "embray"
}
```

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).



---

archive/issue_comments_380479.json:
```json
{
    "body": "Stumble upon a similar problem using `.subs()`\n\n```\nsage: R.<X,Y> = ZZ[] \n....: import gc \n....: mem0 = get_memory_usage() \n....: for i in range(1000): \n....:     for _ in range(100): \n....:         _ = (X + Y).subs(X=X, Y=Y) \n....:     _ = gc.collect() \n....:     mem1 = get_memory_usage() \n....:     if mem1>mem0: \n....:         print(i, mem1-mem0) \n....:         mem0 = mem1                                                                                                                                                                      \n78 0.1328125\n100 0.1328125\n121 0.12890625\n142 0.12890625\n164 0.1328125\n172 2.0\n185 0.12890625\n206 0.12890625\n228 0.1328125\n...\n```\n\nSee also https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/",
    "created_at": "2021-05-06T17:19:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380479",
    "user": "vdelecroix"
}
```

Stumble upon a similar problem using `.subs()`

```
sage: R.<X,Y> = ZZ[] 
....: import gc 
....: mem0 = get_memory_usage() 
....: for i in range(1000): 
....:     for _ in range(100): 
....:         _ = (X + Y).subs(X=X, Y=Y) 
....:     _ = gc.collect() 
....:     mem1 = get_memory_usage() 
....:     if mem1>mem0: 
....:         print(i, mem1-mem0) 
....:         mem0 = mem1                                                                                                                                                                      
78 0.1328125
100 0.1328125
121 0.12890625
142 0.12890625
164 0.1328125
172 2.0
185 0.12890625
206 0.12890625
228 0.1328125
...
```

See also https://ask.sagemath.org/question/29444/high-memory-usage-when-substituting-variables/



---

archive/issue_comments_380480.json:
```json
{
    "body": "Since `__call__` calls `subs()` I gues the latter is the culprit.",
    "created_at": "2021-05-06T17:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380480",
    "user": "vdelecroix"
}
```

Since `__call__` calls `subs()` I gues the latter is the culprit.



---

archive/issue_comments_380481.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-05-07T08:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380481",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_380482.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-05-07T08:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380482",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_380483.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-05-07T08:05:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380483",
    "user": "vdelecroix"
}
```

Changing priority from major to critical.



---

archive/issue_comments_380484.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-07T08:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380484",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380485.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-05-07T08:27:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380485",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_380486.json:
```json
{
    "body": "Does `gc.collect()` trigger Singular's GC - does it even have such an option?\nIt does its own memory management.",
    "created_at": "2021-05-07T08:37:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380486",
    "user": "dimpase"
}
```

Does `gc.collect()` trigger Singular's GC - does it even have such an option?
It does its own memory management.



---

archive/issue_comments_380487.json:
```json
{
    "body": "Replying to [comment:16 dimpase]:\n> Does `gc.collect()` trigger Singular's GC - does it even have such an option?\n> It does its own memory management.\n\nWhat does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with\n\n```\nsage: R = PolynomialRing(ZZ, 'x', 50)\nsage: d = {str(g): g for g in R.gens()}\nsage: p = sum(d.values())\nsage: while True:\n....:     _ = p.subs(**d)\n```\n",
    "created_at": "2021-05-07T08:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380487",
    "user": "vdelecroix"
}
```

Replying to [comment:16 dimpase]:
> Does `gc.collect()` trigger Singular's GC - does it even have such an option?
> It does its own memory management.

What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with

```
sage: R = PolynomialRing(ZZ, 'x', 50)
sage: d = {str(g): g for g in R.gens()}
sage: p = sum(d.values())
sage: while True:
....:     _ = p.subs(**d)
```




---

archive/issue_comments_380488.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-05-07T12:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380488",
    "user": "dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_380489.json:
```json
{
    "body": "The following 1-line patch fixes the leak from comment:10 and the 1st leak reported on the ticket.\n\n\n```diff\n--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n@@ -3620,9 +3620,8 @@ cdef class MPolynomial_libsingular(MPolynomial):\n                 res_id = fast_map_common_subexp(from_id, _ring, to_id, _ring)\n                 _p = res_id.m[0]\n \n-                from_id.m[0] = NULL\n+                p_Delete(&from_id.m[0], _ring)\n                 res_id.m[0] = NULL\n-\n                 id_Delete(&from_id, _ring)\n                 id_Delete(&res_id, _ring)\n }}}\n\nit does not fix the 2nd leak on the ticket, but I guess it might be that one needs to clean more of these `from_id` parts...",
    "created_at": "2021-05-07T12:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380489",
    "user": "dimpase"
}
```

The following 1-line patch fixes the leak from comment:10 and the 1st leak reported on the ticket.


```diff
--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
@@ -3620,9 +3620,8 @@ cdef class MPolynomial_libsingular(MPolynomial):
                 res_id = fast_map_common_subexp(from_id, _ring, to_id, _ring)
                 _p = res_id.m[0]
 
-                from_id.m[0] = NULL
+                p_Delete(&from_id.m[0], _ring)
                 res_id.m[0] = NULL
-
                 id_Delete(&from_id, _ring)
                 id_Delete(&res_id, _ring)
 }}}

it does not fix the 2nd leak on the ticket, but I guess it might be that one needs to clean more of these `from_id` parts...



---

archive/issue_comments_380490.json:
```json
{
    "body": "It'd be good to have more eyes on this, `subs()` code, preferably of people who wrote chunks of it.",
    "created_at": "2021-05-07T12:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380490",
    "user": "dimpase"
}
```

It'd be good to have more eyes on this, `subs()` code, preferably of people who wrote chunks of it.



---

archive/issue_comments_380491.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-05-07T12:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380491",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_380492.json:
```json
{
    "body": "thx for your input!",
    "created_at": "2021-05-07T12:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380492",
    "user": "vdelecroix"
}
```

thx for your input!



---

archive/issue_comments_380493.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-05-07T12:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380493",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_380494.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> Replying to [comment:16 dimpase]:\n> > Does `gc.collect()` trigger Singular's GC - does it even have such an option?\n> > It does its own memory management.\n> \n> What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with\n> {{{\n> sage: R = PolynomialRing(ZZ, 'x', 50)\n> sage: d = {str(g): g for g in R.gens()}\n> sage: p = sum(d.values())\n> sage: while True:\n> ....:     _ = p.subs(**d)\n> }}}\n\nwith the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.",
    "created_at": "2021-05-07T12:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380494",
    "user": "dimpase"
}
```

Replying to [comment:17 vdelecroix]:
> Replying to [comment:16 dimpase]:
> > Does `gc.collect()` trigger Singular's GC - does it even have such an option?
> > It does its own memory management.
> 
> What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with
> {{{
> sage: R = PolynomialRing(ZZ, 'x', 50)
> sage: d = {str(g): g for g in R.gens()}
> sage: p = sum(d.values())
> sage: while True:
> ....:     _ = p.subs(**d)
> }}}

with the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.



---

archive/issue_comments_380495.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-07T12:55:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380495",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380496.json:
```json
{
    "body": "Replying to [comment:22 dimpase]:\n> Replying to [comment:17 vdelecroix]:\n> > Replying to [comment:16 dimpase]:\n> > > Does `gc.collect()` trigger Singular's GC - does it even have such an option?\n> > > It does its own memory management.\n> > \n> > What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with\n> > {{{\n> > sage: R = PolynomialRing(ZZ, 'x', 50)\n> > sage: d = {str(g): g for g in R.gens()}\n> > sage: p = sum(d.values())\n> > sage: while True:\n> > ....:     _ = p.subs(**d)\n> > }}}\n> \n> with the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.\n\nVery good. This is implemented in commit 19881aa.",
    "created_at": "2021-05-07T12:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380496",
    "user": "vdelecroix"
}
```

Replying to [comment:22 dimpase]:
> Replying to [comment:17 vdelecroix]:
> > Replying to [comment:16 dimpase]:
> > > Does `gc.collect()` trigger Singular's GC - does it even have such an option?
> > > It does its own memory management.
> > 
> > What does this have to do with the problem? The `gc.collect()` can be removed from the snippets. They are here to guarantee that there is no undeleted temporary Python objects lying around and get consistent tests. You can crash sage with
> > {{{
> > sage: R = PolynomialRing(ZZ, 'x', 50)
> > sage: d = {str(g): g for g in R.gens()}
> > sage: p = sum(d.values())
> > sage: while True:
> > ....:     _ = p.subs(**d)
> > }}}
> 
> with the patch I just proposed this can be run seemingly forever, without showing any memory increase after few minutes of CPU time.

Very good. This is implemented in commit 19881aa.



---

archive/issue_comments_380497.json:
```json
{
    "body": "seems to be a similar bug, from_id, to_id stuff  in `singular_polynomial_call`.\nHere is how to trigger it there, (needs `--long`) \n\n```diff\n--- a/src/sage/libs/singular/polynomial.pyx\n+++ b/src/sage/libs/singular/polynomial.pyx\n@@ -167,12 +167,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n         sage: import gc\n         sage: F.<a> = GF(7^2)\n         sage: R.<x,y> = F[]\n-        sage: p = x+2*y\n+        sage: p = (x+2*y)^3\n         sage: def leak(N):\n         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     gc.collect()\n         ....:     for i in range(N):\n-        ....:         _ = p(a, a)\n+        ....:         _ = p(a+x, a)\n         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes\n```\n\n\ngives\n\n```\nFile \"src/sage/libs/singular/polynomial.pyx\", line 187, in sage.libs.singular.polynomial.singular_polynomial_call\nFailed example:\n    for i in range(30):  # long time\n        n = leak(10000)\n        print(\"Leaked {} bytes\".format(n))\n        if n == 0:\n            zeros += 1\n            if zeros >= 6:\n                break\n        else:\n            zeros = 0\nExpected:\n    Leaked...\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\nGot:\n    Leaked 6180864 bytes\n    Leaked 3956736 bytes\n    Leaked 3923968 bytes\n    Leaked 3923968 bytes\n...\n```\n",
    "created_at": "2021-05-07T13:35:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380497",
    "user": "dimpase"
}
```

seems to be a similar bug, from_id, to_id stuff  in `singular_polynomial_call`.
Here is how to trigger it there, (needs `--long`) 

```diff
--- a/src/sage/libs/singular/polynomial.pyx
+++ b/src/sage/libs/singular/polynomial.pyx
@@ -167,12 +167,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
         sage: import gc
         sage: F.<a> = GF(7^2)
         sage: R.<x,y> = F[]
-        sage: p = x+2*y
+        sage: p = (x+2*y)^3
         sage: def leak(N):
         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     gc.collect()
         ....:     for i in range(N):
-        ....:         _ = p(a, a)
+        ....:         _ = p(a+x, a)
         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes
```


gives

```
File "src/sage/libs/singular/polynomial.pyx", line 187, in sage.libs.singular.polynomial.singular_polynomial_call
Failed example:
    for i in range(30):  # long time
        n = leak(10000)
        print("Leaked {} bytes".format(n))
        if n == 0:
            zeros += 1
            if zeros >= 6:
                break
        else:
            zeros = 0
Expected:
    Leaked...
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 0 bytes
Got:
    Leaked 6180864 bytes
    Leaked 3956736 bytes
    Leaked 3923968 bytes
    Leaked 3923968 bytes
...
```




---

archive/issue_comments_380498.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-07T13:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380498",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380499.json:
```json
{
    "body": "True. I moved my test over ZZ in the same file.",
    "created_at": "2021-05-07T13:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380499",
    "user": "vdelecroix"
}
```

True. I moved my test over ZZ in the same file.



---

archive/issue_comments_380500.json:
```json
{
    "body": "unfortunately I don't know how to fix the leak in `singular_polynomial_call()`. Trying to do something similar leads tp segfaults.",
    "created_at": "2021-05-07T15:55:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380500",
    "user": "dimpase"
}
```

unfortunately I don't know how to fix the leak in `singular_polynomial_call()`. Trying to do something similar leads tp segfaults.



---

archive/issue_comments_380501.json:
```json
{
    "body": "Thanks for trying. I update the description. Should we agree on the current status? Should we make it for sage-9.3?",
    "created_at": "2021-05-07T16:42:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380501",
    "user": "vdelecroix"
}
```

Thanks for trying. I update the description. Should we agree on the current status? Should we make it for sage-9.3?



---

archive/issue_comments_380502.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-07T16:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380502",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380503.json:
```json
{
    "body": "I believe this indicates that the problem is upstream, in `fast_map_common_subexp`. I have replaced the function by one that does nothing but return a copy of the original polynomial.\n\n\n```diff\n--- a/src/sage/libs/singular/polynomial.pyx\n+++ b/src/sage/libs/singular/polynomial.pyx\n@@ -173,8 +173,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n         ....:     for i in range(N):\n         ....:         _ = p(x, y)\n         ....:         _ = p(x + y, y)\n-        ....:         _ = p(1, -1)\n-        ....:         _ = p(0, 0)\n         ....:     gc.collect()\n         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes\n@@ -185,7 +183,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n         ....:     gc.collect()\n         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss\n         ....:     for i in range(N):\n-        ....:         _ = p(a, a)\n         ....:         _ = p(x, y)\n         ....:         _ = p(x + y, y)\n         ....:         _ = p(a + x, a)\n@@ -228,7 +225,7 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n     from_id.m[0] = p\n\n     rChangeCurrRing(r)\n-    cdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)\n+    cdef ideal *res_id = dummy_map_common_subexp(from_id, r, to_id)\n     ret[0] = res_id.m[0]\n\n     # Unsure why we have to normalize here. See #16958\n@@ -243,6 +240,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly\n\n     return 0\n\n+# can fail if the result is expected to be constant\n+cdef ideal *dummy_map_common_subexp(ideal *from_id, ring *r, ideal *to_id):\n+    cdef ideal *res_id = idInit(1, 1)\n+    res_id.m[0] = p_Copy(from_id.m[0], r)\n+    return res_id\n+\n cdef int singular_polynomial_cmp(poly *p, poly *q, ring *r):\n     \"\"\"\n     Compare two Singular elements ``p`` and ``q`` in ``r``.\n```\n\n\n\n```\nGot:\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n    Leaked 0 and 0 bytes\n```\n",
    "created_at": "2021-05-08T12:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380503",
    "user": "@mwageringel"
}
```

I believe this indicates that the problem is upstream, in `fast_map_common_subexp`. I have replaced the function by one that does nothing but return a copy of the original polynomial.


```diff
--- a/src/sage/libs/singular/polynomial.pyx
+++ b/src/sage/libs/singular/polynomial.pyx
@@ -173,8 +173,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
         ....:     for i in range(N):
         ....:         _ = p(x, y)
         ....:         _ = p(x + y, y)
-        ....:         _ = p(1, -1)
-        ....:         _ = p(0, 0)
         ....:     gc.collect()
         ....:     after = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     return (after - before) * 1024   # ru_maxrss is in kilobytes
@@ -185,7 +183,6 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
         ....:     gc.collect()
         ....:     before = resource.getrusage(resource.RUSAGE_SELF).ru_maxrss
         ....:     for i in range(N):
-        ....:         _ = p(a, a)
         ....:         _ = p(x, y)
         ....:         _ = p(x + y, y)
         ....:         _ = p(a + x, a)
@@ -228,7 +225,7 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly
     from_id.m[0] = p

     rChangeCurrRing(r)
-    cdef ideal *res_id = fast_map_common_subexp(from_id, r, to_id, r)
+    cdef ideal *res_id = dummy_map_common_subexp(from_id, r, to_id)
     ret[0] = res_id.m[0]

     # Unsure why we have to normalize here. See #16958
@@ -243,6 +240,12 @@ cdef int singular_polynomial_call(poly **ret, poly *p, ring *r, list args, poly

     return 0

+# can fail if the result is expected to be constant
+cdef ideal *dummy_map_common_subexp(ideal *from_id, ring *r, ideal *to_id):
+    cdef ideal *res_id = idInit(1, 1)
+    res_id.m[0] = p_Copy(from_id.m[0], r)
+    return res_id
+
 cdef int singular_polynomial_cmp(poly *p, poly *q, ring *r):
     """
     Compare two Singular elements ``p`` and ``q`` in ``r``.
```



```
Got:
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
    Leaked 0 and 0 bytes
```




---

archive/issue_comments_380504.json:
```json
{
    "body": "How does one convince the upstream? \nWould writing a C++ program using libsingular suffice?\nOr a Singular example would be required?\nIt could be that Singular does not use this function the way it's used here.\nIn fact, in Singular it's only called at one place, once, in in `maMapIdeal()`\nAnd the latter is only called once:\n\n```\n./Singular/ipshell.cc:  v->data=maMapIdeal(IDIDEAL(w), src_ring, (ideal)theMap, currRing,nMap);\n```\n\nin Singular's  shell, so it's probably not too hard to figure out the Singular command calling it.",
    "created_at": "2021-05-08T13:33:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380504",
    "user": "dimpase"
}
```

How does one convince the upstream? 
Would writing a C++ program using libsingular suffice?
Or a Singular example would be required?
It could be that Singular does not use this function the way it's used here.
In fact, in Singular it's only called at one place, once, in in `maMapIdeal()`
And the latter is only called once:

```
./Singular/ipshell.cc:  v->data=maMapIdeal(IDIDEAL(w), src_ring, (ideal)theMap, currRing,nMap);
```

in Singular's  shell, so it's probably not too hard to figure out the Singular command calling it.



---

archive/issue_comments_380505.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-08T15:05:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380505",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380506.json:
```json
{
    "body": "Singular's `subst()` leaks memory very fast, I don't know why we expect anything better from `libsingular`.\nE.g.\n\n```\nring r=0,(x,y),dp;\npoly p=(x+y)^10;\nwhile (1) {\nsubst(p,x,x+y);\n}\n```\n\n\ntakes 30 sec to reach many gigabytes.",
    "created_at": "2021-05-08T22:48:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380506",
    "user": "dimpase"
}
```

Singular's `subst()` leaks memory very fast, I don't know why we expect anything better from `libsingular`.
E.g.

```
ring r=0,(x,y),dp;
poly p=(x+y)^10;
while (1) {
subst(p,x,x+y);
}
```


takes 30 sec to reach many gigabytes.



---

archive/issue_comments_380507.json:
```json
{
    "body": "I opened an issue on the singular side https://github.com/Singular/Singular/issues/1089.",
    "created_at": "2021-05-09T07:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380507",
    "user": "vdelecroix"
}
```

I opened an issue on the singular side https://github.com/Singular/Singular/issues/1089.



---

archive/issue_comments_380508.json:
```json
{
    "body": "Sage allows some weird things\n\n```\nsage: R.<x,y> = ZZ[]\nsage: S.<q> = ZZ[]\nsage: (x+y).subs(x=q)  # expected\nTraceback (most recent call last):\n...\nTypeError: unsupported operand parent(s) for +:\n  'Univariate Polynomial Ring in q over Integer Ring' and\n  'Multivariate Polynomial Ring in x, y over Integer Ring'\nsage: x.subs(x=q)  # why does it work!?\nq\n```\n",
    "created_at": "2021-05-09T08:24:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380508",
    "user": "vdelecroix"
}
```

Sage allows some weird things

```
sage: R.<x,y> = ZZ[]
sage: S.<q> = ZZ[]
sage: (x+y).subs(x=q)  # expected
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for +:
  'Univariate Polynomial Ring in q over Integer Ring' and
  'Multivariate Polynomial Ring in x, y over Integer Ring'
sage: x.subs(x=q)  # why does it work!?
q
```




---

archive/issue_comments_380509.json:
```json
{
    "body": "Replying to [comment:36 vdelecroix]:\n> Sage allows some weird things\n> {{{\n> sage: R.<x,y> = ZZ[]\n> sage: S.<q> = ZZ[]\n> sage: (x+y).subs(x=q)  # expected\n> Traceback (most recent call last):\n> ...\n> TypeError: unsupported operand parent(s) for +:\n>   'Univariate Polynomial Ring in q over Integer Ring' and\n>   'Multivariate Polynomial Ring in x, y over Integer Ring'\n> sage: x.subs(x=q)  # why does it work!?\n> q\n> }}}\n\nand even worse\n\n```\nsage: x(q, y)\nq\n```\n",
    "created_at": "2021-05-09T08:25:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380509",
    "user": "vdelecroix"
}
```

Replying to [comment:36 vdelecroix]:
> Sage allows some weird things
> {{{
> sage: R.<x,y> = ZZ[]
> sage: S.<q> = ZZ[]
> sage: (x+y).subs(x=q)  # expected
> Traceback (most recent call last):
> ...
> TypeError: unsupported operand parent(s) for +:
>   'Univariate Polynomial Ring in q over Integer Ring' and
>   'Multivariate Polynomial Ring in x, y over Integer Ring'
> sage: x.subs(x=q)  # why does it work!?
> q
> }}}

and even worse

```
sage: x(q, y)
q
```




---

archive/issue_comments_380510.json:
```json
{
    "body": "Replying to [comment:37 vdelecroix]:\n> Replying to [comment:36 vdelecroix]:\n> > Sage allows some weird things\n> > {{{\n> > sage: R.<x,y> = ZZ[]\n> > sage: S.<q> = ZZ[]\n> > sage: (x+y).subs(x=q)  # expected\n> > Traceback (most recent call last):\n> > ...\n> > TypeError: unsupported operand parent(s) for +:\n> >   'Univariate Polynomial Ring in q over Integer Ring' and\n> >   'Multivariate Polynomial Ring in x, y over Integer Ring'\n> > sage: x.subs(x=q)  # why does it work!?\n> > q\n> > }}}\n> \n> and even worse\n> {{{\n> sage: x(q, y)\n> q\n> }}}\n\nhttps://groups.google.com/g/sage-devel/c/vGzNJKAQWbs",
    "created_at": "2021-05-09T08:51:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380510",
    "user": "vdelecroix"
}
```

Replying to [comment:37 vdelecroix]:
> Replying to [comment:36 vdelecroix]:
> > Sage allows some weird things
> > {{{
> > sage: R.<x,y> = ZZ[]
> > sage: S.<q> = ZZ[]
> > sage: (x+y).subs(x=q)  # expected
> > Traceback (most recent call last):
> > ...
> > TypeError: unsupported operand parent(s) for +:
> >   'Univariate Polynomial Ring in q over Integer Ring' and
> >   'Multivariate Polynomial Ring in x, y over Integer Ring'
> > sage: x.subs(x=q)  # why does it work!?
> > q
> > }}}
> 
> and even worse
> {{{
> sage: x(q, y)
> q
> }}}

https://groups.google.com/g/sage-devel/c/vGzNJKAQWbs



---

archive/issue_comments_380511.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-05-19T06:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380511",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_380512.json:
```json
{
    "body": "Rebased on 9.3.\n\nI implemented the proposal of Nils Bruin from the sage-devel thread to implement the generic `__call__`. The behaviour is doctested but it would even be better if it was part of the `TestSuite` (see #31668). The doctest fixes from 796e854 (modular forms on Hecke triangle groups) look a bit weird. But at least the output is still correct.",
    "created_at": "2021-05-19T06:33:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380512",
    "user": "vdelecroix"
}
```

Rebased on 9.3.

I implemented the proposal of Nils Bruin from the sage-devel thread to implement the generic `__call__`. The behaviour is doctested but it would even be better if it was part of the `TestSuite` (see #31668). The doctest fixes from 796e854 (modular forms on Hecke triangle groups) look a bit weird. But at least the output is still correct.



---

archive/issue_comments_380513.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-19T08:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380513",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380514.json:
```json
{
    "body": "testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now",
    "created_at": "2021-05-19T13:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380514",
    "user": "dimpase"
}
```

testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now



---

archive/issue_comments_380515.json:
```json
{
    "body": "Replying to [comment:43 dimpase]:\n> testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now\n\nGood idea. Thanks.",
    "created_at": "2021-05-19T13:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380515",
    "user": "vdelecroix"
}
```

Replying to [comment:43 dimpase]:
> testing https://github.com/Singular/Singular/issues/1089#issuecomment-844015795 now

Good idea. Thanks.



---

archive/issue_comments_380516.json:
```json
{
    "body": "Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.",
    "created_at": "2021-05-19T13:54:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380516",
    "user": "dimpase"
}
```

Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.



---

archive/issue_comments_380517.json:
```json
{
    "body": "Replying to [comment:46 dimpase]:\n> Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.\n\nIt would be nice to track the underlying singular issue. However, this should not hold the ticket any longer.",
    "created_at": "2021-05-19T17:06:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380517",
    "user": "vdelecroix"
}
```

Replying to [comment:46 dimpase]:
> Unfortunately, this Singular patch only fixes the reported in https://github.com/Singular/Singular/issues/1089 problem, but not the leaks here.

It would be nice to track the underlying singular issue. However, this should not hold the ticket any longer.



---

archive/issue_comments_380518.json:
```json
{
    "body": "are the leaks in the ticket text now fixed?",
    "created_at": "2021-05-19T21:42:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380518",
    "user": "dimpase"
}
```

are the leaks in the ticket text now fixed?



---

archive/issue_comments_380519.json:
```json
{
    "body": "Replying to [comment:48 dimpase]:\n> are the leaks in the ticket text now fixed?\n\nBoth of them as explained in the ticket description (`subs` thanks to you and `__call__` via naive symbolic evaluation). Also they are both doctested.",
    "created_at": "2021-05-20T06:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380519",
    "user": "vdelecroix"
}
```

Replying to [comment:48 dimpase]:
> are the leaks in the ticket text now fixed?

Both of them as explained in the ticket description (`subs` thanks to you and `__call__` via naive symbolic evaluation). Also they are both doctested.



---

archive/issue_comments_380520.json:
```json
{
    "body": "Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?",
    "created_at": "2021-05-20T09:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380520",
    "user": "dimpase"
}
```

Should we add the patch from  https://github.com/Singular/Singular/issues/1089  here?



---

archive/issue_comments_380521.json:
```json
{
    "body": "Replying to [comment:50 dimpase]:\n> Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?\n\nAccording to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?",
    "created_at": "2021-05-20T11:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380521",
    "user": "vdelecroix"
}
```

Replying to [comment:50 dimpase]:
> Should we add the patch from  https://github.com/Singular/Singular/issues/1089  here?

According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?



---

archive/issue_comments_380522.json:
```json
{
    "body": "Replying to [comment:51 vdelecroix]:\n> Replying to [comment:50 dimpase]:\n> > Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?\n> \n> According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?\n\nisn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?",
    "created_at": "2021-05-20T12:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380522",
    "user": "dimpase"
}
```

Replying to [comment:51 vdelecroix]:
> Replying to [comment:50 dimpase]:
> > Should we add the patch from  https://github.com/Singular/Singular/issues/1089  here?
> 
> According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?

isn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?



---

archive/issue_comments_380523.json:
```json
{
    "body": "Replying to [comment:52 dimpase]:\n> Replying to [comment:51 vdelecroix]:\n> > Replying to [comment:50 dimpase]:\n> > > Should we add the patch from  \u200bhttps://github.com/Singular/Singular/issues/1089  here?\n> > \n> > According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?\n> \n> isn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?\n\nMaybe. I don't quite see the link with this ticket about `subs` and `__call__`. If you think it is worth adding this patch to singular, please open a ticket mentionning which issue it does solve on the sage side and create a branch.",
    "created_at": "2021-05-20T12:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380523",
    "user": "vdelecroix"
}
```

Replying to [comment:52 dimpase]:
> Replying to [comment:51 vdelecroix]:
> > Replying to [comment:50 dimpase]:
> > > Should we add the patch from  https://github.com/Singular/Singular/issues/1089  here?
> > 
> > According to your [comment:46] it does not solve the issue. So I don't see why we should only port this particular bug fix. Furthermore, we do not have any patch to singular in sage. Better keep it that way, no?
> 
> isn't the bug uncovered in https://github.com/Singular/Singular/issues/1089 sitting in Singular code used by Sage, and may re-surface if not patched?

Maybe. I don't quite see the link with this ticket about `subs` and `__call__`. If you think it is worth adding this patch to singular, please open a ticket mentionning which issue it does solve on the sage side and create a branch.



---

archive/issue_comments_380524.json:
```json
{
    "body": "here is another Singular leak demo, not fixed by the patch we discuss:\n\n```\nring r;\nmap F=r,x+y+z3,y+z+x2z3,z+1+xyz;\npoly f=(x+y+z+xz)^10;\nmatrix m=f;\nmatrix mm;\nwhile (1) {mm=F(m);}\n```\n \n\nhere I checked that the code path goes through `fast_map_common_subexp()`, so this is another leak, hopefully just what we are fighting on this ticket.",
    "created_at": "2021-05-20T16:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380524",
    "user": "dimpase"
}
```

here is another Singular leak demo, not fixed by the patch we discuss:

```
ring r;
map F=r,x+y+z3,y+z+x2z3,z+1+xyz;
poly f=(x+y+z+xz)^10;
matrix m=f;
matrix mm;
while (1) {mm=F(m);}
```
 

here I checked that the code path goes through `fast_map_common_subexp()`, so this is another leak, hopefully just what we are fighting on this ticket.



---

archive/issue_comments_380525.json:
```json
{
    "body": "I've opened  https://github.com/Singular/Singular/issues/1090",
    "created_at": "2021-05-20T16:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380525",
    "user": "dimpase"
}
```

I've opened  https://github.com/Singular/Singular/issues/1090



---

archive/issue_comments_380526.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-23T07:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380526",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380527.json:
```json
{
    "body": "Replying to [comment:55 dimpase]:\n> I've opened  https://github.com/Singular/Singular/issues/1090\n\nApparently, partially fixed in [b983a8a](https://github.com/Singular/Singular/commit/b983a8a3c4c9303d054079a944ecab5d165f88d4).",
    "created_at": "2021-05-23T19:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380527",
    "user": "vdelecroix"
}
```

Replying to [comment:55 dimpase]:
> I've opened  https://github.com/Singular/Singular/issues/1090

Apparently, partially fixed in [b983a8a](https://github.com/Singular/Singular/commit/b983a8a3c4c9303d054079a944ecab5d165f88d4).



---

archive/issue_comments_380528.json:
```json
{
    "body": "This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.",
    "created_at": "2021-05-27T18:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380528",
    "user": "@mwageringel"
}
```

This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.



---

archive/issue_comments_380529.json:
```json
{
    "body": "Replying to [comment:59 gh-mwageringel]:\n> This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.\n\nThis ticket is not about performance issue. But as I mentioned in the ask question switching to naive Python evaluation as done in my branch actually speeds up the evaluation.",
    "created_at": "2021-05-27T19:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380529",
    "user": "vdelecroix"
}
```

Replying to [comment:59 gh-mwageringel]:
> This [ask-sage question](https://ask.sagemath.org/question/57281/performance-of-polynomialring-evaluation/) reports that there is also a performance problem with polynomial evaluation. Could this be related to the issue of this ticket? The example from the linked question is about 10 times slower than the naive Python substitution.

This ticket is not about performance issue. But as I mentioned in the ask question switching to naive Python evaluation as done in my branch actually speeds up the evaluation.



---

archive/issue_comments_380530.json:
```json
{
    "body": "ping?",
    "created_at": "2021-05-28T07:33:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380530",
    "user": "vdelecroix"
}
```

ping?



---

archive/issue_comments_380531.json:
```json
{
    "body": "testing...",
    "created_at": "2021-05-28T09:05:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380531",
    "user": "dimpase"
}
```

testing...



---

archive/issue_comments_380532.json:
```json
{
    "body": "lgtm",
    "created_at": "2021-05-28T12:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380532",
    "user": "dimpase"
}
```

lgtm



---

archive/issue_comments_380533.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-05-28T12:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380533",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_380534.json:
```json
{
    "body": "thx",
    "created_at": "2021-05-28T13:41:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380534",
    "user": "vdelecroix"
}
```

thx



---

archive/issue_comments_380535.json:
```json
{
    "body": "one test broken on macOS:\n\n```\nFile \"src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\", line 153, in sage.rings.polynomial.multi_polynomial_libsingular\nFailed example:\n    for i in range(30):\n        n = leak_subs(20)\n        print(\"Leaked {} bytes\".format(n))\n        if n == 0:\n            zeros += 1\n            if zeros >= 6:\n                print(\"done\")\n                break\n        else:\n            zeros = 0\nExpected:\n    Leaked ...\n    ...\n    Leaked 0 bytes\n    done\nGot:\n    Leaked 184549376 bytes\n    Leaked 12582912 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 8388608 bytes\n    Leaked 0 bytes\n    Leaked 37748736 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 37748736 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 37748736 bytes\n    Leaked 4194304 bytes\n    Leaked 0 bytes\n    Leaked 0 bytes\n    Leaked 4194304 bytes\n**********************************************************************\n1 item had failures:\n   1 of  55 in sage.rings.polynomial.multi_polynomial_libsingular\n```\n\n(tested together with #30801, but I guess it doesn't matter.",
    "created_at": "2021-05-28T18:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380535",
    "user": "dimpase"
}
```

one test broken on macOS:

```
File "src/sage/rings/polynomial/multi_polynomial_libsingular.pyx", line 153, in sage.rings.polynomial.multi_polynomial_libsingular
Failed example:
    for i in range(30):
        n = leak_subs(20)
        print("Leaked {} bytes".format(n))
        if n == 0:
            zeros += 1
            if zeros >= 6:
                print("done")
                break
        else:
            zeros = 0
Expected:
    Leaked ...
    ...
    Leaked 0 bytes
    done
Got:
    Leaked 184549376 bytes
    Leaked 12582912 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 8388608 bytes
    Leaked 0 bytes
    Leaked 37748736 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 37748736 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 37748736 bytes
    Leaked 4194304 bytes
    Leaked 0 bytes
    Leaked 0 bytes
    Leaked 4194304 bytes
**********************************************************************
1 item had failures:
   1 of  55 in sage.rings.polynomial.multi_polynomial_libsingular
```

(tested together with #30801, but I guess it doesn't matter.



---

archive/issue_comments_380536.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-05-28T18:14:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380536",
    "user": "dimpase"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_380537.json:
```json
{
    "body": "The sagemath-singular interface is worse than what I thought. Switching to a generic `subs` function also leak!",
    "created_at": "2021-05-28T19:11:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380537",
    "user": "vdelecroix"
}
```

The sagemath-singular interface is worse than what I thought. Switching to a generic `subs` function also leak!



---

archive/issue_comments_380538.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-28T20:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380538",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_380539.json:
```json
{
    "body": "how about adding latest upstream fixes as patches?",
    "created_at": "2021-05-29T00:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27024",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27024#issuecomment-380539",
    "user": "dimpase"
}
```

how about adding latest upstream fixes as patches?
