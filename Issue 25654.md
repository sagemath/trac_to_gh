# Issue 25654: Implementing generators for Hamming graphs, Egawa graphs and Cai-Furer-Immerman graphs

Issue created by migration from Trac.

Original creator: Vaush

Original creation time: 2018-07-20 17:15:09

CC:  dimpase

Keywords: gsoc2018 generators Cai Furer Immerman Egawa Hamming

Adding generators for the following graph families:
 -Egawa graphs, which are not recognizable by k-Weisfeiler-Lehman with k < 3, described in https://doi.org/10.1016/0097-3165(81)90007-8
 -Hamming graphs, which are Egawa graphs cospectral mates, and with a subset being isomorphic to them. More information at https://en.wikipedia.org/wiki/Hamming_graph
 -Cai-Furer-Immerman graphs, a family of graphs with parameter t that should have the property of not being recognized by any k-WL with k less than t. The current implementation, to the best of my knowledge, still doesn't display this propery. Remains to be seen if it's due to a misunderstanding of the paper or an implementation error, but at the moment this generator is a work in progress. The paper that describes them can be found at https://doi.org/10.1007/BF01305232


---

Comment by dcoudert created at 2018-07-21 08:30:23

Why are you creating new files for these graphs ? can't you just add these generators in file `families.py` ? In general, we try to avoid adding new files unless there is a real need for it (easier for maintaining the code).

Also, this patch is build on top of #25802 (without indicating the dependency) but I have the feeling that this can be done independently.
----
Last 10 new commits:


---

Comment by Vaush created at 2018-07-21 08:56:34

I added new files so that the code could be put in .pyx files and be compiled, and also use static typing to improve efficiency, since this graphs get very large very fast, and I wanted to speed the generation up a bit. What would be the best way to do this then?\\
As per the merged ticket, it's an error, I was testing something and merged it, but wanted to revert the merge before pushing, and I forgot to do it.
I'll fix it ASAP


---

Comment by dcoudert created at 2018-07-21 12:07:05

I tried saving the `CaiFurerImmermanGraph` in a python file and in a cython file to see if it is more efficient. Honestly, the differnce is not big enough to justify adding a new cython file (and in particular a 10 lines cython file).

```
sage: %timeit CaiFurerImmermanGraph_pyx(18)
1 loop, best of 3: 6.5 s per loop
sage: %timeit CaiFurerImmermanGraph_py(18)
1 loop, best of 3: 6.86 s per loop
```

Note that you can write:

```
powerset = list(chain.from_iterable(combinations(range(k), r) for r in range(0, k+1, 2)))
```


I have not tried the `EgawaGraph` or the `HammingGraph`, but it should be exactly the same.

In input parameters of methods, avoid `X=[]` and prefer `X=None`.


---

Comment by Vaush created at 2018-07-21 12:13:21

I was talking about the other graphs, since for Egawa even (0,10) gives millions of nodes and edges.
I'll change the rest as soon as I get home


---

Comment by dcoudert created at 2018-07-21 12:18:22

How much memory you need for a graph with millions on vertices/edges in python ? What can we do with it ? Beyond a certain size, I usually use C/C++ code only: more efficient and reasonable memory consumption.


---

Comment by Vaush created at 2018-07-22 11:37:46

I suppose a lot of memory, but the reason I didn't put a limit to the parameter is for the sake of completeness, and I used the .pyx files to speed up generations.\\
I don't actually have a use for the graphs outside of performance testing for my implementation of the Weisfeiler-Lehman algorithm, so if you think using additional files to speed up generation is not worth it, I'll just move them to the normal .py file.


---

Comment by dimpase created at 2018-07-22 12:41:33

I think that fast generation has its merit. I'd start something like families_fast.pyx and start collecting such implementations there.


---

Comment by dcoudert created at 2018-07-22 14:10:37

I agree that fast generation is very interesting, but here the speedup is less than 2%...

Note that we already have file `src/sage/graphs/graph_generators_pyx.pyx` for this purpose.


---

Comment by git created at 2018-07-22 15:15:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Vaush created at 2018-07-22 15:23:50

Ok, everything you asked is done. Anyway, about the implementation, there's basically no speedup because the code for CaiFurerImmerman graphs is not yet optimised at all for Cython compilation, it's just a small sequence of itertools results passed to the methods of a Graph object.\\
In other cases, such as the Egawa graphs, it's quite more significant:


```
sage: %timeit EG_py(0,8)
1 loop, best of 3: 5.69 s per loop
sage: %timeit EG_pyx(0,8)
1 loop, best of 3: 3.91 s per loop
```


Which is not a lot, but still around 31%.\\\\
I didn't use the ` src/sage/graphs/graph_generators_pyx.pyx` simply because there's only one method for a common random (di)graph, so I wasn't sure putting family generators there was inteneded usage.


---

Comment by git created at 2018-07-30 18:37:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2018-07-31 07:53:01

I noticed that in file `graph_generators.py` you did changes like

```
-###########################################################################
-# Random Graphs
-###########################################################################
+    ###########################################################################
+    # Random Graphs
+    ###########################################################################
```

I don't understand the motivation for that.


---

Comment by git created at 2018-07-31 08:44:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-07-31 08:52:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Vaush created at 2018-07-31 08:54:43

Replying to [comment:16 dcoudert]:
> I noticed that in file `graph_generators.py` you did changes like
> {{{
> -###########################################################################
> -# Random Graphs
> -###########################################################################
> +    ###########################################################################
> +    # Random Graphs
> +    ###########################################################################
> }}}
> I don't understand the motivation for that.
I'm not really sure. It surely wasn't intentional, I must have done something wrong while writing the new code, but I don't really know how.
Anyway, I found a couple of these errors, and I should've fixed them all, thanks for spotting them!
Also, I deleted the old branch and uploaded a new one, incorporating the fix in the last commit.


---

Comment by git created at 2018-08-04 11:05:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-08-06 06:46:53


```
  File "/home/dimpase/sagetrac-mirror/local/lib/python2.7/site-packages/sage/graphs/generators/families.py", line 2993
    return newG, total_partition
SyntaxError: 'return' outside function
```



---

Comment by dcoudert created at 2018-08-06 11:22:47

A few suggestions for `EgawaGraph`:
- add an `INPUT:` block
- `Any Egawa graph with parameters (0, s)` -> `The Egawa graph with parameters (0, s)`
- You may add the reference of Agawa paper in file `src/doc/en/reference/references/index.rst` instead of putting link `https://doi.org/10.1016/0097-3165(81)90007-8`. At least, use `:doi:`10.1016/0097-3165(81)90007-8``
- you don't need to import `DenseGraph`. not used
- since `Y` is a graph, instead of the loop `for el in Y:`, you can do a loop like `for el in Y.neighbor_iterator(v[i]):`. Then, you can directly construct `u`.
- same for the loop `for el in X:`
- `for j in range(s): ` -> `for i in range(p, p+s):`
- I'm not sure it is really useful to use set `used`.
- add test to check that input parameters are ok

A few suggestions for `HammingGraph`:
- add an `INPUT:` block
- add test to check that input parameters are ok
- you don't need to import `DenseGraph`. not used
- instead of having both `q` and `X`, you could have a single parameter `q` that could be either an integer, in which case you have `X = list(range(q))` or an iterable container (list, set, tuple, etc.) in which case you can do `X = list(q)`.
- you could add a link to the wikipedia page
- I don't think you need the set `used`. You can add several times the same edge.

In the documentation of all methods, since you use `r""" some text """`, you can write latex equations. For instance, instead of writing ``p` != 0`, write ``p \neq 0``. Write also ``X^n`` to get nicer html rendering.


---

Comment by dimpase created at 2018-08-08 11:30:30

Please remove tabs from the source files. Sage uses spaces only (4 spaces per tab).


---

Comment by Vaush created at 2018-08-08 12:10:08

Replying to [comment:23 dimpase]:
> Please remove tabs from the source files. Sage uses spaces only (4 spaces per tab).
I've set up my editor to only use spaces, it's so weird a few slipped through.\\
Anyway, the only ones I've found are in the graph_generators.py file, did you find any others?


---

Comment by git created at 2018-08-08 12:11:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Vaush created at 2018-08-08 12:16:10

Replying to [comment:22 dcoudert]:
> A few suggestions for `EgawaGraph`:
> - add an `INPUT:` block
> - `Any Egawa graph with parameters (0, s)` -> `The Egawa graph with parameters (0, s)`
> - You may add the reference of Agawa paper in file `src/doc/en/reference/references/index.rst` instead of putting link `https://doi.org/10.1016/0097-3165(81)90007-8`. At least, use `:doi:`10.1016/0097-3165(81)90007-8``
> - you don't need to import `DenseGraph`. not used
> - since `Y` is a graph, instead of the loop `for el in Y:`, you can do a loop like `for el in Y.neighbor_iterator(v[i]):`. Then, you can directly construct `u`.
> - same for the loop `for el in X:`
> - `for j in range(s): ` -> `for i in range(p, p+s):`
> - I'm not sure it is really useful to use set `used`.
> - add test to check that input parameters are ok
> 
> A few suggestions for `HammingGraph`:
> - add an `INPUT:` block
> - add test to check that input parameters are ok
> - you don't need to import `DenseGraph`. not used
> - instead of having both `q` and `X`, you could have a single parameter `q` that could be either an integer, in which case you have `X = list(range(q))` or an iterable container (list, set, tuple, etc.) in which case you can do `X = list(q)`.
> - you could add a link to the wikipedia page
> - I don't think you need the set `used`. You can add several times the same edge.
> 
> In the documentation of all methods, since you use `r""" some text """`, you can write latex equations. For instance, instead of writing ``p` != 0`, write ``p \neq 0``. Write also ``X^n`` to get nicer html rendering.

I've made the changes you suggested, save for the one about the parameters X and q. I see what you mean when you say one could use only one paramers, but I feel like it would be confusing to be able to pass either an integer or an iterable under the same name, and it's not like X needs to be passed most of the time anyway.\\
I'll add a check for the input soon too, but first I want to decide if there is a need to have this .pyx file for generators who need more speed.\\
Talking with dimpase, he told me he would like to see one, but in this particular case, after refactoring the code a bit, all my generators take more or less the same amount of time, .pyx or not, because most of the time is spent creating the actual graph, not computing edges and vertices.\\
There is some improvement mind you, but it's less than 10%. What should I do? Both versions are included in this commit, so that anyone can check for themselves what I mean, I'll simply delete the not needed ones when a decision has been made.


---

Comment by dimpase created at 2018-08-08 12:20:34

You should also check that the docs can be built.
Without your latest commit, I needed to change things to get docs built. Here is a diff (more changes - I guess the one that broke things was `|X|` without !``):

```
diff --git a/src/sage/graphs/generators/families.py b/src/sage/graphs/generators/families.py
index 7101b881a6..c04edb2f53 100644
--- a/src/sage/graphs/generators/families.py
+++ b/src/sage/graphs/generators/families.py
`@``@` -142,10 +142,10 `@``@` def EgawaGraph(p, s):
     that is their orbits are not correctly returned by k-WL for k lower than 3.
     
     Furthermore, all the graphs in this family are distance-regular, but they are
-    not distance-transitive if `p` != 0.
+    not distance-transitive if `p` is non-zero.
     
-    Any Egawa graph with parameters (0, s) is isomorphic to the Hamming graph
-    with parameters (s, 4)
+    Any Egawa graph with parameters `(0, s)` is isomorphic to the Hamming graph
+    with parameters `(s, 4)`.
     
     EXAMPLES:
 
`@``@` -194,12 +194,12 `@``@` def HammingGraph(n, q, X=None):
     Returns the Hamming graph with parameters `n, q` over set `X`.
 
     Hamming graphs are graphs over the cartesian product of n copies of X,
-    where q = |X|, where the vertices, labelled with the corresponding tuple in X^n,
+    where `q = |X|`, where the vertices, labelled with the corresponding tuple in `X^n`,
     are connected if the Hamming distance between their labels is 1.
     All Hamming graphs are regular, vertex-transitive and distance-regular.
     
-    Hamming graphs with parameters (1,q) represent the complete graph with
-    q vertices over the set X.
+    Hamming graphs with parameters `(1,q)` represent the complete graph with
+    `q` vertices over the set `X`.
     
     EXAMPLES:
 
`@``@` -2990,7 +2990,7 `@``@` def CaiFurerImmermanGraph(G, twisted=False):
     else:
         s = ""
     newG.name("CaiFurerImmerman" + s + " graph constructed from a " + G.name())
-return newG, total_partition
+    return newG, total_partition
             
             
 def MathonPseudocyclicMergingGraph(M, t):
```



---

Comment by dimpase created at 2018-08-08 12:23:44

to look for tabs in a given directory and all its subdirs, do e.g.

```
 grep -R -P "\t" .
```



---

Comment by Vaush created at 2018-08-08 12:26:10

Replying to [comment:27 dimpase]:
> You should also check that the docs can be built.
> Without your latest commit, I needed to change things to get docs built. Here is a diff (more changes - I guess the one that broke things was `|X|` without !``):
> {{{
> diff --git a/src/sage/graphs/generators/families.py b/src/sage/graphs/generators/families.py
> index 7101b881a6..c04edb2f53 100644
> --- a/src/sage/graphs/generators/families.py
> +++ b/src/sage/graphs/generators/families.py
> `@``@` -142,10 +142,10 `@``@` def EgawaGraph(p, s):
>      that is their orbits are not correctly returned by k-WL for k lower than 3.
>      
>      Furthermore, all the graphs in this family are distance-regular, but they are
> -    not distance-transitive if `p` != 0.
> +    not distance-transitive if `p` is non-zero.
>      
> -    Any Egawa graph with parameters (0, s) is isomorphic to the Hamming graph
> -    with parameters (s, 4)
> +    Any Egawa graph with parameters `(0, s)` is isomorphic to the Hamming graph
> +    with parameters `(s, 4)`.
>      
>      EXAMPLES:
>  
> `@``@` -194,12 +194,12 `@``@` def HammingGraph(n, q, X=None):
>      Returns the Hamming graph with parameters `n, q` over set `X`.
>  
>      Hamming graphs are graphs over the cartesian product of n copies of X,
> -    where q = |X|, where the vertices, labelled with the corresponding tuple in X^n,
> +    where `q = |X|`, where the vertices, labelled with the corresponding tuple in `X^n`,
>      are connected if the Hamming distance between their labels is 1.
>      All Hamming graphs are regular, vertex-transitive and distance-regular.
>      
> -    Hamming graphs with parameters (1,q) represent the complete graph with
> -    q vertices over the set X.
> +    Hamming graphs with parameters `(1,q)` represent the complete graph with
> +    `q` vertices over the set `X`.
>      
>      EXAMPLES:
>  
> `@``@` -2990,7 +2990,7 `@``@` def CaiFurerImmermanGraph(G, twisted=False):
>      else:
>          s = ""
>      newG.name("CaiFurerImmerman" + s + " graph constructed from a " + G.name())
> -return newG, total_partition
> +    return newG, total_partition
>              
>              
>  def MathonPseudocyclicMergingGraph(M, t):
> }}}
I know, I'm sorry.\\
This last commit was tested for docbuilding too, it works.


---

Comment by Vaush created at 2018-08-08 12:27:00

Replying to [comment:28 dimpase]:
> to look for tabs in a given directory and all its subdirs, do e.g.
> {{{
>  grep -R -P "\t" .
> }}}
I did that, that's how I found the ones in graph_generators.py, but one can never be too sure, so I asked if there were any other ones you found that escaped grep for some reason.


---

Comment by dcoudert created at 2018-08-08 12:51:08

As I already said, I don't see the need for a pyx file if the code is essentially Python. Nonetheless, I will not fight against it.

You use type `bool`, but you could use `bint` instead (no need for import) as done in file `src/sage/graphs/generic_graph_pyx.pyx`.
You also import `string` but it is never used. You use type `str`.


---

Comment by dimpase created at 2018-08-11 07:42:56

`HammingGraph` needs tests for the use of `X=`.
(e.g. what happens in `|X|` is not equal to `q`).


---

Comment by git created at 2018-08-11 12:26:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-11 12:28:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Vaush created at 2018-08-11 12:29:22

Replying to [comment:31 dcoudert]:
> As I already said, I don't see the need for a pyx file if the code is essentially Python. Nonetheless, I will not fight against it.
> 
> You use type `bool`, but you could use `bint` instead (no need for import) as done in file `src/sage/graphs/generic_graph_pyx.pyx`.
> You also import `string` but it is never used. You use type `str`.
Done\\\\
Replying to [comment:32 dimpase]:
> `HammingGraph` needs tests for the use of `X=`.
> (e.g. what happens in `|X|` is not equal to `q`).
And done


---

Comment by dcoudert created at 2018-08-21 09:13:46

Please format documentation in 80 columns mode.

In method `FurerGadget`:
- add an examples block
- I assume that `k` must be positive. What if `k==0` ? add a test.
- what is the expected type of `prefix` ? you could document that.
- you use `zip(...)`. With Python3, `zip` becomes an iterator. So if `Va = zip(...)`, you can iterate over `Va` only once. More precisely, after doing `G.add_vertices(Va)`, the operation `Va[i]` raises an error (in Python3). The solution here is to do `Va = list(zip(...))`.
- `rep(prefix, len(V_a))` -> `rep(prefix, k)`, no ?
- `for r in range(k+1) if r % 2 == 0` could be simply `for r in range(0, k+1, 2)`


In method `CaiFurerImmermanGraph`:
- in the documentation, you can write ``G`` instead of ```G``` to use latex.
- `F(v)` -> ``F(v)``
- add an examples block and possibly some tests.
- What if `G` is the empty graph ?
- `G.edges(labels=False)` -> `G.edge_iterator(labels=False)`
- The block `temp = edge_ua` is currently not correct as it sets `edge_ua` to it's initial value without touching `edge_ub`. I recommend to rewrite it in 1 line: `edge_ua, edge_ub = edge_ub, edge_ua`.

In method `EgawaGraph`:
- Returns -> Return
- add tests on `p` and `s`. Strictly positive ? 


In `HammingGraph`:
- `if None (or left unused)` -> `if ``None`` (or left unused)`. It's a general convention in documentation for `None`, `True` and `False`.
- add tests for the expected values of `n` and `q`.

Sorry to bother you with all these "details", but the cleaner the code, the easier it is to maintain.


---

Comment by git created at 2018-08-26 09:31:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-30 13:15:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-30 13:16:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by Vaush created at 2018-08-30 13:17:33

Replying to [comment:36 dcoudert]:
> Please format documentation in 80 columns mode.
> 
> In method `FurerGadget`:
> - add an examples block
> - I assume that `k` must be positive. What if `k==0` ? add a test.
> - what is the expected type of `prefix` ? you could document that.
> - you use `zip(...)`. With Python3, `zip` becomes an iterator. So if `Va = zip(...)`, you can iterate over `Va` only once. More precisely, after doing `G.add_vertices(Va)`, the operation `Va[i]` raises an error (in Python3). The solution here is to do `Va = list(zip(...))`.
> - `rep(prefix, len(V_a))` -> `rep(prefix, k)`, no ?
> - `for r in range(k+1) if r % 2 == 0` could be simply `for r in range(0, k+1, 2)`
> 
> 
> In method `CaiFurerImmermanGraph`:
> - in the documentation, you can write ``G`` instead of ```G``` to use latex.
> - `F(v)` -> ``F(v)``
> - add an examples block and possibly some tests.
> - What if `G` is the empty graph ?
> - `G.edges(labels=False)` -> `G.edge_iterator(labels=False)`
> - The block `temp = edge_ua` is currently not correct as it sets `edge_ua` to it's initial value without touching `edge_ub`. I recommend to rewrite it in 1 line: `edge_ua, edge_ub = edge_ub, edge_ua`.
> 
> In method `EgawaGraph`:
> - Returns -> Return
> - add tests on `p` and `s`. Strictly positive ? 
> 
> 
> In `HammingGraph`:
> - `if None (or left unused)` -> `if ``None`` (or left unused)`. It's a general convention in documentation for `None`, `True` and `False`.
> - add tests for the expected values of `n` and `q`.
> 
> Sorry to bother you with all these "details", but the cleaner the code, the easier it is to maintain. 
Fixed everything, the graph G can be empty for a CaiFurerImmerman graph, it will simply return an equally empty graph.
Prefix can be anything, so it doesn't really matter.
And anyway, don't worry about it, I appreciate the attention to details, you're telling me things I couldn't have known by myself, thanks.
----
New commits:


---

Comment by dimpase created at 2018-09-16 08:35:21

Is it ready for review? If so, please set it ready for review...


---

Comment by Vaush created at 2018-09-18 09:30:43

Changing status from new to needs_review.


---

Comment by dcoudert created at 2018-09-18 11:50:14

A choice must be done: either put the methods in `families.py` or in a new file `families_pyx.pyx`.
I don't see the advantage of the new `.pyx` file here, as the speed up improvement is rather limited, but I will not fight against it.


---

Comment by Vaush created at 2018-09-18 12:01:51

Replying to [comment:43 dcoudert]:
> A choice must be done: either put the methods in `families.py` or in a new file `families_pyx.pyx`.
> I don't see the advantage of the new `.pyx` file here, as the speed up improvement is rather limited, but I will not fight against it.
I have to say in this case I agree with you, there's not much use for it, as the bottleneck in basically any case is going to be the creation of the graph itself, but since I didn't want to choose by myself, I'll leave it for other reviewers to decide. \\
It's a 1 minute job to delete one of the two versions, anyway.


---

Comment by dimpase created at 2018-10-05 10:16:20

fixed docs formatting, and few changes in docs English.
----
New commits:


---

Comment by dimpase created at 2018-10-05 10:16:20

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2018-10-05 10:26:12

still needs removal of the cython version


---

Comment by dimpase created at 2018-10-05 10:26:12

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-10-05 10:48:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-10-05 10:49:22

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2018-10-05 10:49:22

all done.


---

Comment by vbraun created at 2018-10-06 17:12:59

Resolution: fixed
