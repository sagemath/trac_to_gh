# Issue 24918: Implement global options for WQSym

Issue created by migration from Trac.

Original creator: alauve

Original creation time: 2018-04-12 15:53:59

CC:  alauve tscrim darij amypang zabrocki

Keywords: IMA coding sprint, CHAs

Ordered set partitions are in bijection with packed words. It would be nice to be able to work with packed words in the Hopf algebra WQSym. In the branch, I shall also implement "tight" and "compact" notations for the output.


---

Comment by git created at 2018-04-12 19:17:24

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2018-04-13 15:44:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-04-13 15:44:38

If my changes look good, then positive review.


---

Comment by tscrim created at 2018-04-13 15:44:38

Changing status from new to needs_review.


---

Comment by git created at 2018-04-13 16:01:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by alauve created at 2018-04-26 18:12:45

I'm happy with these changes. How do others feel about the following snippet from `OrderedSetPartition` ?:

```
    INPUT:

    - ``parts`` -- the parts of the ordered set partition
    - ``from_word`` -- (optional) allows the creation of an ordered set
      partition from any finite word or iterable , e.g., a packed word
```


The reader may be led to think that `parts` is required. In fact, the way the code is written, exactly one of `parts` and `from_word` is used (and it's `from_word` if that one is given). It must be a keyword/named argument, as the code is currently written, because I was being lazy about how to distinguish between the two possible inputs. E.g., if the lone argument [[1,2],[4],[3]] is passed, should this be viewed as a word on the alphabet "finite subsets of `NN`" or as a partition of {1,2,3,4} into blocks? Probably the latter, but should I make that restriction on future use?


---

Comment by @darijgr created at 2018-04-26 20:41:05

Just say "(in this case, ``parts`` needs not be provided)"?


---

Comment by tscrim created at 2018-04-27 00:06:17

The other way would be to say "one of the following must be provided" but that is slightly misleading as `parts` could be a packed word IIRC. Thinking a little more, perhaps this is better:

```
INPUT

- ``parts`` -- an object or iterable that defines an ordered set partition;
  if there is ambiguity, use the keyword ``from_word`` if the input should
  be treated as a packed word
```



---

Comment by @darijgr created at 2018-04-27 00:07:01

Argh! Do we really want duck-typing here? Please think hard about whether this is really unambiguous and whether it's worth the slowdown.


---

Comment by tscrim created at 2018-04-27 00:22:58

Yes, this is the behavior we want. It is stupid and annoying to make users have to use a keyword argument when a packed word as a list is sufficient. The ambiguity is when you want a packed word whose letters are sets/lists/etc. (This is also not ducktyping, but parsing input. Ducktyping is doing something like `L[0]`, where `L` could be a list/tuple/iterable and gets treated in the same way.)


---

Comment by alauve created at 2018-05-01 02:57:53

So what is better for `__classcall_private__`? Trying to process an ordered set partition first, or trying to process a packed word first?

At present, the code first tries to process `part` as a packed word:

```
        # if `parts` looks like a sequence of "letters" then treat it like a word.
        if parts in Words() or (len(parts) > 0 and isinstance(parts[0], (str, int, Integer))):
            return OrderedSetPartitions().from_finite_word(Words()(parts))
        else:
            P = OrderedSetPartitions( reduce(lambda x,y: x.union(y), map(Set, parts), Set([])) )
            return P.element_class(P, parts)
```


but this might be better:


```
        # if `parts` looks like a sequence of "sets" then treat it like an ordered set partition.
        if parts in OrderedSetPartitions() or (len(parts) > 0 and isinstance(parts[0], (list, tuple, set, Set))):
            P = OrderedSetPartitions( reduce(lambda x,y: x.union(y), map(Set, parts), Set([])) )
            return P.element_class(P, parts)
        else:
            return OrderedSetPartitions().from_finite_word(Words()(parts))
```



---

Comment by git created at 2018-05-01 03:11:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-05-02 12:46:03

Replying to [comment:13 alauve]:
> So what is better for `__classcall_private__`? Trying to process an ordered set partition first, or trying to process a packed word first?

I don't think it matters. Actually, it only treats words in `(str, int, Integer)` (not even rationals; a more robust check is `x in ZZ` modulo `str`). At least, I wouldn't worry about it until there is a definite problem.


---

Comment by alauve created at 2018-05-04 14:59:23

I don't quite know what you mean by "modulo `str`." Are you suggesting changes?

Additionally, are there any more changes from #25133 that need to be brought in, or is this good to go?


---

Comment by tscrim created at 2018-05-05 06:52:50

I am suggesting a change: `isinstance(parts[0], (str, int, Integer))` -> `parts[0] in ZZ or isinstance(parts[0], str)`. The "modulo `str`" was because that is still a useful check.

There is also a doctest in `combinat/words/finite_word.py` needing a trivial fix (see the patchbot report).


---

Comment by git created at 2018-05-06 18:29:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-05-06 23:03:44

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-05-06 23:03:44

Thanks. LGTM.


---

Comment by alauve created at 2018-05-07 03:50:40

Thanks, Travis!


---

Comment by git created at 2018-05-09 23:55:48

Changing status from positive_review to needs_review.


---

Comment by git created at 2018-05-09 23:55:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by tscrim created at 2018-05-09 23:56:05

Trivial rebase.


---

Comment by tscrim created at 2018-05-09 23:56:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-05-17 21:43:10

PDF docs don't build


---

Comment by vbraun created at 2018-05-17 21:43:10

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-17 21:55:26

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2018-05-17 22:01:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @darijgr created at 2018-05-17 22:05:23

Changing status from needs_work to positive_review.


---

Comment by @darijgr created at 2018-05-17 22:05:23

This should do it. (Sorry for forced push -- I had a dirty develop branch, and it smuggled several other tickets in this.)


---

Comment by vbraun created at 2018-05-19 15:56:39

Resolution: fixed


---

Comment by alauve created at 2018-06-14 17:29:39

In my view, this ticket is incomplete. Notice the following:


```
sage: M = WordQuasiSymmetricFunctions(QQ).M()
sage: c = OrderedSetPartition([1,1,2,1]); c # enter an OSP as a packed word
[{1, 2, 4}, {3}]
sage: M[c]
M[{1, 2, 4}, {3}]
sage: m = M[[1,2,4],[3]]; m
M[{1, 2, 4}, {3}]
sage: M.options.objects = "words"
sage: m
M[1, 1, 2, 1]
sage: M[1,1,2,1], M[This is the Trac macro *1,1,2,1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,1,2,1-macro)
(M[{1, 2}], M[{1, 2}])
```


I'd like to see things like `M[1,1,2,1]` and/or `M[This is the Trac macro *1,1,2,1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,1,2,1-macro)` return the basis element corresponding to the indicated packed word, i.e., `M[1, 1, 2, 1]`.

If anybody thinks this is worth a new ticket, perhaps they could weigh-in, after taking a peek at this branch: 
`public/combinat/allow-packed-words-in-wqsym`


---

Comment by @darijgr created at 2018-06-16 22:08:11

I'm not sure I want global options to modify anything other than output. Imagine, for example, that some code internally calls `M[O]` for some ordered set partition `O`. But the user has set a global option that causes this `O` to be interpreted (wrongly) as a packed word. Hilarity ensues. (We had this problem with the infamous global option that decides in which order permutations are multiplied.)

If you want a quick way to turn a packed word into a basis element of `WQSym`, define a helper function, like

```
def Mw(w):
    return M[OrderedSetPartition(w)]
```

Maybe this should be suggested in the doc.


---

Comment by tscrim created at 2018-06-17 02:07:28

Replying to [comment:29 gh-darijgr]:
> (We had this problem with the infamous global option that decides in which order permutations are multiplied.)

I think this is still "have", but I don't have a concrete issue.

I agree with Darij on this, it should only affect the printing output as a convenience for the user.

Actually, why the packed word input does not work (which at least `M[1,1,2,1]` I think should) is because this fails:

```
sage: OSP = OrderedSetPartitions()
sage: OSP([1,1,2,1])
...
TypeError: Element has no defined underlying set
```

So we might want to consider moving the checking to see if the input-is-a-word to the `_element_constructor_`.


---

Comment by alauve created at 2018-06-18 15:24:48

Replying to [comment:30 tscrim]:
> Actually, why the packed word input does not work (which at least `M[1,1,2,1]` I think should) is because this fails:
> {{{
> sage: OSP = OrderedSetPartitions()
> sage: OSP([1,1,2,1])
> ...
> TypeError: Element has no defined underlying set
> }}}
> So we might want to consider moving the checking to see if the input-is-a-word to the `_element_constructor_`.

.

This seems like a good idea to me. I can start a ticket to make this happen. However, ...

I wonder what will/should happen when the user enters `M[1,2,3]`. Right now, I believe one sees `M[{1,2,3}]`. Are we all in agreement that one should instead see `M[{1}, {2}, {3}]`? And that we should demand the user enter `M[This is the Trac macro *1,2,3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2,3-macro)` to get the former?


---

Comment by tscrim created at 2018-06-19 00:40:37

Python will not fundamentally distinguish between `M[1,2,3]` and `M[This is the Trac macro *1,2,3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2,3-macro)` other than in the former case, it will be a `tuple` rather than a `list` as input. I don't think we want to treat tuples and lists differently, but maybe we do want to do that.


---

Comment by alauve created at 2018-06-19 03:22:47

Yeah..., came to that realization after working on the aforementioned branch for awhile this afternoon.
I hate to have `M[This is the Trac macro *1,2,3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1,2,3-macro)` get interpreted as `M[{1}, {2}, {3}]` (and equally hate asking the user to enter `M[This is the Trac macro *[1,2,3* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#[1,2,3-macro)]`).

If we avoid making a distinction between tuples and lists, should we then drop this idea altogether? So, in documentation, we suggest users build the `Mw` shortcut of Darij?


---

Comment by tscrim created at 2018-06-19 03:40:37

Quite possibly. Another option I just thought of is to construct a custom `basis` method that takes a parameter `indexed_by_words`, where the default is `False`. If `True`, then it returns a basis such that it goes through the `OrderedSetPartitions.from_word`.
