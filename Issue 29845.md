# Issue 29845: Make ./bootstrap less sensitive to stray files in build/pkgs (affects patchbot operation)

archive/issues_029845.json:
```json
{
    "body": "CC:  @fchapoton tmonteil @dimpase @jhpalmieri @vbraun\n\nSome patchbots fail after testing some tickets that leave build/pkgs unclean:\n\n```\n./bootstrap -d\nmake[2]: Entering directory '/home/sagemath/sage-9.1'\nrm -rf config configure build/make/Makefile-auto.in\nrm -f src/doc/en/installation/*.txt\nrm -rf src/doc/en/reference/spkg/*.rst\nrm -f src/doc/en/reference/repl/*.txt\nmake[2]: Leaving directory '/home/sagemath/sage-9.1'\ncat: build/pkgs/sage_setup/type: No such file or directory\nmake[1]: *** [Makefile:208: configure] Error 1\nmake[1]: Leaving directory '/home/sagemath/sage-9.1'\nmake: *** [Makefile:32: doc-clean] Error 2\n```\n\n(https://patchbot.sagemath.org/log/30074/Linux/1_SMP_Debian_4.19.118-2+deb10u1_(2020-06-07)/x86_64/4.19.0-9-amd64/tmonteil-lxc/2020-07-06%2007:27:05)\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/30082\n\n",
    "created_at": "2020-07-06T20:00:38Z",
    "labels": [
        "component: build: configure",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Make ./bootstrap less sensitive to stray files in build/pkgs (affects patchbot operation)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29845",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @fchapoton tmonteil @dimpase @jhpalmieri @vbraun

Some patchbots fail after testing some tickets that leave build/pkgs unclean:

```
./bootstrap -d
make[2]: Entering directory '/home/sagemath/sage-9.1'
rm -rf config configure build/make/Makefile-auto.in
rm -f src/doc/en/installation/*.txt
rm -rf src/doc/en/reference/spkg/*.rst
rm -f src/doc/en/reference/repl/*.txt
make[2]: Leaving directory '/home/sagemath/sage-9.1'
cat: build/pkgs/sage_setup/type: No such file or directory
make[1]: *** [Makefile:208: configure] Error 1
make[1]: Leaving directory '/home/sagemath/sage-9.1'
make: *** [Makefile:32: doc-clean] Error 2
```

(https://patchbot.sagemath.org/log/30074/Linux/1_SMP_Debian_4.19.118-2+deb10u1_(2020-06-07)/x86_64/4.19.0-9-amd64/tmonteil-lxc/2020-07-06%2007:27:05)


Issue created by migration from https://trac.sagemath.org/ticket/30082





---

archive/issue_comments_423466.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-06T20:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29845#issuecomment-423466",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_423467.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-07-06T20:10:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29845#issuecomment-423467",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_423468.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-07-07T22:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29845#issuecomment-423468",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_423469.json:
```json
{
    "body": "Looks okay to me. If I create an empty directory `build/pkgs/sage_setup`, `bootstrap` fails as in the description. With the branch here, it works.\n\nIt does print the warning message four times, which makes me wonder if the loops should be done in the other order: first `for PKG_SCRIPTS in build/pkgs/*`, then `for SYSTEM in arch debian fedora cygwin homebrew`. As it stands, some commands are executed multiple times (the glob in the for loop, and `PKG_BASE=$(basename $PKG_SCRIPTS)` and `PKG_TYPE=$(cat $PKG_SCRIPTS/type)`), but those won't meaningfully affect the running time. With the loops interchanged, then `SYSTEM_PACKAGES=$(echo $(${STRIP_COMMENTS} build/pkgs/$SYSTEM.txt))` would get executed more times instead.",
    "created_at": "2020-07-07T22:21:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29845#issuecomment-423469",
    "user": "https://github.com/jhpalmieri"
}
```

Looks okay to me. If I create an empty directory `build/pkgs/sage_setup`, `bootstrap` fails as in the description. With the branch here, it works.

It does print the warning message four times, which makes me wonder if the loops should be done in the other order: first `for PKG_SCRIPTS in build/pkgs/*`, then `for SYSTEM in arch debian fedora cygwin homebrew`. As it stands, some commands are executed multiple times (the glob in the for loop, and `PKG_BASE=$(basename $PKG_SCRIPTS)` and `PKG_TYPE=$(cat $PKG_SCRIPTS/type)`), but those won't meaningfully affect the running time. With the loops interchanged, then `SYSTEM_PACKAGES=$(echo $(${STRIP_COMMENTS} build/pkgs/$SYSTEM.txt))` would get executed more times instead.



---

archive/issue_comments_423470.json:
```json
{
    "body": "Thanks! \n\nI don't think it's worth changing the code so that the warning is printed less often.",
    "created_at": "2020-07-08T00:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29845#issuecomment-423470",
    "user": "https://github.com/mkoeppe"
}
```

Thanks! 

I don't think it's worth changing the code so that the warning is printed less often.



---

archive/issue_events_027506.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-07-10T19:34:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29845#event-27506"
}
```



---

archive/issue_comments_423471.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-10T19:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29845",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29845#issuecomment-423471",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
