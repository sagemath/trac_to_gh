# Issue 28293: Bug in polynomial rootfinding over QQbar related to QQbar → CC → pari conversions

Issue created by migration from https://trac.sagemath.org/ticket/28530

Original creator: mmezzarobba

Original creation time: 2019-09-23 13:19:36

CC:  slelievre


```
sage: K.<a> = NumberField(x^2 - x - 6256320, embedding=-2500.763730596996)
....: lc = (253699680440307500000000000000000000000000*x^13 + (-82964409970750000000000000000000000*a - 253907049983029389625000000000000000000000)*x^12 - 1269011504560040442911087500000000000000000*x^11 + (4149898436576441004087500000000
....: 00000*a + 1270048771674262724340059170625000000000000)*x^10 + 2539049473271641600616704837811000000000000*x^9 + (-830315359762894607374452813100000000*a - 2541124846513368955687837282617343450000000)*x^8 - 25400761968577569693195506
....: 26460768394380000*x^7 + (830651117050319162421733536395645998*a + 2542152409324824242066023749434989311552001)*x^6 + 1270551589939213408433336739488536788760000*x^5 + (-415493479588780904355108633491291996*a - 1271590115891445566303
....: 772333517948273104002)*x^4 - 254213042233365096819403450838768394380000*x^3 + (83132288614462248899077910195645998*a + 254420831388756945210526696075302411552001)*x^2)
....: lc = lc.change_ring(QQbar)
sage: lc.roots(CIF)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-2-4c09d35f31d7> in <module>()
----> 1 lc.roots(CIF)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:61905)()
   7763 
   7764                 if is_ComplexIntervalField(L):
-> 7765                     rts = complex_roots(self, min_prec=L.prec())
   7766                 elif is_AlgebraicField(L):
   7767                     rts = complex_roots(self, retval='algebraic')

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/complex_roots.pyc in complex_roots(p, skip_squarefree, retval, min_prec)
    256         for (factor, exp) in factors:
    257             cfac = CCX(factor)
--> 258             rts = cfac.roots(multiplicities=False)
    259             # Make sure the number of roots we found is the degree. If
    260             # we don't find that many roots, it's because the

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.roots (build/cythonized/sage/rings/polynomial/polynomial_element.c:59417)()
   7673                 if not input_arbprec:
   7674                     self = self.change_ring(CC if input_complex else RR)
-> 7675                 ext_rts = self.__pari__().polroots(precision=L.prec())
   7676 
   7677             if output_complex:

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial.__pari__ (build/cythonized/sage/rings/polynomial/polynomial_element.c:49123)()
   6065             Mod(2, 8)*x^3 + Mod(1, 8)*a*x
   6066         """
-> 6067         return self._pari_with_name(self._parent.variable_name())
   6068 
   6069     def _pari_or_constant(self, name=None):

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_element.pyx in sage.rings.polynomial.polynomial_element.Polynomial._pari_with_name (build/cythonized/sage/rings/polynomial/polynomial_element.c:49515)()
   6118             2*y^2 + y
   6119         """
-> 6120         vals = [x.__pari__() for x in self.list()]
   6121         return pari(vals).Polrev(name)
   6122 

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/complex_number.pyx in sage.rings.complex_number.ComplexNumber.__pari__ (build/cythonized/sage/rings/complex_number.c:7236)()
    592         if self.is_real():
    593             return self.real().__pari__()
--> 594         return sage.libs.pari.all.pari.complex(self.real() or 0, self.imag())
    595 
    596     def __mpc__(self):

cypari2/pari_instance.pyx in cypari2.pari_instance.Pari.complex()

cypari2/gen.pyx in cypari2.gen.objtogen()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/real_mpfr.pyx in sage.rings.real_mpfr.RealNumber.__pari__ (build/cythonized/sage/rings/real_mpfr.c:22227)()
   3226 
   3227         if mpfr_nan_p(self.value) or mpfr_inf_p(self.value):
-> 3228             raise ValueError('Cannot convert NaN or infinity to Pari float')
   3229 
   3230         # wordsize for PARI

ValueError: Cannot convert NaN or infinity to Pari float
sage: lc.roots(CIF)
[(-1.000505492239?, 2),
 (-1.000000000000?, 2),
 (-0.999999999662605?, 1),
 (0, 2),
 (1.000000000000?, 2),
 (1.000505492239?, 2),
 (0.999999587? + 0.?e-11*I, 1),
 (0.999999999? + 0.?e-11*I, 1)]
```


From a quick look, the issue appears to be that the rootfinding code produces algebraic numbers whose current known enclosure is NaN and which then get converted to CC(NaN) and from there to Pari. I don't know where exaclty the bug is in the chain, nor why the second run succeeds (presumably because something gets refined or exactified, but I don't see where). Merging in #25019 doesn't solve the issue.


---

Comment by slelievre created at 2019-09-23 13:29:52

Changing component from PLEASE CHANGE to numerical.


---

Comment by vdelecroix created at 2019-09-23 19:39:04

It is worse than this. If you enter a second time the same polynomial (over K), do the base ring change one more time then it works!


---

Comment by vdelecroix created at 2019-09-23 19:50:58

Indeed, something weirdly related to #25019 is happening

```
sage: import ipdb
sage: ipdb.run('lc.roots(CIF)')
ipdb> b sage/rings/polynomial/complex_roots.py:256
Breakpoint 1 at /opt/sage/local/lib/python3.7/site-packages/sage/rings/polynomial/complex_roots.py:256
ipdb> r
> /opt/sage/local/lib/python3.7/site-packages/sage/rings/polynomial/complex_roots.py(256)complex_roots()
    255 
1-> 256         for (factor, exp) in factors:
    257             cfac = CCX(factor)
ipdb> p factors[0][0][3].exactify()
*** ZeroDivisionError: rational division by zero
```



---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by @mwageringel created at 2021-03-17 18:23:49

The error happens somewhere in the generic `QQbar._gcd_univariate_polynomial` from `sage.categories.fields`. I suspect it is related to checking whether an algebraic number is exactly zero. The gcd is computed roughly like this (with `lc` as in the description):


```
a = lc
b = lc.derivative()
k = 0
while b:
    q, r = a.quo_rem(b)
    if k >= 5:
        print("%s>> r: %s" % (k, r))
    a, b = b, r
    k += 1
```


Output:


```
5>> r: -1.2064221?e36*x^6 + 1.2064221?e36*x^5 + 2.4140642?e36*x^4 - 2.4140641?e36*x^3 - 1.20764205?e36*x^2 + 1.20764205?e36*x
6>> r: 0.?e16*x^5 + 0.?e16*x^3 + 0.?e16*x
7>> r: ([.. NaN ..] + [.. NaN ..]*I)*x^4 + ([.. NaN ..] + [.. NaN ..]*I)*x^3 + ([.. NaN ..] + [.. NaN ..]*I)*x^2 + ([.. NaN ..] + [.. NaN ..]*I)*x + [.. NaN ..] + [.. NaN ..]*I
8>> r: ([.. NaN ..] + [.. NaN ..]*I)*x^3 + ([.. NaN ..] + [.. NaN ..]*I)*x^2 + ([.. NaN ..] + [.. NaN ..]*I)*x + [.. NaN ..] + [.. NaN ..]*I
9>> r: ([.. NaN ..] + [.. NaN ..]*I)*x^2 + ([.. NaN ..] + [.. NaN ..]*I)*x + [.. NaN ..] + [.. NaN ..]*I
10>> r: ([.. NaN ..] + [.. NaN ..]*I)*x + [.. NaN ..] + [.. NaN ..]*I
11>> r: [.. NaN ..] + [.. NaN ..]*I
12>> r: 0
```

If one exactifies the coefficients of `r`, one gets:

```
5>> r: -1.2064220692284205?e36*x^6 + 1.2064220689565884?e36*x^5 + 2.414064120710128?e36*x^4 - 2.414064120166189?e36*x^3 - 1.207642051481707?e36*x^2 + 1.2076420512096000?e36*x
6>> r: 1.1302?e10*x^5 - 2.2614?e10*x^3 + 1.1313?e10*x
7>> r: 0
```


Is it allowed for an algebraic number to be represented by `[.. NaN ..]` at all?

#23459 might be the same issue, by the way.


---

Comment by vdelecroix created at 2021-03-17 19:00:06

Thanks for the diagnostic! Could you check how the branch works for you?
----
New commits:


---

Comment by git created at 2021-03-17 19:06:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-03-17 19:07:21

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2021-03-17 21:55:52

It works well, also with the computation that lead me to this ticket. Thank you for the fix. I hope it does not cause infinite loops.

Tests have passed on my end.


---

Comment by @mwageringel created at 2021-03-17 21:55:52

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-20 15:27:39

Resolution: fixed
