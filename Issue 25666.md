# Issue 25666: strange behavior in macaulay2 bridge

archive/issues_025666.json:
```json
{
    "body": "CC:  @mwageringel @slel @dimpase @saliola @antonleykin\n\nIf I run \n\n```python\nmacaulay2.eval(';'.join([\n'R = ZZ/101[x000, x001, x010, x011, x100, x101, x110, x111, DegreeRank=>8]', \n'idl77 = module ideal(x000*x010*x100*x110, x000*x010*x101*x111, x000*x011*x100*x111, x000*x011*x101*x111, x001*x010*x101*x110, x001*x010*x101*x111, x001*x011*x100*x110, x001*x011*x100*x111, x001*x011*x101*x110, x001*x011*x101*x111)', \n'res77 = res idl77']))\n```\nI get back the correct answer in sage.\n\n```\n 10      16      8      1\nR   <-- R   <-- R  <-- R  <-- 0\n                               \n0       1       2      3      4\n\nChainComplex\n```\n\nHowever if I try a larger ring and ideal,\n\n```python\nmacaulay2.eval(';'.join([\n'R = ZZ/101[x0000, x0001, x0010, x0011, x0100, x0101, x0110, x0111, x1000, x1001, x1010, x1011, x1100, x1101, x1110, x1111, DegreeRank=>16]',\n'idl111 = module ideal(x0000*x0010*x0100*x0110*x1000*x1010*x1100*x1110, x0000*x0010*x0100*x0110*x1001*x1011*x1101*x1111, x0000*x0010*x0101*x0111*x1000*x1010*x1101*x1111, x0000*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0100*x0111*x1000*x1011*x1100*x1111, x0000*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0110*x1001*x1010*x1101*x1110, x0001*x0010*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0110*x1001*x1011*x1100*x1110, x0001*x0011*x0100*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1010*x1100*x1110, x0001*x0011*x0101*x0111*x1000*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1111)',\n'res111 = res idl111'\n]\n))\n```\nthen I get back an empty string.\nHowever, if I rerun\n\n```python\nmacaulay2.eval('res111 = res idl111')\n```\nin the second case I'll get back the right answer.\n\nI checked that both commands give the correct answers inside macaulay2, so it must be a bug in the bridge.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25903\n\n",
    "created_at": "2018-07-23T03:29:13Z",
    "labels": [
        "component: algebraic geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "strange behavior in macaulay2 bridge",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25666",
    "user": "https://github.com/eulerreich"
}
```
CC:  @mwageringel @slel @dimpase @saliola @antonleykin

If I run 

```python
macaulay2.eval(';'.join([
'R = ZZ/101[x000, x001, x010, x011, x100, x101, x110, x111, DegreeRank=>8]', 
'idl77 = module ideal(x000*x010*x100*x110, x000*x010*x101*x111, x000*x011*x100*x111, x000*x011*x101*x111, x001*x010*x101*x110, x001*x010*x101*x111, x001*x011*x100*x110, x001*x011*x100*x111, x001*x011*x101*x110, x001*x011*x101*x111)', 
'res77 = res idl77']))
```
I get back the correct answer in sage.

```
 10      16      8      1
R   <-- R   <-- R  <-- R  <-- 0
                               
0       1       2      3      4

ChainComplex
```

However if I try a larger ring and ideal,

```python
macaulay2.eval(';'.join([
'R = ZZ/101[x0000, x0001, x0010, x0011, x0100, x0101, x0110, x0111, x1000, x1001, x1010, x1011, x1100, x1101, x1110, x1111, DegreeRank=>16]',
'idl111 = module ideal(x0000*x0010*x0100*x0110*x1000*x1010*x1100*x1110, x0000*x0010*x0100*x0110*x1001*x1011*x1101*x1111, x0000*x0010*x0101*x0111*x1000*x1010*x1101*x1111, x0000*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0100*x0111*x1000*x1011*x1100*x1111, x0000*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0000*x0011*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0110*x1001*x1010*x1101*x1110, x0001*x0010*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0010*x0101*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0110*x1001*x1011*x1100*x1110, x0001*x0011*x0100*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0100*x0111*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0110*x1001*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1010*x1100*x1110, x0001*x0011*x0101*x0111*x1000*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1000*x1011*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1010*x1101*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1100*x1111, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1110, x0001*x0011*x0101*x0111*x1001*x1011*x1101*x1111)',
'res111 = res idl111'
]
))
```
then I get back an empty string.
However, if I rerun

```python
macaulay2.eval('res111 = res idl111')
```
in the second case I'll get back the right answer.

I checked that both commands give the correct answers inside macaulay2, so it must be a bug in the bridge.

Issue created by migration from https://trac.sagemath.org/ticket/25903





---

archive/issue_comments_361675.json:
```json
{
    "body": "Changing keywords from \"\" to \"Macaulay2, interface\".",
    "created_at": "2018-07-24T11:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361675",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "Macaulay2, interface".



---

archive/issue_comments_361676.json:
```json
{
    "body": "See also:\n- #25885 Fixes for outdated Macaulay2 interface",
    "created_at": "2018-07-24T11:44:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361676",
    "user": "https://github.com/slel"
}
```

See also:
- #25885 Fixes for outdated Macaulay2 interface



---

archive/issue_comments_361677.json:
```json
{
    "body": "This happens when the input string sent to eval is longer than 500 characters, as the Macaulay2-Expect interface is configured with the option `eval_using_file_cutoff=500`. This option determines whether the input is pasted into the Macaulay2 REPL directly for short input, or whether it is first written to a file and then loaded into Macaulay2. Loading the file is implemented using the `load` command, which exectues the code, but does not echo the output values in Macaulay2, so this results in an empty string returned by eval.\n\nI tried to replace the `load` command by the `input` command which does echo the output values \u2013 however, it also echoes the input on additional input lines. This makes it rather difficult to handle using the Expect interface as parsing the output stops once it reaches the first input prompt. I could not figure out how to solve this.\n\nThe only way to fix this I can think of would be to add a function to Macaulay2 that just echoes the output of a file.\n\nAs a workaround, you can call `macaulay2(\"res111\")` or call print at the end of your Macaulay2 code like `print res idl111`.",
    "created_at": "2018-07-24T20:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361677",
    "user": "https://github.com/mwageringel"
}
```

This happens when the input string sent to eval is longer than 500 characters, as the Macaulay2-Expect interface is configured with the option `eval_using_file_cutoff=500`. This option determines whether the input is pasted into the Macaulay2 REPL directly for short input, or whether it is first written to a file and then loaded into Macaulay2. Loading the file is implemented using the `load` command, which exectues the code, but does not echo the output values in Macaulay2, so this results in an empty string returned by eval.

I tried to replace the `load` command by the `input` command which does echo the output values – however, it also echoes the input on additional input lines. This makes it rather difficult to handle using the Expect interface as parsing the output stops once it reaches the first input prompt. I could not figure out how to solve this.

The only way to fix this I can think of would be to add a function to Macaulay2 that just echoes the output of a file.

As a workaround, you can call `macaulay2("res111")` or call print at the end of your Macaulay2 code like `print res idl111`.



---

archive/issue_events_064772.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2019-10-07T03:45:19Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25666#event-64772"
}
```



---

archive/issue_comments_361678.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361678",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_361679.json:
```json
{
    "body": "Changing component from algebraic geometry to interfaces: optional.",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361679",
    "user": "https://github.com/mwageringel"
}
```

Changing component from algebraic geometry to interfaces: optional.



---

archive/issue_comments_361680.json:
```json
{
    "body": "Changing keywords from \"Macaulay2, interface\" to \"Macaulay2, interface, IMA Coding Sprint\".",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361680",
    "user": "https://github.com/mwageringel"
}
```

Changing keywords from "Macaulay2, interface" to "Macaulay2, interface, IMA Coding Sprint".



---

archive/issue_comments_361681.json:
```json
{
    "body": "Here is a branch solving this by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output \u2013 this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.\n\nNote that this is only necessary because the Macaulay2 interface in Sage overwrites the prompts, in the first place. In a usual Macaulay2 session, echoed input lines start with `ii` rather than a single `i`:\n\n```\ni1 : input \"testfile.m2\"\n\nii2 : a = 7\n\noo2 = 7\n\nii3 :\n\ni4 :\n```\nHowever, in the current interface, the prompt is overwritten to `_EGAS_` in either case, so it confuses echoed input lines and actual input lines. With this branch, the echoed input lines start with `_EGAS_LOAD_` and get stripped.\n\n---\nNew commits:",
    "created_at": "2019-10-07T03:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361681",
    "user": "https://github.com/mwageringel"
}
```

Here is a branch solving this by using the Macaulay2 function `input` instead of `load` to read in files. With `input`, the results are echoed as desired. However, `input` also echoes the input lines. These echoed input lines need to be stripped from the output – this is accomplished by setting a custom input prompt while reading from a file. The input lines are then stripped in `_post_process_from_file`.

Note that this is only necessary because the Macaulay2 interface in Sage overwrites the prompts, in the first place. In a usual Macaulay2 session, echoed input lines start with `ii` rather than a single `i`:

```
i1 : input "testfile.m2"

ii2 : a = 7

oo2 = 7

ii3 :

i4 :
```
However, in the current interface, the prompt is overwritten to `_EGAS_` in either case, so it confuses echoed input lines and actual input lines. With this branch, the echoed input lines start with `_EGAS_LOAD_` and get stripped.

---
New commits:



---

archive/issue_events_064773.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-01-01T12:27:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "milestone": "sage-9.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25666#event-64773"
}
```



---

archive/issue_events_064774.json:
```json
{
    "actor": "https://github.com/mwageringel",
    "created_at": "2020-01-01T12:27:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "milestone": "sage-9.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25666#event-64774"
}
```



---

archive/issue_comments_361682.json:
```json
{
    "body": "looks good. Sorry for sitting on it for such a long time.",
    "created_at": "2020-01-05T04:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361682",
    "user": "https://github.com/dimpase"
}
```

looks good. Sorry for sitting on it for such a long time.



---

archive/issue_comments_361683.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-01-05T04:59:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361683",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_361684.json:
```json
{
    "body": "No problem. Thank you.",
    "created_at": "2020-01-05T10:10:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361684",
    "user": "https://github.com/mwageringel"
}
```

No problem. Thank you.



---

archive/issue_comments_361685.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-09T23:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25666#issuecomment-361685",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_064775.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-01-09T23:44:38Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25666",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25666#event-64775"
}
```
