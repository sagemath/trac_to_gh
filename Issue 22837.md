# Issue 22837: Allow Python functions in minimize with NCG method

Issue created by migration from Trac.

Original creator: mforets

Original creation time: 2017-05-25 09:17:19

CC:  dimpase

Keywords: minimize

If `algorithm="ncg"` is used in the top-level `minimize` function, one should be able to work with Python functions, as with the other algorithms.


---

Comment by mforets created at 2017-05-25 09:20:23

For instance, this use case is currently broken:


```
sage: f = lambda x : 100*(x[1]-x[0]^2)^2+(1-x[0])^2+100*(x[2]-x[1]^2)^2+(1-x[1])^2
sage: gradient = lambda x : scipy.array([400*(x[0]**2 - x[1])*x[0] + 2*x[0] - 2, \
                                    -200*x[0]**2 + 400*(x[1]**2 - x[2])*x[1] + 202*x[1] - 2, \
                                     -200*x[1]**2 + 200*x[2]])
sage: x0 = [.1,.3,.4]
sage: minimize(f, x0, gradient, algorithm="ncg")
Traceback (most recent call last)
...
UnboundLocalError: local variable 'min' referenced before assignment
```


but it shouldn't, since this works:


```
sage: import scipy
sage: from scipy import optimize
sage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, disp=True)
Optimization terminated successfully.
...
array([ 0.99999732,  0.99999463,  0.99998926])
```


Moreover, the Hessian can also be passed to ncg (but it's optional => docstring is inaccurate)


```
sage: hessian = lambda x : [[1200*x[0]^2 - 400*x[1] + 2, -400*x[0], 0], \
                    [-400*x[0], 1200*x[1]^2 - 400*x[2] + 202, -400*x[1]], \
                    [0, -400*x[1], 200]]
sage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, fhess=hessian, disp=True)
Optimization terminated successfully.
...
array([ 1.,  1.,  1.])
```



---

Comment by mforets created at 2017-05-25 09:22:34

on a separate line, [in the doc](https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize) it says that 

> Only one of hessp or hess needs to be given.

Hence, in the current if clause of `algorithm=="ncg"` one does not need to compute & pass both `hessian` and `hessian_p`, but just one of them, i think.


---

Comment by mforets created at 2017-05-27 17:34:48

Last 10 new commits:


---

Comment by git created at 2017-05-27 18:13:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mforets created at 2017-05-27 18:14:00

Changing status from new to needs_review.


---

Comment by git created at 2017-05-27 18:15:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-02-23 10:10:37

rebased
----
New commits:


---

Comment by git created at 2020-02-23 10:27:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2020-02-23 10:41:00

Some refactorization in progress..


---

Comment by vdelecroix created at 2020-02-23 10:41:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-02-23 10:48:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-02-23 10:49:19

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-02-23 15:05:43

Thanks, looks good.


---

Comment by dimpase created at 2020-02-23 15:05:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-02-24 23:46:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-02-24 23:46:37

On 32-bit:

```
**********************************************************************
File "src/sage/numerical/optimize.py", line 352, in sage.numerical.optimize.?
Failed example:
    minimize(f, [.1, .3, .4], algorithm="ncg") # abs tol 1e-6
Expected:
    (1.0, 1.0, 1.0)
Got:
    (1.0000003254615812, 1.000000652320023, 1.0000013080122123)
Tolerance exceeded in 1 of 3:
    1.0 vs 1.0000013080122123, tolerance 2e-6 > 1e-6
**********************************************************************
1 item had failures:
   1 of  20 in sage.numerical.optimize.?
    [104 tests, 1 failure, 1.15 s]
----------------------------------------------------------------------
sage -t --long src/sage/numerical/optimize.py  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
