# Issue 22837: Allow Python functions in minimize with NCG method

archive/issues_022837.json:
```json
{
    "body": "CC:  dimpase\n\nKeywords: minimize\n\nIf `algorithm=\"ncg\"` is used in the top-level `minimize` function, one should be able to work with Python functions, as with the other algorithms.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23074\n\n",
    "created_at": "2017-05-25T09:17:19Z",
    "labels": [
        "numerical",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Allow Python functions in minimize with NCG method",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22837",
    "user": "mforets"
}
```
CC:  dimpase

Keywords: minimize

If `algorithm="ncg"` is used in the top-level `minimize` function, one should be able to work with Python functions, as with the other algorithms.

Issue created by migration from https://trac.sagemath.org/ticket/23074





---

archive/issue_comments_319344.json:
```json
{
    "body": "For instance, this use case is currently broken:\n\n\n```\nsage: f = lambda x : 100*(x[1]-x[0]^2)^2+(1-x[0])^2+100*(x[2]-x[1]^2)^2+(1-x[1])^2\nsage: gradient = lambda x : scipy.array([400*(x[0]**2 - x[1])*x[0] + 2*x[0] - 2, \\\n                                    -200*x[0]**2 + 400*(x[1]**2 - x[2])*x[1] + 202*x[1] - 2, \\\n                                     -200*x[1]**2 + 200*x[2]])\nsage: x0 = [.1,.3,.4]\nsage: minimize(f, x0, gradient, algorithm=\"ncg\")\nTraceback (most recent call last)\n...\nUnboundLocalError: local variable 'min' referenced before assignment\n```\n\n\nbut it shouldn't, since this works:\n\n\n```\nsage: import scipy\nsage: from scipy import optimize\nsage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, disp=True)\nOptimization terminated successfully.\n...\narray([ 0.99999732,  0.99999463,  0.99998926])\n```\n\n\nMoreover, the Hessian can also be passed to ncg (but it's optional => docstring is inaccurate)\n\n\n```\nsage: hessian = lambda x : [[1200*x[0]^2 - 400*x[1] + 2, -400*x[0], 0], \\\n                    [-400*x[0], 1200*x[1]^2 - 400*x[2] + 202, -400*x[1]], \\\n                    [0, -400*x[1], 200]]\nsage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, fhess=hessian, disp=True)\nOptimization terminated successfully.\n...\narray([ 1.,  1.,  1.])\n```\n",
    "created_at": "2017-05-25T09:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319344",
    "user": "mforets"
}
```

For instance, this use case is currently broken:


```
sage: f = lambda x : 100*(x[1]-x[0]^2)^2+(1-x[0])^2+100*(x[2]-x[1]^2)^2+(1-x[1])^2
sage: gradient = lambda x : scipy.array([400*(x[0]**2 - x[1])*x[0] + 2*x[0] - 2, \
                                    -200*x[0]**2 + 400*(x[1]**2 - x[2])*x[1] + 202*x[1] - 2, \
                                     -200*x[1]**2 + 200*x[2]])
sage: x0 = [.1,.3,.4]
sage: minimize(f, x0, gradient, algorithm="ncg")
Traceback (most recent call last)
...
UnboundLocalError: local variable 'min' referenced before assignment
```


but it shouldn't, since this works:


```
sage: import scipy
sage: from scipy import optimize
sage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, disp=True)
Optimization terminated successfully.
...
array([ 0.99999732,  0.99999463,  0.99998926])
```


Moreover, the Hessian can also be passed to ncg (but it's optional => docstring is inaccurate)


```
sage: hessian = lambda x : [[1200*x[0]^2 - 400*x[1] + 2, -400*x[0], 0], \
                    [-400*x[0], 1200*x[1]^2 - 400*x[2] + 202, -400*x[1]], \
                    [0, -400*x[1], 200]]
sage: optimize.fmin_ncg(f, [float(_) for _ in x0], fprime=gradient, fhess=hessian, disp=True)
Optimization terminated successfully.
...
array([ 1.,  1.,  1.])
```




---

archive/issue_comments_319345.json:
```json
{
    "body": "on a separate line, [in the doc](https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize) it says that \n\n> Only one of hessp or hess needs to be given.\n\nHence, in the current if clause of `algorithm==\"ncg\"` one does not need to compute & pass both `hessian` and `hessian_p`, but just one of them, i think.",
    "created_at": "2017-05-25T09:22:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319345",
    "user": "mforets"
}
```

on a separate line, [in the doc](https://docs.scipy.org/doc/scipy-0.19.0/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize) it says that 

> Only one of hessp or hess needs to be given.

Hence, in the current if clause of `algorithm=="ncg"` one does not need to compute & pass both `hessian` and `hessian_p`, but just one of them, i think.



---

archive/issue_comments_319346.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2017-05-27T17:34:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319346",
    "user": "mforets"
}
```

Last 10 new commits:



---

archive/issue_comments_319347.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-27T18:13:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319347",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319348.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-05-27T18:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319348",
    "user": "mforets"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_319349.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-05-27T18:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319349",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319350.json:
```json
{
    "body": "rebased\n----\nNew commits:",
    "created_at": "2020-02-23T10:10:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319350",
    "user": "vdelecroix"
}
```

rebased
----
New commits:



---

archive/issue_comments_319351.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-02-23T10:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319351",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_319352.json:
```json
{
    "body": "Some refactorization in progress..",
    "created_at": "2020-02-23T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319352",
    "user": "vdelecroix"
}
```

Some refactorization in progress..



---

archive/issue_comments_319353.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-23T10:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319353",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_319354.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-23T10:48:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319354",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_319355.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-23T10:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319355",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_319356.json:
```json
{
    "body": "Thanks, looks good.",
    "created_at": "2020-02-23T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319356",
    "user": "dimpase"
}
```

Thanks, looks good.



---

archive/issue_comments_319357.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-02-23T15:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319357",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_319358.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-02-24T23:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319358",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_319359.json:
```json
{
    "body": "On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/numerical/optimize.py\", line 352, in sage.numerical.optimize.?\nFailed example:\n    minimize(f, [.1, .3, .4], algorithm=\"ncg\") # abs tol 1e-6\nExpected:\n    (1.0, 1.0, 1.0)\nGot:\n    (1.0000003254615812, 1.000000652320023, 1.0000013080122123)\nTolerance exceeded in 1 of 3:\n    1.0 vs 1.0000013080122123, tolerance 2e-6 > 1e-6\n**********************************************************************\n1 item had failures:\n   1 of  20 in sage.numerical.optimize.?\n    [104 tests, 1 failure, 1.15 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/numerical/optimize.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2020-02-24T23:46:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319359",
    "user": "vbraun"
}
```

On 32-bit:

```
**********************************************************************
File "src/sage/numerical/optimize.py", line 352, in sage.numerical.optimize.?
Failed example:
    minimize(f, [.1, .3, .4], algorithm="ncg") # abs tol 1e-6
Expected:
    (1.0, 1.0, 1.0)
Got:
    (1.0000003254615812, 1.000000652320023, 1.0000013080122123)
Tolerance exceeded in 1 of 3:
    1.0 vs 1.0000013080122123, tolerance 2e-6 > 1e-6
**********************************************************************
1 item had failures:
   1 of  20 in sage.numerical.optimize.?
    [104 tests, 1 failure, 1.15 s]
----------------------------------------------------------------------
sage -t --long src/sage/numerical/optimize.py  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_319360.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319360",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_319361.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319361",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_319362.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22837",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22837#issuecomment-319362",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
