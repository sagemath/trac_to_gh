# Issue 12483: Update PolyBoRi to release 0.8.1

Issue created by migration from https://trac.sagemath.org/ticket/12655

Original creator: AlexanderDreyer

Original creation time: 2012-03-12 15:07:10

Assignee: AlexanderDreyer

CC:  polybori malb burcin

PolyBoRi's next minor release will be out soon.
There were no changes of the interface between PolyBoRi 0.8.0 and 0.8.1, so we just have to update the sources from here:

https://sourceforge.net/projects/polybori/files/polybori/0.8.1rc


---

Comment by AlexanderDreyer created at 2012-03-12 15:17:03

The first experiment is here http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1rc3.p0.spkg


---

Comment by AlexanderDreyer created at 2012-03-12 15:17:30

Changing status from new to needs_review.


---

Comment by AlexanderDreyer created at 2012-03-12 15:52:28

Even though the spkg works without a patch to the sage library, I recommend to use the patch from #12656, also. It fixed inconsistencies between the original interface and Sage's Cython-bases reimplementation.


---

Comment by AlexanderDreyer created at 2012-03-12 15:57:42

For sage-5.0.beta7 (with #12656) the spkg installs and tests well (`make ptestlong`) on a SuSE Enterprise 11 AMD64.


---

Comment by AlexanderDreyer created at 2012-03-12 22:10:12

Also works without #12656 (not recommended).


---

Comment by malb created at 2012-03-13 23:43:30

I can confirm that doctests pass on geom.math with 5.0.beta8.


---

Comment by AlexanderDreyer created at 2012-03-14 14:10:08

Here's an updates spkg.
http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1rc5.p0.spkg
Note: upstream PolyBoRi can detect and use Sage (if available), so we do not have to patch PyPolyBoRi.py every time again and again.


---

Comment by malb created at 2012-03-14 14:52:04

Since it's still an RC, do we aim for 'positive review' already?


---

Comment by AlexanderDreyer created at 2012-03-14 15:18:52

Replying to [comment:8 malb]:
> Since it's still an RC, do we aim for 'positive review' already?
It should be final now, but I'd like to wait for response from non-Linux people. Maybe you can give a conditional review for the case, the spkg doesn't change any more. (There's no rc5 marker inside the spkg, so we just have to rename it, if we are lucky.)


---

Comment by malb created at 2012-03-14 15:22:18

Sounds like a plan. conditional positive review it is :)


---

Comment by AlexanderDreyer created at 2012-03-15 23:52:21

Unfortunately, I had to rebundle the spkg, because the directory name contained rc5 (D'Oh!).
Here is the updated spkg: http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1.p0.spkg
Also, there is one last-minute change in the source (not doctesting optional polybori.plot, if prerequsite `dot` is not available):
https://bitbucket.org/brickenstein/polybori/changeset/b3a12752980c

The recent spkg installed on SuSE11 AMD64 and OS X 10.5 ppc. make ptestlong succeeded on SuSE (OS X still running.)


---

Comment by malb created at 2012-03-16 12:18:45

Changing status from needs_review to positive_review.


---

Comment by malb created at 2012-03-16 12:18:45

Hey, I checked the SPKG for obvious problems and it looks clean. I didn't install it again and ran tests, but those the buildbot can figure out. So: positive review.


---

Comment by AlexanderDreyer created at 2012-03-16 22:36:36

Finally, the rc became release, indeed!


---

Comment by jdemeyer created at 2012-03-20 16:12:30

It is recommended to use `patch` for patching SPKGs, see [http://sagemath.org/doc/developer/patching_spkgs.html](http://sagemath.org/doc/developer/patching_spkgs.html).  If not, at least add a corresponding `.patch` file for `custom.py`.

I'm not setting this ticket back to needs_work for this but it [SHOULD](http://www.ietf.org/rfc/rfc2119.txt) be fixed.


---

Comment by AlexanderDreyer created at 2012-03-20 21:14:51

Replying to [comment:14 jdemeyer]:
> It is recommended to use `patch` for patching SPKGs, see [http://sagemath.org/doc/developer/patching_spkgs.html](http://sagemath.org/doc/developer/patching_spkgs.html).  If not, at least add a corresponding `.patch` file for `custom.py`.
A patch might become part of upstream sources eventually.
But `custom.py` is a user configuration file, which will never be upstream itself (of course the mechanism already supported there). 
Of course, we can generate a patch against `/dev/null`. but does it really makes sense?


---

Comment by AlexanderDreyer created at 2012-03-20 21:31:02

Replying to [comment:15 AlexanderDreyer]:
> Of course, we can generate a patch against `/dev/null`. but does it really makes sense?
Ok, answering myself: it's part of the directory `patch`, so of course one should consider it as a patch to upstream. There's no `config` directory mention here http://sagemath.org/doc/developer/producing_spkgs.html , so patching is the only option here.


---

Comment by AlexanderDreyer created at 2012-03-20 22:38:36

The updated spkg is now here:
http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1.p0.spkg
Also, I added two minor fixes from upstream. One fixes a preprocessor misconception (`#if` instead of `#ifdef`, and the other fixes a doctest prerequisites check, which prevented `ipbori`'s self test to check `polybori.plot`.

So, unfortunately we need a review again.


---

Comment by AlexanderDreyer created at 2012-03-20 22:38:36

Changing status from positive_review to needs_work.


---

Comment by AlexanderDreyer created at 2012-03-20 22:38:49

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2012-03-21 00:22:09

I agree that "custom.py" is not a patch to upstream in any way. It is a custom configuration and there is nothing in it that couldn't be actually be shifted in spkg-install. Putting it in custom.py probably keep things cleaner. If you don't want to pollute the patch folder could we consider putting it in the spkg root directory?


---

Comment by jdemeyer created at 2012-03-21 07:29:28

Replying to [comment:19 fbissey]:
> If you don't want to pollute the patch folder could we consider putting it in the spkg root directory?
I agree with this.  I saw the file in `patches/` and assumed it was a patch to some existing PolyBoRi file.  If it's not a patch, it doesn't belong in `patches/`.


---

Comment by AlexanderDreyer created at 2012-03-21 09:19:37

Ok,  I moved `custom.py` to the spkg root. The spkg-install is now more generic: it takes any `*.patch`es in `patches` and apply them to the sources. The updated spkg is at the ususal place.


---

Comment by AlexanderDreyer created at 2012-03-21 09:54:57

Replying to [comment:20 jdemeyer]:
> Replying to [comment:19 fbissey]:
> > If you don't want to pollute the patch folder could we consider putting it in the spkg root directory?
> I agree with this.  I saw the file in `patches/` and assumed it was a patch to some existing PolyBoRi file.  If it's not a patch, it doesn't belong in `patches/`.
I fixed that, so the package needs a new review.


---

Comment by fbissey created at 2012-03-21 21:06:44

Sorry to be a little bit annoying. Now that custom.py is in the root folder of the spkg could you add a "special files" section to SPKG.txt, list custom.py and explain what it is.


---

Comment by AlexanderDreyer created at 2012-03-21 21:47:11

Replying to [comment:23 fbissey]:
> Sorry to be a little bit annoying. Now that custom.py is in the root folder of the spkg could you add a "special files" section to SPKG.txt, list custom.py and explain what it is.
No problem! You'll find an updated spkg at the usual place.


---

Comment by jdemeyer created at 2012-03-22 09:29:59

Looks good to me.


---

Comment by jdemeyer created at 2012-03-22 09:29:59

Changing status from needs_review to positive_review.


---

Comment by malb created at 2012-03-22 13:42:37

We found a bug and have a fix, see: 
http://sourceforge.net/mailarchive/forum.php?thread_name=4F6B130B.5060503%40itwm.fraunhofer.de&forum_name=polybori-discuss


---

Comment by malb created at 2012-03-22 13:42:37

Changing status from positive_review to needs_work.


---

Comment by AlexanderDreyer created at 2012-03-22 16:31:04

Hi, 
I updated the spkg. Please have a look at it.


---

Comment by AlexanderDreyer created at 2012-03-22 16:31:04

Changing status from needs_work to needs_review.


---

Comment by malb created at 2012-03-22 21:23:51

Changing status from needs_review to positive_review.


---

Comment by malb created at 2012-03-22 21:23:51

Back to positive review. Thanks!


---

Comment by jhpalmieri created at 2012-03-27 19:19:49

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2012-03-27 19:19:49

At least in combination with #12369, this fails to build on OpenSolaris on x86 (David Kirkby's machine hawk): it gives me

```
scons: done reading SConscript files.
scons: Building targets ...
writing config.h...
gcc -o Cudd/cudd/cuddAPI.pic.o -c -std=c99 -O3 -Wno-long-long -Wreturn-type -g -fPIC -mmmx -msse -msse2 -msse3 -g -fPIC -Wall -pedantic -O2 -KPIC -DPBORI_NDEBUG -DSIZEOF_VOID_P=4 -DSIZEOF_INT=4 -DSIZEOF_LONG=4 -DPBORI_HAVE_GD -DPBORI_HAVE_TR1_UNORDERED_MAP -DPBORI_HAVE_M4RI -Ilibpolybori/include -Igroebner/include -I/export/home/palmieri/testing/GCC-no-check/sage-5.0.beta10-gcc/local/include -I/export/home/palmieri/testing/GCC-no-check/sage-5.0.beta10-gcc/local/include/python2.7 -ICudd Cudd/cudd/cuddAPI.c
gcc: error: unrecognized option ‘-KPIC’
scons: *** [Cudd/cudd/cuddAPI.pic.o] Error 1
```

In contrast, the 0.8.0.p1 spkg builds fine.

On Solaris on sparc (mark2), in combination with #12369, I get this:

```
Starting build...
Removing old PolyBoRi install...
Done removing old PolyBoRi install.
Running build_polybori...
scons: Reading SConscript files ...
Platform:  sunos5
Variable LIBSUFFIX not in default environment!
Platform:  sunos5
Detecting type sizes... no
Could not detect type sizes (maybe compile/link flags trouble)! Exiting.
```



---

Comment by AlexanderDreyer created at 2012-03-27 22:26:06

Thanks, I think I found the issue. Please try out the following:
http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1.p1.spkg

Note: I updated the spkg from #12754 which already fixed other things (for instance gcc-4.7 compatibility.)


---

Comment by AlexanderDreyer created at 2012-03-27 22:26:06

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2012-03-27 22:47:46

With this package, on both Solaris and OpenSolaris, I get this:

```
Starting build...
Removing old PolyBoRi install...
Done removing old PolyBoRi install.
Running build_polybori...
scons: Reading SConscript files ...
NameError: name 'CCFLAGS' is not defined:
  File "/export/home/palmieri/testing/sage-5.0.beta7-gcc/spkg/build/polybori-0.8.1.p1/src/polybori-0.8.1/SConstruct", line 241:
    if is_gcc():
  File "/export/home/palmieri/testing/sage-5.0.beta7-gcc/spkg/build/polybori-0.8.1.p1/src/polybori-0.8.1/SConstruct", line 239:
    compilerenv = Environment(ENV = os.environ, options = opts)
  File "/export/home/palmieri/testing/sage-5.0.beta7-gcc/local/lib/scons-1.2.0/SCons/Environment.py", line 975:
    variables.Update(self)
  File "/export/home/palmieri/testing/sage-5.0.beta7-gcc/local/lib/scons-1.2.0/SCons/Variables/__init__.py", line 169:
    execfile(filename, {}, values)
  File "custom.py", line 6:
    CCFLAGS += ["-Wno-long-long", "-Wreturn-type"]
Error building PolyBoRi.
```

Should `CCFLAGS` be `CFLAGS`?  If I fix this, I get a similar error for `GD_LIBS`. I ended up applying the following patch:

```diff
diff --git a/custom.py b/custom.py
--- a/custom.py
+++ b/custom.py
@@ -1,13 +1,15 @@
 import os
 import sys
 
-# FIXME: Do we really want to *overwrite* the flags (e.g. if set by the user)?
-# Answer: Should be fixed now.
-CCFLAGS += ["-Wno-long-long", "-Wreturn-type"]
-
 # Note: PolyBoRi still appends DEFAULT_*FLAGS (overwrite those, if necessary)
 if 'CFLAGS' in os.environ:
   CFLAGS = os.environ['CFLAGS'].split(' ')
+else:
+  CFLAGS = []
+
+# FIXME: Do we really want to *overwrite* the flags (e.g. if set by the user)?
+# Answer: Should be fixed now.
+CFLAGS += ["-Wno-long-long", "-Wreturn-type"]
 
 if 'CXXFLAGS' in os.environ:
   CXXFLAGS = os.environ['CXXFLAGS'].split(' ')
@@ -15,6 +17,11 @@
 if 'CPPFLAGS' in os.environ:
   CCFLAGS = os.environ['CPPFLAGS'].split(' ')
 
+if 'GD_LIBS' in os.environ:
+  GD_LIBS = os.environ['GD_LIBS'].split(' ')
+else:
+  GD_LIBS = []
+
 GD_LIBS+=["png12","z"]
 
 # FIXME: Should we include LDFLAGS here? (see above)
```

The spkg-install file is odd, though: some places it refers to `CFLAGS`, others to `CCFLAGS`, so I'm not sure my changes are correct. In any case, it worked on OpenSolaris, but on Solaris I got the same error as before ("Could not detect type sizes"). This may be related to #12369.


---

Comment by AlexanderDreyer created at 2012-03-27 23:07:10

Replying to [comment:31 jhpalmieri]:
> With this package, on both Solaris and OpenSolaris, I get this:
> Should `CCFLAGS` be `CFLAGS`?  If I fix this, I get a similar error for `GD_LIBS`. I ended up applying the following patch:
Sorry, I made a mistake. I did not have a recent Sage at hand on Solaris, so I tried that out without custom.py. (I need to fix that upstream again. Your patch is a good work around.)

> The spkg-install file is odd, though: some places it refers to `CFLAGS`, others to `CCFLAGS`, so I'm not sure my changes are correct.
CFLAGS are flags for pure C, CCFLAGS for C or C++.
> In any case, it worked on OpenSolaris, but on Solaris I got the same error as before ("Could not detect type sizes"). This may be related to #12369.
There a file called config.log. Can you post it somewhere?


---

Comment by AlexanderDreyer created at 2012-03-27 23:10:10

> Sorry, I made a mistake. I did not have a recent Sage at hand on Solaris, so I tried that out without custom.py. (I need to fix that upstream again. Your patch is a good work around.)
But the CCFLAGS should still be there, for instance:

CCFLAGS = ["-O3", "-Wno-long-long", "-Wreturn-type"]


---

Comment by jhpalmieri created at 2012-03-27 23:53:13

If I add a print statement at the top of custom.py ("print CCFLAGS"), then on OS X or sage.math, I see `['-O3']`. On OpenSolaris, I get a NameError saying that CCFLAGS is not defined.

With Solaris (skynet machine mark2), the entire contents of config.log:

```
file /home/palmieri/mark2/GCC/sage-5.0.beta10-gcc/spkg/build/polybori-0.8.1.p1/src/polybori-0.8.1/SConstruct,line 653:
        Configure(confdir = .sconf_temp)
scons: Configure: Detecting type sizes... 
.sconf_temp/conftest_0.c <-
  |
  |        #include <stdio.h>
  |        int main(int argc, char **argv) {
  |          printf("SIZEOF_VOID_P=%u SIZEOF_INT=%u SIZEOF_LONG=%u",
  |            (unsigned)sizeof(void*), (unsigned)sizeof(int), (unsigned)sizeof(long));
  |          return 0;
  |        }
  |        
gcc -o .sconf_temp/conftest_0.o -c -Wno-long-long -Wreturn-type -std=c99 -O3 -DPBORI_NDEBUG -I/home/palmieri/mark2/GCC/sage-5.0.beta10-gcc/local/include .sconf_temp/conftest_0.c
gcc -o .sconf_temp/conftest_0 -Wl,-rpath=\$ORIGIN/../build/usr/local/lib -z origin .sconf_temp/conftest_0.o -L/home/palmieri/mark2/GCC/sage-5.0.beta10-gcc/local/lib
ld: fatal: option -dn and -P are incompatible
ld: fatal: Flags processing errors
collect2: ld returned 1 exit status
scons: Configure: no
```



---

Comment by jdemeyer created at 2012-03-28 06:46:15

Replying to [comment:32 AlexanderDreyer]:
> CFLAGS are flags for pure C, CCFLAGS for C or C++.
I don't think this is standard usage.  Normally, one uses CFLAGS for C and CXXFLAGS for C++.  Of course, you can additionally support CCFLAGS if you want.


---

Comment by AlexanderDreyer created at 2012-03-28 09:28:41

Replying to [comment:35 jdemeyer]:
> Replying to [comment:32 AlexanderDreyer]:
> > CFLAGS are flags for pure C, CCFLAGS for C or C++.
> I don't think this is standard usage.  Normally, one uses CFLAGS for C and CXXFLAGS for C++.  Of course, you can additionally support CCFLAGS if you want.
Well, that's not my idea, that's `scons`' standard. But I use CCFLAGS only internally (for instance for storing `CPPFLAGS` from the environment.


---

Comment by AlexanderDreyer created at 2012-03-28 09:33:27

Replying to [comment:34 jhpalmieri]:
> If I add a print statement at the top of custom.py ("print CCFLAGS"), then on OS X or sage.math, I see `['-O3']`. On OpenSolaris, I get a NameError saying that CCFLAGS is not defined.
> 
> With Solaris (skynet machine mark2), the entire contents of config.log:
> {{{
> ld: fatal: option -dn and -P are incompatible
> ld: fatal: Flags processing errors
> collect2: ld returned 1 exit status
> scons: Configure: no
> }}}
Ok, that's arising from `-rpath`, As I understand it must be `-R` for the Solaris-linker. I'll provide a patch for that.


---

Comment by jdemeyer created at 2012-03-28 09:35:34

Replying to [comment:37 AlexanderDreyer]:
> Well, that's not my idea, that's `scons`' standard.
Not the first strange idea from the SCons developers... (honestly, if I encounter a SCons developer on the street, I'd like to punch him in the face)


---

Comment by AlexanderDreyer created at 2012-03-28 22:33:13

There's an updated spkg at the usual place: 
http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1.p1.spkg

Please have a look at it.


---

Comment by jhpalmieri created at 2012-03-28 22:51:49

On OpenSolaris: it seems to build correctly. I haven't done any testing, though.

On Solaris:

```
Running build_polybori...
scons: Reading SConscript files ...
Platform:  sunos5
Platform:  sunos5
ValueError: list.remove(x): x not in list:
  File "/home/palmieri/mark2/GCC/sage-5.0.beta10-gcc/spkg/build/polybori-0.8.1.p1/src/polybori-0.8.1/SConstruct", line 472:
    tools.remove(arg)
```



---

Comment by AlexanderDreyer created at 2012-03-28 23:32:22

Replying to [comment:41 jhpalmieri]:
> On OpenSolaris: it seems to build correctly. I haven't done any testing, though.
> 
> On Solaris:
> {{{

> ValueError: list.remove(x): x not in list:
>   File "/home/palmieri/mark2/GCC/sage-5.0.beta10-gcc/spkg/build/polybori-0.8.1.p1/src/polybori-0.8.1/SConstruct", line 472:
>     tools.remove(arg)
> }}}
Ok, a plain typo. Please try our gain.


---

Comment by jhpalmieri created at 2012-03-29 00:57:39

Okay, this works now on Solaris.


---

Comment by AlexanderDreyer created at 2012-03-29 07:54:32

So back to positive review again? (I add a dependency on #12754, since I used the spkg from there, and ot formally still needs a positive review.)


---

Comment by AlexanderDreyer created at 2012-03-29 08:58:36

Changing component from algebra to packages.


---

Comment by jdemeyer created at 2012-04-02 07:37:25

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-04-02 07:37:25

I think SPKG.txt needs some work:
 1. The Changelog messages don't tell much.  If you add a patch, you should mention that fact in the Changelog.  You should add a ticket number in the Changelog messages.
 2. The patches should be documented.


---

Comment by AlexanderDreyer created at 2012-04-02 19:02:08

Replying to [comment:51 jdemeyer]:
> I think SPKG.txt needs some work:
>  1. The Changelog messages don't tell much.  If you add a patch, you should mention that fact in the Changelog.  You should add a ticket number in the Changelog messages.
>  2. The patches should be documented.

No problem, I'll add this:


```
 #!diff
diff -r f4822b70da5b SPKG.txt           
--- a/SPKG.txt  Thu Mar 29 01:28:08 2012 +0200
+++ b/SPKG.txt  Mon Apr 02 20:59:48 2012 +0200
@@ -36,17 +36,35 @@                           
  * png/libpng12 (accomplished because Python and gd depend on it, too)
  * libz         (accomplished because e.g. libpng depends on it)      
                                                                       
+== Patches ==                                                         
+                                                                      
+ * Sage Trac #12655 (Upgrade ticket, fixing known issues):            
+   - gbcore.py.patch -- Fixing list access to ideal, which might be represented
+     as a set here                                                             
+   - ipbori.patch -- Fixing prerequisites check for testing plot.py            
+   - nf.h.patch -- Fixing preprocessor misconception                           
+ * Sage Trac #12750:                                                           
+   - base_lookup.patch -- Fixing explict name lookup in template base (gcc 4.7)
+ * Sage Trac #12655, comment:29:
+   - SConstruct.patch -- Fixing gcc components on sun
+
+All patches were merged upstream.
+
+
 == Special Files ==
+
  * custom.py - configuration file for PolyBoRi's build system,
                sets local prefix and install paths to Sage directories

+
 == Releases ==

 === polybori-0.8.1.p1 (Alexander Dreyer, March 26th, 2012) ===
- * Rebased spkg on polybori-0.8.0.p2, work around broken scons on sun
+ * Rebased spkg on polybori-0.8.0.p2 (Sage Trac #12750)
+ * Working around broken scons on sun (Sage Trac #12655, comment:29)

 === polybori-0.8.1.p0 (Alexander Dreyer, March 7th, 2012) ===
- * Updating sources to PolyBoRi's release 0.8.1
+ * Updating sources to PolyBoRi's release 0.8.1 (Sage Trac #12655)

 === polybori-0.8.0.p2 (Alexander Dreyer, March 26th, 2012) ===
  * Fix scoping/name look-up issue and support flags from the environment

```



---

Comment by AlexanderDreyer created at 2012-04-02 19:14:36

Now, the new spkg is uploaded at the usual place: http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1.p1.spkg .


---

Comment by leif created at 2012-04-02 23:53:09

`module_list.py` certainly needs work w.r.t. dependencies.

After installing the new PolyBoRi spkg and running `env SAGE_UPGRADING=yes make build` (which reinstalls the Sage library as well as GAP and sagetex), I get dozens of import errors from Sphinx (since `ptestlong` depends on `doc` -- never understood why we have to build HTML documentation to run tests...).

Note that `local/bin/sage-starts` seemed to have succeeded, but in fact it was `[ -f local/lib/sage-started.txt ]` that did; i.e., _of course_ also Sage doesn't start up.

That's because a couple of Sage library extension modules didn't get rebuilt, still referring to the old, deleted PolyBoRi shared library.


---

Comment by leif created at 2012-04-03 00:33:29

I also noticed that (e.g.) `-O3` in `C/CPP/CXXFLAGS` gets overridden by `-O2`, but the latter apparently originates from M4RI's `m4ri_config.h`, i.e. `__M4RI_CFLAGS`.

Is it intentional to use _all of them_ in _all_ compile commands?  (These are btw. also passed to `g++` when compiling C++ sources.)




Furthermore, it's quite funny to use `g++ -std=c++98` while using `long long`; I get hundreds of warnings for that, since `-Wall` is also there, but not `-Wno-long-long`.  (`-Wall` comes from M4RI's `CFLAGS` as well.)


---

Comment by leif created at 2012-04-03 00:49:14

After running `./sage -ba-force`, `make ptestlong` passes all tests (Sage 5.0.beta11, Ubuntu 12.04 beta x86_64, self-made GCC 4.6.3).


---

Comment by leif created at 2012-04-03 06:04:11

Replying to [comment:54 leif]:
> `module_list.py` certainly needs work w.r.t. dependencies.
>  [...]
> That's because a couple of Sage library extension modules didn't get rebuilt, still referring to the old, deleted PolyBoRi shared library.

Actually only the `pbori` module needs to get rebuilt; while `touch`ing `$SAGE_LOCAL/include/polybori.h` doesn't help, touching `$SAGE_LOCAL/include/polybori/*` does (afterwards running `./sage -b`).




Also builds with GCC 4.7.0 (Sage 5.0.beta10, Ubuntu 10.04.4 x86_64).

I noticed that different flags get passed to `gcc`/`g++` depending on GCC's version, or probably the settings of `CC` and `CXX`.  Seems rather a side-effect than intended behaviour...

W.r.t. M4RI's flags:  It should be sufficient to only pass / add the contents of `__M4RI_SIMD_CFLAGS`, and probably only when compiling _some_ of the modules.


---

Comment by AlexanderDreyer created at 2012-04-03 08:37:52

Replying to [comment:55 leif]:
> I also noticed that (e.g.) `-O3` in `C/CPP/CXXFLAGS` gets overridden by `-O2`, but the latter apparently originates from M4RI's `m4ri_config.h`, i.e. `__M4RI_CFLAGS`.
> 
> Is it intentional to use _all of them_ in _all_ compile commands?  (These are btw. also passed to `g++` when compiling C++ sources.)
Otherwise you might get inconsistencies.

> 

> 
> Furthermore, it's quite funny to use `g++ -std=c++98` while using `long long`; I get hundreds of warnings for that, since `-Wall` is also there, but not `-Wno-long-long`.  (`-Wall` comes from M4RI's `CFLAGS` as well.)
`long long` arises from M4RI, but M4RI assumes C99 which knows `long long`. But this is a known problem, I'll add `-Wno-long-long` back to the custom flags in the spkg. (I removed it, because `PolyBoRi` 0.8.1 was improved to be compatible wit c++98.)


---

Comment by AlexanderDreyer created at 2012-04-03 08:39:57

Replying to [comment:57 leif]:
> Replying to [comment:54 leif]:
> > `module_list.py` certainly needs work w.r.t. dependencies.
> >  [...]
> > That's because a couple of Sage library extension modules didn't get rebuilt, still referring to the old, deleted PolyBoRi shared library.
> 
> Actually only the `pbori` module needs to get rebuilt; while `touch`ing `$SAGE_LOCAL/include/polybori.h` doesn't help, touching `$SAGE_LOCAL/include/polybori/*` does (afterwards running `./sage -b`).
I'll add this to the spkg.

> Also builds with GCC 4.7.0 (Sage 5.0.beta10, Ubuntu 10.04.4 x86_64).
> 
> I noticed that different flags get passed to `gcc`/`g++` depending on GCC's version, or probably the settings of `CC` and `CXX`.  Seems rather a side-effect than intended behaviour...
> 
> W.r.t. M4RI's flags:  It should be sufficient to only pass / add the contents of `__M4RI_SIMD_CFLAGS`, and probably only when compiling _some_ of the modules.
This is not related to the upgrade, so I'd prefer a new ticket on this.


---

Comment by AlexanderDreyer created at 2012-04-03 14:10:10

Replying to [comment:55 leif]:
> Furthermore, it's quite funny to use `g++ -std=c++98` while using `long long`; I get hundreds of warnings for that, since `-Wall` is also there, but not `-Wno-long-long`.  (`-Wall` comes from M4RI's `CFLAGS` as well.)
I double-checked that. Per default the spkg sets `-Wno-long-long`, It's probably overwritten by some C...FLAGS. Should I block `-Wno-long-long` such that it is never overwritten by the environment (like `-std=c++98`)?


---

Comment by AlexanderDreyer created at 2012-04-03 14:17:45

Changing status from needs_work to needs_info.


---

Comment by AlexanderDreyer created at 2012-04-03 14:17:45

Replying to [comment:58 leif]:
This issue is now #12799.


---

Comment by jdemeyer created at 2012-04-03 14:53:11

Replying to [comment:60 AlexanderDreyer]:
> > Actually only the `pbori` module needs to get rebuilt; while `touch`ing `$SAGE_LOCAL/include/polybori.h` doesn't help, touching `$SAGE_LOCAL/include/polybori/*` does (afterwards running `./sage -b`).
> I'll add this to the spkg.
I think it's better to change `module_list.py` instead of the spkg.


---

Comment by AlexanderDreyer created at 2012-04-03 19:08:13

Replying to [comment:63 jdemeyer]:
> I think it's better to change `module_list.py` instead of the spkg.
This part is now #12799, so I add this as dependency and remove the work issue.

I also updated the spkg to use `-Wno-long-long` for C++ here: http://boxen.math.washington.edu/home/dreyer/spkg/polybori-0.8.1.p1.spkg


---

Comment by AlexanderDreyer created at 2012-04-03 19:08:13

Changing status from needs_info to needs_review.


---

Comment by AlexanderDreyer created at 2012-04-03 19:26:19

Replying to [comment:57 leif]: 
> W.r.t. M4RI's flags:  It should be sufficient to only pass / add the contents of `__M4RI_SIMD_CFLAGS`, and probably only when compiling _some_ of the modules.
`@`malb What do you think: Would this be enough?


---

Comment by leif created at 2012-04-03 20:13:07

Replying to [comment:63 jdemeyer]:
> Replying to [comment:60 AlexanderDreyer]:
> > > Actually only the `pbori` module needs to get rebuilt; while `touch`ing `$SAGE_LOCAL/include/polybori.h` doesn't help, touching `$SAGE_LOCAL/include/polybori/*` does (afterwards running `./sage -b`).
> > I'll add this to the spkg.
> I think it's better to change `module_list.py` instead of the spkg.

IIRC the problem isn't only _which_ files the `pbori` module depends on, but also that the headers have their original file date from upstream, i.e., aren't generated during build nor (currently) `touch`ed from `spkg-install`, such that they'll usually be older than a present `pbori` module.

If one doesn't want to change the timestamps, one could make the `pbori` module just (or also) depend on the `.so` (without a version suffix), since the (target of the) latter will always have a fresh modification time.


---

Comment by AlexanderDreyer created at 2012-04-03 20:29:39

Replying to [comment:66 leif]:
> If one doesn't want to change the timestamps, one could make the `pbori` module just (or also) depend on the `.so` (without a version suffix), since the (target of the) latter will always have a fresh modification time.
The libraries are already listed as `libraries=['polybori', 'polybori_groebner', 'gd', 'png12', 'm4ri']`. Aren't they considered as dependencies anyway?

But the timestamp of `include/polybori/config.h` varies, so #12799 fixes the problem.


---

Comment by leif created at 2012-04-03 20:55:33

Replying to [comment:67 AlexanderDreyer]:
> Replying to [comment:66 leif]:
> > If one doesn't want to change the timestamps, one could make the `pbori` module just (or also) depend on the `.so` (without a version suffix), since the (target of the) latter will always have a fresh modification time.
> The libraries are already listed as `libraries=['polybori', 'polybori_groebner', 'gd', 'png12', 'm4ri']`. Aren't they considered as dependencies anyway?

Of course the libraries are listed, since they need to get linked to the module, but Cython doesn't automatically consider _their_ timestamps for dependency checking, i.e., which modules need to get rebuilt.




> But the timestamp of `include/polybori/config.h` varies, so #12799 fixes the problem.

Then I'd add just that there.


---

Comment by AlexanderDreyer created at 2012-04-03 21:20:58

Replying to [comment:68 leif]:
> Then I'd add just that there.
Done. Is this ticket positively reviewed again?


---

Comment by leif created at 2012-04-03 21:33:47

Replying to [comment:69 AlexanderDreyer]:
> Replying to [comment:68 leif]:
> > Then I'd add just that there.
> Done. Is this ticket positively reviewed again?

Can't tell.  Jeroen last set it from *needs_review* to needs_work, and the issues he mentioned seem to be fixed, as well as mine regarding the dependencies (now at #12799, which this ticket depends on).

If the rest of the spkg already had positive review, you could probably revert it to that, but the other reviewers can probably tell better.


---

Comment by AlexanderDreyer created at 2012-04-03 21:55:33

Replying to [comment:51 jdemeyer]:
> I think SPKG.txt needs some work:
>  1. The Changelog messages don't tell much.  If you add a patch, you should mention that fact in the Changelog.  You should add a ticket number in the Changelog messages.
>  2. The patches should be documented.
Also done (see above). `@`jdemeyer Back to positive?


---

Comment by leif created at 2012-04-03 22:49:46

Replying to [comment:70 leif]:
> Replying to [comment:69 AlexanderDreyer]:
> > Is this ticket positively reviewed again?
> 
> [...] the issues he mentioned seem to be fixed, as well as mine regarding the dependencies (now at #12799, which this ticket depends on).

... which now has positive review.


---

Comment by jdemeyer created at 2012-04-04 13:19:23

Positive review then... provided it survives testing.


---

Comment by jdemeyer created at 2012-04-04 13:19:23

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-04-08 00:37:29

Resolution: fixed
