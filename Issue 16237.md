# Issue 16237: timeouts in doctests on OS X 10.9

Issue created by migration from https://trac.sagemath.org/ticket/16474

Original creator: jhpalmieri

Original creation time: 2014-06-11 20:57:54

CC:  vbraun

There are some timeouts when doctesting on OS X 10.9 (Mavericks). For example:

```
$ ./sage -tp src/doc/en/constructions

...
----------------------------------------------------------------------
sage -t src/doc/en/constructions/algebraic_geometry.rst  # Timed out
sage -t src/doc/en/constructions/polynomials.rst  # Timed out
----------------------------------------------------------------------
```

These seem to be caused by the changes in the Singular/pexpect interface from #15631.


---

Comment by dimpase created at 2014-06-15 11:01:35

even after reverting the corresponding commit from #15631 I still get lots of doctest timeouts.


---

Comment by jhpalmieri created at 2014-06-15 16:54:18

I'm not suggesting this as a fix (because I don't know anything about the pexpect interface), but if I make this one change:

```diff
diff --git a/src/sage/interfaces/singular.py b/src/sage/interfaces/singular.py
index 576fcc7..97ed05d 100644
--- a/src/sage/interfaces/singular.py
+++ b/src/sage/interfaces/singular.py
@@ -378,7 +378,7 @@ class Singular(Expect):
         """
         prompt = '> '
         Expect.__init__(self,
-                        terminal_echo=False,
+                        terminal_echo=True,
                         name = 'singular',
                         prompt = prompt,
                         command = "Singular -t --ticks-per-sec 1000", #no tty and fine grained cputime()
```

then I don't get the timeouts any more. (I get other doctest failures because of this, but no timeouts.)


---

Comment by dimpase created at 2014-06-17 09:30:36

in case, note #16260#comment:62


---

Comment by vbraun created at 2014-06-19 12:47:17

I've debugged the issue on OSX 10.9 and when the hang happens
* Singular does print its header and prompt (captured with dtrace)
* Python never sees any output from the subprocess, the first select() in `pexpect.read_nonblocking` hangs forever.

One way to reduce the likelihood of the hang is to insert a sleep before first reading from the subproces (in `expect._start`)


---

Comment by vbraun created at 2014-06-19 12:56:18

Sleeping 100ms when starting Singular reduces the failure rate in `sage -t --long src/sage/interfaces/magma.py` from about 1/10 to 1/1000 fwiw.


---

Comment by vbraun created at 2014-06-19 13:30:30

The branch attached is obviously a no-op, and just moves the setecho(0) further down after we read the first prompt. But it seems to improve things in my limited testing.
----
New commits:


---

Comment by vbraun created at 2014-06-19 15:31:24

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-06-19 15:31:24

This seems to fix it, I haven't seen another failure in `sage -t --long src/sage/interfaces/magma.py`


---

Comment by jhpalmieri created at 2014-06-19 23:49:40

Oh, very nice. This fixes it on two OS X 10.9 machines.


---

Comment by jhpalmieri created at 2014-06-19 23:49:40

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-06-21 23:43:17

Resolution: fixed
