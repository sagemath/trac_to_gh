# Issue 13132: Very inefficient scalar multiplication on FreeModule_ambient with somewhat large rank

Issue created by migration from Trac.

Original creator: daniels

Original creation time: 2012-07-27 11:24:49

Assignee: daniels

CC:  jdemeyer

As reported in a [thread in sage-support](https://groups.google.com/d/topic/sage-support/jlLTyY-8H8c/discussion) trivial scalar multiplication in `FreeModule_ambient` can be extremely slow or lead to out of memory errors:


```
n = 10000
v = vector([0]*n)   # ok so far
v2 = v/1            # kaboom
```


The problem is that, during coercion, `_an_element_impl()` and in turn `gen(0)` of `FreeModule_ambient` gets called. The default implementation of `gen` calls `basis()`, computing the entire standard basis, and then returns the first basis vector.




---

Attachment

The patch overrides `gen` in `FreeModule_ambient` to avoid generating the entire standard basis.


---

Comment by daniels created at 2012-07-31 09:47:11

Changing status from new to needs_review.


---

Comment by tfeulner created at 2012-08-30 11:12:51

The change looks fine to me and passes all tests. Maybe you should
- fill in your real name as Author of this ticket
- add your name to the author section of the file
- mark the doctest with the ticket number as an in-line comment
- explain the speed efficiency gained after applying the patch.


---

Comment by nbruin created at 2012-08-30 15:54:40

It's possible that calling `base_ring().one_element()` is a bit faster than converting the integer 1 into the ring every time. The method `one_element`normally gets cached.

What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast. With your patch this caching doesn't get triggered by asking for one basis vector any more. Code that previously benefited m might see a decrease in speed (which can be solved by first explicitly asking for the whole basis to trigger caching).

It might still be a good idea to not cache, but you might document the possible pitfall.


---

Comment by tfeulner created at 2012-08-31 06:07:21

The question is, in which situations do we actually ask for the basis of the ambient space? I found out that there is a similar problem when constructing subspaces, see
[sage-devel](https://groups.google.com/d/topic/sage-devel/ULcyJECqT4M/discussion). Unfortunately, this is not solved with this patch.

Surprisingly, there is a difference between the fields `GF(4, 'a')` and `QQ`.


---

Comment by ncohen created at 2013-12-02 15:57:12

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2013-12-02 15:57:12

(from the previous comments, it looks like the patch in its current state is not waiting for a review)


---

Comment by mmezzarobba created at 2014-03-16 12:55:16

See also #10262.

Replying to [comment:4 nbruin]:
> What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast.

If I understand correctly, the basis we are talking about is essentially the identity matrix. In fact, I am not convinced caching it (strongly at least) is such a good idea even in general—either recomputing it or computing whatever information one really needs instead sounds better in all cases I can think of. But in any case I think it is insane to call a function that may keep in cache a basis of, say, ℤ<sup>10000</sup>, unless one absolutely needs the whole basis!


---

Comment by mmezzarobba created at 2014-03-16 13:15:29

New commits:


---

Comment by mmezzarobba created at 2014-03-16 13:26:06

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2014-03-16 13:26:06

I opened a separate ticket (#15953) for the more general issue of whether and when to cache the basis.


---

Comment by mmezzarobba created at 2014-03-25 08:17:09

Changing priority from minor to major.


---

Comment by chapoton created at 2014-10-10 19:32:33

I just made a small clean-up and checked that doc builds and look nice.
----
New commits:


---

Comment by mmezzarobba created at 2015-02-05 16:21:25

Frédéric, did you review the commits prior to yours?


---

Comment by vdelecroix created at 2015-02-08 15:55:23

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-02-08 15:55:23

Hello,

You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way

```
    coefficient_ring = parent.basis()[0][0].parent()
```

In particular the following also takes life time for the very same reason

```
sage: V = ZZ['x']^50000
sage: V([0]*50000)
```



---

Comment by mmezzarobba created at 2015-02-08 16:05:01

Replying to [comment:17 vdelecroix]:
> You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way
> {{{
>     coefficient_ring = parent.basis()[0][0].parent()
> }}}
> In particular the following also takes life time for the very same reason
> {{{
> sage: V = ZZ['x']^50000
> sage: V([0]*50000)
> }}}

Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?


---

Comment by vdelecroix created at 2015-02-08 16:29:35

Replying to [comment:18 mmezzarobba]:
> Replying to [comment:17 vdelecroix]:
> > You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way
> > {{{
> >     coefficient_ring = parent.basis()[0][0].parent()
> > }}}
> > In particular the following also takes life time for the very same reason
> > {{{
> > sage: V = ZZ['x']^50000
> > sage: V([0]*50000)
> > }}}
> 
> Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?

Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?


---

Comment by mmezzarobba created at 2015-02-08 16:35:05

Replying to [comment:19 vdelecroix]:
> Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?

No, please feel free to do it here if you like. (I can't do it myself at the moment.)


---

Comment by vdelecroix created at 2015-02-08 17:14:10

Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?


---

Comment by vdelecroix created at 2015-02-20 15:24:12

Replying to [comment:21 vdelecroix]:
> Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?

The problem mentioned in [comment:17 comment:17] and the follow-ups needs #17585. In the meantime I am running the test for this branch on sage-6.6.beta0 and will set a positive review accordinlgy.

Vincent


---

Comment by vdelecroix created at 2015-02-20 15:54:43

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-02-20 16:08:13

I think that #17585 provides a better and more fundamental fix to the problem: the line

```
coefficient_ring = parent.basis()[0][0].parent()
```

is just removed completely.


---

Comment by jdemeyer created at 2015-02-20 16:16:19

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-02-20 16:16:19

Actually, #17585 fixes

```
sage: V = ZZ['x']^50000
sage: V([0]*50000)
```

but not

```
sage: vector([0]*50000)/1
```


Since this ticket looks quite independent of #17585, it makes sense to have both.

I do suggest to add the _two_ doctests above, since they clearly test different issues.


---

Comment by vdelecroix created at 2015-02-20 16:24:26

Replying to [comment:25 jdemeyer]:
> Actually, #17585 fixes
> {{{
> sage: V = ZZ['x']^50000
> sage: V([0]*50000)
> }}}
> but not
> {{{
> sage: vector([0]*50000)/1
> }}}
> 
> Since this ticket looks quite independent of #17585, it makes sense to have both.
> 
> I do suggest to add the _two_ doctests above, since they clearly test different issues.

The first one should go in #17585, no?


---

Comment by jdemeyer created at 2015-02-20 16:38:21

Sorry, there was a misunderstanding. I thought that this ticket fixed both issues.


---

Comment by jdemeyer created at 2015-02-20 16:38:21

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-02-21 12:40:44

Resolution: fixed
