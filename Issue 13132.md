# Issue 13132: Very inefficient scalar multiplication on FreeModule_ambient with somewhat large rank

archive/issues_013132.json:
```json
{
    "body": "Assignee: @dansme\n\nCC:  @jdemeyer\n\nAs reported in a [thread in sage-support](https://groups.google.com/d/topic/sage-support/jlLTyY-8H8c/discussion) trivial scalar multiplication in `FreeModule_ambient` can be extremely slow or lead to out of memory errors:\n\n\n```\nn = 10000\nv = vector([0]*n)   # ok so far\nv2 = v/1            # kaboom\n```\n\n\nThe problem is that, during coercion, `_an_element_impl()` and in turn `gen(0)` of `FreeModule_ambient` gets called. The default implementation of `gen` calls `basis()`, computing the entire standard basis, and then returns the first basis vector.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13304\n\n",
    "created_at": "2012-07-27T11:24:49Z",
    "labels": [
        "linear algebra",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Very inefficient scalar multiplication on FreeModule_ambient with somewhat large rank",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13132",
    "user": "@dansme"
}
```
Assignee: @dansme

CC:  @jdemeyer

As reported in a [thread in sage-support](https://groups.google.com/d/topic/sage-support/jlLTyY-8H8c/discussion) trivial scalar multiplication in `FreeModule_ambient` can be extremely slow or lead to out of memory errors:


```
n = 10000
v = vector([0]*n)   # ok so far
v2 = v/1            # kaboom
```


The problem is that, during coercion, `_an_element_impl()` and in turn `gen(0)` of `FreeModule_ambient` gets called. The default implementation of `gen` calls `basis()`, computing the entire standard basis, and then returns the first basis vector.



Issue created by migration from https://trac.sagemath.org/ticket/13304





---

archive/issue_comments_159856.json:
```json
{
    "body": "Attachment [trac_13304_gen_speedup.patch](tarball://root/attachments/some-uuid/ticket13304/trac_13304_gen_speedup.patch) by @dansme created at 2012-07-27 11:27:34\n\nThe patch overrides `gen` in `FreeModule_ambient` to avoid generating the entire standard basis.",
    "created_at": "2012-07-27T11:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159856",
    "user": "@dansme"
}
```

Attachment [trac_13304_gen_speedup.patch](tarball://root/attachments/some-uuid/ticket13304/trac_13304_gen_speedup.patch) by @dansme created at 2012-07-27 11:27:34

The patch overrides `gen` in `FreeModule_ambient` to avoid generating the entire standard basis.



---

archive/issue_comments_159857.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-07-31T09:47:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159857",
    "user": "@dansme"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_159858.json:
```json
{
    "body": "The change looks fine to me and passes all tests. Maybe you should\n- fill in your real name as Author of this ticket\n- add your name to the author section of the file\n- mark the doctest with the ticket number as an in-line comment\n- explain the speed efficiency gained after applying the patch.",
    "created_at": "2012-08-30T11:12:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159858",
    "user": "tfeulner"
}
```

The change looks fine to me and passes all tests. Maybe you should
- fill in your real name as Author of this ticket
- add your name to the author section of the file
- mark the doctest with the ticket number as an in-line comment
- explain the speed efficiency gained after applying the patch.



---

archive/issue_comments_159859.json:
```json
{
    "body": "It's possible that calling `base_ring().one_element()` is a bit faster than converting the integer 1 into the ring every time. The method `one_element`normally gets cached.\n\nWhat's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast. With your patch this caching doesn't get triggered by asking for one basis vector any more. Code that previously benefited m might see a decrease in speed (which can be solved by first explicitly asking for the whole basis to trigger caching).\n\nIt might still be a good idea to not cache, but you might document the possible pitfall.",
    "created_at": "2012-08-30T15:54:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159859",
    "user": "@nbruin"
}
```

It's possible that calling `base_ring().one_element()` is a bit faster than converting the integer 1 into the ring every time. The method `one_element`normally gets cached.

What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast. With your patch this caching doesn't get triggered by asking for one basis vector any more. Code that previously benefited m might see a decrease in speed (which can be solved by first explicitly asking for the whole basis to trigger caching).

It might still be a good idea to not cache, but you might document the possible pitfall.



---

archive/issue_comments_159860.json:
```json
{
    "body": "The question is, in which situations do we actually ask for the basis of the ambient space? I found out that there is a similar problem when constructing subspaces, see\n[sage-devel](https://groups.google.com/d/topic/sage-devel/ULcyJECqT4M/discussion). Unfortunately, this is not solved with this patch.\n\nSurprisingly, there is a difference between the fields `GF(4, 'a')` and `QQ`.",
    "created_at": "2012-08-31T06:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159860",
    "user": "tfeulner"
}
```

The question is, in which situations do we actually ask for the basis of the ambient space? I found out that there is a similar problem when constructing subspaces, see
[sage-devel](https://groups.google.com/d/topic/sage-devel/ULcyJECqT4M/discussion). Unfortunately, this is not solved with this patch.

Surprisingly, there is a difference between the fields `GF(4, 'a')` and `QQ`.



---

archive/issue_comments_159861.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-12-02T15:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159861",
    "user": "@nathanncohen"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_159862.json:
```json
{
    "body": "(from the previous comments, it looks like the patch in its current state is not waiting for a review)",
    "created_at": "2013-12-02T15:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159862",
    "user": "@nathanncohen"
}
```

(from the previous comments, it looks like the patch in its current state is not waiting for a review)



---

archive/issue_comments_159863.json:
```json
{
    "body": "See also #10262.\n\nReplying to [comment:4 nbruin]:\n> What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast.\n\nIf I understand correctly, the basis we are talking about is essentially the identity matrix. In fact, I am not convinced caching it (strongly at least) is such a good idea even in general\u2014either recomputing it or computing whatever information one really needs instead sounds better in all cases I can think of. But in any case I think it is insane to call a function that may keep in cache a basis of, say, \u2124<sup>10000</sup>, unless one absolutely needs the whole basis!",
    "created_at": "2014-03-16T12:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159863",
    "user": "@mezzarobba"
}
```

See also #10262.

Replying to [comment:4 nbruin]:
> What's more, previously, asking for one basis element triggered basis computation and caching. After that, getting basis elements should be fast.

If I understand correctly, the basis we are talking about is essentially the identity matrix. In fact, I am not convinced caching it (strongly at least) is such a good idea even in general—either recomputing it or computing whatever information one really needs instead sounds better in all cases I can think of. But in any case I think it is insane to call a function that may keep in cache a basis of, say, ℤ<sup>10000</sup>, unless one absolutely needs the whole basis!



---

archive/issue_comments_159864.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-03-16T13:15:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159864",
    "user": "@mezzarobba"
}
```

New commits:



---

archive/issue_comments_159865.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-03-16T13:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159865",
    "user": "@mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_159866.json:
```json
{
    "body": "I opened a separate ticket (#15953) for the more general issue of whether and when to cache the basis.",
    "created_at": "2014-03-16T13:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159866",
    "user": "@mezzarobba"
}
```

I opened a separate ticket (#15953) for the more general issue of whether and when to cache the basis.



---

archive/issue_comments_159867.json:
```json
{
    "body": "Changing priority from minor to major.",
    "created_at": "2014-03-25T08:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159867",
    "user": "@mezzarobba"
}
```

Changing priority from minor to major.



---

archive/issue_comments_159868.json:
```json
{
    "body": "I just made a small clean-up and checked that doc builds and look nice.\n----\nNew commits:",
    "created_at": "2014-10-10T19:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159868",
    "user": "@fchapoton"
}
```

I just made a small clean-up and checked that doc builds and look nice.
----
New commits:



---

archive/issue_comments_159869.json:
```json
{
    "body": "Fr\u00e9d\u00e9ric, did you review the commits prior to yours?",
    "created_at": "2015-02-05T16:21:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159869",
    "user": "@mezzarobba"
}
```

Frédéric, did you review the commits prior to yours?



---

archive/issue_comments_159870.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-08T15:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159870",
    "user": "@videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_159871.json:
```json
{
    "body": "Hello,\n\nYou got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way\n\n```\n    coefficient_ring = parent.basis()[0][0].parent()\n```\n\nIn particular the following also takes life time for the very same reason\n\n```\nsage: V = ZZ['x']^50000\nsage: V([0]*50000)\n```\n",
    "created_at": "2015-02-08T15:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159871",
    "user": "@videlec"
}
```

Hello,

You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way

```
    coefficient_ring = parent.basis()[0][0].parent()
```

In particular the following also takes life time for the very same reason

```
sage: V = ZZ['x']^50000
sage: V([0]*50000)
```




---

archive/issue_comments_159872.json:
```json
{
    "body": "Replying to [comment:17 vdelecroix]:\n> You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way\n> {{{\n>     coefficient_ring = parent.basis()[0][0].parent()\n> }}}\n> In particular the following also takes life time for the very same reason\n> {{{\n> sage: V = ZZ['x']^50000\n> sage: V([0]*50000)\n> }}}\n\nDoes it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?",
    "created_at": "2015-02-08T16:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159872",
    "user": "@mezzarobba"
}
```

Replying to [comment:17 vdelecroix]:
> You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way
> {{{
>     coefficient_ring = parent.basis()[0][0].parent()
> }}}
> In particular the following also takes life time for the very same reason
> {{{
> sage: V = ZZ['x']^50000
> sage: V([0]*50000)
> }}}

Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?



---

archive/issue_comments_159873.json:
```json
{
    "body": "Replying to [comment:18 mmezzarobba]:\n> Replying to [comment:17 vdelecroix]:\n> > You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way\n> > {{{\n> >     coefficient_ring = parent.basis()[0][0].parent()\n> > }}}\n> > In particular the following also takes life time for the very same reason\n> > {{{\n> > sage: V = ZZ['x']^50000\n> > sage: V([0]*50000)\n> > }}}\n> \n> Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?\n\nSecond option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?",
    "created_at": "2015-02-08T16:29:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159873",
    "user": "@videlec"
}
```

Replying to [comment:18 mmezzarobba]:
> Replying to [comment:17 vdelecroix]:
> > You got it right for integer vectors but the generic constructor of `FreeModuleElement_generic_dense` does call the basis in a very stupid way
> > {{{
> >     coefficient_ring = parent.basis()[0][0].parent()
> > }}}
> > In particular the following also takes life time for the very same reason
> > {{{
> > sage: V = ZZ['x']^50000
> > sage: V([0]*50000)
> > }}}
> 
> Does it make the solution in this ticket inadequate? Or is it just a similar problem that can be handled separately?

Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?



---

archive/issue_comments_159874.json:
```json
{
    "body": "Replying to [comment:19 vdelecroix]:\n> Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?\n\nNo, please feel free to do it here if you like. (I can't do it myself at the moment.)",
    "created_at": "2015-02-08T16:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159874",
    "user": "@mezzarobba"
}
```

Replying to [comment:19 vdelecroix]:
> Second option. It is just a one line change (that I can even do myself). Do you prefer this one line change to be on another ticket?

No, please feel free to do it here if you like. (I can't do it myself at the moment.)



---

archive/issue_comments_159875.json:
```json
{
    "body": "Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?",
    "created_at": "2015-02-08T17:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159875",
    "user": "@videlec"
}
```

Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?



---

archive/issue_comments_159876.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?\n\nThe problem mentioned in [comment:17 comment:17] and the follow-ups needs #17585. In the meantime I am running the test for this branch on sage-6.6.beta0 and will set a positive review accordinlgy.\n\nVincent",
    "created_at": "2015-02-20T15:24:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159876",
    "user": "@videlec"
}
```

Replying to [comment:21 vdelecroix]:
> Wow! Because of #11751 that introduces a very weird behavior the call to `.basis()` is somewhat unavoidable. Jeroen already pointed that out in #11751 and proposed to revert the changes. I am in favor of also reverting the changes. Might be better within another ticket?

The problem mentioned in [comment:17 comment:17] and the follow-ups needs #17585. In the meantime I am running the test for this branch on sage-6.6.beta0 and will set a positive review accordinlgy.

Vincent



---

archive/issue_comments_159877.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-02-20T15:54:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159877",
    "user": "@videlec"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_159878.json:
```json
{
    "body": "I think that #17585 provides a better and more fundamental fix to the problem: the line\n\n```\ncoefficient_ring = parent.basis()[0][0].parent()\n```\n\nis just removed completely.",
    "created_at": "2015-02-20T16:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159878",
    "user": "@jdemeyer"
}
```

I think that #17585 provides a better and more fundamental fix to the problem: the line

```
coefficient_ring = parent.basis()[0][0].parent()
```

is just removed completely.



---

archive/issue_comments_159879.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-02-20T16:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159879",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_159880.json:
```json
{
    "body": "Actually, #17585 fixes\n\n```\nsage: V = ZZ['x']^50000\nsage: V([0]*50000)\n```\n\nbut not\n\n```\nsage: vector([0]*50000)/1\n```\n\n\nSince this ticket looks quite independent of #17585, it makes sense to have both.\n\nI do suggest to add the *two* doctests above, since they clearly test different issues.",
    "created_at": "2015-02-20T16:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159880",
    "user": "@jdemeyer"
}
```

Actually, #17585 fixes

```
sage: V = ZZ['x']^50000
sage: V([0]*50000)
```

but not

```
sage: vector([0]*50000)/1
```


Since this ticket looks quite independent of #17585, it makes sense to have both.

I do suggest to add the *two* doctests above, since they clearly test different issues.



---

archive/issue_comments_159881.json:
```json
{
    "body": "Replying to [comment:25 jdemeyer]:\n> Actually, #17585 fixes\n> {{{\n> sage: V = ZZ['x']^50000\n> sage: V([0]*50000)\n> }}}\n> but not\n> {{{\n> sage: vector([0]*50000)/1\n> }}}\n> \n> Since this ticket looks quite independent of #17585, it makes sense to have both.\n> \n> I do suggest to add the *two* doctests above, since they clearly test different issues.\n\nThe first one should go in #17585, no?",
    "created_at": "2015-02-20T16:24:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159881",
    "user": "@videlec"
}
```

Replying to [comment:25 jdemeyer]:
> Actually, #17585 fixes
> {{{
> sage: V = ZZ['x']^50000
> sage: V([0]*50000)
> }}}
> but not
> {{{
> sage: vector([0]*50000)/1
> }}}
> 
> Since this ticket looks quite independent of #17585, it makes sense to have both.
> 
> I do suggest to add the *two* doctests above, since they clearly test different issues.

The first one should go in #17585, no?



---

archive/issue_comments_159882.json:
```json
{
    "body": "Sorry, there was a misunderstanding. I thought that this ticket fixed both issues.",
    "created_at": "2015-02-20T16:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159882",
    "user": "@jdemeyer"
}
```

Sorry, there was a misunderstanding. I thought that this ticket fixed both issues.



---

archive/issue_comments_159883.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-02-20T16:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159883",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_159884.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-21T12:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13132",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13132#issuecomment-159884",
    "user": "@vbraun"
}
```

Resolution: fixed
