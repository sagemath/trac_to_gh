# Issue 32928: evaluating polynomials in R[x] at elements of R[x]/(f) is really slow

archive/issues_032928.json:
```json
{
    "body": "This seems to be part of what's going wrong in #33156:\n\n```\nsage: R.<x> = GF(31337)[]\nsage: f = R.random_element(degree=999)\nsage: g = R.random_element(degree=9999)\nsage: S.<y> = R.quotient(f)\nsage: %timeit g(y)\n188 ms \u00b1 1.74 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\nsage: %timeit (g%f)(y)\n16.4 ms \u00b1 31 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\nsage: %timeit S(g%f)\n2.97 ms \u00b1 185 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 100 loops each)\n```\n\n\nWe should probably add an optimized code path for evaluation at quotient-ring elements.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33165\n\n",
    "created_at": "2022-01-14T04:42:57Z",
    "labels": [
        "component: algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "evaluating polynomials in R[x] at elements of R[x]/(f) is really slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32928",
    "user": "https://github.com/yyyyx4"
}
```
This seems to be part of what's going wrong in #33156:

```
sage: R.<x> = GF(31337)[]
sage: f = R.random_element(degree=999)
sage: g = R.random_element(degree=9999)
sage: S.<y> = R.quotient(f)
sage: %timeit g(y)
188 ms ± 1.74 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit (g%f)(y)
16.4 ms ± 31 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit S(g%f)
2.97 ms ± 185 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


We should probably add an optimized code path for evaluation at quotient-ring elements.

Issue created by migration from https://trac.sagemath.org/ticket/33165





---

archive/issue_comments_469162.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-01-14T05:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469162",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_469163.json:
```json
{
    "body": "With the patch, `g(y)` is now just as fast as `S(g)`.\n----\nNew commits:",
    "created_at": "2022-01-14T05:44:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469163",
    "user": "https://github.com/yyyyx4"
}
```

With the patch, `g(y)` is now just as fast as `S(g)`.
----
New commits:



---

archive/issue_comments_469164.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-14T05:46:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469164",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469165.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-14T06:09:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469165",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469166.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-01-14T08:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469166",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_469167.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-14T14:43:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469167",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469168.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-01-14T14:51:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469168",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_469169.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-01-14T16:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469169",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469170.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-12T12:30:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469170",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469171.json:
```json
{
    "body": "Why not do it like this instead?\n\n|                                                                                                                                           |                                                         |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|\n|[89327e5](https://git.sagemath.org/sage.git/commit/?id=89327e56e2f7773b704c7f4f2d582d4b4f40de13)|`#33165 limit slowdown for eval at elts of the base ring`|\nThis avoids slowing down the case of evaluations at elements of the base ring as much, and extends your speed-up to evaluations using keyword syntax.",
    "created_at": "2022-02-12T12:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469171",
    "user": "https://github.com/mezzarobba"
}
```

Why not do it like this instead?

|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[89327e5](https://git.sagemath.org/sage.git/commit/?id=89327e56e2f7773b704c7f4f2d582d4b4f40de13)|`#33165 limit slowdown for eval at elts of the base ring`|
This avoids slowing down the case of evaluations at elements of the base ring as much, and extends your speed-up to evaluations using keyword syntax.



---

archive/issue_comments_469172.json:
```json
{
    "body": "A few comments since you want to optimize this:\n\n- Instead of `is_MPolynomialRing(parent(a))` why not test `isinstance(a, MPolynomial)`. This should be faster.\n- Use `(<Element> a)._parent` as it is faster. If you don't want to break encapsulation, use `parent(a)` since it is a Cython function instead of a Python method IIRC.\n- It might be good to tweak `change_variable_name` to take advantage of this codepath.",
    "created_at": "2022-02-14T03:57:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469172",
    "user": "https://github.com/tscrim"
}
```

A few comments since you want to optimize this:

- Instead of `is_MPolynomialRing(parent(a))` why not test `isinstance(a, MPolynomial)`. This should be faster.
- Use `(<Element> a)._parent` as it is faster. If you don't want to break encapsulation, use `parent(a)` since it is a Cython function instead of a Python method IIRC.
- It might be good to tweak `change_variable_name` to take advantage of this codepath.



---

archive/issue_comments_469173.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-14T12:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469173",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469174.json:
```json
{
    "body": "Thanks for the suggestions! It's indeed a little bit faster with these changes.",
    "created_at": "2022-02-14T12:51:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469174",
    "user": "https://github.com/yyyyx4"
}
```

Thanks for the suggestions! It's indeed a little bit faster with these changes.



---

archive/issue_comments_469175.json:
```json
{
    "body": "Perhaps it would also be good to handle the cases when the input is a monomial? You might be better off using the `ETuple` for the multi polynomial case. At least the monomial input for that would be essentially the same as what you currently have. The univariate  case would take a bit more work.",
    "created_at": "2022-02-14T14:21:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469175",
    "user": "https://github.com/tscrim"
}
```

Perhaps it would also be good to handle the cases when the input is a monomial? You might be better off using the `ETuple` for the multi polynomial case. At least the monomial input for that would be essentially the same as what you currently have. The univariate  case would take a bit more work.



---

archive/issue_comments_469176.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-15T04:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469176",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469177.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> Perhaps it would also be good to handle the cases when the input is a monomial?\n\nLike this?\n\n(I didn't adapt the code for monomials in quotient rings because it's not totally obvious when it is worth it to do so.)",
    "created_at": "2022-02-15T04:50:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469177",
    "user": "https://github.com/yyyyx4"
}
```

Replying to [comment:14 tscrim]:
> Perhaps it would also be good to handle the cases when the input is a monomial?

Like this?

(I didn't adapt the code for monomials in quotient rings because it's not totally obvious when it is worth it to do so.)



---

archive/issue_comments_469178.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-15T08:36:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469178",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469179.json:
```json
{
    "body": "Yes, thank you. I have also made some additional tweaks to try and get more speed out. Most notable:\n\n- I made sure the handle the dense and sparse cases separately.\n- `0` and constants are handled as further special cases.\n- Not everything that is `x` is true as `is_gen()`:\n  {{{\nsage: R.<x> = QQ[]\nsage: R([0,1]).is_gen()\nFalse\n  }}}\n  So I now cover this case.\n\nWith my changes, I get just a little tiny bit more (at least it is no worse):\n\n```\nsage: R.<x> = GF(31337)[]\nsage: g = R(list(range(1,1001)))\nsage: U.<t,u,v> = GF(31337)[]\nsage: %timeit g(u)\n1.86 ms \u00b1 10.2 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)git\n```\n\nversus your branch\n\n```\nsage: %timeit g(u)\n1.88 ms \u00b1 35.7 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1000 loops each)\n```\n\nI didn't run timing tests extensively, but where I did test, I saw at least a little speedup.",
    "created_at": "2022-02-15T09:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469179",
    "user": "https://github.com/tscrim"
}
```

Yes, thank you. I have also made some additional tweaks to try and get more speed out. Most notable:

- I made sure the handle the dense and sparse cases separately.
- `0` and constants are handled as further special cases.
- Not everything that is `x` is true as `is_gen()`:
  {{{
sage: R.<x> = QQ[]
sage: R([0,1]).is_gen()
False
  }}}
  So I now cover this case.

With my changes, I get just a little tiny bit more (at least it is no worse):

```
sage: R.<x> = GF(31337)[]
sage: g = R(list(range(1,1001)))
sage: U.<t,u,v> = GF(31337)[]
sage: %timeit g(u)
1.86 ms ± 10.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)git
```

versus your branch

```
sage: %timeit g(u)
1.88 ms ± 35.7 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

I didn't run timing tests extensively, but where I did test, I saw at least a little speedup.



---

archive/issue_comments_469180.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-15T09:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469180",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469181.json:
```json
{
    "body": "I am not sure about this change:\n\n```\n         R = parent(a)\n \n-        if parent(cst) is not R:\n-\n+        if R is not self._parent._base:\n```\n\nShouldn't it be `pol._parent._base` instead of `self._parent._base`?\n\nApart from that, lgtm! (But someone else should have a look since I contributed to the code.)",
    "created_at": "2022-02-17T10:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469181",
    "user": "https://github.com/mezzarobba"
}
```

I am not sure about this change:

```
         R = parent(a)
 
-        if parent(cst) is not R:
-
+        if R is not self._parent._base:
```

Shouldn't it be `pol._parent._base` instead of `self._parent._base`?

Apart from that, lgtm! (But someone else should have a look since I contributed to the code.)



---

archive/issue_comments_469182.json:
```json
{
    "body": "Since everything else in that code is working with `pol`, I think we should check that base ring. Although from what I understand of the code above, it should be the same base ring as `self`.\n\nI have also checked your code, so if you are okay with mine, then we can set a positive review.",
    "created_at": "2022-02-17T11:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469182",
    "user": "https://github.com/tscrim"
}
```

Since everything else in that code is working with `pol`, I think we should check that base ring. Although from what I understand of the code above, it should be the same base ring as `self`.

I have also checked your code, so if you are okay with mine, then we can set a positive review.



---

archive/issue_comments_469183.json:
```json
{
    "body": "Actually, you\u2019re right, it should check `pol._parent._base`. If you could make this change, then you can set a positive review on my behalf (assuming you have given a positive review to my changes).\n\nIt would be nice to add a test for this, but I think the code is sufficient robust with the coercion framework to make testing for this difficult. We would have do something with incompatible objects after mapping coefficients. If you can think of a simple test, please add it. Otherwise, we can just let it be since we have looked at the code\u2019s logic.",
    "created_at": "2022-02-17T11:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469183",
    "user": "https://github.com/tscrim"
}
```

Actually, you’re right, it should check `pol._parent._base`. If you could make this change, then you can set a positive review on my behalf (assuming you have given a positive review to my changes).

It would be nice to add a test for this, but I think the code is sufficient robust with the coercion framework to make testing for this difficult. We would have do something with incompatible objects after mapping coefficients. If you can think of a simple test, please add it. Otherwise, we can just let it be since we have looked at the code’s logic.



---

archive/issue_comments_469184.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-17T11:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469184",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469185.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-17T20:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469185",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469186.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-02-21T00:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469186",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_469187.json:
```json
{
    "body": "On 32-bit:\n\n```\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_element.pyx\", line 736, in sage.rings.polynomial.polynomial_element.Polynomial.__call__\nFailed example:\n    f(y^1000)\nExpected:\n    y^10000000000 + 1\nGot:\n    y^1410065408 + 1\n**********************************************************************\n```\n",
    "created_at": "2022-02-21T00:33:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469187",
    "user": "https://github.com/vbraun"
}
```

On 32-bit:

```
**********************************************************************
File "src/sage/rings/polynomial/polynomial_element.pyx", line 736, in sage.rings.polynomial.polynomial_element.Polynomial.__call__
Failed example:
    f(y^1000)
Expected:
    y^10000000000 + 1
Got:
    y^1410065408 + 1
**********************************************************************
```




---

archive/issue_comments_469188.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-21T04:14:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469188",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469189.json:
```json
{
    "body": "Trivial change of decreasing the degree so that there is no overflow on 32-bit.",
    "created_at": "2022-02-21T04:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469189",
    "user": "https://github.com/tscrim"
}
```

Trivial change of decreasing the degree so that there is no overflow on 32-bit.



---

archive/issue_comments_469190.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2022-02-21T04:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469190",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_469191.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-27T22:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32928",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32928#issuecomment-469191",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
