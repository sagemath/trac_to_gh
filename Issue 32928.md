# Issue 32928: evaluating polynomials in R[x] at elements of R[x]/(f) is really slow

Issue created by migration from https://trac.sagemath.org/ticket/33165

Original creator: lorenz

Original creation time: 2022-01-14 04:42:57

This seems to be part of what's going wrong in #33156:

```
sage: R.<x> = GF(31337)[]
sage: f = R.random_element(degree=999)
sage: g = R.random_element(degree=9999)
sage: S.<y> = R.quotient(f)
sage: %timeit g(y)
188 ms ± 1.74 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
sage: %timeit (g%f)(y)
16.4 ms ± 31 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
sage: %timeit S(g%f)
2.97 ms ± 185 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
```


We should probably add an optimized code path for evaluation at quotient-ring elements.


---

Comment by lorenz created at 2022-01-14 05:44:41

Changing status from new to needs_review.


---

Comment by lorenz created at 2022-01-14 05:44:41

With the patch, `g(y)` is now just as fast as `S(g)`.
----
New commits:


---

Comment by git created at 2022-01-14 05:46:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-01-14 06:09:17

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by lorenz created at 2022-01-14 08:42:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-01-14 14:43:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-01-14 14:51:15

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-01-14 16:34:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-12 12:30:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2022-02-12 12:34:07

Why not do it like this instead?

|                                                                                                                                           |                                                         |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
|[89327e5](https://git.sagemath.org/sage.git/commit/?id=89327e56e2f7773b704c7f4f2d582d4b4f40de13)|`#33165 limit slowdown for eval at elts of the base ring`|
This avoids slowing down the case of evaluations at elements of the base ring as much, and extends your speed-up to evaluations using keyword syntax.


---

Comment by tscrim created at 2022-02-14 03:57:16

A few comments since you want to optimize this:

- Instead of `is_MPolynomialRing(parent(a))` why not test `isinstance(a, MPolynomial)`. This should be faster.
- Use `(<Element> a)._parent` as it is faster. If you don't want to break encapsulation, use `parent(a)` since it is a Cython function instead of a Python method IIRC.
- It might be good to tweak `change_variable_name` to take advantage of this codepath.


---

Comment by git created at 2022-02-14 12:06:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-02-14 12:51:36

Thanks for the suggestions! It's indeed a little bit faster with these changes.


---

Comment by tscrim created at 2022-02-14 14:21:46

Perhaps it would also be good to handle the cases when the input is a monomial? You might be better off using the `ETuple` for the multi polynomial case. At least the monomial input for that would be essentially the same as what you currently have. The univariate  case would take a bit more work.


---

Comment by git created at 2022-02-15 04:44:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-02-15 04:50:02

Replying to [comment:14 tscrim]:
> Perhaps it would also be good to handle the cases when the input is a monomial?

Like this?

(I didn't adapt the code for monomials in quotient rings because it's not totally obvious when it is worth it to do so.)


---

Comment by git created at 2022-02-15 08:36:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-15 09:11:53

Yes, thank you. I have also made some additional tweaks to try and get more speed out. Most notable:

- I made sure the handle the dense and sparse cases separately.
- `0` and constants are handled as further special cases.
- Not everything that is `x` is true as `is_gen()`:
  {{{
sage: R.<x> = QQ[]
sage: R([0,1]).is_gen()
False
  }}}
  So I now cover this case.

With my changes, I get just a little tiny bit more (at least it is no worse):

```
sage: R.<x> = GF(31337)[]
sage: g = R(list(range(1,1001)))
sage: U.<t,u,v> = GF(31337)[]
sage: %timeit g(u)
1.86 ms ± 10.2 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)git
```

versus your branch

```
sage: %timeit g(u)
1.88 ms ± 35.7 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
```

I didn't run timing tests extensively, but where I did test, I saw at least a little speedup.


---

Comment by git created at 2022-02-15 09:12:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2022-02-17 10:14:11

I am not sure about this change:

```
         R = parent(a)
 
-        if parent(cst) is not R:
-
+        if R is not self._parent._base:
```

Shouldn't it be `pol._parent._base` instead of `self._parent._base`?

Apart from that, lgtm! (But someone else should have a look since I contributed to the code.)


---

Comment by tscrim created at 2022-02-17 11:25:05

Since everything else in that code is working with `pol`, I think we should check that base ring. Although from what I understand of the code above, it should be the same base ring as `self`.

I have also checked your code, so if you are okay with mine, then we can set a positive review.


---

Comment by tscrim created at 2022-02-17 11:31:58

Actually, you’re right, it should check `pol._parent._base`. If you could make this change, then you can set a positive review on my behalf (assuming you have given a positive review to my changes).

It would be nice to add a test for this, but I think the code is sufficient robust with the coercion framework to make testing for this difficult. We would have do something with incompatible objects after mapping coefficients. If you can think of a simple test, please add it. Otherwise, we can just let it be since we have looked at the code’s logic.


---

Comment by git created at 2022-02-17 11:52:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2022-02-17 20:43:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-21 00:33:57

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-02-21 00:33:57

On 32-bit:

```
**********************************************************************
File "src/sage/rings/polynomial/polynomial_element.pyx", line 736, in sage.rings.polynomial.polynomial_element.Polynomial.__call__
Failed example:
    f(y^1000)
Expected:
    y^10000000000 + 1
Got:
    y^1410065408 + 1
**********************************************************************
```



---

Comment by git created at 2022-02-21 04:14:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-21 04:15:38

Trivial change of decreasing the degree so that there is no overflow on 32-bit.


---

Comment by tscrim created at 2022-02-21 04:15:38

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-02-27 22:00:28

Resolution: fixed
