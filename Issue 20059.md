# Issue 20059: MixedIntegerLinearProgram: New backend using InteractiveLPProblem

Issue created by migration from https://trac.sagemath.org/ticket/20296

Original creator: mkoeppe

Original creation time: 2016-03-26 02:40:10

CC:  dimpase novoselt ncohen vdelecroix chapoton

Keywords: lp

If one has to solve a small LP with irrational (say, AA) data (and needs access to the exact solution), the only available tool is the didactical implementation of the simplex method in `InteractiveLPProblem` (but see #18735). This ticket implements a `MixedIntegerLinearProgram` backend using `InteractiveLPProblem`.


---

Comment by mkoeppe created at 2016-03-27 00:36:26

Needs review.

Some remarks:
 - I'm using some _internals of `InteractiveLPProblem` (`_constraint_types`, `_variable_types`, `_problem_type`, `_is_negative`) because some accessor methods are missing. Should I be adding them?
 - There's should be a way to choose the base ring for the solver (right now I'm using AA -- but ultimately I'd like to use an embedded number field), but I'm not sure about the interface... perhaps  ` MixedIntegerLinearProgram(solver=('InteractiveLP', AA)) ` or `MixedIntegerLinearProgram(solver='InteractiveLP', base_ring=AA`
----
New commits:


---

Comment by mkoeppe created at 2016-03-27 00:36:26

Changing status from new to needs_review.


---

Comment by novoselt created at 2016-03-27 05:11:10

Replying to [comment:2 mkoeppe]:
> Some remarks:
>  - I'm using some _internals of `InteractiveLPProblem` (`_constraint_types`, `_variable_types`, `_problem_type`, `_is_negative`) because some accessor methods are missing. Should I be adding them?

I think so - the reason they are missing is that they were never needed before. Using guts directly makes sense inside of ILLP itself, but now that you have a dependent module there has to be documented and tested way to access them.

>  - There's should be a way to choose the base ring for the solver (right now I'm using AA -- but ultimately I'd like to use an embedded number field), but I'm not sure about the interface... perhaps  ` MixedIntegerLinearProgram(solver=('InteractiveLP', AA)) ` or `MixedIntegerLinearProgram(solver='InteractiveLP', base_ring=AA`

`base_ring=AA` seems to be more common (and I think it is common to use `ring` even when only field would really make sense).


---

Comment by git created at 2016-03-27 05:57:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-03-27 06:17:55

I've added these accessor methods and changed my code to use them.
Two more things regarding `InteractiveLPProblem`:
 - I think `InteractiveLPProblem.standard_form` should allow the user to pass names for the slack variables
 - It would be nice if `InteractiveLPProblem`would support an additive constant in the objective function (see `obj_constant_term` in my code)


---

Comment by novoselt created at 2016-03-27 17:11:52

Regarding `problem_type` method - why do you add minus there? It seems to me that your old code was not adding it so either it was wrong or it is wrong now. And for the method itself I think it makes more sense to return just `self._problem_type` as is and mention in documentation that there is also `is_negative` method and they need to be used together.

Passing through parameters to the constructor would make sense. And adding a constant to non-standard form would be handy. Let me work on it today actually and take a break from digging in JavaScript!

Also, it would be nice if someone closer to LP backends did the full review of this ticket.


---

Comment by git created at 2016-03-27 18:56:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-03-27 18:59:25

Replying to [comment:7 novoselt]:
> Regarding `problem_type` method - why do you add minus there? It seems to me that your old code was not adding it so either it was wrong or it is wrong now. And for the method itself I think it makes more sense to return just `self._problem_type` as is and mention in documentation that there is also `is_negative` method and they need to be used together.

OK, I've changed it. 
For my code, it does not make any difference because I don't construct "-max" or "-min" problems. 
I only have to deal with `is_negative` once, for the standard-form problem that is created while solving.

> Passing through parameters to the constructor would make sense. And adding a constant to non-standard form would be handy. Let me work on it today actually and take a break from digging in JavaScript!

Thanks!

> Also, it would be nice if someone closer to LP backends did the full review of this ticket.

Yes, I'm hoping that someone on the Cc list could take a look...


---

Comment by mkoeppe created at 2016-03-27 19:04:36

By the way, the `interactive_simplex_method` code should probably check for variable-name clashes between auto-generated and user-supplied variable names. It gets quite confused, for example, when a variable named "x0" is introduced because it thinks it is the primal-phase-1 auxiliary variable.


---

Comment by git created at 2016-03-27 19:30:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-03-27 19:51:56

Another wishlist item for `interactive_simplex_method`: `standard_form` should provide a linear map that transforms a solution back to the original variables. (If `InteractiveLPProblem` wants to support arbitrary variable bounds in the future, it would have to be an affine linear map.)


---

Comment by git created at 2016-03-27 20:16:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-27 21:44:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-27 21:47:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-27 21:52:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by novoselt created at 2016-03-27 23:39:54

I think everything and a little more but name clashes are implemented in #20311.

Regarding variable names, it is sort of by design that auxiliary variable can be one of the decision ones - that's how auxiliary problems are distinguished. It may not be the best choice but changing it should be done carefully. In all other cases name clashes should throw errors and users are responsible for either adjusting their choices or overriding defaults to avoid conflict.


---

Comment by git created at 2016-03-28 01:28:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-30 03:08:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-31 18:27:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-31 20:47:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-03 19:21:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-04-05 15:00:25

there are long commented out blocks, like `cpdef solver_parameter`, and ones for file output. Can you remove them?


---

Comment by git created at 2016-04-05 15:08:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-04-05 15:28:36

Can we have a real example of solving an LP over algebraic numbers?
I tried to create one by using #20301, but it does not quite fly:

```
sage: d=polytopes.dodecahedron()
sage: p,x=d.to_linear_program(solver='InteractiveLP',return_variable=True)
sage: p.set_objective(x[0]+x[1]+x[2])
sage: p.solve()
2.291796067500631?
sage: p.get_values()
[]
sage: p.get_values(x)
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-21-d8eb94d9ce26> in <module>()
----> 1 p.get_values(x)

/home/dima/software/sage/src/sage/numerical/mip.pyx in sage.numerical.mip.MixedIntegerLinearProgram.get_values (build/cythonized/sage/numerical/mip.c:9812)()
   1366                 c = {}
   1367                 for (k,v) in l.items():
-> 1368                     c[k] = self._backend.get_variable_value(self._variables[v])
   1369                 val.append(c)
   1370             elif isinstance(l, list):

/home/dima/software/sage/src/sage/numerical/backends/interactivelp_backend.pyx in sage.numerical.backends.interactivelp_backend.InteractiveLPBackend.get_variable_value (build/cythonized/sage/numerical/backends/interactivelp_backend.c:8385)()
    700         """
    701         if str(self.lp.decision_variables()[variable]) != str(self.lp_std_form.decision_variables()[variable]):
--> 702             raise NotImplementedError("Undoing the standard-form transformation is not implemented")
    703         return self.final_dictionary.basic_solution()[variable]
    704 

NotImplementedError: Undoing the standard-form transformation is not implemented
```


anyway, that `p.get_values(x)` ought to be fixed, perhaps on another ticket. By now you can still make this ticket depend on #20301, and give the above (without `p.get_values(x)`) as a doctest. 
Or perhaps you know a workaround to get the values regardless?


---

Comment by novoselt created at 2016-04-05 15:32:52

#20311 implements going back from the standard form, so will allow to address this problem.


---

Comment by mkoeppe created at 2016-04-05 15:49:42

Until #20301 and #20311 are merged into develop, I will modify the test with algebraic numbers as follows so you can see the solution vector, using backend methods:

```
            sage: poly = polytopes.dodecahedron(base_ring=AA)
            sage: lp = poly.to_linear_program(solver='InteractiveLP')
            sage: b = lp.get_backend()
            sage: for k in range(3): b.variable_lower_bound(k, 0)
            sage: b.set_objective([1, 1, 1])
            sage: lp.solve()
            2.291796067500631?
            sage: [b.get_variable_value(k) for k in range(3)]
            [0.763932022500211?, 0.763932022500211?, 0.763932022500211?]
```

(I already have a patch on a branch that uses these tickets and has a prettier version of this example.)


---

Comment by git created at 2016-04-05 16:06:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-05 16:29:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-04-05 22:57:51

in the last commit, the line 

```
sage: p = get_solver('InteractiveLP', base_ring=QQ)
```

should be

```
sage: p = get_solver('InteractiveLP', base_ring=QQ); p
```


otherwise the doctest fails


---

Comment by git created at 2016-04-05 23:21:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2016-04-05 23:22:43

Thanks. 
Another thing was wrong with this simple line. Annoyingly, the first argument to `get_solver` is not the solver name but rather the obscure argument `constraint_generation`.


---

Comment by dimpase created at 2016-04-05 23:23:31

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2016-04-05 23:23:31

OK, good.


---

Comment by mkoeppe created at 2016-04-05 23:24:20

Thanks for reviewing!


---

Comment by vbraun created at 2016-04-06 23:03:29

Resolution: fixed
