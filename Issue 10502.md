# Issue 10502: Add services to Sage.app

Issue created by migration from Trac.

Original creator: iandrus

Original creation time: 2011-01-04 14:47:33

Assignee: iandrus

CC:  kcrisman

Keywords: mac app,services

Add services to Sage.app like evaluating Sage code in place and creating a new notebook with selection.



---

Attachment


---

Comment by iandrus created at 2011-01-04 14:52:54

Changing status from new to needs_review.


---

Comment by iandrus created at 2011-01-04 14:52:54

Shoot.  Somehow it uploaded 2 copies of the exact same patch.  Oh well.

Apply trac_10555-extcode.patch
requires #8473


---

Comment by kcrisman created at 2011-04-06 15:11:52

I'm not sure exactly what's been added here - I always find the code for the app inscrutable, no thanks to Apple, I guess.  What things should one test here?  (A list of all things added would be great, maybe some typical use cases.)


---

Comment by iandrus created at 2011-04-09 10:19:10

Replying to [comment:3 kcrisman]:
> I'm not sure exactly what's been added here - I always find the code for the app inscrutable, no thanks to Apple, I guess.  What things should one test here?  (A list of all things added would be great, maybe some typical use cases.)

I thought I had added the documentation, but it's in another repository, so it needs a different patch. *sigh*

I think most of them (and their use cases) are fairly self-explanatory, at least after you read the documentation.  If not, then please let me know.

One potential problem is having more than one Sage.app and it getting confused about which version it should use for the service.  Actually, I'll add that to the documentation...  I'm not sure of a work around at the moment.


---

Attachment


---

Comment by kcrisman created at 2011-08-01 21:16:46

This depends on #8473 and #11026.


---

Comment by kcrisman created at 2012-06-14 19:57:02

#8473 is solved, see  the [sagenb upstream pull request](https://github.com/sagemath/sagenb/pull/31).

Putting this to "needs info" because I don't know whether this patch will be compatible with the new notebook.


---

Comment by iandrus created at 2012-06-14 20:10:36

This patch should be fine.  It only depends on #8473 for the "new notebook with selection" service.  What it does is create a temporary txt file and then upload it to the server using the functionality of #11026.


---

Comment by kcrisman created at 2012-07-06 01:48:59


```
On Mac OS 10.6 you will 
have to enable those you wish to use in System Preferences > Keyboard > 
Keyboard Shortcuts > Services. 
```

I can't get this to work.  I thought maybe it was because I had multiple Sages, but even deleting them (though not emptying the Trash) didn't help.  Maybe I'm doing something not quite right.  Perhaps the instructions aren't as complete as they need to be.

But otherwise the infrastructure for this seems to be right on track!  Putting as 'needs work', but feel free to correct me if I just forgot something.


---

Comment by kcrisman created at 2012-07-06 01:48:59

Changing status from needs_review to needs_work.


---

Comment by iandrus created at 2012-07-12 13:18:59

I think it might be related to having several Sage.app's and some don't have the services.  In particular if you build a new version I don't think it always picks up changes (because of caching), especially if the version number hasn't changed.  If you are building in Xcode rather than with `sage -bdist` the version wouldn't change.  You might consider restarting, or just running `/System/Library/CoreServices/pbs` which should rebuild the services list.  If that works, then we should probably add it to the README.


---

Comment by kcrisman created at 2012-07-12 18:32:53

Replying to [comment:9 iandrus]:
> I think it might be related to having several Sage.app's and some don't have the services.  In particular if you build a new version I don't think it always picks up changes (because of caching), especially if the version number hasn't changed.  If you are building in Xcode rather than with `sage -bdist` the version wouldn't change.  You might consider restarting, or just running `/System/Library/CoreServices/pbs` which should rebuild the services list.  If that works, then we should probably add it to the README.

Okay, I'll try this. It will take a while because of having to do the restart or whatever.  

But will this patch still work, or does it need rebasing on #11026?


---

Attachment

Updating for changes to 8473


---

Comment by iandrus created at 2012-07-12 20:42:53

Replying to [comment:10 kcrisman]:
> Replying to [comment:9 iandrus]:
 
> But will this patch still work, or does it need rebasing on #11026?

IIRC it applied with some fuzz, but I rebased it.


---

Comment by kcrisman created at 2012-07-13 02:45:49

> or just running /System/Library/CoreServices/pbs which should rebuild the services list. If that works, then we should probably add it to the README.

Awww yeahhhh.  Yup, this works, so you definitely should add this to the instructions.

Unfortunately, apparently it has trouble deciding on an app.  I highlighted some text (`2+2`), right-clicked, chose preparse, and got

```
Running...
/Users/.../sage-4.4.4-mcbc/data/extcode/sage/ext/mac-app/Sage.app/Contents/Resources/script: line 14: cd: /tmp/sage-map-app: No such file or directory
Setting environment variables
/Users/.../sage-4.4.4-mcbc/data/extcode/sage/ext/mac-app/Sage.app/Contents/Resources/script: line 18: ./local/bin/sage-env: No such file or directory
```

I didn't even know I *had* a Sage app in there!  And in fact, I don't - I just have the usual data/extcode stuff.  This was a surprise.  Yes, I have the correct binary picked for the actual existing Sage app (I used it to test #10556 just now and `which sage` was always what it was supposed to be).

Moving this binary off the Desktop and into Downloads fixed the problem.  Not sure what that was about.  But if you can't even have a command-line Sage somewhere around for this, that's a little different from the other issues we've seen with multiple Sage.app's.

----

Trying the services:
* Preparse was almost eery.  Seemed to work fine.
* Trying to _evaluate_ `2+3` and replace it:

```
The “Evaluate Code in Sage (and replace)” service could not be used because the “Sage-click-path-services” application did not provide valid data.

Try using the service differently, or contact the vendor for an updated version of “Sage-click-path-services.”
```

  Whether the server was on or not did not seem to matter.  Oh wait, I needed to use `print` ... well, maybe that should be even bigger?  Is it possible to detect the word `print`?  Or maybe since we don't really do that with the menu shortcut we don't need to here.  What do you think?

* With trying to get it to execute in a new terminal session:

```
sage:  arrow2d(headpoint=None, tailpoint=None); exit

'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'
sage: 
```

  Wow!  Where did that come from?  I know that sort of message has been bandied about elsewhere - has that been built in all the time in the app?  I haven't seen it in prior testing, that I recall, though that was a long time ago.  Awesome.  Except for the fact that in this case it doesn't actually exit, since it's inside Sage.  That probably will need a little tweaking.

* As for trying the new worksheet file, this didn't seem to work as well.

```
http://localhost:8000/upload_worksheet?url=file://localhost/var/folders/Yy/YytEJm5VEB0+pBRD7JNLe++++TQ/-Tmp-/sage.fp5w.txt
```

  never opened, it just sat like a bump in the browser URL area.

* Uncompressing Sage packages is weird.  It creates the directory, but with a `[space]2` after it.  This also causes problems in compressing.
* Unpacking spkg command just quits mid-word in the "preview of command" popup (I really like this in these things) and there is no scroll bar to indicate it goes on.  You have to pull on the popup window and make it bigger.
  And then there is this issue.

```
/Users/.../sage-5.1.beta1-flask/sage --pkg_nc /Users/.../brian-1.2.1.p0 2
```

  which clearly isn't going to work, because there is no `brian-1.2.1.p0`, there is only `brian-1.2.1.p0\ 2`.    Whatever escaping I do, I then get this error message that you shouldn't have weird characters anyway, and then it tells me also that 2.spkg can't be created.
  And then even when I make a normal thing, I get

```
Creating Sage package /Users/.../brian-1.2.1.p1
tar: brian-1.2.1.p1: Cannot stat: No such file or directory
tar: Error exit delayed from previous errors.

Created package brian-1.2.1.p1.spkg.

    NAME: brian
 VERSION: 1.2.1.p1
    SIZE: 0K
 HG REPO: Error reading repository
SPKG.txt: File is missing
```

  i.e. this part is broken, because I shouldn't have to think to use it.
* What sort of files should give the service for testing?  I can't get it for .rst or .py files.  Maybe that's because I don't have Sage as the "default open" for such files.  
  It _does_ work for folders.  It _does_ work for .sage files.  But you'd think that even for things that weren't default to open in Sage.app, they should still do what I ask.


----

Overall, it looks cool.  I certainly now think that Services are useful in general!  Hadn't really tried much before.  But I don't know that these services are quite ready for prime-time yet.


---

Comment by iandrus created at 2012-07-13 10:27:18

Replying to [comment:12 kcrisman]:
> > or just running /System/Library/CoreServices/pbs which should rebuild the services list. If that works, then we should probably add it to the README.
> 
> Awww yeahhhh.  Yup, this works, so you definitely should add this to the instructions.

Done.

> Unfortunately, apparently it has trouble deciding on an app.  I highlighted some text (`2+2`), right-clicked, chose preparse, and got
> {{{
> Running...
> /Users/.../sage-4.4.4-mcbc/data/extcode/sage/ext/mac-app/Sage.app/Contents/Resources/script: line 14: cd: /tmp/sage-map-app: No such file or directory
> Setting environment variables
> /Users/.../sage-4.4.4-mcbc/data/extcode/sage/ext/mac-app/Sage.app/Contents/Resources/script: line 18: ./local/bin/sage-env: No such file or directory
> }}}
> I didn't even know I *had* a Sage app in there!  And in fact, I don't - I just have the usual data/extcode stuff.  This was a surprise.  Yes, I have the correct binary picked for the actual existing Sage app (I used it to test #10556 just now and `which sage` was always what it was supposed to be).
> 
> Moving this binary off the Desktop and into Downloads fixed the problem.  Not sure what that was about.  But if you can't even have a command-line Sage somewhere around for this, that's a little different from the other issues we've seen with multiple Sage.app's.

Yes, this is a big problem.  That's an old Sage!  IIRC I used to include a Sage.app that wasn't fully functional, and then just replaced a few things instead of building it.  So old versions of Sage can be a problem.  Choosing which Sage.app to use is problematic in general though.  AFAICT it's not documented anywhere and subject to change etc.  I think it's supposed to use the one with the biggest version, but if you build in Xcode the version is just SAGE_VERSION.  In my experience it will use a running app over one that's not running.

You can find all versions of Sage.app on your system with

```
mdfind "kMDItemCFBundleIdentifier == 'org.sagemath.Sage'"
```

perhaps that should be documented.  I would like to have some concrete suggestions before I document it though.

> ----
> 
> Trying the services:
> * Preparse was almost eery.  Seemed to work fine.

Eery in what way?  A good way?

> * Trying to _evaluate_ `2+3` and replace it:
> {{{
> The “Evaluate Code in Sage (and replace)” service could not be used because the “Sage-click-path-services” application did not provide valid data.
> 
> Try using the service differently, or contact the vendor for an updated version of “Sage-click-path-services.”
> }}}
>   Whether the server was on or not did not seem to matter.  Oh wait, I needed to use `print` ... well, maybe that should be even bigger?  Is it possible to detect the word `print`?  Or maybe since we don't really do that with the menu shortcut we don't need to here.  What do you think?

Hmm.   It didn't cause an error for me.  Do you see anything in Console.app?  As for requiring print, I agree.  I just call `sage -c`.  It's hard though because you may not want to see all the output from a longer session, and just adding print won't work if there is more than one statement.  I don't suppose long chunks of code is a primary use case though.  


> * With trying to get it to execute in a new terminal session:
> {{{
> sage:  arrow2d(headpoint=None, tailpoint=None); exit
> 
> 'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'
> sage: 
> }}}
>   Wow!  Where did that come from?  I know that sort of message has been bandied about elsewhere - has that been built in all the time in the app?  I haven't seen it in prior testing, that I recall, though that was a long time ago.  Awesome.  Except for the fact that in this case it doesn't actually exit, since it's inside Sage.  That probably will need a little tweaking.

I didn't see that because I use the "don't exit" variant.  I don't think it should be that hard to fix, though perhaps a bit ugly.

> * As for trying the new worksheet file, this didn't seem to work as well.
> {{{
> http://localhost:8000/upload_worksheet?url=file://localhost/var/folders/Yy/YytEJm5VEB0+pBRD7JNLe++++TQ/-Tmp-/sage.fp5w.txt
> }}}
>   never opened, it just sat like a bump in the browser URL area.

It's not getting URL encoded.  I'll fix that.

> * Uncompressing Sage packages is weird.  It creates the directory, but with a `[space]2` after it.  This also causes problems in compressing.

Okay I see that too.  I know it worked before, so I wonder what changed.

> * Unpacking spkg command just quits mid-word in the "preview of command" popup (I really like this in these things) and there is no scroll bar to indicate it goes on.  You have to pull on the popup window and make it bigger.

I have to admit, I don't know what you are talking about with the "preview of command" popup.  Are you on Lion?  Maybe they added something wrt services.

>   And then there is this issue.
> {{{
> /Users/.../sage-5.1.beta1-flask/sage --pkg_nc /Users/.../brian-1.2.1.p0 2
> }}}
>   which clearly isn't going to work, because there is no `brian-1.2.1.p0`, there is only `brian-1.2.1.p0\ 2`.    Whatever escaping I do, I then get this error message that you shouldn't have weird characters anyway, and then it tells me also that 2.spkg can't be created.
>   And then even when I make a normal thing, I get
> {{{
> Creating Sage package /Users/.../brian-1.2.1.p1
> tar: brian-1.2.1.p1: Cannot stat: No such file or directory
> tar: Error exit delayed from previous errors.
> 
> Created package brian-1.2.1.p1.spkg.
> 
>     NAME: brian
>  VERSION: 1.2.1.p1
>     SIZE: 0K
>  HG REPO: Error reading repository
> SPKG.txt: File is missing
> }}}
>   i.e. this part is broken, because I shouldn't have to think to use it.

Okay, I probably never tried it with spaces in the name.  Thanks

> * What sort of files should give the service for testing?  I can't get it for .rst or .py files.  Maybe that's because I don't have Sage as the "default open" for such files.  
>   It _does_ work for folders.  It _does_ work for .sage files.  But you'd think that even for things that weren't default to open in Sage.app, they should still do what I ask.

Which service? The creating an spkg service?  That should only show up for directories.

Thanks for all the testing, I know it's a thankless job and I'm sorry nothing works.  :-(  I'm not sure when I can get to fixing these since I _really_ need to work on my thesis and they probably aren't simple fixes.


---

Comment by kcrisman created at 2012-07-13 11:56:34

> I'm not sure when I can get to fixing these since I _really_ need to work on my thesis and they probably aren't simple fixes.
Then you should forget about it.  This is much lower priority, since one can just do cut and paste and open it.  #11026 was so much more awesome than anything here.  When you finish your degree you'll have time for this... or maybe not ;-)


---

Comment by iandrus created at 2014-06-03 05:21:33

This is just a port of the changes I had before to the git workflow.  I haven't yet tried to fix anything.
----
New commits:


---

Comment by git created at 2014-06-03 05:32:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-10 06:11:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by iandrus created at 2014-06-10 06:14:07

I think the issues should be fixed now.   Unless I forgot one while reading this ticket.


---

Comment by iandrus created at 2014-06-10 06:14:07

Changing status from needs_work to needs_review.


---

Comment by kcrisman created at 2014-11-13 19:55:43

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2014-11-13 19:56:14

Changing status from positive_review to needs_review.


---

Comment by novoselt created at 2017-02-05 05:53:11

Does not apply!


---

Comment by novoselt created at 2017-02-05 05:53:11

Changing status from needs_review to needs_work.


---

Comment by iandrus created at 2017-04-19 04:10:46

`@`kcrisman, do you think there is any value to these any more?  Several of them (creating packages etc.) no longer make sense at all, and I wonder how useful the others ever were.  I could try to update them, but I'm afraid it's really not worth it.

You can read the documentation of what they were intended to do at https://git.sagemath.org/sage.git/commit/?id=64b793848e4e392673804335c4284d673f43a952


---

Comment by kcrisman created at 2017-04-19 12:56:49

Changing status from needs_work to positive_review.


---

Comment by kcrisman created at 2017-04-19 12:56:49

Given the time that has passed and that it seems less likely people will be taking random text from other applications and putting it in Sage, I think that is okay.


---

Comment by embray created at 2017-07-13 07:54:31

Resolution: wontfix


---

Comment by embray created at 2017-07-13 07:54:31

Closing tickets in the sage-duplicate/invalid/wontfix module with positive_review (i.e. someone has confirmed they should be closed).
