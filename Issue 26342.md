# Issue 26342: Fix ecl.pyx doctests with threaded ecl

archive/issues_026342.json:
```json
{
    "body": "CC:  fbissey @timokau saraedum\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/26579\n\n",
    "created_at": "2018-10-28T10:32:04Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "PLEASE CHANGE"
    ],
    "title": "Fix ecl.pyx doctests with threaded ecl",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26342",
    "user": "arojas"
}
```
CC:  fbissey @timokau saraedum



Issue created by migration from https://trac.sagemath.org/ticket/26579





---

archive/issue_comments_370933.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-10-28T10:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370933",
    "user": "arojas"
}
```

New commits:



---

archive/issue_comments_370934.json:
```json
{
    "body": "Changing keywords from \"\" to \"packaging\".",
    "created_at": "2018-10-28T10:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370934",
    "user": "arojas"
}
```

Changing keywords from "" to "packaging".



---

archive/issue_comments_370935.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-28T10:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370935",
    "user": "arojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370936.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-10-28T10:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370936",
    "user": "arojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_370937.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to distribution.",
    "created_at": "2018-10-28T10:36:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370937",
    "user": "arojas"
}
```

Changing component from PLEASE CHANGE to distribution.



---

archive/issue_comments_370938.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-28T20:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370938",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370939.json:
```json
{
    "body": "Feels like something I have seen before. Anyway the fix in question is extremely minor and  is at the level of a typo correction.",
    "created_at": "2018-10-28T20:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370939",
    "user": "fbissey"
}
```

Feels like something I have seen before. Anyway the fix in question is extremely minor and  is at the level of a typo correction.



---

archive/issue_comments_370940.json:
```json
{
    "body": "At least a while ago, running ecllib in sage with thread support was rather fundamentally not possible: when threads are enabled, ecl will have a separate thread for signal handling (and garbage collection). Furthermore, it will use some very strange signals for syncing processes around garbage collection.\n\nSage will swap signal handlers when entering/exiting ecllib. That's fundamentally incompatible with a multi-threaded approach.\n\nI think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).",
    "created_at": "2018-10-28T20:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370940",
    "user": "nbruin"
}
```

At least a while ago, running ecllib in sage with thread support was rather fundamentally not possible: when threads are enabled, ecl will have a separate thread for signal handling (and garbage collection). Furthermore, it will use some very strange signals for syncing processes around garbage collection.

Sage will swap signal handlers when entering/exiting ecllib. That's fundamentally incompatible with a multi-threaded approach.

I think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).



---

archive/issue_comments_370941.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-10-28T20:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370941",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_370942.json:
```json
{
    "body": "Replying to [comment:4 nbruin]:\n> I think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).\n\nI don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.\n\nIf there are concerns about possible issues with threaded ecl (of which I'm not aware after having packaged Sage for 4 years) they should be addressed elsewhere by adding appropriate tests for the actual issues. Again, I don't understand why they should prevent merging this.",
    "created_at": "2018-10-29T20:41:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370942",
    "user": "arojas"
}
```

Replying to [comment:4 nbruin]:
> I think before changing the doctest to just pass, I think you should submit some evidence that these problems do not arise anymore. We could even extend the doctests to more properly test if garbage collection in ecl acts nicely with multithreading in sage now (I have trouble imagining how it could).

I don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.

If there are concerns about possible issues with threaded ecl (of which I'm not aware after having packaged Sage for 4 years) they should be addressed elsewhere by adding appropriate tests for the actual issues. Again, I don't understand why they should prevent merging this.



---

archive/issue_comments_370943.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-29T22:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370943",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_370944.json:
```json
{
    "body": "Its not easy to write tests for signal / multithread interop, things just tend to randomly crash on some systems but not on others. How much of the Sage testsuite passes reliably on Arch?",
    "created_at": "2018-10-29T22:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370944",
    "user": "vbraun"
}
```

Its not easy to write tests for signal / multithread interop, things just tend to randomly crash on some systems but not on others. How much of the Sage testsuite passes reliably on Arch?



---

archive/issue_comments_370945.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2018-10-29T22:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370945",
    "user": "vbraun"
}
```

Changing status from closed to new.



---

archive/issue_comments_370946.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2018-10-29T22:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370946",
    "user": "vbraun"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_370947.json:
```json
{
    "body": "I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.",
    "created_at": "2018-10-29T23:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370947",
    "user": "@timokau"
}
```

I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.



---

archive/issue_comments_370948.json:
```json
{
    "body": "Replying to [comment:8 gh-timokau]:\n> I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.\n\nExcept that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.\n\nAnyway, not going to waste more of my time pushing for this. I'll just keep ignoring the test as I've always done.",
    "created_at": "2018-10-30T06:48:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370948",
    "user": "arojas"
}
```

Replying to [comment:8 gh-timokau]:
> I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.

Except that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.

Anyway, not going to waste more of my time pushing for this. I'll just keep ignoring the test as I've always done.



---

archive/issue_comments_370949.json:
```json
{
    "body": "Replying to [comment:5 arojas]:\n\n> I don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.\n\nSee #11752 for an actual bug report that led to the disabling of threads. It's 7 years old, so things might have changed, but it was a very concrete issue that crashed sage.\n\nThe incompatibility I observed before was so bad that sage should refuse to load ecllib when it has threading enabled. If the situation has improved, it's great. Otherwise, Arch should modify its sage dependencies and link to a libecl-nothreading.so or something. It's unfortunate, but as far as I know, sage will *not* work properly with a threaded libecl.\n\nIt would be great if sage could work with a libecl configured with default options (which means threading  nowadays -- when sage adopted libecl it didn't have threading), especially because it would mean better integration with distributions like Arch. I'm just sharing my earlier experience that this was (at least at some point) not the case. I expect that the test suite won't exercise ecl enough to reliably trigger the behaviours that would crash sage/ecl-with-threading.\n\n**EDIT:** In fact, the ticket in question deals exactly with the scenario you are facing: running sage in a way that is more integrated in a larger distribution (Mandriva there). It looked like it turned out to be possible at the time to run a generically compiled ECL, but to turn off the threading with a boot-time option (it looks like the option got renamed and that the test is exactly checking that the option is set appropriately).",
    "created_at": "2018-10-30T06:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370949",
    "user": "nbruin"
}
```

Replying to [comment:5 arojas]:

> I don't really see what this has to do with this ticket. I'm not proposing to enable threading in sage's ecl or anything of that sort. This patch is just so that distributions that *already* build ecl with threads (something that is not going to change regardless of whether this is merged or not) don't get a bogus test failure that doesn't really provide any value or give any hint about what issues threaded ecl may cause, and only creates noise in the testuite output.

See #11752 for an actual bug report that led to the disabling of threads. It's 7 years old, so things might have changed, but it was a very concrete issue that crashed sage.

The incompatibility I observed before was so bad that sage should refuse to load ecllib when it has threading enabled. If the situation has improved, it's great. Otherwise, Arch should modify its sage dependencies and link to a libecl-nothreading.so or something. It's unfortunate, but as far as I know, sage will *not* work properly with a threaded libecl.

It would be great if sage could work with a libecl configured with default options (which means threading  nowadays -- when sage adopted libecl it didn't have threading), especially because it would mean better integration with distributions like Arch. I'm just sharing my earlier experience that this was (at least at some point) not the case. I expect that the test suite won't exercise ecl enough to reliably trigger the behaviours that would crash sage/ecl-with-threading.

**EDIT:** In fact, the ticket in question deals exactly with the scenario you are facing: running sage in a way that is more integrated in a larger distribution (Mandriva there). It looked like it turned out to be possible at the time to run a generically compiled ECL, but to turn off the threading with a boot-time option (it looks like the option got renamed and that the test is exactly checking that the option is set appropriately).



---

archive/issue_comments_370950.json:
```json
{
    "body": "Replying to [comment:9 arojas]:\n> Replying to [comment:8 gh-timokau]:\n> > I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.\n> \n> Except that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.\n\nWell the first thing I would try is to build ecl with the same options and see if that fixes anything. If there are no actual issues with threading however that is of course different. Would be nice if someone with more experience with the ecl interface could re-evaluate.",
    "created_at": "2018-10-30T09:52:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370950",
    "user": "@timokau"
}
```

Replying to [comment:9 arojas]:
> Replying to [comment:8 gh-timokau]:
> > I agree with nbruin here. If sage doesn't work with an ecl with threading enabled, I'd rather have a doctest that tells me that than having to figure out the underlying reason from other seemingly unrelated test failures.
> 
> Except that this test doesn't tell you anything, simply that your ecl has been build with different options. I don't see how that's going to help when you get a seemingly unrelated crash somewhere else. So far I've only heard about hypothetical issues that there's no way to test and that no Arch user has ever reported in 4 years, nothing concrete.

Well the first thing I would try is to build ecl with the same options and see if that fixes anything. If there are no actual issues with threading however that is of course different. Would be nice if someone with more experience with the ecl interface could re-evaluate.



---

archive/issue_comments_370951.json:
```json
{
    "body": "Good news! I looked up the particular configuration option:\n\nhttps://common-lisp.net/project/ecl/static/manual/re97.html#table.boot_options\n\nand it's only the *signal number* that would be used for thread communication in ECL, should multiple threads exist. I don't think we ever should have multiple threads in ECL within sage, because the signal handling would get completely screwed up. However, this option doesn't particularly seem to influence whether we do. I think it might be a bit of a red flag if this option does have a special value (because it might indicate an ECL build that has thread support), but that in itself is not necessarily indicative of problems. Also, with the work on #11752 it seems that just having thread support in ECL built doesn't necessarily trigger problems. So it might be OK to not test this option.\n\nOn the other hand, \"ECL_OPT_SIGNAL_HANDLING_THREAD\" really should be checked to be 0. If it isn't we can really expect trouble.",
    "created_at": "2018-10-30T22:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370951",
    "user": "nbruin"
}
```

Good news! I looked up the particular configuration option:

https://common-lisp.net/project/ecl/static/manual/re97.html#table.boot_options

and it's only the *signal number* that would be used for thread communication in ECL, should multiple threads exist. I don't think we ever should have multiple threads in ECL within sage, because the signal handling would get completely screwed up. However, this option doesn't particularly seem to influence whether we do. I think it might be a bit of a red flag if this option does have a special value (because it might indicate an ECL build that has thread support), but that in itself is not necessarily indicative of problems. Also, with the work on #11752 it seems that just having thread support in ECL built doesn't necessarily trigger problems. So it might be OK to not test this option.

On the other hand, "ECL_OPT_SIGNAL_HANDLING_THREAD" really should be checked to be 0. If it isn't we can really expect trouble.



---

archive/issue_comments_370952.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-10-31T06:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370952",
    "user": "arojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370953.json:
```json
{
    "body": "Great, so can this be set back to positive_review?",
    "created_at": "2018-10-31T06:53:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370953",
    "user": "arojas"
}
```

Great, so can this be set back to positive_review?



---

archive/issue_comments_370954.json:
```json
{
    "body": "Replying to [comment:13 arojas]:\n> Great, so can this be set back to positive_review?\n\nWhile you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.",
    "created_at": "2018-10-31T06:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370954",
    "user": "fbissey"
}
```

Replying to [comment:13 arojas]:
> Great, so can this be set back to positive_review?

While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.



---

archive/issue_comments_370955.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-31T06:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370955",
    "user": "fbissey"
}
```

Resolution: fixed



---

archive/issue_comments_370956.json:
```json
{
    "body": "Replying to [comment:14 fbissey]:\n> Replying to [comment:13 arojas]:\n> > Great, so can this be set back to positive_review?\n> \n> While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.\n\nThis is not merged in beta2, please reopen.",
    "created_at": "2018-11-01T22:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370956",
    "user": "arojas"
}
```

Replying to [comment:14 fbissey]:
> Replying to [comment:13 arojas]:
> > Great, so can this be set back to positive_review?
> 
> While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.

This is not merged in beta2, please reopen.



---

archive/issue_comments_370957.json:
```json
{
    "body": "Changing status from closed to new.",
    "created_at": "2018-11-01T22:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370957",
    "user": "fbissey"
}
```

Changing status from closed to new.



---

archive/issue_comments_370958.json:
```json
{
    "body": "Replying to [comment:15 arojas]:\n> Replying to [comment:14 fbissey]:\n> > Replying to [comment:13 arojas]:\n> > > Great, so can this be set back to positive_review?\n> > \n> > While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.\n> \n> This is not merged in beta2.\n\nOK I didn't see it being pulled off again :(  putting it back to positive review then.",
    "created_at": "2018-11-01T22:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370958",
    "user": "fbissey"
}
```

Replying to [comment:15 arojas]:
> Replying to [comment:14 fbissey]:
> > Replying to [comment:13 arojas]:
> > > Great, so can this be set back to positive_review?
> > 
> > While you were having this discussion, this has been merged for the next beta and closed fixed already. Restoring to that state.
> 
> This is not merged in beta2.

OK I didn't see it being pulled off again :(  putting it back to positive review then.



---

archive/issue_comments_370959.json:
```json
{
    "body": "Resolution changed from fixed to ",
    "created_at": "2018-11-01T22:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370959",
    "user": "fbissey"
}
```

Resolution changed from fixed to 



---

archive/issue_comments_370960.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-01T22:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370960",
    "user": "fbissey"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_370961.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-01T22:27:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370961",
    "user": "fbissey"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_370962.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-04T10:38:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26342",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26342#issuecomment-370962",
    "user": "vbraun"
}
```

Resolution: fixed
