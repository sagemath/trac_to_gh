# Issue 24432: Re-enable threads on OpenBLAS

archive/issues_024432.json:
```json
{
    "body": "Keywords: openblas cygwin\n\nIt was disabled in #22021 to work around some deadlocks that were occurring, and still further problems were reported in #23933.\n\nBut these issues appear to be fixed as of OpenBLAS 0.2.20 which Sage is now on.  It would be good if more people can test this though (especially on OSX).\n\nThis will also require a patch for Cygwin which I'll add to this shortly.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24669\n\n",
    "created_at": "2018-02-06T11:07:40Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "title": "Re-enable threads on OpenBLAS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24432",
    "user": "embray"
}
```
Keywords: openblas cygwin

It was disabled in #22021 to work around some deadlocks that were occurring, and still further problems were reported in #23933.

But these issues appear to be fixed as of OpenBLAS 0.2.20 which Sage is now on.  It would be good if more people can test this though (especially on OSX).

This will also require a patch for Cygwin which I'll add to this shortly.

Issue created by migration from https://trac.sagemath.org/ticket/24669





---

archive/issue_comments_342671.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-06T16:35:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342671",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342672.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-06T16:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342672",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_342673.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-06T16:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342673",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_342674.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-04-06T20:50:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342674",
    "user": "vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342675.json:
```json
{
    "body": "Thanks--this fix will be nice to have.",
    "created_at": "2018-04-09T09:38:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342675",
    "user": "embray"
}
```

Thanks--this fix will be nice to have.



---

archive/issue_comments_342676.json:
```json
{
    "body": "Breaks the testsuite\n\n```\n$ SAGE_CHECK=yes sage -p openblas\n[...]\ngfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o cblat1 cblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran \ngfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o zblat1 zblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran \n../libopenblas_haswell-r0.2.20.a: file not recognized: File truncated\ncollect2: error: ld returned 1 exit status\nmake[1]: *** [Makefile:138: cblat1] Error 1\n```\n",
    "created_at": "2018-05-10T14:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342676",
    "user": "vbraun"
}
```

Breaks the testsuite

```
$ SAGE_CHECK=yes sage -p openblas
[...]
gfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o cblat1 cblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran 
gfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o zblat1 zblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran 
../libopenblas_haswell-r0.2.20.a: file not recognized: File truncated
collect2: error: ld returned 1 exit status
make[1]: *** [Makefile:138: cblat1] Error 1
```




---

archive/issue_comments_342677.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-10T14:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342677",
    "user": "vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_342678.json:
```json
{
    "body": "I'm not convinced yet that that has anything to do with this patch (especially considering it was [accepted upstream](https://github.com/xianyi/OpenBLAS/pull/1450).",
    "created_at": "2018-05-11T14:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342678",
    "user": "embray"
}
```

I'm not convinced yet that that has anything to do with this patch (especially considering it was [accepted upstream](https://github.com/xianyi/OpenBLAS/pull/1450).



---

archive/issue_comments_342679.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-11T15:18:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342679",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_342680.json:
```json
{
    "body": "Well, I was able to reproduce it so I guess I'm convinced now :) But I don't see any obvious mechanism by which this would cause such an issue...",
    "created_at": "2018-05-11T15:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342680",
    "user": "embray"
}
```

Well, I was able to reproduce it so I guess I'm convinced now :) But I don't see any obvious mechanism by which this would cause such an issue...



---

archive/issue_comments_342681.json:
```json
{
    "body": "I believe this issue can reasonably be addressed for Sage 8.4.",
    "created_at": "2018-07-18T11:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342681",
    "user": "embray"
}
```

I believe this issue can reasonably be addressed for Sage 8.4.



---

archive/issue_comments_342682.json:
```json
{
    "body": "For what it's worth, threads are not disabled in nix's openblas and all our tests (sage and other packages) pass.",
    "created_at": "2018-08-04T12:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342682",
    "user": "@timokau"
}
```

For what it's worth, threads are not disabled in nix's openblas and all our tests (sage and other packages) pass.



---

archive/issue_comments_342683.json:
```json
{
    "body": "Yeah, I'm not sure why this is causing problems when running the test suite.  I suspect it's also an upstream issue though, or an oddity in how we run the tests; there should be no problem normally for enabling threads...\n\nI just haven't bothered to look into this yet, but this really should be fixed.",
    "created_at": "2018-08-06T14:46:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342683",
    "user": "embray"
}
```

Yeah, I'm not sure why this is causing problems when running the test suite.  I suspect it's also an upstream issue though, or an oddity in how we run the tests; there should be no problem normally for enabling threads...

I just haven't bothered to look into this yet, but this really should be fixed.



---

archive/issue_comments_342684.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2018-08-06T14:47:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342684",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_342685.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-08-06T15:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342685",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_342686.json:
```json
{
    "body": "Rebased on 8.4.beta0; not that there was a merge conflict or anything (it's a very simple change), but just because the original commit was pretty old...",
    "created_at": "2018-08-06T15:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342686",
    "user": "embray"
}
```

Rebased on 8.4.beta0; not that there was a merge conflict or anything (it's a very simple change), but just because the original commit was pretty old...



---

archive/issue_comments_342687.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-08-06T16:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342687",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_342688.json:
```json
{
    "body": "Turns out the answer was quite simple:  We also just had to remove `USE_THREAD=0` from the `spkg-check` script :|",
    "created_at": "2018-08-06T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342688",
    "user": "embray"
}
```

Turns out the answer was quite simple:  We also just had to remove `USE_THREAD=0` from the `spkg-check` script :|



---

archive/issue_comments_342689.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-08-06T16:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342689",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_342690.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-08-07T17:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342690",
    "user": "saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_342691.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-09T21:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342691",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_342692.json:
```json
{
    "body": "I believe that this broke `sage -tp` on some machines, see #26118.",
    "created_at": "2018-08-24T14:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24432",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24432#issuecomment-342692",
    "user": "saraedum"
}
```

I believe that this broke `sage -tp` on some machines, see #26118.
