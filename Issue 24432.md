# Issue 24432: Re-enable threads on OpenBLAS

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-02-06 11:07:40

Keywords: openblas cygwin

It was disabled in #22021 to work around some deadlocks that were occurring, and still further problems were reported in #23933.

But these issues appear to be fixed as of OpenBLAS 0.2.20 which Sage is now on.  It would be good if more people can test this though (especially on OSX).

This will also require a patch for Cygwin which I'll add to this shortly.


---

Comment by git created at 2018-02-06 16:35:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-06 16:36:04

New commits:


---

Comment by embray created at 2018-02-06 16:36:04

Changing status from new to needs_review.


---

Comment by vbraun created at 2018-04-06 20:50:58

Changing status from needs_review to positive_review.


---

Comment by embray created at 2018-04-09 09:38:17

Thanks--this fix will be nice to have.


---

Comment by vbraun created at 2018-05-10 14:44:00

Breaks the testsuite

```
$ SAGE_CHECK=yes sage -p openblas
[...]
gfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o cblat1 cblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran 
gfortran -O2 -Wall -m64  -L/mnt/disk/home/release/Sage/local/lib -Wl,-rpath,/mnt/disk/home/release/Sage/local/lib  -o zblat1 zblat1.o ../libopenblas_haswell-r0.2.20.a -lm -lgfortran -lm -lgfortran 
../libopenblas_haswell-r0.2.20.a: file not recognized: File truncated
collect2: error: ld returned 1 exit status
make[1]: *** [Makefile:138: cblat1] Error 1
```



---

Comment by vbraun created at 2018-05-10 14:44:00

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-05-11 14:53:15

I'm not convinced yet that that has anything to do with this patch (especially considering it was [accepted upstream](https://github.com/xianyi/OpenBLAS/pull/1450).


---

Comment by git created at 2018-05-11 15:18:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-05-11 15:21:41

Well, I was able to reproduce it so I guess I'm convinced now :) But I don't see any obvious mechanism by which this would cause such an issue...


---

Comment by embray created at 2018-07-18 11:47:03

I believe this issue can reasonably be addressed for Sage 8.4.


---

Comment by @timokau created at 2018-08-04 12:26:55

For what it's worth, threads are not disabled in nix's openblas and all our tests (sage and other packages) pass.


---

Comment by embray created at 2018-08-06 14:46:32

Yeah, I'm not sure why this is causing problems when running the test suite.  I suspect it's also an upstream issue though, or an oddity in how we run the tests; there should be no problem normally for enabling threads...

I just haven't bothered to look into this yet, but this really should be fixed.


---

Comment by embray created at 2018-08-06 14:47:35

Set assignee to embray.


---

Comment by git created at 2018-08-06 15:57:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-08-06 15:58:15

Rebased on 8.4.beta0; not that there was a merge conflict or anything (it's a very simple change), but just because the original commit was pretty old...


---

Comment by git created at 2018-08-06 16:17:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-08-06 16:18:22

Turns out the answer was quite simple:  We also just had to remove `USE_THREAD=0` from the `spkg-check` script :|


---

Comment by embray created at 2018-08-06 16:18:22

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2018-08-07 17:04:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-08-09 21:28:00

Resolution: fixed


---

Comment by saraedum created at 2018-08-24 14:27:20

I believe that this broke `sage -tp` on some machines, see #26118.
