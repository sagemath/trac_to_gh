# Issue 12176: variable ind has the wrong type in matrix indexing; and why are big sparse matrices so slow to make?

Issue created by migration from https://trac.sagemath.org/ticket/12348

Original creator: was

Original creation time: 2012-01-24 19:18:20

Assignee: jason, was

Oops, in the function  `def __getitem__(self, key)` in matrix0.pyx, the variable `ind` is of type int.  

This will work fine on 32-bit, but will be totally broken/buggy in subtle and surprising ways on 64-bit machines.  The type of ind should be `Py_ssize_t`, just like the type of `i`.  Nobody will notice this now, because there is some sort of massive weird inefficiency in the creation of sparse matrices (maybe the parent space has its basis constructed or something idiotic like that), which makes it impossible to make a large sparse matrix, even though this should be trivial, instant, fast, and take no memory:

```
sage: time a = matrix(QQ, 2^25, sparse=True)
Time: CPU 5.88 s, Wall: 8.46 s
sage: get_memory_usage()   # what ?
3908.29296875
```


The ind being an int was introduced in #4973.



---

Comment by dsm created at 2012-05-25 17:12:51

This is how the sparse matrix is being stored:


```
        [...]

        self._matrix = <mpq_vector*> sage_malloc(parent.nrows()*sizeof(mpq_vector))

        [...]
 
        for i from 0 <= i < parent.nrows():
            mpq_vector_init(&self._matrix[i], self._ncols, 0)

```


This even introduces a subtle slowdown when the object is lost because of the deallocation, which puzzled me for some time:


```
            for i from 0 <= i < self._nrows:
                mpq_vector_clear(&self._matrix[i])

```


I wonder if this is indirectly responsible for some of the surprisingly slow sparse routines.


---

Comment by was created at 2012-05-25 17:17:35

One solution would be to have a special case of null pointer for empty rows.  All code (e.g., echelon form) would have to be changed to take this special case into account.  That would resolve this problem. 

I wrote the mpq sparse matrix class for computing presentations of modular symbols spaces, and in that situation there are no zero rows, so this wasn't a problem for me.
