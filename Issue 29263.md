# Issue 29263: Install all Python packages using pip

archive/issues_029263.json:
```json
{
    "body": "CC:  @slel @tobiasdiez @embray @jhpalmieri @tscrim\n\nSome of our Python packages are still installed by calling setup.py directly. This should be fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/29500\n\n",
    "created_at": "2020-04-13T02:40:23Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Install all Python packages using pip",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29263",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @slel @tobiasdiez @embray @jhpalmieri @tscrim

Some of our Python packages are still installed by calling setup.py directly. This should be fixed

Issue created by migration from https://trac.sagemath.org/ticket/29500





---

archive/issue_comments_414317.json:
```json
{
    "body": "Would that be `gambit`, `numpy` and `pillow`?\n\nAnd is this how to find them?\n\n```\n$ git grep \"setup.py\" build/pkgs\n```\n",
    "created_at": "2020-05-09T23:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414317",
    "user": "https://github.com/slel"
}
```

Would that be `gambit`, `numpy` and `pillow`?

And is this how to find them?

```
$ git grep "setup.py" build/pkgs
```




---

archive/issue_comments_414318.json:
```json
{
    "body": "... Also consider pipenv + pipfile as suggested in #30317 ...",
    "created_at": "2020-08-30T19:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414318",
    "user": "https://github.com/mkoeppe"
}
```

... Also consider pipenv + pipfile as suggested in #30317 ...



---

archive/issue_comments_414319.json:
```json
{
    "body": "I would prefer not to have two separate package installation and management systems.  If the only motivation of this is the race condition, like I said this can be solved with an additional file lock to prevent multiple Python packages from being installed simultaneously.",
    "created_at": "2020-09-01T13:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414319",
    "user": "https://github.com/embray"
}
```

I would prefer not to have two separate package installation and management systems.  If the only motivation of this is the race condition, like I said this can be solved with an additional file lock to prevent multiple Python packages from being installed simultaneously.



---

archive/issue_comments_414320.json:
```json
{
    "body": "Narrowed the scope of the ticket.",
    "created_at": "2020-09-08T02:31:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414320",
    "user": "https://github.com/mkoeppe"
}
```

Narrowed the scope of the ticket.



---

archive/issue_comments_414321.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-08T05:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414321",
    "user": "https://github.com/mkoeppe"
}
```

New commits:



---

archive/issue_comments_414322.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-08T05:33:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414322",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_414323.json:
```json
{
    "body": "Replying to [comment:1 slelievre]:\n> Would that be `gambit`, `numpy` and `pillow`?\n> \n> And is this how to find them?\n> {{{\n> $ git grep \"setup.py\" build/pkgs\n> }}}\nYes, still need to take care of these.",
    "created_at": "2020-09-08T05:46:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414323",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:1 slelievre]:
> Would that be `gambit`, `numpy` and `pillow`?
> 
> And is this how to find them?
> {{{
> $ git grep "setup.py" build/pkgs
> }}}
Yes, still need to take care of these.



---

archive/issue_comments_414324.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-09-08T05:46:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414324",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_414325.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-08T19:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414326.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-09-08T20:04:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414326",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_414327.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-09T17:26:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414327",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414328.json:
```json
{
    "body": "- Why `sdh_store_and_pip_install_wheel requires . as only argument`? Why not just call it with no arguments?\n\n- This function should be documented in `developer/packaging.rst`.\n\n- Does `sage-pip-uninstall` leave the old wheels lying around?\n\n- Typo in `sage-pip-uninstall` (copied from `sage-pip-install`): \"this command hould use\"",
    "created_at": "2020-09-17T00:32:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414328",
    "user": "https://github.com/jhpalmieri"
}
```

- Why `sdh_store_and_pip_install_wheel requires . as only argument`? Why not just call it with no arguments?

- This function should be documented in `developer/packaging.rst`.

- Does `sage-pip-uninstall` leave the old wheels lying around?

- Typo in `sage-pip-uninstall` (copied from `sage-pip-install`): "this command hould use"



---

archive/issue_comments_414329.json:
```json
{
    "body": "Replying to [comment:28 jhpalmieri]:\n> - Why `sdh_store_and_pip_install_wheel requires . as only argument`? Why not just call it with no arguments?\n\nI did this to emphasize the analogy to `sage-pip-install`.\n\n> - This function should be documented in `developer/packaging.rst`.\n\nGood idea, will do.\n\n> - Does `sage-pip-uninstall` leave the old wheels lying around?\n\n`sage-pip-uninstall` is not really used for regular uninstalls. Rather, it \"force-uninstalls\" previously installed versions - in case the site-packages directory was somehow messed up. (This code was previously part of `sage-pip-install`.)\n\nThe wheels are installed with the staging mechanism (DESTDIR), which records the installed files. In this way, the `-clean` targets etc. automatically install the wheel.\n\n> - Typo in `sage-pip-uninstall` (copied from `sage-pip-install`): \"this command hould use\"\n\nThanks",
    "created_at": "2020-09-17T00:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414329",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:28 jhpalmieri]:
> - Why `sdh_store_and_pip_install_wheel requires . as only argument`? Why not just call it with no arguments?

I did this to emphasize the analogy to `sage-pip-install`.

> - This function should be documented in `developer/packaging.rst`.

Good idea, will do.

> - Does `sage-pip-uninstall` leave the old wheels lying around?

`sage-pip-uninstall` is not really used for regular uninstalls. Rather, it "force-uninstalls" previously installed versions - in case the site-packages directory was somehow messed up. (This code was previously part of `sage-pip-install`.)

The wheels are installed with the staging mechanism (DESTDIR), which records the installed files. In this way, the `-clean` targets etc. automatically install the wheel.

> - Typo in `sage-pip-uninstall` (copied from `sage-pip-install`): "this command hould use"

Thanks



---

archive/issue_comments_414330.json:
```json
{
    "body": "Replying to [comment:29 mkoeppe]:\n> The wheels are installed with the staging mechanism (DESTDIR), which records the installed files. In this way, the `-clean` targets etc. automatically install the wheel.\n\nTo clarify, both the wheels and the installation made from the wheels uses the staging mechanism.",
    "created_at": "2020-09-17T00:42:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414330",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:29 mkoeppe]:
> The wheels are installed with the staging mechanism (DESTDIR), which records the installed files. In this way, the `-clean` targets etc. automatically install the wheel.

To clarify, both the wheels and the installation made from the wheels uses the staging mechanism.



---

archive/issue_comments_414331.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-17T01:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414331",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414332.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-18T03:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414332",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_414333.json:
```json
{
    "body": "Seems okay to me, and it built and passed tests before, so I think it's okay. Of course, I can [no longer build Sage](https://trac.sagemath.org/ticket/30494#comment:9) anymore, so perhaps take this review with a grain of salt.",
    "created_at": "2020-09-18T03:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414333",
    "user": "https://github.com/jhpalmieri"
}
```

Seems okay to me, and it built and passed tests before, so I think it's okay. Of course, I can [no longer build Sage](https://trac.sagemath.org/ticket/30494#comment:9) anymore, so perhaps take this review with a grain of salt.



---

archive/issue_comments_414334.json:
```json
{
    "body": "Thanks!",
    "created_at": "2020-09-18T03:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414334",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_414335.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-09-21T21:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414335",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_414336.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2020-09-21T21:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414336",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_414337.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-21T21:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414337",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_414338.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2020-09-21T21:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414338",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_027039.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-09-27T09:09:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29263#event-27039"
}
```



---

archive/issue_comments_414339.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-27T09:09:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414339",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_414340.json:
```json
{
    "body": "Follow-up: #30771",
    "created_at": "2020-10-15T04:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414340",
    "user": "https://github.com/mkoeppe"
}
```

Follow-up: #30771



---

archive/issue_comments_414341.json:
```json
{
    "body": "I'm not really sure what the advantage is of this complication. For the follow-up do you propose eliminating the installation manifests installed to `/var/lib/sage/installed/`? I would very much prefer to not do that. I see no reason for Python packages to be arbitrarily treated differently in this regard. But I'm not sure if that is really the plan.",
    "created_at": "2020-10-22T13:33:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414341",
    "user": "https://github.com/embray"
}
```

I'm not really sure what the advantage is of this complication. For the follow-up do you propose eliminating the installation manifests installed to `/var/lib/sage/installed/`? I would very much prefer to not do that. I see no reason for Python packages to be arbitrarily treated differently in this regard. But I'm not sure if that is really the plan.



---

archive/issue_comments_414342.json:
```json
{
    "body": "Replying to [comment:40 embray]:\n> I'm not really sure what the advantage is of this complication. \nhttps://wiki.sagemath.org/ReleaseTours/sage-9.2#Reusable_wheels_for_the_Python_packages_built_by_the_Sage_distribution explains an immediate use case.",
    "created_at": "2020-10-22T15:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414342",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:40 embray]:
> I'm not really sure what the advantage is of this complication. 
https://wiki.sagemath.org/ReleaseTours/sage-9.2#Reusable_wheels_for_the_Python_packages_built_by_the_Sage_distribution explains an immediate use case.



---

archive/issue_comments_414343.json:
```json
{
    "body": "Replying to [comment:40 embray]:\n> For the follow-up do you propose eliminating the installation manifests installed to `/var/lib/sage/installed/`?\n\nI don't have a ticket for this at the moment. But I think it's unavoidable to make some changes. Already now these installation manifests (which duplicate the `.egg-info` record in `site-packages`) can fall out of sync with the actual installation when the user uses `sage -pip install`, which could lead to upgrades of some python package dependencies. It's best to use standard Python tools to manage Python packages.",
    "created_at": "2020-10-22T15:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29263",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29263#issuecomment-414343",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:40 embray]:
> For the follow-up do you propose eliminating the installation manifests installed to `/var/lib/sage/installed/`?

I don't have a ticket for this at the moment. But I think it's unavoidable to make some changes. Already now these installation manifests (which duplicate the `.egg-info` record in `site-packages`) can fall out of sync with the actual installation when the user uses `sage -pip install`, which could lead to upgrades of some python package dependencies. It's best to use standard Python tools to manage Python packages.
