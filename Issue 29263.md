# Issue 29263: Install all Python packages using pip

Issue created by migration from https://trac.sagemath.org/ticket/29500

Original creator: mkoeppe

Original creation time: 2020-04-13 02:40:23

CC:  slelievre @tobiasdiez embray jhpalmieri tscrim

Some of our Python packages are still installed by calling setup.py directly. This should be fixed


---

Comment by slelievre created at 2020-05-09 23:21:53

Would that be `gambit`, `numpy` and `pillow`?

And is this how to find them?

```
$ git grep "setup.py" build/pkgs
```



---

Comment by mkoeppe created at 2020-08-30 19:31:21

... Also consider pipenv + pipfile as suggested in #30317 ...


---

Comment by embray created at 2020-09-01 13:16:41

I would prefer not to have two separate package installation and management systems.  If the only motivation of this is the race condition, like I said this can be solved with an additional file lock to prevent multiple Python packages from being installed simultaneously.


---

Comment by mkoeppe created at 2020-09-08 02:31:49

Narrowed the scope of the ticket.


---

Comment by mkoeppe created at 2020-09-08 05:29:56

New commits:


---

Comment by mkoeppe created at 2020-09-08 05:33:10

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-09-08 05:46:35

Replying to [comment:1 slelievre]:
> Would that be `gambit`, `numpy` and `pillow`?
> 
> And is this how to find them?
> {{{
> $ git grep "setup.py" build/pkgs
> }}}
Yes, still need to take care of these.


---

Comment by mkoeppe created at 2020-09-08 05:46:35

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-09-08 19:50:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-08 20:04:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-09-09 17:26:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-09-17 00:32:48

- Why `sdh_store_and_pip_install_wheel requires . as only argument`? Why not just call it with no arguments?

- This function should be documented in `developer/packaging.rst`.

- Does `sage-pip-uninstall` leave the old wheels lying around?

- Typo in `sage-pip-uninstall` (copied from `sage-pip-install`): "this command hould use"


---

Comment by mkoeppe created at 2020-09-17 00:40:54

Replying to [comment:28 jhpalmieri]:
> - Why `sdh_store_and_pip_install_wheel requires . as only argument`? Why not just call it with no arguments?

I did this to emphasize the analogy to `sage-pip-install`.

> - This function should be documented in `developer/packaging.rst`.

Good idea, will do.

> - Does `sage-pip-uninstall` leave the old wheels lying around?

`sage-pip-uninstall` is not really used for regular uninstalls. Rather, it "force-uninstalls" previously installed versions - in case the site-packages directory was somehow messed up. (This code was previously part of `sage-pip-install`.)

The wheels are installed with the staging mechanism (DESTDIR), which records the installed files. In this way, the `-clean` targets etc. automatically install the wheel.

> - Typo in `sage-pip-uninstall` (copied from `sage-pip-install`): "this command hould use"

Thanks


---

Comment by mkoeppe created at 2020-09-17 00:42:37

Replying to [comment:29 mkoeppe]:
> The wheels are installed with the staging mechanism (DESTDIR), which records the installed files. In this way, the `-clean` targets etc. automatically install the wheel.

To clarify, both the wheels and the installation made from the wheels uses the staging mechanism.


---

Comment by git created at 2020-09-17 01:08:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-09-18 03:16:41

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-09-18 03:16:41

Seems okay to me, and it built and passed tests before, so I think it's okay. Of course, I can [no longer build Sage](https://trac.sagemath.org/ticket/30494#comment:9) anymore, so perhaps take this review with a grain of salt.


---

Comment by mkoeppe created at 2020-09-18 03:58:39

Thanks!


---

Comment by vbraun created at 2020-09-21 21:14:45

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-09-21 21:14:45

Merge conflict


---

Comment by git created at 2020-09-21 21:49:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-09-21 21:49:47

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-09-27 09:09:52

Resolution: fixed


---

Comment by mkoeppe created at 2020-10-15 04:26:53

Follow-up: #30771


---

Comment by embray created at 2020-10-22 13:33:29

I'm not really sure what the advantage is of this complication. For the follow-up do you propose eliminating the installation manifests installed to `/var/lib/sage/installed/`? I would very much prefer to not do that. I see no reason for Python packages to be arbitrarily treated differently in this regard. But I'm not sure if that is really the plan.


---

Comment by mkoeppe created at 2020-10-22 15:12:17

Replying to [comment:40 embray]:
> I'm not really sure what the advantage is of this complication. 
https://wiki.sagemath.org/ReleaseTours/sage-9.2#Reusable_wheels_for_the_Python_packages_built_by_the_Sage_distribution explains an immediate use case.


---

Comment by mkoeppe created at 2020-10-22 15:21:53

Replying to [comment:40 embray]:
> For the follow-up do you propose eliminating the installation manifests installed to `/var/lib/sage/installed/`?

I don't have a ticket for this at the moment. But I think it's unavoidable to make some changes. Already now these installation manifests (which duplicate the `.egg-info` record in `site-packages`) can fall out of sync with the actual installation when the user uses `sage -pip install`, which could lead to upgrades of some python package dependencies. It's best to use standard Python tools to manage Python packages.
