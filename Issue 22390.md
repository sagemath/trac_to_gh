# Issue 22390: R build broken on Cygwin

archive/issues_022390.json:
```json
{
    "body": "For a bunch of R's shared library modules it does not explicitly include `-l` flags for libraries they link to, as it is not necessary to do so, for the most part, on Linux.\n\nHowever, on Windows it is necessary to resolve all symbols at link time.  This patch fixes the issue, and is otherwise harmless.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22627\n\n",
    "created_at": "2017-03-17T00:00:34Z",
    "labels": [
        "porting: Cygwin",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "R build broken on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22390",
    "user": "embray"
}
```
For a bunch of R's shared library modules it does not explicitly include `-l` flags for libraries they link to, as it is not necessary to do so, for the most part, on Linux.

However, on Windows it is necessary to resolve all symbols at link time.  This patch fixes the issue, and is otherwise harmless.

Issue created by migration from https://trac.sagemath.org/ticket/22627





---

archive/issue_comments_311652.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-17T00:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311652",
    "user": "embray"
}
```

New commits:



---

archive/issue_comments_311653.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-17T00:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311653",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_311654.json:
```json
{
    "body": "This will conflict with #20523. Yet instead of basing this on #20523, which is potentially still controversial, I would create a new separate branch that is based on #20523.",
    "created_at": "2017-03-17T00:21:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311654",
    "user": "tscrim"
}
```

This will conflict with #20523. Yet instead of basing this on #20523, which is potentially still controversial, I would create a new separate branch that is based on #20523.



---

archive/issue_comments_311655.json:
```json
{
    "body": "I should test #20523 on Cygwin anyways....once I get the rest fixed.",
    "created_at": "2017-03-17T00:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311655",
    "user": "embray"
}
```

I should test #20523 on Cygwin anyways....once I get the rest fixed.



---

archive/issue_comments_311656.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-17T09:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311656",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_311657.json:
```json
{
    "body": "Setting to needs_work because it should be rebased on #20523.",
    "created_at": "2017-03-17T09:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311657",
    "user": "jdemeyer"
}
```

Setting to needs_work because it should be rebased on #20523.



---

archive/issue_comments_311658.json:
```json
{
    "body": "Changing keywords from \"\" to \"days85\".",
    "created_at": "2017-03-17T09:08:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311658",
    "user": "jdemeyer"
}
```

Changing keywords from "" to "days85".



---

archive/issue_comments_311659.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:",
    "created_at": "2017-03-22T16:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311659",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:



---

archive/issue_comments_311660.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-22T16:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311660",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_311661.json:
```json
{
    "body": "Rebased on #20523.  This simple patch this adds could probably be directly tacked on to #20523, but since that issue has been under contention for a long time and is finally close to ready I'd rather not touch it.",
    "created_at": "2017-03-22T16:17:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311661",
    "user": "embray"
}
```

Rebased on #20523.  This simple patch this adds could probably be directly tacked on to #20523, but since that issue has been under contention for a long time and is finally close to ready I'd rather not touch it.



---

archive/issue_comments_311662.json:
```json
{
    "body": "LGTM.",
    "created_at": "2017-03-22T18:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311662",
    "user": "tscrim"
}
```

LGTM.



---

archive/issue_comments_311663.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-22T18:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311663",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_311664.json:
```json
{
    "body": "Attachment [r-3.3.3.p1.log](tarball://root/attachments/some-uuid/ticket22627/r-3.3.3.p1.log) by gouezel created at 2017-03-25 11:28:37\n\nDoesn't work for me (i.e., I think the patch fixes some build issue of R, but not all of them for me), on cygwin64 on x86_64, windows 10 pro. Short version: a file `libR.so`is correctly produced, but next I get\n\n```\ngcc -fopenmp  -L../../lib -L/home/Sebastien/sage33/sage/local/lib -Wl,-rpath,/home/Sebastien/sage33/sage/local/lib  -o R.bin Rmain.o  -lR \n/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lR\ncollect2: error: ld returned 1 exit status\n```\n\nIs it looking for `libR.dll` instead? \n\nLog file attached.",
    "created_at": "2017-03-25T11:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311664",
    "user": "gouezel"
}
```

Attachment [r-3.3.3.p1.log](tarball://root/attachments/some-uuid/ticket22627/r-3.3.3.p1.log) by gouezel created at 2017-03-25 11:28:37

Doesn't work for me (i.e., I think the patch fixes some build issue of R, but not all of them for me), on cygwin64 on x86_64, windows 10 pro. Short version: a file `libR.so`is correctly produced, but next I get

```
gcc -fopenmp  -L../../lib -L/home/Sebastien/sage33/sage/local/lib -Wl,-rpath,/home/Sebastien/sage33/sage/local/lib  -o R.bin Rmain.o  -lR 
/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lR
collect2: error: ld returned 1 exit status
```

Is it looking for `libR.dll` instead? 

Log file attached.



---

archive/issue_comments_311665.json:
```json
{
    "body": "I'm not building R 3.3.3.  I'm still on 3.2.4.  I've been meaning to test the 3.3.3 build on Cygwin for comment on #20523, but have kept getting side-tracked by other things.  It's entirely likely there are other, unrelated build issues of 3.3.x on Cygwin.\n\n(on cygwin `-lR` should find the `libR.dll.a` import library).",
    "created_at": "2017-03-27T15:29:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311665",
    "user": "embray"
}
```

I'm not building R 3.3.3.  I'm still on 3.2.4.  I've been meaning to test the 3.3.3 build on Cygwin for comment on #20523, but have kept getting side-tracked by other things.  It's entirely likely there are other, unrelated build issues of 3.3.x on Cygwin.

(on cygwin `-lR` should find the `libR.dll.a` import library).



---

archive/issue_comments_311666.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-03T15:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311666",
    "user": "embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_311667.json:
```json
{
    "body": "I confirmed, finally, that with the recent upgrade to R 3.3.3 building is broken on Cygwin again; this patch alone doesn't fix it.  I got the same error as [comment:8].  I will investigate and update the patch as needed.",
    "created_at": "2017-04-03T15:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311667",
    "user": "embray"
}
```

I confirmed, finally, that with the recent upgrade to R 3.3.3 building is broken on Cygwin again; this patch alone doesn't fix it.  I got the same error as [comment:8].  I will investigate and update the patch as needed.



---

archive/issue_comments_311668.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-03T21:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311668",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_311669.json:
```json
{
    "body": "Do it on a new ticket..",
    "created_at": "2017-04-03T21:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311669",
    "user": "vbraun"
}
```

Do it on a new ticket..



---

archive/issue_comments_311670.json:
```json
{
    "body": "Turns out we already had the patch I attached in the this ticket here, along with some other Cygwin-specific patches: https://git.sagemath.org/sage.git/tree/build/pkgs/r/patches/cygwin?id=718f365788938d539483a3ec714c7b42172cd237\n\nThese patches just aren't being applied at all (the `spkg-install` moves them but never applies them, since patches are now applied before `spkg-install` is run).",
    "created_at": "2017-04-04T08:32:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311670",
    "user": "embray"
}
```

Turns out we already had the patch I attached in the this ticket here, along with some other Cygwin-specific patches: https://git.sagemath.org/sage.git/tree/build/pkgs/r/patches/cygwin?id=718f365788938d539483a3ec714c7b42172cd237

These patches just aren't being applied at all (the `spkg-install` moves them but never applies them, since patches are now applied before `spkg-install` is run).



---

archive/issue_comments_311671.json:
```json
{
    "body": "Why?  R build is still broken on Cygwin.  It is not \"fixed\".",
    "created_at": "2017-04-04T10:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311671",
    "user": "embray"
}
```

Why?  R build is still broken on Cygwin.  It is not "fixed".



---

archive/issue_comments_311672.json:
```json
{
    "body": "But the ticket is merged and didn't cause the buildbot to break. If you don't think its fixed you shouldn't have set it to needs_review.",
    "created_at": "2017-04-04T13:36:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311672",
    "user": "vbraun"
}
```

But the ticket is merged and didn't cause the buildbot to break. If you don't think its fixed you shouldn't have set it to needs_review.



---

archive/issue_comments_311673.json:
```json
{
    "body": "> If you don't think its fixed you shouldn't have set it to needs_review.\n\nWhat are you talking about?  Why shouldn't I have set needs_review?  I realized weeks after it was set to positive_review that this needed more work and set it to needs_work.  Why was it merged even after I set it to needs_work?",
    "created_at": "2017-04-04T14:57:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311673",
    "user": "embray"
}
```

> If you don't think its fixed you shouldn't have set it to needs_review.

What are you talking about?  Why shouldn't I have set needs_review?  I realized weeks after it was set to positive_review that this needed more work and set it to needs_work.  Why was it merged even after I set it to needs_work?



---

archive/issue_comments_311674.json:
```json
{
    "body": "It was merged and tested before you switched it away from positive review. It does take quite a bit of time to run though all buildbots.",
    "created_at": "2017-04-04T22:29:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311674",
    "user": "vbraun"
}
```

It was merged and tested before you switched it away from positive review. It does take quite a bit of time to run though all buildbots.



---

archive/issue_comments_311675.json:
```json
{
    "body": "I don't understand.  Does it get merged automatically or manually?  What this ticket shows is that it was set to \"needs_work\" by me first, and then closed by you and I have no idea if you're doing this manually or if there are some scripts doing it.",
    "created_at": "2017-04-05T09:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311675",
    "user": "embray"
}
```

I don't understand.  Does it get merged automatically or manually?  What this ticket shows is that it was set to "needs_work" by me first, and then closed by you and I have no idea if you're doing this manually or if there are some scripts doing it.



---

archive/issue_comments_311676.json:
```json
{
    "body": "There are scripts testing and merging positively reviewed tickets. Backing that out because somebody changes it back from positive review is a manual process.",
    "created_at": "2017-04-05T12:26:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311676",
    "user": "vbraun"
}
```

There are scripts testing and merging positively reviewed tickets. Backing that out because somebody changes it back from positive review is a manual process.



---

archive/issue_comments_311677.json:
```json
{
    "body": "But do you manually update the ticket, or does the script do that (i.e. [comment:11])?  What I don't understand is why it would merge the branch even after the ticket's status has been changed--unless that's happening before it changed, but there's no obvious way to see that that's the case.",
    "created_at": "2017-04-05T12:34:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311677",
    "user": "embray"
}
```

But do you manually update the ticket, or does the script do that (i.e. [comment:11])?  What I don't understand is why it would merge the branch even after the ticket's status has been changed--unless that's happening before it changed, but there's no obvious way to see that that's the case.



---

archive/issue_comments_311678.json:
```json
{
    "body": "I think I changed this by mistake.",
    "created_at": "2017-04-05T13:21:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311678",
    "user": "embray"
}
```

I think I changed this by mistake.



---

archive/issue_comments_311679.json:
```json
{
    "body": "The branch is merged before testing and closed after testing on the buildbot. If you switch it back from positive review during testing then I get notified but nothing is done automatically.",
    "created_at": "2017-04-05T14:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22390",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22390#issuecomment-311679",
    "user": "vbraun"
}
```

The branch is merged before testing and closed after testing on the buildbot. If you switch it back from positive review during testing then I get notified but nothing is done automatically.
