# Issue 22390: R build broken on Cygwin

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2017-03-17 00:00:34

For a bunch of R's shared library modules it does not explicitly include `-l` flags for libraries they link to, as it is not necessary to do so, for the most part, on Linux.

However, on Windows it is necessary to resolve all symbols at link time.  This patch fixes the issue, and is otherwise harmless.


---

Comment by embray created at 2017-03-17 00:01:14

New commits:


---

Comment by embray created at 2017-03-17 00:01:14

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-03-17 00:21:32

This will conflict with #20523. Yet instead of basing this on #20523, which is potentially still controversial, I would create a new separate branch that is based on #20523.


---

Comment by embray created at 2017-03-17 00:47:50

I should test #20523 on Cygwin anyways....once I get the rest fixed.


---

Comment by jdemeyer created at 2017-03-17 09:08:29

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-17 09:08:29

Setting to needs_work because it should be rebased on #20523.


---

Comment by jdemeyer created at 2017-03-17 09:08:29

Changing keywords from "" to "days85".


---

Comment by git created at 2017-03-22 16:15:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by embray created at 2017-03-22 16:17:07

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-03-22 16:17:07

Rebased on #20523.  This simple patch this adds could probably be directly tacked on to #20523, but since that issue has been under contention for a long time and is finally close to ready I'd rather not touch it.


---

Comment by tscrim created at 2017-03-22 18:01:44

LGTM.


---

Comment by tscrim created at 2017-03-22 18:01:44

Changing status from needs_review to positive_review.


---

Attachment

Doesn't work for me (i.e., I think the patch fixes some build issue of R, but not all of them for me), on cygwin64 on x86_64, windows 10 pro. Short version: a file `libR.so`is correctly produced, but next I get

```
gcc -fopenmp  -L../../lib -L/home/Sebastien/sage33/sage/local/lib -Wl,-rpath,/home/Sebastien/sage33/sage/local/lib  -o R.bin Rmain.o  -lR 
/usr/lib/gcc/x86_64-pc-cygwin/5.4.0/../../../../x86_64-pc-cygwin/bin/ld: cannot find -lR
collect2: error: ld returned 1 exit status
```

Is it looking for `libR.dll` instead? 

Log file attached.


---

Comment by embray created at 2017-03-27 15:29:46

I'm not building R 3.3.3.  I'm still on 3.2.4.  I've been meaning to test the 3.3.3 build on Cygwin for comment on #20523, but have kept getting side-tracked by other things.  It's entirely likely there are other, unrelated build issues of 3.3.x on Cygwin.

(on cygwin `-lR` should find the `libR.dll.a` import library).


---

Comment by embray created at 2017-04-03 15:30:41

Changing status from positive_review to needs_work.


---

Comment by embray created at 2017-04-03 15:30:41

I confirmed, finally, that with the recent upgrade to R 3.3.3 building is broken on Cygwin again; this patch alone doesn't fix it.  I got the same error as [comment:8].  I will investigate and update the patch as needed.


---

Comment by vbraun created at 2017-04-03 21:00:15

Resolution: fixed


---

Comment by vbraun created at 2017-04-03 21:16:01

Do it on a new ticket..


---

Comment by embray created at 2017-04-04 08:32:37

Turns out we already had the patch I attached in the this ticket here, along with some other Cygwin-specific patches: https://git.sagemath.org/sage.git/tree/build/pkgs/r/patches/cygwin?id=718f365788938d539483a3ec714c7b42172cd237

These patches just aren't being applied at all (the `spkg-install` moves them but never applies them, since patches are now applied before `spkg-install` is run).


---

Comment by embray created at 2017-04-04 10:16:48

Why?  R build is still broken on Cygwin.  It is not "fixed".


---

Comment by vbraun created at 2017-04-04 13:36:45

But the ticket is merged and didn't cause the buildbot to break. If you don't think its fixed you shouldn't have set it to needs_review.


---

Comment by embray created at 2017-04-04 14:57:43

> If you don't think its fixed you shouldn't have set it to needs_review.

What are you talking about?  Why shouldn't I have set needs_review?  I realized weeks after it was set to positive_review that this needed more work and set it to needs_work.  Why was it merged even after I set it to needs_work?


---

Comment by vbraun created at 2017-04-04 22:29:09

It was merged and tested before you switched it away from positive review. It does take quite a bit of time to run though all buildbots.


---

Comment by embray created at 2017-04-05 09:20:21

I don't understand.  Does it get merged automatically or manually?  What this ticket shows is that it was set to "needs_work" by me first, and then closed by you and I have no idea if you're doing this manually or if there are some scripts doing it.


---

Comment by vbraun created at 2017-04-05 12:26:50

There are scripts testing and merging positively reviewed tickets. Backing that out because somebody changes it back from positive review is a manual process.


---

Comment by embray created at 2017-04-05 12:34:50

But do you manually update the ticket, or does the script do that (i.e. [comment:11])?  What I don't understand is why it would merge the branch even after the ticket's status has been changed--unless that's happening before it changed, but there's no obvious way to see that that's the case.


---

Comment by embray created at 2017-04-05 13:21:31

I think I changed this by mistake.


---

Comment by vbraun created at 2017-04-05 14:42:48

The branch is merged before testing and closed after testing on the buildbot. If you switch it back from positive review during testing then I get notified but nothing is done automatically.
