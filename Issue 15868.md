# Issue 15868: Sage crashes on start: libntl.so.2 not find

Issue created by migration from https://trac.sagemath.org/ticket/16105

Original creator: darij

Original creation time: 2014-04-09 05:43:06

CC:  vbraun

Keywords: ntl, crash

Sorry for the laziest bugreport since my last one, but this is what I'm getting since I've updated to 6.2.beta7 and I have no idea what it comes from.


```
***************************************************************************

IPython post-mortem report

{'codename': 'An Afternoon Hack',
 'commit_hash': '9db8c5c',
 'commit_source': 'installation',
 'default_encoding': 'UTF-8',
 'ipython_path': '/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython',
 'ipython_version': '1.2.1',
 'os_name': 'posix',
 'platform': 'Linux-3.2.0-60-generic-i686-with-debian-wheezy-sid',
 'sys_executable': '/home/darij/gitsage6.2/local/bin/python',
 'sys_platform': 'linux2',
 'sys_version': '2.7.5 (default, Mar 23 2014, 16:40:35) \n[GCC 4.6.3]'}

***************************************************************************



***************************************************************************

Crash traceback:

---------------------------------------------------------------------------
ImportError           Python 2.7.5: /home/darij/gitsage6.2/local/bin/python
                                                   Tue Apr  8 22:39:26 2014
A problem occured executing Python code.  Here is the sequence of function
calls leading up to the error, with the most recent (innermost) call last.
/home/darij/gitsage6.2/src/bin/sage-ipython in <module>()
      2 # -*- coding: utf-8 -*-
      3 """
      4 Sage IPython startup script.
      5 """
      6 from sage.misc.interpreter import SageTerminalApp
      7 
      8 # installs the extra readline commands before the IPython initialization begins.
      9 from sage.misc.readline_extra_commands import *
     10 
     11 # Make sure we're using the Sage profile if one isn't specified.
     12 import sys
     13 if '--profile' not in sys.argv:
     14     sys.argv.extend(['--profile', 'sage'])
     15 
     16 app = SageTerminalApp.instance()
---> 17 app.initialize()
        global app.initialize = <bound method SageTerminalApp.initialize of <sage.misc.interpreter.SageTerminalApp object at 0xb76f0a2c>>
     18 app.start()

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/terminal/ipapp.pyc in initialize(self=<sage.misc.interpreter.SageTerminalApp object>, argv=None)

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/config/application.pyc in catch_config_error(method=<function initialize>, app=<sage.misc.interpreter.SageTerminalApp object>, *args=(None,), **kwargs={})
     74 
     75 #-----------------------------------------------------------------------------
     76 # Application class
     77 #-----------------------------------------------------------------------------
     78 
     79 @decorator
     80 def catch_config_error(method, app, *args, **kwargs):
     81     """Method decorator for catching invalid config (Trait/ArgumentErrors) during init.
     82 
     83     On a TraitError (generally caused by bad config), this will print the trait's
     84     message, and exit the app.
     85     
     86     For use on init methods, to prevent invoking excepthook on invalid input.
     87     """
     88     try:
---> 89         return method(app, *args, **kwargs)
        method = <function initialize at 0xb7170bfc>
        app = <sage.misc.interpreter.SageTerminalApp object at 0xb76f0a2c>
        args = (None,)
        kwargs = {}
     90     except (TraitError, ArgumentError) as e:
     91         app.print_help()
     92         app.log.fatal("Bad config encountered during initialization:")
     93         app.log.fatal(str(e))
     94         app.log.debug("Config at the time: %s", app.config)
     95         app.exit(1)
     96 
     97 
     98 class ApplicationError(Exception):
     99     pass
    100 
    101 class LevelFormatter(logging.Formatter):
    102     """Formatter with additional `highlevel` record
    103     
    104     This field is empty if log level is less than highlevel_limit,

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/terminal/ipapp.pyc in initialize(self=<sage.misc.interpreter.SageTerminalApp object>, argv=None)
    308     
    309     @catch_config_error
    310     def initialize(self, argv=None):
    311         """Do actions after construct, but before starting the app."""
    312         super(TerminalIPythonApp, self).initialize(argv)
    313         if self.subapp is not None:
    314             # don't bother initializing further, starting subapp
    315             return
    316         if not self.ignore_old_config:
    317             check_for_old_config(self.ipython_dir)
    318         # print self.extra_args
    319         if self.extra_args and not self.something_to_run:
    320             self.file_to_run = self.extra_args[0]
    321         self.init_path()
    322         # create the shell
--> 323         self.init_shell()
        self.init_shell = <bound method SageTerminalApp.init_shell of <sage.misc.interpreter.SageTerminalApp object at 0xb76f0a2c>>
    324         # and draw the banner
    325         self.init_banner()
    326         # Now a variety of things that happen after the banner is printed.
    327         self.init_gui_pylab()
    328         self.init_extensions()
    329         self.init_code()
    330 
    331     def init_shell(self):
    332         """initialize the InteractiveShell instance"""
    333         # Create an InteractiveShell instance.
    334         # shell.display_banner should always be False for the terminal
    335         # based app, because we call shell.show_banner() by hand below
    336         # so the banner shows *before* all extension loading stuff.
    337         self.shell = TerminalInteractiveShell.instance(parent=self,
    338                         display_banner=False, profile_dir=self.profile_dir,

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/interpreter.pyc in init_shell(self=<sage.misc.interpreter.SageTerminalApp object>)
    668             sage: from sage.misc.interpreter import SageTerminalApp, DEFAULT_SAGE_CONFIG
    669             sage: app = SageTerminalApp(config=DEFAULT_SAGE_CONFIG)
    670             sage: app.initialize(argv=[])  # indirect doctest
    671             sage: app.shell
    672             <sage.misc.interpreter.SageInteractiveShell object at 0x...>
    673         """
    674         # We need verbose crashes for the Sage crash handler.  We set it here
    675         # so that we don't overwrite the traitlet attribute
    676         self.verbose_crash = True
    677 
    678         # Shell initialization
    679         self.shell = SageInteractiveShell.instance(config=self.config,
    680                         display_banner=False, profile_dir=self.profile_dir,
    681                         ipython_dir=self.ipython_dir)
    682         self.shell.configurables.append(self)
--> 683         self.shell.extension_manager.load_extension('sage.misc.sage_extension')
        self.shell.extension_manager.load_extension = <bound method ExtensionManager.load_extension of <IPython.core.extensions.ExtensionManager object at 0x97e5a4c>>

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/IPython/core/extensions.pyc in load_extension(self=<IPython.core.extensions.ExtensionManager object>, module_str='sage.misc.sage_extension')
     83     def load_extension(self, module_str):
     84         """Load an IPython extension by its module name.
     85 
     86         Returns the string "already loaded" if the extension is already loaded,
     87         "no load function" if the module doesn't have a load_ipython_extension
     88         function, or None if it succeeded.
     89         """
     90         if module_str in self.loaded:
     91             return "already loaded"
     92         
     93         from IPython.utils.syspathcontext import prepended_to_syspath
     94         
     95         with self.shell.builtin_trap:
     96             if module_str not in sys.modules:
     97                 with prepended_to_syspath(self.ipython_extension_dir):
---> 98                     __import__(module_str)
        global __import__ = undefined
        module_str = 'sage.misc.sage_extension'
     99             mod = sys.modules[module_str]
    100             if self._call_load_ipython_extension(mod):
    101                 self.loaded.add(module_str)
    102             else:
    103                 return "no load function"
    104 
    105     def unload_extension(self, module_str):
    106         """Unload an IPython extension by its module name.
    107 
    108         This function looks up the extension's name in ``sys.modules`` and
    109         simply calls ``mod.unload_ipython_extension(self)``.
    110         
    111         Returns the string "no unload function" if the extension doesn't define
    112         a function to unload itself, "not loaded" if the extension isn't loaded,
    113         otherwise None.

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/misc/sage_extension.py in <module>()
     45     2
     46 
     47 In contrast, input to the ``%time`` magic command is preparsed::
     48 
     49     sage: shell.run_cell('%time 594.factor()')
     50     CPU times: user ...
     51     Wall time: ...
     52     2 * 3^3 * 11
     53 """
     54 
     55 from IPython.core.hooks import TryNext
     56 from IPython.core.magic import Magics, magics_class, line_magic
     57 import os
     58 import sys
     59 import sage
---> 60 import sage.all
        global sage.all = undefined
     61 from sage.misc.interpreter import preparser
     62 from sage.misc.preparser import preparse
     63 
     64 @magics_class
     65 class SageMagics(Magics):
     66 
     67     @line_magic
     68     def crun(self, s):
     69         r"""
     70         Profile C function calls
     71 
     72         INPUT:
     73         
     74         - ``s`` -- string. Sage command to profile.
     75 

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/all.py in <module>()
     76 ###################################################################
     77 
     78 import sage.ext.c_lib
     79 sage.ext.c_lib._init_csage()
     80 sig_on_count = sage.ext.c_lib._sig_on_reset
     81 
     82 from time                import sleep
     83 
     84 from sage.ext.c_lib import AlarmInterrupt, SignalError
     85 
     86 import sage.misc.lazy_import
     87 from sage.misc.all       import *         # takes a while
     88 
     89 from sage.misc.sh import sh
     90 
---> 91 from sage.libs.all       import *
        global sage.libs.all = undefined
     92 from sage.doctest.all    import *
     93 try:
     94     from sage.dev.all    import *
     95 except ImportError:
     96     pass   # dev scripts are disabled
     97 
     98 from sage.rings.all      import *
     99 from sage.matrix.all     import *
    100 
    101 # This must come before Calculus -- it initializes the Pynac library.
    102 import sage.symbolic.pynac
    103 
    104 from sage.modules.all    import *
    105 from sage.monoids.all    import *
    106 from sage.algebras.all   import *

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/libs/all.py in <module>()
----> 1 import sage.libs.ntl.all  as ntl
        global sage.libs.ntl.all = undefined
        global ntl = undefined
      2 
      3 from sage.libs.pari.all   import pari, pari_gen, PariError
      4 
      5 from sage.libs.mwrank.all  import (mwrank_EllipticCurve, mwrank_MordellWeil,
      6                                    mwrank_initprimes,
      7                                    get_precision as mwrank_get_precision,
      8                                    set_precision as mwrank_set_precision)
      9 
     10 
     11 import symmetrica.all as symmetrica
     12 
     13 from cremona.all import CremonaModularSymbols
     14 
     15 
     16 from sage.misc.lazy_import import lazy_import
     17 lazy_import('sage.libs.gap.libgap', 'libgap')

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/libs/ntl/__init__.py in <module>()
----> 1 import all
        global all = undefined

/home/darij/gitsage6.2/local/lib/python2.7/site-packages/sage/libs/ntl/all.py in <module>()
     17 #    but WITHOUT ANY WARRANTY; without even the implied warranty of
     18 #    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
     19 #    General Public License for more details.
     20 #
     21 #  The full text of the GPL is available at:
     22 #
     23 #                  http://www.gnu.org/licenses/
     24 #*****************************************************************************
     25 
     26 from sage.libs.ntl.ntl_ZZ import (
     27                  ntl_setSeed, \
     28                  ntl_ZZ as ZZ,
     29                  randomBnd as ZZ_random,
     30                  randomBits as ZZ_random_bits )
     31 
---> 32 from sage.libs.ntl.ntl_ZZ_pContext import ntl_ZZ_pContext as ZZ_pContext
        global sage.libs.ntl.ntl_ZZ_pContext = undefined
        global ntl_ZZ_pContext = undefined
        global ZZ_pContext = undefined
     33 
     34 from sage.libs.ntl.ntl_ZZ_p import (
     35                  ntl_ZZ_p as ZZ_p,
     36                  ntl_ZZ_p_random_element as ZZ_p_random )
     37 
     38 from sage.libs.ntl.ntl_ZZX import (
     39                  ntl_ZZX as ZZX,
     40                  zero_ZZX, one_ZZX )
     41 
     42 from sage.libs.ntl.ntl_ZZ_pX import ntl_ZZ_pX as ZZ_pX
     43 
     44 from sage.libs.ntl.ntl_ZZ_pEContext import ntl_ZZ_pEContext as ZZ_pEContext
     45 
     46 from sage.libs.ntl.ntl_ZZ_pE import ntl_ZZ_pE as ZZ_pE
     47 

ImportError: libntl.so.2: cannot open shared object file: No such file or directory

***************************************************************************

History of session input:
*** Last line of input (may not be in above history):
```



---

Comment by rws created at 2014-04-09 09:03:36

Solution in https://groups.google.com/forum/?hl=en#!topic/sage-release/zxlHERyLUVU


---

Comment by rws created at 2014-04-09 09:03:36

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-04-09 09:14:49


```
make distclean && make
```



---

Comment by darij created at 2014-04-09 13:01:53

Ah, thank you!

Hmm... any chance things like this could appear in the release notes? Or is it a system-dependent heisenbug?


---

Comment by jdemeyer created at 2014-04-11 09:40:37

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-04-11 09:40:37

Changing priority from critical to blocker.


---

Comment by jdemeyer created at 2014-04-11 09:40:37

Changing component from number theory to build.


---

Comment by jdemeyer created at 2014-04-11 09:40:37

I disagree with the "solution", this is a bug in the dependency checking.


---

Comment by jdemeyer created at 2014-04-11 09:58:56

It seems that all Cython extensions are compiled against NTL for no clear reason:

```
$ ./sage -b
[...]
gcc -pthread -shared -L/usr/local/src/sage-config/local/lib build/temp.linux-x86_64-2.7/sage/misc/parser.o -L/usr/local/src/sage-config/local/lib -L/usr/local/src/sage-config/local/lib -lcsage -lstdc++ -lntl -lpython2.7 -o build/lib.linux-x86_64-2.7/sage/misc/parser.so
```


This `-lntl` is hardcoded in `src/setup.py`.


---

Comment by jdemeyer created at 2014-04-11 12:25:34

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-04-11 12:25:34

New commits:


---

Comment by jdemeyer created at 2014-04-11 13:02:17

Just realized that always using `list.append()` is dangerous. I should use `list = list + [foo]`.


---

Comment by jpflori created at 2014-04-11 13:07:00

Replying to [comment:12 jdemeyer]:
> Just realized that always using `list.append()` is dangerous. I should use `list = list + [foo]`.
Why is it dangerous?


---

Comment by jdemeyer created at 2014-04-11 13:12:13

Okay, "dangerous" isn't the right word.

The problem is the following:

```
sage: mylist = ["hello"]
sage: a = mylist
sage: a.append("world")
sage: a
['hello', 'world']
sage: mylist
['hello', 'world']
```


As you can see, `a` and `mylist` remain the same object. The same if you use `+=`. That is also the reason why some Sage command lines look like

```
gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/usr/local/src/sage-config/local/include/singular -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include -I/usr/local/src/sage-config/local/include/csage -I/usr/local/src/sage-config/src -I/usr/local/src/sage-config/src/sage/ext -I/usr/local/src/sage-config/local/include/python2.7 -c sage/rings/polynomial/plural.cpp -o build/temp.linux-x86_64-2.7/sage/rings/polynomial/plural.o -D__STDC_LIMIT_MACROS -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w -fno-strict-aliasing -w
```

so I plan to fix this also here.


---

Comment by leif created at 2014-04-11 13:32:55

Nice.  (After the FIXME has been in for more than `\pi` years... ;-) )

The order of the libraries is still wrong in many places (e.g. `"gmp", "gmpxx"`; and `"m"` should almost always be the _last_), but that's not really the point of the ticket; the following is:

I'd also add NTL here:

```python
lib_headers = { "gmp":     [ os.path.join(SAGE_INC,'gmp.h') ],   # cf. #8664, #9896
                "gmpxx":   [ os.path.join(SAGE_INC,'gmpxx.h') ],
                "ntl":     [ os.path.join(SAGE_INC,'NTL','config.h') ]
              }
```

(That way, all modules using NTL, i.e., [directly] linking to it, will automatically depend on an NTL header that gets modified upon every NTL reinstallation.)




Not sure why you want all extension modules to depend on `setup.py` (makes sense of course, but will also trigger frequent rebuilds of the _whole_ Sage library); we should then also let all of them depend on `module_list.py` (which is IMHO probably more important).




And there are of course still many libraries not really needed, because they're just indirectly used, but that's another issue, cf. [this comment on #16017](http://trac.sagemath.org/ticket/16017#comment:10).


---

Comment by jdemeyer created at 2014-04-11 13:48:52

Replying to [comment:15 leif]:
> Not sure why you want all extension modules to depend on `setup.py`
Well, it is needed at least to fix all modules currently linked to an old version of NTL: all these need to be relinked.

> (makes sense of course, but will also trigger frequent rebuilds of the _whole_ Sage library);
I doubt it, that file isn't changed so frequently.


---

Comment by leif created at 2014-04-11 14:02:18

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 leif]:
> > Not sure why you want all extension modules to depend on `setup.py`
> Well, it is needed at least to fix all modules currently linked to an old version of NTL: all these need to be relinked.

Haha, a one-time dependency.  So you're going to remove it again in some of the next betas? 

> > (makes sense of course, but will also trigger frequent rebuilds of the _whole_ Sage library);
> I doubt it, that file isn't changed so frequently.

So you're not going to let them depend on `module_list.py` also?

(I frequently hate myself for making all targets depend on the Makefile; similar issue.)




Probably Volker should mention `env SAGE_UPGRADING=yes make build` in the release announcements for a while.  (Doing `./sage -ba-force` afterwards should no longer be necessary once this ticket is merged, hopefully...)

Would save him a couple of `make distclean && make` replies, too.


---

Comment by jdemeyer created at 2014-04-11 14:33:57

Replying to [comment:17 leif]:
> Haha, a one-time dependency.  So you're going to remove it again in some of the next betas? 
Of course not. I am saying it is needed _now_ and it doesn't really hurt to keep it.

> So you're not going to let them depend on `module_list.py` also?
I would say no.
I think it is quite unlikely that `module_list.py` gets edited
- without a change to the corresponding `.pyx` files (if the `.pyx` file is changed, the module is recompiled anyway)
- without considering changes which are only cosmetic or only for portability (those don't need rebuilds).


---

Comment by leif created at 2014-04-11 15:17:09

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 leif]:
> > So you're going to remove it again in some of the next betas? 
> Of course not. I am saying it is needed _now_ and it doesn't really hurt to keep it.
> 
> > So you're not going to let them depend on `module_list.py` also?
> I would say no.

Ok.  Then we can at least "touch" `setup.py` in the future (by adding a comment, or by fixing some typo...) to trigger a _full_ rebuild of the Sage library, e.g. if we make further structural changes to (just) `module_list.py` that do require a rebuild (of a couple of otherwise untouched, or of all modules).

And simply adding an extension module (or changing _one's_ deps etc.) will _not_ trigger the rebuild of the whole Sage library, which presumably is more important to many.


---

Comment by git created at 2014-04-11 15:24:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-04-11 15:25:56

New version for review.


---

Comment by leif created at 2014-04-11 15:54:59

Replying to [comment:21 jdemeyer]:
> New version for review.

Looks sane, but I can't test this right now.  (Others will presumably be faster.)

Just wonder whether we'd need the absolute path of `setup.py` (`__file__` may just be the latter, or have a relative path).


---

Comment by leif created at 2014-04-11 16:45:44

Replying to [comment:19 leif]:
> Replying to [comment:18 jdemeyer]:
> > Replying to [comment:17 leif]:
> > > So you're going to remove it again in some of the next betas? 
> > Of course not. I am saying it is needed _now_ and it doesn't really hurt to keep it.
> Ok.  Then we can at least "touch" `setup.py` in the future (by adding a comment, or by fixing some typo...) to trigger a _full_ rebuild of the Sage library, e.g. if we make further structural changes to (just) `module_list.py` that do require a rebuild (of a couple of otherwise untouched, or of all modules).

Thinking a bit more about it, this can be quite annoying _during development_, so we may add some way to bypass the dependency on `setup.py`.  (There's already a `DEVEL` variable in it, but it's also unconditionally set to `False`, rather than derived from some environment variable, say.)


---

Comment by leif created at 2014-04-11 16:59:39

Instead of introducing yet another environment variable (here, at least), we could (ab|re)use `SAGE_UPGRADING`, and bypass the dependency on `setup.py` iff `SAGE_UPGRADING = "no"`, which would also be compatible to having `SAGE_UPGRADING=yes` the default (in future releases).


---

Comment by vbraun created at 2014-04-11 17:03:38

will test it on the bulidbot


---

Comment by vbraun created at 2014-04-11 17:26:45

IMHO any extra logic to avoid recompile with certain environment variables will just break because it is not doctested. And `sage -ba` takes 11 seconds on my laptop with warm caches.


---

Comment by leif created at 2014-04-11 18:02:55

Replying to [comment:26 vbraun]:
> IMHO any extra logic to avoid recompile with certain environment variables will just break because it is not doctested.

Building is not doctested at all, unfortunately not even upgrading is tested -- at least not on a regular basis (otherwise the ticket upgrading NTL would have dealt with what we do here).  `SAGE_UPGRADING` isn't new, and the default behaviour of (just issuing) `make` (or `sage-spkg`) regularly causes failures.




> And `sage -ba` takes 11 seconds on my laptop with warm caches.

[File system and ccache I guess.]

Well, if every Sage user|developer (at your choice) in the world gets such for free...

Otherwise we could just update the minimal hardware requirements (for building or developing with Sage).


---

Comment by vbraun created at 2014-04-11 19:28:54

IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades. Of course feel free to volunteer to test and debug upgrades. As long as "make distclean && make" works I don't consider it a blocker.


---

Comment by vbraun created at 2014-04-11 19:41:30

Resolution: fixed


---

Comment by leif created at 2014-04-11 20:03:57

Replying to [comment:28 vbraun]:
> IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades.

_We worked hard<sup>TM</sup>_ to make upgrading work (again), without much hassle such as having to artificially bump spkg patch levels to trigger a "rebuild", but people tend to create new pitfalls or refuse to remove the existing ones, and apparently don't care much about whether upgrading will work with their changes, so testing the latter is (or had been) mostly up to the release manager.

And the "disabling" of upgrades _from_ betas (or alphas to that time, IIRC) for a while presumably didn't encourage people to test upgrading either.




> Of course feel free to volunteer to test and debug upgrades. As long as "make distclean && make" works I don't consider it a blocker.

[http://wiki.sagemath.org/devel/ReleaseManagement#Release_checklist](http://wiki.sagemath.org/devel/ReleaseManagement#Release_checklist) B)

(Once upon a time...)


Buildbots could (and IMHO should) not just test building from scratch, but also upgrading (nowadays `git pull` plus `[env SAGE_UPGRADING=yes] make`), at least from the last stable release, say.


---

Comment by leif created at 2014-04-11 20:05:46

Argh, trac...


---

Comment by jdemeyer created at 2014-04-12 11:07:25

Replying to [comment:30 leif]:
> Buildbots could (and IMHO should) not just test building from scratch, but also upgrading (nowadays `git pull` plus `[env SAGE_UPGRADING=yes] make`), at least from the last stable release, say.
Agreed. `env SAGE_UPGRADING=yes $MAKE` should always work.


---

Comment by jdemeyer created at 2014-04-12 11:08:20

Replying to [comment:28 vbraun]:
> IMHO the current build system is not sufficient to reasonably be able to guarantee upgrades.
Well, if we would make `SAGE_UPGRADING=yes` the default, it should work. In the light of `ccache`, that's not such a stupid idea either.


---

Comment by vbraun created at 2014-04-12 23:53:00

Replying to [comment:32 jdemeyer]:
> Agreed. `env SAGE_UPGRADING=yes $MAKE` should always work.

I disagree, having irremovably crapped old headers or old shared libraries into the Sage tree is always going to be a challenge for upgrades. I have no interest in forever playing whack-a-mole there. Upgrades without "make distclean" will be guaranteed to work when the build system can reliably support them.


---

Comment by jdemeyer created at 2014-04-13 08:08:03

Replying to [comment:34 vbraun]:
> I disagree, having irremovably crapped old headers or old shared libraries into the Sage tree is always going to be a challenge for upgrades. I have no interest in forever playing whack-a-mole there. Upgrades without "make distclean" will be guaranteed to work when the build system can reliably support them.
Upgrades worked fine up to Sage 5.13 (I always tested that) and that was with a much worse build system than we have now. And I guess this ticket here is maybe the first time since Sage 6.0 that upgrades break but it's also clearly a genuine bug which should be fixed.


---

Comment by vbraun created at 2014-04-13 10:14:09

I of course agree that this ticket was a genuine bug, and I'm happy that you fixed it. Still, we are not at a point where upgrading is guaranteed to work. Making that happen is a higher priority to me than checking whether or not it works right now.


---

Comment by fbissey created at 2014-04-13 10:40:46

I almost feel like I am watching on the side while eating popcorn :) ... But that will probably create me a bit of work in sage-on-gentoo by breaking patches :P

So I will take a serious look at this because I want to clean as little as possible. Jeroen, is there a reason why you are inconsistent in removing stdc++ in extension that are marked "language = c++". I am presuming that stdc++ is always brought in by the c++ compiler. So, in the patch I would expect it to be removed from: 
 * sage.algebras.quatalg.quaternion_algebra_element
 * sage.algebras.quatalg.quaternion_algebra_cython
 * sage.numerical.backends.glpk_graph_backend

Now I will try to work through the libs on my sage-on-gentoo install which is all compiled with --as-needed and see if you got the minimal set of library. I already have an answer for the top one in your patch, gmpxx is not needed:

```
ldd -r /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_element.so
	linux-vdso.so.1 (0x00007fffe372b000)
	libcsage.so => /usr/lib64/libcsage.so (0x00007f6d4cb06000)
	libflint.so.2.4.3 => /usr/lib64/libflint.so.2.4.3 (0x00007f6d4c778000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007f6d4c507000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libstdc++.so.6 (0x00007f6d4c1ff000)
	libpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007f6d4be4e000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f6d4baa0000)
	libntl-6.1.0.so => /usr/lib64/libntl-6.1.0.so (0x00007f6d4b6fe000)
	libpari-gmp.so.3 => /usr/lib64/libpari-gmp.so.3 (0x00007f6d4b0bd000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libgcc_s.so.1 (0x00007f6d4aea5000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f6d4ac88000)
	libmpfr.so.4 => /usr/lib64/libmpfr.so.4 (0x00007f6d4aa2d000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f6d4a730000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f6d4cf88000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007f6d4a52c000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007f6d4a329000)
	libgf2x.so.1 => /usr/lib64/libgf2x.so.1 (0x00007f6d4a113000)
```

And readelf is even more minimalist:

```
readelf -d /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_element.so

Dynamic section at offset 0x26c90 contains 30 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x5938
```

libpari probably comes through libcsage, all the rest, indirect linking...


---

Comment by fbissey created at 2014-04-13 11:02:40

Next

```
readelf -d /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_cython.so

Dynamic section at offset 0xcd18 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x29e0
```

and 

```
ldd -r /usr/lib64/python2.7/site-packages/sage/algebras/quatalg/quaternion_algebra_cython.so
	linux-vdso.so.1 (0x00007fffbb1ff000)
	libcsage.so => /usr/lib64/libcsage.so (0x00007ff74c655000)
	libgmp.so.10 => /usr/lib64/libgmp.so.10 (0x00007ff74c3e5000)
	libstdc++.so.6 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libstdc++.so.6 (0x00007ff74c0dc000)
	libpython2.7.so.1.0 => /usr/lib64/libpython2.7.so.1.0 (0x00007ff74bd2b000)
	libc.so.6 => /lib64/libc.so.6 (0x00007ff74b97e000)
	libntl-6.1.0.so => /usr/lib64/libntl-6.1.0.so (0x00007ff74b5db000)
	libpari-gmp.so.3 => /usr/lib64/libpari-gmp.so.3 (0x00007ff74af9a000)
	libgcc_s.so.1 => /usr/lib/gcc/x86_64-pc-linux-gnu/4.8.2/libgcc_s.so.1 (0x00007ff74ad83000)
	libm.so.6 => /lib64/libm.so.6 (0x00007ff74aa86000)
	/lib64/ld-linux-x86-64.so.2 (0x00007ff74cab4000)
	libpthread.so.0 => /lib64/libpthread.so.0 (0x00007ff74a869000)
	libdl.so.2 => /lib64/libdl.so.2 (0x00007ff74a665000)
	libutil.so.1 => /lib64/libutil.so.1 (0x00007ff74a461000)
	libgf2x.so.1 => /usr/lib64/libgf2x.so.1 (0x00007ff74a24c000)
```

flint and gmpxx are absent.

```
readelf -d /usr/lib64/python2.7/site-packages/sage/groups/perm_gps/partn_ref2/refinement_generic.so

Dynamic section at offset 0x32cd8 contains 30 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0x5ec8
```

gmpxx not there and in consequence stdc++ is not there either. It is brought in indirectly by ntl through flint and csage from the ldd output.


```
readelf -d /usr/lib64/python2.7/site-packages/sage/libs/flint/flint.so

Dynamic section at offset 0x1da8 contains 29 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libflint.so.2.4.3]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0xf98
```


At this stage I did a little research and found that the only extension linking directly to gmpxx is

```
File: /usr/lib64/python2.7/site-packages/sage/modular/arithgroup/farey_symbol.so

Dynamic section at offset 0x42be8 contains 32 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libcsage.so]
 0x0000000000000001 (NEEDED)             Shared library: [libgmpxx.so.4]
 0x0000000000000001 (NEEDED)             Shared library: [libgmp.so.10]
 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]
 0x0000000000000001 (NEEDED)             Shared library: [libpython2.7.so.1.0]
 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000c (INIT)               0xbd28
```



---

Comment by jdemeyer created at 2014-04-13 11:17:44

Replying to [comment:37 fbissey]:
> So I will take a serious look at this because I want to clean as little as possible. Jeroen, is there a reason why you are inconsistent in removing stdc++ in extension that are marked "language = c++".
I am consistent, but just in a different way: I only removed `stdc++` if it appears at the end of the list of libraries, because the order matters. In theory, it could be that a build breaks by changing `-lstdc++ -lmylib -lstdc++` to `-lmylib -lstdc++`, but changing `-lmylib -lstdc++ -lstdc++` to `-lmylib -lstdc++` is always safe.

> I am presuming that stdc++ is always brought in by the c++ compiler.
Yes, if `g++` is used instead of `gcc`. I'm not entirely sure this is always the case.


---

Comment by jdemeyer created at 2014-04-13 11:19:21

Replying to [comment:37 fbissey]:
> libpari probably comes through libcsage, all the rest, indirect linking...
Please keep in mind that linking is a very system-dependent thing. If it works on Linux doesn't mean that it will work on OS X or Cygwin.


---

Comment by fbissey created at 2014-04-13 11:39:23

I'll admit I am not sure about cygwin. I am fairly confident that it will work on OS X on the other hand. As for stdc++, yes my comment assume that g++ is used, which I am expecting to be the case for anything that is marked "language=c++". I haven't checked that cython always uses g++ (or the C++ compiler du jour) for c++ but I would be baffled if it didn't (unless expressly instructed to use something else).


---

Comment by vbraun created at 2014-04-13 12:10:02

As an empirical fact linking works on the buildbot...


---

Comment by leif created at 2014-04-13 15:05:18

Replying to [comment:41 fbissey]:
> I'll admit I am not sure about cygwin. I am fairly confident that it will work on OS X on the other hand.

Well, for MacOS X 10.4 at least, _provided the `install_name`s are correct_, as you know...




> As for stdc++, yes my comment assume that g++ is used, which I am expecting to be the case for anything that is marked "language=c++". I haven't checked that cython always uses g++ (or the C++ compiler du jour) for c++ but I would be baffled if it didn't (unless expressly instructed to use something else).

There at least used to be times where that was not the case (years ago, I admit).  Another problem is (or was) that the sources of a module may consist of both C and C++ files (although you'd actually just need `g++` _for linking_ unless you explicitly specify `-lstdc++`, modulo probably different include paths), but there's just one `language` tag per extension module.  Compiling C99 sources as if they were C++ with a C++98 compiler also caused a lot of trouble in the past. 




(Also `--as-needed` didn't work when I tried about four years ago, IIRC due to some implicit assumptions on the import order.  I wasted a few weeks removing and adding libraries in `module_list.py`, when Robert B. told me the mechanism was subject to change on the Cython side anyway, so I didn't pursue that further.)


---

Comment by fbissey created at 2014-04-13 18:56:08

For stdc++ I only named the one tagged with "language=c++". Yes there are other that include it but they have plain c sources and will be compiled with the c compiler so the extra stdc++ is necessary for them. I explicitly didn't mention them.

My comment is for those that are compiled with g++ remove it and that's the three I listed. For the other you leave them alone.

I cannot tell when we started to have --as-needed working. I remember a time where it wasn't but now it definitely does.


---

Comment by leif created at 2014-04-17 12:26:27

John C. just reported for 6.2.beta8 (where this ticket got merged):

```
This is a different problem to the one I reported on the other
sage-release thread.  On my laptop (ubuntu 12.04) I had a working
build of a previous beta, I think beta6.  I pulled from trac/develop
and ran a make.  Here's the error message:


[ -f local/etc/sage-started.txt ] || local/bin/sage-starts
build/pipestatus "./sage --docbuild --no-pdf-links all html  2>&1"
"tee -a logs/dochtml.log"
Traceback (most recent call last):
  File "/home/john/sagegit/src/doc/common/builder.py", line 1467, in <module>
    import sage.all
(...)
  File "/home/john/sagegit/local/lib/python2.7/site-packages/sage/matrix/matrix_space.py",
line 48, in <module>
    import matrix_mpolynomial_dense
ImportError: libntl.so.2: cannot open shared object file: No such file
or directory
```


Wonder what went wrong, since due to the dependency of _every_ extension module on `setup.py` the _whole_ Sage library should have gotten rebuilt.
