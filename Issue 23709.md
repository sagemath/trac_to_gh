# Issue 23709: Exhaust over Weil polynomials

Issue created by migration from Trac.

Original creator: kedlaya

Original creation time: 2017-09-30 20:23:32

CC:  roed

Keywords: Weil polynomials, sd91

I have reasonably stable code (mostly in C, depending on FLINT) for exhausting over Weil polynomials:

https://github.com/kedlaya/root-unitary

The goal of this ticket is to incorporate this code into Sage in some fashion.


---

Comment by kedlaya created at 2017-10-12 05:47:29

Status update: I've pushed many recent changes to the branch `repackage_for_sage` of the Github repo. In particular, I have been working to make the call syntax much more transparent; for instance, to compute the Weil polynomials corresponding to abelian varieties of dimension `g` over the finite field of order `q`, one can now use standard Python iterator syntax:

```
sage: wp = WeilPolynomials(2*g, q)
sage: for i in wp:
...
```

Some to-do items: check that all my old test scripts still work; write more tests; add more documentation; add more input sanitization.

In the meantime, I'd appreciate some feedback about where this might belong in Sage.


---

Comment by jdemeyer created at 2017-10-12 12:31:23

Replying to [comment:1 kedlaya]:
> In the meantime, I'd appreciate some feedback about where this might belong in Sage.

First of all, your github repo contains both C code and `.sage` files. Are the `.sage` files considered to be part of your package or are they really only use cases/examples/tests/documentation?


There are two possibilities, each with its advantages and disadvantages:

(A) Make it an external (presumably optional) package and interface it from Sage.

(B) Make it actually a part of Sage itself.

Advantages of (A) are that you keep control of the package: you can easily change the package at will (with (B) every change would need to go through the Sage Trac) and you don't need to care about Sage coding standards. Also important: with (A) your package could be used without Sage. With (B), there might be more initial work needed to get it into Sage but then it might be less work to maintain.


---

Comment by kedlaya created at 2017-10-18 04:13:22

I just merged a pull request in from another branch, which has the effect of significantly reconfiguring the file structure. In particular, there are no longer any `.sage` files in the main directory; the ones that exist are all in subdirectories and are indeed examples/tests.

The main code base now consists of two `.c` files (and their `.h` headers) and one `.pyx` file. I still don't have any sort of independent build structure set up; moreover, the `.pyx` file is more than just a simple wrapper, it is where the parallelism is currently implemented. So at the moment there is really no way to use the code without Sage, and I don't particularly intend to work on making that possible. (Exception: if someone wants to use the code from some other platform like Julia, I'd be willing to cooperate with that.)


---

Comment by roed created at 2017-10-18 21:44:06

I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?


---

Comment by kedlaya created at 2017-10-23 17:55:37

Replying to [comment:4 roed]:
> I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?

Do you mean put everything in there? Or put the Cython in `sage/rings/polynomials/weil_polynomials.pyx` and the C files in `sage/rings/polynomial/weil`?

Also, if someone can point me to some guidance about a module to the Sage library (e.g., how to format `__init__.py` and `all.py` and the like to make the new code discoverable), that would be helpful.


---

Comment by roed created at 2017-10-25 16:09:18

Replying to [comment:5 kedlaya]:
> Replying to [comment:4 roed]:
> > I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?
> 
> Do you mean put everything in there? Or put the Cython in `sage/rings/polynomials/weil_polynomials.pyx` and the C files in `sage/rings/polynomial/weil`?

I meant putting everything in there.  We should also talk about the best way for a user to access these methods; perhaps a method `weil_polynomials` on `ZZ[x]` and `QQ[x]` that returns your iterator?

> Also, if someone can point me to some guidance about a module to the Sage library (e.g., how to format `__init__.py` and `all.py` and the like to make the new code discoverable), that would be helpful.

See http://doc.sagemath.org/html/en/developer/coding_basics.html#files-and-directory-structure for some details.  You'll also need to add lines to `src/module_list.py` for each extension module.


---

Comment by kedlaya created at 2017-11-07 05:19:45

Pushed some partial progress, but this doesn't compile yet.
----
New commits:


---

Comment by kedlaya created at 2019-12-14 05:07:22

New commits:


---

Comment by kedlaya created at 2019-12-14 05:09:36

OK, here is a new branch which seems to compile. Still a lot of polishing to be done, but it should be possible to at least play with the code now.
----
New commits:


---

Comment by chapoton created at 2019-12-14 20:30:45

does not work for me:

```
sage: from sage.rings.polynomial.weil.weil_polynomials import *
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
<ipython-input-1-5b4f8184ba57> in <module>()
----> 1 from sage.rings.polynomial.weil.weil_polynomials import *

ImportError: /home/chapoton/sage3/local/lib/python3.7/site-packages/sage/rings/polynomial/weil/weil_polynomials.cpython-37m-x86_64-linux-gnu.so: undefined symbol: GOMP_loop_nonmonotonic_dynamic_start
```


and there are missing empty lines in the doc after lines ending with `::`


---

Comment by kedlaya created at 2019-12-14 21:02:00

That is the code looking for OpenMP (which is optional, since we don't ship it with Sage). Does it help if you take out the compiler directive in line 2 of `sage/rings/polynomial/weil/weil_polynomials.pyx`?

The docstrings need a fair bit of work to get to 100% doctest coverage, let alone proper formatting. I can of course work on that independently.


---

Comment by chapoton created at 2019-12-14 21:08:13

yes, removing the distutils directive make it work


---

Comment by git created at 2019-12-14 22:51:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-12-14 22:52:48

In addition to suppressing OpenMP, I also added doctests to get to 100% coverage.

Cc'ing roed, who is somewhat familiar to the code.


---

Comment by chapoton created at 2019-12-15 12:44:10

please remove the "next" method.

and in the test of `__next__`, use next(it) to call the iterator.


---

Comment by git created at 2019-12-15 17:39:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-15 22:51:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-12-17 19:57:22

needs review ?


---

Comment by kedlaya created at 2019-12-17 20:40:30

Standing by for some feedback from roed first.


---

Comment by roed created at 2019-12-18 19:03:02

About to board a flight, and I want to make a few more changes, but can you take a look at the documentation I added and make sure it looks right?  It would also be nice to see some examples illustrating the different inputs available to the iterator.
----
New commits:


---

Comment by git created at 2019-12-19 00:54:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2019-12-19 01:02:55

Alright, I made the other changes I wanted to make (most notably adding a method to polynomial rings).  Here are some documentation questions that I'd like to see addressed, but I think this ticket is basically ready to go.

* I don't understand how specifying congruence constraints on leading coefficients works.  I tried the following:

```
sage: R.<T> = ZZ[]
sage: R.weil_polynomials(4,2,lead=((1,0),(0,2)))
[T^4 + 4, T^4 - T^2 + 4, T^4 - 2*T^2 + 4, T^4 - 3*T^2 + 4, T^4 - 4*T^2 + 4]
```

I would expect this to give polynomials where the coefficient of `T^3` was even, but I'm not sure what I'm getting.  Is it ignoring the 2 and giving me those where the coefficient of `T^3` is exactly 0?  Kiran, can you give me an idea of how this functionality is supposed to work?
* I don't quite understand what `node_limit` does.  Raises a `RuntimeError` if the number of terminal nodes ever exceeds the given value?
* Similarly, I guessed that `squarefree` omits polynomials that are not squarefree.

Overall, can you check/correct the changes I made?  Also, if there's anything else useful to be said about how to recompile with OpenMP support, feel free to augment the documentation that I added.


---

Comment by git created at 2019-12-19 02:13:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-19 03:18:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-12-19 03:27:22

Replying to [comment:26 roed]:
> Alright, I made the other changes I wanted to make (most notably adding a method to polynomial rings).  Here are some documentation questions that I'd like to see addressed, but I think this ticket is basically ready to go.
> 
I made a few tweaks in the latest commits. I really like having a method for polynomial rings; I'm guessing most users will only use the code this way. The iterator is really only needed for power use cases.

Since there is already an `is_weil_polynomial` method for polynomial elements, I edited the docstring for that method to point to `weil_polynomials` and vice versa.

> * I don't understand how specifying congruence constraints on leading coefficients works.  I tried the following:
> {{{
> sage: R.<T> = ZZ[]
> sage: R.weil_polynomials(4,2,lead=((1,0),(0,2)))
> [T^4 + 4, T^4 - T^2 + 4, T^4 - 2*T^2 + 4, T^4 - 3*T^2 + 4, T^4 - 4*T^2 + 4]
> }}}
> I would expect this to give polynomials where the coefficient of `T^3` was even, but I'm not sure what I'm getting.  Is it ignoring the 2 and giving me those where the coefficient of `T^3` is exactly 0?  Kiran, can you give me an idea of how this functionality is supposed to work?

You just caught a bug in the C code which I have now fixed (here and upstream). I added a doctest documenting how this is supposed to work.

> * I don't quite understand what `node_limit` does.  Raises a `RuntimeError` if the number of terminal nodes ever exceeds the given value?

Correct. It is there as a failsafe in case you don't want your code to run forever.

> * Similarly, I guessed that `squarefree` omits polynomials that are not squarefree.
> 
Correct, except that there was a (long-known) bug in that too. I fixed that and added a doctest.

> Overall, can you check/correct the changes I made?  Also, if there's anything else useful to be said about how to recompile with OpenMP support, feel free to augment the documentation that I added.

One issue is that on my system, I have to put the distutils lines at the top of the code when uncommenting them, which I think runs contrary to Sage conventions. I added a comment about this.

Since it seems we are basically into the review phase anyway, let me go ahead and set state accordingly. I would be particularly open to suggestions for additional doctests; there are probably many use cases I haven't thought to test yet, and I'd like to make sure not to break those in future versions of the code.


---

Comment by kedlaya created at 2019-12-19 03:27:22

Changing status from new to needs_review.


---

Comment by git created at 2019-12-19 09:44:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2019-12-19 09:45:34

I've added some more tests.  I think I'm happy to give this positive review if all tests are passing.   I'm also happy to try to keep brainstorming some more doctests if you'd like.


---

Comment by git created at 2019-12-19 16:45:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-12-19 16:50:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-12-19 17:06:27

A few last-minute changes:

- There was a trivial bug in `polynomial_ring.py` about checking the base ring (which patchbot also noticed); I fixed that and added some doctests to confirm.
- I fixed some compiler warnings on the backend.
- I added a link to the github repo in the main package docstring.

That's probably enough doctests for the moment; I'll inevitably have to add more in response to later bugfixes. Let's see what patchbot has to say next.


---

Comment by roed created at 2019-12-19 18:14:07

Patchbot is green; I think we're good to go!  I'll optimistically set the milestone to 9.0. :-)


---

Comment by roed created at 2019-12-19 18:14:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-12-25 09:57:40

On Python 2 there are various errors of the form 

```
**********************************************************************
File "src/sage/rings/polynomial/weil/weil_polynomials.pyx", line 168, in sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count
Failed example:
    _ = next(it)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count[3]>", line 1, in <module>
        _ = next(it)
    TypeError: instance has no next() method
**********************************************************************
```



---

Comment by vbraun created at 2019-12-25 09:57:53

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-12-25 16:36:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-12-25 16:37:56

Replying to [comment:39 vbraun]:
> On Python 2 there are various errors of the form 
> {{{
> **********************************************************************
> File "src/sage/rings/polynomial/weil/weil_polynomials.pyx", line 168, in sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count
> Failed example:
>     _ = next(it)
> Exception raised:
>     Traceback (most recent call last):
>       File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count[3]>", line 1, in <module>
>         _ = next(it)
>     TypeError: instance has no next() method
> **********************************************************************
> }}}

I was asked to remove that method (see comment:18), but anyway here it is again.


---

Comment by kedlaya created at 2019-12-25 16:37:56

Changing status from needs_work to needs_review.


---

Comment by git created at 2019-12-25 19:12:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-12-25 19:39:43

Looking at the patchbot logs, it seems that at least one of the bots failed to build because of nested function declarations in the C code. I thought we were always compiling the Sage library with gcc, which supports nested functions even though they are not in the ANSI standard...?


---

Comment by vbraun created at 2019-12-25 21:56:42

on osx we now use clang by default


---

Comment by git created at 2019-12-25 23:56:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2019-12-25 23:58:02

Ah, it seems clang does not (yet) support nested functions as in GNU C. So I redid that bit of the C code; let's see what the patchbots have to say now.


---

Comment by kedlaya created at 2019-12-30 07:29:48

Some of the patchbots are set up strangely, but I'm not seeing any systemic issues with this branch.


---

Comment by roed created at 2019-12-30 23:28:09

Changing status from needs_review to positive_review.


---

Comment by roed created at 2019-12-30 23:28:09

I agree.  We have successful tests run on Darwin, so I'm setting this back to positive review.


---

Comment by vbraun created at 2020-01-05 15:47:17

Resolution: fixed
