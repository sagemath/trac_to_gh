# Issue 23709: Exhaust over Weil polynomials

archive/issues_023709.json:
```json
{
    "body": "CC:  @roed314\n\nKeywords: Weil polynomials, sd91\n\nI have reasonably stable code (mostly in C, depending on FLINT) for exhausting over Weil polynomials:\n\nhttps://github.com/kedlaya/root-unitary\n\nThe goal of this ticket is to incorporate this code into Sage in some fashion.\n\nIssue created by migration from https://trac.sagemath.org/ticket/23946\n\n",
    "created_at": "2017-09-30T20:23:32Z",
    "labels": [
        "component: number theory",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "Exhaust over Weil polynomials",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23709",
    "user": "https://github.com/kedlaya"
}
```
CC:  @roed314

Keywords: Weil polynomials, sd91

I have reasonably stable code (mostly in C, depending on FLINT) for exhausting over Weil polynomials:

https://github.com/kedlaya/root-unitary

The goal of this ticket is to incorporate this code into Sage in some fashion.

Issue created by migration from https://trac.sagemath.org/ticket/23946





---

archive/issue_comments_331723.json:
```json
{
    "body": "Status update: I've pushed many recent changes to the branch `repackage_for_sage` of the Github repo. In particular, I have been working to make the call syntax much more transparent; for instance, to compute the Weil polynomials corresponding to abelian varieties of dimension `g` over the finite field of order `q`, one can now use standard Python iterator syntax:\n\n```\nsage: wp = WeilPolynomials(2*g, q)\nsage: for i in wp:\n...\n```\n\nSome to-do items: check that all my old test scripts still work; write more tests; add more documentation; add more input sanitization.\n\nIn the meantime, I'd appreciate some feedback about where this might belong in Sage.",
    "created_at": "2017-10-12T05:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331723",
    "user": "https://github.com/kedlaya"
}
```

Status update: I've pushed many recent changes to the branch `repackage_for_sage` of the Github repo. In particular, I have been working to make the call syntax much more transparent; for instance, to compute the Weil polynomials corresponding to abelian varieties of dimension `g` over the finite field of order `q`, one can now use standard Python iterator syntax:

```
sage: wp = WeilPolynomials(2*g, q)
sage: for i in wp:
...
```

Some to-do items: check that all my old test scripts still work; write more tests; add more documentation; add more input sanitization.

In the meantime, I'd appreciate some feedback about where this might belong in Sage.



---

archive/issue_comments_331724.json:
```json
{
    "body": "Replying to [comment:1 kedlaya]:\n> In the meantime, I'd appreciate some feedback about where this might belong in Sage.\n\nFirst of all, your github repo contains both C code and `.sage` files. Are the `.sage` files considered to be part of your package or are they really only use cases/examples/tests/documentation?\n\n\nThere are two possibilities, each with its advantages and disadvantages:\n\n(A) Make it an external (presumably optional) package and interface it from Sage.\n\n(B) Make it actually a part of Sage itself.\n\nAdvantages of (A) are that you keep control of the package: you can easily change the package at will (with (B) every change would need to go through the Sage Trac) and you don't need to care about Sage coding standards. Also important: with (A) your package could be used without Sage. With (B), there might be more initial work needed to get it into Sage but then it might be less work to maintain.",
    "created_at": "2017-10-12T12:31:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331724",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:1 kedlaya]:
> In the meantime, I'd appreciate some feedback about where this might belong in Sage.

First of all, your github repo contains both C code and `.sage` files. Are the `.sage` files considered to be part of your package or are they really only use cases/examples/tests/documentation?


There are two possibilities, each with its advantages and disadvantages:

(A) Make it an external (presumably optional) package and interface it from Sage.

(B) Make it actually a part of Sage itself.

Advantages of (A) are that you keep control of the package: you can easily change the package at will (with (B) every change would need to go through the Sage Trac) and you don't need to care about Sage coding standards. Also important: with (A) your package could be used without Sage. With (B), there might be more initial work needed to get it into Sage but then it might be less work to maintain.



---

archive/issue_comments_331725.json:
```json
{
    "body": "I just merged a pull request in from another branch, which has the effect of significantly reconfiguring the file structure. In particular, there are no longer any `.sage` files in the main directory; the ones that exist are all in subdirectories and are indeed examples/tests.\n\nThe main code base now consists of two `.c` files (and their `.h` headers) and one `.pyx` file. I still don't have any sort of independent build structure set up; moreover, the `.pyx` file is more than just a simple wrapper, it is where the parallelism is currently implemented. So at the moment there is really no way to use the code without Sage, and I don't particularly intend to work on making that possible. (Exception: if someone wants to use the code from some other platform like Julia, I'd be willing to cooperate with that.)",
    "created_at": "2017-10-18T04:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331725",
    "user": "https://github.com/kedlaya"
}
```

I just merged a pull request in from another branch, which has the effect of significantly reconfiguring the file structure. In particular, there are no longer any `.sage` files in the main directory; the ones that exist are all in subdirectories and are indeed examples/tests.

The main code base now consists of two `.c` files (and their `.h` headers) and one `.pyx` file. I still don't have any sort of independent build structure set up; moreover, the `.pyx` file is more than just a simple wrapper, it is where the parallelism is currently implemented. So at the moment there is really no way to use the code without Sage, and I don't particularly intend to work on making that possible. (Exception: if someone wants to use the code from some other platform like Julia, I'd be willing to cooperate with that.)



---

archive/issue_comments_331726.json:
```json
{
    "body": "I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?",
    "created_at": "2017-10-18T21:44:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331726",
    "user": "https://github.com/roed314"
}
```

I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?



---

archive/issue_comments_331727.json:
```json
{
    "body": "Replying to [comment:4 roed]:\n> I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?\n\nDo you mean put everything in there? Or put the Cython in `sage/rings/polynomials/weil_polynomials.pyx` and the C files in `sage/rings/polynomial/weil`?\n\nAlso, if someone can point me to some guidance about a module to the Sage library (e.g., how to format `__init__.py` and `all.py` and the like to make the new code discoverable), that would be helpful.",
    "created_at": "2017-10-23T17:55:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331727",
    "user": "https://github.com/kedlaya"
}
```

Replying to [comment:4 roed]:
> I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?

Do you mean put everything in there? Or put the Cython in `sage/rings/polynomials/weil_polynomials.pyx` and the C files in `sage/rings/polynomial/weil`?

Also, if someone can point me to some guidance about a module to the Sage library (e.g., how to format `__init__.py` and `all.py` and the like to make the new code discoverable), that would be helpful.



---

archive/issue_comments_331728.json:
```json
{
    "body": "Replying to [comment:5 kedlaya]:\n> Replying to [comment:4 roed]:\n> > I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?\n> \n> Do you mean put everything in there? Or put the Cython in `sage/rings/polynomials/weil_polynomials.pyx` and the C files in `sage/rings/polynomial/weil`?\n\nI meant putting everything in there.  We should also talk about the best way for a user to access these methods; perhaps a method `weil_polynomials` on `ZZ[x]` and `QQ[x]` that returns your iterator?\n\n> Also, if someone can point me to some guidance about a module to the Sage library (e.g., how to format `__init__.py` and `all.py` and the like to make the new code discoverable), that would be helpful.\n\nSee http://doc.sagemath.org/html/en/developer/coding_basics.html#files-and-directory-structure for some details.  You'll also need to add lines to `src/module_list.py` for each extension module.",
    "created_at": "2017-10-25T16:09:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331728",
    "user": "https://github.com/roed314"
}
```

Replying to [comment:5 kedlaya]:
> Replying to [comment:4 roed]:
> > I think that the code is stable enough that we should just add it to Sage.  Maybe create a folder `sage/rings/polynomial/weil/` and put them in there?
> 
> Do you mean put everything in there? Or put the Cython in `sage/rings/polynomials/weil_polynomials.pyx` and the C files in `sage/rings/polynomial/weil`?

I meant putting everything in there.  We should also talk about the best way for a user to access these methods; perhaps a method `weil_polynomials` on `ZZ[x]` and `QQ[x]` that returns your iterator?

> Also, if someone can point me to some guidance about a module to the Sage library (e.g., how to format `__init__.py` and `all.py` and the like to make the new code discoverable), that would be helpful.

See http://doc.sagemath.org/html/en/developer/coding_basics.html#files-and-directory-structure for some details.  You'll also need to add lines to `src/module_list.py` for each extension module.



---

archive/issue_comments_331729.json:
```json
{
    "body": "Pushed some partial progress, but this doesn't compile yet.\n----\nNew commits:",
    "created_at": "2017-11-07T05:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331729",
    "user": "https://github.com/kedlaya"
}
```

Pushed some partial progress, but this doesn't compile yet.
----
New commits:



---

archive/issue_comments_331730.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-14T05:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331730",
    "user": "https://github.com/kedlaya"
}
```

New commits:



---

archive/issue_comments_331731.json:
```json
{
    "body": "OK, here is a new branch which seems to compile. Still a lot of polishing to be done, but it should be possible to at least play with the code now.\n----\nNew commits:",
    "created_at": "2019-12-14T05:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331731",
    "user": "https://github.com/kedlaya"
}
```

OK, here is a new branch which seems to compile. Still a lot of polishing to be done, but it should be possible to at least play with the code now.
----
New commits:



---

archive/issue_comments_331732.json:
```json
{
    "body": "does not work for me:\n\n```\nsage: from sage.rings.polynomial.weil.weil_polynomials import *\n---------------------------------------------------------------------------\nImportError                               Traceback (most recent call last)\n<ipython-input-1-5b4f8184ba57> in <module>()\n----> 1 from sage.rings.polynomial.weil.weil_polynomials import *\n\nImportError: /home/chapoton/sage3/local/lib/python3.7/site-packages/sage/rings/polynomial/weil/weil_polynomials.cpython-37m-x86_64-linux-gnu.so: undefined symbol: GOMP_loop_nonmonotonic_dynamic_start\n```\n\n\nand there are missing empty lines in the doc after lines ending with `::`",
    "created_at": "2019-12-14T20:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331732",
    "user": "https://github.com/fchapoton"
}
```

does not work for me:

```
sage: from sage.rings.polynomial.weil.weil_polynomials import *
---------------------------------------------------------------------------
ImportError                               Traceback (most recent call last)
<ipython-input-1-5b4f8184ba57> in <module>()
----> 1 from sage.rings.polynomial.weil.weil_polynomials import *

ImportError: /home/chapoton/sage3/local/lib/python3.7/site-packages/sage/rings/polynomial/weil/weil_polynomials.cpython-37m-x86_64-linux-gnu.so: undefined symbol: GOMP_loop_nonmonotonic_dynamic_start
```


and there are missing empty lines in the doc after lines ending with `::`



---

archive/issue_comments_331733.json:
```json
{
    "body": "That is the code looking for OpenMP (which is optional, since we don't ship it with Sage). Does it help if you take out the compiler directive in line 2 of `sage/rings/polynomial/weil/weil_polynomials.pyx`?\n\nThe docstrings need a fair bit of work to get to 100% doctest coverage, let alone proper formatting. I can of course work on that independently.",
    "created_at": "2019-12-14T21:02:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331733",
    "user": "https://github.com/kedlaya"
}
```

That is the code looking for OpenMP (which is optional, since we don't ship it with Sage). Does it help if you take out the compiler directive in line 2 of `sage/rings/polynomial/weil/weil_polynomials.pyx`?

The docstrings need a fair bit of work to get to 100% doctest coverage, let alone proper formatting. I can of course work on that independently.



---

archive/issue_comments_331734.json:
```json
{
    "body": "yes, removing the distutils directive make it work",
    "created_at": "2019-12-14T21:08:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331734",
    "user": "https://github.com/fchapoton"
}
```

yes, removing the distutils directive make it work



---

archive/issue_comments_331735.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-14T22:51:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331735",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331736.json:
```json
{
    "body": "In addition to suppressing OpenMP, I also added doctests to get to 100% coverage.\n\nCc'ing roed, who is somewhat familiar to the code.",
    "created_at": "2019-12-14T22:52:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331736",
    "user": "https://github.com/kedlaya"
}
```

In addition to suppressing OpenMP, I also added doctests to get to 100% coverage.

Cc'ing roed, who is somewhat familiar to the code.



---

archive/issue_comments_331737.json:
```json
{
    "body": "please remove the \"next\" method.\n\nand in the test of `__next__`, use next(it) to call the iterator.",
    "created_at": "2019-12-15T12:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331737",
    "user": "https://github.com/fchapoton"
}
```

please remove the "next" method.

and in the test of `__next__`, use next(it) to call the iterator.



---

archive/issue_comments_331738.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-15T17:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331738",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331739.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-15T22:51:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331739",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331740.json:
```json
{
    "body": "needs review ?",
    "created_at": "2019-12-17T19:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331740",
    "user": "https://github.com/fchapoton"
}
```

needs review ?



---

archive/issue_comments_331741.json:
```json
{
    "body": "Standing by for some feedback from roed first.",
    "created_at": "2019-12-17T20:40:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331741",
    "user": "https://github.com/kedlaya"
}
```

Standing by for some feedback from roed first.



---

archive/issue_comments_331742.json:
```json
{
    "body": "About to board a flight, and I want to make a few more changes, but can you take a look at the documentation I added and make sure it looks right?  It would also be nice to see some examples illustrating the different inputs available to the iterator.\n----\nNew commits:",
    "created_at": "2019-12-18T19:03:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331742",
    "user": "https://github.com/roed314"
}
```

About to board a flight, and I want to make a few more changes, but can you take a look at the documentation I added and make sure it looks right?  It would also be nice to see some examples illustrating the different inputs available to the iterator.
----
New commits:



---

archive/issue_comments_331743.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-19T00:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331743",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331744.json:
```json
{
    "body": "Alright, I made the other changes I wanted to make (most notably adding a method to polynomial rings).  Here are some documentation questions that I'd like to see addressed, but I think this ticket is basically ready to go.\n\n* I don't understand how specifying congruence constraints on leading coefficients works.  I tried the following:\n\n```\nsage: R.<T> = ZZ[]\nsage: R.weil_polynomials(4,2,lead=((1,0),(0,2)))\n[T^4 + 4, T^4 - T^2 + 4, T^4 - 2*T^2 + 4, T^4 - 3*T^2 + 4, T^4 - 4*T^2 + 4]\n```\n\nI would expect this to give polynomials where the coefficient of `T^3` was even, but I'm not sure what I'm getting.  Is it ignoring the 2 and giving me those where the coefficient of `T^3` is exactly 0?  Kiran, can you give me an idea of how this functionality is supposed to work?\n* I don't quite understand what `node_limit` does.  Raises a `RuntimeError` if the number of terminal nodes ever exceeds the given value?\n* Similarly, I guessed that `squarefree` omits polynomials that are not squarefree.\n\nOverall, can you check/correct the changes I made?  Also, if there's anything else useful to be said about how to recompile with OpenMP support, feel free to augment the documentation that I added.",
    "created_at": "2019-12-19T01:02:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331744",
    "user": "https://github.com/roed314"
}
```

Alright, I made the other changes I wanted to make (most notably adding a method to polynomial rings).  Here are some documentation questions that I'd like to see addressed, but I think this ticket is basically ready to go.

* I don't understand how specifying congruence constraints on leading coefficients works.  I tried the following:

```
sage: R.<T> = ZZ[]
sage: R.weil_polynomials(4,2,lead=((1,0),(0,2)))
[T^4 + 4, T^4 - T^2 + 4, T^4 - 2*T^2 + 4, T^4 - 3*T^2 + 4, T^4 - 4*T^2 + 4]
```

I would expect this to give polynomials where the coefficient of `T^3` was even, but I'm not sure what I'm getting.  Is it ignoring the 2 and giving me those where the coefficient of `T^3` is exactly 0?  Kiran, can you give me an idea of how this functionality is supposed to work?
* I don't quite understand what `node_limit` does.  Raises a `RuntimeError` if the number of terminal nodes ever exceeds the given value?
* Similarly, I guessed that `squarefree` omits polynomials that are not squarefree.

Overall, can you check/correct the changes I made?  Also, if there's anything else useful to be said about how to recompile with OpenMP support, feel free to augment the documentation that I added.



---

archive/issue_comments_331745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-19T02:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331745",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-19T03:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331746",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331747.json:
```json
{
    "body": "Replying to [comment:26 roed]:\n> Alright, I made the other changes I wanted to make (most notably adding a method to polynomial rings).  Here are some documentation questions that I'd like to see addressed, but I think this ticket is basically ready to go.\n> \nI made a few tweaks in the latest commits. I really like having a method for polynomial rings; I'm guessing most users will only use the code this way. The iterator is really only needed for power use cases.\n\nSince there is already an `is_weil_polynomial` method for polynomial elements, I edited the docstring for that method to point to `weil_polynomials` and vice versa.\n\n> * I don't understand how specifying congruence constraints on leading coefficients works.  I tried the following:\n> {{{\n> sage: R.<T> = ZZ[]\n> sage: R.weil_polynomials(4,2,lead=((1,0),(0,2)))\n> [T^4 + 4, T^4 - T^2 + 4, T^4 - 2*T^2 + 4, T^4 - 3*T^2 + 4, T^4 - 4*T^2 + 4]\n> }}}\n> I would expect this to give polynomials where the coefficient of `T^3` was even, but I'm not sure what I'm getting.  Is it ignoring the 2 and giving me those where the coefficient of `T^3` is exactly 0?  Kiran, can you give me an idea of how this functionality is supposed to work?\n\nYou just caught a bug in the C code which I have now fixed (here and upstream). I added a doctest documenting how this is supposed to work.\n\n> * I don't quite understand what `node_limit` does.  Raises a `RuntimeError` if the number of terminal nodes ever exceeds the given value?\n\nCorrect. It is there as a failsafe in case you don't want your code to run forever.\n\n> * Similarly, I guessed that `squarefree` omits polynomials that are not squarefree.\n> \nCorrect, except that there was a (long-known) bug in that too. I fixed that and added a doctest.\n\n> Overall, can you check/correct the changes I made?  Also, if there's anything else useful to be said about how to recompile with OpenMP support, feel free to augment the documentation that I added.\n\nOne issue is that on my system, I have to put the distutils lines at the top of the code when uncommenting them, which I think runs contrary to Sage conventions. I added a comment about this.\n\nSince it seems we are basically into the review phase anyway, let me go ahead and set state accordingly. I would be particularly open to suggestions for additional doctests; there are probably many use cases I haven't thought to test yet, and I'd like to make sure not to break those in future versions of the code.",
    "created_at": "2019-12-19T03:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331747",
    "user": "https://github.com/kedlaya"
}
```

Replying to [comment:26 roed]:
> Alright, I made the other changes I wanted to make (most notably adding a method to polynomial rings).  Here are some documentation questions that I'd like to see addressed, but I think this ticket is basically ready to go.
> 
I made a few tweaks in the latest commits. I really like having a method for polynomial rings; I'm guessing most users will only use the code this way. The iterator is really only needed for power use cases.

Since there is already an `is_weil_polynomial` method for polynomial elements, I edited the docstring for that method to point to `weil_polynomials` and vice versa.

> * I don't understand how specifying congruence constraints on leading coefficients works.  I tried the following:
> {{{
> sage: R.<T> = ZZ[]
> sage: R.weil_polynomials(4,2,lead=((1,0),(0,2)))
> [T^4 + 4, T^4 - T^2 + 4, T^4 - 2*T^2 + 4, T^4 - 3*T^2 + 4, T^4 - 4*T^2 + 4]
> }}}
> I would expect this to give polynomials where the coefficient of `T^3` was even, but I'm not sure what I'm getting.  Is it ignoring the 2 and giving me those where the coefficient of `T^3` is exactly 0?  Kiran, can you give me an idea of how this functionality is supposed to work?

You just caught a bug in the C code which I have now fixed (here and upstream). I added a doctest documenting how this is supposed to work.

> * I don't quite understand what `node_limit` does.  Raises a `RuntimeError` if the number of terminal nodes ever exceeds the given value?

Correct. It is there as a failsafe in case you don't want your code to run forever.

> * Similarly, I guessed that `squarefree` omits polynomials that are not squarefree.
> 
Correct, except that there was a (long-known) bug in that too. I fixed that and added a doctest.

> Overall, can you check/correct the changes I made?  Also, if there's anything else useful to be said about how to recompile with OpenMP support, feel free to augment the documentation that I added.

One issue is that on my system, I have to put the distutils lines at the top of the code when uncommenting them, which I think runs contrary to Sage conventions. I added a comment about this.

Since it seems we are basically into the review phase anyway, let me go ahead and set state accordingly. I would be particularly open to suggestions for additional doctests; there are probably many use cases I haven't thought to test yet, and I'd like to make sure not to break those in future versions of the code.



---

archive/issue_comments_331748.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-19T03:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331748",
    "user": "https://github.com/kedlaya"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_331749.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-19T09:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331749",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331750.json:
```json
{
    "body": "I've added some more tests.  I think I'm happy to give this positive review if all tests are passing.   I'm also happy to try to keep brainstorming some more doctests if you'd like.",
    "created_at": "2019-12-19T09:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331750",
    "user": "https://github.com/roed314"
}
```

I've added some more tests.  I think I'm happy to give this positive review if all tests are passing.   I'm also happy to try to keep brainstorming some more doctests if you'd like.



---

archive/issue_comments_331751.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-19T16:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331752.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-19T16:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331752",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331753.json:
```json
{
    "body": "A few last-minute changes:\n\n- There was a trivial bug in `polynomial_ring.py` about checking the base ring (which patchbot also noticed); I fixed that and added some doctests to confirm.\n- I fixed some compiler warnings on the backend.\n- I added a link to the github repo in the main package docstring.\n\nThat's probably enough doctests for the moment; I'll inevitably have to add more in response to later bugfixes. Let's see what patchbot has to say next.",
    "created_at": "2019-12-19T17:06:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331753",
    "user": "https://github.com/kedlaya"
}
```

A few last-minute changes:

- There was a trivial bug in `polynomial_ring.py` about checking the base ring (which patchbot also noticed); I fixed that and added some doctests to confirm.
- I fixed some compiler warnings on the backend.
- I added a link to the github repo in the main package docstring.

That's probably enough doctests for the moment; I'll inevitably have to add more in response to later bugfixes. Let's see what patchbot has to say next.



---

archive/issue_comments_331754.json:
```json
{
    "body": "Patchbot is green; I think we're good to go!  I'll optimistically set the milestone to 9.0. :-)",
    "created_at": "2019-12-19T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331754",
    "user": "https://github.com/roed314"
}
```

Patchbot is green; I think we're good to go!  I'll optimistically set the milestone to 9.0. :-)



---

archive/issue_comments_331755.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-19T18:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331755",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_331756.json:
```json
{
    "body": "On Python 2 there are various errors of the form \n\n```\n**********************************************************************\nFile \"src/sage/rings/polynomial/weil/weil_polynomials.pyx\", line 168, in sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count\nFailed example:\n    _ = next(it)\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count[3]>\", line 1, in <module>\n        _ = next(it)\n    TypeError: instance has no next() method\n**********************************************************************\n```\n",
    "created_at": "2019-12-25T09:57:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331756",
    "user": "https://github.com/vbraun"
}
```

On Python 2 there are various errors of the form 

```
**********************************************************************
File "src/sage/rings/polynomial/weil/weil_polynomials.pyx", line 168, in sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count
Failed example:
    _ = next(it)
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count[3]>", line 1, in <module>
        _ = next(it)
    TypeError: instance has no next() method
**********************************************************************
```




---

archive/issue_comments_331757.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-12-25T09:57:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331757",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_331758.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-25T16:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331758",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331759.json:
```json
{
    "body": "Replying to [comment:39 vbraun]:\n> On Python 2 there are various errors of the form \n> {{{\n> **********************************************************************\n> File \"src/sage/rings/polynomial/weil/weil_polynomials.pyx\", line 168, in sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count\n> Failed example:\n>     _ = next(it)\n> Exception raised:\n>     Traceback (most recent call last):\n>       File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n>         self.compile_and_execute(example, compiler, test.globs)\n>       File \"/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1123, in compile_and_execute\n>         exec(compiled, globs)\n>       File \"<doctest sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count[3]>\", line 1, in <module>\n>         _ = next(it)\n>     TypeError: instance has no next() method\n> **********************************************************************\n> }}}\n\nI was asked to remove that method (see comment:18), but anyway here it is again.",
    "created_at": "2019-12-25T16:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331759",
    "user": "https://github.com/kedlaya"
}
```

Replying to [comment:39 vbraun]:
> On Python 2 there are various errors of the form 
> {{{
> **********************************************************************
> File "src/sage/rings/polynomial/weil/weil_polynomials.pyx", line 168, in sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count
> Failed example:
>     _ = next(it)
> Exception raised:
>     Traceback (most recent call last):
>       File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
>         self.compile_and_execute(example, compiler, test.globs)
>       File "/var/lib/buildbot/slave/sage2_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1123, in compile_and_execute
>         exec(compiled, globs)
>       File "<doctest sage.rings.polynomial.weil.weil_polynomials.dfs_manager.node_count[3]>", line 1, in <module>
>         _ = next(it)
>     TypeError: instance has no next() method
> **********************************************************************
> }}}

I was asked to remove that method (see comment:18), but anyway here it is again.



---

archive/issue_comments_331760.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-12-25T16:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331760",
    "user": "https://github.com/kedlaya"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_331761.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-25T19:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331761",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331762.json:
```json
{
    "body": "Looking at the patchbot logs, it seems that at least one of the bots failed to build because of nested function declarations in the C code. I thought we were always compiling the Sage library with gcc, which supports nested functions even though they are not in the ANSI standard...?",
    "created_at": "2019-12-25T19:39:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331762",
    "user": "https://github.com/kedlaya"
}
```

Looking at the patchbot logs, it seems that at least one of the bots failed to build because of nested function declarations in the C code. I thought we were always compiling the Sage library with gcc, which supports nested functions even though they are not in the ANSI standard...?



---

archive/issue_comments_331763.json:
```json
{
    "body": "on osx we now use clang by default",
    "created_at": "2019-12-25T21:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331763",
    "user": "https://github.com/vbraun"
}
```

on osx we now use clang by default



---

archive/issue_comments_331764.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-25T23:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331764",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331765.json:
```json
{
    "body": "Ah, it seems clang does not (yet) support nested functions as in GNU C. So I redid that bit of the C code; let's see what the patchbots have to say now.",
    "created_at": "2019-12-25T23:58:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331765",
    "user": "https://github.com/kedlaya"
}
```

Ah, it seems clang does not (yet) support nested functions as in GNU C. So I redid that bit of the C code; let's see what the patchbots have to say now.



---

archive/issue_comments_331766.json:
```json
{
    "body": "Some of the patchbots are set up strangely, but I'm not seeing any systemic issues with this branch.",
    "created_at": "2019-12-30T07:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331766",
    "user": "https://github.com/kedlaya"
}
```

Some of the patchbots are set up strangely, but I'm not seeing any systemic issues with this branch.



---

archive/issue_comments_331767.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-30T23:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331767",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_331768.json:
```json
{
    "body": "I agree.  We have successful tests run on Darwin, so I'm setting this back to positive review.",
    "created_at": "2019-12-30T23:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331768",
    "user": "https://github.com/roed314"
}
```

I agree.  We have successful tests run on Darwin, so I'm setting this back to positive review.



---

archive/issue_comments_331769.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-01-05T15:47:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23709",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23709#issuecomment-331769",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
