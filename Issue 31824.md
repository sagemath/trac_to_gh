# Issue 31824: New SPKG for GNU gengetopt

Issue created by migration from https://trac.sagemath.org/ticket/32061

Original creator: mjo

Original creation time: 2021-06-25 17:13:35

The latest version of lcalc requires gengetopt to build:

  https://www.gnu.org/software/gengetopt/

We'll need an SPKG for lcalc to depend on.




---

Comment by mjo created at 2021-06-25 18:06:26

Changing status from new to needs_review.


---

Comment by mjo created at 2021-06-25 18:06:26

New commits:


---

Comment by git created at 2021-06-25 18:08:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-06-25 23:03:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-26 01:21:15

Title (first line) in SPKG.rst needs to start with the SPKG name (= directory name in build/pkgs/)


---

Comment by mkoeppe created at 2021-06-26 01:21:59

https://repology.org/project/gengetopt/versions has the missing distro information


---

Comment by git created at 2021-06-26 01:51:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2021-06-26 07:13:05

With the current branch, "make gengetopt" persists to try to upload from the mirrors, even if configure says

```
gengetopt-2.23:                              using system package; SPKG will not be installed
```

This is on Ubuntu 20.04

**EDIT** ok, I guess this may be the normal behaviour.


---

Comment by chapoton created at 2021-07-01 07:19:59

ok, installs correctly for me. 

`@`mkoeppe : Is there any way to check against many other machine configurations before setting to positive ? Because this will become a standard package, one should be cautious.


---

Comment by mkoeppe created at 2021-07-01 16:10:32

Replying to [comment:8 chapoton]:
> Is there any way to check against many other machine configurations before setting to positive ? Because this will become a standard package, one should be cautious.

Yes, see https://doc.sagemath.org/html/en/developer/portability_testing.html#automatic-parallel-tox-runs-on-github-actions


---

Comment by dimpase created at 2021-07-01 19:50:41

please also add homebrew gengetopt (yes it is gengetopt)


---

Comment by dimpase created at 2021-07-01 19:52:08

Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 chapoton]:
> > Is there any way to check against many other machine configurations before setting to positive ? Because this will become a standard package, one should be cautious.
> 
> Yes, see https://doc.sagemath.org/html/en/developer/portability_testing.html#automatic-parallel-tox-runs-on-github-actions

it can be started from a browser, very cool :-)


---

Comment by chapoton created at 2021-07-04 08:08:44

comment:10 needs to be done


---

Comment by dimpase created at 2021-07-04 10:42:01

conda has gengetopt too.


---

Comment by git created at 2021-07-04 12:06:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-07-04 12:07:01

both done


---

Comment by chapoton created at 2021-07-05 15:37:54

do other reviewers agree on a positive review ?


---

Comment by mkoeppe created at 2021-07-05 16:29:28

`@`mjo I know it's kind of late for this, but have you considered just shipping the generated C files as part of `lcalc`'s `make dist` and use `AM_MAINTAINER_MODE`, just like one used to do with `bison`?


---

Comment by mjo created at 2021-07-05 16:41:36

Yes, but not too much. The gengetopt input file is preprocessed by `./configure` to avoid duplication (i.e. to avoid leaving the old version in `lcalc --version` after changing `configure.ac`). I'm sure it could still be made to work, but the fact that the source files get touched on the user's machine would involve some autotools voodoo that I didn't really feel like dealing with.


---

Comment by dimpase created at 2021-07-05 16:57:59

I think gengetopt is small and everywhere, let's just add it and forget about it


---

Comment by dimpase created at 2021-07-05 16:58:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-05 17:12:03

Replying to [comment:9 mkoeppe]:
> Replying to [comment:8 chapoton]:
> > Is there any way to check against many other machine configurations before setting to positive ? Because this will become a standard package, one should be cautious.
> 
> Yes, see https://doc.sagemath.org/html/en/developer/portability_testing.html#automatic-parallel-tox-runs-on-github-actions

Well, did someone actually run it on GH Actions?


---

Comment by chapoton created at 2021-07-05 19:09:41

I tried, but everything I tried failed.


---

Comment by dimpase created at 2021-07-05 19:40:22

Replying to [comment:22 chapoton]:
> I tried, but everything I tried failed.
the only workflow that can be started from browser is
`SAGE_ROOT/tox.ini`

started here: 
https://github.com/sagemath/sagetrac-mirror/actions/runs/1002175317


---

Comment by dimpase created at 2021-07-06 08:49:56

although many old systems fail due to #32101 not yet merged.


---

Comment by dimpase created at 2021-07-08 11:23:20

The default build fails if `makeinfo` is not installed. I don't immediately see how to disable it, it seems to be hardwired.
In its aclocal.m4 one sees

```
# Some tools Automake needs.
AC_REQUIRE([AM_SANITY_CHECK])dnl
AC_REQUIRE([AC_ARG_PROGRAM])dnl
AM_MISSING_PROG([ACLOCAL], [aclocal-${am__api_version}])
AM_MISSING_PROG([AUTOCONF], [autoconf])
AM_MISSING_PROG([AUTOMAKE], [automake-${am__api_version}])
AM_MISSING_PROG([AUTOHEADER], [autoheader])
AM_MISSING_PROG([MAKEINFO], [makeinfo])
AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
AC_REQUIRE([AM_PROG_INSTALL_STRIP])dnl
AC_REQUIRE([AC_PROG_MKDIR_P])dnl
```


so it seems to be treated in the same scope as autotools.


---

Comment by dimpase created at 2021-07-08 11:23:20

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2021-07-08 12:14:29

Should we just add gengetopt to the general pre-reqs instead (and texinfo, for the good measure).
In fact if we added texinfo to the general pre-reqs then we'd be able to build gengetopt always.


---

Comment by mjo created at 2021-07-08 12:55:57

The info/html files are not supposed to be rebuilt (and makeinfo should not be required). There's just some stupid timestamp issue that I need to figure out.


---

Comment by git created at 2021-07-08 13:35:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-07-08 13:41:42

That new commit fixes it, but is a pretty ugly solution. I'm open to suggestions.

The next version of gengetopt should allow us to disable the documentation: https://git.savannah.gnu.org/cgit/gengetopt.git/commit/?h=devel&id=e3fe8db2b67cdb18e1a2a6765644c8cc476d0b0a


---

Comment by mkoeppe created at 2021-07-08 13:59:33

Replying to [comment:26 dimpase]:
> Should we just add gengetopt to the general pre-reqs instead (and texinfo, for the good measure).

Definitely no - it does not exist on macOS without homebrew.


I'd suggest to investigate comment 17 above more. 

The generated files are a clear use case for just being shipped in the "make dist" of lcalc.


---

Comment by mjo created at 2021-07-08 14:42:55

Replying to [comment:30 mkoeppe]:
> 
> I'd suggest to investigate comment 17 above more. 
> 
> The generated files are a clear use case for just being shipped in the "make dist" of lcalc. 
> 

This isn't a good long-term solution even if we can hack autotools to avoid re-running gengetopt. Currently only the package name and version (which are static) are substituted into the ggo file, but that should change. For example...



```
$ lcalc -O5 -z 10

ERROR: lcalc has not been compiled with openmp enabled.
...
```


Ignoring the nonsense advice it gives you, that option simply shouldn't be present. In other words, `./configure --disable-openmp` should not add the `-O` flag to the gengetopt file. Likewise for the elliptic curve flags that require `--with-pari`. Fixing that will make it thoroughly impossible to ship the generated C++ sources.

I've opened https://gitlab.com/sagemath/lcalc/-/issues/12 to track the issue.


---

Comment by mkoeppe created at 2021-07-08 15:44:39

Replying to [comment:31 mjo]:
> Replying to [comment:30 mkoeppe]:
> > 
> > I'd suggest to investigate comment 17 above more. 
> > 
> > The generated files are a clear use case for just being shipped in the "make dist" of lcalc. 
> > 
> 
> This isn't a good long-term solution even if we can hack autotools to avoid re-running gengetopt. Currently only the package name and version (which are static) are substituted into the ggo file, but that should change. For example...
> 
> 
> {{{
> $ lcalc -O5 -z 10
> 
> ERROR: lcalc has not been compiled with openmp enabled.
> ...
> }}}
> 
> Ignoring the nonsense advice it gives you, that option simply shouldn't be present.

I don't think so. I think in general a user would prefer that a package informs them about an option disabled at compile time rather than just pretending that it has never heard of this option.


---

Comment by dimpase created at 2021-07-08 17:03:25

testing this branch + #32101 on https://github.com/dimpase/sagetrac-mirror/actions/runs/1012429541


---

Comment by mjo created at 2021-07-08 19:44:48

Replying to [comment:32 mkoeppe]:
> 
> I don't think so. I think in general a user would prefer that a package informs them about an option disabled at compile time rather than just pretending that it has never heard of this option.

I can see your point, but am still aesthetically opposed to compiling in decoy options. If the user builds lcalc from source, the decoy options do him no good, since he's the one that disabled them in the first place. And if he's using a binary package, having them documented also does him no good, since he can't do anything about it. And in this case, while OpenMP isn't too bad, the pari options significantly clutter up the `--help` output.

If there were no gengetopt at all, I think these option would have been hidden by an `#if HAVE_FOO` a long time ago.


---

Comment by mkoeppe created at 2021-07-08 19:48:13

Replying to [comment:34 mjo]:
> if he's using a binary package, having them documented also does him no good, since he can't do anything about it.

Sure, the user can then complain to the packager.


---

Comment by mkoeppe created at 2021-07-08 19:49:31

Replying to [comment:34 mjo]:
> If the user builds lcalc from source, the decoy options do him no good, since he's the one that disabled them in the first place. 

That may have been 3 years in the past.


---

Comment by vbraun created at 2021-07-08 21:16:09


```
[gengetopt-2.23] if /bin/bash /var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/gengetopt-2.23/src/build-aux/missing makeinfo   -I . \
[gengetopt-2.23]  -o gengetopt.info `test -f 'gengetopt.texi' || echo './'`gengetopt.texi; \
[gengetopt-2.23] then \
[gengetopt-2.23]   rc=0; \
[gengetopt-2.23] else \
[gengetopt-2.23]   rc=$?; \
[gengetopt-2.23]   $restore $backupdir/* `echo "./gengetopt.info" | sed 's|[^/]*$||'`; \
[gengetopt-2.23] fi; \
[gengetopt-2.23] rm -rf $backupdir; exit $rc
[gengetopt-2.23] /var/lib/buildbot/slave/sage_git/build/local/var/tmp/sage/build/gengetopt-2.23/src/build-aux/missing: line 81: makeinfo: command not found
[gengetopt-2.23] WARNING: 'makeinfo' is missing on your system.
[gengetopt-2.23]          You should only need it if you modified a '.texi' file, or
[gengetopt-2.23]          any other file indirectly affecting the aspect of the manual.
[gengetopt-2.23]          You might want to install the Texinfo package:
[gengetopt-2.23]          <https://www.gnu.org/software/texinfo/>
[gengetopt-2.23]          The spurious makeinfo call might also be the consequence of
[gengetopt-2.23]          using a buggy 'make' (AIX, DU, IRIX), in which case you might
[gengetopt-2.23]          want to install GNU make:
[gengetopt-2.23]          <https://www.gnu.org/software/make/>
[gengetopt-2.23] make[8]: *** [Makefile:812: gengetopt.info] Error 127
```



---

Comment by dimpase created at 2021-07-08 22:04:09

Replying to [comment:37 vbraun]:
> {{{
> ...
> [gengetopt-2.23] make[8]: *** [Makefile:812: gengetopt.info] Error 127
> }}}
is this including the latest commit?


---

Comment by git created at 2021-07-09 16:11:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2021-07-09 16:12:15

The new commit works around the "makeinfo" problem in a better way. Instead of running "make" at the top level, we `cd` into the `gl` and `src` subdirectories and run "make" there.


---

Comment by mjo created at 2021-07-09 16:12:15

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2021-11-01 12:21:09

lgtm


---

Comment by dimpase created at 2021-11-01 12:21:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-11-06 13:25:01

Running with SAGE_CHECK=yes still fails:

```
[gengetopt-2.23]          using a buggy 'make' (AIX, DU, IRIX), in which case you might
[gengetopt-2.23]          want to install GNU make:
[gengetopt-2.23]          <https://www.gnu.org/software/make/>
[gengetopt-2.23] Makefile:842: recipe for target 'gengetopt.html' failed
[gengetopt-2.23] make[7]: *** [gengetopt.html] Error 1
[gengetopt-2.23] Makefile:812: recipe for target 'gengetopt.info' failed
[gengetopt-2.23] make[7]: *** [gengetopt.info] Error 127
[gengetopt-2.23] make[7]: Target 'check-am' not remade because of errors.
[gengetopt-2.23] Makefile:1201: recipe for target 'check' failed
[gengetopt-2.23] make[6]: *** [check] Error 2
```



---

Comment by vbraun created at 2021-11-06 13:25:01

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-11-06 16:41:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2021-11-06 16:43:01

Changing status from needs_work to positive_review.


---

Comment by mjo created at 2021-11-06 16:43:01

Replying to [comment:43 vbraun]:
> Running with SAGE_CHECK=yes still fails:

Whoops, we need to copy the fix from `spkg-build.in` into `spkg-check.in`, too. Should work now.


---

Comment by vbraun created at 2021-11-12 21:27:52

Resolution: fixed
