# Issue 31843: Apply some upstream NumPy patches for CPU detection

archive/issues_031843.json:
```json
{
    "body": "Followup to #32021\n\nIssue created by migration from https://trac.sagemath.org/ticket/32080\n\n",
    "created_at": "2021-06-28T23:51:07Z",
    "labels": [
        "packages: standard",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Apply some upstream NumPy patches for CPU detection",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31843",
    "user": "@jhpalmieri"
}
```
Followup to #32021

Issue created by migration from https://trac.sagemath.org/ticket/32080





---

archive/issue_comments_455061.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-28T23:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455061",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455062.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-06-29T00:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455062",
    "user": "@jhpalmieri"
}
```

New commits:



---

archive/issue_comments_455063.json:
```json
{
    "body": "The `cygwin-standard` build of this ticket (https://github.com/mkoeppe/sage/runs/2947289812?check_suite_focus=true) failed \nbecause of a mistake in my CI scripts. I'm pushing the necessary changes to #32021 so that we can test it properly.",
    "created_at": "2021-07-06T18:20:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455063",
    "user": "@mkoeppe"
}
```

The `cygwin-standard` build of this ticket (https://github.com/mkoeppe/sage/runs/2947289812?check_suite_focus=true) failed 
because of a mistake in my CI scripts. I'm pushing the necessary changes to #32021 so that we can test it properly.



---

archive/issue_comments_455064.json:
```json
{
    "body": "- 19074 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.0rc1\n- 19365 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.1 \n\nSo the upgrade to #32488 makes these patches obsolete. \n\nThe question whether this change:\n\n```\n--- a/build/pkgs/numpy/spkg-install.in\n+++ b/build/pkgs/numpy/spkg-install.in\n@@ -22,10 +22,6 @@ python3 ../lapack_conf.py\n export FFLAGS=\"$FFLAGS -fPIC\"\n export FCFLAGS=\"$FCFLAGS -fPIC\"\n \n-# Numpy 1.20.3 enables some intrinsics on machines without support with `-march=native`.\n-# We disable it until this is fixed.\n-export CFLAGS=\"$CFLAGS_NON_NATIVE\"\n-\n export NUMPY_FCONFIG=\"config_fc --noopt --noarch\"\n if [ \"$SAGE_FAT_BINARY\" = \"yes\" ]; then\n     export NUMPY_FCONFIG=\"--cpu-baseline=NONE\"\n```\n\nshould be done can be reopened after #32488, #32434, #32424 have been resolved.",
    "created_at": "2021-09-09T17:52:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455064",
    "user": "@mkoeppe"
}
```

- 19074 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.0rc1
- 19365 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.1 

So the upgrade to #32488 makes these patches obsolete. 

The question whether this change:

```
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,10 +22,6 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
-# Numpy 1.20.3 enables some intrinsics on machines without support with `-march=native`.
-# We disable it until this is fixed.
-export CFLAGS="$CFLAGS_NON_NATIVE"
-
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 if [ "$SAGE_FAT_BINARY" = "yes" ]; then
     export NUMPY_FCONFIG="--cpu-baseline=NONE"
```

should be done can be reopened after #32488, #32434, #32424 have been resolved.



---

archive/issue_comments_455065.json:
```json
{
    "body": "Okay, I will leave the decision about whether to remove `export CFLAGS=\"$CFLAGS_NON_NATIVE\"` to others. I don't know anything about NumPy or how this might affect its performance.",
    "created_at": "2021-09-10T15:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455065",
    "user": "@jhpalmieri"
}
```

Okay, I will leave the decision about whether to remove `export CFLAGS="$CFLAGS_NON_NATIVE"` to others. I don't know anything about NumPy or how this might affect its performance.



---

archive/issue_comments_455066.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-09-10T15:56:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455066",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455067.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-09-10T17:33:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31843",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31843#issuecomment-455067",
    "user": "@mkoeppe"
}
```

Resolution: invalid
