# Issue 31843: Apply some upstream NumPy patches for CPU detection

Issue created by migration from https://trac.sagemath.org/ticket/32080

Original creator: jhpalmieri

Original creation time: 2021-06-28 23:51:07

Followup to #32021


---

Comment by jhpalmieri created at 2021-06-28 23:51:13

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2021-06-29 00:07:05

New commits:


---

Comment by mkoeppe created at 2021-07-06 18:20:47

The `cygwin-standard` build of this ticket (https://github.com/mkoeppe/sage/runs/2947289812?check_suite_focus=true) failed 
because of a mistake in my CI scripts. I'm pushing the necessary changes to #32021 so that we can test it properly.


---

Comment by mkoeppe created at 2021-09-09 17:52:54

- 19074 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.0rc1
- 19365 was merged in https://github.com/numpy/numpy/releases/tag/v1.21.1 

So the upgrade to #32488 makes these patches obsolete. 

The question whether this change:

```
--- a/build/pkgs/numpy/spkg-install.in
+++ b/build/pkgs/numpy/spkg-install.in
@@ -22,10 +22,6 @@ python3 ../lapack_conf.py
 export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
-# Numpy 1.20.3 enables some intrinsics on machines without support with `-march=native`.
-# We disable it until this is fixed.
-export CFLAGS="$CFLAGS_NON_NATIVE"
-
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
 if [ "$SAGE_FAT_BINARY" = "yes" ]; then
     export NUMPY_FCONFIG="--cpu-baseline=NONE"
```

should be done can be reopened after #32488, #32434, #32424 have been resolved.


---

Comment by jhpalmieri created at 2021-09-10 15:56:26

Okay, I will leave the decision about whether to remove `export CFLAGS="$CFLAGS_NON_NATIVE"` to others. I don't know anything about NumPy or how this might affect its performance.


---

Comment by jhpalmieri created at 2021-09-10 15:56:26

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-09-10 17:33:19

Resolution: invalid
