# Issue 23544: python2/3: split spkg-install to spkg-build; fix various build issues

Issue created by migration from https://trac.sagemath.org/ticket/23781

Original creator: embray

Original creation time: 2017-09-04 16:44:59

Keywords: python2 python3

This ticket starts by splitting the `spkg-install` for python2 and python3 into separate `spkg-build` and `spkg-install` scripts as recommended by #21726 (we said we would apply this change to individual packages on a case-by-case basis, and I figured as long as I was making changes to these scripts it would be good to do).

This also fixes a general bug with the build, where building a new Python can link the python executable and extension modules with an old libpython left in `$SAGE_LOCAL`, leading to possible errors.

Rather than deleting the old libpython first, I think it's cleaner to pass the correct `$LDFLAGS` to prevent this from happening.

Finally, this moves the tests that certain extension modules built to after building, but before installing, and runs the tests out of the source directory.  This is a change extracted from #22509.


---

Comment by embray created at 2017-09-04 16:45:26

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-09-05 12:15:32

Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?


---

Comment by jdemeyer created at 2017-09-05 12:19:12

Looking at the difference between the Python 2 and Python 3 scripts, I wonder why this only occurs for Python 2:

```
  # Use EXTRA_CFLAGS for user-defined CFLAGS since Python puts its own
  # default flags like -O3 after CFLAGS but before EXTRA_CFLAGS.
  # We also disable warnings about unused variables/functions which are
  # common in Cython-generated code.
  export EXTRA_CFLAGS="`testcflags.sh -Wno-unused` $CFLAGS"
  unset CFLAGS
```

I think this is just an omission and it should be there for Python 3 also.


---

Comment by jdemeyer created at 2017-09-05 12:34:52

Apart from that, everything looks fine from looking at the diff.


---

Comment by embray created at 2017-09-05 14:08:48

Replying to [comment:2 jdemeyer]:
> Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?

I've wondered that myself.  It's tempting--maybe this ticket would be a good place to do it as long as I'm making changes...


---

Comment by embray created at 2017-09-05 14:14:12

Replying to [comment:3 jdemeyer]:
> Looking at the difference between the Python 2 and Python 3 scripts, I wonder why this only occurs for Python 2:
> {{{
>   # Use EXTRA_CFLAGS for user-defined CFLAGS since Python puts its own
>   # default flags like -O3 after CFLAGS but before EXTRA_CFLAGS.
>   # We also disable warnings about unused variables/functions which are
>   # common in Cython-generated code.
>   export EXTRA_CFLAGS="`testcflags.sh -Wno-unused` $CFLAGS"
>   unset CFLAGS
> }}}
> I think this is just an omission and it should be there for Python 3 also.

Apparently you added that in #19899, but didn't add it to python3, presumably just due to lack of python3 testing at the time.  Probably it applies there too.


---

Comment by jdemeyer created at 2017-09-06 08:24:13

Replying to [comment:5 embray]:
> Replying to [comment:2 jdemeyer]:
> > Given that these scripts are mostly the same for Python 2 and Python 3, would it be possible to have just one script (say, by symlinking) and then use `$PKG_NAME` inside the script where needed?
> 
> I've wondered that myself.  It's tempting--maybe this ticket would be a good place to do it as long as I'm making changes...

Great! Please do.


---

Comment by jdemeyer created at 2017-09-06 08:24:13

Changing status from needs_review to needs_work.


---

Comment by embray created at 2017-10-11 13:38:40

For some reason I thought I already did this.  I guess I'll finish this up now since this is a dependency of #22509, which I'd also really like to move forward on.


---

Comment by git created at 2017-10-11 13:44:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-10-11 14:30:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-11 14:31:51

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-11 14:31:51

As suggested, merged the mostly duplicate scripts into one (this will be _much_ better maintenance-wise going forward).  This required one small change to `sage-spkg` to ensure that symlinks are dereferenced when copying to the build directory.


---

Comment by jdemeyer created at 2017-10-13 09:00:09

I see that you are checking for the importability of various modules _before_ installing Python. That makes sense, but it also means that you can remove the duplicate check

```
if [ -z `find build -name _scproxy.so` ]; then
```



---

Comment by jdemeyer created at 2017-10-13 09:02:31

Maybe also fold both import checks into one by doing something like

```
testmodules="ctypes math hashlib crypt readline socket"
if ...; then
    testmodules="_scproxy $testmodules"
fi
for modules in $testmodules; do
```



---

Comment by jdemeyer created at 2017-10-13 09:04:00

Please explain this:

```
# Make sure -L. is placed before -L$SAGE_LOCAL/lib so that python and extension
# modules are linked with the right libpython
export LDFLAGS="-L. $LDFLAGS"
```

We didn't need this before...


---

Comment by jdemeyer created at 2017-10-13 09:08:10

`$CUR` is undefined here:

```
    mkdir "$CUR/include"
```

Just replace it with `..` since that's what it was.


---

Comment by embray created at 2017-10-13 09:21:23

Replying to [comment:14 jdemeyer]:
> Please explain this:
> {{{
> # Make sure -L. is placed before -L$SAGE_LOCAL/lib so that python and extension
> # modules are linked with the right libpython
> export LDFLAGS="-L. $LDFLAGS"
> }}}
> We didn't need this before...

Actually you did, you just didn't know it :)  I try to write reasonably descriptive commit messages: https://git.sagemath.org/sage.git/commit/?h=56408511f00875d68b76c150455b2bcfb5f0174f&id=cab490ec9f568b6bf70ede31f93ba86d71c865e8


---

Comment by embray created at 2017-10-13 09:22:54

Replying to [comment:12 jdemeyer]:
> I see that you are checking for the importability of various modules _before_ installing Python. That makes sense, but it also means that you can remove the duplicate check
> {{{
> if [ -z `find build -name _scproxy.so` ]; then
> }}}

I'm not honestly even sure what that check is for (or why it was ever separate to begin with).  Could you provide some background?


---

Comment by embray created at 2017-10-13 09:24:00

Replying to [comment:15 jdemeyer]:
> `$CUR` is undefined here:
> {{{
>     mkdir "$CUR/include"
> }}}
> Just replace it with `..` since that's what it was.

Oops--carry over from a merge conflict resolution.  I'll fix that.


---

Comment by git created at 2017-10-13 09:32:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-13 09:32:56

Replying to [comment:17 embray]:
> I'm not honestly even sure what that check is for (or why it was ever separate to begin with).  Could you provide some background?

Well, the old install script worked like:

A. Build Python

B. Check that `_scproxy.so` was compiled (Python does not consider it an error if this optional module was not compiled)

C. Install Python

D. Check that `_scproxy` can be imported.

Earlier versions of the install script did not have step B. This means that a broken Python could be installed in step C. So step B was added as a way of doing step D before installing. But now that you have arranged things like


A. Build Python

B. Check that `_scproxy.so` was compiled (Python does not consider it an error if this optional module was not compiled)

D. Check that `_scproxy` can be imported.

C. Install Python

there is no longer any reason for B: if `_scproxy` can be imported, surely it was compiled.


---

Comment by embray created at 2017-10-13 09:33:18

I'm going to try testing this on OSX.  I now supposedly have access to an OSX machine now, but I haven't tried using it for anything yet...  Would be great if there were a reliable OSX patchbot (maybe once I get things up and running there will be :)


---

Comment by embray created at 2017-10-13 09:35:20

Replying to [comment:20 jdemeyer]:
> Replying to [comment:17 embray]:
> there is no longer any reason for B: if `_scproxy` can be imported, surely it was compiled.

I see. I'll remove "B" then.  

I just meant I don't know what the `_scproxy` module is or why it's checked for in the first place.


---

Comment by git created at 2017-10-13 09:36:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-10-13 09:38:19

Replying to [comment:22 embray]:
> I just meant I don't know what the `_scproxy` module is or why it's checked for in the first place.

Well, I don't know it either. But clearly people consider it important.
----
New commits:


---

Comment by jdemeyer created at 2017-10-13 09:39:41

I still don't fully understand the `-L.` issue. Under which scenario would things break without it?


---

Comment by embray created at 2017-10-13 10:01:46

Replying to [comment:25 jdemeyer]:
> I still don't fully understand the `-L.` issue. Under which scenario would things break without it?

Sure, I'll demonstrate.  Say I disable that, and I also (for some reason) change `--enable-unicode=ucs4` to `--enable-unicode=ucs2` (this is just an easy way to wind up with an incompatible libpython).  Then I run `./sage -f python2`.  Soon as it goes to build the first extension module:


```
[python2-2.7.13.p1] gcc -shared -Wl,--enable-auto-image-base -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib -L/home/embray/src/sagemath/sage/local/lib -Wl,-rpath,/home/embray/src/sagemath/sage/local/lib build/temp.cygwin-2.8.0-x86_64-2.7/home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.o -L/home/embray/src/sagemath/sage/local/lib -L/usr/local/lib -L. -L. -lpython2.7 -o build/lib.cygwin-2.8.0-x86_64-2.7/_struct.dll
[python2-2.7.13.p1] build/temp.cygwin-2.8.0-x86_64-2.7/home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.o: In function `s_init':
[python2-2.7.13.p1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.c:1383: undefined reference to `PyUnicodeUCS2_AsEncodedString'
[python2-2.7.13.p1] /home/embray/src/sagemath/sage/local/var/tmp/sage/build/python2-2.7.13.p1/src/Modules/_struct.c:1383:(.text+0x1234): relocation truncated to fit: R_X86_64_PC32 against undefined symbol `PyUnicodeUCS2_AsEncodedString'
[python2-2.7.13.p1] collect2: error: ld returned 1 exit status
```


Those gcc flags are already something of a mess.  Several of the flags are duplicated (I'm not sure why). But also, as I explained in the commit message, our `LDFLAGS` are inserted very early on, so the linker finds `-lpython2.7` in `$SAGE_LOCAL/lib`, when it should be finding it in the current directory--the libpython that was just built.


---

Comment by embray created at 2017-10-13 10:04:02

I'll note it's possible this isn't as often a problem on Linux since it's not necessary to resolve all symbols at link time when linking shared libraries.


---

Comment by jdemeyer created at 2017-10-14 07:44:49

I don't agree with the `-L.` thing. I suggest to take it out and create a separate ticket of it (if you think that it is important enough).

The problem with the current approach is that those `LDFLAGS` are inherited by other Python packages. I don't know the exact mechanism, since it doesn't happen with the Sage library for example. But this is an example command line from scipy with this patch:

```
gcc -pthread -shared -L. -L/home/jdemeyer/sage/local/lib -Wl,-rpath,/home/jdemeyer/sage/local/lib -shared -L/home/jdemeyer/sage/local/lib -Wl,-rpath,/home/jdemeyer/sage/local/lib build/temp.linux-x86_64-2.7/scipy/cluster/_vq.o -L/home/jdemeyer/sage/local/lib -L/home/jdemeyer/sage/local/lib -Lbuild/temp.linux-x86_64-2.7 -lopenblas -lopenblas -lpython2.7 -o build/lib.linux-x86_64-2.7/scipy/cluster/_vq.so
```

Without this patch, this `-L.` wasn't there.


---

Comment by jdemeyer created at 2017-10-14 07:44:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-10-14 07:45:40

If you want to fix the `-L.` issue, I think it's better to fix the upstream build system instead.


---

Comment by embray created at 2017-10-16 12:19:26

I see what you're saying, but this is a problem that needs to be solved somehow.

I don't want to make a separate ticket because 

a) I'm sick of refactoring 

b) At some point (weeks ago, so I can't remember why) this was important enough to add to this ticket, because without it something was breaking.


---

Comment by jdemeyer created at 2017-10-16 12:31:22

Replying to [comment:30 embray]:
> I see what you're saying, but this is a problem that needs to be solved somehow.

What do you think of my proposal to fix the Python upstream build system to put `-L.` in the correct place? That looks like the best solution. And it doesn't affect distros because this is a pure build issue.


---

Comment by embray created at 2017-10-16 12:41:19

Replying to [comment:31 jdemeyer]:
> Replying to [comment:30 embray]:
> > I see what you're saying, but this is a problem that needs to be solved somehow.
> 
> What do you think of my proposal to fix the Python upstream build system to put `-L.` in the correct place? That looks like the best solution. And it doesn't affect distros because this is a pure build issue.

I'd definitely be fine with that--I'm just going to look around a bit more to see if there isn't already a solution to this.  It seems odd to me that there wouldn't be.


---

Comment by embray created at 2017-10-16 13:04:30

Okay, there is a better solution, which in retrospect is obvious--instead of exporting `LDFLAGS="-L. ..."`, just pass the additional flags at `make` time:

    `make LDFLAGS="-L. $LDFLAGS"`

This does not change the defaults that are saved to the `Makefile` by `configure` (and hence does not impact the flags used in the future for building extension modules).  But it does ensure that the correct flags are added for building the extension modules included with Python.

Whether or not this is an upstream bug is debatable, but I'll ask on python-dev.


---

Comment by git created at 2017-10-16 15:02:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2017-10-16 15:03:37

Changing status from needs_work to needs_review.


---

Comment by embray created at 2017-10-16 15:03:37

How does this looks?  It seems to work for me.

If you still really want me to make a separate ticket for the link issue I can do so; I would just prefer not to bother.


---

Comment by jdemeyer created at 2017-10-18 20:25:18

I just need to test this, but your explanation sounds OK.


---

Comment by jdemeyer created at 2017-10-18 20:26:46

Replying to [comment:35 embray]:
> If you still really want me to make a separate ticket for the link issue I can do so; I would just prefer not to bother.

If there is an easy fix, that's fine. It's just that I'd rather finish this ticket instead of keeping struggling with this one issue.


---

Comment by jdemeyer created at 2017-10-20 14:52:40

Looks good to me. One final thing: when making such substantial changes to the build/install scripts, it is safer to increase the patchlevel of the packages (even if one could argue that this is not strictly needed). I did that in a follow-up commit. Do you agree?
----
New commits:


---

Comment by git created at 2017-10-22 20:26:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-10-23 08:48:23

Yes--I think that's an unfortunate quirk of how we do continuous integration for Sage, but under the current circumstances I think it makes sense.


---

Comment by jdemeyer created at 2017-10-23 08:57:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-25 06:58:09

Resolution: fixed
