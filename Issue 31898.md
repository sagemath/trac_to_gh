# Issue 31898: Implement to_polynomial and from_polynomial methods for ModularFormsRing

Issue created by migration from https://trac.sagemath.org/ticket/32135

Original creator: @DavidAyotte

Original creation time: 2021-07-05 14:08:26

CC:  vdelecroix

Keywords: graded modular forms polynomials gsoc 2021

The goal of this ticket is to implement two methods: one for the class `GradedModularFormElement` and one for the class `ModularFormsRing`. 

* The first method is `to_polynomial` that will convert a graded form //F// into a polynomial //P(X_1, X_2,... X_n)// where the //X_i// correspond to the generators of the graded ring of modular forms in which //F// lives. Note that the result of this method is not unique in general. 


```
sage: M = ModularFormsRing(1)
sage: f = (M.0)^3 + (M.1)^2;
2 - 288*q + 400032*q^2 + 33473664*q^3 + 796491936*q^4 + 9257371200*q^5 + O(q^6)
sage: f.to_polynomial([M.0, M.1])
X^3 + Y^2
```


* The second method is `from_polynomial` that will convert a polynomial into a graded form:


```
sage: M = ModularFormsRing(1)
sage: M.from_polynomial(X^3 + Y^2, [M.0, M.1])
2 - 288*q + 400032*q^2 + 33473664*q^3 + 796491936*q^4 + 9257371200*q^5 + O(q^6)
```


This ticket is part of #31560


---

Comment by git created at 2021-07-06 19:38:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-07 01:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-07 17:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-07-07 17:51:22

Set assignee to @DavidAyotte.


---

Comment by @DavidAyotte created at 2021-07-07 17:53:15

Changing status from new to needs_review.


---

Comment by git created at 2021-07-12 13:18:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-12 20:21:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-07-27 08:57:54

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2021-07-27 08:57:54

The method `_monomials_of_weight` is hidden and it does not make much sense to have an `EXAMPLES` block for this. Furthermore, the code is not properly indented here.

The method `_weights_of_generators` is used only once in the code. It does not make much sense to have it given that its code is a single line.

In the documentation of `polynomial_ring` the generators are not unique. You would better change `Return the polynomial ring of which ``self`` is a quotient.` by `Return a polynomial ring of which ``self`` is a quotient.`.

The method `_monomials_of_weight` is used nowhere. After `:meth:` in the documentation you need to add backticks like `:meth:`my_method``. This was missing in `from_polynomial`.

Instead of

```
iter = 0
poly = 0
for p in monomials.keys():
    poly += soln[iter, 0]*p
    iter += 1
```

you would better write

```
poly = 0 # TODO : this should be the zero polynomial, not the integer 0
for iter, p in enumerate(monomials):
    poly += soln[iter, 0]*p
```



---

Comment by git created at 2021-07-27 19:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-07-27 19:14:33

Changing status from needs_work to needs_review.


---

Comment by @DavidAyotte created at 2021-07-27 19:14:33

Thank you very much for the comments! Considering the method `_monomials_of_weight`, it is used in `sage/modular/modform/element.py`, line 3563 (for the method `_homogeneous_to_polynomial`). However, it is the only place that it is used. Should I make it not private, or simply erase the method and move the code inside the method `_homogeneous_to_polynomial`?


---

Comment by git created at 2021-08-04 15:41:34

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-08-04 18:36:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2021-08-07 10:18:31

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2021-08-07 10:18:31

In `_homogeneous_to_polynomial` you call Sturm bound in two places (first one is inside a loop)

```
f[k].parent().sturm_bound()
self[k].parent().sturm_bound()
```

This is always the same value, right? I believe the code would be simpler to read if you initialized a variable

```
sturm_bound = M.modular_forms_of_weight(k).sturm_bound()
```

and use that instead.


There is a `TODO` left in the code

```
poly = 0 # TODO : this should be the zero polynomial, not the integer 0
```

Similarly, in the sum

```
        dict_of_monomials = {}
        for exponents in W:
            monomial_forms = 1; monomial_poly = 1
            iter = 0
            for e, g in zip(exponents, gens):
                monomial_forms *= self(g)**e
                monomial_poly *= poly_parent.gen(iter)**e
                iter += 1
            dict_of_monomials[monomial_poly] = monomial_forms
```

The `monomial_poly` should be the one from the polynomial ring. Not the Python integer one.


In the same piece of code, don't use `;`. Having two statements on the same line is more complicated to read.


I don't understand why the ouptut of `_monomials_of_weight` is a dictionary. The latter is an expensive data structure (involving hasing of the keys). You don't seem to use the dictionary structure anywhere.


---

Comment by git created at 2021-08-09 14:36:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-08-09 14:42:38

Changing status from needs_work to needs_review.


---

Comment by @DavidAyotte created at 2021-08-09 14:42:38

Thanks a lot for the review. I decided to remove `_monomials_of_weight` (and move the code inside `_homogeneous_to_polynomial`) because, as you pointed out, it is not used very often in the code. I believe that this eliminates a loop in the code. I also changed the dictionary structure to a list.


---

Comment by vdelecroix created at 2021-08-12 06:33:09

I think there ought to be a test with a base ring different from `ZZ`.


---

Comment by git created at 2021-08-12 12:59:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-08-12 13:10:01

Currently polynomial conversion does not work over base ring other than Q mostly because of the method `gens_form` (which only returns forms over Q no matter what the base ring is). There is also the method `generators` which only returns q-expansion, so I think that there might be more than just one change to do here. Hence, I think that this should be a topic of a new ticket (I was planning to open one soon) and I simply decided to add an `if` statement in order to check the base ring. What do you think?


---

Comment by vdelecroix created at 2021-08-16 15:00:00

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2021-08-16 15:00:00

It is fine for now.


---

Comment by @DavidAyotte created at 2021-08-17 13:06:18

I'm changing this to _needs work_ because I will add input parsing for the element constructor (in order to check if the polynomial is a q-expansion).


---

Comment by @DavidAyotte created at 2021-08-17 13:06:18

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-08-25 13:39:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-08-25 13:40:38

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2021-08-26 07:50:15

Is this the expected behavior

```
sage: M = ModularFormsRing(1)
sage: q,t = polygens(QQ, 'q,t')
sage: M(q^2+t^3)
Traceback (most recent call last):
...
NotImplementedError: conversion from q-expansion not yet implemented
```



---

Comment by git created at 2021-08-26 14:58:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-08-26 15:00:44

Hello Vincent,

Thank you for your comment, I changed a little bit the behavior of the code. What do you think? I'm all ears to any other ideas also.


---

Comment by vdelecroix created at 2021-08-27 15:27:06

Hi David,

I don't like the fact that we rely on variable names to parse user input. What about using univariate (for q-expansion) versus multivariate (for generators)?

Also, you sometimes use `defaults.DEFAULT_VARIABLE` and sometimes the string `'q'`. The usage could be cleaner.


---

Comment by vdelecroix created at 2021-08-27 15:27:14

(cleaner and tested)


---

Comment by git created at 2021-08-27 19:00:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DavidAyotte created at 2021-08-27 19:20:09

Replying to [comment:31 vdelecroix]:
> Hi David,
> 
> I don't like the fact that we rely on variable names to parse user input. What about using univariate (for q-expansion) versus multivariate (for generators)?
> 
> Also, you sometimes use `defaults.DEFAULT_VARIABLE` and sometimes the string `'q'`. The usage could be cleaner.

Thank you for your feedback! I decided to drop completely the case for a univariate polynomial. At first, I wanted the code to work even if the number of variables was less or equal to the number of generators, but it turned out to be confusing with q-expansion, so as you said it is better to stick with multivariate polynomials. I also added some details in the documentation in order to make it clearer for the user (is it?). 

For q-expansion, I think it will be better to stick with power series (and not univariate polynomial) instead in order to be consistent with the spaces of weighted modular forms:


```
sage: M = ModularForms(1, 4)
sage: q = polygen(QQ, 'q')
sage: E4 = 1 + 240*q + 2160*q^2 + 6720*q^3 + 17520*q^4 + 30240*q^5 # Univariate polynomial
sage: M(E4)
Traceback (most recent call last):
...
TypeError: can't initialize vector from nonzero non-list
sage: P.<q> = PowerSeriesRing(QQ)
sage: E4 = 1 + 240*q + 2160*q^2 + 6720*q^3 + 17520*q^4 + 30240*q^5 + O(q^6) # Power series
sage: M(E4)
1 + 240*q + 2160*q^2 + 6720*q^3 + 17520*q^4 + 30240*q^5 + O(q^6)
```


Moreover, observe that we have the following behavior:


```
sage: P.<q> = PowerSeriesRing(QQ)
sage: E4 = 1 + 240*q + 2160*q^2 + 6720*q^3 + 17520*q^4 + 30240*q^5 # Exact power series
sage: M(E4)
Traceback (most recent call last):
...
TypeError: unable to create modular form from exact non-zero polynomial
```


However, I do find the error message "can't initialize vector from nonzero non-list" not very explicit for the user (but that's an issue for an other ticket).


---

Comment by vdelecroix created at 2021-08-28 06:31:30

Good point. I agree that compatibility with modular forms come first. The interface there is reasonable, to specify zero leading coefficients you need the O(q^n).


---

Comment by vdelecroix created at 2021-08-30 09:41:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-08-31 22:00:32

Resolution: fixed
