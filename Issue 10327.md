# Issue 10327: Flint-1.5.2 with ARM 32-bits

Issue created by migration from https://trac.sagemath.org/ticket/10328

Original creator: Snark

Original creation time: 2010-11-25 17:18:57

Assignee: GeorgSWeber

CC:  leif

Here is a patch for flint-1.5.2, which only modifies what gets built on ARM 32-bits.

I can confirm that with that change, flint-1.5.2 builds -- and all tests end up ok.

The issue has been discussed upstream ; they're ok with a sage-only patch, since they're focusing on flint2.

I built my own spkg by :

* taking the current flint spkg ;

* putting the 1.5.2 version of flint in src/ instead of the current 1.5.0 ;

* copying src/longlong.h to patches/

* copying the attached patch to patches/

* applying it to the patches/longlong.h

In spkg-install, I also added two lines :

# Patched longlong.h doesn't produce invalid assembly on 32-bit ARM

cp patches/longlong.h src/

Then I packed it into flint-1.5.2.p1.spkg, and put it in ~/sage/spkg/standard/ ; removing the current flint spkg.


---

Attachment

Patch to remove buggy sub_ddmmss implementation


---

Comment by leif created at 2010-12-17 14:30:50

I'm intending to upgrade Sage's FLINT to 1.5.2 at #9858, because of #8664, to be hopefully merged into (an early alpha of) Sage 4.6.2.

Note that the spkg needs clean-up I'll do there as well. (I already did some stuff, until black-out... :/ )


Btw, FLINT 1.6 is on the way, too.

----

The _Author(s)_ field should contain realnames; please also add yourself to http://trac.sagemath.org/sage_trac/wiki#AccountNamesmappedtoRealNames .

In general you should provide a proper Mercurial patch to the spkg (along with a link to the updated spkg), but I can include your changes in my spkg.


---

Comment by leif created at 2010-12-26 18:05:15

Replying to [comment:1 leif]:
> I'm intending to upgrade Sage's FLINT to 1.5.2 at #9858, because of #8664, to be hopefully merged into (an early alpha of) Sage 4.6.2.
> 
> Note that the spkg needs clean-up I'll do there as well. (I already did some stuff, until black-out... :/ )
> 
> 
> Btw, FLINT 1.6 is on the way, too.


FLINT 1.6 was released on/for Chrismas (Dec. 24th).

Unless somebody else already did/does I'll open a ticket to upgrade Sage's version to that one.

Since Sage currently does weird things with the Makefile, providing a new, "clean" spkg will take some time (besides testing collaboration with the new FLINT of course).

(Though FLINT is a *plain C* library, with a *separate* module to interface with NTL, which is C++ and hence the interface as well, Sage builds one monolithic "FLINT" library with that interface module included such that it always depends on the NTL library and the C++ standard library, which is totally odd and frequently causes trouble. Changing that requires changes to the _Sage library_, including `module_list.py` and perhaps `setup.py`, too.)


---

Comment by Snark created at 2011-08-21 19:16:17

Changing status from new to needs_info.


---

Comment by Snark created at 2011-08-21 19:16:17

sage 4.7.1 is still using flint 1.5.0.p5 which doesn't build on ARM, so what I described above is still current. How are things going with respect to an upgraded flint?


---

Comment by kcrisman created at 2011-08-24 02:04:53

Copying a comment I made on #9858 here:

Here is another issue - if one of the patches fails in the _current_ Flint spkg, then the Cygwin-only move of `$SAGE_LOCAL/lib/libntl.a` to a temporary file is NOT rescinded.  So this should already happen if the patches do not apply.  Just a point for any upgrade to FLINT - this should be fixed.

(I noticed this because one of the patches didn't apply for me.  Which makes no sense, because it was exactly right.  But whatever.)


---

Comment by kcrisman created at 2011-08-24 02:43:35

See #11727 for that problem.


---

Comment by Snark created at 2011-10-29 18:23:03

I gave sage-4.7.2.alpha4 a try, and it still has flint-1.5.0.p9, which doesn't build.

I replaced sage-4.7.2.alpha4's flint-1.5.0.p9.spkg's src/ directory with flint-1.5.2's sources, put my longlong.diff patch in patches/ as longlong.patch, and it compiled successfully.


---

Comment by was created at 2011-12-20 23:53:16

I had to do some rebasing of patches, etc. to get a flint-1.5.2 to actually work.   Here's my spkg, since it may be useful:

http://wstein.org/patches/flint-1.5.2.spkg

The repo isn't checked in.  This did work for me on Android.

william


---

Comment by dimpase created at 2011-12-30 08:51:11

Replying to [comment:7 was]:
> I had to do some rebasing of patches, etc. to get a flint-1.5.2 to actually work.   Here's my spkg, since it may be useful:
> 
> http://wstein.org/patches/flint-1.5.2.spkgthat 
> 
> The repo isn't checked in.  This did work for me on Android.
> 
I can confirm that it also builds on AC100, ubuntu 11.10.
I will be willing to give it positive review once I am done building and testing Sage.


> william


---

Comment by was created at 2011-12-31 14:33:02

I don't think we should give this a positive review as is.    More precisely, it deletes a chunk of code that isn't buggy (as far as we know) on other platforms, and which could lead to a big performance regression (for all I know).  That code should only get deleted when building Sage on ARM.


---

Comment by dimpase created at 2012-01-01 07:37:17

Replying to [comment:9 was]:
> I don't think we should give this a positive review as is.    More precisely, it deletes a chunk of code that isn't buggy (as far as we know) on other platforms, and which could lead to a big performance regression (for all I know).  That code should only get deleted when building Sage on ARM. 

OK, I actually did not look into the spkg. Right, thus some rebasing needs to be done...


---

Comment by Snark created at 2012-01-02 12:52:14

The code I remove is under "#if defined (__arm__) && W_TYPE_SIZE == 32", so "it deletes a chunk of code that isn't buggy (as far as we know) on other platforms" is wrong : that code is platform-specific and is known not to compile on that very platform!

The removal is unconditional because the code is conditional anyway : if it's not there, then we fall back on C code which compiles and runs. Not optimal, but there is no working optimised code for the platform anyway, so there's no regression.

I hope that clears matters.


---

Comment by dimpase created at 2012-01-22 12:47:28

I've cleaned up the spkg, updated SPKG.txt, checked in stuff, and put the result [here](http://boxen.math.washington.edu/home/dima/packages/flint-1.5.2.spkg). I'll test on a couple of platforms, just to make sure everything is OK.


---

Comment by dimpase created at 2012-01-22 13:39:40

Replying to [comment:12 dimpase]:
> I've cleaned up the spkg, updated SPKG.txt, checked in stuff, and put the result [here](http://boxen.math.washington.edu/home/dima/packages/flint-1.5.2.spkg). I'll test on a couple of platforms, just to make sure everything is OK.

all is well, it appears (tested on Linux, MacOSX).


---

Comment by dimpase created at 2012-01-22 13:39:40

Changing status from needs_info to needs_review.


---

Comment by Snark created at 2012-02-25 20:43:57

When will that spkg find its way into sage?


---

Comment by dimpase created at 2012-02-25 20:50:32

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-25 20:58:26

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-02-25 20:58:26

Dmitrii: I guess somebody else should review your changes.


---

Comment by jdemeyer created at 2012-02-25 20:58:32

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2012-03-24 06:28:39

I can confirm that this still builds and passes ptestlong on Sage 5.0.beta9. As I cannot review my own changes, Julien, could you please review this?


---

Comment by Snark created at 2012-03-24 09:29:30

Changing status from needs_review to positive_review.


---

Comment by Snark created at 2012-03-24 09:29:30

I have been using (compiling&ptestlonging) this package both on ARM and x86_64 since it has been available and last time this very morning. Never had anything to say about it.

So positive review.


---

Comment by leif created at 2012-03-24 10:29:00

Well, the spkg should at least have a `.p0` extension, as it modifies upstream code.  (In the ticket's description, Julien says he made a `.p1`.)

Provided I do have the correct / most recent spkg ([this](http://boxen.math.washington.edu/home/dima/packages/flint-1.5.2.spkg), md5sum `4ef63f3b19e31e3a8f0161a24cfa661a`), I don't see how the "spkg got cleaned up", but I don't mind the latter either, as I've been working on a (cleaned-up!) FLINT 1.5.2 spkg a couple of times and had to rebase my changes at least five times.  Hopefully I'll finally get my changes in on some other ticket.


---

Comment by dimpase created at 2012-03-24 13:22:43

Replying to [comment:21 leif]:
> Well, the spkg should at least have a `.p0` extension, as it modifies upstream code.  (In the ticket's description, Julien says he made a `.p1`.)

Done.

> 
> Provided I do have the correct / most recent spkg ([this](http://boxen.math.washington.edu/home/dima/packages/flint-1.5.2.spkg), md5sum `4ef63f3b19e31e3a8f0161a24cfa661a`), I don't see how the "spkg got cleaned up", 

well, I just committed the changes into the repo, updated SPKG.txt, etc.


---

Comment by leif created at 2012-03-24 14:16:50

Replying to [comment:23 dimpase]:
> Replying to [comment:21 leif]:
> > Well, the spkg should at least have a `.p0` extension, as it modifies upstream code.  (In the ticket's description, Julien says he made a `.p1`.)
> 
> Done.

Ok, thanks.  (New spkg is also "clean" as far as I can see.)


---

Comment by Snark created at 2012-04-06 07:11:45

I see beta12 still has the old flint.

What more is there to do here?


---

Comment by jdemeyer created at 2012-04-06 07:36:39

Replying to [comment:26 Snark]:
> What more is there to do here?
Patience you must have.


---

Comment by Snark created at 2012-04-06 14:43:56

Sigh. I just noticed 1.6 has been released since I opened that ticket. Let's get 1.5.2 in sage first...


---

Comment by jdemeyer created at 2012-04-19 06:43:34

Resolution: fixed
