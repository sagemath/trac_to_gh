# Issue 21922: Upgrade to latest libpng

Issue created by migration from https://trac.sagemath.org/ticket/22159

Original creator: jdemeyer

Original creation time: 2017-01-09 10:41:42

CC:  jpflori frederichan

*Tarball*: http://download.sourceforge.net/libpng/libpng-1.6.28.tar.gz


---

Comment by git created at 2017-01-09 13:37:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-09 14:58:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2017-01-09 15:53:19

Changing status from new to needs_review.


---

Comment by jpflori created at 2017-01-10 09:59:21

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2017-01-10 09:59:21

Looks good to me.
Let the patchbots do their job.


---

Comment by jdemeyer created at 2017-01-10 13:41:25

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-01-10 13:41:25

I have some doubts regarding `giac`. Setting this back to needs_work for now...


---

Comment by jdemeyer created at 2017-01-11 08:47:48

Changing keywords from "" to "atelierpari2017".


---

Comment by jpflori created at 2017-01-12 13:04:56

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-01-22 10:36:52

Fails in giac

```
[giac-1.2.2.103] /bin/bash ../libtool --tag=CXX   --mode=link g++  -g -O2 -fno-strict-aliasing -DGIAC_GENERIC_CONSTANTS  -L/home/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildbot/slave/sage_git/build/local/lib  -o aide aide.o libxcas.la -lreadline  -ldl -lpng -lm -lmpfi -lmpfr -lgmp  -lgsl -lgslcblas  -lrt -lpthread -ldl -lpng -lm -lmpfi -lmpfr -lgmp 
25420[giac-1.2.2.103] libtool: link: g++ -g -O2 -fno-strict-aliasing -DGIAC_GENERIC_CONSTANTS -Wl,-rpath -Wl,/home/buildbot/slave/sage_git/build/local/lib -o .libs/aide aide.o  -L/home/buildbot/slave/sage_git/build/local/lib ./.libs/libxcas.a /home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/giac-1.2.2.103/src/src/.libs/libgiac.so -lntl -lpari -lreadline -lgsl -lgslcblas -lrt -lpthread -ldl -lpng -lm -lmpfi -lmpfr -lgmp -Wl,-rpath -Wl,/home/buildbot/slave/sage_git/build/local/lib
25421[giac-1.2.2.103] /home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/giac-1.2.2.103/src/src/.libs/libgiac.so: undefined reference to `png_set_longjmp_fn'
25422[giac-1.2.2.103] collect2: error: ld returned 1 exit status
25423[giac-1.2.2.103] Makefile:574: recipe for target 'icas' failed
25424[giac-1.2.2.103] make[5]: *** [icas] Error 1
25425[giac-1.2.2.103] /home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/giac-1.2.2.103/src/src/.libs/libgiac.so: undefined reference to `png_set_longjmp_fn'
25426[giac-1.2.2.103] collect2: error: ld returned 1 exit status
25427[giac-1.2.2.103] Makefile:571: recipe for target 'aide' failed
```



---

Comment by vbraun created at 2017-01-22 10:36:52

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-01-22 11:08:38

Is this using `ccache`? I remember a similar error where it turned out to be a `ccache` bug. Just to be sure, could you try again with `CCACHE_DISABLE=1`?


---

Comment by vbraun created at 2017-01-22 13:07:43

Also happens on buildbot without ccache


---

Comment by jdemeyer created at 2017-01-23 07:26:17

OK, thanks for the info.


---

Comment by frederichan created at 2017-01-25 17:55:42

On fedora 25 where my system libpng is 1.6.27 I was able to built giac with your libpng 1.6.28.

On a debian system with libpng12 installed I was able to reproduce the above error.

But cd in src/src/.libs and edit libgiac.la with -lpng16 instead of -lpng and I was able to end the built.

Does it worth a patch (do you have a similar pb elsewhere?) or should I ask parisse if it is possible to add a --disable-png in configure?


---

Comment by jpflori created at 2017-01-25 21:53:43

Worth a patch.
See #22163#comment:4


---

Comment by frederichan created at 2017-02-08 09:28:17

I have configured giac with --disable-png in #22101 so this should not happen anymore with the 1.2.3.25 giac spkg


---

Comment by tmonteil created at 2017-03-13 08:35:30

Replying to [comment:17 frederichan]:
> I have configured giac with --disable-png in #22101 so this should not happen anymore with the 1.2.3.25 giac spkg

I would be +1 for the patch as well, since i need to compile giac with png and fltk support for [Sage Debian Live](https://sagedebianlive.metelu.net/), since i provide xcas through Sage. So, if it is possible, it is better to fix the issue than to skip it.


---

Comment by frederichan created at 2017-03-13 10:41:51

Replying to [comment:18 tmonteil]:
> Replying to [comment:17 frederichan]:
> > I have configured giac with --disable-png in #22101 so this should not happen anymore with the 1.2.3.25 giac spkg
> 
> I would be +1 for the patch as well, since i need to compile giac with png and fltk support for [Sage Debian Live](https://sagedebianlive.metelu.net/), since i provide xcas through Sage. So, if it is possible, it is better to fix the issue than to skip it.

The problem occurs when you have a libpng12 system wide installed and sage libpng1.6. If you built giac with the system wide libpng12 then I guess  that you will have the same error as in comment 10.
Are you using 2 libpng in sage debian live?
Now if you built giac with -lpng16 instead of -lpng I don't know if it will work with your fltk because I guess it is linked to the system libpng12?


---

Comment by tmonteil created at 2017-03-15 10:54:18

Replying to [comment:19 frederichan]:
> The problem occurs when you have a libpng12 system wide installed and sage libpng1.6. If you built giac with the system wide libpng12 then I guess  that you will have the same error as in comment 10.
> Are you using 2 libpng in sage debian live?
> Now if you built giac with -lpng16 instead of -lpng I don't know if it will work with your fltk because I guess it is linked to the system libpng12?

Indeed: `apt-rdepends libfltk1.3-dev | grep -E '^[a-zA-Z0-9]' | grep png` leads to `libpng12-0` Fortunately, the next Debian stable will ship libpng16.


---

Comment by frederichan created at 2017-03-15 14:37:32

Replying to [comment:20 tmonteil]:
> Replying to [comment:19 frederichan]:
> > The problem occurs when you have a libpng12 system wide installed and sage libpng1.6. If you built giac with the system wide libpng12 then I guess  that you will have the same error as in comment 10.
> > Are you using 2 libpng in sage debian live?
> > Now if you built giac with -lpng16 instead of -lpng I don't know if it will work with your fltk because I guess it is linked to the system libpng12?
> 
> Indeed: `apt-rdepends libfltk1.3-dev | grep -E '^[a-zA-Z0-9]' | grep png` leads to `libpng12-0` Fortunately, the next Debian stable will ship libpng16.
NB: giac/xcas has now an official package in debian unstable:

https://packages.debian.org/source/unstable/giac

so in next releases you may not need the spkg for xcas.


---

Comment by tmonteil created at 2017-03-15 15:17:24

> Indeed: `apt-rdepends libfltk1.3-dev | grep -E '^[a-zA-Z0-9]' | grep png` leads to `libpng12-0` Fortunately, the next Debian stable will ship libpng16.

Actually, i wonder whether giac from Sage could produce png with libpng16 (shipped with Sage once this ticket gets merged) and the xcas GUI could be displayed with fltk using system's libpng12 without any conflict. I will try such an option anyway (also, `libfltk1.3-dev` has no dependency on `libpng12-dev` so that i can remove it during giac compilation, so there should not be any problem there).

Replying to [comment:21 frederichan]:
> NB: giac/xcas has now an official package in debian unstable:
> 
> https://packages.debian.org/source/unstable/giac
> 
> so in next releases you may not need the spkg for xcas.

Well, it did not enter stretch, which is now frozen, hence it will not be shipped with the next stable :(


---

Comment by dimpase created at 2017-03-28 21:47:10

I suspect that something is not perfect with libpng in Sage. In particular, on FreeBSD (#22679) with Sage's current libpng (1.2.51) I see

```
sage: loads(dumps(B)) == B ## line 827 ##
libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
libpng warning: Application  is  running with png.c from libpng-1.2.51
GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library

**********************************************************************
----------------------------------------------------------------------
sage -t --long src/sage/coding/binary_code.pyx  # Killed due to segmentation fault
```

so it looks as if somewhere wrong or absent `-I/...` is used for compilation.


---

Comment by dimpase created at 2017-03-28 23:27:55

Replying to [comment:23 dimpase]:
> I suspect that something is not perfect with libpng in Sage. In particular, on FreeBSD (#22679) with Sage's current libpng (1.2.51) I see
> {{{
> sage: loads(dumps(B)) == B ## line 827 ##
> libpng warning: Application was compiled with png.h from libpng-1.6.27+apng
> libpng warning: Application  is  running with png.c from libpng-1.2.51
> GD Error: gd-png: fatal libpng error: Incompatible libpng version in application and library
> 
> **********************************************************************
> ----------------------------------------------------------------------
> sage -t --long src/sage/coding/binary_code.pyx  # Killed due to segmentation fault
> }}}
> so it looks as if somewhere wrong or absent `-I/...` is used for compilation.

unsurprisingly, upgrading to the branch in this ticket makes this crash go away.


---

Comment by dimpase created at 2017-03-29 15:36:19

Replying to [comment:23 dimpase]:
> I suspect that something is not perfect with libpng in Sage. 
> In particular, on FreeBSD (#22679) with Sage's current libpng (1.2.51) I see

sorry for noise, that was FreeBSD-specific leftover from an old port that caused this.
No problem, in fact.


---

Comment by jpflori created at 2017-04-03 11:40:02

Can we try to merge it in 8.0?
The giac issue is solved in a giac ticket isn't it?


---

Comment by tmonteil created at 2017-04-03 16:16:10

Replying to [comment:26 jpflori]:
> Can we try to merge it in 8.0?

Sure.

> The giac issue is solved in a giac ticket isn't it?

Well, the issue is _avoided_ in #22101 (which disables png support), but i think we should not consider this as a permanent solution, and provide a full-featured giac (which can draw pictures).


---

Comment by jpflori created at 2017-04-25 17:45:48

I think we can live with a giac without png support.
We already live with a completely borken giac outside x86_64...


---

Comment by jpflori created at 2017-04-28 15:06:40

And note that giac build system should be fixed to use proper -lpng1x rather than -lpng.
Not libpng...


---

Comment by jpflori created at 2017-05-17 09:08:58

From my point of view it is enough to rebase this ticket, I'll do it.


---

Comment by jpflori created at 2017-05-17 12:16:50

Changing status from needs_work to needs_review.


---

Comment by jpflori created at 2017-05-17 12:16:50

New commits:


---

Comment by tscrim created at 2017-05-21 02:52:52

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-05-21 02:52:52

Built for me. Back to the buildbots.


---

Comment by vbraun created at 2017-05-21 21:51:57

Resolution: fixed
