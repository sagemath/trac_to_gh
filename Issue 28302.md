# Issue 28302: Optimization for small permutation groups

Issue created by migration from https://trac.sagemath.org/ticket/28539

Original creator: vdelecroix

Original creation time: 2019-09-26 11:16:12

CC:  tscrim chapoton sbrandhorst

This ticket stands for micro optimizations for small permutation groups. The rationale is to handle the situation where we have a billion of combinatorial objects and need to run through their automorphism groups most of which are trivial or let say, <= 100 elements. An even more concrete application is given by the [admcycles MR 14](https://gitlab.com/jo314schmitt/admcycles/merge_requests/14) where there is a tentative to use graph automorphisms from Sage instead of an handmade implementation. It turns out that this is slowing down a lot! For example

```
sage: from admcycles.admcycles import Hyperell
sage: %time H = Hyperell(3)
```

takes 13.5 sec on master but with MR 14 takes 17.4 sec.

The profiling points to
- the constructor `__init__` of `PermutationGroupElement`
- the `.subgroup` method of `PermutationGroupElement`
- the product `p1 * p2` when `p1` is a symmetric group element and `p2` is a permutation group on the same domain
- `__iter__` for `PermutationGroupElement` (that currently involves computing a strong generating scheme)


---

Comment by vdelecroix created at 2019-09-26 11:19:00

New commits:


---

Comment by git created at 2019-09-30 08:17:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2019-09-30 08:19:25

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-09-30 12:06:16

hmm some py2/py3 issue I guess.


---

Comment by vdelecroix created at 2019-09-30 12:06:16

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-09-30 14:42:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-09-30 15:25:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2019-09-30 15:26:47

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-10-01 06:55:23

Still failing. And proliferation of #py2 and # py3 does not seem to be a good solution.


---

Comment by tscrim created at 2019-10-02 01:42:28

I agree with Frédéric that adding a whole bunch of `# py2` and `# py3` tags is not a good solution. I am assuming this comes from this change:

```diff
-        return self.iteration(algorithm="SGS")
+        if len(self._gens) == 1:
+            return self._iteration_monogen()
+        elif self.cardinality() <= 100:
+            return self.iteration(algorithm="BFS")
+        else:
+            return self.iteration(algorithm="SGS")
```

and the `BFS` option calls `RecursivelyEnumeratedSet`, which has consistency problems on Python3 IIRC. So we have to solve that bigger problem first.

I have some other comments:

I don't see the point of going to cycles just to convert back here:

```
return grp.element_class(self.to_cycles(singletons=False), grp, check=False)
```

I know this was already done, but it seems useless as the `PermutationGroupElement` stores things internally as a list in essentially the same way.

I would probably Cythonize `from_cycles`.

Is there a reason why `_set_identity` and `_set_list_images` are `cpdef` and not just `cdef` (which is faster when being called by C code)? By being `cpdef`, they also need doctests.


---

Comment by tscrim created at 2019-10-02 01:42:28

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2019-10-02 03:26:02

Thanks for the feedback. I will cut the ticket and start by optimizing the constructor. Optimizing the iterator will be postponed to another one.


---

Comment by vdelecroix created at 2019-10-25 01:00:24

Changing type from enhancement to task.


---

Comment by @mwageringel created at 2019-10-29 23:44:58

See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.


---

Comment by vdelecroix created at 2019-10-31 15:13:38

Replying to [comment:14 gh-mwageringel]:
> See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.

I don't think that the enumeration order is relevant here. This is convenient for doctests and only shows the weakness of them.


---

Comment by embray created at 2020-01-06 14:10:03

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by slelievre created at 2020-08-31 20:34:29

Changing status from needs_info to needs_work.


---

Comment by slelievre created at 2020-08-31 20:34:29

Supporting Python 2 is no longer needed now.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
