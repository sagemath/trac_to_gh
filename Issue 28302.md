# Issue 28302: Optimization for small permutation groups

archive/issues_028302.json:
```json
{
    "body": "CC:  tscrim chapoton sbrandhorst\n\nThis ticket stands for micro optimizations for small permutation groups. The rationale is to handle the situation where we have a billion of combinatorial objects and need to run through their automorphism groups most of which are trivial or let say, <= 100 elements. An even more concrete application is given by the [admcycles MR 14](https://gitlab.com/jo314schmitt/admcycles/merge_requests/14) where there is a tentative to use graph automorphisms from Sage instead of an handmade implementation. It turns out that this is slowing down a lot! For example\n\n```\nsage: from admcycles.admcycles import Hyperell\nsage: %time H = Hyperell(3)\n```\n\ntakes 13.5 sec on master but with MR 14 takes 17.4 sec.\n\nThe profiling points to\n- the constructor `__init__` of `PermutationGroupElement`\n- the `.subgroup` method of `PermutationGroupElement`\n- the product `p1 * p2` when `p1` is a symmetric group element and `p2` is a permutation group on the same domain\n- `__iter__` for `PermutationGroupElement` (that currently involves computing a strong generating scheme)\n\nIssue created by migration from https://trac.sagemath.org/ticket/28539\n\n",
    "created_at": "2019-09-26T11:16:12Z",
    "labels": [
        "combinatorics",
        "major",
        "enhancement"
    ],
    "title": "Optimization for small permutation groups",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28302",
    "user": "vdelecroix"
}
```
CC:  tscrim chapoton sbrandhorst

This ticket stands for micro optimizations for small permutation groups. The rationale is to handle the situation where we have a billion of combinatorial objects and need to run through their automorphism groups most of which are trivial or let say, <= 100 elements. An even more concrete application is given by the [admcycles MR 14](https://gitlab.com/jo314schmitt/admcycles/merge_requests/14) where there is a tentative to use graph automorphisms from Sage instead of an handmade implementation. It turns out that this is slowing down a lot! For example

```
sage: from admcycles.admcycles import Hyperell
sage: %time H = Hyperell(3)
```

takes 13.5 sec on master but with MR 14 takes 17.4 sec.

The profiling points to
- the constructor `__init__` of `PermutationGroupElement`
- the `.subgroup` method of `PermutationGroupElement`
- the product `p1 * p2` when `p1` is a symmetric group element and `p2` is a permutation group on the same domain
- `__iter__` for `PermutationGroupElement` (that currently involves computing a strong generating scheme)

Issue created by migration from https://trac.sagemath.org/ticket/28539





---

archive/issue_comments_399716.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-09-26T11:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399716",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_399717.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-30T08:17:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399717",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399718.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-09-30T08:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399718",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_399719.json:
```json
{
    "body": "hmm some py2/py3 issue I guess.",
    "created_at": "2019-09-30T12:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399719",
    "user": "vdelecroix"
}
```

hmm some py2/py3 issue I guess.



---

archive/issue_comments_399720.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-09-30T12:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399720",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_399721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-30T14:42:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399721",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_399722.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-30T15:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399722",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_399723.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-09-30T15:26:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399723",
    "user": "vdelecroix"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_399724.json:
```json
{
    "body": "Still failing. And proliferation of #py2 and # py3 does not seem to be a good solution.",
    "created_at": "2019-10-01T06:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399724",
    "user": "chapoton"
}
```

Still failing. And proliferation of #py2 and # py3 does not seem to be a good solution.



---

archive/issue_comments_399725.json:
```json
{
    "body": "I agree with Fr\u00e9d\u00e9ric that adding a whole bunch of `# py2` and `# py3` tags is not a good solution. I am assuming this comes from this change:\n\n```diff\n-        return self.iteration(algorithm=\"SGS\")\n+        if len(self._gens) == 1:\n+            return self._iteration_monogen()\n+        elif self.cardinality() <= 100:\n+            return self.iteration(algorithm=\"BFS\")\n+        else:\n+            return self.iteration(algorithm=\"SGS\")\n```\n\nand the `BFS` option calls `RecursivelyEnumeratedSet`, which has consistency problems on Python3 IIRC. So we have to solve that bigger problem first.\n\nI have some other comments:\n\nI don't see the point of going to cycles just to convert back here:\n\n```\nreturn grp.element_class(self.to_cycles(singletons=False), grp, check=False)\n```\n\nI know this was already done, but it seems useless as the `PermutationGroupElement` stores things internally as a list in essentially the same way.\n\nI would probably Cythonize `from_cycles`.\n\nIs there a reason why `_set_identity` and `_set_list_images` are `cpdef` and not just `cdef` (which is faster when being called by C code)? By being `cpdef`, they also need doctests.",
    "created_at": "2019-10-02T01:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399725",
    "user": "tscrim"
}
```

I agree with Frédéric that adding a whole bunch of `# py2` and `# py3` tags is not a good solution. I am assuming this comes from this change:

```diff
-        return self.iteration(algorithm="SGS")
+        if len(self._gens) == 1:
+            return self._iteration_monogen()
+        elif self.cardinality() <= 100:
+            return self.iteration(algorithm="BFS")
+        else:
+            return self.iteration(algorithm="SGS")
```

and the `BFS` option calls `RecursivelyEnumeratedSet`, which has consistency problems on Python3 IIRC. So we have to solve that bigger problem first.

I have some other comments:

I don't see the point of going to cycles just to convert back here:

```
return grp.element_class(self.to_cycles(singletons=False), grp, check=False)
```

I know this was already done, but it seems useless as the `PermutationGroupElement` stores things internally as a list in essentially the same way.

I would probably Cythonize `from_cycles`.

Is there a reason why `_set_identity` and `_set_list_images` are `cpdef` and not just `cdef` (which is faster when being called by C code)? By being `cpdef`, they also need doctests.



---

archive/issue_comments_399726.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-10-02T01:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399726",
    "user": "tscrim"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_399727.json:
```json
{
    "body": "Thanks for the feedback. I will cut the ticket and start by optimizing the constructor. Optimizing the iterator will be postponed to another one.",
    "created_at": "2019-10-02T03:26:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399727",
    "user": "vdelecroix"
}
```

Thanks for the feedback. I will cut the ticket and start by optimizing the constructor. Optimizing the iterator will be postponed to another one.



---

archive/issue_comments_399728.json:
```json
{
    "body": "Changing type from enhancement to task.",
    "created_at": "2019-10-25T01:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399728",
    "user": "vdelecroix"
}
```

Changing type from enhancement to task.



---

archive/issue_comments_399729.json:
```json
{
    "body": "See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.",
    "created_at": "2019-10-29T23:44:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399729",
    "user": "@mwageringel"
}
```

See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.



---

archive/issue_comments_399730.json:
```json
{
    "body": "Replying to [comment:14 gh-mwageringel]:\n> See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.\n\nI don't think that the enumeration order is relevant here. This is convenient for doctests and only shows the weakness of them.",
    "created_at": "2019-10-31T15:13:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399730",
    "user": "vdelecroix"
}
```

Replying to [comment:14 gh-mwageringel]:
> See also #28674 which should eventually solve the consistency problems of `RecursivelyEnumeratedSet`.

I don't think that the enumeration order is relevant here. This is convenient for doctests and only shows the weakness of them.



---

archive/issue_comments_399731.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399731",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_399732.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399732",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_399733.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2020-08-31T20:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399733",
    "user": "slelievre"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_399734.json:
```json
{
    "body": "Supporting Python 2 is no longer needed now.",
    "created_at": "2020-08-31T20:34:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399734",
    "user": "slelievre"
}
```

Supporting Python 2 is no longer needed now.



---

archive/issue_comments_399735.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399735",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_399736.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28302",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28302#issuecomment-399736",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.
