# Issue 28412: py3: flush output from FLINT error message

archive/issues_028412.json:
```json
{
    "body": "CC:  chapoton dimpase egourgoulhon\n\nThis is a second fix for the problem reported at #28334, the doctest failure in `rings/polynomial/polynomial_rational_flint.pyx`. This fix does not rely on patching FLINT.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28649\n\n",
    "created_at": "2019-10-24T18:23:52Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "py3: flush output from FLINT error message",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28412",
    "user": "jhpalmieri"
}
```
CC:  chapoton dimpase egourgoulhon

This is a second fix for the problem reported at #28334, the doctest failure in `rings/polynomial/polynomial_rational_flint.pyx`. This fix does not rely on patching FLINT.

Issue created by migration from https://trac.sagemath.org/ticket/28649





---

archive/issue_comments_401289.json:
```json
{
    "body": "As I said at #28334, the fix there can be kept independently of the change here, and it should be kept, since the patch to FLINT was accepted upstream. The one here is to handle the case when using non-patched versions of FLINT.",
    "created_at": "2019-10-24T18:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401289",
    "user": "jhpalmieri"
}
```

As I said at #28334, the fix there can be kept independently of the change here, and it should be kept, since the patch to FLINT was accepted upstream. The one here is to handle the case when using non-patched versions of FLINT.



---

archive/issue_comments_401290.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-10-24T18:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401290",
    "user": "jhpalmieri"
}
```

New commits:



---

archive/issue_comments_401291.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-24T18:27:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401291",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_401292.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-24T18:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401292",
    "user": "dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401293.json:
```json
{
    "body": "good, thanks. Takes extra 0.5 sec on my laptop, but OK...",
    "created_at": "2019-10-24T18:32:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401293",
    "user": "dimpase"
}
```

good, thanks. Takes extra 0.5 sec on my laptop, but OK...



---

archive/issue_comments_401294.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2019-10-24T19:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401294",
    "user": "nbruin"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_401295.json:
```json
{
    "body": "It may be possible to do this cross-platform in a relatively convenient way with ctypes anyway:\n\n```\nimport ctypes\nlibc = ctypes.CDLL(ctypes.util.find_library(\"c\"))\nlibc.fflush(0r)\n```\n\nseems to work, and looking at the source, it seems \"find_library\" does make an effort to be cross-platform. It's probably worth considering if this will do, since it's a lot lighter weight than running cython.",
    "created_at": "2019-10-24T19:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401295",
    "user": "nbruin"
}
```

It may be possible to do this cross-platform in a relatively convenient way with ctypes anyway:

```
import ctypes
libc = ctypes.CDLL(ctypes.util.find_library("c"))
libc.fflush(0r)
```

seems to work, and looking at the source, it seems "find_library" does make an effort to be cross-platform. It's probably worth considering if this will do, since it's a lot lighter weight than running cython.



---

archive/issue_comments_401296.json:
```json
{
    "body": "we can just add this flush function somewher into sagelib",
    "created_at": "2019-10-24T19:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401296",
    "user": "dimpase"
}
```

we can just add this flush function somewher into sagelib



---

archive/issue_comments_401297.json:
```json
{
    "body": "Using Sage's own `misc.compat.find_library` would probably be better:\n\n```diff\ndiff --git a/src/sage/rings/polynomial/polynomial_rational_flint.pyx b/src/sage/rings/polynomial/polynomial_rational_flint.pyx\nindex 73d1992656..aeb5a824e3 100644\n--- a/src/sage/rings/polynomial/polynomial_rational_flint.pyx\n+++ b/src/sage/rings/polynomial/polynomial_rational_flint.pyx\n@@ -1176,6 +1176,15 @@ cdef class Polynomial_rational_flint(Polynomial):\n             ...\n             RuntimeError: FLINT exception\n \n+        Flush the output buffer to get rid of stray output -- see\n+        :trac:`28649`::\n+\n+            sage: from sage.misc.compat import find_library\n+            sage: import ctypes\n+            sage: libc = ctypes.CDLL(find_library(\"c\"))\n+            sage: libc.fflush(0r)\n+            ...\n+\n         Test fractional powers (:trac:`20086`)::\n \n             sage: P.<R> = QQ[]\n```\n",
    "created_at": "2019-10-24T20:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401297",
    "user": "jhpalmieri"
}
```

Using Sage's own `misc.compat.find_library` would probably be better:

```diff
diff --git a/src/sage/rings/polynomial/polynomial_rational_flint.pyx b/src/sage/rings/polynomial/polynomial_rational_flint.pyx
index 73d1992656..aeb5a824e3 100644
--- a/src/sage/rings/polynomial/polynomial_rational_flint.pyx
+++ b/src/sage/rings/polynomial/polynomial_rational_flint.pyx
@@ -1176,6 +1176,15 @@ cdef class Polynomial_rational_flint(Polynomial):
             ...
             RuntimeError: FLINT exception
 
+        Flush the output buffer to get rid of stray output -- see
+        :trac:`28649`::
+
+            sage: from sage.misc.compat import find_library
+            sage: import ctypes
+            sage: libc = ctypes.CDLL(find_library("c"))
+            sage: libc.fflush(0r)
+            ...
+
         Test fractional powers (:trac:`20086`)::
 
             sage: P.<R> = QQ[]
```




---

archive/issue_comments_401298.json:
```json
{
    "body": "Both approaches work for me on OS X and on my Ubuntu virtual machine. Should they both work on Cygwin?",
    "created_at": "2019-10-24T20:12:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401298",
    "user": "jhpalmieri"
}
```

Both approaches work for me on OS X and on my Ubuntu virtual machine. Should they both work on Cygwin?



---

archive/issue_comments_401299.json:
```json
{
    "body": "It looks like\n\n```\nlibc = ctypes.CDLL(None)\n```\n\nworks too. I have no idea why. (see https://eli.thegreenplace.net/2015/redirecting-all-kinds-of-stdout-in-python/)",
    "created_at": "2019-10-24T20:54:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401299",
    "user": "nbruin"
}
```

It looks like

```
libc = ctypes.CDLL(None)
```

works too. I have no idea why. (see https://eli.thegreenplace.net/2015/redirecting-all-kinds-of-stdout-in-python/)



---

archive/issue_comments_401300.json:
```json
{
    "body": "Does https://stackoverflow.com/questions/49878901/how-does-ctypes-cdll-loadlibrarynone-work help? I'm worried about this on Cygwin, though.",
    "created_at": "2019-10-24T21:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401300",
    "user": "jhpalmieri"
}
```

Does https://stackoverflow.com/questions/49878901/how-does-ctypes-cdll-loadlibrarynone-work help? I'm worried about this on Cygwin, though.



---

archive/issue_comments_401301.json:
```json
{
    "body": "Any opinions on which approach to take? I see three options:\n\n1. Keep the current branch. Slow, requires a functioning Cython compiler. (Is that guaranteed with binary releases?)\n\n2. Add the `cyflush` function to the Sage library so that it is precompiled.\n\n3. Take the `ctypes` approach from comment:17, with `libc = ctypes.CDLL(None)`.\n\nAny opinions? I would like to get a solution to this problem merged, because there are people out there using non-Sage versions of FLINT.",
    "created_at": "2019-10-29T04:52:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401301",
    "user": "jhpalmieri"
}
```

Any opinions on which approach to take? I see three options:

1. Keep the current branch. Slow, requires a functioning Cython compiler. (Is that guaranteed with binary releases?)

2. Add the `cyflush` function to the Sage library so that it is precompiled.

3. Take the `ctypes` approach from comment:17, with `libc = ctypes.CDLL(None)`.

Any opinions? I would like to get a solution to this problem merged, because there are people out there using non-Sage versions of FLINT.



---

archive/issue_comments_401302.json:
```json
{
    "body": "I think 2 is the easiest. I don't see any benefits of using `ctypes` here, whatsoever.",
    "created_at": "2019-10-29T07:08:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401302",
    "user": "dimpase"
}
```

I think 2 is the easiest. I don't see any benefits of using `ctypes` here, whatsoever.



---

archive/issue_comments_401303.json:
```json
{
    "body": "Any suggestions for where that function should go? `polynomial_rational_flint.pyx` is one option, since it will be used there, but that's not a particularly natural place for anyone to find it later.",
    "created_at": "2019-10-29T16:38:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401303",
    "user": "jhpalmieri"
}
```

Any suggestions for where that function should go? `polynomial_rational_flint.pyx` is one option, since it will be used there, but that's not a particularly natural place for anyone to find it later.



---

archive/issue_comments_401304.json:
```json
{
    "body": "src/sage/misc/pager.py ?",
    "created_at": "2019-10-29T16:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401304",
    "user": "chapoton"
}
```

src/sage/misc/pager.py ?



---

archive/issue_comments_401305.json:
```json
{
    "body": "or maybe misc/sage_ostools.pyx",
    "created_at": "2019-10-29T16:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401305",
    "user": "chapoton"
}
```

or maybe misc/sage_ostools.pyx



---

archive/issue_comments_401306.json:
```json
{
    "body": "I'm leaning toward either misc/misc_c.pyx or a new file cpython/cyflush.pyx.",
    "created_at": "2019-10-29T16:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401306",
    "user": "jhpalmieri"
}
```

I'm leaning toward either misc/misc_c.pyx or a new file cpython/cyflush.pyx.



---

archive/issue_comments_401307.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-10-29T18:49:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401307",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_401308.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-10-29T18:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401308",
    "user": "jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_401309.json:
```json
{
    "body": "Let's try this.",
    "created_at": "2019-10-29T18:50:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401309",
    "user": "jhpalmieri"
}
```

Let's try this.



---

archive/issue_comments_401310.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-10-29T18:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401310",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_401311.json:
```json
{
    "body": "the EXAMPLES:: content in cyflush is overindented.",
    "created_at": "2019-10-30T13:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401311",
    "user": "chapoton"
}
```

the EXAMPLES:: content in cyflush is overindented.



---

archive/issue_comments_401312.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-10-30T17:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401312",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_401313.json:
```json
{
    "body": "Replying to [comment:20 chapoton]:\n> the EXAMPLES:: content in cyflush is overindented.\n\nOops, sorry. Fixed.",
    "created_at": "2019-10-30T17:24:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401313",
    "user": "jhpalmieri"
}
```

Replying to [comment:20 chapoton]:
> the EXAMPLES:: content in cyflush is overindented.

Oops, sorry. Fixed.



---

archive/issue_comments_401314.json:
```json
{
    "body": "ok, good to go",
    "created_at": "2019-10-30T20:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401314",
    "user": "chapoton"
}
```

ok, good to go



---

archive/issue_comments_401315.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-30T20:13:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401315",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_401316.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-31T22:40:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28412",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28412#issuecomment-401316",
    "user": "vbraun"
}
```

Resolution: fixed
