# Issue 28412: py3: flush output from FLINT error message

Issue created by migration from https://trac.sagemath.org/ticket/28649

Original creator: jhpalmieri

Original creation time: 2019-10-24 18:23:52

CC:  chapoton dimpase egourgoulhon

This is a second fix for the problem reported at #28334, the doctest failure in `rings/polynomial/polynomial_rational_flint.pyx`. This fix does not rely on patching FLINT.


---

Comment by jhpalmieri created at 2019-10-24 18:26:04

As I said at #28334, the fix there can be kept independently of the change here, and it should be kept, since the patch to FLINT was accepted upstream. The one here is to handle the case when using non-patched versions of FLINT.


---

Comment by jhpalmieri created at 2019-10-24 18:27:29

New commits:


---

Comment by jhpalmieri created at 2019-10-24 18:27:29

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-10-24 18:32:49

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-10-24 18:32:49

good, thanks. Takes extra 0.5 sec on my laptop, but OK...


---

Comment by nbruin created at 2019-10-24 19:32:32

Changing status from positive_review to needs_info.


---

Comment by nbruin created at 2019-10-24 19:32:32

It may be possible to do this cross-platform in a relatively convenient way with ctypes anyway:

```
import ctypes
libc = ctypes.CDLL(ctypes.util.find_library("c"))
libc.fflush(0r)
```

seems to work, and looking at the source, it seems "find_library" does make an effort to be cross-platform. It's probably worth considering if this will do, since it's a lot lighter weight than running cython.


---

Comment by dimpase created at 2019-10-24 19:34:49

we can just add this flush function somewher into sagelib


---

Comment by jhpalmieri created at 2019-10-24 20:07:31

Using Sage's own `misc.compat.find_library` would probably be better:

```diff
diff --git a/src/sage/rings/polynomial/polynomial_rational_flint.pyx b/src/sage/rings/polynomial/polynomial_rational_flint.pyx
index 73d1992656..aeb5a824e3 100644
--- a/src/sage/rings/polynomial/polynomial_rational_flint.pyx
+++ b/src/sage/rings/polynomial/polynomial_rational_flint.pyx
@@ -1176,6 +1176,15 @@ cdef class Polynomial_rational_flint(Polynomial):
             ...
             RuntimeError: FLINT exception
 
+        Flush the output buffer to get rid of stray output -- see
+        :trac:`28649`::
+
+            sage: from sage.misc.compat import find_library
+            sage: import ctypes
+            sage: libc = ctypes.CDLL(find_library("c"))
+            sage: libc.fflush(0r)
+            ...
+
         Test fractional powers (:trac:`20086`)::
 
             sage: P.<R> = QQ[]
```



---

Comment by jhpalmieri created at 2019-10-24 20:12:33

Both approaches work for me on OS X and on my Ubuntu virtual machine. Should they both work on Cygwin?


---

Comment by nbruin created at 2019-10-24 20:54:50

It looks like

```
libc = ctypes.CDLL(None)
```

works too. I have no idea why. (see https://eli.thegreenplace.net/2015/redirecting-all-kinds-of-stdout-in-python/)


---

Comment by jhpalmieri created at 2019-10-24 21:06:37

Does https://stackoverflow.com/questions/49878901/how-does-ctypes-cdll-loadlibrarynone-work help? I'm worried about this on Cygwin, though.


---

Comment by jhpalmieri created at 2019-10-29 04:52:51

Any opinions on which approach to take? I see three options:

1. Keep the current branch. Slow, requires a functioning Cython compiler. (Is that guaranteed with binary releases?)

2. Add the `cyflush` function to the Sage library so that it is precompiled.

3. Take the `ctypes` approach from comment:17, with `libc = ctypes.CDLL(None)`.

Any opinions? I would like to get a solution to this problem merged, because there are people out there using non-Sage versions of FLINT.


---

Comment by dimpase created at 2019-10-29 07:08:06

I think 2 is the easiest. I don't see any benefits of using `ctypes` here, whatsoever.


---

Comment by jhpalmieri created at 2019-10-29 16:38:30

Any suggestions for where that function should go? `polynomial_rational_flint.pyx` is one option, since it will be used there, but that's not a particularly natural place for anyone to find it later.


---

Comment by chapoton created at 2019-10-29 16:39:35

src/sage/misc/pager.py ?


---

Comment by chapoton created at 2019-10-29 16:46:21

or maybe misc/sage_ostools.pyx


---

Comment by jhpalmieri created at 2019-10-29 16:53:46

I'm leaning toward either misc/misc_c.pyx or a new file cpython/cyflush.pyx.


---

Comment by git created at 2019-10-29 18:49:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-10-29 18:50:09

Changing status from needs_info to needs_review.


---

Comment by jhpalmieri created at 2019-10-29 18:50:09

Let's try this.


---

Comment by git created at 2019-10-29 18:50:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-10-30 13:37:24

the EXAMPLES:: content in cyflush is overindented.


---

Comment by git created at 2019-10-30 17:23:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2019-10-30 17:24:20

Replying to [comment:20 chapoton]:
> the EXAMPLES:: content in cyflush is overindented.

Oops, sorry. Fixed.


---

Comment by chapoton created at 2019-10-30 20:13:09

ok, good to go


---

Comment by chapoton created at 2019-10-30 20:13:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-10-31 22:40:47

Resolution: fixed
