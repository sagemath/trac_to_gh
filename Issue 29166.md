# Issue 29166: ci-cygwin.yml: Multi-stage build

Issue created by migration from https://trac.sagemath.org/ticket/29403

Original creator: mkoeppe

Original creation time: 2020-03-25 01:55:07

CC:  dimpase embray slelievre jpflori tscrim vbraun kcrisman

The [GitHub](GitHub) workflow for cygwin does not fit into the 6-hour time limit.
We do a multi-stage build, saving and loading `local/` to/from build artifacts.



---

Comment by git created at 2020-03-25 03:13:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-26 19:50:32

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-26 19:52:29

Sample run https://github.com/mkoeppe/sage/actions/runs/63708828


---

Comment by mkoeppe created at 2020-03-29 03:03:39

Something is still triggering rebuilds of targets that have been built in a previous stage.


---

Comment by dimpase created at 2020-03-29 03:14:59

I'd suspect it's the `toolchain` crud.


---

Comment by mkoeppe created at 2020-03-29 04:29:35

I'm running one test with MAKE="make --debug=verbose" to see what's happening there


---

Comment by git created at 2020-03-30 22:38:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-31 16:03:26

This works pretty well now.


---

Comment by git created at 2020-04-04 14:53:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-05 02:43:38

New failure mode: https://github.com/mkoeppe/sage/runs/560884908

```
"/cygdrive/d/a/sage/sage/local/lib/python3.7/subprocess.py", line 775, in __init__
  [backports_abc-0.5]       restore_signals, start_new_session)
  [backports_abc-0.5]     File "/cygdrive/d/a/sage/sage/local/lib/python3.7/subprocess.py", line 1453, in _execute_child
  [backports_abc-0.5]       restore_signals, start_new_session, preexec_fn)
  [backports_abc-0.5]   BlockingIOError: [Errno 11] Resource temporarily unavailable
  [backports_abc-0.5]   Cleaning up...
```



---

Comment by mkoeppe created at 2020-04-05 02:45:28

https://github.com/mkoeppe/sage/runs/560884917

```
Installing backports_abc-0.5
      0 [main] python3.7 16471 child_info_fork::abort: address space needed by 'cyglzma-5.dll' (0x400000) is already occupied
Installing package backports_abc using pip3
      0 [main] python3.7 16554 child_info_fork::abort: address space needed by 'cyglzma-5.dll' (0x400000) is already occupied
Ignoring indexes: https://pypi.org/simple
```



---

Comment by mkoeppe created at 2020-04-05 02:47:31

https://github.com/mkoeppe/sage/runs/560884917

```
 [r-3.6.2.p0]   gcc -I../../src/extra -I../../src/extra/xdr -I. -I../../src/include -I../../src/include -I/cygdrive/d/a/sage/sage/local/include  -I../../src/nmath -DHAVE_CONFIG_H   -fopenmp   -g -O2  -fPIC  -c version.c -o version.o
  [r-3.6.2.p0]   sysutils.c:554:10: fatal error: iconv.h: No such file or directory
  [r-3.6.2.p0]     554 | #include <iconv.h>
  [r-3.6.2.p0]         |          ^~~~~~~~~
  [r-3.6.2.p0]   compilation terminated.
```



---

Comment by dimpase created at 2020-04-05 02:53:02

Replying to [comment:15 mkoeppe]:
> New failure mode: https://github.com/mkoeppe/sage/runs/560884908
> {{{
> "/cygdrive/d/a/sage/sage/local/lib/python3.7/subprocess.py", line 775, in __init__
>   [backports_abc-0.5]       restore_signals, start_new_session)
>   [backports_abc-0.5]     File "/cygdrive/d/a/sage/sage/local/lib/python3.7/subprocess.py", line 1453, in _execute_child
>   [backports_abc-0.5]       restore_signals, start_new_session, preexec_fn)
>   [backports_abc-0.5]   BlockingIOError: [Errno 11] Resource temporarily unavailable
>   [backports_abc-0.5]   Cleaning up...
> }}}

welcome to Cygwin rebase Hell. 
One might need to call one of these `src/bin/sage-rebase*` (sacrificing a black chicken might be a pre-req).


---

Comment by git created at 2020-04-08 14:41:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-04-09 16:37:48

In https://github.com/mkoeppe/sage/runs/572730280 (cygwin-stage-ii-a (minimal)), despite rebasing in the "Extract sage-local artifact" step, I am still getting `_fork::abort: address space needed by 'cyglzma-5.dll' (0x400000) is already occupied` when building packages


---

Comment by mkoeppe created at 2020-04-09 16:51:26

#29486 cygwin-standard: rpy2 fails to build


---

Comment by mkoeppe created at 2020-04-09 16:55:56

cygwin-stage-ii-b (minimal) times out -  https://github.com/mkoeppe/sage/runs/572730298 - may need to rebalance stages


---

Comment by mkoeppe created at 2020-04-09 17:00:05

In https://github.com/mkoeppe/sage/runs/572730287 (cygwin-stage-ii-a (standard)): matplotlib fails to build - numpy-related 

```
     File "/cygdrive/d/a/sage/sage/local/lib/python3.7/site-packages/numpy/matrixlib/__init__.py", line 6, in <module>
        from .defmatrix import *
      File "/cygdrive/d/a/sage/sage/local/lib/python3.7/site-packages/numpy/matrixlib/defmatrix.py", line 13, in <module>
        from numpy.linalg import matrix_power
      File "/cygdrive/d/a/sage/sage/local/lib/python3.7/site-packages/numpy/linalg/__init__.py", line 51, in <module>
        from .linalg import *
      File "/cygdrive/d/a/sage/sage/local/lib/python3.7/site-packages/numpy/linalg/linalg.py", line 35, in <module>
        from numpy.linalg import lapack_lite, _umath_linalg
    ImportError: No such file or directory
```



---

Comment by mkoeppe created at 2020-04-12 15:44:21

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-12 16:39:34

Anyone out there who is interested in cygwin?


---

Comment by git created at 2020-04-13 05:40:05

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-04-13 05:40:32

Merged in #29417 to resolve merge conflicts


---

Comment by tscrim created at 2020-04-15 22:52:22

As far as I can tell, this is okay, but I am not enough of an expert to say definitively. I would appreciate a second opinion from someone who is more well-versed in the Sage build system to double-check.


---

Comment by mkoeppe created at 2020-04-15 23:01:11

The issue of comment 21 is not resolved yet


---

Comment by mkoeppe created at 2020-04-17 03:38:55

Ancient info on rebasing: https://groups.google.com/d/msg/sage-windows/ygK1kJm9p9w/x0ckGqo2ej4J


---

Comment by dimpase created at 2020-04-17 05:24:26

well, yes, it was not clear whether rebasing must be done from outside of Cygwin shell, or not.

I gather that we rebase within Cygwin.

By the way, it would be interesting to do testing  in Windows WSL...


---

Comment by mkoeppe created at 2020-04-17 06:31:28

I'll give it another shot, doing exactly what is also done in sage-spkg


---

Comment by git created at 2020-04-17 06:52:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-04-17 07:27:03

with these multi-stage builds, where *.so get built at one place, and moved then somewhere esle, it could be that more rebasing is needed. In particular, I recall seeing and fixing rebase locations for Python modules being built.
(Basically it was the issue that totally broke building Sage on Cygwin32, simply due to insufficient address space).


---

Comment by mkoeppe created at 2020-04-17 07:30:11

Testing at https://github.com/mkoeppe/sage/actions/runs/80516745


---

Comment by mkoeppe created at 2020-04-17 07:31:10

Yes, I'm rebasing after unpacking `local` from the previous stages.


---

Comment by mkoeppe created at 2020-04-17 21:19:22

I think it's working now, and we can see the real build errors again in `cygwin-standard`: matplotlib, rpy2, scipy (likely BLAS-related) https://github.com/mkoeppe/sage/runs/596536457


---

Comment by mkoeppe created at 2020-04-17 21:20:01

Changing component from porting to porting: Cygwin.


---

Comment by git created at 2020-04-17 23:45:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-04-18 04:14:09

testing on https://github.com/dimpase/sage/actions/runs/81294070


---

Comment by mkoeppe created at 2020-04-18 04:35:37

I cannot reproduce the matplotlib build error locally - even when I download and unpack stage-i-a and stage-i-b (standard) and configure against that.


---

Comment by git created at 2020-04-18 05:37:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-18 05:40:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-18 07:08:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-04-18 09:37:09

how does one need to modify ~/.github/ to make GH Actions only run cygwin tests?


---

Comment by mkoeppe created at 2020-04-18 15:57:49

Replying to [comment:49 dimpase]:
> how does one need to modify ~/.github/ to make GH Actions only run cygwin tests?

Just delete the file tox.yml


---

Comment by git created at 2020-04-18 16:36:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-19 03:30:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-04-19 23:47:28

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-04-20 00:30:39

Thanks!


---

Comment by vbraun created at 2020-04-23 22:32:47

Resolution: fixed
