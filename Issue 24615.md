# Issue 24615: Fix bytes/str in sage.data_structures.bitset

archive/issues_024615.json:
```json
{
    "body": "CC:  embray\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/24852\n\n",
    "created_at": "2018-02-27T09:33:53Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "Fix bytes/str in sage.data_structures.bitset",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24615",
    "user": "jdemeyer"
}
```
CC:  embray



Issue created by migration from https://trac.sagemath.org/ticket/24852





---

archive/issue_comments_345300.json:
```json
{
    "body": "It looks like `bitset_from_str` is meant to be a low-level C function. Wouldn't it be better to fix *calls* to `bitset_from_str` instead?\n----\nNew commits:",
    "created_at": "2018-02-27T09:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345300",
    "user": "jdemeyer"
}
```

It looks like `bitset_from_str` is meant to be a low-level C function. Wouldn't it be better to fix *calls* to `bitset_from_str` instead?
----
New commits:



---

archive/issue_comments_345301.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-02-27T09:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345301",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_345302.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-27T09:36:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345302",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_345303.json:
```json
{
    "body": "Yes, I see your point. Let me see how many of those there actually are...",
    "created_at": "2018-02-27T09:38:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345303",
    "user": "embray"
}
```

Yes, I see your point. Let me see how many of those there actually are...



---

archive/issue_comments_345304.json:
```json
{
    "body": "No, it's only used in bitset.pyx, and the way I use `str_to_bytes` here makes sense.",
    "created_at": "2018-02-27T09:42:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345304",
    "user": "embray"
}
```

No, it's only used in bitset.pyx, and the way I use `str_to_bytes` here makes sense.



---

archive/issue_comments_345305.json:
```json
{
    "body": "There are one or two cases in bitset.pyx where it's explicitly being used on bytes (e.g. in `__setstate__`, and other cases where it's being used on `str` (in the 2/3-compatibility sense) where using `str_to_bytes` in `bitset_from_str` makes sense.\n\nI think what might make sense, for symmetry's sake, might be to rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`) and then make `bitset_from_str` a wrapper around that which uses `str_to_bytes`.",
    "created_at": "2018-02-27T09:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345305",
    "user": "embray"
}
```

There are one or two cases in bitset.pyx where it's explicitly being used on bytes (e.g. in `__setstate__`, and other cases where it's being used on `str` (in the 2/3-compatibility sense) where using `str_to_bytes` in `bitset_from_str` makes sense.

I think what might make sense, for symmetry's sake, might be to rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`) and then make `bitset_from_str` a wrapper around that which uses `str_to_bytes`.



---

archive/issue_comments_345306.json:
```json
{
    "body": "On second thought, `__setstate__` is fine since `__getstate__` also returns `str`.  Though I don't know why it would dump/load as strings when it could just use binary.",
    "created_at": "2018-02-27T11:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345306",
    "user": "embray"
}
```

On second thought, `__setstate__` is fine since `__getstate__` also returns `str`.  Though I don't know why it would dump/load as strings when it could just use binary.



---

archive/issue_comments_345307.json:
```json
{
    "body": "Set assignee to embray.",
    "created_at": "2018-05-14T16:12:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345307",
    "user": "embray"
}
```

Set assignee to embray.



---

archive/issue_comments_345308.json:
```json
{
    "body": "what is the status of this one ?",
    "created_at": "2018-06-13T16:09:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345308",
    "user": "chapoton"
}
```

what is the status of this one ?



---

archive/issue_comments_345309.json:
```json
{
    "body": "I still think that it needs to be fixed.",
    "created_at": "2018-06-14T05:38:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345309",
    "user": "jdemeyer"
}
```

I still think that it needs to be fixed.



---

archive/issue_comments_345310.json:
```json
{
    "body": "Replying to [comment:7 embray]:\n> rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`)\n\nBikeshed: I find it a bit strange to use `char` to refer to `char *`. Better would be `cstr` or `charptr` or `chararray` or whatever.",
    "created_at": "2018-06-14T05:39:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345310",
    "user": "jdemeyer"
}
```

Replying to [comment:7 embray]:
> rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`)

Bikeshed: I find it a bit strange to use `char` to refer to `char *`. Better would be `cstr` or `charptr` or `chararray` or whatever.



---

archive/issue_comments_345311.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Replying to [comment:7 embray]:\n> > rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`)\n> \n> Bikeshed: I find it a bit strange to use `char` to refer to `char *`. Better would be `cstr` or `charptr` or `chararray` or whatever.\n\nI have the same uneasiness about it but couldn't think of a better name at the time.  I think for now I'll keep just \"char\" for consistency's sake, unless you also want to rename `char_to_str`.\n\nI still believe just \"char\" is clear enough in context, though I do like \"cstr\".",
    "created_at": "2018-06-22T15:15:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345311",
    "user": "embray"
}
```

Replying to [comment:13 jdemeyer]:
> Replying to [comment:7 embray]:
> > rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`)
> 
> Bikeshed: I find it a bit strange to use `char` to refer to `char *`. Better would be `cstr` or `charptr` or `chararray` or whatever.

I have the same uneasiness about it but couldn't think of a better name at the time.  I think for now I'll keep just "char" for consistency's sake, unless you also want to rename `char_to_str`.

I still believe just "char" is clear enough in context, though I do like "cstr".



---

archive/issue_comments_345312.json:
```json
{
    "body": "update milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345312",
    "user": "vdelecroix"
}
```

update milestone 8.3 -> 8.4



---

archive/issue_comments_345313.json:
```json
{
    "body": "What's the status here ? can we move on ?",
    "created_at": "2018-09-11T14:29:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345313",
    "user": "chapoton"
}
```

What's the status here ? can we move on ?



---

archive/issue_comments_345314.json:
```json
{
    "body": "I think this is still worth fixing:\n\n> I think what might make sense, for symmetry's sake, might be to rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`) and then make `bitset_from_str` a wrapper around that which uses `str_to_bytes`.\n\nThere's also the matter of Jeroen's bikeshed about the name, but I think I addressed that above.",
    "created_at": "2018-09-11T14:55:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345314",
    "user": "embray"
}
```

I think this is still worth fixing:

> I think what might make sense, for symmetry's sake, might be to rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`) and then make `bitset_from_str` a wrapper around that which uses `str_to_bytes`.

There's also the matter of Jeroen's bikeshed about the name, but I think I addressed that above.



---

archive/issue_comments_345315.json:
```json
{
    "body": "many doctests failures with python2... essentially totally broken",
    "created_at": "2018-10-03T13:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345315",
    "user": "chapoton"
}
```

many doctests failures with python2... essentially totally broken



---

archive/issue_comments_345316.json:
```json
{
    "body": "Okay. Would you like to fix it, taking into account my last comment?  I can still do it too, it just hasn't been high priority.",
    "created_at": "2018-10-03T15:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345316",
    "user": "embray"
}
```

Okay. Would you like to fix it, taking into account my last comment?  I can still do it too, it just hasn't been high priority.



---

archive/issue_comments_345317.json:
```json
{
    "body": "I have no idea what to do here.. So I am not able to do it myself, sorry.",
    "created_at": "2018-10-03T15:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345317",
    "user": "chapoton"
}
```

I have no idea what to do here.. So I am not able to do it myself, sorry.



---

archive/issue_comments_345318.json:
```json
{
    "body": "Ok, but I think you underestimate yourself.  It's mainly just a simple str/bytes conversion issue.\n\nThe existing function maed `bitset_from_str` originally took a `char *` as its argument, which won't make sense for Python 3 str, so I changed it to accept a generic `object` instead and use `str_to_bytes` on it.\n\nJeroen's suggestion was that we keep the original implementation of `bitset_from_str`, but rename it to something like `bitset_from_char`, keeping the original `char *` interface, then add a new `bitset_from_str` which on Python 2 can easily just be an easily for `bitset_from_str`, and on Python 3 would call `str_to_bytes` and pass that to `bitset_from_char`.  Just for example.",
    "created_at": "2018-10-03T15:49:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345318",
    "user": "embray"
}
```

Ok, but I think you underestimate yourself.  It's mainly just a simple str/bytes conversion issue.

The existing function maed `bitset_from_str` originally took a `char *` as its argument, which won't make sense for Python 3 str, so I changed it to accept a generic `object` instead and use `str_to_bytes` on it.

Jeroen's suggestion was that we keep the original implementation of `bitset_from_str`, but rename it to something like `bitset_from_char`, keeping the original `char *` interface, then add a new `bitset_from_str` which on Python 2 can easily just be an easily for `bitset_from_str`, and on Python 3 would call `str_to_bytes` and pass that to `bitset_from_char`.  Just for example.



---

archive/issue_comments_345319.json:
```json
{
    "body": "Well, I've got 30 minutes to kill. So I'll take a look at it now.",
    "created_at": "2018-10-04T10:02:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345319",
    "user": "embray"
}
```

Well, I've got 30 minutes to kill. So I'll take a look at it now.



---

archive/issue_comments_345320.json:
```json
{
    "body": "Reworked this a bit more.  In addition to the original changes from this branch, I also updated `__getstate__` and `__setstate__` to work on bytes instead of str, and I renamed the original `bitset_string` function to `bitset_bytes`, but also added a new `bitset_string` that returns a `str` on Python 3.\n\nI think everything should work on Python 2 as well.  I tested all the modules that use this class directly, at least.\n----\nNew commits:",
    "created_at": "2018-10-04T13:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345320",
    "user": "embray"
}
```

Reworked this a bit more.  In addition to the original changes from this branch, I also updated `__getstate__` and `__setstate__` to work on bytes instead of str, and I renamed the original `bitset_string` function to `bitset_bytes`, but also added a new `bitset_string` that returns a `str` on Python 3.

I think everything should work on Python 2 as well.  I tested all the modules that use this class directly, at least.
----
New commits:



---

archive/issue_comments_345321.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-10-04T13:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345321",
    "user": "embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_345322.json:
```json
{
    "body": "ok, then. Thanks a lot.",
    "created_at": "2018-10-04T16:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345322",
    "user": "chapoton"
}
```

ok, then. Thanks a lot.



---

archive/issue_comments_345323.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-10-04T16:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345323",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_345324.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-10-06T17:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24615",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24615#issuecomment-345324",
    "user": "vbraun"
}
```

Resolution: fixed
