# Issue 24615: Fix bytes/str in sage.data_structures.bitset

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-02-27 09:33:53

CC:  embray




---

Comment by jdemeyer created at 2018-02-27 09:36:29

It looks like `bitset_from_str` is meant to be a low-level C function. Wouldn't it be better to fix _calls_ to `bitset_from_str` instead?
----
New commits:


---

Comment by jdemeyer created at 2018-02-27 09:36:41

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-27 09:36:46

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-02-27 09:38:54

Yes, I see your point. Let me see how many of those there actually are...


---

Comment by embray created at 2018-02-27 09:42:41

No, it's only used in bitset.pyx, and the way I use `str_to_bytes` here makes sense.


---

Comment by embray created at 2018-02-27 09:46:47

There are one or two cases in bitset.pyx where it's explicitly being used on bytes (e.g. in `__setstate__`, and other cases where it's being used on `str` (in the 2/3-compatibility sense) where using `str_to_bytes` in `bitset_from_str` makes sense.

I think what might make sense, for symmetry's sake, might be to rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`) and then make `bitset_from_str` a wrapper around that which uses `str_to_bytes`.


---

Comment by embray created at 2018-02-27 11:53:58

On second thought, `__setstate__` is fine since `__getstate__` also returns `str`.  Though I don't know why it would dump/load as strings when it could just use binary.


---

Comment by embray created at 2018-05-14 16:12:30

Set assignee to embray.


---

Comment by chapoton created at 2018-06-13 16:09:42

what is the status of this one ?


---

Comment by jdemeyer created at 2018-06-14 05:38:24

I still think that it needs to be fixed.


---

Comment by jdemeyer created at 2018-06-14 05:39:44

Replying to [comment:7 embray]:
> rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`)

Bikeshed: I find it a bit strange to use `char` to refer to `char *`. Better would be `cstr` or `charptr` or `chararray` or whatever.


---

Comment by embray created at 2018-06-22 15:15:35

Replying to [comment:13 jdemeyer]:
> Replying to [comment:7 embray]:
> > rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`)
> 
> Bikeshed: I find it a bit strange to use `char` to refer to `char *`. Better would be `cstr` or `charptr` or `chararray` or whatever.

I have the same uneasiness about it but couldn't think of a better name at the time.  I think for now I'll keep just "char" for consistency's sake, unless you also want to rename `char_to_str`.

I still believe just "char" is clear enough in context, though I do like "cstr".


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by chapoton created at 2018-09-11 14:29:57

What's the status here ? can we move on ?


---

Comment by embray created at 2018-09-11 14:55:46

I think this is still worth fixing:

> I think what might make sense, for symmetry's sake, might be to rename the original `bitset_from_str` to `bitset_from_char`  (as in `char *`) and then make `bitset_from_str` a wrapper around that which uses `str_to_bytes`.

There's also the matter of Jeroen's bikeshed about the name, but I think I addressed that above.


---

Comment by chapoton created at 2018-10-03 13:38:25

many doctests failures with python2... essentially totally broken


---

Comment by embray created at 2018-10-03 15:25:02

Okay. Would you like to fix it, taking into account my last comment?  I can still do it too, it just hasn't been high priority.


---

Comment by chapoton created at 2018-10-03 15:31:01

I have no idea what to do here.. So I am not able to do it myself, sorry.


---

Comment by embray created at 2018-10-03 15:49:58

Ok, but I think you underestimate yourself.  It's mainly just a simple str/bytes conversion issue.

The existing function maed `bitset_from_str` originally took a `char *` as its argument, which won't make sense for Python 3 str, so I changed it to accept a generic `object` instead and use `str_to_bytes` on it.

Jeroen's suggestion was that we keep the original implementation of `bitset_from_str`, but rename it to something like `bitset_from_char`, keeping the original `char *` interface, then add a new `bitset_from_str` which on Python 2 can easily just be an easily for `bitset_from_str`, and on Python 3 would call `str_to_bytes` and pass that to `bitset_from_char`.  Just for example.


---

Comment by embray created at 2018-10-04 10:02:44

Well, I've got 30 minutes to kill. So I'll take a look at it now.


---

Comment by embray created at 2018-10-04 13:14:27

Reworked this a bit more.  In addition to the original changes from this branch, I also updated `__getstate__` and `__setstate__` to work on bytes instead of str, and I renamed the original `bitset_string` function to `bitset_bytes`, but also added a new `bitset_string` that returns a `str` on Python 3.

I think everything should work on Python 2 as well.  I tested all the modules that use this class directly, at least.
----
New commits:


---

Comment by embray created at 2018-10-04 13:14:27

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-10-04 16:14:23

ok, then. Thanks a lot.


---

Comment by chapoton created at 2018-10-04 16:14:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-10-06 17:13:15

Resolution: fixed
