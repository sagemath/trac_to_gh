# Issue 12500: Build PPL with its C interface

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2012-03-15 08:36:23

Assignee: tbd

CC:  aginiewicz

Keywords: PPL C interface

Currently, the standard PPL spkg only builds the C++ interface. However, `CLooG-PPL` (see #12666) needs the C-header `ppl_c.h` as well.

Therefore I suggest to slightly modify the install script of our PPL spkg:

 * Do `make install` instead of `make install-strip` -- I admit that I am not sure whether this is needed, and perhaps `make install-strip` yields faster code. A reviewer should comment on that.
 * Modify the configuration options, such that the C interface is built.

*spkg:* [http://boxen.math.washington.edu/home/SimonKing/SAGE/spkgs/ppl-0.11.2.p2.spkg](http://boxen.math.washington.edu/home/SimonKing/SAGE/spkgs/ppl-0.11.2.p2.spkg)


---

Comment by SimonKing created at 2012-03-15 08:36:32

Changing status from new to needs_review.


---

Comment by SimonKing created at 2012-03-15 09:14:08

Interestingly, when I tried doc tests with a Sage version that used massive optimization (via graphite), a lot of tests went a lot slower (by a factor of 2 in some cases) than without the optimization.

I had the impression that the particularly bad cases were related to polyhedra. Therefore, I try to build ppl with `make install-strip` again, and keep my fingers crossed that it will improve the situation.


---

Comment by SimonKing created at 2012-03-15 19:05:44

It could be that the bad performance came from using GMP instead of MPIR. It turns out that cloog-ppl can be built with MPIR (originally, I thought GMP is required). Anyway, I am now building Sage without GMP but with high optimization, and hope that it'll work better.


---

Comment by aginiewicz created at 2012-03-17 00:33:20

This also fixes #11391, where on Arch Linux and some other new 32-bit distros there are missing symbols in ppl during building of pycrypto - enabling C interface makes it work again. I haven't noticed this ticket, as I started testing fix for 11391 before this one was created, so I posted nearly same spkg in #11391 (with C interface, but without install vs install-strip change).

As I worked on the same thing just few hours ago, after quick check on sage 4.8 I just made in VM I can say that it works, but I don't feel experienced enough to comment on install vs install-strip, so I'm leaving it as needing review.


---

Comment by jdemeyer created at 2012-03-27 09:56:45

`make install-strip` removes debugging information from the PPL library.  I don't see the need for that, so I actually prefer `install` over `install-strip`.


---

Comment by jdemeyer created at 2012-04-01 15:56:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-04-01 15:56:15

Unfortunately, this seems to require a recent vesion of M4 (which isn't present on OS X 10.4):

```
checking whether to build the Parma Watchdog Library... yes
checking whether to build the ppl_lcdd program... yes
checking whether to build the ppl_lpsol program... yes
checking whether to build the ppl_pips program... yes
checking which interfaces are enabled... cxx c
checking for GNU M4 that supports accurate traces... configure: error: no acceptable m4 could be found in $PATH.
GNU M4 1.4.5 or later is required; 1.4.11 is recommended
Error configuring the Parma Polyhedra Library.
```



---

Comment by jdemeyer created at 2012-06-19 12:17:55

This is a duplicate of #11391 (which has the same solution for a different problem).


---

Comment by SimonKing created at 2012-07-26 16:19:11

Replying to [comment:7 jdemeyer]:
> This is a duplicate of #11391 (which has the same solution for a different problem).

I think it is not a duplicate. #11391 is about building ppl on ArchLinux and OpenSuse and so on. The ticket here is about building ppl with its c interface. So, these are orthogonal problems.


---

Comment by SimonKing created at 2012-07-26 16:20:29

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2012-07-26 16:20:58

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2012-07-26 16:22:33

It remains "needs work", because of the problem on OS X you mentioned. So, do we need an M4 package??


---

Comment by kcrisman created at 2013-03-29 15:45:44

I don't see why one couldn't just do the usual thing we do in `spkg-install` for unusual systems - just a check for Darwin with version 8 or 9 or something.  Or even check for m4's existence and version (can this be done easily?).  In either case, just don't do

```
-    --enable-interfaces=c++ --disable-fpmath
+    --enable-interfaces="c++ c" --disable-fpmath
```

for that specific situation, maybe echoing a message.  Then #12666 can raise an error message if one doesn't have the correct header, saying "please get a system with a recent enough m4, do `sage -i ppl`, and then reinstall this optional spkg".


---

Comment by jdemeyer created at 2013-03-29 16:33:40

Replying to [comment:12 kcrisman]:
> just a check for Darwin with version 8 or 9 or something.
That's too fragile, nobody guarantees that this is the only system with a bad `m4`.

> Or even check for m4's existence and version
If you create a patch, I'll be happy to review it. Note that we already require the _existence_ of `m4` in prereq (MPIR needs it).


---

Comment by kcrisman created at 2013-03-29 17:25:51

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 kcrisman]:
> > just a check for Darwin with version 8 or 9 or something.
> That's too fragile, nobody guarantees that this is the only system with a bad `m4`.
True, in fact it's quite likely others will be thus.
> > Or even check for m4's existence and version
> If you create a patch, I'll be happy to review it. Note that we already require the _existence_ of `m4` in prereq (MPIR needs it).


---

Comment by kcrisman created at 2013-03-30 03:09:31

Here is a first try.

```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
`@``@` -39,9 +39,21 `@``@`
     fi
 done
 
-./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
-    --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz \
-    --enable-interfaces="c++ c" --disable-fpmath
+# If m4 is not recent enough, we fall back to only enabling the C++ interface
+M4_VERSION=`m4 --version | grep GNU | cut -d " " -f 3`
+if [This is the Trac macro *$M4_VERSION < 1.4.5 * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#$M4_VERSION < 1.4.5 -macro); then
+    echo "Configuring only for C++ interface"
+    echo "Install GNU M4 1.4.5 or later for C interface"
+    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
+        --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz \
+        --enable-interfaces=c++ --disable-fpmath
+else
+    echo "Great, you have GNU M4 1.4.5 or later"
+    echo "Configuring for C++ and C interfaces"
+    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
+        --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz \
+        --enable-interfaces="c++ c" --disable-fpmath
+fi
 if [ $? -ne 0 ]; then
    echo >&2 "Error configuring the Parma Polyhedra Library."
    exit 1
```

But it doesn't work, because the extended bash test doesn't quite do what we want.

```
$ if [This is the Trac macro *1.4.11 > 1.4.5 * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1.4.11 > 1.4.5 -macro); then echo "bigger"; fi
$
```

I cringe at the more comprehensive solutions to this problem I found on the internet, though.   The `sort -V` command might have been helpful, but that flag isn't universally available.


---

Comment by jdemeyer created at 2013-06-04 15:07:33

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2013-06-04 15:07:33

Fixed by #14232.


---

Comment by jdemeyer created at 2013-06-06 12:40:37

Resolution: duplicate
