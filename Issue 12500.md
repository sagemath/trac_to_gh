# Issue 12500: Build PPL with its C interface

archive/issues_012500.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  aginiewicz\n\nKeywords: PPL C interface\n\nCurrently, the standard PPL spkg only builds the C++ interface. However, `CLooG-PPL` (see #12666) needs the C-header `ppl_c.h` as well.\n\nTherefore I suggest to slightly modify the install script of our PPL spkg:\n\n* Do `make install` instead of `make install-strip` -- I admit that I am not sure whether this is needed, and perhaps `make install-strip` yields faster code. A reviewer should comment on that.\n* Modify the configuration options, such that the C interface is built.\n\n**spkg:** [http://boxen.math.washington.edu/home/SimonKing/SAGE/spkgs/ppl-0.11.2.p2.spkg](http://boxen.math.washington.edu/home/SimonKing/SAGE/spkgs/ppl-0.11.2.p2.spkg)\n\nIssue created by migration from https://trac.sagemath.org/ticket/12672\n\n",
    "created_at": "2012-03-15T08:36:23Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "Build PPL with its C interface",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12500",
    "user": "SimonKing"
}
```
Assignee: tbd

CC:  aginiewicz

Keywords: PPL C interface

Currently, the standard PPL spkg only builds the C++ interface. However, `CLooG-PPL` (see #12666) needs the C-header `ppl_c.h` as well.

Therefore I suggest to slightly modify the install script of our PPL spkg:

* Do `make install` instead of `make install-strip` -- I admit that I am not sure whether this is needed, and perhaps `make install-strip` yields faster code. A reviewer should comment on that.
* Modify the configuration options, such that the C interface is built.

**spkg:** [http://boxen.math.washington.edu/home/SimonKing/SAGE/spkgs/ppl-0.11.2.p2.spkg](http://boxen.math.washington.edu/home/SimonKing/SAGE/spkgs/ppl-0.11.2.p2.spkg)

Issue created by migration from https://trac.sagemath.org/ticket/12672





---

archive/issue_comments_148089.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-03-15T08:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148089",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_148090.json:
```json
{
    "body": "Interestingly, when I tried doc tests with a Sage version that used massive optimization (via graphite), a lot of tests went a lot slower (by a factor of 2 in some cases) than without the optimization.\n\nI had the impression that the particularly bad cases were related to polyhedra. Therefore, I try to build ppl with `make install-strip` again, and keep my fingers crossed that it will improve the situation.",
    "created_at": "2012-03-15T09:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148090",
    "user": "SimonKing"
}
```

Interestingly, when I tried doc tests with a Sage version that used massive optimization (via graphite), a lot of tests went a lot slower (by a factor of 2 in some cases) than without the optimization.

I had the impression that the particularly bad cases were related to polyhedra. Therefore, I try to build ppl with `make install-strip` again, and keep my fingers crossed that it will improve the situation.



---

archive/issue_comments_148091.json:
```json
{
    "body": "It could be that the bad performance came from using GMP instead of MPIR. It turns out that cloog-ppl can be built with MPIR (originally, I thought GMP is required). Anyway, I am now building Sage without GMP but with high optimization, and hope that it'll work better.",
    "created_at": "2012-03-15T19:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148091",
    "user": "SimonKing"
}
```

It could be that the bad performance came from using GMP instead of MPIR. It turns out that cloog-ppl can be built with MPIR (originally, I thought GMP is required). Anyway, I am now building Sage without GMP but with high optimization, and hope that it'll work better.



---

archive/issue_comments_148092.json:
```json
{
    "body": "This also fixes #11391, where on Arch Linux and some other new 32-bit distros there are missing symbols in ppl during building of pycrypto - enabling C interface makes it work again. I haven't noticed this ticket, as I started testing fix for 11391 before this one was created, so I posted nearly same spkg in #11391 (with C interface, but without install vs install-strip change).\n\nAs I worked on the same thing just few hours ago, after quick check on sage 4.8 I just made in VM I can say that it works, but I don't feel experienced enough to comment on install vs install-strip, so I'm leaving it as needing review.",
    "created_at": "2012-03-17T00:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148092",
    "user": "aginiewicz"
}
```

This also fixes #11391, where on Arch Linux and some other new 32-bit distros there are missing symbols in ppl during building of pycrypto - enabling C interface makes it work again. I haven't noticed this ticket, as I started testing fix for 11391 before this one was created, so I posted nearly same spkg in #11391 (with C interface, but without install vs install-strip change).

As I worked on the same thing just few hours ago, after quick check on sage 4.8 I just made in VM I can say that it works, but I don't feel experienced enough to comment on install vs install-strip, so I'm leaving it as needing review.



---

archive/issue_comments_148093.json:
```json
{
    "body": "`make install-strip` removes debugging information from the PPL library.  I don't see the need for that, so I actually prefer `install` over `install-strip`.",
    "created_at": "2012-03-27T09:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148093",
    "user": "jdemeyer"
}
```

`make install-strip` removes debugging information from the PPL library.  I don't see the need for that, so I actually prefer `install` over `install-strip`.



---

archive/issue_comments_148094.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-04-01T15:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148094",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_148095.json:
```json
{
    "body": "Unfortunately, this seems to require a recent vesion of M4 (which isn't present on OS X 10.4):\n\n```\nchecking whether to build the Parma Watchdog Library... yes\nchecking whether to build the ppl_lcdd program... yes\nchecking whether to build the ppl_lpsol program... yes\nchecking whether to build the ppl_pips program... yes\nchecking which interfaces are enabled... cxx c\nchecking for GNU M4 that supports accurate traces... configure: error: no acceptable m4 could be found in $PATH.\nGNU M4 1.4.5 or later is required; 1.4.11 is recommended\nError configuring the Parma Polyhedra Library.\n```\n",
    "created_at": "2012-04-01T15:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148095",
    "user": "jdemeyer"
}
```

Unfortunately, this seems to require a recent vesion of M4 (which isn't present on OS X 10.4):

```
checking whether to build the Parma Watchdog Library... yes
checking whether to build the ppl_lcdd program... yes
checking whether to build the ppl_lpsol program... yes
checking whether to build the ppl_pips program... yes
checking which interfaces are enabled... cxx c
checking for GNU M4 that supports accurate traces... configure: error: no acceptable m4 could be found in $PATH.
GNU M4 1.4.5 or later is required; 1.4.11 is recommended
Error configuring the Parma Polyhedra Library.
```




---

archive/issue_comments_148096.json:
```json
{
    "body": "This is a duplicate of #11391 (which has the same solution for a different problem).",
    "created_at": "2012-06-19T12:17:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148096",
    "user": "jdemeyer"
}
```

This is a duplicate of #11391 (which has the same solution for a different problem).



---

archive/issue_comments_148097.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> This is a duplicate of #11391 (which has the same solution for a different problem).\n\nI think it is not a duplicate. #11391 is about building ppl on ArchLinux and OpenSuse and so on. The ticket here is about building ppl with its c interface. So, these are orthogonal problems.",
    "created_at": "2012-07-26T16:19:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148097",
    "user": "SimonKing"
}
```

Replying to [comment:7 jdemeyer]:
> This is a duplicate of #11391 (which has the same solution for a different problem).

I think it is not a duplicate. #11391 is about building ppl on ArchLinux and OpenSuse and so on. The ticket here is about building ppl with its c interface. So, these are orthogonal problems.



---

archive/issue_comments_148098.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-07-26T16:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148098",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_148099.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-07-26T16:20:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148099",
    "user": "SimonKing"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_148100.json:
```json
{
    "body": "It remains \"needs work\", because of the problem on OS X you mentioned. So, do we need an M4 package??",
    "created_at": "2012-07-26T16:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148100",
    "user": "SimonKing"
}
```

It remains "needs work", because of the problem on OS X you mentioned. So, do we need an M4 package??



---

archive/issue_comments_148101.json:
```json
{
    "body": "I don't see why one couldn't just do the usual thing we do in `spkg-install` for unusual systems - just a check for Darwin with version 8 or 9 or something.  Or even check for m4's existence and version (can this be done easily?).  In either case, just don't do\n\n```\n-    --enable-interfaces=c++ --disable-fpmath\n+    --enable-interfaces=\"c++ c\" --disable-fpmath\n```\n\nfor that specific situation, maybe echoing a message.  Then #12666 can raise an error message if one doesn't have the correct header, saying \"please get a system with a recent enough m4, do `sage -i ppl`, and then reinstall this optional spkg\".",
    "created_at": "2013-03-29T15:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148101",
    "user": "kcrisman"
}
```

I don't see why one couldn't just do the usual thing we do in `spkg-install` for unusual systems - just a check for Darwin with version 8 or 9 or something.  Or even check for m4's existence and version (can this be done easily?).  In either case, just don't do

```
-    --enable-interfaces=c++ --disable-fpmath
+    --enable-interfaces="c++ c" --disable-fpmath
```

for that specific situation, maybe echoing a message.  Then #12666 can raise an error message if one doesn't have the correct header, saying "please get a system with a recent enough m4, do `sage -i ppl`, and then reinstall this optional spkg".



---

archive/issue_comments_148102.json:
```json
{
    "body": "Replying to [comment:12 kcrisman]:\n> just a check for Darwin with version 8 or 9 or something.\nThat's too fragile, nobody guarantees that this is the only system with a bad `m4`.\n\n> Or even check for m4's existence and version\nIf you create a patch, I'll be happy to review it. Note that we already require the *existence* of `m4` in prereq (MPIR needs it).",
    "created_at": "2013-03-29T16:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148102",
    "user": "jdemeyer"
}
```

Replying to [comment:12 kcrisman]:
> just a check for Darwin with version 8 or 9 or something.
That's too fragile, nobody guarantees that this is the only system with a bad `m4`.

> Or even check for m4's existence and version
If you create a patch, I'll be happy to review it. Note that we already require the *existence* of `m4` in prereq (MPIR needs it).



---

archive/issue_comments_148103.json:
```json
{
    "body": "Replying to [comment:13 jdemeyer]:\n> Replying to [comment:12 kcrisman]:\n> > just a check for Darwin with version 8 or 9 or something.\n> That's too fragile, nobody guarantees that this is the only system with a bad `m4`.\nTrue, in fact it's quite likely others will be thus.\n> > Or even check for m4's existence and version\n> If you create a patch, I'll be happy to review it. Note that we already require the *existence* of `m4` in prereq (MPIR needs it).",
    "created_at": "2013-03-29T17:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148103",
    "user": "kcrisman"
}
```

Replying to [comment:13 jdemeyer]:
> Replying to [comment:12 kcrisman]:
> > just a check for Darwin with version 8 or 9 or something.
> That's too fragile, nobody guarantees that this is the only system with a bad `m4`.
True, in fact it's quite likely others will be thus.
> > Or even check for m4's existence and version
> If you create a patch, I'll be happy to review it. Note that we already require the *existence* of `m4` in prereq (MPIR needs it).



---

archive/issue_comments_148104.json:
```json
{
    "body": "Here is a first try.\n\n```diff\ndiff --git a/spkg-install b/spkg-install\n--- a/spkg-install\n+++ b/spkg-install\n@@ -39,9 +39,21 @@\n     fi\n done\n \n-./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n-    --with-gmp-prefix=\"$SAGE_LOCAL\" --enable-coefficients=mpz \\\n-    --enable-interfaces=\"c++ c\" --disable-fpmath\n+# If m4 is not recent enough, we fall back to only enabling the C++ interface\n+M4_VERSION=`m4 --version | grep GNU | cut -d \" \" -f 3`\n+if [[ $M4_VERSION < 1.4.5 ]]; then\n+    echo \"Configuring only for C++ interface\"\n+    echo \"Install GNU M4 1.4.5 or later for C interface\"\n+    ./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n+        --with-gmp-prefix=\"$SAGE_LOCAL\" --enable-coefficients=mpz \\\n+        --enable-interfaces=c++ --disable-fpmath\n+else\n+    echo \"Great, you have GNU M4 1.4.5 or later\"\n+    echo \"Configuring for C++ and C interfaces\"\n+    ./configure --prefix=\"$SAGE_LOCAL\" --libdir=\"$SAGE_LOCAL/lib\" \\\n+        --with-gmp-prefix=\"$SAGE_LOCAL\" --enable-coefficients=mpz \\\n+        --enable-interfaces=\"c++ c\" --disable-fpmath\n+fi\n if [ $? -ne 0 ]; then\n    echo >&2 \"Error configuring the Parma Polyhedra Library.\"\n    exit 1\n```\n\nBut it doesn't work, because the extended bash test doesn't quite do what we want.\n\n```\n$ if [[ 1.4.11 > 1.4.5 ]]; then echo \"bigger\"; fi\n$\n```\n\nI cringe at the more comprehensive solutions to this problem I found on the internet, though.   The `sort -V` command might have been helpful, but that flag isn't universally available.",
    "created_at": "2013-03-30T03:09:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148104",
    "user": "kcrisman"
}
```

Here is a first try.

```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
@@ -39,9 +39,21 @@
     fi
 done
 
-./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
-    --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz \
-    --enable-interfaces="c++ c" --disable-fpmath
+# If m4 is not recent enough, we fall back to only enabling the C++ interface
+M4_VERSION=`m4 --version | grep GNU | cut -d " " -f 3`
+if [[ $M4_VERSION < 1.4.5 ]]; then
+    echo "Configuring only for C++ interface"
+    echo "Install GNU M4 1.4.5 or later for C interface"
+    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
+        --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz \
+        --enable-interfaces=c++ --disable-fpmath
+else
+    echo "Great, you have GNU M4 1.4.5 or later"
+    echo "Configuring for C++ and C interfaces"
+    ./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" \
+        --with-gmp-prefix="$SAGE_LOCAL" --enable-coefficients=mpz \
+        --enable-interfaces="c++ c" --disable-fpmath
+fi
 if [ $? -ne 0 ]; then
    echo >&2 "Error configuring the Parma Polyhedra Library."
    exit 1
```

But it doesn't work, because the extended bash test doesn't quite do what we want.

```
$ if [[ 1.4.11 > 1.4.5 ]]; then echo "bigger"; fi
$
```

I cringe at the more comprehensive solutions to this problem I found on the internet, though.   The `sort -V` command might have been helpful, but that flag isn't universally available.



---

archive/issue_comments_148105.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-06-04T15:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148105",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_148106.json:
```json
{
    "body": "Fixed by #14232.",
    "created_at": "2013-06-04T15:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148106",
    "user": "jdemeyer"
}
```

Fixed by #14232.



---

archive/issue_comments_148107.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2013-06-06T12:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12500",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12500#issuecomment-148107",
    "user": "jdemeyer"
}
```

Resolution: duplicate
