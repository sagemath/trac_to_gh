# Issue 15220: sage-cleaner does not quit

archive/issues_015220.json:
```json
{
    "body": "If there are files in `DOT_SAGE/temp/HOSTNAME` then the sage cleaner process never stops. Note that Sage temp files must(!) be under `DOT_SAGE/temp/HOSTNAME/<pid>`.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15457\n\n",
    "created_at": "2013-11-26T22:52:06Z",
    "labels": [
        "scripts",
        "major",
        "bug"
    ],
    "title": "sage-cleaner does not quit",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15220",
    "user": "vbraun"
}
```
If there are files in `DOT_SAGE/temp/HOSTNAME` then the sage cleaner process never stops. Note that Sage temp files must(!) be under `DOT_SAGE/temp/HOSTNAME/<pid>`.



Issue created by migration from https://trac.sagemath.org/ticket/15457





---

archive/issue_comments_195582.json:
```json
{
    "body": "Also, clean up the cleaner sources a bit. And move the pid file to `SAGE_TMP_ROOT/cleaner.pid`. And log the output to `SAGE_TMP_ROOT/cleaner.log`.",
    "created_at": "2013-11-27T00:15:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195582",
    "user": "vbraun"
}
```

Also, clean up the cleaner sources a bit. And move the pid file to `SAGE_TMP_ROOT/cleaner.pid`. And log the output to `SAGE_TMP_ROOT/cleaner.log`.



---

archive/issue_comments_195583.json:
```json
{
    "body": "New commits:",
    "created_at": "2013-11-27T01:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195583",
    "user": "vbraun"
}
```

New commits:



---

archive/issue_comments_195584.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-11-27T01:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195584",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_195585.json:
```json
{
    "body": "Who or what is writing to `DOT_SAGE/temp/HOSTNAME`? I haven't seen this problem appear before.",
    "created_at": "2013-12-10T08:52:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195585",
    "user": "jdemeyer"
}
```

Who or what is writing to `DOT_SAGE/temp/HOSTNAME`? I haven't seen this problem appear before.



---

archive/issue_comments_195586.json:
```json
{
    "body": "The files were fairly old afair. Of course it is hard to say where they came from, could even have been a ticket that was not merged that way. I guess you just haven't noticed since you didn't try to delete DOT_SAGE (which will fail on NFS if files are still open). In any case, the sage cleaner shoudn't break just because there is a temp file in the wrong location. By outright deleting the illegal file we hopefully hurt whoever put it there so they notice the error in their ways.\n\nFor the record, I configured the new buildbot so that full builds start with a fresh DOT_SAGE and incremental builds keep using the previous one.",
    "created_at": "2013-12-10T11:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195586",
    "user": "vbraun"
}
```

The files were fairly old afair. Of course it is hard to say where they came from, could even have been a ticket that was not merged that way. I guess you just haven't noticed since you didn't try to delete DOT_SAGE (which will fail on NFS if files are still open). In any case, the sage cleaner shoudn't break just because there is a temp file in the wrong location. By outright deleting the illegal file we hopefully hurt whoever put it there so they notice the error in their ways.

For the record, I configured the new buildbot so that full builds start with a fresh DOT_SAGE and incremental builds keep using the previous one.



---

archive/issue_comments_195587.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> The files were fairly old afair. Of course it is hard to say where they came from, could even have been a ticket that was not merged that way.\nThanks, that's a good explanation.",
    "created_at": "2013-12-10T11:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195587",
    "user": "jdemeyer"
}
```

Replying to [comment:6 vbraun]:
> The files were fairly old afair. Of course it is hard to say where they came from, could even have been a ticket that was not merged that way.
Thanks, that's a good explanation.



---

archive/issue_comments_195588.json:
```json
{
    "body": "Can you review this ticket?",
    "created_at": "2013-12-23T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195588",
    "user": "vbraun"
}
```

Can you review this ticket?



---

archive/issue_comments_195589.json:
```json
{
    "body": "What's the motivation for always re-opening the file in `LogFile`?",
    "created_at": "2014-01-01T14:32:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195589",
    "user": "jdemeyer"
}
```

What's the motivation for always re-opening the file in `LogFile`?



---

archive/issue_comments_195590.json:
```json
{
    "body": "There is also this: [http://docs.python.org/2/library/logging.html](http://docs.python.org/2/library/logging.html), see also [http://docs.python.org/2/howto/logging.html](http://docs.python.org/2/howto/logging.html)",
    "created_at": "2014-01-01T14:36:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195590",
    "user": "jdemeyer"
}
```

There is also this: [http://docs.python.org/2/library/logging.html](http://docs.python.org/2/library/logging.html), see also [http://docs.python.org/2/howto/logging.html](http://docs.python.org/2/howto/logging.html)



---

archive/issue_comments_195591.json:
```json
{
    "body": "And why not replace\n\n```\n    if not os.path.isdir(SAGE_TMP_ROOT):\n        mkdir_p(SAGE_TMP_ROOT)\n```\n\nby\n\n```\n    mkdir_p(SAGE_TMP_ROOT)\n```\n\n(or at least, move the `isdir` check inside `mkdir_p`)",
    "created_at": "2014-01-01T14:39:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195591",
    "user": "jdemeyer"
}
```

And why not replace

```
    if not os.path.isdir(SAGE_TMP_ROOT):
        mkdir_p(SAGE_TMP_ROOT)
```

by

```
    mkdir_p(SAGE_TMP_ROOT)
```

(or at least, move the `isdir` check inside `mkdir_p`)



---

archive/issue_comments_195592.json:
```json
{
    "body": "Working on review patch, hang on...",
    "created_at": "2014-01-01T14:51:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195592",
    "user": "jdemeyer"
}
```

Working on review patch, hang on...



---

archive/issue_comments_195593.json:
```json
{
    "body": "And what was wrong with\n\n```\nopen(pidfile,'w').write(str(os.getpid()))\n```\n\n???",
    "created_at": "2014-01-01T16:09:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195593",
    "user": "jdemeyer"
}
```

And what was wrong with

```
open(pidfile,'w').write(str(os.getpid()))
```

???



---

archive/issue_comments_195594.json:
```json
{
    "body": "Additional commit needs review.\n----\nNew commits:",
    "created_at": "2014-01-01T17:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195594",
    "user": "jdemeyer"
}
```

Additional commit needs review.
----
New commits:



---

archive/issue_comments_195595.json:
```json
{
    "body": "IMHO it is bad to keep log files open for extended amounts of time. This is just going to cause problems (depending on the file system) if multiple processes try do do that. And before you say that there is only one cleaner process, the whole point of the logging is to have a log to prove that if things go south again. The Python logging module does not support multiple processes logging to the same file, for the record. But at least it flushes the output.\n\nThe `open(pidfile,'w').write(str(os.getpid()))` construct works but is IMHO bad style. For starters, it does an implicit close (explicit is better than implicit). The point in the program flow where the close occurs is also not specified (CPython implementation detail closes it immediately, I think, but the specs don't specify). And until the close there is (probably, again implementation/fs detail) nothing written to disk.",
    "created_at": "2014-01-02T04:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195595",
    "user": "vbraun"
}
```

IMHO it is bad to keep log files open for extended amounts of time. This is just going to cause problems (depending on the file system) if multiple processes try do do that. And before you say that there is only one cleaner process, the whole point of the logging is to have a log to prove that if things go south again. The Python logging module does not support multiple processes logging to the same file, for the record. But at least it flushes the output.

The `open(pidfile,'w').write(str(os.getpid()))` construct works but is IMHO bad style. For starters, it does an implicit close (explicit is better than implicit). The point in the program flow where the close occurs is also not specified (CPython implementation detail closes it immediately, I think, but the specs don't specify). And until the close there is (probably, again implementation/fs detail) nothing written to disk.



---

archive/issue_comments_195596.json:
```json
{
    "body": "Replying to [comment:17 vbraun]:\n> IMHO it is bad to keep log files open for extended amounts of time. This is just going to cause problems (depending on the file system) if multiple processes try do do that. And before you say that there is only one cleaner process, the whole point of the logging is to have a log to prove that if things go south again. The Python logging module does not support multiple processes logging to the same file, for the record. But at least it flushes the output.\n\nHaving multiple processes append to the same file is indeed subject to race conditions on NFS (but almost everything with NFS has race conditions). However, this is independent of how many processes have the file open, I see no evidence that simply having a file open makes things worse.",
    "created_at": "2014-01-02T08:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195596",
    "user": "jdemeyer"
}
```

Replying to [comment:17 vbraun]:
> IMHO it is bad to keep log files open for extended amounts of time. This is just going to cause problems (depending on the file system) if multiple processes try do do that. And before you say that there is only one cleaner process, the whole point of the logging is to have a log to prove that if things go south again. The Python logging module does not support multiple processes logging to the same file, for the record. But at least it flushes the output.

Having multiple processes append to the same file is indeed subject to race conditions on NFS (but almost everything with NFS has race conditions). However, this is independent of how many processes have the file open, I see no evidence that simply having a file open makes things worse.



---

archive/issue_comments_195597.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-02T08:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195597",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_195598.json:
```json
{
    "body": "NFS isn't even close to being the worst case here. For example on the PanFS network file system opening a file also locks it, so all other processes get EACCESS. Its not about a race, its that other processes can't even log that something is wrong.",
    "created_at": "2014-01-03T06:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195598",
    "user": "vbraun"
}
```

NFS isn't even close to being the worst case here. For example on the PanFS network file system opening a file also locks it, so all other processes get EACCESS. Its not about a race, its that other processes can't even log that something is wrong.



---

archive/issue_comments_195599.json:
```json
{
    "body": "Should we really jump through hoops to support broken file systems?",
    "created_at": "2014-01-09T17:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195599",
    "user": "jdemeyer"
}
```

Should we really jump through hoops to support broken file systems?



---

archive/issue_comments_195600.json:
```json
{
    "body": "Afaik there is nothing in the spec that disallows automatic mandatory file locking. Its not done in the usual local filesystems, but that doesn't mean that Panasas is broken. But even if it goes agains POSIX then its still a widely-used filesystem in the HPC world, so we would only hurt ourselves if we were to intentionally break Sage on it.",
    "created_at": "2014-01-12T03:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195600",
    "user": "vbraun"
}
```

Afaik there is nothing in the spec that disallows automatic mandatory file locking. Its not done in the usual local filesystems, but that doesn't mean that Panasas is broken. But even if it goes agains POSIX then its still a widely-used filesystem in the HPC world, so we would only hurt ourselves if we were to intentionally break Sage on it.



---

archive/issue_comments_195601.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-14T19:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15220",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15220#issuecomment-195601",
    "user": "vbraun"
}
```

Resolution: fixed
