# Issue 26825: MR5: note on what happens if an executable script is loaded

Issue created by migration from https://trac.sagemath.org/ticket/27062

Original creator: galois

Original creation time: 2019-01-15 16:00:13

CC:  embray

Dmitrii Pasechnik ([`@`dimpase](https://gitlab.com/dimpase)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/5:
----









---

Comment by dimpase created at 2019-01-15 16:01:29

Changing component from PLEASE CHANGE to documentation.


---

Comment by dimpase created at 2019-01-15 16:01:29

Changing type from PLEASE CHANGE to enhancement.


---

Comment by galois created at 2019-01-15 16:08:44

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by jdemeyer created at 2019-01-15 16:50:01

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2019-01-15 16:50:01

Erik seems to think that this is a bug.


---

Comment by dimpase created at 2019-01-15 16:54:58

I don't think it is a bug. In Sage REPL you have `__name__==__main__`, and `load()` is akin to typing code in. Why would it go under another `__name__`?


---

Comment by embray created at 2019-01-15 17:38:42

I think it's a principle of least astonishment.  We teach that the way to make a Python script into an executable command-line script is to put `if __name__ == '__main__':`.  Most users don't really know what that means or why it works; it's just cargo cult.  While `load()` is not perfectly analogous to `import` and, as you say, is more like typing in commands at the REPL, I don't think it should run those commands with `__name__ = '__main__'` since that will break the user's expectation that "that code will only run when I run this file as a script".


---

Comment by dimpase created at 2019-01-15 17:58:11

Replying to [comment:5 embray]:
> I think it's a principle of least astonishment.  We teach that the way to make a Python script into an executable command-line script is to put `if __name__ == '__main__':`.  Most users don't really know what that means or why it works; it's just cargo cult.  While `load()` is not perfectly analogous to `import` and, as you say, is more like typing in commands at the REPL, I don't think it should run those commands with `__name__ = '__main__'` since that will break the user's expectation that "that code will only run when I run this file as a script".

Sorry, but at Python REPL you do have `__name__==__main__`. So you propose to temporarily set `__name__` to something else, then set it back, emulating `import ...`.
So then you'd also need to explain in the docs what `__name__` it is, decide whether it will be a proper import, and so reflected in `sys.modules.keys()`, with a potential for name clashes, or not, and (very confusing, potentially) etc... 

No, I really do not like this. I'd rather document the current behaviour and be done with it.


---

Comment by dimpase created at 2019-01-15 18:01:40

By the way, ipython has a similar facility, a magic `%load`:

```
In [4]: %load p.py

In [5]: # %load p.py
   ...: if __name__ == '__main__':
   ...:     print("blah")
   ...: 
blah

In [6]: 
```


So you propose to deviate from this, too....


---

Comment by embray created at 2019-01-15 18:07:55

Yeah, I think that's bad, actually, in IPython too.  There's no _good_ reason to have `__name__ == '__main__'` in this context.


---

Comment by dimpase created at 2019-01-15 18:13:31

Replying to [comment:8 embray]:
> Yeah, I think that's bad, actually, in IPython too.  There's no _good_ reason to have `__name__ == '__main__'` in this context.

In ipython it's obvious that `%load` is nothing but pasting into REPL, no?
And why would such a pasting do something funny with `__name__`?


---

Comment by embray created at 2019-01-15 18:33:12

I don't think Sage's `load()` function necessarily has to be exactly analogous to IPython's `%load` magic, but I am beginning to come around to your point.

I believe what's really missing here is a way to `import` .sage files as though they were normal Python modules.

I think this would be really easy to do too, so maybe I'll just do that (and accept this documentation note in the meantime).


---

Comment by dimpase created at 2019-01-17 10:21:33

Well, perhaps something like a Python extension to Sage-preparse whatever comes in `import` statements, or indeed a `module_name=` parameter for `load()` and `attach()`, but this is certainly something tricky and of very low priority.


---

Comment by dimpase created at 2019-01-17 10:21:33

Changing status from needs_info to needs_review.


---

Comment by embray created at 2019-01-18 10:41:43

It's actually pretty easy (though ironically it was easier in the old import system).


---

Comment by embray created at 2019-01-18 10:55:24

Created a ticket for this at #27074.  I'm surprised I haven't made one for this already but I don't think I have...


---

Comment by embray created at 2019-01-18 11:00:35

I made a merge request to your merge request with a suggested slight rewording, but if you accept that then positive review otherwise.


---

Comment by embray created at 2019-01-18 11:00:35

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2019-01-18 11:23:08

I don't seem to get anything on gitlab that points to your request - could you tell me where to look?

there is nothing on 
https://gitlab.com/sagemath/sage/merge_requests/5
to do for me, in fact.

But  I just noticed in a merge request in my fork, duh...
All done now.


---

Comment by galois created at 2019-01-18 12:14:36

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by jdemeyer created at 2019-01-18 13:07:16

Replying to [comment:15 dimpase]:
> I don't seem to get anything on gitlab that points to your request - could you tell me where to look?
> 
> there is nothing on 
> https://gitlab.com/sagemath/sage/merge_requests/5
> to do for me, in fact.

This is exactly the reason why I say that the Sage Trac workflow is better than [GitLab](GitLab) or [GitHub](GitHub).


---

Comment by dimpase created at 2019-01-18 13:27:08

Replying to [comment:17 jdemeyer]:
> Replying to [comment:15 dimpase]:
> > I don't seem to get anything on gitlab that points to your request - could you tell me where to look?
> > 
> > there is nothing on 
> > https://gitlab.com/sagemath/sage/merge_requests/5
> > to do for me, in fact.
> 
> This is exactly the reason why I say that the Sage Trac workflow is better than [GitLab](GitLab) or [GitHub](GitHub).

Well, I don't think it is bad - it's just different - you need to know where to look, and this is actually quite intuitive.
And it is better, as there is no need to mess with branches manually.
(unless you work in public/, with all the possible gotcha's).


---

Comment by dimpase created at 2019-01-18 13:29:38

Replying to [comment:18 dimpase]:
> Replying to [comment:17 jdemeyer]:
> > Replying to [comment:15 dimpase]:
> > > I don't seem to get anything on gitlab that points to your request - could you tell me where to look?
> > > 
> > > there is nothing on 
> > > https://gitlab.com/sagemath/sage/merge_requests/5
> > > to do for me, in fact.
> > 
> > This is exactly the reason why I say that the Sage Trac workflow is better than [GitLab](GitLab) or [GitHub](GitHub).
> 
> Well, I don't think it is bad - it's just different - you need to know where to look, and this is actually quite intuitive.
> And it is better, as there is no need to mess with branches manually.
> (unless you work in public/, with all the possible gotcha's).

(And you erased the line I added to my comment, which meant to indicate that even an old demented guy like me, who learned to program with punchcards can still figure it out himself :-P)


---

Comment by jdemeyer created at 2019-01-18 13:41:04

Replying to [comment:18 dimpase]:
> you need to know where to look

Well, I shouldn't need to know where to look. With the Sage Trac workflow, everything is in one place.


---

Comment by dimpase created at 2019-01-18 13:50:27

No, it's not in one place - it's on your computer, on the ticket's author's computer, in different git branches, on trac, on trac's git server, whereas on gitlab it's all there. 
Things can, and do, go wrong in many different ways.

Whereas on gitlab the review and tests (something not quite ready yet) are all done online. It's only cause I'm a very unexperienced user of gitlab, I did ask that question is the 1st place (and I didn't even check my repo for notification - I could have set up an email notifications and got it in mailbox then, totally clear).


---

Comment by embray created at 2019-01-18 14:08:31

Replying to [comment:21 dimpase]:
> Whereas on gitlab the review and tests (something not quite ready yet) are all done online. It's only cause I'm a very unexperienced user of gitlab, I did ask that question is the 1st place (and I didn't even check my repo for notification - I could have set up an email notifications and got it in mailbox then, totally clear).

Yes, normally you'd get an e-mail notification in which case it's clearer.  Though when I made my MR I should have included a reference to yours, and it would have automatically created a backreference as well.


---

Comment by embray created at 2019-01-18 14:09:09

Changing status from needs_work to positive_review.


---

Comment by galois created at 2019-01-26 11:42:30

New commits added to merge request.  I updated the commit SHA-1.  This was a forced push.  New commits:


---

Comment by galois created at 2019-01-26 11:46:56

New commits added to merge request.  I updated the commit SHA-1.  New commits:


---

Comment by dimpase created at 2019-01-26 12:06:33

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2019-01-26 12:06:33

I messed up the gitlab fork by pushing with `-f` into my repo (yes, mine, not that galois guy!)

and the work on this ticket is just gone now :-(

This is obviously a workflow bug that must be somehow fixed...


---

Comment by dimpase created at 2019-01-26 12:28:58

New commits:


---

Comment by dimpase created at 2019-01-26 15:17:28

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2019-01-26 15:17:28

I have cherry-picked the patch from Erik's Sage gitlab fork - fortunately it was still there.


---

Comment by tscrim created at 2019-01-26 20:11:02

It might be good in terms of formatting to do

```diff
-    code is inside an
+    code is inside an::
 
-            if __name__ == "__main__":
+        if __name__ == "__main__":
 
```

(The extra indentation I think is irrelevant.) But this is a trivial thing.


---

Comment by git created at 2019-01-27 07:28:43

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-01-27 07:28:43

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by dimpase created at 2019-01-27 07:29:37

Replying to [comment:29 tscrim]:
> It might be good in terms of formatting to do
> {{{#!diff
> -    code is inside an
> +    code is inside an::
>  
> -            if __name__ == "__main__":
> +        if __name__ == "__main__":
>  
> }}}
> (The extra indentation I think is irrelevant.) But this is a trivial thing.

fixed.


---

Comment by dimpase created at 2019-01-27 07:29:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-01-27 10:55:47

Can you only set this to positive review once you actually are happy with it? This is now the second time that I'm backing out this ticket again after running it on the buildbot


---

Comment by vbraun created at 2019-01-27 10:55:47

Changing status from positive_review to needs_info.


---

Comment by dimpase created at 2019-01-27 11:39:05

I am happy with it. I have no idea whether flipping its status has any bearing on anyone, sorry.


---

Comment by dimpase created at 2019-01-27 11:39:05

Changing status from needs_info to positive_review.


---

Comment by embray created at 2019-01-29 18:05:58

I'm not sure what you did because normally forced pushes work fine.


---

Comment by dimpase created at 2019-01-29 18:19:33

I made a gitlab branch, X, say, and a merge request from it. And then, I force-pushed to the branch X, overwriting whatever changes I made for the merge request, I think.


---

Comment by vbraun created at 2019-02-04 23:02:29

Resolution: fixed
