# Issue 29124: openblas spkg-configure.m4: Fix the check for lapack/cblas functions

Issue created by migration from https://trac.sagemath.org/ticket/29361

Original creator: mkoeppe

Original creation time: 2020-03-18 18:49:50

CC:  dimpase

This line (introduced in #29071):

```
        AC_FC_FREEFORM([AC_FC_FUNC([dgeqrf])])
```

is not executed at all because `AC_FC_FREEFORM` is `AC_DEFUN_ONCE` and is called already in `gfortran/spkg-configure.m4`

As a result:

```
Checking whether SageMath should install SPKG openblas...
checking BLAS library... openblas
checking whether any of gfortran is installed or will be installed as SPKG... no
checking for openblas >= 0.2.20... yes
checking for cblas_dgemm... yes
checking for ... no
checking for lapack... no
configure: no suitable system package found for SPKG openblas
```


In this ticket, we fix the check by avoiding `AC_FC_FUNC` altogether, which is not suitable to be used in a configure that must work if no Fortran compiler is available.

(Factored out from #29104.)



---

Comment by mkoeppe created at 2020-03-18 18:53:26

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-03-18 18:53:26

New commits:


---

Comment by dimpase created at 2020-03-19 03:05:23

good, it works.


---

Comment by dimpase created at 2020-03-19 03:05:23

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-03-19 03:07:06

Thanks.


---

Comment by dimpase created at 2020-03-19 03:25:35

Again, with Fedora there is a subsequent problem installing cblas.pc, but it is fixed by #29082


---

Comment by @mwageringel created at 2020-03-20 21:02:26

This does not seem to work for me with Homebrew. I still get

```
Checking whether SageMath should install SPKG openblas...
checking BLAS library... openblas
checking whether any of gfortran is installed or will be installed as SPKG... no
checking for OPENBLAS... yes
checking for library containing cblas_dgemm... -lopenblas
checking for library containing ... no
checking for LAPACK... no
configure: no suitable system package found for SPKG openblas
```

after a distclean and running

```
./configure \
     LDFLAGS="-L/usr/local/opt/readline/lib -L/usr/local/opt/openblas/lib" \
     CPPFLAGS="-I/usr/local/opt/readline/include -I/usr/local/opt/openblas/include" \
     PKG_CONFIG_PATH="/usr/local/opt/readline/lib/pkgconfig:/usr/local/opt/openblas/lib/pkgconfig"
```



---

Comment by mkoeppe created at 2020-03-20 21:11:14

Did you run bootstrap?


---

Comment by @mwageringel created at 2020-03-20 21:33:14

Ok, running bootstrap solves this. My bad.

I do get an error running bootstrap though, but probably not from this ticket.

```
build/pkgs/iconv/spkg-configure.m4:2: warning: macro 'AM_ICONV' not found in library
...
configure:18231: error: possibly undefined macro: AM_ICONV
      If this token and others are legitimate, please use m4_pattern_allow.
      See the Autoconf documentation.
```



---

Comment by mkoeppe created at 2020-03-20 21:36:44

Need to add to ACLOCAL_PATH.
See `.homebrew-build-env` in #29104


---

Comment by @mwageringel created at 2020-03-20 21:41:13

I thought I had done that, but must have messed it up. All good now. Thank you.


---

Comment by mkoeppe created at 2020-03-22 14:33:10

I still see problems with finding openblas on fedora-32-standard at https://github.com/mkoeppe/sage/runs/524868616 (which has #29082): Does not find openblas, installs its own openblas, then openblas-dependent packages such as iml, gsl fail to compile. This is in contrast to fedora-32-minimal (which has no system openblas) - where iml builds successfully


---

Comment by dimpase created at 2020-03-22 14:56:19

it cannot find openblas, as Fedora does not install openblas.pc

it is out of scope of this ticket. 

It is possible to get around this by either shipping or generating one, though.


---

Comment by mkoeppe created at 2020-03-22 19:30:22

OK I have created #29393 for the Fedora issue.


---

Comment by vbraun created at 2020-03-25 22:48:38

Resolution: fixed
