# Issue 18191: Error checking in sage-spkg

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2015-05-16 07:34:46




---

Comment by vbraun created at 2015-05-16 07:43:57

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-05-16 07:43:57

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2015-05-16 07:43:57

Changing component from PLEASE CHANGE to build.


---

Comment by vbraun created at 2015-05-16 07:43:57

New commits:


---

Comment by git created at 2015-05-16 08:21:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-18 22:45:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-19 08:41:47

Surely, this is wrong:

```
sage-download-file "$PKG_URL" "$PKG_TMP"
if [ $? -ne 0 ]; then
    exit 1
fi
if [ $? -ne 0 ]; then
    # Delete failed download
    rm -f "$PKG_TMP"
```



---

Comment by jdemeyer created at 2015-05-19 08:41:47

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-19 08:44:56

Why this?

```
export PYTHONUNBUFFERED=yes
```


Why is it a problem if output is buffered?

(I am a bit worried about performance implications, since this is passed to _every_ Python script run during the installation of Sage).


---

Comment by jdemeyer created at 2015-05-19 08:46:10

And I also don't understand why you remove some of the

```
if [ $INFO -eq 0 ]; then
```

branches.


---

Comment by git created at 2015-05-19 09:00:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-05-19 09:10:27

The problem with buffering is that network connections might take a while, and the last message on the screen should be flushed to indicate what we are doing. `PYTHONUNBUFFERED` only makes Python stdin/out unbuffered, and we don't print() that much. So I don't see where there could be a performance impact. Even in the worst case (passing the entire build log through Python unbuffered, which we don't do) its unlikely to take a long time compared to actually producing the build log.

The first INFO branch is about checking whether the tarball is already downloaded, which is now done by sage-download file. The second INFO branch is just printing logs, and I moved that to the relevant place.


---

Comment by jdemeyer created at 2015-05-19 12:46:28

Replying to [comment:9 vbraun]:
> The problem with buffering is that network connections might take a while, and the last message on the screen should be flushed to indicate what we are doing.
Of course, that can be done with `sys.stdout.flush()` also...

Regarding this, I also don't think that `sage-spkg` is the best place to put this. I would rather like to put it in `build/deps`, so it also applies to building the Sage library.


---

Comment by vbraun created at 2015-05-19 19:59:05

Not sure I follow, `build/deps` is a Makefile but just setting a make variable is not good enough. You mean use the "export" gnu make extension to change the environment? 

Probably the best solution would be to subclass the stdout stream to a version that always flushes. But sage-download-file is already too many loc. I'm thinking to refactor it into a python package (say, `src/sage_bootstrap`) that deals with downloading and potentially other pre-installation stuff. That then could also be tested nicely with tox to see that it runs on different Python versions. But we should probably fix more urgent issues first.


---

Comment by jdemeyer created at 2015-05-19 20:43:06

Can we just move the buffering stuff to a new ticket and focus on the "more urgent issues first" then?


---

Comment by vbraun created at 2015-05-19 21:44:25

Sure, it just simplifies analyzing problems if the last log message is actually on the screen.


---

Comment by jdemeyer created at 2015-05-20 07:27:33

Replying to [comment:11 vbraun]:
> You mean use the "export" gnu make extension to change the environment? 
Well, I guess we are already assuming `GNU make`. Alternatively, put it in `build/install`.


---

Comment by vbraun created at 2015-05-20 08:29:08

But that is only used during the initial build, and not when running `sage -i <package>`, right?


---

Comment by jdemeyer created at 2015-05-20 08:48:13

Replying to [comment:15 vbraun]:
> But that is only used during the initial build, and not when running `sage -i <package>`, right?

Right indeed.


---

Comment by git created at 2015-05-30 08:12:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-30 08:37:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-05-30 08:57:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-05-30 08:58:09

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-06-03 08:31:49

needs review...


---

Comment by vbraun created at 2015-06-03 08:48:45

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-03 23:22:43

Resolution: fixed
