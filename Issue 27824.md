# Issue 27824: Wrong conversion SR -> RealBallField

Issue created by migration from https://trac.sagemath.org/ticket/28061

Original creator: vdelecroix

Original creation time: 2019-06-26 08:12:49

CC:  chapoton mmezzarobba

The following shows the difference between (certified) numerical integration using arb and symbolic integration followed by real ball evaluation. There is already an error on the 7th digit which shows that there is something very wrong in the conversion `SR -> RealBallField` which should be precise when the symbolic input does not have any floating point value.

```
sage: f = integral(exp(-x^2)*log(x), x, algorithm='sympy')
sage: f
1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
sage: prec = 128
sage: R = RealBallField(prec)
sage: C = ComplexBallField(prec)
sage: a = 5; b = 6
sage: C.integral(lambda x,_: (-x*x).exp()*x.log(), a, b)
[2.21866269568217921271433463e-12 +/- 2.99e-39]
sage: R(f.subs(x=b)) - R(f.subs(x=a))
[2.2186641328845716165938996e-12 +/- 9.28e-38]
```



---

Comment by vdelecroix created at 2019-06-26 10:04:50

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-06-26 10:04:50

New commits:


---

Comment by git created at 2019-06-26 10:05:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-06-26 12:30:37

ok, looks good. Merci


---

Comment by chapoton created at 2019-06-26 12:30:37

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2019-06-26 19:34:22

I'm okay with this fix for now, but I wonder if the actual bug isn't that `sage_to_mpath` converts its input to a real number (essentially) unconditionally, instead of doing it only when there is a coercion.


---

Comment by vdelecroix created at 2019-06-26 21:18:48

Replying to [comment:6 mmezzarobba]:
> I'm okay with this fix for now, but I wonder if the actual bug isn't that `sage_to_mpath` converts its input to a real number (essentially) unconditionally, instead of doing it only when there is a coercion.

This would already be better than the current situation as it would have raised an error with `RBF(erf(5))`. What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.


---

Comment by mmezzarobba created at 2019-06-27 08:45:51

Replying to [comment:7 vdelecroix]:
> What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.

Yes, maybe. It's about the "unreliable evaluation" part of the problem; I agree that it's better if it works instead of raising an error (but real balls should eventually get an erf() method of their own...)


---

Comment by vdelecroix created at 2019-06-27 09:40:37

Replying to [comment:8 mmezzarobba]:
> Replying to [comment:7 vdelecroix]:
> > What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.
> 
> Yes, maybe. It's about the "unreliable evaluation" part of the problem; I agree that it's better if it works instead of raising an error (but real balls should eventually get an erf() method of their own...)

You are right: we should automatically forward to complex balls the unavailable functions. See #28068


---

Comment by vbraun created at 2019-06-27 20:13:55

Resolution: fixed


---

Comment by mmezzarobba created at 2019-09-18 16:34:26

Either this ticket didn't in fact fix the issue, or it reappeared since::

```
sage: ref = ComplexBallField(200)(5).erf().real()
sage: ref
[0.99999999999846254020557196514981165651461662110988194968528 +/- 5.48e-60]
sage: val = RealBallField(128)(erf(5)) # doctested, seee #28061
sage: val
[0.999999999998462540205571965149811656513 +/- 3.10e-40]
sage: val.overlaps(ref)
False
```

Do you remember if you checked the actual enclosure?

More about that shortly at #28517.


---

Comment by vdelecroix created at 2019-09-18 16:37:59

Are you on develop? Here is what I get

```
sage: ref = ComplexBallField(200)(5).erf().real()
sage: val = RealBallField(128)(erf(5))
sage: val.overlaps(ref)
True
```



---

Comment by mmezzarobba created at 2019-09-18 16:58:22

Replying to [comment:12 vdelecroix]:
> Are you on develop? Here is what I get
> {{{
> sage: ref = ComplexBallField(200)(5).erf().real()
> sage: val = RealBallField(128)(erf(5))
> sage: val.overlaps(ref)
> True
> }}}

Interesting. You are right, I wasn't on develop, but I didn't expect the branch I was using to make a difference. I need to double-check. Thanks!
