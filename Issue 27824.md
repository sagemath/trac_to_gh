# Issue 27824: Wrong conversion SR -> RealBallField

archive/issues_027824.json:
```json
{
    "body": "CC:  @fchapoton @mezzarobba\n\nThe following shows the difference between (certified) numerical integration using arb and symbolic integration followed by real ball evaluation. There is already an error on the 7th digit which shows that there is something very wrong in the conversion `SR -> RealBallField` which should be precise when the symbolic input does not have any floating point value.\n\n```\nsage: f = integral(exp(-x^2)*log(x), x, algorithm='sympy')\nsage: f\n1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)\nsage: prec = 128\nsage: R = RealBallField(prec)\nsage: C = ComplexBallField(prec)\nsage: a = 5; b = 6\nsage: C.integral(lambda x,_: (-x*x).exp()*x.log(), a, b)\n[2.21866269568217921271433463e-12 +/- 2.99e-39]\nsage: R(f.subs(x=b)) - R(f.subs(x=a))\n[2.2186641328845716165938996e-12 +/- 9.28e-38]\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/28061\n\n",
    "created_at": "2019-06-26T08:12:49Z",
    "labels": [
        "component: numerical",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.9",
    "title": "Wrong conversion SR -> RealBallField",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27824",
    "user": "https://github.com/videlec"
}
```
CC:  @fchapoton @mezzarobba

The following shows the difference between (certified) numerical integration using arb and symbolic integration followed by real ball evaluation. There is already an error on the 7th digit which shows that there is something very wrong in the conversion `SR -> RealBallField` which should be precise when the symbolic input does not have any floating point value.

```
sage: f = integral(exp(-x^2)*log(x), x, algorithm='sympy')
sage: f
1/2*sqrt(pi)*erf(x)*log(x) - x*hypergeometric((1/2, 1/2), (3/2, 3/2), -x^2)
sage: prec = 128
sage: R = RealBallField(prec)
sage: C = ComplexBallField(prec)
sage: a = 5; b = 6
sage: C.integral(lambda x,_: (-x*x).exp()*x.log(), a, b)
[2.21866269568217921271433463e-12 +/- 2.99e-39]
sage: R(f.subs(x=b)) - R(f.subs(x=a))
[2.2186641328845716165938996e-12 +/- 9.28e-38]
```

Issue created by migration from https://trac.sagemath.org/ticket/28061





---

archive/issue_comments_392566.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-06-26T10:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392566",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_392567.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-06-26T10:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392567",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_392568.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-06-26T10:05:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392568",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_392569.json:
```json
{
    "body": "ok, looks good. Merci",
    "created_at": "2019-06-26T12:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392569",
    "user": "https://github.com/fchapoton"
}
```

ok, looks good. Merci



---

archive/issue_comments_392570.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-06-26T12:30:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392570",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_392571.json:
```json
{
    "body": "I'm okay with this fix for now, but I wonder if the actual bug isn't that `sage_to_mpath` converts its input to a real number (essentially) unconditionally, instead of doing it only when there is a coercion.",
    "created_at": "2019-06-26T19:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392571",
    "user": "https://github.com/mezzarobba"
}
```

I'm okay with this fix for now, but I wonder if the actual bug isn't that `sage_to_mpath` converts its input to a real number (essentially) unconditionally, instead of doing it only when there is a coercion.



---

archive/issue_comments_392572.json:
```json
{
    "body": "Replying to [comment:6 mmezzarobba]:\n> I'm okay with this fix for now, but I wonder if the actual bug isn't that `sage_to_mpath` converts its input to a real number (essentially) unconditionally, instead of doing it only when there is a coercion.\n\n\nThis would already be better than the current situation as it would have raised an error with `RBF(erf(5))`. What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.",
    "created_at": "2019-06-26T21:18:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392572",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:6 mmezzarobba]:
> I'm okay with this fix for now, but I wonder if the actual bug isn't that `sage_to_mpath` converts its input to a real number (essentially) unconditionally, instead of doing it only when there is a coercion.


This would already be better than the current situation as it would have raised an error with `RBF(erf(5))`. What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.



---

archive/issue_comments_392573.json:
```json
{
    "body": "Replying to [comment:7 vdelecroix]:\n> What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.\n\n\nYes, maybe. It's about the \"unreliable evaluation\" part of the problem; I agree that it's better if it works instead of raising an error (but real balls should eventually get an erf() method of their own...)",
    "created_at": "2019-06-27T08:45:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392573",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:7 vdelecroix]:
> What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.


Yes, maybe. It's about the "unreliable evaluation" part of the problem; I agree that it's better if it works instead of raising an error (but real balls should eventually get an erf() method of their own...)



---

archive/issue_comments_392574.json:
```json
{
    "body": "Replying to [comment:8 mmezzarobba]:\n> Replying to [comment:7 vdelecroix]:\n> > What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.\n\n> \n> Yes, maybe. It's about the \"unreliable evaluation\" part of the problem; I agree that it's better if it works instead of raising an error (but real balls should eventually get an erf() method of their own...)\n\n\nYou are right: we should automatically forward to complex balls the unavailable functions. See #28068",
    "created_at": "2019-06-27T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392574",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:8 mmezzarobba]:
> Replying to [comment:7 vdelecroix]:
> > What you propose is a disjoint fix for a disjoint problem: I want `RBF(erf(5))` to suceed not to fail.

> 
> Yes, maybe. It's about the "unreliable evaluation" part of the problem; I agree that it's better if it works instead of raising an error (but real balls should eventually get an erf() method of their own...)


You are right: we should automatically forward to complex balls the unavailable functions. See #28068



---

archive/issue_events_069539.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-06-27T20:13:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/27824#event-69539"
}
```



---

archive/issue_comments_392575.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-06-27T20:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392575",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_392576.json:
```json
{
    "body": "Either this ticket didn't in fact fix the issue, or it reappeared since::\n\n```\nsage: ref = ComplexBallField(200)(5).erf().real()\nsage: ref\n[0.99999999999846254020557196514981165651461662110988194968528 +/- 5.48e-60]\nsage: val = RealBallField(128)(erf(5)) # doctested, seee #28061\nsage: val\n[0.999999999998462540205571965149811656513 +/- 3.10e-40]\nsage: val.overlaps(ref)\nFalse\n```\nDo you remember if you checked the actual enclosure?\n\nMore about that shortly at #28517.",
    "created_at": "2019-09-18T16:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392576",
    "user": "https://github.com/mezzarobba"
}
```

Either this ticket didn't in fact fix the issue, or it reappeared since::

```
sage: ref = ComplexBallField(200)(5).erf().real()
sage: ref
[0.99999999999846254020557196514981165651461662110988194968528 +/- 5.48e-60]
sage: val = RealBallField(128)(erf(5)) # doctested, seee #28061
sage: val
[0.999999999998462540205571965149811656513 +/- 3.10e-40]
sage: val.overlaps(ref)
False
```
Do you remember if you checked the actual enclosure?

More about that shortly at #28517.



---

archive/issue_comments_392577.json:
```json
{
    "body": "Are you on develop? Here is what I get\n\n```\nsage: ref = ComplexBallField(200)(5).erf().real()\nsage: val = RealBallField(128)(erf(5))\nsage: val.overlaps(ref)\nTrue\n```",
    "created_at": "2019-09-18T16:37:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392577",
    "user": "https://github.com/videlec"
}
```

Are you on develop? Here is what I get

```
sage: ref = ComplexBallField(200)(5).erf().real()
sage: val = RealBallField(128)(erf(5))
sage: val.overlaps(ref)
True
```



---

archive/issue_comments_392578.json:
```json
{
    "body": "Replying to [comment:12 vdelecroix]:\n> Are you on develop? Here is what I get\n> \n> ```\n> sage: ref = ComplexBallField(200)(5).erf().real()\n> sage: val = RealBallField(128)(erf(5))\n> sage: val.overlaps(ref)\n> True\n> ```\n\n\nInteresting. You are right, I wasn't on develop, but I didn't expect the branch I was using to make a difference. I need to double-check. Thanks!",
    "created_at": "2019-09-18T16:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27824",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27824#issuecomment-392578",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:12 vdelecroix]:
> Are you on develop? Here is what I get
> 
> ```
> sage: ref = ComplexBallField(200)(5).erf().real()
> sage: val = RealBallField(128)(erf(5))
> sage: val.overlaps(ref)
> True
> ```


Interesting. You are right, I wasn't on develop, but I didn't expect the branch I was using to make a difference. I need to double-check. Thanks!
