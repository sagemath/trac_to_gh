# Issue 17112: R fails with version `GOMP_4.0' not found

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2014-11-15 12:32:18

Compiling R with gcc 4.9.2 can fail because of OpenMP library version mismatch. This is on the "snapperkob" build bot:

```
/home/buildbot/build/sage/snapperkob/sage_git/build/local/var/tmp/sage/build/r-3.1.1.p0/src/bin/exec/R: /usr/lib/x86_64-linux-gnu/libgomp.so.1: version `GOMP_4.0' not found (required by /home/buildbot/build/sage/snapperkob/sage_git/build/local/var/tmp/sage/build/r-3.1.1.p0/src/lib/libR.so)
make[6]: *** [all] Error 1
make[6]: Leaving directory `/home/buildbot/build/sage/snapperkob/sage_git/build/local/var/tmp/sage/build/r-3.1.1.p0/src/src/library/tools'
make[5]: *** [R] Error 1
make[5]: Leaving directory `/home/buildbot/build/sage/snapperkob/sage_git/build/local/var/tmp/sage/build/r-3.1.1.p0/src/src/library'
make[4]: *** [R] Error 1
make[4]: Leaving directory `/home/buildbot/build/sage/snapperkob/sage_git/build/local/var/tmp/sage/build/r-3.1.1.p0/src/src'
make[3]: *** [R] Error 1
make[3]: Leaving directory `/home/buildbot/build/sage/snapperkob/sage_git/build/local/var/tmp/sage/build/r-3.1.1.p0/src'
Error building R.
```



---

Comment by vbraun created at 2014-11-15 12:36:55

New commits:


---

Comment by vbraun created at 2014-11-15 12:36:55

Changing status from new to needs_review.


---

Comment by kcrisman created at 2014-11-20 21:38:33

Hmm, does that mean that anytime anyone uploads a binary for use that one should use `SAGE_FAT_BINARY`?    Or is this necessary in general for any old Sage build?


---

Comment by vbraun created at 2014-11-20 21:44:16

If you want to share binaries then you should set `SAGE_FAT_BINARY=yes` unless you know that the processor and os matches.


---

Comment by kcrisman created at 2014-11-20 21:52:34

Luckily, that is _nearly_ the case with Mac binaries.  But I'll keep it in mind.


---

Comment by git created at 2014-11-21 23:05:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2014-11-21 23:30:23

lgtm


---

Comment by fbissey created at 2014-11-21 23:30:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-11-23 19:59:56

Resolution: fixed


---

Comment by dimpase created at 2015-06-01 09:00:00

On Ubuntu 14.04 ldd will tell you that something is fishy even if Sage (6.8.beta2) builds and passes ptestlong

```
$ ldd R/lib/libR.so
R/lib/libR.so: /usr/lib/x86_64-linux-gnu/libgomp.so.1: version `GOMP_4.0' not found (required by R/lib/libR.so)
        linux-vdso.so.1 =>  (0x00007fff066ae000)
        libf77blas.so.3 => not found
        libatlas.so.3 => not found
        libgfortran.so.3 => /usr/lib/x86_64-linux-gnu/libgfortran.so.3 (0x00007f8b89e3a000)
        libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f8b89b34000)
        libquadmath.so.0 => /usr/lib/x86_64-linux-gnu/libquadmath.so.0 (0x00007f8b898f8000)
        libreadline.so.6 => /lib/x86_64-linux-gnu/libreadline.so.6 (0x00007f8b896b1000)
        libbz2.so.1 => /lib/x86_64-linux-gnu/libbz2.so.1 (0x00007f8b894a1000)
        libz.so.1 => /lib/x86_64-linux-gnu/libz.so.1 (0x00007f8b89288000)
        librt.so.1 => /lib/x86_64-linux-gnu/librt.so.1 (0x00007f8b8907f000)
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f8b88e7b000)
        libgomp.so.1 => /usr/lib/x86_64-linux-gnu/libgomp.so.1 (0x00007f8b88c6c000)
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f8b88a4d000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8b88688000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f8b8a7aa000)
        libgcc_s.so.1 => /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f8b88472000)
        libtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007f8b88248000)
```

Sure this does not look like a real bug, but still...

see also https://groups.google.com/d/msg/sage-devel/X_dVGq5gWoo/FiSnIPzO8FEJ


---

Comment by fbissey created at 2015-06-01 09:11:20

Replying to [comment:11 dimpase]:
> On Ubuntu 14.04 ldd will tell you that something is fishy even if Sage (6.8.beta2) builds and passes ptestlong
> {{{
> $ ldd R/lib/libR.so
> R/lib/libR.so: /usr/lib/x86_64-linux-gnu/libgomp.so.1: version `GOMP_4.0' not found (required by R/lib/libR.so)
>         linux-vdso.so.1 =>  (0x00007fff066ae000)
>         libf77blas.so.3 => not found
>         libatlas.so.3 => not found
>         libgfortran.so.3 => /usr/lib/x86_64-linux-gnu/libgfortran.so.3 (0x00007f8b89e3a000)
>         libm.so.6 => /lib/x86_64-linux-gnu/libm.so.6 (0x00007f8b89b34000)
>         libquadmath.so.0 => /usr/lib/x86_64-linux-gnu/libquadmath.so.0 (0x00007f8b898f8000)
>         libreadline.so.6 => /lib/x86_64-linux-gnu/libreadline.so.6 (0x00007f8b896b1000)
>         libbz2.so.1 => /lib/x86_64-linux-gnu/libbz2.so.1 (0x00007f8b894a1000)
>         libz.so.1 => /lib/x86_64-linux-gnu/libz.so.1 (0x00007f8b89288000)
>         librt.so.1 => /lib/x86_64-linux-gnu/librt.so.1 (0x00007f8b8907f000)
>         libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f8b88e7b000)
>         libgomp.so.1 => /usr/lib/x86_64-linux-gnu/libgomp.so.1 (0x00007f8b88c6c000)
>         libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f8b88a4d000)
>         libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f8b88688000)
>         /lib64/ld-linux-x86-64.so.2 (0x00007f8b8a7aa000)
>         libgcc_s.so.1 => /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f8b88472000)
>         libtinfo.so.5 => /lib/x86_64-linux-gnu/libtinfo.so.5 (0x00007f8b88248000)
> }}}
> Sure this does not look like a real bug, but still...
> 
> see also https://groups.google.com/d/msg/sage-devel/X_dVGq5gWoo/FiSnIPzO8FEJ

Have you gone to a sage shell (`./sage -sh`) before running `ldd`? It looks suspiciously like `LD_LIBRARY_PATH` is not set.


---

Comment by dimpase created at 2015-06-01 10:26:18

Replying to [comment:12 fbissey]:

> Have you gone to a sage shell (`./sage -sh`) before running `ldd`? It looks suspiciously like `LD_LIBRARY_PATH` is not set.

Oops, indeed, you're right. But this means that I can only build Sage on this system using Sage's gcc rather than the system gcc, as libopenmp comes from Sage, and it seems that gcc is the only Sage package it could come from...
(Otherwise R won't build without setting `SAGE_FAT_BINARY=yes`)


---

Comment by fbissey created at 2015-06-01 10:33:36

Yes that must means that your system gcc has been deemed inadequate and sage has been built with its own gcc. Is this a problem?


---

Comment by dimpase created at 2015-06-01 12:15:58

Replying to [comment:14 fbissey]:
> Yes that must means that your system gcc has been deemed inadequate and sage has been built with its own gcc. Is this a problem?

Actually, it's all OK; the system gcc uses system's libopenmp, while Sage's gcc needs a newer version, coming from gcc's spkg. Sorry for barking up the wrong tree.
