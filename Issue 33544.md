# Issue 33544: gcd / lcm do not work on lists of Factorizations

archive/issues_033544.json:
```json
{
    "body": "`gcd( factor(10), factor(15) )` works fine but `gcd( [factor(10), factor(15)] )` returns an error:\n\n\n```\nTypeError: 'int' object is not iterable\n```\n\n\nA similar issue with `lcm` function, although `lcm( [factor(10), factor(15)] )` results in a different error:\n\n\n```\nTypeError: no common canonical parent for objects with parents: 'Integer Ring' and '<class 'sage.structure.factorization_integer.IntegerFactorization'>'\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33781\n\n",
    "created_at": "2022-05-01T17:22:18Z",
    "labels": [
        "number theory",
        "major",
        "bug"
    ],
    "title": "gcd / lcm do not work on lists of Factorizations",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33544",
    "user": "@maxale"
}
```
`gcd( factor(10), factor(15) )` works fine but `gcd( [factor(10), factor(15)] )` returns an error:


```
TypeError: 'int' object is not iterable
```


A similar issue with `lcm` function, although `lcm( [factor(10), factor(15)] )` results in a different error:


```
TypeError: no common canonical parent for objects with parents: 'Integer Ring' and '<class 'sage.structure.factorization_integer.IntegerFactorization'>'
```


Issue created by migration from https://trac.sagemath.org/ticket/33781





---

archive/issue_comments_477479.json:
```json
{
    "body": "Changing component from number theory to linear algebra.",
    "created_at": "2022-05-22T17:30:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477479",
    "user": "@maxale"
}
```

Changing component from number theory to linear algebra.



---

archive/issue_comments_477480.json:
```json
{
    "body": "Changing component from linear algebra to number theory.",
    "created_at": "2022-05-22T17:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477480",
    "user": "@maxale"
}
```

Changing component from linear algebra to number theory.



---

archive/issue_comments_477481.json:
```json
{
    "body": "Ops. It was a misclick.",
    "created_at": "2022-05-22T17:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477481",
    "user": "@maxale"
}
```

Ops. It was a misclick.



---

archive/issue_comments_477482.json:
```json
{
    "body": "\n```diff\n--- a/src/sage/arith/misc.py\n+++ b/src/sage/arith/misc.py\n@@ -1831,7 +1831,10 @@\n     if len(v) == 0:\n         return ZZ(0)\n     if hasattr(v,'universe'):\n-        g = v.universe()(0)\n+        try:\n+            g = v.universe()(0)\n+        except:\n+            g = v[0]\n     else:\n         g = ZZ(0)\n     for vi in v:\n```\n",
    "created_at": "2022-05-25T17:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477482",
    "user": "@sheerluck"
}
```


```diff
--- a/src/sage/arith/misc.py
+++ b/src/sage/arith/misc.py
@@ -1831,7 +1831,10 @@
     if len(v) == 0:
         return ZZ(0)
     if hasattr(v,'universe'):
-        g = v.universe()(0)
+        try:
+            g = v.universe()(0)
+        except:
+            g = v[0]
     else:
         g = ZZ(0)
     for vi in v:
```




---

archive/issue_comments_477483.json:
```json
{
    "body": "\n```diff\n--- a/sage/arith/functions.pyx\n+++ b/sage/arith/functions.pyx\n@@ -17,6 +17,7 @@\n from sage.libs.gmp.mpz cimport mpz_lcm, mpz_set_ui\n from sage.rings.integer cimport Integer\n from sage.structure.coerce cimport coercion_model\n+from sage.structure.factorization_integer import IntegerFactorization\n \n \n def lcm(a, b=None):\n@@ -197,6 +198,8 @@\n             x = <Integer>elt\n         elif isinstance(elt, (int, long)):\n             x = Integer(elt)\n+        elif isinstance(elt, IntegerFactorization):\n+            return LCM_generic(itr, elt)\n         else:\n             # The result is no longer an Integer, pass to generic code\n             a, b = coercion_model.canonical_coercion(z, elt)\n```\n\n\nafter applying both of those patches:\n\n```\nsage: gcd(factor(10), factor(15))\n5\nsage: gcd([factor(10), factor(15)])\n5\nsage: lcm(factor(10), factor(15))\n2 * 3 * 5\nsage: lcm([factor(10), factor(15)])\n2 * 3 * 5\n```\n",
    "created_at": "2022-05-25T18:00:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477483",
    "user": "@sheerluck"
}
```


```diff
--- a/sage/arith/functions.pyx
+++ b/sage/arith/functions.pyx
@@ -17,6 +17,7 @@
 from sage.libs.gmp.mpz cimport mpz_lcm, mpz_set_ui
 from sage.rings.integer cimport Integer
 from sage.structure.coerce cimport coercion_model
+from sage.structure.factorization_integer import IntegerFactorization
 
 
 def lcm(a, b=None):
@@ -197,6 +198,8 @@
             x = <Integer>elt
         elif isinstance(elt, (int, long)):
             x = Integer(elt)
+        elif isinstance(elt, IntegerFactorization):
+            return LCM_generic(itr, elt)
         else:
             # The result is no longer an Integer, pass to generic code
             a, b = coercion_model.canonical_coercion(z, elt)
```


after applying both of those patches:

```
sage: gcd(factor(10), factor(15))
5
sage: gcd([factor(10), factor(15)])
5
sage: lcm(factor(10), factor(15))
2 * 3 * 5
sage: lcm([factor(10), factor(15)])
2 * 3 * 5
```




---

archive/issue_comments_477484.json:
```json
{
    "body": "\n```\nsage: gcd([factor(247), factor(2147), factor(2717), factor(3401)])\n19\nsage: lcm([factor(247), factor(2147), factor(2717), factor(3401)])\n11 * 13 * 19 * 113 * 179\n```\n\nAn additional patch is needed for that:\n\n```diff\n--- a/sage/structure/coerce.pyx\n+++ b/sage/structure/coerce.pyx\n@@ -1390,6 +1390,9 @@\n             except Exception:\n                 self._record_exception()\n \n+        if isinstance(x, type(y)):\n+            return x, y\n+\n         raise TypeError(\"no common canonical parent for objects with parents: '%s' and '%s'\"%(xp, yp))\n```\n",
    "created_at": "2022-05-26T08:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477484",
    "user": "@sheerluck"
}
```


```
sage: gcd([factor(247), factor(2147), factor(2717), factor(3401)])
19
sage: lcm([factor(247), factor(2147), factor(2717), factor(3401)])
11 * 13 * 19 * 113 * 179
```

An additional patch is needed for that:

```diff
--- a/sage/structure/coerce.pyx
+++ b/sage/structure/coerce.pyx
@@ -1390,6 +1390,9 @@
             except Exception:
                 self._record_exception()
 
+        if isinstance(x, type(y)):
+            return x, y
+
         raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
```




---

archive/issue_comments_477485.json:
```json
{
    "body": "Could you please propose your patches for review?",
    "created_at": "2022-07-27T16:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477485",
    "user": "@maxale"
}
```

Could you please propose your patches for review?



---

archive/issue_comments_477486.json:
```json
{
    "body": "Replying to [comment:8 gh-maxale]:\n> Could you please propose your patches for review?\n\nI launched https://github.com/sheerluck/sage/runs/7547359829 in the hope of testing https://github.com/sheerluck/sage/commit/d37c4cb6031556d84d2d940f679939ae979682e8",
    "created_at": "2022-07-27T19:25:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477486",
    "user": "@sheerluck"
}
```

Replying to [comment:8 gh-maxale]:
> Could you please propose your patches for review?

I launched https://github.com/sheerluck/sage/runs/7547359829 in the hope of testing https://github.com/sheerluck/sage/commit/d37c4cb6031556d84d2d940f679939ae979682e8



---

archive/issue_comments_477487.json:
```json
{
    "body": "well, turns out, my childish `if isinstance(x, type(y))` is too general and plain wrong.\n`canonical_coercion` needs work",
    "created_at": "2022-07-28T05:45:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477487",
    "user": "@sheerluck"
}
```

well, turns out, my childish `if isinstance(x, type(y))` is too general and plain wrong.
`canonical_coercion` needs work



---

archive/issue_comments_477488.json:
```json
{
    "body": "I need help with\n\n```\nTypeError: no common canonical parent for objects '11 * 13 * 19' and '13 * 19 * 113'\n  types:\n   '<class 'sage.structure.factorization_integer.IntegerFactorization'>' and\n   '<class 'sage.structure.factorization.Factorization'>'\n  with parents:\n   '<class 'sage.structure.factorization_integer.IntegerFactorization'>' and\n   '<class 'sage.structure.factorization.Factorization'>'\n```\n\nin `canonical_coercion` (coerce.pyx)\n\nI should not just compare `type(x)` and `type(y)` with these types, should I?",
    "created_at": "2022-07-28T06:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477488",
    "user": "@sheerluck"
}
```

I need help with

```
TypeError: no common canonical parent for objects '11 * 13 * 19' and '13 * 19 * 113'
  types:
   '<class 'sage.structure.factorization_integer.IntegerFactorization'>' and
   '<class 'sage.structure.factorization.Factorization'>'
  with parents:
   '<class 'sage.structure.factorization_integer.IntegerFactorization'>' and
   '<class 'sage.structure.factorization.Factorization'>'
```

in `canonical_coercion` (coerce.pyx)

I should not just compare `type(x)` and `type(y)` with these types, should I?



---

archive/issue_comments_477489.json:
```json
{
    "body": "Ok, I fixed coerce.pyx\n\n```diff\n--- a/src/sage/structure/coerce.pyx\n+++ b/src/sage/structure/coerce.pyx\n@@ -1390,9 +1390,11 @@ cdef class CoercionModel:\n             except Exception:\n                 self._record_exception()\n \n+        if hasattr(x, \"universe\") and hasattr(y, \"universe\"):\n+            if x.universe() == y.universe():\n+                if isinstance(x, type(y)):\n+                    return x, y\n+     \n```\n\nAll tests passed.\n\nProblem is this may be a valid patch from python point of view... but **math might not make any sense**.\n\nI squshed it all into a single commit: https://github.com/sheerluck/sage/commit/faf7d9950ae31e727e366e485c23f86266df07ce\n\nIf only there were a way to convert that commit into **Brach** for this ticket... unfortunately, I lack that knowledge.",
    "created_at": "2022-07-28T16:02:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477489",
    "user": "@sheerluck"
}
```

Ok, I fixed coerce.pyx

```diff
--- a/src/sage/structure/coerce.pyx
+++ b/src/sage/structure/coerce.pyx
@@ -1390,9 +1390,11 @@ cdef class CoercionModel:
             except Exception:
                 self._record_exception()
 
+        if hasattr(x, "universe") and hasattr(y, "universe"):
+            if x.universe() == y.universe():
+                if isinstance(x, type(y)):
+                    return x, y
+     
```

All tests passed.

Problem is this may be a valid patch from python point of view... but **math might not make any sense**.

I squshed it all into a single commit: https://github.com/sheerluck/sage/commit/faf7d9950ae31e727e366e485c23f86266df07ce

If only there were a way to convert that commit into **Brach** for this ticket... unfortunately, I lack that knowledge.



---

archive/issue_comments_477490.json:
```json
{
    "body": "Please also check that gcd/lcm work for generators like `lcm( factor(i) for i in (1..5) )`.",
    "created_at": "2022-07-28T16:40:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477490",
    "user": "@maxale"
}
```

Please also check that gcd/lcm work for generators like `lcm( factor(i) for i in (1..5) )`.



---

archive/issue_comments_477491.json:
```json
{
    "body": "\n```\nsage: lcm( factor(i) for i in (1..5) )\n2^2 * 3 * 5\n```\n",
    "created_at": "2022-07-28T16:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477491",
    "user": "@sheerluck"
}
```


```
sage: lcm( factor(i) for i in (1..5) )
2^2 * 3 * 5
```




---

archive/issue_comments_477492.json:
```json
{
    "body": "\n```\nsage: gcd(factor(i) for i in [7, 7 * 2, 7 * 3])\n7\n```\n",
    "created_at": "2022-07-28T16:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477492",
    "user": "@sheerluck"
}
```


```
sage: gcd(factor(i) for i in [7, 7 * 2, 7 * 3])
7
```




---

archive/issue_comments_477493.json:
```json
{
    "body": "Attachment [trac-33781.patch](tarball://root/attachments/some-uuid/ticket33781/trac-33781.patch) by @sheerluck created at 2022-07-29 19:17:50",
    "created_at": "2022-07-29T19:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33544",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33544#issuecomment-477493",
    "user": "@sheerluck"
}
```

Attachment [trac-33781.patch](tarball://root/attachments/some-uuid/ticket33781/trac-33781.patch) by @sheerluck created at 2022-07-29 19:17:50
