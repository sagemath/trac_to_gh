# Issue 33544: gcd / lcm do not work on lists of Factorizations

Issue created by migration from https://trac.sagemath.org/ticket/33781

Original creator: @maxale

Original creation time: 2022-05-01 17:22:18

`gcd( factor(10), factor(15) )` works fine but `gcd( [factor(10), factor(15)] )` returns an error:


```
TypeError: 'int' object is not iterable
```


A similar issue with `lcm` function, although `lcm( [factor(10), factor(15)] )` results in a different error:


```
TypeError: no common canonical parent for objects with parents: 'Integer Ring' and '<class 'sage.structure.factorization_integer.IntegerFactorization'>'
```



---

Comment by @maxale created at 2022-05-22 17:30:40

Changing component from number theory to linear algebra.


---

Comment by @maxale created at 2022-05-22 17:31:46

Changing component from linear algebra to number theory.


---

Comment by @maxale created at 2022-05-22 17:31:46

Ops. It was a misclick.


---

Comment by @sheerluck created at 2022-05-25 17:09:34


```diff
--- a/src/sage/arith/misc.py
+++ b/src/sage/arith/misc.py
@@ -1831,7 +1831,10 @@
     if len(v) == 0:
         return ZZ(0)
     if hasattr(v,'universe'):
-        g = v.universe()(0)
+        try:
+            g = v.universe()(0)
+        except:
+            g = v[0]
     else:
         g = ZZ(0)
     for vi in v:
```



---

Comment by @sheerluck created at 2022-05-25 18:00:57


```diff
--- a/sage/arith/functions.pyx
+++ b/sage/arith/functions.pyx
@@ -17,6 +17,7 @@
 from sage.libs.gmp.mpz cimport mpz_lcm, mpz_set_ui
 from sage.rings.integer cimport Integer
 from sage.structure.coerce cimport coercion_model
+from sage.structure.factorization_integer import IntegerFactorization
 
 
 def lcm(a, b=None):
@@ -197,6 +198,8 @@
             x = <Integer>elt
         elif isinstance(elt, (int, long)):
             x = Integer(elt)
+        elif isinstance(elt, IntegerFactorization):
+            return LCM_generic(itr, elt)
         else:
             # The result is no longer an Integer, pass to generic code
             a, b = coercion_model.canonical_coercion(z, elt)
```


after applying both of those patches:

```
sage: gcd(factor(10), factor(15))
5
sage: gcd([factor(10), factor(15)])
5
sage: lcm(factor(10), factor(15))
2 * 3 * 5
sage: lcm([factor(10), factor(15)])
2 * 3 * 5
```



---

Comment by @sheerluck created at 2022-05-26 08:27:39


```
sage: gcd([factor(247), factor(2147), factor(2717), factor(3401)])
19
sage: lcm([factor(247), factor(2147), factor(2717), factor(3401)])
11 * 13 * 19 * 113 * 179
```

An additional patch is needed for that:

```diff
--- a/sage/structure/coerce.pyx
+++ b/sage/structure/coerce.pyx
@@ -1390,6 +1390,9 @@
             except Exception:
                 self._record_exception()
 
+        if isinstance(x, type(y)):
+            return x, y
+
         raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
```



---

Comment by @maxale created at 2022-07-27 16:01:49

Could you please propose your patches for review?


---

Comment by @sheerluck created at 2022-07-27 19:25:38

Replying to [comment:8 gh-maxale]:
> Could you please propose your patches for review?

I launched https://github.com/sheerluck/sage/runs/7547359829 in the hope of testing https://github.com/sheerluck/sage/commit/d37c4cb6031556d84d2d940f679939ae979682e8


---

Comment by @sheerluck created at 2022-07-28 05:45:43

well, turns out, my childish `if isinstance(x, type(y))` is too general and plain wrong.
`canonical_coercion` needs work


---

Comment by @sheerluck created at 2022-07-28 06:57:08

I need help with

```
TypeError: no common canonical parent for objects '11 * 13 * 19' and '13 * 19 * 113'
  types:
   '<class 'sage.structure.factorization_integer.IntegerFactorization'>' and
   '<class 'sage.structure.factorization.Factorization'>'
  with parents:
   '<class 'sage.structure.factorization_integer.IntegerFactorization'>' and
   '<class 'sage.structure.factorization.Factorization'>'
```

in `canonical_coercion` (coerce.pyx)

I should not just compare `type(x)` and `type(y)` with these types, should I?


---

Comment by @sheerluck created at 2022-07-28 16:02:45

Ok, I fixed coerce.pyx

```diff
--- a/src/sage/structure/coerce.pyx
+++ b/src/sage/structure/coerce.pyx
@@ -1390,9 +1390,11 @@ cdef class CoercionModel:
             except Exception:
                 self._record_exception()
 
+        if hasattr(x, "universe") and hasattr(y, "universe"):
+            if x.universe() == y.universe():
+                if isinstance(x, type(y)):
+                    return x, y
+     
```

All tests passed.

Problem is this may be a valid patch from python point of view... but **math might not make any sense**.

I squshed it all into a single commit: https://github.com/sheerluck/sage/commit/faf7d9950ae31e727e366e485c23f86266df07ce

If only there were a way to convert that commit into **Brach** for this ticket... unfortunately, I lack that knowledge.


---

Comment by @maxale created at 2022-07-28 16:40:11

Please also check that gcd/lcm work for generators like `lcm( factor(i) for i in (1..5) )`.


---

Comment by @sheerluck created at 2022-07-28 16:44:10


```
sage: lcm( factor(i) for i in (1..5) )
2^2 * 3 * 5
```



---

Comment by @sheerluck created at 2022-07-28 16:47:24


```
sage: gcd(factor(i) for i in [7, 7 * 2, 7 * 3])
7
```



---

Attachment
