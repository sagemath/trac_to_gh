# Issue 24524: py3: implement PolyDict.__hash__

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-02-16 17:03:34

This type needs to have an explicit `__hash__` implementation for Python 3.

Although its underlying data structure is a mutable `dict`, it's not intended to be mutated and the API generally disallows this (it still might be better if it used an immutable dict).


---

Comment by embray created at 2018-02-16 17:03:54

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-02-17 01:46:44

Instead of sorting the output, I would use a `frozenset` since that is more inline with the mathematical interpretation. I also feel like that (in general) would be faster than sorting, but I haven't tested. Thoughts?


---

Comment by jdemeyer created at 2018-02-17 12:07:20

Just one detail: `type(x)` is faster than `x.__class__` in Cython code.


---

Comment by chapoton created at 2018-02-19 09:21:49

does not apply


---

Comment by chapoton created at 2018-02-19 09:21:49

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-02-19 13:59:22

Replying to [comment:3 tscrim]:
> Instead of sorting the output, I would use a `frozenset` since that is more inline with the mathematical interpretation. I also feel like that (in general) would be faster than sorting, but I haven't tested. Thoughts?

Yes, I think you have a point there. I'll try it out.


---

Comment by embray created at 2018-02-19 14:01:17

Replying to [comment:4 jdemeyer]:
> Just one detail: `type(x)` is faster than `x.__class__` in Cython code.

Interesting--I'd have just assumed they would optimize that, but I guess technically you can't since many objects' `.__class__` can be overridden.  We're certainly not concerned with that here.


---

Comment by jdemeyer created at 2018-02-19 14:10:24

Replying to [comment:7 embray]:
> Interesting--I'd have just assumed they would optimize that, but I guess technically you can't since many objects' `.__class__` can be overridden.

Indeed. Cython really wants to be Python-compatible. `type()` is a built-in function, so Cython knows exactly what it does. But `.__class__` is just an attribute that a custom (meta?)class can override.

This also explains why you shouldn't do `from six.moves import range` in Cython code: instead of a known builtin, you get a random Python object that Cython cannot do anything with.


---

Comment by git created at 2018-02-19 14:10:30

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-02-19 14:11:18

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-02-19 14:11:18

Rebased and incorporated minor review comments.
----
New commits:


---

Comment by chapoton created at 2018-03-05 10:28:35

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-03-05 10:28:35

ok


---

Comment by vbraun created at 2018-03-06 23:24:15

Resolution: fixed
