# Issue 13968: mpir-2.6.0.p0 fails to build on 32-bit architecure

Issue created by migration from Trac.

Original creator: tmonteil

Original creation time: 2013-02-24 11:55:22

Assignee: GeorgSWeber

CC:  leif jpflori jhpalmieri kcrisman

Keywords: mpir, spkg

The build of sage 5.7 stops during the build of the mpir-2.6.0.p0 package.

spkg/logs/mpir-2.6.0.p0.log is pasted at http://paste.debian.net/237529/

The problem seems related to some 32-bit architecture:

```
Building a 32-bit version of MPIR.
Building MPIR with the C++ interface and (also) static libraries.
** Building with "fat binary" support for 32-bit CPUs **
[...]
configure: error: ABI=32 is not among the following valid choices: standard
Error configuring MPIR (with CFLAGS unset).
```


The machine is running Debian wheezy, Linux 3.2.0-4-686-pae #1 SMP Debian 3.2.35-2 i686 GNU/Linux

I used the following sage variables :
- SAGE_FAT_BINARY='yes'
- SAGE_BINARY_BUILD='yes'
- SAGE_CHECK="yes"
- MAKE="make -j2"

I had no problem building sage-5.6 on the same machine with the same configuration.

Exporting ABI='standard' globally (see http://ask.sagemath.org/question/1713/error-installing-package-mpir-240p6) allows the mpir spkg to be built but then gap-4.5.7.p3 cannot be built since it also uses the ABI variable for which the value 'standard' does not make sense (it only accepts ABI=32 or ABI=64).


---

Comment by leif created at 2013-02-24 14:42:51

Changing keywords from "mpir, spkg" to "mpir spkg ABI 32".


---

Comment by leif created at 2013-02-24 14:46:05

Could you attach `spkg/build/mpir-2.6.0.p0/src/config.log` (of a _failed_ build)?

What does `spkg/build/mpir-2.6.0.p0/src/config.guess` give?


---

Comment by leif created at 2013-02-24 14:48:45

Also `/proc/cpuinfo` might be interesting.


---

Comment by leif created at 2013-02-24 16:41:02

For reference, this is the current logic (originally for MPIR 2.4.0):

```sh

    Linux)
        # MPIR fails to build on 32-bit operating systems running on
        # 64-bit CPUs if CFLAGS happen to contain '-m32' and ABI is
        # *not* set, so we set it here if necessary:
        # (Cf. http://groups.google.com/group/mpir-devel/browse_thread/thread/46ccdc5dfc3485cd#)
        # Note: This code snippet could in principle be moved out of the
        #       Linux branch, but since we already set ABI for other
        #       OSs above (and print an according message), it's here.
        if [ -z "$ABI" ]; then
            echo "int main(){return 0;}" > foo.c
            # Try building and running a 64-bit executable:
            # (Building usually succeeds even on 32-bit systems, unless e.g. a 32-bit
            # CPU is explicitly selected by CFLAGS, while running does not.)
            if $CC $CFLAGS $CFLAG64 -o foo foo.c 2>/dev/null && ./foo 2>/dev/null; then
                # We can run 64-bit executables.
                # Setting ABI=64 shouldn't be necessary, but shouldn't hurt either.
                echo "Building a 64-bit version of MPIR."
                case "`uname -m`" in
                    ppc64) ABI=mode64;;
                    *)     ABI=64
                esac
            elif $CC $CFLAGS $CFLAG32 -o foo foo.c 2>/dev/null && ./foo 2>/dev/null; then
                # We're on a 32-bit OS which cannot run 64-bit executables.
                echo "Building a 32-bit version of MPIR."
                ABI=32
            else
                # It seems the compiler does not support -m32 nor -m64 (e.g.
                # GCC on Itanium rejects both); do not set ABI at all.
                echo "Your compiler does not support '$CFLAG32' nor '$CFLAG64'.  Leaving ABI unset."
            fi
            rm -f foo foo.c
        fi
        ;; # Linux
```


----

If only MPIR (2.6.0) requires `ABI=standard` (rather than `ABI=32`, or left empty/unset), one should presumably only set it for building MPIR:

```
$ unset ABI # (or set it to "32" on 32-bit operating systems running on a 64-bit CPU)
$ make -k # continue as far as possible
$ env ABI=standard ./sage -i spkg/standand/mpir-2.6.0.p0.spkg
$ make # build the rest
```


That way (not _globally_ setting `ABI=standard`) shouldn't cause problems with other spkgs (such as GAP).

We'll see whether we can tweak `spkg-install` (or patch MPIR's `configure`) to not require this manual intervention, although [from a previous thread on a similar problem]

```
On Dec 24, 1:51Â am, Bill Hart <goodwillh...`@`googlemail.com> wrote:
> I agree with William's synopsis. You definitely have 64 bit hardware,
> but a 32 bit OS. It's not that your hardware is "old". I was just
> wrong about that. We support much older hardware than Core 2's!
>
> Note that you will get an approximately 2x speedup of much
> mathematical software if you upgrade your linux to a 64 bit linux. So
> it is worth considering.
```

(SCNR.)


---

Comment by leif created at 2013-02-24 18:16:24

The problem seems to be an upstream bug in MPIR 2.6.0, specifically on *Intel Core* (not Core2 or Core i7) processors, or, more precisely, shows up if `config.guess` yields `core-*` (probably only in conjunction with a 32-bit [Linux] OS, not sure right now).


---

Comment by leif created at 2013-02-24 19:06:47

Changing keywords from "mpir spkg ABI 32" to "mpir spkg ABI standard Intel Core".


---

Comment by leif created at 2013-02-24 19:06:47

It doesn't seem to matter whether the OS is 32- or 64-bit, it's just `core-*` that doesn't allow `ABI=32` nor `ABI=64`.

Note that (on `core-*`) with `ABI=standard`, the _generic C implementation_ is chosen, which is odd.


---

Comment by leif created at 2013-02-24 20:30:11

Replying to [comment:3 leif]:
> Also `/proc/cpuinfo` might be interesting.

Thierry, could you paste the output of `cat /proc/cpuinfo`?

Also, do you happen to have the MPIR build log from Sage 5.6 on the same machine?  (It seems the actual bug had been present in MPIR 2.4.0 and probably older releases as well, so we're curious what has changed inbetween -- probably the output of MPIR's `config.guess`.)


---

Comment by tmonteil created at 2013-02-24 21:04:31

Here are the files.

- /proc/cpuinfo is at http://paste.debian.net/237897/
- spkg/build/mpir-2.6.0.p0/src/config.log is at http://paste.debian.net/237898/
- spkg/build/mpir-2.6.0.p0/src/config.guess is at http://paste.debian.net/237899/

I will see if i can found a log for the sage 5.6 build somewhere.

Note that is is sometimes good to be able to build a 32-bits sage system on a 64-bits machine. For example, i need this when building sage for a live USB key that aims to boot on a widest range of machines.


---

Comment by leif created at 2013-02-24 22:19:03

Replying to [comment:9 tmonteil]:
> Here are the files.

Thanks.

> - /proc/cpuinfo is at http://paste.debian.net/237897/
> - spkg/build/mpir-2.6.0.p0/src/config.log is at http://paste.debian.net/237898/
> - spkg/build/mpir-2.6.0.p0/src/config.guess is at http://paste.debian.net/237899/

Sorry, I meant the output of running `config.guess` (you uploaded the file itself), but I guess it is just `core-pc-linux-gnu`.  (Its output would also be interesting for MPIR 2.4.0, although I doubt it'll differ.)




> I will see if i can found a log for the sage 5.6 build somewhere.

If you still have the Sage 5.6 installation (but not the logs in `spkg/logs/`), you could try reinstalling MPIR 2.4.0 with `./sage -f -s spkg/standard/mpir-2.4.0.p6.spkg`. (`-s` keeps the spkg build directory, where the source code (including `config.guess`) and `config.log` are located, even if no error occurred during the installation.)




> Note that is is sometimes good to be able to build a 32-bits sage system on a 64-bits machine. For example, i need this when building sage for a live USB key that aims to boot on a widest range of machines.

Yes.  Some also prefer 32-bit versions for virtual machines (on 64-bit machines).

The safest way to produce (32-bit) binary dists is still to create them natively, on old machines.  (E.g., `ECM_CONFIGURE=--disable-sse2` is currently necessary for Pentium III and some older CPUs, which I only noticed while actually building on a Pentium III ...)


---

Comment by tmonteil created at 2013-02-25 14:17:39

The output of running config.guess is indeed core-pc-linux-gnu (as well as on the mpir-2.4.0.p6.spkg).

Now, looking back at the logs of the sage-5.6 build, it seems that i built it on a more recent machine (though the live USB key with 32-bit OS was the same). Sorry for having missing that (i am currently oscillating between two different locations every two weeks).

Running ./sage -f -s spkg/standard/mpir-2.4.0.p6.spkg on the older machine does the same bug.


---

Comment by leif created at 2013-02-27 00:22:31

Changing status from new to needs_review.


---

Comment by leif created at 2013-02-27 00:36:49

Thierry, could you give [this preliminary spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/mpir-2.6.0.p1-preliminary.spkg) a try on your Intel Core machine?

Especially *without* `SAGE_FAT_BINARY=yes`, and `ABI` either unset or set to `32`.

(`SAGE_FAT_BINARY=yes` should also work; you could of course try that as well, but the former is more important / interesting.)

And attach the resulting spkg log(s) here...

Thanks.


P.S.:  If you're going to rebuild Sage or other spkgs depending on it with that, you should copy the spkg into `$SAGE_ROOT/spkg/standard/`.  (You can use `env SAGE_UPGRADING=yes make` after doing so, in order to rebuild all dependent spkgs as well, although this is likely to take quite some time.)


---

Comment by leif created at 2013-02-27 01:11:30

Replying to [ticket:14172 leif]:
> === mpir-2.6.0.p1 (Leif Leonhardy, February 26th 2013) ===
>  * #14172: MPIR 2.6.0 (but also older versions) fails to configure on Intel
>    "Core" CPUs (expecting ABI to be "standard" rather than "32", which is
>    just a symptom).  (Similar for Pentium4 Prescott.)
>    We currently only patch (the generated) `configure` (after another patch
>    to it and its source files has been applied), rather than [also]
>    `aclocal.m4` and `configure.in`.

`s/aclocal.m4/acinclude.m4/`


---

Comment by leif created at 2013-02-27 03:38:10

[Note to myself:]  I'll upload a slightly fixed spkg (also patching `acinclude.m4` and `configure.in` later<sup>TM</sup>, presumably tomorrow.  (I missed some places when manually patching [just] `configure`, but these are minor _I think<sup>TM</sup>_.)


---

Comment by leif created at 2013-02-27 07:47:32

Diff between the `.p1` and the `.p0`.  For reference / review only.


---

Attachment

Replying to [comment:15 leif]:
> [Note to myself:]  I'll upload a slightly fixed spkg (also patching `acinclude.m4` and `configure.in` later<sup>TM</sup>, presumably tomorrow.  (I missed some places when manually patching [just] `configure`, but these are minor _I think<sup>TM</sup>_.)

Done.  Note: [New spkg](http://boxen.math.washington.edu/home/leif/Sage/spkgs/mpir-2.6.0.p1.spkg) also has a new name (`-preliminary` dropped).


---

Comment by leif created at 2013-02-27 08:18:57

Changing keywords from "mpir spkg ABI standard Intel Core" to "mpir spkg ABI standard Intel Core Pentium4 Prescott".


---

Comment by tmonteil created at 2013-02-27 11:17:36

Hi Leif, i am back in Montpellier and the machine is still in Paris. I will try to find a similar machine here or ask someone to bring it back this week-end.


---

Comment by leif created at 2013-02-28 18:34:54

Just in case you intend to support / fix the use of `SAGE64` on Linux, it would be nice if you based your spkg on this one... ;-)

(And cc me if you open a ticket for that; I'll otherwise probably do so.)


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Attachment


---

Comment by tmonteil created at 2013-02-28 22:52:39

Hi Leif, i found a Core Duo at the lab, and did the tests you asked on the same 32-bit OS, and all possibilities lead to a build without error with mpir-2.6.0.p1.spkg. FAT means that i exported SAGE_FAT_BINARY='yes', ABI32 means i exported ABI='32'. I also tried exporting SAGE_CHECK='yes' (with no other options exported) and the tests went fine.


---

Comment by leif created at 2013-03-02 18:59:25

Replying to [comment:22 tmonteil]:
> Hi Leif, i found a Core Duo at the lab, and did the tests you asked on the same 32-bit OS, and all possibilities lead to a build without error with mpir-2.6.0.p1.spkg. FAT means that i exported SAGE_FAT_BINARY='yes', ABI32 means i exported ABI='32'. I also tried exporting SAGE_CHECK='yes' (with no other options exported) and the tests went fine.

So do we have a positive review?


---

Comment by tmonteil created at 2013-03-05 20:19:12

All tests passed on Core Duo, so it is OK for me. It could be nice to have it tested on some prescott cpu as well. Also, i let someone who is used in maintaining this spkg to check whether the patch is ok on the code side and give a positive review.


---

Comment by leif created at 2013-03-27 12:21:31

Replying to [comment:24 tmonteil]:
> All tests passed on Core Duo, so it is OK for me. It could be nice to have it tested on some prescott cpu as well. Also, i let someone who is used in maintaining this spkg to check whether the patch is ok on the code side and give a positive review.

Ping...

(Yesterday again someone reported running into this on sage-release.)


---

Comment by jpflori created at 2013-03-27 12:38:34

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2013-03-27 12:38:34

Looks fine and build on a my (non problematic) system.

Just a little remark, I think you should tag the commit yourself as this is automatically done by Jeroen's scripts, though I think they are smart enough to realize you did it, so no worry.


---

Comment by leif created at 2013-03-27 13:19:10

Thanks for the review.

Replying to [comment:26 jpflori]:
> Just a little remark, I think you should tag the commit yourself as this is automatically done by Jeroen's scripts, though I think they are smart enough to realize you did it, so no worry.

I prefer tagging the changesets myself (and I'd appreciate if others did as well -- some do); doing so makes it easier to base spkgs on previous ones which haven't been merged yet (otherwise tags may even be missing).

The merger script shouldn't do anything with spkgs unless necessary, i.e., it should only perform sanity checks, and in case some of these fail, automagically modify the spkg if appropriate (which includes adding a missing revision tag).


---

Comment by jdemeyer created at 2013-03-28 17:59:20

Resolution: fixed


---

Comment by tmonteil created at 2019-08-27 19:45:19

Changing keywords from "mpir spkg ABI standard Intel Core Pentium4 Prescott" to "mpir, spkg, ABI, standard, Intel, Core, Pentium4, Prescott, sdl".
