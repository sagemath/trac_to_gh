# Issue 24330: Python bugs with tarfile structure and permissions

Issue created by migration from https://trac.sagemath.org/ticket/24567

Original creator: embray

Original creation time: 2018-01-19 11:28:16

I first noted this in #24389 but wasn't exactly sure at the time what the problem was.  Now I've seen this same problem again with pytz and have investigated more.

It seems at some point, some Python source package creation tool (I'm not sure which) has started creating some apparently bogus (but still readable) tar files.  This was not previously the case.  For example, `entrypoints-0.2.2.tar.gz` looks normal:


```
entrypoints-0.2.2/
entrypoints-0.2.2/.gitignore
entrypoints-0.2.2/.travis.yml
entrypoints-0.2.2/LICENSE
entrypoints-0.2.2/doc/
entrypoints-0.2.2/doc/Makefile
entrypoints-0.2.2/doc/api.rst
entrypoints-0.2.2/doc/conf.py
entrypoints-0.2.2/doc/index.rst
entrypoints-0.2.2/entrypoints.py
entrypoints-0.2.2/flit.ini
entrypoints-0.2.2/tests/
entrypoints-0.2.2/tests/__init__.py
entrypoints-0.2.2/tests/samples/
entrypoints-0.2.2/tests/samples/packages1/
entrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/
entrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/EGG-INFO/
entrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/EGG-INFO/entry_points.txt
entrypoints-0.2.2/tests/samples/packages1/foo-0.1.dist-info/
entrypoints-0.2.2/tests/samples/packages1/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.2/tests/samples/packages2/
entrypoints-0.2.2/tests/samples/packages2/bar-0.2.egg-info/
entrypoints-0.2.2/tests/samples/packages2/bar-0.2.egg-info/entry_points.txt
entrypoints-0.2.2/tests/samples/packages2/foo-0.1.1.dist-info/
entrypoints-0.2.2/tests/samples/packages2/foo-0.1.1.dist-info/entry_points.txt
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/entry_points.txt
entrypoints-0.2.2/tests/samples/packages3/
entrypoints-0.2.2/tests/samples/packages3/foo-0.1.dist-info/
entrypoints-0.2.2/tests/samples/packages3/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.2/tests/test_entrypoints.py
```


However, `entrypoints-0.2.3.tar.gz` looks odd:


```
entrypoints-0.2.3/.gitignore
entrypoints-0.2.3/.travis.yml
entrypoints-0.2.3/LICENSE
entrypoints-0.2.3/doc/Makefile
entrypoints-0.2.3/doc/api.rst
entrypoints-0.2.3/doc/conf.py
entrypoints-0.2.3/doc/index.rst
entrypoints-0.2.3/entrypoints.py
entrypoints-0.2.3/flit.ini
entrypoints-0.2.3/tests/__init__.py
entrypoints-0.2.3/tests/samples/packages1/baz-0.3.egg/EGG-INFO/entry_points.txt
entrypoints-0.2.3/tests/samples/packages1/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.3/tests/samples/packages2/bar-0.2.egg-info/entry_points.txt
entrypoints-0.2.3/tests/samples/packages2/foo-0.1.1.dist-info/entry_points.txt
entrypoints-0.2.3/tests/samples/packages2/qux-0.4.egg
entrypoints-0.2.3/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/entry_points.txt
entrypoints-0.2.3/tests/samples/packages3/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.3/tests/test_entrypoints.py
entrypoints-0.2.3/setup.py
entrypoints-0.2.3/PKG-INFO
```


Most notably, it does not contain explicit entries for the directories.  This strikes me as fishy, but I don't think it's actually incorrect as far as the tar format is concerned.  It's still unusual though, and different from what GNU tar would do.

What's worse, however, is that the `tarfile` module is buggy in how it handles such files.  When an _explicit_ directory entry exists, it uses the method `TarFile.makedir` which creates the directory with "safe" permissions (`0o700`), and then later applies the requested permissions and ownership to the directory (our tarfile wrapper ensures that the user's umask is applied in this case).

_However_, if there are no explicit entries for the directories a file is in, when it goes to try to extract that file it happily calls `os.makedirs` for the file's entire directory tree, using the default mode, and never applies any fixups to the directories.  If the default permissions are too permissive this can cause builds to break.


---

Comment by embray created at 2018-01-19 11:30:27

In fairness the behavior of `tarfile` might not be a bug, insofar as if there are no directory entries in the tarfile then it has no way of knowing what permissions/ownership to apply to the directories, so it just takes the user's current defaults.

That's still a bit sketchy though, and I want to find out what tool is making these strange tarballs...


---

Comment by embray created at 2018-01-19 13:17:27

I'm not sure why, but there's also some funny business going on in Cygwin with permissions, because even if I set umask restrictively the default permissions it's creating directories with is not obeying the umask.  This could be a problem related to recursively applied Windows ACLs overriding the permissions applied by Cygwin but I'm not sure--it works if I explicitly set the correct permissions on the directory.

I think a reasonable workaround in Sage is to make sure, at least, that the user's umask is applied correctly to the top-level source directory of a package (regardless of what permissions were set when it was first extracted).


---

Comment by embray created at 2018-01-19 13:30:34

Changing status from new to needs_review.


---

Comment by embray created at 2018-01-19 13:30:34

Kind of a hack but does the trick.
----
New commits:


---

Comment by jdemeyer created at 2018-01-19 21:11:39

Just a comment: the permissions of the extracted tarball should not influence the installation. I'm pretty sure that it doesn't matter for autotools packages. However, for some packages it might matter, but I consider that a bug.


---

Comment by embray created at 2018-01-22 13:46:28

Replying to [comment:4 jdemeyer]:
> Just a comment: the permissions of the extracted tarball should not influence the installation. I'm pretty sure that it doesn't matter for autotools packages. However, for some packages it might matter, but I consider that a bug.

It does for Python packages that import the package itself during setup--then your patch to Python complains that the permissions are not restrictive enough and refuses to add `''` to `sys.path`, preventing this from working.  I have mixed feelings about that, but it is an example where the permissions do affect installation and is not a bug.


---

Comment by jdemeyer created at 2018-01-23 13:34:46

Speaking of extracting tarballs: just today I encountered again an issue with `pip` which comes up now and then: if `pip` installs something, the timestamp of the installed file is taken from the _source_ file. With autotools on the other hand, the timestamp of the installed files equals the _installation time_.

The autotools behaviour makes a lot more sense because of dependency checking: if you (re)install a package, you typically want to rebuild everything depending on that package. A typical example of breakage is Cython packages which depend on other Cython packages. There is also a workaround for this issue at the end of `build/pkgs/numpy/spkg-install`

So it might be a good idea to just update the timestamp of the files in the extracted tarball to the current time.


---

Comment by jdemeyer created at 2018-01-23 14:00:39

Now about this ticket: if you want to be safe, wouldn't it be better to create the directory with the correct permissions (or even create all directories this way)?


---

Comment by jdemeyer created at 2018-01-25 18:01:52

Changing status from needs_review to needs_info.


---

Comment by embray created at 2018-01-26 16:24:54

Well, over in #20481 we agreed that applying the user's umask to the files was the most "correct" approach, but as this issue demonstrates, there are cases where if the user's umask has certain values the build will simply fail even if it were otherwise correctly applied to all the directories.

So in that case, simply for the purpose of building Sage's packages, it probably makes sense to just force a mask like `077` and leave it at that.  Agreed on the timestamps as well; I need to double-check what Python's `TarFile` does by default there.

Hopefully there are no packages that somehow depend on files in the source tarball having a certain timestamp... That would be ugly.


---

Comment by embray created at 2018-01-26 16:25:02

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2018-01-26 16:47:16

Replying to [comment:9 embray]:
> Agreed on the timestamps as well; I need to double-check what Python's `TarFile` does by default there.

Tarballs should preserve timestamps by default.

The problem is really in distutils: when it copies files, it always preserves the timestamp. Ideally, we should fix this in distutils too. Should we report this to https://bugs.python.org/ or some different bug tracker?

But changing the timestamp of the extracted tarballs would fix all cases, even for non-Python packages (even though I don't know any with this bug).


---

Comment by embray created at 2018-01-30 17:36:32

I think the issue of timestamps is pretty separate from this, but it should be easy enough to fix as long as I'm tinkering...


---

Comment by git created at 2018-02-02 11:45:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-02 11:46:06

Changing status from needs_work to needs_review.


---

Comment by embray created at 2018-02-02 15:57:44

I think the problems that some of the patchbots are having with this are due to a bug in the patchbot actually (which I've since fixed but haven't restarted those patchbots yet...)


---

Comment by jdemeyer created at 2018-02-02 16:29:08

`0o077` is a strange choice for umask. I think that `0o022` would make a lot more sense.


---

Comment by embray created at 2018-02-02 16:41:24

022 is the typical default.  I could go with that.  I just figured it couldn't hurt to be maximally restrictive either.  Up to you.


---

Comment by jdemeyer created at 2018-02-02 16:48:19

You're keeping the "extraction time" too literally. For dependency checking purposes, it is important that all files are extracted with an _identical_ timestamp. Otherwise you get stuff like

```
[singular-4.1.0p3.p1] make[4]: Entering directory '/usr/local/src/sage-config/local/var/tmp/sage/build/singular-4.1.0p3.p1/src/resources'
[singular-4.1.0p3.p1]  cd . && /bin/bash /usr/local/src/sage-config/local/var/tmp/sage/build/singular-4.1.0p3.p1/src/build-aux/missing automake-1.15 --foreign
[singular-4.1.0p3.p1] aclocal.m4:17: warning: this file was generated for autoconf 2.69.
[singular-4.1.0p3.p1] You have another version of autoconf.  It may work, but is not guaranteed to.
[singular-4.1.0p3.p1] If you have problems, you may need to regenerate the build system entirely.
[singular-4.1.0p3.p1] To do so, use the procedure documented by the package, typically 'autoreconf'.
[singular-4.1.0p3.p1] configure.ac:9: error: version mismatch.  This is Automake 1.15.1,
[singular-4.1.0p3.p1] configure.ac:9: but the definition used by this AM_INIT_AUTOMAKE
[singular-4.1.0p3.p1] configure.ac:9: comes from Automake 1.15.  You should recreate
[singular-4.1.0p3.p1] configure.ac:9: aclocal.m4 with aclocal and run automake again.
[singular-4.1.0p3.p1] WARNING: 'automake-1.15' is probably too old.
[singular-4.1.0p3.p1]          You should only need it if you modified 'Makefile.am' or
[singular-4.1.0p3.p1]          'configure.ac' or m4 files included by 'configure.ac'.
[singular-4.1.0p3.p1]          The 'automake' program is part of the GNU Automake package:
[singular-4.1.0p3.p1]          <http://www.gnu.org/software/automake>
[singular-4.1.0p3.p1]          It also requires GNU Autoconf, GNU m4 and Perl in order to run:
[singular-4.1.0p3.p1]          <http://www.gnu.org/software/autoconf>
[singular-4.1.0p3.p1]          <http://www.gnu.org/software/m4/>
[singular-4.1.0p3.p1]          <http://www.perl.org/>
[singular-4.1.0p3.p1] Makefile:425: recipe for target 'Makefile.in' failed
```



---

Comment by jdemeyer created at 2018-02-02 16:48:19

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-02-02 16:51:44

Replying to [comment:17 embray]:
> I just figured it couldn't hurt to be maximally restrictive either.

It hurts because it restricts an installation to a single user. We want Sage to work in multi-user installations.


---

Comment by embray created at 2018-02-05 09:59:42

I'm well aware of that, but this should have no effect on the permissions applied when the files are installed, but I guess it depends in part on the installation mechanism.


---

Comment by embray created at 2018-02-05 10:00:26

Ugh, okay.


---

Comment by git created at 2018-02-05 10:18:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-02-05 10:18:35

This should do it, but let's see if it fixes the patchbots.


---

Comment by embray created at 2018-02-05 10:18:35

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-05 11:01:50

Why not set `self._extracted_mtime = time.time()` in `__init__()`? It seems overcomplicated to first initialize it as `None` and then set it to `time.time()` later.


---

Comment by embray created at 2018-02-05 13:00:08

Well, this time the patchbot failed, but due to an unrelated bug with the patchbot itself in testing "unsafe tickets".


---

Comment by embray created at 2018-02-05 13:00:49

That's what I did at first, and in practice it would probably be fine.  But in theory you can instantiate a `Tarball` instance and then extract it multiple times at different times.


---

Comment by jdemeyer created at 2018-02-05 15:28:04

I'm writing a reviewer commit...


---

Comment by jdemeyer created at 2018-02-05 16:01:35

I created https://bugs.python.org/issue32773 for the timestamp issue.


---

Comment by jdemeyer created at 2018-02-05 16:13:55

Style comment: I often see you adding blank lines between a method docstring and the code. I checked [PEP 257](https://www.python.org/dev/peps/pep-0257/) and it only says to do that after the docstring of a class.


---

Comment by jdemeyer created at 2018-02-05 16:16:44

New commits:


---

Comment by embray created at 2018-02-06 12:46:01

This is basically ignoring the point I just made for why I did it the way I did. But as far as how this code is actually used it's fine--it's not like anyone is instantiating a `SageBaseTarFile` and extracting from it multiple times at different times, so fine. But it seems wrong to me.


---

Comment by embray created at 2018-02-06 12:48:27

Replying to [comment:29 jdemeyer]:
> Style comment: I often see you adding blank lines between a method docstring and the code. I checked [PEP 257](https://www.python.org/dev/peps/pep-0257/) and it only says to do that after the docstring of a class.

Ugh, I hate that convention. I personally find it difficult to visually separate the end of the docstring from the beginning of the function.  Syntax highlighting helps there, but only somewhat.  It's a minor thing though.


---

Comment by embray created at 2018-02-06 12:49:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-09 23:48:18

Resolution: fixed
