# Issue 24330: Python bugs with tarfile structure and permissions

archive/issues_024330.json:
```json
{
    "body": "I first noted this in #24389 but wasn't exactly sure at the time what the problem was.  Now I've seen this same problem again with pytz and have investigated more.\n\nIt seems at some point, some Python source package creation tool (I'm not sure which) has started creating some apparently bogus (but still readable) tar files.  This was not previously the case.  For example, `entrypoints-0.2.2.tar.gz` looks normal:\n\n\n```\nentrypoints-0.2.2/\nentrypoints-0.2.2/.gitignore\nentrypoints-0.2.2/.travis.yml\nentrypoints-0.2.2/LICENSE\nentrypoints-0.2.2/doc/\nentrypoints-0.2.2/doc/Makefile\nentrypoints-0.2.2/doc/api.rst\nentrypoints-0.2.2/doc/conf.py\nentrypoints-0.2.2/doc/index.rst\nentrypoints-0.2.2/entrypoints.py\nentrypoints-0.2.2/flit.ini\nentrypoints-0.2.2/tests/\nentrypoints-0.2.2/tests/__init__.py\nentrypoints-0.2.2/tests/samples/\nentrypoints-0.2.2/tests/samples/packages1/\nentrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/\nentrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/EGG-INFO/\nentrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/EGG-INFO/entry_points.txt\nentrypoints-0.2.2/tests/samples/packages1/foo-0.1.dist-info/\nentrypoints-0.2.2/tests/samples/packages1/foo-0.1.dist-info/entry_points.txt\nentrypoints-0.2.2/tests/samples/packages2/\nentrypoints-0.2.2/tests/samples/packages2/bar-0.2.egg-info/\nentrypoints-0.2.2/tests/samples/packages2/bar-0.2.egg-info/entry_points.txt\nentrypoints-0.2.2/tests/samples/packages2/foo-0.1.1.dist-info/\nentrypoints-0.2.2/tests/samples/packages2/foo-0.1.1.dist-info/entry_points.txt\nentrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg\nentrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/\nentrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/\nentrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/entry_points.txt\nentrypoints-0.2.2/tests/samples/packages3/\nentrypoints-0.2.2/tests/samples/packages3/foo-0.1.dist-info/\nentrypoints-0.2.2/tests/samples/packages3/foo-0.1.dist-info/entry_points.txt\nentrypoints-0.2.2/tests/test_entrypoints.py\n```\n\n\nHowever, `entrypoints-0.2.3.tar.gz` looks odd:\n\n\n```\nentrypoints-0.2.3/.gitignore\nentrypoints-0.2.3/.travis.yml\nentrypoints-0.2.3/LICENSE\nentrypoints-0.2.3/doc/Makefile\nentrypoints-0.2.3/doc/api.rst\nentrypoints-0.2.3/doc/conf.py\nentrypoints-0.2.3/doc/index.rst\nentrypoints-0.2.3/entrypoints.py\nentrypoints-0.2.3/flit.ini\nentrypoints-0.2.3/tests/__init__.py\nentrypoints-0.2.3/tests/samples/packages1/baz-0.3.egg/EGG-INFO/entry_points.txt\nentrypoints-0.2.3/tests/samples/packages1/foo-0.1.dist-info/entry_points.txt\nentrypoints-0.2.3/tests/samples/packages2/bar-0.2.egg-info/entry_points.txt\nentrypoints-0.2.3/tests/samples/packages2/foo-0.1.1.dist-info/entry_points.txt\nentrypoints-0.2.3/tests/samples/packages2/qux-0.4.egg\nentrypoints-0.2.3/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/entry_points.txt\nentrypoints-0.2.3/tests/samples/packages3/foo-0.1.dist-info/entry_points.txt\nentrypoints-0.2.3/tests/test_entrypoints.py\nentrypoints-0.2.3/setup.py\nentrypoints-0.2.3/PKG-INFO\n```\n\n\nMost notably, it does not contain explicit entries for the directories.  This strikes me as fishy, but I don't think it's actually incorrect as far as the tar format is concerned.  It's still unusual though, and different from what GNU tar would do.\n\nWhat's worse, however, is that the `tarfile` module is buggy in how it handles such files.  When an *explicit* directory entry exists, it uses the method `TarFile.makedir` which creates the directory with \"safe\" permissions (`0o700`), and then later applies the requested permissions and ownership to the directory (our tarfile wrapper ensures that the user's umask is applied in this case).\n\n*However*, if there are no explicit entries for the directories a file is in, when it goes to try to extract that file it happily calls `os.makedirs` for the file's entire directory tree, using the default mode, and never applies any fixups to the directories.  If the default permissions are too permissive this can cause builds to break.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24567\n\n",
    "created_at": "2018-01-19T11:28:16Z",
    "labels": [
        "component: build",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Python bugs with tarfile structure and permissions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24330",
    "user": "https://github.com/embray"
}
```
I first noted this in #24389 but wasn't exactly sure at the time what the problem was.  Now I've seen this same problem again with pytz and have investigated more.

It seems at some point, some Python source package creation tool (I'm not sure which) has started creating some apparently bogus (but still readable) tar files.  This was not previously the case.  For example, `entrypoints-0.2.2.tar.gz` looks normal:


```
entrypoints-0.2.2/
entrypoints-0.2.2/.gitignore
entrypoints-0.2.2/.travis.yml
entrypoints-0.2.2/LICENSE
entrypoints-0.2.2/doc/
entrypoints-0.2.2/doc/Makefile
entrypoints-0.2.2/doc/api.rst
entrypoints-0.2.2/doc/conf.py
entrypoints-0.2.2/doc/index.rst
entrypoints-0.2.2/entrypoints.py
entrypoints-0.2.2/flit.ini
entrypoints-0.2.2/tests/
entrypoints-0.2.2/tests/__init__.py
entrypoints-0.2.2/tests/samples/
entrypoints-0.2.2/tests/samples/packages1/
entrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/
entrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/EGG-INFO/
entrypoints-0.2.2/tests/samples/packages1/baz-0.3.egg/EGG-INFO/entry_points.txt
entrypoints-0.2.2/tests/samples/packages1/foo-0.1.dist-info/
entrypoints-0.2.2/tests/samples/packages1/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.2/tests/samples/packages2/
entrypoints-0.2.2/tests/samples/packages2/bar-0.2.egg-info/
entrypoints-0.2.2/tests/samples/packages2/bar-0.2.egg-info/entry_points.txt
entrypoints-0.2.2/tests/samples/packages2/foo-0.1.1.dist-info/
entrypoints-0.2.2/tests/samples/packages2/foo-0.1.1.dist-info/entry_points.txt
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/
entrypoints-0.2.2/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/entry_points.txt
entrypoints-0.2.2/tests/samples/packages3/
entrypoints-0.2.2/tests/samples/packages3/foo-0.1.dist-info/
entrypoints-0.2.2/tests/samples/packages3/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.2/tests/test_entrypoints.py
```


However, `entrypoints-0.2.3.tar.gz` looks odd:


```
entrypoints-0.2.3/.gitignore
entrypoints-0.2.3/.travis.yml
entrypoints-0.2.3/LICENSE
entrypoints-0.2.3/doc/Makefile
entrypoints-0.2.3/doc/api.rst
entrypoints-0.2.3/doc/conf.py
entrypoints-0.2.3/doc/index.rst
entrypoints-0.2.3/entrypoints.py
entrypoints-0.2.3/flit.ini
entrypoints-0.2.3/tests/__init__.py
entrypoints-0.2.3/tests/samples/packages1/baz-0.3.egg/EGG-INFO/entry_points.txt
entrypoints-0.2.3/tests/samples/packages1/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.3/tests/samples/packages2/bar-0.2.egg-info/entry_points.txt
entrypoints-0.2.3/tests/samples/packages2/foo-0.1.1.dist-info/entry_points.txt
entrypoints-0.2.3/tests/samples/packages2/qux-0.4.egg
entrypoints-0.2.3/tests/samples/packages2/qux-0.4.egg.unpacked/EGG-INFO/entry_points.txt
entrypoints-0.2.3/tests/samples/packages3/foo-0.1.dist-info/entry_points.txt
entrypoints-0.2.3/tests/test_entrypoints.py
entrypoints-0.2.3/setup.py
entrypoints-0.2.3/PKG-INFO
```


Most notably, it does not contain explicit entries for the directories.  This strikes me as fishy, but I don't think it's actually incorrect as far as the tar format is concerned.  It's still unusual though, and different from what GNU tar would do.

What's worse, however, is that the `tarfile` module is buggy in how it handles such files.  When an *explicit* directory entry exists, it uses the method `TarFile.makedir` which creates the directory with "safe" permissions (`0o700`), and then later applies the requested permissions and ownership to the directory (our tarfile wrapper ensures that the user's umask is applied in this case).

*However*, if there are no explicit entries for the directories a file is in, when it goes to try to extract that file it happily calls `os.makedirs` for the file's entire directory tree, using the default mode, and never applies any fixups to the directories.  If the default permissions are too permissive this can cause builds to break.

Issue created by migration from https://trac.sagemath.org/ticket/24567





---

archive/issue_comments_340247.json:
```json
{
    "body": "In fairness the behavior of `tarfile` might not be a bug, insofar as if there are no directory entries in the tarfile then it has no way of knowing what permissions/ownership to apply to the directories, so it just takes the user's current defaults.\n\nThat's still a bit sketchy though, and I want to find out what tool is making these strange tarballs...",
    "created_at": "2018-01-19T11:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340247",
    "user": "https://github.com/embray"
}
```

In fairness the behavior of `tarfile` might not be a bug, insofar as if there are no directory entries in the tarfile then it has no way of knowing what permissions/ownership to apply to the directories, so it just takes the user's current defaults.

That's still a bit sketchy though, and I want to find out what tool is making these strange tarballs...



---

archive/issue_comments_340248.json:
```json
{
    "body": "I'm not sure why, but there's also some funny business going on in Cygwin with permissions, because even if I set umask restrictively the default permissions it's creating directories with is not obeying the umask.  This could be a problem related to recursively applied Windows ACLs overriding the permissions applied by Cygwin but I'm not sure--it works if I explicitly set the correct permissions on the directory.\n\nI think a reasonable workaround in Sage is to make sure, at least, that the user's umask is applied correctly to the top-level source directory of a package (regardless of what permissions were set when it was first extracted).",
    "created_at": "2018-01-19T13:17:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340248",
    "user": "https://github.com/embray"
}
```

I'm not sure why, but there's also some funny business going on in Cygwin with permissions, because even if I set umask restrictively the default permissions it's creating directories with is not obeying the umask.  This could be a problem related to recursively applied Windows ACLs overriding the permissions applied by Cygwin but I'm not sure--it works if I explicitly set the correct permissions on the directory.

I think a reasonable workaround in Sage is to make sure, at least, that the user's umask is applied correctly to the top-level source directory of a package (regardless of what permissions were set when it was first extracted).



---

archive/issue_comments_340249.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-19T13:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340249",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340250.json:
```json
{
    "body": "Kind of a hack but does the trick.\n----\nNew commits:",
    "created_at": "2018-01-19T13:30:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340250",
    "user": "https://github.com/embray"
}
```

Kind of a hack but does the trick.
----
New commits:



---

archive/issue_comments_340251.json:
```json
{
    "body": "Just a comment: the permissions of the extracted tarball should not influence the installation. I'm pretty sure that it doesn't matter for autotools packages. However, for some packages it might matter, but I consider that a bug.",
    "created_at": "2018-01-19T21:11:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340251",
    "user": "https://github.com/jdemeyer"
}
```

Just a comment: the permissions of the extracted tarball should not influence the installation. I'm pretty sure that it doesn't matter for autotools packages. However, for some packages it might matter, but I consider that a bug.



---

archive/issue_comments_340252.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> Just a comment: the permissions of the extracted tarball should not influence the installation. I'm pretty sure that it doesn't matter for autotools packages. However, for some packages it might matter, but I consider that a bug.\n\nIt does for Python packages that import the package itself during setup--then your patch to Python complains that the permissions are not restrictive enough and refuses to add `''` to `sys.path`, preventing this from working.  I have mixed feelings about that, but it is an example where the permissions do affect installation and is not a bug.",
    "created_at": "2018-01-22T13:46:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340252",
    "user": "https://github.com/embray"
}
```

Replying to [comment:4 jdemeyer]:
> Just a comment: the permissions of the extracted tarball should not influence the installation. I'm pretty sure that it doesn't matter for autotools packages. However, for some packages it might matter, but I consider that a bug.

It does for Python packages that import the package itself during setup--then your patch to Python complains that the permissions are not restrictive enough and refuses to add `''` to `sys.path`, preventing this from working.  I have mixed feelings about that, but it is an example where the permissions do affect installation and is not a bug.



---

archive/issue_comments_340253.json:
```json
{
    "body": "Speaking of extracting tarballs: just today I encountered again an issue with `pip` which comes up now and then: if `pip` installs something, the timestamp of the installed file is taken from the *source* file. With autotools on the other hand, the timestamp of the installed files equals the *installation time*.\n\nThe autotools behaviour makes a lot more sense because of dependency checking: if you (re)install a package, you typically want to rebuild everything depending on that package. A typical example of breakage is Cython packages which depend on other Cython packages. There is also a workaround for this issue at the end of `build/pkgs/numpy/spkg-install`\n\nSo it might be a good idea to just update the timestamp of the files in the extracted tarball to the current time.",
    "created_at": "2018-01-23T13:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340253",
    "user": "https://github.com/jdemeyer"
}
```

Speaking of extracting tarballs: just today I encountered again an issue with `pip` which comes up now and then: if `pip` installs something, the timestamp of the installed file is taken from the *source* file. With autotools on the other hand, the timestamp of the installed files equals the *installation time*.

The autotools behaviour makes a lot more sense because of dependency checking: if you (re)install a package, you typically want to rebuild everything depending on that package. A typical example of breakage is Cython packages which depend on other Cython packages. There is also a workaround for this issue at the end of `build/pkgs/numpy/spkg-install`

So it might be a good idea to just update the timestamp of the files in the extracted tarball to the current time.



---

archive/issue_comments_340254.json:
```json
{
    "body": "Now about this ticket: if you want to be safe, wouldn't it be better to create the directory with the correct permissions (or even create all directories this way)?",
    "created_at": "2018-01-23T14:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340254",
    "user": "https://github.com/jdemeyer"
}
```

Now about this ticket: if you want to be safe, wouldn't it be better to create the directory with the correct permissions (or even create all directories this way)?



---

archive/issue_comments_340255.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2018-01-25T18:01:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340255",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_340256.json:
```json
{
    "body": "Well, over in #20481 we agreed that applying the user's umask to the files was the most \"correct\" approach, but as this issue demonstrates, there are cases where if the user's umask has certain values the build will simply fail even if it were otherwise correctly applied to all the directories.\n\nSo in that case, simply for the purpose of building Sage's packages, it probably makes sense to just force a mask like `077` and leave it at that.  Agreed on the timestamps as well; I need to double-check what Python's `TarFile` does by default there.\n\nHopefully there are no packages that somehow depend on files in the source tarball having a certain timestamp... That would be ugly.",
    "created_at": "2018-01-26T16:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340256",
    "user": "https://github.com/embray"
}
```

Well, over in #20481 we agreed that applying the user's umask to the files was the most "correct" approach, but as this issue demonstrates, there are cases where if the user's umask has certain values the build will simply fail even if it were otherwise correctly applied to all the directories.

So in that case, simply for the purpose of building Sage's packages, it probably makes sense to just force a mask like `077` and leave it at that.  Agreed on the timestamps as well; I need to double-check what Python's `TarFile` does by default there.

Hopefully there are no packages that somehow depend on files in the source tarball having a certain timestamp... That would be ugly.



---

archive/issue_comments_340257.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2018-01-26T16:25:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340257",
    "user": "https://github.com/embray"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_340258.json:
```json
{
    "body": "Replying to [comment:9 embray]:\n> Agreed on the timestamps as well; I need to double-check what Python's `TarFile` does by default there.\n\nTarballs should preserve timestamps by default.\n\nThe problem is really in distutils: when it copies files, it always preserves the timestamp. Ideally, we should fix this in distutils too. Should we report this to https://bugs.python.org/ or some different bug tracker?\n\nBut changing the timestamp of the extracted tarballs would fix all cases, even for non-Python packages (even though I don't know any with this bug).",
    "created_at": "2018-01-26T16:47:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340258",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 embray]:
> Agreed on the timestamps as well; I need to double-check what Python's `TarFile` does by default there.

Tarballs should preserve timestamps by default.

The problem is really in distutils: when it copies files, it always preserves the timestamp. Ideally, we should fix this in distutils too. Should we report this to https://bugs.python.org/ or some different bug tracker?

But changing the timestamp of the extracted tarballs would fix all cases, even for non-Python packages (even though I don't know any with this bug).



---

archive/issue_comments_340259.json:
```json
{
    "body": "I think the issue of timestamps is pretty separate from this, but it should be easy enough to fix as long as I'm tinkering...",
    "created_at": "2018-01-30T17:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340259",
    "user": "https://github.com/embray"
}
```

I think the issue of timestamps is pretty separate from this, but it should be easy enough to fix as long as I'm tinkering...



---

archive/issue_comments_340260.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-02T11:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340260",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340261.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-02T11:46:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340261",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340262.json:
```json
{
    "body": "I think the problems that some of the patchbots are having with this are due to a bug in the patchbot actually (which I've since fixed but haven't restarted those patchbots yet...)",
    "created_at": "2018-02-02T15:57:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340262",
    "user": "https://github.com/embray"
}
```

I think the problems that some of the patchbots are having with this are due to a bug in the patchbot actually (which I've since fixed but haven't restarted those patchbots yet...)



---

archive/issue_comments_340263.json:
```json
{
    "body": "`0o077` is a strange choice for umask. I think that `0o022` would make a lot more sense.",
    "created_at": "2018-02-02T16:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340263",
    "user": "https://github.com/jdemeyer"
}
```

`0o077` is a strange choice for umask. I think that `0o022` would make a lot more sense.



---

archive/issue_comments_340264.json:
```json
{
    "body": "022 is the typical default.  I could go with that.  I just figured it couldn't hurt to be maximally restrictive either.  Up to you.",
    "created_at": "2018-02-02T16:41:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340264",
    "user": "https://github.com/embray"
}
```

022 is the typical default.  I could go with that.  I just figured it couldn't hurt to be maximally restrictive either.  Up to you.



---

archive/issue_comments_340265.json:
```json
{
    "body": "You're keeping the \"extraction time\" too literally. For dependency checking purposes, it is important that all files are extracted with an *identical* timestamp. Otherwise you get stuff like\n\n```\n[singular-4.1.0p3.p1] make[4]: Entering directory '/usr/local/src/sage-config/local/var/tmp/sage/build/singular-4.1.0p3.p1/src/resources'\n[singular-4.1.0p3.p1]  cd . && /bin/bash /usr/local/src/sage-config/local/var/tmp/sage/build/singular-4.1.0p3.p1/src/build-aux/missing automake-1.15 --foreign\n[singular-4.1.0p3.p1] aclocal.m4:17: warning: this file was generated for autoconf 2.69.\n[singular-4.1.0p3.p1] You have another version of autoconf.  It may work, but is not guaranteed to.\n[singular-4.1.0p3.p1] If you have problems, you may need to regenerate the build system entirely.\n[singular-4.1.0p3.p1] To do so, use the procedure documented by the package, typically 'autoreconf'.\n[singular-4.1.0p3.p1] configure.ac:9: error: version mismatch.  This is Automake 1.15.1,\n[singular-4.1.0p3.p1] configure.ac:9: but the definition used by this AM_INIT_AUTOMAKE\n[singular-4.1.0p3.p1] configure.ac:9: comes from Automake 1.15.  You should recreate\n[singular-4.1.0p3.p1] configure.ac:9: aclocal.m4 with aclocal and run automake again.\n[singular-4.1.0p3.p1] WARNING: 'automake-1.15' is probably too old.\n[singular-4.1.0p3.p1]          You should only need it if you modified 'Makefile.am' or\n[singular-4.1.0p3.p1]          'configure.ac' or m4 files included by 'configure.ac'.\n[singular-4.1.0p3.p1]          The 'automake' program is part of the GNU Automake package:\n[singular-4.1.0p3.p1]          <http://www.gnu.org/software/automake>\n[singular-4.1.0p3.p1]          It also requires GNU Autoconf, GNU m4 and Perl in order to run:\n[singular-4.1.0p3.p1]          <http://www.gnu.org/software/autoconf>\n[singular-4.1.0p3.p1]          <http://www.gnu.org/software/m4/>\n[singular-4.1.0p3.p1]          <http://www.perl.org/>\n[singular-4.1.0p3.p1] Makefile:425: recipe for target 'Makefile.in' failed\n```\n",
    "created_at": "2018-02-02T16:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340265",
    "user": "https://github.com/jdemeyer"
}
```

You're keeping the "extraction time" too literally. For dependency checking purposes, it is important that all files are extracted with an *identical* timestamp. Otherwise you get stuff like

```
[singular-4.1.0p3.p1] make[4]: Entering directory '/usr/local/src/sage-config/local/var/tmp/sage/build/singular-4.1.0p3.p1/src/resources'
[singular-4.1.0p3.p1]  cd . && /bin/bash /usr/local/src/sage-config/local/var/tmp/sage/build/singular-4.1.0p3.p1/src/build-aux/missing automake-1.15 --foreign
[singular-4.1.0p3.p1] aclocal.m4:17: warning: this file was generated for autoconf 2.69.
[singular-4.1.0p3.p1] You have another version of autoconf.  It may work, but is not guaranteed to.
[singular-4.1.0p3.p1] If you have problems, you may need to regenerate the build system entirely.
[singular-4.1.0p3.p1] To do so, use the procedure documented by the package, typically 'autoreconf'.
[singular-4.1.0p3.p1] configure.ac:9: error: version mismatch.  This is Automake 1.15.1,
[singular-4.1.0p3.p1] configure.ac:9: but the definition used by this AM_INIT_AUTOMAKE
[singular-4.1.0p3.p1] configure.ac:9: comes from Automake 1.15.  You should recreate
[singular-4.1.0p3.p1] configure.ac:9: aclocal.m4 with aclocal and run automake again.
[singular-4.1.0p3.p1] WARNING: 'automake-1.15' is probably too old.
[singular-4.1.0p3.p1]          You should only need it if you modified 'Makefile.am' or
[singular-4.1.0p3.p1]          'configure.ac' or m4 files included by 'configure.ac'.
[singular-4.1.0p3.p1]          The 'automake' program is part of the GNU Automake package:
[singular-4.1.0p3.p1]          <http://www.gnu.org/software/automake>
[singular-4.1.0p3.p1]          It also requires GNU Autoconf, GNU m4 and Perl in order to run:
[singular-4.1.0p3.p1]          <http://www.gnu.org/software/autoconf>
[singular-4.1.0p3.p1]          <http://www.gnu.org/software/m4/>
[singular-4.1.0p3.p1]          <http://www.perl.org/>
[singular-4.1.0p3.p1] Makefile:425: recipe for target 'Makefile.in' failed
```




---

archive/issue_comments_340266.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-02T16:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340266",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340267.json:
```json
{
    "body": "Replying to [comment:17 embray]:\n> I just figured it couldn't hurt to be maximally restrictive either.\n\nIt hurts because it restricts an installation to a single user. We want Sage to work in multi-user installations.",
    "created_at": "2018-02-02T16:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340267",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:17 embray]:
> I just figured it couldn't hurt to be maximally restrictive either.

It hurts because it restricts an installation to a single user. We want Sage to work in multi-user installations.



---

archive/issue_comments_340268.json:
```json
{
    "body": "I'm well aware of that, but this should have no effect on the permissions applied when the files are installed, but I guess it depends in part on the installation mechanism.",
    "created_at": "2018-02-05T09:59:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340268",
    "user": "https://github.com/embray"
}
```

I'm well aware of that, but this should have no effect on the permissions applied when the files are installed, but I guess it depends in part on the installation mechanism.



---

archive/issue_comments_340269.json:
```json
{
    "body": "Ugh, okay.",
    "created_at": "2018-02-05T10:00:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340269",
    "user": "https://github.com/embray"
}
```

Ugh, okay.



---

archive/issue_comments_340270.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-05T10:18:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340270",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340271.json:
```json
{
    "body": "This should do it, but let's see if it fixes the patchbots.",
    "created_at": "2018-02-05T10:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340271",
    "user": "https://github.com/embray"
}
```

This should do it, but let's see if it fixes the patchbots.



---

archive/issue_comments_340272.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-05T10:18:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340272",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340273.json:
```json
{
    "body": "Why not set `self._extracted_mtime = time.time()` in `__init__()`? It seems overcomplicated to first initialize it as `None` and then set it to `time.time()` later.",
    "created_at": "2018-02-05T11:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340273",
    "user": "https://github.com/jdemeyer"
}
```

Why not set `self._extracted_mtime = time.time()` in `__init__()`? It seems overcomplicated to first initialize it as `None` and then set it to `time.time()` later.



---

archive/issue_comments_340274.json:
```json
{
    "body": "Well, this time the patchbot failed, but due to an unrelated bug with the patchbot itself in testing \"unsafe tickets\".",
    "created_at": "2018-02-05T13:00:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340274",
    "user": "https://github.com/embray"
}
```

Well, this time the patchbot failed, but due to an unrelated bug with the patchbot itself in testing "unsafe tickets".



---

archive/issue_comments_340275.json:
```json
{
    "body": "That's what I did at first, and in practice it would probably be fine.  But in theory you can instantiate a `Tarball` instance and then extract it multiple times at different times.",
    "created_at": "2018-02-05T13:00:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340275",
    "user": "https://github.com/embray"
}
```

That's what I did at first, and in practice it would probably be fine.  But in theory you can instantiate a `Tarball` instance and then extract it multiple times at different times.



---

archive/issue_comments_340276.json:
```json
{
    "body": "I'm writing a reviewer commit...",
    "created_at": "2018-02-05T15:28:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340276",
    "user": "https://github.com/jdemeyer"
}
```

I'm writing a reviewer commit...



---

archive/issue_comments_340277.json:
```json
{
    "body": "I created https://bugs.python.org/issue32773 for the timestamp issue.",
    "created_at": "2018-02-05T16:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340277",
    "user": "https://github.com/jdemeyer"
}
```

I created https://bugs.python.org/issue32773 for the timestamp issue.



---

archive/issue_comments_340278.json:
```json
{
    "body": "Style comment: I often see you adding blank lines between a method docstring and the code. I checked [PEP 257](https://www.python.org/dev/peps/pep-0257/) and it only says to do that after the docstring of a class.",
    "created_at": "2018-02-05T16:13:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340278",
    "user": "https://github.com/jdemeyer"
}
```

Style comment: I often see you adding blank lines between a method docstring and the code. I checked [PEP 257](https://www.python.org/dev/peps/pep-0257/) and it only says to do that after the docstring of a class.



---

archive/issue_comments_340279.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-02-05T16:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340279",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_340280.json:
```json
{
    "body": "This is basically ignoring the point I just made for why I did it the way I did. But as far as how this code is actually used it's fine--it's not like anyone is instantiating a `SageBaseTarFile` and extracting from it multiple times at different times, so fine. But it seems wrong to me.",
    "created_at": "2018-02-06T12:46:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340280",
    "user": "https://github.com/embray"
}
```

This is basically ignoring the point I just made for why I did it the way I did. But as far as how this code is actually used it's fine--it's not like anyone is instantiating a `SageBaseTarFile` and extracting from it multiple times at different times, so fine. But it seems wrong to me.



---

archive/issue_comments_340281.json:
```json
{
    "body": "Replying to [comment:29 jdemeyer]:\n> Style comment: I often see you adding blank lines between a method docstring and the code. I checked [PEP 257](https://www.python.org/dev/peps/pep-0257/) and it only says to do that after the docstring of a class.\n\nUgh, I hate that convention. I personally find it difficult to visually separate the end of the docstring from the beginning of the function.  Syntax highlighting helps there, but only somewhat.  It's a minor thing though.",
    "created_at": "2018-02-06T12:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340281",
    "user": "https://github.com/embray"
}
```

Replying to [comment:29 jdemeyer]:
> Style comment: I often see you adding blank lines between a method docstring and the code. I checked [PEP 257](https://www.python.org/dev/peps/pep-0257/) and it only says to do that after the docstring of a class.

Ugh, I hate that convention. I personally find it difficult to visually separate the end of the docstring from the beginning of the function.  Syntax highlighting helps there, but only somewhat.  It's a minor thing though.



---

archive/issue_comments_340282.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-06T12:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340282",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340283.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-09T23:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24330",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24330#issuecomment-340283",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
