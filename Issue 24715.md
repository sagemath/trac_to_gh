# Issue 24715: Speed up SR(Integer)

archive/issues_024715.json:
```json
{
    "body": "\n```\nsage: a = ZZ(23)\nsage: %timeit SR(a)\n100000 loops, best of 3: 3.51 \u00b5s per loop\nsage: %timeit RR(a)\n1000000 loops, best of 3: 218 ns per loop\n```\n\nProfiling with callgrind shows Python code the main contributor (only 0.4% Pynac), with a big chunk from malloc/free.\n\n* simply moving up the check for `Integer` in `SR._element_constructor_()` reduces the time to 300ns \n* with a mock `Integer._symbolic_()` member replacing `if (hasattr(x, '_symbolic_')):` with `try: x._symbolic_()` gains 100ns\n\nSo this ticket will implement a dedicated `Integer._symbolic_()` that calls helper functions in `symbolic/expression.pyx`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24952\n\n",
    "created_at": "2018-03-12T09:56:18Z",
    "labels": [
        "performance",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "Speed up SR(Integer)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24715",
    "user": "@rwst"
}
```

```
sage: a = ZZ(23)
sage: %timeit SR(a)
100000 loops, best of 3: 3.51 Âµs per loop
sage: %timeit RR(a)
1000000 loops, best of 3: 218 ns per loop
```

Profiling with callgrind shows Python code the main contributor (only 0.4% Pynac), with a big chunk from malloc/free.

* simply moving up the check for `Integer` in `SR._element_constructor_()` reduces the time to 300ns 
* with a mock `Integer._symbolic_()` member replacing `if (hasattr(x, '_symbolic_')):` with `try: x._symbolic_()` gains 100ns

So this ticket will implement a dedicated `Integer._symbolic_()` that calls helper functions in `symbolic/expression.pyx`.

Issue created by migration from https://trac.sagemath.org/ticket/24952





---

archive/issue_comments_346894.json:
```json
{
    "body": "Note the created ex is \"numeric\" with type MPZ, i.e. Pynac (always) checks if a Python object is an Integer (using `py_funcs.py_is_Integer(o)`) and converts it to internal GMP format (using `py_funcs.py_mpz_from_integer(o)`). This means symbolic operations are optimally fast. It also means the process can be further improved if Pynac provided an interface to create its MPZ numerics directly from a given `mpz_t`.\n----\nNew commits:",
    "created_at": "2018-03-12T15:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346894",
    "user": "@rwst"
}
```

Note the created ex is "numeric" with type MPZ, i.e. Pynac (always) checks if a Python object is an Integer (using `py_funcs.py_is_Integer(o)`) and converts it to internal GMP format (using `py_funcs.py_mpz_from_integer(o)`). This means symbolic operations are optimally fast. It also means the process can be further improved if Pynac provided an interface to create its MPZ numerics directly from a given `mpz_t`.
----
New commits:



---

archive/issue_comments_346895.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-03-12T15:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346895",
    "user": "@rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_346896.json:
```json
{
    "body": "In pure Python, it is 2-3x faster to check `hasattr` when such an attribute is not there, but having the attribute is slower, but not by so much:\n\n```sage\nsage: def check(x):\n....:     if hasattr(x,'parent'):\n....:         return x.parent()\n....:     return None\nsage: def check2(x):\n....:     try:\n....:         return x.parent()\n....:     except AttributeError:\n....:         return None\nsage: z = 5\nsage: %timeit check(z)\n1000000 loops, best of 3: 205 ns per loop\nsage: %timeit check2(z)\n10000000 loops, best of 3: 126 ns per loop\nsage: z = int(5)\nsage: %timeit check(z)\n1000000 loops, best of 3: 381 ns per loop\nsage: %timeit check2(z)\n1000000 loops, best of 3: 889 ns per loop\n```\n\nSimilar using Cython:\n\n```sage\nsage: %%cython\n....: def check(x):\n....:     if hasattr(x,'parent'):\n....:         return x.parent()\n....: def check2(x):\n....:     try:\n....:         return x.parent()\n....:     except AttributeError:\n....:         return None\n....: \nsage: z = 5\nsage: %timeit check(z)\n10000000 loops, best of 3: 94 ns per loop\nsage: %timeit check2(z)\n10000000 loops, best of 3: 68.5 ns per loop\nsage: z = int(5)\nsage: %timeit check(z)\n1000000 loops, best of 3: 185 ns per loop\nsage: %timeit check2(z)\n1000000 loops, best of 3: 395 ns per loop\n```\n\nSo I am not convinced that removing the `hasattr` check is for the better. I guess the question is how often do you expect things to be passed to `SR` that do not have a `_symbolic_`? What about also doing `SR(Rational)`?",
    "created_at": "2018-03-13T00:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346896",
    "user": "@tscrim"
}
```

In pure Python, it is 2-3x faster to check `hasattr` when such an attribute is not there, but having the attribute is slower, but not by so much:

```sage
sage: def check(x):
....:     if hasattr(x,'parent'):
....:         return x.parent()
....:     return None
sage: def check2(x):
....:     try:
....:         return x.parent()
....:     except AttributeError:
....:         return None
sage: z = 5
sage: %timeit check(z)
1000000 loops, best of 3: 205 ns per loop
sage: %timeit check2(z)
10000000 loops, best of 3: 126 ns per loop
sage: z = int(5)
sage: %timeit check(z)
1000000 loops, best of 3: 381 ns per loop
sage: %timeit check2(z)
1000000 loops, best of 3: 889 ns per loop
```

Similar using Cython:

```sage
sage: %%cython
....: def check(x):
....:     if hasattr(x,'parent'):
....:         return x.parent()
....: def check2(x):
....:     try:
....:         return x.parent()
....:     except AttributeError:
....:         return None
....: 
sage: z = 5
sage: %timeit check(z)
10000000 loops, best of 3: 94 ns per loop
sage: %timeit check2(z)
10000000 loops, best of 3: 68.5 ns per loop
sage: z = int(5)
sage: %timeit check(z)
1000000 loops, best of 3: 185 ns per loop
sage: %timeit check2(z)
1000000 loops, best of 3: 395 ns per loop
```

So I am not convinced that removing the `hasattr` check is for the better. I guess the question is how often do you expect things to be passed to `SR` that do not have a `_symbolic_`? What about also doing `SR(Rational)`?



---

archive/issue_comments_346897.json:
```json
{
    "body": "The usage of '_symbolic_' should increase so I'll change it back and add the rational case.",
    "created_at": "2018-03-13T06:39:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346897",
    "user": "@rwst"
}
```

The usage of '_symbolic_' should increase so I'll change it back and add the rational case.



---

archive/issue_comments_346898.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-13T07:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346898",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_346899.json:
```json
{
    "body": "Thanks. I agree that more thing should implement a `_symbolic_`. I just worry it is too much a swing in the other direction in terms of speed to assume it is an attribute.",
    "created_at": "2018-03-13T09:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346899",
    "user": "@tscrim"
}
```

Thanks. I agree that more thing should implement a `_symbolic_`. I just worry it is too much a swing in the other direction in terms of speed to assume it is an attribute.



---

archive/issue_comments_346900.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-13T09:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346900",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_346901.json:
```json
{
    "body": "Could this ticket be responsible for this\n\n```\nsage -t --long --warn-long 72.7 /usr/lib64/python2.7/site-packages/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/structure/coerce_actions.pyx\", line 525, in sage.structure.coerce_actions.ModuleAction.__invert__\nFailed example:\n    cm.explain(x, 1, operator.truediv)\nExpected:\n    Action discovered.\n        Right inverse action by Symbolic Constants Subring on Univariate Polynomial Ring in x over Symbolic Constants Subring\n        with precomposition on right by Coercion map:\n          From: Integer Ring\n          To:   Symbolic Constants Subring\n    Result lives in Univariate Polynomial Ring in x over Symbolic Constants Subring\n    Univariate Polynomial Ring in x over Symbolic Constants Subring\nGot:\n    Action discovered.\n        Right inverse action by Symbolic Constants Subring on Univariate Polynomial Ring in x over Symbolic Constants Subring\n        with precomposition on right by Conversion via _symbolic_ method map:\n          From: Integer Ring\n          To:   Symbolic Constants Subring\n    Result lives in Univariate Polynomial Ring in x over Symbolic Constants Subring\n    Univariate Polynomial Ring in x over Symbolic Constants Subring\n**********************************************************************\n1 item had failures:\n   1 of  26 in sage.structure.coerce_actions.ModuleAction.__invert__\n    [143 tests, 1 failure, 1.06 s]\n```\n",
    "created_at": "2018-03-22T01:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346901",
    "user": "@kiwifb"
}
```

Could this ticket be responsible for this

```
sage -t --long --warn-long 72.7 /usr/lib64/python2.7/site-packages/sage/structure/coerce_actions.pyx
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/structure/coerce_actions.pyx", line 525, in sage.structure.coerce_actions.ModuleAction.__invert__
Failed example:
    cm.explain(x, 1, operator.truediv)
Expected:
    Action discovered.
        Right inverse action by Symbolic Constants Subring on Univariate Polynomial Ring in x over Symbolic Constants Subring
        with precomposition on right by Coercion map:
          From: Integer Ring
          To:   Symbolic Constants Subring
    Result lives in Univariate Polynomial Ring in x over Symbolic Constants Subring
    Univariate Polynomial Ring in x over Symbolic Constants Subring
Got:
    Action discovered.
        Right inverse action by Symbolic Constants Subring on Univariate Polynomial Ring in x over Symbolic Constants Subring
        with precomposition on right by Conversion via _symbolic_ method map:
          From: Integer Ring
          To:   Symbolic Constants Subring
    Result lives in Univariate Polynomial Ring in x over Symbolic Constants Subring
    Univariate Polynomial Ring in x over Symbolic Constants Subring
**********************************************************************
1 item had failures:
   1 of  26 in sage.structure.coerce_actions.ModuleAction.__invert__
    [143 tests, 1 failure, 1.06 s]
```




---

archive/issue_comments_346902.json:
```json
{
    "body": "Yes, I believe it is. What ticket does this come up on and is it a problem?",
    "created_at": "2018-03-22T02:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346902",
    "user": "@tscrim"
}
```

Yes, I believe it is. What ticket does this come up on and is it a problem?



---

archive/issue_comments_346903.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-03-22T02:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346903",
    "user": "@tscrim"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_346904.json:
```json
{
    "body": "Oh, I see, a patchbot failure.",
    "created_at": "2018-03-22T02:33:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346904",
    "user": "@tscrim"
}
```

Oh, I see, a patchbot failure.



---

archive/issue_comments_346905.json:
```json
{
    "body": "For my own sage-on-gentoo needs I follow the branch were Volker merges stuff. And that one showed up. It took a bit of effort to track a reasonable culprit amongst the tickets merged.",
    "created_at": "2018-03-22T03:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346905",
    "user": "@kiwifb"
}
```

For my own sage-on-gentoo needs I follow the branch were Volker merges stuff. And that one showed up. It took a bit of effort to track a reasonable culprit amongst the tickets merged.



---

archive/issue_comments_346906.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-03-22T07:55:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346906",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_346907.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-03-22T07:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346907",
    "user": "@rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_346908.json:
```json
{
    "body": "I just replaced the `...Coercion...` with the `...Conversion...` part because the new output does not seem wrong for me.",
    "created_at": "2018-03-22T07:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346908",
    "user": "@rwst"
}
```

I just replaced the `...Coercion...` with the `...Conversion...` part because the new output does not seem wrong for me.



---

archive/issue_comments_346909.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-03-22T23:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346909",
    "user": "@kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_346910.json:
```json
{
    "body": "Should be good.",
    "created_at": "2018-03-22T23:52:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346910",
    "user": "@kiwifb"
}
```

Should be good.



---

archive/issue_comments_346911.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-12T11:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24715",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24715#issuecomment-346911",
    "user": "@vbraun"
}
```

Resolution: fixed
