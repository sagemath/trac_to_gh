# Issue 26618: py3: fixes for doctests in cpython

Issue created by migration from https://trac.sagemath.org/ticket/26855

Original creator: chapoton

Original creation time: 2018-12-07 20:35:56




---

Comment by chapoton created at 2018-12-07 20:36:26

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-12-07 20:36:26

New commits:


---

Comment by tscrim created at 2018-12-07 23:53:08

LGTM.


---

Comment by tscrim created at 2018-12-07 23:53:08

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2018-12-08 08:31:38

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2018-12-08 08:31:38

Why is this needed?

```diff
-        sage: test_del_dictitem_by_exact_value(D, ZZ, 2)
+        sage: test_del_dictitem_by_exact_value(D, ZZ, int(2))
```


If this change is really needed, I consider it a bug in Cython.


---

Comment by jdemeyer created at 2018-12-08 08:32:11

General rule about fixing Python 3 doctests: don't "fix" the doctest but fix the code such that the doctest remains working.


---

Comment by chapoton created at 2018-12-08 08:33:08

because in python 3, the hash must be a python int...


---

Comment by jdemeyer created at 2018-12-08 08:52:33

Replying to [comment:5 chapoton]:
> because in python 3, the hash must be a python int...

What do you mean? Are you talking about the output of a plain-Python `__hash__` method? This is not involved here.


---

Comment by chapoton created at 2018-12-08 08:54:38


```
sage -t --long src/sage/cpython/dict_del_by_value.pyx
**********************************************************************
File "src/sage/cpython/dict_del_by_value.pyx", line 435, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 443, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2504)
        return del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```



---

Comment by jdemeyer created at 2018-12-08 09:12:05

I'm assuming that this is an exception raised by Cython. So I would like to understand why it works on Python 2 but not on Python 3. This is not only going to be relevant for this ticket, but possibly for many other Python 3 problems regarding Sage `Integer` vs Python `int`.


---

Comment by tscrim created at 2018-12-08 09:17:14

My thought was that the coercion (conversion?) from `Integer` -> `int` was somehow not done automatically in Python3 but it was allowed in Python2.


---

Comment by jdemeyer created at 2018-12-08 12:30:35

Replying to [comment:9 tscrim]:
> My thought was that the coercion (conversion?) from `Integer` -> `int` was somehow not done automatically in Python3 but it was allowed in Python2.

I think it's at least something that we should investigate in general.


---

Comment by jdemeyer created at 2018-12-08 12:31:05

Possibly we are doing something wrong in `integer.pyx`...


---

Comment by jdemeyer created at 2018-12-10 12:32:54

Changing status from needs_info to positive_review.


---

Comment by jdemeyer created at 2018-12-10 12:32:54

The problem with `Py_hash_t` should be fixed upstream in Cython. So I will revert this part of this ticket, which should be solved whenever we upgrade Cython.
----
New commits:


---

Comment by vbraun created at 2018-12-23 23:40:24

Resolution: fixed


---

Comment by embray created at 2018-12-28 14:06:38

This tickets were closed as fixed after the Sage 8.5 release.
