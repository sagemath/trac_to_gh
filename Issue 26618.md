# Issue 26618: py3: fixes for doctests in cpython

archive/issues_026618.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/26855\n\n",
    "created_at": "2018-12-07T20:35:56Z",
    "labels": [
        "component: python3"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "py3: fixes for doctests in cpython",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26618",
    "user": "https://github.com/fchapoton"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/26855





---

archive/issue_comments_373566.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-07T20:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373566",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_373567.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-12-07T20:36:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373567",
    "user": "https://github.com/fchapoton"
}
```

New commits:



---

archive/issue_comments_373568.json:
```json
{
    "body": "LGTM.",
    "created_at": "2018-12-07T23:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373568",
    "user": "https://github.com/tscrim"
}
```

LGTM.



---

archive/issue_comments_373569.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-07T23:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373569",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_373570.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-12-08T08:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373570",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_373571.json:
```json
{
    "body": "Why is this needed?\n\n```diff\n-        sage: test_del_dictitem_by_exact_value(D, ZZ, 2)\n+        sage: test_del_dictitem_by_exact_value(D, ZZ, int(2))\n```\n\n\nIf this change is really needed, I consider it a bug in Cython.",
    "created_at": "2018-12-08T08:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373571",
    "user": "https://github.com/jdemeyer"
}
```

Why is this needed?

```diff
-        sage: test_del_dictitem_by_exact_value(D, ZZ, 2)
+        sage: test_del_dictitem_by_exact_value(D, ZZ, int(2))
```


If this change is really needed, I consider it a bug in Cython.



---

archive/issue_comments_373572.json:
```json
{
    "body": "General rule about fixing Python 3 doctests: don't \"fix\" the doctest but fix the code such that the doctest remains working.",
    "created_at": "2018-12-08T08:32:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373572",
    "user": "https://github.com/jdemeyer"
}
```

General rule about fixing Python 3 doctests: don't "fix" the doctest but fix the code such that the doctest remains working.



---

archive/issue_comments_373573.json:
```json
{
    "body": "because in python 3, the hash must be a python int...",
    "created_at": "2018-12-08T08:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373573",
    "user": "https://github.com/fchapoton"
}
```

because in python 3, the hash must be a python int...



---

archive/issue_comments_373574.json:
```json
{
    "body": "Replying to [comment:5 chapoton]:\n> because in python 3, the hash must be a python int...\n\nWhat do you mean? Are you talking about the output of a plain-Python `__hash__` method? This is not involved here.",
    "created_at": "2018-12-08T08:52:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373574",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 chapoton]:
> because in python 3, the hash must be a python int...

What do you mean? Are you talking about the output of a plain-Python `__hash__` method? This is not involved here.



---

archive/issue_comments_373575.json:
```json
{
    "body": "\n```\nsage -t --long src/sage/cpython/dict_del_by_value.pyx\n**********************************************************************\nFile \"src/sage/cpython/dict_del_by_value.pyx\", line 435, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value\nFailed example:\n    test_del_dictitem_by_exact_value(D, ZZ, 2)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>\", line 1, in <module>\n        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))\n      File \"sage/cpython/dict_del_by_value.pyx\", line 443, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2504)\n        return del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)\n    TypeError: an integer is required\n```\n",
    "created_at": "2018-12-08T08:54:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373575",
    "user": "https://github.com/fchapoton"
}
```


```
sage -t --long src/sage/cpython/dict_del_by_value.pyx
**********************************************************************
File "src/sage/cpython/dict_del_by_value.pyx", line 435, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value
Failed example:
    test_del_dictitem_by_exact_value(D, ZZ, 2)
Exception raised:
    Traceback (most recent call last):
      File "/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/u1/chapoton/sage3/local/lib/python3.6/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value[7]>", line 1, in <module>
        test_del_dictitem_by_exact_value(D, ZZ, Integer(2))
      File "sage/cpython/dict_del_by_value.pyx", line 443, in sage.cpython.dict_del_by_value.test_del_dictitem_by_exact_value (build/cythonized/sage/cpython/dict_del_by_value.c:2504)
        return del_dictitem_by_exact_value(<PyDictObject *>D, <PyObject *>value, h)
    TypeError: an integer is required
```




---

archive/issue_comments_373576.json:
```json
{
    "body": "I'm assuming that this is an exception raised by Cython. So I would like to understand why it works on Python 2 but not on Python 3. This is not only going to be relevant for this ticket, but possibly for many other Python 3 problems regarding Sage `Integer` vs Python `int`.",
    "created_at": "2018-12-08T09:12:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373576",
    "user": "https://github.com/jdemeyer"
}
```

I'm assuming that this is an exception raised by Cython. So I would like to understand why it works on Python 2 but not on Python 3. This is not only going to be relevant for this ticket, but possibly for many other Python 3 problems regarding Sage `Integer` vs Python `int`.



---

archive/issue_comments_373577.json:
```json
{
    "body": "My thought was that the coercion (conversion?) from `Integer` -> `int` was somehow not done automatically in Python3 but it was allowed in Python2.",
    "created_at": "2018-12-08T09:17:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373577",
    "user": "https://github.com/tscrim"
}
```

My thought was that the coercion (conversion?) from `Integer` -> `int` was somehow not done automatically in Python3 but it was allowed in Python2.



---

archive/issue_comments_373578.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> My thought was that the coercion (conversion?) from `Integer` -> `int` was somehow not done automatically in Python3 but it was allowed in Python2.\n\nI think it's at least something that we should investigate in general.",
    "created_at": "2018-12-08T12:30:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373578",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 tscrim]:
> My thought was that the coercion (conversion?) from `Integer` -> `int` was somehow not done automatically in Python3 but it was allowed in Python2.

I think it's at least something that we should investigate in general.



---

archive/issue_comments_373579.json:
```json
{
    "body": "Possibly we are doing something wrong in `integer.pyx`...",
    "created_at": "2018-12-08T12:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373579",
    "user": "https://github.com/jdemeyer"
}
```

Possibly we are doing something wrong in `integer.pyx`...



---

archive/issue_comments_373580.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2018-12-10T12:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373580",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_373581.json:
```json
{
    "body": "The problem with `Py_hash_t` should be fixed upstream in Cython. So I will revert this part of this ticket, which should be solved whenever we upgrade Cython.\n----\nNew commits:",
    "created_at": "2018-12-10T12:32:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373581",
    "user": "https://github.com/jdemeyer"
}
```

The problem with `Py_hash_t` should be fixed upstream in Cython. So I will revert this part of this ticket, which should be solved whenever we upgrade Cython.
----
New commits:



---

archive/issue_comments_373582.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373582",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_024730.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2018-12-23T23:40:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26618#event-24730"
}
```



---

archive/issue_comments_373583.json:
```json
{
    "body": "This tickets were closed as fixed after the Sage 8.5 release.",
    "created_at": "2018-12-28T14:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26618",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26618#issuecomment-373583",
    "user": "https://github.com/embray"
}
```

This tickets were closed as fixed after the Sage 8.5 release.
