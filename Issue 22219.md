# Issue 22219: LatticePoset: Add subdirect decomposition

Issue created by migration from https://trac.sagemath.org/ticket/22456

Original creator: jmantysalo

Original creation time: 2017-02-27 03:51:06

CC:  mantepse tscrim

Add a function that computes the subdirect decomposition of a lattice.


---

Comment by jmantysalo created at 2017-02-27 08:14:54

Some test code:


```
set_random_seed(321)
N = 100

for i in range(N):
    L = Posets.RandomLattice(randint(10, 20), 0.997)
    Ld = L.subdirect_decomposition()

    if not L.is_subdirectly_reducible():
        if len(Ld) != 1:
            print("Error 1")
            raise AssertionError

    else:
        for Lf in Ld:
            if Lf.is_subdirectly_reducible():
                print("Error 2")
                raise AssertionError

        Lp = LatticePoset({0: []})
        for Lf in Ld:
            Lp = Lp.product(Lf)
        try:
            next(Lp.isomorphic_sublattices_iterator(L))
        except StopIteration:
            print("Error 3")
            raise AssertionError

for i in range(N):
    Lp = LatticePoset({0: []})
    for j in range(3):
        L = Posets.ChainPoset(3)
        while L.is_subdirectly_reducible():
            L = Posets.RandomLattice(7, 0.98)
        Lp = Lp.product(L)
    if len(Lp.subdirect_decomposition()) != 3:
        raise AssertionError

print("Seems to work")
```

----
New commits:


---

Comment by jmantysalo created at 2017-02-27 08:14:54

Changing status from new to needs_review.


---

Comment by git created at 2017-03-06 08:24:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-19 08:06:53

LGTM modulo this little change:

```diff
             low = L.lower_covers(e)
             if len(low) == 1:  # a join-irreducible element
-                C[e] = congs[max(e, key=lambda x: cong_ji._element_to_vertex(x))]
-            if len(low) > 1:  # "extending" congruence to avoid re-computation
+                C[e] = congs[max(e, key=cong_ji._element_to_vertex)]
+            elif low:  # "extending" congruence to avoid re-computation
                 low_0 = min(low, key=lambda x: C[x].number_of_subsets())
                 for new_pair in e:
```



---

Comment by git created at 2017-03-19 08:20:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-03-19 08:33:44

Changing status from needs_review to needs_work.


---

Comment by jmantysalo created at 2017-03-19 08:33:44

Replying to [comment:4 tscrim]:


```
C[e] = congs[max(e, key=cong_ji._element_to_vertex)]
```


Good point, I didn't notice this one.


```
elif low:  # "extending" congruence to avoid re-computation
```


Well, OK. Not sure if minimal speedup is worth slightly harder code to understand, `len(x) == 1` and `len(x) > 1` is cleaner solution.

Compiling and testing, so not ready for review just now.


---

Comment by git created at 2017-03-19 17:09:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2017-03-19 17:11:38

Now ready.


---

Comment by jmantysalo created at 2017-03-19 17:11:38

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-03-19 20:20:48

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-03-19 20:20:48

Looks good, thank you.


---

Comment by vbraun created at 2017-03-27 20:42:21

Resolution: fixed
