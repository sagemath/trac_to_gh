# Issue 12768: Combinatorial implementation of the affine symmetric group

Issue created by migration from Trac.

Original creator: sdenton

Original creation time: 2012-05-11 19:25:19

Assignee: tom denton

CC:  nthiery aschilling chrisjamesberg

Keywords: affine, combinatorics, days38

This is a combinatorial implementation of the affine symmetric group, providing a second implementation of the WeylGroup(['A',k,1]), but quite a bit faster.  The basic idea should be easily extensible to the combinatorial interpretations of the other affine types with window notations, and I've discussed a bit with N. Thiery about hacking together a kind of window notation for the other types.


---

Attachment

affine permutations class.  (Attach this first, if testing.)


---

Attachment

Affine symmetric group class file.


---

Comment by sdenton created at 2012-05-17 18:47:45

Changing component from PLEASE CHANGE to combinatorics.


---

Attachment


---

Comment by sdenton created at 2012-05-17 18:49:33

Removed the cython-ified version of the affine permutations class as it was creating issues, and wasn't really improving run times that much.  Made numerous algorithm improvements, though; the patch is now int he sage-combinat queue as well.


---

Comment by aschilling created at 2012-08-25 04:03:54

Hi Tom,

It looks like that Affine Permutations really need to be integrated into the sage file system. At the moment this seems to be a stand-alone patch!

Best,

Anne


---

Comment by sdenton created at 2012-10-07 13:15:12

Ok, at long last, I've fixed up the sage combinat patch and exported; it's the attachment above.  It should also patch the sage files that point out that the new directory and file exist!


---

Comment by aschilling created at 2012-10-08 05:23:11

Hi Tom,

Could we entice you to add a to_core method? Also, some of your documentation using INPUT: etc is not standard and needs to be fixed. And ... please put your patch on the sage-combinat queue.

Cheers,

Anne


---

Comment by sdenton created at 2012-10-16 08:24:16

Ok, changed the documentation, updated the patch in the combinat queue, and added some new functions.

There are two ways to pull a dominant element out of an affine permutation: one is to sort the Lehmer code, and the other is to write x=g*f, where g is dominant and f is finite type (0-parabolic).  The to_dominant method does the sorting, and the grassmannian_quotient() method returns the pair (g,f).  (Or (f,g) if you specify side='left'.)  I also put in a to_core method, which uses the sorting approach.  One can get the core for the quotient element by doing x.grassmannian_quotient()[0].to_core().

Best,
-tom


---

Comment by aschilling created at 2012-10-24 02:31:32

Hi Tom,

Without looking at the mathematics yet, here are some Sage specific requirements that your patch does not yet fulfill:

- You need 100% coverage:


```
$affine_permutations anne$ sage -coverage affine_permutations.py 
----------------------------------------------------------------------
affine_permutations.py
ERROR: Please add a `TestSuite(s).run()` doctest.
SCORE affine_permutations.py: 95% (46 of 48)

Missing doctests:
	 * __init__(self, parent, lst, check=True):
	 * random_element(self, n):


Possibly wrong (function name doesn't occur in doctests):
	 * _repr_(self):
	 * check(self):
	 * lower_covers(self,side="right"):
	 * _element_constructor_(self, *args, **keywords):
	 * _repr_(self):
	 * is_crystallographic(self):
	 * _an_element_(self):
```


- The preamble of your patch needs to start with #12940: Title + then a summary of what this patch implements.

- The indents of your tests are not right for many of your methods. You need

```
    EXAMPLES::

        sage: ....
```

Look at your documentation by building it via 

```
sage -docbuild reference html
```

I can already see many places where you forgot ` for math display such as in `\ZZ`.

So much for now,

Anne


---

Comment by sdenton created at 2012-10-24 07:01:49

Ok, fixed up the docs.  I hadn't seen the -coverage command before.  The ones that are giving warnings now are methods (like _repr_) that are implicitly called within the doc test for that function.

I went through and fixed up latex parts by hand, and am still waiting on the documentation to build to really make a visual check...

Best,
-tom


---

Comment by aschilling created at 2012-10-24 15:28:40

Thanks, tom. You can put #indirect doctest in the line after your test to calm the 

```
sage -coverage
```

command, if the test indeed indirectly tests the method.

Anne


---

Comment by aschilling created at 2012-10-24 16:24:28

Hi tom,

Some more Sage comments:

- Currently you have a directory in /sage/combinat called affine_permutations, but there is only one file in there, namely affine_permutations.py. Unless you forsee the addition of further file to break up the code, I would strongly suggest to get rid of the directory and just put affine_permutations.py in /sage/cominbat as is done for permutations, partitions etc..

- For the documentation you need to put a link in /doc/en/reference/combinat

Best,

Anne


---

Comment by nthiery created at 2012-10-25 10:39:53

Hi Tom!

For the directory structure, you may want to follow that of permutation groups. Something like:

```
    sage/groups/affine_permutation_groups/affine_permutation.py
                                          affine_symmetric_group.py
                                          affine_permutation_group.py
```


Which just made me think: is there a way to generalize the algorithmic
for permutation groups (see
http://en.wikipedia.org/wiki/Strong_generating_set) to subgroups of
the affine symmetric group? Hmm, if this hasn't been done yet, that
could be a fun research project. Of course, the obvious first
candidates to play with would be the affine coxeter groups realized as
groups of permutations as we had discussed in Montreal.

Cheers,
                           Nicolas


---

Comment by sdenton created at 2013-01-21 12:54:09

Hello!

I've been trying to get this expanded and finished up.  The following changes happened lately:

* Changed the names of things to AffinePermutation and AffinePermutationGroup, because:
* I added affine permutation groups of types ABCDG.  (E and F are in Eriksson, but are ugly; I want to think about whether there's a cleaner way to go about these ones.)
* Everything is just in the file affine_permutations.py, which sits directly in sage/combinat

I'm now getting a problem I can't figure out, though: Sage is refusing to import the AffinePermutationGroup name.  It doesn't seem to be previously defined, and when I disable all of the import statements I still get an error (so it can't be an import loop; also, nothing calls my file...).  I can manually attach the file just fine, too.

I've stared at this a good long time and haven't been able to figure out what's going wrong...


---

Comment by schilly created at 2013-01-22 09:49:22

Replying to [comment:12 sdenton]:
> Hello!
> 
> I've been trying to get this expanded and finished up.  The following changes happened lately:
> 
> * Changed the names of things to AffinePermutation and AffinePermutationGroup, because:
> * I added affine permutation groups of types ABCDG.  (E and F are in Eriksson, but are ugly; I want to think about whether there's a cleaner way to go about these ones.)
> * Everything is just in the file affine_permutations.py, which sits directly in sage/combinat
> 
> I'm now getting a problem I can't figure out, though: Sage is refusing to import the AffinePermutationGroup name.  It doesn't seem to be previously defined, and when I disable all of the import statements I still get an error (so it can't be an import loop; also, nothing calls my file...).  I can manually attach the file just fine, too.
> 
> I've stared at this a good long time and haven't been able to figure out what's going wrong...

Anne tries to write: Don't you mean non-twisted rather than non-exceptional? Type G is exceptional!


---

Comment by aschilling created at 2013-01-22 09:53:58

Hi Tom,

I just answered your question on sage-combinat. In short, you need to remove some old files left over from your /combinat/affine_permutations/ directory by hand since it gets confused about the file and the directory.

Also, to be consistent with permutation.py, core.py, etc, shouldn't your file be called affine_permutation.py (without the s)?

In the documentation of AffinePermuation you says


```
    These are combinatorial implmentations of the affine Weyl groups of
    non-exceptional type as permutations of the set of all integers.
    the basic algorithms are derived from Bjorner and Brenti's `Combinatorics
    of Coxeter Groups.'
```


Don't you mean non-twisted rather than non-exceptional. Type G is exceptional!

Best,

Anne


---

Comment by sdenton created at 2013-02-10 20:10:33

Replying to [ticket:12940 sdenton]:
> This is a combinatorial implementation of the affine symmetric group, providing a second implementation of the WeylGroup(['A',k,1]), but quite a bit faster.  The basic idea should be easily extensible to the combinatorial interpretations of the other affine types with window notations, and I've discussed a bit with N. Thiery about hacking together a kind of window notation for the other types.


---

Comment by sdenton created at 2013-02-10 23:02:03

Recent changes:
* Moved everything into a single file, as per reviewer request
* Expanded to include types affine A,B,C,D,G
* added TestSuite runs, for better coverage
* fixed a bug with apply_simple_reflection_left in Type G


---

Comment by sdenton created at 2013-03-17 20:37:02

Added is_fully_commutative to type A.
Rebased to fix an issue with the new documentation system.


---

Comment by sdenton created at 2013-03-17 20:37:39

Changing status from new to needs_review.


---

Comment by chrisjamesberg created at 2013-03-24 16:53:00

Nicolas volunteered me to review the patch. =)
I sent my comments directly to Tom. When he posts a new version, I can review that.

Chris


---

Comment by tscrim created at 2013-06-01 17:06:33

This will need to have a minor rebase over #14673.


---

Comment by chrisjamesberg created at 2013-06-18 08:41:39

Changing keywords from "affine, combinatorics, days38" to "affine, combinatorics, days38, days49".


---

Comment by aschilling created at 2013-06-18 08:53:18

Hi Tom,

I think you need to rebase your patch on top of #8392. There is a conflict with the all.py file!

Also, would it be possible to explain the input of AffinePermutations in the header, since this is what the user will see if (s)he types AffinePermutations??.

Thank you!

Anne


---

Comment by aschilling created at 2013-06-18 09:21:25

Hi Tom,

I put a rebased version of the patch on the sage-combinat queue. But please also add the input information for the AffinePermutations.

Anne


---

Comment by aschilling created at 2013-06-18 13:45:10

Hi Tom,

Here are some more comments about your patch:

-  is_i_grassmannian(i=0, side='right') needs a description of the input (like the i).

- Please explain the input of to_weyl_group_element(W=None)

- has_right_descent has a description of an option which is not there ('right' or 'left').
Same for has_left_descent.

- Everywhere in the file you seem to use OPTIONS:. This should be replaced by or combined with INPUT. Also, as far as I know the syntax is

```
- ``variable`` -- description of what it does.
```


Tom, could you make the above changes? Also, I left a review patch called trac_12940-review-as.patch on the sage-combinat queue. Please fold it into the rebased patch on the sage-combinat queue.

Thanks!

Anne


---

Comment by aschilling created at 2013-06-18 13:49:12

Hi Tom,

One more comment: please use

REFERENCE:

[XXX] blaba

for references and cite them via [XXX]_. See elsewhere in Sage how this is done!

Anne


---

Attachment


---

Comment by aschilling created at 2013-06-19 10:26:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-06-20 07:16:57

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2013-06-20 07:16:57

The patch needs a proper commit message (use hg qrefresh -e to change the message).


---

Attachment


---

Comment by aschilling created at 2013-06-20 08:31:28

Changing status from needs_info to needs_review.


---

Comment by chrisjamesberg created at 2013-06-20 08:32:36

Changing status from needs_review to positive_review.


---

Comment by chrisjamesberg created at 2013-06-20 08:32:36

Apply: trac_12940_affine_permutations-td.3.patch


---

Comment by jdemeyer created at 2013-06-20 09:11:50

This patch badly abuses `assert` statements. Assertions should be used to check correctness of the code, not to validate user input. Any `AssertionError` caused by the use of public functions is by definition a bug.


---

Comment by jdemeyer created at 2013-06-20 09:11:50

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-06-20 09:14:46

Also, while you're at it, could you use the new style doctest continuations:

```
sage: for a in CP: 
....:     p.to_lehmer_code(a[0],a[1])
```

instead of

```
sage: for a in CP: 
...     p.to_lehmer_code(a[0],a[1])
```



---

Comment by sdenton created at 2013-06-20 09:29:22

I'm confused, then; my understanding of the clonable array class was that it needs to have a check method which throws assertion errors if the 'checked' clonable array doesn't actually check out as a proper object.  This checks simultaneously for user errors and for code errors.

Could you point me to a discussion or coding convention on proper ways to use assert statements or check for input correctness?


---

Comment by sdenton created at 2013-06-20 10:13:05

Changing status from needs_work to needs_review.


---

Comment by sdenton created at 2013-06-20 10:14:57

Changed all assert statements outside of the 'check' and '_test.+' methods into ValueErrors.  Others left as 'assert' according to conventions in:
http://www.sagemath.org/doc/reference/structure/sage/structure/list_clone.html


---

Comment by jdemeyer created at 2013-06-20 10:20:55

Replying to [comment:34 sdenton]:
> Could you point me to a discussion or coding convention on proper ways to use assert statements or check for input correctness?
This has been discussed before, but I can't find the discussion anymore. There is some discussion at [http://stackoverflow.com/questions/944592/best-practice-for-python-assert/945135#945135](http://stackoverflow.com/questions/944592/best-practice-for-python-assert/945135#945135)

Assertions (and this is not specific to Sage or Python) are internal checks for code correctness. Don't forget that assertions can be turned off (run Python with `-O` switch) and you don't want user code to depend on whether on not assertions are enabled.

I think of assertion failures as serious as a crash due to a Segmentation Fault: it is always a bug in the program if one occurs.

Most of the assertions in this ticket should be replaced by something of the form

```
if not some_condition:
    raise ValueError("some_condition failed")
```

or `TypeError` depending on the kind of error.


---

Comment by chrisjamesberg created at 2013-06-20 10:21:09

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-06-20 10:23:11

Replying to [comment:36 sdenton]:
> Changed all assert statements outside of the 'check' and '_test.+' methods into ValueErrors.  Others left as 'assert' according to conventions in:
> http://www.sagemath.org/doc/reference/structure/sage/structure/list_clone.html
I think that `IncreasingArray` is doing things wrongly, so don't copy from that. It's not so bad though, since `IncreasingArray` is not meant to be used directly by users (it's a "small extension class for testing `ClonableArray`").


---

Comment by sdenton created at 2013-06-20 10:25:24

I think that's the whole idea of the check methods: they aren't directly accessed by the user, but called to check the integrity of the object.


---

Comment by sdenton created at 2013-06-20 10:27:42

Similarly, should one use asserts or exceptions in test suite methods?


---

Comment by jdemeyer created at 2013-06-20 10:29:23

Replying to [comment:41 sdenton]:
> Similarly, should one use asserts or exceptions in test suite methods?
In test suites, assertions are fine.


---

Comment by jdemeyer created at 2013-06-20 10:30:36

The following is still a bug. It's a clear example of bad user input leading to an `AssertionError`:

```
sage: AffinePermutationGroup(['A',8,1])([0])
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
...
AssertionError: Length of list must be k+1=9.
```



---

Comment by jdemeyer created at 2013-06-20 10:30:36

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-06-20 10:32:05

Replying to [comment:40 sdenton]:
> I think that's the whole idea of the check methods: they aren't directly accessed by the user
It doesn't matter if they are directly or indirectly accessed by the user, what matters is that these "check" methods are used for validating user input.


---

Comment by jdemeyer created at 2013-06-20 10:33:16

Read this sentence again: *I think of assertion failures as serious as a crash due to a Segmentation Fault: it is always a bug in the program if one occurs.*


---

Comment by jdemeyer created at 2013-06-20 10:43:13

Please don't use `ClonableArray` as an example, it shouldn't be using assertions that way.


---

Comment by jdemeyer created at 2013-06-20 11:33:41

One more way to think of assertions: they express "I _know_ this condition is true", not "I want to _check_ that this condition is true".


---

Comment by aschilling created at 2013-06-20 12:46:19

Hi Jeroen,

Thank you for your comments! The asserts in the check methods of ClonableArrays/Lists seem to be in a grey area, since they are used for both the user input check as well as internal checks. Is assert ok here? If not, I would strongly suggest to change the documentation of ClonableArray to show how things are supposed to be used!

Thank you,

Anne

Replying to [comment:47 jdemeyer]:
> One more way to think of assertions: they express "I _know_ this condition is true", not "I want to _check_ that this condition is true".


---

Comment by sdenton created at 2013-06-20 13:03:02

If this is the accepted usage of asserts vs ValueErrors in Sage, they should be written up as such in the developer's guide; there wasn't any way for me to know this was the local convention.  Additionally, a bug+patch should be made for the Cloneable Array class.

The line between internal assumptions and user input becomes very thin in Sage, and this is an example of a very close case.  The idea of the Cloneable Array is that it's a simple data type with some extra assumptions.  When making a new one of these objects, you might break those assumptions temporarily, but should end up with something that satisfies the assumptions, and the 'check' methods are intended to check that your methods have actually made this transformation effectively.  This is a machine use of the check method, but - as you say - the check method also works well to check user input.  After all, user input IS code in Sage!  It's not a bug in my code if buggy input fails to run.  It's a very, very different situation from taking user input from, say, a web form and getting an Assertion Error.  Users can run arbitrary code, so if you want to avoid assertion errors at all cost, it should simply be completely off-limits to use assert statements at all.  I have, as a user, definitely used statements like ``X._test_whatever()``, which, as you say, are fine to have assert statements.

In short, if an assertion error happens in my code, yes, it's a bug in the program.  If one happens due to code that's been supplied by the user, it's a bug in the user's input.  

The only reason I can actually get behind to switch to ValueErrors is that it's possible to turn off assertion errors at the Python level.  But this doesn't seem to be why you think they're as bad as segmentation faults....

In any case, I've refactored the code, and am attaching a new version of the patch.


---

Comment by jdemeyer created at 2013-06-20 14:02:39

Replying to [comment:49 sdenton]:
> If this is the accepted usage of asserts vs ValueErrors in Sage, they should be written up as such in the developer's guide; there wasn't any way for me to know this was the local convention.
It's not a local convention, it is a general convention independent of Sage or Python. I think you will find that [http://en.wikipedia.org/wiki/Assertion_(software_development)#Comparison_with_error_handling](http://en.wikipedia.org/wiki/Assertion_(software_development)#Comparison_with_error_handling) mostly agrees with me.

> After all, user input IS code in Sage!
I don't understand what you mean with this.

> It's a very, very different situation from taking user input from, say, a web form and getting an Assertion Error.
Why? What makes calling `AffinePermutationGroup()` so different from filling in a web form?

> I have, as a user, definitely used statements like ``X._test_whatever()``, which, as you say, are fine to have assert statements.
Underscored methods are supposed to be private, so you're expected to know what you're doing. Everything I said applies to using public, documented functions. Of course, everything can happen if you mess with internal data structures.

> It's not a bug in my code if buggy input fails to run.
That's perhaps a matter of opinion. Would you find it a bug in the `rm` command if it crashed with a Segmentation Fault if the file could not be found? Would you find it a bug in your web browser if it crashed every time you fill in a non-existing URL?


---

Comment by jdemeyer created at 2013-06-20 14:09:56

Perhaps this should be a `NotImplementedError`:

```
raise ValueError('Cartan type provided is not implemented as an affine permutation group.')
```



---

Comment by sdenton created at 2013-06-20 15:16:17

Switched to NotImplementedError in the indicated place.  Can this finally get out the door now?


---

Comment by sdenton created at 2013-06-20 16:42:15

Patch file.


---

Comment by aschilling created at 2013-06-20 16:45:02

Changing status from needs_work to positive_review.


---

Attachment


---

Comment by jdemeyer created at 2013-07-31 12:53:26

Resolution: fixed
