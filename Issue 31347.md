# Issue 31347: Fix suitesparse/cvxopt /usr/local leakage

archive/issues_031347.json:
```json
{
    "body": "CC:  @jhpalmieri @dimpase @orlitzky\n\nWe fix a simple bug in our build system: \n\nThe value of `SAGE_SUITESPARSE_LOCALINSTALL` is set in `build/pkgs/suitesparse/spkg-configure.m4` but is not actually passed on to `build/pkgs/cvxopt/spkg-install.in`.\n\nAs a result, `suitesparse` from `/usr/local` can leak in, as observed in #31567?replyto=25#comment:25\n\nIssue created by migration from https://trac.sagemath.org/ticket/31584\n\n",
    "created_at": "2021-03-30T22:38:29Z",
    "labels": [
        "packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Fix suitesparse/cvxopt /usr/local leakage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31347",
    "user": "@mkoeppe"
}
```
CC:  @jhpalmieri @dimpase @orlitzky

We fix a simple bug in our build system: 

The value of `SAGE_SUITESPARSE_LOCALINSTALL` is set in `build/pkgs/suitesparse/spkg-configure.m4` but is not actually passed on to `build/pkgs/cvxopt/spkg-install.in`.

As a result, `suitesparse` from `/usr/local` can leak in, as observed in #31567?replyto=25#comment:25

Issue created by migration from https://trac.sagemath.org/ticket/31584





---

archive/issue_comments_448500.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-30T22:44:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448500",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448501.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-30T22:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448501",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448502.json:
```json
{
    "body": "Tested in #31567",
    "created_at": "2021-03-31T02:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448502",
    "user": "@mkoeppe"
}
```

Tested in #31567



---

archive/issue_comments_448503.json:
```json
{
    "body": "Why the variable name change? `SAGE_SUITESPARSE_PREFIX` doesn't contain the prefix when suitesparse from the system is being used so this *looks* wrong (why aren't we passing the prefix unconditionally?) even though it's doing the right thing. I think that's why dima changed the name in the first place in f2cc5b45.",
    "created_at": "2021-03-31T11:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448503",
    "user": "@orlitzky"
}
```

Why the variable name change? `SAGE_SUITESPARSE_PREFIX` doesn't contain the prefix when suitesparse from the system is being used so this *looks* wrong (why aren't we passing the prefix unconditionally?) even though it's doing the right thing. I think that's why dima changed the name in the first place in f2cc5b45.



---

archive/issue_comments_448504.json:
```json
{
    "body": "On second thought, the only possible values of `SAGE_SUITESPARSE_PREFIX` are `$SAGE_LOCAL` and the empty string, so I'm not sure how this fixes the problem.",
    "created_at": "2021-03-31T13:15:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448504",
    "user": "@orlitzky"
}
```

On second thought, the only possible values of `SAGE_SUITESPARSE_PREFIX` are `$SAGE_LOCAL` and the empty string, so I'm not sure how this fixes the problem.



---

archive/issue_comments_448505.json:
```json
{
    "body": "I have expanded the ticket description, please take a look",
    "created_at": "2021-03-31T17:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448505",
    "user": "@mkoeppe"
}
```

I have expanded the ticket description, please take a look



---

archive/issue_comments_448506.json:
```json
{
    "body": "Replying to [comment:5 mjo]:\n> `SAGE_SUITESPARSE_PREFIX` doesn't contain the prefix when suitesparse from the system is being used \n\nThat's right, but this matches the semantics of the other `SAGE_..._PREFIX` variables; see for example `build/pkgs/mpir/spkg-configure.m4` for `SAGE_GMP_PREFIX`.",
    "created_at": "2021-03-31T17:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448506",
    "user": "@mkoeppe"
}
```

Replying to [comment:5 mjo]:
> `SAGE_SUITESPARSE_PREFIX` doesn't contain the prefix when suitesparse from the system is being used 

That's right, but this matches the semantics of the other `SAGE_..._PREFIX` variables; see for example `build/pkgs/mpir/spkg-configure.m4` for `SAGE_GMP_PREFIX`.



---

archive/issue_comments_448507.json:
```json
{
    "body": "Replying to [comment:5 mjo]:\n> why aren't we passing the prefix unconditionally?\n\nBecause normal compile/link tests do not determine the install prefix.",
    "created_at": "2021-03-31T17:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448507",
    "user": "@mkoeppe"
}
```

Replying to [comment:5 mjo]:
> why aren't we passing the prefix unconditionally?

Because normal compile/link tests do not determine the install prefix.



---

archive/issue_comments_448508.json:
```json
{
    "body": "Replying to [comment:6 mjo]:\n> the only possible values of `SAGE_SUITESPARSE_PREFIX` are `$SAGE_LOCAL` and the empty string, so I'm not sure how this fixes the problem.\n\nFrom `build/pkgs/cvxopt/spkg-install.in`:\n\n```\nif test \"x$SAGE_SUITESPARSE_PREFIX\" != \"x\"; then\n   export CVXOPT_SUITESPARSE_LIB_DIR=\"${SAGE_SUITESPARSE_PREFIX}\"\n   export CVXOPT_SUITESPARSE_INC_DIR=\"${SAGE_SUITESPARSE_PREFIX}/include\"\nfi\n```\n\n\nEffectively we only set these variables for cvxopt when we use suitesparse from spkg-configure.  Setting these variables disables cvxopt's use of `/usr/local` - https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55\n\nWe do not need to do this when we use system suitesparse, as we do not want to claim authority that our configure script's suitesparse-finding technique is better than the one in cvxopt's install script.",
    "created_at": "2021-03-31T17:36:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448508",
    "user": "@mkoeppe"
}
```

Replying to [comment:6 mjo]:
> the only possible values of `SAGE_SUITESPARSE_PREFIX` are `$SAGE_LOCAL` and the empty string, so I'm not sure how this fixes the problem.

From `build/pkgs/cvxopt/spkg-install.in`:

```
if test "x$SAGE_SUITESPARSE_PREFIX" != "x"; then
   export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_SUITESPARSE_PREFIX}"
   export CVXOPT_SUITESPARSE_INC_DIR="${SAGE_SUITESPARSE_PREFIX}/include"
fi
```


Effectively we only set these variables for cvxopt when we use suitesparse from spkg-configure.  Setting these variables disables cvxopt's use of `/usr/local` - https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55

We do not need to do this when we use system suitesparse, as we do not want to claim authority that our configure script's suitesparse-finding technique is better than the one in cvxopt's install script.



---

archive/issue_comments_448509.json:
```json
{
    "body": "Replying to [comment:10 mkoeppe]:\n> \n> Effectively we only set these variables for cvxopt when we use suitesparse from spkg-configure.  Setting these variables disables cvxopt's use of `/usr/local` - https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55\n\nIsn't it the other way around? From `build/pkgs/suitesparse/spkg-configure.m4`,\n\n\n```\nAS_IF([test x$sage_spkg_install_suitesparse = xyes], [\n  AC_SUBST(SAGE_SUITESPARSE_PREFIX, ['$SAGE_LOCAL'])\n], [\n  AC_SUBST(SAGE_SUITESPARSE_PREFIX, [''])\n])\n```\n\n\nAs a result, I think this block only gets executed when `$SAGE_SUITESPARSE_PREFIX = $SAGE_LOCAL`,\n\n\n```\nif test \"x$SAGE_SUITESPARSE_PREFIX\" != \"x\"; then\n   export CVXOPT_SUITESPARSE_LIB_DIR=\"${SAGE_SUITESPARSE_PREFIX}\"\n   export CVXOPT_SUITESPARSE_INC_DIR=\"${SAGE_SUITESPARSE_PREFIX}/include\"\nfi\n```\n\n\nwhich is why I don't think that replacing `$SAGE_LOCAL` with `$SAGE_SUITESPARSE_PREFIX` has changed anything there.",
    "created_at": "2021-03-31T20:28:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448509",
    "user": "@orlitzky"
}
```

Replying to [comment:10 mkoeppe]:
> 
> Effectively we only set these variables for cvxopt when we use suitesparse from spkg-configure.  Setting these variables disables cvxopt's use of `/usr/local` - https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55

Isn't it the other way around? From `build/pkgs/suitesparse/spkg-configure.m4`,


```
AS_IF([test x$sage_spkg_install_suitesparse = xyes], [
  AC_SUBST(SAGE_SUITESPARSE_PREFIX, ['$SAGE_LOCAL'])
], [
  AC_SUBST(SAGE_SUITESPARSE_PREFIX, [''])
])
```


As a result, I think this block only gets executed when `$SAGE_SUITESPARSE_PREFIX = $SAGE_LOCAL`,


```
if test "x$SAGE_SUITESPARSE_PREFIX" != "x"; then
   export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_SUITESPARSE_PREFIX}"
   export CVXOPT_SUITESPARSE_INC_DIR="${SAGE_SUITESPARSE_PREFIX}/include"
fi
```


which is why I don't think that replacing `$SAGE_LOCAL` with `$SAGE_SUITESPARSE_PREFIX` has changed anything there.



---

archive/issue_comments_448510.json:
```json
{
    "body": "Sorry, I mistyped: I meant to type \"when we use suitesparse from SPKG\".",
    "created_at": "2021-03-31T20:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448510",
    "user": "@mkoeppe"
}
```

Sorry, I mistyped: I meant to type "when we use suitesparse from SPKG".



---

archive/issue_comments_448511.json:
```json
{
    "body": "Replying to [comment:11 mjo]:\n> I don't think that replacing `$SAGE_LOCAL` with `$SAGE_SUITESPARSE_PREFIX` has changed anything there.\n\nThat's right, this part of the change makes no difference.",
    "created_at": "2021-03-31T20:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448511",
    "user": "@mkoeppe"
}
```

Replying to [comment:11 mjo]:
> I don't think that replacing `$SAGE_LOCAL` with `$SAGE_SUITESPARSE_PREFIX` has changed anything there.

That's right, this part of the change makes no difference.



---

archive/issue_comments_448512.json:
```json
{
    "body": "The bug is fixed by the first commit (7ff26dfad).",
    "created_at": "2021-03-31T20:40:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448512",
    "user": "@mkoeppe"
}
```

The bug is fixed by the first commit (7ff26dfad).



---

archive/issue_comments_448513.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-31T20:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448513",
    "user": "@orlitzky"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448514.json:
```json
{
    "body": "Oh, I see it now. The variable `SAGE_SUITESPARSE_PREFIX` appears in `build/bin/sage-build-env-config.in` (before the fix), but `SAGE_SUITESPARSE_LOCALINSTALL` does not.",
    "created_at": "2021-03-31T20:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448514",
    "user": "@orlitzky"
}
```

Oh, I see it now. The variable `SAGE_SUITESPARSE_PREFIX` appears in `build/bin/sage-build-env-config.in` (before the fix), but `SAGE_SUITESPARSE_LOCALINSTALL` does not.



---

archive/issue_comments_448515.json:
```json
{
    "body": "Thanks for reviewing!",
    "created_at": "2021-03-31T22:14:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448515",
    "user": "@mkoeppe"
}
```

Thanks for reviewing!



---

archive/issue_comments_448516.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-02T22:56:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31347",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31347#issuecomment-448516",
    "user": "@vbraun"
}
```

Resolution: fixed
