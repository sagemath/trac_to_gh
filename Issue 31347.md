# Issue 31347: Fix suitesparse/cvxopt /usr/local leakage

Issue created by migration from https://trac.sagemath.org/ticket/31584

Original creator: mkoeppe

Original creation time: 2021-03-30 22:38:29

CC:  jhpalmieri dimpase mjo

We fix a simple bug in our build system: 

The value of `SAGE_SUITESPARSE_LOCALINSTALL` is set in `build/pkgs/suitesparse/spkg-configure.m4` but is not actually passed on to `build/pkgs/cvxopt/spkg-install.in`.

As a result, `suitesparse` from `/usr/local` can leak in, as observed in #31567?replyto=25#comment:25


---

Comment by git created at 2021-03-30 22:44:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-30 22:45:28

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-31 02:12:10

Tested in #31567


---

Comment by mjo created at 2021-03-31 11:38:34

Why the variable name change? `SAGE_SUITESPARSE_PREFIX` doesn't contain the prefix when suitesparse from the system is being used so this _looks_ wrong (why aren't we passing the prefix unconditionally?) even though it's doing the right thing. I think that's why dima changed the name in the first place in f2cc5b45.


---

Comment by mjo created at 2021-03-31 13:15:34

On second thought, the only possible values of `SAGE_SUITESPARSE_PREFIX` are `$SAGE_LOCAL` and the empty string, so I'm not sure how this fixes the problem.


---

Comment by mkoeppe created at 2021-03-31 17:23:15

I have expanded the ticket description, please take a look


---

Comment by mkoeppe created at 2021-03-31 17:27:45

Replying to [comment:5 mjo]:
> `SAGE_SUITESPARSE_PREFIX` doesn't contain the prefix when suitesparse from the system is being used 

That's right, but this matches the semantics of the other `SAGE_..._PREFIX` variables; see for example `build/pkgs/mpir/spkg-configure.m4` for `SAGE_GMP_PREFIX`.


---

Comment by mkoeppe created at 2021-03-31 17:28:33

Replying to [comment:5 mjo]:
> why aren't we passing the prefix unconditionally?

Because normal compile/link tests do not determine the install prefix.


---

Comment by mkoeppe created at 2021-03-31 17:36:27

Replying to [comment:6 mjo]:
> the only possible values of `SAGE_SUITESPARSE_PREFIX` are `$SAGE_LOCAL` and the empty string, so I'm not sure how this fixes the problem.

From `build/pkgs/cvxopt/spkg-install.in`:

```
if test "x$SAGE_SUITESPARSE_PREFIX" != "x"; then
   export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_SUITESPARSE_PREFIX}"
   export CVXOPT_SUITESPARSE_INC_DIR="${SAGE_SUITESPARSE_PREFIX}/include"
fi
```


Effectively we only set these variables for cvxopt when we use suitesparse from spkg-configure.  Setting these variables disables cvxopt's use of `/usr/local` - https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55

We do not need to do this when we use system suitesparse, as we do not want to claim authority that our configure script's suitesparse-finding technique is better than the one in cvxopt's install script.


---

Comment by mjo created at 2021-03-31 20:28:49

Replying to [comment:10 mkoeppe]:
> 
> Effectively we only set these variables for cvxopt when we use suitesparse from spkg-configure.  Setting these variables disables cvxopt's use of `/usr/local` - https://github.com/cvxopt/cvxopt/blob/master/setup.py#L55

Isn't it the other way around? From `build/pkgs/suitesparse/spkg-configure.m4`,


```
AS_IF([test x$sage_spkg_install_suitesparse = xyes], [
  AC_SUBST(SAGE_SUITESPARSE_PREFIX, ['$SAGE_LOCAL'])
], [
  AC_SUBST(SAGE_SUITESPARSE_PREFIX, [''])
])
```


As a result, I think this block only gets executed when `$SAGE_SUITESPARSE_PREFIX = $SAGE_LOCAL`,


```
if test "x$SAGE_SUITESPARSE_PREFIX" != "x"; then
   export CVXOPT_SUITESPARSE_LIB_DIR="${SAGE_SUITESPARSE_PREFIX}"
   export CVXOPT_SUITESPARSE_INC_DIR="${SAGE_SUITESPARSE_PREFIX}/include"
fi
```


which is why I don't think that replacing `$SAGE_LOCAL` with `$SAGE_SUITESPARSE_PREFIX` has changed anything there.


---

Comment by mkoeppe created at 2021-03-31 20:37:23

Sorry, I mistyped: I meant to type "when we use suitesparse from SPKG".


---

Comment by mkoeppe created at 2021-03-31 20:39:25

Replying to [comment:11 mjo]:
> I don't think that replacing `$SAGE_LOCAL` with `$SAGE_SUITESPARSE_PREFIX` has changed anything there.

That's right, this part of the change makes no difference.


---

Comment by mkoeppe created at 2021-03-31 20:40:22

The bug is fixed by the first commit (7ff26dfad).


---

Comment by mjo created at 2021-03-31 20:52:32

Changing status from needs_review to positive_review.


---

Comment by mjo created at 2021-03-31 20:52:32

Oh, I see it now. The variable `SAGE_SUITESPARSE_PREFIX` appears in `build/bin/sage-build-env-config.in` (before the fix), but `SAGE_SUITESPARSE_LOCALINSTALL` does not.


---

Comment by mkoeppe created at 2021-03-31 22:14:54

Thanks for reviewing!


---

Comment by vbraun created at 2021-04-02 22:56:39

Resolution: fixed
