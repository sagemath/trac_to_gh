# Issue 29704: Modularization of sagelib: Break out a separate package sage-repl

Issue created by migration from https://trac.sagemath.org/ticket/29941

Original creator: mkoeppe

Original creation time: 2020-06-22 23:56:19

CC:  klee @tobiasdiez @kliem mjo dimpase jhpalmieri fbissey

This package would package at least the following:
 - `sage.repl` (and hence depends on on basic rings such as `ZZ`, hence on `sage-categories` (#29865))
 - `sage.doctest` (which depends on `sage.repl`)
 - `sage.misc.sage_input`
 - ??


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by git created at 2021-11-27 06:20:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-27 06:21:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-11-28 00:00:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 03:32:12

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-05 03:43:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 08:34:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 09:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 19:29:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 21:34:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 21:50:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 21:59:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 22:13:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-05 23:04:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-06 01:12:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-06 19:28:52

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-06 19:48:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-06 20:22:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-07 02:52:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-08 00:28:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-11 07:00:11

Changing status from new to needs_review.


---

Comment by git created at 2021-12-11 08:11:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-13 04:10:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-13 06:59:41

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-18 06:24:06

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-01-02 22:56:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-01-23 02:03:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-20 21:43:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-04 19:05:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-05-04 19:09:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-04 20:46:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-05-04 20:47:41

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-04 21:02:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-04 21:05:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-04 21:09:53


```
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/pkgs/sagemath-repl/.tox/py39/lib/python3.9/site-packages/sage/repl/all.py", line 1, in <module>
    from sage.misc.lazy_import import lazy_import
ModuleNotFoundError: No module named 'sage.misc.lazy_import'
```



---

Comment by mkoeppe created at 2022-05-04 21:09:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-04 21:52:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-04 22:10:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-04 22:24:03

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-04 22:43:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-04 23:28:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-05 05:34:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-05-05 18:18:11

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-05-05 18:23:10

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-05 18:52:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-05 18:53:27

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-05 19:04:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-05 20:31:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-05-05 20:53:46

the 1st test fails:

```
$ ./bootstrap && ./sage -sh -c '(cd pkgs/sagemath-environment && SAGE_NUM_THREADS=8 tox -r -v -v -v -e py39)'
...
  copying sage/features/latex.py -> build/lib/sage/features
  copying sage/features/graph_generators.py -> build/lib/sage/features
  copying sage/features/pkg_systems.py -> build/lib/sage/features
  running build_scripts
  creating build/scripts-3.9
  error: [Errno 2] No such file or directory: 'bin/sage'
  error: subprocess-exited-with-error
  
  × Building wheel for sagemath-environment (pyproject.toml) did not run successfully.
  │ exit code: 1
  ╰─> See above for output.
  
  note: This error originates from a subprocess, and is likely not a problem with pip.
  full command: /Users/dima/sage/pkgs/sagemath-environment/.tox/py39/bin/python /Users/dima/sage/pkgs/sagemath-environment/.tox/py39/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py build_wheel /var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/tmp_aul7hyy
  cwd: /private/var/folders/lh/tzyg2vbn4z99vg__rg2_t_f80000gs/T/pip-req-build-tveamdav
  Building wheel for sagemath-environment (pyproject.toml) ... error
  ERROR: Failed building wheel for sagemath-environment
Failed to build sagemath-environment
ERROR: Could not build wheels for sagemath-environment, which is required to install pyproject.toml-based projects
ERROR: invocation failed (exit code 1)
py39 finish: installpkg /Users/dima/sage/pkgs/sagemath-environment/.tox/.tmp/package/1/sagemath-environment-9.6rc3.tar.gz after 6.46 seconds
______________________________________________________________________ summary ______________________________________________________________________
ERROR:   py39: InvocationError for command /Users/dima/sage/pkgs/sagemath-environment/.tox/py39/bin/python -m pip install --exists-action w -v .tox/.tmp/package/1/sagemath-environment-9.6rc3.tar.gz (exited with code 1)
```



---

Comment by git created at 2022-05-05 20:54:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-05 20:55:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-05 20:56:31

Replying to [comment:98 dimpase]:
> the 1st test fails:
> {{{
>   error: [Errno 2] No such file or directory: 'bin/sage'
> }}}

Thanks for testing! I had forgotten to add one file. Fixed now


---

Comment by git created at 2022-05-06 00:52:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-06 01:20:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-06 03:52:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-06 04:20:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-06 06:44:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-06 07:13:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-05-06 10:09:01

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-05-06 10:09:01

lgtm


---

Comment by mkoeppe created at 2022-05-06 14:58:26

Thank you!


---

Comment by dimpase created at 2022-05-06 16:05:16

I spoke too soon, sorry. This broke `make sagelib`, something with `ECL_CFLAGS` or so:

```
$ make sagelib-clean sagelib-uninstall
$ make sagelib
...
[sagelib-9.6.rc3] 11303 | static char __pyx_doc_4sage_7cpython_6string_bytes_to_str[] = "bytes_to_str(b, encoding=None, errors=None) -> str\nFile: sage/cpython/string.pxd (starting at line 28)\n\n    Convert ``bytes`` to ``str``.\n\n    This decodes the given ``bytes`` to a Python 3 unicode ``str`` using\n    the specified encoding.  It is a no-op on ``str`` input.\n\n    EXAMPLES::\n\n        sage: from sage.cpython.string import bytes_to_str\n        sage: s = bytes_to_str(b'\\xcf\\x80')\n        sage: s == u'\317\200'\n        True\n        sage: bytes_to_str([])\n        Traceback (most recent call last):\n        ...\n        TypeError: expected bytes, list found\n    ";
[sagelib-9.6.rc3]       |             ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[sagelib-9.6.rc3] gcc: warning: ECL_CFLAGS: linker input file unused because linking not done
[sagelib-9.6.rc3] gcc: error: ECL_CFLAGS: linker input file not found: No such file or directory
[sagelib-9.6.rc3] error: Command "gcc -Wno-unused-result -Wsign-compare -DDYNAMIC_ANNOTATIONS_ENABLED=1 -DNDEBUG -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -D_GNU_SOURCE -fPIC -fwrapv -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -D_GNU_SOURCE -fPIC -fwrapv -O2 -fexceptions -g -grecord-gcc-switches -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fstack-protector-strong -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -D_GNU_SOURCE -fPIC -fwrapv -g -O2 -fPIC -Isage/libs -IECL_INCDIR -I./sage/cpython -Isage/cpython -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/cysignals -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-standard -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/numpy/core/include -I/usr/include/python3.9 -Ibuild/cythonized -I/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/local/var/lib/sage/venv-python3.9/include -I/usr/include/python3.9 -c build/cythonized/sage/libs/ecl.c -o build/temp.linux-x86_64-3.9/build/cythonized/sage/libs/ecl.o -fno-strict-aliasing -DCYTHON_CLINE_IN_TRACEBACK=1 ECL_CFLAGS -std=c99" failed with exit status 1
[sagelib-9.6.rc3] 
[sagelib-9.6.rc3] real	0m7.340s
[sagelib-9.6.rc3] user	0m5.870s
[sagelib-9.6.rc3] sys	0m1.481s
make[4]: *** [Makefile:2946: sagelib-SAGE_VENV-no-deps] Error 1
```



---

Comment by dimpase created at 2022-05-06 16:05:16

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2022-05-06 16:07:04

this was already in #33803


---

Comment by git created at 2022-05-06 16:38:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-06 16:58:05

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-05-06 17:05:19

with the latest changes I see

```
ModuleNotFoundError: No module named 'sage.all__sagemath_repl'
(lots of doctest failures are expected)
```

If this is OK, feel free to turn it to positive review.

Otherwise, OK.


---

Comment by mkoeppe created at 2022-05-06 17:49:56

Replying to [comment:115 dimpase]:
> with the latest changes I see
> {{{
> ModuleNotFoundError: No module named 'sage.all__sagemath_repl'
> (lots of doctest failures are expected)
> }}}

This is not OK - full log please


---

Attachment

This is on Fedora 34. 
Same branch works fine on macOS...


---

Comment by git created at 2022-05-06 23:13:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-06 23:14:33

Thanks for the log! I have a workaround here. Proper fix in #28925.


---

Comment by dimpase created at 2022-05-07 08:52:28

I still get a similar error, with your latest branch.

```
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,gfan,graphviz,imagemagick,jupymake,kenzo,latte_int,lrslib,mcqd,meataxe,nauty,palp,pandoc,pdf2svg,pdftocairo,plantri,polytopes_db,polytopes_db_4d,pynormaliz,python_igraph,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.groups,sage.plot,sage.rings.number_field,sage.rings.padics,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,sagemath_doc_html,sphinx,tdlib
Doctesting 57 files.
Traceback (most recent call last):
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/bin/sage-runtests", line 151, in <module>
    err = DC.run()
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/lib64/python3.9/site-packages/sage/doctest/control.py", line 1348, in run
    self.run_doctests()
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/lib64/python3.9/site-packages/sage/doctest/control.py", line 1044, in run_doctests
    self.dispatcher = DocTestDispatcher(self)
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/lib64/python3.9/site-packages/sage/doctest/forker.py", line 1626, in __init__
    init_sage(controller)
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/lib64/python3.9/site-packages/sage/doctest/forker.py", line 193, in init_sage
    controller.load_environment()
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/lib64/python3.9/site-packages/sage/doctest/control.py", line 583, in load_environment
    return import_module(self.options.environment)
  File "/usr/lib64/python3.9/importlib/__init__.py", line 127, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
  File "<frozen importlib._bootstrap>", line 1030, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1007, in _find_and_load
  File "<frozen importlib._bootstrap>", line 986, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 680, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 850, in exec_module
  File "<frozen importlib._bootstrap>", line 228, in _call_with_frames_removed
  File "/home/scratch/scratch2/dimpase/sage/sagetrac-mirror/pkgs/sagemath-repl/.tox/py39/lib64/python3.9/site-packages/sage/all__sagemath_repl.py", line 2, in <module>
    from .all__sagemath_environment import *
ModuleNotFoundError: No module named 'sage.all__sagemath_environment'
```



---

Comment by git created at 2022-05-07 16:52:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-07 16:53:24

Thanks for testing - I think I've got everything covered now


---

Comment by mkoeppe created at 2022-05-07 17:03:41

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-07 17:47:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-07 18:16:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-07 18:17:45

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-05-08 12:47:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-05-09 11:08:20

lgtm


---

Comment by dimpase created at 2022-05-09 11:08:20

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-09 17:02:06

Thank you!


---

Comment by git created at 2022-05-15 22:01:39

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-05-15 22:01:39

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2022-05-15 22:08:59

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-05-15 22:08:59

trivial merge


---

Comment by git created at 2022-05-15 22:32:35

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-05-15 22:32:35

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2022-05-15 22:32:45

Changing status from needs_review to positive_review.


---

Comment by git created at 2022-05-26 23:29:08

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-05-26 23:29:08

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2022-05-26 23:29:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-05-28 11:16:34

Not the only fail but e.g.:

```
**********************************************************************
File "src/sage/misc/lazy_attribute.pyx", line 89, in sage.misc.lazy_attribute._lazy_attribute._sage_src_lines_
Failed example:
    lines
Expected:
    81
Got:
    89
**********************************************************************
1 item had failures:
   1 of   6 in sage.misc.lazy_attribute._lazy_attribute._sage_src_lines_
    [100 tests, 1 failure, 2.55 s]
----------------------------------------------------------------------
sage -t --long --warn-long 46.9 --random-seed=123 src/sage/misc/lazy_attribute.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2022-05-28 11:16:34

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-05-28 17:37:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-28 17:37:37

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-28 17:39:08

The failure in sage/doctest/forker.py is unrelated, fixed in #33917.


---

Comment by dimpase created at 2022-05-29 21:40:37

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-05-29 21:40:37

OK


---

Comment by vbraun created at 2022-06-12 12:17:17

Resolution: fixed
