# Issue 33260: coerce vs _coerce_

Issue created by migration from https://trac.sagemath.org/ticket/33497

Original creator: vdelecroix

Original creation time: 2022-03-13 20:56:55

CC:  mmezzarobba

Even though the `_coerce_` method is only implemented in the deprecated sage.structure.parent_old.Parent it is still used in some places. The current situation prevents to build a ring that inherits from Parent and use it as a base ring for the multivariate polynomial ring.

We replace all usage of `_coerce_` by `coerce` and deprecate the former.


---

Comment by vdelecroix created at 2022-03-13 22:25:32

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2022-03-13 22:25:32

New commits:


---

Comment by tscrim created at 2022-03-14 07:10:31

This is definitely a step in the right direction. So +1 on this ticket. Definitely in the documentation it would be good to use `coerce()`. I am a little worried in the code that it might be slower in core code (integers (mod ring), rationals, and polynomial rings specifically). This might be something we just have to swallow when we finish the transition, but I am worried this might hide slightly potential optimizations. I know there are a lot of 'if's in that, so it is not a strong argument. I would probably feel better if there were some timings. What are your thoughts on this?


---

Comment by vdelecroix created at 2022-03-14 07:42:03

Currently there is an indirection : `_coerce_`/`_coerce_c` calls `coerce`. So what I wrote should make everything faster. With the branch, you can see the indirection

```
sage: QQ._coerce_(3)
DeprecationWarning: _coerce_ is deprecated, use coerce instead
See https://trac.sagemath.org/33497 for details.
3
```



---

Comment by tscrim created at 2022-03-14 08:36:12

I see. Thanks. So every parent that you changed already has an `element_constructor` then (and hence making that an indirection)?


---

Comment by vdelecroix created at 2022-03-14 09:05:38

I did not modify any parent. If tests pass, then all parents that are tested have an element constructor...


---

Comment by tscrim created at 2022-03-14 09:17:40

I wasn’t be precise enough, but for the parents that you call `coerce()` instead of `_coerce_()`. Test passing is not an indication because you did these changes. It would need to be tested with the deprecation but *without* the aforementioned change.

I am not sure that is a good thing that there is the element constructor and using the old coercion system as it means it is half way between the two, but that is not so relevant.


---

Comment by vdelecroix created at 2022-03-14 10:25:26

Should I add a warning when the element constructor is not implemented? ie

```diff
diff --git a/src/sage/structure/parent_old.pyx b/src/sage/structure/parent_old.pyx
index 630f0ca861..02c3423a0b 100644
--- a/src/sage/structure/parent_old.pyx
+++ b/src/sage/structure/parent_old.pyx
@@ -39,7 +39,8 @@ from cpython.bool cimport *
 cdef inline check_old_coerce(Parent p):
     if p._element_constructor is not None:
         raise RuntimeError("%s still using old coercion framework" % p)
-
+    from warnings import warn
+    warn("{} does not implement element_constructor".format(p), RuntimeWarning)
 
 cdef class Parent(parent.Parent):
     """
```



---

Comment by tscrim created at 2022-03-14 11:29:10

That is a good idea for a way to check. My guess is there are still parents that use that. However, I suspect there are parents that do not implement it since it is something that comes from using the new style `Parent`. So I would be a little curious as to what would prevent them from moving to the new coercion framework. There also wouldn’t be any way to reach the `_coerce_c()` or _coerce_impl()`, right?

The change `_coerce_c()` -> `coerce()` is not removing an indirection though.


---

Comment by vdelecroix created at 2022-03-14 12:27:43

It seems to me that only multivariate polynomial rings are going through the old coercion framework

```
$ git grep -l '_coerce_c_impl('
rings/polynomial/multi_polynomial_ring_base.pxd
rings/polynomial/multi_polynomial_ring_base.pyx
structure/parent_base.pyx
structure/parent_old.pxd
```



---

Comment by tscrim created at 2022-03-14 23:57:09

Then perhaps we can just leave those calls to `_coerce_c` and fully deprecate `_coerce_()`?

Also, the patchbot seems to report an infinite loop in `schemes/hyperelliptic_curves/monsky_washnitzer.py`:

```
      File "/amd/compute/sagebot/sage/local/var/lib/sage/venv-python3.10.2/lib/python3.10/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 313, in __call__
        return self.coerce(value)
      File "sage/structure/parent.pyx", line 1183, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11113)
        cpdef coerce(self, x):
      File "sage/structure/parent.pyx", line 1215, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11059)
        return (<map.Map>mor)._call_(x)
      File "sage/categories/morphism.pyx", line 457, in sage.categories.morphism.CallMorphism._call_ (build/cythonized/sage/categories/morphism.c:6817)
        return self._codomain(x)
      File "/amd/compute/sagebot/sage/local/var/lib/sage/venv-python3.10.2/lib/python3.10/site-packages/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 313, in __call__
        return self.coerce(value)
```



---

Comment by tscrim created at 2022-03-14 23:57:09

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2022-03-15 07:41:20

Yes, there is something going wrong in "monsky_washnitzer", probably (at least) in the class

`SpecialCubicQuotientRing`

which has no element constructor. Maybe it would also help to add a method "one" to this ring ?

*EDIT*: adding "one" does not fix the infinite recursion


---

Comment by chapoton created at 2022-03-15 21:02:32

I pushed to trac a rough branch (public/monsky_coercion) where I tried to convert the Monsky-Washnitser file to the current coercion system. Not yet working, but possibly close to. Maybe Travis would know better what to do.


---

Comment by chapoton created at 2022-03-18 15:25:50

I have made #33525 for the Monsky problem.


---

Comment by chapoton created at 2022-03-18 15:36:30

I would suggest not to touch the file `schemes/hyperelliptic_curves/monsky_washnitzer.py` here at all.


---

Comment by chapoton created at 2022-03-18 20:47:06

so here is a branch just the same but with no changes in monsky
----
New commits:


---

Comment by chapoton created at 2022-03-19 08:04:13

it seems that the pathcbot ran the doctests without merging the dependency..


---

Comment by tscrim created at 2022-03-19 08:14:25

I think it needs to be manually merged in each ticket for testing.


---

Comment by git created at 2022-03-24 23:19:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-03-24 23:25:12

I just pushed the merge. Running the tests that failed before, I get the following deprecation warnings:

```
sage -t --warn-long 36.7 --random-seed=61225901820605168759510913146636968794 src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 2457, in sage.schemes.hyperelliptic_curves.monsky_washnitzer.SpecialHyperellipticQuotientElement._rmul_
Failed example:
    x._rmul_(y)
Expected:
    y*1*x
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 3103, in sage.schemes.hyperelliptic_curves.monsky_washnitzer.MonskyWashnitzerDifferential._add_
Failed example:
    x*w + w
Expected:
    (1 + x) dx/2y
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 3279, in sage.schemes.hyperelliptic_curves.monsky_washnitzer.MonskyWashnitzerDifferential.extract_pow_y
Failed example:
    (A * C.invariant_differential()).extract_pow_y(5)
Expected:
    [1, 0, 0, 0, 0]
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 3489, in sage.schemes.hyperelliptic_curves.monsky_washnitzer.MonskyWashnitzerDifferential.reduce_pos_y
Failed example:
    (y^2).diff().reduce_pos_y()
Expected:
    (y^2*1, 0 dx/2y)

sage -t --warn-long 36.7 --random-seed=61225901820605168759510913146636968794 src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py", line 735, in sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.coleman_integral
Failed example:
    C.coleman_integral(x*w, P, Q)
Expected:
    O(11^6)
```

and one proper failure:

```
sage -t --warn-long 36.7 --random-seed=61225901820605168759510913146636968794 src/sage/rings/finite_rings/element_pari_ffelt.pyx
**********************************************************************
File "src/sage/rings/finite_rings/element_pari_ffelt.pyx", line 1285, in sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt._gap_init_
Failed example:
    gap.coerce(a)
Expected:
    Traceback (most recent call last):
    ...
    TypeError: order must be at most 65536
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/home/travis/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.finite_rings.element_pari_ffelt.FiniteFieldElement_pari_ffelt._gap_init_[13]>", line 1, in <module>
        gap.coerce(a)
      File "sage/structure/parent.pyx", line 1183, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11113)
        cpdef coerce(self, x):
      File "sage/structure/parent.pyx", line 1213, in sage.structure.parent.Parent.coerce (build/cythonized/sage/structure/parent.c:11039)
        raise TypeError(_LazyString("no canonical coercion from %s to %s", (parent(x), self), {}))
    TypeError: no canonical coercion from Finite Field in a of size 1009^2 to Gap
```



---

Comment by chapoton created at 2022-03-25 07:53:31

any idea where these deprecations comes from ?
the traceback is not very helpful:

```
      File "<doctest sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.coleman_integral[8]>", line 1, in <module>
        C.coleman_integral(x*w, P, Q)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/categories/pushout.py", line 4112, in pushout
        elif S.has_coerce_map_from(Rs[-1]):
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/misc/superseded.py", line 99, in deprecation
        warning(trac_number, message, DeprecationWarning, stacklevel)
```


EDIT: This may hint that monsky_washnitser is not yet in perfect shape..


---

Comment by tscrim created at 2022-03-27 06:27:36

What is happening is this:

```
parent_old.Parent._coerce_impl() -> ParentWithBase._coerce_c_impl() -> _coerce_()
```

(I have also deprecated the second method locally and will push once I figure out how to fix things fully since it either calls `_coerce_` or errors out.) So my guess it is coming from one of these calls:

```
travis@tscrim:~/sage/src/sage/combinat$ grep -R "\._coerce_impl(" ../*
../algebras/commutative_dga.py:            return self._coerce_impl(im_gens)
../categories/crystals.py:            return self._coerce_impl(on_gens)
../interfaces/r.py:        return super(R, self)._coerce_impl(x, use_special=use_special)
../interfaces/polymake.py:        return super(PolymakeAbstract, self)._coerce_impl(x, use_special=use_special)
../interfaces/interface.py:            result = self._coerce_impl(x, use_special=False)
../modular/abvar/homspace.py:            sage: J = J0(37) ; J.Hom(J)._coerce_impl(matrix(ZZ,4,[5..20]))
../modular/abvar/homspace.py:            sage: K = J0(11) * J0(11) ; J.Hom(K)._coerce_impl(matrix(ZZ,4,[5..20]))
../modular/abvar/homspace.py:            return HomsetWithBase._coerce_impl(self, x)
../rings/finite_rings/homset.py:            return self._coerce_impl(im_gens)
../rings/finite_rings/homset.py:                return self._coerce_impl(im_gens)
../rings/multi_power_series_ring.py:            sage: g1 = R._coerce_impl(f1)
../rings/polynomial/pbori/pbori.pyx:            return self._coerce_impl(other)
```

Reducing it down to removing the obvious non-related calls:

```
../algebras/commutative_dga.py:            return self._coerce_impl(im_gens)
../rings/finite_rings/homset.py:            return self._coerce_impl(im_gens)
../rings/finite_rings/homset.py:                return self._coerce_impl(im_gens)
../rings/polynomial/pbori/pbori.pyx:            return self._coerce_impl(other)
```

It is one of these is what is starting the process to yield the error.

However, I don't think that is the root issue. Putting a `print(type(self))` in `parent_old.Parent._coerce_impl` yields

```
 <class 'sage.schemes.hyperelliptic_curves.monsky_washnitzer.SpecialHyperellipticQuotientRing_with_category'>
```

Indeed, that is the problem as that is still using the old coercion framework, which I tested by changing it to inherit from `Parent` instead. I have created #33576 for this.


---

Comment by tscrim created at 2022-03-27 22:46:05

With the changes on #33576, the only failure left I am getting is on `rings/finite_rings/element_pari_ffelt.pyx`, which I believe is essentially a trivial failure because of a different error message because of the coercion change (it is reporting the same error IMO). So I propose changing the doctest output, and then all tests should pass.


---

Comment by git created at 2022-03-29 03:42:28

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2022-03-29 03:43:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-03-29 03:44:35

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-03-29 03:44:35

Here is with fixing the last doctest and the other deprecation I mentioned. I also merged in #33558 to resolve a trivial conflict.


---

Comment by tscrim created at 2022-04-01 06:58:04

Morally green bot (pyflakes warnings are not introduced on this ticket).


---

Comment by tscrim created at 2022-04-05 08:14:46

Ping. Should we try to get this into the next Sage release or wait for the next beta0?


---

Comment by vdelecroix created at 2022-04-05 17:48:33

Would be great to have it in the next release! It is a major step forward in using `Parent`.


---

Comment by tscrim created at 2022-04-06 00:07:25

Only my latest changes need to be reviewed as I have reviewed Frédéric's and (re-)reviewed yours (as Frédéric likely already reviewed yours). If mine are good, then it is a positive review.


---

Comment by vdelecroix created at 2022-04-07 16:44:53

Looks good to me.


---

Comment by vdelecroix created at 2022-04-07 16:57:04

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2022-04-08 00:03:52

Thank you.


---

Comment by vbraun created at 2022-04-09 21:01:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-04-09 21:01:46

Merge failure on top of:

5a999eb9e1 Trac #33468: Feature for gfan

b389f97a3a Trac #33466: sage.features.lrs: Make it a JoinFeature of Lrs, LrsNash; use Executable.absolute_filename

204cbf0584 Trac #33017: LazyImport.__instancecheck__, __subclasscheck__: Return False on ImportError

ae06fa42e0 Trac #31802: Bug in plotting 3d polyhedron with rays, add option polygon='rainbow'

0553c9b0b9 Trac #30749: Characteristic polynomial of central Hyperplane arrangement returns wrong result?

2317d5d7fc Trac #30411: src/tox.ini: Add environment pyright

cf219d6eb2 Trac #33661: Don't test files created by jupyter-sphinx

770a894d6c Trac #33642: Update build/pkgs/matplotlib/install-requires.txt and distros/conda.txt

a4429624dc Trac #33638: GH Actions: Fix cygwin

0a5029cfbe Trac #33430: GH Actions: Fix homebrew-maximal, remove opensuse-15.2.1

7ee048cefb Trac #33426: add more details on conda-based installations of Sage

7acdc3d662 Trac #33246: canonical_label returns incorrect partite sets

6df7b36536 Trac #33063: notebook: update to 6.4.10 to fix deprecation warning

365d2b1957 Trac #33650: Set JUPYTER_DATA_DIR etc. during docbuild

b2ddb07d71 Trac #33635: fixing the broken linter, again

c489291a97 Trac #33632: fix indentation (E111) in pyx files in numerical/

a837fee19e Trac #33626: sageinspect.sage_getfile(x) incorrect when using an alternate suffix for extension modules

216d60bb1b Trac #33633: fix indentation (E111) in pyx files in graphs, libs, proba

39d402cb75 Trac #33629: add negative for continued fractions

4955762701 Trac #33565: Add CODE_OF_CONDUCT.md to the repo

00bc51075d Trac #33560: pytest: ignore cython files

a02eec36bf Trac #33582: clean up docstring formatting in schemes/elliptic_curves/

31995b748a Trac #33618: docbuild: typo in arguments check leads to confusing error

94a131cc20 Trac #33612: sage.matrix.matrix_space: Rename a test_... function to _test_... (with deprecation)

823194cfff Trac #33605: cbc: Add system package information for gentoo, nix

6eb1f67d62 Trac #33593: fix W391 in groups/ and algebras/

5ec6108788 Trac #33571: Correct wrong paths in the developer's guide

b886d89536 Trac #33628: Fig bug in graphs.RandomToleranceGraph

5ee8a50e85 Trac #33616: Simplify inventory builder

0a7c8f485c Trac #33615: full cleanup of modules/fp_graded/

97533a71f9 Trac #33589: Gitpod: track remote trac branch

b8d5371aae Trac #33576: Modernize coercion for SpecialHyperellipticQuotientRing

55da3e109e Trac #33572: sage -pytest

2f104e6454 Trac #33533: Update nbconvert to 6.4.x, add optional package pyppeteer

7a5714ac65 Trac #33366: BipartiteGraph() fails to create graph from graph6 string

dfd98a710e Trac #31006: Add more typing information to manifold package

360ee4c168 Trac #30540: Add package phitigra: Graph editor that works with Jupyter

3f93cd0a9c Trac #29640: Create an AUTHORS.md file with links

d8f76fb1bd Trac #33624: doctest unnecessarily assumes SAGE_VENV/bin contains `sage` binary

b438a78918 Trac #33608: Building documentation is broken in Sage 9.6.beta6

88e25dd77b Trac #33631: Github workflow: Fix pyright

78bfb6c7ad Updated [SageMath](SageMath) version to 9.6.beta7



author 'Vincent Delecroix, Travis Scrimshaw,' does not look right


---

Comment by git created at 2022-04-25 00:22:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-04-25 00:24:04

I am not getting any merge failure on 9.6.rc1. Although I guess this is probably too late to be merged into 9.6, so I guess we just have to wait for 9.7.beta0...


---

Comment by tscrim created at 2022-04-25 00:24:04

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2022-04-25 00:27:41

The failure was actually just "author 'Vincent Delecroix, Travis Scrimshaw,' does not look right". You just fixed that.


---

Comment by vbraun created at 2022-05-20 22:27:15

Resolution: fixed
