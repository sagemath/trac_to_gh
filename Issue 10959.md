# Issue 10959: PolyBoRi fails to build on Solaris with gcc-4.6.0

Issue created by migration from https://trac.sagemath.org/ticket/11083

Original creator: drkirkby

Original creation time: 2011-03-29 22:35:20

Assignee: drkirkby

CC:  alexanderdreyer polybori

When compiling with gcc, PolyBoRi generates position independent code because of the compiler flag -fPIC. It does this on Solaris, and I expect Linux and OS X too. 

However, on Solaris PolyBoRi also generates the compiler flag "`-KPIC`" which is the flag used by Sun (now Oracle) compilers to generate position independent code. GCC has always ignored this flag. However, the latest gcc does not, and considers this an error. 


```
g++ -o Cudd/obj/cuddObj.pic.o -c -O3 -Wno-long-long -Wreturn-type -g -fPIC -ftemplate-depth-100 -O3 -Wno-long-long -Wreturn-type -g -fPIC -KPIC -DNDEBUG -DHAVE_GD -DHAVE_TR1_UNORDERED_MAP -DPACKED -DHAVE_M4RI -DHAVE_GD -DHAVE_IEEE_754 -DBSD -I/export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/local/include -I/export/home/drkirkby/sage-new-gcc/sage-4.7.alpha2/local/include/python2.6 -Ipolybori/include -ICudd/obj -ICudd/util -ICudd/cudd -ICudd/mtr -ICudd/st -ICudd/epd Cudd/obj/cuddObj.cc
g++: error: unrecognized option '-KPIC'
scons: *** [Cudd/obj/cuddObj.pic.o] Error 1
scons: building terminated because of errors.
Error building PolyBoRi.
```


I found this on OpenSolaris, but I'm 99% sure the same would happen on Solaris, since I know the option "`-KPIC`" has always been there on both systems. 

I'm cc'ing the PolyBoRi developers.


---

Comment by drkirkby created at 2011-03-29 23:43:26

I've sent a note to `polybori-discuss`@`lists.sourceforge.net` outlining the problem a few minutes ago.


---

Comment by AlexanderDreyer created at 2011-03-30 07:38:54

Thanks for pointing this out. Since the gcc-installation of t2 seems to be broken. Is there any machine around, where I can get access to?


---

Comment by AlexanderDreyer created at 2011-03-30 08:07:23

Meanwhile. please try out this hack:

```
diff -r 7bb357180e7b SConstruct
--- a/SConstruct        Sun Mar 13 22:34:17 2011 +0100
+++ b/SConstruct        Wed Mar 30 10:05:01 2011 +0200
@@ -276,6 +276,9 @@


 env = Environment(ENV = getenv, options = opts, tools = tools, toolpath = '.')
+if (env['PLATFORM'] == "sunos") and ('gcc' in env['TOOLS']):
+    if '-KPIC' in  env['SHCCFLAGS']:
+      env['SHCCFLAGS'].remove('-KPIC')

 if 'dump' in COMMAND_LINE_TARGETS:
   print env.Dump()
```


If the problem persists, please add replace `scons` by `scons dump` and post the output.

My best,
  Alexander


---

Comment by drkirkby created at 2011-03-30 09:34:45

Replying to [comment:2 AlexanderDreyer]:
> Thanks for pointing this out. Since the gcc-installation of t2 seems to be broken. Is there any machine around, where I can get access to?

gcc on t2.math works fine. William did break it, but I fixed ages ago. t2.math is regularly used to build Sage with the buildbot. It was last built successufully on 20<sup>th</sup> March - only 10 days ago. 

http://build.sagemath.org/sage/buildslaves/t2-1

I just put a note in `/etc/motd` to add this to ones `$HOME/.profile`


```
. /usr/local/bin/t2-setup
```


However, there is currently no gcc-4.6.0 on there, but it should be possible to see if the patch removes the -KPIC option. 

Do you want an account on my Sun Ultra 27? That runs OpenSolaris, not Solaris and is x86 not SPARC.

Although there are some differences, most things are the same. The advantage of that machine is that it is much faster than t2.math. You can build Sage and run all the long doctests in little over an hour if the machine is idle.


---

Comment by AlexanderDreyer created at 2011-03-30 12:06:33

> I just put a note in `/etc/motd` to add this to ones `$HOME/.profile`
> 
> {{{
> . /usr/local/bin/t2-setup
> }}}
Thanks, I didn't know that. Is there a 4.7alpha2 build somewhere?

> However, there is currently no gcc-4.6.0 on there, but it should be possible to see if the patch removes the -KPIC option. 
> 
> Do you want an account on my Sun Ultra 27? That runs OpenSolaris, not Solaris and is x86 not SPARC.
This would be nice, I'll contact you off-Trac

My best
  Alexander


---

Comment by AlexanderDreyer created at 2011-03-30 22:53:53

Changing status from new to needs_review.


---

Comment by AlexanderDreyer created at 2011-03-30 22:53:53

It seems, I finally found out where this -KPIC comes in and managed to fix it. See the updated spkg here:
http://sage.math.washington.edu/home/dreyer/spkg/polybori-0.7.0.p2.spkg

My best,
  Alexander


---

Comment by drkirkby created at 2011-03-31 10:30:05

Thank you. That has solved it.


---

Comment by drkirkby created at 2011-03-31 10:30:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-04-05 11:59:39

Resolution: fixed


---

Comment by jdemeyer created at 2011-05-04 09:23:22

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2011-05-04 09:23:22

Changing status from closed to new.


---

Comment by jdemeyer created at 2011-05-04 09:23:22

SPKG.txt needs to updated:
 - backport [http://trac.sagemath.org/sage_trac/raw-attachment/ticket/10797/polybori-SPKG.txt.diff](http://trac.sagemath.org/sage_trac/raw-attachment/ticket/10797/polybori-SPKG.txt.diff)
 - mention this ticket


---

Comment by jdemeyer created at 2011-05-04 09:23:28

Changing priority from major to blocker.


---

Comment by AlexanderDreyer created at 2011-05-04 13:48:24

Does this mean that it fails again?


---

Comment by AlexanderDreyer created at 2011-05-04 14:23:21

Or should does one needs to rebundle the spkg?


---

Comment by jdemeyer created at 2011-05-04 15:08:06

Only the file SPKG.txt in the spkg should be changed.  This ticket should be _documented_ in the spkg, that's it.


---

Comment by jdemeyer created at 2011-05-04 15:08:06

Changing status from new to needs_info.


---

Comment by jdemeyer created at 2011-05-04 15:08:25

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2011-05-04 15:08:39

Changing status from needs_review to needs_work.


---

Comment by AlexanderDreyer created at 2011-05-04 15:24:25

Changing status from needs_work to needs_review.


---

Comment by AlexanderDreyer created at 2011-05-04 15:24:25

Ok, I put it on the same location here;
 http://sage.math.washington.edu/home/dreyer/spkg/polybori-0.7.0.p2.spkg
(the previous one is at http://sage.math.washington.edu/home/dreyer/spkg/polybori-0.7.0.p2.spkg.0)


---

Comment by jdemeyer created at 2011-05-04 21:11:23

I removed `SPKG.txt~`, new spkg: [http://boxen.math.washington.edu/home/jdemeyer/spkg/polybori-0.7.0.p2.spkg](http://boxen.math.washington.edu/home/jdemeyer/spkg/polybori-0.7.0.p2.spkg)


---

Comment by drkirkby created at 2011-05-04 22:52:40

That looks fine


```
real	3m44.578s
user	3m21.196s
sys	0m16.574s
Successfully installed polybori-0.7.0.p2
```


Positive review.


---

Comment by drkirkby created at 2011-05-04 22:53:39

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-05-05 09:48:35

Resolution: fixed
