# Issue 30123: Pushout of number field and free module over ZZ fails

Issue created by migration from https://trac.sagemath.org/ticket/30360

Original creator: @kliem

Original creation time: 2020-08-14 20:21:18

CC:  vdelecroix tscrim

Keywords: pushout, number field, free module


```
sage: 1/2*vector([1,2,3])
(1/2, 1, 3/2)
```


```
sage: AA(2).sqrt()*vector([1,2,3])                                                                                                                                                                                                                                                                                                                                         
(1.414213562373095?, 2.828427124746190?, 4.242640687119285?)
```


```
sage: K.<sqrt5> = QuadraticField(5, embedding=AA(5).sqrt())                                                                                                                                                                                                                                                                                                                
sage: sqrt5*vector([1,2])                                                                                                                                                                                                                                                                                                                                                  
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-65-1ac790b433d6> in <module>
----> 1 sqrt5*vector([Integer(1),Integer(2)])

~/Applications/sage/local/lib/python3.7/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__mul__ (build/cythonized/sage/structure/element.c:12196)()
   1513             return (<Element>left)._mul_(right)
   1514         if BOTH_ARE_ELEMENT(cl):
-> 1515             return coercion_model.bin_op(left, right, mul)
   1516 
   1517         cdef long value

~/Applications/sage/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.bin_op (build/cythonized/sage/structure/coerce.c:11304)()
   1246         # We should really include the underlying error.
   1247         # This causes so much headache.
-> 1248         raise bin_op_exception(op, x, y)
   1249 
   1250     cpdef canonical_coercion(self, x, y):

TypeError: unsupported operand parent(s) for *: 'Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?' and 'Ambient free module of rank 2 over the principal ideal domain Integer Ring'
```


It doesn't matter whether you specify the embedding or not.


---

Comment by mkoeppe created at 2020-08-14 23:37:23

It's not really the pushout that's failing here:

```
sage: from sage.categories.pushout import pushout
sage: pushout(sqrt5.parent(), vector([1,2]).parent())
Vector space of dimension 2 over Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?
```



---

Comment by mkoeppe created at 2020-08-14 23:53:15

I think the methods `_lmul_` and `_rmul_` of `NumberFieldElement_quadratic` are in the way. I think they may just need to be removed (haven't tried)


---

Comment by @kliem created at 2020-08-15 11:24:18

Changing keywords from "pushout, number field, free module" to "action, scalar, number field, free module".


---

Comment by mkoeppe created at 2020-08-15 16:21:23

Replying to [comment:3 mkoeppe]:
> I think the methods `_lmul_` and `_rmul_` of `NumberFieldElement_quadratic` are in the way. I think they may just need to be removed (haven't tried)

By itself this does not fix it... (see branch)
----
New commits:


---

Comment by mkoeppe created at 2020-08-15 16:27:02

You are right, the action is missing.

```
sage: cm.explain(AA, vector([1,2]).parent(), operator.mul)                                                                                                          
Action discovered.
    Left scalar multiplication by Algebraic Real Field on Ambient free module of rank 2 over the principal ideal domain Integer Ring
Result lives in Vector space of dimension 2 over Algebraic Real Field
Vector space of dimension 2 over Algebraic Real Field
sage: cm.explain(K, vector([1,2]).parent(), operator.mul)                                                                                                           

Unknown result parent.
```



---

Comment by mkoeppe created at 2020-08-15 16:54:22

It looks like this is because of a unique representation / equality bug for number fields


---

Comment by mkoeppe created at 2020-08-15 17:00:35


```
sage: K.<sqrt5> = QuadraticField(5, embedding=AA(5).sqrt())
sage: V = vector([1, 2]).parent()
sage: from sage.structure.coerce_actions import LeftModuleAction                                                                                                    
sage: LeftModuleAction(AA, V)
Left scalar multiplication by Algebraic Real Field on Ambient free module of rank 2 over the principal ideal domain Integer Ring
sage: LeftModuleAction(K, V)                                                                                                                               
CoercionException: Actor must be coercible into base.
```


Looking at `LeftModuleAction.__init__`, this boils down to:

```
sage: from sage.categories.pushout import pushout                                                         
sage: K                                                                                                   
Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?
sage: pushout(K, ZZ) is K                                                                                 
True
sage: K2 = pushout(K, V).base(); K2                                                                       
Number Field in sqrt5 with defining polynomial x^2 - 5 with sqrt5 = 2.236067977499790?
sage: K2 is K                                                                                             
False
sage: K2 == K                                                                                             
False
```



---

Comment by mkoeppe created at 2020-08-15 17:06:06

This bug seems specific to quadratic fields:

```
sage: K = QuadraticField(5)                                                                               
sage: pushout(K, ZZ^2).base() is K                                                                        
False
sage: K.<a> = NumberField(x^3 + 2/3*x + 1)                                                                
sage: pushout(K, ZZ^2).base() is K                                                                        
True
sage: K.<a> = NumberField(x^3 + 2/3*x + 1, embedding=AA(1))                                               
sage: pushout(K, ZZ^2).base() is K                                                                        
True
```



---

Comment by mkoeppe created at 2020-08-15 17:27:52


```
sage: QuadraticField(5).latex_variable_name()                                                                                       
'\\sqrt{5}'
sage: pushout(QuadraticField(5), ZZ^2).base().latex_variable_name()                                                                 
'a'
```

That's why they're not equal...


---

Comment by mkoeppe created at 2020-08-15 17:32:16


```
sage: K = QuadraticField(5, latex_name=None)                                                                                        
sage: pushout(K, ZZ^2).base() is K                                                                                                  
True
sage: K.<sqrt5> = QuadraticField(5, embedding=AA(5).sqrt(), latex_name=None)                                                                                                                                                                                                                                                                                                                
sage: sqrt5*vector([1,2])  
(sqrt5, 2*sqrt5)
```



---

Comment by mkoeppe created at 2020-08-15 17:34:06

Also

```
sage: K.<a> = NumberField(x^3 + 2/3*x + 1, latex_name='mangrove') 
sage: pushout(K, ZZ^2).base() is K                                                                                            
False
```



---

Comment by mkoeppe created at 2020-08-15 17:39:26

Looks like `NumberField_generic.construction` needs to handle `latex_variable_names`.


---

Comment by mkoeppe created at 2020-08-15 18:49:00

One more broken thing:

```
sage: K3.<a> = NumberField(x^3+x^2+1, latex_name=['alpha'])                                                                         
sage: K3.latex_variable_names()                                                                                                     
['a']
sage: K3.latex_variable_name()                                                                                                      
'alpha'
```



---

Comment by git created at 2020-08-15 19:12:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-08-15 20:28:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-15 20:28:35

Changing status from new to needs_review.


---

Comment by git created at 2020-08-16 00:35:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-16 13:31:18

The test failure reported by the patchbot seems unrelated. Ready for review


---

Comment by @kliem created at 2020-08-17 05:26:49

The test failure is subject of #29989, which is now closed.


---

Comment by tscrim created at 2020-08-17 06:00:14

It is a little strange that `extension()` has the parameters `name` and `names` but only `latex_name`. Although this isn't a dealbreaker, I think it would be good to have this consistent.


---

Comment by mkoeppe created at 2020-08-17 06:16:24

Thanks. Note that this is a comment for the dependency #30372. I have just found an old ticket with a similar goal, #19657. I am going to make the improvement regarding `latex_name`, `latex_names` on that ticket, reworking it on top of #30372.


---

Comment by mkoeppe created at 2020-08-17 06:21:37

Sorry, I was confused.


---

Comment by mkoeppe created at 2020-08-17 06:23:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-08-17 22:41:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-08-17 22:42:30

Cherry-picked some more latex-name changes from #19657.


---

Comment by mkoeppe created at 2020-08-17 22:42:30

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-08-18 00:11:52

I am not sure about this:

```python
        if latex_name is None and latex_names is not None:
            latex_name = latex_names
```

I would expect `latex_names` to be a tuple, so I would think the correct thing to do would be `latex_name = latex_names[0]`.


---

Comment by mkoeppe created at 2020-08-18 00:19:40

This is passed on to the `extension` method, which handles both singular and plural.


---

Comment by tscrim created at 2020-08-18 00:22:49

Okay, good. Then let's wait for the patchbot, but if that is green, then positive review.


---

Comment by mkoeppe created at 2020-08-18 02:00:25

Thanks!


---

Comment by mkoeppe created at 2020-08-18 02:00:25

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-24 22:56:11

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-08-24 22:56:11

PDF docs don't build


---

Comment by @kliem created at 2020-08-25 05:51:40

`@`vbraun: Can you be more precice? Is this on a test branch on top of other tickets?

The patchbot exceeds disk quota due to `ccache`, so I don't think this has anything to do with this ticket.

For me, documentation builds just fine.


---

Comment by mkoeppe created at 2020-08-26 15:30:23

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2020-08-26 22:54:59

PDF docs don't build (non-pdf is ok)


---

Comment by vbraun created at 2020-08-26 22:54:59

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-08-26 22:55:43


```
[docpdf] 
[docpdf] ! Package inputenc Error: Unicode character ^^G (U+0007)
[docpdf] (inputenc)                not set up for use with LaTeX.
[docpdf] 
[docpdf] See the inputenc package documentation for explanation.
[docpdf] Type  H <return>  for immediate help.
[docpdf]  ...                                              
[docpdf]                                                   
[docpdf] l.1012 ...G{l+s+s1}{\PYGZsq{}}\PYG{p}{]}\PYG{p}{)}
[docpdf]                                                   
[docpdf] ? 
[docpdf] ! Emergency stop.
```



---

Comment by tscrim created at 2020-08-27 00:02:49

I think the problem is in `NumberFieldTower`, the string is not a `r"""`. Let me see if that fixes it.


---

Comment by tscrim created at 2020-08-27 00:43:53

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2020-08-27 00:43:53

Replying to [comment:41 tscrim]:
> I think the problem is in `NumberFieldTower`, the string is not a `r"""`. Let me see if that fixes it.

I think that fixes it. Please double-check. What a cryptic error message through...
----
New commits:


---

Comment by mkoeppe created at 2020-08-27 00:54:29

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-08-27 00:54:29

Thanks, this did the job.


---

Comment by vbraun created at 2020-09-01 22:59:36

Resolution: fixed
