# Issue 18851: multi-line doctests fail when using angle notation (preparser)

archive/issues_018851.json:
```json
{
    "body": "CC:  @jcamp0x2a @kliem\n\nThe following fails\n\n```\n        sage: A.<n> = AsymptoticRing(growth_group='QQ^x * x^QQ * log(n)^QQ',\n        ....:                         coefficient_ring=QQ); A\n```\n\n(used with the code of #17601, but is nothing specific about this code).\n\nOne gets:\n\n```\n    A.<n> = AsymptoticRing(growth_group='QQ^x * x^QQ * log(n)^QQ',\n                           coefficient_ring=QQ); A\nException raised:\n    Traceback (most recent call last):\n    ...\n        A = AsymptoticRing(growth_group='QQ^x * x^QQ * log(n)^QQ',; (n,) = A._first_ngens(1)\n                                                                  ^\n    SyntaxError: invalid syntax\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/19088\n\n",
    "created_at": "2015-08-25T18:24:09Z",
    "labels": [
        "doctest framework",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "multi-line doctests fail when using angle notation (preparser)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18851",
    "user": "dkrenn"
}
```
CC:  @jcamp0x2a @kliem

The following fails

```
        sage: A.<n> = AsymptoticRing(growth_group='QQ^x * x^QQ * log(n)^QQ',
        ....:                         coefficient_ring=QQ); A
```

(used with the code of #17601, but is nothing specific about this code).

One gets:

```
    A.<n> = AsymptoticRing(growth_group='QQ^x * x^QQ * log(n)^QQ',
                           coefficient_ring=QQ); A
Exception raised:
    Traceback (most recent call last):
    ...
        A = AsymptoticRing(growth_group='QQ^x * x^QQ * log(n)^QQ',; (n,) = A._first_ngens(1)
                                                                  ^
    SyntaxError: invalid syntax
```



Issue created by migration from https://trac.sagemath.org/ticket/19088





---

archive/issue_comments_257967.json:
```json
{
    "body": "Perhaps a simpler example: compare\n\n```\nsage: preparse(\"\"\"A.<a,b,c>=PolynomialRing(QQ)\"\"\")\n\"A = PolynomialRing(QQ, names=('a', 'b', 'c',)); (a, b, c,) = A._first_ngens(3)\"\nsage: preparse(\"\"\"A.<a,b,c>=PolynomialRing(QQ\\n)\"\"\")\n'A = PolynomialRing(QQ; (a, b, c,) = A._first_ngens(3)\\n)'\nsage: preparse(\"A.<x>=QQ[]\")\n\"A = QQ['x']; (x,) = A._first_ngens(1)\"\nsage: preparse(\"A.<x>=QQ[\\n]\")\n'A = QQ[; (x,) = A._first_ngens(1)\\n]'\n```\n\nAs you can see, the newline completely throws off the substitution:\n- no \"names\" attribute is inserted\n- the binding of generators to given identifiers is inserted in the wrong spot (at the end of the first line instead of at the end of the command)\n\nThis is a tricky one: Usually in python, a newline terminates a command, so the place of insertion would usually be safe. However, if there is an unbalanced bracket, then the newline is just a whitespace. This is a condition that cannot be detected with a regex in general.",
    "created_at": "2015-08-25T19:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18851#issuecomment-257967",
    "user": "nbruin"
}
```

Perhaps a simpler example: compare

```
sage: preparse("""A.<a,b,c>=PolynomialRing(QQ)""")
"A = PolynomialRing(QQ, names=('a', 'b', 'c',)); (a, b, c,) = A._first_ngens(3)"
sage: preparse("""A.<a,b,c>=PolynomialRing(QQ\n)""")
'A = PolynomialRing(QQ; (a, b, c,) = A._first_ngens(3)\n)'
sage: preparse("A.<x>=QQ[]")
"A = QQ['x']; (x,) = A._first_ngens(1)"
sage: preparse("A.<x>=QQ[\n]")
'A = QQ[; (x,) = A._first_ngens(1)\n]'
```

As you can see, the newline completely throws off the substitution:
- no "names" attribute is inserted
- the binding of generators to given identifiers is inserted in the wrong spot (at the end of the first line instead of at the end of the command)

This is a tricky one: Usually in python, a newline terminates a command, so the place of insertion would usually be safe. However, if there is an unbalanced bracket, then the newline is just a whitespace. This is a condition that cannot be detected with a regex in general.



---

archive/issue_comments_257968.json:
```json
{
    "body": "Changing component from doctest framework to misc.",
    "created_at": "2016-08-12T09:13:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18851#issuecomment-257968",
    "user": "jdemeyer"
}
```

Changing component from doctest framework to misc.



---

archive/issue_comments_257969.json:
```json
{
    "body": "Changing keywords from \"\" to \"preparser, multiline\".",
    "created_at": "2021-03-22T21:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18851#issuecomment-257969",
    "user": "slelievre"
}
```

Changing keywords from "" to "preparser, multiline".



---

archive/issue_comments_257970.json:
```json
{
    "body": "This similar Sage extension of the Python syntax\nto define symbolic functions also fails:\n\n```\nsage: T(r, t) = [r^2,\n....:            t^2]\n  File \"<ipython-input-12-9f172b245c59>\", line 1\n    __tmp__=var(\"r,t\"); T = symbolic_expression([r**Integer(2),).function(r,t)\n                                                               ^\nSyntaxError: closing parenthesis ')' does not match opening parenthesis '['\n```\n",
    "created_at": "2021-03-22T21:09:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18851#issuecomment-257970",
    "user": "slelievre"
}
```

This similar Sage extension of the Python syntax
to define symbolic functions also fails:

```
sage: T(r, t) = [r^2,
....:            t^2]
  File "<ipython-input-12-9f172b245c59>", line 1
    __tmp__=var("r,t"); T = symbolic_expression([r**Integer(2),).function(r,t)
                                                               ^
SyntaxError: closing parenthesis ')' does not match opening parenthesis '['
```




---

archive/issue_comments_257971.json:
```json
{
    "body": "See also\n\n- #30953: Implicit line continuation in callable symbolic expression\n- #17404: Long time doctests in multiline code not detected\n- #11621: Preparser could accommodate multiline input and continuation lines",
    "created_at": "2021-03-26T23:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18851",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18851#issuecomment-257971",
    "user": "slelievre"
}
```

See also

- #30953: Implicit line continuation in callable symbolic expression
- #17404: Long time doctests in multiline code not detected
- #11621: Preparser could accommodate multiline input and continuation lines
