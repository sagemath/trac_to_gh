# Issue 15043: Normal form for polytopes of non-zero codimension

archive/issues_015043.json:
```json
{
    "body": "CC:  @vbraun @novoselt\n\nKeywords: toric\n\nCurrently computing the normal form of a lattice polytope of non-zero codimension throws an exception since PALP doesn't cover it. However, the PALP algorithm can easily be extended to cover these cases, as suggested for example in Section 3.2 of http://magma.maths.usyd.edu.au/~kasprzyk/research/pdf/normal_form.pdf .\nThe idea is to simply restrict to the sublattice spanned by vertices of the polytope, compute the normal form there and embed it back into the original ambient space.\n\nI've written a short patch doing precisely that and am attaching it. There is of course the long patch #13525 which overhauls all of normal_form(), but this point is not addressed there.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15280\n\n",
    "created_at": "2013-10-15T14:05:41Z",
    "labels": [
        "geometry",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "Normal form for polytopes of non-zero codimension",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15043",
    "user": "jkeitel"
}
```
CC:  @vbraun @novoselt

Keywords: toric

Currently computing the normal form of a lattice polytope of non-zero codimension throws an exception since PALP doesn't cover it. However, the PALP algorithm can easily be extended to cover these cases, as suggested for example in Section 3.2 of http://magma.maths.usyd.edu.au/~kasprzyk/research/pdf/normal_form.pdf .
The idea is to simply restrict to the sublattice spanned by vertices of the polytope, compute the normal form there and embed it back into the original ambient space.

I've written a short patch doing precisely that and am attaching it. There is of course the long patch #13525 which overhauls all of normal_form(), but this point is not addressed there.

Issue created by migration from https://trac.sagemath.org/ticket/15280





---

archive/issue_comments_192370.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2013-10-15T14:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192370",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_192371.json:
```json
{
    "body": "I'm setting this to needs review. By the way, I'm still a bit confused about which branch to base my patches on. Right now I'm using public/sage-git/master - should I go back to simply the master branch on trac?",
    "created_at": "2013-10-15T14:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192371",
    "user": "jkeitel"
}
```

I'm setting this to needs review. By the way, I'm still a bit confused about which branch to base my patches on. Right now I'm using public/sage-git/master - should I go back to simply the master branch on trac?



---

archive/issue_comments_192372.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-10-15T14:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192372",
    "user": "jkeitel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_192373.json:
```json
{
    "body": "You should use just master for any new branches.",
    "created_at": "2013-10-15T14:36:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192373",
    "user": "@vbraun"
}
```

You should use just master for any new branches.



---

archive/issue_comments_192374.json:
```json
{
    "body": "Okay, I just made another patch based on the new master branch. I then pushed it here and used -f in order to ignore the previously pushed commits, i.e. I executed git push -f --set-upstream trac HEAD:u/jkeitel/normal_form_codimension\n\nThe branch seems to be pushed, that's fine, but there was in error in the trac hooks: \n\n```\nX11 forwarding request failed on channel 0\nCounting objects: 16, done.\nDelta compression using up to 8 threads.\nCompressing objects: 100% (8/8), done.\nWriting objects: 100% (8/8), 2.35 KiB, done.\nTotal 8 (delta 6), reused 0 (delta 0)\nremote: Trac #15280: Commit changed to 4b42b4.\nremote: Traceback (most recent call last):\nremote:   File \"./hooks/post-receive.d/01-trac_branch\", line 152, in <module> \nremote:     trac.update_commit(number, ticket, branch, oldref, newref)\nremote:   File \"./hooks/post-receive.d/01-trac_branch\", line 139, in update_commit\nremote:     commit += '\\n'.join(self.log_table(newref, limit=FORCED_COMMITS))\nremote: UnboundLocalError: local variable 'commit' referenced before assignment To ssh://git@trac.sagemath.org:2222/sage.git\n\n  + 8d4c117...4b42b4a HEAD -> u/jkeitel/normal_form_codimension (forced update)\n\nBranch normal_form_codimension set up to track remote branch u/jkeitel/normal_form_codimension from trac.\n```\n\nAfterwards I had to set the commit by hand. That's clearly not part of this ticket, but it might still be something to fix.\n\nCheers, Jan",
    "created_at": "2013-10-15T15:09:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192374",
    "user": "jkeitel"
}
```

Okay, I just made another patch based on the new master branch. I then pushed it here and used -f in order to ignore the previously pushed commits, i.e. I executed git push -f --set-upstream trac HEAD:u/jkeitel/normal_form_codimension

The branch seems to be pushed, that's fine, but there was in error in the trac hooks: 

```
X11 forwarding request failed on channel 0
Counting objects: 16, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (8/8), done.
Writing objects: 100% (8/8), 2.35 KiB, done.
Total 8 (delta 6), reused 0 (delta 0)
remote: Trac #15280: Commit changed to 4b42b4.
remote: Traceback (most recent call last):
remote:   File "./hooks/post-receive.d/01-trac_branch", line 152, in <module> 
remote:     trac.update_commit(number, ticket, branch, oldref, newref)
remote:   File "./hooks/post-receive.d/01-trac_branch", line 139, in update_commit
remote:     commit += '\n'.join(self.log_table(newref, limit=FORCED_COMMITS))
remote: UnboundLocalError: local variable 'commit' referenced before assignment To ssh://git@trac.sagemath.org:2222/sage.git

  + 8d4c117...4b42b4a HEAD -> u/jkeitel/normal_form_codimension (forced update)

Branch normal_form_codimension set up to track remote branch u/jkeitel/normal_form_codimension from trac.
```

Afterwards I had to set the commit by hand. That's clearly not part of this ticket, but it might still be something to fix.

Cheers, Jan



---

archive/issue_comments_192375.json:
```json
{
    "body": "You should never merge another branch in unless you absolutely have to. Just because there is a newer master is not a reason. The only valid reasons are 1) there is a conflict with the new master or 2) you need a feature from the new master.",
    "created_at": "2013-10-15T15:24:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192375",
    "user": "@vbraun"
}
```

You should never merge another branch in unless you absolutely have to. Just because there is a newer master is not a reason. The only valid reasons are 1) there is a conflict with the new master or 2) you need a feature from the new master.



---

archive/issue_comments_192376.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-10-22T08:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192376",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_192377.json:
```json
{
    "body": "Sorry for the previous post by git, apparently I'm still struggling - must have done something bad to my local copy. Now everything should be fine.\nIn any case, I've added a 'affine normal form' that is invariant under affine transformations of the polytope.",
    "created_at": "2013-10-22T08:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192377",
    "user": "jkeitel"
}
```

Sorry for the previous post by git, apparently I'm still struggling - must have done something bad to my local copy. Now everything should be fine.
In any case, I've added a 'affine normal form' that is invariant under affine transformations of the polytope.



---

archive/issue_comments_192378.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-10-22T08:28:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192378",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_192379.json:
```json
{
    "body": "I'm putting this to needs_work because #13525 is changing the same methods and one of the two will need to be a dependency of the other.",
    "created_at": "2013-10-23T14:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192379",
    "user": "jkeitel"
}
```

I'm putting this to needs_work because #13525 is changing the same methods and one of the two will need to be a dependency of the other.



---

archive/issue_comments_192380.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-10-23T14:53:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192380",
    "user": "jkeitel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_192381.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2013-10-30T13:55:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192381",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_192382.json:
```json
{
    "body": "LatticePolytope now has methods affine_normal_form and find_isomorphism that allows finding isomorphisms between polytopes that are related to each other by an affine transformation, even if the embedding spaces are different.\nAt the moment I'm using LatticeEuclideanGroupElement, a class that seemed only to be intended for LatticePolytope_PPL for the affine maps. Is there a better alternative? I need affine maps between different dimensional vector spaces.\nAlso, the maps may be over QQ and while I've written a short hack to extend LatticeEuclideanGroupElement to do that, that's probably not the best solution.\n\nSuggestions? Volker? :)",
    "created_at": "2013-10-30T14:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192382",
    "user": "jkeitel"
}
```

LatticePolytope now has methods affine_normal_form and find_isomorphism that allows finding isomorphisms between polytopes that are related to each other by an affine transformation, even if the embedding spaces are different.
At the moment I'm using LatticeEuclideanGroupElement, a class that seemed only to be intended for LatticePolytope_PPL for the affine maps. Is there a better alternative? I need affine maps between different dimensional vector spaces.
Also, the maps may be over QQ and while I've written a short hack to extend LatticeEuclideanGroupElement to do that, that's probably not the best solution.

Suggestions? Volker? :)



---

archive/issue_comments_192383.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-13T13:58:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192383",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_192384.json:
```json
{
    "body": "I've done my best to merge in the changes in the lattice polytope class and the new commits from #13525. Doctests still need to be adjusted to point collections, but at least things seem to be working.",
    "created_at": "2014-05-13T14:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192384",
    "user": "jkeitel"
}
```

I've done my best to merge in the changes in the lattice polytope class and the new commits from #13525. Doctests still need to be adjusted to point collections, but at least things seem to be working.



---

archive/issue_comments_192385.json:
```json
{
    "body": "This definitely needs some close attention while rebasing, as I am looking at the first four differences and they are\n- Format of the constructor call which is not really used anywhere in Sage, so why should it be here???\n- `return` after another `return`\n- `_desc` popping which should not be there since there is no more `_desc`\n- Resurrection of old convoluted code for the number of facets instead of the new one-liner.",
    "created_at": "2014-05-13T23:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192385",
    "user": "@novoselt"
}
```

This definitely needs some close attention while rebasing, as I am looking at the first four differences and they are
- Format of the constructor call which is not really used anywhere in Sage, so why should it be here???
- `return` after another `return`
- `_desc` popping which should not be there since there is no more `_desc`
- Resurrection of old convoluted code for the number of facets instead of the new one-liner.



---

archive/issue_comments_192386.json:
```json
{
    "body": "Volker, any thoughts on [comment:13]?",
    "created_at": "2014-05-13T23:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192386",
    "user": "@novoselt"
}
```

Volker, any thoughts on [comment:13]?



---

archive/issue_comments_192387.json:
```json
{
    "body": "Jan, it would be better also to try to take advantage of the switch rather than just making things work:\n\n```\nvertices = matrix(QQ, self.vertices_pc().column_matrix().transpose())\n```\n\ncan be written more naturally as\n\n```\nvertices = matrix(QQ, self.vertices_pc().matrix())\n```\n\nwhich is shorter and does not require double transposition of a cached matrix. Or perhaps as\n\n```\nvertices = self.vertices_pc().matrix().change_ring(QQ)\n```\n\nSorry for annoying rebasing, but in the long run it should be nice to have uniform behaviour for polytopes and cones/fans.",
    "created_at": "2014-05-13T23:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192387",
    "user": "@novoselt"
}
```

Jan, it would be better also to try to take advantage of the switch rather than just making things work:

```
vertices = matrix(QQ, self.vertices_pc().column_matrix().transpose())
```

can be written more naturally as

```
vertices = matrix(QQ, self.vertices_pc().matrix())
```

which is shorter and does not require double transposition of a cached matrix. Or perhaps as

```
vertices = self.vertices_pc().matrix().change_ring(QQ)
```

Sorry for annoying rebasing, but in the long run it should be nice to have uniform behaviour for polytopes and cones/fans.



---

archive/issue_comments_192388.json:
```json
{
    "body": "Sorry, the first differences must have crept back in in the merge. Don't know how that happened, but now that #13525 is merged that's easier to see and I'll get rid of them. You're also absolutely right about the code you quote above and I had planned to do so. The code does still need to be cleaned up and there might well be a couple of other places that can be simplified. I'll try to do that in the next commits.",
    "created_at": "2014-05-14T05:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192388",
    "user": "jkeitel"
}
```

Sorry, the first differences must have crept back in in the merge. Don't know how that happened, but now that #13525 is merged that's easier to see and I'll get rid of them. You're also absolutely right about the code you quote above and I had planned to do so. The code does still need to be cleaned up and there might well be a couple of other places that can be simplified. I'll try to do that in the next commits.



---

archive/issue_comments_192389.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-14T15:43:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192389",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_192390.json:
```json
{
    "body": "Inspired by Nathan / Volker arguments about filters for cached functions: I didn't quite liked how `normal_form` was changed in #13525 to accept parameters that make it return different output types. It used to be straightforward\n\n```\n@cached_method\nnormal_form(self)\n```\n\nand with this ticket it gets more and more complicated, which makes it unclear how (and whether) it should be cached. I also found it annoying that this conditional output propagates down to helper functions.\n\nSo how about this:\n- Drop arguments to helper functions so that their output is stable and if something has to be done to it, the caller does not have to parse argument to decompose and recompose the output appropriately. Am I right that permutation/transformation don't cost much time to compute in addition to normal form? Certainly permutations are trivial when read from the PALP output.\n- Perhaps only the default-algorithm normal form has to be cached: with all the associated data, but only once and during each call `normal_form` will drop unnecessary pieces?\n\nAnother option is to make `normal_form` always return everything, but given the name I think `normal_form()` should return just the normal form and nothing else or it gets confusing. Besides, while I agree that it is nice to have extra data, I used normal form a lot by itself, so it is useful on its own.",
    "created_at": "2014-05-14T18:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192390",
    "user": "@novoselt"
}
```

Inspired by Nathan / Volker arguments about filters for cached functions: I didn't quite liked how `normal_form` was changed in #13525 to accept parameters that make it return different output types. It used to be straightforward

```
@cached_method
normal_form(self)
```

and with this ticket it gets more and more complicated, which makes it unclear how (and whether) it should be cached. I also found it annoying that this conditional output propagates down to helper functions.

So how about this:
- Drop arguments to helper functions so that their output is stable and if something has to be done to it, the caller does not have to parse argument to decompose and recompose the output appropriately. Am I right that permutation/transformation don't cost much time to compute in addition to normal form? Certainly permutations are trivial when read from the PALP output.
- Perhaps only the default-algorithm normal form has to be cached: with all the associated data, but only once and during each call `normal_form` will drop unnecessary pieces?

Another option is to make `normal_form` always return everything, but given the name I think `normal_form()` should return just the normal form and nothing else or it gets confusing. Besides, while I agree that it is nice to have extra data, I used normal form a lot by itself, so it is useful on its own.



---

archive/issue_comments_192391.json:
```json
{
    "body": "Yes, I actually wondered about the same thing when I read that discussion. I'd say I'll just make a few timings in order to see whether there's a significant advantage to not calculating the permutation / transformation. Surely, always calculating the permutation shouldn't hurt, so we can probably drop the `permutation` flag from the helper functions.\nAfter that, we can still check whether there should be a separate function for computing the transformation that sends something to normal form and one that only outputs the normal form.",
    "created_at": "2014-05-14T21:20:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192391",
    "user": "jkeitel"
}
```

Yes, I actually wondered about the same thing when I read that discussion. I'd say I'll just make a few timings in order to see whether there's a significant advantage to not calculating the permutation / transformation. Surely, always calculating the permutation shouldn't hurt, so we can probably drop the `permutation` flag from the helper functions.
After that, we can still check whether there should be a separate function for computing the transformation that sends something to normal form and one that only outputs the normal form.



---

archive/issue_comments_192392.json:
```json
{
    "body": "If the transformation is computed in the same way no matter what algorithm has been used, then probably it can be computed directly in `normal_form` if necessary.\n\nOn the bright side, since these details do not affect user interface, there is no worry about deprecations and waiting.",
    "created_at": "2014-05-14T21:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192392",
    "user": "@novoselt"
}
```

If the transformation is computed in the same way no matter what algorithm has been used, then probably it can be computed directly in `normal_form` if necessary.

On the bright side, since these details do not affect user interface, there is no worry about deprecations and waiting.



---

archive/issue_comments_192393.json:
```json
{
    "body": "Here are some timings, showing that the effect of computing the permutations can in fact be largely neglected:\n\n\n```\nsage: o = lattice_polytope.cross_polytope(2)\nsage: %timeit o._palp_native_normal_form(permutation=False)\n10 loops, best of 3: 43.8 ms per loop\nsage: %timeit o._palp_native_normal_form(permutation=True)\n10 loops, best of 3: 43.9 ms per loop\nsage: %timeit o._palp_modified_normal_form(permutation=False)\n10 loops, best of 3: 36 ms per loop\nsage: %timeit o._palp_modified_normal_form(permutation=True)\n10 loops, best of 3: 36.1 ms per loop\nsage: %timeit o._normal_form_full_dimensional(permutation=False)\n10 loops, best of 3: 8.91 ms per loop\nsage: %timeit o._normal_form_full_dimensional(permutation=True)\n10 loops, best of 3: 9.12 ms per loop\n```\n\n\nHowever, the same tests show (again) that our python implementations from #13525 are really, really slow:\n\n```\nsage: o = lattice_polytope.cross_polytope(4)\nsage: %timeit o._palp_native_normal_form(permutation=False)\n1 loops, best of 3: 33.7 s per loop\nsage: %timeit o._palp_native_normal_form(permutation=True)\n1 loops, best of 3: 33.6 s per loop\nsage: %timeit o._palp_modified_normal_form(permutation=False)\n1 loops, best of 3: 1.4 s per loop\nsage: %timeit o._palp_modified_normal_form(permutation=True)\n1 loops, best of 3: 1.38 s per loop\nsage: %timeit o._normal_form_full_dimensional(permutation=False)\n10 loops, best of 3: 11.2 ms per loop\nsage: %timeit o._normal_form_full_dimensional(permutation=True)\n10 loops, best of 3: 11.5 ms per loop\n```\n\n\nThe following isn't really relevant for this ticket, but the reason that they are so slow are the calls to GAP:\n\n```\n%prun o._palp_native_normal_form(permutation=True)\n\n38627975 function calls (38584943 primitive calls) in 39.390 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n   428940    9.260    0.000   23.171    0.000 pexpect.py:918(expect_list)\n 19600688    4.943    0.000    4.943    0.000 {method 'search' of '_sre.SRE_Pattern' objects}\n    98854    3.581    0.000    3.655    0.000 {method 'with_permuted_rows_and_columns' of 'sage.matrix.matrix0.Matrix' objects}\n   796103    2.139    0.000    2.139    0.000 {select.select}\n   796103    2.135    0.000    8.395    0.000 pexpect.py:502(read_nonblocking)\n   796103    1.921    0.000    1.921    0.000 {posix.read}\n   171376    1.513    0.000    1.513    0.000 {posix.write}\n        1    1.383    1.383   39.131   39.131 lattice_polytope.py:3109(_palp_PM_max)\n    85688    1.050    0.000   26.405    0.000 gap.py:576(_execute_line)\n    22916    1.049    0.000   18.948    0.001 lattice_polytope.py:3169(PGE)\n   796103    0.919    0.000    1.819    0.000 pexpect.py:743(isalive)\n  1592206    0.900    0.000    0.900    0.000 {posix.waitpid}\n    19818    0.833    0.000   14.553    0.001 permgroup.py:594(__call__)\n    42815    0.476    0.000   11.385    0.000 expect.py:1154(eval)\n    85688    0.428    0.000   26.977    0.000 gap.py:664(_eval_line)\n    42942    0.382    0.000    1.034    0.000 permutation.py:5608(from_cycles)\n    99725    0.346    0.000    0.472    0.000 free_module.py:899(__call__)\n    46719    0.317    0.000    0.412    0.000 permutation.py:542(__init__)\n   639678    0.286    0.000    0.286    0.000 {isinstance}\n   838918    0.270    0.000    0.270    0.000 {method 'find' of 'str' objects}\n   615296    0.267    0.000    0.267    0.000 {method 'index' of 'list' objects}\n    42815    0.247    0.000   11.715    0.000 gap.py:510(eval)\n85884/42942    0.222    0.000    0.441    0.000 {repr}\n  2328491    0.221    0.000    0.221    0.000 {method 'start' of '_sre.SRE_Match' objects}\n   171376    0.205    0.000    1.894    0.000 pexpect.py:660(send)\n   128426    0.202    0.000    0.222    0.000 expect.py:1310(_check_valid)\n    22917    0.194    0.000    0.429    0.000 permgroup_named.py:158(__classcall__)\n   171376    0.177    0.000    0.177    0.000 {time.sleep}\n    42815    0.160    0.000   12.065    0.000 interface.py:675(__contains__)\n    42873    0.151    0.000   16.769    0.000 expect.py:1276(__init__)\n   978573    0.150    0.000    0.196    0.000 {len}\n    42815    0.148    0.000    0.148    0.000 interface.py:508(__getattr__)\n    99709    0.144    0.000    0.144    0.000 free_module.py:330(create_key)\n   839045    0.131    0.000    0.131    0.000 {method 'lower' of 'str' objects}\n   405591    0.123    0.000    0.157    0.000 combinat.py:1086(__getitem__)\n    42873    0.120    0.000   16.926    0.000 interface.py:162(__call__)\n    46719    0.116    0.000    0.116    0.000 permutation.py:4476(__classcall_private__)\n    42865    0.113    0.000    0.228    0.000 expect.py:1326(__del__)\n    85688    0.111    0.000    2.005    0.000 pexpect.py:672(sendline)\n   207596    0.100    0.000    0.100    0.000 {range}\n    42942    0.096    0.000    0.314    0.000 permutation.py:675(_repr_)\n    42873    0.094    0.000   16.473    0.000 gap.py:1294(set)\n    46719    0.085    0.000    0.498    0.000 sets_cat.py:310(_element_constructor_from_element_class)\n   857880    0.085    0.000    0.085    0.000 {method 'end' of '_sre.SRE_Match' objects}\n    42942    0.074    0.000    0.118    0.000 global_options.py:664(__getitem__)\n    42815    0.072    0.000   11.788    0.000 gap.py:797(_contains)\n   602437    0.068    0.000    0.068    0.000 {method 'append' of 'list' objects}\n    42873    0.062    0.000   16.600    0.000 interface.py:387(_create)\n...\n```\n\nMaybe that could be improved at some point. In any case, I'll now remove the permutation flag.",
    "created_at": "2014-05-15T08:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192393",
    "user": "jkeitel"
}
```

Here are some timings, showing that the effect of computing the permutations can in fact be largely neglected:


```
sage: o = lattice_polytope.cross_polytope(2)
sage: %timeit o._palp_native_normal_form(permutation=False)
10 loops, best of 3: 43.8 ms per loop
sage: %timeit o._palp_native_normal_form(permutation=True)
10 loops, best of 3: 43.9 ms per loop
sage: %timeit o._palp_modified_normal_form(permutation=False)
10 loops, best of 3: 36 ms per loop
sage: %timeit o._palp_modified_normal_form(permutation=True)
10 loops, best of 3: 36.1 ms per loop
sage: %timeit o._normal_form_full_dimensional(permutation=False)
10 loops, best of 3: 8.91 ms per loop
sage: %timeit o._normal_form_full_dimensional(permutation=True)
10 loops, best of 3: 9.12 ms per loop
```


However, the same tests show (again) that our python implementations from #13525 are really, really slow:

```
sage: o = lattice_polytope.cross_polytope(4)
sage: %timeit o._palp_native_normal_form(permutation=False)
1 loops, best of 3: 33.7 s per loop
sage: %timeit o._palp_native_normal_form(permutation=True)
1 loops, best of 3: 33.6 s per loop
sage: %timeit o._palp_modified_normal_form(permutation=False)
1 loops, best of 3: 1.4 s per loop
sage: %timeit o._palp_modified_normal_form(permutation=True)
1 loops, best of 3: 1.38 s per loop
sage: %timeit o._normal_form_full_dimensional(permutation=False)
10 loops, best of 3: 11.2 ms per loop
sage: %timeit o._normal_form_full_dimensional(permutation=True)
10 loops, best of 3: 11.5 ms per loop
```


The following isn't really relevant for this ticket, but the reason that they are so slow are the calls to GAP:

```
%prun o._palp_native_normal_form(permutation=True)

38627975 function calls (38584943 primitive calls) in 39.390 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
   428940    9.260    0.000   23.171    0.000 pexpect.py:918(expect_list)
 19600688    4.943    0.000    4.943    0.000 {method 'search' of '_sre.SRE_Pattern' objects}
    98854    3.581    0.000    3.655    0.000 {method 'with_permuted_rows_and_columns' of 'sage.matrix.matrix0.Matrix' objects}
   796103    2.139    0.000    2.139    0.000 {select.select}
   796103    2.135    0.000    8.395    0.000 pexpect.py:502(read_nonblocking)
   796103    1.921    0.000    1.921    0.000 {posix.read}
   171376    1.513    0.000    1.513    0.000 {posix.write}
        1    1.383    1.383   39.131   39.131 lattice_polytope.py:3109(_palp_PM_max)
    85688    1.050    0.000   26.405    0.000 gap.py:576(_execute_line)
    22916    1.049    0.000   18.948    0.001 lattice_polytope.py:3169(PGE)
   796103    0.919    0.000    1.819    0.000 pexpect.py:743(isalive)
  1592206    0.900    0.000    0.900    0.000 {posix.waitpid}
    19818    0.833    0.000   14.553    0.001 permgroup.py:594(__call__)
    42815    0.476    0.000   11.385    0.000 expect.py:1154(eval)
    85688    0.428    0.000   26.977    0.000 gap.py:664(_eval_line)
    42942    0.382    0.000    1.034    0.000 permutation.py:5608(from_cycles)
    99725    0.346    0.000    0.472    0.000 free_module.py:899(__call__)
    46719    0.317    0.000    0.412    0.000 permutation.py:542(__init__)
   639678    0.286    0.000    0.286    0.000 {isinstance}
   838918    0.270    0.000    0.270    0.000 {method 'find' of 'str' objects}
   615296    0.267    0.000    0.267    0.000 {method 'index' of 'list' objects}
    42815    0.247    0.000   11.715    0.000 gap.py:510(eval)
85884/42942    0.222    0.000    0.441    0.000 {repr}
  2328491    0.221    0.000    0.221    0.000 {method 'start' of '_sre.SRE_Match' objects}
   171376    0.205    0.000    1.894    0.000 pexpect.py:660(send)
   128426    0.202    0.000    0.222    0.000 expect.py:1310(_check_valid)
    22917    0.194    0.000    0.429    0.000 permgroup_named.py:158(__classcall__)
   171376    0.177    0.000    0.177    0.000 {time.sleep}
    42815    0.160    0.000   12.065    0.000 interface.py:675(__contains__)
    42873    0.151    0.000   16.769    0.000 expect.py:1276(__init__)
   978573    0.150    0.000    0.196    0.000 {len}
    42815    0.148    0.000    0.148    0.000 interface.py:508(__getattr__)
    99709    0.144    0.000    0.144    0.000 free_module.py:330(create_key)
   839045    0.131    0.000    0.131    0.000 {method 'lower' of 'str' objects}
   405591    0.123    0.000    0.157    0.000 combinat.py:1086(__getitem__)
    42873    0.120    0.000   16.926    0.000 interface.py:162(__call__)
    46719    0.116    0.000    0.116    0.000 permutation.py:4476(__classcall_private__)
    42865    0.113    0.000    0.228    0.000 expect.py:1326(__del__)
    85688    0.111    0.000    2.005    0.000 pexpect.py:672(sendline)
   207596    0.100    0.000    0.100    0.000 {range}
    42942    0.096    0.000    0.314    0.000 permutation.py:675(_repr_)
    42873    0.094    0.000   16.473    0.000 gap.py:1294(set)
    46719    0.085    0.000    0.498    0.000 sets_cat.py:310(_element_constructor_from_element_class)
   857880    0.085    0.000    0.085    0.000 {method 'end' of '_sre.SRE_Match' objects}
    42942    0.074    0.000    0.118    0.000 global_options.py:664(__getitem__)
    42815    0.072    0.000   11.788    0.000 gap.py:797(_contains)
   602437    0.068    0.000    0.068    0.000 {method 'append' of 'list' objects}
    42873    0.062    0.000   16.600    0.000 interface.py:387(_create)
...
```

Maybe that could be improved at some point. In any case, I'll now remove the permutation flag.



---

archive/issue_comments_192394.json:
```json
{
    "body": "Thanks for looking into this! Of course, the diamond is very simple and it may be different for other polytopes, but then again you usually want to do something beyond normal form computation and that something is likely to take much more time. Any timings or ideas for computing actual transformations? My guess is that it is faster that normal form itself, but slower than keeping track of permutations. But with 10% difference or so I am for simpler readable code.",
    "created_at": "2014-05-15T18:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15043",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15043#issuecomment-192394",
    "user": "@novoselt"
}
```

Thanks for looking into this! Of course, the diamond is very simple and it may be different for other polytopes, but then again you usually want to do something beyond normal form computation and that something is likely to take much more time. Any timings or ideas for computing actual transformations? My guess is that it is faster that normal form itself, but slower than keeping track of permutations. But with 10% difference or so I am for simpler readable code.
