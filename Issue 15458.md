# Issue 15458: Coercion problems between numpy and sage floats

Issue created by migration from Trac.

Original creator: nbruin

Original creation time: 2014-01-19 17:28:47

See this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/0IalWN4NHig).
This problem arises (at least on a lot of machines)

```
import numpy as np
sage: isinstance(np.float64(1),float)
True
sage: isinstance(np.float32(1),float)
False
sage: isinstance(np.float128(1),float)
False
sage: isinstance(np.float(1),float)
True
sage: type(np.float(1))
<type 'float'>
sage: parent(np.float64(1))
<type 'numpy.float64'>
```

As you can see, numpy decides to map `numpy.float64` a subclass of `float`. Sage's coercion code wasn't prepared for subclassing. This leads to awkward coercion problems:

```
sage: 1j + np.float64(2)
2.0
```

(the result is of type np.float64 rather than CC, i.e., the wrong parent is chosen).
The simplest choice seems to be to ensure that sage tests for subtypes in the relevant spot.


---

Comment by nbruin created at 2014-01-19 17:52:40

very basic fix. Feel free to adapt. Don't forget to test (including performance regression. Python should be able to do a `issubtype` really quickly, but it will be slower than an identity test)
----
New commits:


---

Comment by mmezzarobba created at 2014-03-15 18:56:29

This might be the right place to deal with #8426 (which now works as requested in that ticket but needs a regression test if that's indeed the behaviour we want to support).


---

Comment by vdelecroix created at 2015-03-28 12:00:38

Hello,

I propose to close this as duplicates because of #18076. With the branch applied

```
sage: import numpy
sage: 1j + numpy.float64(2)
2.00000000000000 + 1.00000000000000*I
sage: parent(_)
Complex Field with 53 bits of precision
```

But #8824 is still an issue

```
sage: numpy.float64(2) + 1j
(2+1j)
sage: parent(_)
<type 'numpy.complex128'>
```


Since as I copied some of the suggestions from the branch, I propose to set you as an author in #18076.

Vincent


---

Comment by jdemeyer created at 2015-04-23 12:00:21

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-04-23 12:00:27

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-23 14:51:24

Resolution: duplicate
