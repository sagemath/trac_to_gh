# Issue 15458: Coercion problems between numpy and sage floats

archive/issues_015458.json:
```json
{
    "body": "See this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/0IalWN4NHig).\nThis problem arises (at least on a lot of machines)\n\n```\nimport numpy as np\nsage: isinstance(np.float64(1),float)\nTrue\nsage: isinstance(np.float32(1),float)\nFalse\nsage: isinstance(np.float128(1),float)\nFalse\nsage: isinstance(np.float(1),float)\nTrue\nsage: type(np.float(1))\n<type 'float'>\nsage: parent(np.float64(1))\n<type 'numpy.float64'>\n```\nAs you can see, numpy decides to map `numpy.float64` a subclass of `float`. Sage's coercion code wasn't prepared for subclassing. This leads to awkward coercion problems:\n\n```\nsage: 1j + np.float64(2)\n2.0\n```\n(the result is of type np.float64 rather than CC, i.e., the wrong parent is chosen).\nThe simplest choice seems to be to ensure that sage tests for subtypes in the relevant spot.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15695\n\n",
    "created_at": "2014-01-19T17:28:47Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Coercion problems between numpy and sage floats",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15458",
    "user": "https://github.com/nbruin"
}
```
See this [sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/0IalWN4NHig).
This problem arises (at least on a lot of machines)

```
import numpy as np
sage: isinstance(np.float64(1),float)
True
sage: isinstance(np.float32(1),float)
False
sage: isinstance(np.float128(1),float)
False
sage: isinstance(np.float(1),float)
True
sage: type(np.float(1))
<type 'float'>
sage: parent(np.float64(1))
<type 'numpy.float64'>
```
As you can see, numpy decides to map `numpy.float64` a subclass of `float`. Sage's coercion code wasn't prepared for subclassing. This leads to awkward coercion problems:

```
sage: 1j + np.float64(2)
2.0
```
(the result is of type np.float64 rather than CC, i.e., the wrong parent is chosen).
The simplest choice seems to be to ensure that sage tests for subtypes in the relevant spot.

Issue created by migration from https://trac.sagemath.org/ticket/15695





---

archive/issue_comments_199429.json:
```json
{
    "body": "very basic fix. Feel free to adapt. Don't forget to test (including performance regression. Python should be able to do a `issubtype` really quickly, but it will be slower than an identity test)\n\n---\nNew commits:",
    "created_at": "2014-01-19T17:52:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15458#issuecomment-199429",
    "user": "https://github.com/nbruin"
}
```

very basic fix. Feel free to adapt. Don't forget to test (including performance regression. Python should be able to do a `issubtype` really quickly, but it will be slower than an identity test)

---
New commits:



---

archive/issue_events_046057.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46057"
}
```



---

archive/issue_comments_199430.json:
```json
{
    "body": "This might be the right place to deal with #8426 (which now works as requested in that ticket but needs a regression test if that's indeed the behaviour we want to support).",
    "created_at": "2014-03-15T18:56:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15458#issuecomment-199430",
    "user": "https://github.com/mezzarobba"
}
```

This might be the right place to deal with #8426 (which now works as requested in that ticket but needs a regression test if that's indeed the behaviour we want to support).



---

archive/issue_events_046058.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46058"
}
```



---

archive/issue_events_046059.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46059"
}
```



---

archive/issue_events_046060.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46060"
}
```



---

archive/issue_events_046061.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46061"
}
```



---

archive/issue_comments_199431.json:
```json
{
    "body": "Hello,\n\nI propose to close this as duplicates because of #18076. With the branch applied\n\n```\nsage: import numpy\nsage: 1j + numpy.float64(2)\n2.00000000000000 + 1.00000000000000*I\nsage: parent(_)\nComplex Field with 53 bits of precision\n```\nBut #8824 is still an issue\n\n```\nsage: numpy.float64(2) + 1j\n(2+1j)\nsage: parent(_)\n<type 'numpy.complex128'>\n```\n\nSince as I copied some of the suggestions from the branch, I propose to set you as an author in #18076.\n\nVincent",
    "created_at": "2015-03-28T12:00:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15458#issuecomment-199431",
    "user": "https://github.com/videlec"
}
```

Hello,

I propose to close this as duplicates because of #18076. With the branch applied

```
sage: import numpy
sage: 1j + numpy.float64(2)
2.00000000000000 + 1.00000000000000*I
sage: parent(_)
Complex Field with 53 bits of precision
```
But #8824 is still an issue

```
sage: numpy.float64(2) + 1j
(2+1j)
sage: parent(_)
<type 'numpy.complex128'>
```

Since as I copied some of the suggestions from the branch, I propose to set you as an author in #18076.

Vincent



---

archive/issue_events_046062.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-23T12:00:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46062"
}
```



---

archive/issue_events_046063.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-04-23T12:00:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46063"
}
```



---

archive/issue_comments_199432.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-23T12:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15458#issuecomment-199432",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_199433.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-23T12:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15458#issuecomment-199433",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_046064.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-23T14:51:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15458#event-46064"
}
```



---

archive/issue_comments_199434.json:
```json
{
    "body": "Resolution: duplicate",
    "created_at": "2015-04-23T14:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15458",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15458#issuecomment-199434",
    "user": "https://github.com/vbraun"
}
```

Resolution: duplicate
