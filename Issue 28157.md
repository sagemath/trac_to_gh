# Issue 28157: comparison of sage rationals with gmpy2 mpq broken

archive/issues_028157.json:
```json
{
    "body": "CC:  vklein\n\n\n```\nsage: import gmpy2\nsage: gmpy2.mpq(5,3) == 5/3\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-7445d1641afe> in <module>()\n----> 1 gmpy2.mpq(Integer(5),Integer(3)) == Integer(5)/Integer(3)\n\nTypeError: cannot convert object to mpq\nsage: 5/3 == gmpy2.mpq(5,3)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-593205bfa17f> in <module>()\n----> 1 Integer(5)/Integer(3) == gmpy2.mpq(Integer(5),Integer(3))\n\n/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational.__richcmp__ (build/cythonized/sage/rings/rational.c:9498)()\n    868             c = mpq_cmp_si((<Rational>left).value, PyInt_AS_LONG(right), 1)\n    869         else:\n--> 870             return coercion_model.richcmp(left, right, op)\n    871 \n    872         return rich_to_bool_sgn(op, c)\n\n/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19779)()\n   1946         # we would end up trying the same coercion again.\n   1947         if not y_is_Element and Py_TYPE(y).tp_richcompare:\n-> 1948             res = Py_TYPE(y).tp_richcompare(y, x, revop(op))\n   1949             if res is not NotImplemented:\n   1950                 return res\n\nTypeError: cannot convert object to mpq\n```\n\nSage integers are perfectly fine\n\n```\nsage: gmpy2.mpz(3) == 3\nTrue\nsage: 3 == gmpy2.mpz(3)\nTrue\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28394\n\n",
    "created_at": "2019-08-24T14:15:47Z",
    "labels": [
        "basic arithmetic",
        "major",
        "bug"
    ],
    "title": "comparison of sage rationals with gmpy2 mpq broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28157",
    "user": "vdelecroix"
}
```
CC:  vklein


```
sage: import gmpy2
sage: gmpy2.mpq(5,3) == 5/3
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-7445d1641afe> in <module>()
----> 1 gmpy2.mpq(Integer(5),Integer(3)) == Integer(5)/Integer(3)

TypeError: cannot convert object to mpq
sage: 5/3 == gmpy2.mpq(5,3)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-593205bfa17f> in <module>()
----> 1 Integer(5)/Integer(3) == gmpy2.mpq(Integer(5),Integer(3))

/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/rings/rational.pyx in sage.rings.rational.Rational.__richcmp__ (build/cythonized/sage/rings/rational.c:9498)()
    868             c = mpq_cmp_si((<Rational>left).value, PyInt_AS_LONG(right), 1)
    869         else:
--> 870             return coercion_model.richcmp(left, right, op)
    871 
    872         return rich_to_bool_sgn(op, c)

/opt/sage/sage-py3-gcc/local/lib/python3.7/site-packages/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel.richcmp (build/cythonized/sage/structure/coerce.c:19779)()
   1946         # we would end up trying the same coercion again.
   1947         if not y_is_Element and Py_TYPE(y).tp_richcompare:
-> 1948             res = Py_TYPE(y).tp_richcompare(y, x, revop(op))
   1949             if res is not NotImplemented:
   1950                 return res

TypeError: cannot convert object to mpq
```

Sage integers are perfectly fine

```
sage: gmpy2.mpz(3) == 3
True
sage: 3 == gmpy2.mpz(3)
True
```


Issue created by migration from https://trac.sagemath.org/ticket/28394





---

archive/issue_comments_397594.json:
```json
{
    "body": "It looks likes it's a gmpy2 bug.\n\n```\npython3.7\nPython 3.7.4 (default, Jul  9 2019, 03:52:42) \n[GCC 5.4.0 20160609] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from gmpy2 import mpz, mpq\n>>> class Q:\n...     def __mpq__(self): return mpq(3,2)\n... \n>>> q = Q()\n>>> mpq(3, 2) * q\nmpq(9,4)\n>>> mpq(3, 2) == q\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: cannot convert object to mpq\n>>> from gmpy2 import cmp\n>>> cmp(mpq(3,2), q)\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nTypeError: cannot convert object to mpq\n>>> cmp(mpq(3,2), mpq(3,2))\n0\n```\n",
    "created_at": "2019-08-26T08:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397594",
    "user": "vklein"
}
```

It looks likes it's a gmpy2 bug.

```
python3.7
Python 3.7.4 (default, Jul  9 2019, 03:52:42) 
[GCC 5.4.0 20160609] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from gmpy2 import mpz, mpq
>>> class Q:
...     def __mpq__(self): return mpq(3,2)
... 
>>> q = Q()
>>> mpq(3, 2) * q
mpq(9,4)
>>> mpq(3, 2) == q
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: cannot convert object to mpq
>>> from gmpy2 import cmp
>>> cmp(mpq(3,2), q)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: cannot convert object to mpq
>>> cmp(mpq(3,2), mpq(3,2))
0
```




---

archive/issue_comments_397595.json:
```json
{
    "body": "Do you think this need a patch ?\n\nIMHO it's not necessary. You can call `__mpq__` explicitly if needed :\n\n```\nsage: from gmpy2 import mpq\nsage: q = 5/3\nsage: q.__mpq__() == mpq(5,3)\nTrue\nsage: mpq(q) == mpq(5,3)\nTrue\n```\n",
    "created_at": "2019-08-27T07:29:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397595",
    "user": "vklein"
}
```

Do you think this need a patch ?

IMHO it's not necessary. You can call `__mpq__` explicitly if needed :

```
sage: from gmpy2 import mpq
sage: q = 5/3
sage: q.__mpq__() == mpq(5,3)
True
sage: mpq(q) == mpq(5,3)
True
```




---

archive/issue_comments_397596.json:
```json
{
    "body": "Thank you. I agree with you that there is no need for a patch.",
    "created_at": "2019-08-27T08:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397596",
    "user": "vdelecroix"
}
```

Thank you. I agree with you that there is no need for a patch.



---

archive/issue_comments_397597.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397597",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_397598.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397598",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_397599.json:
```json
{
    "body": "Why `TypeError: cannot convert object to mpq`\nif converting is as simple as `mpq(5/3)`?",
    "created_at": "2020-09-16T00:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397599",
    "user": "slelievre"
}
```

Why `TypeError: cannot convert object to mpq`
if converting is as simple as `mpq(5/3)`?



---

archive/issue_comments_397600.json:
```json
{
    "body": "This has been fixed upstream\n\n```\nsage: gmpy2.mpq(5,3) == 5/3\nTrue\nsage: 5/3 == gmpy2.mpq(5,3)\nTrue\n```\n\nEDIT: in version 2.1.0b4",
    "created_at": "2020-09-16T06:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397600",
    "user": "vdelecroix"
}
```

This has been fixed upstream

```
sage: gmpy2.mpq(5,3) == 5/3
True
sage: 5/3 == gmpy2.mpq(5,3)
True
```

EDIT: in version 2.1.0b4



---

archive/issue_comments_397601.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-16T07:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397601",
    "user": "vdelecroix"
}
```

New commits:



---

archive/issue_comments_397602.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-16T07:04:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397602",
    "user": "vdelecroix"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_397603.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-16T23:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397603",
    "user": "mkoeppe"
}
```

New commits:



---

archive/issue_comments_397604.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-09-16T23:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397604",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_397605.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-09-23T21:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28157",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28157#issuecomment-397605",
    "user": "vbraun"
}
```

Resolution: fixed
