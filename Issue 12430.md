# Issue 12430: Rework download/extract code in sage-spkg

Issue created by migration from https://trac.sagemath.org/ticket/12602

Original creator: jdemeyer

Original creation time: 2012-02-27 15:52:32

Assignee: GeorgSWeber

CC:  jhpalmieri

The current code in `sage-spkg` to determine which package to install and whether to download it is too complicated (and probably buggy).  Also get rid of calls to the `newest_version` script and allow gzip compression of .spkg files.


---

Comment by jhpalmieri created at 2012-02-28 02:27:02

Questions: if you type `sage -i pkg`, should it first check spkg/standard (and spkg/optional, spkg/experimental) to see if there is a matching spkg, before trying to download something?  Or should it check version numbers to see if the on-line file is more recent?  If it checks first in spkg/..., then should there be an option to force downloading, or should we just assume that people will figure out what's going on and delete the local version if they want to download the spkg?


---

Comment by jdemeyer created at 2012-02-28 07:31:28

I still think the default should be to give priority to local packages.

We could support the following (-u for "upgrade"):

```
./sage -i -u mpfr
```

which would check the latest online version of mpfr, download it if needed.  What do you think?


---

Comment by jdemeyer created at 2012-02-28 11:41:15

Changing status from new to needs_review.


---

Comment by SimonKing created at 2012-03-13 13:35:54

To what repository is your patch supposed to be added? It apparently does not work with devel/sage.


---

Comment by jhpalmieri created at 2012-03-20 18:27:13

On line 268, why `cd /`?  The working directory remains `/` for a while after that, which makes me a little uncomfortable.


---

Comment by jdemeyer created at 2012-03-20 20:22:05

Replying to [comment:11 jhpalmieri]:
> On line 268, why `cd /`?
No real reason.  I just wanted to make sure that `PKG_SRC` is an absolute path.  So doing "cd /" would give a failure if `PKG_SRC` had a relative path.

I changed the relevant code to the safer

```
# Do a final check that PKG_SRC is a file with an absolute path
cd /
if [ ! -f "$PKG_SRC" ]; then
    echo >&2 "Error: spkg file '$PKG_SRC' not found."
    echo >&2 "This shouldn't happen, it is a bug in the sage-spkg script."
    exit 1
fi

# Go back to SAGE_ROOT where we have less chance of completely messing
# up the system if we do something wrong.
cd "$SAGE_ROOT" || exit
```



---

Attachment


---

Comment by jhpalmieri created at 2012-03-20 20:42:59

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-03-20 20:42:59

Okay, this latest change looks good. The code as a whole also looks good. I've been using this for a while (as part of the sage-gcc betas), and it seems to work well as part of the Sage build, when downloading optional packages (with and without version numbers specified), and when installing local packages.


---

Comment by jdemeyer created at 2012-03-23 15:21:40

Resolution: fixed
