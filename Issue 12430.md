# Issue 12430: Rework download/extract code in sage-spkg

archive/issues_012430.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\nCC:  @jhpalmieri\n\nThe current code in `sage-spkg` to determine which package to install and whether to download it is too complicated (and probably buggy).  Also get rid of calls to the `newest_version` script and allow gzip compression of .spkg files.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12602\n\n",
    "created_at": "2012-02-27T15:52:32Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "Rework download/extract code in sage-spkg",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12430",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: GeorgSWeber

CC:  @jhpalmieri

The current code in `sage-spkg` to determine which package to install and whether to download it is too complicated (and probably buggy).  Also get rid of calls to the `newest_version` script and allow gzip compression of .spkg files.

Issue created by migration from https://trac.sagemath.org/ticket/12602





---

archive/issue_comments_146640.json:
```json
{
    "body": "Questions: if you type `sage -i pkg`, should it first check spkg/standard (and spkg/optional, spkg/experimental) to see if there is a matching spkg, before trying to download something?  Or should it check version numbers to see if the on-line file is more recent?  If it checks first in spkg/..., then should there be an option to force downloading, or should we just assume that people will figure out what's going on and delete the local version if they want to download the spkg?",
    "created_at": "2012-02-28T02:27:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146640",
    "user": "https://github.com/jhpalmieri"
}
```

Questions: if you type `sage -i pkg`, should it first check spkg/standard (and spkg/optional, spkg/experimental) to see if there is a matching spkg, before trying to download something?  Or should it check version numbers to see if the on-line file is more recent?  If it checks first in spkg/..., then should there be an option to force downloading, or should we just assume that people will figure out what's going on and delete the local version if they want to download the spkg?



---

archive/issue_comments_146641.json:
```json
{
    "body": "I still think the default should be to give priority to local packages.\n\nWe could support the following (-u for \"upgrade\"):\n\n```\n./sage -i -u mpfr\n```\n\nwhich would check the latest online version of mpfr, download it if needed.  What do you think?",
    "created_at": "2012-02-28T07:31:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146641",
    "user": "https://github.com/jdemeyer"
}
```

I still think the default should be to give priority to local packages.

We could support the following (-u for "upgrade"):

```
./sage -i -u mpfr
```

which would check the latest online version of mpfr, download it if needed.  What do you think?



---

archive/issue_comments_146642.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-28T11:41:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146642",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_146643.json:
```json
{
    "body": "To what repository is your patch supposed to be added? It apparently does not work with devel/sage.",
    "created_at": "2012-03-13T13:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146643",
    "user": "https://github.com/simon-king-jena"
}
```

To what repository is your patch supposed to be added? It apparently does not work with devel/sage.



---

archive/issue_comments_146644.json:
```json
{
    "body": "On line 268, why `cd /`?  The working directory remains `/` for a while after that, which makes me a little uncomfortable.",
    "created_at": "2012-03-20T18:27:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146644",
    "user": "https://github.com/jhpalmieri"
}
```

On line 268, why `cd /`?  The working directory remains `/` for a while after that, which makes me a little uncomfortable.



---

archive/issue_comments_146645.json:
```json
{
    "body": "Replying to [comment:11 jhpalmieri]:\n> On line 268, why `cd /`?\nNo real reason.  I just wanted to make sure that `PKG_SRC` is an absolute path.  So doing \"cd /\" would give a failure if `PKG_SRC` had a relative path.\n\nI changed the relevant code to the safer\n\n```\n# Do a final check that PKG_SRC is a file with an absolute path\ncd /\nif [ ! -f \"$PKG_SRC\" ]; then\n    echo >&2 \"Error: spkg file '$PKG_SRC' not found.\"\n    echo >&2 \"This shouldn't happen, it is a bug in the sage-spkg script.\"\n    exit 1\nfi\n\n# Go back to SAGE_ROOT where we have less chance of completely messing\n# up the system if we do something wrong.\ncd \"$SAGE_ROOT\" || exit\n```\n",
    "created_at": "2012-03-20T20:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146645",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:11 jhpalmieri]:
> On line 268, why `cd /`?
No real reason.  I just wanted to make sure that `PKG_SRC` is an absolute path.  So doing "cd /" would give a failure if `PKG_SRC` had a relative path.

I changed the relevant code to the safer

```
# Do a final check that PKG_SRC is a file with an absolute path
cd /
if [ ! -f "$PKG_SRC" ]; then
    echo >&2 "Error: spkg file '$PKG_SRC' not found."
    echo >&2 "This shouldn't happen, it is a bug in the sage-spkg script."
    exit 1
fi

# Go back to SAGE_ROOT where we have less chance of completely messing
# up the system if we do something wrong.
cd "$SAGE_ROOT" || exit
```




---

archive/issue_comments_146646.json:
```json
{
    "body": "Attachment [12602_spkg_download.patch](tarball://root/attachments/some-uuid/ticket12602/12602_spkg_download.patch) by @jdemeyer created at 2012-03-20 20:22:25",
    "created_at": "2012-03-20T20:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146646",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [12602_spkg_download.patch](tarball://root/attachments/some-uuid/ticket12602/12602_spkg_download.patch) by @jdemeyer created at 2012-03-20 20:22:25



---

archive/issue_comments_146647.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-03-20T20:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146647",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_146648.json:
```json
{
    "body": "Okay, this latest change looks good. The code as a whole also looks good. I've been using this for a while (as part of the sage-gcc betas), and it seems to work well as part of the Sage build, when downloading optional packages (with and without version numbers specified), and when installing local packages.",
    "created_at": "2012-03-20T20:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146648",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, this latest change looks good. The code as a whole also looks good. I've been using this for a while (as part of the sage-gcc betas), and it seems to work well as part of the Sage build, when downloading optional packages (with and without version numbers specified), and when installing local packages.



---

archive/issue_events_012418.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-03-23T15:21:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/12430#event-12418"
}
```



---

archive/issue_comments_146649.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-03-23T15:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12430",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12430#issuecomment-146649",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
