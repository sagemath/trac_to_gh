# Issue 13085: Coercion from `ZZ['x']` to `Integers(n)['x']` is VERY slow

archive/issues_013085.json:
```json
{
    "body": "Assignee: @robertwb\n\nCC:  @fredrik-johansson jlopez simonking\n\nAs reported by Fredrik Johansson in #12713 this is a horrible horror:\n\n```\nsage: a = ZZ['x'](range(100000))\nsage: R = Integers(3)['x']\nsage: %time R(a);\nCPU times: user 39.38 s, sys: 28.55 s, total: 67.93 s\nWall time: 71.19 s\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13257\n\n",
    "created_at": "2012-07-15T10:15:52Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Coercion from `ZZ['x']` to `Integers(n)['x']` is VERY slow",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13085",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```
Assignee: @robertwb

CC:  @fredrik-johansson jlopez simonking

As reported by Fredrik Johansson in #12713 this is a horrible horror:

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: %time R(a);
CPU times: user 39.38 s, sys: 28.55 s, total: 67.93 s
Wall time: 71.19 s
```


Issue created by migration from https://trac.sagemath.org/ticket/13257





---

archive/issue_comments_158937.json:
```json
{
    "body": "Pruning the command shows the whole time is spent calling `R._element_constructor_(a)` so we should take a look on how that function works to see what's going on.\n\n\n```\nsage: %prun R(a);\n         22 function calls in 66.593 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n        1   66.592   66.592   66.593   66.593 polynomial_ring.py:290(_element_constructor_)\n        1    0.000    0.000   66.593   66.593 <string>:1(<module>)\n        2    0.000    0.000    0.000    0.000 polynomial_ring.py:716(__hash__)\n        6    0.000    0.000    0.000    0.000 {isinstance}\n        3    0.000    0.000    0.000    0.000 {cmp}\n        1    0.000    0.000    0.000    0.000 {method 'has_coerce_map_from' of 'sage.structure.parent.Parent' objects}\n        3    0.000    0.000    0.000    0.000 integer_mod_ring.py:1030(__cmp__)\n        3    0.000    0.000    0.000    0.000 {method 'base_ring' of 'sage.structure.category_object.CategoryObject' objects}\n        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}\n        1    0.000    0.000    0.000    0.000 {method 'parent' of 'sage.structure.element.Element' objects}\n```\n",
    "created_at": "2012-07-15T10:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158937",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

Pruning the command shows the whole time is spent calling `R._element_constructor_(a)` so we should take a look on how that function works to see what's going on.


```
sage: %prun R(a);
         22 function calls in 66.593 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        1   66.592   66.592   66.593   66.593 polynomial_ring.py:290(_element_constructor_)
        1    0.000    0.000   66.593   66.593 <string>:1(<module>)
        2    0.000    0.000    0.000    0.000 polynomial_ring.py:716(__hash__)
        6    0.000    0.000    0.000    0.000 {isinstance}
        3    0.000    0.000    0.000    0.000 {cmp}
        1    0.000    0.000    0.000    0.000 {method 'has_coerce_map_from' of 'sage.structure.parent.Parent' objects}
        3    0.000    0.000    0.000    0.000 integer_mod_ring.py:1030(__cmp__)
        3    0.000    0.000    0.000    0.000 {method 'base_ring' of 'sage.structure.category_object.CategoryObject' objects}
        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}
        1    0.000    0.000    0.000    0.000 {method 'parent' of 'sage.structure.element.Element' objects}
```




---

archive/issue_comments_158938.json:
```json
{
    "body": "As a point of comparison, if we convert the polynomial back into a list then the operation runs about 500x faster:\n\n```\nsage: %time R(list(a));\nCPU times: user 0.12 s, sys: 0.02 s, total: 0.14 s\nWall time: 0.14 s\n```\n\nSo we probably have a 'lost in coercion' situation here.",
    "created_at": "2012-07-15T10:33:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158938",
    "user": "https://trac.sagemath.org/admin/accounts/users/jlopez"
}
```

As a point of comparison, if we convert the polynomial back into a list then the operation runs about 500x faster:

```
sage: %time R(list(a));
CPU times: user 0.12 s, sys: 0.02 s, total: 0.14 s
Wall time: 0.14 s
```

So we probably have a 'lost in coercion' situation here.



---

archive/issue_comments_158939.json:
```json
{
    "body": "The main problem is in compiled files (which is why `%prun` doesn't see it). In particular `polynomial_modz_flint.pyx` `_element_constructor_` calls `Polynomial_template`'s `__init__()` which converts `a` into a list of coefficients, which then reconstructs the polynomial by adding individual monomials together.\n\nWhere the time is taken is each time a monomial is added, a new polynomial is created. A partial solution is to convert polynomial inputs in `_element_consturctor_` to a list and do that (this runs fast because it just does the coefficient coercion and sets the coefficient list of the new polynomial). I haven't looked too deeply into a general solution yet (I don't quite know if this is the only case where this slowdown occurs), but I would suspect one exists.\n\nBest,\n\nTravis",
    "created_at": "2013-02-05T14:43:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158939",
    "user": "https://github.com/tscrim"
}
```

The main problem is in compiled files (which is why `%prun` doesn't see it). In particular `polynomial_modz_flint.pyx` `_element_constructor_` calls `Polynomial_template`'s `__init__()` which converts `a` into a list of coefficients, which then reconstructs the polynomial by adding individual monomials together.

Where the time is taken is each time a monomial is added, a new polynomial is created. A partial solution is to convert polynomial inputs in `_element_consturctor_` to a list and do that (this runs fast because it just does the coefficient coercion and sets the coefficient list of the new polynomial). I haven't looked too deeply into a general solution yet (I don't quite know if this is the only case where this slowdown occurs), but I would suspect one exists.

Best,

Travis



---

archive/issue_comments_158940.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-11T00:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158940",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_158941.json:
```json
{
    "body": "Well, I should say that's where it used to be...it's now in `polynomial_ring.py`.\n\nSomething even more scary to me, this did not scale linearly with `n`:\n\n```\nsage: a = ZZ['x'](range(30000)) \nsage: R = Integers(3)['x']\nsage: %time L = R(a)\nCPU times: user 4.48 s, sys: 0.03 s, total: 4.52 s\nWall time: 4.61 s\nsage: a = ZZ['x'](range(60000))\nsage: %time L = R(a)\nCPU times: user 17.84 s, sys: 0.09 s, total: 17.93 s\nWall time: 18.22 s\n```\n\n\nHowever I'm uploading a patch which just checks if it is a polynomial, and if so, it handles it as if it were a list. With the patch:\n\n```\nsage: a = ZZ['x'](range(1000000)) # Note the number of 0's\nsage: R = Integers(3)['x']\nsage: %time L = R(a)\nCPU times: user 2.00 s, sys: 0.19 s, total: 2.18 s\nWall time: 2.55 s\n```\n\n\nTo be honest, I'm still not perfectly happy with this solution since feels like a hack. If someone else can find an example of a significant slowdown which is not caught by this patch, please share. However as it stands, this patch is ready for review.\n\nBest\n\nTravis",
    "created_at": "2013-02-11T00:25:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158941",
    "user": "https://github.com/tscrim"
}
```

Well, I should say that's where it used to be...it's now in `polynomial_ring.py`.

Something even more scary to me, this did not scale linearly with `n`:

```
sage: a = ZZ['x'](range(30000)) 
sage: R = Integers(3)['x']
sage: %time L = R(a)
CPU times: user 4.48 s, sys: 0.03 s, total: 4.52 s
Wall time: 4.61 s
sage: a = ZZ['x'](range(60000))
sage: %time L = R(a)
CPU times: user 17.84 s, sys: 0.09 s, total: 17.93 s
Wall time: 18.22 s
```


However I'm uploading a patch which just checks if it is a polynomial, and if so, it handles it as if it were a list. With the patch:

```
sage: a = ZZ['x'](range(1000000)) # Note the number of 0's
sage: R = Integers(3)['x']
sage: %time L = R(a)
CPU times: user 2.00 s, sys: 0.19 s, total: 2.18 s
Wall time: 2.55 s
```


To be honest, I'm still not perfectly happy with this solution since feels like a hack. If someone else can find an example of a significant slowdown which is not caught by this patch, please share. However as it stands, this patch is ready for review.

Best

Travis



---

archive/issue_comments_158942.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-02-12T07:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158942",
    "user": "https://github.com/robertwb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_158943.json:
```json
{
    "body": "Won't this patch break\n\n\n```\nsage: R.<x> = ZZ[]\nsage: S.<y> = R[]\nsage: S._element_constructor_(x^2)\n x^2\n```\n\n\nI think polynomial_template should be fixed, at the cost of requiring a couple more special methods.",
    "created_at": "2013-02-12T07:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158943",
    "user": "https://github.com/robertwb"
}
```

Won't this patch break


```
sage: R.<x> = ZZ[]
sage: S.<y> = R[]
sage: S._element_constructor_(x^2)
 x^2
```


I think polynomial_template should be fixed, at the cost of requiring a couple more special methods.



---

archive/issue_comments_158944.json:
```json
{
    "body": "Replying to [comment:6 robertwb]:\n> Won't this patch break\n> \n> {{{\n> sage: R.<x> = ZZ[]\n> sage: S.<y> = R[]\n> sage: S._element_constructor_(x^2)\n>  x^2\n> }}}\n> \nYes it does:\n\n```\nsage: S._element_constructor_(x^2)\ny^2\n```\n\n\n> I think polynomial_template should be fixed, at the cost of requiring a couple more special methods.\n\nI'll see what I can do.\n\nThanks,\n\nTravis",
    "created_at": "2013-02-13T14:25:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158944",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:6 robertwb]:
> Won't this patch break
> 
> {{{
> sage: R.<x> = ZZ[]
> sage: S.<y> = R[]
> sage: S._element_constructor_(x^2)
>  x^2
> }}}
> 
Yes it does:

```
sage: S._element_constructor_(x^2)
y^2
```


> I think polynomial_template should be fixed, at the cost of requiring a couple more special methods.

I'll see what I can do.

Thanks,

Travis



---

archive/issue_comments_158945.json:
```json
{
    "body": "Changed implementation",
    "created_at": "2013-02-15T20:43:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158945",
    "user": "https://github.com/tscrim"
}
```

Changed implementation



---

archive/issue_comments_158946.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158946",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_158947.json:
```json
{
    "body": "Changing keywords from \"\" to \"days45\".",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158947",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "days45".



---

archive/issue_comments_158948.json:
```json
{
    "body": "Attachment [trac_13257-modn_conversion_speedup-ts.patch](tarball://root/attachments/some-uuid/ticket13257/trac_13257-modn_conversion_speedup-ts.patch) by @tscrim created at 2013-02-15 20:51:39\n\nI've changed the fix to have `Polynomial_template` just convert the input polynomial into a list of coefficients and then pass that list back as a corresponding call the the *original* class's `__init__()` (rather than back to `Polynomial_template`) to take advantage of the specific implementations. This doesn't work quite as well for `GF2`, but that was significantly faster before anyways.\n\nMy timings with the patch:\n\n```\nsage: a = ZZ['x'](range(100000))\nsage: R = Integers(3)['x']\nsage: %time L = R(a)\nCPU times: user 0.22 s, sys: 0.05 s, total: 0.26 s\nWall time: 0.35 s\nsage: type(L)\nsage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint\n\nsage: S = GF(3)['x']\nsage: %time L = S(a)\nCPU times: user 0.22 s, sys: 0.00 s, total: 0.22 s\nWall time: 0.26 s\nsage: type(L)\nsage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint\n\nsage: T = GF(2)['x'] % different because it uses NTL\nCPU times: user 1.40 s, sys: 0.00 s, total: 1.40 s\nWall time: 1.50 s\nsage: %time L = T(list(a))\nCPU times: user 1.06 s, sys: 0.00 s, total: 1.06 s\nWall time: 1.16 s\nsage: type(L)\nsage.rings.polynomial.polynomial_gf2x.Polynomial_GF2X\n```\n\n\nReady for review again.\n\nThanks,\n\nTravis",
    "created_at": "2013-02-15T20:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158948",
    "user": "https://github.com/tscrim"
}
```

Attachment [trac_13257-modn_conversion_speedup-ts.patch](tarball://root/attachments/some-uuid/ticket13257/trac_13257-modn_conversion_speedup-ts.patch) by @tscrim created at 2013-02-15 20:51:39

I've changed the fix to have `Polynomial_template` just convert the input polynomial into a list of coefficients and then pass that list back as a corresponding call the the *original* class's `__init__()` (rather than back to `Polynomial_template`) to take advantage of the specific implementations. This doesn't work quite as well for `GF2`, but that was significantly faster before anyways.

My timings with the patch:

```
sage: a = ZZ['x'](range(100000))
sage: R = Integers(3)['x']
sage: %time L = R(a)
CPU times: user 0.22 s, sys: 0.05 s, total: 0.26 s
Wall time: 0.35 s
sage: type(L)
sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint

sage: S = GF(3)['x']
sage: %time L = S(a)
CPU times: user 0.22 s, sys: 0.00 s, total: 0.22 s
Wall time: 0.26 s
sage: type(L)
sage.rings.polynomial.polynomial_zmod_flint.Polynomial_zmod_flint

sage: T = GF(2)['x'] % different because it uses NTL
CPU times: user 1.40 s, sys: 0.00 s, total: 1.40 s
Wall time: 1.50 s
sage: %time L = T(list(a))
CPU times: user 1.06 s, sys: 0.00 s, total: 1.06 s
Wall time: 1.16 s
sage: type(L)
sage.rings.polynomial.polynomial_gf2x.Polynomial_GF2X
```


Ready for review again.

Thanks,

Travis



---

archive/issue_comments_158949.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-06-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158949",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_158950.json:
```json
{
    "body": "I think the horrible horror has been fixed in #12173 itself.\nAt least it takes 0 sec on my computer to perform this (except for Integers(2) where it is slightly solwer, 0.41 sec, surely because NTL is slow :)).\n\nSo I propose to close this as duplicate.",
    "created_at": "2013-06-04T13:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158950",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

I think the horrible horror has been fixed in #12173 itself.
At least it takes 0 sec on my computer to perform this (except for Integers(2) where it is slightly solwer, 0.41 sec, surely because NTL is slow :)).

So I propose to close this as duplicate.



---

archive/issue_comments_158951.json:
```json
{
    "body": "Agreed. On `5.10.beta5`:\n\n```\nsage: %time L = R(a)\nCPU times: user 0.06 s, sys: 0.00 s, total: 0.07 s\nWall time: 0.07 s\n```\n",
    "created_at": "2013-06-04T14:08:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158951",
    "user": "https://github.com/tscrim"
}
```

Agreed. On `5.10.beta5`:

```
sage: %time L = R(a)
CPU times: user 0.06 s, sys: 0.00 s, total: 0.07 s
Wall time: 0.07 s
```




---

archive/issue_comments_158952.json:
```json
{
    "body": "Resolution: worksforme",
    "created_at": "2013-06-06T12:43:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13085",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13085#issuecomment-158952",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: worksforme
