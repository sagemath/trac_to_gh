# Issue 20006: Count real roots of polynomials using Sturm sequences

Issue created by migration from https://trac.sagemath.org/ticket/20243

Original creator: kedlaya

Original creation time: 2016-03-21 15:40:23

Keywords: polynomials, root-counting

We should expose PARI's functionality for counting roots of polynomials in a closed interval:

```
sage: P.<x> = PolynomialRing(ZZ)
sage: pari((x-1)*(x-2)*(x-3)).polsturm(1,2)
2
```

Note that the boundary behavior has changed from PARI 2.7 (which did not include the left endpoint of the interval as a root) to 2.8 (which does do so).


---

Comment by kedlaya created at 2016-03-22 04:40:59

Set assignee to kedlaya.


---

Comment by kedlaya created at 2016-03-22 04:51:34

Changing status from new to needs_review.


---

Comment by kedlaya created at 2016-03-22 17:53:49

Changing keywords from "polynomials, root-counting" to "polynomials, root-counting, days71".


---

Comment by kdilks created at 2016-03-23 06:52:17

Running Patchbot overnight, will play with the code tomorrow. 

Just looking at the source, you're probably going to want to include a check in the code to make sure your polynomial has an appropriate base field, and a test making sure this check behaves properly. Easiest way would to be to check that self.base_field() is RR/QQ/ZZ. There's a potential issue if somebody's polynomial has real coefficients, but is constructed in a complex ring. That is something I may personally do, as testing the Cyclic Sieving Phenomenon involves evaluating polynomials with nonnegative integer coefficients at complex roots of unity. But I suppose the user can just change the base ring appropriately if they want to test for real roots in that case.

Also, there should be the option of having a be -\infty and b being +\infty (the Maxima code for counting number of real roots in an interval allows these options, not sure about pari). My main interest in this code would checking to see if all of a polynomial's roots are real, so I would personally want a simple alias 'is_real_rooted()' that returns 'all_roots_in_interval(-Inf,Inf)'.


---

Comment by jdemeyer created at 2016-03-23 10:09:03

> Just looking at the source, you're probably going to want to include a check in the code to make sure your polynomial has an appropriate base field

Agreed. However, it might be easier to do this check _after_ converting to PARI.


---

Comment by jdemeyer created at 2016-03-23 10:09:03

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-03-23 10:40:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-23 10:44:48

PARI's polsturm allows infinite arguments by omission: a first argument of None translates to -Infinity, a second argument of None translates to +Infinity. I just pushed a commit allowing these.

I agree with adding an alias for all real roots, but I'm not sure what to call it. My first thought would be is_self-adjoint().

I'm not sure what is the best way to check for a valid base ring. One option would be to force the coefficients into RR, but I really want this to be an exact computation on exact input. I suppose I could check for coefficients in QQ or ZZ, and in those cases pass exact coefficients, and in all other cases force the coefficients into RR. But then one should be careful not to clobber the precision of the input in case it is higher than usual.


---

Comment by jdemeyer created at 2016-03-23 11:04:36

Replying to [comment:8 kedlaya]:
> PARI's polsturm allows infinite arguments by omission: a first argument of None translates to -Infinity, a second argument of None translates to +Infinity. I just pushed a commit allowing these.

That's undocumented in PARI, so I think it's a bad idea to rely on that.


---

Comment by kedlaya created at 2016-03-23 11:40:07

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 kedlaya]:
> > PARI's polsturm allows infinite arguments by omission: a first argument of None translates to -Infinity, a second argument of None translates to +Infinity. I just pushed a commit allowing these.
> 
> That's undocumented in PARI, so I think it's a bad idea to rely on that.

It's in the 2.7 documentation:

```
polsturm(pol, {a}, {b}): Number of real roots of the real squarefree polynomial pol in the interval ]a,b], using Sturm's algorithm. a (resp. b) is taken to be -infinity (resp. +infinity) if omitted.
```

Or have you seen the 2.8 user guide yet (which I haven't found)? There does need to be a change of text to change the interval from ]a,b] (open on the left, closed on the right) to [a,b] (closed both sides).


---

Comment by jdemeyer created at 2016-03-23 12:58:45

Replying to [comment:10 kedlaya]:
> Or have you seen the 2.8 user guide yet (which I haven't found)?

PARI-2.7 is ancient. In PARI-2.8, the syntax has changed, you are supposed to use `polsturm(pol, [a,b])` instead.

The PARI-2.8 user guide might not be online, but you can access the documentation from Sage: run `./sage --gp` and then type `??polsturm`.

I created #20257 to deprecate `pari(...).polsturm(a, b)` in Sage.


---

Comment by git created at 2016-03-23 13:45:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-23 14:30:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-23 14:32:06

OK, I changed the call syntax to polsturm. I also changed the call syntax for count_roots_in_interval and all_roots_in_interval: they now take a variable number of arguments, which should be either two numbers or one interval. Moreover, I allow passing either None or -Infinity as a left endpoint, and None or +Infinity as a right endpoint (converting them to the Pari infinities).

I still haven't implemented an alias for all real roots (since I'm not settled on the name) or checking the argument type.


---

Comment by jdemeyer created at 2016-03-23 14:35:30

Conversion to infinity should not happen here, but more generally in the Sage <-> PARI interface. Feel free to add a commit to #20256 to do that.


---

Comment by git created at 2016-03-24 10:30:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-24 10:39:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-24 10:41:29

This commit should play nicely with #20256, but I'm still a novice with git-trac and haven't figured out how to test this yet.

I added has_all_real_roots() to test for all roots in the real line. I'm open to changing that name if someone has a better idea.

I still haven't implemented any sort of sanity checking on the input base ring.


---

Comment by git created at 2016-03-24 14:29:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-24 15:27:57

Merged #20256 to do the Infinity conversion.

I don't know what to do about type-checking. If you have a polynomial over C but whose coefficients actually belong to R, then PARI seems to handle this correctly (I added a doctest to this effect). However, we have trouble with inexact polynomials which are (apparently) not squarefree:

```
sage: P.<x> = PolynomialRing(RR)
sage: pol = (x-1)^2*(x-2)^2*(x-3)
sage: pol.is_squarefree() # Should be False
True
sage: pari(pol).issquarefree # Should be 0
1
sage: pol.count_roots_in_interval()
...
PariError: domain error in polsturm: issquarefree(pol) = 0
```

I created ticket #20282 for this issue, in case we decide not to deal with it here (which would be my preference).


---

Comment by jdemeyer created at 2016-03-24 16:00:52

You don't actually need this: `a1 = pari(a)` and `b1 = pari(b)`: PARI methods will automatically convert anyway.


---

Comment by git created at 2016-03-24 16:11:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-03-24 16:15:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-24 16:16:33

Replying to [comment:21 jdemeyer]:
> You don't actually need this: `a1 = pari(a)` and `b1 = pari(b)`: PARI methods will automatically convert anyway.

Changed to `a1 = a` and `b1 = b`.


---

Comment by jdemeyer created at 2016-03-24 16:37:58

You don't need `a1` or `b1` either, just use `a` and `b`. And `foo == None` should be replaced by `foo is None`.


---

Comment by git created at 2016-03-24 17:35:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-24 17:36:07

Replying to [comment:25 jdemeyer]:
> You don't need `a1` or `b1` either, just use `a` and `b`. And `foo == None` should be replaced by `foo is None`.

Changes made.


---

Comment by jdemeyer created at 2016-03-24 18:10:29

The only thing that remains is to check that the coefficients are real. I see two approaches: either checking that the base_ring coerces to `RealField(2)` or checking the PARI types after conversion to PARI.


---

Comment by kedlaya created at 2016-03-24 19:56:43

I'm not sure checking the base ring is the right approach; one use case that was already suggested above is a polynomial over CC which happens to have real coefficients. One option is to attempt the coercion by calling `self.change_ring(RR)` and discarding the result (allowing a `TypeError` through if it comes up). Working on the PARI side eliminates this particular case:

```
sage: u = CC(1)
sage: u.parent()
Complex Field with 53 bits of precision
sage: pari(u)
1.00000000000000
sage: pari(u).type()
't_REAL'
```

Thoughts?


---

Comment by jdemeyer created at 2016-03-24 21:25:59

Replying to [comment:29 kedlaya]:
> I'm not sure checking the base ring is the right approach; one use case that was already suggested above is a polynomial over CC which happens to have real coefficients.

The Sage philosophy is usually that the base ring matters. So, if the polynomial defined over CC happens to have real coefficients, that's an accident. It doens't mean that functions expecting real input should work.


---

Comment by git created at 2016-03-25 12:07:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-25 12:09:58

Replying to [comment:30 jdemeyer]:
> Replying to [comment:29 kedlaya]:
> > I'm not sure checking the base ring is the right approach; one use case that was already suggested above is a polynomial over CC which happens to have real coefficients.
> 
> The Sage philosophy is usually that the base ring matters. So, if the polynomial defined over CC happens to have real coefficients, that's an accident. It doens't mean that functions expecting real input should work.

Here is a better solution: make the function work on complex inputs! Now I first attempt a conversion to RR, and if no exception is raised I pass the (unconverted) input directly to PARI; that way, exact inputs stay exact. If that fails, I convert to CC (allowing an exception through if it occurs), and take the GCD of the polynomial with its conjugate (and strip off the leading coefficient) to get a polynomial with real coefficients and all the same real roots as before.


---

Comment by jdemeyer created at 2016-03-25 12:36:29

Replying to [comment:32 kedlaya]:
> Here is a better solution: make the function work on complex inputs! Now I first attempt a conversion to RR, and if no exception is raised I pass the (unconverted) input directly to PARI; that way, exact inputs stay exact. If that fails, I convert to CC (allowing an exception through if it occurs), and take the GCD of the polynomial with its conjugate (and strip off the leading coefficient) to get a polynomial with real coefficients and all the same real roots as before.

Can you document the stuff you wrote here in the code?

I don't see why you need to convert to `CC`. Just conjugate without conversion. That way, you support much more base fields, in particular `QQbar`.


---

Comment by git created at 2016-03-25 13:02:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-03-25 13:04:58

Replying to [comment:33 jdemeyer]:
> Replying to [comment:32 kedlaya]:
> > Here is a better solution: make the function work on complex inputs! Now I first attempt a conversion to RR, and if no exception is raised I pass the (unconverted) input directly to PARI; that way, exact inputs stay exact. If that fails, I convert to CC (allowing an exception through if it occurs), and take the GCD of the polynomial with its conjugate (and strip off the leading coefficient) to get a polynomial with real coefficients and all the same real roots as before.
> 
> Can you document the stuff you wrote here in the code?
> 
> I don't see why you need to convert to `CC`. Just conjugate without conversion. That way, you support much more base fields, in particular `QQbar`.

Done. I also took out the conversion to RR, since anyway Pari will return an error if it doesn't like the input.


---

Comment by kedlaya created at 2016-04-05 02:46:45

Changing status from needs_work to needs_review.


---

Comment by kdilks created at 2016-04-06 02:05:34

Patchbot doesn't like something about the way errors are raised. I think it would be a bit more straightforward to make the arguments be `(self,lower_bound=None,upper_bound=None)`, and just not allow for the option of specifying the bounds as a two-element list.

In terms of the names of functions, I think `count_roots_in_interval` would make more sense as `number_of_roots_in_interval` (that's the naming convention used for most combinatorial statistics). And `has_all_real_roots` should probably be named `is_real_rooted`. Things that return a boolean almost always start with `is_`, and calling polynomials with all real roots "real rooted" is prevalent, at least in the literature that I read.


---

Comment by kdilks created at 2016-04-06 02:05:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-04-06 02:46:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-06 02:53:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-04-06 03:00:08

Replying to [comment:37 kdilks]:
> Patchbot doesn't like something about the way errors are raised. I think it would be a bit more straightforward to make the arguments be `(self,lower_bound=None,upper_bound=None)`, and just not allow for the option of specifying the bounds as a two-element list.
> 
See if patchbot does better with this.

> In terms of the names of functions, I think `count_roots_in_interval` would make more sense as `number_of_roots_in_interval` (that's the naming convention used for most combinatorial statistics). And `has_all_real_roots` should probably be named `is_real_rooted`. Things that return a boolean almost always start with `is_`, and calling polynomials with all real roots "real rooted" is prevalent, at least in the literature that I read.

Not a term I had seen before. I suppose it's actually "real-rooted" (otherwise a "real rooted polynomial" would be a polynomial which is real and also "rooted"), but I think there is a convention to convert both spaces and hyphens into underscores in method names (as in `Matrix.is_skew_symmetric`). However, I don't have a suitable "is" reformulation of  `all_roots_in_interval`.

Bonus edit: I added `number_of_real_roots` as an alias for `number_of_roots_in_interval` with no arguments.


---

Comment by kdilks created at 2016-04-06 19:00:11

I am happy with this ticket now, but I'll give `@`jdemeyer some time to weigh in before setting positive review.


---

Comment by kdilks created at 2016-04-06 19:00:11

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-05-26 19:02:21

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2016-05-26 19:02:21

missing whiteline after `TESTS::`

otherwise looks good to me


---

Comment by git created at 2016-05-26 21:06:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-05-26 21:07:06

Changing status from needs_work to needs_review.


---

Comment by kedlaya created at 2016-05-26 21:07:06

Replying to [comment:42 chapoton]:
> missing whiteline after `TESTS::`
> 
> otherwise looks good to me

Fixed, thanks.


---

Comment by chapoton created at 2016-05-27 06:23:52

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2016-05-27 06:23:52

ok, let it be.


---

Comment by vbraun created at 2016-05-28 12:13:32

Resolution: fixed
