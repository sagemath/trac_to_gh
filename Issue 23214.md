# Issue 23214: compiling linbox fails when /bin/sh is a recent dash

Issue created by migration from https://trac.sagemath.org/ticket/23451

Original creator: tornaria

Original creation time: 2017-07-18 04:42:55

CC:  jdemeyer

(see #23448 for a different issue when /bin/sh is a recent dash)

Both `fflas-ffpack` and `linbox` packages seem to have issues.

- `fflas-ffpack`: this one doesn't give an error message, but in fact it installs a broken version of `local/include/fflas-ffpack/config.h` which produces a failure later on when compiling `linbox`

- `linbox`: creates a broken version of `linbox/config.h` and then the compilation fails

The symptom in both cases is that spurious characters (^A and ^B) appear in the files `fflas-ffpack/config.h` and `linbox/config.h`, thus causing errors in the compiler.

Sample line:

```
#define __FFLASFFPACK_^A ^B 
```


The root cause seems to be bad escaping of substitutions in sed (i.e. \1, \2, etc) which instead of substituting the captured text they become a literal \1 (^A) or \2 (^B), etc.

Since sage requires bash anyway, the easiest fix seems to be to force CONFIG_SHELL=bash when running configure for those two packages.



---

Comment by tornaria created at 2017-07-18 05:01:41

Changing status from new to needs_review.


---

Comment by tornaria created at 2017-07-18 05:01:41

New commits:


---

Comment by tornaria created at 2017-07-18 05:04:55

I wrote the patch on top of #23448 since without that one compilation fails earlier anyway, but they are independent.


---

Comment by jdemeyer created at 2017-07-18 07:35:33

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-07-18 07:35:33

I have no idea what `CONFIG_SHELL` does, but wouldn't it be simpler to just run `bash configure`?

Also: author name on Trac


---

Comment by jdemeyer created at 2017-07-18 07:36:58

And I don't understand the changes to `configure.ac`.


---

Comment by jdemeyer created at 2017-07-18 11:40:56

I guess the changes to `configure.ac` belong to #23448 and should be removed here.


---

Comment by tornaria created at 2017-07-18 16:16:23

Replying to [comment:3 jdemeyer]:
> I have no idea what `CONFIG_SHELL` does, but wouldn't it be simpler to just run `bash configure`?

I think either way is ok.

One advantage of using the environment variable is: we could actually set `CONFIG_SHELL` globally so that the configure scripts for all packages are run using bash (maybe as provided by the user).

As a matter of fact, for my particular set up those two were the only two packages that needed to be run under bash.


---

Comment by tornaria created at 2017-07-18 16:18:19

Replying to [comment:5 jdemeyer]:
> I guess the changes to `configure.ac` belong to #23448 and should be removed here.

I don't know how to remove them from here. The first two commits are //the same// as the ones in #23448. The third commit is the only relevant one here.


---

Comment by tornaria created at 2017-07-18 16:19:03

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-07-19 07:35:40

Author name


---

Comment by jdemeyer created at 2017-07-19 07:35:40

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2017-07-19 07:39:49

Replying to [comment:8 tornaria]:
> I don't know how to remove them from here. The first two commits are //the same// as the ones in #23448. The third commit is the only relevant one here.

Thanks for the info, but there is no way that I could have figured it out without you telling me. You don't need to change anything, it is good like this.


---

Comment by tornaria created at 2017-07-19 23:18:11

Changing status from needs_info to needs_review.


---

Comment by tornaria created at 2017-07-19 23:18:11

I rewrote the commit to use `command -v bash` instead of just bash (see ticket:23448#comment:18).
----
Final commit for this ticket, on branch [u/tornaria/23451-v2](https://git.sagemath.org/sage.git/log/?h=u/tornaria/23451-v2):


---

Comment by jdemeyer created at 2017-08-23 14:00:33

I still feel like this is over-complicating things. Just run `bash configure` instead of `./configure`.


---

Comment by tornaria created at 2017-08-23 14:51:11

I agree using autoconf is over-complicating things, but that was not my choice.

In this case your suggestion is probably equivalent except what I mentioned in comment:7.


---

Comment by dimpase created at 2018-01-08 13:22:28

Does this do the right thing with the `sdh_*` scripts, or was it only tested before the moment they came in?


---

Comment by jdemeyer created at 2018-01-08 14:28:26

Replying to [comment:15 dimpase]:
> Does this do the right thing with the `sdh_*` scripts

Good point, see #24491.


---

Comment by dimpase created at 2018-01-08 15:45:47

Replying to [comment:13 jdemeyer]:
> I still feel like this is over-complicating things. Just run `bash configure` instead of `./configure`.

It seems that you have taken this back on #24491. Thus, positive review.


---

Comment by dimpase created at 2018-01-08 15:45:47

Changing status from needs_review to positive_review.


---

Comment by tornaria created at 2018-01-08 16:38:57

Replying to [comment:15 dimpase]:
> Does this do the right thing with the `sdh_*` scripts, or was it only tested before the moment they came in?

I didn't test with the `sdh_*` scripts, but I would expect


```
export CONFIG_SHELL=whatever
./configure --prefix="$SAGE_LOCAL" --libdir="$SAGE_LOCAL/lib" blah
```


to be equivalent to

```
export CONFIG_SHELL=whatever
sdh_configure blah
```


as the "export" makes sure the variable is recursively inherited by subshells.


---

Comment by vbraun created at 2018-01-15 22:29:42

Resolution: fixed
