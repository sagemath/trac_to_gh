# Issue 31858: DiFUB algorithm fails on some random graph

Issue created by migration from https://trac.sagemath.org/ticket/32095

Original creator: @kliem

Original creation time: 2021-07-01 18:54:00

Keywords: graphs, diameter


```
sage -t --long --random-seed=4 src/sage/graphs/digraph.py
**********************************************************************
File "src/sage/graphs/digraph.py", line 2475, in sage.graphs.digraph.DiGraph.?
Failed example:
    d1 == d2
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of 166 in sage.graphs.digraph.DiGraph.?
    [530 tests, 1 failure, 1.70 s]
```



```
sage: set_random_seed(4)                                                                                                                                                                                                                                                       
sage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              
sage: G.diameter()                                                                                                                                                                                                                                                             
3
sage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       
sage: d1                                                                                                                                                                                                                                                                       
2.0
```


Yet, `DiFUB` claims to be exact.


---

Comment by dcoudert created at 2021-07-01 21:34:33

`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.

Apparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.


---

Comment by dcoudert created at 2021-07-03 09:30:08

Changing status from new to needs_review.


---

Comment by dcoudert created at 2021-07-03 09:30:08

it was an incorrect use of method `sorted`.
----
New commits:


---

Comment by @kliem created at 2021-07-03 09:45:57

Ok, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.


---

Comment by @kliem created at 2021-07-03 09:46:07

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2021-07-03 09:57:00

If you prefer, we can use the graph6 string.


---

Comment by @kliem created at 2021-07-03 10:09:39

It would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.


---

Comment by git created at 2021-07-03 10:20:31

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-07-03 10:20:31

Changing status from positive_review to needs_review.


---

Comment by dcoudert created at 2021-07-03 10:21:37

Should be better this way.


---

Comment by @kliem created at 2021-07-03 11:01:39

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-07-03 11:01:39

Yes, that is better. It also fixes the graph in case that random graphs change at some point.


---

Comment by vbraun created at 2021-07-23 20:10:58

Resolution: fixed
