# Issue 31858: DiFUB algorithm fails on some random graph

archive/issues_031858.json:
```json
{
    "body": "Keywords: graphs, diameter\n\n\n```\nsage -t --long --random-seed=4 src/sage/graphs/digraph.py\n**********************************************************************\nFile \"src/sage/graphs/digraph.py\", line 2475, in sage.graphs.digraph.DiGraph.?\nFailed example:\n    d1 == d2\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 item had failures:\n   1 of 166 in sage.graphs.digraph.DiGraph.?\n    [530 tests, 1 failure, 1.70 s]\n```\n\n\n\n```\nsage: set_random_seed(4)                                                                                                                                                                                                                                                       \nsage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              \nsage: G.diameter()                                                                                                                                                                                                                                                             \n3\nsage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       \nsage: d1                                                                                                                                                                                                                                                                       \n2.0\n```\n\n\nYet, `DiFUB` claims to be exact.\n\nIssue created by migration from https://trac.sagemath.org/ticket/32095\n\n",
    "created_at": "2021-07-01T18:54:00Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "DiFUB algorithm fails on some random graph",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31858",
    "user": "@kliem"
}
```
Keywords: graphs, diameter


```
sage -t --long --random-seed=4 src/sage/graphs/digraph.py
**********************************************************************
File "src/sage/graphs/digraph.py", line 2475, in sage.graphs.digraph.DiGraph.?
Failed example:
    d1 == d2
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of 166 in sage.graphs.digraph.DiGraph.?
    [530 tests, 1 failure, 1.70 s]
```



```
sage: set_random_seed(4)                                                                                                                                                                                                                                                       
sage: G = graphs.RandomGNP(40, 0.4).to_directed()                                                                                                                                                                                                                              
sage: G.diameter()                                                                                                                                                                                                                                                             
3
sage: d1 = G.diameter(algorithm='DiFUB', by_weight=True)                                                                                                                                                                                                                       
sage: d1                                                                                                                                                                                                                                                                       
2.0
```


Yet, `DiFUB` claims to be exact.

Issue created by migration from https://trac.sagemath.org/ticket/32095





---

archive/issue_comments_455321.json:
```json
{
    "body": "`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.\n\nApparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.",
    "created_at": "2021-07-01T21:34:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455321",
    "user": "dcoudert"
}
```

`DiFUB` is an exact algorithm, and actually the default algorithm for unweighted digraphs is `DiFUB` as implemented in `distances_all_pairs.pyx`.

Apparently there is a bug in the implementation of `DiFUB` with boost (`base/boost_graph.pyx`). I will have a look.



---

archive/issue_comments_455322.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-03T09:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455322",
    "user": "dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_455323.json:
```json
{
    "body": "it was an incorrect use of method `sorted`.\n----\nNew commits:",
    "created_at": "2021-07-03T09:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455323",
    "user": "dcoudert"
}
```

it was an incorrect use of method `sorted`.
----
New commits:



---

archive/issue_comments_455324.json:
```json
{
    "body": "Ok, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.",
    "created_at": "2021-07-03T09:45:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455324",
    "user": "@kliem"
}
```

Ok, this is good to go. Thanks for the quick fix. One needs to be carefull with setting `set_random_seed(4)`, but this is ok at the end of a test block. The next block will get the initial seed again.



---

archive/issue_comments_455325.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-03T09:46:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455325",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455326.json:
```json
{
    "body": "If you prefer, we can use the graph6 string.",
    "created_at": "2021-07-03T09:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455326",
    "user": "dcoudert"
}
```

If you prefer, we can use the graph6 string.



---

archive/issue_comments_455327.json:
```json
{
    "body": "It would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.",
    "created_at": "2021-07-03T10:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455327",
    "user": "@kliem"
}
```

It would be nice. At the moment things are stable and the next doctest is run with the correct seed. However, this doctest needs to be always the last (involving randomness) in this block.



---

archive/issue_comments_455328.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-07-03T10:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455328",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_455329.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-07-03T10:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455329",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_455330.json:
```json
{
    "body": "Should be better this way.",
    "created_at": "2021-07-03T10:21:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455330",
    "user": "dcoudert"
}
```

Should be better this way.



---

archive/issue_comments_455331.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-07-03T11:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455331",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_455332.json:
```json
{
    "body": "Yes, that is better. It also fixes the graph in case that random graphs change at some point.",
    "created_at": "2021-07-03T11:01:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455332",
    "user": "@kliem"
}
```

Yes, that is better. It also fixes the graph in case that random graphs change at some point.



---

archive/issue_comments_455333.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-23T20:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31858",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31858#issuecomment-455333",
    "user": "vbraun"
}
```

Resolution: fixed
