# Issue 24108: Disallow boolean operations with Unknown

Issue created by migration from https://trac.sagemath.org/ticket/24345

Original creator: rws

Original creation time: 2017-12-08 15:31:53

The `Unknown` from `misc/unknown.py` incorrectly behaves like `False` in the context of boolean operations, so it is useless as long as Python has no tristate conditionals and logic operators. This ticket raises an error instead, and changes code with boolean conditionals and operators such that the right comparison using `is` is made. This way the code becomes correct and stays valid whenever logic changes are introduced.


---

Comment by rws created at 2017-12-08 15:34:18

New commits:


---

Comment by rws created at 2017-12-08 15:34:18

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-12-08 16:15:00

I'm not sure that there is actually a bug here...

To me, requiring people to write `foo() is True` is a bigger problem than treating `Unknown` as false.


---

Comment by rws created at 2017-12-09 06:57:29

Replying to [comment:3 jdemeyer]:
> To me, requiring people to write `foo() is True` is a bigger problem than treating `Unknown` as false.

So you would not argue against a ticket that uses such an Unknown?


---

Comment by rws created at 2017-12-11 15:53:21

Replying to [comment:3 jdemeyer]:
> I'm not sure that there is actually a bug here...
> 
> To me, requiring people to write `foo() is True` is a bigger problem than treating `Unknown` as false.

Another alternative with this ticket's `Unknown` would be to raise an `UnknownError` instead of `NotImplementedError` and suggest to the user to catch it. This way you can still write `if foo():`. What about it?


---

Comment by jdemeyer created at 2017-12-11 17:01:55

Sorry, I'm not quite following what you are trying to say...

Maybe you should explain better which bug this ticket is meant to address any why it is a bug.


---

Comment by rws created at 2017-12-11 19:05:22

The bug is that the flag query functions is_integer, is_real etc return False instead of Unknown, ie #22162. I followed your argument there that using Unknown as is would win nothing, although I think it would be less confusing. This ticket tries to implement an Unknown that behaves more like what we want. Can we agree on this? Have I misunderstood something?


---

Comment by rws created at 2017-12-11 19:10:32

Also after the flag query functions return unknown changes can be made that make them return True/Unknown/False where False really means False.


---

Comment by jdemeyer created at 2017-12-12 16:49:00

Replying to [comment:7 rws]:
> Can we agree on this?

Well, first I have to agree with myself. I read the discussion again on #22162 and I'm less convinced about my own reasoning there. I have not thought much about it now, but my feeling is that I was wrong on #22162.


---

Comment by vdelecroix created at 2017-12-13 18:24:24

`Unknown` is broken. The only reasonable proposals are in order of decreasing preference (to me):
 - make Python troolean compatible
 - the proposal of this ticket
 - remove completely `Unknown`

I definitely support the changes from this ticket.


---

Comment by vdelecroix created at 2017-12-16 14:36:49

In an ideal world, we would have the following behavior

```
if troolean:
    # here troolean = True
elif not troolean:
    # here troolean = False
else:
    # here troolean = Unknown
```

It would be so much better to patch Python!


---

Comment by vdelecroix created at 2018-01-02 20:27:35

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-01-02 20:27:35

one doctest failure (see patchbot report)

```
sage -t --long src/sage/graphs/strongly_regular_db.pyx  # 1 doctest failed
```



---

Comment by git created at 2018-01-03 07:26:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-01-03 07:27:01

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-01-11 11:55:38

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-01-11 11:55:38

From the documentation of `designs.differenf_family`

```
    - ``existence`` -- if ``True``, then return either ``True`` if Sage knows
      how to build such design, ``Unknown`` if it does not and ``False`` if it
      knows that the design does not exist.
```

Hence, the `isinstance(ret, tuple)` should not be needed in

```
+        ....:             ret = designs.difference_family(v,k,l,existence=True)
+        ....:             if ret is True or isinstance(ret, tuple):
```

There is indeed a bug in the design code (see #24513)

```
sage: designs.difference_family(3,2,1, existence=True)   # should be True
(Ring of integers modulo 3, [[1, 2]])
```



---

Comment by rws created at 2018-01-11 15:07:57

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-01-11 15:07:57

New commits:


---

Comment by vdelecroix created at 2018-01-11 15:17:05

Looks good.

Could you document more carefully the behavior of `Unknown` class? Especially in the design and stronly regular graph codes where you need to write

```
my_function(params, existence=True) is True
```

and not simply

```
my_function(params, existence=True)
```



---

Comment by vdelecroix created at 2018-01-25 23:43:35

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-01-25 23:43:35

I like the idea of Jereon from [comment:5 comment:5]. It would be clearer with `UnknownError` rather than the less specific `NotImplementedError`. And this would allow the alternative troolean evaluation

```
try:
    if troolean:
        ...
    else:
        ....
except UnknownError:
    ....
```


And as said from [comment:19 comment:19]. Documentation is needed.


---

Comment by rws created at 2018-01-26 14:59:18

Changing status from needs_work to needs_review.


---

Comment by rws created at 2018-01-26 14:59:18

New commits:


---

Comment by vdelecroix created at 2018-01-26 16:40:04

You break `bool(Unknown)` and this is not mentioned.


---

Comment by vdelecroix created at 2018-01-26 16:41:33

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2018-01-26 16:41:33

Why this change

```diff
@@ -168,7 +213,7 @@ class UnknownClass(UniqueRepresentation, SageObject):
         if other is self:
             return rich_to_bool(op, 0)
         if not isinstance(other, bool):
-            return NotImplemented
+            return Unknown
         if other:
             return rich_to_bool(op, -1)
         else:
```



---

Comment by vdelecroix created at 2018-01-26 16:43:40

The following should not be broken

```diff
@@ -114,14 +153,18 @@ class UnknownClass(UniqueRepresentation, SageObject):
             sage: Unknown | False
             Unknown
             sage: Unknown | Unknown
-            Unknown
+            Traceback (most recent call last):
+            ...
+            UnknownError: Unknown does not evaluate in boolean context
             sage: Unknown | True
             True
```

(as well as operation `&`). The implementation of `__xor__` and `__and__` should be modified.


---

Comment by vdelecroix created at 2018-01-26 16:44:01

Changing status from needs_info to needs_work.


---

Comment by git created at 2018-01-27 07:19:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-01-27 07:19:42

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-01-27 10:46:42

You should also test `True | Unknown` as well as `False | Unknown`.

`__not__` is by no way a special Python method. It would better be removed.


---

Comment by vdelecroix created at 2018-01-27 11:21:37

Replying to [comment:29 vdelecroix]:
> You should also test `True | Unknown` as well as `False | Unknown`.

which is also broken

```
sage: False | Unknown
Traceback (most recent call last):
...
TypeError: unsupported operand type(s) for |: 'bool' and 'UnknownClass'
sage: True | Unknown
Traceback (most recent call last):
...
TypeError: unsupported operand type(s) for |: 'bool' and 'UnknownClass'
```



---

Comment by git created at 2018-01-29 15:28:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-01-29 15:33:46

Replying to [comment:30 vdelecroix]:
> which is also broken
> {{{
> sage: False | Unknown
> Traceback (most recent call last):
> ...
> TypeError: unsupported operand type(s) for |: 'bool' and 'UnknownClass'
> }}}
I have no idea how to fix this so I just added a test. This is odd:

```
sage: True | 1
1
sage: True.__or__(1)
NotImplemented
```



---

Comment by vdelecroix created at 2018-01-29 16:43:54

Replying to [comment:32 rws]:
> Replying to [comment:30 vdelecroix]:
> > which is also broken
> > {{{
> > sage: False | Unknown
> > Traceback (most recent call last):
> > ...
> > TypeError: unsupported operand type(s) for |: 'bool' and 'UnknownClass'
> > }}}
> I have no idea how to fix this so I just added a test. This is odd:
> {{{
> sage: True | 1
> 1
> sage: True.__or__(1)
> NotImplemented
> }}}

Precisely: when `x.__or__(y)` returns `NotImplemented` Python automatically calls `y.__or__(x)`.


---

Comment by rws created at 2018-01-29 17:00:20

Replying to [comment:33 vdelecroix]:
> Precisely: when `x.__or__(y)` returns `NotImplemented` Python automatically calls `y.__or__(x)`.

Then why does this mechanism not work with x=True and y=Unknown?


---

Comment by jdemeyer created at 2018-01-29 20:17:21

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-01-29 20:17:21

PEP 335 was rejected, so can we please stop pretending that it will eventually be accepted? In other words: remove all references to PEP 335.


---

Comment by vdelecroix created at 2018-01-29 21:50:33

For reference, here is the implementation for `__or__` for booleans

```
static PyObject *
bool_or(PyObject *a, PyObject *b)
{
    if (!PyBool_Check(a) || !PyBool_Check(b))
        return PyLong_Type.tp_as_number->nb_or(a, b);
    return PyBool_FromLong((a == Py_True) | (b == Py_True));
}
```



---

Comment by rws created at 2018-01-30 07:09:28

OK, now I get it. The members `__and__` and `__or__` have nothing to do with logic operators, they are associated with bitwise, i.e. `&` and `|`. The original author added these methods thinking that `&` and `|` are logical (as seen in the method description) but they are not and as I don't think bit operations have a meaning with `Unknown` I will remove these methods.


---

Comment by git created at 2018-01-30 07:12:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2018-01-30 07:13:09

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-01-30 07:16:27

Replying to [comment:37 rws]:
> OK, now I get it. The members `__and__` and `__or__` have nothing to do with logic operators, they are associated with bitwise, i.e. `&` and `|`. The original author added these methods thinking that `&` and `|` are logical (as seen in the method description) but they are not and as I don't think bit operations have a meaning with `Unknown` I will remove these methods.

Note that the operators `and` and `or` are only using `__nonzero__`. Though they are *not* logical operator in the most common sense (like `&&` and `||` in C/C++).


---

Comment by vdelecroix created at 2018-01-30 07:21:37

And since we are at refactoring, I don't understand why `Unknown` should inherit from `SageObject`. It does not interact with anything else.


---

Comment by git created at 2018-01-30 07:38:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-03-03 16:58:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-02-16 20:48:07

rebased
----
New commits:


---

Comment by git created at 2020-02-16 20:56:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-02-17 06:32:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2020-02-17 09:44:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-02-19 23:26:59

Resolution: fixed
