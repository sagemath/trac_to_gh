# Issue 32228: Refactor Matrix_double_dense through Matrix_numpy_dense

Issue created by migration from https://trac.sagemath.org/ticket/32465

Original creator: mkoeppe

Original creation time: 2021-09-04 02:18:24

CC:  @kliem mjo

... in order to define matrix spaces backed by numpy arrays of various types
https://numpy.org/doc/stable/reference/arrays.scalars.html#signed-integer-types


---

Comment by mkoeppe created at 2021-10-12 05:56:22

setting to needs_review for the patchbot.

Still needs work to hook it into the constructor etc.
----
New commits:


---

Comment by mkoeppe created at 2021-10-12 05:56:22

Changing status from new to needs_review.


---

Comment by git created at 2021-10-12 19:39:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-12 22:23:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-12 22:33:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-16 20:28:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-02-03 01:32:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2022-02-16 02:58:32

Do I understand this ticket correctly that it is basically refactoring out methods into base classes?

Why isn't, e.g., `_numpy_dtypeint` set for `Matrix_double_dense`? I would think this would cause problems when using this class with numpy.


---

Comment by mkoeppe created at 2022-02-16 03:11:38

Replying to [comment:13 tscrim]:
> Do I understand this ticket correctly that it is basically refactoring out methods into base classes?

Yes


---

Comment by mkoeppe created at 2022-02-16 03:13:33

Replying to [comment:13 tscrim]:
> Why isn't, e.g., `_numpy_dtypeint` set for `Matrix_double_dense`? I would think this would cause problems when using this class with numpy.

`Matrix_double_dense` is also abstract. `_numpy_dtypeint` is set in the subclasses, see `src/sage/matrix/matrix_real_double_dense.pyx` and `src/sage/matrix/matrix_complex_double_dense.pyx`


---

Comment by tscrim created at 2022-02-16 03:29:45

Ah, I see. Thank you. This is essentially a positive review. One little change I saw when reading it over (a while-we-are-at-it):

In `matrix_numpy_dense` `is_symmetric()`:

```diff
-        The tolerance inequality is strict:
+        The tolerance inequality is strict::
+
             sage: m.is_symmetric(tol=0.1)
             False
             sage: m.is_symmetric(tol=0.11)
             True
```

Once done, you can set a positive review on my behalf.


---

Comment by git created at 2022-02-16 04:46:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-16 04:52:23

Thank you!


---

Comment by mkoeppe created at 2022-02-16 04:52:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-20 10:05:54

On 32-bit:

```
**********************************************************************
File "src/sage/matrix/matrix_numpy_integer_dense.pyx", line 15, in sage.matrix.matrix_numpy_integer_dense
Failed example:
    M.numpy()
Expected:
    array([[ 0,  0,  0],
           [ 0,  0, 47]])
Got:
    array([[ 0,  0,  0],
           [ 0,  0, 47]], dtype=int64)
**********************************************************************
1 item had failures:
   1 of   6 in sage.matrix.matrix_numpy_integer_dense
    [8 tests, 1 failure, 0.01 s]
**********************************************************************
File "src/sage/modules/vector_numpy_integer_dense.pyx", line 12, in sage.modules.vector_numpy_integer_dense
Failed example:
    v.numpy()
Expected:
    array([ 0, 42,  0])
Got:
    array([ 0, 42,  0], dtype=int64)
**********************************************************************
1 item had failures:
   1 of   6 in sage.modules.vector_numpy_integer_dense
    [5 tests, 1 failure, 0.01 s]
```



---

Comment by vbraun created at 2022-02-20 10:05:54

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-02-20 17:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-20 17:53:48

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2022-02-20 17:54:06

Nice catch, fixed now


---

Comment by vbraun created at 2022-02-21 21:56:16

Resolution: fixed
