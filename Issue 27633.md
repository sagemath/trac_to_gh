# Issue 27633: spkg-configure.m4 for  $(BLAS) (i.e. atlas and openblas)

Issue created by migration from https://trac.sagemath.org/ticket/27870

Original creator: dimpase

Original creation time: 2019-05-25 10:22:58

CC:  embray vbraun tmonteil mmezzarobba mjo charpent fbissey isuruf mkoeppe

one needs to understand the existing design first.

* (as far as I can see) currently Sage generates *.pc files for pkg-config, for blas, cblas, and lapack. This is done for Atlas (and for external blas/lapack fed in by `SAGE_ATLAS_LIB` ?). For openblas these *.pc files are basically all point to the same library.

* how are they used?  Are they all used?

* is the description of `SAGE_ATLAS_LIB` outdated? I cannot imagine any need for f77 libraries in 2019...


---

Comment by embray created at 2019-05-31 15:54:27

Yes, we should probably get rid of some of the ATLAS-specific stuff (or re-appropriate it).  The thing about a lot of the ATLAS stuff is that it doesn't actually care that much about having ATLAS BLAS; the way much of it is written it will work if it can find some BLAS anywhere.  That's why on Cygwin it works when you install the lapack package, because it comes with a built-in netlib BLAS.  It has nothing to do with ATLAS.

It would make sense to have an option to look for openblas if it exists, or else fall back on a generic BLAS if one can be found via various sources (pkg-config, some autoconf tests, etc.).


---

Comment by embray created at 2019-06-14 14:55:02

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by dimpase created at 2019-12-10 00:05:53

Debian has all the needed .pc files, so there it appears to work.
----
New commits:


---

Comment by embray created at 2019-12-12 13:02:16

That's certainly better than nothing.  There should probably also be a check in `REQUIRED-CHECK` (the third argument to `SAGE_SPKG_CONFIGURE`) to set `sage_require_openblas=no` if `$with_blas != openblas`).   This way it won't check for openblas if someone configured Sage with `--with-blas=atlas`.


---

Comment by dimpase created at 2019-12-12 13:20:38

One can only check for `openblas` with `pkg-config` and make `blas.pc` and `lapack.pc` just as copies of `openblas.pc`.

But I don't know how to look for `openblas.pc` to  copy, other than doing Unix `find /usr/` - something that is neither robust nor fast.


---

Comment by dimpase created at 2019-12-12 13:22:27

One can fill in templates for `blas.pc` by calling `pkg-config` on `openblas`, but this looks like an ugly hack...


---

Comment by dimpase created at 2019-12-12 23:00:54

OK, in fact one get the location of `openblas.pc` file:

```
pkg-config --variable=pcfiledir openblas
```

(this works), and the corresponding autoconf macro (not tested yet): 

```
 PKG_CHECK_VAR([OPENBLASPCDIR], [openblas], [pcfiledir],
               [ACTION-IF-FOUND], [ACTION-IF-NOT-FOUND])
```



---

Comment by git created at 2019-12-13 13:53:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-12-13 13:56:20

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-12-13 13:56:20

this is a minimal fix for the use of system's openblas, identifiable from pkg-config.

I have not touched Atlas installation procedure.


---

Comment by charpent created at 2019-12-13 18:45:53

Well... I did `git trac checkout 27870`, then `make`, and `make` went directly to checking the documentation.

I guess that testing your patch involves either `make clean` or `make distclean`. Which one ?


---

Comment by dimpase created at 2019-12-13 19:23:48

Replying to [comment:13 charpent]:
> Well... I did `git trac checkout 27870`, then `make`, and `make` went directly to checking the documentation.
> 
> I guess that testing your patch involves either `make clean` or `make distclean`. Which one ?

Not only this :-)


```
make openblas-clean # uninstall package
./bootstrap # update ./configure
./configure # here the output should show that openblas is not being installed
make build
```

on OSX for some reason I also needed to `./sage -f numpy` before `make build`

`make distclean` before `bootstrap` is more robust. I'm not sure in which cases one should re-install all the packages that depend upon blas, too, this might be
platform-dependent.

----

One naturally is interested in testing against system's openblas: e.g. on debian and derived systems one needs `apt install pkg-config libopenblas-dev`

On OSX's Homebrew one would need `brew install openblas` and then export certain
environment variable (as Homebrew will tell you), as for some reason it's not installed into a default location.


---

Comment by mjo created at 2019-12-13 20:12:11

There is a larger mess to deal with here, but TBH I'm fine with solving it one piece at a time. It looks like a few packages (R, numpy,... ?) do use pkg-config to discover information about the blas/lapack being used. And our pkg-config is hacked (build/pkgs/pkgconf/patches/pkg-config.in) to look in a custom directory for .pc files if they aren't found on the system. So I think the idea was that if pkg-config couldn't find e.g. lapack.pc, that it would then look in SAGE_LOCAL to find it.

This only raises more questions. If openblas is installed on the system, can we count on the system pkg-config to know that the system blas/lapack are just the system openblas? If so, then we shouldn't need to create "fallback" symlinks. If not, would linking to some other blas/lapack cause problems? Why don't those packages check for openblas or atlas directly instead of "blas" and "lapack", in that case? And so on. Your approach looks better the deeper I go.


---

Comment by dimpase created at 2019-12-13 20:52:15

I more or less copy the logic of openblas/dpkg-install - which does install openblas.pc under 3 different names - openblas, blas, and lapack.


---

Comment by jhpalmieri created at 2019-12-13 20:55:12

I tried this (meaning `make distclean; ./bootstrap; make`) with an Ubuntu virtual machine. `config.log` says

```
configure:20206: result:     atlas-3.10.2.p3 will not be installed (configure check)
...
configure:20206: result:     openblas-0.3.6.p0 will not be installed (configure check)
```

but `scipy` installation fails with

```
numpy.distutils.system_info.NotFoundError: No lapack/blas resources found.
```

There are also various warnings in the `numpy` installation log about not finding atlas or blas.


---

Comment by dimpase created at 2019-12-13 21:02:58

scipy depends on numpy to supply blas interface, so something goes wrong with numpy installation (it is weird that it foes not fail).

it works for me on Debian 10. numpy has its own extermely convoluted configure routine, which emits a lot of noise about not finding this or that.

Could you try building numpy with SAGE_CHECK ?


---

Comment by mjo created at 2019-12-13 21:04:01

Replying to [comment:16 dimpase]:
> I more or less copy the logic of openblas/dpkg-install - which does install openblas.pc under 3 different names - openblas, blas, and lapack.

Yeah I agree with that. Maybe two years from now, no one is using atlas any more and this is easy to clean up by dropping support for it and by having those other packages call `pkg-config openblas...` instead of `pkg-config lapack` and `pkg-config blas`. No need to worry about it now.


---

Comment by mjo created at 2019-12-13 21:07:07

Replying to [comment:17 jhpalmieri]:
>
> There are also various warnings in the `numpy` installation log about not finding atlas or blas.

FWIW numpy is one of those packages that uses pkg-config to find these libraries; see build/pkgs/numpy/lapack_conf.py.


---

Comment by dimpase created at 2019-12-13 21:07:23

Apart from Atlas and openblas there are other perfectly ok implementations of blas and lapack, which may be used.


---

Comment by dimpase created at 2019-12-13 21:08:59

e.g. there are highly optimised by hardware vendors blas and lapacks (e.g. MKL)


---

Comment by jhpalmieri created at 2019-12-13 21:17:33

Replying to [comment:18 dimpase]:
> Could you try building numpy with SAGE_CHECK ?

`numpy` has no `spkg-check` file, so this acts the same as what I did before.


---

Comment by mjo created at 2019-12-13 21:19:10

I'm not suggesting that we don't support other blas/lapack implementations, but trying to account for multiple system implementations AND multiple sage implementations is making life harder than it has to be. Somewhere down the road, we should be (a) checking for system blas/lapack, and using what we find; then (b) as a fallback, installing openblas and using openblas.

This is all speculation right now, regardless =)


---

Comment by charpent created at 2019-12-13 21:27:19

Replying to [comment:24 mjo]:
> I'm not suggesting that we don't support other blas/lapack implementations, but trying to account for multiple system implementations AND multiple sage implementations is making life harder than it has to be. Somewhere down the road, we should be (a) checking for system blas/lapack, and using what we find; then (b) as a fallback, installing openblas and using openblas.
> 
> This is all speculation right now, regardless =)

Do you mean "not ready for prime time" ?


---

Comment by charpent created at 2019-12-13 22:05:24

Changing status from needs_review to needs_work.


---

Comment by charpent created at 2019-12-13 22:05:24

Replying to [comment:14 dimpase]:
> Replying to [comment:13 charpent]:
> > Well... I did `git trac checkout 27870`, then `make`, and `make` went directly to checking the documentation.
> > 
> > I guess that testing your patch involves either `make clean` or `make distclean`. Which one ?
> 
> Not only this :-)
> 
> {{{
> make openblas-clean # uninstall package
> ./bootstrap # update ./configure
> ./configure # here the output should show that openblas is not being installed

No such bllody luck. From config.log:


```
configure:11316: === checking whether to install the openblas SPKG ===
configure:11334: checking BLAS library
configure:11353: result: openblas
configure:11395: checking for OPENBLAS
configure:11402: $PKG_CONFIG --exists --print-errors "openblas >= 0.3.5"
Package openblas was not found in the pkg-config search path.
Perhaps you should add the directory containing `openblas.pc'
to the PKG_CONFIG_PATH environment variable
No package 'openblas' found
configure:11405: $? = 1
configure:11419: $PKG_CONFIG --exists --print-errors "openblas >= 0.3.5"
Package openblas was not found in the pkg-config search path.
Perhaps you should add the directory containing `openblas.pc'
to the PKG_CONFIG_PATH environment variable
No package 'openblas' found
configure:11422: $? = 1
configure:11436: result: no
No package 'openblas' found
```


But the relevant packages **are** installed systemwide (Debian testing) :


```
charpent@zen-book-flip:~$ dpkg -l "*openblas*"
Souhait=inconnU/Installé/suppRimé/Purgé/H=à garder
+++-=============================-============-============-===================>
ii  libopenblas-base:amd64        0.3.7+ds-5   amd64        Optimized BLAS (lin>
ii  libopenblas-dev:amd64         0.3.7+ds-5   amd64        Optimized BLAS (lin>
un  libopenblas-openmp-dev        <aucune>     <aucune>     (aucune description>
ii  libopenblas-pthread-dev:amd64 0.3.7+ds-5   amd64        Optimized BLAS (lin>
un  libopenblas-serial-dev        <aucune>     <aucune>     (aucune description>
ii  libopenblas0:amd64            0.3.7+ds-5   amd64        Optimized BLAS (lin>
un  libopenblas0-openmp           <aucune>     <aucune>     (aucune description>
ii  libopenblas0-pthread:amd64    0.3.7+ds-5   amd64        Optimized BLAS (lin>
un  libopenblas0-serial           <aucune>     <aucune>     (aucune description
```

| État=Non/Installé/fichier-Config/dépaqUeté/échec-conFig/H=semi-installé/W=att>
|/ Err?=(aucune)/besoin Réinstallation (État,Err: majuscule=mauvais)
||/ Nom                           Version      Architecture Description
==> `needs_work`.

Sorry.


---

Comment by dimpase created at 2019-12-13 22:13:55

do you have `pkg-config` installed?


---

Comment by charpent created at 2019-12-13 22:25:47

Replying to [comment:28 dimpase]:
> do you have `pkg-config` installed? 


Yes :

```
charpent@zen-book-flip:~$ dpkg -l "*pkg-config*"
Souhait=inconnU/Installé/suppRimé/Purgé/H=à garder
+++-==============-============-============-==================================>
ii  pkg-config     0.29-6       amd64        manage compile and link flags for >
un  pkg-config-bin <aucune>     <aucune>     (aucune description n'est disponib>
```

| État=Non/Installé/fichier-Config/dépaqUeté/échec-conFig/H=semi-installé/W=att>
|/ Err?=(aucune)/besoin Réinstallation (État,Err: majuscule=mauvais)
||/ Nom            Version      Architecture Description
I was unaware (until 30 seconds ago) of `pkg-config-bin`. It seems to be a virtual package (i. e. in Debianese, a placeholder for a functionality fullfillable by more than one package).


---

Comment by dimpase created at 2019-12-13 22:31:28

what does 

```
pkg-config --list-all | grep blas
```

show?


---

Comment by charpent created at 2019-12-13 22:34:29

Replying to [comment:30 dimpase]:
> what does 
> {{{
> pkg-config --list-all | grep blas
> }}}
> show? 


```
charpent@zen-book-flip:~$ pkg-config --list-all | grep blas
lapack-openblas                openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
blas                           openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
blas-openblas                  openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
lapack                         openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
blas-netlib                    BLAS - FORTRAN reference implementation of BLAS Basic Linear Algebra Subprograms
```



---

Comment by jhpalmieri created at 2019-12-13 22:53:44

I think my numpy/scipy problem is from each package's `spkg-install` script:

```
 export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
```

Setting `OPENBLAS` to `None` seems to cause the package not to find the system's openblas installation. Removing `OPENBLAS` from the list of environment variables fixes things for me. What is the purpose of this line?


---

Comment by mjo created at 2019-12-13 22:58:09

Replying to [comment:25 charpent]:
> 
> Do you mean "not ready for prime time" ?
> 

I probably should not have said anything at all. Modulo whatever bugs are being worked out, Dima's approach looks good to me.

Later on, there may be _additional_ improvements to make sage support the system blas/lapack, but this patch is a step in the right direction.


---

Comment by dimpase created at 2019-12-13 23:01:54

Replying to [comment:32 jhpalmieri]:
> I think my numpy/scipy problem is from each package's `spkg-install` script:
> {{{
>  export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
> }}}
> Setting `OPENBLAS` to `None` seems to cause the package not to find the system's openblas installation. Removing `OPENBLAS` from the list of environment variables fixes things for me. What is the purpose of this line?

I can reproduce your problem - and it seems to go away if I just not call that
python script, i.e.

```diff
--- a/build/pkgs/numpy/spkg-install
+++ b/build/pkgs/numpy/spkg-install
@@ -11,7 +11,7 @@ else
     export LDFLAGS="${LDFLAGS} -shared"
 fi
 
-sage-python23 ../lapack_conf.py
+# sage-python23 ../lapack_conf.py
 
 # Make sure that the fortran objects are compiled with -fPIC
 export FFLAGS="$FFLAGS -fPIC"
```


I'm not saying it can be just removed unconditionally, but it needs an adjustment.

Hopefully Francois, its author, knows what's going wrong.


---

Comment by dimpase created at 2019-12-13 23:05:14

Replying to [comment:31 charpent]:
> Replying to [comment:30 dimpase]:
> > what does 
> > {{{
> > pkg-config --list-all | grep blas
> > }}}
> > show? 
> 
> {{{
> charpent`@`zen-book-flip:~$ pkg-config --list-all | grep blas
> lapack-openblas                openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
> blas                           openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
> blas-openblas                  openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
> lapack                         openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
> blas-netlib                    BLAS - FORTRAN reference implementation of BLAS Basic Linear Algebra Subprograms
> }}}

So in their infinite wisdom they removed `openblas.pc` all together.
Not sure it's a Debian bug (note that upstream openblas does create such a file, so it's really an incompatible Debian invention here).


---

Comment by charpent created at 2019-12-13 23:18:54

Replying to [comment:35 dimpase]:
> Replying to [comment:31 charpent]:
> > Replying to [comment:30 dimpase]:
> > > what does 
> > > {{{
> > > pkg-config --list-all | grep blas
> > > }}}
> > > show? 
> > 
> > {{{
> > charpent`@`zen-book-flip:~$ pkg-config --list-all | grep blas
> > lapack-openblas                openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
> > blas                           openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
> > blas-openblas                  openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
> > lapack                         openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
> > blas-netlib                    BLAS - FORTRAN reference implementation of BLAS Basic Linear Algebra Subprograms
> > }}}
> 
> So in their infinite wisdom they removed `openblas.pc` all together.
> Not sure it's a Debian bug (note that upstream openblas does create such a file, so it's really an incompatible Debian invention here).

Nope:

```
charpent@zen-book-flip:~$ ls -l /usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig/openblas.pc 
-rw-r--r-- 1 root root 570 déc.   2 06:33 /usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig/openblas.pc
charpent@zen-book-flip:~$ cat /usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig/openblas.pc 
libdir=/usr/lib/x86_64-linux-gnu/openblas-pthread/
includedir=/usr/include/x86_64-linux-gnu/openblas-pthread/
openblas_config= USE_64BITINT= DYNAMIC_ARCH=1 DYNAMIC_OLDER=1 NO_CBLAS= NO_LAPACK= NO_LAPACKE=1 NO_AFFINITY=1 USE_OPENMP=0 generic MAX_THREADS=64
version=0.3.7
extralib=-lm -lpthread -lgfortran -lm -lpthread -lgfortran
Name: openblas
Description: OpenBLAS is an optimized BLAS library based on GotoBLAS2 1.13 BSD version
Version: ${version}
URL: https://github.com/xianyi/OpenBLAS
Libs: -L${libdir} -lopenblas
Libs.private: ${extralib}
Cflags: -I${includedir}
```


The problem is elsewhere...


---

Comment by charpent created at 2019-12-13 23:23:50

Note, however,that my `locate` finds the `openblas.pc` created in my various Sage trees, but **not** the systewide one.

I don't recall having ever fiddled with its configuration.

Replying to [comment:36 charpent]:
> Replying to [comment:35 dimpase]:
> > Replying to [comment:31 charpent]:
> > > Replying to [comment:30 dimpase]:
> > > > what does 
> > > > {{{
> > > > pkg-config --list-all | grep blas
> > > > }}}
> > > > show? 
> > > 
> > > {{{
> > > charpent`@`zen-book-flip:~$ pkg-config --list-all | grep blas
> > > lapack-openblas                openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
> > > blas                           openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
> > > blas-openblas                  openblas-blas - Optimized BLAS (linear algebra) library based on GotoBLAS2
> > > lapack                         openblas-lapack - Optimized BLAS (linear algebra) library, LAPACK
> > > blas-netlib                    BLAS - FORTRAN reference implementation of BLAS Basic Linear Algebra Subprograms
> > > }}}
> > 
> > So in their infinite wisdom they removed `openblas.pc` all together.
> > Not sure it's a Debian bug (note that upstream openblas does create such a file, so it's really an incompatible Debian invention here).
> 
> Nope:
> {{{
> charpent`@`zen-book-flip:~$ ls -l /usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig/openblas.pc 
> -rw-r--r-- 1 root root 570 déc.   2 06:33 /usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig/openblas.pc
> charpent`@`zen-book-flip:~$ cat /usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig/openblas.pc 
> libdir=/usr/lib/x86_64-linux-gnu/openblas-pthread/
> includedir=/usr/include/x86_64-linux-gnu/openblas-pthread/
> openblas_config= USE_64BITINT= DYNAMIC_ARCH=1 DYNAMIC_OLDER=1 NO_CBLAS= NO_LAPACK= NO_LAPACKE=1 NO_AFFINITY=1 USE_OPENMP=0 generic MAX_THREADS=64
> version=0.3.7
> extralib=-lm -lpthread -lgfortran -lm -lpthread -lgfortran
> Name: openblas
> Description: OpenBLAS is an optimized BLAS library based on GotoBLAS2 1.13 BSD version
> Version: ${version}
> URL: https://github.com/xianyi/OpenBLAS
> Libs: -L${libdir} -lopenblas
> Libs.private: ${extralib}
> Cflags: -I${includedir}
> }}}
> 
> The problem is elsewhere...
>


---

Comment by dimpase created at 2019-12-13 23:30:05

Well, this pretty much looks like a Debian bug. The point of installing `openblas.pc` into a hidden from `pkg-config` directory only makes sense if they plan to install "competing" versions of this file in different locations...


---

Comment by charpent created at 2019-12-14 00:05:56

Replying to [comment:38 dimpase]:
> Well, this pretty much looks like a Debian bug. The point of installing `openblas.pc` into a hidden from `pkg-config` directory only makes sense if they plan to install "competing" versions of this file in different locations...

This is now [Debian bug 946698 ](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=946698). For what it's worth...


---

Comment by jhpalmieri created at 2019-12-14 00:23:51

For me, this fixes the problem.

```diff
diff --git a/build/pkgs/numpy/lapack_conf.py b/build/pkgs/numpy/lapack_conf.py
index d127d08def..f1bc559cfa 100644
--- a/build/pkgs/numpy/lapack_conf.py
+++ b/build/pkgs/numpy/lapack_conf.py
@@ -8,7 +8,7 @@ conf_file.write('[ALL]\n')
 conf_file.write('library_dirs = '+ os.environ['SAGE_LOCAL']+ '/lib\n')
 conf_file.write('include_dirs = '+ os.environ['SAGE_LOCAL']+ '/include\n')
 
-pc_blas   = pkgconfig.parse('cblas blas')
+pc_blas   = pkgconfig.parse('blas')
 pc_lapack = pkgconfig.parse('lapack')
 
 if not (os.environ['UNAME'] == 'Darwin'):
```

If I run `./sage --python`:

```pycon
>>> import pkgconfig
>>> pkgconfig.parse('blas')
defaultdict(<class 'list'>, {'include_dirs': ['/usr/include/x86_64-linux-gnu'], 'libraries': ['openblas'], 'define_macros': []})
>>> pkgconfig.parse('cblas blas')
defaultdict(<class 'list'>, {'define_macros': []})
```

I don't know why the space-separated list doesn't work. It is supposed to, according to the documentation. As far as I can tell, it doesn't find a cblas package, and maybe that confuses it. (it = `pkgconfig.parse`)


---

Comment by fbissey created at 2019-12-14 00:39:11

I originally followed the model of the gentoo ebuild for figuring out the needed blas/cblas bits. Of course if you standardise on openblas this is not so needed.

Debian and now gentoo have this model where you have just `libblas.so`, `libcblas.so` and `liblapack.so` and what is underneath can be changed at runtime. So you don't need to know the implementation. On the other hand numpy has this detection model trying to figure what implementation you may have to figure the correct libraries. It used to be that something different would be built depending on implementation but not anymore. Honestly trying to figure which blas/lapack you are using leads to madness :( which is why we steered towards having standard named .pc files. And historically we shaved some bits from numpy's detection machinery.

On my TODO list is to switch my sage-on-gentoo from openblas to mkl. The runtime switch means that it should be quick and easy.

The stuff about `pkgconfig.parse` should be reported as a bug. Although we should check we have currently the latest version first.


---

Comment by dimpase created at 2019-12-14 01:51:01

with up-to-date pkgconfig (version 1.5.1)
I get 

```
$ ./sage --python
Python 3.7.3 (default, Dec 13 2019, 17:59:09) 
[GCC 8.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import pkgconfig
>>> pkgconfig.parse('blas')
defaultdict(<class 'list'>, {'include_dirs': ['/usr/include/x86_64-linux-gnu'], 'libraries': ['openblas']})
>>> pkgconfig.parse('cblas blas')
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 248, in parse
    _raise_if_not_exists(package)
  File "/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
    raise PackageNotFoundError(package)
pkgconfig.pkgconfig.PackageNotFoundError: cblas not found
>>> 
```

That is, after the update the script might just error out (`cblas` need not be present)


---

Comment by fbissey created at 2019-12-14 02:07:35

Replying to [comment:42 dimpase]:
> with up-to-date pkgconfig (version 1.5.1)
> I get 
> {{{
> $ ./sage --python
> Python 3.7.3 (default, Dec 13 2019, 17:59:09) 
> [GCC 8.3.0] on linux
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import pkgconfig
> >>> pkgconfig.parse('blas')
> defaultdict(<class 'list'>, {'include_dirs': ['/usr/include/x86_64-linux-gnu'], 'libraries': ['openblas']})
> >>> pkgconfig.parse('cblas blas')
> Traceback (most recent call last):
>   File "<stdin>", line 1, in <module>
>   File "/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 248, in parse
>     _raise_if_not_exists(package)
>   File "/home/dimpase/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
>     raise PackageNotFoundError(package)
> pkgconfig.pkgconfig.PackageNotFoundError: cblas not found
> >>> 
> }}}
> That is, after the update the script might just error out (`cblas` need not be present) 

Yes. So I think for that part
1. upgrade `pkgconfig`
2. put a `try`-`expect` block in the script
first we try with both, if the right exception is raised we try only `blas` and if that errors too, something is wrong and we should bail out.


---

Comment by dimpase created at 2019-12-14 02:27:50

I've opened #28883 for pkgconfig upgrade. 

I should also add cblas to the list of link the branch here is installing.


---

Comment by git created at 2019-12-14 10:00:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-12-14 11:09:57

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-12-14 11:09:57

Changing keywords from "" to "spkg-configure".


---

Comment by charpent created at 2019-12-14 16:16:35

Possibly dumb question: why are we looking for `openblas` rather than for `blas` and `lapack` ?

From my systemwide Debian pkg-confi (afrter a reboot):

```
charpent@zen-book-flip:/usr/local/sage-9$ pkg-config --libs --cflags openblas
Package openblas was not found in the pkg-config search path.
Perhaps you should add the directory containing `openblas.pc'
to the PKG_CONFIG_PATH environment variable
No package 'openblas' found
charpent@zen-book-flip:/usr/local/sage-9$ pkg-config --libs --cflags blas
-I/usr/include/x86_64-linux-gnu -L/usr/lib/x86_64-linux-gnu/openblas -lblas
charpent@zen-book-flip:/usr/local/sage-9$ pkg-config --libs --cflags lapack
-I/usr/include/x86_64-linux-gnu -L/usr/lib/x86_64-linux-gnu/openblas -llapack
```


[ Snip... ]


---

Comment by dimpase created at 2019-12-14 16:31:18

it seems to be Debian (testing/unstable) bug.


---

Comment by dimpase created at 2019-12-14 16:43:58

"generic" blas and lapack may be very different from what Sage needs, it is a tough call to test whether everything needed is there.


---

Comment by charpent created at 2019-12-14 16:58:26

Well... Starting from #28883, I created a local branch in which I merged #27870, then `make openblas-clean`, then `./bootstrap`, then `./configure`.

When I started make, the first thing it did was to recompile openblas...

And, sure enough, my `config.log` contains:

```
configure:11316: === checking whether to install the openblas SPKG ===
configure:11334: checking BLAS library
configure:11353: result: openblas
configure:11395: checking for OPENBLAS
configure:11402: $PKG_CONFIG --exists --print-errors "openblas >= 0.3.5"
Package openblas was not found in the pkg-config search path.
Perhaps you should add the directory containing `openblas.pc'
to the PKG_CONFIG_PATH environment variable
No package 'openblas' found
configure:11405: $? = 1
configure:11419: $PKG_CONFIG --exists --print-errors "openblas >= 0.3.5"
Package openblas was not found in the pkg-config search path.
Perhaps you should add the directory containing `openblas.pc'
to the PKG_CONFIG_PATH environment variable
No package 'openblas' found
configure:11422: $? = 1
configure:11436: result: no
No package 'openblas' found
```



---

Comment by dimpase created at 2019-12-14 17:40:38

#28883 has nothing to do with testing Debian distro bug that you reported, it is meant for MacOS problem reported by John.

If you want to try to use the `openblas.pc` you have, you can do

```
export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig"
make openblas-clean
./configure # - and check the output - for openblas not being installed
```

if this worked you can try building, i.e. `make` or `make build`...


---

Comment by jhpalmieri created at 2019-12-14 17:53:01

It's true I usually use MacOS, but for this ticket I've been using an Ubuntu virtual machine, so #28883 is relevant.


---

Comment by dimpase created at 2019-12-14 18:11:36

Replying to [comment:52 jhpalmieri]:
> It's true I usually use MacOS, but for this ticket I've been using an Ubuntu virtual machine, so #28883 is relevant.

right, indeed. Anyway, #28883 is meant to fix a problem with building numpy with already configured external openblas, rather than a configuration problem of newer Debians.


---

Comment by charpent created at 2019-12-14 18:41:41

Replying to [comment:51 dimpase]:
> #28883 has nothing to do with testing Debian distro bug that you reported, it is meant for MacOS problem reported by John.
> 
> If you want to try to use the `openblas.pc` you have, you can do
> {{{
> export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/openblas-pthread/pkgconfig"
> make openblas-clean
> ./configure # - and check the output - for openblas not being installed
> }}}
> if this worked you can try building, i.e. `make` or `make build`...

This //seems// to have worked. Now `make`ing. Don't hold your breath...

**EDIT :** `make` went directly to building the docs, which seems fishy : I expected it to recompile openblas-dependent packages (among them R). But these binaries somehow have caught the change :


```
charpent@zen-book-flip:/usr/local/sage-9$ ./sage -R

R version 3.6.1 (2019-07-05) -- "Action of the Toes"

[ Snip ... ]

> sessionInfo()
R version 3.6.1 (2019-07-05)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Debian GNU/Linux bullseye/sid

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.7.so

[ re-Snip... ]

```


So it seems to work.

In your opinion (prbably better than mine), is the need to set PKG_CONFIG_PATH enough to block a `positive review` ?

Anyway, `ptestlong` underway...


---

Comment by dimpase created at 2019-12-14 18:57:31

How can a bug in Debian, which can be worked around by setting appropriately `PKG_CONFIG_PATH`, be a blocker to this? It cannot work for all the broken systems out there  :-)

E.g. Homebrew (on MacOS) also installs openblas somewhere strange, with a need to set `PKG_CONFIG_PATH` (it tells you this, actually).


---

Comment by charpent created at 2019-12-14 20:29:47

Changing status from needs_review to positive_review.


---

Comment by charpent created at 2019-12-14 20:29:47

Replying to [comment:55 dimpase]:
> How can a bug in Debian, which can be worked around by setting appropriately `PKG_CONFIG_PATH`, be a blocker to this? It cannot work for all the broken systems out there  :-)
> 
> E.g. Homebrew (on MacOS) also installs openblas somewhere strange, with a need to set `PKG_CONFIG_PATH` (it tells you this, actually).

Okay.

Anyway, `ptestlong` gets two permanent failures (and no transient):


```
charpent@zen-book-flip:/usr/local/sage-9$ sage -t --long --warn-long 178.2 src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
Running doctests with ID 2019-12-14-21-20-56-a860b5d2.
Git branch: t/27870/packages/openblas/openblasconf
Using --optional=build,dochtml,memlimit,sage
Doctesting 1 file.
sage -t --long --warn-long 178.2 src/sage/numerical/backends/glpk_backend.pyx
**********************************************************************
File "src/sage/numerical/backends/glpk_backend.pyx", line 2287, in sage.numerical.backends.glpk_backend.GLPKBackend.print_ranges
Failed example:
    p.print_ranges()
Expected:
    glp_print_ranges: optimal basic solution required
    1
Got:
    1
**********************************************************************
1 item had failures:
   1 of  13 in sage.numerical.backends.glpk_backend.GLPKBackend.print_ranges
    [554 tests, 1 failure, 3.70 s]
----------------------------------------------------------------------
sage -t --long --warn-long 178.2 src/sage/numerical/backends/glpk_backend.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 3.8 seconds
    cpu time: 3.6 seconds
    cumulative wall time: 3.7 seconds
```



```
charpent@zen-book-flip:/usr/local/sage-9$ sage -t --long --warn-long 178.2 src/sage/libs/glpk/error.pyx  # 1 doctest failed
Running doctests with ID 2019-12-14-21-21-18-8e3dc9e1.
Git branch: t/27870/packages/openblas/openblasconf
Using --optional=build,dochtml,memlimit,sage
Doctesting 1 file.
sage -t --long --warn-long 178.2 src/sage/libs/glpk/error.pyxThos failures have already been reported for the same machine 
**********************************************************************
File "src/sage/libs/glpk/error.pyx", line 100, in sage.libs.glpk.error.setup_glpk_error_handler
Failed example:
    res = p.solve()
Expected:
          0: obj = ...
Got:
    <BLANKLINE>
**********************************************************************
1 item had failures:
   1 of  11 in sage.libs.glpk.error.setup_glpk_error_handler
    [12 tests, 1 failure, 0.72 s]
----------------------------------------------------------------------
sage -t --long --warn-long 178.2 src/sage/libs/glpk/error.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 0.7 seconds
    cpu time: 0.4 seconds
    cumulative wall time: 0.7 seconds
```


Those failures were already reported (in [sage-release](https://groups.google.com/d/msg/sage-release/p3mnazZ58HQ/0neeoSraBQAJ)) for the same machine and the same version of (Python 3-based) 9.0.beta9. Therefore, they do  do not seem to be related to the current patch.

==> `positive_review`, subject to better-informed advice...


---

Comment by isuruf created at 2019-12-15 01:17:29

Works for me with conda.


---

Comment by charpent created at 2019-12-16 09:47:39

Replying to [comment:39 charpent]:
> Replying to [comment:38 dimpase]:
> > Well, this pretty much looks like a Debian bug. The point of installing `openblas.pc` into a hidden from `pkg-config` directory only makes sense if they plan to install "competing" versions of this file in different locations...
> 
> This is now [Debian bug 946698 ](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=946698). For what it's worth...

FWIW, this Debian bug is [claimed](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=946698).  to have been fixed. In about 45 hours... Pffew !


---

Comment by vbraun created at 2019-12-20 22:46:06

Resolution: fixed


---

Comment by vbraun created at 2019-12-22 15:16:26

This ticket breaks build on OSX:

```
************************************************************************
Traceback (most recent call last):
  File "setup.py", line 72, in <module>
    from module_list import ext_modules, library_order
  File "/Users/buildbot-sage/slave/sage_git/build/src/module_list.py", line 42, in <module>
    zlib_pc = pkgconfig.parse('zlib')
  File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 248, in parse
    _raise_if_not_exists(package)
  File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
    raise PackageNotFoundError(package)
pkgconfig.pkgconfig.PackageNotFoundError: zlib not found
************************************************************************
Error building the Sage library
************************************************************************
```



---

Comment by vbraun created at 2019-12-22 15:16:26

Changing status from closed to new.


---

Comment by vbraun created at 2019-12-22 15:16:26

Resolution changed from fixed to 


---

Comment by dimpase created at 2019-12-22 15:23:18

one needs details such as whether you build zlib or use zlib from the system, whether Python gets  correctly built zlib module, etc.

What does happen if you do

```
./sage --python
>>> import zlib
```



---

Comment by vbraun created at 2019-12-22 15:28:29

Should be the fault of the dependency at #28883


---

Comment by vbraun created at 2019-12-22 15:28:29

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-12-22 15:35:56

Well, we do need a newer pkgconfig from #28883 here, and I really have no idea what breaks for you at #28883. Did you try `make distclean` ?


---

Comment by vbraun created at 2019-12-22 15:40:19

On Catalina, there is no zlib in /usr/lib/pkgconfig and we don't build our own zlib with #27870.

```
buildbot-sage@osx build % ./sage -sh -c 'pkgconf --cflags zlib'

Package zlib was not found in the pkg-config search path.
Perhaps you should add the directory containing `zlib.pc'
to the PKG_CONFIG_PATH environment variable
Package 'zlib', required by 'world', not found
```

All builds from scratch.


---

Comment by vbraun created at 2019-12-22 16:01:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-12-22 16:01:07

Is the fault of #28883


---

Comment by vbraun created at 2019-12-22 16:06:43

New commits:


---

Comment by git created at 2019-12-28 07:41:07

Changing status from positive_review to needs_review.


---

Comment by git created at 2019-12-28 07:41:07

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by dimpase created at 2019-12-28 07:42:22

trivial rebase over updated #28883


---

Comment by dimpase created at 2019-12-28 07:42:22

Changing status from needs_review to positive_review.


---

Comment by embray created at 2020-01-08 14:38:03

Currently doesn't detect system openblas on Cygwin (which just gets installed as the generic libblas when you install it).  Not sure why yet.  I won't hold up this ticket over it but if I can find a quick fix I might like to do that.


---

Comment by dimpase created at 2020-01-08 14:51:12

what does `pkg-config --modversion openblas` say?


---

Comment by embray created at 2020-01-08 15:02:53

Replying to [comment:72 embray]:
> Currently doesn't detect system openblas on Cygwin (which just gets installed as the generic libblas when you install it).  Not sure why yet.  I won't hold up this ticket over it but if I can find a quick fix I might like to do that.

I see; it's simply that Cygwin does not install an openblas.pc.  That's annoying.  I'll see if I can get that fixed upstream.  In the meantime we can just leave this as-is.

I think as a broader improvement to the current situation it's worth recognizing that the spkg-install for "atlas" actually does two things:

* If you have the old `SAGE_ATLAS_LIB` environment variable set it will just detect and use any old generic BLAS it can find in th given path; it doesn't care if it's actually ATLAS or not.
* Otherwise it contains steps for specifically building and installing ATLAS from source.

These two cases seem to be quite at odds with each-other, and the naming of `SAGE_ATLAS_LIB` is misleading.

I think what we should do is this (in a separate ticket):

* Deprecate use of `SAGE_ATLAS_LIB`; it can still work for now but display a deprecation message if it is set sage is configured with `--with-blas=atlas`.

* Clean up the atlas SPKG a bit so it's only responsible for installing ATLAS if requested.

* Add a generic package called just "blas" (we could keep openblas as the default though).  The spkg-configure.m4 for blas would implement the `--with-blas` flag, and also extend it to take an optional argument of a path (e.g. instead of `--with-blas=openblas` or `--with-blas=atlas` one can pass something like `--with-blas=/usr/lib`.  This latter case would have essentially functionality as the current `SAGE_ATLAS_LIB` (maybe a little better): use that path to search for a generic blas library; maybe also check that it contains some known symbols.
  * This is nice, because if you use the `--with-blas=<path>` option you don't get any SPKGs installed for blas, emphasizing that some generic blas on the system is being used.


---

Comment by dimpase created at 2020-01-08 15:23:09

iirc, SAGE_ATLAS_LIB is used for two rather different purposes. So there is some cleaning up due.


---

Comment by embray created at 2020-01-08 16:24:24

Replying to [comment:75 dimpase]:
> iirc, SAGE_ATLAS_LIB is used for two rather different purposes. So there is some cleaning up due.

The only use of it I could find was in `build/pkgs/atlas/spkg-install.py`.  If set, the directory it's set to is searched (in a fairly flimsy manner) for files that look blas-ish, although in one case it does explicitly look for an existing ATLAS install (if any functionality like this is to be kept it should be moved to `atlas/spkg-configure.m4`).  If anything is found it creates some symlinks to the found libraries into `SAGE_LOCAL` (this should go away), and also generates some .pc files (also probably can go away and handled more like you did with zlib...)


---

Comment by vbraun created at 2020-01-09 23:44:36

Resolution: fixed


---

Comment by embray created at 2020-01-13 13:37:01

Apparently my rather old Ubuntu lacks a `PKG_CONFIG_VAR` macro, so since this ticket I get:


```
$ ./bootstrap
rm -rf config configure build/make/Makefile-auto.in
bootstrap:69: installing 'config/config.rpath'
configure.ac:328: installing 'config/compile'
configure.ac:113: installing 'config/config.guess'
configure.ac:113: installing 'config/config.sub'
configure.ac:68: installing 'config/install-sh'
configure.ac:68: installing 'config/missing'
configure.ac:453: error: possibly undefined macro: AC_CONFIG_COMMANDS
      If this token and others are legitimate, please use m4_pattern_allow.
      See the Autoconf documentation.
configure:17006: error: possibly undefined macro: PKG_CHECK_VAR
configure:17007: error: possibly undefined macro: AC_CONFIG_LINKS
configure:17012: error: possibly undefined macro: AC_MSG_WARN
```


(I don't know why it complains first about `AC_CONFIG_COMMANDS` since that's standard autoconf, but it seems likely the problem is stemming from `PKG_CHECK_VAR` being missing.)

I'm going to look into it.


---

Comment by dimpase created at 2020-01-13 13:48:48

you must have a past-EOL Ubuntu, I gather.


---

Comment by embray created at 2020-01-13 14:17:41

Replying to [comment:74 embray]:
> Replying to [comment:72 embray]:
> * Add a generic package called just "blas" (we could keep openblas as the default though).  The spkg-configure.m4 for blas would implement the `--with-blas` flag, and also extend it to take an optional argument of a path (e.g. instead of `--with-blas=openblas` or `--with-blas=atlas` one can pass something like `--with-blas=/usr/lib`.  This latter case would have essentially functionality as the current `SAGE_ATLAS_LIB` (maybe a little better): use that path to search for a generic blas library; maybe also check that it contains some known symbols.

Perhaps the idea of a "generic package" is overcomplicated for now.  Although it's something I've wanted to try to do in the past (#23465) but as a first pass detection of a "generic blas" can live in the spkg-configure.m4 for openblas (sort of as we do with gmp/mpir).


---

Comment by embray created at 2020-01-13 15:06:18

On the third-hand, because of the way the Sage build uses .pc files for cblas and lapack, and the fact that both the openblas and atlas SPKGs install these .pc files into SAGE_LOCAL, I understand now that even when we detect a system openblas, this ticket uses `AC_CONFIG_LINKS` to create those .pc files as symlinks directly into `$SAGE_LOCAL`.

I don't really like this, because part of my long-term goals has been to make it so that running `configure` doesn't create and write _anything_ to `$SAGE_LOCAL` (this preference is in service to issues like #21532).  I'm okay with it for now as a temporary solution, but it does seem like a step backwards.

I'm going to see if I can come up with an alternative solution to this...
