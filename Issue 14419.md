# Issue 14419: occasional doctest failure in test_graceful_exit

archive/issues_014419.json:
```json
{
    "body": "Assignee: @roed314\n\nCC:  @jdemeyer\n\nThe test will call a Python subprocess at a random moment and verify that GP/Pari shuts down. But depending on timings I get two different outputs: Either\n\n```\nAn exception has occurred, use %tb to see the full traceback.\n\nSystemExit\n\nsage: \nExiting Sage (CPU time 0m0.02s, Wall time 0m0.11s).\nExiting spawned PARI/GP interpreter process.\n```\n\nor\n\n```\nTraceback (most recent call last)...\nTypeError: 'int' object is not callable\nExiting Sage (CPU time 0m0.36s, Wall time 0m0.38s).\nExiting spawned PARI/GP interpreter process.\n```\n\nBut the doctest\n\n```\n    sage: str(P.stdout.read())  # long time\n    '...Exiting spawned PARI/GP interpreter process...'\n```\n\nmatches only the former because of the somewhat convoluted quotation rules:\n\n```\nsage: repr(\"my 'foo' bar\")   # output starts with single quote\n'\"my \\'foo\\' bar\"'\nsage: repr(\"my foo bar\")     # output starts with double quote\n\"'my foo bar'\"\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14623\n\n",
    "created_at": "2013-05-21T14:43:17Z",
    "labels": [
        "component: doctest framework",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.10",
    "title": "occasional doctest failure in test_graceful_exit",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14419",
    "user": "https://github.com/vbraun"
}
```
Assignee: @roed314

CC:  @jdemeyer

The test will call a Python subprocess at a random moment and verify that GP/Pari shuts down. But depending on timings I get two different outputs: Either

```
An exception has occurred, use %tb to see the full traceback.

SystemExit

sage: 
Exiting Sage (CPU time 0m0.02s, Wall time 0m0.11s).
Exiting spawned PARI/GP interpreter process.
```

or

```
Traceback (most recent call last)...
TypeError: 'int' object is not callable
Exiting Sage (CPU time 0m0.36s, Wall time 0m0.38s).
Exiting spawned PARI/GP interpreter process.
```

But the doctest

```
    sage: str(P.stdout.read())  # long time
    '...Exiting spawned PARI/GP interpreter process...'
```

matches only the former because of the somewhat convoluted quotation rules:

```
sage: repr("my 'foo' bar")   # output starts with single quote
'"my \'foo\' bar"'
sage: repr("my foo bar")     # output starts with double quote
"'my foo bar'"
```


Issue created by migration from https://trac.sagemath.org/ticket/14623





---

archive/issue_comments_182060.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-21T14:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182060",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_182061.json:
```json
{
    "body": "One could think about fixing this on the level of the doctest framework, but then it seems to be unlikely enough that we don't really have to worry about this. My trivial patch just unquotes stuff.\n\nFor the record, the doctest failure looks like this:\n\n```\nsage -t --long sage/tests/interrupt.pyx\n**********************************************************************\nFile \"sage/tests/interrupt.pyx\", line 846, in sage.tests.interrupt.test_graceful_exit\nFailed example:\n    P.stdout.read()  # long time\nExpected:\n    '...Exiting spawned PARI/GP interpreter process...'\nGot:\n    \"---------------------------------------------------------------------------\\nTypeError                                 Traceback (most recent call last)\\nTypeError: 'int' object is not callable\\nsage: \\nExiting Sage (CPU time 0m0.34s, Wall time 0m0.47s).\\nExiting spawned PARI/GP interpreter process.\\n\"\n**********************************************************************\n1 item had failures:\n   1 of  10 in sage.tests.interrupt.test_graceful_exit\n    [97 tests, 1 failure, 24.88 s]\n```\n",
    "created_at": "2013-05-21T14:49:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182061",
    "user": "https://github.com/vbraun"
}
```

One could think about fixing this on the level of the doctest framework, but then it seems to be unlikely enough that we don't really have to worry about this. My trivial patch just unquotes stuff.

For the record, the doctest failure looks like this:

```
sage -t --long sage/tests/interrupt.pyx
**********************************************************************
File "sage/tests/interrupt.pyx", line 846, in sage.tests.interrupt.test_graceful_exit
Failed example:
    P.stdout.read()  # long time
Expected:
    '...Exiting spawned PARI/GP interpreter process...'
Got:
    "---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\nTypeError: 'int' object is not callable\nsage: \nExiting Sage (CPU time 0m0.34s, Wall time 0m0.47s).\nExiting spawned PARI/GP interpreter process.\n"
**********************************************************************
1 item had failures:
   1 of  10 in sage.tests.interrupt.test_graceful_exit
    [97 tests, 1 failure, 24.88 s]
```




---

archive/issue_comments_182062.json:
```json
{
    "body": "Why would adding `str()` work? I think `P.stdout.read()` is already a string, so adding `str()` shouldn't make a difference.\n\nHow about\n\n```\nsage: print P.stdout.read()\n```\n",
    "created_at": "2013-05-21T15:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182062",
    "user": "https://github.com/jdemeyer"
}
```

Why would adding `str()` work? I think `P.stdout.read()` is already a string, so adding `str()` shouldn't make a difference.

How about

```
sage: print P.stdout.read()
```




---

archive/issue_comments_182063.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-05-21T15:00:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182063",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_182064.json:
```json
{
    "body": "Yes, I just realized that. But print doesn't work because you can't ellipsize the beginning of the result since `^...` is prompt continuation....",
    "created_at": "2013-05-21T16:28:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182064",
    "user": "https://github.com/vbraun"
}
```

Yes, I just realized that. But print doesn't work because you can't ellipsize the beginning of the result since `^...` is prompt continuation....



---

archive/issue_comments_182065.json:
```json
{
    "body": "Attachment [trac_14623_shutdown_doctest_fix.patch](tarball://root/attachments/some-uuid/ticket14623/trac_14623_shutdown_doctest_fix.patch) by @vbraun created at 2013-05-21 16:36:12\n\nUpdated patch",
    "created_at": "2013-05-21T16:36:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182065",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14623_shutdown_doctest_fix.patch](tarball://root/attachments/some-uuid/ticket14623/trac_14623_shutdown_doctest_fix.patch) by @vbraun created at 2013-05-21 16:36:12

Updated patch



---

archive/issue_comments_182066.json:
```json
{
    "body": "Fixed.",
    "created_at": "2013-05-21T16:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182066",
    "user": "https://github.com/vbraun"
}
```

Fixed.



---

archive/issue_comments_182067.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-05-21T16:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182067",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_182068.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-23T07:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182068",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_182069.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-05-26T19:48:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14419",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14419#issuecomment-182069",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
