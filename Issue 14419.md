# Issue 14419: occasional doctest failure in test_graceful_exit

Issue created by migration from https://trac.sagemath.org/ticket/14623

Original creator: vbraun

Original creation time: 2013-05-21 14:43:17

Assignee: roed

CC:  jdemeyer

The test will call a Python subprocess at a random moment and verify that GP/Pari shuts down. But depending on timings I get two different outputs: Either

```
An exception has occurred, use %tb to see the full traceback.

SystemExit

sage: 
Exiting Sage (CPU time 0m0.02s, Wall time 0m0.11s).
Exiting spawned PARI/GP interpreter process.
```

or

```
Traceback (most recent call last)...
TypeError: 'int' object is not callable
Exiting Sage (CPU time 0m0.36s, Wall time 0m0.38s).
Exiting spawned PARI/GP interpreter process.
```

But the doctest

```
    sage: str(P.stdout.read())  # long time
    '...Exiting spawned PARI/GP interpreter process...'
```

matches only the former because of the somewhat convoluted quotation rules:

```
sage: repr("my 'foo' bar")   # output starts with single quote
'"my \'foo\' bar"'
sage: repr("my foo bar")     # output starts with double quote
"'my foo bar'"
```



---

Comment by vbraun created at 2013-05-21 14:49:50

Changing status from new to needs_review.


---

Comment by vbraun created at 2013-05-21 14:49:50

One could think about fixing this on the level of the doctest framework, but then it seems to be unlikely enough that we don't really have to worry about this. My trivial patch just unquotes stuff.

For the record, the doctest failure looks like this:

```
sage -t --long sage/tests/interrupt.pyx
**********************************************************************
File "sage/tests/interrupt.pyx", line 846, in sage.tests.interrupt.test_graceful_exit
Failed example:
    P.stdout.read()  # long time
Expected:
    '...Exiting spawned PARI/GP interpreter process...'
Got:
    "---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\nTypeError: 'int' object is not callable\nsage: \nExiting Sage (CPU time 0m0.34s, Wall time 0m0.47s).\nExiting spawned PARI/GP interpreter process.\n"
**********************************************************************
1 item had failures:
   1 of  10 in sage.tests.interrupt.test_graceful_exit
    [97 tests, 1 failure, 24.88 s]
```



---

Comment by jdemeyer created at 2013-05-21 15:00:43

Why would adding `str()` work? I think `P.stdout.read()` is already a string, so adding `str()` shouldn't make a difference.

How about

```
sage: print P.stdout.read()
```



---

Comment by jdemeyer created at 2013-05-21 15:00:43

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2013-05-21 16:28:59

Yes, I just realized that. But print doesn't work because you can't ellipsize the beginning of the result since `^...` is prompt continuation....


---

Attachment

Updated patch


---

Comment by vbraun created at 2013-05-21 16:36:43

Fixed.


---

Comment by vbraun created at 2013-05-21 16:36:43

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2013-05-23 07:18:15

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-05-26 19:48:50

Resolution: fixed
