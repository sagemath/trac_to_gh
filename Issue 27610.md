# Issue 27610: openblas 0.3.6

Issue created by migration from https://trac.sagemath.org/ticket/27847

Original creator: vbraun

Original creation time: 2019-05-18 10:56:05

CC:  embray




---

Comment by vbraun created at 2019-05-18 10:57:02

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by vbraun created at 2019-05-18 10:57:02

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vbraun created at 2019-05-18 11:08:13

New commits:


---

Comment by vbraun created at 2019-05-18 11:08:13

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-05-18 11:24:05

these patches you removed - they are upstream, or they just don't apply?


---

Comment by vbraun created at 2019-05-18 12:05:18

Upstreamed


---

Comment by dimpase created at 2019-05-18 12:11:00

OK, so Cygwin should not be a problem then.


---

Comment by dimpase created at 2019-05-18 17:23:27

On Gentoo Linux withg gcc 9.1 I am getting here from `make ptest`

```
sage: B.<a,b,c> = BooleanPolynomialRing() ## line 4733 ##

out of memory allocating 8388640 bytes
```

as well as

```
sage -t src/sage/rings/polynomial/multi_polynomial_sequence.py
    Killed due to abort
**********************************************************************
Tests run before process (pid=19424) failed:
sage: sr = mq.SR(2,1,2,4,gf2=True,polybori=True) ## line 26 ##
sage: sr ## line 27 ##
SR(2,1,2,4)
sage: set_random_seed(1) ## line 33 ##
sage: F,s = sr.polynomial_system() ## line 34 ##
sage: F ## line 35 ##

out of memory allocating 8388640 bytes
```

and one more polybori-related failure, in total 3

```
----------------------------------------------------------------------
sage -t src/sage/crypto/mq/sr.py  # Killed due to abort
sage -t src/sage/rings/polynomial/multi_polynomial_sequence.py  # Killed due to abort
sage -t src/sage/rings/polynomial/pbori.pyx  # Killed due to abort
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2019-05-18 22:51:29

Yes, see #27676 for the brial failures with gcc9


---

Comment by dimpase created at 2019-05-19 07:10:16

anyhow, I also tested with gcc 8.3 on Linux and on OSX with clang, these are all good.
Waiting for Cygwin confirmation I suppose, from Erik.


---

Comment by mkoeppe created at 2019-05-20 01:18:50

This new version also fixes a compile problem unrelated to #27676 that I encountered with 0.3.5.p1, on a CentOS Linux release 7.6.1810 running on Intel(R) Xeon(R) Gold 6152 CPU.  0.3.6 from this ticket compiles and passes its test suite on this system.


---

Comment by dimpase created at 2019-05-20 12:15:25

while we are at it, can we drop `write_pc_file.py` ? With this version, if you run `make install` then OpenBLAS does generate `openblas.pc` by itself.


---

Comment by dimpase created at 2019-05-21 19:33:11

Replying to [comment:11 dimpase]:
> while we are at it, can we drop `write_pc_file.py` ? With this version, if you run `make install` then OpenBLAS does generate `openblas.pc` by itself.

In fact, I don't know where `write_pc_file.py` writes anything. If I remove it I still get `local/lib/pkgconfig/openblas.pc` written just fine.


---

Comment by dimpase created at 2019-05-22 07:04:45

New commits:


---

Comment by dimpase created at 2019-05-22 15:41:20

OK, I see there is a small problem - one still needs to make these `(c)blas.pc` and `lapack.pc` from `openblas.pc`. Not sure whether `Name:` line needs to be adjusted, or merely a copy/link will do.


---

Comment by dimpase created at 2019-05-22 17:21:23

Let us postpone this then, so back to postive review from me.


---

Comment by embray created at 2019-05-23 11:19:12

I'll give it a look. I want to review this very carefully, as I've been practically traumatized by OpenBLAS in the last year. I know this release should include many of my existing fixes but I want to look over the other diffs between versions to make sure no other obvious regressions crept in.


---

Comment by vbraun created at 2019-05-25 09:46:12

Can you do this sometime soon, I can't build Sage on my own PC...


---

Comment by dimpase created at 2019-05-25 10:39:36

How crucial is Openblas for Cygwin? Can't one use SAGE_ATLAS_LIB and whatever is supplied by Cygwin? (but we should work on #27870 anyway, to resolve these things in a meaningful way)


---

Comment by vbraun created at 2019-05-30 22:37:54

Any updates?


---

Comment by embray created at 2019-05-31 13:54:09

Replying to [comment:17 vbraun]:
> What exactly do you mean by this?


---

Comment by embray created at 2019-05-31 14:11:39

I will test this as soon as _I_ can get a working Sage, which now seems to be a problem due to some other reason (possibly related to #27901 but unclear).


---

Comment by vbraun created at 2019-06-02 13:30:15

Changing priority from major to blocker.


---

Comment by vbraun created at 2019-06-02 13:31:32

That I'm on gcc9 and while I can technically build Sage, the testsuite fails with heaps of errors.


I'm in favor of releasing this if Eric can't try out cygwin any time soon. Its a must fix for currently supported platforms.


---

Comment by mkoeppe created at 2019-06-02 22:33:44

Replying to [comment:23 vbraun]:
> I'm in favor of releasing this if Eric can't try out cygwin any time soon. Its a must fix for currently supported platforms.

+1


---

Comment by mkoeppe created at 2019-06-02 22:39:35

On a different Linux system (Ubuntu 18.04.2 LTS, running on some virtualized AMD system), I have the following problem with both 0.3.5.p1 and 0.3.6:

```
[openblas-0.3.6.p0] perl ./gensymbol linktest  x86_64 _ 0 0 0 0 0 0 "" "" 1 > linktest.c
[openblas-0.3.6.p0] gcc -O2 -DMAX_STACK_ALLOC=2048 -Wall -m64 -DF_INTERFACE_GFORT -fPIC -DSMP_SERVER -DNO_WARMUP -DMAX_CPU_NUMBER=24 -DMAX_PARALLEL_NUMBER=1 -DUSE_TLS -DVERSION=\"0.3.6\" -DASMNAME= -DASMFNAME=_ -DNAME=_ -DCNAME= -DCHAR_NAME=\"_\" -DCHAR_CNAME=\"\" -DNO_AFFINITY -I.. -L/homes/home05/m/mkoeppe/sage/local/lib -Wl,-rpath,/homes/home05/m/mkoeppe/sage/local/lib  -shared -o ../libopenblas_atomp-r0.3.6.so \
[openblas-0.3.6.p0] -Wl,--whole-archive ../libopenblas_atomp-r0.3.6.a -Wl,--no-whole-archive \
[openblas-0.3.6.p0] -Wl,-soname,libopenblas.so.0 -lm -lpthread -lgfortran -lm -lpthread -lgfortran
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(ssymv_U.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(ssymv_L.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(dsymv_U.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can n
ot be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(dsymv_L.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(zsymv_U.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(zsymv_L.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(zhemv_U.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: ../libopenblas_atomp-r0.3.6.a(zhemv_L.o): relocation R_X86_64_32S against undefined symbol `PREFETCHSIZE' can not be used when making a shared object; recompile with -fPIC
[openblas-0.3.6.p0] /usr/bin/ld: final link failed: Nonrepresentable section on output
[openblas-0.3.6.p0] collect2: error: ld returned 1 exit status
[openblas-0.3.6.p0] Makefile:153: recipe for target '../libopenblas_atomp-r0.3.6.so' failed
[openblas-0.3.6.p0] make[3]: *** [../libopenblas_atomp-r0.3.6.so] Error 1
[openblas-0.3.6.p0] make[3]: Leaving directory '/homes/home05/m/mkoeppe/sage/local/var/tmp/sage/build/openblas-0.3.6.p0/src/exports'
[openblas-0.3.6.p0] Makefile:101: recipe for target 'shared' failed
[openblas-0.3.6.p0] make[2]: *** [shared] Error 2
[openblas-0.3.6.p0] make[2]: Leaving directory '/homes/home05/m/mkoeppe/sage/local/var/tmp/sage/build/openblas-0.3.6.p0/src'
[openblas-0.3.6.p0] ********************************************************************************
[openblas-0.3.6.p0] Error building openblas-0.3.6.p0
```

Nevertheless, I'm setting the ticket to positive review.


---

Comment by mkoeppe created at 2019-06-02 22:39:48

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-06-03 06:15:18

What exactly is the issue with gcc9 that this is resolving?


---

Comment by dimpase created at 2019-06-03 07:57:33

Replying to [comment:27 embray]:
> What exactly is the issue with gcc9 that this is resolving?
see #27676 - basically, openblas 0.3.5 is too old for gcc9, which miscompiles it.


---

Comment by vbraun created at 2019-06-06 22:26:50

Resolution: fixed


---

Comment by embray created at 2019-06-07 17:23:10

Replying to [comment:28 dimpase]:
> Replying to [comment:27 embray]:
> > What exactly is the issue with gcc9 that this is resolving?
> see #27676 - basically, openblas 0.3.5 is too old for gcc9, which miscompiles it.

I think not being able to use the most bleeding-edge version of a compiler is not such a blocker if it means forcing dependency updates that could lead to instabilities in other ways (in general being always at the bleeding edge lends some instability; as does falling too far behind).

In this case, at least, I haven't been able to identify any major problems with this openblas release, and it fixes all the problems i'm aware of from 0.3.5, which was a mess.


---

Comment by jhpalmieri created at 2019-06-09 19:39:16

This seems to cause Sage to crash with some machines using OS X. From the end of Sage_crash_report.txt:

```
ImportError: dlopen(/Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_rational_dense.so, 2): Library not loaded: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/libopenblas_haswellp-r0.3.5.dylib
  Referenced from: /Users/palmieri/Desktop/Sage_stuff/git/sage/local/lib/python2.7/site-packages/sage/matrix/matrix_rational_dense.so
  Reason: image not found
```



---

Comment by jhpalmieri created at 2019-06-09 19:45:57

Followup at #27961.


---

Comment by dimpase created at 2019-06-09 20:31:08

why does the error message mention 0.3.5 as the version number of the library which cannot be loaded?

and not 0.3.6?


---

Comment by jhpalmieri created at 2019-06-09 20:58:52

I don't know, but that's the error I get with this ticket plus 8.8.beta7, incremental build.


---

Comment by jhpalmieri created at 2019-06-10 22:37:26

A second issue, only present on one OS X machine so far:

```
sage: M = ModularSymbols(GammaH(13,[3]), weight=4)
sage: M.cuspidal_subspace()
Fatal: Memory exhausted.
```

This occurs with 8.8.beta7 + this ticket. For now, let's track both issues at #27961. If they need to be separated into two tickets, we can do this later.
