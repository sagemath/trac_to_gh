# Issue 11365: units in polynomial rings with prime power characteristic

Issue created by migration from https://trac.sagemath.org/ticket/11537

Original creator: tdupu

Original creation time: 2011-06-23 19:38:16

Assignee: AlexGhitza


```
sage: p = 101
sage: S.<t> = PolynomialRing(ZZ.quotient_ring(p^3))
sage: f = 1+p*t^2
sage: f.is_unit()
True
```



```
sage: S.<t> = PolynomialRing(ZZ.quotient_ring(p^3),1)
sage: t = S.0
sage: f = 1+p*t^2
sage: f.is_unit()
False
sage: f.inverse_of_unit()
...
ArithmeticError: Element is not a unit.
```



```
sage: S1.<t> = PolynomialRing(ZZ.quotient_ring(p^3),1)
sage: S2.<tt> = PolynomialRing(ZZ.quotient_ring(p^3))
sage: S1
Multivariate Polynomial Ring in t over Ring of integers modulo 1030301
sage: S2
Univariate Polynomial Ring in tt over Ring of integers modulo 1030301
sage: S1 == S2
False
```




---

Attachment


---

Comment by tdupu created at 2011-06-23 19:42:34

--There are lots of "inverse_of_unit" methods one should implement while they are fixing this the attached notebook shows one way this can be done from prime power characteristic.


---

Comment by msaaltink created at 2017-03-06 16:51:38

New commits:


---

Comment by msaaltink created at 2017-03-06 16:51:38

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-03-07 17:35:48

-1 on removing the specialized code that uses Singular; at least I strongly suspect that is faster. You should be able to specify quickly in which cases you should punt up to the generic code. Also, don't use `$x$` for latex, instead use ``x``.


---

Comment by msaaltink created at 2017-03-07 20:39:58

Re: "-1 on removing the specialized code that uses Singular":   Yes, it is fast, but does not get the correct answers.  The same goes for libsingular's p_IsUnit. For some reason I am having trouble finding the documentation in libsingular that explains these two functions so do not know if they are even supposed to work in these non-integral domains.  I think the safest thing for now is to use the generic code to get the correct answer.

I'll look into the latex issue and push something soon.


---

Comment by tscrim created at 2017-03-07 21:07:25

As I said, I would probably send it up to the generic case when the base ring is not something nice. Probably a good condition is if the domain is known to be an integral domain, then use the specialized code. You should also post a bug report to Singular if using this in general is expected to work (provided you can find such information).


---

Comment by msaaltink created at 2017-03-10 01:48:27

I asked about the Singular functions used here, in the Singular forum, post 2582 (https://www.singular.uni-kl.de/forum/viewtopic.php?f=10&t=2582).  The answer (from "hannes") is quite clear:

```
p_Invers: is only a helper routine for the 3-argument forms of jet [...]
It should not be used otherwise: is a static routine in newer releases
Furthermore, the coefficients must be from a field.

p_IsUnit: is currently only used to simplify ideals,
and currently defined as: p is a constant polynomial and the constant is a unit.
I will try to extend that.....but it is of low priority.
```


So I think the specialized code in multi_polynomial_libsingular canniot be relied on, and we should stick with the generic code.  The Singular documentation offers no other functions that look useful here.


---

Comment by git created at 2017-03-10 03:39:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by msaaltink created at 2017-03-11 21:14:12

I have made the change from $x$ to `x` in the above commit.  This makes the documentation look better in the interactive console, which is not something I knew after reading the developer guide's section on Latex (http://doc.sagemath.org/html/en/developer/coding_basics.html#section-latex-typeset).


---

Comment by chapoton created at 2017-05-21 20:00:40

branch does not apply on latest beta


---

Comment by chapoton created at 2017-05-21 20:00:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-05-22 15:23:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by msaaltink created at 2017-05-22 15:27:14

Merged in the latest 'develop' branch, as suggested in the "advanced git" section of the developer guide for this situation.  I would have thought a rebase would be easier.


---

Comment by msaaltink created at 2017-05-22 15:27:14

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-05-22 16:17:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-05-22 17:55:01

1) Because it is private, the function `_inverse_of_unit_polynomial` and its documentation will not appear in the reference manual. I would prefer to have it public and have pointers from the various methods (via `:func:XXX`) to this function. These are implementation details but which might be of importance for advanced users. The algorithm in only explained in the function.

2) Wouldn't be easy to fix the following?

```
sage: R(5).inverse_of_unit()
Traceback (most recent call last):
...
AttributeError: <class 'sage.rings.polynomial.infinite_polynomial_element.InfinitePolynomial_sparse'>
has no attribute constant_coefficient
```


3) As far as I understand, singular call works in some cases. If this is the case, you would better keep it. You can easily make something like the following that is also done in other places in Sage

```
    def inverse_of_unit(self, algorithm=None):
        if algorithm is None:
             ... set algorithm to what is best ...

        if algorithm == 'singular':
             if self.base_ring().is_not_appropriate():
                 raise ValueError('does not work')
              ... singular imple ...
         elif algorithm == 'generic':
             ... what is provide in the branch ...
         else:
             raise ValueError('unknown algorithm %s' %algorithm)
```



---

Comment by msaaltink created at 2017-05-23 02:38:02

1) Good idea; I'll make those changes.

2) The fix is not as easy as I had hoped.  I have a branch open on ticket 22514 to fix this, but the way these constant infinite polynomials get created is hard to pin down---there are strange coercion things happening.  I'll get back at it and hope to have a fix soon.

3) The singular call works only when the polynomial is constant, so that all we do is invert the constant coefficient in the base ring.  I don't see this as worth going to singular for.


---

Comment by vdelecroix created at 2017-05-23 06:33:27

Replying to [comment:20 msaaltink]:
> 3) The singular call works only when the polynomial is constant, so that all we do is invert the constant coefficient in the base ring. I don't see this as worth going to singular for.

Indeed. So if Singular is that bad, remove the code. Do not put comments everywhere. You can keep a line or two of explanations

```
# Singular seems not able to invert non-constant polynomial.
# We use the generic function created in trac ticket #11537
```



---

Comment by git created at 2017-05-24 00:10:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2017-06-01 18:49:23

4) Could you add some checks that the parent is indeed correct, e.g.

```
sage: R.<x> = Zmod(32)[]
sage: inverse_of_unit_polynomial(1 + 4*x)
16*x^2 + 28*x + 1
sage: inverse_of_unit_polynomial(1 + 4*x) is R
True
```


5) I do not see where the following error is tested

```
except AttributeError:
    v =  ~u # many rings don't implement inverse_of_unit
    if v.parent() is not p.base_ring():
        raise NotImplementedError
```


6) In order to avoid coercion, it would be better to define `mp1 = m + 1` and use it in the loop. In the same veine, change `while p*i != 1` to `while not (p * i).is_one()`


---

Comment by vdelecroix created at 2017-06-01 18:49:23

Changing status from needs_review to needs_work.


---

Comment by msaaltink created at 2017-06-02 16:51:13

4) Do you mean that I should add a run-time check of some sort, or did you mean I should add an EXAMPLE or TEST?

5) In context, that code is

```
    try:
        v = u.inverse_of_unit()
    except AttributeError:
        v =  ~u # many rings don't implement inverse_of_unit
```

Perhaps the comment is misplaced; the except block is executed in cases where `v = u.inverse_of_unit()` is not implemented - which is for many rings.  Perhaps I should also check for `NotImplementedError`.   The fallback is to use `~v` if it is in the correct ring---sometimes it is in the fraction field.  I will try clarifying the comment.

6. Good idea; I'll do that.


---

Comment by vdelecroix created at 2017-06-02 16:57:00

Replying to [comment:24 msaaltink]:
> 4) Do you mean that I should add a run-time check of some sort, or did you mean I should add an EXAMPLE or TEST?

Not at runtime. Only inside `EXAMPLES` or/and `TESTS` (but it can still be rather exhaustive).

> 5) In context, that code is
> {{{
>     try:
>         v = u.inverse_of_unit()
>     except AttributeError:
>         v =  ~u # many rings don't implement inverse_of_unit
> }}}
> Perhaps the comment is misplaced; the except block is executed in cases where `v = u.inverse_of_unit()` is not implemented - which is for many rings.  Perhaps I should also check for `NotImplementedError`.   The fallback is to use `~v` if it is in the correct ring---sometimes it is in the fraction field.  I will try clarifying the comment.

It was not my point. My comment was about the two lines

```
    if v.parent() is not p.base_ring():
        raise NotImplementedError
```

This `NotImplementedError` does not appear in doctests.


---

Comment by git created at 2017-06-23 16:40:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by msaaltink created at 2017-06-23 16:45:37

Changing status from needs_work to needs_review.


---

Comment by msaaltink created at 2017-06-23 16:45:37

The last set of comments have been addressed in this latest commit:

4) has been done, with 3 more test cases

5) this condition is now tested.

6) `m + 1` cannot be pulled out of the loop because `m` is changed on every iteration.  I did however make the change from `p*i != 1` to `not (p*i).is_one()`.


---

Comment by vdelecroix created at 2017-06-24 14:59:11

Matrices form a non-commutative ring... you expect your algorithm to work in this case? Anyway, I am not sure it is good idea to use this in tests as it is completely broken

```
sage: M=MatrixSpace(QQ, 2, 2); S.<y> = M[]
sage: p = M.one() + y * M([0,2,0,0])
sage: inverse_of_unit_polynomial(p)
Traceback (most recent call last):
...
AttributeError: 'MatrixSpace_with_category' object has no attribute 'is_integral_domain'
```



---

Comment by vdelecroix created at 2017-06-24 15:03:51

and doctest failure

```
sage -t --long --warn-long 75.4 rings/polynomial/polynomial_element.pyx
**********************************************************************
File "rings/polynomial/polynomial_element.pyx", line 9680, in sage.rings.polynomial.polynomial_element.inverse_of_unit_polynomial
Failed example:
    inverse_of_unit_polynomial(S(1))
Expected:
    Traceback (most recent call last):
    ...
    NotImplementedError: Base ring, Full MatrixSpace of 2 by 2 dense matrices over Univariate Polynomial Ring in x over Integer Ring, does not implement inverse_of_unit.
Got:
    [1 0]
    [0 1]
**********************************************************************
```



---

Comment by vdelecroix created at 2017-06-24 15:03:51

Changing status from needs_review to needs_work.


---

Comment by msaaltink created at 2017-06-24 16:42:17

That is strange; the doctest succeeds for me.  However, as you point out, it is not good to use a noncommutative base ring.  I do not think I then have a test for the condition triggering the `NotImplementedError`, as the place this situation used to occur was in polynomial rings, and is fixed by this patch.  Still, I'm reluctant to take the untested code out, as a ring could be added in future that also has this feature (no `inverse_of_unit` and `~` taking us to a different ring).  Would it be cheating for me to create such a ring in the doctest?


---

Comment by vdelecroix created at 2017-06-24 18:32:56

Note that I did the testing on top of beta12 which might explain the changes.


---

Comment by vdelecroix created at 2017-06-24 18:46:11

Replying to [comment:30 msaaltink]:
> Would it be cheating for me to create such a ring in the doctest?

Yes!


---

Comment by vdelecroix created at 2017-06-24 18:57:25

When I try to build a complicated base ring, `is_nilpotent` or `is_unit` is not implemented.

Keep the code the way it is, but merge with beta12 and fix the doctest.


---

Comment by git created at 2017-06-29 15:19:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by msaaltink created at 2017-06-29 15:20:32

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-07-04 15:58:37

does not apply


---

Comment by chapoton created at 2017-07-04 15:58:37

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-07-04 22:57:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by msaaltink created at 2017-07-04 22:58:54

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2017-07-06 07:57:41

I added a commit to introduce `constant_coefficient` for infinite polynomial rings. Please review.
----
New commits:


---

Comment by msaaltink created at 2017-07-06 15:14:49

While this is a straightforward change that makes an additional test case work, I had really hoped for a more comprehensive answer to the problems identified in trac #22514.  In my opinion, the right fix is to ensure that the `_p` attribute on an infinite polynomial is always in fact a polynomial, which would fix the `constant coefficient` problem as well as the many others identified in #22514.  That fix, if made, would make this new method unnecessary.


---

Comment by vdelecroix created at 2017-07-06 15:25:55

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2017-07-06 15:25:55

I would be happy to have it the other way around, but then you should first fix #22514. Your branch attached to this ticket introduces a regression which is not good.


---

Comment by vdelecroix created at 2017-07-06 15:27:07

Note that many methods would be simplified if the attribute `_p` would consistently be a polynomial...


---

Comment by msaaltink created at 2017-07-09 20:36:41

I have pushed a proposed fix for #22514; if accepted it will make commit 718b0e2 unnecessary and will allow the test case for constant elements of an `InfinitePolynomialRing` to be successful.
