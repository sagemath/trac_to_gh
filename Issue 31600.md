# Issue 31600: lcalc: Fix for gcc 11

Issue created by migration from https://trac.sagemath.org/ticket/31837

Original creator: mkoeppe

Original creation time: 2021-05-18 18:03:06

CC:  tscrim dimpase fbissey mjo isuruf chapoton saraedum

Previous fixes in #30987


---

Comment by fbissey created at 2021-05-19 01:37:04

For the record if I don't get around this. The sage-on-gentoo patch supercedes a previous patch that touches the same section.


---

Comment by mkoeppe created at 2021-05-19 04:07:53

Is there an upstream repo?


---

Comment by fbissey created at 2021-05-19 04:23:32

Replying to [comment:3 mkoeppe]:
> Is there an upstream repo?

Funny you would ask https://groups.google.com/g/sage-devel/c/0nZaREwFJpQ/m/lfFLjUrLBAAJ


---

Comment by mjo created at 2021-06-02 19:17:41

Does anyone know Michael Rubinstein? As an upstream project, lcalc looks dead to me. It would be nice if we could get his blessing to work on its successor in our gitlab repo. There are a mountain of patches waiting to be applied, and we could fix the build system and test suite. We could then package the fork in sage and the various distros.


---

Comment by dimpase created at 2021-06-03 12:53:36

Upstream does not appear to be active (I did have an email exchange), and we certainly may do as we please.

(un)fortunately at some point Sage became de facto upstream for lcalc, and tracing the history of changes is not fun...


---

Comment by mjo created at 2021-06-06 14:14:02

Does anyone know if sage actually needs lcalc to be built with MPFR support? The repo at https://gitlab.com/sagemath/lcalc is in increasingly good shape, but support for MPFR is still broken.

The previous build system allowed you to manually define one of two constants, `-DMPFR` or `-DMPFRCPP`, which chose one of two C++ interfaces to MPFR. Using `-DMPFR` would use the much older interface from https://math.berkeley.edu/~wilken/code/gmpfrxx/, while `-DMPFRCPP` would use the still-maintained http://www.holoborodko.com/pavel/mpfr/. (The necessary headers still live in the old `include` directory.)

Problem is, when I define either constant, neither approach builds out-of-the box. The still-maintained interface would obviously be preferable, but there are horrendous C++ template errors either way. If sage doesn't actually need MPFR support in lcalc, I could choose the cowardly option to release lcalc-2.0.0 without MPFR support until someone cares enough to fix it. That would leave only the documentation and test suite to work on.


---

Comment by dimpase created at 2021-06-07 09:19:22

Sage does not build lcalc with MPFR support, so this is not a requirement for us.


---

Comment by mjo created at 2021-06-07 14:27:23

Ok, good. I was just looking at the "mpfr" in its `dependencies` file.

I may actually be able to get MPFR support working soon. I made it compile by adding a bunch of typecasts and by replacing the C++ built-in `complex` class with the one from lcalc's `Lcomplex.h` within `mpreal.h`. None of the output looks too crazy but I'm not exactly confident about it.


---

Comment by dimpase created at 2021-06-07 14:46:43

I checked that lcalc on a couple of systems is not linked with libmpfr.


---

Comment by mkoeppe created at 2021-06-20 15:27:17

How's this coming along?


---

Comment by mjo created at 2021-06-21 13:40:04

Replying to [comment:12 mkoeppe]:
> How's this coming along?

It's done AFAIK. The only thing left to do is run `make dist` in the lcalc repo, install it to the system, and see if it works with sage. Hopefully not too many changes are needed. The header location is now "officially" installed to `lcalc/L.h` but that's the only breaking change that I know of for sure.

If everything works, I can release v2.0.0 and we can upgrade the spkg.


---

Comment by mjo created at 2021-06-22 13:42:29

An important API changed in the new lcalc: https://gitlab.com/sagemath/lcalc/-/issues/8

I don't think the fix will be very complicated, but it does require changing stuff in `src/sage/libs/lcalc/`.


---

Comment by mjo created at 2021-06-23 03:22:15

The lcalc-2.0.0 upgrade ticket is at #32037 with some proof-of-concept patches that I hacked together. Not all of the doctest changes are simple fixes:  two of the answers have changed, and I don't know which is correct.

I would recommend pulling in one of the distro patches to fix the gcc-11 problem for sage-9.4, since upgrading lcalc may take some time.


---

Comment by mkoeppe created at 2021-06-30 21:07:31

Of course because of heavy patching, this patch does not apply
----
New commits:


---

Comment by mkoeppe created at 2021-06-30 21:08:52

Is there a branch in the lcalc repo on gitlab that corresponds to the patches that we have in `build/pkgs/lcalc/patches`?


---

Comment by fbissey created at 2021-06-30 21:11:42

Replying to [comment:17 mkoeppe]:
> Of course because of heavy patching, this patch does not apply
> ----
> New commits:
> ||[5023898](https://git.sagemath.org/sage.git/commit?id=50238984b0822c0c6a747e2a7908b7137af389c9)||`build/pkgs/lcalc/patches: Add https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/lcalc/files/lcalc-1.23-gcc11.patch`||

You missed the bit where it says this patch replaces another. Namely the `Lcommon.h.patch` in vanilla sage.


---

Comment by mkoeppe created at 2021-06-30 21:12:50

Thanks!


---

Comment by git created at 2021-06-30 21:14:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-30 21:14:52

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-06-30 23:17:19

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-06-30 23:17:19

that's just adding a bunch of `constexpr`, right?

I've upstreamed this in https://gitlab.com/sagemath/lcalc/-/issues/9

LGTM


---

Comment by fbissey created at 2021-06-30 23:18:42

Replying to [comment:23 dimpase]:
> that's just adding a bunch of `constexpr`, right?
> 

Yes.


---

Comment by mkoeppe created at 2021-07-01 00:10:52

Thanks.


---

Comment by vbraun created at 2021-07-06 21:29:42

Resolution: fixed
