# Issue 31600: lcalc: Fix for gcc 11

archive/issues_031600.json:
```json
{
    "body": "CC:  @tscrim @dimpase @kiwifb @orlitzky @isuruf @fchapoton @saraedum\n\nPrevious fixes in #30987\n\nIssue created by migration from https://trac.sagemath.org/ticket/31837\n\n",
    "created_at": "2021-05-18T18:03:06Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "lcalc: Fix for gcc 11",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31600",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @tscrim @dimpase @kiwifb @orlitzky @isuruf @fchapoton @saraedum

Previous fixes in #30987

Issue created by migration from https://trac.sagemath.org/ticket/31837





---

archive/issue_comments_450903.json:
```json
{
    "body": "For the record if I don't get around this. The sage-on-gentoo patch supercedes a previous patch that touches the same section.",
    "created_at": "2021-05-19T01:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450903",
    "user": "https://github.com/kiwifb"
}
```

For the record if I don't get around this. The sage-on-gentoo patch supercedes a previous patch that touches the same section.



---

archive/issue_comments_450904.json:
```json
{
    "body": "Is there an upstream repo?",
    "created_at": "2021-05-19T04:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450904",
    "user": "https://github.com/mkoeppe"
}
```

Is there an upstream repo?



---

archive/issue_comments_450905.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> Is there an upstream repo?\n\nFunny you would ask https://groups.google.com/g/sage-devel/c/0nZaREwFJpQ/m/lfFLjUrLBAAJ",
    "created_at": "2021-05-19T04:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450905",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:3 mkoeppe]:
> Is there an upstream repo?

Funny you would ask https://groups.google.com/g/sage-devel/c/0nZaREwFJpQ/m/lfFLjUrLBAAJ



---

archive/issue_comments_450906.json:
```json
{
    "body": "Does anyone know Michael Rubinstein? As an upstream project, lcalc looks dead to me. It would be nice if we could get his blessing to work on its successor in our gitlab repo. There are a mountain of patches waiting to be applied, and we could fix the build system and test suite. We could then package the fork in sage and the various distros.",
    "created_at": "2021-06-02T19:17:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450906",
    "user": "https://github.com/orlitzky"
}
```

Does anyone know Michael Rubinstein? As an upstream project, lcalc looks dead to me. It would be nice if we could get his blessing to work on its successor in our gitlab repo. There are a mountain of patches waiting to be applied, and we could fix the build system and test suite. We could then package the fork in sage and the various distros.



---

archive/issue_comments_450907.json:
```json
{
    "body": "Upstream does not appear to be active (I did have an email exchange), and we certainly may do as we please.\n\n(un)fortunately at some point Sage became de facto upstream for lcalc, and tracing the history of changes is not fun...",
    "created_at": "2021-06-03T12:53:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450907",
    "user": "https://github.com/dimpase"
}
```

Upstream does not appear to be active (I did have an email exchange), and we certainly may do as we please.

(un)fortunately at some point Sage became de facto upstream for lcalc, and tracing the history of changes is not fun...



---

archive/issue_comments_450908.json:
```json
{
    "body": "Does anyone know if sage actually needs lcalc to be built with MPFR support? The repo at https://gitlab.com/sagemath/lcalc is in increasingly good shape, but support for MPFR is still broken.\n\nThe previous build system allowed you to manually define one of two constants, `-DMPFR` or `-DMPFRCPP`, which chose one of two C++ interfaces to MPFR. Using `-DMPFR` would use the much older interface from https://math.berkeley.edu/~wilken/code/gmpfrxx/, while `-DMPFRCPP` would use the still-maintained http://www.holoborodko.com/pavel/mpfr/. (The necessary headers still live in the old `include` directory.)\n\nProblem is, when I define either constant, neither approach builds out-of-the box. The still-maintained interface would obviously be preferable, but there are horrendous C++ template errors either way. If sage doesn't actually need MPFR support in lcalc, I could choose the cowardly option to release lcalc-2.0.0 without MPFR support until someone cares enough to fix it. That would leave only the documentation and test suite to work on.",
    "created_at": "2021-06-06T14:14:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450908",
    "user": "https://github.com/orlitzky"
}
```

Does anyone know if sage actually needs lcalc to be built with MPFR support? The repo at https://gitlab.com/sagemath/lcalc is in increasingly good shape, but support for MPFR is still broken.

The previous build system allowed you to manually define one of two constants, `-DMPFR` or `-DMPFRCPP`, which chose one of two C++ interfaces to MPFR. Using `-DMPFR` would use the much older interface from https://math.berkeley.edu/~wilken/code/gmpfrxx/, while `-DMPFRCPP` would use the still-maintained http://www.holoborodko.com/pavel/mpfr/. (The necessary headers still live in the old `include` directory.)

Problem is, when I define either constant, neither approach builds out-of-the box. The still-maintained interface would obviously be preferable, but there are horrendous C++ template errors either way. If sage doesn't actually need MPFR support in lcalc, I could choose the cowardly option to release lcalc-2.0.0 without MPFR support until someone cares enough to fix it. That would leave only the documentation and test suite to work on.



---

archive/issue_comments_450909.json:
```json
{
    "body": "Sage does not build lcalc with MPFR support, so this is not a requirement for us.",
    "created_at": "2021-06-07T09:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450909",
    "user": "https://github.com/dimpase"
}
```

Sage does not build lcalc with MPFR support, so this is not a requirement for us.



---

archive/issue_comments_450910.json:
```json
{
    "body": "Ok, good. I was just looking at the \"mpfr\" in its `dependencies` file.\n\nI may actually be able to get MPFR support working soon. I made it compile by adding a bunch of typecasts and by replacing the C++ built-in `complex` class with the one from lcalc's `Lcomplex.h` within `mpreal.h`. None of the output looks too crazy but I'm not exactly confident about it.",
    "created_at": "2021-06-07T14:27:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450910",
    "user": "https://github.com/orlitzky"
}
```

Ok, good. I was just looking at the "mpfr" in its `dependencies` file.

I may actually be able to get MPFR support working soon. I made it compile by adding a bunch of typecasts and by replacing the C++ built-in `complex` class with the one from lcalc's `Lcomplex.h` within `mpreal.h`. None of the output looks too crazy but I'm not exactly confident about it.



---

archive/issue_comments_450911.json:
```json
{
    "body": "I checked that lcalc on a couple of systems is not linked with libmpfr.",
    "created_at": "2021-06-07T14:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450911",
    "user": "https://github.com/dimpase"
}
```

I checked that lcalc on a couple of systems is not linked with libmpfr.



---

archive/issue_comments_450912.json:
```json
{
    "body": "How's this coming along?",
    "created_at": "2021-06-20T15:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450912",
    "user": "https://github.com/mkoeppe"
}
```

How's this coming along?



---

archive/issue_comments_450913.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> How's this coming along?\n\nIt's done AFAIK. The only thing left to do is run `make dist` in the lcalc repo, install it to the system, and see if it works with sage. Hopefully not too many changes are needed. The header location is now \"officially\" installed to `lcalc/L.h` but that's the only breaking change that I know of for sure.\n\nIf everything works, I can release v2.0.0 and we can upgrade the spkg.",
    "created_at": "2021-06-21T13:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450913",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:12 mkoeppe]:
> How's this coming along?

It's done AFAIK. The only thing left to do is run `make dist` in the lcalc repo, install it to the system, and see if it works with sage. Hopefully not too many changes are needed. The header location is now "officially" installed to `lcalc/L.h` but that's the only breaking change that I know of for sure.

If everything works, I can release v2.0.0 and we can upgrade the spkg.



---

archive/issue_comments_450914.json:
```json
{
    "body": "An important API changed in the new lcalc: https://gitlab.com/sagemath/lcalc/-/issues/8\n\nI don't think the fix will be very complicated, but it does require changing stuff in `src/sage/libs/lcalc/`.",
    "created_at": "2021-06-22T13:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450914",
    "user": "https://github.com/orlitzky"
}
```

An important API changed in the new lcalc: https://gitlab.com/sagemath/lcalc/-/issues/8

I don't think the fix will be very complicated, but it does require changing stuff in `src/sage/libs/lcalc/`.



---

archive/issue_comments_450915.json:
```json
{
    "body": "The lcalc-2.0.0 upgrade ticket is at #32037 with some proof-of-concept patches that I hacked together. Not all of the doctest changes are simple fixes:  two of the answers have changed, and I don't know which is correct.\n\nI would recommend pulling in one of the distro patches to fix the gcc-11 problem for sage-9.4, since upgrading lcalc may take some time.",
    "created_at": "2021-06-23T03:22:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450915",
    "user": "https://github.com/orlitzky"
}
```

The lcalc-2.0.0 upgrade ticket is at #32037 with some proof-of-concept patches that I hacked together. Not all of the doctest changes are simple fixes:  two of the answers have changed, and I don't know which is correct.

I would recommend pulling in one of the distro patches to fix the gcc-11 problem for sage-9.4, since upgrading lcalc may take some time.



---

archive/issue_comments_450916.json:
```json
{
    "body": "Of course because of heavy patching, this patch does not apply\n----\nNew commits:",
    "created_at": "2021-06-30T21:07:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450916",
    "user": "https://github.com/mkoeppe"
}
```

Of course because of heavy patching, this patch does not apply
----
New commits:



---

archive/issue_comments_450917.json:
```json
{
    "body": "Is there a branch in the lcalc repo on gitlab that corresponds to the patches that we have in `build/pkgs/lcalc/patches`?",
    "created_at": "2021-06-30T21:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450917",
    "user": "https://github.com/mkoeppe"
}
```

Is there a branch in the lcalc repo on gitlab that corresponds to the patches that we have in `build/pkgs/lcalc/patches`?



---

archive/issue_comments_450918.json:
```json
{
    "body": "Replying to [comment:17 mkoeppe]:\n> Of course because of heavy patching, this patch does not apply\n> ----\n> New commits:\n> ||[5023898](https://git.sagemath.org/sage.git/commit?id=50238984b0822c0c6a747e2a7908b7137af389c9)||`build/pkgs/lcalc/patches: Add https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/lcalc/files/lcalc-1.23-gcc11.patch`||\n\nYou missed the bit where it says this patch replaces another. Namely the `Lcommon.h.patch` in vanilla sage.",
    "created_at": "2021-06-30T21:11:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450918",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:17 mkoeppe]:
> Of course because of heavy patching, this patch does not apply
> ----
> New commits:
> ||[5023898](https://git.sagemath.org/sage.git/commit?id=50238984b0822c0c6a747e2a7908b7137af389c9)||`build/pkgs/lcalc/patches: Add https://github.com/cschwan/sage-on-gentoo/blob/master/sci-mathematics/lcalc/files/lcalc-1.23-gcc11.patch`||

You missed the bit where it says this patch replaces another. Namely the `Lcommon.h.patch` in vanilla sage.



---

archive/issue_comments_450919.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-06-30T21:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450919",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_comments_450920.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-30T21:14:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450920",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_450921.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-30T21:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450921",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_450922.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-30T23:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450922",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_450923.json:
```json
{
    "body": "that's just adding a bunch of `constexpr`, right?\n\nI've upstreamed this in https://gitlab.com/sagemath/lcalc/-/issues/9\n\nLGTM",
    "created_at": "2021-06-30T23:17:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450923",
    "user": "https://github.com/dimpase"
}
```

that's just adding a bunch of `constexpr`, right?

I've upstreamed this in https://gitlab.com/sagemath/lcalc/-/issues/9

LGTM



---

archive/issue_comments_450924.json:
```json
{
    "body": "Replying to [comment:23 dimpase]:\n> that's just adding a bunch of `constexpr`, right?\n> \n\nYes.",
    "created_at": "2021-06-30T23:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450924",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:23 dimpase]:
> that's just adding a bunch of `constexpr`, right?
> 

Yes.



---

archive/issue_comments_450925.json:
```json
{
    "body": "Thanks.",
    "created_at": "2021-07-01T00:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450925",
    "user": "https://github.com/mkoeppe"
}
```

Thanks.



---

archive/issue_comments_450926.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-07-06T21:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31600#issuecomment-450926",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_084085.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-07-06T21:29:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31600",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31600#event-84085"
}
```
