# Issue 16323: Upgrade lrcalc to 1.1.7

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2014-06-27 00:47:59

Assignee: sage-combinat

CC:  sage-combinat nthiery

Keywords: lrcalc

Using the upstream based off of here: http://www.math.rutgers.edu/~asbuch/lrcalc/

This should (help) fix #14625.


---

Attachment


---

Comment by tscrim created at 2014-06-27 00:50:45

Changing status from new to needs_review.


---

Comment by tscrim created at 2014-06-27 00:50:45

Running tests now...


---

Comment by tscrim created at 2014-06-27 01:17:19

All (long) tests pass for me.


---

Comment by git created at 2014-06-27 01:17:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2014-06-27 02:35:11

So the only difference between the two upstream tarballs is that one of them is properly autool=ed and the other is not?


---

Comment by fbissey created at 2014-06-27 02:37:56

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2014-06-27 02:37:56

This version has otherwise been in use in sage-on-gentoo since December without any reported issue so I am putting that positive review.


---

Comment by tscrim created at 2014-06-27 03:21:06

Replying to [comment:4 fbissey]:
> So the only difference between the two upstream tarballs is that one of them is properly autool=ed and the other is not?

Nicolas would be the best one to answer that since he helped create it.

Thanks for doing the review.


---

Comment by nthiery created at 2014-06-27 23:56:47

Replying to [comment:6 tscrim]:
> Replying to [comment:4 fbissey]:
> > So the only difference between the two upstream tarballs is that one of them is properly autool=ed and the other is not?
> 
> Nicolas would be the best one to answer that since he helped create it.

As far as I remember, yes. And this one is an official release by Anders rather than a tarball produced by myself.


---

Comment by vbraun created at 2014-06-28 12:47:46

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-06-28 12:47:46

Fails on OSX

```
libtool: link: gcc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/liblrcalc.1.dylib   -Wl,-force_load,mathlib/.libs/libmath.a -Wl,-force_load,lrcoef/.libs/libsymfcn.a -Wl,-force_load,schubert/.libs/libschub.a   -O2   -install_name  /Users/buildslave-sage/slave/sage_git/build/local/lib/liblrcalc.1.dylib -compatibility_version 2 -current_version 2.0 -Wl,-single_module
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    mathlib/.libs/libmath.a(hashtab.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    mathlib/.libs/libmath.a(list.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    mathlib/.libs/libmath.a(set.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    mathlib/.libs/libmath.a(vectarg.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    mathlib/.libs/libmath.a(vector.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    lrcoef/.libs/libsymfcn.a(symfcn.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    lrcoef/.libs/libsymfcn.a(maple.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    schubert/.libs/libschub.a(schublib.o)
duplicate symbol _lrcalc_panic_frame in:
    mathlib/.libs/libmath.a(alloc.o)
    schubert/.libs/libschub.a(lincomb.o)
ld: 9 duplicate symbols for architecture x86_64
collect2: error: ld returned 1 exit status
make[5]: *** [liblrcalc.la] Error 1
make[5]: Target `all-am' not remade because of errors.
make[4]: *** [all-recursive] Error 1
make[3]: *** [all] Error 2
Error building lrcalc.
```

Full log: http://build.sagemath.org/sage/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.9%20x86_64%29%20incremental/builds/279/steps/compile/logs/stdio


---

Comment by fbissey created at 2014-06-28 20:53:32

Hum.... it seems it cannot cop with lrcalc_panic_frame being defined in mathlib/alloc.h

```
#include <setjmp.h>

/*  Programs using the lrcalc library should set lrcalc_panic_frame
 *  with setjmp(lrcalc_panic_frame).  The lrcalc library will call
 *  longjmp(lrcalc_panic_frame, 1) if an "out of memory" event occurs.
 */
jmp_buf lrcalc_panic_frame;
```

All the files for which the linker is complaining about are inheriting the declaration through multiple include statement but are not using it. I guess the proper course of action, from a correctness point of view, would be to create a specific header for it and include it only where needed. Looking for other options....


---

Comment by fbissey created at 2014-06-28 21:15:43

`@` nthiery: in configure.ac, oops:

```
AC_PREREQ([2.67])
AC_INIT([lrcalc],[1.1.6],[asbuch at math rutgers edu])
```

Not hurtful of course.


---

Attachment

solve the lrcalc_panic_frame definition problem


---

Comment by fbissey created at 2014-06-28 22:49:02

OK the attached patch solve the problem on OS X, it should work on linux too but I haven't tested it there so far. It is a bit invasive and should be submitted upstream for consideration.


---

Comment by tscrim created at 2014-06-29 00:53:54

I will test it on my Ubuntu machine later tonight (if no one beats me to it).


---

Comment by fbissey created at 2014-06-29 01:16:10

Well I have now checked it builds and installs in sage-on-gentoo on linux and OS X but haven't run tests.


---

Comment by git created at 2014-06-29 13:06:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-06-29 13:08:20

Git-a-fied and the spkg and sage checks passed for me.


---

Comment by tscrim created at 2014-06-29 13:08:20

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2014-06-29 13:09:19

Thanks for figuring out the OSX FranÃ§ois (I couldn't do anything since I don't have access to one).


---

Comment by fbissey created at 2014-06-30 10:30:09

Well it is all a bit sloppy in my opinion. You have this variable that I put in separate header that needs to be global in the programs using it. Problems is it was put everywhere including the library parts. The gnu linker used in linux is infintely tolerant to some stuff and possibly has a way of dealing with it. But in this case I think the OS X linker is correct in saying "please fix this up". 

I also sent an email upstream along with the patch.


---

Comment by tscrim created at 2014-06-30 13:49:18

So do you think we should hold off on merging this until we hear back?


---

Comment by vbraun created at 2014-06-30 16:33:53

Resolution: fixed


---

Comment by fbissey created at 2014-06-30 19:26:02

Replying to [comment:18 tscrim]:
> So do you think we should hold off on merging this until we hear back?

Double dose of no. One for me and one for Volker :)
