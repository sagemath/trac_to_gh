# Issue 11388: update sympy to 0.7.0

Issue created by migration from Trac.

Original creator: fbissey

Original creation time: 2011-07-01 01:13:22

Assignee: tbd

CC:  asmeurer certik wdj

Sympy-0.7.0 has been released on the 28th of June 2011. It is interacting much better with sage than previous release. Term ordering has changed compared to previous release. Only one patch (of which upstream sympy is already aware) is needed to make sympy work nicely with sage.
See [https://groups.google.com/forum/#!topic/sympy/XgoLZcIaa3U](https://groups.google.com/forum/#!topic/sympy/XgoLZcIaa3U) for discussion about the release and the fix needed for sage.


---

Comment by fbissey created at 2011-07-01 01:52:49

patch to sympy


---

Attachment


---

Attachment

Remove deprecated each_char option for converting sympy expression


---

Comment by fbissey created at 2011-07-01 02:17:14

Attached two patches for sage. A new spkg should follow in the near future.


---

Comment by fbissey created at 2011-07-01 02:21:04

Forwarding Ondřej Čertík since he is the official maintainer for this spkg.


---

Comment by fbissey created at 2011-07-01 02:26:28

The spkg itself will need revamping since the mercurial instructions to update it are now obsolete. Do you want to take care of it Ondřej, or should I just go ahead?


---

Comment by asmeurer created at 2011-07-01 02:34:48

Ondřej will be away for a couple of weeks (he's getting married), so you should do it.

What instructions, by the way?


---

Comment by fbissey created at 2011-07-01 02:44:18

the README has the following text

```
How to create a SymPy spkg package:

$ ./get-orig-sources

Then rename the sympy-spkg directory to sympy-0.5.13 (choose the correct
version) and execute from the parent directory:

$ sage -pkg sympy-0.5.13
```

which calls
{{{#! /bin/sh
#execute this script from the same directory, where spkg-install is.
#it will remove the src dir (!) and create a new one instead
ver=0.6.4
wget http://sympy.googlecode.com/files/sympy-$ver.tar.gz
tar xzf sympy-$ver.tar.gz
rm -rf src sympy-$ver.tar.gz
mv sympy-$ver src
```

which I guess would still work once "ver" is put to the right value. But there is an old stale file (which the first one I saw) which pulls on hg
{{{#! /bin/sh
# execute this script from the same directory, where spkg-install is.
# it will remove the src dir (!) and create a new one instead from the
# Mercurial sources of SymPy, located in ~/sympy
ver=0.5.15-hg
dir=`pwd`
cd ~/sympy
./setup.py sdist
cp dist/sympy-$ver.tar.gz $dir
cd $dir
tar xzf sympy-$ver.tar.gz
rm -rf src sympy-$ver.tar.gz
mv sympy-$ver src
```

This one will have to go.


---

Comment by asmeurer created at 2011-07-01 03:06:51

Where did you find that?  I don't see it anywhere in the source.

The only guide I know of is http://code.google.com/p/sympy/wiki/SymPyspkg, which I already know is out of date.


---

Comment by fbissey created at 2011-07-01 03:21:25

It is not in sympy's source. Sage uses special packages called spkg with sources, patches and build instructions. When you update a spkg you start with the old one.

The current spkg for sympy in sage is here:
[http://sage.math.washington.edu/home/release/sage-4.7/sage-4.7/spkg/standard/sympy-0.6.4.p0.spkg](http://sage.math.washington.edu/home/release/sage-4.7/sage-4.7/spkg/standard/sympy-0.6.4.p0.spkg) in spite of the .spkg ending it is just a tar.bz2 file and "tar xvfj" will work just fine on it. The source are usually in a src subfolder and the top folder is build/install instructions + documentation. I am almost done with it. I just have to update one of my patches for something I missed:

```
sage -t -long -force_lib "devel/sage-main/sage/symbolic/expression_conversions.py"
**********************************************************************
File "/home/work/fbissey/sandbox/sage-4.7.1.alpha2/devel/sage-main/sage/symbolic/expression_conversions.py", line 559:
    sage: f._sympy_()
Expected:
    exp(x**2) - asin(pi + x)/y
Got:
    exp(x**2) - asin(x + pi)/y
```

I didn't notice the re-ordering in asin...


---

Comment by asmeurer created at 2011-07-01 03:25:17

Ah, thanks. I didn't know about that.  I added a note about it to our release guide.


---

Comment by fbissey created at 2011-07-01 03:29:39

fix doctest for the new ordering


---

Comment by fbissey created at 2011-07-01 03:34:01

Changing status from new to needs_review.


---

Attachment


---

Comment by wdj created at 2011-08-18 13:26:17

I posted a sympy spkg to
http://boxen.math.washington.edu/home/wdj/patches/sympy-0.7.1.p0.spkg


---

Comment by fbissey created at 2011-09-15 23:50:54

Sorry David but I decided to roll a new one of my own rather than giving you the thumb up. There are are a number of things:
 * .p0 is not necessary in this case.
 * None of the change I had made in 0.7.0 were in yours, that included a bit of cleaning of the scripts included.
 * I made the deleting work for for any python2 install rather than just 2.6, so once we get #9958 in, the spkg doesn't have to be updated.
 * I wanted to align what's done in sympy with what leif has done with sphinx in #11665, only delete the old sympy when the build is successful.

At install there is a message about two syntax error in the included mpmath. I didn't take action on these as they are also in the logs of mpmath-0.17 and only concern the tests shipped with mpmath and no functionality is affected.

One step further would be to mirror the work I have done in Gentoo and remove the shipped mpmath to use the version already installed in sage. Of course that means we would have to be careful and then upgrade them in sync.


---

Comment by asmeurer created at 2011-09-16 17:24:10

The mpmath errors are actually for Python 3 compatibility, not tests.  Those files have syntax that is invalid in Python 2, but will never be run there.  I think you can just delete them if you don't care about Python 3 and don't like the errors.  I think Fredrik is going to fix these for the next version of mpmath (see http://code.google.com/p/mpmath/issues/detail?id=204 and http://code.google.com/p/mpmath/issues/detail?id=209).


---

Comment by fbissey created at 2011-09-16 20:08:22

Thanks for piping in Aaron, I actually knew that! I am not that concerned but a reviewer could be. Thank you for adding this fact as it prove that these messages have no consequences.


---

Comment by wdj created at 2011-09-18 13:16:54

Changing status from needs_review to needs_work.


---

Comment by wdj created at 2011-09-18 13:16:54

Replying to [comment:13 fbissey]:
> Sorry David but I decided to roll a new one of my own rather than giving you the thumb up. 


That's fine. Please post a link to your spkg when you finish it.

Changing this to needs work, for now.

...

> One step further would be to mirror the work I have done in Gentoo and remove the shipped mpmath to use the version already installed in sage. Of course that means we would have to be careful and then upgrade them in sync.


---

Comment by fbissey created at 2011-09-18 21:30:25

Replying to [comment:16 wdj]:
> Replying to [comment:13 fbissey]:
> > Sorry David but I decided to roll a new one of my own rather than giving you the thumb up. 
> 
> 
> That's fine. Please post a link to your spkg when you finish it.
> 

There is a link to a spkg in the description. Has been since my comment about David's spkg... 

Thanks for volunteering for a review.


---

Comment by fbissey created at 2011-09-18 21:30:25

Changing status from needs_work to needs_review.


---

Comment by wdj created at 2011-10-01 08:11:12

Changing status from needs_review to needs_work.


---

Comment by wdj created at 2011-10-01 08:11:12

Replying to [comment:17 fbissey]:
> Replying to [comment:16 wdj]:

...

> 
> There is a link to a spkg in the description. Has been since my comment about David's spkg... 
> 
> Thanks for volunteering for a review.


I tested this on sage 4.7.2.a3 and came up with the following failures:

```
The following tests failed:


        sage -t  -force_lib "devel/sage/sage/calculus/test_sympy.py"
        sage -t  -force_lib "devel/sage/sage/functions/trig.py"
        sage -t  -force_lib "devel/sage/sage/misc/functional.py"
        sage -t  -force_lib "devel/sage/sage/symbolic/expression_conversions.py"
        sage -t  -force_lib "devel/sage/sage/symbolic/integration/external.py"
        sage -t  -force_lib "devel/sage/sage/symbolic/integration/integral.py"
```

For example,


```
she:sage-4.7.2.alpha3 davidjoyner$ ./sage -t  -force_lib "devel/sage/sage/calculus/test_sympy.py"
sage -t -force_lib "devel/sage/sage/calculus/test_sympy.py" 
**********************************************************************
File "/Volumes/Bay4/sagefiles2/sage-4.7.2.alpha3/devel/sage/sage/calculus/test_sympy.py", line 139:
    sage: sympy.sympify(var("y"))+sympy.Symbol("x")
Expected:
    x + y
Got:
    doctest:289: DeprecationWarning: The each_char option to symbols() and var() is deprecated.  Separate symbol names by spaces or commas instead.
    x + y
**********************************************************************
File "/Volumes/Bay4/sagefiles2/sage-4.7.2.alpha3/devel/sage/sage/calculus/test_sympy.py", line 154:
    sage: e
Expected:
    cos(x) + sin(y)
Got:
    sin(y) + cos(x)
**********************************************************************
```



---

Comment by fbissey created at 2011-10-01 21:33:17

Replying to [comment:18 wdj]:
> Replying to [comment:17 fbissey]:
> > Replying to [comment:16 wdj]:
> 
> ...
> 
> > 
> > There is a link to a spkg in the description. Has been since my comment about David's spkg... 
> > 
> > Thanks for volunteering for a review.
> 
> 
> I tested this on sage 4.7.2.a3 and came up with the following failures:
> {{{
> The following tests failed:
> 
> 
>         sage -t  -force_lib "devel/sage/sage/calculus/test_sympy.py"
>         sage -t  -force_lib "devel/sage/sage/functions/trig.py"
>         sage -t  -force_lib "devel/sage/sage/misc/functional.py"
>         sage -t  -force_lib "devel/sage/sage/symbolic/expression_conversions.py"
>         sage -t  -force_lib "devel/sage/sage/symbolic/integration/external.py"
>         sage -t  -force_lib "devel/sage/sage/symbolic/integration/integral.py"
> }}}
> For example,
> 
> {{{
> she:sage-4.7.2.alpha3 davidjoyner$ ./sage -t  -force_lib "devel/sage/sage/calculus/test_sympy.py"
> sage -t -force_lib "devel/sage/sage/calculus/test_sympy.py" 
> **********************************************************************
> File "/Volumes/Bay4/sagefiles2/sage-4.7.2.alpha3/devel/sage/sage/calculus/test_sympy.py", line 139:
>     sage: sympy.sympify(var("y"))+sympy.Symbol("x")
> Expected:
>     x + y
> Got:
>     doctest:289: DeprecationWarning: The each_char option to symbols() and var() is deprecated.  Separate symbol names by spaces or commas instead.
>     x + y
> **********************************************************************
> File "/Volumes/Bay4/sagefiles2/sage-4.7.2.alpha3/devel/sage/sage/calculus/test_sympy.py", line 154:
>     sage: e
> Expected:
>     cos(x) + sin(y)
> Got:
>     sin(y) + cos(x)
> **********************************************************************
> }}}
> 
Hi David,

(now I have noticed that wdj is your handle). Did you apply the two patches that the description says you have to apply?

Francois


---

Comment by wdj created at 2011-10-02 14:59:16

Replying to [comment:19 fbissey]:

...

> Hi David,
> 
> (now I have noticed that wdj is your handle). Did you apply the two 
> patches that the description says you have to apply?


I forgot to, sorry. Changing back to needs review (which I will do now).

> 
> Francois


---

Comment by wdj created at 2011-10-02 14:59:16

Changing status from needs_work to needs_review.


---

Comment by wdj created at 2011-10-02 15:05:26

Changing status from needs_review to positive_review.


---

Comment by wdj created at 2011-10-02 15:05:26

Applies fine to 4.7.2.a3 and passes all tests, once the two patches are applied. The patches fix some sage functions which use sympy, resulting form changes in sympy.

sympy 0.7.1 is much better than the old version which is currently in sage. Thanks for creating this spkg and patches Francois !


---

Comment by jdemeyer created at 2011-10-12 07:35:04

Resolution: fixed


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by leif created at 2013-05-23 19:31:32

Someone is asking on sage-release (Sage 5.10.beta4 thread) whether we're planning to upgrade to SymPy 0.7.2.  There doesn't seem to be a ticket for doing so yet, but maybe I just didn't find it...


---

Comment by fbissey created at 2013-05-23 21:02:49

I don't think there is. sage-on-gentoo is on 0.7.2 that breaks two doctests. One would need attention the other is pretty printing.


---

Comment by eviatarbach created at 2013-06-06 01:06:05

This is now #14694.
