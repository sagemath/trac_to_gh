# Issue 23830: Call sympy_init() at sympy import

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2017-10-19 13:22:16

CC:  jdemeyer isuruf infinity0 egourgoulhon

sympy_init() enables conversion of SymPy objects. It is called with every initialization of a `SympyConverter`, i.e. with `Expression._sympy_()`. Better is to only call it once with any `import sympy`.


---

Comment by rws created at 2017-10-19 14:19:17

Last 10 new commits:


---

Comment by rws created at 2017-10-19 14:19:17

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2017-11-19 15:52:24

Rebased to 8.1.rc2 for easier reviewing.
----
New commits:


---

Comment by git created at 2017-11-19 16:25:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2017-11-19 17:22:08

Positive review to your first commit. I added two follow-up commits, please review.


---

Comment by fbissey created at 2017-11-19 18:56:57

I am concerned that the sympy patch cannot be sent upstream as is. It makes sage a dependency of sympy for it to even start. I doubt that's acceptable.


---

Comment by tscrim created at 2017-11-19 21:25:17

What about just adding `sympy_init()` to the end of the interface file?


---

Comment by fbissey created at 2017-11-19 21:27:12

Replying to [comment:8 tscrim]:
> What about just adding `sympy_init()` to the end of the interface file?

I would favor an all in sage solution to this. I am not against a push in sympy upstream but it has to be acceptable to them and that will certainly not be.


---

Comment by rws created at 2017-11-20 07:47:06

Replying to [comment:7 fbissey]:
> I am concerned that the sympy patch cannot be sent upstream as is. It makes sage a dependency of sympy for it to even start. I doubt that's acceptable.

To make it work the `__init__` file needs to know if it is imported from sage. I'm no Python expert but I doubt that's possible. A solution to the design problem would be not to have `_sage_` member functions but a global `sage(...)` method.

Additions LGTM.


---

Comment by rws created at 2017-11-20 07:47:06

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-11-20 08:08:45

What about guarding it with a `try: expect:` block so it can start gracefully if sage is not present (and therefore not used).


---

Comment by jdemeyer created at 2017-11-20 08:40:31

fbissey: I am assuming that this ticket would only be merged in some 8.2.beta of Sage. Since this branch here does solve the immediate problem of docbuilding, I suggest to merge this patch as-is and in the mean time work on a solution for upstream.


---

Comment by fbissey created at 2017-11-20 08:54:42

Replying to [comment:12 jdemeyer]:
> fbissey: I am assuming that this ticket would only be merged in some 8.2.beta of Sage. Since this branch here does solve the immediate problem of docbuilding, I suggest to merge this patch as-is and in the mean time work on a solution for upstream.

I was hoping a more conciliatory attitude and hadn't removed the positive review. This is now back to need_work. This is just un-acceptable to sage-on-distro this close to release. 

We would have to make our own version of the patch that does the "right thing" (TM) instead of a "sloppy job" (TM) just because we can and feel in too much of a hurry for 3 more lines of code, anyway so let's do it right now instead.


---

Comment by fbissey created at 2017-11-20 09:24:58

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2017-11-20 09:24:58

New commits:


---

Comment by fbissey created at 2017-11-20 09:25:09

Changing status from needs_work to needs_review.


---

Comment by infinity0 created at 2017-11-20 09:31:35

`@`fbissey, that last commit, while much better than what was before, will still force all users of sympy to import sage into their python program, as long as sage is installed.

A better method might be something like this instead:


```
if 'sage.XXXX' in sys.modules:
    from sage.interfaces.sympy import sympy_init
    sympy_init()
```


where XXXX is some module that sage always imports. So the patch is only activated if sage is already imported.

This might be more acceptable to upstream as well.


---

Comment by fbissey created at 2017-11-20 09:36:09

`@`infinity0 I agree that is not perfect - for exactly the reason you mention - but that's the best I could come up with without more complication. Feel free to improve it, that's one of the reason I called other packagers on this ticket.


---

Comment by infinity0 created at 2017-11-20 09:41:49

So what about using `if ... in sys.modules`?

If you additionally need to support the use-case where a third-party program/library really has to import sympy _then later_ import sage (I can't imagine why), then the `if ... in sys.modules` logic needs to also be added to a sage module but in reverse - i.e. check if sympy is already imported, and activate the patch if so.

In any case, we're unlikely to patch sympy in Debian like this, unless they indicate that they would already accept it. (Someone else maintains it, the situation is outside of my control.) Could you/someone else file a upstream ticket *before* releasing this in Sage?


---

Comment by fbissey created at 2017-11-20 09:51:30

Replying to [comment:18 infinity0]:
> So what about using `if ... in sys.modules`?
> 

I can make that change, but I am calling it a night :)

> If you additionally need to support the use-case where a third-party program/library really has to import sympy _then later_ import sage (I can't imagine why), then the `if ... in sys.modules` logic needs to also be added to a sage module but in reverse - i.e. check if sympy is already imported, and activate the patch if so.
> 
> In any case, we're unlikely to patch sympy in Debian like this, unless they indicate that they would already accept it. (Someone else maintains it, the situation is outside of my control.) Could you/someone else file a upstream ticket *before* releasing this in Sage?

+1, `@`rws do you have an upstream issue for this? There definitely should be.


---

Comment by rws created at 2017-11-20 10:02:01

Replying to [comment:19 fbissey]:
> +1, `@`rws do you have an upstream issue for this? There definitely should be.

I'll open one if this ticket has code that all agree on. Set at least `needs review` so we have the patchbots.


---

Comment by jdemeyer created at 2017-11-20 10:57:46

Replying to [comment:13 fbissey]:
> This is just un-acceptable to sage-on-distro

Even for a beta version of Sage? I agree that it would be unacceptable in a released version.


---

Comment by jdemeyer created at 2017-11-20 11:00:40

If we're going to submit a patch upstream, we shouldn't rush.


---

Comment by jdemeyer created at 2017-11-20 11:00:40

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2017-11-20 19:51:53

Replying to [comment:21 jdemeyer]:
> Replying to [comment:13 fbissey]:
> > This is just un-acceptable to sage-on-distro
> 
> Even for a beta version of Sage? I agree that it would be unacceptable in a released version.

Come on. We are at rc2. We are just ironing bugs, that would end up in the released 8.1 unless you moved the milestone to 8.2.


---

Comment by tscrim created at 2017-11-20 23:22:15

I would be surprised if this was positively reviewed it would make it into 8.1 (unless we set it as a blocker).


---

Comment by fbissey created at 2017-11-20 23:26:49

Because of the troubles building the documentation reported on sage-release, one of #24238 or this ticket has to be a blocker in my opinion. I came to this ticket after Jeroen commented on #24238 that this ticket should be the one with the fix.


---

Comment by rws created at 2017-11-21 04:12:27

The third option would be a revert ticket for the manifolds changes that introduced it.


---

Comment by jdemeyer created at 2017-11-21 08:28:03

Replying to [comment:26 fbissey]:
> Because of the troubles building the documentation reported on sage-release, one of #24238 or this ticket has to be a blocker in my opinion. I came to this ticket after Jeroen commented on #24238 that this ticket should be the one with the fix.

#24238 is a blocker. That ticket is also simple enough that it shouldn't cause problems.


---

Comment by jdemeyer created at 2017-11-21 08:30:52

Replying to [comment:24 fbissey]:
> We are just ironing bugs, that would end up in the released 8.1 unless you moved the milestone to 8.2.

No. I'm pretty sure that the release manager only merges "blocker" tickets once an rc has been released. The whole point of an "rc" is that it should be close to a release and you don't want to merge random tickets at that point.

Anyway, that doesn't matter anymore for this ticket.


---

Comment by mkoeppe created at 2021-07-06 02:46:24

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-07-06 02:46:24

Time to close this bizarre ticket


---

Comment by fbissey created at 2021-07-06 04:02:37

I am not remembering much about it but obviously it didn't make the cut then.


---

Comment by fbissey created at 2021-07-06 04:02:37

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-08-26 02:08:43

Resolution: invalid
