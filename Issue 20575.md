# Issue 20575: derivative of integer wrt to variable in polynomial ring should belong to that ring, not symbolic ring

archive/issues_020575.json:
```json
{
    "body": "CC:  @orlitzky\n\nIf I try to take the derivative of an integer (or nonzero rational, or integer mod n), then the result is an element of the symbolic ring:\n\n```\nsage: R.<x>=ZZ[]\nsage: derivative(0,x).parent()\nSymbolic Ring\n```\n\nIt seems like it would be more natural for the returned value to belong to the ring containing x instead.\n\nThis may seem kind of pedantic, but it did trip me up when I was working with a list of polynomials, some of which were constant, and things were getting cast to Expression unexpectedly.\n\nI am not particularly familiar with the Sage codebase, but I am attaching a patch that seems to fix the issue.\n\nIssue created by migration from https://trac.sagemath.org/ticket/20812\n\n",
    "created_at": "2016-06-12T02:51:40Z",
    "labels": [
        "component: calculus"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "derivative of integer wrt to variable in polynomial ring should belong to that ring, not symbolic ring",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20575",
    "user": "https://trac.sagemath.org/admin/accounts/users/dgulotta"
}
```
CC:  @orlitzky

If I try to take the derivative of an integer (or nonzero rational, or integer mod n), then the result is an element of the symbolic ring:

```
sage: R.<x>=ZZ[]
sage: derivative(0,x).parent()
Symbolic Ring
```

It seems like it would be more natural for the returned value to belong to the ring containing x instead.

This may seem kind of pedantic, but it did trip me up when I was working with a list of polynomials, some of which were constant, and things were getting cast to Expression unexpectedly.

I am not particularly familiar with the Sage codebase, but I am attaching a patch that seems to fix the issue.

Issue created by migration from https://trac.sagemath.org/ticket/20812





---

archive/issue_comments_283795.json:
```json
{
    "body": "Attachment [functional.py.patch](tarball://root/attachments/some-uuid/ticket20812/functional.py.patch) by @fchapoton created at 2017-03-02 17:11:11\n\nIf you take care to use the correct zero, this just works:\n\n```\nsage: R.zero().derivative(x).parent()\nUnivariate Polynomial Ring in x over Integer Ring\n```\n\nBut there is room for improvement, for sure.",
    "created_at": "2017-03-02T17:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283795",
    "user": "https://github.com/fchapoton"
}
```

Attachment [functional.py.patch](tarball://root/attachments/some-uuid/ticket20812/functional.py.patch) by @fchapoton created at 2017-03-02 17:11:11

If you take care to use the correct zero, this just works:

```
sage: R.zero().derivative(x).parent()
Univariate Polynomial Ring in x over Integer Ring
```

But there is room for improvement, for sure.



---

archive/issue_comments_283796.json:
```json
{
    "body": "The derivative of a symbolic expression is a symbolic expression :\n\n```\nsage: R1.<t>=ZZ[]\nsage: derivative(x^2+x+1,t).parent()\nSymbolic Ring\n```\n\n\n\nTherefore this :\n\n```\nsage: derivative(0,t).parent()\nSymbolic Ring\n```\n\n\nis a special case, indicating that 0 is cast to a symbolic expression (probably by `diff`...).\n\nHowever :\n\n```\nsage: derivative(R1(0),t).parent()\nUnivariate Polynomial Ring in t over Integer Ring\n```\n\n\nconforms to the requirement that the derivative of an object belongs its parent ring.\n\nPedantism works both ways...\n\n==> marking as invalid and requesting review in order to close.",
    "created_at": "2021-03-13T13:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283796",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

The derivative of a symbolic expression is a symbolic expression :

```
sage: R1.<t>=ZZ[]
sage: derivative(x^2+x+1,t).parent()
Symbolic Ring
```



Therefore this :

```
sage: derivative(0,t).parent()
Symbolic Ring
```


is a special case, indicating that 0 is cast to a symbolic expression (probably by `diff`...).

However :

```
sage: derivative(R1(0),t).parent()
Univariate Polynomial Ring in t over Integer Ring
```


conforms to the requirement that the derivative of an object belongs its parent ring.

Pedantism works both ways...

==> marking as invalid and requesting review in order to close.



---

archive/issue_comments_283797.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-13T13:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283797",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_283798.json:
```json
{
    "body": "This behavior is confusing. I think it's reasonable to expect that the derivative(f,g) will lie in the smallest ring containing f and g.  Why not fix this?",
    "created_at": "2021-03-13T13:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283798",
    "user": "https://trac.sagemath.org/admin/accounts/users/dgulotta"
}
```

This behavior is confusing. I think it's reasonable to expect that the derivative(f,g) will lie in the smallest ring containing f and g.  Why not fix this?



---

archive/issue_comments_283799.json:
```json
{
    "body": "Replying to [comment:3 dgulotta]:\n> This behavior is confusing. I think it's reasonable to expect that the derivative(f,g) will lie in the smallest ring containing f and g.  Why not fix this? \n\nIn order \n\n* to avoid introducing a //lot// of special-casing...\n\n* to keep (at least an appearance of) reason : the differential of a \"constant\" does not make sense, whereas the differential of a function, expression or polynomial being respectively a function, expression or polynomial does...\n\n...even when this function, expression or polynomial happens to be a \"constant\" or degree-0 monomial, in which case the derivative can be taken to be the null \"constant\" or degree-0 monomial.\n\nYour remark may be more relevant in the reverse case:\n\n```\nsage: R1.<t>=QQbar[]\nsage: foo=t^2\nsage: integral(foo,t).parent()\nUnivariate Polynomial Ring in t over Algebraic Field\n```\n\n\nSo far, so good. But\n\n\n```\nsage: integral(0,t).parent()\nSymbolic Ring\n```\n\n\nis nonsensical, unless we mean to do implicitly :\n\n\n```\nsage: integral(R1(0),t).parent()\nUnivariate Polynomial Ring in t over Algebraic Field\n```\n\n\nIn other words, take note that\n\n```\nsage: R1(0) is 0\nFalse\n```\n\n\neven if\n\n```\nsage: R1(0).is_zero()\nTrue\n```\n\n\nHTH,",
    "created_at": "2021-03-15T04:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283799",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:3 dgulotta]:
> This behavior is confusing. I think it's reasonable to expect that the derivative(f,g) will lie in the smallest ring containing f and g.  Why not fix this? 

In order 

* to avoid introducing a //lot// of special-casing...

* to keep (at least an appearance of) reason : the differential of a "constant" does not make sense, whereas the differential of a function, expression or polynomial being respectively a function, expression or polynomial does...

...even when this function, expression or polynomial happens to be a "constant" or degree-0 monomial, in which case the derivative can be taken to be the null "constant" or degree-0 monomial.

Your remark may be more relevant in the reverse case:

```
sage: R1.<t>=QQbar[]
sage: foo=t^2
sage: integral(foo,t).parent()
Univariate Polynomial Ring in t over Algebraic Field
```


So far, so good. But


```
sage: integral(0,t).parent()
Symbolic Ring
```


is nonsensical, unless we mean to do implicitly :


```
sage: integral(R1(0),t).parent()
Univariate Polynomial Ring in t over Algebraic Field
```


In other words, take note that

```
sage: R1(0) is 0
False
```


even if

```
sage: R1(0).is_zero()
True
```


HTH,



---

archive/issue_comments_283800.json:
```json
{
    "body": "It is difficult to do the right thing in all cases but I think that the patch that I submitted improves the situation for derivatives.  I could write something similar for integrals if there is agreement that this would be useful.\n\nThe reason why I don't like casting things into the symbolic ring is that it leads to errors that are very difficult to track down.  For example:\n\n```\nsage: R.<x>=QQ[]\nsage: l = [1,x,x*(x-1),x*(x-1)*(x-2)]\nsage: [derivative(f,x).monomial_coefficient(x) for f in l]\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-16-ff4d7a390725> in <module>\n----> 1 [derivative(f,x).monomial_coefficient(x) for f in l]\n\n<ipython-input-16-ff4d7a390725> in <listcomp>(.0)\n----> 1 [derivative(f,x).monomial_coefficient(x) for f in l]\n\n/ext/sage/sage-9.2/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4703)()\n    491             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'\n    492         \"\"\"\n--> 493         return self.getattr_from_category(name)\n    494 \n    495     cdef getattr_from_category(self, name):\n/ext/sage/sage-9.2/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4815)()\n    504         else:\n    505             cls = P._abstract_element_class\n--> 506         return getattr_from_other_class(self, cls, name)\n    507 \n    508     def __dir__(self):\n/ext/sage/sage-9.2/local/lib/python3.8/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2620)()\n    370         dummy_error_message.cls = type(self)\n    371         dummy_error_message.name = name\n--> 372         raise AttributeError(dummy_error_message)\n    373     attribute = <object>attr\n    374     # Check for a descriptor (__get__ in Python)\nAttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'monomial_coefficient'\n```\n\nIt is not at all clear from the error message that `1` needs to be replaced with `R(1)`.  And this is just a toy example; in real code the failure could occur much later down the line.  So I think it is bad for a function like `derivative` that sometimes returns polynomials to implicitly cast things into the symbolic ring when none of the arguments live in the symbolic ring.  The patch that I submitted should significantly reduce  these types of errors.\n\nIn principle I think it is better to raise an error with a detailed message than to implicitly cast into the symbolic ring.  I guess it may be too late to make that change since it might break existing code.  Attempting to cast into a polynomial ring when possible seems like a reasonable compromise.",
    "created_at": "2021-03-15T14:06:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283800",
    "user": "https://trac.sagemath.org/admin/accounts/users/dgulotta"
}
```

It is difficult to do the right thing in all cases but I think that the patch that I submitted improves the situation for derivatives.  I could write something similar for integrals if there is agreement that this would be useful.

The reason why I don't like casting things into the symbolic ring is that it leads to errors that are very difficult to track down.  For example:

```
sage: R.<x>=QQ[]
sage: l = [1,x,x*(x-1),x*(x-1)*(x-2)]
sage: [derivative(f,x).monomial_coefficient(x) for f in l]
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-16-ff4d7a390725> in <module>
----> 1 [derivative(f,x).monomial_coefficient(x) for f in l]

<ipython-input-16-ff4d7a390725> in <listcomp>(.0)
----> 1 [derivative(f,x).monomial_coefficient(x) for f in l]

/ext/sage/sage-9.2/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.__getattr__ (build/cythonized/sage/structure/element.c:4703)()
    491             AttributeError: 'LeftZeroSemigroup_with_category.element_class' object has no attribute 'blah_blah'
    492         """
--> 493         return self.getattr_from_category(name)
    494 
    495     cdef getattr_from_category(self, name):
/ext/sage/sage-9.2/local/lib/python3.8/site-packages/sage/structure/element.pyx in sage.structure.element.Element.getattr_from_category (build/cythonized/sage/structure/element.c:4815)()
    504         else:
    505             cls = P._abstract_element_class
--> 506         return getattr_from_other_class(self, cls, name)
    507 
    508     def __dir__(self):
/ext/sage/sage-9.2/local/lib/python3.8/site-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2620)()
    370         dummy_error_message.cls = type(self)
    371         dummy_error_message.name = name
--> 372         raise AttributeError(dummy_error_message)
    373     attribute = <object>attr
    374     # Check for a descriptor (__get__ in Python)
AttributeError: 'sage.symbolic.expression.Expression' object has no attribute 'monomial_coefficient'
```

It is not at all clear from the error message that `1` needs to be replaced with `R(1)`.  And this is just a toy example; in real code the failure could occur much later down the line.  So I think it is bad for a function like `derivative` that sometimes returns polynomials to implicitly cast things into the symbolic ring when none of the arguments live in the symbolic ring.  The patch that I submitted should significantly reduce  these types of errors.

In principle I think it is better to raise an error with a detailed message than to implicitly cast into the symbolic ring.  I guess it may be too late to make that change since it might break existing code.  Attempting to cast into a polynomial ring when possible seems like a reasonable compromise.



---

archive/issue_comments_283801.json:
```json
{
    "body": "Replying to [comment:5 dgulotta]:\n\n\n[ Snip... ]\n\n> The patch that I submitted should significantly reduce  these types of errors.\n\nWhich patch ? I find no patch in the ticket.\n\nMore generally, I think that the problem is to //define// and //compute// \"the smallest ring containing f and g\".\n\nTo illustrate :\n\n\n```\nsage: R1.<t>=QQ[]\nsage: t.derivative(t)\n1\nsage: t.derivative(t).parent()\nUnivariate Polynomial Ring in t over Rational Field\nsage: 1.derivative(t).parent()\n## [ Snip... ]\nAttributeError: 'sage.rings.integer.Integer' object has no attribute 'derivative'\nsage: t.parent()(1).derivative(t).parent()\nUnivariate Polynomial Ring in t over Rational Field\n```\n\n\nThis cast is reasonable and might be expected (i. e. one can reasonably expect `1.differential(t)` to return `R1`'s `0`.\n\nHarder :\n\n\n```\nsage: R2.<u>=QQ[]\nsage: t.derivative(u)\n## [ Snip... ]\nValueError: cannot differentiate with respect to u\n```\n\n\nOne might expect the `0` with : \n* this zero belonging to `PolynomialRing(QQ,\"v1,v2\")`, //and//\n* some \"automagic glue\" realizing `v1==t, v2==u`.\n\nI'm not sure that this can be expressed in Sage...\n\nFor the integrals :\n\n\n```\nsage: 1.integral(t)\n## [ Snip]\nAttributeError: 'sage.rings.integer.Integer' object has no attribute 'integral'\nsage: t.parent()(1).integral(t)\nt\n```\n\n\nAgain, a \"reasonable\" cast.\n\nThe case `t.integral(u)` leads to the same conclusion as for `t.differentiate(u)`.\n\nAnd we might have worse difficulties : what should be the \"smallest ring\" containing `Zmod(3)['v']` and `QQbar['w']` ? Ditto for ring of matrices...\n\nCasting to SR is, indeed, far from ideal, but it seems tome that the possible enhancements are fraught with more difficulties than they solve.\n\nYour thoughts ?",
    "created_at": "2021-03-15T17:04:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283801",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:5 dgulotta]:


[ Snip... ]

> The patch that I submitted should significantly reduce  these types of errors.

Which patch ? I find no patch in the ticket.

More generally, I think that the problem is to //define// and //compute// "the smallest ring containing f and g".

To illustrate :


```
sage: R1.<t>=QQ[]
sage: t.derivative(t)
1
sage: t.derivative(t).parent()
Univariate Polynomial Ring in t over Rational Field
sage: 1.derivative(t).parent()
## [ Snip... ]
AttributeError: 'sage.rings.integer.Integer' object has no attribute 'derivative'
sage: t.parent()(1).derivative(t).parent()
Univariate Polynomial Ring in t over Rational Field
```


This cast is reasonable and might be expected (i. e. one can reasonably expect `1.differential(t)` to return `R1`'s `0`.

Harder :


```
sage: R2.<u>=QQ[]
sage: t.derivative(u)
## [ Snip... ]
ValueError: cannot differentiate with respect to u
```


One might expect the `0` with : 
* this zero belonging to `PolynomialRing(QQ,"v1,v2")`, //and//
* some "automagic glue" realizing `v1==t, v2==u`.

I'm not sure that this can be expressed in Sage...

For the integrals :


```
sage: 1.integral(t)
## [ Snip]
AttributeError: 'sage.rings.integer.Integer' object has no attribute 'integral'
sage: t.parent()(1).integral(t)
t
```


Again, a "reasonable" cast.

The case `t.integral(u)` leads to the same conclusion as for `t.differentiate(u)`.

And we might have worse difficulties : what should be the "smallest ring" containing `Zmod(3)['v']` and `QQbar['w']` ? Ditto for ring of matrices...

Casting to SR is, indeed, far from ideal, but it seems tome that the possible enhancements are fraught with more difficulties than they solve.

Your thoughts ?



---

archive/issue_comments_283802.json:
```json
{
    "body": "There is an attachment to this ticket, which is a patch.  The patch uses `sage.structure.element.get_coercion_model`.  I don't claim to be an expert on this function but it seems to do the right thing in cases that would come up in practice.",
    "created_at": "2021-03-15T17:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283802",
    "user": "https://trac.sagemath.org/admin/accounts/users/dgulotta"
}
```

There is an attachment to this ticket, which is a patch.  The patch uses `sage.structure.element.get_coercion_model`.  I don't claim to be an expert on this function but it seems to do the right thing in cases that would come up in practice.



---

archive/issue_comments_283803.json:
```json
{
    "body": "Replying to [comment:7 dgulotta]:\n> There is an attachment to this ticket, which is a patch.  The patch uses `sage.structure.element.get_coercion_model`.  I don't claim to be an expert on this function but it seems to do the right thing in cases that would come up in practice.\n\nWould you mind submitting a branch, as described in Sagemath's [developer's guide](https://doc.sagemath.org/html/en/developer/index.html) ?",
    "created_at": "2021-03-15T17:23:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283803",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:7 dgulotta]:
> There is an attachment to this ticket, which is a patch.  The patch uses `sage.structure.element.get_coercion_model`.  I don't claim to be an expert on this function but it seems to do the right thing in cases that would come up in practice.

Would you mind submitting a branch, as described in Sagemath's [developer's guide](https://doc.sagemath.org/html/en/developer/index.html) ?



---

archive/issue_comments_283804.json:
```json
{
    "body": "It is a bad idea to put a lot of code inside the `try` block. Only keep there the minimal amount of code that could potentially raise an error. For example neither `elts.append(f)` nor `cm = get_coercion_model()` should be there.\n----\nNew commits:",
    "created_at": "2021-03-17T20:04:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283804",
    "user": "https://github.com/videlec"
}
```

It is a bad idea to put a lot of code inside the `try` block. Only keep there the minimal amount of code that could potentially raise an error. For example neither `elts.append(f)` nor `cm = get_coercion_model()` should be there.
----
New commits:



---

archive/issue_comments_283805.json:
```json
{
    "body": "This might be an interesting data point:\n\n```\nsage: R.<x> = ZZ[]\nsage: S.<y> = ZZ[]\nsage: derivative(S.zero(), x).parent()\nUnivariate Polynomial Ring in y over Integer Ring\n```\n",
    "created_at": "2021-03-19T03:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283805",
    "user": "https://github.com/tscrim"
}
```

This might be an interesting data point:

```
sage: R.<x> = ZZ[]
sage: S.<y> = ZZ[]
sage: derivative(S.zero(), x).parent()
Univariate Polynomial Ring in y over Integer Ring
```




---

archive/issue_comments_283806.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-12-29T10:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283806",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_283807.json:
```json
{
    "body": "Setting in needs works because of [comment:10].",
    "created_at": "2021-12-29T10:36:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283807",
    "user": "https://github.com/videlec"
}
```

Setting in needs works because of [comment:10].



---

archive/issue_comments_283808.json:
```json
{
    "body": "Also [comment:2] makes a good point `derivative(QQ['t'].gen(), SR.var('t'))` is currently a polynomial. The proposed branch would change that behaviour and it is not clear whether this is desirable.\n\nA more sensible change for `derivative(f, v)` would be to do in order\n1. try to *convert* `v` to `parent(f)` and take derivative (that would keep the behaviour noticed in [comment:2])\n2. try to find a common parent for `f` and `v` and take derivative (that would solve the issue in the ticket description and arguably improve the behaviour from [comment:11])\n3. go to `SR`",
    "created_at": "2021-12-29T10:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283808",
    "user": "https://github.com/videlec"
}
```

Also [comment:2] makes a good point `derivative(QQ['t'].gen(), SR.var('t'))` is currently a polynomial. The proposed branch would change that behaviour and it is not clear whether this is desirable.

A more sensible change for `derivative(f, v)` would be to do in order
1. try to *convert* `v` to `parent(f)` and take derivative (that would keep the behaviour noticed in [comment:2])
2. try to find a common parent for `f` and `v` and take derivative (that would solve the issue in the ticket description and arguably improve the behaviour from [comment:11])
3. go to `SR`



---

archive/issue_comments_283809.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-12-29T11:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283809",
    "user": "https://github.com/videlec"
}
```

New commits:



---

archive/issue_comments_283810.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-12-29T11:11:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283810",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_283811.json:
```json
{
    "body": "There's a typo in,\n\n> This behaviour of the ``derivaive`` function\n\nBut personally, instead of an example that says\n\n> the parent of the result might seem confusing... this... is a consequence of how derivatives are implemented for polynomials\n\nI would prefer if the documentation just told me what the parent will be in the `OUTPUT` block: the derivative of a symbolic expression with respect to a symbolic expression will be a symbolic expression, and likewise for polynomials with respect to polynomials. If the function and the variable are of different types that share a common parent, then the result will live in that common parent. Otherwise, as a last resort, it will live in the symbolic ring.",
    "created_at": "2021-12-29T12:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283811",
    "user": "https://github.com/orlitzky"
}
```

There's a typo in,

> This behaviour of the ``derivaive`` function

But personally, instead of an example that says

> the parent of the result might seem confusing... this... is a consequence of how derivatives are implemented for polynomials

I would prefer if the documentation just told me what the parent will be in the `OUTPUT` block: the derivative of a symbolic expression with respect to a symbolic expression will be a symbolic expression, and likewise for polynomials with respect to polynomials. If the function and the variable are of different types that share a common parent, then the result will live in that common parent. Otherwise, as a last resort, it will live in the symbolic ring.



---

archive/issue_comments_283812.json:
```json
{
    "body": "Currently\n\n```\nsage: derivative(0)\n0\nsage: derivative(0).parent()\nSymbolic Ring\n```\n\nI don't like it... though I am not sure what it should be.",
    "created_at": "2021-12-29T17:12:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283812",
    "user": "https://github.com/videlec"
}
```

Currently

```
sage: derivative(0)
0
sage: derivative(0).parent()
Symbolic Ring
```

I don't like it... though I am not sure what it should be.



---

archive/issue_comments_283813.json:
```json
{
    "body": "Replying to [comment:18 vdelecroix]:\n> I don't like it... though I am not sure what it should be.\n\nIt should be an error, because the integer zero is not a function.\n\nBut I guess that behavior is consistent with the usual abuse of notation. We convert constants to symbolic expressions so that they can be evaluated like a function. In this case, we convert `ZZ(0)` to `SR(0)`, and if you think of that as being the const-zero function, its derivative is itself with respect to whatever you call the implicit argument.",
    "created_at": "2021-12-29T17:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283813",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:18 vdelecroix]:
> I don't like it... though I am not sure what it should be.

It should be an error, because the integer zero is not a function.

But I guess that behavior is consistent with the usual abuse of notation. We convert constants to symbolic expressions so that they can be evaluated like a function. In this case, we convert `ZZ(0)` to `SR(0)`, and if you think of that as being the const-zero function, its derivative is itself with respect to whatever you call the implicit argument.



---

archive/issue_comments_283814.json:
```json
{
    "body": "Replying to [comment:19 mjo]:\n> Replying to [comment:18 vdelecroix]:\n> > I don't like it... though I am not sure what it should be.\n> \n> It should be an error, because the integer zero is not a function.\n\nIf this is your answer, then you should arguethat the derivative of **any** element of `Integer Ring` should result in an error.\n\n> But I guess that behavior is consistent with the usual abuse of notation. We convert constants to symbolic expressions so that they can be evaluated like a function. In this case, we convert `ZZ(0)` to `SR(0)`, and if you think of that as being the const-zero function, its derivative is itself with respect to whatever you call the implicit argument.\n\nPrecisely, this ticket is changing that behaviour as it also make sense to take derivatives of polynomials, Laurent polynomials, power series, etc. If you find this behaviour consistent, then this ticket should not be merged at all.",
    "created_at": "2021-12-29T17:23:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283814",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:19 mjo]:
> Replying to [comment:18 vdelecroix]:
> > I don't like it... though I am not sure what it should be.
> 
> It should be an error, because the integer zero is not a function.

If this is your answer, then you should arguethat the derivative of **any** element of `Integer Ring` should result in an error.

> But I guess that behavior is consistent with the usual abuse of notation. We convert constants to symbolic expressions so that they can be evaluated like a function. In this case, we convert `ZZ(0)` to `SR(0)`, and if you think of that as being the const-zero function, its derivative is itself with respect to whatever you call the implicit argument.

Precisely, this ticket is changing that behaviour as it also make sense to take derivatives of polynomials, Laurent polynomials, power series, etc. If you find this behaviour consistent, then this ticket should not be merged at all.



---

archive/issue_comments_283815.json:
```json
{
    "body": "I suspect the behaviour on the integers was installed to deal with some edge cases that happened interactively or perhaps internally in SR.\n\nAs far as I can see, `x.derivative(...)` is meant as an application of an operator to a ring element `x` and the argument `...` is taken as an indication what operator is meant. In particular, I don't think there is normally any effort to coerce the element `x` into a ring derived from the arguments `...`.\n\nFor instance:\n\n```\nsage: R.<a>=QQ[]\nsage: S.<b>=QQ[]\nsage: a.derivative(b)\nValueError: cannot differentiate with respect to b\nsage: (a^3).derivative(2) #  2 means a repeat count here\n6*a\n```\n\nIn fact,\n\n```\nsage: 0.derivative(a)\nAttributeError: 'sage.rings.integer.Integer' object has no attribute 'derivative'\n```\n\nso the functionality here is just part of the top-level `derivative` convenience function. Indeed, it's behaviour is: first try method application. If that fails, try if coercing into SR works. I think the current behaviour is as intended: convenience for the casual user who isn't bothered by SR. Anyone who is worried about parents should be using method calls here, since they dispatch much better among types.\n\nThese convenience functions are just not a good way of dispatching on type data. You'd have to move to a different language then, that has full signature dispatch rather than python's \"first argument\" dispatch through method calls.",
    "created_at": "2021-12-29T17:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283815",
    "user": "https://github.com/nbruin"
}
```

I suspect the behaviour on the integers was installed to deal with some edge cases that happened interactively or perhaps internally in SR.

As far as I can see, `x.derivative(...)` is meant as an application of an operator to a ring element `x` and the argument `...` is taken as an indication what operator is meant. In particular, I don't think there is normally any effort to coerce the element `x` into a ring derived from the arguments `...`.

For instance:

```
sage: R.<a>=QQ[]
sage: S.<b>=QQ[]
sage: a.derivative(b)
ValueError: cannot differentiate with respect to b
sage: (a^3).derivative(2) #  2 means a repeat count here
6*a
```

In fact,

```
sage: 0.derivative(a)
AttributeError: 'sage.rings.integer.Integer' object has no attribute 'derivative'
```

so the functionality here is just part of the top-level `derivative` convenience function. Indeed, it's behaviour is: first try method application. If that fails, try if coercing into SR works. I think the current behaviour is as intended: convenience for the casual user who isn't bothered by SR. Anyone who is worried about parents should be using method calls here, since they dispatch much better among types.

These convenience functions are just not a good way of dispatching on type data. You'd have to move to a different language then, that has full signature dispatch rather than python's "first argument" dispatch through method calls.



---

archive/issue_comments_283816.json:
```json
{
    "body": "Replying to [comment:20 vdelecroix]:\n> Replying to [comment:19 mjo]:\n> > Replying to [comment:18 vdelecroix]:\n> > > I don't like it... though I am not sure what it should be.\n> > \n> > It should be an error, because the integer zero is not a function.\n> \n> If this is your answer, then you should argue that the derivative of **any** element of `Integer Ring` should result in an error.\n\nThat's right.\n\n\n> Precisely, this ticket is changing that behaviour as it also make sense to take derivatives of polynomials, Laurent polynomials, power series, etc. If you find this behaviour consistent, then this ticket should not be merged at all.\n\nThese top-level convenience functions that take any sage or python object are always a mess. The principled approach is to use `x.derivative()`, and if that method isn't there, then you can't differentiate the thing. We only run into a problem trying to teach the top-level function how to differentiate things that can't be differentiated. In that regard, asking for consistency from the result when our goals weren't consistent to begin with is too optimistic.\n\nSo I think `derivative(ZZ(0)) = SR(0)` is as good as any answer for the derivative of an integer. But I also think that having special cases for polynomials and series is fine too. Since polynomials overlap partially (but not completely) with things that can be coerced into `SR`, I don't think we'll get a nice solution that is consistent in all cases.",
    "created_at": "2021-12-29T18:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20575",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20575#issuecomment-283816",
    "user": "https://github.com/orlitzky"
}
```

Replying to [comment:20 vdelecroix]:
> Replying to [comment:19 mjo]:
> > Replying to [comment:18 vdelecroix]:
> > > I don't like it... though I am not sure what it should be.
> > 
> > It should be an error, because the integer zero is not a function.
> 
> If this is your answer, then you should argue that the derivative of **any** element of `Integer Ring` should result in an error.

That's right.


> Precisely, this ticket is changing that behaviour as it also make sense to take derivatives of polynomials, Laurent polynomials, power series, etc. If you find this behaviour consistent, then this ticket should not be merged at all.

These top-level convenience functions that take any sage or python object are always a mess. The principled approach is to use `x.derivative()`, and if that method isn't there, then you can't differentiate the thing. We only run into a problem trying to teach the top-level function how to differentiate things that can't be differentiated. In that regard, asking for consistency from the result when our goals weren't consistent to begin with is too optimistic.

So I think `derivative(ZZ(0)) = SR(0)` is as good as any answer for the derivative of an integer. But I also think that having special cases for polynomials and series is fine too. Since polynomials overlap partially (but not completely) with things that can be coerced into `SR`, I don't think we'll get a nice solution that is consistent in all cases.
