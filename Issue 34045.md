# Issue 34045: Join feature TeXFile with pdflatex

Issue created by migration from https://trac.sagemath.org/ticket/34282

Original creator: soehms

Original creation time: 2022-08-05 06:39:37

CC:  slabbe

Keywords: latex texfile feature join

Currently, as observed in [comment 7](https://trac.sagemath.org/ticket/34185#comment:7) of #34185, the method `is_present` of instances of class `TeXFile` runs into an exception if `pdflatex` is not installed. For example:


```
sage: from sage.features.latex import LaTeXPackage
sage: LaTeXPackage("tkz-graph").is_present()
Traceback (most recent call last):
...
FileNotFoundError: [Errno 2] No such file or directory: 'kpsewhich'
```


The aim of the ticket is to fix this.


---

Comment by soehms created at 2022-08-05 06:48:57

Changing component from packages: optional to doctest framework.


---

Comment by soehms created at 2022-08-05 06:48:57

New commits:


---

Comment by soehms created at 2022-08-05 06:48:57

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-05 18:54:01

I think it would also make sense to add `spkg='texlive'` to these features


---

Comment by git created at 2022-08-08 17:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-08-08 17:37:02

Replying to [comment:3 mkoeppe]:
> I think it would also make sense to add `spkg='texlive'` to these features

Done! Furthermore, I refactor the executable features not only to avoid duplicated code, but also since in my point of view it is not reasonable that just the `latex` feature has a stronger `is_functional` check.


---

Comment by klee created at 2022-08-20 01:01:42


```diff
diff --git a/src/sage/features/latex.py b/src/sage/features/latex.py
index cf65aea6af..7db89f6190 100644
--- a/src/sage/features/latex.py
+++ b/src/sage/features/latex.py
@@ -37,7 +37,7 @@ class LaTeX(Executable):
             sage: isinstance(latex(), latex)
             True
         """
-        Executable.__init__(self, name, executable=name, spkg=latex_spkg, url=latex_url)
+        super().__init__(name, executable=name, spkg=latex_spkg, url=latex_url)
 
     def is_functional(self):
         r"""
@@ -217,13 +217,10 @@ class TeXFile(StaticFile, JoinFeature):
             sage: from sage.features.latex import LaTeXPackage, pdflatex
             sage: f = LaTeXPackage("tkz-graph")
             sage: g = pdflatex()
-            sage: bool(f.is_present()) == bool(g.is_present())  # indirect doctest
+            sage: not f.is_present() or bool(g.is_present())  # indirect doctest
             True
         """
-        test = JoinFeature._is_present(self)
-        if not test:
-            return test
-        return super(TeXFile, self)._is_present()
+        return JoinFeature._is_present(self) and StaticFile._is_present(self)
 
```



---

Comment by klee created at 2022-08-20 01:10:36

By the way, why presence of `kpsewhich` is checked by the presence of `pdflatex`? `kpsewhich` is a component of tex installation. Checking if `texlive` is present isn't enough?


---

Comment by soehms created at 2022-08-20 14:46:39

Replying to [comment:6 klee]:
> {{{#!diff
> diff --git a/src/sage/features/latex.py b/src/sage/features/latex.py
> index cf65aea6af..7db89f6190 100644
> --- a/src/sage/features/latex.py
> +++ b/src/sage/features/latex.py
> `@``@` -37,7 +37,7 `@``@` class LaTeX(Executable):
>              sage: isinstance(latex(), latex)
>              True
>          """
> -        Executable.__init__(self, name, executable=name, spkg=latex_spkg, url=latex_url)
> +        super().__init__(name, executable=name, spkg=latex_spkg, url=latex_url)
>  
>      def is_functional(self):
>          r"""
> `@``@` -217,13 +217,10 `@``@` class TeXFile(StaticFile, JoinFeature):
>              sage: from sage.features.latex import LaTeXPackage, pdflatex
>              sage: f = LaTeXPackage("tkz-graph")
>              sage: g = pdflatex()
> -            sage: bool(f.is_present()) == bool(g.is_present())  # indirect doctest
> +            sage: not f.is_present() or bool(g.is_present())  # indirect doctest
>              True
>          """
> -        test = JoinFeature._is_present(self)
> -        if not test:
> -            return test
> -        return super(TeXFile, self)._is_present()
> +        return JoinFeature._is_present(self) and StaticFile._is_present(self)
>  
> }}}

I'm fine with your first suggestion. Concerning the second, the advantage is not clear to me. 

With your third suggestion I have a problem since in general I prefer to serialise condition checks if they only work in a certain order. I know that it is no problem any more with modern languages and compilers, since they implicitly serialise in the order they are written. But the syntax using `and` / `or` pretends a parallelism which is not given in such a situation.


---

Comment by soehms created at 2022-08-20 14:48:44

Replying to [comment:7 klee]:
> By the way, why presence of `kpsewhich` is checked by the presence of `pdflatex`? `kpsewhich` is a component of tex installation. Checking if `texlive` is present isn't enough?

AFAIK there is no feature that checks if `texlive` is just installed, no? Do you want to create a new feature or just replace the join with `pdflatex` by `latex`?


---

Comment by klee created at 2022-08-20 16:23:31

Replying to [comment:8 soehms]:
> Concerning the second, the advantage is not clear to me. 

Here you want to check that "if f.is_present, then g.is_present". Right? My test just does that expressly.

> With your third suggestion I have a problem since in general I prefer to serialise condition checks if they only work in a certain order. I know that it is no problem any more with modern languages and compilers, since they implicitly serialise in the order they are written. But the syntax using `and` / `or` pretends a parallelism which is not given in such a situation.

There is no parallelism here. My simple code exactly does what your code does. Note that

```
sage: 0 and 1
0
sage: 1 and 2
2
```

In `A and B`, `B` is never evaluated if `A` is false.


---

Comment by soehms created at 2022-08-20 16:49:18

Replying to [comment:10 klee]:
> Replying to [comment:8 soehms]:
> > Concerning the second, the advantage is not clear to me. 
> 
> Here you want to check that "if f.is_present, then g.is_present". Right? My test just does that expressly.

Convinced! I had _if and only if_ in mind since AFAIK in reallity `f` is always present if `g` is.

> 
> > With your third suggestion I have a problem since in general I prefer to serialise condition checks if they only work in a certain order. I know that it is no problem any more with modern languages and compilers, since they implicitly serialise in the order they are written. But the syntax using `and` / `or` pretends a parallelism which is not given in such a situation.
> 
> There is no parallelism here.

I was saying _pretends a parallelism_. 

> My simple code exactly does what your code does. 

So what is the advantage?

> Note that
> {{{
> sage: 0 and 1
> 0
> sage: 1 and 2
> 2
> }}}
> In `A and B`, `B` is never evaluated if `A` is false.
>

Maybe I'm old fashioned, but I know a time where you could not be sure that _`B` is never evaluated if `A` is false_ (at least in `C`).


---

Comment by klee created at 2022-08-20 21:47:16

Replying to [comment:11 soehms]:
> > My simple code exactly does what your code does. 
> 
> So what is the advantage?

It took me some time to understand the purpose of your code. My code expresses the purpose.

> > In `A and B`, `B` is never evaluated if `A` is false.
> >
> 
> Maybe I'm old fashioned, but I know a time where you could not be sure that _`B` is never evaluated if `A` is false_ (at least in `C`).

Yeah, this is just Python:

https://docs.python.org/3/reference/expressions.html#boolean-operations


---

Comment by klee created at 2022-08-20 22:54:12

Replying to [comment:9 soehms]:
> Replying to [comment:7 klee]:
> > By the way, why presence of `kpsewhich` is checked by the presence of `pdflatex`? `kpsewhich` is a component of tex installation. Checking if `texlive` is present isn't enough?
> 
> ...or just replace the join with `pdflatex` by `latex`?

Yes. I know that they are practically the same, but the name `latex` can be understood as the latex system(texlive) but `pdflatex` refers to the program.


---

Comment by soehms created at 2022-08-21 06:06:22

Replying to [comment:12 klee]:
> Replying to [comment:11 soehms]:
> > > My simple code exactly does what your code does. 
> > 
> > So what is the advantage?
> 
> It took me some time to understand the purpose of your code. My code expresses the purpose.
> 

But it might be misleading for people who think `and` is a commutative binary operator which is not very unusual for mathematicians :)


---

Comment by soehms created at 2022-08-21 06:08:16

Replying to [comment:13 klee]:
> Replying to [comment:9 soehms]:
> > Replying to [comment:7 klee]:
> > > By the way, why presence of `kpsewhich` is checked by the presence of `pdflatex`? `kpsewhich` is a component of tex installation. Checking if `texlive` is present isn't enough?
> > 
> > ...or just replace the join with `pdflatex` by `latex`?
> 
> Yes. I know that they are practically the same, but the name `latex` can be understood as the latex system(texlive) but `pdflatex` refers to the program.

Agreed!

I'm on vaccation the next two week. If you don't want to wait that long, feel free to do all of the changes you suggested by yourself.


---

Comment by klee created at 2022-08-21 06:12:13

Replying to [comment:14 soehms]:
> But it might be misleading for people who think `and` is a commutative binary operator which is not very unusual for mathematicians :)

But for python programmers, the above use of `and` is a common idiom. Don't worry.


---

Comment by klee created at 2022-08-21 06:12:54

Replying to [comment:15 soehms]:
> I'm on vaccation the next two week. If you don't want to wait that long, feel free to do all of the changes you suggested by yourself.

Okay. Happy vacation!


---

Comment by soehms created at 2022-08-21 07:38:47

Replying to [comment:17 klee]:
> Replying to [comment:15 soehms]:
> > I'm on vaccation the next two week. If you don't want to wait that long, feel free to do all of the changes you suggested by yourself.
> 
> Okay. Happy vacation!

Thanks!


---

Comment by klee created at 2022-08-21 12:23:51

While fixing things, I could not resist from doing more than I intended. Sorry...

It seemed that TeXFile doesn't need to be a subclass of JoinFeature.

Instead, TeXFile now simply checks latex presence first. 
----
New commits:


---

Comment by klee created at 2022-08-21 12:23:51

Changing keywords from "latex texfile feature join" to "latex texfile feature".


---

Comment by git created at 2022-08-21 12:38:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by soehms created at 2022-08-21 13:14:10

Replying to [comment:20 klee]:
> While fixing things, I could not resist from doing more than I intended. Sorry...
> 
> It seemed that TeXFile doesn't need to be a subclass of JoinFeature.
> 
> Instead, TeXFile now simply checks latex presence first. 

Note that #34185 has a dependency on this ticket and I think this would break things there. More precisely, the method `joined_features` defined in class `Feature` will not work correctly for `TeX` files. So at least you should find another solution for that.


---

Comment by klee created at 2022-08-22 01:53:53

Replying to [comment:23 soehms]:
> Note that #34185 has a dependency on this ticket and I think this would break things there.

Probably.

> More precisely, the method `joined_features` defined in class `Feature` will not work correctly for `TeX` files. So at least you should find another solution for that.

The purpose of this ticket as in description (but not as in old title) is to fix a **bug** in TeXFile feature, which did not check latex system in place before it check the presence of a TeX file (such as a latex package). This has nothing to do with #34185. 

Hence I think that any changes to TeXFile feature related with #34185 should be made in #34185 itself.

Moreover, as far as I understand #34185, the goal of #34185 is not clear to me and I doubt if the goal is reasonable. So the present ticket is better to be independent from #34185.


---

Comment by klee created at 2022-08-22 01:57:14

By the way, I am positive with this ticket.


---

Comment by soehms created at 2022-08-24 11:51:08

Replying to [comment:25 klee]:
> By the way, I am positive with this ticket.
I will not be able to look at your additional changes before I will be back home again.

At the moment I am still not convinced to remove the inheritance of JoinFeature (independently of #34185), since as fas as I understand this is the conceptual way to indicate dependencies between features.


---

Comment by klee created at 2022-08-24 20:04:29

Replying to [comment:27 soehms]:
> Replying to [comment:25 klee]:
> > By the way, I am positive with this ticket.
> I will not be able to look at your additional changes before I will be back home again.

No hurry. Enjoy vacation!
 
> At the moment I am still not convinced to remove the inheritance of JoinFeature (independently of #34185), since as fas as I understand this is the conceptual way to indicate dependencies between features.

I think JoinFeature is not relevant for the bug. A joined feature is conceptually a new feature "A and B" combining A and B. TeXFile is a feature A that requires feature B. Conceptually it is "A => B".


---

Comment by soehms created at 2022-09-06 07:09:22

Replying to [comment:28 Kwankyu Lee]:
> I think JoinFeature is not relevant for the bug. A joined feature is conceptually a new feature "A and B" combining A and B. TeXFile is a feature A that requires feature B. Conceptually it is "A => B".   

Indeed, according to the examples given in the docstring of the class you are right. But it is at least misleading that most examples of joined features consist of just one:


```sage
sage: from sage.features.all import all_features
sage: from sage.features.join_feature import JoinFeature
sage: J = [F for F in all_features() if isinstance(F, JoinFeature)]
sage: len([F for F in J if len(F._features) == 1])
16
sage: len([F for F in J if len(F._features) > 1])
7
```


In these cases the instance of `JoinFeature` usually refers to a `SPKG` (for example `meataxe`) which is combined with a Python module (in the example `meataxe` this is `sage.matrix.matrix_gfpn_dense`) implementing the integration of the new functionality into Sage. Since the Python module requires the `SPKG` the construction describes a dependency here, as well. But I confess that it is reverse on how I used it.

Finally, I agree with your changes, but I observed two little things that I have corrected. If you agree and the patchbot comes green again, you may set to positive review.


---

Comment by klee created at 2022-09-07 04:28:25

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-09-07 04:28:25

Replying to [comment:30 Sebastian Oehms]:
> In these cases the instance of `JoinFeature` usually refers to a `SPKG` (for example `meataxe`) which is combined with a Python module (in the example `meataxe` this is `sage.matrix.matrix_gfpn_dense`) implementing the integration of the new functionality into Sage. Since the Python module requires the `SPKG` the construction describes a dependency here, as well. But I confess that it is reverse on how I used it.

It seems `JoinFeature` is also used as unary. In your example, the feature `Meataxe` is a `JoinFeature` of the Python module `sage.matrix.matrix_gfpn_dense` only. Any feature is provided by an `SPKG`. In this example, the presence of the Python module implies the presence of the SPKG meataxe. Hence I think the feature `Meataxe` uses the unary `JoinFeature` to check the presence of the SPKG meataxe.  In general, unary `JoinFeature` seems to be used to check the presence of an SPKG.

In our case, we don't need the trick since we can check the presence of the latex feature.
 
> Finally, I agree with your changes, but I observed two little things that I have corrected. If you agree and the patchbot comes green again, you may set to positive review.

Thanks. I am positive too!


---

Comment by soehms created at 2022-09-07 17:10:18

Replying to [comment:32 Kwankyu Lee]:
> Replying to [comment:30 Sebastian Oehms]:
> It seems `JoinFeature` is also used as unary. In your example, the feature `Meataxe` is a `JoinFeature` of the Python module `sage.matrix.matrix_gfpn_dense` only. Any feature is provided by an `SPKG`. In this example, the presence of the Python module implies the presence of the SPKG meataxe. Hence I think the feature `Meataxe` uses the unary `JoinFeature` to check the presence of the SPKG meataxe.  In general, unary `JoinFeature` seems to be used to check the presence of an SPKG.
> 
Exactly! I think `JoinFeature` is missing some documentation to make these things clear. Shall I open a ticket?


> Thanks. I am positive too!

Thanks, as well!


---

Comment by mkoeppe created at 2022-09-07 19:06:06

Replying to [comment:32 Kwankyu Lee]:
> It seems `JoinFeature` is also used as unary. In your example, the feature `Meataxe` is a `JoinFeature` of the Python module `sage.matrix.matrix_gfpn_dense` only. Any feature is provided by an `SPKG`. In this example, the presence of the Python module implies the presence of the SPKG meataxe. Hence I think the feature `Meataxe` uses the unary `JoinFeature` to check the presence of the SPKG meataxe.  In general, unary `JoinFeature` seems to be used to check the presence of an SPKG.

The name of a feature gives the `# optional` tag. I have used unary `JoinFeature`s to equip features such as `PythonModule` features with a tag name that differs from the systematic tag name.


---

Comment by klee created at 2022-09-07 22:35:47

Replying to [comment:33 Sebastian Oehms]:
> I think `JoinFeature` is missing some documentation to make these things clear. Shall I open a ticket?

That would be nice. Matthias explains clearly how unary `JoinFeature` can be used.


---

Comment by soehms created at 2022-09-08 19:17:25

Replying to [comment:35 Kwankyu Lee]:
> Replying to [comment:33 Sebastian Oehms]:
> > I think `JoinFeature` is missing some documentation to make these things clear. Shall I open a ticket?
> 
> That would be nice. Matthias explains clearly how unary `JoinFeature` can be used.

This is now #34508!


---

Comment by vbraun created at 2022-09-22 22:35:37

Resolution: fixed
