# Issue 13234: Optimize CombinatorialFreeModule.Element._vector_

Issue created by migration from Trac.

Original creator: nthiery

Original creation time: 2012-08-28 08:31:10

Assignee: jason, was

CC:  sage-combinat bump mguaypaq




---

Comment by chapoton created at 2012-08-28 09:29:20

One suggestion, maybe: use the trac automatic link instead of just #number


```
:trac:`13406`: the code below has been optimized
```



---

Comment by nthiery created at 2012-08-28 10:06:26

Replying to [comment:2 chapoton]:
> One suggestion, maybe: use the trac automatic link instead of just #number
> 
> {{{
> :trac:`13406`: the code below has been optimized
> }}}

Oops, thanks for catching this! Btw I fixed the patch header in the updated patch.


---

Comment by saliola created at 2012-08-28 13:59:50

Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?


---

Comment by nthiery created at 2012-08-28 14:36:34

Hi Franco,

Replying to [comment:4 saliola]:
> Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?

Essentially, vector(...) is very slow, in particular because it first has to figure out which dense free module F to use. The patch builds that free module once for all (in the _dense_free_module method which is cached). And then it saves a bit more by feeding the data directly to the element class of F, and being careful about the options).


---

Comment by saliola created at 2012-08-28 15:36:55

I'm ready to set a positive review on this, but I can't run doctests on sage-5.3.rc0 currently and the patchbot seems to be sleeping. Can someone run tests, etc.


---

Comment by saliola created at 2012-08-28 15:38:28

Replying to [comment:5 nthiery]:
>           Hi Franco,
> 
> Replying to [comment:4 saliola]:
> > Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?
> 
> Essentially, vector(...) is very slow, in particular because it first has to figure out which dense free module F to use. The patch builds that free module once for all (in the _dense_free_module method which is cached). And then it saves a bit more by feeding the data directly to the element class of F, and being careful about the options).

Thanks for the explanation, Nicolas. It's very subtle.


---

Comment by chapoton created at 2012-08-29 07:39:27

Changing status from new to needs_review.


---

Comment by mguaypaq created at 2012-09-28 18:55:18

Changing status from needs_review to needs_work.


---

Comment by mguaypaq created at 2012-09-28 18:55:18

As far as I can tell, the patch as posted does not functionally change anything. It changes the documentation of `CombinatorialFreeModuleElement._vector_` without changing the corresponding code, and adds the method `CombinatorialFreeModule._dense_free_module` without adding any code to have it called.

I confirmed this experimentally by getting the following timings on sage-5.3 for the first three tests in the ticket description (`f._vector_()`, `f.to_vector()`, `vector(f)`):

Before: 270, 270, 293 µs


After: 265, 266, 290 µs

and also by adding a `print` statement to `_dense_free_module` (so that I know the code is never called). I got similar results by trying this on sage-5.3 + combinat.

Is it possible that the patch file got corrupted, or that it is based on an already modified version of Sage, or that there is an unstated dependency which introduces `_dense_free_module` as a hook?


---

Comment by nthiery created at 2012-10-03 20:57:27

Replying to [comment:9 mguaypaq]:
> Is it possible that the patch file got corrupted

Yikes! Yes, definitely, a hunk (well, THE interesting hunk) was somehow lost in that patch. I can't find it either on the combinat server, so I must have screwed up somewhere. Thanks for catching this! I'll work on this tomorrow morning.

Cheers,
                                  Nicolas

PS: I now better understand Franco's comment about the subtlety of this patch!


---

Attachment


---

Comment by nthiery created at 2012-10-05 16:38:11

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2012-10-05 16:38:11

Done! I could not find back the code, so I rewrote it (and gained another micro second :-))


---

Comment by mguaypaq created at 2012-10-09 03:48:39

Changing status from needs_review to positive_review.


---

Comment by mguaypaq created at 2012-10-09 03:48:39

With the current patch, the code change makes sense, is well documented, and I can reproduce the impressive speedups described in the ticked description on my own machine. Also, the patchbot reports that all tests pass on Sage 5.4.rc1 and that the documentation builds cleanly.


---

Comment by nthiery created at 2012-10-09 09:59:26

Replying to [comment:12 mguaypaq]:
> With the current patch, the code change makes sense, is well documented, and I can reproduce the impressive speedups described in the ticked description on my own machine. Also, the patchbot reports that all tests pass on Sage 5.4.rc1 and that the documentation builds cleanly.

Thanks for the review!


---

Comment by jdemeyer created at 2012-10-17 21:00:36

Resolution: fixed
