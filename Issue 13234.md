# Issue 13234: Optimize CombinatorialFreeModule.Element._vector_

archive/issues_013234.json:
```json
{
    "body": "Assignee: jason, was\n\nCC:  sage-combinat @dwbump @mguaypaq\n\nConverting a `CombinatorialFreeModule` element to a vector (i.e. dense\n`FreeModule` element) was ridiculously slow:\n\nBefore:\n\n```\nsage: F = CombinatorialFreeModule(QQ, range(10))\nsage: f = F.an_element()\nsage: %timeit f._vector_()\n625 loops, best of 3: 142 \u00b5s per loop\nsage: %timeit f.to_vector()\n625 loops, best of 3: 143 \u00b5s per loop\nsage: %timeit vector(f)\n625 loops, best of 3: 159 \u00b5s per loop\n```\n\nAfter:\n\n```\nsage: F = CombinatorialFreeModule(QQ, range(10))\nsage: f = F.an_element()\nsage: %timeit f._vector_()\n625 loops, best of 3: 17.7 \u00b5s per loop\nsage: %timeit f.to_vector()\n625 loops, best of 3: 17.5 \u00b5s per loop\nsage: %timeit vector(f)\n625 loops, best of 3: 34.6 \u00b5s per loop\n```\n\nThis impacts for example Weyl group actions, and thus lots of the root\nsystems arithmetic.\n\nBefore:\n\n```\nsage: W = WeylGroup([\"A\",5])\nsage: %time l = list(W)\nCPU times: user 3.55 s, sys: 0.00 s, total: 3.55 s\nWall time: 3.57 s\n```\n\nAfter:\n\n```\nsage: W = WeylGroup([\"A\",5])\nsage: %time l = list(W)\nCPU times: user 2.80 s, sys: 0.00 s, total: 2.81 s\nWall time: 2.81 s\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13406\n\n",
    "closed_at": "2012-10-17T21:00:36Z",
    "created_at": "2012-08-28T08:31:10Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.5",
    "title": "Optimize CombinatorialFreeModule.Element._vector_",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13234",
    "user": "https://github.com/nthiery"
}
```
Assignee: jason, was

CC:  sage-combinat @dwbump @mguaypaq

Converting a `CombinatorialFreeModule` element to a vector (i.e. dense
`FreeModule` element) was ridiculously slow:

Before:

```
sage: F = CombinatorialFreeModule(QQ, range(10))
sage: f = F.an_element()
sage: %timeit f._vector_()
625 loops, best of 3: 142 µs per loop
sage: %timeit f.to_vector()
625 loops, best of 3: 143 µs per loop
sage: %timeit vector(f)
625 loops, best of 3: 159 µs per loop
```

After:

```
sage: F = CombinatorialFreeModule(QQ, range(10))
sage: f = F.an_element()
sage: %timeit f._vector_()
625 loops, best of 3: 17.7 µs per loop
sage: %timeit f.to_vector()
625 loops, best of 3: 17.5 µs per loop
sage: %timeit vector(f)
625 loops, best of 3: 34.6 µs per loop
```

This impacts for example Weyl group actions, and thus lots of the root
systems arithmetic.

Before:

```
sage: W = WeylGroup(["A",5])
sage: %time l = list(W)
CPU times: user 3.55 s, sys: 0.00 s, total: 3.55 s
Wall time: 3.57 s
```

After:

```
sage: W = WeylGroup(["A",5])
sage: %time l = list(W)
CPU times: user 2.80 s, sys: 0.00 s, total: 2.81 s
Wall time: 2.81 s
```


Issue created by migration from https://trac.sagemath.org/ticket/13406





---

archive/issue_comments_161871.json:
```json
{
    "body": "One suggestion, maybe: use the trac automatic link instead of just #number\n\n```\n:trac:`13406`: the code below has been optimized\n```",
    "created_at": "2012-08-28T09:29:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161871",
    "user": "https://github.com/fchapoton"
}
```

One suggestion, maybe: use the trac automatic link instead of just #number

```
:trac:`13406`: the code below has been optimized
```



---

archive/issue_comments_161872.json:
```json
{
    "body": "Replying to [comment:2 chapoton]:\n> One suggestion, maybe: use the trac automatic link instead of just #number\n> \n> \n> ```\n> :trac:`13406`: the code below has been optimized\n> ```\n\n\nOops, thanks for catching this! Btw I fixed the patch header in the updated patch.",
    "created_at": "2012-08-28T10:06:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161872",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:2 chapoton]:
> One suggestion, maybe: use the trac automatic link instead of just #number
> 
> 
> ```
> :trac:`13406`: the code below has been optimized
> ```


Oops, thanks for catching this! Btw I fixed the patch header in the updated patch.



---

archive/issue_comments_161873.json:
```json
{
    "body": "Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?",
    "created_at": "2012-08-28T13:59:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161873",
    "user": "https://github.com/saliola"
}
```

Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?



---

archive/issue_comments_161874.json:
```json
{
    "body": "Hi Franco,\n\nReplying to [comment:4 saliola]:\n> Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?\n\n\nEssentially, vector(...) is very slow, in particular because it first has to figure out which dense free module F to use. The patch builds that free module once for all (in the _dense_free_module method which is cached). And then it saves a bit more by feeding the data directly to the element class of F, and being careful about the options).",
    "created_at": "2012-08-28T14:36:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161874",
    "user": "https://github.com/nthiery"
}
```

Hi Franco,

Replying to [comment:4 saliola]:
> Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?


Essentially, vector(...) is very slow, in particular because it first has to figure out which dense free module F to use. The patch builds that free module once for all (in the _dense_free_module method which is cached). And then it saves a bit more by feeding the data directly to the element class of F, and being careful about the options).



---

archive/issue_comments_161875.json:
```json
{
    "body": "I'm ready to set a positive review on this, but I can't run doctests on sage-5.3.rc0 currently and the patchbot seems to be sleeping. Can someone run tests, etc.",
    "created_at": "2012-08-28T15:36:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161875",
    "user": "https://github.com/saliola"
}
```

I'm ready to set a positive review on this, but I can't run doctests on sage-5.3.rc0 currently and the patchbot seems to be sleeping. Can someone run tests, etc.



---

archive/issue_comments_161876.json:
```json
{
    "body": "Replying to [comment:5 nthiery]:\n>           Hi Franco,\n\n> \n> Replying to [comment:4 saliola]:\n> > Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?\n\n> \n> Essentially, vector(...) is very slow, in particular because it first has to figure out which dense free module F to use. The patch builds that free module once for all (in the _dense_free_module method which is cached). And then it saves a bit more by feeding the data directly to the element class of F, and being careful about the options).\n\n\nThanks for the explanation, Nicolas. It's very subtle.",
    "created_at": "2012-08-28T15:38:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161876",
    "user": "https://github.com/saliola"
}
```

Replying to [comment:5 nthiery]:
>           Hi Franco,

> 
> Replying to [comment:4 saliola]:
> > Nicolas: I see that the code hasn't changed much, yet you get an impressive speed-up. Can you comment on how/why it happens?

> 
> Essentially, vector(...) is very slow, in particular because it first has to figure out which dense free module F to use. The patch builds that free module once for all (in the _dense_free_module method which is cached). And then it saves a bit more by feeding the data directly to the element class of F, and being careful about the options).


Thanks for the explanation, Nicolas. It's very subtle.



---

archive/issue_comments_161877.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-29T07:39:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161877",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_161878.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-09-28T18:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161878",
    "user": "https://github.com/mguaypaq"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_161879.json:
```json
{
    "body": "As far as I can tell, the patch as posted does not functionally change anything. It changes the documentation of `CombinatorialFreeModuleElement._vector_` without changing the corresponding code, and adds the method `CombinatorialFreeModule._dense_free_module` without adding any code to have it called.\n\nI confirmed this experimentally by getting the following timings on sage-5.3 for the first three tests in the ticket description (`f._vector_()`, `f.to_vector()`, `vector(f)`):\n\nBefore: 270, 270, 293 \u00b5s\n\n\nAfter: 265, 266, 290 \u00b5s\n\nand also by adding a `print` statement to `_dense_free_module` (so that I know the code is never called). I got similar results by trying this on sage-5.3 + combinat.\n\nIs it possible that the patch file got corrupted, or that it is based on an already modified version of Sage, or that there is an unstated dependency which introduces `_dense_free_module` as a hook?",
    "created_at": "2012-09-28T18:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161879",
    "user": "https://github.com/mguaypaq"
}
```

As far as I can tell, the patch as posted does not functionally change anything. It changes the documentation of `CombinatorialFreeModuleElement._vector_` without changing the corresponding code, and adds the method `CombinatorialFreeModule._dense_free_module` without adding any code to have it called.

I confirmed this experimentally by getting the following timings on sage-5.3 for the first three tests in the ticket description (`f._vector_()`, `f.to_vector()`, `vector(f)`):

Before: 270, 270, 293 µs


After: 265, 266, 290 µs

and also by adding a `print` statement to `_dense_free_module` (so that I know the code is never called). I got similar results by trying this on sage-5.3 + combinat.

Is it possible that the patch file got corrupted, or that it is based on an already modified version of Sage, or that there is an unstated dependency which introduces `_dense_free_module` as a hook?



---

archive/issue_comments_161880.json:
```json
{
    "body": "Replying to [comment:9 mguaypaq]:\n> Is it possible that the patch file got corrupted\n\n\nYikes! Yes, definitely, a hunk (well, THE interesting hunk) was somehow lost in that patch. I can't find it either on the combinat server, so I must have screwed up somewhere. Thanks for catching this! I'll work on this tomorrow morning.\n\nCheers,\n                                  Nicolas\n\nPS: I now better understand Franco's comment about the subtlety of this patch!",
    "created_at": "2012-10-03T20:57:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161880",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:9 mguaypaq]:
> Is it possible that the patch file got corrupted


Yikes! Yes, definitely, a hunk (well, THE interesting hunk) was somehow lost in that patch. I can't find it either on the combinat server, so I must have screwed up somewhere. Thanks for catching this! I'll work on this tomorrow morning.

Cheers,
                                  Nicolas

PS: I now better understand Franco's comment about the subtlety of this patch!



---

archive/issue_comments_161881.json:
```json
{
    "body": "Attachment [trac_13406-combinatorial_free_module-optimize_to_vector-nt.patch](tarball://root/attachments/some-uuid/ticket13406/trac_13406-combinatorial_free_module-optimize_to_vector-nt.patch) by @nthiery created at 2012-10-05 16:32:58",
    "created_at": "2012-10-05T16:32:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161881",
    "user": "https://github.com/nthiery"
}
```

Attachment [trac_13406-combinatorial_free_module-optimize_to_vector-nt.patch](tarball://root/attachments/some-uuid/ticket13406/trac_13406-combinatorial_free_module-optimize_to_vector-nt.patch) by @nthiery created at 2012-10-05 16:32:58



---

archive/issue_comments_161882.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-10-05T16:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161882",
    "user": "https://github.com/nthiery"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_161883.json:
```json
{
    "body": "Done! I could not find back the code, so I rewrote it (and gained another micro second :-))",
    "created_at": "2012-10-05T16:38:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161883",
    "user": "https://github.com/nthiery"
}
```

Done! I could not find back the code, so I rewrote it (and gained another micro second :-))



---

archive/issue_comments_161884.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-09T03:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161884",
    "user": "https://github.com/mguaypaq"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_161885.json:
```json
{
    "body": "With the current patch, the code change makes sense, is well documented, and I can reproduce the impressive speedups described in the ticked description on my own machine. Also, the patchbot reports that all tests pass on Sage 5.4.rc1 and that the documentation builds cleanly.",
    "created_at": "2012-10-09T03:48:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161885",
    "user": "https://github.com/mguaypaq"
}
```

With the current patch, the code change makes sense, is well documented, and I can reproduce the impressive speedups described in the ticked description on my own machine. Also, the patchbot reports that all tests pass on Sage 5.4.rc1 and that the documentation builds cleanly.



---

archive/issue_events_037216.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-09T06:35:23Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "milestone": "sage-5.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13234#event-37216"
}
```



---

archive/issue_comments_161886.json:
```json
{
    "body": "Replying to [comment:12 mguaypaq]:\n> With the current patch, the code change makes sense, is well documented, and I can reproduce the impressive speedups described in the ticked description on my own machine. Also, the patchbot reports that all tests pass on Sage 5.4.rc1 and that the documentation builds cleanly.\n\n\nThanks for the review!",
    "created_at": "2012-10-09T09:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161886",
    "user": "https://github.com/nthiery"
}
```

Replying to [comment:12 mguaypaq]:
> With the current patch, the code change makes sense, is well documented, and I can reproduce the impressive speedups described in the ticked description on my own machine. Also, the patchbot reports that all tests pass on Sage 5.4.rc1 and that the documentation builds cleanly.


Thanks for the review!



---

archive/issue_comments_161887.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-10-17T21:00:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13234#issuecomment-161887",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_037217.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-10-17T21:00:36Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13234",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13234#event-37217"
}
```
