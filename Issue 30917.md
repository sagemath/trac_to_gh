# Issue 30917: Report distances in Breadth First Search in c_graph.pyx

Issue created by migration from https://trac.sagemath.org/ticket/31154

Original creator: @kliem

Original creation time: 2021-01-02 16:54:38

CC:  dcoudert

Keywords: graphs, BFS, distances

Currently, reporting of distances is reported in the python implementation only. We enable this in the cython implementation in `c_graph.pyx`.

To compare:


```
sage: def comp(): 
....:     for n in [5, 10, 50, 100, 500, 1000]:  
....:         G = graphs.Grid2dGraph(n, n)  
....:         print(G) 
....:         %timeit _ = list(G.breadth_first_search(start=(0, 0), report_distance=False)) 
....:         %timeit _ = list(G.breadth_first_search(start=(0, 0), report_distance=True)) 
```


Before:


```                                                                                                                                                                          
sage: comp()                                                                                                                                                                                                                                                                                                                                                               
2D Grid Graph for [5, 5]
5.69 µs ± 67 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
36.3 µs ± 67 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
2D Grid Graph for [10, 10]
16.2 µs ± 22.8 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
143 µs ± 945 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
2D Grid Graph for [50, 50]
492 µs ± 5.91 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
4.32 ms ± 48.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
2D Grid Graph for [100, 100]
2.68 ms ± 24.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
18.6 ms ± 81.1 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
2D Grid Graph for [500, 500]
89.4 ms ± 665 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
655 ms ± 4.93 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
2D Grid Graph for [1000, 1000]
452 ms ± 5.52 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
3.26 s ± 57.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


After:

```
sage: comp()                                                                                                                                                                                                                                                                                                                                                               
2D Grid Graph for [5, 5]
5.48 µs ± 7.2 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
5.49 µs ± 18.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
2D Grid Graph for [10, 10]
15.2 µs ± 35.3 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
15.3 µs ± 95.4 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
2D Grid Graph for [50, 50]
449 µs ± 1.61 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
450 µs ± 2.84 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
2D Grid Graph for [100, 100]
2.51 ms ± 16.7 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
2.53 ms ± 39.1 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
2D Grid Graph for [500, 500]
85.4 ms ± 301 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
85 ms ± 109 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
2D Grid Graph for [1000, 1000]
431 ms ± 6.59 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
433 ms ± 10 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```


The small improvement in the first case is due to using `yield from`.


---

Comment by @kliem created at 2021-01-02 16:54:45

Changing status from new to needs_review.


---

Comment by dcoudert created at 2021-01-02 17:35:31

It's nice that the extra cost of pushing pairs even when `report_distance` is `False` is compensated by the `yield from...`.

We could also report edges. It suffices to store in second the parent in the BFS instead of the distance. The extra cost of testing if `edges` is true before pushing to the queue is rather limited.


---

Comment by dcoudert created at 2021-01-02 17:57:27

Why are you using `smallInteger` for distances ? does it really make a difference ?


---

Comment by @kliem created at 2021-01-02 18:22:42

Actually, I can't measure a difference for pushing pairs or not. It doesn't seem to make a difference at all. After all it's super easy C stuff (if you try to push a tuple as a pair and hope for cython to do the right thing, that is going to make a difference in the wrong way).

`yield from` is a bit fast that's it.


---

Comment by @kliem created at 2021-01-02 18:35:26

Replying to [comment:3 dcoudert]:
> Why are you using `smallInteger` for distances ? does it really make a difference ?

`Integer` is lots slower. `smallInteger` is exactly for this use case. Creating an integer from an `int/long`.

Timings with replacing `smallInteger` by `Integer`:

```
sage: comp()                                                                                                                                                                                                                                                                                                                                                               
2D Grid Graph for [5, 5]
5.67 µs ± 254 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
8.34 µs ± 114 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
2D Grid Graph for [10, 10]
15.9 µs ± 73.5 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
26.1 µs ± 98.9 ns per loop (mean ± std. dev. of 7 runs, 10000 loops each)
2D Grid Graph for [50, 50]
470 µs ± 6.86 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
1.09 ms ± 8.04 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
2D Grid Graph for [100, 100]
2.59 ms ± 20.5 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
5.8 ms ± 8.76 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
2D Grid Graph for [500, 500]
91.1 ms ± 1.26 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
182 ms ± 638 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
2D Grid Graph for [1000, 1000]
445 ms ± 9.32 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
734 ms ± 9.12 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```



---

Comment by @kliem created at 2021-01-02 18:40:23

The distance assume weight 1 for each edge.

Is there any use case in having the distances and the edges? Currently `report_distance` is ignored when `edges` is true.


---

Comment by dcoudert created at 2021-01-02 18:45:24

`smallInteger`: this is good to know

report distances and edges: we can certainly find a use case where it is useful to return both. Is it slower to push tuples instead of pairs ?


---

Comment by @kliem created at 2021-01-02 19:26:25

Replying to [comment:7 dcoudert]:
> `smallInteger`: this is good to know

I was told on my very first ticket about it.
> 
> report distances and edges: we can certainly find a use case where it is useful to return both. Is it slower to push tuples instead of pairs ?

I'll try.


---

Comment by @kliem created at 2021-01-02 21:06:13

Apparently, I took the timings in some intermediate step where `report_distances=True` did not do anything. Things are slower now, but `smallInteger` is still better than `Integer`.


---

Comment by @kliem created at 2021-01-02 21:13:13

Replying to [comment:4 gh-kliem]:
> Actually, I can't measure a difference for pushing pairs or not. It doesn't seem to make a difference at all. After all it's super easy C stuff (if you try to push a tuple as a pair and hope for cython to do the right thing, that is going to make a difference in the wrong way).
> 
> `yield from` is a bit fast that's it.

Actually you are right, there is a small penalty for pushing pairs. Something like 5 percent.


---

Comment by git created at 2021-01-02 21:39:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-02 21:40:12

Slighly better by simplifying things.
----
New commits:


---

Comment by dcoudert created at 2021-01-02 22:20:02

I like the way you count maintain the distance. it's smart.

What is surprising is that reporting distance takes roughly 30% more time. The only difference in the code is in the return statement.


---

Comment by git created at 2021-01-02 22:34:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-02 22:42:33

Replying to [comment:13 dcoudert]:
> I like the way you count maintain the distance. it's smart.
> 
> What is surprising is that reporting distance takes roughly 30% more time. The only difference in the code is in the return statement. 

Now that you point this out, I find it surprisingly to.

However, I believe this is out of reach:


```
sage: cython(''' 
....: def tester(int n): 
....:     cdef int i 
....:     for i in range(n): 
....:         yield i 
....:          
....: def tester2(int n): 
....:     cdef int i 
....:     for i in range(n): 
....:         yield (i, 1) 
....: ''')                                                                                                                                                                                                                                                                                                                                                                 

sage:                                                                                                                                                                                                                                                                                                                                                                      
sage: %timeit list(tester(100))                                                                                                                                                                                                                                                                                                                                            
2.3 µs ± 15.9 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit list(tester2(100))                                                                                                                                                                                                                                                                                                                                           
3.97 µs ± 5.07 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit list(tester(200))                                                                                                                                                                                                                                                                                                                                            
4.15 µs ± 29.6 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
sage: %timeit list(tester2(200))                                                                                                                                                                                                                                                                                                                                           
7.94 µs ± 52.7 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)
```



---

Comment by dcoudert created at 2021-01-03 09:30:12

I agree. We already have a huge speedup. 

Some details, missing `:` (several times):

```diff
-        - ``report_distance`` -- boolean (default ``False``); if ``True``,
+        - ``report_distance`` -- boolean (default: ``False``); if ``True``,
```



```diff
-        - ``edges`` -- boolean (default ``False``); whether to return the edges
+        - ``edges`` -- boolean (default: ``False``); whether to return the edges
```



---

Comment by git created at 2021-01-03 20:43:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-01-03 20:45:51

Replying to [comment:17 dcoudert]:
> I agree. We already have a huge speedup. 
> 
> Some details, missing `:` (several times):
> {{{#!diff
> -        - ``report_distance`` -- boolean (default ``False``); if ``True``,
> +        - ``report_distance`` -- boolean (default: ``False``); if ``True``,
> }}}
> 
> {{{#!diff
> -        - ``edges`` -- boolean (default ``False``); whether to return the edges
> +        - ``edges`` -- boolean (default: ``False``); whether to return the edges
> }}}

Copy/paste. Changed it for every instance in the touched files.


---

Comment by dcoudert created at 2021-01-03 22:02:46

LGTM. Thank you !


---

Comment by dcoudert created at 2021-01-03 22:02:46

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-01-06 09:33:28

Thanks for reviewing.


---

Comment by vbraun created at 2021-01-17 13:45:51

Resolution: fixed
