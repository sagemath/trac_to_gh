# Issue 26504: MPolynomialRing_polydict hardcodes its elements

archive/issues_026504.json:
```json
{
    "body": "CC:  jdemeyer\n\nKeywords: polynomial ring, Element\n\nCurrently `MPolynomialRing_polydict` hardcodes `MPolynomial_polydict` as its element by calling it directly inside its `__call__` method (and also in its `monomial_quotient` method). This makes inheritance difficult.\n\nThe aim of this ticket is to replace this behaviour by defining `Element` and\nusing `element_class` to construct elements when needed.\n\nThe code in the attached branch does exactly this but it seems to mess up with\nthe coercion mechanism.\n\nVanilla:\n\n```\nsage: R1 = PolynomialRing(QQbar,2,'x'); R1\nMultivariate Polynomial Ring in x0, x1 over Algebraic Field\nsage: R2 = PolynomialRing(QQbar,3,'x'); R2\nMultivariate Polynomial Ring in x0, x1, x2 over Algebraic Field\nsage: R1.gen(0) + R2.gen(0)\n2*x0\nsage: R2.has_coerce_map_from(R1)\nTrue\n```\n\n\nWith the patch:\n\n```\nsage: R1 = PolynomialRing(QQbar,2,'x'); R1\nMultivariate Polynomial Ring in x0, x1 over Algebraic Field\nsage: R2 = PolynomialRing(QQbar,3,'x'); R2\nMultivariate Polynomial Ring in x0, x1, x2 over Algebraic Field\nsage: R1.gen(0) + R2.gen(0)\nTraceback (most recent call last)\n...\nTypeError: unsupported operand parent(s) for +: 'Multivariate Polynomial Ring in x0, x1 over Algebraic Field' and 'Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field'\nsage: R2.has_coerce_map_from(R1)\nFalse\n```\n\n\nAs a result several doctest fail. Any idea on what might be going wrong?\n\nIssue created by migration from https://trac.sagemath.org/ticket/26741\n\n",
    "created_at": "2018-11-22T14:58:49Z",
    "labels": [
        "algebra",
        "major",
        "enhancement"
    ],
    "title": "MPolynomialRing_polydict hardcodes its elements",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26504",
    "user": "etn40ff"
}
```
CC:  jdemeyer

Keywords: polynomial ring, Element

Currently `MPolynomialRing_polydict` hardcodes `MPolynomial_polydict` as its element by calling it directly inside its `__call__` method (and also in its `monomial_quotient` method). This makes inheritance difficult.

The aim of this ticket is to replace this behaviour by defining `Element` and
using `element_class` to construct elements when needed.

The code in the attached branch does exactly this but it seems to mess up with
the coercion mechanism.

Vanilla:

```
sage: R1 = PolynomialRing(QQbar,2,'x'); R1
Multivariate Polynomial Ring in x0, x1 over Algebraic Field
sage: R2 = PolynomialRing(QQbar,3,'x'); R2
Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field
sage: R1.gen(0) + R2.gen(0)
2*x0
sage: R2.has_coerce_map_from(R1)
True
```


With the patch:

```
sage: R1 = PolynomialRing(QQbar,2,'x'); R1
Multivariate Polynomial Ring in x0, x1 over Algebraic Field
sage: R2 = PolynomialRing(QQbar,3,'x'); R2
Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field
sage: R1.gen(0) + R2.gen(0)
Traceback (most recent call last)
...
TypeError: unsupported operand parent(s) for +: 'Multivariate Polynomial Ring in x0, x1 over Algebraic Field' and 'Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field'
sage: R2.has_coerce_map_from(R1)
False
```


As a result several doctest fail. Any idea on what might be going wrong?

Issue created by migration from https://trac.sagemath.org/ticket/26741





---

archive/issue_comments_372744.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-22T22:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372744",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372745.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-22T22:44:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372745",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372746.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T13:58:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372746",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372747.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T14:26:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372747",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372748.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T14:55:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372748",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372749.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T15:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372749",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372750.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T16:11:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372750",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372751.json:
```json
{
    "body": "I think that the change in commit [b7004e6](https://git.sagemath.org/sage.git/commit?id=b7004e678cb8c9c21b2e31ea0204e976fbe670da) is due to some numerical error, I have\nno idea where it comes from. Can anyone comment on this?",
    "created_at": "2018-11-23T16:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372751",
    "user": "etn40ff"
}
```

I think that the change in commit [b7004e6](https://git.sagemath.org/sage.git/commit?id=b7004e678cb8c9c21b2e31ea0204e976fbe670da) is due to some numerical error, I have
no idea where it comes from. Can anyone comment on this?



---

archive/issue_comments_372752.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-23T16:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372752",
    "user": "etn40ff"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_372753.json:
```json
{
    "body": "It might be due to some change in the coercion framework. However, I am a little worried about the addition of `_coerce_map_from_` having changed some of the allowed coercions. Might be good to cc Jeroen since he has done some work on that. Independently, `_coerce_map_from_` needs doctests.\n\nAlso, it is better to do\n\n```diff\n             if x == 0:\n-                return self(0)\n+                return self.zero()\n```\n\nas it avoids recreating the zero element and going through the coercion framework.",
    "created_at": "2018-11-23T17:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372753",
    "user": "tscrim"
}
```

It might be due to some change in the coercion framework. However, I am a little worried about the addition of `_coerce_map_from_` having changed some of the allowed coercions. Might be good to cc Jeroen since he has done some work on that. Independently, `_coerce_map_from_` needs doctests.

Also, it is better to do

```diff
             if x == 0:
-                return self(0)
+                return self.zero()
```

as it avoids recreating the zero element and going through the coercion framework.



---

archive/issue_comments_372754.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T17:14:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372754",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372755.json:
```json
{
    "body": "Done and added Jeroen in CC.\n\nI will take care of doctesting `_coerce_map_from_` soon.\n\nThanks fo the fast comment",
    "created_at": "2018-11-23T17:16:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372755",
    "user": "etn40ff"
}
```

Done and added Jeroen in CC.

I will take care of doctesting `_coerce_map_from_` soon.

Thanks fo the fast comment



---

archive/issue_comments_372756.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-23T17:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372756",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372757.json:
```json
{
    "body": "A patchbot reported some failures on magma. I do not have a magma licence so I can't fix those.",
    "created_at": "2018-11-23T18:20:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372757",
    "user": "etn40ff"
}
```

A patchbot reported some failures on magma. I do not have a magma licence so I can't fix those.



---

archive/issue_comments_372758.json:
```json
{
    "body": "The 6 magma failures on the fermat patchbot are systematic, and not related to this ticket. You can safely ignore them.",
    "created_at": "2018-11-23T19:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372758",
    "user": "chapoton"
}
```

The 6 magma failures on the fermat patchbot are systematic, and not related to this ticket. You can safely ignore them.



---

archive/issue_comments_372759.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-25T09:34:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372759",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_372760.json:
```json
{
    "body": "It seems to me that this is mostly a duplicate of #25558 (but only for `MPolynomialRing_polydict` instead of all polynomial rings): something which is very much needed but a much bigger can of worms than I initially estimated. I mostly forgot about that ticket though.\n\nI won't have much time the coming weeks to work on this. If you're going to push through with this, I would rather suggest to do it properly, meaning:\n\n- think about which coercions should be allowed. Currently this is very ad hoc, there is no real theory. Clearly document which coercions between polynomial rings exist.\n- whatever you do, do it for all polynomial rings, not only `MPolynomialRing_polydict`.",
    "created_at": "2018-12-18T13:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372760",
    "user": "jdemeyer"
}
```

It seems to me that this is mostly a duplicate of #25558 (but only for `MPolynomialRing_polydict` instead of all polynomial rings): something which is very much needed but a much bigger can of worms than I initially estimated. I mostly forgot about that ticket though.

I won't have much time the coming weeks to work on this. If you're going to push through with this, I would rather suggest to do it properly, meaning:

- think about which coercions should be allowed. Currently this is very ad hoc, there is no real theory. Clearly document which coercions between polynomial rings exist.
- whatever you do, do it for all polynomial rings, not only `MPolynomialRing_polydict`.



---

archive/issue_comments_372761.json:
```json
{
    "body": "Indeed #25558 seems to cover this.\n\nThat ticket is quite a mouthful though. I would be willing to help with it but I do not feel qualified to take the relevant design decisions on my own. I could use some guidance from someone more familiar with the polynomial framework than I am.",
    "created_at": "2018-12-18T22:53:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372761",
    "user": "etn40ff"
}
```

Indeed #25558 seems to cover this.

That ticket is quite a mouthful though. I would be willing to help with it but I do not feel qualified to take the relevant design decisions on my own. I could use some guidance from someone more familiar with the polynomial framework than I am.



---

archive/issue_comments_372762.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-05-27T07:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372762",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_372763.json:
```json
{
    "body": "red branch => needs work",
    "created_at": "2019-05-27T07:04:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26504#issuecomment-372763",
    "user": "chapoton"
}
```

red branch => needs work
