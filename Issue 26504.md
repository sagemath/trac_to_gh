# Issue 26504: MPolynomialRing_polydict hardcodes its elements

Issue created by migration from Trac.

Original creator: etn40ff

Original creation time: 2018-11-22 14:58:49

CC:  jdemeyer

Keywords: polynomial ring, Element

Currently `MPolynomialRing_polydict` hardcodes `MPolynomial_polydict` as its element by calling it directly inside its `__call__` method (and also in its `monomial_quotient` method). This makes inheritance difficult.

The aim of this ticket is to replace this behaviour by defining `Element` and
using `element_class` to construct elements when needed.

The code in the attached branch does exactly this but it seems to mess up with
the coercion mechanism.

Vanilla:

```
sage: R1 = PolynomialRing(QQbar,2,'x'); R1
Multivariate Polynomial Ring in x0, x1 over Algebraic Field
sage: R2 = PolynomialRing(QQbar,3,'x'); R2
Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field
sage: R1.gen(0) + R2.gen(0)
2*x0
sage: R2.has_coerce_map_from(R1)
True
```


With the patch:

```
sage: R1 = PolynomialRing(QQbar,2,'x'); R1
Multivariate Polynomial Ring in x0, x1 over Algebraic Field
sage: R2 = PolynomialRing(QQbar,3,'x'); R2
Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field
sage: R1.gen(0) + R2.gen(0)
Traceback (most recent call last)
...
TypeError: unsupported operand parent(s) for +: 'Multivariate Polynomial Ring in x0, x1 over Algebraic Field' and 'Multivariate Polynomial Ring in x0, x1, x2 over Algebraic Field'
sage: R2.has_coerce_map_from(R1)
False
```


As a result several doctest fail. Any idea on what might be going wrong?


---

Comment by git created at 2018-11-22 22:35:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-22 22:44:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-23 13:58:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-23 14:26:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-23 14:55:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-23 15:47:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-11-23 16:11:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by etn40ff created at 2018-11-23 16:25:59

I think that the change in commit [b7004e6](https://git.sagemath.org/sage.git/commit?id=b7004e678cb8c9c21b2e31ea0204e976fbe670da) is due to some numerical error, I have
no idea where it comes from. Can anyone comment on this?


---

Comment by etn40ff created at 2018-11-23 16:25:59

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-11-23 17:05:51

It might be due to some change in the coercion framework. However, I am a little worried about the addition of `_coerce_map_from_` having changed some of the allowed coercions. Might be good to cc Jeroen since he has done some work on that. Independently, `_coerce_map_from_` needs doctests.

Also, it is better to do

```diff
             if x == 0:
-                return self(0)
+                return self.zero()
```

as it avoids recreating the zero element and going through the coercion framework.


---

Comment by git created at 2018-11-23 17:14:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by etn40ff created at 2018-11-23 17:16:28

Done and added Jeroen in CC.

I will take care of doctesting `_coerce_map_from_` soon.

Thanks fo the fast comment


---

Comment by git created at 2018-11-23 17:28:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by etn40ff created at 2018-11-23 18:20:31

A patchbot reported some failures on magma. I do not have a magma licence so I can't fix those.


---

Comment by chapoton created at 2018-11-23 19:16:41

The 6 magma failures on the fermat patchbot are systematic, and not related to this ticket. You can safely ignore them.


---

Comment by git created at 2018-11-25 09:34:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-12-18 13:36:33

It seems to me that this is mostly a duplicate of #25558 (but only for `MPolynomialRing_polydict` instead of all polynomial rings): something which is very much needed but a much bigger can of worms than I initially estimated. I mostly forgot about that ticket though.

I won't have much time the coming weeks to work on this. If you're going to push through with this, I would rather suggest to do it properly, meaning:

- think about which coercions should be allowed. Currently this is very ad hoc, there is no real theory. Clearly document which coercions between polynomial rings exist.
- whatever you do, do it for all polynomial rings, not only `MPolynomialRing_polydict`.


---

Comment by etn40ff created at 2018-12-18 22:53:58

Indeed #25558 seems to cover this.

That ticket is quite a mouthful though. I would be willing to help with it but I do not feel qualified to take the relevant design decisions on my own. I could use some guidance from someone more familiar with the polynomial framework than I am.


---

Comment by chapoton created at 2019-05-27 07:04:49

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-05-27 07:04:49

red branch => needs work
