# Issue 33293: Upgrade ipython to 8.x - requires dropping python 3.7

Issue created by migration from https://trac.sagemath.org/ticket/33530

Original creator: mkoeppe

Original creation time: 2022-03-19 01:22:53

CC:  arojas @collares tornaria fbissey egourgoulhon culler dunfield dimpase

ipython 8.0 dropped support for Python 3.7 - https://ipython.readthedocs.io/en/stable/whatsnew/version8.html


---

Comment by mkoeppe created at 2022-04-21 01:51:07


```
[entrypoints-0.4] ERROR: Directory '.' is not installable. Neither 'setup.py' nor 'pyproject.toml' found.
[beautifulsoup4-4.11.1]   /Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/beautifulsoup4-4.11.1/src/bs4/element.py:15: UserWarning: The soupsieve package is not installed. CSS selectors cannot be used.
[beautifulsoup4-4.11.1] ERROR: Could not find a version that satisfies the requirement soupsieve>1.2 (from beautifulsoup4) (from versions: none)
[attrs-21.4.0] WARNING: Ignoring invalid distribution -leach (/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages)
[argon2_cffi-21.3.0] ERROR: Could not find a version that satisfies the requirement argon2-cffi-bindings (from argon2-cffi) (from versions: none)
[argon2_cffi-21.3.0] Warning: The installation needed to use "--no-deps --ignore-installed --ignore-requires-python" to succeed. This means that a dependencies file in build/pkgs/ needs to be updated. Please report this to sage-devel@googlegroups.com, including the build log of this package.
[idna-3.3] requests 2.26.0 requires charset-normalizer~=2.0.0; python_version >= "3", which is not installed.
[appnope-0.1.3] ipython 7.29.0 requires decorator, which is not installed.
[appnope-0.1.3] ipython 7.29.0 requires prompt-toolkit!=3.0.0,!=3.0.1,<3.1.0,>=2.0.0, which is not installed.
[appnope-0.1.3] ipython 7.29.0 requires pygments, which is not installed.
[bleach-5.0.0] nbconvert 6.4.4 requires beautifulsoup4, which is not installed.
[bleach-5.0.0] nbconvert 6.4.4 requires entrypoints>=0.2.2, which is not installed.
[bleach-5.0.0] nbconvert 6.4.4 requires pygments>=2.4.1, which is not installed.
```

----
Last 10 new commits:


---

Comment by mkoeppe created at 2022-04-21 02:13:34

After adding dependency `soupsieve`:

```
[soupsieve-2.3.2.post1] ModuleNotFoundError: No module named 'hatchling'
```

Also

```
[testpath-0.6.0] ERROR: Directory '.' is not installable. Neither 'setup.py' nor 'pyproject.toml' found.
[jupyterlab_pygments-0.2.2] ModuleNotFoundError: No module named 'jupyter_packaging'
[tzlocal-4.2] ERROR: Could not find a version that satisfies the requirement pytz-deprecation-shim (from tzlocal) (from versions: none)
```



---

Comment by mkoeppe created at 2022-04-21 02:16:16

Backing out the update of `beautifulsoup4`, `argon2_cffi`, `jupyterlab_widgets`


---

Comment by git created at 2022-04-21 02:22:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-04-21 02:39:07


```
[nbformat-5.3.0] ERROR: Could not find a version that satisfies the requirement fastjsonschema (from nbformat) (from versions: none)
[tzlocal-4.2] ERROR: Could not find a version that satisfies the requirement pytz-deprecation-shim (from tzlocal) (from versions: none)
```



---

Comment by git created at 2022-04-21 02:41:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-04-21 02:59:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-21 02:59:33


```
[nbconvert-6.5.0] ERROR: Could not find a version that satisfies the requirement MarkupSafe>=2.0 (from nbconvert) (from versions: 1.1.1)
[nbconvert-6.5.0] ERROR: No matching distribution found for MarkupSafe>=2.0
```

----
New commits:


---

Comment by git created at 2022-04-21 03:01:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-21 03:19:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-04-21 03:23:06


```
[ipykernel-6.13.0] Applying patches from ../patches...
[ipykernel-6.13.0] Applying ../patches/debugpy-make-optional.patch
[ipykernel-6.13.0] patching file pyproject.toml
[ipykernel-6.13.0] patching file setup.py
[ipykernel-6.13.0] Hunk #1 FAILED at 63.
[ipykernel-6.13.0] 1 out of 1 hunk FAILED -- saving rejects to file setup.py.rej
[ipykernel-6.13.0] Error applying '../patches/debugpy-make-optional.patch'
```

The patch from #33020 needs updating


---

Comment by git created at 2022-04-21 03:45:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-04-21 03:45:59

Backed out the ipykernel update for now.


---

Comment by mkoeppe created at 2022-04-21 04:02:52


```
[notebook-6.4.11] ERROR: Could not find a version that satisfies the requirement tinycss2 (from nbconvert) (from versions: none)
```



---

Comment by git created at 2022-04-21 04:04:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-04-21 04:05:15

Backed out the nbconvert update


---

Comment by git created at 2022-04-21 04:19:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-21 04:20:47


```
[nbconvert-6.5.0] ERROR: Could not find a version that satisfies the requirement jinja2>=3.0 (from nbconvert) (from versions: 2.11.2)
```



---

Comment by git created at 2022-04-21 05:21:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-29 18:28:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-04-30 02:57:53

Changing status from new to needs_review.


---

Comment by git created at 2022-05-27 02:09:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-05-27 02:18:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-05-27 03:11:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-26 18:43:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-26 18:51:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-26 20:01:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2022-06-26 22:20:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-06-27 17:49:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2022-06-27 17:55:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-27 17:57:15

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-06-27 18:09:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-27 18:15:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-06-27 20:01:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-27 20:02:39

Some more changes so that also `make jupyterlab_widgets` does not have to upgrade packages


---

Comment by git created at 2022-06-27 20:41:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-27 23:00:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-28 00:39:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-06-28 06:47:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by culler created at 2022-06-29 22:40:37

This is a heads-up that this change will break the macOS Sage binary package.
That package includes prompt-toolkit 2 because prompt-toolkit 3, which started using the asyncio module for its event loops, does not work correctly with Tk.  IPython 8 currently generates exceptions when used with prompt-toolkit 2.  It appears that the IPython developers do not intend to fix this.


---

Comment by mkoeppe created at 2022-06-29 22:48:24

The release that we are updating to, ipython 8.4.0, still allows prompt_toolkit 2.0 according to https://github.com/ipython/ipython/blob/8.4.0/setup.cfg#L40

(edit: https://github.com/ipython/ipython/pull/13677 restricts it to propt_toolkit 3)


---

Comment by mkoeppe created at 2022-06-29 22:51:58

Oh, I see / remember https://github.com/ipython/ipython/issues/13645 now.


---

Comment by mkoeppe created at 2022-06-29 22:56:35

Is there any ipython 8.x version that works correctly with prompt-toolkit 2?


---

Comment by mkoeppe created at 2022-06-29 23:13:39

I guess we can carry a patch for ipython that fixes up the issue with the `_loaded` attribute or something like this.
https://github.com/ipython/ipython/issues/13645#issuecomment-1107883939


---

Comment by jhpalmieri created at 2022-06-29 23:26:48

I'm seeing warnings in docbuilding:

```
Could not import extension jupyter_sphinx (exception: No module named 'fastjsonschema')
```

I don't know if this is related, but the installation of `notebook` hung: the log file ends with

```
https://mirror.aarnet.edu.au/pub/sage/spkg/upstream/notebook/notebook-6.4.12.tar.gz
[
```

(Shouldn't it time-out and then proceed to the next mirror?) Anyway, would `notebook` or a package that depends on it install `fastjsonschema`? If so, `sagemath_doc_html` should depend on that.


---

Comment by mkoeppe created at 2022-06-29 23:29:32

Replying to [comment:55 jhpalmieri]:
> the installation of `notebook` hung: the log file ends with
> {{{
> https://mirror.aarnet.edu.au/pub/sage/spkg/upstream/notebook/notebook-6.4.12.tar.gz
> [
> }}}
> (Shouldn't it time-out and then proceed to the next mirror?)

It should; but I think I occasionally also see such hangups in the GH Actions runs.


---

Comment by mkoeppe created at 2022-06-29 23:36:57

Replying to [comment:55 jhpalmieri]:
> I'm seeing warnings in docbuilding:
> {{{
> Could not import extension jupyter_sphinx (exception: No module named 'fastjsonschema')
> }}}

I think this is a new nbformat dep that I forgot about (or dropped by mistake again)


---

Comment by mkoeppe created at 2022-06-29 23:37:02

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2022-06-29 23:46:00

I also see this in the `sagelib` log file:

```
INFO: Disabling color, you really want to install colorlog.
```

and also

```
INFO: Pythran support for package 'scipy' will be reduced: this module is not available at runtime.
```

The second one can probably be fixed if `scipy` is made into a dependency of `sagelib`. Do we really want to install colorlog?


---

Comment by mkoeppe created at 2022-06-29 23:48:46

These two are not new from this ticket. I don't have an immediate interest in `colorlog`. I think (but haven't investigated the details) that the pythran support does not matter to us during the compilation of sagelib.


---

Comment by git created at 2022-06-29 23:49:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-29 23:50:28

I think this fixes comment:57 but my docbuild hasn't yet run through


---

Comment by mkoeppe created at 2022-06-30 00:06:12

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-06-30 01:58:54

I see doctest failures:

```
sage -t --random-seed=40701510628761718232931312764279214628 src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 146, in sage.misc.package.pip_installed_packages
Failed example:
    'scipy' in d  # optional - sage_spkg
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/misc/package.py", line 148, in sage.misc.package.pip_installed_packages
Failed example:
    d['scipy']  # optional - sage_spkg
Exception raised:
    Traceback (most recent call last):
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta3/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.7.beta3/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.pip_installed_packages[3]>", line 1, in <module>
        d['scipy']  # optional - sage_spkg
    KeyError: 'scipy'
```



---

Comment by jhpalmieri created at 2022-06-30 02:01:06

And what about the MacOS binary issue (comment:50)?


---

Comment by @GMS103 created at 2022-06-30 03:02:39

I only get 2 failures, the same as John.


---

Comment by jhpalmieri created at 2022-06-30 03:31:50

I see, the key in the dictionary `pip_installed_packages()` is now `SciPy` rather than `scipy`. A change like this might work:

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 783626d824..319aac4406 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -142,7 +142,7 @@ def pip_installed_packages(normalization=None):
     EXAMPLES::
 
         sage: from sage.misc.package import pip_installed_packages
-        sage: d = pip_installed_packages()  # optional - sage_spkg
+        sage: d = pip_installed_packages('spkg')  # optional - sage_spkg
         sage: 'scipy' in d  # optional - sage_spkg
         True
         sage: d['scipy']  # optional - sage_spkg
```



---

Comment by jhpalmieri created at 2022-06-30 03:35:18

No, sorry, this change:

```diff
diff --git a/src/sage/misc/package.py b/src/sage/misc/package.py
index 783626d824..359d1121e4 100644
--- a/src/sage/misc/package.py
+++ b/src/sage/misc/package.py
@@ -143,15 +143,15 @@ def pip_installed_packages(normalization=None):
 
         sage: from sage.misc.package import pip_installed_packages
         sage: d = pip_installed_packages()  # optional - sage_spkg
-        sage: 'scipy' in d  # optional - sage_spkg
-        True
-        sage: d['scipy']  # optional - sage_spkg
-        '...'
         sage: d['beautifulsoup4']   # optional - sage_spkg beautifulsoup4
         '...'
         sage: d['prompt-toolkit']   # optional - sage_spkg
         '...'
         sage: d = pip_installed_packages(normalization='spkg')  # optional - sage_spkg
+        sage: 'scipy' in d  # optional - sage_spkg
+        True
+        sage: d['scipy']  # optional - sage_spkg
+        '...'
         sage: d['prompt_toolkit']   # optional - sage_spkg
         '...'
 
```



---

Comment by jhpalmieri created at 2022-06-30 04:31:21

Or we could change to `d['SciPy']` — I don't know which is a better approach. I don't know where the change is coming from. The `pip` upgrade?


---

Comment by jhpalmieri created at 2022-06-30 04:39:30

Yes, I think these are due to #33866; reported there.


---

Comment by git created at 2022-06-30 18:25:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-06-30 18:43:19

Replying to [comment:50 culler]:
> This is a heads-up that this change will break the macOS Sage binary package.
> That package includes prompt-toolkit 2 because prompt-toolkit 3, which started using the asyncio module for its event loops, does not work correctly with Tk.  IPython 8 currently generates exceptions when used with prompt-toolkit 2.  It appears that the IPython developers do not intend to fix this.

I just checked that `./sage -pip install 'ipython<8' 'prompt-toolkit<3'` succeeds without having to downgrade any other packages. So adding these constraints (I think you already use `prompt-toolkit<3`) to the *snappy* package would be an easy workaround for you.


---

Comment by jhpalmieri created at 2022-06-30 19:44:03

Tests now pass and it looks good in brief testing, both command-line and notebook. Others should test it, too.


---

Comment by mkoeppe created at 2022-06-30 21:01:33

Thanks for testing!


---

Comment by arojas created at 2022-07-02 13:29:56

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2022-07-02 13:29:56

The `jupyter_jsmol` update breaks jsmol in the notebook, because the extension changed its name from `jupyter_jsmol` to `jupyter-jsmol`. The path needs to be updated accordingly in `sage/repl/display/jsmol_iframe.py`


---

Comment by git created at 2022-07-02 17:27:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-02 17:27:57

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-07-11 22:57:02

Changing priority from major to critical.


---

Comment by mkoeppe created at 2022-07-14 16:40:36

Let's get this in please before all updates are outdated


---

Comment by fbissey created at 2022-07-14 19:19:01

It'll be fine. sage-on-gentoo default to ipython 8 already without a problem. There's only that pesky jupyter_jsmol that I need to be careful of.


---

Comment by fbissey created at 2022-07-14 19:19:01

Changing status from needs_review to positive_review.


---

Comment by @GMS103 created at 2022-07-14 20:13:19

I am not sure this is relevant for this ticket, but for me `make pyparsing` fails persistently (unable to download package `pyparsing-3.0.9.tar.gz` from mirrors).

Log attached.


---

Attachment


---

Comment by mkoeppe created at 2022-07-14 20:21:24

You'll need `configure --enable-download-from-upstream-url`


---

Comment by @GMS103 created at 2022-07-14 21:35:43

Replying to [comment:83 mkoeppe]:
> You'll need `configure --enable-download-from-upstream-url`

I did do it.

Now it is working (after the 29th mirror):

```
https://github.com/pyparsing/pyparsing/releases/download/pyparsing_3.0.9/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.lyrahosting.com/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://www-ftp.lip6.fr/pub/math/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.koddos.net/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.up.pt/pub/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.dogado.de/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://ftp.rediris.es/mirror/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.mit.edu/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.aliyun.com/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.yandex.ru/mirrors/sage.math.washington.edu/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://www.mirrorservice.org/sites/www.sagemath.org/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.xmission.com/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
http://files.sagemath.org/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.marwan.ma/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror-hk.koddos.net/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.csclub.uwaterloo.ca/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://ftp.sun.ac.za/ftp/pub/mirrors/www.sagemath.org/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.ufs.ac.za/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
http://linorg.usp.br/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://ftp.yz.yamagata-u.ac.jp/pub/math/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://ftp.riken.jp/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.rcg.sfu.ca/mirror/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirror.aarnet.edu.au/pub/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://sagemath.c3sl.ufpr.br/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://sage.mirror.garr.it/mirrors/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.nju.edu.cn/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.tuna.tsinghua.edu.cn/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://mirrors.ustc.edu.cn/sagemath/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
http://sagepad.org/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz
https://files.pythonhosted.org/packages/source/p/pyparsing/pyparsing-3.0.9.tar.gz
```

(before it got stuck at `https://mirror.marwan.ma/sage/spkg/upstream/pyparsing/pyparsing-3.0.9.tar.gz`).


---

Comment by jhpalmieri created at 2022-07-14 21:39:35

That's how it's going to work when it is a new version of a Sage package: the mirrors currently only have an earlier version, so it tries and fails all of those before going to the upstream URL.


---

Comment by jhpalmieri created at 2022-07-14 21:40:01

I spot-checked again, a little more than last time. 3d plotting works well with various viewers, math in the notebook works. I don't see any issues.


---

Comment by mkoeppe created at 2022-07-14 21:41:43

If searching the mirrors takes too long, you can edit `upstream/mirror_list` to make it shorter


---

Comment by mkoeppe created at 2022-07-14 21:41:58

Thanks for the review!


---

Comment by jhpalmieri created at 2022-07-16 20:40:26

Interrupt issues with this version of `prompt_toolkit`: see #33428.


---

Comment by jhpalmieri created at 2022-07-16 20:40:26

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-07-16 20:43:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-16 20:50:12

Changing status from needs_work to needs_review.


---

Comment by git created at 2022-07-16 20:53:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-07-16 21:15:54

Looks good, thanks.


---

Comment by jhpalmieri created at 2022-07-16 21:15:54

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-07-16 21:23:47

Thanks!


---

Comment by vbraun created at 2022-07-28 19:10:25

Resolution: fixed
