# Issue 26795: Notebook will not start in Windows 10 (Chinese language)

Issue created by migration from https://trac.sagemath.org/ticket/27032

Original creator: @kernel1983

Original creation time: 2019-01-08 09:32:23

CC:  slelievre

version: 8.5


```
(sage-sh) KJ@DESKTOP-RUCUC7J:sagemath-8.5$ /opt/sagemath-8.5/sage --notebook jupyter          
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.5, Release Date: 2018-12-22                     │
│ Using Python 2.7.15. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
Please wait while the Sage Jupyter Notebook server starts...
[I 17:09:31.161 NotebookApp] Using MathJax: nbextensions/mathjax/MathJax.js
The Jupyter HTML Notebook.

这将启动一个基于tornado的HTML笔记本服务器，它提供一个html5/
javascript笔记本客户端。

Traceback (most recent call last):
  File "/opt/sagemath-8.5/src/bin/sage-notebook", line 268, in <module>
    launcher(unknown)
  File "/opt/sagemath-8.5/src/bin/sage-notebook", line 100, in __init__
    main(argv)
  File "/opt/sagemath-8.5/local/lib/python2.7/site-packages/jupyter_core/application.py", line 266, in launch_instance
    return super(JupyterApp, cls).launch_instance(argv=argv, **kwargs)
  File "/opt/sagemath-8.5/local/lib/python2.7/site-packages/traitlets/config/application.py", line 657, in launch_instance
    app.initialize(argv)
  File "<decorator-gen-7>", line 2, in initialize
  File "/opt/sagemath-8.5/local/lib/python2.7/site-packages/traitlets/config/application.py", line 89, in catch_config_error
    app.print_help()
  File "/opt/sagemath-8.5/local/lib/python2.7/site-packages/traitlets/config/application.py", line 385, in print_help
    self.print_subcommands()
  File "/opt/sagemath-8.5/local/lib/python2.7/site-packages/traitlets/config/application.py", line 377, in print_subcommands
    print(os.linesep.join(lines))
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe5 in position 4: ordinal not in range(128)
```



---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by @fwjmath created at 2019-07-03 14:41:16

This bug also appears in Linux (Ubuntu 19.04) in Chinese environment. In fact I suspect that this bug affects all non-western locale. 

It seems to be related to the encoding setting. For instance, if in sage/local/lib/python2.7/site.py, in the function setencoding(), we switch on the first if, then it gives the following error message on my machine:


```
[C 15:50:01.242 NotebookApp] Bad config encountered during initialization:
[C 15:50:01.242 NotebookApp] Could not decode '\xe6\x9c\xaa\xe5\x91\xbd\xe5\x90\x8d' for unicode trait 'untitled_notebook' of a LargeFileManager instance.
```


**Workaround**:

This is to be executed in addition to the modification in site.py mentioned above.

In the traitlets module (sage/local/lib/python2.7/sitepackages/traitlets/traitlets.py), track down the function `validate` in class `Unicode`, and modify it as


```
    def validate(self, obj, value):
        if isinstance(value, six.text_type):
            return value
        if isinstance(value, bytes):
            try:
                return value.decode('ascii', 'strict')
            except UnicodeDecodeError:
                #msg = "Could not decode {!r} for unicode trait '{}' of {} instance."
                #raise TraitError(msg.format(value, self.name, class_of(obj)))
                return '!!!Decode error!!!'
        self.error(obj, value)
```


This modification suppresses the error raised when unable to decode a certain string. The problem should be reported upstream, to encourage a more graceful handling of decoding exceptions. After all, usability only degrades a bit with uncorrectly decoded strings, but raising an exception and failing is another dimension.

Since I observed that my jupyter notebook now has localized message (in Chinese) in it, I suspect that it is a bug introduced in upstream when they do localization.


---

Comment by embray created at 2019-07-03 15:09:02

I didn't see this ticket before; too bad.  This was also raised [here](https://github.com/sagemath/sage-windows/issues/28) and [here](https://ask.sagemath.org/question/45052/sage-85-windows-jupyter-cant-work/).  It's a bug in Jupyter that [only affects Python 2](https://github.com/jupyter/notebook/issues/4166) so I think upstream has been loathe to do anything about it.

I would be willing consider including a workaround directly in Sage's Jupyter though, if need be.  In the meantime a simple workaround is to set (unfortunately) `LANGUAGE=en_US` in your environment before starting the Jupyter notebook.


---

Comment by embray created at 2019-07-03 15:09:02

Changing keywords from "" to "windows".


---

Comment by chapoton created at 2020-06-25 19:32:06

Changing keywords from "windows" to "windows, python2".


---

Comment by chapoton created at 2022-05-21 07:37:31

can we qualify this as obsolete, now we are running only python3 ?


---

Comment by chapoton created at 2022-05-21 07:37:31

Changing status from new to needs_review.


---

Comment by slelievre created at 2022-05-24 10:05:51

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2022-05-24 10:05:51

OK to close.


---

Comment by chapoton created at 2022-05-24 10:33:37

Resolution: invalid
