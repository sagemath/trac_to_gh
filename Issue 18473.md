# Issue 18473: Move some make targets to build/Makefile

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2015-06-16 10:01:00

CC:  ncohen

Move all `make` targets involving building parts of Sage to `build/Makefile`.

There are two future goals:
1. Adding targets for every package, such that `make mypkg` would install `mypkg` _with dependency checking_ (unlike `./sage -i mypkg`).
2. Building the documentation in parallel with packages (this is assuming that not every package needs to be installed to build the documentation, this needs to be investigated)


---

Comment by jdemeyer created at 2015-06-16 16:58:55

New commits:


---

Comment by jdemeyer created at 2015-06-16 16:58:55

Changing status from new to needs_review.


---

Comment by ncohen created at 2015-06-16 18:05:09

You make many unrelated changes in the same diff and it's rather hard to figure out. Could you split the commits? Having one commit per block of rules that you move from one place to another would help a lot.

Nathann


---

Comment by jdemeyer created at 2015-06-16 18:28:07

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-06-16 19:32:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-06-16 19:45:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-16 19:50:17

I split off 2 tickets: #18715 and #18716 and kept only the core of this ticket here, I hope it's more clear now.


---

Comment by jdemeyer created at 2015-06-16 19:50:26

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-06-16 21:25:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-06-17 08:21:10

Yes yes it is clearer. Though you didn't have to go through the trouble of creating many tickets, splitting the commits would have been enough. I'll review this soon.


---

Comment by jdemeyer created at 2015-06-17 08:24:39

Replying to [comment:14 ncohen]:
> Though you shouldn't have to go through the trouble of creating many tickets
Well, creating a ticket takes essentially no time (certainly much less than splitting up commits).


---

Comment by ncohen created at 2015-06-17 08:51:39

What about the packages that install libraries that Sage needs to compile cython modules? They need to be installed if you want their doc to appear.

And unfortunately, I am also talking of optional ones `:-/`


---

Comment by ncohen created at 2015-06-17 09:02:03


```
+# Defer unknown targets to build/Makefile
+%::
+	$(MAKE) configure logs
+	cd build && ./pipestatus \
+		"./install '$`@`' 2>&1" \
+		"tee -a ../logs/install.log"
```


You can't log everything to `.install.log` regarless of the command that was run.


---

Comment by jdemeyer created at 2015-06-17 10:03:59

Replying to [comment:16 ncohen]:
> What about the packages that install libraries that Sage needs to compile cython modules? They need to be installed if you want their doc to appear.
Yes, they are handled by the `$(SAGERUNTIME)` dependency.

> And unfortunately, I am also talking of optional ones `:-/`
Well, we are currently not building documentation for optional extensions anyway, so that doesn't matter.


---

Comment by jdemeyer created at 2015-06-17 10:06:03

Replying to [comment:17 ncohen]:
> You can't log everything to `.install.log` regarless of the command that was run.

Actually, why not? I don't see a problem with having one "master" log file logging everything. And it can help debugging race conditions if some command fails depending on when it was run.

The individual log files are still generated, so I don't see this as a regression.


---

Comment by ncohen created at 2015-06-17 10:39:08

> The individual log files are still generated, so I don't see this as a regression.

You concatenate in the same file the results of several commands, don't you? How are we meant to know what is the result of what? Wouldn't it be better to have a logfile whose name includes the date or something?

Also, 'install' is ill-chosen. This filename is used whenever the rule that is being used does not exist in the  main makefile, and it can be anything (install/docbuild/tests). It also seems that calls to 'make' with a wrong rule will produce output too.

Nathann


---

Comment by jdemeyer created at 2015-06-17 10:53:58

Replying to [comment:20 ncohen]:
> You concatenate in the same file the results of several commands, don't you?
Yes indeed.

> How are we meant to know what is the result of what?
You cannot really know that. But if you need to know, just look at the individual log files, which still exist.

> Wouldn't it be better to have a logfile whose name includes the date or something?
> Also, 'install' is ill-chosen.
Well, I think that changing the name of that file is outside the scope of this ticket. That should be done with caution, as this might have consequences for the patchbot/buildbot for example.

> This filename is used whenever the rule that is being used does not exist in the  main makefile, and it can be anything (install/docbuild/tests).
Well, this ticket is about integrating the build of the documentation into the rest of the build system. So having one log file is consistent with that.

> It also seems that calls to 'make' with a wrong rule will produce output too.
True, but that's not really a major problem, is it?


---

Comment by ncohen created at 2015-06-17 10:57:39

If having one makefile call the other forces you to accept so many issues with the logfiles, then this temporary design maybe isn't a good idea.


---

Comment by jdemeyer created at 2015-06-17 11:29:43

Replying to [comment:22 ncohen]:
> If having one makefile call the other forces you to accept so many issues with the logfiles, then this temporary design maybe isn't a good idea.
The only new issue is that the output of `make this_target_does_not_exist` gets logged in `install.log`. I do not believe that this is sufficient reason to reject this patch.

All the other issues that you mentioned in [comment:20] are already present in Sage, independent of this ticket.


---

Comment by ncohen created at 2015-06-17 11:32:09

Why do you insist on logging the output of a 'forwarded' rule call? Why wouldn't you just let the actual rule hande the logging?

P.S.: How can you even be sure that the final logging rule does not simultaneously output to install.log?


---

Comment by jdemeyer created at 2015-06-17 11:36:18

Replying to [comment:24 ncohen]:
> Why do you insist on logging the output of a 'forwarded' rule call?
I am just keeping this behaviour *which already exists in Sage*. Changing this is not in the scope of this ticket.

> P.S.: How can you even be sure that the final logging rule does not simultaneously output to install.log?
Even if that happens, that's not really a problem (it's perfectly legal to have more than 1 process append to the same file, then output will appear in "random" order, nothing will be lost).


---

Comment by ncohen created at 2015-06-17 11:38:00

> I am just keeping this behaviour *which already exists in Sage*.

Explain what you mean: this logging is done in a rule that you create in this branch.


---

Comment by jdemeyer created at 2015-06-17 11:49:42

Replying to [comment:26 ncohen]:
> this logging is done in a rule created by this branch.
Currently in Sage:

```
build: logs configure
    +cd build && \
    "../$(PIPE)" \
        "./install all 2>&1" \
        "tee -a ../logs/install.log"
    +./sage -b
```


With this ticket:

```
%::
    $(MAKE) configure logs
    +cd build && ./pipestatus \
        "./install '$`@`' 2>&1" \
        "tee -a ../logs/install.log"
```


There is no difference at all in how `install.log` is treated.


---

Comment by git created at 2015-06-17 11:51:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2015-06-17 11:53:49

> There is no difference at all in how `install.log` is treated.

Be honest for a second Jeroen. There is no difference at all *when make build* is called. For all other calls, there is a difference. In these situations, it would make more sense to not double-log everything. Why don't you move the logging to `install.log` to the `build:` rule in the other makefile?

And then, you can remove the logging from this very very generic rule.

Nathann


---

Comment by jdemeyer created at 2015-06-17 12:00:34

Can you please try to understand the following sentence?

*We are already double-logging the whole build process and my ticket does not change that.*

There are a few small differences, sure: with #18710, also the docbuild is double-logged. But that's not a fundamental change.


---

Comment by ncohen created at 2015-06-17 12:03:26

> Can you please try to understand the following sentence?
> 
> *We are already double-logging the whole build process and my ticket does not change that.*

Jeroen, I am here to review your ticket. If all you plan on doing is scream whenever your reviewer disagrees with you, your ticket is blocked. Agreed ?

So let's do something constructive: can you tell me why you insist on double-logging in this new rule that you add? Can't you just move this logging to the other makefile?


---

Comment by jdemeyer created at 2015-06-17 12:05:58

Replying to [comment:31 ncohen]:
> > Can you please try to understand the following sentence?
> > 
> > *We are already double-logging the whole build process and my ticket does not change that.*
> 
> Jeroen, I am here to review your ticket. If all you plan on doing is scream whenever your reviewer disagrees with you, your ticket is blocked. Agreed ?
It just feels to me like you are complaining without reading my comments. I hope that the bold sentence above will not escape your attention. Anyway, I need to cool down for a while...


---

Comment by ncohen created at 2015-06-17 12:09:19

> It just feels to me like you are complaining without reading my comments. I hope that the bold sentence above will not escape your attention. 

To me it is an assertion without proof. You tell me that everything is already double-logged, while I have my eyes on a generic rule that you add that double-logs everything automatically. Is it now triple-logged?

I also asked you in my last comment why you wouldn't move this logging to the other file, so that it only applies to the 'build' rule, but you did not answer that.

> Anyway, I need to cool down for a while...

Yep.

Nathann


---

Comment by jdemeyer created at 2015-06-17 12:41:15

OK, let me try again:

> Can't you just move this logging to the other makefile?
There is already logging in the individual rules in `build/Makefile`. This is logging number 1.

The logging to `install.log` from `Makefile` is logging number 2.

I don't see where a "triple logging" could come from.

Note that `install.log` contains information which is not available from the individual log files:
1. a listing of environment variables at the start of the build, and other output from `build/install`.
2. timing information: it shows all commands in parallel as they are executed. This is actually a feature, since it allows debugging race conditions. With just the individual files, that information is lost.


---

Comment by ncohen created at 2015-06-17 13:12:55

Yooooooo !

> There is already logging in the individual rules in `build/Makefile`. This is logging number 1.
> 
> The logging to `install.log` from `Makefile` is logging number 2.

Right. Do we agree that before your branch is applied, this "number 2 logging" in `install.log` is only performed for 'make build'?

(assuming that we agree on that) With the new fallback `%::` rule that you added, all calls to 'make X' that are not defined in `SAGE_ROOT/Makefile` are forwarded to `build/Makefile`. Thus, after your branch is applied, the output of `make doc-html` is logged in `install.log`. 

(assuming that we agree on that) Before your branch is applied, the output of `make doc-html` was not logged i install.log.

(assuming that we agree on that) Why wouldn't we remove the logging from the `%::` rule, and only add it in the `make build` rule (which is now the `make all-build` rule from `build/Makefile`)?

> Note that `install.log` contains information which is not available from the individual log files:
> 1. a listing of environment variables at the start of the build, and other output from `build/install`.
> 2. timing information: it shows all commands in parallel as they are executed. This is actually a feature, since it allows debugging race conditions. With just the individual files, that information is lost.

For 'make build' it I agree that this information can make sense.

Nathann


---

Comment by jdemeyer created at 2015-06-17 13:25:18

Replying to [comment:35 ncohen]:
> Right. Do we agree that before your branch is applied, this "number 2 logging" in `install.log` is only performed for 'make build'?
Yes. However, let me remark that most top-level targets depend on `build`, so the "build" part of those targets is also logged in `install.log`.

> With the new fallback `%::` rule that you added, all calls to 'make X' that are not defined in `SAGE_ROOT/Makefile` are forwarded to `build/Makefile`. Thus, after your branch is applied, the output of `make doc-html` is logged in `install.log`.
True. But this is a feature, not a bug.

> (assuming that we agree on that) Before your branch is applied, the output of `make doc-html` was not logged in `install.log`.
Obviously true.

> (assuming that we agree on that) Why wouldn't we remove the logging from the `%::` rule, and only add it in the `make build` rule (which is now the `make all-build` rule from `build/Makefile`)?

See the last paragraph of [comment:34]. Those reasons make sense for `make doc` as much for `make build`.


---

Comment by jdemeyer created at 2015-06-17 13:31:15

I'll try to get rid of the explicit running of `./sage -b` (which shouldn't be needed).


---

Comment by jdemeyer created at 2015-06-17 13:31:15

Changing status from needs_review to needs_work.


---

Comment by ncohen created at 2015-06-17 13:34:28

Okay. From what you say, it appears to me that:

1) After your branch is applied, "make build" is logged exactly as previously in `install.log`
2) After your branch is applied, the output of `make doc-html` is logged in `install.log`. As it triggers a `make build`, then the output of `make build` is logged twice in `install.log` (once in `make doc-html`, once in the triggered `make build`)
3) My problem with your `%::` is that is that it covers *any* kind of rule, even those that we will add in the future. Promising right now that any rules that is aliased from `Makefile` to `build/Makefile` will be logged in `install.log` looks too wide for me.

Thus, could you remove this logging from the `%::` rule? You could add the same logging in the `make all-sage` rule. It would also let you add a more specific logging of `make doc` that would not cover the subsequent call to `make build`, thus we would not double-log that.

> See the last paragraph of [comment:34]. Those reasons make sense for `make doc` as much for `make build`.

I would have less problem if you were only adding those rules in `make doc` and `make build`. Right now you are doing this in a wider scope: you apply then to all rules that are aliased, even those that will be added later.

Nathann


---

Comment by git created at 2015-06-17 14:12:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-06-17 14:19:32

Replying to [comment:38 ncohen]:
> After your branch is applied, the output of `make doc-html` is logged in `install.log`. As it triggers a `make build`, then the output of `make build` is logged twice in `install.log` (once in `make doc-html`, once in the triggered `make build`)

I think you are misunderstanding something, because this is not true: `make doc-html` does not trigger `make build`.

The documentation is now built similarly to spkgs. The dependencies for the documentation are declared just like the dependencies for packages, see this part of `build/Makefile`:

```Makefile
# Building the documentation has many dependencies, because all
# documented modules are imported and because we use matplotlib to
# produce plots.
DOC_DEPENDENCIES = sagelib $(INST)/$(SPHINX) $(INST)/$(SAGENB) \
    | $(SAGERUNTIME) $(INST)/$(MAXIMA) $(INST)/$(NETWORKX) \
    $(INST)/$(SCIPY) $(INST)/$(MATPLOTLIB) $(INST)/$(PILLOW)

doc: doc-html

doc-html: $(DOC_DEPENDENCIES)
    cd .. && $(PIPE) "./sage --docbuild --no-pdf-links all html $(SAGE_DOCBUILD_OPTS) 2>&1" "tee -a logs/dochtml.log"
```

----
New commits:


---

Comment by jdemeyer created at 2015-06-17 14:31:05

Replying to [comment:38 ncohen]:
> 3) My problem with your `%::` is that is that it covers *any* kind of rule, even those that we will add in the future. Promising right now that any rules that is aliased from `Makefile` to `build/Makefile` will be logged in `install.log` looks too wide for me.
When logging, it is safer to log too much than too little. So I actually think this extra logging of everything going through to `build/Makefile` is a feature rather than a bug. Think of `install.log` as a log of everything regarding the build of your Sage installation. What's wrong with that? Are you afraid of losing a few megabytes of disk space?

> I would have less problem if you were only adding those rules in `make doc` and `make build`
When you say `make doc`, do you really mean `make doc` or also `make doc-pdf` and `make doc-html-jsmath` and similar? When you say `make build`, I guess you really mean `make all` and `make all-build` (or just one of these?). You see that this becomes complicated...


---

Comment by jdemeyer created at 2015-06-17 14:31:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-06-19 10:34:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-06-19 10:34:40

Squashed and rebased to latest beta.


---

Comment by git created at 2015-06-19 10:36:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-06-28 09:37:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-06-28 11:37:05

Resolution: fixed


---

Comment by vbraun created at 2015-06-29 09:27:36

I'm reopening this as it totally breaks OSX, see http://build.sagedev.org/release/builders/%20%20fast%20Volker%20MiniMac%20%28OSX%2010.10%20x86_64%29%20full/builds/63/steps/compile_1/logs/stdio

I haven't tried to understand whats going on but it seems that packages don't wait for the gcc build to finish


---

Comment by vbraun created at 2015-06-29 09:27:36

Changing status from closed to new.


---

Comment by vbraun created at 2015-06-29 09:27:36

Resolution changed from fixed to 


---

Comment by jdemeyer created at 2015-06-29 09:53:50

Got it: the problem is that the buildbot runs `make start` which is indeed broken.


---

Comment by jdemeyer created at 2015-06-29 11:04:53

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-06-29 11:04:53

Now `make start` works properly after `make distclean`.
----
New commits:


---

Comment by jdemeyer created at 2015-06-29 15:20:00

These old commits already have positive_review:
> ||[f3c4445](http://git.sagemath.org/sage.git/commit/?id=f3c4445950120a708b9da3bd3d2bfe68a27f09cc)||`Move various targets to build/Makefile`||
> ||[b86e0bb](http://git.sagemath.org/sage.git/commit/?id=b86e0bb1f7f558f6f6b853a3eb0ff60a145eaebc)||`Fix strange mixture of TABs and spaces`||

This commit was by Volker for #18788, but it really belongs on this ticket. I give it positive_review:
> ||[1eac5fd](http://git.sagemath.org/sage.git/commit/?id=1eac5fdde95cd5a0c605028101d2c38f55fda275)||`Remove test for faux package`||

So this is the only commit which needs to be reviewed:
> ||[6db418e](http://git.sagemath.org/sage.git/commit/?id=6db418e791a4d1881bd455e6814458457e904476)||`Fix dependencies for "make start"`||


---

Comment by vbraun created at 2015-06-29 22:31:23

Resolution: fixed


---

Comment by jhpalmieri created at 2015-07-06 18:31:14

Is there a philosophy behind which targets are in the top-level `Makefile` and which are in `build/deps`? `build-clean`, for example? Or maybe more importantly, if someone wanted to add a new target, how to decide where it should go?


---

Comment by vbraun created at 2015-07-06 22:08:14

To a first approximation, I'd say stuff dealing specifically with third-party packages should go to deps and more global targets to the top-level Makefile. But then its really just putting lipstick on a pig. What we *really* need is a reliable build system, not a policy where to put stuff right now.


---

Comment by jhpalmieri created at 2015-07-13 17:56:33

What's up with

```
+$(STARTED): $(STANDARD_PACKES)
+	"$(SAGE_LOCAL)/bin/sage-starts"
```

Shouldn't that be `STANDARD_PACKAGES`?


---

Comment by jdemeyer created at 2015-07-13 18:08:29

Of course...
