# Issue 15544: Increase Performance of possible_periods in Projective Morphism

Issue created by migration from Trac.

Original creator: drose

Original creation time: 2014-02-03 15:05:59

CC:  bhutz

Keywords: possible_periods, cython

Increase Performance of possible_periods in Projective Morphism by replacing functionality with cython.


---

Comment by drose created at 2014-02-05 17:27:10

Changing component from cython to algebraic geometry.


---

Comment by drose created at 2014-02-05 17:27:10

Set assignee to drose.


---

Comment by drose created at 2014-02-05 17:27:10

Changing priority from major to minor.


---

Comment by git created at 2014-02-05 17:55:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-02-10 15:33:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-02-11 00:28:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2014-04-10 15:24:27

rebased to 6.2.beta7
----
Last 10 new commits:


---

Comment by git created at 2014-04-10 16:00:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-22 01:54:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by drose created at 2014-04-22 01:55:21

Changing status from new to needs_review.


---

Comment by bhutz created at 2014-04-23 16:20:44

Changing status from needs_review to needs_work.


---

Comment by bhutz created at 2014-04-23 16:20:44

No issues with the long test, but before I do more specialized testing there are number of things from looking through the code:

1) Fix preamble documentation to be for the helper and not generic projective space

2) Fix copyright date

3) in _fast_possible_periods:

 - use a Reference block - see dynamtomic_polynomial (should be able to use the references from other files)

 - examples should call _fast_possible_periods

 - todo: typo return

 - todo: add - more space efficient hash/pointtable

 - use is_prime_finite_field

 - move import to header of file

4) pass N+1 into into _normalize_coordinates to replace the len(point) calls

5) _mod_inv - description: Find the inverse of the number modulo the given prime.

6) Use the better version of the eigenvale computation (see 14219 lines 2608-2624)

7) also from 14219 

use

return sorted(periods)

instead of

periods=list(periods)
periods.sort()
return(periods)

8)enum points documentation:
Enumerate points in projective space over finite field with given prime and dimension.


---

Comment by bhutz created at 2014-04-23 16:23:57

err.. there was one doc test failure in helper.pyx


```
File "sage/schemes/projective/projective_morphism_helper.pyx", line 213, in sage.schemes.projective.projective_morphism_helper._enum_points
Failed example:
    _enum_points(3,2)
Expected:
    [[1, 0, 0], [0, 1, 0], [1, 1, 0], [2, 1, 0], [0, 0, 1], [1, 0, 1], [2, 0, 1], [0, 1, 1], [1, 1, 1], [2, 1, 1], [0, 2, 1], [1, 2, 1], [2, 2, 1]]
Got:
    <generator object at 0x1161d6500>
```



---

Comment by git created at 2014-04-25 18:16:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-25 18:26:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2014-04-28 12:34:15

The long test and my other functionality tests all pass, but there are two things. One minor, one major.

Minor: I think I was wrong about the reference block. The .pyx files seem to not be part of the docbuild, so I'm a little concerned about the REFERENCE block have possible issues later on. Perhaps that should be returned to the previous method.

Major: There is still a memory issue. The following example:


```
P.<x,y,z,u,v>=ProjectiveSpace(QQ,4)
H=Hom(P,P)
f=H([-38/45*x^2 + (2*y - 7/45*v)*x + (-1/2*y^2 - 1/2*v*y + v^2),-67/90*x^2 + (2*y + 157/90*v)*x - v*y,(-u - v)*z + (-13/30*u^2 + 13/30*v*u + v^2),-1/2*z^2 + (-u + 3/2*v)*z + (-1/3*u^2 + 4/3*v*u),v^2])
print f.possible_periods(prime_bound=[13,30])
```


runs just fine with 15780, but with 15781 very quickly runs out of memory (on my laptop allocated 3Gb). fyi, it take about 8min to complete the example on my laptop under 15780. The function _enum_points is what is consuming all the memory.


---

Comment by nbruin created at 2014-04-28 15:32:25

... and you may want to redo the branch for this ticket (hopefully nothing depends on it yet). Currently, it has the `*.c` file of a `*.pyx` tracked. You should probably rebase the branch so that that file is never checked in (I'm not sure whether removing it will leave it in the history).


---

Comment by git created at 2014-05-01 15:23:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-01 16:13:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2014-05-01 23:56:07

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2014-05-01 23:56:07

Dillon fixed the issues and removed the .c file. I then did the rebase to be sure it doesn't have it in the history. I ran the full tests again and everything looks good.

Should someone else take a look at this since both Dillon and I have been making code changes?
----
Last 10 new commits:


---

Comment by jdefaria created at 2014-05-08 18:54:48

Reviewed code.


---

Comment by jdefaria created at 2014-05-08 18:54:48

Changing status from needs_review to positive_review.


---

Comment by nbruin created at 2014-05-08 22:17:44

Changing status from positive_review to needs_work.


---

Comment by nbruin created at 2014-05-08 22:17:44

Please rewrite history for this branch prior to merging. Presently, you are putting this commit in the history of sage for posterity:

http://git.sagemath.org/sage.git/commit/?id=170205d7d56fc90724c3e0d557b1d6e8ade2dcae


---

Comment by bhutz created at 2014-05-08 22:53:49

We tried to undo that by untracking the file and then rebasing. How do we rewrite the history so that .c file is not included?


---

Comment by nbruin created at 2014-05-09 00:26:36

Replying to [comment:25 bhutz]:
> We tried to undo that by untracking the file and then rebasing. How do we rewrite the history so that .c file is not included?

Probably something like `git rebase -i 6.2.rc0` (what you called rebases in history were probably merges) and then edit a lot of "pick" to be "squash" instead. If you can squash everything between the addition and the removal of the `.c` file, you'll have the easiest time. If you want to preserve some of the individual commits in between, you'll have to see if you can reorder them.

You'll basically be producing a "fresh" branch that introduces the commits you want to have in there and not the ones you don't. Of course, anybody who has based work on commits you're removing, will have merge conflicts with your new branch, so hopefully no-one did. That's why usually merging produces less severe conflicts and is therefore recommended, but when you really want to _remove_ things from history, you have to rebase.


---

Comment by bhutz created at 2014-05-09 02:36:32

ok. I actually did git rebase and not merge. It sounds like the rebase -i will give me more control over the end result. I'll give that a try and see if I can get the .c problem sorted out


---

Comment by git created at 2014-05-09 16:19:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by bhutz created at 2014-05-09 16:32:04

I've re-written the history to remove all references to the .c file. Currently building and testing...


---

Comment by bhutz created at 2014-05-09 18:29:17

Changing status from needs_work to needs_review.


---

Comment by jdefaria created at 2014-05-10 13:49:55

Reviewed code, everything is still working


---

Comment by jdefaria created at 2014-05-10 13:49:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-12 20:20:09

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-05-12 20:20:09

Merge conflict, please fix


---

Comment by git created at 2014-05-12 22:58:02

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by bhutz created at 2014-05-12 22:59:39

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2014-05-12 22:59:39

the rebase to 6.3.beta0 did not cause any changes to commit, just omitted some commits, so I had to push with force to. But, it should merge now.


---

Comment by vbraun created at 2014-05-15 15:22:21

You should never rebase branches that are on trac, always merge. 

Conflicts with 6.3.beta1


---

Comment by vbraun created at 2014-05-15 15:22:21

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-05-15 15:23:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by bhutz created at 2014-05-15 15:36:06

I saw the conflict and had just pushed a new rebase before I saw your comment. I'll merge in the future.


---

Comment by bhutz created at 2014-05-15 15:36:06

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-05-15 17:18:28

Resolution: fixed
