# Issue 32466: GH Actions: In tox-docker, run a job for "make build-local" first, cache image for job "make build"

archive/issues_032466.json:
```json
{
    "body": "CC:  @tobiasdiez @kliem @orlitzky @isuruf\n\n(+) On top of the built image containing the full SAGE_LOCAL, we can test several ways to build the Python parts\n- Sage distribution, classic\n- Sage distribution with `configure --enable-editable`\n- Sage distribution with `configure --enable-system-site-packages` (#29665)\n- the configurations from pkgs/**sagemath-standard**/tox.ini\n- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)\n\n(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit\n\n(-) Unfortunately, because [because \"needs\" cannot depend on \"matrix\"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed\n\nReferences\n- https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching\n\nIssue created by migration from https://trac.sagemath.org/ticket/32703\n\n",
    "created_at": "2021-10-16T19:03:25Z",
    "labels": [
        "component: porting"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "GH Actions: In tox-docker, run a job for \"make build-local\" first, cache image for job \"make build\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32466",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @tobiasdiez @kliem @orlitzky @isuruf

(+) On top of the built image containing the full SAGE_LOCAL, we can test several ways to build the Python parts
- Sage distribution, classic
- Sage distribution with `configure --enable-editable`
- Sage distribution with `configure --enable-system-site-packages` (#29665)
- the configurations from pkgs/**sagemath-standard**/tox.ini
- build/install of modularized distributions such as pkgs/**sage-categories** (#29865), pkgs/**sagemath-standard-no-symbolics** (#32601)

(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit

(-) Unfortunately, because [because "needs" cannot depend on "matrix"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed

References
- https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching

Issue created by migration from https://trac.sagemath.org/ticket/32703





---

archive/issue_comments_462579.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-10-17T01:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462579",
    "user": "https://github.com/mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_462580.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T05:25:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462580",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462581.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T18:29:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462581",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462582.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-17T23:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462582",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462583.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-18T19:36:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462583",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462584.json:
```json
{
    "body": "working well now",
    "created_at": "2021-10-19T16:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462584",
    "user": "https://github.com/mkoeppe"
}
```

working well now



---

archive/issue_comments_462585.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-19T17:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462585",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462586.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-19T17:08:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462586",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_462587.json:
```json
{
    "body": "If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel. For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact. Maybe something like https://github.com/marketplace/actions/wait-for-check helps.",
    "created_at": "2021-10-19T17:23:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462587",
    "user": "https://github.com/tobiasdiez"
}
```

If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel. For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact. Maybe something like https://github.com/marketplace/actions/wait-for-check helps.



---

archive/issue_comments_462588.json:
```json
{
    "body": "Replying to [comment:14 gh-tobiasdiez]:\n> If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.\n\nYes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...\n\n> For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact.\n\nWell, they failed because the previous stage failed.",
    "created_at": "2021-10-19T17:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462588",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:14 gh-tobiasdiez]:
> If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.

Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...

> For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact.

Well, they failed because the previous stage failed.



---

archive/issue_comments_462589.json:
```json
{
    "body": "Replying to [comment:14 gh-tobiasdiez]:\n> Maybe something like https://github.com/marketplace/actions/wait-for-check helps.\n\nThanks for the pointer, we can look into using something like this",
    "created_at": "2021-10-19T17:36:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462589",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:14 gh-tobiasdiez]:
> Maybe something like https://github.com/marketplace/actions/wait-for-check helps.

Thanks for the pointer, we can look into using something like this



---

archive/issue_comments_462590.json:
```json
{
    "body": "Testing with integrated builds for the optional packages now at https://github.com/mkoeppe/sage/actions/runs/1360303527",
    "created_at": "2021-10-19T17:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462590",
    "user": "https://github.com/mkoeppe"
}
```

Testing with integrated builds for the optional packages now at https://github.com/mkoeppe/sage/actions/runs/1360303527



---

archive/issue_comments_462591.json:
```json
{
    "body": "Replying to [comment:15 mkoeppe]:\n> Replying to [comment:14 gh-tobiasdiez]:\n> > If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.\n> \n> Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...\n\nOkay, but isn't this a very fragile design? Imagine that you have exactly 5 matrix cases. So all of the stage 1 tasks start at the same time. Now if the last case exists slightly before the other 4, then the stage 2 for the other 4 may be invoked and now fail as their stage 1 is not yet finished. Also this would limit everything to mac, as on linux you have way more runners.",
    "created_at": "2021-10-19T21:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462591",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:15 mkoeppe]:
> Replying to [comment:14 gh-tobiasdiez]:
> > If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.
> 
> Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...

Okay, but isn't this a very fragile design? Imagine that you have exactly 5 matrix cases. So all of the stage 1 tasks start at the same time. Now if the last case exists slightly before the other 4, then the stage 2 for the other 4 may be invoked and now fail as their stage 1 is not yet finished. Also this would limit everything to mac, as on linux you have way more runners.



---

archive/issue_comments_462592.json:
```json
{
    "body": "Replying to [comment:18 gh-tobiasdiez]:\n> Okay, but isn't this a very fragile design? \n\nYes",
    "created_at": "2021-10-19T21:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462592",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:18 gh-tobiasdiez]:
> Okay, but isn't this a very fragile design? 

Yes



---

archive/issue_comments_462593.json:
```json
{
    "body": "Replying to [comment:18 gh-tobiasdiez]:\n> on linux you have way more runners.\n\nwe also have way more jobs...",
    "created_at": "2021-10-19T21:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462593",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:18 gh-tobiasdiez]:
> on linux you have way more runners.

we also have way more jobs...



---

archive/issue_comments_462594.json:
```json
{
    "body": "Then I would suggest using two jobs that wait using \"needs\" and accept the disadvantages that go with it. \n\n> Unfortunately, because \u200bbecause \"needs\" cannot depend on \"matrix\", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed \n\nI think this is also a more flexible design as the stage two matrix will probably have more options in the future (e.g. editable install, with/without prebuild wheels from pypi, pipenv).\nIn fact, for maximal flexibility do you think it makes sense too split it further into 3 stages:\n- Built all non-python packages (min/standard/max)\n- Built all python packages (standard, editable, prebuild wheels, pipenv)\n- Run doctests",
    "created_at": "2021-10-20T07:55:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462594",
    "user": "https://github.com/tobiasdiez"
}
```

Then I would suggest using two jobs that wait using "needs" and accept the disadvantages that go with it. 

> Unfortunately, because ​because "needs" cannot depend on "matrix", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed 

I think this is also a more flexible design as the stage two matrix will probably have more options in the future (e.g. editable install, with/without prebuild wheels from pypi, pipenv).
In fact, for maximal flexibility do you think it makes sense too split it further into 3 stages:
- Built all non-python packages (min/standard/max)
- Built all python packages (standard, editable, prebuild wheels, pipenv)
- Run doctests



---

archive/issue_comments_462595.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-20T16:03:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462595",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462596.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-20T16:07:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462596",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462597.json:
```json
{
    "body": "Yes, in stage 2 we can have all of these variants, next to the runs for the optional packages added in 313dc82\n\nWhether the doctest needs a separate stage remains to be seen; I think having it as part of the stage 2 builds will easily fit into the 6 hour limit in all variants.",
    "created_at": "2021-10-20T16:44:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462597",
    "user": "https://github.com/mkoeppe"
}
```

Yes, in stage 2 we can have all of these variants, next to the runs for the optional packages added in 313dc82

Whether the doctest needs a separate stage remains to be seen; I think having it as part of the stage 2 builds will easily fit into the 6 hour limit in all variants.



---

archive/issue_comments_462598.json:
```json
{
    "body": "Optional packages working well now - https://github.com/mkoeppe/sage/actions/runs/1364372711",
    "created_at": "2021-10-21T02:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462598",
    "user": "https://github.com/mkoeppe"
}
```

Optional packages working well now - https://github.com/mkoeppe/sage/actions/runs/1364372711



---

archive/issue_comments_462599.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-21T19:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462599",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_462600.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T19:49:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462600",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462601.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-21T19:54:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462601",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462602.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-10-21T19:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462602",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_462603.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-10-21T20:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462603",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_462604.json:
```json
{
    "body": "Rebased away from #31535.",
    "created_at": "2021-10-21T20:00:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462604",
    "user": "https://github.com/mkoeppe"
}
```

Rebased away from #31535.



---

archive/issue_comments_462605.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-19T01:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462605",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_462606.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-19T02:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462606",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462607.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-19T03:48:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462607",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462608.json:
```json
{
    "body": "Looks like homebrew's `gcc` package no longer installs an unversioned `gfortran` binary\n\nhttps://github.com/mkoeppe/sage/runs/4572338375?check_suite_focus=true",
    "created_at": "2021-12-20T00:51:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462608",
    "user": "https://github.com/mkoeppe"
}
```

Looks like homebrew's `gcc` package no longer installs an unversioned `gfortran` binary

https://github.com/mkoeppe/sage/runs/4572338375?check_suite_focus=true



---

archive/issue_comments_462609.json:
```json
{
    "body": "Also conda install fails early\n\nhttps://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true",
    "created_at": "2021-12-20T00:52:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462609",
    "user": "https://github.com/mkoeppe"
}
```

Also conda install fails early

https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true



---

archive/issue_comments_462610.json:
```json
{
    "body": "Replying to [comment:39 mkoeppe]:\n> Also conda install fails early\n> \n> https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true\n\n(same as #32113#comment:17)",
    "created_at": "2021-12-20T06:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462610",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:39 mkoeppe]:
> Also conda install fails early
> 
> https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true

(same as #32113#comment:17)



---

archive/issue_comments_462611.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-12-21T03:29:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462611",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_462612.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T03:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462612",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462613.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-12-21T04:52:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462613",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_462614.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T07:49:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462614",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462615.json:
```json
{
    "body": "I know we already touch upon this point, but can you please expand on\n> Unfortunately, because \u200bbecause \"needs\" cannot depend on \"matrix\", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed \n\nThat is, why do you prefer the \"custom stage build\" over having a \"local-macos-stage2\" job that depends via \"needs\" on \"local-macos-stage1\", where each of these jobs defines an appropriate matrix. In particular, I don't understand the \"all platforms\" part, as ubuntu and macos are in different jobs, right? It appears to me that with the current design also stage 1 builds are executed before any stage 2 is executed, so the only difference is that you can already have 4 or so stage 2 builds running while the last stage 1 build finishes. I guess for the overall build time this shouldn't make much of a difference anyway, as these 4 runners would be busy with other workflows then (or are free to execute builds of other stuff in the sagemath org).",
    "created_at": "2021-12-21T16:25:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462615",
    "user": "https://github.com/tobiasdiez"
}
```

I know we already touch upon this point, but can you please expand on
> Unfortunately, because ​because "needs" cannot depend on "matrix", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed 

That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix. In particular, I don't understand the "all platforms" part, as ubuntu and macos are in different jobs, right? It appears to me that with the current design also stage 1 builds are executed before any stage 2 is executed, so the only difference is that you can already have 4 or so stage 2 builds running while the last stage 1 build finishes. I guess for the overall build time this shouldn't make much of a difference anyway, as these 4 runners would be busy with other workflows then (or are free to execute builds of other stuff in the sagemath org).



---

archive/issue_comments_462616.json:
```json
{
    "body": "Replying to [comment:48 gh-tobiasdiez]:\n> That is, why do you prefer the \"custom stage build\" over having a \"local-macos-stage2\" job that depends via \"needs\" on \"local-macos-stage1\", where each of these jobs defines an appropriate matrix.\n\nTo avoid copy-paste",
    "created_at": "2021-12-21T16:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462616",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:48 gh-tobiasdiez]:
> That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix.

To avoid copy-paste



---

archive/issue_comments_462617.json:
```json
{
    "body": "Replying to [comment:48 gh-tobiasdiez]:\n>  I don't understand the \"all platforms\" part, as ubuntu and macos are in different jobs, right?\n\nYes, that's right, within each job; and in this ticket, only for macos.",
    "created_at": "2021-12-21T16:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462617",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:48 gh-tobiasdiez]:
>  I don't understand the "all platforms" part, as ubuntu and macos are in different jobs, right?

Yes, that's right, within each job; and in this ticket, only for macos.



---

archive/issue_comments_462618.json:
```json
{
    "body": "Replying to [comment:49 mkoeppe]:\n> Replying to [comment:48 gh-tobiasdiez]:\n> > That is, why do you prefer the \"custom stage build\" over having a \"local-macos-stage2\" job that depends via \"needs\" on \"local-macos-stage1\", where each of these jobs defines an appropriate matrix.\n> \n> To avoid copy-paste\n\nGithub recently made it possible to reuse workflows: https://docs.github.com/en/actions/learn-github-actions/reusing-workflows\nThus you could extract the current local-macos job into a new workflow and pass the right \"tox\" command as an argument (determined by the matrix + step).",
    "created_at": "2021-12-21T16:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462618",
    "user": "https://github.com/tobiasdiez"
}
```

Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 gh-tobiasdiez]:
> > That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix.
> 
> To avoid copy-paste

Github recently made it possible to reuse workflows: https://docs.github.com/en/actions/learn-github-actions/reusing-workflows
Thus you could extract the current local-macos job into a new workflow and pass the right "tox" command as an argument (determined by the matrix + step).



---

archive/issue_comments_462619.json:
```json
{
    "body": "Thanks for the pointer!! I've added this to #29060 for welcome future refactoring - but this won't make it into Sage 9.5",
    "created_at": "2021-12-21T16:45:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462619",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for the pointer!! I've added this to #29060 for welcome future refactoring - but this won't make it into Sage 9.5



---

archive/issue_comments_462620.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T17:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462620",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_462621.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-23T14:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462621",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_462622.json:
```json
{
    "body": "OK,macOS runs on GH look good.",
    "created_at": "2021-12-23T14:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462622",
    "user": "https://github.com/dimpase"
}
```

OK,macOS runs on GH look good.



---

archive/issue_comments_462623.json:
```json
{
    "body": "Thanks!",
    "created_at": "2021-12-23T16:25:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462623",
    "user": "https://github.com/mkoeppe"
}
```

Thanks!



---

archive/issue_events_029452.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-01-01T00:23:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32466#event-29452"
}
```



---

archive/issue_comments_462624.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-01-01T00:23:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32466",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32466#issuecomment-462624",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
