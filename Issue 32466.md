# Issue 32466: GH Actions: In tox-docker, run a job for "make build-local" first, cache image for job "make build"

Issue created by migration from https://trac.sagemath.org/ticket/32703

Original creator: mkoeppe

Original creation time: 2021-10-16 19:03:25

CC:  @tobiasdiez @kliem mjo isuruf

(+) On top of the built image containing the full SAGE_LOCAL, we can test several ways to build the Python parts
  - Sage distribution, classic
  - Sage distribution with `configure --enable-editable`
  - Sage distribution with `configure --enable-system-site-packages` (#29665)
  - the configurations from pkgs/*sagemath-standard*/tox.ini
  - build/install of modularized distributions such as pkgs/*sage-categories* (#29865), pkgs/*sagemath-standard-no-symbolics* (#32601)

(+) Splitting the job into two would also help with the configurations for which we scrape at the 6 hour time limit

(-) Unfortunately, because [because "needs" cannot depend on "matrix"](https://github.community/t/needs-based-on-matrix/132400), the jobs for building/testing Python packages would not start before all jobs building `SAGE_LOCAL` for all platforms are completed

References
- https://evilmartians.com/chronicles/build-images-on-github-actions-with-docker-layer-caching


---

Comment by mkoeppe created at 2021-10-17 01:38:12

Last 10 new commits:


---

Comment by git created at 2021-10-17 05:25:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-17 18:29:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-17 23:59:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-18 19:36:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-19 16:01:36

working well now


---

Comment by git created at 2021-10-19 17:04:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-19 17:08:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @tobiasdiez created at 2021-10-19 17:23:34

If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel. For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact. Maybe something like https://github.com/marketplace/actions/wait-for-check helps.


---

Comment by mkoeppe created at 2021-10-19 17:35:35

Replying to [comment:14 gh-tobiasdiez]:
> If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.

Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...

> For example, some stage 2 runs (e.g https://github.com/mkoeppe/sage/runs/3935018795?check_suite_focus=true) fail since they try to download a non-existing artifact.

Well, they failed because the previous stage failed.


---

Comment by mkoeppe created at 2021-10-19 17:36:00

Replying to [comment:14 gh-tobiasdiez]:
> Maybe something like https://github.com/marketplace/actions/wait-for-check helps.

Thanks for the pointer, we can look into using something like this


---

Comment by mkoeppe created at 2021-10-19 17:43:51

Testing with integrated builds for the optional packages now at https://github.com/mkoeppe/sage/actions/runs/1360303527


---

Comment by @tobiasdiez created at 2021-10-19 21:06:33

Replying to [comment:15 mkoeppe]:
> Replying to [comment:14 gh-tobiasdiez]:
> > If I understand the changes (and the output) correctly, then currently stage 1 and 2 run parallel.
> 
> Yes, in theory. But in practice we only get 5 parallel jobs on macOS and we launch many more jobs...

Okay, but isn't this a very fragile design? Imagine that you have exactly 5 matrix cases. So all of the stage 1 tasks start at the same time. Now if the last case exists slightly before the other 4, then the stage 2 for the other 4 may be invoked and now fail as their stage 1 is not yet finished. Also this would limit everything to mac, as on linux you have way more runners.


---

Comment by mkoeppe created at 2021-10-19 21:09:26

Replying to [comment:18 gh-tobiasdiez]:
> Okay, but isn't this a very fragile design? 

Yes


---

Comment by mkoeppe created at 2021-10-19 21:14:39

Replying to [comment:18 gh-tobiasdiez]:
> on linux you have way more runners.

we also have way more jobs...


---

Comment by @tobiasdiez created at 2021-10-20 07:55:30

Then I would suggest using two jobs that wait using "needs" and accept the disadvantages that go with it. 

> Unfortunately, because ​because "needs" cannot depend on "matrix", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed 

I think this is also a more flexible design as the stage two matrix will probably have more options in the future (e.g. editable install, with/without prebuild wheels from pypi, pipenv).
In fact, for maximal flexibility do you think it makes sense too split it further into 3 stages:
- Built all non-python packages (min/standard/max)
- Built all python packages (standard, editable, prebuild wheels, pipenv)
- Run doctests


---

Comment by git created at 2021-10-20 16:03:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-20 16:07:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-20 16:44:21

Yes, in stage 2 we can have all of these variants, next to the runs for the optional packages added in 313dc82

Whether the doctest needs a separate stage remains to be seen; I think having it as part of the stage 2 builds will easily fit into the 6 hour limit in all variants.


---

Comment by mkoeppe created at 2021-10-21 02:21:01

Optional packages working well now - https://github.com/mkoeppe/sage/actions/runs/1364372711


---

Comment by git created at 2021-10-21 19:45:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-10-21 19:49:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-21 19:54:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-21 19:57:08

Changing status from new to needs_review.


---

Comment by git created at 2021-10-21 20:00:33

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-10-21 20:00:53

Rebased away from #31535.


---

Comment by git created at 2021-12-19 01:26:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-12-19 02:12:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-12-19 03:48:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-20 00:51:32

Looks like homebrew's `gcc` package no longer installs an unversioned `gfortran` binary

https://github.com/mkoeppe/sage/runs/4572338375?check_suite_focus=true


---

Comment by mkoeppe created at 2021-12-20 00:52:39

Also conda install fails early

https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true


---

Comment by mkoeppe created at 2021-12-20 06:55:09

Replying to [comment:39 mkoeppe]:
> Also conda install fails early
> 
> https://github.com/mkoeppe/sage/runs/4572338435?check_suite_focus=true

(same as #32113#comment:17)


---

Comment by git created at 2021-12-21 03:29:11

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-12-21 03:36:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-21 04:52:45

Changing priority from major to critical.


---

Comment by git created at 2021-12-21 07:49:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2021-12-21 16:25:24

I know we already touch upon this point, but can you please expand on
> Unfortunately, because ​because "needs" cannot depend on "matrix", the jobs for building/testing Python packages would not start before all jobs building SAGE_LOCAL for all platforms are completed 

That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix. In particular, I don't understand the "all platforms" part, as ubuntu and macos are in different jobs, right? It appears to me that with the current design also stage 1 builds are executed before any stage 2 is executed, so the only difference is that you can already have 4 or so stage 2 builds running while the last stage 1 build finishes. I guess for the overall build time this shouldn't make much of a difference anyway, as these 4 runners would be busy with other workflows then (or are free to execute builds of other stuff in the sagemath org).


---

Comment by mkoeppe created at 2021-12-21 16:29:55

Replying to [comment:48 gh-tobiasdiez]:
> That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix.

To avoid copy-paste


---

Comment by mkoeppe created at 2021-12-21 16:30:38

Replying to [comment:48 gh-tobiasdiez]:
>  I don't understand the "all platforms" part, as ubuntu and macos are in different jobs, right?

Yes, that's right, within each job; and in this ticket, only for macos.


---

Comment by @tobiasdiez created at 2021-12-21 16:40:50

Replying to [comment:49 mkoeppe]:
> Replying to [comment:48 gh-tobiasdiez]:
> > That is, why do you prefer the "custom stage build" over having a "local-macos-stage2" job that depends via "needs" on "local-macos-stage1", where each of these jobs defines an appropriate matrix.
> 
> To avoid copy-paste

Github recently made it possible to reuse workflows: https://docs.github.com/en/actions/learn-github-actions/reusing-workflows
Thus you could extract the current local-macos job into a new workflow and pass the right "tox" command as an argument (determined by the matrix + step).


---

Comment by mkoeppe created at 2021-12-21 16:45:24

Thanks for the pointer!! I've added this to #29060 for welcome future refactoring - but this won't make it into Sage 9.5


---

Comment by git created at 2021-12-21 17:13:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-12-23 14:45:58

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-12-23 14:45:58

OK,macOS runs on GH look good.


---

Comment by mkoeppe created at 2021-12-23 16:25:46

Thanks!


---

Comment by vbraun created at 2022-01-01 00:23:33

Resolution: fixed
