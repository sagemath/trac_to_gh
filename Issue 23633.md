# Issue 23633: speed_up_Permutation_to_matrix

archive/issues_023633.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/23870\n\n",
    "created_at": "2017-09-15T17:53:51Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "speed_up_Permutation_to_matrix",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23633",
    "user": "@mantepse"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/23870





---

archive/issue_comments_330983.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330983",
    "user": "@mantepse"
}
```

New commits:



---

archive/issue_comments_330984.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330984",
    "user": "@mantepse"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_330985.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330985",
    "user": "@mantepse"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_330986.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2017-09-15T18:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330986",
    "user": "@mantepse"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_330987.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-15T19:43:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330987",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330988.json:
```json
{
    "body": "Why is this needs_info? What information are you requesting? From the sage-devel thread?\n\nAlso, trivial PEP8 thing: `sparse = True` -> `sparse=True`.",
    "created_at": "2017-09-15T19:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330988",
    "user": "@tscrim"
}
```

Why is this needs_info? What information are you requesting? From the sage-devel thread?

Also, trivial PEP8 thing: `sparse = True` -> `sparse=True`.



---

archive/issue_comments_330989.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> Why is this needs_info? What information are you requesting? From the sage-devel thread?\n\nI don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.",
    "created_at": "2017-09-15T20:06:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330989",
    "user": "@mantepse"
}
```

Replying to [comment:5 tscrim]:
> Why is this needs_info? What information are you requesting? From the sage-devel thread?

I don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.



---

archive/issue_comments_330990.json:
```json
{
    "body": "With the current version (calling the constructor directly), I'm down to\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\")\n5 loops, best of 3: 2.33 s per loop\n```\n",
    "created_at": "2017-09-15T20:27:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330990",
    "user": "@mantepse"
}
```

With the current version (calling the constructor directly), I'm down to

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 2.33 s per loop
```




---

archive/issue_comments_330991.json:
```json
{
    "body": "Using a `late_import` function, I get\n\n```\nsage: timeit(\"[elt.to_matrix() for elt in l]\", repeat=1, number=1)\n1 loops, best of 1: 3.01 s per loop\n```\n\n\nCould some design expert let me know what I should do now?\n\n1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.\n2. `Matrix_integer_sparse`: speedup by a factor 4.8\n3. both\n\nI am for 1. or 3., but do not know which of the two is really better.\n\nOf course, I am willing to run more tests, but I wouldn't know which are expressive.",
    "created_at": "2017-09-15T20:53:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330991",
    "user": "@mantepse"
}
```

Using a `late_import` function, I get

```
sage: timeit("[elt.to_matrix() for elt in l]", repeat=1, number=1)
1 loops, best of 1: 3.01 s per loop
```


Could some design expert let me know what I should do now?

1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.
2. `Matrix_integer_sparse`: speedup by a factor 4.8
3. both

I am for 1. or 3., but do not know which of the two is really better.

Of course, I am willing to run more tests, but I wouldn't know which are expressive.



---

archive/issue_comments_330992.json:
```json
{
    "body": "As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nSide note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.",
    "created_at": "2017-09-15T21:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330992",
    "user": "@tscrim"
}
```

As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.



---

archive/issue_comments_330993.json:
```json
{
    "body": "Actually, instead of directly calling the class, I would use\n\n```\nsage: MS = MatrixSpace(QQ, 3)\nsage: MS._get_matrix_class()\n<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n```\n\nbut that would be acceptable for me because it is more robust against changes in the parent.",
    "created_at": "2017-09-15T21:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330993",
    "user": "@tscrim"
}
```

Actually, instead of directly calling the class, I would use

```
sage: MS = MatrixSpace(QQ, 3)
sage: MS._get_matrix_class()
<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
```

but that would be acceptable for me because it is more robust against changes in the parent.



---

archive/issue_comments_330994.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-15T21:25:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330994",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330995.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n\nI have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n\nI have no idea what you mean here.\n\n> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n\nThis would allow to write `matrix(pi)` instead of `pi.to_matrix()`?",
    "created_at": "2017-09-15T21:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330995",
    "user": "@mantepse"
}
```

Replying to [comment:9 tscrim]:
> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

I have no idea what you mean here.

> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?



---

archive/issue_comments_330996.json:
```json
{
    "body": "Replying to [comment:10 tscrim]:\n> Actually, instead of directly calling the class, I would use\n> {{{\n> sage: MS = MatrixSpace(QQ, 3)\n> sage: MS._get_matrix_class()\n> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> }}}\n> but that would be acceptable for me because it is more robust against changes in the parent.\n\nI tried this, but it kills quite a bit of the performance gain.",
    "created_at": "2017-09-15T21:31:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330996",
    "user": "@mantepse"
}
```

Replying to [comment:10 tscrim]:
> Actually, instead of directly calling the class, I would use
> {{{
> sage: MS = MatrixSpace(QQ, 3)
> sage: MS._get_matrix_class()
> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> }}}
> but that would be acceptable for me because it is more robust against changes in the parent.

I tried this, but it kills quite a bit of the performance gain.



---

archive/issue_comments_330997.json:
```json
{
    "body": "Replying to [comment:12 mantepse]:\n> Replying to [comment:9 tscrim]:\n> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).\n> \n> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n\n`grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\n> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).\n> \n> I have no idea what you mean here.\n\nThis is what is done in the `matrix()` construction function. You just check `hasattr(M, \"_matrix_\")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).\n\n> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.\n> \n> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?\n\nCorrect.",
    "created_at": "2017-09-15T21:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330997",
    "user": "@tscrim"
}
```

Replying to [comment:12 mantepse]:
> Replying to [comment:9 tscrim]:
> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).
> 
> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

`grep` for `lazy_import`. It's self-explanatory and all over Sage.

> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).
> 
> I have no idea what you mean here.

This is what is done in the `matrix()` construction function. You just check `hasattr(M, "_matrix_")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).

> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.
> 
> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?

Correct.



---

archive/issue_comments_330998.json:
```json
{
    "body": "Replying to [comment:13 mantepse]:\n> Replying to [comment:10 tscrim]:\n> > Actually, instead of directly calling the class, I would use\n> > {{{\n> > sage: MS = MatrixSpace(QQ, 3)\n> > sage: MS._get_matrix_class()\n> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>\n> > }}}\n> > but that would be acceptable for me because it is more robust against changes in the parent.\n> \n> I tried this, but it kills quite a bit of the performance gain.\n\nThe problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a ``@`lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).",
    "created_at": "2017-09-15T21:55:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330998",
    "user": "@tscrim"
}
```

Replying to [comment:13 mantepse]:
> Replying to [comment:10 tscrim]:
> > Actually, instead of directly calling the class, I would use
> > {{{
> > sage: MS = MatrixSpace(QQ, 3)
> > sage: MS._get_matrix_class()
> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> > }}}
> > but that would be acceptable for me because it is more robust against changes in the parent.
> 
> I tried this, but it kills quite a bit of the performance gain.

The problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a ``@`lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).



---

archive/issue_comments_330999.json:
```json
{
    "body": "> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.\n> \n> `grep` for `lazy_import`. It's self-explanatory and all over Sage.\n\nI did this before I wrote the `late_import` thing:\n\n\n```\nfrom sage.misc.lazy_import import lazy_import\nlazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')\nlazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')\n```\n\n\nbut sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.",
    "created_at": "2017-09-15T22:08:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-330999",
    "user": "@mantepse"
}
```

> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.
> 
> `grep` for `lazy_import`. It's self-explanatory and all over Sage.

I did this before I wrote the `late_import` thing:


```
from sage.misc.lazy_import import lazy_import
lazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')
lazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')
```


but sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.



---

archive/issue_comments_331000.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-15T22:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331000",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_331001.json:
```json
{
    "body": "You needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a ``@`lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.\n\nIf my changes are good, then I think we can set a positive review.\n----\nNew commits:",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331001",
    "user": "@tscrim"
}
```

You needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a ``@`lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.

If my changes are good, then I think we can set a positive review.
----
New commits:



---

archive/issue_comments_331002.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-09-16T21:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331002",
    "user": "@tscrim"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_331003.json:
```json
{
    "body": "Great and thank you for explaining `startup`!  One question: is this going to affect startup time?",
    "created_at": "2017-09-17T06:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331003",
    "user": "@mantepse"
}
```

Great and thank you for explaining `startup`!  One question: is this going to affect startup time?



---

archive/issue_comments_331004.json:
```json
{
    "body": "Not really, or at least I would be surprised if it did have an impact.",
    "created_at": "2017-09-17T07:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331004",
    "user": "@tscrim"
}
```

Not really, or at least I would be surprised if it did have an impact.



---

archive/issue_comments_331005.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-17T07:25:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331005",
    "user": "@mantepse"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_331006.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-20T22:26:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23633#issuecomment-331006",
    "user": "@vbraun"
}
```

Resolution: fixed
