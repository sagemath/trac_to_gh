# Issue 23633: speed_up_Permutation_to_matrix

Issue created by migration from https://trac.sagemath.org/ticket/23870

Original creator: mantepse

Original creation time: 2017-09-15 17:53:51




---

Comment by mantepse created at 2017-09-15 18:07:47

New commits:


---

Comment by mantepse created at 2017-09-15 18:07:47

Changing status from new to needs_info.


---

Comment by mantepse created at 2017-09-15 18:07:47

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mantepse created at 2017-09-15 18:07:47

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by git created at 2017-09-15 19:43:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-09-15 19:50:24

Why is this needs_info? What information are you requesting? From the sage-devel thread?

Also, trivial PEP8 thing: `sparse = True` -> `sparse=True`.


---

Comment by mantepse created at 2017-09-15 20:06:04

Replying to [comment:5 tscrim]:
> Why is this needs_info? What information are you requesting? From the sage-devel thread?

I don't really like calling `Matrix_integer_sparse` directly.  I still have to check whether I can get comparable speed by removing the local imports in `MatrixSpace.matrix`.  If so, I would like to know why they are there in the first place.


---

Comment by mantepse created at 2017-09-15 20:27:14

With the current version (calling the constructor directly), I'm down to

```
sage: timeit("[elt.to_matrix() for elt in l]")
5 loops, best of 3: 2.33 s per loop
```



---

Comment by mantepse created at 2017-09-15 20:53:41

Using a `late_import` function, I get

```
sage: timeit("[elt.to_matrix() for elt in l]", repeat=1, number=1)
1 loops, best of 1: 3.01 s per loop
```


Could some design expert let me know what I should do now?

1. `late_import`: speedup by a factor 3.7, but all calls to `MatrixSpace` benefit.
2. `Matrix_integer_sparse`: speedup by a factor 4.8
3. both

I am for 1. or 3., but do not know which of the two is really better.

Of course, I am willing to run more tests, but I wouldn't know which are expressive.


---

Comment by tscrim created at 2017-09-15 21:20:21

As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too). However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.


---

Comment by tscrim created at 2017-09-15 21:24:06

Actually, instead of directly calling the class, I would use

```
sage: MS = MatrixSpace(QQ, 3)
sage: MS._get_matrix_class()
<type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
```

but that would be acceptable for me because it is more robust against changes in the parent.


---

Comment by git created at 2017-09-15 21:25:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2017-09-15 21:30:41

Replying to [comment:9 tscrim]:
> As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).

I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

> However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).

I have no idea what you mean here.

> Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.

This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?


---

Comment by mantepse created at 2017-09-15 21:31:21

Replying to [comment:10 tscrim]:
> Actually, instead of directly calling the class, I would use
> {{{
> sage: MS = MatrixSpace(QQ, 3)
> sage: MS._get_matrix_class()
> <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> }}}
> but that would be acceptable for me because it is more robust against changes in the parent.

I tried this, but it kills quite a bit of the performance gain.


---

Comment by tscrim created at 2017-09-15 21:50:39

Replying to [comment:12 mantepse]:
> Replying to [comment:9 tscrim]:
> > As I mentioned on sage-devel, use `lazy_import`, which should be more efficient because you don't have to do a Python call every time (which I am slightly surprised that the late_import is faster too).
> 
> I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.

`grep` for `lazy_import`. It's self-explanatory and all over Sage.

> > However, I am thinking a better way out is to use the hook we already have for matrices by `_matrix_`, which will open it up to more things (things that, IMO, it should already work for).
> 
> I have no idea what you mean here.

This is what is done in the `matrix()` construction function. You just check `hasattr(M, "_matrix_")`. So, for example, permutations would be accepted as input with the change proposed below (which, IMO, is very natural).

> > Side note - I feel permutations should have `_matrix_ = to_matrix` to use `matrix(P)`.
> 
> This would allow to write `matrix(pi)` instead of `pi.to_matrix()`?

Correct.


---

Comment by tscrim created at 2017-09-15 21:55:07

Replying to [comment:13 mantepse]:
> Replying to [comment:10 tscrim]:
> > Actually, instead of directly calling the class, I would use
> > {{{
> > sage: MS = MatrixSpace(QQ, 3)
> > sage: MS._get_matrix_class()
> > <type 'sage.matrix.matrix_rational_dense.Matrix_rational_dense'>
> > }}}
> > but that would be acceptable for me because it is more robust against changes in the parent.
> 
> I tried this, but it kills quite a bit of the performance gain.

The problem is caching. It is, in effect, cached, by being called in the `__init__` and setting the attribute `__matrix_class`. I am sure this was written a long time ago. So I would probably make `_matrix_class` a ``@`lazy_attribute`, replace the `__matrix_class` with `_matrix_class`, and get rid of `_get_matrix_class` (it needs no deprecation because it is not public).


---

Comment by mantepse created at 2017-09-15 22:08:05

> > I have no idea how to use `lazy_import`.  I just pushed my `late_import` implementation, maybe you can guide me.
> 
> `grep` for `lazy_import`. It's self-explanatory and all over Sage.

I did this before I wrote the `late_import` thing:


```
from sage.misc.lazy_import import lazy_import
lazy_import('sage.groups.matrix_gps.group_element', 'is_MatrixGroupElement')
lazy_import('sage.modular.arithgroup.arithgroup_element', 'ArithmeticSubgroupElement')
```


but sage crashed on startup.  But I didn't try long - maybe I made a mistake when compiling or so.


---

Comment by git created at 2017-09-15 22:25:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-09-16 21:11:32

You needed to tell Sage that this needs to be resolved at startup (as the error message indicates). This is primarily a temporary solution until more involved changes with the matrix spaces are done (make `_get_matrix_class` into a ``@`lazy_attribute` `Element` so it behaves more like a proper parent and we can then use `MS.element_class` and use the methods `_matrix_`/`matrix` for constructing `matrix` and possibly coercion), which might need some further discussions.

If my changes are good, then I think we can set a positive review.
----
New commits:


---

Comment by tscrim created at 2017-09-16 21:11:32

Changing status from needs_info to needs_review.


---

Comment by mantepse created at 2017-09-17 06:36:17

Great and thank you for explaining `startup`!  One question: is this going to affect startup time?


---

Comment by tscrim created at 2017-09-17 07:19:25

Not really, or at least I would be surprised if it did have an impact.


---

Comment by mantepse created at 2017-09-17 07:25:05

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-20 22:26:20

Resolution: fixed
