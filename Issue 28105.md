# Issue 28105: spkg-configure.m4 for m4ri, m4rie, givaro

Issue created by migration from https://trac.sagemath.org/ticket/28342

Original creator: dimpase

Original creation time: 2019-08-11 07:58:06

CC:  embray fbissey isuruf

these are very straightforward, basically just doing dependencies and version checks. 

`m4ri(e)` are quite stable, and it appears impossibe to distinguish the present version of `m4rie` from the older one. We just rely on the version of `m4ri`, it's dependence, which thankfully has pkg-config support.
 


---

Comment by dimpase created at 2019-08-11 08:00:43

see https://bitbucket.org/malb/m4rie/issues/18/add-pkg-config-support


---

Comment by dimpase created at 2019-08-11 19:58:27

Changing status from new to needs_review.


---

Comment by dimpase created at 2019-08-11 19:58:27

this is quite straighforward w.r.t. to m4ri(e) and givaro spkg-configure files, less so
with a macro to check dependencies that I wrote and used on these examples. Please review.
----
New commits:


---

Comment by git created at 2019-08-11 20:02:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-08-11 21:57:04

One improvement for SAGE_SPKG_DEPCHECK would be to get rid of the 1st argument, the package name. After all it is called from within SAGE_SPKG_CONFIGURE, and the package name should be "known", but I have no clue how to get it.


---

Comment by isuruf created at 2019-08-14 16:25:21

This works for me on conda. Somebody else should review the macro.


---

Comment by embray created at 2019-08-15 09:16:42

Replying to [comment:4 dimpase]:
> One improvement for SAGE_SPKG_DEPCHECK would be to get rid of the 1st argument, the package name. After all it is called from within SAGE_SPKG_CONFIGURE, and the package name should be "known", but I have no clue how to get it.

If it's only used within `SAGE_SPKG_CONFIGURE` it can probably use the `SPKG_NAME` macro.  But I think it's maybe a bit cleaner actually to keep it more independent.


---

Comment by dimpase created at 2019-08-15 09:27:28

Already working on this ticket I made an error involving the 1st parameter of `SAGE_SPKG_DEPCHECK`, as I copy-pasted it and didn't adjust is :-)

As we should eventually rewrite already done 20 or 30 spkg-configure.4 files using this macro, it's better to minimise the number of places one can make this sort of error...


---

Comment by embray created at 2019-08-15 11:51:14

I think a typo in `SAGE_SPKG_DEPCHECK`:


```
AC_DEFUN([SAGE_SPKG_DEPCHECK], [
+    m4_foreach_w([DEP], $2, [
+       AC_REQUIRE([SAGE_SPKG_CONFIGURE_]m4_toupper(DEP))])
+    AC_MSG_CHECKING([installing $2? ])
+    AS_IF([test x = y m4_foreach_w([DEP], $2, [ -o [x$sage_spkg_install_]DEP = x$yes])],
```


At the end of the last line I think you just meant `xyes` not `x$yes`.


---

Comment by embray created at 2019-08-15 11:52:02

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-08-17 19:17:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2019-08-17 19:18:52

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-08-17 19:18:52

OK, fixed that embarassing extra $, and further improvements (see commits). Needs review.


---

Comment by git created at 2019-08-18 09:29:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-08-18 13:37:40

I don't really think [afacd43](https://git.sagemath.org/sage.git/commit/?id=afacd43081bb1bbcc91c8a8e8ee8f02933dfabdc) is much of an improvement.  To me it looks fragile and potentially confusing.  But I won't fight it for now, as long as it works, if you really think it's better...


---

Comment by embray created at 2019-08-18 13:46:16

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-08-18 13:46:16

The m4ri in my (old-ish) Ubuntu is _too_ old to otherwise test this.

I had a container with a newer Ubuntu but it seems to have gone away.  I'll set that up again, but in the meantime I think this looks good assuming it works at least on your system.


---

Comment by dimpase created at 2019-08-18 15:10:07

you may try installing m4ri(e) in /usr/local/, for testing.

certainly the new macro should have been a part of sage_spkg_configure() all along, getting rid of one parameter is a step towards this refactoring...


---

Comment by embray created at 2019-08-18 18:56:33

I got a new Ubuntu 18.04 container set up and it worked! :)


---

Comment by vbraun created at 2019-08-19 22:08:55

Resolution: fixed


---

Comment by dimpase created at 2019-08-21 20:17:09

It seems something wasn't fully tested w.r.t. #26932, and in fact this needs

```diff
--- a/build/pkgs/givaro/spkg-configure.m4
+++ b/build/pkgs/givaro/spkg-configure.m4
@@ -1,5 +1,5 @@
 SAGE_SPKG_CONFIGURE([givaro], [
-    m4_pushdef([SAGE_GIVARO_MINVER],["40004"])
+    m4_pushdef([SAGE_GIVARO_MINVER],["40101"])
     SAGE_SPKG_DEPCHECK([gmp mpir], [
         AC_PATH_PROG([GIVAROCONFIG], [givaro-config])
         AS_IF([test x$GIVAROCONFIG = x], [
```

I've opened #28380 to fix this.
