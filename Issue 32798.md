# Issue 32798: random doctest failure in src/sage/tests/book_stein_ent.py

Issue created by migration from https://trac.sagemath.org/ticket/33035

Original creator: lorenz

Original creation time: 2021-12-17 07:05:21

CC:  was

Part of #32544:

```
sage -t --long --random-seed=248665222928234939040854301866666446071 src/sage/tests/book_stein_ent.py
**********************************************************************
File "src/sage/tests/book_stein_ent.py", line 208, in sage.tests.book_stein_ent
Failed example:
    decrypt(c, d, n)
Expected:
    123
Got:
    109489
**********************************************************************
1 item had failures:
   1 of 262 in sage.tests.book_stein_ent
    [261 tests, 1 failure, 15.47 s]
```

(From a patchbot run in #32744.)


---

Comment by lorenz created at 2021-12-17 07:08:17

The error is because the preceding call to `rsa()` generates a key with `p=q` when using this seed.


---

Comment by mjo created at 2021-12-29 12:35:12

Instead of


```
....:     p = next_prime(ZZ.random_element(2**(bits//2 +1)),
....:                    proof=proof)
....:     q = next_prime(ZZ.random_element(2**(bits//2 +1)),
....:                    proof=proof)
```


we should be able to do


```
....:     p = q = ZZ.zero()
....:     while (p == q):
....:         p = next_prime(ZZ.random_element(2**(bits//2 +1)),
....:                        proof=proof)
....:         q = next_prime(ZZ.random_element(2**(bits//2 +1)),
....:                        proof=proof)
```


(we really only need to regenerate `q`, but this is nice and symmetric.)

But for these tests to serve their intended purpose we'll need William (hint hint) to pick a solution so that it can be incorporated into the book (https://github.com/williamstein/ent) as well.


---

Comment by was created at 2021-12-29 13:44:19

Hint taken.  How about this?


```
....:     while True:
....:         p = next_prime(ZZ.random_element(2**(bits//2 + 1)),
....:                        proof=proof)
....:         q = next_prime(ZZ.random_element(2**(bits//2 + 1)),
....:                        proof=proof)
....:         if p != q: break
```



---

Comment by mjo created at 2021-12-29 14:01:14

Replying to [comment:4 was]:
> Hint taken.  How about this?
> 

Even better. I'll post a branch later today. Thanks.


---

Comment by mjo created at 2021-12-29 18:09:41

Last 10 new commits:


---

Comment by mjo created at 2021-12-29 18:09:41

Changing status from new to needs_review.


---

Comment by mjo created at 2021-12-29 18:10:56

Those extra commits are from #32907 which is already merged but isn't in beta9.


---

Comment by git created at 2021-12-29 18:50:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2022-01-16 15:38:08

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2022-01-30 15:39:13

Setting milestone to 9.6 now that 9.5 is out.


---

Comment by vbraun created at 2022-02-16 23:56:37

Resolution: fixed
