# Issue 27045: integer_mod.lucas: calling remove_from_pari_stack() inside sig_on

Issue created by migration from https://trac.sagemath.org/ticket/27282

Original creator: vbraun

Original creation time: 2019-02-14 19:51:23

CC:  jdemeyer

I found another one:

```
**********************************************************************
File "src/sage/rings/finite_rings/integer_mod.pyx", line 4044, in sage.rings.finite_rings.integer_mod.lucas
Failed example:
    all([lucas(k,p,q,n)[0] == Mod(lucas_number2(k,p,q),n)
         for k in Integers(20)])
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.finite_rings.integer_mod.lucas[4]>", line 2, in <module>
        for k in Integers(Integer(20))])
      File "sage/rings/finite_rings/integer_mod.pyx", line 4095, in sage.rings.finite_rings.integer_mod.lucas (build/cythonized/sage/rings/finite_rings/integer_mod.c:38164)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
**********************************************************************
```



---

Comment by jdemeyer created at 2019-02-14 22:37:07

New commits:


---

Comment by jdemeyer created at 2019-02-14 22:37:07

Changing status from new to needs_review.


---

Comment by tscrim created at 2019-02-15 19:34:42

Doctest failures on 2 patchbots:

```
sage -t --long src/sage/arith/misc.py  # Timed out
sage -t --long src/sage/tests/book_stein_ent.py  # 2 doctests failed
sage -t --long src/sage/schemes/elliptic_curves/ell_point.py  # 3 doctests failed
sage -t --long src/sage/coding/grs.py  # 3 doctests failed
```

The timeout seems to fail on this test `two_squares(2^222+1)`.
From the `ell_point.py` failures, it seems like the return type gets altered with your changes.


---

Comment by tscrim created at 2019-02-16 17:21:51

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-02-16 21:51:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-02-16 22:09:21

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-02-17 00:39:27

Green bot => positive review.


---

Comment by tscrim created at 2019-02-17 00:51:09

Patchbot failures seem unrelated.


---

Comment by tscrim created at 2019-02-17 00:51:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-02-22 22:01:36

Resolution: fixed
