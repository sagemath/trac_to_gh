# Issue 28092: Suppress warnings from failed psutil statistics collection

Issue created by migration from https://trac.sagemath.org/ticket/28329

Original creator: mjo

Original creation time: 2019-08-06 21:18:38

CC:  embray jdemeyer

I see this every time I start [SageMath](SageMath):


```
/home/mjo/src/sage.git/local/lib/python2.7/site-packages/psutil/_pslinux.py:489: RuntimeWarning: 'sin' and 'sout' swap memory stats couldn't be determined and were set to 0
  warnings.warn(msg, RuntimeWarning)
sage: 
```


The warning is displayed when psutil can't gather swap statistics, which in turn happens because my /proc/vmstat pseudo-file is missing "pswpin" and "pswpout" lines. (Why? Who knows.)

We don't need those statistics, however, so it should be possible to hide the warnings.


---

Comment by mjo created at 2019-08-06 21:20:48

Changing status from new to needs_review.


---

Comment by mjo created at 2019-08-06 21:20:48

New commits:


---

Comment by git created at 2019-08-25 16:49:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2019-08-25 16:50:59

I figured it out. Those two vmstat entries are missing if `CONFIG_VM_EVENT_COUNTERS` is unset in your kernel. Force-pushed with an updated commit message, and CCing the two people who look like the bosses of psutil.


---

Comment by dimpase created at 2019-12-08 09:43:42

Looks good to me, I tested this on Linux. 

Our psutil is old, due to its not ported to cygwin, so have have a patch, etc...


---

Comment by dimpase created at 2019-12-08 09:54:41

rebased over latest beta
----
New commits:


---

Comment by dimpase created at 2019-12-08 09:54:41

Changing priority from minor to major.


---

Comment by mjo created at 2019-12-08 13:32:05

Replying to [comment:4 dimpase]:
> **Cc** embray added; ebray removed

Derp, thanks Dima.


---

Comment by dimpase created at 2019-12-08 17:46:51

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-12-08 17:46:51

LGTM, also tested on OSX 10.13. Actually, unless `warnings` is pretty much broken on a platform, it should be OK. So I brave to give it a positive review.


---

Comment by @mwageringel created at 2019-12-08 20:00:51

The patchbots report a failure in `src/sage/groups/matrix_gps/homset.py`. I am not sure how it is caused by this ticket though.


```
File "src/sage/groups/matrix_gps/homset.py", line 44, in sage.groups.matrix_gps.homset.is_MatrixGroupHomset
Failed example:
    is_MatrixGroupHomset(M)
Expected:
    True
Got:
    ...
    DeprecationWarning: MatrixGroupHomset is deprecated. Use GroupHomset_libgap instead.
    See https://trac.sagemath.org/25444 for details.
    True
```



---

Comment by dimpase created at 2019-12-08 20:03:00

Replying to [comment:9 gh-mwageringel]:
> The patchbots report a failure in `src/sage/groups/matrix_gps/homset.py`. I am not sure how it is caused by this ticket though.
> 
> {{{
> File "src/sage/groups/matrix_gps/homset.py", line 44, in sage.groups.matrix_gps.homset.is_MatrixGroupHomset
> Failed example:
>     is_MatrixGroupHomset(M)
> Expected:
>     True
> Got:
>     ...
>     DeprecationWarning: MatrixGroupHomset is deprecated. Use GroupHomset_libgap instead.
>     See https://trac.sagemath.org/25444 for details.
>     True
> }}}

Cf #25444#comment:34

I cannot imagine that this ticket has anything to do with that...


---

Comment by dimpase created at 2019-12-08 20:06:41

but apparently it does... hmm...


---

Comment by dimpase created at 2019-12-08 20:10:57

the only possible reason seems to be that the state is modified by `warnings.simplefilter("ignore")` and kept that way, or some other side effect happens...


---

Comment by dimpase created at 2019-12-08 20:16:49

Changing status from positive_review to needs_work.


---

Comment by @mwageringel created at 2019-12-08 20:25:45

Replying to [comment:12 dimpase]:
> the only possible reason seems to be that the state is modified by `warnings.simplefilter("ignore")` and kept that way, or some other side effect happens...

Indeed, if I understand correctly, according to [ticket:24755#comment:7], this seems to be the case and it is probably harmless:

>> This also explained why we get erratic behavior w.r.t. warnings in the Sage doctests.  Although there aren't many cases directly in the doctests where we directly manipulate the warnings filter, there are at least a few (and probably more cases where we do so indirectly).  So every time that happens it resets whether a warning has been displayed =_=


---

Comment by dimpase created at 2019-12-08 20:32:04

I just read the doc :-)
https://docs.python.org/3/library/warnings.html

```
Note: this can only be guaranteed in a single-threaded application. If two or more threads use the catch_warnings context manager at the same time, the behavior is undefined.
```



---

Comment by mjo created at 2019-12-08 21:12:52

JFC, what a time to be alive =)

Thanks for catching that, I'll fix it in a different way.


---

Comment by dimpase created at 2019-12-08 22:44:41

But, isn't the deprecation message in comment:9 actually **correct** ?

I.e. by right the test there should show a deprecation message, it just doesn't for a reason which probably has to do with threading (and this branch has kicked this can further down the road, so it started doing the right thing)?


---

Comment by mjo created at 2019-12-08 22:54:45

Replying to [comment:17 dimpase]:
> But, isn't the deprecation message in comment:9 actually **correct** ?
> 
> I.e. by right the test there should show a deprecation message, it just doesn't for a reason which probably has to do with threading (and this branch has kicked this can further down the road, so it started doing the right thing)?

Yes, it looks to me like that doctest should have been throwing a warning all along.

Nevertheless, I should be more careful when poking global state.


---

Comment by mjo created at 2019-12-09 02:33:08

Let's see what goes wrong this time...
----
New commits:


---

Comment by mjo created at 2019-12-09 02:33:08

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-12-09 10:15:29

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2019-12-09 10:15:29

OK.


---

Comment by embray created at 2019-12-09 10:41:15

Replying to [comment:15 dimpase]:
> I just read the doc :-)
> https://docs.python.org/3/library/warnings.html
> {{{
> Note: this can only be guaranteed in a single-threaded application. If two or more threads use the catch_warnings context manager at the same time, the behavior is undefined.
> }}}

For the record, sage's doctests run in multiple processes.  Sage is single-threaded and threads have nothing to do with this.


---

Comment by embray created at 2019-12-09 10:44:51

Replying to [comment:18 mjo]:
> Replying to [comment:17 dimpase]:
> > But, isn't the deprecation message in comment:9 actually **correct** ?
> > 
> > I.e. by right the test there should show a deprecation message, it just doesn't for a reason which probably has to do with threading (and this branch has kicked this can further down the road, so it started doing the right thing)?
> 
> Yes, it looks to me like that doctest should have been throwing a warning all along.

Yes and no.  The way Sage's doctest runner handles warnings is actually broken and a bit arbitrary, in part due to #25444#comment:34

If the warning had already been displayed once in the course of testing a single module, it _should not_ be displayed again while testing that same module.  But due to that bug in the warnings module, the warning state can get reset and be displayed again when it shouldn't be.


---

Comment by dimpase created at 2019-12-09 10:49:46

Replying to [comment:21 embray]:
> Replying to [comment:15 dimpase]:
> > I just read the doc :-)
> > https://docs.python.org/3/library/warnings.html
> > {{{
> > Note: this can only be guaranteed in a single-threaded application. If two or more threads use the catch_warnings context manager at the same time, the behavior is undefined.
> > }}}
> 
> For the record, sage's doctests run in multiple processes.  Sage is single-threaded and threads have nothing to do with this.

well, this is not true, cf. e.g. #22766 which shows how to crash Sage using the fact that it's not single-threaded :-)


---

Comment by mjo created at 2019-12-09 14:57:36

My own ptestlong more or less passed, with only some failures in glpk that are probably due to using the system copy instead of the bundled one. The failures don't involve warnings, anyway.

Replying to [comment:22 embray]:
> If the warning had already been displayed once in the course of testing a single module, it should not be displayed again while testing that same module.

There's only one test in that module, and the module only does one thing. I still think it should be displayed, but I'm not sure it's worth investigating if there are bigger known problems with warnings in doctests. With the new approach, we can at least be reasonably certain I haven't made anything worse.

While the doctests may not be threaded, sage is a library, and we don't know what client code is doing with it -- so the safer the better.


---

Comment by embray created at 2019-12-09 16:39:00

Replying to [comment:23 dimpase]:
> Replying to [comment:21 embray]:
> > Replying to [comment:15 dimpase]:
> > > I just read the doc :-)
> > > https://docs.python.org/3/library/warnings.html
> > > {{{
> > > Note: this can only be guaranteed in a single-threaded application. If two or more threads use the catch_warnings context manager at the same time, the behavior is undefined.
> > > }}}
> > 
> > For the record, sage's doctests run in multiple processes.  Sage is single-threaded and threads have nothing to do with this.
> 
> well, this is not true, cf. e.g. #22766 which shows how to crash Sage using the fact that it's not single-threaded :-)
> 
That only affects the REPL; in the tests there are only one thread running.


---

Comment by vbraun created at 2019-12-11 21:46:28

Resolution: fixed
