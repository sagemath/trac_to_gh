# Issue 23005: Allow `make ptest*` to honor SAGE_NUM_THREADS

Issue created by migration from https://trac.sagemath.org/ticket/23242

Original creator: embray

Original creation time: 2017-06-15 08:08:45

This change simply passes the value of `SAGE_NUM_THREADS` for the `-p` flag when running `make ptest` and similar targets.


---

Comment by embray created at 2017-06-15 08:08:55

Changing status from new to needs_review.


---

Comment by tscrim created at 2017-06-15 08:14:26

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-06-15 08:14:26

Sounds reasonable, especially since there is no other way to pass such a parameter IIRC.


---

Comment by jdemeyer created at 2017-06-15 13:19:40

Which problem does this fix? `SAGE_NUM_THREADS` already works without this patch.


---

Comment by jdemeyer created at 2017-06-15 13:19:47

Changing status from positive_review to needs_info.


---

Comment by embray created at 2017-06-15 14:04:16

Well it looks to me like this is all a bit of a mess really.  According to the docs:

> `SAGE_NUM_THREADS` - if set to a number, then when building the documentation, parallel doctesting, or running `sage -b`, use this many threads. If this is not set, then determine the number of threads using the value of the `MAKE` (see above) or `MAKEFLAGS` environment variables. If none of these specifies a number of jobs, use one thread (except for parallel testing: there we use a default of the number of CPU cores, with a maximum of 8 and a minimum of 2).

But in reality `sage-runtests` doesn't use any of this, and instead checks `SAGE_NUM_THREADS_PARALLEL` which is set in `sage-env` using the `sage-num-threads.py` script (???).  `SAGE_NUM_THREADS_PARALLEL` isn't documented anywhere, much less as the way to set the default number of processes to use for sage-runtests -p`.

I don't understand what the distinction between `SAGE_NUM_THREADS` and `SAGE_NUM_THREADS_PARALLEL` is supposed to be (the use of "threads" is a bit misleading too, though you could at least argue that each process has a main thread...).

Point being, there's no well-documented way to control how many processes to use when running `make ptest`, and this adds at least _a_ way that's more or less consistent with what's documented.


---

Comment by embray created at 2017-06-15 15:47:25

Resolution: worksforme


---

Comment by embray created at 2017-06-15 15:47:25

I gave it another try without this patch, and it looks like this isn't needed after all as Jeroen suggested.  The current behavior _is_ right.  Convoluted and hard to trace, but it does seem to work.


---

Comment by jdemeyer created at 2017-06-16 07:49:45

Replying to [comment:6 embray]:
> Convoluted and hard to trace

I don't think it's so bad. The script `sage-num-threads.py` is where all decisions regarding number of threads/processes are made. Other parts of Sage (like the doctester) use the output of that script. I think the script itself is reasonably documented.


---

Comment by embray created at 2017-06-16 08:43:48

I think the script itself is not so bad, but it's not obvious if you don't know about it how these values are getting set.  There's a disconnect between the docs (e.g. "use `SAGE_NUM_THREADS`") and things like the implementation of the test runner ("default to `SAGE_NUM_THREADS_PARALLEL`"--which leads to "where the heck did that come from?).  That is, just reading the code doesn't suggest any obvious path for this value is actually getting set because it happens extrinsically when setting up `sage-env`.

Now that I understand, I don't think it's so bad either.  Just not obvious.
