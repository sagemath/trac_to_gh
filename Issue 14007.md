# Issue 14007: Crash in GiNaC::Number_T::hash()

archive/issues_014007.json:
```json
{
    "body": "Assignee: @burcin\n\n\n```\nsage: pU = vector([0,0])                            \nsage: pB = vector([2,0])                            \nsage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         \nsage: d = (pB-pU).row()*(pB-pU).column()                                                              \nsage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()\nsage: f1(x) == f2(x)\n([4*(tau - 1)^2]) == ([4*tau^2 - 8*tau + 4])\nsage: bool(f1(x) == f2(x))\nterminate called after throwing an instance of 'std::runtime_error'\n  what():  Number_T::hash() python function (__hash__) raised exception\n...\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14211\n\n",
    "created_at": "2013-03-01T17:45:10Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Crash in GiNaC::Number_T::hash()",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14007",
    "user": "@orlitzky"
}
```
Assignee: @burcin


```
sage: pU = vector([0,0])                            
sage: pB = vector([2,0])                            
sage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         
sage: d = (pB-pU).row()*(pB-pU).column()                                                              
sage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()
sage: f1(x) == f2(x)
([4*(tau - 1)^2]) == ([4*tau^2 - 8*tau + 4])
sage: bool(f1(x) == f2(x))
terminate called after throwing an instance of 'std::runtime_error'
  what():  Number_T::hash() python function (__hash__) raised exception
...
```


Issue created by migration from https://trac.sagemath.org/ticket/14211





---

archive/issue_comments_174885.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2015-01-31T10:00:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174885",
    "user": "@rwst"
}
```

Changing priority from major to critical.



---

archive/issue_comments_174886.json:
```json
{
    "body": "Reported as https://github.com/pynac/pynac/issues/34",
    "created_at": "2015-05-03T07:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174886",
    "user": "@rwst"
}
```

Reported as https://github.com/pynac/pynac/issues/34



---

archive/issue_comments_174887.json:
```json
{
    "body": "Minimal case given. In Sage `hash(matrix())` will not allow hashing probably because `PyObject_Hash` will fail and to prevent that. The fail happens in Pynac nevertheless because the check is avoided due to function expansion and there leads to the crash.\n\nOne part of the fix is preventing Sage from crashing. Surrounding the call to Pynac in `Expression::__nonzero__` with guards:\n\n```\n            sig_on()\n            pynac_result = relational_to_bool(self._gobj)\n            sig_off()\n```\n\nleads to:\n\n```\nsage: bool(f(x)==f(x))\nterminate called after throwing an instance of 'std::runtime_error'\n  what():  Number_T::hash() python function (__hash__) raised exception\n---------------------------------------------------------------------------\nTypeError: mutable matrices are unhashable\n```\n\nwhich is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?",
    "created_at": "2015-05-03T08:53:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174887",
    "user": "@rwst"
}
```

Minimal case given. In Sage `hash(matrix())` will not allow hashing probably because `PyObject_Hash` will fail and to prevent that. The fail happens in Pynac nevertheless because the check is avoided due to function expansion and there leads to the crash.

One part of the fix is preventing Sage from crashing. Surrounding the call to Pynac in `Expression::__nonzero__` with guards:

```
            sig_on()
            pynac_result = relational_to_bool(self._gobj)
            sig_off()
```

leads to:

```
sage: bool(f(x)==f(x))
terminate called after throwing an instance of 'std::runtime_error'
  what():  Number_T::hash() python function (__hash__) raised exception
---------------------------------------------------------------------------
TypeError: mutable matrices are unhashable
```

which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?



---

archive/issue_comments_174888.json:
```json
{
    "body": "Replying to [comment:8 rws]:\n> which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?\n\nBecause the default for matrix creation is to create a mutable matrix. That's because a mutable matrix can be turned into an immutable one, but not the other way around (that requires copying the matrix to a new, mutable, one). That default is probably inconvenient for symbolics.\n\nAre you sure this is the sole problem, though? If we try this:\n\n```\ndef imm_mt(*args,**kwargs):\n    M=matrix(*args,**kwargs)\n    M.set_immutable()\n    return M\nf(x)=imm_mt()\n```\n\nthen we get\n\n```\nsage: hash(f(x))\n0\n```\n\nbut `bool(f(x)==f(x))` still crashes. is it trying to see if `f(x)*f(x)^(-1)` is one?",
    "created_at": "2015-05-03T17:07:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174888",
    "user": "@nbruin"
}
```

Replying to [comment:8 rws]:
> which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?

Because the default for matrix creation is to create a mutable matrix. That's because a mutable matrix can be turned into an immutable one, but not the other way around (that requires copying the matrix to a new, mutable, one). That default is probably inconvenient for symbolics.

Are you sure this is the sole problem, though? If we try this:

```
def imm_mt(*args,**kwargs):
    M=matrix(*args,**kwargs)
    M.set_immutable()
    return M
f(x)=imm_mt()
```

then we get

```
sage: hash(f(x))
0
```

but `bool(f(x)==f(x))` still crashes. is it trying to see if `f(x)*f(x)^(-1)` is one?



---

archive/issue_comments_174889.json:
```json
{
    "body": "Replying to [comment:11 nbruin]:\n> Are you sure this is the sole problem, though?\nI have reopened the Pynac issue. The crash is in exactly the same call tree. It happens while trying to multiply the rhs with `-1` to get `lhs-rhs`. So:\n\n```\nsage: f(x)=matrix()\nsage: bool(f(x)==1)\nTrue\nsage: bool(1==f(x))\n<crash>\n```\n\nAlso no, I don't think it's the sole problem. Either Sage or Pynac will have to check somewhere before evaluating that all mutable Python objects of the expression are switched to immutable (or make immutable copies).\n\nEDIT: But that would be a different ticket: #18360",
    "created_at": "2015-05-04T06:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174889",
    "user": "@rwst"
}
```

Replying to [comment:11 nbruin]:
> Are you sure this is the sole problem, though?
I have reopened the Pynac issue. The crash is in exactly the same call tree. It happens while trying to multiply the rhs with `-1` to get `lhs-rhs`. So:

```
sage: f(x)=matrix()
sage: bool(f(x)==1)
True
sage: bool(1==f(x))
<crash>
```

Also no, I don't think it's the sole problem. Either Sage or Pynac will have to check somewhere before evaluating that all mutable Python objects of the expression are switched to immutable (or make immutable copies).

EDIT: But that would be a different ticket: #18360



---

archive/issue_comments_174890.json:
```json
{
    "body": "Please read [http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions](http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions)",
    "created_at": "2015-05-04T06:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174890",
    "user": "@jdemeyer"
}
```

Please read [http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions](http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions)



---

archive/issue_comments_174891.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-04T15:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174891",
    "user": "@rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_174892.json:
```json
{
    "body": "Replying to [comment:11 nbruin]:\n> If we try this:\n> {{{\n> def imm_mt(*args,**kwargs):\n>     M=matrix(*args,**kwargs)\n>     M.set_immutable()\n>     return M\n> f(x)=imm_mt()\n> }}}\n> then we get\n> {{{\n> sage: hash(f(x))\n> 0\n> }}}\n> but `bool(f(x)==f(x))` still crashes.\nMy best guess at the moment is that somewhere in between a copy is made which, as you suggested, is then mutable again. This can only be fixed by a dedicated ticket such as #18360. \n\nAs to this code, the reviewer should check doubly if what I did here was right. There was not a single example in Sage with a special function catching exceptions from which I could have learned.\n----\nNew commits:",
    "created_at": "2015-05-04T15:11:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174892",
    "user": "@rwst"
}
```

Replying to [comment:11 nbruin]:
> If we try this:
> {{{
> def imm_mt(*args,**kwargs):
>     M=matrix(*args,**kwargs)
>     M.set_immutable()
>     return M
> f(x)=imm_mt()
> }}}
> then we get
> {{{
> sage: hash(f(x))
> 0
> }}}
> but `bool(f(x)==f(x))` still crashes.
My best guess at the moment is that somewhere in between a copy is made which, as you suggested, is then mutable again. This can only be fixed by a dedicated ticket such as #18360. 

As to this code, the reviewer should check doubly if what I did here was right. There was not a single example in Sage with a special function catching exceptions from which I could have learned.
----
New commits:



---

archive/issue_comments_174893.json:
```json
{
    "body": "Obviously, a doctest is needed.\n\nBesides that, it makes no sense to add an additional layer `_nonzero_`. The exception should be handled in the pynac interface, i.e. the `relational_to_bool()` function.",
    "created_at": "2015-05-04T16:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174893",
    "user": "@jdemeyer"
}
```

Obviously, a doctest is needed.

Besides that, it makes no sense to add an additional layer `_nonzero_`. The exception should be handled in the pynac interface, i.e. the `relational_to_bool()` function.



---

archive/issue_comments_174894.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-04T16:19:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174894",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_174895.json:
```json
{
    "body": "Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.\n----\nNew commits:",
    "created_at": "2015-05-05T06:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174895",
    "user": "@rwst"
}
```

Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.
----
New commits:



---

archive/issue_comments_174896.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-05T06:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174896",
    "user": "@rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_174897.json:
```json
{
    "body": "Replying to [comment:20 rws]:\n> Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.\n\nWell, behaviour shouldn't depend on what \"presumably\" happens (does the traceback look sensible? If not, you're certainly doing it wrong). I admit I don't know the proper way to deal with this (a C++ exception and `PyErr_Occurred() != NULL`), but it's not right like this.\n\nBesides that, I would never print the C++ exception.",
    "created_at": "2015-05-05T07:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174897",
    "user": "@jdemeyer"
}
```

Replying to [comment:20 rws]:
> Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.

Well, behaviour shouldn't depend on what "presumably" happens (does the traceback look sensible? If not, you're certainly doing it wrong). I admit I don't know the proper way to deal with this (a C++ exception and `PyErr_Occurred() != NULL`), but it's not right like this.

Besides that, I would never print the C++ exception.



---

archive/issue_comments_174898.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-05T07:16:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174898",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_174899.json:
```json
{
    "body": "I can have a look at how to properly deal with this, but not now.",
    "created_at": "2015-05-05T07:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174899",
    "user": "@jdemeyer"
}
```

I can have a look at how to properly deal with this, but not now.



---

archive/issue_comments_174900.json:
```json
{
    "body": "Now that the actual bug is fixed in future Pynac (#18360) the given doctest will not work in the future, so I removed the commit.",
    "created_at": "2015-06-17T14:34:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174900",
    "user": "@rwst"
}
```

Now that the actual bug is fixed in future Pynac (#18360) the given doctest will not work in the future, so I removed the commit.



---

archive/issue_comments_174901.json:
```json
{
    "body": "Branch reset because other exceptions can be thrown.\n----\nNew commits:",
    "created_at": "2015-06-22T15:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174901",
    "user": "@rwst"
}
```

Branch reset because other exceptions can be thrown.
----
New commits:



---

archive/issue_comments_174902.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-10-19T14:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174902",
    "user": "@rwst"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_174903.json:
```json
{
    "body": "No longer necessary (doctest added in #18360)",
    "created_at": "2015-10-19T14:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174903",
    "user": "@rwst"
}
```

No longer necessary (doctest added in #18360)



---

archive/issue_comments_174904.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-10-22T08:32:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-174904",
    "user": "@vbraun"
}
```

Resolution: fixed
