# Issue 14007: Crash in GiNaC::Number_T::hash()

Issue created by migration from Trac.

Original creator: mjo

Original creation time: 2013-03-01 17:45:10

Assignee: burcin


```
sage: pU = vector([0,0])                            
sage: pB = vector([2,0])                            
sage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         
sage: d = (pB-pU).row()*(pB-pU).column()                                                              
sage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()
sage: f1(x) == f2(x)
([4*(tau - 1)^2]) == ([4*tau^2 - 8*tau + 4])
sage: bool(f1(x) == f2(x))
terminate called after throwing an instance of 'std::runtime_error'
  what():  Number_T::hash() python function (__hash__) raised exception
...
```



---

Comment by rws created at 2015-01-31 10:00:35

Changing priority from major to critical.


---

Comment by rws created at 2015-05-03 07:02:16

Reported as https://github.com/pynac/pynac/issues/34


---

Comment by rws created at 2015-05-03 08:53:29

Minimal case given. In Sage `hash(matrix())` will not allow hashing probably because `PyObject_Hash` will fail and to prevent that. The fail happens in Pynac nevertheless because the check is avoided due to function expansion and there leads to the crash.

One part of the fix is preventing Sage from crashing. Surrounding the call to Pynac in `Expression::__nonzero__` with guards:

```
            sig_on()
            pynac_result = relational_to_bool(self._gobj)
            sig_off()
```

leads to:

```
sage: bool(f(x)==f(x))
terminate called after throwing an instance of 'std::runtime_error'
  what():  Number_T::hash() python function (__hash__) raised exception
---------------------------------------------------------------------------
TypeError: mutable matrices are unhashable
```

which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?


---

Comment by nbruin created at 2015-05-03 17:07:02

Replying to [comment:8 rws]:
> which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?

Because the default for matrix creation is to create a mutable matrix. That's because a mutable matrix can be turned into an immutable one, but not the other way around (that requires copying the matrix to a new, mutable, one). That default is probably inconvenient for symbolics.

Are you sure this is the sole problem, though? If we try this:

```
def imm_mt(*args,**kwargs):
    M=matrix(*args,**kwargs)
    M.set_immutable()
    return M
f(x)=imm_mt()
```

then we get

```
sage: hash(f(x))
0
```

but `bool(f(x)==f(x))` still crashes. is it trying to see if `f(x)*f(x)^(-1)` is one?


---

Comment by rws created at 2015-05-04 06:41:12

Replying to [comment:11 nbruin]:
> Are you sure this is the sole problem, though?
I have reopened the Pynac issue. The crash is in exactly the same call tree. It happens while trying to multiply the rhs with `-1` to get `lhs-rhs`. So:

```
sage: f(x)=matrix()
sage: bool(f(x)==1)
True
sage: bool(1==f(x))
<crash>
```

Also no, I don't think it's the sole problem. Either Sage or Pynac will have to check somewhere before evaluating that all mutable Python objects of the expression are switched to immutable (or make immutable copies).

EDIT: But that would be a different ticket: #18360


---

Comment by jdemeyer created at 2015-05-04 06:48:08

Please read [http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions](http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions)


---

Comment by rws created at 2015-05-04 15:11:46

Changing status from new to needs_review.


---

Comment by rws created at 2015-05-04 15:11:46

Replying to [comment:11 nbruin]:
> If we try this:
> {{{
> def imm_mt(*args,**kwargs):
>     M=matrix(*args,**kwargs)
>     M.set_immutable()
>     return M
> f(x)=imm_mt()
> }}}
> then we get
> {{{
> sage: hash(f(x))
> 0
> }}}
> but `bool(f(x)==f(x))` still crashes.
My best guess at the moment is that somewhere in between a copy is made which, as you suggested, is then mutable again. This can only be fixed by a dedicated ticket such as #18360. 

As to this code, the reviewer should check doubly if what I did here was right. There was not a single example in Sage with a special function catching exceptions from which I could have learned.
----
New commits:


---

Comment by jdemeyer created at 2015-05-04 16:19:45

Obviously, a doctest is needed.

Besides that, it makes no sense to add an additional layer `_nonzero_`. The exception should be handled in the pynac interface, i.e. the `relational_to_bool()` function.


---

Comment by jdemeyer created at 2015-05-04 16:19:45

Changing status from needs_review to needs_work.


---

Comment by rws created at 2015-05-05 06:42:44

Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.
----
New commits:


---

Comment by rws created at 2015-05-05 06:42:44

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-05-05 07:16:01

Replying to [comment:20 rws]:
> Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.

Well, behaviour shouldn't depend on what "presumably" happens (does the traceback look sensible? If not, you're certainly doing it wrong). I admit I don't know the proper way to deal with this (a C++ exception and `PyErr_Occurred() != NULL`), but it's not right like this.

Besides that, I would never print the C++ exception.


---

Comment by jdemeyer created at 2015-05-05 07:16:06

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-05-05 07:19:43

I can have a look at how to properly deal with this, but not now.


---

Comment by rws created at 2015-06-17 14:34:19

Now that the actual bug is fixed in future Pynac (#18360) the given doctest will not work in the future, so I removed the commit.


---

Comment by rws created at 2015-06-22 15:03:48

Branch reset because other exceptions can be thrown.
----
New commits:


---

Comment by rws created at 2015-10-19 14:09:03

Changing status from needs_work to positive_review.


---

Comment by rws created at 2015-10-19 14:09:03

No longer necessary (doctest added in #18360)


---

Comment by vbraun created at 2015-10-22 08:32:18

Resolution: fixed
