# Issue 18976: For packages listed in build/pkgs/piprules, allow 'sage --optional' to list them

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2015-09-14 21:26:34

CC:  vdelecroix jdemeyer vbraun embray

In #19187, the file `build/pkgs/piprules` was created. This allows any packages listed there to be installed via `sage -i PKG` by just running `pip install PKG`. The changes here allow such packages to be listed when running `sage --optional`, and therefore to be detected as optional packages when doctesting.

For example: after running `sage -i brian`, `sage --optional` gives me

```
...
bliss................................... 0.72.p1 (not_installed)
brian................................... 1.4.1 (1.4.1)
buckygen................................ 1.0 (not_installed)
...
```

and doctesting gives me

```
Using --optional=arb,brian,ccache,gcc,mpir,python2,sage,scons
```


This does not print package information for all packages listed in `build/pkg/piprules`, only for those which have been installed


---

Comment by jhpalmieri created at 2015-09-14 21:26:49

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2015-09-14 21:26:49

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vdelecroix created at 2015-09-15 01:15:49

To my mind, it would nice to also list non installed pip packages as well as the last version available. The pip version can be obtained from Python with the json API

```
import urllib2
import json

def pip_version(package_name):
    url = "https://pypi.python.org/pypi/{}/json".format(package_name)

    try:
        data = json.load(urllib2.urlopen(urllib2.Request(url)))
    except urllib2.HTTPError:
        return None

    try:
        return data["info"]["version"]
    except KeyError:
        return None
```

The last version available might differ from what is installed. And it is worth mentioning that an update is available.
----
New commits:


---

Comment by jhpalmieri created at 2015-09-15 01:38:23

Replying to [comment:3 vdelecroix]:
> To my mind, it would nice to also list non installed pip packages as well as the last version available. The pip version can be obtained from Python with the json API

One disadvantage to this is that it requires internet access, which `sage --optional --local` does not do. But this would be a good addition if `--local` were not given. If we do list the non-installed packages, then it's going to get unwieldy if there are hundreds of entries in `build/pkgs/piprules`. What if that file gets big?

Do we want to list these as optional packages or in another category? `sage --pip_packages`?


---

Comment by jdemeyer created at 2015-09-15 07:25:58

I do not want these pip packages to be treated like optional packages. If anything, they are closer to "experimental" than to "optional". We don't have control over them, so they are more likely to break when the upstream package gets upgraded.


---

Comment by jdemeyer created at 2015-09-15 07:25:58

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-09-15 07:25:58

Changing component from packages: optional to scripts.


---

Comment by jhpalmieri created at 2015-09-15 15:26:57

Replying to [comment:5 jdemeyer]:
> I do not want these pip packages to be treated like optional packages. If anything, they are closer to "experimental" than to "optional". We don't have control over them, so they are more likely to break when the upstream package gets upgraded.

Do you mean

- you want them listed in `sage --experimental`, not `sage --optional`, or
- you don't want them detected for the purpose of doctests,

or both?


---

Comment by jdemeyer created at 2015-09-15 16:54:56

Replying to [comment:6 jhpalmieri]:
> Do you mean
> 
> - you want them listed in `sage --experimental`, not `sage --optional`, or
> - you don't want them detected for the purpose of doctests,
> 
> or both?

The default for `--optional` flags in doctests really should be optional packages only, so I don't want pip packages to be tested by doctests by default. Therefore, I also don't want those packages to appear in `sage --optional`. So I really prefer to see them as a new category: not standard, not optional, not experimental.


---

Comment by jhpalmieri created at 2015-09-15 18:29:06

Wait, if an (old-style) optional package is listed in `piprules`, you still don't want it listed in `sage --optional`? Should it be removed altogether from the listing, or listed as `not_installed`? If it's old-style, by the way, having it listed in `sage --optional` is somewhat independent of having it used in doctests, since the doctest framework only looks at local packages. So in my current branch, if we delete the changes to `doctest/control.py`, then these pip packages won't be used automatically in doctests.


---

Comment by vdelecroix created at 2015-09-16 14:49:27

Replying to [comment:7 jdemeyer]:
> Replying to [comment:6 jhpalmieri]:
> > Do you mean
> > 
> > - you want them listed in `sage --experimental`, not `sage --optional`, or
> > - you don't want them detected for the purpose of doctests,
> > 
> > or both?
> 
> The default for `--optional` flags in doctests really should be optional packages only, so I don't want pip packages to be tested by doctests by default. Therefore, I also don't want those packages to appear in `sage --optional`. So I really prefer to see them as a new category: not standard, not optional, not experimental.

I see several solutions to deal with "pip packages":
1. having a new category of packages (let say python-optional)
2. be stricter about versioning, i.e. in piprules specify the version of the packages we support

```
brian=1.3.1
trac=2.3
```

  Very simple to maintain!

I agree that it would be hard to prevent a pip package to just break because versions are not backward compatible. So solution 2 looks appropriate to me. Otherwise, we can have a more precise tagging system for python-optional packages

```
sage: my_test()  # python-optional -- 3.5 <= beautifulsoup <= 4.1.2
```

It is more flexible than the piprules strict versioning solution but the cost of maintenance is much higher.

Vincent


---

Comment by vdelecroix created at 2015-09-16 15:32:24

I have a working version of `sage-list-packages` doing

```
$ ./sage-list-packages python
[package] .............................. [latest version] ([installed version])

beautifulsoup........................... 3.2.1 (3.2.1)
biopython............................... 1.65 (1.65)
brian................................... 1.4.1 (1.4.1)
guppy................................... 0.1.10 (0.1.10)
mercurial............................... 3.5.1 (3.5.1)
mpi4py.................................. 1.3.1 (1.3.1)
nibabel................................. 2.0.1 (2.0.1)
pybtex.................................. 0.18 (0.18)
pyflakes................................ 0.9.2 (0.9.2)
pyopenssl............................... 0.15.1 (0.15.1)
sqlalchemy.............................. 1.0.8 (1.0.8)
trac.................................... 1.0.9 (1.0.9)
```

The only problem is that it is relatively long to get the information from the pip json API for all the packages. Perhaps, one can be smarter with `urllib2`.

John, am I free to change the branch in order to make my proposition publicly available?

Vincent


---

Comment by vdelecroix created at 2015-09-16 15:44:47

Furthermore, could we separate the issues of:
- listing python packages
- including optional doctests for them

Vincent


---

Comment by jhpalmieri created at 2015-09-16 16:02:43

Replying to [comment:10 vdelecroix]:
> John, am I free to change the branch in order to make my proposition publicly available?

Please do so.


---

Comment by jhpalmieri created at 2015-09-16 16:56:43

I have a few questions and comments:

- if #19220 is merged (archiving superseded packages, including the `piprules` packages), how are users supposed to find out about `biopython`, `brian`, etc.? We need to include an option to `sage` which will call `sage-list-packages python`. Maybe we should also have an option which lists all packages: first standard, then optional, then experimental, then python/pip. Or maybe group all of the non-standard packages together, sorted by name. In any case, we shouldn't expect users to even be aware that there are several different types of non-standard packages; they should instead just be able to get one list to see if some particular package is supported.

 Maybe a list like

```
[package (type)] .......... [latest version] ([installed version])

...
biopython (pip) ........... latest version (installed version)
...
chomp (experimental) ...... latest version (installed version)
...
ore_algebra (optional) .... latest version (installed version)
...
```

 I'm not really sure, though.
- Regarding the versions, I am not convinced that we can accurately specify which version of each package we support. Who is going to maintain this? Unless there is some automatic way of determining the versions supported by Sage, the versions will quickly get out of date. If `brian` gets updated to 1.4.2 but we list `brian=1.4.1`, what happens if a user does `sage -i brian`? What happens if a user does `sage --pip install brian`?


---

Comment by vdelecroix created at 2015-09-16 21:53:57

New commits:


---

Comment by mkoeppe created at 2016-07-16 17:17:25

What is the status on this?


---

Comment by vdelecroix created at 2016-07-29 20:58:09

New commits:


---

Comment by vdelecroix created at 2016-07-29 20:58:09

Changing status from needs_work to needs_review.


---

Comment by git created at 2016-07-29 20:59:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-29 21:04:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2016-07-29 21:18:05

ACHTUNG! According to an email by user dmuthiah, changes by this user on this ticket were done by an unautorised person...


---

Comment by vdelecroix created at 2016-07-29 21:18:55

Replying to [comment:22 dimpase]:
> ACHTUNG! According to an email by user dmuthiah, changes by this user on this ticket were done by an unautorised person... 

that was me... (I sent an e-mail). Sorry.


---

Comment by vdelecroix created at 2016-07-29 21:19:52

need to superseed `sage/misc/packages` which contains *builtin* list of packages!!


---

Comment by vdelecroix created at 2016-07-29 21:19:52

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-07-29 23:45:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-07-29 23:45:43

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2016-08-03 19:54:04

This is probably a FAQ, but I'm getting this error:

```
$ sage -optional
[package]...............................[latest version] ([version])

Traceback (most recent call last):
  File "/Users/mkoeppe/cvs/sage/src/bin/sage-list-packages", line 67, in <module>
    L = list_packages('optional', 'pip', local=args['local']).values()
  File "/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/misc/package.py", line 196, in list_packages
    pkg['remote_version'] = pip_remote_version(p)
  File "/Users/mkoeppe/cvs/sage/local/lib/python2.7/site-packages/sage/misc/package.py", line 87, in pip_remote_version
    f = urlopen(url)
  File "/Users/mkoeppe/cvs/sage/local/lib/python/urllib2.py", line 154, in urlopen
    return opener.open(url, data, timeout)
  File "/Users/mkoeppe/cvs/sage/local/lib/python/urllib2.py", line 431, in open
    response = self._open(req, data)
  File "/Users/mkoeppe/cvs/sage/local/lib/python/urllib2.py", line 449, in _open
    '_open', req)
  File "/Users/mkoeppe/cvs/sage/local/lib/python/urllib2.py", line 409, in _call_chain
    result = func(*args)
  File "/Users/mkoeppe/cvs/sage/local/lib/python/urllib2.py", line 1240, in https_open
    context=self._context)
  File "/Users/mkoeppe/cvs/sage/local/lib/python/urllib2.py", line 1197, in do_open
    raise URLError(err)
urllib2.URLError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:590)>
```

(I don't have problems with `sage -pip` otherwise.)


---

Comment by vbraun created at 2016-08-03 22:18:33

You are on OSX; Apple's openssl library is outdated and lacks tls 1.2 support.


---

Comment by vdelecroix created at 2016-08-03 22:42:18

And PyPI does not seem to accept http connections... I can catch URLError and just return `version='?'` in that case. What do you think?


---

Comment by git created at 2016-08-03 22:58:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-08-03 22:59:03

Please test again. Normally you should see the same output as with `sage-list-packages optional --local`.


---

Comment by git created at 2016-08-03 22:59:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2016-08-03 23:19:12

Replying to [comment:30 vbraun]:
> You are on OSX; Apple's openssl library is outdated and lacks tls 1.2 support.

Thanks. Is there a documented workaround for this for Sage users/developers?


---

Comment by mkoeppe created at 2016-08-03 23:19:38

Replying to [comment:34 vdelecroix]:
> Please test again. Normally you should see the same output as with `sage-list-packages optional --local`.

Seems to work now.


---

Comment by vdelecroix created at 2016-08-03 23:21:15

Replying to [comment:37 mkoeppe]:
> Replying to [comment:34 vdelecroix]:
> > Please test again. Normally you should see the same output as with `sage-list-packages optional --local`.
> 
> Seems to work now.

Yes but normally you can not see remote pip version (look at the lines for the packages `beautifulsoup`, `biopython`, `sqlalchemy`,  etc)


---

Comment by mkoeppe created at 2016-08-03 23:21:35

I only took a cursory look at the code changes. Perhaps someone familiar with this code should take a closer look.


---

Comment by mkoeppe created at 2016-08-03 23:22:20

Replying to [comment:38 vdelecroix]:
> Yes but normally you can not see remote pip version (look at the lines for the packages `beautifulsoup`, `biopython`, `sqlalchemy`,  etc)
Yes, I see question marks for these packages.


---

Comment by mkoeppe created at 2016-08-04 00:00:45

Perhaps there should be a warning/notice when the pip version query failed.


---

Comment by git created at 2016-08-04 01:39:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-08-05 12:16:06

It is possible to somehow compute the package lists lazily? I am just a bit worried that those `_STANDARD_PACKAGES` lists will need to be computed every time that Sage starts.


---

Comment by vdelecroix created at 2016-08-08 13:24:57

Replying to [comment:43 jdemeyer]:
> It is possible to somehow compute the package lists lazily? I am just a bit worried that those `_STANDARD_PACKAGES` lists will need to be computed every time that Sage starts.

The module would better not be imported on startup. I will change the imports to become lazy.


---

Comment by vdelecroix created at 2016-08-08 13:49:49

Actually, it seems nearly impossible to be sure that `sage.misc.package` is not imported on startup using `sage.misc.lazy_import.is_during_startup`. The main reason is that `is_package_installed` is currently used in `sage_setup`.


---

Comment by vdelecroix created at 2016-08-08 13:52:00

As this is rather disjoint from the preoccupations of this ticket, I would prefer to postpone this problem. One solution is to wait for #20382 that get rid of `is_installed_package`. Then it would be trivial to forbid the import on startup.


---

Comment by mkoeppe created at 2016-08-10 18:43:46

Replying to [comment:42 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[de597b2](https://git.sagemath.org/sage.git/commit/?id=de597b27c45d0f629698832a4677b92b48472c3a)||`19213: a warning with tests`||
OK, that's much better with these warnings. 

From my side, this would be a 'positive_review'. Jeroen?


---

Comment by jdemeyer created at 2016-08-10 21:20:49

I would like to see what the patchbot thinks of the startup time (however, it seems down now). If this ticket does not give a statistically significant increase to the startup time, it is ok for me. See [comment:43]


---

Comment by vdelecroix created at 2016-08-10 21:23:10

Replying to [comment:48 jdemeyer]:
> I would like to see what the patchbot thinks of the startup time (however, it seems down now). If this ticket does not give a statistically significant increase to the startup time, it is ok for me. See [comment:43]

Since the lists are built with `local=True` this should even be faster than before. The old way to build these lists was via the script `sage-package-list`...


---

Comment by jdemeyer created at 2016-08-10 21:26:57

Replying to [comment:49 vdelecroix]:
> The old way to build these lists was via the script `sage-package-list`...

Unless I'm missing something, in the old version, the list of packages was not computed _every time that Sage starts_.


---

Comment by vdelecroix created at 2016-08-10 21:29:07

Replying to [comment:50 jdemeyer]:
> Replying to [comment:49 vdelecroix]:
> > The old way to build these lists was via the script `sage-package-list`...
> 
> Unless I'm missing something, in the old version, the list of packages was not computed _every time that Sage starts_.

It was the very same. All of `_STANDARD_PACKAGES`, `_OPTIONAL_PACKAGES`, `_EXPERIMENTAL_PACKAGES` where computed at module loading time (since they are used in the doc of the module). And the module is loaded on startup.


---

Comment by jhpalmieri created at 2016-08-11 17:23:51

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2016-08-11 17:23:51

I see a significant difference in startup time: on one OS X machine it takes about 800ms longer on average with this branch. (I ran `sage --startuptime` 10 times with and without the branch, discarding the first run in each case. Average without: 1760ms. With: 2560ms.) If I run `sage --startuptime sage.misc.package`, without the branch it takes about 0.8ms to import that module, while with the branch: 800ms.


---

Comment by git created at 2016-08-11 18:45:58

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-08-11 18:48:04

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-08-11 18:48:04

Indeed... I was wrong the variables `X_PACKAGES` where hardcoded (and unmaintained).

I rebased and added some deprecations to all of `standard_packages`, `optional_packages`, `experimental_packages` and `package_versions` (since all the information is now available from `list_packages`).


---

Comment by jdemeyer created at 2016-08-12 08:30:54

Replying to [comment:54 vdelecroix]:
> Indeed... I was wrong the variables `X_PACKAGES` where hardcoded

Yes, that's what I meant.


---

Comment by jdemeyer created at 2016-08-12 08:32:31

I don't see why `standard_packages()` and friends should be deprecated. They offer a user-friendly interface for `list_packages()`.


---

Comment by jdemeyer created at 2016-08-12 08:38:06

Anyway, I don't really care much about this.


---

Comment by git created at 2016-08-12 14:10:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-08-12 14:11:14

I don't care either. But a pair of lists is not a lot more friendly than a dictionary.


---

Comment by jdemeyer created at 2016-08-15 07:34:34

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-17 06:40:33

Resolution: fixed


---

Comment by mderickx created at 2017-09-13 17:42:01

It seems that the deprecation warnings were removed in the latest commit f054998 , but the documentation still says they are deprecated. I modified the documentation accordingly in #23849 .
