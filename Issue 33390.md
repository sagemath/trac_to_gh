# Issue 33390: Move sage-gdb-commands out of src/bin

Issue created by migration from https://trac.sagemath.org/ticket/33627

Original creator: mkoeppe

Original creation time: 2022-04-02 05:51:50

CC:  tornaria jhpalmieri fbissey dimpase

(from #33625)

This is just package_data and should be moved into `src/sage/doctest/`.


---

Comment by mkoeppe created at 2022-07-22 22:54:11

Changing priority from minor to critical.


---

Comment by mkoeppe created at 2022-07-22 23:50:39

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-07-22 23:50:39

New commits:


---

Comment by fbissey created at 2022-07-23 01:11:17

Would `sage-gdb-commands` not be in a better location in `ext_data`? It is not a function that is specific to doctests. That's my only reaction so far to that change, but I wouldn't push for the move too strongly if you tell me that it is too hard.


---

Comment by mkoeppe created at 2022-07-23 01:20:39

Replying to [comment:6 fbissey]:
> Would `sage-gdb-commands` not be in a better location in `ext_data`? It is not a function that is specific to doctests. 

The purpose of this file is not documented, and it is only used there


---

Comment by fbissey created at 2022-07-23 01:28:09

I just looked at the content of the file for the first time in some years. 

```
r
```

may be we can just get rid of it if it is the only place it is used. And that's what the gdb manual has to say about what it does https://sourceware.org/gdb/current/onlinedocs/gdb/Starting.html#Starting


---

Comment by mkoeppe created at 2022-07-23 01:33:37

In any case, `ext_data` is an outdated design and I'd rather not add to it.


---

Comment by jhpalmieri created at 2022-07-23 03:05:02

Fran√ßois asks a good question about the purpose of this file. Could we instead just have a variable `SAGE_GDB_COMMANDS` defined as `'r'` in `doctest/control.py`? Having a file which contains a single character seems a little ridiculous.


---

Comment by mkoeppe created at 2022-07-23 03:17:09

The name of the file is passed to `gdb`, it's a list of commands to execute upon starting. Of course we could also generate this file as a temporary file, but I don't think that's a cleaner design


---

Comment by fbissey created at 2022-07-23 04:09:08

Yes, it is all coming back to me now. I guess it is meant to be clever. In any case it is the design we have to deal with and if it is only used from the `dosctest` folder, then yes it should live there.


---

Comment by mkoeppe created at 2022-07-23 04:29:56

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-07-23 04:29:56

Actually the file is also used in `src/bin/sage`. I missed it because it's written as `"${SELF}-gdb-commands"`


---

Comment by git created at 2022-07-23 06:39:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-23 07:08:49

With recent gdb versions we can just use this option instead and get rid of the command file altogether

```
  --eval-command=COMMAND, -ex
		     Execute a single GDB command.
```



---

Comment by git created at 2022-07-23 07:21:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-23 07:29:58

The code handling `./sage --gdb` in `src/bin/sage` has clearly not been tried in a long time. The `SAGE_DEBUG` logic is broken because this environment variable is only set in the build environment, not in `sage -sh`


---

Comment by git created at 2022-07-23 07:33:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-07-23 07:34:34

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-07-23 18:45:02

What's the advantage to explicitly including `python` (a.k.a. `sys.executable`) in

```
exec gdb --eval-command="run" --args ...python... sage-runtests --serial --timeout=0 hello_world.py
```



---

Comment by mkoeppe created at 2022-07-23 18:50:58

Without this change it wasn't working for me at all (on macOS): I got

```
"/Users/mkoeppe/s/sage/sage-rebasing/src/bin/sage-runtests": not in executable format: file format not recognized
```



---

Comment by jhpalmieri created at 2022-07-23 19:58:59

I can't get it to work on OS X either way. The SPKG doesn't build for me ("C compiler cannot create executables" because "ld: library not found for -ltinfo"). If I run `brew install gdb`, then I get complaints about things not being codesigned. Anyway, with this branch things fail a bit better than with `develop`, and the changes make sense to me. Comments from anyone else?


---

Comment by mkoeppe created at 2022-07-23 20:02:00

Yes, the `gdb` SPKG is too old (see #30158). I have also not done the codesigning dance with the homebrew gdb this time to try out whether it really works on macOS


---

Comment by dimpase created at 2022-07-24 10:25:53

isn't gdb pretty much useless with macOS clang, and one should use lldb instead?


---

Comment by mkoeppe created at 2022-07-24 16:22:34

Hence #31568


---

Comment by jhpalmieri created at 2022-07-25 05:33:16

Let's merge this.


---

Comment by jhpalmieri created at 2022-07-25 05:33:16

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-07-25 05:36:45

Thanks!


---

Comment by vbraun created at 2022-08-01 20:23:18

Resolution: fixed


---

Comment by jhpalmieri created at 2022-08-06 21:57:29

By the way, we missed an example in `developer/doctesting.rst` that mentions `sage-gdb-commands`. See #34295 for a follow-up.
