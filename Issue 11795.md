# Issue 11795: os x 10.7 Lion -- Sage segfaults on startup when initializing GiNaC

archive/issues_011795.json:
```json
{
    "body": "Assignee: drkirkby\n\nCC:  @burcin @jhpalmieri\n\nKeywords: python osx lion darwin\n\n(The problem has been solved -- see below -- though I haven't figured out what the right patch should be yet.  A solution to get Sage to startup without segfault is to delete local/lib/python2.6/config/libpython2.6.a and replace it by local/lib/libpython2.6.dylib, then rebuild the pynac spkg and the Sage library.)\n\nAfter getting Sage to building (as explained at #11881), we get\n\n```\n$ sage -gdb\nthen \"bt\" for a backtrace:\n...\n\nProgram received signal EXC_BAD_ACCESS, Could not access memory.\nReason: KERN_INVALID_ADDRESS at address: 0x0000000000000000\nPyInt_FromLong (ival=Cannot access memory at address 0x0\n) at intobject.c:91\n91 intobject.c: No such file or directory.\n in intobject.c\n(gdb) bt\n#0  PyInt_FromLong (ival=Cannot access memory at address 0x0\n) at intobject.c:91\n#1  0x0000000107781951 in GiNaC::numeric::numeric ()\n#2  0x00000001077c865a in GiNaC::library_init::library_init ()\n#3  0x0000000107662029 in global constructors keyed to _ZN5GiNaC8py_funcsE ()\n#4  0x00007fff5fc0fd1a in __dyld__ZN16ImageLoaderMachO18doModInitFunctionsERKN11ImageLoader11LinkContextE ()\n#5  0x00007fff5fc0fa66 in __dyld__ZN16ImageLoaderMachO16doInitializationERKN11ImageLoader11LinkContextE ()\n#6  0x00007fff5fc0d258 in __dyld__ZN11ImageLoader23recursiveInitializationERKNS_11LinkContextEjRNS_21InitializerTimingListE ()\n#7  0x00007fff5fc0d1f1 in __dyld__ZN11ImageLoader23recursiveInitializationERKNS_11LinkContextEjRNS_21InitializerTimingListE ()\n#8  0x00007fff5fc0e02b in __dyld__ZN11ImageLoader15runInitializersERKNS_11LinkContextERNS_21InitializerTimingListE ()\n#9  0x00007fff5fc03189 in __dyld__ZN4dyld15runInitializersEP11ImageLoader ()\n#10 0x00007fff5fc095cb in __dyld_dlopen ()\n#11 0x00007fff8fddb95b in dlopen ()\n#12 0x00000001000c957a in _PyImport_GetDynLoadFunc ()\n#13 0x00000001000b7095 in _PyImport_LoadDynamicModule ()\n#14 0x00000001000b56d3 in import_submodule ()\n#15 0x00000001000b58eb in load_next ()\n...\n```\n\n---\n\nNew spkg: [http://sage.math.washington.edu/home/palmieri/SPKG/Old/python-2.7.2.p2.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/Old/python-2.7.2.p2.spkg)\n\nIssue created by migration from https://trac.sagemath.org/ticket/11967\n\n",
    "closed_at": "2012-02-14T14:20:52Z",
    "created_at": "2011-10-31T07:18:07Z",
    "labels": [
        "component: porting",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.0",
    "title": "os x 10.7 Lion -- Sage segfaults on startup when initializing GiNaC",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11795",
    "user": "https://github.com/williamstein"
}
```
Assignee: drkirkby

CC:  @burcin @jhpalmieri

Keywords: python osx lion darwin

(The problem has been solved -- see below -- though I haven't figured out what the right patch should be yet.  A solution to get Sage to startup without segfault is to delete local/lib/python2.6/config/libpython2.6.a and replace it by local/lib/libpython2.6.dylib, then rebuild the pynac spkg and the Sage library.)

After getting Sage to building (as explained at #11881), we get

```
$ sage -gdb
then "bt" for a backtrace:
...

Program received signal EXC_BAD_ACCESS, Could not access memory.
Reason: KERN_INVALID_ADDRESS at address: 0x0000000000000000
PyInt_FromLong (ival=Cannot access memory at address 0x0
) at intobject.c:91
91 intobject.c: No such file or directory.
 in intobject.c
(gdb) bt
#0  PyInt_FromLong (ival=Cannot access memory at address 0x0
) at intobject.c:91
#1  0x0000000107781951 in GiNaC::numeric::numeric ()
#2  0x00000001077c865a in GiNaC::library_init::library_init ()
#3  0x0000000107662029 in global constructors keyed to _ZN5GiNaC8py_funcsE ()
#4  0x00007fff5fc0fd1a in __dyld__ZN16ImageLoaderMachO18doModInitFunctionsERKN11ImageLoader11LinkContextE ()
#5  0x00007fff5fc0fa66 in __dyld__ZN16ImageLoaderMachO16doInitializationERKN11ImageLoader11LinkContextE ()
#6  0x00007fff5fc0d258 in __dyld__ZN11ImageLoader23recursiveInitializationERKNS_11LinkContextEjRNS_21InitializerTimingListE ()
#7  0x00007fff5fc0d1f1 in __dyld__ZN11ImageLoader23recursiveInitializationERKNS_11LinkContextEjRNS_21InitializerTimingListE ()
#8  0x00007fff5fc0e02b in __dyld__ZN11ImageLoader15runInitializersERKNS_11LinkContextERNS_21InitializerTimingListE ()
#9  0x00007fff5fc03189 in __dyld__ZN4dyld15runInitializersEP11ImageLoader ()
#10 0x00007fff5fc095cb in __dyld_dlopen ()
#11 0x00007fff8fddb95b in dlopen ()
#12 0x00000001000c957a in _PyImport_GetDynLoadFunc ()
#13 0x00000001000b7095 in _PyImport_LoadDynamicModule ()
#14 0x00000001000b56d3 in import_submodule ()
#15 0x00000001000b58eb in load_next ()
...
```

---

New spkg: [http://sage.math.washington.edu/home/palmieri/SPKG/Old/python-2.7.2.p2.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/Old/python-2.7.2.p2.spkg)

Issue created by migration from https://trac.sagemath.org/ticket/11967





---

archive/issue_comments_134527.json:
```json
{
    "body": "I looked into this further, but haven't solved the problem.     I made an *empty* Cython file a.pyx with Extension description:\n\n```\n    Extension('sage.symbolic.a',\n              sources = ['sage/symbolic/a.pyx'],\n              language = 'c++',\n              depends = ginac_depends,\n              libraries = [\"pynac\", \"gmp\"]),\n```\n\nthen I did \"sage -ipython\" and \"import sage.symbolic.a\", and I get exactly the same crash as when import sage.all. \nI looked at the traceback more carefully.   The line\n\n```\n#0  PyInt_FromLong (ival=Cannot access memory at address 0x0\n) at intobject.c:91\n```\noccurs in the Python library in this code:\n\n```\n#if NSMALLNEGINTS + NSMALLPOSINTS > 0\n\tif (-NSMALLNEGINTS <= ival && ival < NSMALLPOSINTS) {\n\t\tv = small_ints[ival + NSMALLNEGINTS];\n\t\tPy_INCREF(v);                                      <------------------------ ***\n#ifdef COUNT_ALLOCS\n```\n\nThus the array small_ints -- this is some \"object pool\" (maybe) -- hasn't been initialized.\nThis was called from the Pynac library on startup where various constants (e.g., 1,2,3,4,5, etc., ) are defined.  In particular, this line in pynac's numeric.cpp causes the trouble:\n\n```\n    t = PYOBJECT;\n    if (!(v._pyobject = PyInt_FromLong(x)))\n      py_error(\"Error creating int\");\n```\n\nThis *feels* to me a lot like what would happen if two separate copies of the Python library were linked in.  One of them hasn't been initialized yet, so the object pool is nonsense.    However, I don't see a static libpython sitting around anywhere, so I'm not quite sure what happened.",
    "created_at": "2011-11-03T01:44:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134527",
    "user": "https://github.com/williamstein"
}
```

I looked into this further, but haven't solved the problem.     I made an *empty* Cython file a.pyx with Extension description:

```
    Extension('sage.symbolic.a',
              sources = ['sage/symbolic/a.pyx'],
              language = 'c++',
              depends = ginac_depends,
              libraries = ["pynac", "gmp"]),
```

then I did "sage -ipython" and "import sage.symbolic.a", and I get exactly the same crash as when import sage.all. 
I looked at the traceback more carefully.   The line

```
#0  PyInt_FromLong (ival=Cannot access memory at address 0x0
) at intobject.c:91
```
occurs in the Python library in this code:

```
#if NSMALLNEGINTS + NSMALLPOSINTS > 0
	if (-NSMALLNEGINTS <= ival && ival < NSMALLPOSINTS) {
		v = small_ints[ival + NSMALLNEGINTS];
		Py_INCREF(v);                                      <------------------------ ***
#ifdef COUNT_ALLOCS
```

Thus the array small_ints -- this is some "object pool" (maybe) -- hasn't been initialized.
This was called from the Pynac library on startup where various constants (e.g., 1,2,3,4,5, etc., ) are defined.  In particular, this line in pynac's numeric.cpp causes the trouble:

```
    t = PYOBJECT;
    if (!(v._pyobject = PyInt_FromLong(x)))
      py_error("Error creating int");
```

This *feels* to me a lot like what would happen if two separate copies of the Python library were linked in.  One of them hasn't been initialized yet, so the object pool is nonsense.    However, I don't see a static libpython sitting around anywhere, so I'm not quite sure what happened.



---

archive/issue_comments_134528.json:
```json
{
    "body": "Milestone sage-4.7.3 deleted",
    "created_at": "2011-11-03T16:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134528",
    "user": "https://github.com/jdemeyer"
}
```

Milestone sage-4.7.3 deleted



---

archive/issue_comments_134529.json:
```json
{
    "body": "I've put sage-4.7.3.alpha1, built from source on a 10.6 computer (bsd.math) and on a 10.7 computer (my laptop), then moved the 10.6 built one to the 10.7 computer.  The version built on 10.6 starts up on 10.7 just fine, but of course the version built on 10.7 crashes as explained above.    I looked at the file local/lib/libpynac-0.2.3.dylib in each install, and they are different:\n\n```\n10.6$ ls -l local/lib/libpynac-0.2.3.dylib \n-rwxr-xr-x  1 wstein  staff  3176552 Nov  2 18:15 local/lib/libpynac-0.2.3.dylib\n10.7$  ls -l local/lib/libpynac-0.2.3.dylib \n-rwxr-xr-x  1 wstein  staff  5144444 Nov  2 18:27 local/lib/libpynac-0.2.3.dylib\n```\nNotice that the version that works is much smaller.  The bad one (on 10.7) has twice as many symbols:\n\n```\n10.6$ nm -o local/lib/libpynac-0.2.3.dylib|wc -l\n4665\n10.7$ nm -o local/lib/libpynac-0.2.3.dylib|wc -l\n9526\n```\nCheck out this:\n\n```\n10.6$nm -o local/lib/libpynac-0.2.3.dylib|grep -i Py_INCREF\nbut\n10.7$ nm -o local/lib/libpynac-0.2.3.dylib|grep -i Py_INCREF\nlocal/lib/libpynac-0.2.3.dylib: 00000000001a9750 T _Py_IncRef\n```\n\nThis suggests again that the build of Pynac on OS X 10.7 is now broken and somehow accidentally links in another copy of Python.   \n\nLooking at the build log, we find this during the pynac build (on 10.7):\n\n```\n-L/Users/wstein/sage/install/sage-4.7.3.alpha1/local/lib/python2.6/config -lpython2.6 \n```\nand in that -L'd directory we find only an \"evil\" static libpython2.6.a:\n\n```\n$ ls local/lib/python2.6/config\nMakefile\tSetup.config\tconfig.c\tinstall-sh\tmakesetup\nSetup\t\tSetup.local\tconfig.c.in\tlibpython2.6.a\tpython.o\n```\n\nThe same libpython2.6.a is in that directory in the 10.6 version.  The same build line appears there to.  So... I'm guessing that one of the changes in XCode 4.x is to make it so that -L works differently.  In fact, what now happens (that causes this problem) does seem pretty reasonable to me.\n\nMy first attempt to fix this is to rebuild the pynac spkg, but with libpython2.6.dylib simply copied into the local/lib/python2.6/config directory.   That one change was *not* sufficient to fix the problem, but I bet something related will work...",
    "created_at": "2011-11-08T08:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134529",
    "user": "https://github.com/williamstein"
}
```

I've put sage-4.7.3.alpha1, built from source on a 10.6 computer (bsd.math) and on a 10.7 computer (my laptop), then moved the 10.6 built one to the 10.7 computer.  The version built on 10.6 starts up on 10.7 just fine, but of course the version built on 10.7 crashes as explained above.    I looked at the file local/lib/libpynac-0.2.3.dylib in each install, and they are different:

```
10.6$ ls -l local/lib/libpynac-0.2.3.dylib 
-rwxr-xr-x  1 wstein  staff  3176552 Nov  2 18:15 local/lib/libpynac-0.2.3.dylib
10.7$  ls -l local/lib/libpynac-0.2.3.dylib 
-rwxr-xr-x  1 wstein  staff  5144444 Nov  2 18:27 local/lib/libpynac-0.2.3.dylib
```
Notice that the version that works is much smaller.  The bad one (on 10.7) has twice as many symbols:

```
10.6$ nm -o local/lib/libpynac-0.2.3.dylib|wc -l
4665
10.7$ nm -o local/lib/libpynac-0.2.3.dylib|wc -l
9526
```
Check out this:

```
10.6$nm -o local/lib/libpynac-0.2.3.dylib|grep -i Py_INCREF
but
10.7$ nm -o local/lib/libpynac-0.2.3.dylib|grep -i Py_INCREF
local/lib/libpynac-0.2.3.dylib: 00000000001a9750 T _Py_IncRef
```

This suggests again that the build of Pynac on OS X 10.7 is now broken and somehow accidentally links in another copy of Python.   

Looking at the build log, we find this during the pynac build (on 10.7):

```
-L/Users/wstein/sage/install/sage-4.7.3.alpha1/local/lib/python2.6/config -lpython2.6 
```
and in that -L'd directory we find only an "evil" static libpython2.6.a:

```
$ ls local/lib/python2.6/config
Makefile	Setup.config	config.c	install-sh	makesetup
Setup		Setup.local	config.c.in	libpython2.6.a	python.o
```

The same libpython2.6.a is in that directory in the 10.6 version.  The same build line appears there to.  So... I'm guessing that one of the changes in XCode 4.x is to make it so that -L works differently.  In fact, what now happens (that causes this problem) does seem pretty reasonable to me.

My first attempt to fix this is to rebuild the pynac spkg, but with libpython2.6.dylib simply copied into the local/lib/python2.6/config directory.   That one change was *not* sufficient to fix the problem, but I bet something related will work...



---

archive/issue_events_031674.json:
```json
{
    "actor": "https://github.com/williamstein",
    "created_at": "2011-11-08T08:28:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11795#event-31674"
}
```



---

archive/issue_comments_134530.json:
```json
{
    "body": "OK, I'm next rebuilding everything (pynac spkg + \"sage -ba\"), with that static library (mentioned in the previous comment above) *deleted* to avoid it accidentally getting linked in somewhere.    This did not help.  Starting Sage fails with this traceback now (different than before):\n\n```\nterminate called throwing an exception\nProgram received signal SIGABRT, Aborted.\n0x00007fff941a182a in __kill ()\n(gdb) bt\n#0  0x00007fff941a182a in __kill ()\n#1  0x00007fff8d186a9c in abort ()\n#2  0x00007fff8d0fe7bc in abort_message ()\n#3  0x00007fff8d0fbfcf in default_terminate ()\n#4  0x00007fff8ccc21cd in _objc_terminate ()\n#5  0x00007fff8d0fc001 in safe_handler_caller ()\n#6  0x00007fff8d0fc05c in std::terminate ()\n#7  0x00007fff8d0fd152 in __cxa_throw ()\n#8  0x0000000101f1cb85 in py_error (s=0xe688 <Address 0xe688 out of bounds>) at numeric.cpp:131\n#9  0x0000000101f2915e in Integer (x=@0x100308fa0) at numeric.cpp:169\n#10 0x0000000101f29dd6 in Rational () at /Users/wstein/sage/install/sage-4.7.3.alpha1/spkg/build/pynac-0.2.3/src/ginac/numeric.cpp:180\n#11 0x0000000101f29dd6 in GiNaC::Number_T::operator/ (this=0x6, x=@0x0) at numeric.cpp:554\n#12 0x0000000101f2a549 in GiNaC::numeric::numeric (this=0xe688, numer=59016, denom=2) at numeric.cpp:1410\n#13 0x0000000101f672ea in GiNaC::library_init::library_init (this=0xe688) at utils.cpp:288\n#14 0x0000000101e00bf9 in __static_initialization_and_destruction_0 [inlined] () at /Users/wstein/sage/install/sage-4.7.3.alpha1/spkg/build/pynac-0.2.3/src/ginac/py_funcs.cpp:59\n```\n\nWhat's happening here is this code is run during pynac initialization and totally fails due to the `PyImport_ImportModule(...)` failing, returning an error pointer that is invalid, which again suggests that the PYthon library is somehow not properly initialized. \n\n```\nPyObject* Integer(const long int& x) {\n  if (initialized) \n    return GiNaC::py_funcs.py_integer_from_long(x);\n  \n  // Slow version since we can't call Cython-exported code yet.\n  PyObject* m = PyImport_ImportModule(\"sage.rings.integer\");\n  if (!m)\n    py_error(\"Error importing sage.rings.integer\");\n```",
    "created_at": "2011-11-08T18:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134530",
    "user": "https://github.com/williamstein"
}
```

OK, I'm next rebuilding everything (pynac spkg + "sage -ba"), with that static library (mentioned in the previous comment above) *deleted* to avoid it accidentally getting linked in somewhere.    This did not help.  Starting Sage fails with this traceback now (different than before):

```
terminate called throwing an exception
Program received signal SIGABRT, Aborted.
0x00007fff941a182a in __kill ()
(gdb) bt
#0  0x00007fff941a182a in __kill ()
#1  0x00007fff8d186a9c in abort ()
#2  0x00007fff8d0fe7bc in abort_message ()
#3  0x00007fff8d0fbfcf in default_terminate ()
#4  0x00007fff8ccc21cd in _objc_terminate ()
#5  0x00007fff8d0fc001 in safe_handler_caller ()
#6  0x00007fff8d0fc05c in std::terminate ()
#7  0x00007fff8d0fd152 in __cxa_throw ()
#8  0x0000000101f1cb85 in py_error (s=0xe688 <Address 0xe688 out of bounds>) at numeric.cpp:131
#9  0x0000000101f2915e in Integer (x=@0x100308fa0) at numeric.cpp:169
#10 0x0000000101f29dd6 in Rational () at /Users/wstein/sage/install/sage-4.7.3.alpha1/spkg/build/pynac-0.2.3/src/ginac/numeric.cpp:180
#11 0x0000000101f29dd6 in GiNaC::Number_T::operator/ (this=0x6, x=@0x0) at numeric.cpp:554
#12 0x0000000101f2a549 in GiNaC::numeric::numeric (this=0xe688, numer=59016, denom=2) at numeric.cpp:1410
#13 0x0000000101f672ea in GiNaC::library_init::library_init (this=0xe688) at utils.cpp:288
#14 0x0000000101e00bf9 in __static_initialization_and_destruction_0 [inlined] () at /Users/wstein/sage/install/sage-4.7.3.alpha1/spkg/build/pynac-0.2.3/src/ginac/py_funcs.cpp:59
```

What's happening here is this code is run during pynac initialization and totally fails due to the `PyImport_ImportModule(...)` failing, returning an error pointer that is invalid, which again suggests that the PYthon library is somehow not properly initialized. 

```
PyObject* Integer(const long int& x) {
  if (initialized) 
    return GiNaC::py_funcs.py_integer_from_long(x);
  
  // Slow version since we can't call Cython-exported code yet.
  PyObject* m = PyImport_ImportModule("sage.rings.integer");
  if (!m)
    py_error("Error importing sage.rings.integer");
```



---

archive/issue_comments_134531.json:
```json
{
    "body": "Hey wait, I just realized that in my test above I was trying to import that \"a\" module I had made first, and some other parts of the Sage library hadn't been loaded yet.   Removing that, Sage starts up without segfaulting.  W00t!\n\nSo I have now successfully 100% build Sage on OS X 10.7.2 with XCode 4.2, and got it to startup.   I'll post the result of running the test suite soon.",
    "created_at": "2011-11-08T18:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134531",
    "user": "https://github.com/williamstein"
}
```

Hey wait, I just realized that in my test above I was trying to import that "a" module I had made first, and some other parts of the Sage library hadn't been loaded yet.   Removing that, Sage starts up without segfaulting.  W00t!

So I have now successfully 100% build Sage on OS X 10.7.2 with XCode 4.2, and got it to startup.   I'll post the result of running the test suite soon.



---

archive/issue_comments_134532.json:
```json
{
    "body": "So should we delete this file in the python spkg?  Here's an spkg which does that:\n\n- [http://sage.math.washington.edu/home/palmieri/SPKG/python-2.6.4.p12.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/python-2.6.4.p12.spkg)\n\nI'm attaching the patch to the spkg, for reference.",
    "created_at": "2011-11-09T05:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134532",
    "user": "https://github.com/jhpalmieri"
}
```

So should we delete this file in the python spkg?  Here's an spkg which does that:

- [http://sage.math.washington.edu/home/palmieri/SPKG/python-2.6.4.p12.spkg](http://sage.math.washington.edu/home/palmieri/SPKG/python-2.6.4.p12.spkg)

I'm attaching the patch to the spkg, for reference.



---

archive/issue_comments_134533.json:
```json
{
    "body": "Replying to [comment:9 jhpalmieri]:\n> So should we delete this file in the python spkg?\n\n\nI don't know.  It might also make sense to somehow change Pynac, but I'm not sure.  It is always bad in the context of Sage to link in the python library statically, so it's probably good to not have that file exported at all...",
    "created_at": "2011-11-09T16:36:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134533",
    "user": "https://github.com/williamstein"
}
```

Replying to [comment:9 jhpalmieri]:
> So should we delete this file in the python spkg?


I don't know.  It might also make sense to somehow change Pynac, but I'm not sure.  It is always bad in the context of Sage to link in the python library statically, so it's probably good to not have that file exported at all...



---

archive/issue_comments_134534.json:
```json
{
    "body": "I doubt it is relevant, but note there is a problem on 64-bit Solaris with Pynac causing a segfault, which I think was related to the order of objects being loaded is not defined. I can't recall the details, and need to leave for work shortly, but there is a Solaris ticket for it and some comments from Burchin about it, \n\nDave",
    "created_at": "2011-11-10T06:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134534",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

I doubt it is relevant, but note there is a problem on 64-bit Solaris with Pynac causing a segfault, which I think was related to the order of objects being loaded is not defined. I can't recall the details, and need to leave for work shortly, but there is a Solaris ticket for it and some comments from Burchin about it, 

Dave



---

archive/issue_comments_134535.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2011-11-10T13:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134535",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_134536.json:
```json
{
    "body": "Replying to [comment:11 drkirkby]:\n> I doubt it is relevant, but note there is a problem on 64-bit Solaris with Pynac causing a segfault,\n\n\nI think the ticket is #11116.  It doesn't look relevant to me, either, but other people should take a look.",
    "created_at": "2011-11-11T06:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134536",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:11 drkirkby]:
> I doubt it is relevant, but note there is a problem on 64-bit Solaris with Pynac causing a segfault,


I think the ticket is #11116.  It doesn't look relevant to me, either, but other people should take a look.



---

archive/issue_events_031675.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-02T13:12:13Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "milestone": "sage-4.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11795#event-31675"
}
```



---

archive/issue_events_031676.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-01-02T13:12:13Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "milestone": "sage-5.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11795#event-31676"
}
```



---

archive/issue_comments_134537.json:
```json
{
    "body": "I'm trying this again with OS X 10.7 and Sage-5.0.beta1:\n\n```\n$ cd SAGE_ROOT\n$ rm local/lib/python2.7/config/libpython2.7.a \n$ cp local/lib/libpython2.7.dylib local/lib/python2.7/config/\n$ ./sage -f spkg/standard/pynac-0.2.3.p0.spkg\n$ touch devel/sage/sage/symbolic/pynac.pyx\n$ ./sage -br\n```\nAnd now it starts up!",
    "created_at": "2012-01-16T15:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134537",
    "user": "https://github.com/williamstein"
}
```

I'm trying this again with OS X 10.7 and Sage-5.0.beta1:

```
$ cd SAGE_ROOT
$ rm local/lib/python2.7/config/libpython2.7.a 
$ cp local/lib/libpython2.7.dylib local/lib/python2.7/config/
$ ./sage -f spkg/standard/pynac-0.2.3.p0.spkg
$ touch devel/sage/sage/symbolic/pynac.pyx
$ ./sage -br
```
And now it starts up!



---

archive/issue_comments_134538.json:
```json
{
    "body": "NOTE: It's much safer to do `./sage -ba` above.",
    "created_at": "2012-01-16T15:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134538",
    "user": "https://github.com/williamstein"
}
```

NOTE: It's much safer to do `./sage -ba` above.



---

archive/issue_comments_134539.json:
```json
{
    "body": "Changing keywords from \"\" to \"python osx lion darwin\".",
    "created_at": "2012-02-04T06:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134539",
    "user": "https://github.com/jhpalmieri"
}
```

Changing keywords from "" to "python osx lion darwin".



---

archive/issue_comments_134540.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-02-04T06:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134540",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_134541.json:
```json
{
    "body": "New spkg: on OS X Lion, this deletes the file libpython2.7.a.  Self-tests fail, but they always do with Python.  More importantly, Sage starts up with no problems.",
    "created_at": "2012-02-04T06:23:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134541",
    "user": "https://github.com/jhpalmieri"
}
```

New spkg: on OS X Lion, this deletes the file libpython2.7.a.  Self-tests fail, but they always do with Python.  More importantly, Sage starts up with no problems.



---

archive/issue_comments_134542.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-02-05T16:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134542",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_134543.json:
```json
{
    "body": "The issue has nothing to with the **compiler**, it is a **linker** issue.  So, you should remove the `[ -z \"$CC\" ]` check.  Anyway, doesn't Sage *always* set \"$CC\"?",
    "created_at": "2012-02-05T16:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134543",
    "user": "https://github.com/jdemeyer"
}
```

The issue has nothing to with the **compiler**, it is a **linker** issue.  So, you should remove the `[ -z "$CC" ]` check.  Anyway, doesn't Sage *always* set "$CC"?



---

archive/issue_comments_134544.json:
```json
{
    "body": "Since I'm changing the Python spkg in #12422 anyway, I might make this change myself and rebase #12422 on this spkg.",
    "created_at": "2012-02-05T16:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134544",
    "user": "https://github.com/jdemeyer"
}
```

Since I'm changing the Python spkg in #12422 anyway, I might make this change myself and rebase #12422 on this spkg.



---

archive/issue_comments_134545.json:
```json
{
    "body": "You're right, Sage always sets `$CC` to \"gcc\".  So on tickets where it's necessary, we should check whether `[ \"$CC\" = \"gcc\" ]`.  I put up a new spkg here since this is a small change, but go ahead and put the focus on #12422 if you want.",
    "created_at": "2012-02-05T17:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134545",
    "user": "https://github.com/jhpalmieri"
}
```

You're right, Sage always sets `$CC` to "gcc".  So on tickets where it's necessary, we should check whether `[ "$CC" = "gcc" ]`.  I put up a new spkg here since this is a small change, but go ahead and put the focus on #12422 if you want.



---

archive/issue_comments_134546.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-02-05T17:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134546",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_134547.json:
```json
{
    "body": "patch for python spkg; for reference only",
    "created_at": "2012-02-05T17:00:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134547",
    "user": "https://github.com/jhpalmieri"
}
```

patch for python spkg; for reference only



---

archive/issue_comments_134548.json:
```json
{
    "body": "Attachment [trac_11967-python.patch](tarball://root/attachments/some-uuid/ticket11967/trac_11967-python.patch) by @jdemeyer created at 2012-02-06 09:47:34\n\nReplying to [comment:20 jhpalmieri]:\n> You're right, Sage always sets `$CC` to \"gcc\".  So on tickets where it's necessary, we should check whether `[ \"$CC\" = \"gcc\" ]`.\n\nI don't think we should **ever** do that.  Check features, not executable names.",
    "created_at": "2012-02-06T09:47:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134548",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [trac_11967-python.patch](tarball://root/attachments/some-uuid/ticket11967/trac_11967-python.patch) by @jdemeyer created at 2012-02-06 09:47:34

Replying to [comment:20 jhpalmieri]:
> You're right, Sage always sets `$CC` to "gcc".  So on tickets where it's necessary, we should check whether `[ "$CC" = "gcc" ]`.

I don't think we should **ever** do that.  Check features, not executable names.



---

archive/issue_comments_134549.json:
```json
{
    "body": "In #12422, I'm changing \"rm\" to \"rm -f\".  Objections?",
    "created_at": "2012-02-06T10:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134549",
    "user": "https://github.com/jdemeyer"
}
```

In #12422, I'm changing "rm" to "rm -f".  Objections?



---

archive/issue_comments_134550.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Replying to [comment:20 jhpalmieri]:\n> > You're right, Sage always sets `$CC` to \"gcc\".  So on tickets where it's necessary, we should check whether `[ \"$CC\" = \"gcc\" ]`.\n\n> I don't think we should **ever** do that.  Check features, not executable names.\n\nI don't see anything wrong with checking whether \"$CC\" is \"gcc\", as long as it's just a preliminary check, not the only check.\n\nReplying to [comment:22 jdemeyer]:\n> In #12422, I'm changing \"rm\" to \"rm -f\".  Objections?\n\n\nNo objections, that's fine.  (I think in preliminary versions of the patch, I kept misspelling the name of the file to be deleted, so I wanted spkg-install to quit if it didn't delete anything.  Otherwise I would have had 'rm -f' there, too.)",
    "created_at": "2012-02-06T18:15:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134550",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 jhpalmieri]:
> > You're right, Sage always sets `$CC` to "gcc".  So on tickets where it's necessary, we should check whether `[ "$CC" = "gcc" ]`.

> I don't think we should **ever** do that.  Check features, not executable names.

I don't see anything wrong with checking whether "$CC" is "gcc", as long as it's just a preliminary check, not the only check.

Replying to [comment:22 jdemeyer]:
> In #12422, I'm changing "rm" to "rm -f".  Objections?


No objections, that's fine.  (I think in preliminary versions of the patch, I kept misspelling the name of the file to be deleted, so I wanted spkg-install to quit if it didn't delete anything.  Otherwise I would have had 'rm -f' there, too.)



---

archive/issue_comments_134551.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-02-07T11:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134551",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_134552.json:
```json
{
    "body": "Works for me!",
    "created_at": "2012-02-07T11:25:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134552",
    "user": "https://github.com/jdemeyer"
}
```

Works for me!



---

archive/issue_events_031677.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2012-02-14T14:20:52Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/11795#event-31677"
}
```



---

archive/issue_comments_134553.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-02-14T14:20:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134553",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_134554.json:
```json
{
    "body": "We should not rely on `xcodebuild` to determine XCode version numbers (see sage-devel).  How about applying this fix on all OS X 10.6 and above (on a new ticket)?",
    "created_at": "2012-02-22T16:04:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134554",
    "user": "https://github.com/jdemeyer"
}
```

We should not rely on `xcodebuild` to determine XCode version numbers (see sage-devel).  How about applying this fix on all OS X 10.6 and above (on a new ticket)?



---

archive/issue_comments_134555.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> We should not rely on `xcodebuild` to determine XCode version numbers (see sage-devel).  How about applying this fix on all OS X 10.6 and above (on a new ticket)?\n\n\nI've only seen the problem on OS X 10.7.  Why apply it on 10.6?  (I'm guessing that it wouldn't break anything, so it wouldn't hurt, but is there a reason for doing it on 10.6?)",
    "created_at": "2012-02-22T17:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134555",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:26 jdemeyer]:
> We should not rely on `xcodebuild` to determine XCode version numbers (see sage-devel).  How about applying this fix on all OS X 10.6 and above (on a new ticket)?


I've only seen the problem on OS X 10.7.  Why apply it on 10.6?  (I'm guessing that it wouldn't break anything, so it wouldn't hurt, but is there a reason for doing it on 10.6?)



---

archive/issue_comments_134556.json:
```json
{
    "body": "See #12574 for a followup.",
    "created_at": "2012-02-23T17:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134556",
    "user": "https://github.com/jhpalmieri"
}
```

See #12574 for a followup.



---

archive/issue_comments_134557.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> Replying to [comment:20 jhpalmieri]:\n> > You're right, Sage always sets `$CC` to \"gcc\".  So on tickets where it's necessary, we should check whether `[ \"$CC\" = \"gcc\" ]`.\n\n> I don't think we should **ever** do that.  Check features, not executable names.\n\nThe testcc.sh script in $SAGE_LOCAL/bin does exactly that - it tests features. It can identify all the common C compilers, and some of the not-so-common C compilers. There's also another script (I think testcxx.sh), which does the same for C++ compilers. Doing this for Fortran compilers is something I have never managed to work out. \n\nDave",
    "created_at": "2012-02-24T06:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11795",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11795#issuecomment-134557",
    "user": "https://trac.sagemath.org/admin/accounts/users/drkirkby"
}
```

Replying to [comment:21 jdemeyer]:
> Replying to [comment:20 jhpalmieri]:
> > You're right, Sage always sets `$CC` to "gcc".  So on tickets where it's necessary, we should check whether `[ "$CC" = "gcc" ]`.

> I don't think we should **ever** do that.  Check features, not executable names.

The testcc.sh script in $SAGE_LOCAL/bin does exactly that - it tests features. It can identify all the common C compilers, and some of the not-so-common C compilers. There's also another script (I think testcxx.sh), which does the same for C++ compilers. Doing this for Fortran compilers is something I have never managed to work out. 

Dave
