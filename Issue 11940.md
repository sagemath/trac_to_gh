# Issue 11940: prereq should not check for m4

Issue created by migration from https://trac.sagemath.org/ticket/12112

Original creator: jdemeyer

Original creation time: 2011-12-03 13:06:03

Assignee: GeorgSWeber

CC:  mjo jhpalmieri drkirkby

Since Sage does not need m4, we should not check for it.


---

Comment by kcrisman created at 2011-12-03 15:36:04

Huh, that would be useful to know for the Cygwin thing as well.  Currently we need it there, presumably for the same reason.  Thanks.


---

Comment by mjo created at 2011-12-07 17:02:21

Sage may not need it, but the rest of the prereq build system does:


```
prereq-0.9 $ make
(CDPATH="${ZSH_VERSION+.}:" && cd . && /bin/sh /home/mjo/src/sage-4.8.alpha3/spkg/build/prereq-0.9/missing --run autoheader)
autom4te-2.68: need GNU m4 1.4 or later: /usr/bin/m4
autoheader-2.68: '/usr/bin/autom4te-2.68' failed with exit status: 1
make: *** [config.h.in] Error 1
```


We could probably ship a pre-built `configure` and `Makefile` rather than rely on autotools, but this is black magic to me and I don't understand the tradeoffs involved.


---

Comment by jdemeyer created at 2011-12-07 22:30:54

Replying to [comment:2 mjo]:
> Sage may not need it, but the rest of the prereq build system does.
Not really, you just need to run it *once*, it is sufficient if the developer of the new `prereq` package runs it before shipping it into Sage.


---

Attachment


---

Comment by jhpalmieri created at 2012-03-26 20:56:13

What do you think about changing the prereq install script to use bash instead of sh?  (See #12621: with non-bash versions of sh, e.g., on Solaris, at least one part of the script doesn't work properly.)


---

Comment by jdemeyer created at 2012-03-27 20:17:31

This seems to work like it should, so needs_review.


---

Comment by jdemeyer created at 2012-03-27 20:17:31

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-03-28 04:32:48

Dave, I'm cc'ing you. I don't know if you have any time these days, but since you worked on the original prereq script, you may be one of the most qualified people to review this, especially the changes in [attachment:prereq-1.0.diff]. (The other changes are pretty straightforward, I think.)


---

Comment by jdemeyer created at 2012-03-29 12:14:40

Concerning `bash`: maybe we shoudn't require bash in the prereq script.  The prereq script checks whether bash is available and gives a clear error message if it's not.  So I would try to make the script portable, and not force bash.


---

Comment by jhpalmieri created at 2012-03-29 15:20:09

If we don't use bash, then the code

```sh
if ! [ -f "$SAGE_ROOT/spkg/base/$TARGET.tar" ]; then
```

needs to be changed: it gives an error when run on Solaris:

```
base/prereq-0.9-install: !: not found
```

(The error is ignored and installation continues, but this should still be fixed.)


---

Comment by jdemeyer created at 2012-03-29 15:34:14

Okay, un-negated the test and swapped the "if" and "else" clauses.


---

Comment by jhpalmieri created at 2012-03-29 15:57:26

(After a little experimentation, I guess putting the `!` inside the test would have worked, too: `if [ ! -f ... ]`.)


---

Comment by drkirkby created at 2012-03-29 21:55:27

Replying to [comment:14 jdemeyer]:
> Concerning `bash`: maybe we shouldn't require bash in the prereq script.  The prereq script checks whether bash is available and gives a clear error message if it's not.  So I would try to make the script portable, and not force bash.

Agreed. Someone had ideas of converting sage to use the autotools (or autohell to William). The tools are carefully written to be portable, so the last thing we should do is force any non-portable code in there, as it would make it more difficult to use the current script as a basis for others.


---

Comment by drkirkby created at 2012-03-29 22:00:28

Replying to [comment:13 jhpalmieri]:
> Dave, I'm cc'ing you. I don't know if you have any time these days, but since you worked on the original prereq script, you may be one of the most qualified people to review this, especially the changes in [attachment:prereq-1.0.diff]. (The other changes are pretty straightforward, I think.)

I'll comment there.


---

Comment by drkirkby created at 2012-03-29 22:56:38

A few comments: 

1) Testing with: 


```
if [ "$SAGE_BUILD_DIR" = "" ]; then 
```


is bad practice. Testing on "" can fail under some admittedly obscure circumstances. Better would be 


```
if [ "x$SAGE_BUILD_DIR" = x ]; then 
```


2) Are we 100% sure m4 is not needed? I have some recollection of it being needed somewhere. If not, this 
http://www.sagemath.org/doc/faq/faq-usage.html
needs modifying, as that specifically says to install m4. The configure script was clearly written with this in mind too. 

I can't judge all the implications of all the changes, but looking at the diffs only, I can't see anything that looks as though it will be a problem.  

A couple of minor points, one could address if one wanted to: 

a) The Solaris page should now really be to Oracle and not Sun, but it's no big deal. 

b) Although William was annoyed when Sage would not build with gcc 3.4 series due to "ratpoints", and was keen to get Sage working with gcc 3.4.x, I think the chances of that happening are very remote now. There is too much code that will not compile with such an old version of gcc. So one could consider removing all the checks associated with gcc 3.4.x, and simply accept that gcc 4.0.1 is the minimum version. That could take quite a bit of code out, and would mean that SAGE_USE_OLD_GCC could be removed from the list of environment variables. 

So I can't see anything wrong, with the exception of how SAGE_BUILD_DIR is tested. 

Assuming John and Jeroen are happy with each others changes, and the SAGE_BUILD_DIR issue is fixed, I think this should be set to positive review. 


Dave


---

Comment by jhpalmieri created at 2012-03-29 23:35:31

See #12785 for the FAQ issue. Regarding tests like `if [ x"..." = x ]; then`, if we were sure to be using bash, I would feel comfortable omitting the x's, but since we're not using bash here, perhaps we should include the x's.


---

Comment by jdemeyer created at 2012-03-30 12:15:07

Ok, I'm making the following changes:

```diff
--- a/spkg/base/prereq-1.0-install
+++ b/spkg/base/prereq-1.0-install
@@ -5,7 +5,7 @@


 TARGET=prereq-1.0
-if [ "$SAGE_BUILD_DIR" = "" ]; then
+if [ "x$SAGE_BUILD_DIR" = x ]; then
     SAGE_BUILD_DIR="$SAGE_ROOT/spkg/build"
 fi
 mkdir -p "$SAGE_BUILD_DIR"
@@ -22,7 +22,7 @@
 echo "Starting prerequisite check."
 echo "Machine: `uname -a`"

-if [ "$SAGE_PORT" = "" ]; then
+if [ "x$SAGE_PORT" = x ]; then
     if [ `uname | sed -e 's/WIN.\+/WIN/'` = "CYGWIN" ]; then
         echo "Unfortunately, building SAGE on Cygwin is not currently supported,"
         echo "though we are actively working on supporting it.  If you would like"
@@ -138,7 +138,7 @@
     fi

     # If we are installing GCC, skip all compiler checks in ./configure
-    if [ "$SAGE_BUILD_TOOLCHAIN" = yes ]; then
+    if [ "x$SAGE_BUILD_TOOLCHAIN" = xyes ]; then
         PREREQ_OPTIONS="--disable-compiler-checks $PREREQ_OPTIONS"
     fi

```



---

Attachment


---

Comment by jdemeyer created at 2012-03-30 12:19:32

Replying to [comment:21 drkirkby]:
> b) Although William was annoyed when Sage would not build with gcc 3.4 series due to "ratpoints", and was keen to get Sage working with gcc 3.4.x, I think the chances of that happening are very remote now. There is too much code that will not compile with such an old version of gcc. So one could consider removing all the checks associated with gcc 3.4.x, and simply accept that gcc 4.0.1 is the minimum version. That could take quite a bit of code out, and would mean that SAGE_USE_OLD_GCC could be removed from the list of environment variables. 
I would wait with this until #12369 is merged.


---

Comment by jdemeyer created at 2012-03-30 13:32:55

Replying to [comment:21 drkirkby]:
> Assuming John and Jeroen are happy with each others changes, and the SAGE_BUILD_DIR issue is fixed, I think this should be set to positive review. 
Done!


---

Comment by jdemeyer created at 2012-03-30 13:33:02

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-03-30 15:37:21

I wouldn't say #12785 is a dependency, it's more like a follow-up.


---

Comment by jdemeyer created at 2012-04-01 16:04:44

I was wrong about Sage not requiring `m4`.  At least MPIR does require m4 (maybe older versions which I tested initially didn't require `m4`).


---

Comment by jdemeyer created at 2012-04-01 16:04:44

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2012-04-01 16:39:53

Diff for the prereq tarball, for review only


---

Comment by jdemeyer created at 2012-04-01 16:40:45

Changing status from needs_work to needs_review.


---

Attachment

Restored the m4 check.


---

Comment by jdemeyer created at 2012-04-04 07:08:27

Can somebody please review this again?  The only change with respect to the old version was to restore the check for `m4`.


---

Comment by jdemeyer created at 2012-04-04 12:36:58

David Kirkby sent this is an email:

```
Hi,
I see your comment about wanting the update reviewed, and the only
change was checking for m4 again. I'm at work now, and don't have my
Sage trac password with me, so I can't update the ticket. Please
consider I have given this a positive review. I suggest you copy this
email, and put it in the trac ticket, and change it to positive
yourself

Dave
```



---

Comment by jdemeyer created at 2012-04-04 12:36:58

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-04-06 11:45:01

See #12814 for a *blocker* follow-up: `prereq-0.9-install` should be added to `.hgignore` for upgraded Sage versions.


---

Comment by jdemeyer created at 2012-04-07 15:08:00

Resolution: fixed
