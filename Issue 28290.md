# Issue 28290: Character art concatenation takes quadratic time

Issue created by migration from https://trac.sagemath.org/ticket/28527

Original creator: @mwageringel

Original creation time: 2019-09-22 18:46:24

Keywords: ascii_art, unicode_art

This ticket solves a couple of performance problems with ASCII and unicode art representations.

• Concatenating character art objects takes quadratic amount of time in the length of the string. This is particularly problematic with the `%display ascii_art` or `unicode_art` modes. For containers such as tuples or lists, the mere printing of a large result of a computation takes a disproportionate amount of time.
  {{{
  sage: a = [['a'] * 2^k*1000 for k in (0..3)]
  sage: for b in a:
  ....:     %time _ = unicode_art(b)
  CPU times: user 221 ms, sys: 6.62 ms, total: 228 ms
  Wall time: 227 ms
  CPU times: user 751 ms, sys: 10.4 ms, total: 761 ms
  Wall time: 765 ms
  CPU times: user 2.89 s, sys: 27.2 ms, total: 2.91 s
  Wall time: 2.92 s
  CPU times: user 12.7 s, sys: 132 ms, total: 12.8 s
  Wall time: 12.9 s
  }}}
  This is solved by reimplementing `character_art_factory.concatenate` more efficiently, essentially by using `join` line by line.

• The function `character_art._repr_` is currently implemented in a recursive fashion in order to wrap the character objects at the window size. This ticket reimplements this in a non-recursive way to avoid reaching the recursion limit on long input. For example for a window of width 80:
  {{{
  sage: _ = ascii_art(['a'*30] * 1000)._split_repr_(80)
  ...
  RecursionError: maximum recursion depth exceeded
  }}}
  The new implementation also avoids quadratic time complexity.

----

Additionally, this ticket solves the following small problems:

• According to the documentation, the parameter `empty` for `concatenate` should only be used for input of length 0, but instead it is prepended to everything:
  {{{
  sage: [sage.typeset.ascii_art._ascii_art_factory.concatenate(
  ....:     'abc'[:k], ascii_art(':'), empty=ascii_art('0')) for k in (0..3)]
  [0, 0a, 0a:b, 0a:b:c]
  }}}

• Wrapping currently happens one character too early. For window width 80, the first line in this example should be of length 80, not 79:
  {{{
  sage: s = ascii_art(*(['']*90), sep=',')._split_repr_(80); print(s)
  <sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub><sub>,</sub>,,,,

  <sub>,</sub><sub>,</sub>
  sage: len(s.split('\n')[0])  # should be 80
  79
  }}}

• With this ticket, the brackets of containers only stretch as far as the contents. Previously they would always stretch to the 0-baseline:
  {{{
  sage: ascii_art([ascii_art('a', baseline=1)])  # should have height 1
  [   ]
  [ a ]
  }}}

• When adding two character art objects, elements of different heights are usually aligned at the bottom, except if one or both of the `_baseline` parameters are `None`, in which case they are aligned from the top. Addition of character art objects is non-associative because of this. This feature does not seem to be used anywhere in Sage (the baseline is always set to a number in the constructors), so it is removed by this ticket, as it simplifies the implementation. Alignment from the top can still be realized by setting the baseline to the correct number.

• `build_container` does not handle strings of height 0:
  {{{
  sage: sage.typeset.ascii_art._ascii_art_factory.build_container(
  ....:     ascii_art(''),
  ....:     sage.typeset.symbols.ascii_left_parenthesis,
  ....:     sage.typeset.symbols.ascii_right_parenthesis)
  ...
  ValueError: number of lines must be positive
  }}}

• A few typos.



---

Comment by @mwageringel created at 2019-09-22 19:22:59

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2019-09-22 19:22:59

With this branch, I get the following timings, showing that concatenation scales linearly:

```
sage: a = [['a'] * 2^k*1000 for k in (0..6)]
sage: for b in a:
....:     %time _ = unicode_art(b)
CPU times: user 15.6 ms, sys: 886 µs, total: 16.4 ms
Wall time: 15.4 ms
CPU times: user 27.6 ms, sys: 1.79 ms, total: 29.4 ms
Wall time: 28.8 ms
CPU times: user 44 ms, sys: 1.54 ms, total: 45.6 ms
Wall time: 45.2 ms
CPU times: user 78.4 ms, sys: 2.04 ms, total: 80.5 ms
Wall time: 80.8 ms
CPU times: user 234 ms, sys: 8.65 ms, total: 243 ms
Wall time: 246 ms
CPU times: user 374 ms, sys: 11.5 ms, total: 386 ms
Wall time: 389 ms
CPU times: user 781 ms, sys: 19.8 ms, total: 800 ms
Wall time: 804 ms
```

----
New commits:


---

Comment by tscrim created at 2019-09-22 23:37:25

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-09-22 23:37:25

LGTM.


---

Comment by vbraun created at 2019-10-06 23:07:23

Resolution: fixed
