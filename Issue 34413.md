# Issue 34413: Failure to solve a system of linear equations involving explicit complex constants

Issue created by migration from https://trac.sagemath.org/ticket/34650

Original creator: charpent

Original creation time: 2022-10-11 08:41:09

Keywords: solve maxima

Initially seen in [this ask.agemath question](https://ask.sagemath.org/question/64344/solving-a-system-of-linear-equations-with-complex-numbers-yields-false-solution/), discussed in [sage-devel](https://groups.google.com/g/sage-devel/c/6jIKV1hPoCQ).


```
var('L1 L2 L3 L4 C1 C2 C3 C4 M23 I1 I2 I3 I4 U w p RL I J')
## Nota Bene : here, I is a symbolic variable !
Sys = [I1*(w*I*L1 + 1/(w*I*C1)) + I2*(-1/(w*I*C1) ) == U,
       I2*(w*I*L2 + 1/(w*I*C1) + 1/(w*I*C2)) + I3*(w*I*M23 - 1/(w*I*C2)) + I1*(- 1/(w*I*C1)) == 0,
       I3*(1/(w*I*C3) + w*I*L3 + 1/(w*I*C2)) + I2*(w*I*M23 - 1/(w*I*C2)) - I4/(w*I*C3) == 0,
       I4/(w*I*C3) + I4*RL - I3/(w*I*C3) == 0]
IVars = [I1, I2, I3, I4]
```


THis system is easily checked by Sage's default solver (i. e. Maxima's) :


```
sage: Sol = solve(Sys, IVars)
```


and this solution checks :


```
sage: [bool(u.subs(Sol[0]).simplify_full()) for u in Sys]
[True, True, True, True]
```


Now, if we replace the `I` variable by the constant) imaginary unit //i//, Sage's solver finds a //wrong// "solution" :


```
sage: Sys0 = [u.subs({I:J}) for u in Sys]
sage: reset("I")
sage: Sys0 = [u.subs({J:I}) for u in Sys0]
sage: Sol0 = solve(Sys0, IVars)
sage: [bool(u.subs(Sol0[0]).simplify_full()) for u in Sys0]
[True, False, False, True]
```


This issue is reproducible in "pure" Maxima :


```
/* Original system, where I as a *variable* */
(%i31) Sys:[I1*(w*I*L1 + 1/(w*I*C1)) + I2*(-1/(w*I*C1) ) = U,
I2*(w*I*L2 + 1/(w*I*C1) + 1/(w*I*C2)) + I3*(w*I*M23 - 1/(w*I*C2)) + I1*(- 1/(w*I*C1)) = 0,
I3*(1/(w*I*C3) + w*I*L3 + 1/(w*I*C2)) + I2*(w*I*M23 - 1/(w*I*C2)) - I4/(w*I*C3) = 0,
I4/(w*I*C3) + I4*RL - I3/(w*I*C3) = 0]$

(%i32) IVars:[I1, I2, I3, I4]$
/* Solution of the original system */
(%i33) Sol: solve(Sys, IVars)$
/* Solution check : */
(%i34) map(lambda([x], is(ratsimp(subst(Sol, x)))), Sys);
(%o34)                     [true, true, true, true]
/* Specializing Sys by setting I=%i
(%i35) Sys0:map(lambda([x], subst(I=%i, x)), Sys)$
/* Solution */
(%i36) Sol0: solve(Sys0, IVars)$
/* Checking */
(%i37) map(lambda([x], is(ratsimp(subst(Sol0, x)))), Sys0);
(%o37)                    [true, false, false, true]
(%i38)
```


This has been [reported upstream](https://sourceforge.net/p/maxima/bugs/4032/).

This issue makes Sage return //silently// a wrong result from a (quasi-)trivial problem, hence priority set to critical.

Workaround : use Mathematica or the //gratis// Wolfram engine :


```
sage: MSol0 = {u[1].sage():u[2].sage() for u in mathematica.Solve(Sys0, IVars)[1]}
sage: [bool(u.subs(MSol0).simplify_full()) for u in Sys0]
[True, True, True, True]
```


Of note : //Sympy// currently does not return at all. To be explored in a possible distinct ticket.


---

Comment by @DaveWitteMorris created at 2022-10-20 20:22:06

In the [sage-devel thread](https://groups.google.com/g/sage-devel/c/6jIKV1hPoCQ),
Florian KÃ¶nigstein added the following helpful comment:

I'd like to point out that I found a much simpler system of equations for that it fails. I have also reported in the thread for maxima: https://sourceforge.net/p/maxima/bugs/4032/


```
var('I1 I2 I4 I5 C1 w')
assume(I5, "real", I5>0)
assume(C1, "real", C1>0)
assume(w, "real", w>0)

sys = [I*I1*w*C1 == 1, I2*w == I5*w, I*I4*w + I4 == 0]
lsg = solve(sys, [I1,I2,I4])
print(lsg)
[bool(eq.subs(lsg).simplify_full()) for eq in sys]
```

The output is:

```
[ [I1 == (-I*w^2 - 2*w + I)/(C1*w^2 - I*C1*w), I2 == I5, I4 == 0] ]
[False, True, True]
```

The system matrix is already diagonal, so that the system can be solved without any Gauss elimination steps. But the solution for I1 is wrong.
