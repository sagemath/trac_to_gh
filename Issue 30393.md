# Issue 30393: findstat error handling

Issue created by migration from https://trac.sagemath.org/ticket/30630

Original creator: mantepse

Original creation time: 2020-09-22 02:37:17




---

Comment by git created at 2020-09-22 03:17:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2020-09-22 07:34:25

Changing type from PLEASE CHANGE to enhancement.


---

Comment by mantepse created at 2020-09-22 07:34:25

Changing component from PLEASE CHANGE to combinatorics.


---

Comment by mantepse created at 2020-09-22 07:34:25

Changing keywords from "" to "findstat".


---

Comment by mantepse created at 2020-09-22 07:34:25

Changing priority from major to minor.


---

Comment by slelievre created at 2020-09-24 02:45:19

Use an url at `example.com` so nobody can play a trick? Check if that works.

```
-        sage: _get_json("https://nonexistingfindstaturl.org")
+        sage: _get_json("https://not-findstat.example.com")
         Traceback (most recent call last):
         ...
-        ConnectionError: HTTPSConnectionPool(host='nonexistingfindstaturl.org', port=443): Max retries exceeded with url: / (Caused by NewConnectionError('...Failed to establish a new connection: [Errno -2] Name or service not known'))
+        ConnectionError: HTTPSConnectionPool(host='not-findstat.example.com', port=443): Max retries exceeded with url: / (Caused by NewConnectionError('...Failed to establish a new connection: [Errno -2] Name or service not known'))
```


Don't forget to set to `needs_review` when ready.


---

Comment by git created at 2020-09-24 08:33:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2020-09-24 08:39:39

It turns out that testing what I really want to test is tricky:

* I originally wanted to test that an error is raised when findstat is down.

* using `badurl.example.com` or the like does not test this, because the domain does not exist.  In this case `request` also throws nested errors, which are hard to catch.

Therefore, I test something else, which makes more sense to test anyway.


---

Comment by mantepse created at 2020-09-24 08:39:39

Changing status from new to needs_review.


---

Comment by git created at 2020-09-26 10:12:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-27 16:23:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-27 18:28:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-28 10:06:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-10-08 11:30:30

Can you please modify the ticket description so that you see that the support for new collections is added.


---

Comment by vdelecroix created at 2020-10-10 19:49:02

Why are you turning the `JSONDecodeError` into a `ValueError`?


---

Comment by mantepse created at 2020-10-10 20:35:21

Because the reason for the error is (most likely) an inappropriate value `response.text`, due to (most likely) a bad url or a new but on the findstat server.  I felt that a `ValueError` would then be more correct.

For example, upon

```
sage: findstat()
The Combinatorial Statistic Finder (https://www.findstat.org/)
sage: sage.databases.findstat._get_json("https://www.findstat.org/")
```

if I only threw the `JSONDecodeError`, the message would simply be

```
JSONDecodeError: Expecting value: line 1 column 1 (char 0)
```

which wouldn't be helpful at all.

Thus I want to provide the `response.text`, which in this example would be the html of the frontpage of findstat.  Seeing this, I would immediately know that I forgot `api` in the url, which is a `ValueError`, I think.


---

Comment by slabbe created at 2020-10-22 09:04:06

green bot + works for me


---

Comment by slabbe created at 2020-10-22 09:04:06

Changing status from needs_review to positive_review.


---

Comment by mantepse created at 2020-10-22 10:08:17

Thank you!


---

Comment by vbraun created at 2020-11-07 16:22:23

Resolution: fixed
