# Issue 27351: Py3: Fix libs.ntl.ntl_ZZ_pX.pyx doctests.

Issue created by migration from https://trac.sagemath.org/ticket/27588

Original creator: vklein

Original creation time: 2019-04-01 13:21:33

Fix libs.ntl.ntl_ZZ_pX.pyx doctests for python3. All libs.ntl doctests should pass with this ticket.


---

Comment by vklein created at 2019-04-01 13:23:57

Looking at #24804 (which is already in merge confict) commits it doesn't appear to be conflict with this ticket.


---

Comment by vklein created at 2019-04-01 13:32:17

New commits:


---

Comment by vklein created at 2019-04-01 13:32:17

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-04-30 19:45:01

maybe we can instead try again my previous proposal in #24804 ?
----
New commits:


---

Comment by chapoton created at 2019-04-30 19:49:49

here is a simple but working solution
----
New commits:


---

Comment by git created at 2019-05-01 06:15:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-05-01 06:16:53

should be good now. I also made a few minor changes in the doc.


---

Comment by chapoton created at 2019-05-01 09:54:03

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-05-01 09:54:03

fails on python2


---

Comment by vklein created at 2019-05-02 09:37:55

As range is not a class in python2 the new `isinstance` is supposed to fail and the cythonize seems to be a little inconsistent if you use isinstance with a tuple as a second argument:
`elif isinstance(v, (list, tuple, range)):`
generate 

```
__pyx_t_1 = PyObject_IsInstance(__pyx_v_v, __pyx_builtin_range); 
__pyx_t_4 = (__pyx_t_1 != 0);
```

and 
`elif isinstance(v, (list, tuple)) or isinstance(v, range):` generate

```
pyx_t_4 = PyObject_IsInstance(__pyx_v_v, __pyx_builtin_range); 
if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(0, 96, __pyx_L1_error)
```

The latest is the consistent behaviour for me.

For the errors generated by this ticket with python2 the object return -1 on `PyObject_IsInstance(__pyx_v_v, __pyx_builtin_range)` and then `isinstance(v, (list, tuple, range)` return `True`.


---

Comment by chapoton created at 2019-05-02 10:23:45

peut etre que ca marcherait mieux en utilisant xrange, je n'ai pas le temps..


---

Comment by vklein created at 2019-05-02 11:05:39

Je vais essayer.


---

Comment by vklein created at 2019-05-02 11:19:53

It looks like that work !

with sage python3:

```
sage: from past.builtins import xrange
sage: isinstance(range(5), xrange)
True
sage: type(xrange(2))
<class 'range'>
```



---

Comment by git created at 2019-05-02 11:39:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-05-02 11:42:51

Changing status from needs_work to needs_review.


---

Comment by vklein created at 2019-05-02 11:42:51

I give positive review to the commits prior to `00f92a6`


---

Comment by chapoton created at 2019-05-02 16:58:06

probably no need for the import of xrange, as we are in a pyx file..


---

Comment by git created at 2019-05-03 06:50:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vklein created at 2019-05-03 06:52:51

Indeed. `import xrange` has been removed.


---

Comment by chapoton created at 2019-05-03 09:12:58

ok, works both in py2 and py3. If you agree, please set to positive


---

Comment by vklein created at 2019-05-03 09:14:00

Changing status from needs_review to positive_review.


---

Comment by vklein created at 2019-05-03 09:14:00

I agree.


---

Comment by vbraun created at 2019-05-06 11:56:32

Resolution: fixed
