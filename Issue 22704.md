# Issue 22704: Fix error in Sage's rich output display formatter

Issue created by migration from https://trac.sagemath.org/ticket/22941

Original creator: jhpalmieri

Original creation time: 2017-05-03 19:39:30

CC:  dimpase vbraun

Follow up to an issue raised on [sage-devel](https://groups.google.com/d/msg/sage-devel/uyerGH7gEEc/XtXZ1BS6CQAJ): running `vars()` or `locals()` leads to an error. Here is a fix.



---

Comment by jhpalmieri created at 2017-05-03 19:41:01

New commits:


---

Comment by jhpalmieri created at 2017-05-03 19:41:01

Changing status from new to needs_review.


---

Comment by dimpase created at 2017-05-03 20:56:15

does it depend on #22933 ?


---

Comment by dimpase created at 2017-05-03 21:00:13

one way or another, `vars()` works now.


---

Comment by dimpase created at 2017-05-03 21:00:13

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2017-05-03 22:06:15

It doesn't depend on #22933, by the way. Volker, I think you were responsible for this file originally, so please let us know if you have any objections.


---

Comment by dimpase created at 2017-05-03 22:10:38

Perhaps the question is whether `displayhook` can be `None`, or this is a bug.


---

Comment by jhpalmieri created at 2017-05-04 02:09:49

The `displayhook` method starts with

```
        if obj is None:
            return
```

So then the question is whether it is a bug if `obj is None`. (Well, `obj` can be `None`, certainly, but should that occur when you call `vars()` or `locals()`?)


---

Comment by vbraun created at 2017-05-04 19:46:18

I don't think the patch fixes the underlying issue. What really goes wrong is that `__repr__` of vars() somewhere activates SageNB support:

```
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()
[...]
sage: get_display_manager()
The Sage display manager using the SageNB backend
[errors]
```

And having the SageNB backend with the IPython terminal frontend just isn't going to work well....


---

Comment by dimpase created at 2017-05-04 20:49:33

We need to fix `repr(vars()['notebook'])` (surprise, surprise...) by some kind of "guarding" it, or perhaps by removing it from global namespace...


Indeed, try running the following:

```
sage: v=vars()
sage: f=open('/dev/null','w')
sage: for k in v.keys():
....:     if k!='v':   # to avoid recursion
....:         f.write(repr(v[k]))
....:         if 'NB' in str(get_display_manager()):
....:            print("Achtung!!! "+str(k))
....:            break
```

You will get some deprecation warnings and then

```
...
Achtung!!! notebook
```

So swithcing to SageNB backend is triggered by `repr(vars()['notebook'])`.

Indeed

```
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()['notebook']
<sagenb.notebook.notebook_object.NotebookObject instance at 0x7fe63d83ae18>
<sagenb.notebook.notebook_object.NotebookObject instance at 0x7fe63d83ae18>
sage: get_display_manager()
The Sage display manager using the SageNB backend
The Sage display manager using the SageNB backend
```


(doubling of lines is caused by unsuitability of SageNB backend for the terminal.)


---

Comment by vbraun created at 2017-05-04 22:12:01

Just resolving the notebook lazy import, e.g. by `notebook?`, is also sufficient. The easiest solution is probably to duplicate the sagenb notebook functions and docstrings in a proxy module that doesn't drag in the remaining SagenB machinery.


---

Comment by jhpalmieri created at 2017-05-04 22:31:46

This patch to SageNB fixes the problem for me. The point is to not import sagenb.misc.support at the top-level, since that file changes the displayhook.

```diff
diff --git a/sagenb/notebook/worksheet.py b/sagenb/notebook/worksheet.py
index f5b7c26..e41b28a 100644
--- a/sagenb/notebook/worksheet.py
+++ b/sagenb/notebook/worksheet.py
@@ -52,7 +52,6 @@ from sagenb.interfaces import (WorksheetProcess_ExpectImplementation,
                                WorksheetProcess_ReferenceImplementation,
                                WorksheetProcess_RemoteExpectImplementation)
 
-import sagenb.misc.support  as support
 from sagenb.misc.format import relocate_future_imports
 
 # Imports specifically relevant to the sage notebook
@@ -3812,7 +3811,8 @@ except (KeyError, IOError):
         return out
 
     def _get_last_identifier(self, s):
-        return support.get_rightmost_identifier(s)
+        import sagenb.misc.support
+        return sagenb.misc.support.get_rightmost_identifier(s)
 
     def preparse(self, s):
         """
```



---

Comment by jhpalmieri created at 2017-05-04 22:39:50

Actually, both Volker's and my suggestion fix `vars()['notebook']`, but they don't fix the problem in general:

```
sage: notebook?
...
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()['notebook']
<sagenb.notebook.notebook_object.NotebookObject instance at 0x1bc7f57e8>
sage: get_display_manager()
The Sage display manager using the IPython command line backend
sage: vars()
...
sage: get_display_manager()
The Sage display manager using the SageNB backend
The Sage display manager using the SageNB backend
```



---

Comment by jhpalmieri created at 2017-05-04 22:45:23

After making my change to SageNB, running Dima's code from comment:9 gives

```
Achtung!!! v
```

(which strikes me as odd since we already have `if k != v:` there).


---

Comment by dimpase created at 2017-05-05 13:02:04

it seems to be more self-referential than I thought...


---

Comment by vbraun created at 2017-05-05 20:36:03

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-05-05 20:36:03

`notebook` isn't the only thing tho, there is also `inotebook` and others ...


---

Comment by jhpalmieri created at 2017-05-05 20:38:19

Yes, but I don't understand why my proposed change to SageNB doesn't seem to fix all of them.


---

Comment by dimpase created at 2017-05-10 11:29:47

anyhow I will add the sagenb patch to sagenb repo now.


---

Comment by dimpase created at 2017-05-10 11:40:43

could it be that also `import sagenb.misc.support as _support_` in the string in
`initialize_sage()` in the same file is a problem?


---

Comment by git created at 2017-05-10 20:52:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2017-05-10 20:56:51

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2017-05-10 20:56:51

I think I've found the problem. This branch gets rid of the only place in the Sage library that imports sagenb.misc.support. Together with the SageNB patch, this allows `vars()` to work for me without changing the display manager. When I was testing it, I also put in a print statement in sagenb.misc.support:

```diff
--- misc/support.py~	2017-05-10 13:51:18.000000000 -0700
+++ misc/support.py	2017-05-10 13:55:00.000000000 -0700
@@ -41,6 +41,7 @@
         return False
 
 try:
+    print ('Warning: changing the display hook!!!')
     from sage.misc.displayhook import DisplayHook
     sys.displayhook = DisplayHook()
 except ImportError as msg:
```

and with this branch and the modification to SageNB, the warning is not printed when I evaluate `vars()`.


---

Comment by jhpalmieri created at 2017-05-10 21:02:05

Replying to [comment:18 dimpase]:
> could it be that also `import sagenb.misc.support as _support_` in the string in
> `initialize_sage()` in the same file is a problem?

By the way, I tested this, and it does not cause the problem. (I deleted that line and the problem remained.)


---

Comment by jhpalmieri created at 2017-05-10 21:13:21

We could also add a doctest if you want, but I'm not sure where to put it. sage/graphs/all.py? sage/graphs/graph_editor.py? I don't really want it to appear in the reference manual, so maybe the former.

```

"""
TESTS:

Test that sagenb.misc.support is not imported (see :trac:`22941`)::

    sage: import sage.graphs.graph_editor
    sage: 'sagenb.misc.support' in sys.modules
    False
"""
```



---

Comment by dimpase created at 2017-05-10 22:46:41

Good catch. Regarding the doctest, yes, we can have it where you suggest.

Perhaps Sage also needs a module called `customs` to control the imports properly :-)


---

Comment by git created at 2017-05-10 22:55:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-05-10 22:56:43

Replying to [comment:23 dimpase]:
> Good catch. Regarding the doctest, yes, we can have it where you suggest.
> 
> Perhaps Sage also needs a module called `customs` to control the imports properly :-)

Heh. See #21636 for a start. Make Sage Great Again.


---

Comment by dimpase created at 2017-05-10 23:11:21

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2017-05-10 23:12:18

Changing component from PLEASE CHANGE to refactoring.


---

Comment by vbraun created at 2017-05-15 22:51:17

Resolution: fixed
