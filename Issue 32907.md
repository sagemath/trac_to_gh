# Issue 32907: remove py2 tags in explain_pickle

archive/issues_032907.json:
```json
{
    "body": "CC:  embray @mjungmath tscrim\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33144\n\n",
    "created_at": "2022-01-10T18:06:26Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "remove py2 tags in explain_pickle",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32907",
    "user": "chapoton"
}
```
CC:  embray @mjungmath tscrim



Issue created by migration from https://trac.sagemath.org/ticket/33144





---

archive/issue_comments_469371.json:
```json
{
    "body": "Changing status from new to needs_info.",
    "created_at": "2022-01-10T18:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469371",
    "user": "chapoton"
}
```

Changing status from new to needs_info.



---

archive/issue_comments_469372.json:
```json
{
    "body": "boring and painful update..\n\nany expert on pickles aboard ?\n----\nNew commits:",
    "created_at": "2022-01-10T18:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469372",
    "user": "chapoton"
}
```

boring and painful update..

any expert on pickles aboard ?
----
New commits:



---

archive/issue_comments_469373.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-03-20T08:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469373",
    "user": "chapoton"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_469374.json:
```json
{
    "body": "ok, let's do that in several steps. Please review this first step.",
    "created_at": "2022-03-20T08:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469374",
    "user": "chapoton"
}
```

ok, let's do that in several steps. Please review this first step.



---

archive/issue_comments_469375.json:
```json
{
    "body": "please somebody have a look\n\nThis is the last file containing `#py2` tags. Here I remove only the simple ones, and the changes should rather be uncontroversial. The remaining cases are out of my capacity, and require an expert of pickle, that we may no longer have anywhere in sight..\n\nOne alternative would be #27350 (externalize) or just drop the file completely.",
    "created_at": "2022-06-11T07:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469375",
    "user": "chapoton"
}
```

please somebody have a look

This is the last file containing `#py2` tags. Here I remove only the simple ones, and the changes should rather be uncontroversial. The remaining cases are out of my capacity, and require an expert of pickle, that we may no longer have anywhere in sight..

One alternative would be #27350 (externalize) or just drop the file completely.



---

archive/issue_comments_469376.json:
```json
{
    "body": "It would be wonderful for Erik Bray to work on #27350 and close this ticket as `invalid/wontfix`. \n\nIf that would not happen, then I think we should fix `explain_pickle` for python3 before we remove the py2 tag, instead of \"fixing\" doctests for the broken `explain_pickle`.",
    "created_at": "2022-06-14T06:38:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469376",
    "user": "klee"
}
```

It would be wonderful for Erik Bray to work on #27350 and close this ticket as `invalid/wontfix`. 

If that would not happen, then I think we should fix `explain_pickle` for python3 before we remove the py2 tag, instead of "fixing" doctests for the broken `explain_pickle`.



---

archive/issue_comments_469377.json:
```json
{
    "body": "As far as I understand, Erik is no longer available.",
    "created_at": "2022-06-14T06:57:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469377",
    "user": "chapoton"
}
```

As far as I understand, Erik is no longer available.



---

archive/issue_comments_469378.json:
```json
{
    "body": "In principle, I agree with #27350, but I am slightly worried about the practice of it since I find this tool to be very useful at times and would be saddened if it bitrotted. I, unfortunately, would not be able to maintain such a package as I don't understand how `explain_pickle()` works. Since these doctests seem to just be updating the output, I think we should merge these in now. Likewise, I don't think I could help with any of the further marked tests.\n\nKwankyu, any objections to me setting a positive review?",
    "created_at": "2022-06-14T07:07:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469378",
    "user": "tscrim"
}
```

In principle, I agree with #27350, but I am slightly worried about the practice of it since I find this tool to be very useful at times and would be saddened if it bitrotted. I, unfortunately, would not be able to maintain such a package as I don't understand how `explain_pickle()` works. Since these doctests seem to just be updating the output, I think we should merge these in now. Likewise, I don't think I could help with any of the further marked tests.

Kwankyu, any objections to me setting a positive review?



---

archive/issue_comments_469379.json:
```json
{
    "body": "Replying to [comment:9 tscrim]:\n> Since these doctests seem to just be updating the output, \n\nSome outputs from `explain_pickle` (via `test_pickle`), for instance,\n\n```diff\n             sage: from sage.misc.explain_pickle import *\n-            sage: test_pickle(dumps(100000r, compress=False))  # py2\n-                0: \\x80 PROTO      2\n-                2: J    BININT     100000\n-                7: .    STOP\n-            highest protocol among opcodes = 2\n-            explain_pickle in_current_sage=True/False:\n-            100000\n-            result: 100000\n+            sage: test_pickle(dumps(100000r, compress=False))\n+                    0: \\x80 PROTO      2\n+                    2: c    GLOBAL     '_codecs encode'\n+                   18: q    BINPUT     0\n+                   20: X    BINUNICODE '\\x80\\x02J\\xa0\\x86\\x01\\x00.'\n+                   36: q    BINPUT     1\n+                   38: X    BINUNICODE 'latin1'\n+                   49: q    BINPUT     2\n+                   51: \\x86 TUPLE2\n+                   52: q    BINPUT     3\n+                   54: R    REDUCE\n+                   55: q    BINPUT     4\n+                   57: .    STOP\n+                highest protocol among opcodes = 2\n+                explain_pickle in_current_sage=True:\n+                from _codecs import encode\n+                encode('\\x80\\x02J\\xa0\\x86\\x01\\x00.', 'latin1')\n+                explain_pickle in_current_sage=False:\n+                pg_encode = unpickle_global('_codecs', 'encode')\n+                pg_encode('\\x80\\x02J\\xa0\\x86\\x01\\x00.', 'latin1')\n+                result: b'\\x80\\x02J\\xa0\\x86\\x01\\x00.'\n```\n\n\n\nseem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.\n\nIndentations of outputs are wrong.",
    "created_at": "2022-06-14T07:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469379",
    "user": "klee"
}
```

Replying to [comment:9 tscrim]:
> Since these doctests seem to just be updating the output, 

Some outputs from `explain_pickle` (via `test_pickle`), for instance,

```diff
             sage: from sage.misc.explain_pickle import *
-            sage: test_pickle(dumps(100000r, compress=False))  # py2
-                0: \x80 PROTO      2
-                2: J    BININT     100000
-                7: .    STOP
-            highest protocol among opcodes = 2
-            explain_pickle in_current_sage=True/False:
-            100000
-            result: 100000
+            sage: test_pickle(dumps(100000r, compress=False))
+                    0: \x80 PROTO      2
+                    2: c    GLOBAL     '_codecs encode'
+                   18: q    BINPUT     0
+                   20: X    BINUNICODE '\x80\x02J\xa0\x86\x01\x00.'
+                   36: q    BINPUT     1
+                   38: X    BINUNICODE 'latin1'
+                   49: q    BINPUT     2
+                   51: \x86 TUPLE2
+                   52: q    BINPUT     3
+                   54: R    REDUCE
+                   55: q    BINPUT     4
+                   57: .    STOP
+                highest protocol among opcodes = 2
+                explain_pickle in_current_sage=True:
+                from _codecs import encode
+                encode('\x80\x02J\xa0\x86\x01\x00.', 'latin1')
+                explain_pickle in_current_sage=False:
+                pg_encode = unpickle_global('_codecs', 'encode')
+                pg_encode('\x80\x02J\xa0\x86\x01\x00.', 'latin1')
+                result: b'\x80\x02J\xa0\x86\x01\x00.'
```



seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.

Indentations of outputs are wrong.



---

archive/issue_comments_469380.json:
```json
{
    "body": "Replying to [comment:10 klee]:\n> Replying to [comment:9 tscrim]:\n> > Since these doctests seem to just be updating the output, \n\n> seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.\n\nThe pickle itself has changed. If you run `loads(dumps(100000r))`, it returns the correct object without error. In this case, it is likely because `int` has changed from Python2 to Python3.\n\n> Indentations of outputs are wrong. \n\nIndeed; although I found the extra indentation level helped make clear what the doctest outputs were since they are so long with their own indentation. I don't hold a strong opinion on changing this or not.",
    "created_at": "2022-06-14T07:37:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469380",
    "user": "tscrim"
}
```

Replying to [comment:10 klee]:
> Replying to [comment:9 tscrim]:
> > Since these doctests seem to just be updating the output, 

> seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.

The pickle itself has changed. If you run `loads(dumps(100000r))`, it returns the correct object without error. In this case, it is likely because `int` has changed from Python2 to Python3.

> Indentations of outputs are wrong. 

Indeed; although I found the extra indentation level helped make clear what the doctest outputs were since they are so long with their own indentation. I don't hold a strong opinion on changing this or not.



---

archive/issue_comments_469381.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> Replying to [comment:10 klee]:\n> > Replying to [comment:9 tscrim]:\n> > > Since these doctests seem to just be updating the output, \n> \n> > seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.\n> \n> The pickle itself has changed. \n\nI meant the `result`. Shouldn't it be `100000`?",
    "created_at": "2022-06-14T07:43:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469381",
    "user": "klee"
}
```

Replying to [comment:11 tscrim]:
> Replying to [comment:10 klee]:
> > Replying to [comment:9 tscrim]:
> > > Since these doctests seem to just be updating the output, 
> 
> > seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.
> 
> The pickle itself has changed. 

I meant the `result`. Shouldn't it be `100000`?



---

archive/issue_comments_469382.json:
```json
{
    "body": "Replying to [comment:12 klee]:\n> Replying to [comment:11 tscrim]:\n> > Replying to [comment:10 klee]:\n> > > Replying to [comment:9 tscrim]:\n> > > > Since these doctests seem to just be updating the output, \n> > \n> > > seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.\n> > \n> > The pickle itself has changed. \n> \n> I meant the `result`. Shouldn't it be `100000`?\n\nI believe it is the right result but represented or interpreted in the wrong format. Mainly the bytes returned are not converted to a string correctly or something similar.",
    "created_at": "2022-06-14T08:33:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469382",
    "user": "tscrim"
}
```

Replying to [comment:12 klee]:
> Replying to [comment:11 tscrim]:
> > Replying to [comment:10 klee]:
> > > Replying to [comment:9 tscrim]:
> > > > Since these doctests seem to just be updating the output, 
> > 
> > > seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.
> > 
> > The pickle itself has changed. 
> 
> I meant the `result`. Shouldn't it be `100000`?

I believe it is the right result but represented or interpreted in the wrong format. Mainly the bytes returned are not converted to a string correctly or something similar.



---

archive/issue_comments_469383.json:
```json
{
    "body": "Perhaps we just don't remove the tag in the cases when the result is (at least superficially) different?",
    "created_at": "2022-06-14T08:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469383",
    "user": "tscrim"
}
```

Perhaps we just don't remove the tag in the cases when the result is (at least superficially) different?



---

archive/issue_comments_469384.json:
```json
{
    "body": "Replying to [comment:14 tscrim]:\n> Perhaps we just don't remove the tag in the cases when the result is (at least superficially) different?\n\n+1",
    "created_at": "2022-06-14T08:41:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469384",
    "user": "klee"
}
```

Replying to [comment:14 tscrim]:
> Perhaps we just don't remove the tag in the cases when the result is (at least superficially) different?

+1



---

archive/issue_comments_469385.json:
```json
{
    "body": "here is a new branch, where I have dropped the changes that did no look right\n\nI may have missed some\n----\nNew commits:",
    "created_at": "2022-06-14T12:15:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469385",
    "user": "chapoton"
}
```

here is a new branch, where I have dropped the changes that did no look right

I may have missed some
----
New commits:



---

archive/issue_comments_469386.json:
```json
{
    "body": "How about indentations? Did you indent more spaces intentionally?",
    "created_at": "2022-06-14T12:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469386",
    "user": "klee"
}
```

How about indentations? Did you indent more spaces intentionally?



---

archive/issue_comments_469387.json:
```json
{
    "body": "I think outputs should look as they do on the command line, modulo wrappings.",
    "created_at": "2022-06-14T12:24:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469387",
    "user": "klee"
}
```

I think outputs should look as they do on the command line, modulo wrappings.



---

archive/issue_comments_469388.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-06-15T08:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469388",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469389.json:
```json
{
    "body": "now the same as previous one, only with less indentations",
    "created_at": "2022-06-15T08:16:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469389",
    "user": "chapoton"
}
```

now the same as previous one, only with less indentations



---

archive/issue_comments_469390.json:
```json
{
    "body": "Thanks. But some cases with different `result` are still in.",
    "created_at": "2022-06-15T08:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469390",
    "user": "klee"
}
```

Thanks. But some cases with different `result` are still in.



---

archive/issue_comments_469391.json:
```json
{
    "body": "patch for removing some #py2 tags",
    "created_at": "2022-06-26T07:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469391",
    "user": "chapoton"
}
```

patch for removing some #py2 tags



---

archive/issue_comments_469392.json:
```json
{
    "body": "Attachment [0001-removal-of-py2-tag-in-doctests-of-explain-pickle-fir.patch](tarball://root/attachments/some-uuid/ticket33144/0001-removal-of-py2-tag-in-doctests-of-explain-pickle-fir.patch) by chapoton created at 2022-06-26 07:31:43\n\nThen maybe the simplest way would be if you could please edit the attached patch file : keep only the changes that you find appropriate and make a branch from that modified patch.",
    "created_at": "2022-06-26T07:31:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469392",
    "user": "chapoton"
}
```

Attachment [0001-removal-of-py2-tag-in-doctests-of-explain-pickle-fir.patch](tarball://root/attachments/some-uuid/ticket33144/0001-removal-of-py2-tag-in-doctests-of-explain-pickle-fir.patch) by chapoton created at 2022-06-26 07:31:43

Then maybe the simplest way would be if you could please edit the attached patch file : keep only the changes that you find appropriate and make a branch from that modified patch.



---

archive/issue_comments_469393.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-06-26T11:03:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469393",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469394.json:
```json
{
    "body": "Replying to [comment:22 chapoton]:\n> Then maybe the simplest way would be if you could please edit the attached patch file : keep only the changes that you find appropriate and make a branch from that modified patch.\n\nThat is done over your last commit.",
    "created_at": "2022-06-26T11:05:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469394",
    "user": "klee"
}
```

Replying to [comment:22 chapoton]:
> Then maybe the simplest way would be if you could please edit the attached patch file : keep only the changes that you find appropriate and make a branch from that modified patch.

That is done over your last commit.



---

archive/issue_comments_469395.json:
```json
{
    "body": "I am positive now.",
    "created_at": "2022-06-26T11:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469395",
    "user": "klee"
}
```

I am positive now.



---

archive/issue_comments_469396.json:
```json
{
    "body": "thanks, you can set to positive if you wish",
    "created_at": "2022-06-26T17:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469396",
    "user": "chapoton"
}
```

thanks, you can set to positive if you wish



---

archive/issue_comments_469397.json:
```json
{
    "body": "Thanks.",
    "created_at": "2022-06-27T00:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469397",
    "user": "klee"
}
```

Thanks.



---

archive/issue_comments_469398.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2022-06-27T00:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469398",
    "user": "klee"
}
```

Changing priority from major to minor.



---

archive/issue_comments_469399.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-06-27T00:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469399",
    "user": "klee"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_469400.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-07-09T22:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32907",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32907#issuecomment-469400",
    "user": "vbraun"
}
```

Resolution: fixed
