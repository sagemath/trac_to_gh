# Issue 32907: remove py2 tags in explain_pickle

Issue created by migration from https://trac.sagemath.org/ticket/33144

Original creator: chapoton

Original creation time: 2022-01-10 18:06:26

CC:  embray @mjungmath tscrim




---

Comment by chapoton created at 2022-01-10 18:07:28

Changing status from new to needs_info.


---

Comment by chapoton created at 2022-01-10 18:07:28

boring and painful update..

any expert on pickles aboard ?
----
New commits:


---

Comment by chapoton created at 2022-03-20 08:33:01

Changing status from needs_info to needs_review.


---

Comment by chapoton created at 2022-03-20 08:33:01

ok, let's do that in several steps. Please review this first step.


---

Comment by chapoton created at 2022-06-11 07:10:54

please somebody have a look

This is the last file containing `#py2` tags. Here I remove only the simple ones, and the changes should rather be uncontroversial. The remaining cases are out of my capacity, and require an expert of pickle, that we may no longer have anywhere in sight..

One alternative would be #27350 (externalize) or just drop the file completely.


---

Comment by klee created at 2022-06-14 06:38:23

It would be wonderful for Erik Bray to work on #27350 and close this ticket as `invalid/wontfix`. 

If that would not happen, then I think we should fix `explain_pickle` for python3 before we remove the py2 tag, instead of "fixing" doctests for the broken `explain_pickle`.


---

Comment by chapoton created at 2022-06-14 06:57:11

As far as I understand, Erik is no longer available.


---

Comment by tscrim created at 2022-06-14 07:07:48

In principle, I agree with #27350, but I am slightly worried about the practice of it since I find this tool to be very useful at times and would be saddened if it bitrotted. I, unfortunately, would not be able to maintain such a package as I don't understand how `explain_pickle()` works. Since these doctests seem to just be updating the output, I think we should merge these in now. Likewise, I don't think I could help with any of the further marked tests.

Kwankyu, any objections to me setting a positive review?


---

Comment by klee created at 2022-06-14 07:29:55

Replying to [comment:9 tscrim]:
> Since these doctests seem to just be updating the output, 

Some outputs from `explain_pickle` (via `test_pickle`), for instance,

```diff
             sage: from sage.misc.explain_pickle import *
-            sage: test_pickle(dumps(100000r, compress=False))  # py2
-                0: \x80 PROTO      2
-                2: J    BININT     100000
-                7: .    STOP
-            highest protocol among opcodes = 2
-            explain_pickle in_current_sage=True/False:
-            100000
-            result: 100000
+            sage: test_pickle(dumps(100000r, compress=False))
+                    0: \x80 PROTO      2
+                    2: c    GLOBAL     '_codecs encode'
+                   18: q    BINPUT     0
+                   20: X    BINUNICODE '\x80\x02J\xa0\x86\x01\x00.'
+                   36: q    BINPUT     1
+                   38: X    BINUNICODE 'latin1'
+                   49: q    BINPUT     2
+                   51: \x86 TUPLE2
+                   52: q    BINPUT     3
+                   54: R    REDUCE
+                   55: q    BINPUT     4
+                   57: .    STOP
+                highest protocol among opcodes = 2
+                explain_pickle in_current_sage=True:
+                from _codecs import encode
+                encode('\x80\x02J\xa0\x86\x01\x00.', 'latin1')
+                explain_pickle in_current_sage=False:
+                pg_encode = unpickle_global('_codecs', 'encode')
+                pg_encode('\x80\x02J\xa0\x86\x01\x00.', 'latin1')
+                result: b'\x80\x02J\xa0\x86\x01\x00.'
```



seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.

Indentations of outputs are wrong.


---

Comment by tscrim created at 2022-06-14 07:37:06

Replying to [comment:10 klee]:
> Replying to [comment:9 tscrim]:
> > Since these doctests seem to just be updating the output, 

> seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.

The pickle itself has changed. If you run `loads(dumps(100000r))`, it returns the correct object without error. In this case, it is likely because `int` has changed from Python2 to Python3.

> Indentations of outputs are wrong. 

Indeed; although I found the extra indentation level helped make clear what the doctest outputs were since they are so long with their own indentation. I don't hold a strong opinion on changing this or not.


---

Comment by klee created at 2022-06-14 07:43:36

Replying to [comment:11 tscrim]:
> Replying to [comment:10 klee]:
> > Replying to [comment:9 tscrim]:
> > > Since these doctests seem to just be updating the output, 
> 
> > seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.
> 
> The pickle itself has changed. 

I meant the `result`. Shouldn't it be `100000`?


---

Comment by tscrim created at 2022-06-14 08:33:39

Replying to [comment:12 klee]:
> Replying to [comment:11 tscrim]:
> > Replying to [comment:10 klee]:
> > > Replying to [comment:9 tscrim]:
> > > > Since these doctests seem to just be updating the output, 
> > 
> > > seem wrong, which indicates it worked fine with py2 but is now broken with py3. Do we ever correct doctests for wrong output? I think leaving them with py2 tag is right if we do not fix the broken `explain_pickle`.
> > 
> > The pickle itself has changed. 
> 
> I meant the `result`. Shouldn't it be `100000`?

I believe it is the right result but represented or interpreted in the wrong format. Mainly the bytes returned are not converted to a string correctly or something similar.


---

Comment by tscrim created at 2022-06-14 08:35:34

Perhaps we just don't remove the tag in the cases when the result is (at least superficially) different?


---

Comment by klee created at 2022-06-14 08:41:55

Replying to [comment:14 tscrim]:
> Perhaps we just don't remove the tag in the cases when the result is (at least superficially) different?

+1


---

Comment by chapoton created at 2022-06-14 12:15:38

here is a new branch, where I have dropped the changes that did no look right

I may have missed some
----
New commits:


---

Comment by klee created at 2022-06-14 12:20:59

How about indentations? Did you indent more spaces intentionally?


---

Comment by klee created at 2022-06-14 12:24:52

I think outputs should look as they do on the command line, modulo wrappings.


---

Comment by git created at 2022-06-15 08:16:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2022-06-15 08:16:50

now the same as previous one, only with less indentations


---

Comment by klee created at 2022-06-15 08:32:35

Thanks. But some cases with different `result` are still in.


---

Comment by chapoton created at 2022-06-26 07:30:19

patch for removing some #py2 tags


---

Attachment

Then maybe the simplest way would be if you could please edit the attached patch file : keep only the changes that you find appropriate and make a branch from that modified patch.


---

Comment by git created at 2022-06-26 11:03:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-26 11:05:43

Replying to [comment:22 chapoton]:
> Then maybe the simplest way would be if you could please edit the attached patch file : keep only the changes that you find appropriate and make a branch from that modified patch.

That is done over your last commit.


---

Comment by klee created at 2022-06-26 11:09:04

I am positive now.


---

Comment by chapoton created at 2022-06-26 17:00:42

thanks, you can set to positive if you wish


---

Comment by klee created at 2022-06-27 00:09:26

Thanks.


---

Comment by klee created at 2022-06-27 00:09:26

Changing priority from major to minor.


---

Comment by klee created at 2022-06-27 00:09:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-09 22:31:18

Resolution: fixed
