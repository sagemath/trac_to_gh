# Issue 15746: Python 3 preparation: Change names of some function attributes

Issue created by migration from https://trac.sagemath.org/ticket/15983

Original creator: wluebbe

Original creation time: 2014-03-20 15:15:31

CC:  chapoton

Keywords: python3

Only the modern syntax like `f.__doc__` is accepted by Python 3.  


Changes according to `lib2to3/fixes/fix_funcattrs.py`:

```
f.func_x -> f.__x__
for 
('func_closure' | 'func_doc' | 'func_globals' | 'func_name' | 
'func_defaults' | 'func_code' | 'func_dict')
```


This ticket is tracked as a dependency of meta-ticket ticket:15980.



---

Comment by wluebbe created at 2014-03-20 21:09:19

New commits:


---

Comment by wluebbe created at 2014-03-20 21:09:58

Changing status from new to needs_review.


---

Comment by chapoton created at 2014-03-20 21:17:50

maybe you also have to correct the names inside the 'hasattr' ?


---

Comment by wluebbe created at 2014-03-20 21:29:44

Yes, seems suspicious. I will look into it.


---

Comment by wluebbe created at 2014-03-20 21:29:44

Changing status from needs_review to needs_work.


---

Comment by wluebbe created at 2014-03-21 16:05:12

From the Python docs (http://docs.python.org/2/reference/datamodel.html):

//Changed in version 2.6: The double-underscore attributes !__closure!__, !__code!__, !__defaults!__, and !__globals!__ were introduced as aliases for the corresponding func_* attributes for forwards compatibility with Python 3.//

!__dict!__, !__doc!__ and !__name!__ were already available earlier.

Looking at the code with `hasattr` it should probably be manually refactored, keeping in mind that the `__XX__` are always available as alias for the `func_XX`.

Would you agree?


---

Comment by git created at 2014-03-22 09:25:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by wluebbe created at 2014-03-22 09:31:51

The modules with hasattr() might still benefit from some refactoring, as the code could now be a bit simplified.

But I leave this for later ...


---

Comment by wluebbe created at 2014-03-22 09:31:51

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2014-03-22 12:35:19

looks good, I have checked that every instance was found and corrected. But one needs to make sure that nothing is broken and that all tests pass..


---

Comment by wluebbe created at 2014-03-27 12:47:57

doctests fail in
* src/sage/sets/set_from_iterator.py (line 438)
* src/sage/misc/cachefunc.pyx (line 315 and 318)


---

Comment by wluebbe created at 2014-03-27 12:47:57

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2014-04-03 21:49:41

Actually this looks like a bug fix -- the previous version wouldn't work on Python functions/methods defined in Cython code (well they really just duck-type Python functions), since Cython doesn't include the `func_*` aliases.

The doctests just need updating to reflect the bug fix.


---

Comment by ohanar created at 2014-04-04 01:39:38

Actually, nevermind. This is supposed to be stripped, but there are now two instances of this line information, and only one is getting stripped. I should have a patch soon to fix it.

It seems that the 'func_doc' was being used to separate cython functions from python functions.


---

Comment by ohanar created at 2014-04-04 01:51:21

Ok, I believe this should be a fix for the issue, for now.
----
New commits:


---

Comment by ohanar created at 2014-04-04 01:51:21

Changing status from needs_work to needs_review.


---

Comment by wluebbe created at 2014-04-04 08:44:06

Changing status from needs_review to positive_review.


---

Comment by wluebbe created at 2014-04-04 08:44:06

I did a rebase on develop to test with a fresh 6.2.beta6.

```
MAKE='make -j4' make
./sage -tp 4 --all --long >logs/sage-ptestlong-develop
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 2379.2 seconds
#####
git fetch trac u/ohanar/remove_func_star:u/ohanar/remove_func_star
git co u/ohanar/remove_func_star
git co -b u/wluebbe/ticket/15983
git rebase develop
#####
./sage -b
./sage -tp 4 --all --long >logs/sage-ptestlong-15983
All tests passed!
```


My questions (as still being pretty new to Sage): 
* Is it OK to build and test as above?
* When is it necessary to do `make clean; make lib-clean; make` instead of `./sage -b`?
----
New commits:


---

Comment by vbraun created at 2014-04-04 11:45:29

author/reviewer names please


---

Comment by ohanar created at 2014-04-04 13:44:31

Replying to [comment:14 wluebbe]:
> I did a rebase on develop to test with a fresh 6.2.beta6.

In general, you should probably merge in the latest beta rather than rebase (this is a change from how sage use to do things to match standard git practices). That said, extra merges are unnecessary, so you should try to avoid making merges unless there is a merge conflict or an issue is only popping up on a more recent version of sage.

> My questions (as still being pretty new to Sage): 
> * Is it OK to build and test as above?

Yes, although part of a review is to look at the changes in the code and make sure you agree with them.

> * When is it necessary to do `make clean; make lib-clean; make` instead of `./sage -b`?

Use `make` if there have been upgraded packages in the distribution (so between most betas/releases), you can use `./sage -b` if the only changes between the last time you built have been to the sage library (useful if you are working on a feature branch that only touches the sage library).


---

Comment by wluebbe created at 2014-04-04 13:53:03

Thanks for the explanation!

Next time I will try a merge when there is a merge conflict.


---

Comment by vbraun created at 2014-04-04 15:55:37

Resolution: fixed
