# Issue 18135: residue() produces wrong output

archive/issues_018135.json:
```json
{
    "body": "Keywords: residue\n\nFor functions where the pole is not recognized immediately when substituting the argument, residue yields output `0`.\n\nFor example:\n\n\n```\nsage: f(x) = 1/(1 - x - x^2)\nsage: solve(1 - x - x^2 == 0, x)\n[x == -1/2*sqrt(5) - 1/2, x == 1/2*sqrt(5) - 1/2]\nsage: f(1/2*sqrt(5) - 1/2)\n-4/((sqrt(5) - 1)^2 + 2*sqrt(5) - 6)  # pole is not recognized!\nsage: f(1/2*sqrt(5) - 1/2).expand()\nTraceback (most recent call last):  # here it is recognized.\n...\nValueError: power::eval(): division by zero\nsage: f(x).residue(x==1/2*sqrt(5) - 1/2)\n0\n```\n\n\nThis is wrong, as we would expect\n\n```\nsage: f(x).residue(x==1/2*sqrt(5) - 1/2)\n-1/5*sqrt(5)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18372\n\n",
    "created_at": "2015-05-06T09:32:27Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "residue() produces wrong output",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18135",
    "user": "@behackl"
}
```
Keywords: residue

For functions where the pole is not recognized immediately when substituting the argument, residue yields output `0`.

For example:


```
sage: f(x) = 1/(1 - x - x^2)
sage: solve(1 - x - x^2 == 0, x)
[x == -1/2*sqrt(5) - 1/2, x == 1/2*sqrt(5) - 1/2]
sage: f(1/2*sqrt(5) - 1/2)
-4/((sqrt(5) - 1)^2 + 2*sqrt(5) - 6)  # pole is not recognized!
sage: f(1/2*sqrt(5) - 1/2).expand()
Traceback (most recent call last):  # here it is recognized.
...
ValueError: power::eval(): division by zero
sage: f(x).residue(x==1/2*sqrt(5) - 1/2)
0
```


This is wrong, as we would expect

```
sage: f(x).residue(x==1/2*sqrt(5) - 1/2)
-1/5*sqrt(5)
```


Issue created by migration from https://trac.sagemath.org/ticket/18372





---

archive/issue_comments_244528.json:
```json
{
    "body": "In principle, this **could** be fixed by changing\n\n\n```diff\ndiff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx\nindex aede6a0..462c311 100644\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -3678,7 +3678,8 @@ cdef class Expression(CommutativeRingElement):\n             a = 0\n         if a == infinity:\n             return (-self.subs({x: 1/x}) / x**2).residue(x == 0)\n-        return self.subs({x: x+a}).series(x == 0, 0).coefficient(x, -1)\n+        return self.subs({x: x+a}).expand()\\\n+            .series(x == 0, 0).coefficient(x, -1)\n \n     def taylor(self, *args):\n         r\"\"\"\n```\n\n\nin the `residue`-method -- however, I feel that is somehow dirty.\n\nMaybe someone with more experience in Sage's symbolic engine has a opinion with respect to this issue?",
    "created_at": "2015-05-06T09:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244528",
    "user": "@behackl"
}
```

In principle, this **could** be fixed by changing


```diff
diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
index aede6a0..462c311 100644
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -3678,7 +3678,8 @@ cdef class Expression(CommutativeRingElement):
             a = 0
         if a == infinity:
             return (-self.subs({x: 1/x}) / x**2).residue(x == 0)
-        return self.subs({x: x+a}).series(x == 0, 0).coefficient(x, -1)
+        return self.subs({x: x+a}).expand()\
+            .series(x == 0, 0).coefficient(x, -1)
 
     def taylor(self, *args):
         r"""
```


in the `residue`-method -- however, I feel that is somehow dirty.

Maybe someone with more experience in Sage's symbolic engine has a opinion with respect to this issue?



---

archive/issue_comments_244529.json:
```json
{
    "body": "This is another possible fix (which seems a bit less dirty to me):\n\n\n```diff\ndiff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx\nindex aede6a0..bbbd21b 100644\n--- a/src/sage/symbolic/expression.pyx\n+++ b/src/sage/symbolic/expression.pyx\n@@ -3622,7 +3622,7 @@ cdef class Expression(CommutativeRingElement):\n             prec = order\n         sig_on()\n         try:\n-            x = self._gobj.series(symbol0._gobj, prec, 0)\n+            x = self._gobj.expand(0).series(symbol0._gobj, prec, 0)\n         finally:\n             sig_off()\n         return new_Expression_from_GEx(self._parent, x)\n```\n",
    "created_at": "2015-05-09T14:24:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244529",
    "user": "@behackl"
}
```

This is another possible fix (which seems a bit less dirty to me):


```diff
diff --git a/src/sage/symbolic/expression.pyx b/src/sage/symbolic/expression.pyx
index aede6a0..bbbd21b 100644
--- a/src/sage/symbolic/expression.pyx
+++ b/src/sage/symbolic/expression.pyx
@@ -3622,7 +3622,7 @@ cdef class Expression(CommutativeRingElement):
             prec = order
         sig_on()
         try:
-            x = self._gobj.series(symbol0._gobj, prec, 0)
+            x = self._gobj.expand(0).series(symbol0._gobj, prec, 0)
         finally:
             sig_off()
         return new_Expression_from_GEx(self._parent, x)
```




---

archive/issue_comments_244530.json:
```json
{
    "body": "Yes, I think the last one is better. Not because it's less intrusive but the contrary. Expansion before series computation should make the series faster in general, if I'm not mistaken.",
    "created_at": "2015-05-10T06:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244530",
    "user": "@rwst"
}
```

Yes, I think the last one is better. Not because it's less intrusive but the contrary. Expansion before series computation should make the series faster in general, if I'm not mistaken.



---

archive/issue_comments_244531.json:
```json
{
    "body": "I did some testing, and it seems that expanding before computing the series expansion actually is indeed marginally faster, for example:\n\n\n```\nsage: timeit(\"(1/(x^2 - x - 1)).series(x==1/2*sqrt(5)+1/2, 30)\", number=300, repeat=5)\n300 loops, best of 5: 18.4 ms per loop  # without patch\n\nsage: timeit(\"(1/(x^2 - x - 1)).series(x==1/2*sqrt(5)+1/2, 30)\", number=300, repeat=5)\n300 loops, best of 5: 16.5 ms per loop  # with the patch\n```\n\n\nFrom this point of view, I think the fix would be OK -- after all, a class of `residue`-problems is fixed nevertheless. I'll push a branch to the ticket and run some doctests.",
    "created_at": "2015-05-10T14:31:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244531",
    "user": "@behackl"
}
```

I did some testing, and it seems that expanding before computing the series expansion actually is indeed marginally faster, for example:


```
sage: timeit("(1/(x^2 - x - 1)).series(x==1/2*sqrt(5)+1/2, 30)", number=300, repeat=5)
300 loops, best of 5: 18.4 ms per loop  # without patch

sage: timeit("(1/(x^2 - x - 1)).series(x==1/2*sqrt(5)+1/2, 30)", number=300, repeat=5)
300 loops, best of 5: 16.5 ms per loop  # with the patch
```


From this point of view, I think the fix would be OK -- after all, a class of `residue`-problems is fixed nevertheless. I'll push a branch to the ticket and run some doctests.



---

archive/issue_comments_244532.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-05-10T17:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244532",
    "user": "@behackl"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_244533.json:
```json
{
    "body": "Looks fine and passes all tests. Please add your name in the authors field.",
    "created_at": "2015-05-11T13:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244533",
    "user": "@rwst"
}
```

Looks fine and passes all tests. Please add your name in the authors field.



---

archive/issue_comments_244534.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-11T13:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244534",
    "user": "@rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_244535.json:
```json
{
    "body": "Thanks for the review!",
    "created_at": "2015-05-11T14:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244535",
    "user": "@behackl"
}
```

Thanks for the review!



---

archive/issue_comments_244536.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-12T22:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18135",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18135#issuecomment-244536",
    "user": "@vbraun"
}
```

Resolution: fixed
