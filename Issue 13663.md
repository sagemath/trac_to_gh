# Issue 13663: Fix Pynac spkg so that it builds on top of a debug build of python

Issue created by migration from https://trac.sagemath.org/ticket/13867

Original creator: jpflori

Original creation time: 2012-12-27 14:59:23

Assignee: tbd

CC:  burcin vbraun simonking

Keywords: pynac spkg debug

The problem is that the test used by the AX_PYTHON_DEVEL autoconf macro to check for distutils fails when Python is built with pydebug.


---

Comment by vbraun created at 2012-12-27 16:26:18

I'm thinking we should just patch Python to not print out extra crap. Otherwise we have basically no hope of running the Sage doctests, no?


---

Comment by jpflori created at 2012-12-27 16:27:54

Good point.
And that should be even easier.


---

Comment by jpflori created at 2012-12-27 16:56:23

In fact I do not really agree, especially now that I've checked that the crappy additional Python output does not pertub the doctest framework (surely because its spit on stderr and not stdout).


---

Comment by vbraun created at 2012-12-27 17:30:51

Surely the sage pexpect interface to itself will not work. Or various checks in `sage.tests.cmdline` that check that stderr is empty.


---

Comment by vbraun created at 2012-12-28 11:20:26

Changing status from new to needs_review.


---

Comment by vbraun created at 2012-12-28 11:20:26

I'm taking over this ticket to patch up python


---

Comment by vbraun created at 2012-12-28 11:20:26

Changing keywords from "pynac spkg debug" to "python spkg debug".


---

Comment by SimonKing created at 2012-12-28 11:32:42

Just to be on the safe side: To use this one with SAGE_DEBUG=yes on top of an existing Sage install, one needs to install this new python spkg, then (re-)install the new cython spkg from #13832, and then sage -ba, right?


---

Comment by vbraun created at 2012-12-28 11:51:20

to get a working Sage you also need a patch to the Sage library (will post here soon) and a fixed Singular spkg... stay tuned ;-)


---

Comment by vbraun created at 2012-12-28 11:55:27

Patch to the Sage library is at #13868


---

Comment by SimonKing created at 2012-12-28 12:47:58

We now have an abundance of tickets needed to make SAGE_DEBUG work. Shouldn't there be a meta-ticket, listing all relevant single-purpose tickets (#13876, #13867, #13868, #13832, #13864, and what else)?


---

Comment by vbraun created at 2012-12-28 13:03:01

#13864 is now the meta-ticket.


---

Comment by SimonKing created at 2012-12-28 13:06:03

Replying to [comment:10 SimonKing]:
> We now have an abundance of tickets needed to make SAGE_DEBUG work. Shouldn't there be a meta-ticket, listing all relevant single-purpose tickets (#13876, #13867, #13868, #13832, #13864, and what else)?

FWIW: I created a metaticket at #13877.


---

Comment by SimonKing created at 2012-12-28 13:48:08

Replying to [comment:12 SimonKing]:
> Replying to [comment:10 SimonKing]:
> > We now have an abundance of tickets needed to make SAGE_DEBUG work. Shouldn't there be a meta-ticket, listing all relevant single-purpose tickets (#13876, #13867, #13868, #13832, #13864, and what else)?
> 
> FWIW: I created a metaticket at #13877.

OK, forget about that, Volker was faster with his change to #13864.


---

Comment by jdemeyer created at 2012-12-30 08:43:47

In `spkg-install`, are you sure you don't mean `CFLAGS` and/or `CXXFLAGS` instead `CPPFLAGS`? Because `CPPFLAGS` normally means "C preprocessor flags".


---

Comment by vbraun created at 2012-12-30 10:28:09

The `spkg-install` already used `CPPFLAGS` before I edited it, so I stuck with it. It does get picked up on the gcc command line, fwiw.


---

Comment by jdemeyer created at 2012-12-30 10:52:02

Yes, it does use `CPPFLAGS` for its _intended purpose_. The `-I` option is related to preprocessing and belongs in `$CPPFLAGS`.  Flags like `-g` or `-O0` do not.

Note that adding `-I$SAGE_LOCAL/include` to `CPPFLAGS` is actually unneeded since that path gets picked up automatically because of the `$CPATH` environment variable. So you might as well remove

```
CPPFLAGS="-I$SAGE_LOCAL/include $CPPFLAGS"
export CPPFLAGS
```



---

Comment by jdemeyer created at 2012-12-30 10:52:02

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-12-30 10:52:56

Replying to [comment:17 vbraun]:
> The `spkg-install` already used `CPPFLAGS` before I edited it
It also uses `CFLAGS` by the way:

```
export CFLAGS="$CFLAGS `testcflags.sh -fwrapv`"
```



---

Comment by jpflori created at 2012-12-31 09:53:14

I'm ok with the solution Volker proposes, we don't need that "extra" output, but I still think that Pynac should be able to deal with a vanilla Python debug build.
So I'm just posting that here so that Burcin can take notice (I'll post on pynac-devel as well).


---

Attachment

diff for review only


---

Comment by vbraun created at 2012-12-31 10:55:23

I've removed the superfluous CPPFLAGS. Also `--with-pydebug` implies `-O0 -g` so we don't have to set it by hand.


---

Comment by vbraun created at 2012-12-31 10:55:34

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2013-01-21 11:16:40

I use the package successfully with SAGE_DEBUG=yes.

Some criticism: SPKG.txt contains a section "Patches", but the new patch disable_print_refs_debug.patch is not mentioned.

The content of environment variables is sometimes tested like

```
if ["x$SAGE_DEBUG"="xyes"]; then
```

if I am not mistaken, but here it is

```
if ["$SAGE_DEBUG"="yes"]; then
```

Is that a problem?


---

Comment by vbraun created at 2013-01-21 11:58:19

I've added a line documenting the disable_print_refs_debug.patch

The `xyes` thing is a historical artifact.


---

Comment by jpflori created at 2013-01-29 14:09:17

Changing status from needs_review to positive_review.


---

Comment by jpflori created at 2013-01-29 14:09:17

Looks good.

If you really wants me to rant, I'd say:
* first, there is a useless line at the end of the new patch for some emacs generated tmp file.
* or even less problematic, you could remove the historical artifacts from spkg-install while you're at it.


---

Comment by jdemeyer created at 2013-01-30 07:41:54

Server down :-(


---

Comment by jdemeyer created at 2013-02-09 12:14:27

Resolution: fixed
