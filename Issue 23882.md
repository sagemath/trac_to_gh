# Issue 23882: Create an assuming() context manager

Issue created by migration from Trac.

Original creator: charpent

Original creation time: 2017-10-28 08:37:38

CC:  rws

Inspiration : Ralf Stephan in #22322. Thanks to him for nudging me in the right direction.

Goal : create a tool allowing to create reusable, stackable, assumption elements, thus allowing to get the functionality of Mathematica's `Assuming[...,???]`

What I mean :

```
sage: solve(x^2==4, x)
[x == -2, x == 2]
sage: with assuming(x>0): solve(x^2==4, x)
[x == 2]
sage: assumptions()
[]
```




---

Comment by charpent created at 2017-10-28 17:33:03

Changing status from new to needs_review.


---

Comment by charpent created at 2017-10-28 17:33:03

Initial proposition.

On 8.1beta9 + #24026+ #24006 + #23990 + #23923 + #24088 + #10035, passes `ptestlong` with no error whatsoever (1 timeout once on `sage -t --long src/sage/modular/hecke/submodule.py`, unreproductible).

==>`needs_review`


---

Comment by charpent created at 2017-10-28 19:02:54

Aaarghh... I've found a subtle bug: after `with assuming(): do_something()`, the original assumption database is destroyed.

That's due to the fact that `forget()` is equivalent to `forget(assumptions())`, i. e. forgets //all// facts in the database. Hoisted by a "lazy" facility...

I'll fix that (and add a couple doctests for exceptions.

Should we reconsider `forget() <==> forget(assumptions())` ?


---

Comment by charpent created at 2017-10-28 19:02:54

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-28 21:33:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-10-28 21:36:05

Replying to [comment:4 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[c50defe](https://git.sagemath.org/sage.git/commit/?id=c50defe06a74c6ead95ed63bb319eb549aed1d15)||`24119 : Debugging, better doctests, a couple of typos`||

Passes ptestlong with no errors whatsoever, an one non-reproducible timeout on `sage -t --long src/sage/symbolic/expression.pyx`.

==>`needs_review` again.


---

Comment by charpent created at 2017-10-28 21:36:05

Changing status from needs_work to needs_review.


---

Comment by charpent created at 2017-10-28 21:43:54

Replying to [comment:3 charpent]:
> Aaarghh... I've found a subtle bug: after `with assuming(): do_something()`, the original assumption database is destroyed.

[ Snip ... ]

To be absolutely clear : the problem existed when one used `assuming` with an //empty// argument list : you wouldn't do that from the console, but this argument list might result from another computation, which might return an empty list.

Anyway, problem fixed.


---

Comment by rws created at 2017-10-29 15:02:46

Could you please add direct doctests to the member functions?


---

Comment by rws created at 2017-10-29 15:06:33

Also add a doctest with the class that checks correctness with at least doubly stacked assumptions.


---

Comment by charpent created at 2017-10-29 15:07:22

Replying to [comment:7 rws]:
> Could you please add direct doctests to the member functions?

What do you mean ? I added exactly ONE function (`assuming()`), which I documented and doctested, and added a small blurb at the end of the module documentation. Since `assuming()` is designed to interact exclusively with `assume()`, I don't see what you mean.


---

Comment by charpent created at 2017-10-29 15:10:14

Replying to [comment:8 rws]:
> Also add a doctest with the class that checks correctness with at least doubly stacked assumptions.

This I understand and will do. Stay tuned...


---

Comment by rws created at 2017-10-29 15:11:30

The class `assuming` has three member functions, no? Check `class hold_class` in #10035 where `__enter__` and `__exit__` is doctested.


---

Comment by git created at 2017-10-29 15:28:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-29 16:15:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-10-29 16:21:50

Replying to [comment:13 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[127d507](https://git.sagemath.org/sage.git/commit/?id=127d507348ca429602585bf0734e2741d889b135)||`24119 : doctesting individual assuming's member functions.`||

Builds and doctests OK. `make ptestlong` underway (don't hold your breath...).


---

Comment by rws created at 2017-10-29 16:59:07

I like it. Here some minor typos: double space after `declaration`; `:func:assume())` should have backticks; typo in `useable in a in a ``with`` statement`; small caps begin new sentence in `...can be stacked. we can use this functionality can be used to...` also use is used twice; please correct `(and by yhe way,`; finally please add an empty line before `def __enter__` and before `def __exit__`.


---

Comment by charpent created at 2017-10-29 17:11:07

Passes `ptestlong` with no error whatsoever.

I'll fix the typos and re-upload, but won't re-`ptestlong` before late tonight (I *have* to go now...).


---

Comment by git created at 2017-10-29 17:22:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by charpent created at 2017-10-29 17:25:07

Replying to [comment:17 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[017f67c](https://git.sagemath.org/sage.git/commit/?id=017f67c66da8aadfaefebb976528abacef6b58ad)||`24119 : small typos fixed.`||

Typos fixed, except a double space after `declaration`, which I didn't find. Builds and doctests OK. `ptestlong` later tonight. Leaving //NOW//.


---

Comment by charpent created at 2017-10-29 20:29:30

Replying to [comment:18 charpent]:
> Replying to [comment:17 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[017f67c](https://git.sagemath.org/sage.git/commit/?id=017f67c66da8aadfaefebb976528abacef6b58ad)||`24119 : small typos fixed.`||
> 
> Typos fixed, except a double space after `declaration`, which I didn't find. Builds and doctests OK. `ptestlong` later tonight. Leaving //NOW//.

[ Later... ] 
* Passes `ptestlong` with no error whatsoever.
* Most of the 17 patchbots seem to like it, but all but one of them complain that "a plugin failed" ; it seems that this is the "coverage" plugin. Not my watch, I'm afraid...
* Four patchbots got a failure or a timeout :
    - timeout in `src/sage/interfaces/giac.py` : doesn't seem related to my ticket ;
    - one failure on `src/sage/doctest/external.py` : ditto ;
    - timeout in `src/sage/graphs/graph_generators.py` : ditto ;
    - one failure in `src/sage/schemes/elliptic_curves/heegner.py` and one timeout in `src/sage/coding/linear_code.py` : ditto.


These failures seems "too random" to have a systematic cause, and may result from a race condition somewhere in the test infrastructure. We have been plagued with such "transient" failures for some time now.

Seems good to review...


---

Comment by rws created at 2017-10-31 14:19:09

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-10-31 14:19:09

Replying to [comment:19 charpent]:
> * Most of the 17 patchbots seem to like it, but all but one of them complain that "a plugin failed" ; it seems that this is the "coverage" plugin. Not my watch, I'm afraid...

The coverage plugin (of patchbot) looks if you added code without doctest. It uses the call `sage --coverage` which you can do too. You fixed it however when I asked you so the recent patchbot runs no longer show it. It's all fine now.


---

Comment by vbraun created at 2017-11-02 11:05:52

Resolution: fixed
