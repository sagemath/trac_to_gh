# Issue 33050: make iter(ZZ^n) useful

archive/issues_033050.json:
```json
{
    "body": "CC:  @tscrim\n\nAt the moment, iterating over `ZZ^n` only ever produces vectors in `\u2124 \u00d7 {0}^(n-1)`:\n\n\n```\nsage: for i,v in enumerate(ZZ^5):\n....:     print(v)\n....:     if i > 10: break\n....:\n(0, 0, 0, 0, 0)\n(1, 0, 0, 0, 0)\n(-1, 0, 0, 0, 0)\n(2, 0, 0, 0, 0)\n(-2, 0, 0, 0, 0)\n(3, 0, 0, 0, 0)\n(-3, 0, 0, 0, 0)\n(4, 0, 0, 0, 0)\n(-4, 0, 0, 0, 0)\n(5, 0, 0, 0, 0)\n(-5, 0, 0, 0, 0)\n(6, 0, 0, 0, 0)\n```\n\n\nThis patch makes Sage iterate over `ZZ^n` in a more natural order: Sorted primarily by `1`\u2011norm, secondarily by `\u221e`\u2011norm.\n\nThere are two motivations to prefer this behavior in particular:\n1. It is mathematically more correct \u2014 `iter(ZZ^n)` now actually enumerates all of `\u2124^n` rather than just a subset.\n2. It can be useful in some situations (such as in cryptography) when searching for a small error vector of some sort.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33287\n\n",
    "created_at": "2022-02-04T18:02:21Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "make iter(ZZ^n) useful",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/33050",
    "user": "@yyyyx4"
}
```
CC:  @tscrim

At the moment, iterating over `ZZ^n` only ever produces vectors in `ℤ × {0}^(n-1)`:


```
sage: for i,v in enumerate(ZZ^5):
....:     print(v)
....:     if i > 10: break
....:
(0, 0, 0, 0, 0)
(1, 0, 0, 0, 0)
(-1, 0, 0, 0, 0)
(2, 0, 0, 0, 0)
(-2, 0, 0, 0, 0)
(3, 0, 0, 0, 0)
(-3, 0, 0, 0, 0)
(4, 0, 0, 0, 0)
(-4, 0, 0, 0, 0)
(5, 0, 0, 0, 0)
(-5, 0, 0, 0, 0)
(6, 0, 0, 0, 0)
```


This patch makes Sage iterate over `ZZ^n` in a more natural order: Sorted primarily by `1`‑norm, secondarily by `∞`‑norm.

There are two motivations to prefer this behavior in particular:
1. It is mathematically more correct — `iter(ZZ^n)` now actually enumerates all of `ℤ^n` rather than just a subset.
2. It can be useful in some situations (such as in cryptography) when searching for a small error vector of some sort.

Issue created by migration from https://trac.sagemath.org/ticket/33287





---

archive/issue_comments_471209.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-02-04T18:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471209",
    "user": "@yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_471210.json:
```json
{
    "body": "I think this should be fixed on the level of categories:\n\n```\nsage: ZZ^2 in EnumeratedSets()\nFalse\n```\n",
    "created_at": "2022-02-04T23:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471210",
    "user": "@mkoeppe"
}
```

I think this should be fixed on the level of categories:

```
sage: ZZ^2 in EnumeratedSets()
False
```




---

archive/issue_comments_471211.json:
```json
{
    "body": "`CartesianProduct` has the same defect, but at least emits a warning:\n\n```\nsage: i = iter(ZZ.cartesian_product(ZZ))\nsage: next(i)\n/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/sets_cat.py:2249: UserWarning: Sage is not able to determine whether the factors of this Cartesian product are finite. The lexicographic ordering might not go through all elements.\n  warn(\"Sage is not able to determine whether the factors of \"\n(0, 0)\nsage: \nsage: next(i)\n(0, 1)\nsage: next(i)\n(0, -1)\nsage: next(i)\n(0, 2)\nsage: next(i)\n(0, -2)\nsage: next(i)\n(0, 3)\nsage: next(i)\n(0, -3)\nsage: next(i)\n(0, 4)\nsage: next(i)\n(0, -4)\nsage: next(i)\n(0, 5)\n```\n",
    "created_at": "2022-02-04T23:09:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471211",
    "user": "@mkoeppe"
}
```

`CartesianProduct` has the same defect, but at least emits a warning:

```
sage: i = iter(ZZ.cartesian_product(ZZ))
sage: next(i)
/Users/mkoeppe/s/sage/sage-rebasing/worktree-gcc11/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/categories/sets_cat.py:2249: UserWarning: Sage is not able to determine whether the factors of this Cartesian product are finite. The lexicographic ordering might not go through all elements.
  warn("Sage is not able to determine whether the factors of "
(0, 0)
sage: 
sage: next(i)
(0, 1)
sage: next(i)
(0, -1)
sage: next(i)
(0, 2)
sage: next(i)
(0, -2)
sage: next(i)
(0, 3)
sage: next(i)
(0, -3)
sage: next(i)
(0, 4)
sage: next(i)
(0, -4)
sage: next(i)
(0, 5)
```




---

archive/issue_comments_471212.json:
```json
{
    "body": "Changing component from misc to categories.",
    "created_at": "2022-02-05T00:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471212",
    "user": "@mkoeppe"
}
```

Changing component from misc to categories.



---

archive/issue_comments_471213.json:
```json
{
    "body": "I agree that it would be good to have such an implementation at the category level. Although we did have a reason for not doing something like this IIRC. I forget if it was backward compatibility, breaking doctests, slowdowns, or something else.\n\nFor this ticket, can you also add a doctest that shows it works over other enumerated rings, such as `GF(2)[\u2018t\u2019]`? It should work for any infinite enumerated ring.",
    "created_at": "2022-02-05T01:15:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471213",
    "user": "@tscrim"
}
```

I agree that it would be good to have such an implementation at the category level. Although we did have a reason for not doing something like this IIRC. I forget if it was backward compatibility, breaking doctests, slowdowns, or something else.

For this ticket, can you also add a doctest that shows it works over other enumerated rings, such as `GF(2)[‘t’]`? It should work for any infinite enumerated ring.



---

archive/issue_comments_471214.json:
```json
{
    "body": "Replying to [comment:5 tscrim]:\n> For this ticket, can you also add a doctest that shows it works over other enumerated rings, such as `GF(2)[\u2018t\u2019]`? It should work for any infinite enumerated ring.\n\nWell... It doesn't:\n\n```\nsage: GF(2)['t'] in InfiniteEnumeratedSets()\nFalse\n```\n\nIndeed, `iter(GF(2)['t'])` throws a `NotImplementedError`.\n\nIt looks like `ZZ` is the only ring that's registered as an `InfiniteEnumeratedSet`.",
    "created_at": "2022-02-14T07:04:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471214",
    "user": "@yyyyx4"
}
```

Replying to [comment:5 tscrim]:
> For this ticket, can you also add a doctest that shows it works over other enumerated rings, such as `GF(2)[‘t’]`? It should work for any infinite enumerated ring.

Well... It doesn't:

```
sage: GF(2)['t'] in InfiniteEnumeratedSets()
False
```

Indeed, `iter(GF(2)['t'])` throws a `NotImplementedError`.

It looks like `ZZ` is the only ring that's registered as an `InfiniteEnumeratedSet`.



---

archive/issue_comments_471215.json:
```json
{
    "body": "You get the same category result for changing the base ring to `ZZ`:\n\n```\nsage: ZZ['t'] in InfiniteEnumeratedSets()\nFalse\n```\n\nwhich IMO is a bug. (You also get a `NotImplementedError` for `iter(ZZ['t'])`.)\n\nHowever, there should still be other infinite enumerated rings that are not so nice.\n\nInterestingly\n\n```\nsage: QQ in InfiniteEnumeratedSets()\nFalse\n```\n\nbut it iterates just fine. IMO also a bug. I also cannot iterate the braid groups, which I should be able to since they are finitely generated as a monoid. Group algebras over enumerated monoids should also work for this, but they don't as they fail through a strange (IMO) code path:\n\n```\nsage: G = groups.misc.CoxeterGroup(['A',2,1])\nsage: G in InfiniteEnumeratedSets()\nTrue\nsage: A = G.algebra(GF(2))\nsage: A in InfiniteEnumeratedSets()\nFalse\nsage: next(iter(A))\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-49-8fa11f66d58c> in <module>\n----> 1 next(iter(A))\n\n~/sage-build/local/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__getitem__ (build/cythonized/sage/structure/parent.c:11472)()\n   1274             except AttributeError:\n   1275                 return self.list()[n]\n-> 1276         return meth(n)\n   1277 \n   1278     #########################################################################\n\n~/sage-build/local/lib/python3.9/site-packages/sage/categories/rings.py in __getitem__(self, arg)\n   1175 \n   1176             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n-> 1177             return PolynomialRing(self, elts)\n   1178 \n   1179         def free_module(self, base=None, basis=None, map=True):\n\n~/sage-build/local/lib/python3.9/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py in PolynomialRing(base_ring, *args, **kwds)\n    630             raise TypeError(\"you must specify the names of the variables\")\n    631 \n--> 632     names = normalize_names(n, names)\n    633 \n    634     # At this point, we have only handled the \"names\" keyword if it was\n\n~/sage-build/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8565)()\n    898         return dir_with_other_class(self, self.category().parent_class)\n    899 \n--> 900 cpdef normalize_names(Py_ssize_t ngens, names):\n    901     r\"\"\"\n    902     Return a tuple of strings of variable names of length ngens given\n\n~/sage-build/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8407)()\n   1012                 names = sage.misc.defaults.variable_names(ngens, names)\n   1013 \n-> 1014     certify_names(names)\n   1015     if ngens >= 0 and len(names) != ngens:\n   1016        raise IndexError(\"the number of names must equal the number of generators\")\n\n~/sage-build/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.certify_names (build/cythonized/sage/structure/category_object.c:8923)()\n   1064             raise ValueError(\"variable name {!r} is not alphanumeric\".format(N))\n   1065         if not N[0].isalpha():\n-> 1066             raise ValueError(\"variable name {!r} does not start with a letter\".format(N))\n   1067         if N in s:\n   1068             raise ValueError(\"variable name {!r} appears more than once\".format(N))\n\nValueError: variable name '0' does not start with a letter\n```\n\n\nNothing in this code seems to be specific to `ZZ`, just Sage doesn't have put enough objects into the correct category (with the corresponding implementations) to support it.\n\nPerhaps for now we can just change the documentation to say this works for any infinite enumerated (commutative) ring?",
    "created_at": "2022-02-14T07:44:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471215",
    "user": "@tscrim"
}
```

You get the same category result for changing the base ring to `ZZ`:

```
sage: ZZ['t'] in InfiniteEnumeratedSets()
False
```

which IMO is a bug. (You also get a `NotImplementedError` for `iter(ZZ['t'])`.)

However, there should still be other infinite enumerated rings that are not so nice.

Interestingly

```
sage: QQ in InfiniteEnumeratedSets()
False
```

but it iterates just fine. IMO also a bug. I also cannot iterate the braid groups, which I should be able to since they are finitely generated as a monoid. Group algebras over enumerated monoids should also work for this, but they don't as they fail through a strange (IMO) code path:

```
sage: G = groups.misc.CoxeterGroup(['A',2,1])
sage: G in InfiniteEnumeratedSets()
True
sage: A = G.algebra(GF(2))
sage: A in InfiniteEnumeratedSets()
False
sage: next(iter(A))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-49-8fa11f66d58c> in <module>
----> 1 next(iter(A))

~/sage-build/local/lib/python3.9/site-packages/sage/structure/parent.pyx in sage.structure.parent.Parent.__getitem__ (build/cythonized/sage/structure/parent.c:11472)()
   1274             except AttributeError:
   1275                 return self.list()[n]
-> 1276         return meth(n)
   1277 
   1278     #########################################################################

~/sage-build/local/lib/python3.9/site-packages/sage/categories/rings.py in __getitem__(self, arg)
   1175 
   1176             from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
-> 1177             return PolynomialRing(self, elts)
   1178 
   1179         def free_module(self, base=None, basis=None, map=True):

~/sage-build/local/lib/python3.9/site-packages/sage/rings/polynomial/polynomial_ring_constructor.py in PolynomialRing(base_ring, *args, **kwds)
    630             raise TypeError("you must specify the names of the variables")
    631 
--> 632     names = normalize_names(n, names)
    633 
    634     # At this point, we have only handled the "names" keyword if it was

~/sage-build/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8565)()
    898         return dir_with_other_class(self, self.category().parent_class)
    899 
--> 900 cpdef normalize_names(Py_ssize_t ngens, names):
    901     r"""
    902     Return a tuple of strings of variable names of length ngens given

~/sage-build/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.normalize_names (build/cythonized/sage/structure/category_object.c:8407)()
   1012                 names = sage.misc.defaults.variable_names(ngens, names)
   1013 
-> 1014     certify_names(names)
   1015     if ngens >= 0 and len(names) != ngens:
   1016        raise IndexError("the number of names must equal the number of generators")

~/sage-build/local/lib/python3.9/site-packages/sage/structure/category_object.pyx in sage.structure.category_object.certify_names (build/cythonized/sage/structure/category_object.c:8923)()
   1064             raise ValueError("variable name {!r} is not alphanumeric".format(N))
   1065         if not N[0].isalpha():
-> 1066             raise ValueError("variable name {!r} does not start with a letter".format(N))
   1067         if N in s:
   1068             raise ValueError("variable name {!r} appears more than once".format(N))

ValueError: variable name '0' does not start with a letter
```


Nothing in this code seems to be specific to `ZZ`, just Sage doesn't have put enough objects into the correct category (with the corresponding implementations) to support it.

Perhaps for now we can just change the documentation to say this works for any infinite enumerated (commutative) ring?



---

archive/issue_comments_471216.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-14T09:54:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471216",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_471217.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Perhaps for now we can just change the documentation to say this works for any infinite enumerated (commutative) ring?\n\nDone.",
    "created_at": "2022-02-14T10:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471217",
    "user": "@yyyyx4"
}
```

Replying to [comment:7 tscrim]:
> Perhaps for now we can just change the documentation to say this works for any infinite enumerated (commutative) ring?

Done.



---

archive/issue_comments_471218.json:
```json
{
    "body": "Thank you.\n\nI agree that a category level solution would be better, but that might involve some subtleties with speed, mixing finite sets, and things (unfortunately) assuming a particular order on the objects.",
    "created_at": "2022-02-14T12:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471218",
    "user": "@tscrim"
}
```

Thank you.

I agree that a category level solution would be better, but that might involve some subtleties with speed, mixing finite sets, and things (unfortunately) assuming a particular order on the objects.



---

archive/issue_comments_471219.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-14T12:01:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471219",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_471220.json:
```json
{
    "body": "Thank you for reviewing!",
    "created_at": "2022-02-14T12:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471220",
    "user": "@yyyyx4"
}
```

Thank you for reviewing!



---

archive/issue_comments_471221.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-20T13:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/33050",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/33050#issuecomment-471221",
    "user": "@vbraun"
}
```

Resolution: fixed
