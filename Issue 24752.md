# Issue 24752: G.edges_incident returns edges with vertices swapped

archive/issues_024752.json:
```json
{
    "body": "\n```\nsage: G = (graphs.PathGraph(4)).relabel(immutable=True, inplace=False)\nsage: G.edges(labels=False)\n[(0, 1), (1, 2), (2, 3)]\nsage: G.edges_incident([1,2], labels=False)\n[(1, 0), (1, 2), (2, 3)]\n```\n\n\nI would expect that `G.edges_incident` returns a subset of `G.edges`\n\nIssue created by migration from https://trac.sagemath.org/ticket/24989\n\n",
    "created_at": "2018-03-15T20:17:47Z",
    "labels": [
        "graph theory",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "G.edges_incident returns edges with vertices swapped",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24752",
    "user": "mantepse"
}
```

```
sage: G = (graphs.PathGraph(4)).relabel(immutable=True, inplace=False)
sage: G.edges(labels=False)
[(0, 1), (1, 2), (2, 3)]
sage: G.edges_incident([1,2], labels=False)
[(1, 0), (1, 2), (2, 3)]
```


I would expect that `G.edges_incident` returns a subset of `G.edges`

Issue created by migration from https://trac.sagemath.org/ticket/24989





---

archive/issue_comments_347459.json:
```json
{
    "body": "This is due to method `iterator_edges` of the `static_sparse_graph` backend.\n\n```\nsage: G = (graphs.PathGraph(4)).relabel(immutable=True, inplace=False)\nsage: G._backend\n<sage.graphs.base.static_sparse_backend.StaticSparseBackend object at 0x2198ceea8>\nsage: G.edges_incident([1,2], labels=False)\n[(1, 0), (1, 2), (2, 3)]\nsage: list(G.edge_iterator([1,2], labels=False))\n[(1, 0), (1, 2), (2, 3)]\nsage:\nsage: G = (graphs.PathGraph(4)).relabel(immutable=False, inplace=False)\nsage: G._backend\n<sage.graphs.base.sparse_graph.SparseGraphBackend object at 0x218d369d0>\nsage: G.edges_incident([1,2], labels=False)\n[(0, 1), (1, 2), (2, 3)]\nsage: list(G.edge_iterator([1,2], labels=False))\n[(0, 1), (1, 2), (2, 3)]\n```\n",
    "created_at": "2018-03-16T08:12:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347459",
    "user": "dcoudert"
}
```

This is due to method `iterator_edges` of the `static_sparse_graph` backend.

```
sage: G = (graphs.PathGraph(4)).relabel(immutable=True, inplace=False)
sage: G._backend
<sage.graphs.base.static_sparse_backend.StaticSparseBackend object at 0x2198ceea8>
sage: G.edges_incident([1,2], labels=False)
[(1, 0), (1, 2), (2, 3)]
sage: list(G.edge_iterator([1,2], labels=False))
[(1, 0), (1, 2), (2, 3)]
sage:
sage: G = (graphs.PathGraph(4)).relabel(immutable=False, inplace=False)
sage: G._backend
<sage.graphs.base.sparse_graph.SparseGraphBackend object at 0x218d369d0>
sage: G.edges_incident([1,2], labels=False)
[(0, 1), (1, 2), (2, 3)]
sage: list(G.edge_iterator([1,2], labels=False))
[(0, 1), (1, 2), (2, 3)]
```




---

archive/issue_comments_347460.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-08T19:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347460",
    "user": "@vipul79321"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_347461.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-08T19:14:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347461",
    "user": "@vipul79321"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347462.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-08T19:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347462",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_347463.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-08T19:42:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347463",
    "user": "@vipul79321"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347464.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-09T10:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347464",
    "user": "dcoudert"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347465.json:
```json
{
    "body": "No, this is not an acceptable solution. We do our best to provide as fast as possible solutions and making a copy of the graph is a too expensive operation for this purpose. Furthermore, it is not algorithmically sounded as it relies only on the way the copy is done. \n\nThe problem must be fixed in the backend.",
    "created_at": "2020-02-09T10:44:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347465",
    "user": "dcoudert"
}
```

No, this is not an acceptable solution. We do our best to provide as fast as possible solutions and making a copy of the graph is a too expensive operation for this purpose. Furthermore, it is not algorithmically sounded as it relies only on the way the copy is done. 

The problem must be fixed in the backend.



---

archive/issue_comments_347466.json:
```json
{
    "body": "Replying to [comment:8 dcoudert]:\n> No, this is not an acceptable solution. We do our best to provide as fast as possible solutions and making a copy of the graph is a too expensive operation for this purpose. Furthermore, it is not algorithmically sounded as it relies only on the way the copy is done.\nYeah, I agree that it is not fast. We can also try to pass another argument 'bool is_immutable'. So that our function will make copy of the graph only when it is immutable. \n> \n> The problem must be fixed in the backend.\nI dont think it is worth it to make changes in backend for this purpose.",
    "created_at": "2020-02-09T10:56:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347466",
    "user": "@vipul79321"
}
```

Replying to [comment:8 dcoudert]:
> No, this is not an acceptable solution. We do our best to provide as fast as possible solutions and making a copy of the graph is a too expensive operation for this purpose. Furthermore, it is not algorithmically sounded as it relies only on the way the copy is done.
Yeah, I agree that it is not fast. We can also try to pass another argument 'bool is_immutable'. So that our function will make copy of the graph only when it is immutable. 
> 
> The problem must be fixed in the backend.
I dont think it is worth it to make changes in backend for this purpose.



---

archive/issue_comments_347467.json:
```json
{
    "body": "This problem must be fixed without copy of the graph, and FYI, we can check if a graph is immutable or not using `G.is_immutable()`.",
    "created_at": "2020-02-09T11:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347467",
    "user": "dcoudert"
}
```

This problem must be fixed without copy of the graph, and FYI, we can check if a graph is immutable or not using `G.is_immutable()`.



---

archive/issue_comments_347468.json:
```json
{
    "body": "Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.",
    "created_at": "2020-04-14T19:41:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347468",
    "user": "mkoeppe"
}
```

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.



---

archive/issue_comments_347469.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347469",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_347470.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-12-15T23:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347470",
    "user": "@peelin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_347471.json:
```json
{
    "body": "New commit:\n\nhttps://git.sagemath.org/sage.git/commit/?h=u/gh-peelin/ticket24989",
    "created_at": "2022-12-15T23:19:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347471",
    "user": "@peelin"
}
```

New commit:

https://git.sagemath.org/sage.git/commit/?h=u/gh-peelin/ticket24989



---

archive/issue_comments_347472.json:
```json
{
    "body": "I  see 2 issues in your code\n\n\n```diff\n-                if j < i and j in b_vertices:\n-                    continue\n+\n+                # Guarantees that vertex ordering is consistent\n+                if j < i:\n+                    if j in b_vertices:\n+                        continue\n+                    else:\n+                        v1, v2 = self._vertex_to_labels[j], vi\n+                else:\n+                    v1, v2 = vi, self._vertex_to_labels[j]\n```\n\n\n- an an edge can now be returned twice. Before an edge was returned only when `j >= i`\n- you assume that if `i < j` then the label of `i` is smaller than the label of `j`, but there is no reason for that.",
    "created_at": "2022-12-17T08:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347472",
    "user": "dcoudert"
}
```

I  see 2 issues in your code


```diff
-                if j < i and j in b_vertices:
-                    continue
+
+                # Guarantees that vertex ordering is consistent
+                if j < i:
+                    if j in b_vertices:
+                        continue
+                    else:
+                        v1, v2 = self._vertex_to_labels[j], vi
+                else:
+                    v1, v2 = vi, self._vertex_to_labels[j]
```


- an an edge can now be returned twice. Before an edge was returned only when `j >= i`
- you assume that if `i < j` then the label of `i` is smaller than the label of `j`, but there is no reason for that.



---

archive/issue_comments_347473.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-12-17T08:06:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347473",
    "user": "dcoudert"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_347474.json:
```json
{
    "body": "Replying to [comment:19 David Coudert]:\n> I  see 2 issues in your code\n> \n> {{{#!diff\n> -                if j < i and j in b_vertices:\n> -                    continue\n> +\n> +                # Guarantees that vertex ordering is consistent\n> +                if j < i:\n> +                    if j in b_vertices:\n> +                        continue\n> +                    else:\n> +                        v1, v2 = self._vertex_to_labels[j], vi\n> +                else:\n> +                    v1, v2 = vi, self._vertex_to_labels[j]\n> }}}\n> \n> - an an edge can now be returned twice. Before an edge was returned only when `j >= i`\n> - you assume that if `i < j` then the label of `i` is smaller than the label of `j`, but there is no reason for that.\n\n- The edges returned are the same edges as the ones returned before: which was when `j>=i or  j not in b_vertices`. I used a nested if statement to minimize the performance penalty from this change.\n\n- I am not claiming that the output edge (v1, v2) will satisfy v1 < v2, in fact the vertex labels might not even be comparable. I am only guaranteeing that if the edge is output as (v1, v2), then any other time this edge appears (in a different call), only (v1, v2) will be seen and not (v2, v1). I believe this fixes the issue because `G.edges` also internally calls `iterator_edges`.",
    "created_at": "2022-12-17T16:16:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347474",
    "user": "@peelin"
}
```

Replying to [comment:19 David Coudert]:
> I  see 2 issues in your code
> 
> {{{#!diff
> -                if j < i and j in b_vertices:
> -                    continue
> +
> +                # Guarantees that vertex ordering is consistent
> +                if j < i:
> +                    if j in b_vertices:
> +                        continue
> +                    else:
> +                        v1, v2 = self._vertex_to_labels[j], vi
> +                else:
> +                    v1, v2 = vi, self._vertex_to_labels[j]
> }}}
> 
> - an an edge can now be returned twice. Before an edge was returned only when `j >= i`
> - you assume that if `i < j` then the label of `i` is smaller than the label of `j`, but there is no reason for that.

- The edges returned are the same edges as the ones returned before: which was when `j>=i or  j not in b_vertices`. I used a nested if statement to minimize the performance penalty from this change.

- I am not claiming that the output edge (v1, v2) will satisfy v1 < v2, in fact the vertex labels might not even be comparable. I am only guaranteeing that if the edge is output as (v1, v2), then any other time this edge appears (in a different call), only (v1, v2) will be seen and not (v2, v1). I believe this fixes the issue because `G.edges` also internally calls `iterator_edges`.



---

archive/issue_comments_347475.json:
```json
{
    "body": "Right, I was too fast in real the code.\n\nI did some tests and it seems ok, but let's wait for the patchbot.",
    "created_at": "2022-12-17T16:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347475",
    "user": "dcoudert"
}
```

Right, I was too fast in real the code.

I did some tests and it seems ok, but let's wait for the patchbot.



---

archive/issue_comments_347476.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-12-17T16:50:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24752",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24752#issuecomment-347476",
    "user": "dcoudert"
}
```

Changing status from needs_work to needs_review.
