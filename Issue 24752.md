# Issue 24752: G.edges_incident returns edges with vertices swapped

Issue created by migration from https://trac.sagemath.org/ticket/24989

Original creator: mantepse

Original creation time: 2018-03-15 20:17:47


```
sage: G = (graphs.PathGraph(4)).relabel(immutable=True, inplace=False)
sage: G.edges(labels=False)
[(0, 1), (1, 2), (2, 3)]
sage: G.edges_incident([1,2], labels=False)
[(1, 0), (1, 2), (2, 3)]
```


I would expect that `G.edges_incident` returns a subset of `G.edges`


---

Comment by dcoudert created at 2018-03-16 08:12:40

This is due to method `iterator_edges` of the `static_sparse_graph` backend.

```
sage: G = (graphs.PathGraph(4)).relabel(immutable=True, inplace=False)
sage: G._backend
<sage.graphs.base.static_sparse_backend.StaticSparseBackend object at 0x2198ceea8>
sage: G.edges_incident([1,2], labels=False)
[(1, 0), (1, 2), (2, 3)]
sage: list(G.edge_iterator([1,2], labels=False))
[(1, 0), (1, 2), (2, 3)]
sage:
sage: G = (graphs.PathGraph(4)).relabel(immutable=False, inplace=False)
sage: G._backend
<sage.graphs.base.sparse_graph.SparseGraphBackend object at 0x218d369d0>
sage: G.edges_incident([1,2], labels=False)
[(0, 1), (1, 2), (2, 3)]
sage: list(G.edge_iterator([1,2], labels=False))
[(0, 1), (1, 2), (2, 3)]
```



---

Comment by @vipul79321 created at 2020-02-08 19:09:22

Changing status from new to needs_review.


---

Comment by @vipul79321 created at 2020-02-08 19:14:05

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-02-08 19:41:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @vipul79321 created at 2020-02-08 19:42:31

Changing status from needs_work to needs_review.


---

Comment by dcoudert created at 2020-02-09 10:44:52

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2020-02-09 10:44:52

No, this is not an acceptable solution. We do our best to provide as fast as possible solutions and making a copy of the graph is a too expensive operation for this purpose. Furthermore, it is not algorithmically sounded as it relies only on the way the copy is done. 

The problem must be fixed in the backend.


---

Comment by @vipul79321 created at 2020-02-09 10:56:24

Replying to [comment:8 dcoudert]:
> No, this is not an acceptable solution. We do our best to provide as fast as possible solutions and making a copy of the graph is a too expensive operation for this purpose. Furthermore, it is not algorithmically sounded as it relies only on the way the copy is done.
Yeah, I agree that it is not fast. We can also try to pass another argument 'bool is_immutable'. So that our function will make copy of the graph only when it is immutable. 
> 
> The problem must be fixed in the backend.
I dont think it is worth it to make changes in backend for this purpose.


---

Comment by dcoudert created at 2020-02-09 11:11:40

This problem must be fixed without copy of the graph, and FYI, we can check if a graph is immutable or not using `G.is_immutable()`.


---

Comment by mkoeppe created at 2020-04-14 19:41:51

Batch modifying tickets that will likely not be ready for 9.1, based on a review of the ticket title, branch/review status, and last modification date.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by @peelin created at 2022-12-15 23:19:29

Changing status from needs_work to needs_review.


---

Comment by @peelin created at 2022-12-15 23:19:29

New commit:

https://git.sagemath.org/sage.git/commit/?h=u/gh-peelin/ticket24989


---

Comment by dcoudert created at 2022-12-17 08:06:12

I  see 2 issues in your code


```diff
-                if j < i and j in b_vertices:
-                    continue
+
+                # Guarantees that vertex ordering is consistent
+                if j < i:
+                    if j in b_vertices:
+                        continue
+                    else:
+                        v1, v2 = self._vertex_to_labels[j], vi
+                else:
+                    v1, v2 = vi, self._vertex_to_labels[j]
```


- an an edge can now be returned twice. Before an edge was returned only when `j >= i`
- you assume that if `i < j` then the label of `i` is smaller than the label of `j`, but there is no reason for that.


---

Comment by dcoudert created at 2022-12-17 08:06:12

Changing status from needs_review to needs_work.


---

Comment by @peelin created at 2022-12-17 16:16:22

Replying to [comment:19 David Coudert]:
> I  see 2 issues in your code
> 
> {{{#!diff
> -                if j < i and j in b_vertices:
> -                    continue
> +
> +                # Guarantees that vertex ordering is consistent
> +                if j < i:
> +                    if j in b_vertices:
> +                        continue
> +                    else:
> +                        v1, v2 = self._vertex_to_labels[j], vi
> +                else:
> +                    v1, v2 = vi, self._vertex_to_labels[j]
> }}}
> 
> - an an edge can now be returned twice. Before an edge was returned only when `j >= i`
> - you assume that if `i < j` then the label of `i` is smaller than the label of `j`, but there is no reason for that.

- The edges returned are the same edges as the ones returned before: which was when `j>=i or  j not in b_vertices`. I used a nested if statement to minimize the performance penalty from this change.

- I am not claiming that the output edge (v1, v2) will satisfy v1 < v2, in fact the vertex labels might not even be comparable. I am only guaranteeing that if the edge is output as (v1, v2), then any other time this edge appears (in a different call), only (v1, v2) will be seen and not (v2, v1). I believe this fixes the issue because `G.edges` also internally calls `iterator_edges`.


---

Comment by dcoudert created at 2022-12-17 16:50:37

Right, I was too fast in real the code.

I did some tests and it seems ok, but let's wait for the patchbot.


---

Comment by dcoudert created at 2022-12-17 16:50:37

Changing status from needs_work to needs_review.
