# Issue 17920: Random failure in coerce_action.pyx

archive/issues_017920.json:
```json
{
    "body": "CC:  simonking\n\nKeywords: random_fail\n\nZmod(6) can be collected at the wrong time\n\n```\nsage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 78, in sage.structure.coerce_actions.LAction\nFailed example:\n    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\nExpected:\n    Left action by Rational Field on Ring of integers modulo 6\nGot:\n    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>\n**********************************************************************\n1 item had failures:\n   1 of   4 in sage.structure.coerce_actions.LAction\n    [100 tests, 1 failure, 0.82 s]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18157\n\n",
    "created_at": "2015-04-10T20:16:15Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.6",
    "title": "Random failure in coerce_action.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17920",
    "user": "https://github.com/vbraun"
}
```
CC:  simonking

Keywords: random_fail

Zmod(6) can be collected at the wrong time

```
sage -t --long --warn-long 47.9 src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 78, in sage.structure.coerce_actions.LAction
Failed example:
    sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
Expected:
    Left action by Rational Field on Ring of integers modulo 6
Got:
    <repr(<sage.structure.coerce_actions.GenericAction at 0x7f8650aca938>) failed: RuntimeError: This action acted on a set that became garbage collected>
**********************************************************************
1 item had failures:
   1 of   4 in sage.structure.coerce_actions.LAction
    [100 tests, 1 failure, 0.82 s]
```


Issue created by migration from https://trac.sagemath.org/ticket/18157





---

archive/issue_comments_240301.json:
```json
{
    "body": "Reliable reproduction of the error condition:\n\n```\nimport gc\nA=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)\ngc.collect()\nC=repr(A)\n```\n\nThe reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this \"action\" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.\n\nIt may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:\n\n\n```\nsage: Z6 = Zmod(6)\nsage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)\n```\n",
    "created_at": "2015-04-10T21:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240301",
    "user": "https://github.com/nbruin"
}
```

Reliable reproduction of the error condition:

```
import gc
A=sage.structure.coerce_actions.GenericAction(QQ, Zmod(6), True, check=False)
gc.collect()
C=repr(A)
```

The reason is simple: `sage.categories.action.Action.__init__` only stores a weakref to the set acted on, and nothing else. If this "action" object is mainly meant to operate inside the coercion framework then this is probably the appropriate behaviour. Note that if the action ever needs to get used, then there is a group element to act and a set element to be acted upon, so the space has to be alive. Whoever is storing this action object should have a callback on the weakref, though, to throw away this action object to avoid a memory leak.

It may just be that this action object does get used properly and that this doctest is broken. In that case the fix is:


```
sage: Z6 = Zmod(6)
sage: sage.structure.coerce_actions.GenericAction(QQ, Z6, True, check=False)
```




---

archive/issue_comments_240302.json:
```json
{
    "body": "\n```\ncm.discover_action(GF(5)['x'], ZZ, operator.div)\n```\n\nAlso for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.\n\nIf we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.",
    "created_at": "2015-04-13T00:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240302",
    "user": "https://github.com/nbruin"
}
```


```
cm.discover_action(GF(5)['x'], ZZ, operator.div)
```

Also for this one: the coercion framework will never be asked to discover an action on an otherwise unreferenced parent. At the same time, the action object does get cached (globally!) somewhere in the coercion framework and hence should probably not hold a strong reference (at least to one of the sets it acts on). The container it gets stored in is probably a TripleDict, keyed on the two parents involved. It takes care of having a callback to delete the action object when one of the domains gets deleted, so the action objects will normally not outlive the shortest lifetime of the parents involved.

If we have an absolute need of handling actions outside the coercion framework, we should probably make other action objects that do keep strong references. We do this for maps that get used for conversion and coercion. But these actions are showing desirable behaviour for use in the coercion framework. I think the bug is in the doctests.



---

archive/issue_comments_240303.json:
```json
{
    "body": "Replying to [comment:3 nbruin]:\n> I think the bug is in the doctests.\n\nMe too!",
    "created_at": "2015-04-13T07:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240303",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:3 nbruin]:
> I think the bug is in the doctests.

Me too!



---

archive/issue_comments_240304.json:
```json
{
    "body": "Somebody please write a patch instead of me-too-ing ;-)",
    "created_at": "2015-04-13T08:33:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240304",
    "user": "https://github.com/vbraun"
}
```

Somebody please write a patch instead of me-too-ing ;-)



---

archive/issue_comments_240305.json:
```json
{
    "body": "Might be other wrong doctests... not sure how to find them.\n----\nNew commits:",
    "created_at": "2015-04-13T09:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240305",
    "user": "https://github.com/videlec"
}
```

Might be other wrong doctests... not sure how to find them.
----
New commits:



---

archive/issue_comments_240306.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-13T09:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240306",
    "user": "https://github.com/videlec"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_240307.json:
```json
{
    "body": "There is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.",
    "created_at": "2015-04-13T09:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240307",
    "user": "https://github.com/pjbruin"
}
```

There is another one in `src/sage/matrix/action.pyx`; it is already fixed in #10513, so no need to treat that one here.



---

archive/issue_comments_240308.json:
```json
{
    "body": "Would be nice if people would run the testsuite with this patch (and #10513)\n\n```\nfor i in $(seq -w 1 100)\ndo\n   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log\ndone\n```\n\n\nOr even better, does somebody know how to call `gc.collect()` after each command in doctests?",
    "created_at": "2015-04-13T09:23:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240308",
    "user": "https://github.com/videlec"
}
```

Would be nice if people would run the testsuite with this patch (and #10513)

```
for i in $(seq -w 1 100)
do
   sage -t --long structure/ rings/ modular/ matrix/| tee ~/testlong${i}.log
done
```


Or even better, does somebody know how to call `gc.collect()` after each command in doctests?



---

archive/issue_comments_240309.json:
```json
{
    "body": "Replying to [comment:8 vdelecroix]:\n> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\nThat wouldn't help, right?",
    "created_at": "2015-04-13T09:28:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240309",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:8 vdelecroix]:
> Or even better, does somebody know how to call `gc.collect()` after each command in doctests?
That wouldn't help, right?



---

archive/issue_comments_240310.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:8 vdelecroix]:\n> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?\n> That wouldn't help, right?\n\nRight! Not for the two doctests mentioned in the description...",
    "created_at": "2015-04-13T09:31:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240310",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:8 vdelecroix]:
> > Or even better, does somebody know how to call `gc.collect()` after each command in doctests?
> That wouldn't help, right?

Right! Not for the two doctests mentioned in the description...



---

archive/issue_comments_240311.json:
```json
{
    "body": "With one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.\n\nHowever, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!\n\nOne test is different:\n\n```diff\n@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):\n \n         This used to hang before :trac:`17844`::\n \n-            sage: E = EllipticCurve(GF(5), [4,0])\n+            sage: GF5 = GF(5)\n+            sage: E = EllipticCurve(GF5, [4,0])\n             sage: P = E.random_element()\n             sage: (-2^63)*P\n             (0 : 1 : 0)\n```\n\nDefining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.\n\nSo, I put it to \"needs work\", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.",
    "created_at": "2015-04-17T08:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240311",
    "user": "https://github.com/simon-king-jena"
}
```

With one exception, the flaky tests constitute a misuse: Objects that are normally used internally are suddenly put out into the wild. It is clear that that can lead to disaster unless precautions are taken. Hence, I support the general approach in the attached branch: In these tests, one should work with permanent rather than temporary objects, to prevent premature garbage collection.

However, one should also explicitly say in these tests that we are talking about things that normally happen in the innards of Sage, and that the tests do *not* show how to work with them!

One test is different:

```diff
@@ -606,7 +624,8 @@ cdef class IntegerMulAction(Action):
 
         This used to hang before :trac:`17844`::
 
-            sage: E = EllipticCurve(GF(5), [4,0])
+            sage: GF5 = GF(5)
+            sage: E = EllipticCurve(GF5, [4,0])
             sage: P = E.random_element()
             sage: (-2^63)*P
             (0 : 1 : 0)
```

Defining an elliptic curve over a finite field should certainly be enough to prevent the finite field from garbage collection! So, here I do not agree with the fix. Apparently the test fails because of an internal bug, not because of misuse.

So, I put it to "needs work", because we should either find and fix the underlying bug here, or open a new ticket for the elliptic curve issue.



---

archive/issue_comments_240312.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-04-17T08:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240312",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_240313.json:
```json
{
    "body": "I don't see a problem with the elliptic curve example:\n\n```\nsage: import gc\nsage: E = EllipticCurve(GF(5), [4,0])\nsage: gc.collect()\n156\nsage: P = E.random_element()\nsage: gc.collect()\n0\nsage: (-2^63)*P\n(0 : 1 : 0)\n```\n\nSo, why should it be changed?",
    "created_at": "2015-04-17T10:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240313",
    "user": "https://github.com/simon-king-jena"
}
```

I don't see a problem with the elliptic curve example:

```
sage: import gc
sage: E = EllipticCurve(GF(5), [4,0])
sage: gc.collect()
156
sage: P = E.random_element()
sage: gc.collect()
0
sage: (-2^63)*P
(0 : 1 : 0)
```

So, why should it be changed?



---

archive/issue_comments_240314.json:
```json
{
    "body": "Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.",
    "created_at": "2015-04-17T14:16:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240314",
    "user": "https://github.com/vbraun"
}
```

Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future.



---

archive/issue_comments_240315.json:
```json
{
    "body": "Replying to [comment:12 SimonKing]:\n\n> One test is different:\n\nAgreed. You can revert it.",
    "created_at": "2015-04-17T15:14:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240315",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:12 SimonKing]:

> One test is different:

Agreed. You can revert it.



---

archive/issue_comments_240316.json:
```json
{
    "body": "Replying to [comment:14 vbraun]:\n> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. \n\nWhat are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.",
    "created_at": "2015-04-17T17:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240316",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:14 vbraun]:
> Even if right now E is kept alive elsewhere (presumably another doctest leaked it) you shouldn't assume that this will not change in the future. 

What are you talking about? In the test in question, the elliptic curve `E` certainly is kept alive *in the test* (not elsewhere), as it is strongly referenced. As I don't see this test fail, I agree with Vincent that the test should be reverted to its original state.



---

archive/issue_comments_240317.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-17T17:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240317",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240318.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-17T17:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240318",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_240319.json:
```json
{
    "body": "I added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.\n\nFrom my point of view, it is a positive review, but of course someone should have a look at my commit.\n----\nNew commits:",
    "created_at": "2015-04-17T17:58:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240319",
    "user": "https://github.com/simon-king-jena"
}
```

I added comments in appropriate places, telling to be careful when using coerce actions outside of coercion models, reverting the elliptic curve test, and fixing some more tests in which a premature garbage collection was possible.

From my point of view, it is a positive review, but of course someone should have a look at my commit.
----
New commits:



---

archive/issue_comments_240320.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-17T22:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240320",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_240321.json:
```json
{
    "body": "Hi Simon,\n\nI merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI agree with your commits and just added references to your ticket. I am ok for the positive review.\n\nVincent",
    "created_at": "2015-04-17T22:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240321",
    "user": "https://github.com/videlec"
}
```

Hi Simon,

I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I agree with your commits and just added references to your ticket. I am ok for the positive review.

Vincent



---

archive/issue_comments_240322.json:
```json
{
    "body": "Replying to [comment:20 vdelecroix]:\n> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.\n\nI suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.\n\nSo, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.",
    "created_at": "2015-04-17T22:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240322",
    "user": "https://github.com/simon-king-jena"
}
```

Replying to [comment:20 vdelecroix]:
> I merge on sage-6.7.beta1 (sorry if I did wrong). If you prefer you can only cherry-pick 60fcedc.

I suppose that Volker will tell you that (1) one should only merge if there is a good reason, and (2) one must not change the history, even if one has merged without a good reason.

So, just leave it as it is. I had a look at your changes, and they look fine to me. Provided that the patchbot gives a green blob, it should be positive review.



---

archive/issue_comments_240323.json:
```json
{
    "body": "The patchbot tells us that all tests pass, and based on the discussion above we have a positive review.",
    "created_at": "2015-04-18T08:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240323",
    "user": "https://github.com/simon-king-jena"
}
```

The patchbot tells us that all tests pass, and based on the discussion above we have a positive review.



---

archive/issue_comments_240324.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-18T08:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240324",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_240325.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-19T01:52:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17920#issuecomment-240325",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_051393.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-04-19T01:52:11Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17920",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17920#event-51393"
}
```
