# Issue 13245: Improved iteration on finite \ZZ-submodules and vector spaces over finite fields

Issue created by migration from https://trac.sagemath.org/ticket/13417

Original creator: tfeulner

Original creation time: 2012-08-31 13:52:15

Assignee: AlexGhitza

CC:  ppurka

This patch defines an iterator class for finite \ZZ-submodules and especially for subspaces over finite fields.

It improves the running times of this computations significantly:


```
    sage: from sage.modules.finite_submodule_iter import FiniteFieldsubspace_iterator
    sage: A = random_matrix(GF(2), 15, 100)
    sage: X = A.row_space()
    sage: x = [0 for _ in X] #long time #takes 7.12 seconds
    sage: y = [0 for _ in FiniteFieldsubspace_iterator(A)] # takes 0.05 seconds
```



---

Attachment


---

Comment by tfeulner created at 2012-08-31 14:07:11

The `__iter__` methods are untouched in `sage.modules.free_modules`. Should this happen in a seperate ticket?


---

Comment by tfeulner created at 2012-09-03 14:15:06

Changing status from new to needs_review.


---

Comment by ppurka created at 2012-11-09 10:22:23

The attachment [attachment:trac_13417-submodule_iter.patch] contains an update to the patch that we arrived at after a long (off-ticket) discussion with tfeulner. Needs review. :)

Patchbot: apply trac_13417-submodule_iter.patch


---

Comment by ppurka created at 2012-11-09 12:04:30

Updated patch.


---

Attachment

I made a small change in the patch. The line

```
        basis = [_p*x for _p in pows for x in basis] # a ZZ_p-basis for the vectorspace 
```

is changed to

```
        basis = [_p*x for x in basis for _p in pows] # a ZZ_p-basis for the vectorspace
```

Functionally the patch is unchanged, but this small change will enable me to implement `__getitem__` for a linear code (the current implementation of `__getitem__` is a memory hog).


---

Comment by tfeulner created at 2012-11-12 11:02:52

This update allows the user to iterate over cosets of such modules. Furthermore, I added a class to iterate over the set of projective points in the case  of subspaces.

----
Patchbot: apply trac_13417-submodule_iter.2.patch


---

Comment by ppurka created at 2012-11-30 07:40:29

I am curious - maybe I am missing something here. Why is a vector which has the first nonzero element as 2 appearing in the projective point list? Isn't it the "norm" to have the first nonzero element in the vector be 1?

```python
sage: A = random_matrix(GF(3), 2, 3); A
[2 0 2]
[0 1 1]
sage: list(FiniteFieldsubspace_projPoint_iterator(A))
[(2, 0, 2), (0, 1, 1), (2, 1, 0), (1, 1, 2)]
```



---

Comment by tfeulner created at 2012-11-30 08:41:13

Replying to [comment:8 ppurka]:
> I am curious - maybe I am missing something here. Why is a vector which has the first nonzero element as 2 appearing in the projective point list? Isn't it the "norm" to have the first nonzero element in the vector be 1?

Maybe I should have been more precise in the description of this class. For me, a point is just a one-dimensional subspace. The iterator should just return one basis vector for each one-dimensional subspace.

In fact, the way we construct these representatives can be seen as a multiplication by a vector w from the left. The last nonzero coordinate of w is equal to 1. I am not sure about the "norm" for projective points.

I will modifiy the description of this class. The problem could be solved by
echelonizing the basis during the init method (I will only provide an optional argument for those who do care).


---

Comment by ppurka created at 2012-11-30 08:53:43

By "norm" I meant that in usual places like textbooks, the convention followed is to have the first nonzero element as 1. Am I right? The reason is that once someone new uses this class, the output will not conform to what one would expect. I am myself not very familiar with projective spaces, so this was the first thing I noticed. Technically, the output is correct since the output contains only the representatives of each line.

Echelonizing the basis is too much computations I think. All that is required is to determine the first nonzero element of a vector and multiply by its inverse. Something like

```python
ring = v.base_ring()
for vi in v:
   if vi:
      if vi != ring.one():
          v = vi**(-1) * v
      break
```

This can be done only once during the iteration.


---

Comment by tfeulner created at 2012-11-30 09:50:39

Replying to [comment:10 ppurka]:
> By "norm" I meant that in usual places like textbooks, the convention followed is to have the first nonzero element as 1. Am I right? 
Well, this is at least the standard within Sage, so we should follow this.
> 
> Echelonizing the basis is too much computations I think. All that is required is to determine the first nonzero element of a vector and multiply by its inverse. 
I do not understand why this should be too complicated, as far as I understand you would suggest to normalize all computed vectors (by the way there is already a function ```v.normalize()``` doing exactly the same)? But there are (q<sup>k</sup>-1)/(q-1) of them, while you have only to echelonize a (k x n) matrix over F<sub>q</sub>.


---

Comment by tfeulner created at 2012-11-30 09:51:24

normalizing the returned vectors


---

Attachment

Replying to [comment:11 tfeulner]:
> I do not understand why this should be too complicated, as far as I understand you would suggest to normalize all computed vectors (by the way there is already a function ```v.normalize()``` doing exactly the same)? But there are (q<sup>k</sup>-1)/(q-1) of them, while you have only to echelonize a (k x n) matrix over F<sub>q</sub>.
Oh ok. I see. I was thinking that one could get by by normalizing only the basis vectors, but I was wrong.


---

Attachment

apply to devel/sage after original patch.


---

Comment by ppurka created at 2012-11-30 11:36:28

Ok. The code works, and looks good to me. It is positive review from my side. I am attaching a [attachment:trac_13417-review.patch review patch] which does only two changes - get rid of trailing whitespace, and change a comparison  `== None` to `is None`. If you are ok with this patch, then you can set it to positive review.

Patchbot: apply trac_13417-submodule_iter.2.patch trac_13417-review.patch


---

Comment by tfeulner created at 2012-11-30 12:31:33

Changing status from needs_review to positive_review.


---

Comment by tfeulner created at 2012-11-30 12:31:33

Replying to [comment:13 ppurka]:
> Ok. The code works, and looks good to me. It is positive review from my side. I am attaching a [attachment:trac_13417-review.patch review patch] which does only two changes - get rid of trailing whitespace, and change a comparison  `== None` to `is None`. If you are ok with this patch, then you can set it to positive review.

These changes look good to me, sorry for the whitespaces.


---

Comment by jdemeyer created at 2012-12-18 11:15:27

Resolution: fixed
