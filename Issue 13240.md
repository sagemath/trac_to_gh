# Issue 13240: PowerSeriesRing should call Ring.__init__

archive/issues_013240.json:
```json
{
    "body": "Assignee: nthiery\n\nCC:  nthiery niles\n\nWe have\n\n```\nsage: A.<a,b> = PowerSeriesRing(QQ)\nsage: A._is_category_initialized()\nFalse\nsage: isinstance(A,Ring)\nTrue\n```\n\n\nSince `Ring.__init__` initialises the category, it seems that the the base class' initialisation is not called. That also prevents us from removing the alias for `_Hom_` in sage.rings.ring - see #12876.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13412\n\n",
    "created_at": "2012-08-30T08:09:30Z",
    "labels": [
        "categories",
        "major",
        "bug"
    ],
    "title": "PowerSeriesRing should call Ring.__init__",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13240",
    "user": "SimonKing"
}
```
Assignee: nthiery

CC:  nthiery niles

We have

```
sage: A.<a,b> = PowerSeriesRing(QQ)
sage: A._is_category_initialized()
False
sage: isinstance(A,Ring)
True
```


Since `Ring.__init__` initialises the category, it seems that the the base class' initialisation is not called. That also prevents us from removing the alias for `_Hom_` in sage.rings.ring - see #12876.

Issue created by migration from https://trac.sagemath.org/ticket/13412





---

archive/issue_comments_162179.json:
```json
{
    "body": "+1\n\nJust 2 cents: alternatively, it could possibly call Parent.__init__ but passing down the appropriate category.",
    "created_at": "2012-08-30T08:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162179",
    "user": "nthiery"
}
```

+1

Just 2 cents: alternatively, it could possibly call Parent.__init__ but passing down the appropriate category.



---

archive/issue_comments_162180.json:
```json
{
    "body": "I think I'll even be getting category and coercion framework right (there was `__call__`, there was no `self.Element`, there was no `_coerce_map_from_`). With the patch I'm preparing:\n\n```\nsage: A.<a> = PowerSeriesRing(QQ)\nsage: TestSuite(A).run()\nsage: A.<a,b> = PowerSeriesRing(QQ)\nsage: TestSuite(A).run()\n```\n\n\nNeed to document the new stuff, though.",
    "created_at": "2012-08-30T10:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162180",
    "user": "SimonKing"
}
```

I think I'll even be getting category and coercion framework right (there was `__call__`, there was no `self.Element`, there was no `_coerce_map_from_`). With the patch I'm preparing:

```
sage: A.<a> = PowerSeriesRing(QQ)
sage: TestSuite(A).run()
sage: A.<a,b> = PowerSeriesRing(QQ)
sage: TestSuite(A).run()
```


Need to document the new stuff, though.



---

archive/issue_comments_162181.json:
```json
{
    "body": "PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.",
    "created_at": "2012-08-30T10:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162181",
    "user": "SimonKing"
}
```

PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.



---

archive/issue_comments_162182.json:
```json
{
    "body": "Replying to [comment:3 SimonKing]:\n> PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.\n\nNeat!\n\nIt's kind of you to be going the extra mile!",
    "created_at": "2012-08-30T10:16:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162182",
    "user": "nthiery"
}
```

Replying to [comment:3 SimonKing]:
> PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.

Neat!

It's kind of you to be going the extra mile!



---

archive/issue_comments_162183.json:
```json
{
    "body": "Replying to [comment:4 nthiery]:\n> Replying to [comment:3 SimonKing]:\n> > PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.\n> \n> Neat!\n> \n> It's kind of you to be going the extra mile!\n\nNo, that's more like going by car. At first, I tried to fix the `TestSuite` by implementing `__reduce__`, which didn't work well. Inheriting from `UniqueRepresentation` did the trick.",
    "created_at": "2012-08-30T10:50:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162183",
    "user": "SimonKing"
}
```

Replying to [comment:4 nthiery]:
> Replying to [comment:3 SimonKing]:
> > PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.
> 
> Neat!
> 
> It's kind of you to be going the extra mile!

No, that's more like going by car. At first, I tried to fix the `TestSuite` by implementing `__reduce__`, which didn't work well. Inheriting from `UniqueRepresentation` did the trick.



---

archive/issue_comments_162184.json:
```json
{
    "body": "> No, that's more like going by car. At first, I tried to fix the `TestSuite` by implementing `__reduce__`, which didn't work well. Inheriting from `UniqueRepresentation` did the trick.\n\n:-)\n\nHopefuly the previous reduce was good enough that there won't be issues with the pickles from the pickle jar.",
    "created_at": "2012-08-30T11:18:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162184",
    "user": "nthiery"
}
```

> No, that's more like going by car. At first, I tried to fix the `TestSuite` by implementing `__reduce__`, which didn't work well. Inheriting from `UniqueRepresentation` did the trick.

:-)

Hopefuly the previous reduce was good enough that there won't be issues with the pickles from the pickle jar.



---

archive/issue_comments_162185.json:
```json
{
    "body": "Replying to [comment:6 nthiery]:\n> Hopefuly the previous reduce was good enough that there won't be issues with the pickles from the pickle jar.\n\nWell, the pickle jar is doctested, plus it won't break unless I remove the unpickling function used in the old pickles (which I don't).",
    "created_at": "2012-08-30T12:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162185",
    "user": "SimonKing"
}
```

Replying to [comment:6 nthiery]:
> Hopefuly the previous reduce was good enough that there won't be issues with the pickles from the pickle jar.

Well, the pickle jar is doctested, plus it won't break unless I remove the unpickling function used in the old pickles (which I don't).



---

archive/issue_comments_162186.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-08-30T13:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162186",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_162187.json:
```json
{
    "body": "Changing keywords from \"\" to \"power series, coercion, category\".",
    "created_at": "2012-08-30T13:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162187",
    "user": "SimonKing"
}
```

Changing keywords from "" to "power series, coercion, category".



---

archive/issue_comments_162188.json:
```json
{
    "body": "Cc to the original author (hi Niles).\n\nThe patch implements using the category and coercion framework for uni- and multi-variate power series rings. For me, tests pass (but I have a lot of other patches applied as well, so, better you or the patchbot test it as well).",
    "created_at": "2012-08-30T13:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162188",
    "user": "SimonKing"
}
```

Cc to the original author (hi Niles).

The patch implements using the category and coercion framework for uni- and multi-variate power series rings. For me, tests pass (but I have a lot of other patches applied as well, so, better you or the patchbot test it as well).



---

archive/issue_comments_162189.json:
```json
{
    "body": "Any reviewer for making power series rings \"nicer\", from a categorical point of view?",
    "created_at": "2012-09-18T09:05:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162189",
    "user": "SimonKing"
}
```

Any reviewer for making power series rings "nicer", from a categorical point of view?



---

archive/issue_comments_162190.json:
```json
{
    "body": "Hi Simon,\n\nI am not sure I'll get through the review, but I am now browsing through the patch while Sage compiles C3. Here are some little comments:\n\nNear the TestSuite calls, I see things like:\n\n```\n    sage: loads(dumps(X)) is X\n    True\n```\n\nThis is a generic test, so I'd rather not include those, and if you feel strong about them to add it as a generic test in the TestSuite. Maybe the X._test_pickling() should check whether X has unique representation, and test with `is` or `==` accordingly? Or instead one could just check elsewhere that equality is indeed defined in term of ``is`` (like testting whether the __eq__ method is that inherited from UniqueRepresentation)\n\nline 362: this should be `is_MPowerSeriesRing(S)`:\n\n```\n        if (is_MPolynomialRing(S) or is_MPowerSeriesRing)\n```\n\n\nCheers,\n                     Nicolas",
    "created_at": "2012-09-18T10:38:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162190",
    "user": "nthiery"
}
```

Hi Simon,

I am not sure I'll get through the review, but I am now browsing through the patch while Sage compiles C3. Here are some little comments:

Near the TestSuite calls, I see things like:

```
    sage: loads(dumps(X)) is X
    True
```

This is a generic test, so I'd rather not include those, and if you feel strong about them to add it as a generic test in the TestSuite. Maybe the X._test_pickling() should check whether X has unique representation, and test with `is` or `==` accordingly? Or instead one could just check elsewhere that equality is indeed defined in term of ``is`` (like testting whether the __eq__ method is that inherited from UniqueRepresentation)

line 362: this should be `is_MPowerSeriesRing(S)`:

```
        if (is_MPolynomialRing(S) or is_MPowerSeriesRing)
```


Cheers,
                     Nicolas



---

archive/issue_comments_162191.json:
```json
{
    "body": "Replying to [comment:10 nthiery]:\n> Near the TestSuite calls, I see things like:\n> {{{\n>     sage: loads(dumps(X)) is X\n>     True\n> }}}\n> This is a generic test, so I'd rather not include those, and if you feel strong about them to add it as a generic test in the TestSuite.\n\nI added it near the `TestSuite` calls, *because* it looks like a generic test (I argue below that it isn't really generic), and because the `TestSuite` does not (and can not, I think) cover it.\n\n> Maybe the X._test_pickling() should check whether X has unique representation, and test with `is` or `==` accordingly?\n> Or instead one could just check elsewhere that equality is indeed defined in term of ``is`` (like testting whether the __eq__ method is that inherited from UniqueRepresentation)\n\nI thought that to `TestSuite(X)` belong all generic tests that only depend on the category of X. But apparently `X.category()` will not tell whether X is a unique parent.\n\nMoreover, doing `if isinstance(self, UniqueRepresentation)` or testing the `__eq__` method would certainly not cover all unique parents. Namely some of them are created by a `UniqueFactory`. In that case, neither the category nor the class give a hint on whether pickling should work with `X is loads(dumps(X))`.\n\nJust think of polynomial rings: They are unique parents, but that's because of a polynomial ring constructor, and they do have\n\n```\n    cdef int _cmp_c_impl(left, Parent right) except -2:\n        if isinstance(right, (MPolynomialRing_libsingular, MPolynomialRing_polydict_domain)):\n            return cmp((left.base_ring(), map(str, left.gens()), left.term_order()),\n                       (right.base_ring(), map(str, right.gens()), right.term_order()))\n        else:\n            return cmp(type(left),type(right))\n```\n\n\nThe `X is loads(dumps(X))` thus *not* being generic, I think it clearly does not belong to `TestSuite(X)`. I do feel strongly about having that test in addition `TestSuite(X)`.\n\n> line 362: this should be `is_MPowerSeriesRing(S)`:\n> {{{\n>         if (is_MPolynomialRing(S) or is_MPowerSeriesRing)\n> }}}\n\nRight. And there should obviously be a test where `is_MPowerSeriesRing(S)` is needed.",
    "created_at": "2012-09-18T11:12:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162191",
    "user": "SimonKing"
}
```

Replying to [comment:10 nthiery]:
> Near the TestSuite calls, I see things like:
> {{{
>     sage: loads(dumps(X)) is X
>     True
> }}}
> This is a generic test, so I'd rather not include those, and if you feel strong about them to add it as a generic test in the TestSuite.

I added it near the `TestSuite` calls, *because* it looks like a generic test (I argue below that it isn't really generic), and because the `TestSuite` does not (and can not, I think) cover it.

> Maybe the X._test_pickling() should check whether X has unique representation, and test with `is` or `==` accordingly?
> Or instead one could just check elsewhere that equality is indeed defined in term of ``is`` (like testting whether the __eq__ method is that inherited from UniqueRepresentation)

I thought that to `TestSuite(X)` belong all generic tests that only depend on the category of X. But apparently `X.category()` will not tell whether X is a unique parent.

Moreover, doing `if isinstance(self, UniqueRepresentation)` or testing the `__eq__` method would certainly not cover all unique parents. Namely some of them are created by a `UniqueFactory`. In that case, neither the category nor the class give a hint on whether pickling should work with `X is loads(dumps(X))`.

Just think of polynomial rings: They are unique parents, but that's because of a polynomial ring constructor, and they do have

```
    cdef int _cmp_c_impl(left, Parent right) except -2:
        if isinstance(right, (MPolynomialRing_libsingular, MPolynomialRing_polydict_domain)):
            return cmp((left.base_ring(), map(str, left.gens()), left.term_order()),
                       (right.base_ring(), map(str, right.gens()), right.term_order()))
        else:
            return cmp(type(left),type(right))
```


The `X is loads(dumps(X))` thus *not* being generic, I think it clearly does not belong to `TestSuite(X)`. I do feel strongly about having that test in addition `TestSuite(X)`.

> line 362: this should be `is_MPowerSeriesRing(S)`:
> {{{
>         if (is_MPolynomialRing(S) or is_MPowerSeriesRing)
> }}}

Right. And there should obviously be a test where `is_MPowerSeriesRing(S)` is needed.



---

archive/issue_comments_162192.json:
```json
{
    "body": "Now I am totally puzzled. Apparently my tests for _coerce_map_from_ are all wrong, because the method is inherited from somewhere else!",
    "created_at": "2012-09-18T11:28:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162192",
    "user": "SimonKing"
}
```

Now I am totally puzzled. Apparently my tests for _coerce_map_from_ are all wrong, because the method is inherited from somewhere else!



---

archive/issue_comments_162193.json:
```json
{
    "body": "I see. There are two methods `_coerce_map_from_` -- and the second overrides the first (which I wrote).\n\nSince the second (i.e., the old) method seems to be correct, I'll just move my new tests to there.",
    "created_at": "2012-09-18T11:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162193",
    "user": "SimonKing"
}
```

I see. There are two methods `_coerce_map_from_` -- and the second overrides the first (which I wrote).

Since the second (i.e., the old) method seems to be correct, I'll just move my new tests to there.



---

archive/issue_comments_162194.json:
```json
{
    "body": "Implement category and coercion framework for power series rings",
    "created_at": "2012-09-18T11:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162194",
    "user": "SimonKing"
}
```

Implement category and coercion framework for power series rings



---

archive/issue_comments_162195.json:
```json
{
    "body": "Attachment [trac_13412_category_for_power_series_rings.patch](tarball://root/attachments/some-uuid/ticket13412/trac_13412_category_for_power_series_rings.patch) by SimonKing created at 2012-09-18 11:37:41\n\nOK, the patch is updated. I am running doctests now, with\n\n```\n$ hg qa\ntrac_715_combined.patch\ntrac_715_local_refcache.patch\ntrac_715_safer.patch\ntrac_715_specification.patch\ntrac_11521_homset_weakcache_combined.patch\ntrac_11521_callback.patch\n13145.patch\ntrac_13447-sanitise_ring_refcount.patch\ntrac12215_weak_cached_function-sk.patch\ntrac12215_segfault_fixes.patch\ntrac_12313-mono_dict-combined-random-sk.patch\ntrac_12313_quit_sage.patch\ntrac13370_deprecate_is_field.patch\ntrac_13378-convert_map_shortcut.patch\ntrac_13412_category_for_power_series_rings.patch\n```\n",
    "created_at": "2012-09-18T11:37:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162195",
    "user": "SimonKing"
}
```

Attachment [trac_13412_category_for_power_series_rings.patch](tarball://root/attachments/some-uuid/ticket13412/trac_13412_category_for_power_series_rings.patch) by SimonKing created at 2012-09-18 11:37:41

OK, the patch is updated. I am running doctests now, with

```
$ hg qa
trac_715_combined.patch
trac_715_local_refcache.patch
trac_715_safer.patch
trac_715_specification.patch
trac_11521_homset_weakcache_combined.patch
trac_11521_callback.patch
13145.patch
trac_13447-sanitise_ring_refcount.patch
trac12215_weak_cached_function-sk.patch
trac12215_segfault_fixes.patch
trac_12313-mono_dict-combined-random-sk.patch
trac_12313_quit_sage.patch
trac13370_deprecate_is_field.patch
trac_13378-convert_map_shortcut.patch
trac_13412_category_for_power_series_rings.patch
```




---

archive/issue_comments_162196.json:
```json
{
    "body": "Remove assignee nthiery.",
    "created_at": "2012-09-18T11:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162196",
    "user": "SimonKing"
}
```

Remove assignee nthiery.



---

archive/issue_comments_162197.json:
```json
{
    "body": "Tests work for me.",
    "created_at": "2012-09-18T11:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162197",
    "user": "SimonKing"
}
```

Tests work for me.



---

archive/issue_comments_162198.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-10-27T19:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162198",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_162199.json:
```json
{
    "body": "Everything looks good to me.",
    "created_at": "2012-10-27T19:39:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162199",
    "user": "tscrim"
}
```

Everything looks good to me.



---

archive/issue_comments_162200.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-06T22:22:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13240",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13240#issuecomment-162200",
    "user": "jdemeyer"
}
```

Resolution: fixed
