# Issue 13240: PowerSeriesRing should call Ring.__init__

Issue created by migration from https://trac.sagemath.org/ticket/13412

Original creator: SimonKing

Original creation time: 2012-08-30 08:09:30

Assignee: nthiery

CC:  nthiery niles

We have

```
sage: A.<a,b> = PowerSeriesRing(QQ)
sage: A._is_category_initialized()
False
sage: isinstance(A,Ring)
True
```


Since `Ring.__init__` initialises the category, it seems that the the base class' initialisation is not called. That also prevents us from removing the alias for `_Hom_` in sage.rings.ring - see #12876.


---

Comment by nthiery created at 2012-08-30 08:26:06

+1

Just 2 cents: alternatively, it could possibly call Parent.__init__ but passing down the appropriate category.


---

Comment by SimonKing created at 2012-08-30 10:12:47

I think I'll even be getting category and coercion framework right (there was `__call__`, there was no `self.Element`, there was no `_coerce_map_from_`). With the patch I'm preparing:

```
sage: A.<a> = PowerSeriesRing(QQ)
sage: TestSuite(A).run()
sage: A.<a,b> = PowerSeriesRing(QQ)
sage: TestSuite(A).run()
```


Need to document the new stuff, though.


---

Comment by SimonKing created at 2012-08-30 10:13:44

PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.


---

Comment by nthiery created at 2012-08-30 10:16:42

Replying to [comment:3 SimonKing]:
> PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.

Neat!

It's kind of you to be going the extra mile!


---

Comment by SimonKing created at 2012-08-30 10:50:24

Replying to [comment:4 nthiery]:
> Replying to [comment:3 SimonKing]:
> > PS: I also made the power series rings `UniqueRepresentation`, getting rid of the custom cache.
> 
> Neat!
> 
> It's kind of you to be going the extra mile!

No, that's more like going by car. At first, I tried to fix the `TestSuite` by implementing `__reduce__`, which didn't work well. Inheriting from `UniqueRepresentation` did the trick.


---

Comment by nthiery created at 2012-08-30 11:18:49

> No, that's more like going by car. At first, I tried to fix the `TestSuite` by implementing `__reduce__`, which didn't work well. Inheriting from `UniqueRepresentation` did the trick.

:-)

Hopefuly the previous reduce was good enough that there won't be issues with the pickles from the pickle jar.


---

Comment by SimonKing created at 2012-08-30 12:30:19

Replying to [comment:6 nthiery]:
> Hopefuly the previous reduce was good enough that there won't be issues with the pickles from the pickle jar.

Well, the pickle jar is doctested, plus it won't break unless I remove the unpickling function used in the old pickles (which I don't).


---

Comment by SimonKing created at 2012-08-30 13:11:28

Changing status from new to needs_review.


---

Comment by SimonKing created at 2012-08-30 13:11:28

Changing keywords from "" to "power series, coercion, category".


---

Comment by SimonKing created at 2012-08-30 13:11:28

Cc to the original author (hi Niles).

The patch implements using the category and coercion framework for uni- and multi-variate power series rings. For me, tests pass (but I have a lot of other patches applied as well, so, better you or the patchbot test it as well).


---

Comment by SimonKing created at 2012-09-18 09:05:28

Any reviewer for making power series rings "nicer", from a categorical point of view?


---

Comment by nthiery created at 2012-09-18 10:38:09

Hi Simon,

I am not sure I'll get through the review, but I am now browsing through the patch while Sage compiles C3. Here are some little comments:

Near the TestSuite calls, I see things like:

```
    sage: loads(dumps(X)) is X
    True
```

This is a generic test, so I'd rather not include those, and if you feel strong about them to add it as a generic test in the TestSuite. Maybe the X._test_pickling() should check whether X has unique representation, and test with `is` or `==` accordingly? Or instead one could just check elsewhere that equality is indeed defined in term of ``is`` (like testting whether the __eq__ method is that inherited from UniqueRepresentation)

line 362: this should be `is_MPowerSeriesRing(S)`:

```
        if (is_MPolynomialRing(S) or is_MPowerSeriesRing)
```


Cheers,
                     Nicolas


---

Comment by SimonKing created at 2012-09-18 11:12:03

Replying to [comment:10 nthiery]:
> Near the TestSuite calls, I see things like:
> {{{
>     sage: loads(dumps(X)) is X
>     True
> }}}
> This is a generic test, so I'd rather not include those, and if you feel strong about them to add it as a generic test in the TestSuite.

I added it near the `TestSuite` calls, _because_ it looks like a generic test (I argue below that it isn't really generic), and because the `TestSuite` does not (and can not, I think) cover it.

> Maybe the X._test_pickling() should check whether X has unique representation, and test with `is` or `==` accordingly?
> Or instead one could just check elsewhere that equality is indeed defined in term of ``is`` (like testting whether the __eq__ method is that inherited from UniqueRepresentation)

I thought that to `TestSuite(X)` belong all generic tests that only depend on the category of X. But apparently `X.category()` will not tell whether X is a unique parent.

Moreover, doing `if isinstance(self, UniqueRepresentation)` or testing the `__eq__` method would certainly not cover all unique parents. Namely some of them are created by a `UniqueFactory`. In that case, neither the category nor the class give a hint on whether pickling should work with `X is loads(dumps(X))`.

Just think of polynomial rings: They are unique parents, but that's because of a polynomial ring constructor, and they do have

```
    cdef int _cmp_c_impl(left, Parent right) except -2:
        if isinstance(right, (MPolynomialRing_libsingular, MPolynomialRing_polydict_domain)):
            return cmp((left.base_ring(), map(str, left.gens()), left.term_order()),
                       (right.base_ring(), map(str, right.gens()), right.term_order()))
        else:
            return cmp(type(left),type(right))
```


The `X is loads(dumps(X))` thus _not_ being generic, I think it clearly does not belong to `TestSuite(X)`. I do feel strongly about having that test in addition `TestSuite(X)`.

> line 362: this should be `is_MPowerSeriesRing(S)`:
> {{{
>         if (is_MPolynomialRing(S) or is_MPowerSeriesRing)
> }}}

Right. And there should obviously be a test where `is_MPowerSeriesRing(S)` is needed.


---

Comment by SimonKing created at 2012-09-18 11:28:12

Now I am totally puzzled. Apparently my tests for _coerce_map_from_ are all wrong, because the method is inherited from somewhere else!


---

Comment by SimonKing created at 2012-09-18 11:33:01

I see. There are two methods `_coerce_map_from_` -- and the second overrides the first (which I wrote).

Since the second (i.e., the old) method seems to be correct, I'll just move my new tests to there.


---

Comment by SimonKing created at 2012-09-18 11:37:03

Implement category and coercion framework for power series rings


---

Attachment

OK, the patch is updated. I am running doctests now, with

```
$ hg qa
trac_715_combined.patch
trac_715_local_refcache.patch
trac_715_safer.patch
trac_715_specification.patch
trac_11521_homset_weakcache_combined.patch
trac_11521_callback.patch
13145.patch
trac_13447-sanitise_ring_refcount.patch
trac12215_weak_cached_function-sk.patch
trac12215_segfault_fixes.patch
trac_12313-mono_dict-combined-random-sk.patch
trac_12313_quit_sage.patch
trac13370_deprecate_is_field.patch
trac_13378-convert_map_shortcut.patch
trac_13412_category_for_power_series_rings.patch
```



---

Comment by SimonKing created at 2012-09-18 11:55:12

Remove assignee nthiery.


---

Comment by SimonKing created at 2012-09-18 11:55:12

Tests work for me.


---

Comment by tscrim created at 2012-10-27 19:39:29

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2012-10-27 19:39:29

Everything looks good to me.


---

Comment by jdemeyer created at 2012-11-06 22:22:07

Resolution: fixed
