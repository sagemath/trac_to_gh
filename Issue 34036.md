# Issue 34036: opensuse-tumbleweed: python3 build fails because of openssl

archive/issues_034036.json:
```json
{
    "body": "CC:  tmonteil @dimpase\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34273\n\n",
    "created_at": "2022-08-03T23:56:27Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "opensuse-tumbleweed: python3 build fails because of openssl",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34036",
    "user": "https://github.com/mkoeppe"
}
```
CC:  tmonteil @dimpase



Issue created by migration from https://trac.sagemath.org/ticket/34273





---

archive/issue_comments_482515.json:
```json
{
    "body": "\n```\nconfigure:17891: gcc -o conftest  -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration -fvisibility=hidden   -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib   conftest.c -lcrypt -ldl  -lm -lssl -lcrypto  >&5\nconftest.c: In function 'main':\nconftest.c:442:12: error: 'NID_sha3_512' undeclared (first use in this function); did you mean 'NID_sha512'?\n  442 | OBJ_nid2sn(NID_sha3_512);\n      |            ^~~~~~~~~~~~\n      |            NID_sha512\nconftest.c:442:12: note: each undeclared identifier is reported only once for each function it appears in\nconftest.c:443:12: error: 'NID_blake2b512' undeclared (first use in this function)\n  443 | OBJ_nid2sn(NID_blake2b512);\n      |            ^~~~~~~~~~~~~~\nconftest.c:444:1: error: implicit declaration of function 'EVP_PBE_scrypt'; did you mean 'EVP_PKEY_decrypt'? [-Werror=implicit-function-declaration]\n  444 | EVP_PBE_scrypt(NULL, 0, NULL, 0, 2, 8, 1, 0, NULL, 0);\n      | ^~~~~~~~~~~~~~\n      | EVP_PKEY_decrypt\ncc1: some warnings being treated as errors\nconfigure:17891: $? = 1\n```\n",
    "created_at": "2022-08-04T00:05:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482515",
    "user": "https://github.com/mkoeppe"
}
```


```
configure:17891: gcc -o conftest  -std=c99 -Wextra -Wno-unused-result -Wno-unused-parameter -Wno-missing-field-initializers -Werror=implicit-function-declaration -fvisibility=hidden   -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib -Wl,-rpath-link,/sage/local/lib -L/sage/local/lib -Wl,-rpath,/sage/local/lib   conftest.c -lcrypt -ldl  -lm -lssl -lcrypto  >&5
conftest.c: In function 'main':
conftest.c:442:12: error: 'NID_sha3_512' undeclared (first use in this function); did you mean 'NID_sha512'?
  442 | OBJ_nid2sn(NID_sha3_512);
      |            ^~~~~~~~~~~~
      |            NID_sha512
conftest.c:442:12: note: each undeclared identifier is reported only once for each function it appears in
conftest.c:443:12: error: 'NID_blake2b512' undeclared (first use in this function)
  443 | OBJ_nid2sn(NID_blake2b512);
      |            ^~~~~~~~~~~~~~
conftest.c:444:1: error: implicit declaration of function 'EVP_PBE_scrypt'; did you mean 'EVP_PKEY_decrypt'? [-Werror=implicit-function-declaration]
  444 | EVP_PBE_scrypt(NULL, 0, NULL, 0, 2, 8, 1, 0, NULL, 0);
      | ^~~~~~~~~~~~~~
      | EVP_PKEY_decrypt
cc1: some warnings being treated as errors
configure:17891: $? = 1
```




---

archive/issue_comments_482516.json:
```json
{
    "body": "We should probably explicitly install `libopenssl-3-devel`",
    "created_at": "2022-08-04T00:12:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482516",
    "user": "https://github.com/mkoeppe"
}
```

We should probably explicitly install `libopenssl-3-devel`



---

archive/issue_comments_482517.json:
```json
{
    "body": "We should probably get the more detailed configure check from Python:\nhttps://github.com/python/cpython/blob/main/configure.ac#L6823\n----\nNew commits:",
    "created_at": "2022-08-04T00:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482517",
    "user": "https://github.com/mkoeppe"
}
```

We should probably get the more detailed configure check from Python:
https://github.com/python/cpython/blob/main/configure.ac#L6823
----
New commits:



---

archive/issue_comments_482518.json:
```json
{
    "body": "or rather https://github.com/python/cpython/blob/3.10/configure.ac#L5845",
    "created_at": "2022-08-04T00:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482518",
    "user": "https://github.com/mkoeppe"
}
```

or rather https://github.com/python/cpython/blob/3.10/configure.ac#L5845



---

archive/issue_comments_482519.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-04T00:33:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482519",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482520.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-04T00:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482520",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_482521.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-04T00:48:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482521",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_482522.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-04T01:35:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482522",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_482523.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-08-04T01:36:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482523",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_482524.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-04T01:36:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482524",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_482525.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2022-08-04T01:37:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482525",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_482526.json:
```json
{
    "body": "This fixes it. Let's get it in",
    "created_at": "2022-08-05T03:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482526",
    "user": "https://github.com/mkoeppe"
}
```

This fixes it. Let's get it in



---

archive/issue_comments_482527.json:
```json
{
    "body": "Changing priority from critical to blocker.",
    "created_at": "2022-08-07T23:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482527",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from critical to blocker.



---

archive/issue_comments_482528.json:
```json
{
    "body": "I ran the test and got: `docker-opensuse-tumbleweed-standard: commands succeeded`.\n\nI am new to this business, and let me ask some naive questions. What was the sign of failure (of `LibreSSL`)? From the tox test, I still get \n\n```\n[python3-3.10.5] checking whether compiling and linking against OpenSSL works... yes\n[python3-3.10.5] checking for --with-openssl-rpath... \n[python3-3.10.5] checking whether OpenSSL provides required APIs... yes\n[python3-3.10.5] checking for --with-ssl-default-suites... python\n[python3-3.10.5] checking for --with-builtin-hashlib-hashes... md5,sha1,sha256,sha512,sha3,blake2\n[python3-3.10.5] checking for --with-experimental-isolated-subinterpreters... no\n[python3-3.10.5] checking for --with-static-libpython... yes\n[python3-3.10.5] checking for --disable-test-modules... no\n```\n\nwhich seems not much different from the excerpt in the ticket description... How do I check if `libopenssl-3-devel` works with python3 well? Is the message `Sage build/upgrade complete!` enough?",
    "created_at": "2022-08-08T11:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482528",
    "user": "https://github.com/kwankyu"
}
```

I ran the test and got: `docker-opensuse-tumbleweed-standard: commands succeeded`.

I am new to this business, and let me ask some naive questions. What was the sign of failure (of `LibreSSL`)? From the tox test, I still get 

```
[python3-3.10.5] checking whether compiling and linking against OpenSSL works... yes
[python3-3.10.5] checking for --with-openssl-rpath... 
[python3-3.10.5] checking whether OpenSSL provides required APIs... yes
[python3-3.10.5] checking for --with-ssl-default-suites... python
[python3-3.10.5] checking for --with-builtin-hashlib-hashes... md5,sha1,sha256,sha512,sha3,blake2
[python3-3.10.5] checking for --with-experimental-isolated-subinterpreters... no
[python3-3.10.5] checking for --with-static-libpython... yes
[python3-3.10.5] checking for --disable-test-modules... no
```

which seems not much different from the excerpt in the ticket description... How do I check if `libopenssl-3-devel` works with python3 well? Is the message `Sage build/upgrade complete!` enough?



---

archive/issue_comments_482529.json:
```json
{
    "body": "Thanks for testing!\n\nThe crucial line in python3's configure output is this:\n\n```\n[python3-3.10.5] checking whether OpenSSL provides required APIs... yes\n```\n\n... which has changed from \"no\".\n\nI should have added a link to a failing build for reference. In https://github.com/sagemath/sage/actions, selecting \"CI Linux\", there is a completed run for 9.7.beta7, https://github.com/sagemath/sage/actions/runs/2777704621\n\nSelecting \"docker / linux (opensuse-tumbleweed, standard)\" from the sidebar, one gets to https://github.com/sagemath/sage/runs/7619552751, which shows the end of the failing build of the `python3` SPKG:\n\n```\n  [python3-3.10.5]   \n  [python3-3.10.5]   Failed to build these modules:\n  [python3-3.10.5]   _hashlib              _ssl                                     \n  [python3-3.10.5]   \n  [python3-3.10.5]   \n  [python3-3.10.5]   Could not build the ssl module!\n  [python3-3.10.5]   Python requires a OpenSSL 1.1.1 or newer\n  [python3-3.10.5]   \n  ...\n  [python3-3.10.5]   Testing importing of various modules...\n  [python3-3.10.5]   ctypes module imported OK\n  [python3-3.10.5]   math module imported OK\n  [python3-3.10.5]   hashlib module imported OK\n  [python3-3.10.5]   crypt module imported OK\n  [python3-3.10.5]   socket module imported OK\n  [python3-3.10.5]   zlib module imported OK\n  [python3-3.10.5]   sqlite3 module imported OK\n  [python3-3.10.5]   Traceback (most recent call last):\n  [python3-3.10.5]     File \"<string>\", line 1, in <module>\n  [python3-3.10.5]     File \"/sage/local/var/lib/sage/venv-python3.10.5/var/tmp/sage/build/python3-3.10.5/src/Lib/ssl.py\", line 99, in <module>\n  [python3-3.10.5]       import _ssl             # if we can't import it, let the error propagate\n  [python3-3.10.5]   ModuleNotFoundError: No module named '_ssl'\n  [python3-3.10.5]   ssl module failed to import\n  [python3-3.10.5]   Error: One or more modules failed to import.\n  [python3-3.10.5]   \n  [python3-3.10.5]   real\t5m46.942s\n  [python3-3.10.5]   user\t2m41.648s\n  [python3-3.10.5]   sys\t0m17.654s\n  [python3-3.10.5]   ************************************************************************\n  [python3-3.10.5]   Error building package python3-3.10.5\n  [python3-3.10.5]   ************************************************************************\n  [python3-3.10.5] Full log file: /sage/logs/pkgs/python3-3.10.5.log\nmake[2]: *** [Makefile:2930: python3-SAGE_VENV-no-deps] Error 1\n```\n\nWhat happened there is that Python did not build the `_ssl` module because it did not find a suitable openssl. Python reports this with the message \"Could not build the ssl module!\" This is only an info message.\n\nOur script https://github.com/sagemath/sage/blob/develop/build/pkgs/python3/spkg-build.in#L120 then checks again for the required modules and exits with an error.\n\n> How do I check if libopenssl-3-devel works with python3 well? Is the message Sage build/upgrade complete! enough?\n\nI would say it is not necessary to do more testing than what our build script does.",
    "created_at": "2022-08-08T14:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482529",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for testing!

The crucial line in python3's configure output is this:

```
[python3-3.10.5] checking whether OpenSSL provides required APIs... yes
```

... which has changed from "no".

I should have added a link to a failing build for reference. In https://github.com/sagemath/sage/actions, selecting "CI Linux", there is a completed run for 9.7.beta7, https://github.com/sagemath/sage/actions/runs/2777704621

Selecting "docker / linux (opensuse-tumbleweed, standard)" from the sidebar, one gets to https://github.com/sagemath/sage/runs/7619552751, which shows the end of the failing build of the `python3` SPKG:

```
  [python3-3.10.5]   
  [python3-3.10.5]   Failed to build these modules:
  [python3-3.10.5]   _hashlib              _ssl                                     
  [python3-3.10.5]   
  [python3-3.10.5]   
  [python3-3.10.5]   Could not build the ssl module!
  [python3-3.10.5]   Python requires a OpenSSL 1.1.1 or newer
  [python3-3.10.5]   
  ...
  [python3-3.10.5]   Testing importing of various modules...
  [python3-3.10.5]   ctypes module imported OK
  [python3-3.10.5]   math module imported OK
  [python3-3.10.5]   hashlib module imported OK
  [python3-3.10.5]   crypt module imported OK
  [python3-3.10.5]   socket module imported OK
  [python3-3.10.5]   zlib module imported OK
  [python3-3.10.5]   sqlite3 module imported OK
  [python3-3.10.5]   Traceback (most recent call last):
  [python3-3.10.5]     File "<string>", line 1, in <module>
  [python3-3.10.5]     File "/sage/local/var/lib/sage/venv-python3.10.5/var/tmp/sage/build/python3-3.10.5/src/Lib/ssl.py", line 99, in <module>
  [python3-3.10.5]       import _ssl             # if we can't import it, let the error propagate
  [python3-3.10.5]   ModuleNotFoundError: No module named '_ssl'
  [python3-3.10.5]   ssl module failed to import
  [python3-3.10.5]   Error: One or more modules failed to import.
  [python3-3.10.5]   
  [python3-3.10.5]   real	5m46.942s
  [python3-3.10.5]   user	2m41.648s
  [python3-3.10.5]   sys	0m17.654s
  [python3-3.10.5]   ************************************************************************
  [python3-3.10.5]   Error building package python3-3.10.5
  [python3-3.10.5]   ************************************************************************
  [python3-3.10.5] Full log file: /sage/logs/pkgs/python3-3.10.5.log
make[2]: *** [Makefile:2930: python3-SAGE_VENV-no-deps] Error 1
```

What happened there is that Python did not build the `_ssl` module because it did not find a suitable openssl. Python reports this with the message "Could not build the ssl module!" This is only an info message.

Our script https://github.com/sagemath/sage/blob/develop/build/pkgs/python3/spkg-build.in#L120 then checks again for the required modules and exits with an error.

> How do I check if libopenssl-3-devel works with python3 well? Is the message Sage build/upgrade complete! enough?

I would say it is not necessary to do more testing than what our build script does.



---

archive/issue_comments_482530.json:
```json
{
    "body": "Replying to [comment:19 mkoeppe]:\n> I would say it is not necessary to do more testing than what our build script does. \n\nOkay. Now I understand the situation better. So the success of the tox test has shown that your branch works well (otherwise python build script would have failed). \n\nThe relevant github workflow is still running. So let us wait for the result to double-check.\n\nThe branch itself seems good as far as I can judge.",
    "created_at": "2022-08-08T14:51:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482530",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:19 mkoeppe]:
> I would say it is not necessary to do more testing than what our build script does. 

Okay. Now I understand the situation better. So the success of the tox test has shown that your branch works well (otherwise python build script would have failed). 

The relevant github workflow is still running. So let us wait for the result to double-check.

The branch itself seems good as far as I can judge.



---

archive/issue_comments_482531.json:
```json
{
    "body": "Another test would be to install `pkgconfig(libssl)` system package, and to check if the configure correctly decide to install openssl from source. Right?\n\nIt is quite out of my technical reach though. Have you tried it?",
    "created_at": "2022-08-08T15:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482531",
    "user": "https://github.com/kwankyu"
}
```

Another test would be to install `pkgconfig(libssl)` system package, and to check if the configure correctly decide to install openssl from source. Right?

It is quite out of my technical reach though. Have you tried it?



---

archive/issue_comments_482532.json:
```json
{
    "body": "Yes, I tested this. If you want to test it, you can just `git revert \tde3e0f3d5d405ef0f255aaf6d9934f86c72fcca7` and then run `tox -e docker-opensuse-tumbleweed-standard -- config.status`",
    "created_at": "2022-08-08T15:11:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482532",
    "user": "https://github.com/mkoeppe"
}
```

Yes, I tested this. If you want to test it, you can just `git revert 	de3e0f3d5d405ef0f255aaf6d9934f86c72fcca7` and then run `tox -e docker-opensuse-tumbleweed-standard -- config.status`



---

archive/issue_comments_482533.json:
```json
{
    "body": "Replying to [comment:22 mkoeppe]:\n> Yes, I tested this. If you want to test it, you can just `git revert \tde3e0f3d5d405ef0f255aaf6d9934f86c72fcca7` and then run `tox -e docker-opensuse-tumbleweed-standard -- config.status`\n\nAh, easy. I did it, and the configure worked correctly.",
    "created_at": "2022-08-09T00:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482533",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:22 mkoeppe]:
> Yes, I tested this. If you want to test it, you can just `git revert 	de3e0f3d5d405ef0f255aaf6d9934f86c72fcca7` and then run `tox -e docker-opensuse-tumbleweed-standard -- config.status`

Ah, easy. I did it, and the configure worked correctly.



---

archive/issue_comments_482534.json:
```json
{
    "body": "Replying to [comment:20 klee]:\n> The relevant github workflow is still running. So let us wait for the result to double-check.\n\nIt would take too long to get the result. As this is simply double-checking the correct result I got locally, I will skip it.\n\nThen, positive review to this ticket.",
    "created_at": "2022-08-09T00:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482534",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:20 klee]:
> The relevant github workflow is still running. So let us wait for the result to double-check.

It would take too long to get the result. As this is simply double-checking the correct result I got locally, I will skip it.

Then, positive review to this ticket.



---

archive/issue_comments_482535.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-09T00:30:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482535",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_482536.json:
```json
{
    "body": "Thank you!",
    "created_at": "2022-08-09T00:37:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482536",
    "user": "https://github.com/mkoeppe"
}
```

Thank you!



---

archive/issue_comments_482537.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-29T11:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34036",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34036#issuecomment-482537",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
