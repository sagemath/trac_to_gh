# Issue 30509: sage.doctest.control: Replace use of sage.misc.package.list_packages

archive/issues_030509.json:
```json
{
    "body": "CC:  arojas fbissey simonking dimpase jhpalmieri @kliem tscrim klee mjo\n\n... by features.\n\nThis is so that users can make use of doctests conditionalized with \"# optional\" in their Sage programs even on distribution-packaged Sage installations.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30746\n\n",
    "created_at": "2020-10-08T17:06:22Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage.doctest.control: Replace use of sage.misc.package.list_packages",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30509",
    "user": "mkoeppe"
}
```
CC:  arojas fbissey simonking dimpase jhpalmieri @kliem tscrim klee mjo

... by features.

This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations.

Issue created by migration from https://trac.sagemath.org/ticket/30746





---

archive/issue_comments_435526.json:
```json
{
    "body": "How do distributions handle this currently?",
    "created_at": "2020-10-08T17:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435526",
    "user": "mkoeppe"
}
```

How do distributions handle this currently?



---

archive/issue_comments_435527.json:
```json
{
    "body": "I'm patching it out completely\n\nhttps://github.com/archlinux/svntogit-community/blob/packages/sagemath/trunk/test-optional.patch\n\nso tests depending on optional packages are skipped unless explicitely specified in the `sage -t` command",
    "created_at": "2020-10-08T17:21:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435527",
    "user": "arojas"
}
```

I'm patching it out completely

https://github.com/archlinux/svntogit-community/blob/packages/sagemath/trunk/test-optional.patch

so tests depending on optional packages are skipped unless explicitely specified in the `sage -t` command



---

archive/issue_comments_435528.json:
```json
{
    "body": "Replying to [comment:1 mkoeppe]:\n> How do distributions handle this currently?\n\nI don't know about others but I do it badly. The current stuff allow some autodetection of what is installed by the sage package management system. That was not always the case. I remove the autodetection bits and add anything I want to test manually when running `sage -t`.",
    "created_at": "2020-10-08T19:26:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435528",
    "user": "fbissey"
}
```

Replying to [comment:1 mkoeppe]:
> How do distributions handle this currently?

I don't know about others but I do it badly. The current stuff allow some autodetection of what is installed by the sage package management system. That was not always the case. I remove the autodetection bits and add anything I want to test manually when running `sage -t`.



---

archive/issue_comments_435529.json:
```json
{
    "body": "(wrong ticket)",
    "created_at": "2020-11-12T20:03:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435529",
    "user": "mkoeppe"
}
```

(wrong ticket)



---

archive/issue_comments_435530.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435530",
    "user": "mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_435531.json:
```json
{
    "body": "Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111",
    "created_at": "2020-12-06T18:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435531",
    "user": "mkoeppe"
}
```

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111



---

archive/issue_comments_435532.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435532",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_435533.json:
```json
{
    "body": "Why the dependency on #20879? I am assuming this is a typo or the wrong ticket.",
    "created_at": "2021-07-09T00:04:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435533",
    "user": "fbissey"
}
```

Why the dependency on #20879? I am assuming this is a typo or the wrong ticket.



---

archive/issue_comments_435534.json:
```json
{
    "body": "Yes, wrong ticket, I meant #30887.",
    "created_at": "2021-07-09T00:09:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435534",
    "user": "mkoeppe"
}
```

Yes, wrong ticket, I meant #30887.



---

archive/issue_comments_435535.json:
```json
{
    "body": "I'm just seeing this now after wondering why sage keeps searching my system for random broken programs to try to use. Runtime detection of these things will not be a good long-term approach:\n\n1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.\n2. Runtime checks are run over and over again. And many are going to be slow, once they are made to return the right answers.\n3. Distros track dependencies and usually don't want them to (dis)appear at runtime.\n4. If I build sage with e.g. `--disable-lrslib`, I expect it to not search my system for something that looks like lrslib and use it anyway. There has to be a way to reliably disable things.\n\nAs an alternative, you can imagine a shared location where \"features\" record their existence (think pkg-config). The simplest implementation might be to create a file named after the feature to indicate that the feature is present.\n\nOptional packages would touch `$FEATURESDIR/$PACKAGE` upon being detected or installed. That centralizes all of the detection code in spkg-configure.m4, and would eventually make `--disable-foo` work again. Distros could install a \"feature file\" for every feature that their distro package provides. Or if they don't mind the automagic dependencies, you could have (say) the \"ffmpeg\" package install the ffmpeg feature file to tell sage that ffmpeg is available. Of course this would only be done if the distro's ffmpeg package actually works with its sage. But it does allow the user to add features on a binary distro on-the-fly without the developers having to jump through too many hoops. (On Gentoo we might just make you rebuild with `USE=feature` to enable it and encode the dependency.)\n\nDepending on the scenario, this essentially runs the \"feature check\" either once or never, as `[ -f $feature ]` is free. Thus we avoid wasting time on every invocation of `sage -t`.\n\nThe file-based implementation here is not well-thought-out and probably has flaws, but it's also not what's important. What is is that the features should respect the user/distro configuration, not waste too many resources, not cause surprises, and not require any unnecessary duplication (i.e. work). Moving towards runtime-only detection is IMHO moving backwards.",
    "created_at": "2022-01-15T04:37:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435535",
    "user": "mjo"
}
```

I'm just seeing this now after wondering why sage keeps searching my system for random broken programs to try to use. Runtime detection of these things will not be a good long-term approach:

1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.
2. Runtime checks are run over and over again. And many are going to be slow, once they are made to return the right answers.
3. Distros track dependencies and usually don't want them to (dis)appear at runtime.
4. If I build sage with e.g. `--disable-lrslib`, I expect it to not search my system for something that looks like lrslib and use it anyway. There has to be a way to reliably disable things.

As an alternative, you can imagine a shared location where "features" record their existence (think pkg-config). The simplest implementation might be to create a file named after the feature to indicate that the feature is present.

Optional packages would touch `$FEATURESDIR/$PACKAGE` upon being detected or installed. That centralizes all of the detection code in spkg-configure.m4, and would eventually make `--disable-foo` work again. Distros could install a "feature file" for every feature that their distro package provides. Or if they don't mind the automagic dependencies, you could have (say) the "ffmpeg" package install the ffmpeg feature file to tell sage that ffmpeg is available. Of course this would only be done if the distro's ffmpeg package actually works with its sage. But it does allow the user to add features on a binary distro on-the-fly without the developers having to jump through too many hoops. (On Gentoo we might just make you rebuild with `USE=feature` to enable it and encode the dependency.)

Depending on the scenario, this essentially runs the "feature check" either once or never, as `[ -f $feature ]` is free. Thus we avoid wasting time on every invocation of `sage -t`.

The file-based implementation here is not well-thought-out and probably has flaws, but it's also not what's important. What is is that the features should respect the user/distro configuration, not waste too many resources, not cause surprises, and not require any unnecessary duplication (i.e. work). Moving towards runtime-only detection is IMHO moving backwards.



---

archive/issue_comments_435536.json:
```json
{
    "body": "+1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.\n\n-1 on defining file system stuff, config files, etc.",
    "created_at": "2022-01-15T05:53:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435536",
    "user": "mkoeppe"
}
```

+1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.

-1 on defining file system stuff, config files, etc.



---

archive/issue_comments_435537.json:
```json
{
    "body": "Replying to [comment:22 mjo]:\n> 1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.\n\nA more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at `./configure` time, we can replace many `spkg-configure.m4` tests by Feature tests, written in Python.",
    "created_at": "2022-01-15T05:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435537",
    "user": "mkoeppe"
}
```

Replying to [comment:22 mjo]:
> 1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.

A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at `./configure` time, we can replace many `spkg-configure.m4` tests by Feature tests, written in Python.



---

archive/issue_comments_435538.json:
```json
{
    "body": "Replying to [comment:23 mkoeppe]:\n> +1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.\n> \n> -1 on defining file system stuff, config files, etc.\n> \n\nWith sleep comes clarity. Instead of something like pkg-config, why don't we literally use pkg-config for this? To each feature, associate `sage-$feature.pc`. This meets all the criteria above without any hacky wheel reinventing. Distros are already familiar with the concept. `PKG_CONFIG_PATH` tricks should let us avoid version mismatch issues when, say, a git checkout is used on a system where a distro sage is also installed.\n\n> A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. \n\nMaybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.",
    "created_at": "2022-01-15T13:51:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435538",
    "user": "mjo"
}
```

Replying to [comment:23 mkoeppe]:
> +1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.
> 
> -1 on defining file system stuff, config files, etc.
> 

With sleep comes clarity. Instead of something like pkg-config, why don't we literally use pkg-config for this? To each feature, associate `sage-$feature.pc`. This meets all the criteria above without any hacky wheel reinventing. Distros are already familiar with the concept. `PKG_CONFIG_PATH` tricks should let us avoid version mismatch issues when, say, a git checkout is used on a system where a distro sage is also installed.

> A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. 

Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.



---

archive/issue_comments_435539.json:
```json
{
    "body": "Replying to [comment:25 mjo]:\n> > A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. \n> \n> Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.\n\nThe trickiest `spkg-configure.m4` tests are for compile-time stuff - existence of libraries and such - and they do not need to be implemented in `sage.features`.",
    "created_at": "2022-01-15T16:22:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435539",
    "user": "mkoeppe"
}
```

Replying to [comment:25 mjo]:
> > A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. 
> 
> Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.

The trickiest `spkg-configure.m4` tests are for compile-time stuff - existence of libraries and such - and they do not need to be implemented in `sage.features`.



---

archive/issue_comments_435540.json:
```json
{
    "body": "A possible solution could be to go through #31277.",
    "created_at": "2022-01-15T19:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30509#issuecomment-435540",
    "user": "mkoeppe"
}
```

A possible solution could be to go through #31277.
