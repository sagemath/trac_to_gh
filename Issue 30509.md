# Issue 30509: sage.doctest.control: Replace use of sage.misc.package.list_packages

Issue created by migration from https://trac.sagemath.org/ticket/30746

Original creator: mkoeppe

Original creation time: 2020-10-08 17:06:22

CC:  arojas fbissey simonking dimpase jhpalmieri @kliem tscrim klee mjo

... by features.

This is so that users can make use of doctests conditionalized with "# optional" in their Sage programs even on distribution-packaged Sage installations.


---

Comment by mkoeppe created at 2020-10-08 17:06:55

How do distributions handle this currently?


---

Comment by arojas created at 2020-10-08 17:21:22

I'm patching it out completely

https://github.com/archlinux/svntogit-community/blob/packages/sagemath/trunk/test-optional.patch

so tests depending on optional packages are skipped unless explicitely specified in the `sage -t` command


---

Comment by fbissey created at 2020-10-08 19:26:06

Replying to [comment:1 mkoeppe]:
> How do distributions handle this currently?

I don't know about others but I do it badly. The current stuff allow some autodetection of what is installed by the sage package management system. That was not always the case. I remove the autodetection bits and add anything I want to test manually when running `sage -t`.


---

Comment by mkoeppe created at 2020-11-12 20:03:45

(wrong ticket)


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by fbissey created at 2021-07-09 00:04:47

Why the dependency on #20879? I am assuming this is a typo or the wrong ticket.


---

Comment by mkoeppe created at 2021-07-09 00:09:16

Yes, wrong ticket, I meant #30887.


---

Comment by mjo created at 2022-01-15 04:37:51

I'm just seeing this now after wondering why sage keeps searching my system for random broken programs to try to use. Runtime detection of these things will not be a good long-term approach:

1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.
2. Runtime checks are run over and over again. And many are going to be slow, once they are made to return the right answers.
3. Distros track dependencies and usually don't want them to (dis)appear at runtime.
4. If I build sage with e.g. `--disable-lrslib`, I expect it to not search my system for something that looks like lrslib and use it anyway. There has to be a way to reliably disable things.

As an alternative, you can imagine a shared location where "features" record their existence (think pkg-config). The simplest implementation might be to create a file named after the feature to indicate that the feature is present.

Optional packages would touch `$FEATURESDIR/$PACKAGE` upon being detected or installed. That centralizes all of the detection code in spkg-configure.m4, and would eventually make `--disable-foo` work again. Distros could install a "feature file" for every feature that their distro package provides. Or if they don't mind the automagic dependencies, you could have (say) the "ffmpeg" package install the ffmpeg feature file to tell sage that ffmpeg is available. Of course this would only be done if the distro's ffmpeg package actually works with its sage. But it does allow the user to add features on a binary distro on-the-fly without the developers having to jump through too many hoops. (On Gentoo we might just make you rebuild with `USE=feature` to enable it and encode the dependency.)

Depending on the scenario, this essentially runs the "feature check" either once or never, as `[ -f $feature ]` is free. Thus we avoid wasting time on every invocation of `sage -t`.

The file-based implementation here is not well-thought-out and probably has flaws, but it's also not what's important. What is is that the features should respect the user/distro configuration, not waste too many resources, not cause surprises, and not require any unnecessary duplication (i.e. work). Moving towards runtime-only detection is IMHO moving backwards.


---

Comment by mkoeppe created at 2022-01-15 05:53:11

+1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.

-1 on defining file system stuff, config files, etc.


---

Comment by mkoeppe created at 2022-01-15 05:55:12

Replying to [comment:22 mjo]:
> 1. You have to reimplement every spkg-configure.m4 in python for the feature check and keep them synchronized forever.

A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at `./configure` time, we can replace many `spkg-configure.m4` tests by Feature tests, written in Python.


---

Comment by mjo created at 2022-01-15 13:51:58

Replying to [comment:23 mkoeppe]:
> +1 on a mechanism for statically declaring features present/not present, for use by downstream distributions. They could be provided through `sage_conf`.
> 
> -1 on defining file system stuff, config files, etc.
> 

With sleep comes clarity. Instead of something like pkg-config, why don't we literally use pkg-config for this? To each feature, associate `sage-$feature.pc`. This meets all the criteria above without any hacky wheel reinventing. Distros are already familiar with the concept. `PKG_CONFIG_PATH` tricks should let us avoid version mismatch issues when, say, a git checkout is used on a system where a distro sage is also installed.

> A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. 

Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.


---

Comment by mkoeppe created at 2022-01-15 16:22:09

Replying to [comment:25 mjo]:
> > A more positive perspective on that would be that eventually, when we can assume that there is an at least mildly usable python3 available at ./configure time, we can replace many spkg-configure.m4 tests by Feature tests, written in Python. 
> 
> Maybe in some cases, but in general we aren't going to be able to easily replace well-tested autoconf macros with hand-written python. Consequently we'll wind up with the same machinery implemented in two different places in two different languages.

The trickiest `spkg-configure.m4` tests are for compile-time stuff - existence of libraries and such - and they do not need to be implemented in `sage.features`.


---

Comment by mkoeppe created at 2022-01-15 19:47:50

A possible solution could be to go through #31277.
