# Issue 31937: doctests: Detect "safe" external features even if "--optional=external" is not used

Issue created by migration from https://trac.sagemath.org/ticket/32174

Original creator: mkoeppe

Original creation time: 2021-07-10 18:34:16

CC:  dimpase slelievre arojas fbissey klee slabbe vdelecroix

(from #30887#comment:28)

For some "safe" features such as `imagemagick`, `rubiks`, `4ti2` (#30887), `pandoc`, it really shouldn't require the use of `external` to check for these. 

This is a step toward #30746 (`sage.doctest.control`: Replace use of `sage.misc.package.list_packages`)


---

Comment by mkoeppe created at 2021-10-22 20:06:53

Let's use this ticket to address the problem discovered in #32732#comment:10: Detection of Sage modules fails because the check runs before `sage.all` has been imported, and is therefore affected by import failures from cyclic imports


---

Comment by mkoeppe created at 2021-10-22 20:06:53

Changing priority from major to critical.


---

Comment by mkoeppe created at 2021-11-11 02:07:40

Here's an approach to do feature enumeration
----
Last 10 new commits:


---

Comment by git created at 2021-11-11 03:10:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slelievre created at 2021-11-13 13:03:31

Indent `.. NOTE::` blocks 4 spaces, not 3
(can be a follow-up ticket).


---

Comment by git created at 2021-11-13 18:18:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-13 19:50:21

Rebased on 9.5.beta6


---

Comment by git created at 2021-11-14 22:04:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-14 22:25:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-14 22:27:53

The `has_...` functions are now no longer needed.

Deprecate them? Or just remove them?


---

Comment by git created at 2021-11-14 23:43:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-14 23:44:47

Here's a version that seems to work.


---

Comment by git created at 2021-11-15 00:08:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-15 04:26:06

Changing status from new to needs_review.


---

Comment by arojas created at 2021-11-15 07:38:09

Is the ticket description still valid? This doesn't do anything for me unless I explicitly pass `--optional=external`


---

Comment by mkoeppe created at 2021-11-15 17:34:55

At the end of the tests it should print a line "Features detected for doctesting"


---

Comment by arojas created at 2021-11-15 17:42:19

Yes, but it doesn't detect anything if I don't use `--optional=external`:

```
> sage -t --optional=sage /usr/lib/python3.9/site-packages/sage/features/imagemagick.py
too many failed tests, not using stored timings
Running doctests with ID 2021-11-15-18-40-01-8b3be5fc.
Using --optional=sage
External software to be detected: 4ti2,cplex,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,lualatex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,pdf2svg,pdflatex,rubiks,scilab,xelatex
Doctesting 1 file.
sage -t --random-seed=283871835415461728632029979826455200075 /usr/lib/python3.9/site-packages/sage/features/imagemagick.py
    [3 tests, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Features detected for doctesting: 
Pytest is not installed, skip checking tests that rely on it.
```

doesn't detect imagemagick, but

```
> sage -t --optional=sage,external /usr/lib/python3.9/site-packages/sage/features/imagemagick.py
too many failed tests, not using stored timings
Running doctests with ID 2021-11-15-18-39-46-a52ab438.
Using --optional=external,sage
External software to be detected: 4ti2,cplex,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,lualatex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,pdf2svg,pdflatex,rubiks,scilab,xelatex
Doctesting 1 file.
sage -t --random-seed=59814167025539044529043021967633197695 /usr/lib/python3.9/site-packages/sage/features/imagemagick.py
    [4 tests, 0.00 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.0 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Features detected for doctesting: imagemagick
Pytest is not installed, skip checking tests that rely on it.
```

does


---

Comment by git created at 2021-11-15 17:47:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-15 17:49:30

Thanks. Should work now


---

Comment by git created at 2021-11-15 18:04:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-15 18:18:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-11-15 18:21:42

Replying to [comment:26 mkoeppe]:
> Thanks. Should work now

Confirmed. But now, running, `sage -t` without `--optional=external` displays 

```
External software to be detected: cplex,gurobi,internet,macaulay2,magma,maple,mathematica,matlab,octave,scilab
```

which is kind of misleading, as these are precisely the packages that are *not* autodetected in that case.


---

Comment by mkoeppe created at 2021-11-15 18:29:33

Thanks for testing. Good point, I'll make that clearer


---

Comment by git created at 2021-11-15 18:43:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-15 22:27:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-16 00:46:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-16 01:06:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-11-16 16:21:09

This unveils a test failure coming from #32732 (wasn't detected there because the test was skipped)

```
**********************************************************************
File "/usr/lib/python3.9/site-packages/sage/geometry/hyperbolic_space/hyperbolic_geodesic.py", line 2038, in sage.geometry.hyperbolic_space.hyperbolic_geodesic.HyperbolicGeodesicPD.plot
Failed example:
    H = h.plot(thickness=6, color="orange"); H           # optional - sage.plot
Expected:
    Graphics object consisting of 2 graphics primitives        # optional - sage.plot
Got:
    Graphics object consisting of 2 graphics primitives
**********************************************************************
```



---

Comment by git created at 2021-11-16 17:21:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-16 19:42:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2021-11-17 19:29:58

I'm getting a bliss related failure:

```
File "/usr/lib/python3.9/site-packages/sage/features/bliss.py", line 33, in sage.features.bliss.BlissLibrary
Failed example:
    BlissLibrary().require()  # optional: bliss
Exception raised:
    Traceback (most recent call last):
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/usr/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.features.bliss.BlissLibrary[1]>", line 1, in <module>
        BlissLibrary().require()  # optional: bliss
      File "/usr/lib/python3.9/site-packages/sage/features/__init__.py", line 205, in require
        raise FeatureNotPresentError(self, presence.reason, presence.resolution)
    sage.features.FeatureNotPresentError: Bliss is not available.
    Failed to run test code.
    No equivalent system packages for pip are known to Sage.
    Further installation instructions might be available at http://www.tcs.hut.fi/Software/bliss/.
```

This is happening because Sage is compiled with bliss, but the bliss library is not present at runtime (it doesn't need to, since it's statically linked).

So apparently there is a mismatch between whatever is tested to decide whether to enable the `optional: bliss` tests (which seems to be just the presence of the python module) and what the tests themselves require (not just the module, but also the library itself)


---

Comment by slabbe created at 2021-11-17 19:42:23

Also, pyflakes patchbot says:


```
src/sage/doctest/forker.py:218:9 'readline' imported but unused
src/sage/doctest/forker.py:224:9 'sympy' imported but unused
src/sage/geometry/polyhedron/base.py:2701:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:5852:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:6438:17 'sage.graphs.graph' imported but unused
src/sage/geometry/polyhedron/base.py:8913:13 'sage.graphs.graph' imported but unused
```



---

Comment by slabbe created at 2021-11-17 19:44:28

Also another plugin patchbot warning says:


```
wrong syntax for blocks (INPUT, OUTPUT, EXAMPLES, NOTE, etc) inserted on 9 non-empty lines
```


possibly in


```
inside file:  b/src/sage/features/interfaces.py
inside file:  b/src/sage/features/normaliz.py
```



---

Comment by mkoeppe created at 2021-11-17 21:01:12

Replying to [comment:41 slabbe]:
> Also, pyflakes patchbot says:
> 
> {{{
> src/sage/doctest/forker.py:218:9 'readline' imported but unused
> src/sage/doctest/forker.py:224:9 'sympy' imported but unused
> src/sage/geometry/polyhedron/base.py:2701:17 'sage.graphs.graph' imported but unused
> src/sage/geometry/polyhedron/base.py:5852:17 'sage.graphs.graph' imported but unused
> src/sage/geometry/polyhedron/base.py:6438:17 'sage.graphs.graph' imported but unused
> src/sage/geometry/polyhedron/base.py:8913:13 'sage.graphs.graph' imported but unused
> }}}

Not from this ticket, and all of these imports are done for their side effect, not the binding


---

Comment by git created at 2021-11-17 21:06:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-11-18 14:15:46

For reviewing, this ticket, I did:


```
$ sage -t -p --all --long --logfile=logs/32174-second.log
```


which returned


```
Git branch: 32174
Using --optional=4ti2,build,ccache,cryptominisat,debian,dochtml,dot2tex,e_antic,fricas,glucose,latte_int,lidia,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,sage,sage_numerical_backends_coin,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,imagemagick,jupymake,kenzo,latex,latte_int,lrslib,lualatex,mcqd,meataxe,pandoc,pdf2svg,pdflatex,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,tdlib,xelatex
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 4397 files using 8 threads.
...
----------------------------------------------------------------------
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/tests/cmdline.py  # 1 doctest failed
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/graphs/generic_graph.py  # 2 doctests failed
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/interfaces/fricas.py  # 1 doctest failed
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/graphs/graph.py  # 2 doctests failed
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/schemes/toric/sheaf/klyachko.py  # 1 doctest failed
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/sat/solvers/dimacs.py  # 2 doctests failed
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/combinat/designs/incidence_structures.py  # 1 doctest failed
----------------------------------------------------------------------
Features detected for doctesting: dvipng,ffmpeg,graphviz,imagemagick,latex,lualatex,pandoc,pdf2svg,pdflatex,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,xelatex
```


The issue with `src/sage/schemes/toric/sheaf/klyachko.py` does not reproduce:

```
sage -t --long --random-seed=129857008849586417489695899017012168188 src/sage/schemes/toric/sheaf/klyachko.py
**********************************************************************
File "src/sage/schemes/toric/sheaf/klyachko.py", line 950, in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_clas
s.random_deformation
Failed example:
    Vtilde.cohomology(dim=True, weight=(0,))
Expected:
    (1, 0)
Got:
    (0, 0)
**********************************************************************
1 item had failures:
   1 of   7 in sage.schemes.toric.sheaf.klyachko.KlyachkoBundle_class.random_deformation
    [151 tests, 1 failure, 16.00 s]
```

The other failures are known.

Then I did:


```
sage -t -p --all --long --optional=sage,optional,external,build --show-skipped --logfile=logs/32174.log
```

which returned:

```
Git branch: 32174
Using --optional=4ti2,build,ccache,cryptominisat,debian,dot2tex,e_antic,external,fricas,glucose,latte_int,lidia,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,sage,sage_numerical_backends_coin,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,cplex,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,jupymake,kenzo,latex,latte_int,lrslib,lualatex,macaulay2,magma,maple,mathematica,matlab,mcqd,meataxe,octave,pandoc,pdf2svg,pdflatex,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,scilab,tdlib,xelatex
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 4397 files using 8 threads.
...
----------------------------------------------------------------------
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/graphs/generic_graph.py  # 2 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/databases/findstat.py  # 9 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/tests/cmdline.py  # 10 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/graphs/graph.py  # 3 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/interfaces/fricas.py  # 1 doctest failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/sat/solvers/dimacs.py  # 2 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/combinat/designs/incidence_structures.py  # 1 doctest failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/finance/stock.py  # 1 doctest failed
----------------------------------------------------------------------
Features detected for doctesting: dvipng,ffmpeg,graphviz,imagemagick,internet,latex,lualatex,octave,pandoc,pdf2svg,pdflatex,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,xelatex
```


Therefore, there are no new failing test compared to what is currently the case with respect to known external failing doctests, see #25536. The difference is that now there is a list of features to be detected (pandoc, pdf2svg, etc.) which are now considered as optional instead of external which is a good thing.

I confirm that the new list of external packages is shorter and made only of the following:

```
>>> s = "4ti2,benzene,bliss,buckygen,conway_polynomials,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,imagemagick,jupymake,kenzo,latex,latte_int,lrslib,lualatex,mcqd,meataxe,pandoc,pdf2svg,pdflatex,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,tdlib,xelatex"
>>> t = "4ti2,benzene,bliss,buckygen,conway_polynomials,cplex,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,jupymake,kenzo,latex,latte_int,lrslib,lualatex,macaulay2,magma,maple,mathematica,matlab,mcqd,meataxe,octave,pandoc,pdf2svg,pdflatex,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,scilab,tdlib,xelatex"
>>> set(t.split(',')) - set(s.split(','))
set(['macaulay2', 'mathematica', 'cplex', 'magma', 'gurobi', 'matlab', 'octave', 'internet', 'scilab', 'maple'])
```



---

Comment by slabbe created at 2021-11-18 14:18:11

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2021-11-18 14:18:11

Objectives of the ticket are achieved.


---

Comment by mkoeppe created at 2021-11-18 18:07:28

Thank you for reviewing!


---

Comment by vbraun created at 2021-11-23 23:25:37

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-11-23 23:25:37


```
sage -t --long --warn-long 45.7 --random-seed=86523171498431921424879269621082549712 src/sage/misc/latex.py
**********************************************************************
File "src/sage/misc/latex.py", line 1549, in sage.misc.latex.Latex.add_package_to_preamble_if_available
Failed example:
    latex.extra_preamble()       # optional - latex
Expected:
    '\\usepackage{xypic}\n'
Got:
    ''
**********************************************************************
File "src/sage/misc/latex.py", line 1859, in sage.misc.latex.?
Failed example:
    _run_latex_(file, engine="pdflatex") # optional - latex
Expected:
    'pdf'
Got:
    An error occurred.
    This is pdfTeX, Version 3.14159265-2.6-1.40.21 (TeX Live 2020) (preloaded format=pdflatex 2020.11.22)  24 NOV 2021 00:24
    entering extended mode
     restricted \write18 enabled.
     %&-line parsing enabled.
    **\nonstopmode \input{temp.tex}
    (./temp.tex (/usr/share/texlive/texmf-dist/tex/latex/base/article.cls
    Document Class: article 2019/12/20 v1.4l Standard LaTeX document class
    (/usr/share/texlive/texmf-dist/tex/latex/base/size10.clo
    File: size10.clo 2019/12/20 v1.4l Standard LaTeX file (size option)
    )
    \c@part=\count167
    \c@section=\count168
    \c@subsection=\count169
    \c@subsubsection=\count170
    \c@paragraph=\count171
    \c@subparagraph=\count172
    \c@figure=\count173
    \c@table=\count174
    \abovecaptionskip=\skip47
    \belowcaptionskip=\skip48
    \bibindent=\dimen134
    )
    (/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsmath.sty
    Package: amsmath 2020/01/20 v2.17e AMS math features
    \@mathmargin=\skip49
    <BLANKLINE>
    For additional information on amsmath, use the `?' option.
    (/usr/share/texlive/texmf-dist/tex/latex/amsmath/amstext.sty
    Package: amstext 2000/06/29 v2.01 AMS text
    <BLANKLINE>
    (/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsgen.sty
    File: amsgen.sty 1999/11/30 v2.0 generic functions
    \@emptytoks=\toks15
    \ex@=\dimen135
    ))
    (/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsbsy.sty
    Package: amsbsy 1999/11/29 v1.2d Bold Symbols
    \pmbraise@=\dimen136
    )
    (/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsopn.sty
    Package: amsopn 2016/03/08 v2.02 operator names
    )
    \inf@bad=\count175
    LaTeX Info: Redefining \frac on input line 227.
    \uproot@=\count176
    \leftroot@=\count177
    LaTeX Info: Redefining \overline on input line 389.
    \classnum@=\count178
    \DOTSCASE@=\count179
    LaTeX Info: Redefining \ldots on input line 486.
    LaTeX Info: Redefining \dots on input line 489.
    LaTeX Info: Redefining \cdots on input line 610.
    \Mathstrutbox@=\box45
    \strutbox@=\box46
    \big@size=\dimen137
    LaTeX Font Info:    Redeclaring font encoding OML on input line 733.
    LaTeX Font Info:    Redeclaring font encoding OMS on input line 734.
    \macc@depth=\count180
    \c@MaxMatrixCols=\count181
    \dotsspace@=\muskip16
    \c@parentequation=\count182
    \dspbrk@lvl=\count183
    \tag@help=\toks16
    \row@=\count184
    \column@=\count185
    \maxfields@=\count186
    \andhelp@=\toks17
    \eqnshift@=\dimen138
    \alignsep@=\dimen139
    \tagshift@=\dimen140
    \tagwidth@=\dimen141
    \totwidth@=\dimen142
    \lineht@=\dimen143
    \@envbody=\toks18
    \multlinegap=\skip50
    \multlinetaggap=\skip51
    \mathdisplay@stack=\toks19
    LaTeX Info: Redefining \[ on input line 2859.
    LaTeX Info: Redefining \] on input line 2860.
    )
    (/usr/share/texlive/texmf-dist/tex/latex/amsfonts/amssymb.sty
    Package: amssymb 2013/01/14 v3.01 AMS font symbols
    <BLANKLINE>
    (/usr/share/texlive/texmf-dist/tex/latex/amsfonts/amsfonts.sty
    Package: amsfonts 2013/01/14 v3.01 Basic AMSFonts support
    \symAMSa=\mathgroup4
    \symAMSb=\mathgroup5
    LaTeX Font Info:    Redeclaring math symbol \hbar on input line 98.
    LaTeX Font Info:    Overwriting math alphabet `\mathfrak' in version `bold'
    (Font)                  U/euf/m/n --> U/euf/b/n on input line 106.
    ))
    (/usr/share/texlive/texmf-dist/tex/latex/graphics/graphicx.sty
    Package: graphicx 2019/11/30 v1.2a Enhanced LaTeX Graphics (DPC,SPQR)
    <BLANKLINE>
    (/usr/share/texlive/texmf-dist/tex/latex/graphics/keyval.sty
    Package: keyval 2014/10/28 v1.15 key=value parser (DPC)
    \KV@toks@=\toks20
    )
    (/usr/share/texlive/texmf-dist/tex/latex/graphics/graphics.sty
    Package: graphics 2019/11/30 v1.4a Standard LaTeX Graphics (DPC,SPQR)
    <BLANKLINE>
    (/usr/share/texlive/texmf-dist/tex/latex/graphics/trig.sty
    Package: trig 2016/01/03 v1.10 sin cos tan (DPC)
    )
    (/usr/share/texlive/texmf-dist/tex/latex/graphics-cfg/graphics.cfg
    File: graphics.cfg 2016/06/04 v1.11 sample graphics configuration
    )
    Package graphics Info: Driver file: pdftex.def on input line 105.
    <BLANKLINE>
    (/usr/share/texlive/texmf-dist/tex/latex/graphics-def/pdftex.def
    File: pdftex.def 2018/01/08 v1.0l Graphics/color driver for pdftex
    ))
    \Gin@req@height=\dimen144
    \Gin@req@width=\dimen145
    )
    (/usr/share/texlive/texmf-dist/tex/latex/jknapltx/mathrsfs.sty
    Package: mathrsfs 1996/01/01 Math RSFS package v1.0 (jk)
    \symrsfs=\mathgroup6
    )
    (/usr/share/texlive/texmf-dist/tex/latex/base/inputenc.sty
    Package: inputenc 2018/08/11 v1.3c Input encoding file
    \inpenc@prehook=\toks21
    \inpenc@posthook=\toks22
    )
    (/usr/share/texlive/texmf-dist/tex/latex/base/fontenc.sty
    Package: fontenc 2020/02/11 v2.0o Standard LaTeX package
    )
    <BLANKLINE>
    ! LaTeX Error: File `tkz-graph.sty' not found.
    <BLANKLINE>
    Type X to quit or <RETURN> to proceed,
    or enter new name. (Default extension: sty)
    <BLANKLINE>
    Enter file name: 
    ! Emergency stop.
    <read *> 
    <BLANKLINE>
    l.19 \newcommand
                    {\ZZ}{\Bold{Z}}^^M
    *** (cannot \read from terminal in nonstop modes)
    <BLANKLINE>
    <BLANKLINE>
    Here is how much of TeX's memory you used:
     1949 strings out of 482029
     21727 string characters out of 5943690
     251133 words of memory out of 5000000
     17640 multiletter control sequences out of 15000+600000
     533101 words of font info for 25 fonts, out of 8000000 for 9000
     430 hyphenation exceptions out of 8191
     32i,0n,33p,241b,38s stack positions out of 5000i,500n,10000p,200000b,80000s
    !  ==> Fatal error occurred, no output PDF file produced!
    <BLANKLINE>
    'Error latexing slide.'
**********************************************************************
2 items had failures:
   1 of  19 in sage.misc.latex.?
   1 of   5 in sage.misc.latex.Latex.add_package_to_preamble_if_available
    [258 tests, 2 failures, 0.85 s]
----------------------------------------------------------------------
sage -t --long --warn-long 45.7 --random-seed=86523171498431921424879269621082549712 src/sage/misc/latex.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1.0 seconds
    cpu time: 0.2 seconds
    cumulative wall time: 0.9 seconds
Features detected for doctesting: imagemagick,latex
```



---

Comment by git created at 2021-11-24 01:59:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-24 02:00:45

Here's a quick fix by marking some doctests `# optional - latex_package_tkz_graph`. 
For now, this annotation just disables that line. This feature is introduced in #32926.


---

Comment by mkoeppe created at 2021-11-24 02:00:55

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2021-11-25 10:42:00

I do not have access to a computer with no installation of latex. But, I confirm that this


```
sage -tp --optional=sage,optional,external src/sage/misc/latex.py
```


works on my machine:


```
Git branch: 32174
Using --optional=4ti2,ccache,cryptominisat,debian,dot2tex,e_antic,external,fricas,glucose,latte_int,lidia,normaliz,notedown,pandoc_attributes,pip,pycosat,pynormaliz,rst2ipynb,sage,sage_numerical_backends_coin,sage_spkg
Features to be detected: 4ti2,benzene,bliss,buckygen,conway_polynomials,cplex,csdp,database_cremona_ellcurve,database_cremona_mini_ellcurve,database_jones_numfield,database_knotinfo,dvipng,ffmpeg,graphviz,gurobi,imagemagick,internet,jupymake,kenzo,latex,latte_int,lrslib,lualatex,macaulay2,magma,maple,mathematica,matlab,mcqd,meataxe,octave,pandoc,pdf2svg,pdflatex,plantri,pynormaliz,rubiks,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,sage_numerical_backends_coin,scilab,tdlib,xelatex
Doctesting 1 file using 8 threads.
sage -t --random-seed=278462588081941083872300580472279407754 src/sage/misc/latex.py
    [255 tests, 1.15 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Features detected for doctesting: imagemagick,latex
```



---

Comment by slabbe created at 2021-11-25 10:47:36

All tests are passing on the patchbots. For me it is a positive review.

Can someone having a machine similar to the one used by Volker confirm it is okay?

Volker, are you okay to test it again on your machine?


---

Comment by mkoeppe created at 2021-11-26 03:34:35

Let's just put it back in the queue


---

Comment by mkoeppe created at 2021-11-26 03:34:35

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2021-12-01 10:57:22

Changing status from positive_review to needs_info.


---

Comment by slabbe created at 2021-12-01 10:57:22

The 89 + 63 doctest failures (seen on patchbot `labri-vindelecroix-1`) that are discussed in #32926 are also seen here on the same patchbot testing this ticket #32174. Moreover those numerous failures are not seen by the same patchbot while testing #32866 on which #32174 is based on. So I switch the status of the current ticket to needs info.


---

Comment by slabbe created at 2021-12-01 11:00:55

(_I copy paste here a comment originally written at #32926#comment:20_)

All of the 89 + 63 errors are the same. It is always a warning which is printed (the output is always ok) saying `! LaTeX Error: File `type1ec.sty' not found.`

Also the machine on which the failures is happening has the following detected features:

```
Features detected for doctesting: 4ti2,dvipng,ffmpeg,graphviz,latex,latex_package_tkz_graph,lrslib,lualatex,pdflatex,
sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,
sage.rings.real_double,sage.symbolic,xelatex
```


Here is one of the failure:


```
**********************************************************************
File "src/sage/plot/plot.py", line 1919, in sage.plot.plot.plot
Failed example:
    parametric_plot((sqrt(x^2-1),sqrt(x^2-1/2)), (x,0,5), exclude=[1,2,3])
Expected:
    Graphics object consisting of 3 graphics primitives
Got:
    doctest:warning
      File "/home/debian/sage/src/bin/sage-runtests", line 155, in <module>
        err = DC.run()
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/control.py", line 1253, in run
        self.run_doctests()
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/control.py", line 954, in run_doctests
        self.dispatcher.dispatch()
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1996, in dispatch
        self.parallel_dispatch()
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1891, in parallel_dispatch
        w.start()  # This might take some time
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2165, in start
        super(DocTestWorker, self).start()
      File "/usr/lib/python3.9/multiprocessing/process.py", line 121, in start
        self._popen = self._Popen(self)
      File "/usr/lib/python3.9/multiprocessing/context.py", line 224, in _Popen
        return _default_context.get_context().Process._Popen(process_obj)
      File "/usr/lib/python3.9/multiprocessing/context.py", line 277, in _Popen
        return Popen(process_obj)
      File "/usr/lib/python3.9/multiprocessing/popen_fork.py", line 19, in __init__
        self._launch(process_obj)
      File "/usr/lib/python3.9/multiprocessing/popen_fork.py", line 71, in _launch
        code = process_obj._bootstrap(parent_sentinel=child_r)
      File "/usr/lib/python3.9/multiprocessing/process.py", line 315, in _bootstrap
        self.run()
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2137, in run
        task(self.options, self.outtmpfile, msgpipe, self.result_queue)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2467, in __call__
        doctests, extras = self._run(runner, options, results)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 2519, in _run
        result = runner.run(test)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 861, in run
        return self._run(test, compileflags, out)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.plot.plot.plot[144]>", line 1, in <module>
        parametric_plot((sqrt(x**Integer(2)-Integer(1)),sqrt(x**Integer(2)-Integer(1)/Integer(2))), (x,Integer(0),Integer(5)), exclude=[Integer(1),Integer(2),Integer(3)])
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/repl/rich_output/display_manager.py", line 825, in displayhook
        plain_text, rich_output = self._rich_output_formatter(obj, dict())
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/repl/rich_output/display_manager.py", line 643, in _rich_output_formatter
        rich_output = self._call_rich_repr(obj, rich_repr_kwds)
      File "/home/debian/sage/local/lib/python3.9/site-packages/sage/repl/rich_output/display_manager.py", line 608, in _call_rich_repr
        warnings.warn(
      File "/usr/lib/python3.9/warnings.py", line 109, in _showwarnmsg
        sw(msg.message, msg.category, msg.filename, msg.lineno,
    :
    sage.repl.rich_output.display_manager.RichReprWarning: Exception in _rich_repr_ while displaying object: latex was not able to process the following string:
    b'lp'
    <BLANKLINE>
    Here is the full report generated by latex:
    This is pdfTeX, Version 3.14159265-2.6-1.40.21 (TeX Live 2020/Debian) (preloaded format=latex)
     restricted \write18 enabled.
    entering extended mode
    <BLANKLINE>
    (/home/debian/.sage/matplotlib-1.5.1/tex.cache/1acea6f6c115d0ec7a634ed0529287b9
    .tex
    LaTeX2e <2020-10-01> patch level 4
    L3 programming layer <2021-01-09> xparse <2020-03-03>
    (/usr/share/texlive/texmf-dist/tex/latex/base/article.cls
    Document Class: article 2020/04/10 v1.4m Standard LaTeX document class
    (/usr/share/texlive/texmf-dist/tex/latex/base/size10.clo))
    (/usr/share/texlive/texmf-dist/tex/latex/type1cm/type1cm.sty)
    <BLANKLINE>
    ! LaTeX Error: File `type1ec.sty' not found.
    <BLANKLINE>
    Type X to quit or <RETURN> to proceed,
    or enter new name. (Default extension: sty)
    <BLANKLINE>
    Enter file name: 
    ! Emergency stop.
    <read *> 
    <BLANKLINE>
    l.6 \usepackage
                   {type1ec}^^M
    No pages of output.
    Transcript written on 1acea6f6c115d0ec7a634ed0529287b9.log.
    <BLANKLINE>
    <BLANKLINE>
    <BLANKLINE>
    Graphics object consisting of 3 graphics primitives
```


I am not able to reproduce these failures on my machine. I will try to see if these failures appear with the same machine running doctest on different tickets or on no ticket at all (if I remember well, there is a way to check this no?)


---

Comment by slelievre created at 2021-12-01 11:19:24

See similar discussion in a matplotlib issue:

- https://github.com/matplotlib/matplotlib/issues/16911

The fix suggested there is:

```
$ apt install cm-super
```



---

Comment by slabbe created at 2021-12-01 11:21:18

I updated the description of the ticket to mention that more doctests will be run by default after #32174 which may lead to "new" bugs that were there before. That being said, I still don't know if the 89 + 63 fall in this category, because only 2 + 1 doctests are marked as `optional - latex` in those two files.

Also, it made me realize that there is a bug with `--show-skipped` which does not work correctly:
The fact that `2 latex tests not run`, `1 latex test not run` still appear is a bug, since those tests **are** run.


---

Comment by slabbe created at 2021-12-01 11:50:03

The 89 + 63 failures seems to be created by the current branch when looking at the patchbot report made by `vindelecroix-labri1` machine. But, when looking at the code of this ticket, I can't see anything which can explain those failures to appear. I am adding machine's owner in cc in case Vincent has an idea.

Most of the machines are fine, so I am fine with putting the status back to positive review.

Or do we want to mark those doctests as dependent on the external latex feature `cm-super`? That would rather be done in #32926.


---

Comment by slabbe created at 2021-12-01 13:17:21

Replying to [comment:58 slabbe]:
> Also, it made me realize that there is a bug with `--show-skipped` which does not work correctly:
> The fact that `2 latex tests not run`, `1 latex test not run` still appear is a bug, since those tests **are** run.

I am adding a commit to fix the issue with the `--show-skipped` report.
----
New commits:


---

Comment by git created at 2021-12-01 17:23:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-01 17:23:42

Cherry-picked from #32926.


---

Comment by git created at 2021-12-01 17:26:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-01 17:29:03

Changing status from needs_info to needs_review.


---

Comment by mkoeppe created at 2021-12-01 17:29:03

In order to get this ticket in, I have now reduced the scope, keeping the latex features as `external`. In a follow-up ticket, we can work on improving the `# optional` tags.


---

Comment by slabbe created at 2021-12-01 17:55:04

updated the example in the description of the ticket to be based on pandoc instead of latex


---

Comment by mkoeppe created at 2021-12-01 17:58:51

Replying to [comment:66 mkoeppe]:
> In a follow-up ticket, we can work on improving the `# optional` tags.

This is now #32955.


---

Comment by git created at 2021-12-01 18:02:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2021-12-01 18:11:32

I started a re-run of all tests on my machine. Will report later.

`@`Matthias: Sorry for having re-open this ticket earlier today. It was having a positive review for 7 days. I should have open another ticket instead I think. I hope it will not delay the entry of this ticket into sage since many other tickets depend on it. I will stay close to it to not add anymore delay.


---

Comment by mkoeppe created at 2021-12-01 18:14:29

No worries, and thanks for all your work!


---

Comment by slabbe created at 2021-12-01 19:40:45

Replying to [comment:71 slabbe]:
> I started a re-run of all tests on my machine. Will report later.

On my machine running optional and external doctests on top of 9.5.beta7 returns:


```
----------------------------------------------------------------------
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/graphs/generic_graph.py  # 2 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/databases/findstat.py  # 9 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/tests/cmdline.py  # 10 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/graphs/graph.py  # 3 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/interfaces/fricas.py  # 1 doctest failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/sat/solvers/dimacs.py  # 2 doctests failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/combinat/designs/incidence_structures.py  # 1 doctest failed
sage -t --long --random-seed=199830843512308713498063069261640048262 src/sage/finance/stock.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 2664.6 seconds
    cpu time: 16553.0 seconds
    cumulative wall time: 20701.4 seconds
Features detected for doctesting: dvipng,ffmpeg,graphviz,imagemagick,internet,latex,lualatex,octave,pandoc,pdf2svg,pdflatex,sage.combinat,sage.geometry.polyhedron,sage.graphs,sage.plot,sage.rings.number_field,sage.rings.real_double,sage.symbolic,xelatex
```


which has no more failures than what I reported for [9.5.beta7 on sage-release](https://groups.google.com/g/sage-release/c/FXpakLURP_0).

I am waiting for the patchbot to finish.


---

Comment by slabbe created at 2021-12-02 09:37:03

The patchbot `panke` finished its tests. It has only one failure which is exactly the one given in the description of this ticket which I repeat is already tracked at #32697:


```
sage -t --long --random-seed=318717441882109214278396779393985383988 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 732, in sage.tests.cmdline.test_executable
Failed example:
    print(open(output, 'r').read() == t)          # optional - pandoc
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of 223 in sage.tests.cmdline.test_executable
    [222 tests, 1 failure, 57.81 s]
```


From me it is a positive review. Next stuff to be checked are
- whether it works on `vindelecroix-labri1` machine (are the 63 + 89 failures gone with the last changes by Matthias? personnaly, I am not even sure). That being said Vincent is gone for vacation for 4 weeks, so we might not want to wait for an answer.
- whether it works on Volker's machine (normally this was fixed by 07b2512)


---

Comment by mkoeppe created at 2021-12-02 18:10:53

Replying to [comment:74 slabbe]:
> - whether it works on `vindelecroix-labri1` machine (are the 63 + 89 failures gone with the last changes by Matthias? 

Well, these tests are `# optional - latex`, and `latex` is now no longer automatically added unless `external` is in use.


---

Comment by slabbe created at 2021-12-02 20:36:32

Replying to [comment:75 mkoeppe]:
> Replying to [comment:74 slabbe]:
> > - whether it works on `vindelecroix-labri1` machine (are the 63 + 89 failures gone with the last changes by Matthias? 
> 
> Well, these tests are `# optional - latex`, and `latex` is now no longer automatically added unless `external` is in use.

No, only very few of them are marked as `# optional - latex`, maybe two of them if I well remember.


---

Comment by mkoeppe created at 2021-12-03 00:30:26

Thanks for the correction.


---

Comment by slabbe created at 2021-12-03 08:01:36

I think we will not have answers from Vincent as he is on vacation. A solution to this weird problem seen on `vdelecroix-labri1` patchbot is suggested in comment #32174#comment:57 (install cm-super).

I change the status to positive review.


---

Comment by slabbe created at 2021-12-03 08:01:36

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-04 00:08:46

Thanks!


---

Comment by vbraun created at 2021-12-05 15:25:15

Still fails:

```
sage -t --long --warn-long 42.3 --random-seed=269228488280518602699863791762785215883 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 732, in sage.tests.cmdline.test_executable
Failed example:
    print(open(output, 'r').read() == t)          # optional - pandoc
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of 223 in sage.tests.cmdline.test_executable
    [222 tests, 1 failure, 39.52 s]
```



---

Comment by vbraun created at 2021-12-05 15:25:15

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2021-12-05 17:21:59

that's #32697 "`sage --ipynb2rst` is broken due to changes in `nbconvert`


---

Comment by git created at 2021-12-05 18:06:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-05 18:06:55

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2021-12-05 19:16:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-05 20:32:01

Thanks!


---

Comment by vbraun created at 2021-12-16 23:48:26

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-12-16 23:48:26


```
**********************************************************************
File "src/sage/misc/latex.py", line 1087, in sage.misc.latex.Latex.?
Failed example:
    latex.eval(r"\ThisIsAnInvalidCommand", {}) # optional -- ImageMagick
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.latex.Latex.?[1]>", line 1, in <module>
        latex.eval(r"\ThisIsAnInvalidCommand", {}) # optional -- ImageMagick
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/misc/latex.py", line 1128, in eval
        e = _run_latex_(os.path.join(base, filename + ".tex"), debug=debug,
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/misc/latex.py", line 725, in _run_latex_
        pdflatex().require()
      File "/var/lib/buildbot/slave/sage_git/build/local/var/lib/sage/venv-python3.9.9/lib/python3.9/site-packages/sage/features/__init__.py", line 206, in require
        raise FeatureNotPresentError(self, presence.reason, presence.resolution)
    sage.features.FeatureNotPresentError: pdflatex is not available.
    Executable 'pdflatex' not found on PATH.
    Further installation instructions might be available at https://www.latex-project.org/.
**********************************************************************
1 item had failures:
   1 of   3 in sage.misc.latex.Latex.?
    [250 tests, 1 failure, 0.35 s]
    Timed out
**********************************************************************
```



---

Comment by git created at 2021-12-17 00:13:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-17 00:13:38

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2021-12-19 11:46:49

Resolution: fixed


---

Comment by vbraun created at 2021-12-19 11:49:22

Followup at #33045 for ffmpeg


---

Comment by slelievre created at 2022-01-01 19:26:43

Followup at #33101 for lrslib.


---

Comment by slelievre created at 2022-01-01 19:28:36

See also #33092 for ffmpeg and imagemagick.
