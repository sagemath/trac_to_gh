# Issue 30297: Repackage pynac as a pip-installable package

archive/issues_030297.json:
```json
{
    "body": "CC:  @rwst @slel @tobiasdiez @williamstein @kiwifb @tscrim @kliem @videlec @embray\n\npynac has a compile-time dependency on the python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different python versions.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30534\n\n",
    "created_at": "2020-09-09T00:46:09Z",
    "labels": [
        "component: packages: standard"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Repackage pynac as a pip-installable package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30297",
    "user": "https://github.com/mkoeppe"
}
```
CC:  @rwst @slel @tobiasdiez @williamstein @kiwifb @tscrim @kliem @videlec @embray

pynac has a compile-time dependency on the python library but is not installed using Python package infrastructure. This is problematic because Python users cannot install it using standard Python tools - for example for testing different python versions.

Issue created by migration from https://trac.sagemath.org/ticket/30534





---

archive/issue_comments_431498.json:
```json
{
    "body": "Changing keywords from \"\" to \"pynac\".",
    "created_at": "2020-09-09T15:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431498",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "pynac".



---

archive/issue_comments_431499.json:
```json
{
    "body": "Cc-ing Ralf Stephan who maintains Pynac.",
    "created_at": "2020-09-09T15:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431499",
    "user": "https://github.com/slel"
}
```

Cc-ing Ralf Stephan who maintains Pynac.



---

archive/issue_comments_431500.json:
```json
{
    "body": "> Unfortunately, there is an unrelated project\n> that has claimed the name \"Pynac\" on pypi.org:\n>\n> \u200bhttps://pypi.org/project/Pynac\n\nCollision between\n\n- Pynac = \"Py-Dynac\" = Python bindings for the Dynac particle tracking code\n- Pynac = \"Py-GiNaC\" = Python derivative of the C++ library GiNaC\n\nPossible solutions:\n\n- rename these projects to Py-Dynac and Py-GiNaC, or Pydynac and Pyginac\n- no renaming but use the name pyginac on PyPI for \"Py-GiNaC\"\n\nNote:\n\n- \"Py-Dynac\" got the pynac name on PyPI\n- \"Py-GiNaC\" got the pynac.org domain name\n\nRegardless of how we handle getting \"Py-GiNaC\" on PyPI,\na disambiguation note in both \"Pynac\" projects would be\nnice, with links to each other.\n\nI will propose changes via pull requests or other\nto add such a note in relevant places.",
    "created_at": "2020-09-14T00:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431500",
    "user": "https://github.com/slel"
}
```

> Unfortunately, there is an unrelated project
> that has claimed the name "Pynac" on pypi.org:
>
> ​https://pypi.org/project/Pynac

Collision between

- Pynac = "Py-Dynac" = Python bindings for the Dynac particle tracking code
- Pynac = "Py-GiNaC" = Python derivative of the C++ library GiNaC

Possible solutions:

- rename these projects to Py-Dynac and Py-GiNaC, or Pydynac and Pyginac
- no renaming but use the name pyginac on PyPI for "Py-GiNaC"

Note:

- "Py-Dynac" got the pynac name on PyPI
- "Py-GiNaC" got the pynac.org domain name

Regardless of how we handle getting "Py-GiNaC" on PyPI,
a disambiguation note in both "Pynac" projects would be
nice, with links to each other.

I will propose changes via pull requests or other
to add such a note in relevant places.



---

archive/issue_comments_431501.json:
```json
{
    "body": "Or use pynac-ginac as the PyPI name (more discoverable?).",
    "created_at": "2020-09-14T00:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431501",
    "user": "https://github.com/slel"
}
```

Or use pynac-ginac as the PyPI name (more discoverable?).



---

archive/issue_comments_431502.json:
```json
{
    "body": "We briefly discussed it at sd110.\n\n  From William Stein (CoCalc) to Everyone: (1:37 PM)\n\u2029  py-ginac is pretty good.",
    "created_at": "2020-10-30T21:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431502",
    "user": "https://github.com/mkoeppe"
}
```

We briefly discussed it at sd110.

  From William Stein (CoCalc) to Everyone: (1:37 PM)
   py-ginac is pretty good.



---

archive/issue_comments_431503.json:
```json
{
    "body": "Changing keywords from \"pynac\" to \"pynac, sd110\".",
    "created_at": "2020-10-30T21:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431503",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "pynac" to "pynac, sd110".



---

archive/issue_comments_431504.json:
```json
{
    "body": "There is already some `py_ginac` somewhere :\n\nhttp://moebinv.sourceforge.net/pyGiNaC.html",
    "created_at": "2020-11-05T13:53:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431504",
    "user": "https://github.com/fchapoton"
}
```

There is already some `py_ginac` somewhere :

http://moebinv.sourceforge.net/pyGiNaC.html



---

archive/issue_comments_431505.json:
```json
{
    "body": "Replying to [comment:9 chapoton]:\n> There is already some `py_ginac` somewhere :\n> \n> http://moebinv.sourceforge.net/pyGiNaC.html\nThanks for the pointer.  This appears to be an active project. \nFrom https://sourceforge.net/projects/pyginac.moebinv.p/: \n\n  \"This is a refresh and maintained version of the previous stalled project https://sourceforge.net/projects/pyginac/ It works with the current version of GiNaC.\"\n\nThe source (git) is at https://sourceforge.net/p/moebinv/pyginac/code/ci/master/tree/\n\nIt provides the Python packages `cginac` and `ginac`.",
    "created_at": "2020-11-06T23:17:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431505",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:9 chapoton]:
> There is already some `py_ginac` somewhere :
> 
> http://moebinv.sourceforge.net/pyGiNaC.html
Thanks for the pointer.  This appears to be an active project. 
From https://sourceforge.net/projects/pyginac.moebinv.p/: 

  "This is a refresh and maintained version of the previous stalled project https://sourceforge.net/projects/pyginac/ It works with the current version of GiNaC."

The source (git) is at https://sourceforge.net/p/moebinv/pyginac/code/ci/master/tree/

It provides the Python packages `cginac` and `ginac`.



---

archive/issue_comments_431506.json:
```json
{
    "body": "It calls itself \"pyGiNaC\" but it does not define a distribution of this name. It must be built using scons and is not pip-installable - so it also does not claim a project name on PyPI.",
    "created_at": "2020-11-06T23:26:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431506",
    "user": "https://github.com/mkoeppe"
}
```

It calls itself "pyGiNaC" but it does not define a distribution of this name. It must be built using scons and is not pip-installable - so it also does not claim a project name on PyPI.



---

archive/issue_comments_431507.json:
```json
{
    "body": "Changing keywords from \"pynac, sd110\" to \"pynac, sd110, sd111\".",
    "created_at": "2020-12-06T17:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431507",
    "user": "https://github.com/mkoeppe"
}
```

Changing keywords from "pynac, sd110" to "pynac, sd110, sd111".



---

archive/issue_comments_431508.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431508",
    "user": "https://github.com/mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_431509.json:
```json
{
    "body": "https://github.com/pynac/pynac/pull/371",
    "created_at": "2021-02-28T03:44:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431509",
    "user": "https://github.com/mkoeppe"
}
```

https://github.com/pynac/pynac/pull/371



---

archive/issue_comments_431510.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-02-28T06:15:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431510",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431511.json:
```json
{
    "body": "The new package installs correctly. `sage.libs.pynac` needs more work.",
    "created_at": "2021-02-28T07:05:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431511",
    "user": "https://github.com/mkoeppe"
}
```

The new package installs correctly. `sage.libs.pynac` needs more work.



---

archive/issue_comments_431512.json:
```json
{
    "body": "I think I'll need some help here from people who know about `import` and `cimport` in Cython...",
    "created_at": "2021-02-28T20:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431512",
    "user": "https://github.com/mkoeppe"
}
```

I think I'll need some help here from people who know about `import` and `cimport` in Cython...



---

archive/issue_comments_431513.json:
```json
{
    "body": "With what aspects? Just when to use one versus the other?",
    "created_at": "2021-02-28T21:43:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431513",
    "user": "https://github.com/tscrim"
}
```

With what aspects? Just when to use one versus the other?



---

archive/issue_comments_431514.json:
```json
{
    "body": "I am getting runtime linker errors like the following on this branch:\n\n```\n[dochtml]     import sage.libs.pynac.pynac # initialize pynac before .ring\n[dochtml] ImportError: dlopen(/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so, 2): Symbol not found: __ZN5GiNaC12library_initD1Ev\n[dochtml]   Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so\n[dochtml]   Expected in: flat namespace\n[dochtml]  in /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so\n```\n",
    "created_at": "2021-02-28T21:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431514",
    "user": "https://github.com/mkoeppe"
}
```

I am getting runtime linker errors like the following on this branch:

```
[dochtml]     import sage.libs.pynac.pynac # initialize pynac before .ring
[dochtml] ImportError: dlopen(/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so, 2): Symbol not found: __ZN5GiNaC12library_initD1Ev
[dochtml]   Referenced from: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so
[dochtml]   Expected in: flat namespace
[dochtml]  in /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-darwin.so
```




---

archive/issue_comments_431515.json:
```json
{
    "body": "That is beyond my knowledge as it has something to do with how the packages are linked. Perhaps looking at how [p_group_cohomology](https://github.com/sagemath/p_group_cohomology) does its setup might have a clue?\n\nErik, do you know about these things or know a good person to ask?",
    "created_at": "2021-02-28T23:37:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431515",
    "user": "https://github.com/tscrim"
}
```

That is beyond my knowledge as it has something to do with how the packages are linked. Perhaps looking at how [p_group_cohomology](https://github.com/sagemath/p_group_cohomology) does its setup might have a clue?

Erik, do you know about these things or know a good person to ask?



---

archive/issue_comments_431516.json:
```json
{
    "body": "The double leading underscore is very strange. If you remove one it becomes simply\n\n```\n$ c++filt -n _ZN5GiNaC12library_initD1Ev\nGiNaC::library_init::~library_init()\n```\n\nbut with two, it is nothing. Some naming or interface is not set right.",
    "created_at": "2021-02-28T23:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431516",
    "user": "https://github.com/kiwifb"
}
```

The double leading underscore is very strange. If you remove one it becomes simply

```
$ c++filt -n _ZN5GiNaC12library_initD1Ev
GiNaC::library_init::~library_init()
```

but with two, it is nothing. Some naming or interface is not set right.



---

archive/issue_comments_431517.json:
```json
{
    "body": "First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.\n\nUntil then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.",
    "created_at": "2021-03-01T08:33:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431517",
    "user": "https://github.com/kliem"
}
```

First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.

Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.



---

archive/issue_comments_431518.json:
```json
{
    "body": "And something isn't right about `pynac/setup.py`:\n\n\n```\n(sage-sh) kliem@cofio:sage$ python\nPython 3.7.3 (default, Jul 25 2020, 13:03:44) \n[GCC 8.3.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from ginac.pynac import *\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nModuleNotFoundError: No module named 'ginac.pynac'\n>>> from ginac.libpynac import *\nSegmentation fault\n```\n",
    "created_at": "2021-03-01T08:49:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431518",
    "user": "https://github.com/kliem"
}
```

And something isn't right about `pynac/setup.py`:


```
(sage-sh) kliem@cofio:sage$ python
Python 3.7.3 (default, Jul 25 2020, 13:03:44) 
[GCC 8.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> from ginac.pynac import *
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'ginac.pynac'
>>> from ginac.libpynac import *
Segmentation fault
```




---

archive/issue_comments_431519.json:
```json
{
    "body": "I even get segementation fault in ipython when it tries to load the modules of ginac.",
    "created_at": "2021-03-01T08:50:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431519",
    "user": "https://github.com/kliem"
}
```

I even get segementation fault in ipython when it tries to load the modules of ginac.



---

archive/issue_comments_431520.json:
```json
{
    "body": "This part in `numeric.cpp` leads to a segmentation fault when importing the module:\n\n\n```\n3321 #ifdef PYNAC_HAVE_LIBGIAC\n3322 giac::gen* numeric::to_giacgen(giac::context* cptr) const\n3323 {\n3324         if (t == LONG)\n3325                 return new giac::gen(v._long);\n3326 +----  7 lines: if (t == MPZ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n3333 +---- 10 lines: if (t == MPQ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n3343         else\n3344                 return nullptr;\n3345 }\n3346 #endif\n```\n\n\ngiac might not be linked correctly, but I don't know. Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.",
    "created_at": "2021-03-01T13:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431520",
    "user": "https://github.com/kliem"
}
```

This part in `numeric.cpp` leads to a segmentation fault when importing the module:


```
3321 #ifdef PYNAC_HAVE_LIBGIAC
3322 giac::gen* numeric::to_giacgen(giac::context* cptr) const
3323 {
3324         if (t == LONG)
3325                 return new giac::gen(v._long);
3326 +----  7 lines: if (t == MPZ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
3333 +---- 10 lines: if (t == MPQ) {-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
3343         else
3344                 return nullptr;
3345 }
3346 #endif
```


giac might not be linked correctly, but I don't know. Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.



---

archive/issue_comments_431521.json:
```json
{
    "body": "Also I would guess that you need to include the header files as `depends=...`.\n\nWhat is definitely missing is `gmptypes`. Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.\n\nAnyway, if I know just `./bootstrap; make` `pynac` and then include the folder `ginac`, then I'm back to your orignal problem.\n\nFirst I got:\n\n\n```\nImportError: /home/mi/kliem/Applications/pynac/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTVN5GiNaC9containerISt6vectorEE\n```\n\n\nThis I made go away by declaring things static in `pynac_wrap.h`. Then I get the original error about `library_init`.\n\nThe class `library_init` is defined in `ex.h`. However, the methods are then defined in `utils.cpp`.\n\nBut even if I change this, the error doesn't go ayay. By now, I don't understand anything anymore.",
    "created_at": "2021-03-01T15:33:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431521",
    "user": "https://github.com/kliem"
}
```

Also I would guess that you need to include the header files as `depends=...`.

What is definitely missing is `gmptypes`. Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.

Anyway, if I know just `./bootstrap; make` `pynac` and then include the folder `ginac`, then I'm back to your orignal problem.

First I got:


```
ImportError: /home/mi/kliem/Applications/pynac/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZTVN5GiNaC9containerISt6vectorEE
```


This I made go away by declaring things static in `pynac_wrap.h`. Then I get the original error about `library_init`.

The class `library_init` is defined in `ex.h`. However, the methods are then defined in `utils.cpp`.

But even if I change this, the error doesn't go ayay. By now, I don't understand anything anymore.



---

archive/issue_comments_431522.json:
```json
{
    "body": "I noticed while building the package that giac is automagically detected and used. Current sage package explicitly disable it. I remember chatting with Ralph when he made it available and that it was currently broken. So, first thing will be to disable it.",
    "created_at": "2021-03-01T20:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431522",
    "user": "https://github.com/kiwifb"
}
```

I noticed while building the package that giac is automagically detected and used. Current sage package explicitly disable it. I remember chatting with Ralph when he made it available and that it was currently broken. So, first thing will be to disable it.



---

archive/issue_comments_431523.json:
```json
{
    "body": "See https://github.com/pynac/pynac/pull/372 \"configure: Change default to --with-giac=no\"",
    "created_at": "2021-03-01T20:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431523",
    "user": "https://github.com/mkoeppe"
}
```

See https://github.com/pynac/pynac/pull/372 "configure: Change default to --with-giac=no"



---

archive/issue_comments_431524.json:
```json
{
    "body": "I pulled on your python_package branch, I guess I should have used the attached tarball.",
    "created_at": "2021-03-01T20:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431524",
    "user": "https://github.com/kiwifb"
}
```

I pulled on your python_package branch, I guess I should have used the attached tarball.



---

archive/issue_comments_431525.json:
```json
{
    "body": "I've just the branch into `python_package` and will also prepare a new tarball",
    "created_at": "2021-03-01T20:33:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431525",
    "user": "https://github.com/mkoeppe"
}
```

I've just the branch into `python_package` and will also prepare a new tarball



---

archive/issue_comments_431526.json:
```json
{
    "body": "Replying to [comment:30 gh-kliem]:\n> Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.\n\nThanks, renamed now",
    "created_at": "2021-03-01T20:35:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431526",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:30 gh-kliem]:
> Also it seems weird that you name the module `ginac.libpynac` but then you cimport `from ginac.pynac import *` in `pynac.pyx`. This isn't defined.

Thanks, renamed now



---

archive/issue_comments_431527.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-01T20:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431527",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431528.json:
```json
{
    "body": "OK, so pulling from your branch and building with my system packages and tools on gentoo with `python setup.py install --prefix=$someprefix` I cannot see anything obviously wrong with what is installed. `ldd -r pynac.cpython-39-x86_64-linux-gnu.so` just report what I am expecting to be missing, that is symbols from python itself.\n\nI am not currently setup for compiling on OS X, which may have trickier issue at linking.",
    "created_at": "2021-03-01T20:44:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431528",
    "user": "https://github.com/kiwifb"
}
```

OK, so pulling from your branch and building with my system packages and tools on gentoo with `python setup.py install --prefix=$someprefix` I cannot see anything obviously wrong with what is installed. `ldd -r pynac.cpython-39-x86_64-linux-gnu.so` just report what I am expecting to be missing, that is symbols from python itself.

I am not currently setup for compiling on OS X, which may have trickier issue at linking.



---

archive/issue_comments_431529.json:
```json
{
    "body": "Replying to [comment:29 gh-kliem]:\n> Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.\n\nI've now added some instructions to the README",
    "created_at": "2021-03-01T20:58:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431529",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:29 gh-kliem]:
> Also `./bootstrap` is missing from `setup.py`. Just running `./configure` isn't working.

I've now added some instructions to the README



---

archive/issue_comments_431530.json:
```json
{
    "body": "https://github.com/kliem/pynac/tree/python_package\n\nI did some experiments. Not all changes in this branch are necessary to get things to work. In particular, I did many experiments trying to avoid this segmentation fault, but I couldn't find something. It's ipython specific. Sage just complains about linkage.\n\nAs reported above I get a weird segmentation fault, whenever I import `ginac.pynac`.\n\nIt goes away magically, if I import `ginac.gmptypes` beforehand. I don't know why.\n\nGetting sage to start still does not work, because\n\n\n```\nImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE\n```\n\n\nI don't know why it would be undefined. It is sage specific. In an Ipython session it is fine even if I add something that uses it to `ginac/pynac.pyx'\n\n```diff\n+cdef py_gcd(n, k):\n+    return n*k\n+\n+\n+def init_function_table():\n+    py_funcs.py_gcd = &py_gcd\n+\n```\n\n\nIf I pip install this, I can run this function just fine in ipython:\n\n\n```\n(sage-sh) kliem@cofio:pynac$ ipython\nPython 3.7.3 (default, Jul 25 2020, 13:03:44) \nType 'copyright', 'credits' or 'license' for more information\nIPython 7.13.0 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: from ginac import gmptypes                                                                                                                                                                                                                                             \n\nIn [2]: from ginac.pynac import *                                                                                                                                                                                                                                              \n\nIn [3]: init_function_table()  \n```\n\n\nWhat is even more strange about this segementation fault is that in sage on develop branch I can run `import os` beforehand to fix this. This does not work in ipython.",
    "created_at": "2021-03-01T21:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431530",
    "user": "https://github.com/kliem"
}
```

https://github.com/kliem/pynac/tree/python_package

I did some experiments. Not all changes in this branch are necessary to get things to work. In particular, I did many experiments trying to avoid this segmentation fault, but I couldn't find something. It's ipython specific. Sage just complains about linkage.

As reported above I get a weird segmentation fault, whenever I import `ginac.pynac`.

It goes away magically, if I import `ginac.gmptypes` beforehand. I don't know why.

Getting sage to start still does not work, because


```
ImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE
```


I don't know why it would be undefined. It is sage specific. In an Ipython session it is fine even if I add something that uses it to `ginac/pynac.pyx'

```diff
+cdef py_gcd(n, k):
+    return n*k
+
+
+def init_function_table():
+    py_funcs.py_gcd = &py_gcd
+
```


If I pip install this, I can run this function just fine in ipython:


```
(sage-sh) kliem@cofio:pynac$ ipython
Python 3.7.3 (default, Jul 25 2020, 13:03:44) 
Type 'copyright', 'credits' or 'license' for more information
IPython 7.13.0 -- An enhanced Interactive Python. Type '?' for help.

In [1]: from ginac import gmptypes                                                                                                                                                                                                                                             

In [2]: from ginac.pynac import *                                                                                                                                                                                                                                              

In [3]: init_function_table()  
```


What is even more strange about this segementation fault is that in sage on develop branch I can run `import os` beforehand to fix this. This does not work in ipython.



---

archive/issue_comments_431531.json:
```json
{
    "body": "Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get\n\n```\n  Error compiling Cython file:\n  ------------------------------------------------------------\n  ...\n  # (at your option) any later version.\n  #                  http://www.gnu.org/licenses/\n  #*****************************************************************************\n\n  from cpython cimport *\n  from ginac.pynac cimport *\n  ^\n  ------------------------------------------------------------\n\n  ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found\n\n  Error compiling Cython file:\n  ------------------------------------------------------------\n  ...\n      defined by GiNaC. This allows us to prevent collisions with C++ level\n      special functions when a user asks to construct a symbolic function\n      with the same name.\n      \"\"\"\n      global GINAC_FN_SERIAL\n      GINAC_FN_SERIAL = g_registered_functions().size()\n                       ^\n  ------------------------------------------------------------\n\n  ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions\n  Compiling ginac/pynac.pyx because it changed.\n  [1/1] Cythonizing ginac/pynac.pyx\n```\n",
    "created_at": "2021-03-01T21:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431531",
    "user": "https://github.com/kiwifb"
}
```

Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get

```
  Error compiling Cython file:
  ------------------------------------------------------------
  ...
  # (at your option) any later version.
  #                  http://www.gnu.org/licenses/
  #*****************************************************************************

  from cpython cimport *
  from ginac.pynac cimport *
  ^
  ------------------------------------------------------------

  ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found

  Error compiling Cython file:
  ------------------------------------------------------------
  ...
      defined by GiNaC. This allows us to prevent collisions with C++ level
      special functions when a user asks to construct a symbolic function
      with the same name.
      """
      global GINAC_FN_SERIAL
      GINAC_FN_SERIAL = g_registered_functions().size()
                       ^
  ------------------------------------------------------------

  ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions
  Compiling ginac/pynac.pyx because it changed.
  [1/1] Cythonizing ginac/pynac.pyx
```




---

archive/issue_comments_431532.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2021-03-02T02:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431532",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_431533.json:
```json
{
    "body": "I have pushed a few more changes to the pynac branch and have set up testing against this ticket - running at https://github.com/mkoeppe/pynac/runs/2010476345",
    "created_at": "2021-03-02T05:42:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431533",
    "user": "https://github.com/mkoeppe"
}
```

I have pushed a few more changes to the pynac branch and have set up testing against this ticket - running at https://github.com/mkoeppe/pynac/runs/2010476345



---

archive/issue_comments_431534.json:
```json
{
    "body": "Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.\n\nAfter adding it, the build runs fine. Sage doens't start with the same stupid error:\n\n\n```\nImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE\n```\n\n\nThe segmentation fault in ipython went away for an `ImportError`:\n\n\n```\nImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN4giac25i_lex_is_strictly_greaterERKNS_7index_mES2_\n```\n\n\n\nReplying to [comment:40 fbissey]:\n> Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get\n> {{{\n>   Error compiling Cython file:\n>   ------------------------------------------------------------\n>   ...\n>   # (at your option) any later version.\n>   #                  http://www.gnu.org/licenses/\n>   #*****************************************************************************\n> \n>   from cpython cimport *\n>   from ginac.pynac cimport *\n>   ^\n>   ------------------------------------------------------------\n> \n>   ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found\n> \n>   Error compiling Cython file:\n>   ------------------------------------------------------------\n>   ...\n>       defined by GiNaC. This allows us to prevent collisions with C++ level\n>       special functions when a user asks to construct a symbolic function\n>       with the same name.\n>       \"\"\"\n>       global GINAC_FN_SERIAL\n>       GINAC_FN_SERIAL = g_registered_functions().size()\n>                        ^\n>   ------------------------------------------------------------\n> \n>   ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions\n>   Compiling ginac/pynac.pyx because it changed.\n>   [1/1] Cythonizing ginac/pynac.pyx\n> }}}",
    "created_at": "2021-03-02T06:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431534",
    "user": "https://github.com/kliem"
}
```

Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.

After adding it, the build runs fine. Sage doens't start with the same stupid error:


```
ImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE
```


The segmentation fault in ipython went away for an `ImportError`:


```
ImportError: /srv/public/kliem/sage/local/lib/python3.7/site-packages/ginac/pynac.cpython-37m-x86_64-linux-gnu.so: undefined symbol: _ZN4giac25i_lex_is_strictly_greaterERKNS_7index_mES2_
```



Replying to [comment:40 fbissey]:
> Trying to build this branch from vanilla sage, pynac building fails miserably, unlike my simple build from from your git fork. I could import pynac.ginac when build from your git repo, but here I get
> {{{
>   Error compiling Cython file:
>   ------------------------------------------------------------
>   ...
>   # (at your option) any later version.
>   #                  http://www.gnu.org/licenses/
>   #*****************************************************************************
> 
>   from cpython cimport *
>   from ginac.pynac cimport *
>   ^
>   ------------------------------------------------------------
> 
>   ginac/pynac.pyx:18:0: 'ginac/pynac.pxd' not found
> 
>   Error compiling Cython file:
>   ------------------------------------------------------------
>   ...
>       defined by GiNaC. This allows us to prevent collisions with C++ level
>       special functions when a user asks to construct a symbolic function
>       with the same name.
>       """
>       global GINAC_FN_SERIAL
>       GINAC_FN_SERIAL = g_registered_functions().size()
>                        ^
>   ------------------------------------------------------------
> 
>   ginac/pynac.pyx:30:22: undeclared name not builtin: g_registered_functions
>   Compiling ginac/pynac.pyx because it changed.
>   [1/1] Cythonizing ginac/pynac.pyx
> }}}



---

archive/issue_comments_431535.json:
```json
{
    "body": "Replying to [comment:26 gh-kliem]:\n> First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.\n> \n> Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.\n\nHas anyone experienced this? This seems to be a bug in our build system?",
    "created_at": "2021-03-02T06:46:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431535",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:26 gh-kliem]:
> First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.
> 
> Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.

Has anyone experienced this? This seems to be a bug in our build system?



---

archive/issue_comments_431536.json:
```json
{
    "body": "Replying to [comment:44 gh-kliem]:\n> Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.\n\n`pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.\nInstallation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345",
    "created_at": "2021-03-02T06:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431536",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:44 gh-kliem]:
> Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.

`pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.
Installation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345



---

archive/issue_comments_431537.json:
```json
{
    "body": "Replying to [comment:45 gh-kliem]:\n> Replying to [comment:26 gh-kliem]:\n> > First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.\n> > \n> > Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.\n> \n> Has anyone experienced this? This seems to be a bug in our build system?\n\nYes, quite possible that the install cleaner only handles Python modules and extensions but not package data.",
    "created_at": "2021-03-02T06:53:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431537",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:45 gh-kliem]:
> Replying to [comment:26 gh-kliem]:
> > First of all let me remark that I wasn't even able to build it at all until I manually removed all files in `build/pkgs/sagelib/src/build/cythonized/sage/libs/pynac/`.
> > 
> > Until then there was still the old `pynac_wrap.h` dangling around and it did not clean itself.
> 
> Has anyone experienced this? This seems to be a bug in our build system?

Yes, quite possible that the install cleaner only handles Python modules and extensions but not package data.



---

archive/issue_comments_431538.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-02T07:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431538",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431539.json:
```json
{
    "body": "Just packaged up current HEAD of my pynac `python_package` branch.",
    "created_at": "2021-03-02T07:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431539",
    "user": "https://github.com/mkoeppe"
}
```

Just packaged up current HEAD of my pynac `python_package` branch.



---

archive/issue_comments_431540.json:
```json
{
    "body": "Attachment [py-ginac-0.7.27.tar.gz](tarball://root/attachments/some-uuid/ticket30534/py-ginac-0.7.27.tar.gz) by @mkoeppe created at 2021-03-02 07:07:14",
    "created_at": "2021-03-02T07:07:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431540",
    "user": "https://github.com/mkoeppe"
}
```

Attachment [py-ginac-0.7.27.tar.gz](tarball://root/attachments/some-uuid/ticket30534/py-ginac-0.7.27.tar.gz) by @mkoeppe created at 2021-03-02 07:07:14



---

archive/issue_comments_431541.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-02T07:08:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431541",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431542.json:
```json
{
    "body": "(and another time.)",
    "created_at": "2021-03-02T07:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431542",
    "user": "https://github.com/mkoeppe"
}
```

(and another time.)



---

archive/issue_comments_431543.json:
```json
{
    "body": "This is fixed with the new attachment. Before there was a version where `ginac/pynac.pxd` was missing from configure for some reason.\n\nReplying to [comment:46 mkoeppe]:\n> Replying to [comment:44 gh-kliem]:\n> > Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.\n> \n> `pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.\n> Installation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345\n> \n> \n>",
    "created_at": "2021-03-02T07:23:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431543",
    "user": "https://github.com/kliem"
}
```

This is fixed with the new attachment. Before there was a version where `ginac/pynac.pxd` was missing from configure for some reason.

Replying to [comment:46 mkoeppe]:
> Replying to [comment:44 gh-kliem]:
> > Yes, same error here. `ginac/pynax.pdx` is missing from the configure file now.
> 
> `pynac.pxd` is generated by `setup.py` from `pynac.pxd.in` via the `configure` script.
> Installation of the new package can be seen to succeed in https://github.com/mkoeppe/pynac/runs/2010476345
> 
> 
>



---

archive/issue_comments_431544.json:
```json
{
    "body": "With the new branch I can now do `from ginac.pynac import *` without an error raising in `ipython`. The `ImportError` when loading sage itself still persists.",
    "created_at": "2021-03-02T07:24:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431544",
    "user": "https://github.com/kliem"
}
```

With the new branch I can now do `from ginac.pynac import *` without an error raising in `ipython`. The `ImportError` when loading sage itself still persists.



---

archive/issue_comments_431545.json:
```json
{
    "body": "So maybe this module needs to include something on runtime and this doesn't work. So `from ginac.pynac import *` works fine, but the `cimport` doesn't.\n\nIn my experiments, the `os.path.dirname(__file__)` in the setup file didn't do anything. Maybe the `include_dirs` are set up wrong?",
    "created_at": "2021-03-02T07:33:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431545",
    "user": "https://github.com/kliem"
}
```

So maybe this module needs to include something on runtime and this doesn't work. So `from ginac.pynac import *` works fine, but the `cimport` doesn't.

In my experiments, the `os.path.dirname(__file__)` in the setup file didn't do anything. Maybe the `include_dirs` are set up wrong?



---

archive/issue_comments_431546.json:
```json
{
    "body": "OK, tried with all the new stuff. Stopped at the documentation again but different symbol than in comment:23\n\n```\n[dochtml] ImportError: /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE\n```\n\nwhich is\n\n```\n$ c++filt -n _ZN5GiNaC8py_funcsE\nGiNaC::py_funcs\n```\n",
    "created_at": "2021-03-02T09:59:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431546",
    "user": "https://github.com/kiwifb"
}
```

OK, tried with all the new stuff. Stopped at the documentation again but different symbol than in comment:23

```
[dochtml] ImportError: /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so: undefined symbol: _ZN5GiNaC8py_funcsE
```

which is

```
$ c++filt -n _ZN5GiNaC8py_funcsE
GiNaC::py_funcs
```




---

archive/issue_comments_431547.json:
```json
{
    "body": "Running `ldd`, removing python calls and going through `c++filt -n` the following symbols are undefined  and should be replaced by calls since you cannot link to the python module\n\n```\nldd -r /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so | grep _Z | c++filt -n\nundefined symbol: GiNaC::py_funcs       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: vtable for GiNaC::container<std::vector>      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::numeric   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::symbol    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::library_init::~library_init()  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::container<std::vector>::tinfo_static   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: vtable for GiNaC::constant    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::I      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::_num0_bp       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::pseries   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: typeinfo for GiNaC::basic     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&)   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::library_init::library_init()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: ginac_pyinit_Float(_object*)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, std::vector<GiNaC::ex, std::allocator<GiNaC::ex> > const&, bool)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: ginac_pyinit_I(_object*)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: std::vector<GiNaC::ex, std::allocator<GiNaC::ex> >::~vector() (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::relational::decide() const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&, GiNaC::ex const&) (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::sorted_op(unsigned long) const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::construct_from_basic(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::pseries::is_terminating() const        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int)       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::registered_functions()       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::compare(GiNaC::ex const&) const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::numeric::to_pyobject() const   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::relational::the_operator() const       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&)     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::ex::construct_from_int(int)    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::constant::constant()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::basic::hold() const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: ginac_pyinit_Integer(_object*)        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\nundefined symbol: GiNaC::basic::operator=(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)\n```\n",
    "created_at": "2021-03-02T10:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431547",
    "user": "https://github.com/kiwifb"
}
```

Running `ldd`, removing python calls and going through `c++filt -n` the following symbols are undefined  and should be replaced by calls since you cannot link to the python module

```
ldd -r /home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so | grep _Z | c++filt -n
undefined symbol: GiNaC::py_funcs       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: vtable for GiNaC::container<std::vector>      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::numeric   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::symbol    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::library_init::~library_init()  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::container<std::vector>::tinfo_static   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: vtable for GiNaC::constant    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::I      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::_num0_bp       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::pseries   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: typeinfo for GiNaC::basic     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&)   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::library_init::library_init()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: ginac_pyinit_Float(_object*)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, std::vector<GiNaC::ex, std::allocator<GiNaC::ex> > const&, bool)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: ginac_pyinit_I(_object*)      (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: std::vector<GiNaC::ex, std::allocator<GiNaC::ex> >::~vector() (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::relational::decide() const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&, GiNaC::ex const&, GiNaC::ex const&) (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::sorted_op(unsigned long) const     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::construct_from_basic(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::pseries::is_terminating() const        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int)       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::registered_functions()       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::compare(GiNaC::ex const&) const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::numeric::to_pyobject() const   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::relational::the_operator() const       (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::function::function(unsigned int, GiNaC::ex const&)     (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::ex::construct_from_int(int)    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::constant::constant()   (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::basic::hold() const    (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: ginac_pyinit_Integer(_object*)        (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
undefined symbol: GiNaC::basic::operator=(GiNaC::basic const&)  (/home/fbissey/sandbox/git-fork/sage/local/lib/python3.9/site-packages/sage/libs/pynac/pynac.cpython-39-x86_64-linux-gnu.so)
```




---

archive/issue_comments_431548.json:
```json
{
    "body": "Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`",
    "created_at": "2021-03-02T16:17:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431548",
    "user": "https://github.com/mkoeppe"
}
```

Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`



---

archive/issue_comments_431549.json:
```json
{
    "body": "Replying to [comment:57 mkoeppe]:\n> Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`\n\nBut why does\n\n\n```\nsage: cython(''' \n....: from sage.libs.pynac.pynac cimport * \n....: ''')    \n```\n\n\nworks just fine on develop? I would say that things should work just fine, once everything is set up correctly. However, I don't know how to resolve the problems as I'm currently not even able to `cimport` from my own little two files project.",
    "created_at": "2021-03-02T17:11:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431549",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:57 mkoeppe]:
> Looks like trying to pull in everything to `sage.libs.pynac` by `from ginac.pynac cimport *` is a mistake and instead all modules that need pynac should `cimport` more specifically from `ginac.pynac`

But why does


```
sage: cython(''' 
....: from sage.libs.pynac.pynac cimport * 
....: ''')    
```


works just fine on develop? I would say that things should work just fine, once everything is set up correctly. However, I don't know how to resolve the problems as I'm currently not even able to `cimport` from my own little two files project.



---

archive/issue_comments_431550.json:
```json
{
    "body": "I might have found the problem:\n\nIn `setup.py`:\n\n\n```diff\n-       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp']},\n+       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp', '*.cpp']},\n```\n\n\nThis will place the `.cpp` files in the correct directory. We need them, because when we cimport we recompile some of them. When the `.cpp` files are not there, we get the missing symbols.\n\nAfter doing this, I get a new error:\n\n\n```\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/constant.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/constant.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/ring.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/ring.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/function.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/function.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/pynac.o -L/srv/public/kliem/sage/local/lib -lgsl -lflint -lgmp -lm -lopenblas -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/expression.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources -lpari\n[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac\n[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status\n[sagelib-9.3.beta7] error: command 'g++' failed with exit status 1\n```\n\n\nBut I think, this might be easier to resolve.",
    "created_at": "2021-03-02T18:22:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431550",
    "user": "https://github.com/kliem"
}
```

I might have found the problem:

In `setup.py`:


```diff
-       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp']},
+       package_data = {'ginac': ['*.pxd', '*.h', '*.hpp', '*.cpp']},
```


This will place the `.cpp` files in the correct directory. We need them, because when we cimport we recompile some of them. When the `.cpp` files are not there, we get the missing symbols.

After doing this, I get a new error:


```
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/constant.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/constant.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/ring.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/ring.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/function.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/function.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/libs/pynac/pynac.o -L/srv/public/kliem/sage/local/lib -lgsl -lflint -lgmp -lm -lopenblas -lginac -o build/lib.linux-x86_64-3.7/sage/libs/pynac/pynac.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] g++ -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-rpath-link,/srv/public/kliem/sage/local/lib -L/srv/public/kliem/sage/local/lib -Wl,-rpath,/srv/public/kliem/sage/local/lib -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.7/build/cythonized/sage/symbolic/expression.o -lflint -lgmp -lginac -o build/lib.linux-x86_64-3.7/sage/symbolic/expression.cpython-37m-x86_64-linux-gnu.so -L/srv/public/kliem/sage/local/lib -lfactory -lntl -lgmp -lomalloc -lsingular_resources -lpari
[sagelib-9.3.beta7] /usr/bin/ld: cannot find -lginac
[sagelib-9.3.beta7] collect2: error: ld returned 1 exit status
[sagelib-9.3.beta7] error: command 'g++' failed with exit status 1
```


But I think, this might be easier to resolve.



---

archive/issue_comments_431551.json:
```json
{
    "body": "This can't be the right fix. The .cpp files should not be installed.",
    "created_at": "2021-03-02T18:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431551",
    "user": "https://github.com/mkoeppe"
}
```

This can't be the right fix. The .cpp files should not be installed.



---

archive/issue_comments_431552.json:
```json
{
    "body": "Where's that `-lginac` coming from??",
    "created_at": "2021-03-02T18:30:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431552",
    "user": "https://github.com/mkoeppe"
}
```

Where's that `-lginac` coming from??



---

archive/issue_comments_431553.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-02T18:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431553",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431554.json:
```json
{
    "body": "Same problem. Same undefined symbol.\n\nReplying to [comment:62 git]:\n> Branch pushed to git repo; I updated commit sha1. New commits:\n> ||[b4da02f](https://git.sagemath.org/sage.git/commit/?id=b4da02f2732e16a646c097c67c06c80686ba391f)||`cimport directly from ginac.pynac`||",
    "created_at": "2021-03-02T18:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431554",
    "user": "https://github.com/kliem"
}
```

Same problem. Same undefined symbol.

Replying to [comment:62 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[b4da02f](https://git.sagemath.org/sage.git/commit/?id=b4da02f2732e16a646c097c67c06c80686ba391f)||`cimport directly from ginac.pynac`||



---

archive/issue_comments_431555.json:
```json
{
    "body": "Replying to [comment:60 mkoeppe]:\n> This can't be the right fix. The .cpp files should not be installed.\n\nWhen you cimport you recompile `.pxd` file. And by this it is trying to recompile everything that was included there. If the corresponding `.cpp` files aren't found, there is a problem with that.\n\nIf we don't want to recompile everything, then we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.",
    "created_at": "2021-03-02T18:46:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431555",
    "user": "https://github.com/kliem"
}
```

Replying to [comment:60 mkoeppe]:
> This can't be the right fix. The .cpp files should not be installed.

When you cimport you recompile `.pxd` file. And by this it is trying to recompile everything that was included there. If the corresponding `.cpp` files aren't found, there is a problem with that.

If we don't want to recompile everything, then we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.



---

archive/issue_comments_431556.json:
```json
{
    "body": "Replying to [comment:64 gh-kliem]:\n> we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.\n\nI don't know about this mechanism, but it sounds like what I am looking for. Could you elaborate on this or push a change to the branch?",
    "created_at": "2021-03-02T18:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431556",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:64 gh-kliem]:
> we should put the `cdef extern from` into `pynac.pyx` and only do the type definitions in `pynax.pxd`.

I don't know about this mechanism, but it sounds like what I am looking for. Could you elaborate on this or push a change to the branch?



---

archive/issue_comments_431557.json:
```json
{
    "body": "I'll check, if that fixes things.",
    "created_at": "2021-03-02T18:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431557",
    "user": "https://github.com/kliem"
}
```

I'll check, if that fixes things.



---

archive/issue_comments_431558.json:
```json
{
    "body": "I don't know, if that will work. I get many errors and by no means do I know how to fix them.\n\nE.g.\n\n\n```\n[pynac-0.7.28.p18]   gcc -DNDEBUG -g -fwrapv -O2 -Wall -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -Iginac -I./ginac -I. -I. -I/srv/public/kliem/sage/local/lib/python3.7/site-packages/pip/_vendor/pep517 -I/srv/public/kliem/sage/local -I/usr/lib/python37.zip -I/usr/lib/python3.7 -I/usr/lib/python3.7/lib-dynload -I/srv/public/kliem/sage/local/lib/python3.7/site-packages -I/srv/public/kliem/sage/local/include -I/usr/include/python3.7m -c ginac/pynac.cpp -o build/temp.linux-x86_64-3.7/ginac/pynac.o -std=c++11 -DSING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -I/srv/public/kliem/sage/local/include\n[pynac-0.7.28.p18]   ginac/pynac.cpp:1875:50: error: no declaration matches '__pyx_t_5ginac_5pynac_GFunctionOptVector& GiNaC::function::registered_functions()'\n[pynac-0.7.28.p18]    static __pyx_t_5ginac_5pynac_GFunctionOptVector &GiNaC::function::registered_functions(void); /*proto*/\n[pynac-0.7.28.p18]                                                     ^~~~~\n[pynac-0.7.28.p18]   In file included from ginac/ginac.h:54,\n[pynac-0.7.28.p18]                    from ginac/pynac_wrap.h:13,\n[pynac-0.7.28.p18]                    from ginac/pynac.cpp:786:\n[pynac-0.7.28.p18]   ginac/function.h:409:41: note: candidate is: 'static std::vector<GiNaC::function_options>& GiNaC::function::registered_functions()'\n[pynac-0.7.28.p18]     static std::vector<function_options> & registered_functions();\n[pynac-0.7.28.p18]                                            ^~~~~~~~~~~~~~~~~~~~\n[pynac-0.7.28.p18]   ginac/function.h:340:7: note: 'class GiNaC::function' defined here\n[pynac-0.7.28.p18]    class function : public exprseq\n```\n\n\nI don't even know if it is possible to import a `cppclass` in the `.pyx` part and to define in in the header then.\n\nThis option is definitely not mentioned here: https://cython.readthedocs.io/en/latest/src/userguide/wrapping_CPlusPlus.html\n\nThe problem with this entire setup is that ginac was never properly compiled and linked as a C++ module. I have the feeling that you are trying to achieve something that cython doesn't want you to do.\n\n- If you have a C++ library you can create a cython header for this and directly expose the cpp classes via that header (e.g. you can create a pip installable GMP header that uses an existing GMP installation).\n- If you have some C++ files and you want to expose them directly by a cython wrapper, but the header of this wrapper will recompile your files and thus every module cimporting from this wrapper needs to be able to recompile this as well.\n- You can create a proper wrapper class of a cpp class. This class can be used by other modules without recompiling the actual cpp class.\n\nThis is what the picture looks like to me.",
    "created_at": "2021-03-03T10:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431558",
    "user": "https://github.com/kliem"
}
```

I don't know, if that will work. I get many errors and by no means do I know how to fix them.

E.g.


```
[pynac-0.7.28.p18]   gcc -DNDEBUG -g -fwrapv -O2 -Wall -march=native -O3 -g -Wdate-time -D_FORTIFY_SOURCE=2 -fPIC -Iginac -I./ginac -I. -I. -I/srv/public/kliem/sage/local/lib/python3.7/site-packages/pip/_vendor/pep517 -I/srv/public/kliem/sage/local -I/usr/lib/python37.zip -I/usr/lib/python3.7 -I/usr/lib/python3.7/lib-dynload -I/srv/public/kliem/sage/local/lib/python3.7/site-packages -I/srv/public/kliem/sage/local/include -I/usr/include/python3.7m -c ginac/pynac.cpp -o build/temp.linux-x86_64-3.7/ginac/pynac.o -std=c++11 -DSING_NDEBUG -DOM_NDEBUG -DSING_NDEBUG -DOM_NDEBUG -I/srv/public/kliem/sage/local/include
[pynac-0.7.28.p18]   ginac/pynac.cpp:1875:50: error: no declaration matches '__pyx_t_5ginac_5pynac_GFunctionOptVector& GiNaC::function::registered_functions()'
[pynac-0.7.28.p18]    static __pyx_t_5ginac_5pynac_GFunctionOptVector &GiNaC::function::registered_functions(void); /*proto*/
[pynac-0.7.28.p18]                                                     ^~~~~
[pynac-0.7.28.p18]   In file included from ginac/ginac.h:54,
[pynac-0.7.28.p18]                    from ginac/pynac_wrap.h:13,
[pynac-0.7.28.p18]                    from ginac/pynac.cpp:786:
[pynac-0.7.28.p18]   ginac/function.h:409:41: note: candidate is: 'static std::vector<GiNaC::function_options>& GiNaC::function::registered_functions()'
[pynac-0.7.28.p18]     static std::vector<function_options> & registered_functions();
[pynac-0.7.28.p18]                                            ^~~~~~~~~~~~~~~~~~~~
[pynac-0.7.28.p18]   ginac/function.h:340:7: note: 'class GiNaC::function' defined here
[pynac-0.7.28.p18]    class function : public exprseq
```


I don't even know if it is possible to import a `cppclass` in the `.pyx` part and to define in in the header then.

This option is definitely not mentioned here: https://cython.readthedocs.io/en/latest/src/userguide/wrapping_CPlusPlus.html

The problem with this entire setup is that ginac was never properly compiled and linked as a C++ module. I have the feeling that you are trying to achieve something that cython doesn't want you to do.

- If you have a C++ library you can create a cython header for this and directly expose the cpp classes via that header (e.g. you can create a pip installable GMP header that uses an existing GMP installation).
- If you have some C++ files and you want to expose them directly by a cython wrapper, but the header of this wrapper will recompile your files and thus every module cimporting from this wrapper needs to be able to recompile this as well.
- You can create a proper wrapper class of a cpp class. This class can be used by other modules without recompiling the actual cpp class.

This is what the picture looks like to me.



---

archive/issue_comments_431559.json:
```json
{
    "body": "I digged into a bit. Not that I know a solution now, but at least I understand somehow what is going on.\n\nThe question is really what we want. `cdef extern from` in a `.pxd`-file assumes that every file cimporting this is linked against the same library or has access to the same sources. I don't think we can change this. So the way this is we must either compile ginac as a library and link against it or ship the sources (the later being really awful, because we have plenty of duplications and it takes forever to compile).\n\nYou can use `cdef extern` in the `pyx` however and expose the definitions in the header. This seems a very clean way of doing it, but there are tons of obstructions along the way. E.g. the functions must be declared static: https://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#implementing-functions-in-c",
    "created_at": "2021-07-01T07:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431559",
    "user": "https://github.com/kliem"
}
```

I digged into a bit. Not that I know a solution now, but at least I understand somehow what is going on.

The question is really what we want. `cdef extern from` in a `.pxd`-file assumes that every file cimporting this is linked against the same library or has access to the same sources. I don't think we can change this. So the way this is we must either compile ginac as a library and link against it or ship the sources (the later being really awful, because we have plenty of duplications and it takes forever to compile).

You can use `cdef extern` in the `pyx` however and expose the definitions in the header. This seems a very clean way of doing it, but there are tons of obstructions along the way. E.g. the functions must be declared static: https://cython.readthedocs.io/en/latest/src/userguide/external_C_code.html#implementing-functions-in-c



---

archive/issue_comments_431560.json:
```json
{
    "body": "And apparently with a cppclass it works even in the header? (Different project, but there it seemed to work.)\n\nI'm confused. I will see, if I can find out, what is causing the problem.",
    "created_at": "2021-07-01T07:57:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431560",
    "user": "https://github.com/kliem"
}
```

And apparently with a cppclass it works even in the header? (Different project, but there it seemed to work.)

I'm confused. I will see, if I can find out, what is causing the problem.



---

archive/issue_comments_431561.json:
```json
{
    "body": "Thanks for looking into this!",
    "created_at": "2021-07-01T16:29:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431561",
    "user": "https://github.com/mkoeppe"
}
```

Thanks for looking into this!



---

archive/issue_comments_431562.json:
```json
{
    "body": "New approach: #32386 (Merge pynac as src/sage/symbolics/ginac)",
    "created_at": "2021-08-16T17:27:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431562",
    "user": "https://github.com/mkoeppe"
}
```

New approach: #32386 (Merge pynac as src/sage/symbolics/ginac)



---

archive/issue_comments_431563.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-08-16T20:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431563",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_431564.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-16T21:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431564",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_431565.json:
```json
{
    "body": "Sure, let's try the other way.",
    "created_at": "2021-08-16T21:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431565",
    "user": "https://github.com/kiwifb"
}
```

Sure, let's try the other way.



---

archive/issue_events_027841.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-26T02:08:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/30297#event-27841"
}
```



---

archive/issue_comments_431566.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-08-26T02:08:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431566",
    "user": "https://github.com/mkoeppe"
}
```

Resolution: invalid



---

archive/issue_comments_431567.json:
```json
{
    "body": "Removing the branch to avoid confusion in the future.",
    "created_at": "2021-08-27T16:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30297#issuecomment-431567",
    "user": "https://github.com/kliem"
}
```

Removing the branch to avoid confusion in the future.
