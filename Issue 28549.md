# Issue 28549: breakage in finite field with explicit modulus

archive/issues_028549.json:
```json
{
    "body": "CC:  @slel\n\nRun the following fragment twice in the same Sage session.\n\n```\nsage: K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)\n....: x=a^9\n....: y=a^21\n....: z=1/x\n....: v=vector([1,y,y^2,y^3,y^4,y^5,y^6])\n....: S=matrix([[1,1,1,1,1,1,1],[1,z,z^2,z^3,z^4,z^5,z^6],[1,(z^2),(z^2)^2,(z^2)^3,(z^2)^4,(z^2)^5,(z^2)^6],[1,(z^3),(z^3)^2,(z^3)^3,(z^3)^4,(z^\n....: 3)^5,(z^3)^6],[1,(z^4),(z^4)^2,(z^4)^3,(z^4)^4,(z^4)^5,(z^4)^6],[1,(z^5),(z^5)^2,(z^5)^3,(z^5)^4,(z^5)^5,(z^5)^6],[1,(z^6),(z^6)^2,(z^6)^3\n....: ,(z^6)^4,(z^6)^5,(z^6)^6]])\n....: w=S*v\n....: w\n```\n\nThe 1st run succeeds, the 2nd and later runs produce\n\n```\nValueError                                Traceback (most recent call last)\n<ipython-input-7-e412ac7787ee> in <module>()\n----> 1 K = GF(Integer(2)**Integer(6), modulus=x**Integer(6) + x**Integer(4) + x**Integer(3) + x + Integer(1), names=('a',)); (a,) = K._first_ngens(1)\n      2 x=a**Integer(9)\n      3 y=a**Integer(21)\n      4 z=Integer(1)/x\n      5 v=vector([Integer(1),y,y**Integer(2),y**Integer(3),y**Integer(4),y**Integer(5),y**Integer(6)])\n\n/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/structure/factory.pyx in sage.structure.factory.UniqueFactory.__call__ (build/cythonized/sage/structure/factory.c:2162)()\n    365             False\n    366         \"\"\"\n--> 367         key, kwds = self.create_key_and_extra_args(*args, **kwds)\n    368         version = self.get_version(sage_version)\n    369         return self.get_object(version, key, kwds)\n\n/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/rings/finite_rings/finite_field_constructor.py in create_key_and_extra_args(self, order, name, modulus, names, impl, proof, check_irreducible, prefix, repr, elem_cache, **kwds)\n    583 \n    584                     if modulus.degree() != n:\n--> 585                         raise ValueError(\"the degree of the modulus does not equal the degree of the field\")\n    586                     if check_irreducible and not modulus.is_irreducible():\n    587                         raise ValueError(\"finite field modulus must be irreducible but it is not\")\n\nValueError: the degree of the modulus does not equal the degree of the field\n```\n\n\nNote that this does not happen if modulus is not given.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28786\n\n",
    "created_at": "2019-11-22T09:50:17Z",
    "labels": [
        "finite rings",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "breakage in finite field with explicit modulus",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28549",
    "user": "@dimpase"
}
```
CC:  @slel

Run the following fragment twice in the same Sage session.

```
sage: K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)
....: x=a^9
....: y=a^21
....: z=1/x
....: v=vector([1,y,y^2,y^3,y^4,y^5,y^6])
....: S=matrix([[1,1,1,1,1,1,1],[1,z,z^2,z^3,z^4,z^5,z^6],[1,(z^2),(z^2)^2,(z^2)^3,(z^2)^4,(z^2)^5,(z^2)^6],[1,(z^3),(z^3)^2,(z^3)^3,(z^3)^4,(z^
....: 3)^5,(z^3)^6],[1,(z^4),(z^4)^2,(z^4)^3,(z^4)^4,(z^4)^5,(z^4)^6],[1,(z^5),(z^5)^2,(z^5)^3,(z^5)^4,(z^5)^5,(z^5)^6],[1,(z^6),(z^6)^2,(z^6)^3
....: ,(z^6)^4,(z^6)^5,(z^6)^6]])
....: w=S*v
....: w
```

The 1st run succeeds, the 2nd and later runs produce

```
ValueError                                Traceback (most recent call last)
<ipython-input-7-e412ac7787ee> in <module>()
----> 1 K = GF(Integer(2)**Integer(6), modulus=x**Integer(6) + x**Integer(4) + x**Integer(3) + x + Integer(1), names=('a',)); (a,) = K._first_ngens(1)
      2 x=a**Integer(9)
      3 y=a**Integer(21)
      4 z=Integer(1)/x
      5 v=vector([Integer(1),y,y**Integer(2),y**Integer(3),y**Integer(4),y**Integer(5),y**Integer(6)])

/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/structure/factory.pyx in sage.structure.factory.UniqueFactory.__call__ (build/cythonized/sage/structure/factory.c:2162)()
    365             False
    366         """
--> 367         key, kwds = self.create_key_and_extra_args(*args, **kwds)
    368         version = self.get_version(sage_version)
    369         return self.get_object(version, key, kwds)

/mnt/opt/Sage/sage-dev/local/lib/python3.7/site-packages/sage/rings/finite_rings/finite_field_constructor.py in create_key_and_extra_args(self, order, name, modulus, names, impl, proof, check_irreducible, prefix, repr, elem_cache, **kwds)
    583 
    584                     if modulus.degree() != n:
--> 585                         raise ValueError("the degree of the modulus does not equal the degree of the field")
    586                     if check_irreducible and not modulus.is_irreducible():
    587                         raise ValueError("finite field modulus must be irreducible but it is not")

ValueError: the degree of the modulus does not equal the degree of the field
```


Note that this does not happen if modulus is not given.

Issue created by migration from https://trac.sagemath.org/ticket/28786





---

archive/issue_comments_403080.json:
```json
{
    "body": "perhaps making it imposible to use a symbolic variable to define modulus will do the trick. Indeed, if I do \n\n```\nT.<x>=GF(2)[]\nK.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)\n```\n\nthen the error goes away.\n\nStrangely, `x` is the only symbolic variable that is accepted this way.\nTrying to use a symbolic variable with a different name does not work\n\n```\nsage: var('tt'); K.<a>=GF(2^6, modulus=tt^6 + tt^4 + tt^3 + tt + 1)\n...\nTypeError: tt is not a variable of Univariate Polynomial Ring in x over Finite Field of size 2 (using GF2X)\n```\n\nDoes GF2X do something too smart with `x`?",
    "created_at": "2019-11-22T10:13:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28549#issuecomment-403080",
    "user": "@dimpase"
}
```

perhaps making it imposible to use a symbolic variable to define modulus will do the trick. Indeed, if I do 

```
T.<x>=GF(2)[]
K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)
```

then the error goes away.

Strangely, `x` is the only symbolic variable that is accepted this way.
Trying to use a symbolic variable with a different name does not work

```
sage: var('tt'); K.<a>=GF(2^6, modulus=tt^6 + tt^4 + tt^3 + tt + 1)
...
TypeError: tt is not a variable of Univariate Polynomial Ring in x over Finite Field of size 2 (using GF2X)
```

Does GF2X do something too smart with `x`?



---

archive/issue_comments_403081.json:
```json
{
    "body": "I don't think this is a bug.  On the first run, you're taking advantage of the fact that `x` is predefined as a symbolic variable (and indeed, it's the only such variable).  The constructor for finite fields can take elements of the symbolic ring, though polynomials are better.  On the second, you've redefined `x`.\n\nThe error is triggered by just the following lines:\n\n```\nK.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)\nx = a^9\nK.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)\n```\n\n\nPerhaps a better error message in the case that modulus is a finite field element would be appropriate.",
    "created_at": "2019-11-22T16:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28549#issuecomment-403081",
    "user": "@roed314"
}
```

I don't think this is a bug.  On the first run, you're taking advantage of the fact that `x` is predefined as a symbolic variable (and indeed, it's the only such variable).  The constructor for finite fields can take elements of the symbolic ring, though polynomials are better.  On the second, you've redefined `x`.

The error is triggered by just the following lines:

```
K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)
x = a^9
K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)
```


Perhaps a better error message in the case that modulus is a finite field element would be appropriate.



---

archive/issue_comments_403082.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2020-01-06T14:10:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28549#issuecomment-403082",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_403083.json:
```json
{
    "body": "Replying to [comment:3 roed]:\n> I don't think this is a bug. [...]\n>\n> The error is triggered by just the following lines:\n> {{{\n> K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)\n> x = a^9\n> K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)\n> }}}\n> \n> Perhaps a better error message in the case that modulus\n> is a finite field element would be appropriate.\n\nI agree. This ticket could do one or both of the following:\n\n- include a cautionary example in the docstring\n  for `FiniteField` (aka `GF`) (I recommend that)\n\n- make the error message more helpful, such as:\n  \"check that the polynomial variable used in the modulus\n  was indeed a polynomial variable, and not redefined\n  to be a field element for instance\" (maybe not needed\n  if the docstring has a cautionary example)",
    "created_at": "2021-03-20T00:05:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28549#issuecomment-403083",
    "user": "@slel"
}
```

Replying to [comment:3 roed]:
> I don't think this is a bug. [...]
>
> The error is triggered by just the following lines:
> {{{
> K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)
> x = a^9
> K.<a>=GF(2^6, modulus=x^6 + x^4 + x^3 + x + 1)
> }}}
> 
> Perhaps a better error message in the case that modulus
> is a finite field element would be appropriate.

I agree. This ticket could do one or both of the following:

- include a cautionary example in the docstring
  for `FiniteField` (aka `GF`) (I recommend that)

- make the error message more helpful, such as:
  "check that the polynomial variable used in the modulus
  was indeed a polynomial variable, and not redefined
  to be a field element for instance" (maybe not needed
  if the docstring has a cautionary example)



---

archive/issue_comments_403084.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28549",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28549#issuecomment-403084",
    "user": "@mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.
