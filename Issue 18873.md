# Issue 18873: inconsistency: invert ZZ(0) vs. QQ(0)

Issue created by migration from Trac.

Original creator: dkrenn

Original creation time: 2015-08-30 08:23:58


```
sage: ZZ(0)^(-1)
...
ZeroDivisionError: Rational division by zero
```

vs.

```
sage: QQ(0)^(-1)
...
FloatingPointError: Floating point exception
```

which is inconsistent (the latter should also raise a `ZeroDivisionError`.

FYI, `1/ZZ(0)` and `1/QQ(0)` both raise a `ZeroDivisionError`.


---

Comment by dkrenn created at 2015-08-30 08:48:57

Changing type from PLEASE CHANGE to defect.


---

Comment by jdemeyer created at 2015-08-30 09:52:08

Changing priority from major to critical.


---

Comment by ncohen created at 2015-08-30 12:48:08

(I modified the title, as a 'crash' hints that Sage may exist when the command is run)


---

Comment by jdemeyer created at 2015-08-30 12:53:31

Replying to [comment:4 ncohen]:
> (I modified the title, as a 'crash' hints that Sage may exist when the command is run)

I think "Sage crashes" is much closer to the reality than what you think.

Essentially, Sage does crash but the signal handling framework handles this crash and turns it into an exception.


---

Comment by behackl created at 2015-09-01 18:43:52

What about something like the following?


```diff
--- a/src/sage/rings/rational.pyx
+++ b/src/sage/rings/rational.pyx
`@``@` -2397,9 +2397,8 `@``@` cdef class Rational(sage.structure.element.FieldElement):
             mpz_pow_ui(mpq_numref(x.value), mpq_numref(_self.value), -nn)
             mpz_pow_ui(mpq_denref(x.value), mpq_denref(_self.value), -nn)
             # mpz_swap(mpq_numref(x.value), mpq_denref(x.value)) # still a segfault
-            mpq_inv(x.value, x.value)
             sig_off()
-            return x
+            return ~x
         elif nn > 0:
             sig_on()
             mpz_pow_ui(mpq_numref(x.value), mpq_numref(_self.value), nn)

```


Basically, thats similar to what happens in `rings/integer.pyx` (I think). With these changes, I have

```
sage: QQ(0)^(-1)
Traceback (most recent call last):
...
ZeroDivisionError: rational division by zero
```

... and all doctests in `rings/rational.pyx` pass as well. Any thoughts?


---

Comment by jdemeyer created at 2015-09-01 20:36:21

The `~x` trick would work but be much less efficient than the current code.


---

Comment by behackl created at 2015-09-01 21:31:04

... well, that makes sense. The following approach (pushed to the branch attached to this ticket) should be better -- however, I really don't know if thats the best way to check if the fraction is 0...


```diff
--- a/src/sage/rings/rational.pyx
+++ b/src/sage/rings/rational.pyx
`@``@` -2329,6 +2336,9 `@``@` cdef class Rational(sage.structure.element.FieldElement):
 
         if nn < 0:
             sig_on()
+            if mpz_sgn(mpq_numref(_self.value)) == 0:
+                sig_off()
+                raise ZeroDivisionError('rational division by zero')
             # mpz_pow_ui(mpq_denref(x.value), mpq_numref(_self.value), <unsigned long int>(-nn))
             # mpz_pow_ui(mpq_numref(x.value), mpq_denref(_self.value), <unsigned long int>(-nn))
             # The above causes segfaults, so swap after instead...
```

----
New commits:


---

Comment by git created at 2015-09-01 21:36:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-09-02 04:05:45

You can move the check above `sig_on()`, then there is no need for the extra `sig_off()`.


---

Comment by git created at 2015-09-02 07:48:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by behackl created at 2015-09-02 07:51:04

Changing status from new to needs_review.


---

Comment by behackl created at 2015-09-02 07:51:04

Done -- thanks for the suggestion! I think this might be ready for review now.


---

Comment by jdemeyer created at 2015-09-03 09:04:18

Changing status from needs_review to positive_review.


---

Comment by dkrenn created at 2015-09-03 09:11:28

Changing status from positive_review to needs_work.


---

Comment by dkrenn created at 2015-09-03 09:11:28


```
sage: 1/0
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)
...
ZeroDivisionError: Rational division by zero
```


Make the following consistent: `Rational` (above) vs. `rational` (this patch).


---

Comment by dkrenn created at 2015-09-03 09:15:47

To make it more difficult to decide: Pure Python `>>> 1/0` or `sage: int(1)/int(0)` gives lower case `ZeroDivisionError: integer division or modulo by zero`...


---

Comment by git created at 2015-09-03 10:52:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by behackl created at 2015-09-03 11:02:34

Well, in order to be consistent within `rational.pyx`, this and

```
sage: ~QQ(0)
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)
...
ZeroDivisionError: rational division by zero
```

have to be changed. I did that with the last two commits. I think that other inconsistencies (e.g. `SR(0)^(-1)` and `~SR(0)`) should be handled on a separate ticket. Regarding the inconsistency between Python and Sage: I don't feel that this is too dramatic, but if there is the wish to uniformize that, this should be done on a separate ticket, too.

I'll do a `make ptestlong` to check if I oversaw something and report back with the result later.


---

Comment by behackl created at 2015-09-03 14:04:23

... all tests passed. `positive_review` again?


---

Comment by jdemeyer created at 2015-09-03 14:54:46

No, if you bikeshed, at least do it correctly: exception messages should start with a lower-case letter. So if anything, `Rational` should be replaced by `rational`.


---

Comment by git created at 2015-09-03 15:24:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by behackl created at 2015-09-03 15:26:15

... then let's do some bikeshedding. I'm currently testing if I missed something, will report back later.


---

Comment by behackl created at 2015-09-03 16:40:59

Again, all tests passed.


---

Comment by jdemeyer created at 2015-09-03 16:59:21

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-09-04 23:52:24

Resolution: fixed
