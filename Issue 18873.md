# Issue 18873: inconsistency: invert ZZ(0) vs. QQ(0)

archive/issues_018873.json:
```json
{
    "body": "\n```\nsage: ZZ(0)^(-1)\n...\nZeroDivisionError: Rational division by zero\n```\n\nvs.\n\n```\nsage: QQ(0)^(-1)\n...\nFloatingPointError: Floating point exception\n```\n\nwhich is inconsistent (the latter should also raise a `ZeroDivisionError`.\n\nFYI, `1/ZZ(0)` and `1/QQ(0)` both raise a `ZeroDivisionError`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19110\n\n",
    "created_at": "2015-08-30T08:23:58Z",
    "labels": [
        "basic arithmetic",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.9",
    "title": "inconsistency: invert ZZ(0) vs. QQ(0)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18873",
    "user": "dkrenn"
}
```

```
sage: ZZ(0)^(-1)
...
ZeroDivisionError: Rational division by zero
```

vs.

```
sage: QQ(0)^(-1)
...
FloatingPointError: Floating point exception
```

which is inconsistent (the latter should also raise a `ZeroDivisionError`.

FYI, `1/ZZ(0)` and `1/QQ(0)` both raise a `ZeroDivisionError`.

Issue created by migration from https://trac.sagemath.org/ticket/19110





---

archive/issue_comments_258336.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2015-08-30T08:48:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258336",
    "user": "dkrenn"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_258337.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2015-08-30T09:52:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258337",
    "user": "jdemeyer"
}
```

Changing priority from major to critical.



---

archive/issue_comments_258338.json:
```json
{
    "body": "(I modified the title, as a 'crash' hints that Sage may exist when the command is run)",
    "created_at": "2015-08-30T12:48:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258338",
    "user": "ncohen"
}
```

(I modified the title, as a 'crash' hints that Sage may exist when the command is run)



---

archive/issue_comments_258339.json:
```json
{
    "body": "Replying to [comment:4 ncohen]:\n> (I modified the title, as a 'crash' hints that Sage may exist when the command is run)\n\nI think \"Sage crashes\" is much closer to the reality than what you think.\n\nEssentially, Sage does crash but the signal handling framework handles this crash and turns it into an exception.",
    "created_at": "2015-08-30T12:53:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258339",
    "user": "jdemeyer"
}
```

Replying to [comment:4 ncohen]:
> (I modified the title, as a 'crash' hints that Sage may exist when the command is run)

I think "Sage crashes" is much closer to the reality than what you think.

Essentially, Sage does crash but the signal handling framework handles this crash and turns it into an exception.



---

archive/issue_comments_258340.json:
```json
{
    "body": "What about something like the following?\n\n\n```diff\n--- a/src/sage/rings/rational.pyx\n+++ b/src/sage/rings/rational.pyx\n@@ -2397,9 +2397,8 @@ cdef class Rational(sage.structure.element.FieldElement):\n             mpz_pow_ui(mpq_numref(x.value), mpq_numref(_self.value), -nn)\n             mpz_pow_ui(mpq_denref(x.value), mpq_denref(_self.value), -nn)\n             # mpz_swap(mpq_numref(x.value), mpq_denref(x.value)) # still a segfault\n-            mpq_inv(x.value, x.value)\n             sig_off()\n-            return x\n+            return ~x\n         elif nn > 0:\n             sig_on()\n             mpz_pow_ui(mpq_numref(x.value), mpq_numref(_self.value), nn)\n\n```\n\n\nBasically, thats similar to what happens in `rings/integer.pyx` (I think). With these changes, I have\n\n```\nsage: QQ(0)^(-1)\nTraceback (most recent call last):\n...\nZeroDivisionError: rational division by zero\n```\n\n... and all doctests in `rings/rational.pyx` pass as well. Any thoughts?",
    "created_at": "2015-09-01T18:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258340",
    "user": "behackl"
}
```

What about something like the following?


```diff
--- a/src/sage/rings/rational.pyx
+++ b/src/sage/rings/rational.pyx
@@ -2397,9 +2397,8 @@ cdef class Rational(sage.structure.element.FieldElement):
             mpz_pow_ui(mpq_numref(x.value), mpq_numref(_self.value), -nn)
             mpz_pow_ui(mpq_denref(x.value), mpq_denref(_self.value), -nn)
             # mpz_swap(mpq_numref(x.value), mpq_denref(x.value)) # still a segfault
-            mpq_inv(x.value, x.value)
             sig_off()
-            return x
+            return ~x
         elif nn > 0:
             sig_on()
             mpz_pow_ui(mpq_numref(x.value), mpq_numref(_self.value), nn)

```


Basically, thats similar to what happens in `rings/integer.pyx` (I think). With these changes, I have

```
sage: QQ(0)^(-1)
Traceback (most recent call last):
...
ZeroDivisionError: rational division by zero
```

... and all doctests in `rings/rational.pyx` pass as well. Any thoughts?



---

archive/issue_comments_258341.json:
```json
{
    "body": "The `~x` trick would work but be much less efficient than the current code.",
    "created_at": "2015-09-01T20:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258341",
    "user": "jdemeyer"
}
```

The `~x` trick would work but be much less efficient than the current code.



---

archive/issue_comments_258342.json:
```json
{
    "body": "... well, that makes sense. The following approach (pushed to the branch attached to this ticket) should be better -- however, I really don't know if thats the best way to check if the fraction is 0...\n\n\n```diff\n--- a/src/sage/rings/rational.pyx\n+++ b/src/sage/rings/rational.pyx\n@@ -2329,6 +2336,9 @@ cdef class Rational(sage.structure.element.FieldElement):\n \n         if nn < 0:\n             sig_on()\n+            if mpz_sgn(mpq_numref(_self.value)) == 0:\n+                sig_off()\n+                raise ZeroDivisionError('rational division by zero')\n             # mpz_pow_ui(mpq_denref(x.value), mpq_numref(_self.value), <unsigned long int>(-nn))\n             # mpz_pow_ui(mpq_numref(x.value), mpq_denref(_self.value), <unsigned long int>(-nn))\n             # The above causes segfaults, so swap after instead...\n```\n\n----\nNew commits:",
    "created_at": "2015-09-01T21:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258342",
    "user": "behackl"
}
```

... well, that makes sense. The following approach (pushed to the branch attached to this ticket) should be better -- however, I really don't know if thats the best way to check if the fraction is 0...


```diff
--- a/src/sage/rings/rational.pyx
+++ b/src/sage/rings/rational.pyx
@@ -2329,6 +2336,9 @@ cdef class Rational(sage.structure.element.FieldElement):
 
         if nn < 0:
             sig_on()
+            if mpz_sgn(mpq_numref(_self.value)) == 0:
+                sig_off()
+                raise ZeroDivisionError('rational division by zero')
             # mpz_pow_ui(mpq_denref(x.value), mpq_numref(_self.value), <unsigned long int>(-nn))
             # mpz_pow_ui(mpq_numref(x.value), mpq_denref(_self.value), <unsigned long int>(-nn))
             # The above causes segfaults, so swap after instead...
```

----
New commits:



---

archive/issue_comments_258343.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-01T21:36:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258343",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258344.json:
```json
{
    "body": "You can move the check above `sig_on()`, then there is no need for the extra `sig_off()`.",
    "created_at": "2015-09-02T04:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258344",
    "user": "jdemeyer"
}
```

You can move the check above `sig_on()`, then there is no need for the extra `sig_off()`.



---

archive/issue_comments_258345.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-02T07:48:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258345",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258346.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-09-02T07:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258346",
    "user": "behackl"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_258347.json:
```json
{
    "body": "Done -- thanks for the suggestion! I think this might be ready for review now.",
    "created_at": "2015-09-02T07:51:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258347",
    "user": "behackl"
}
```

Done -- thanks for the suggestion! I think this might be ready for review now.



---

archive/issue_comments_258348.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-09-03T09:04:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258348",
    "user": "jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_258349.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-09-03T09:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258349",
    "user": "dkrenn"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_258350.json:
```json
{
    "body": "\n```\nsage: 1/0\n---------------------------------------------------------------------------\nZeroDivisionError                         Traceback (most recent call last)\n...\nZeroDivisionError: Rational division by zero\n```\n\n\nMake the following consistent: `Rational` (above) vs. `rational` (this patch).",
    "created_at": "2015-09-03T09:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258350",
    "user": "dkrenn"
}
```


```
sage: 1/0
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)
...
ZeroDivisionError: Rational division by zero
```


Make the following consistent: `Rational` (above) vs. `rational` (this patch).



---

archive/issue_comments_258351.json:
```json
{
    "body": "To make it more difficult to decide: Pure Python `>>> 1/0` or `sage: int(1)/int(0)` gives lower case `ZeroDivisionError: integer division or modulo by zero`...",
    "created_at": "2015-09-03T09:15:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258351",
    "user": "dkrenn"
}
```

To make it more difficult to decide: Pure Python `>>> 1/0` or `sage: int(1)/int(0)` gives lower case `ZeroDivisionError: integer division or modulo by zero`...



---

archive/issue_comments_258352.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-03T10:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258352",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258353.json:
```json
{
    "body": "Well, in order to be consistent within `rational.pyx`, this and\n\n```\nsage: ~QQ(0)\n---------------------------------------------------------------------------\nZeroDivisionError                         Traceback (most recent call last)\n...\nZeroDivisionError: rational division by zero\n```\n\nhave to be changed. I did that with the last two commits. I think that other inconsistencies (e.g. `SR(0)^(-1)` and `~SR(0)`) should be handled on a separate ticket. Regarding the inconsistency between Python and Sage: I don't feel that this is too dramatic, but if there is the wish to uniformize that, this should be done on a separate ticket, too.\n\nI'll do a `make ptestlong` to check if I oversaw something and report back with the result later.",
    "created_at": "2015-09-03T11:02:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258353",
    "user": "behackl"
}
```

Well, in order to be consistent within `rational.pyx`, this and

```
sage: ~QQ(0)
---------------------------------------------------------------------------
ZeroDivisionError                         Traceback (most recent call last)
...
ZeroDivisionError: rational division by zero
```

have to be changed. I did that with the last two commits. I think that other inconsistencies (e.g. `SR(0)^(-1)` and `~SR(0)`) should be handled on a separate ticket. Regarding the inconsistency between Python and Sage: I don't feel that this is too dramatic, but if there is the wish to uniformize that, this should be done on a separate ticket, too.

I'll do a `make ptestlong` to check if I oversaw something and report back with the result later.



---

archive/issue_comments_258354.json:
```json
{
    "body": "... all tests passed. `positive_review` again?",
    "created_at": "2015-09-03T14:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258354",
    "user": "behackl"
}
```

... all tests passed. `positive_review` again?



---

archive/issue_comments_258355.json:
```json
{
    "body": "No, if you bikeshed, at least do it correctly: exception messages should start with a lower-case letter. So if anything, `Rational` should be replaced by `rational`.",
    "created_at": "2015-09-03T14:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258355",
    "user": "jdemeyer"
}
```

No, if you bikeshed, at least do it correctly: exception messages should start with a lower-case letter. So if anything, `Rational` should be replaced by `rational`.



---

archive/issue_comments_258356.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-09-03T15:24:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258356",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_258357.json:
```json
{
    "body": "... then let's do some bikeshedding. I'm currently testing if I missed something, will report back later.",
    "created_at": "2015-09-03T15:26:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258357",
    "user": "behackl"
}
```

... then let's do some bikeshedding. I'm currently testing if I missed something, will report back later.



---

archive/issue_comments_258358.json:
```json
{
    "body": "Again, all tests passed.",
    "created_at": "2015-09-03T16:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258358",
    "user": "behackl"
}
```

Again, all tests passed.



---

archive/issue_comments_258359.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-09-03T16:59:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258359",
    "user": "jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_258360.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-09-04T23:52:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18873",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18873#issuecomment-258360",
    "user": "vbraun"
}
```

Resolution: fixed
