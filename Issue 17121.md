# Issue 17121: Compilerwrapper package enforces GCC installation

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2014-11-17 14:26:04

CC:  vbraun

The `install` scripts checks whether `$SAGE_LOCAL/bin/gcc` exists and if so will at some point trigger the build of Sage's GCC.
This cannot be prevented by using `SAGE_INSTALL_GCC=no`.


---

Comment by jpflori created at 2014-11-20 17:47:06

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-11-20 17:47:06

New commits:


---

Comment by jdemeyer created at 2014-11-22 17:29:12

Here is a possibly better proposal: do not consider `$SAGE_LOCAL/bin/gcc` at all. Just completely remove that branch.


---

Comment by jpflori created at 2014-11-24 14:18:43

Do you mean removing only the `-f "$SAGE_LOCAL/bin/gcc"` of the test?
(I think the `touch` part can also be removed)

If the user or Sage decided to install Sage's GCC, there should be some files in `$SAGE_INST`, and in that case we still need to put the necessary stuff into the `Makefile` so that GCC will get rebuilt if its dependencies were.


---

Comment by jdemeyer created at 2014-11-24 18:45:09

I meant removing the whole block

```
if [ -f "$SAGE_LOCAL/bin/gcc" ]; then
    # GCC is already installed. To disable unneeded rebuilding
    # of GCC, we touch the installed file for GCC, such that it will
    # really only be built if one of its dependencies has been upgraded.
    echo >&2 "GCC was installed before, it will get re-installed if needed."
    need_to_install_gcc=yes
    for f in "$SAGE_SPKG_INST"/gcc-*; do
        if [ -f "$f" ]; then
            touch "$f"
        fi
    done
```



---

Comment by jpflori created at 2014-11-24 22:15:58

I did not check when the `install` script is run, but if it is run at some point after `GCC` installation without `SAGE_INSTALL_GCC=yes`, `GCC` will never get updated if one of its dependencies is or if a new version is merged unless `SAGE_INSTALL_GCC=yes` and `install` get run once again? Am I wrong?


---

Comment by jdemeyer created at 2014-11-26 17:23:51

Replying to [comment:5 jpflori]:
> I did not check when the `install` script is run, but if it is run at some point after `GCC` installation without `SAGE_INSTALL_GCC=yes`, `GCC` will never get updated if one of its dependencies is or if a new version is merged unless `SAGE_INSTALL_GCC=yes` and `install` get run once again? Am I wrong?
You are right, but perhaps that isn't a problem. I don't think we need to treat GCC like other packages. If users have GCC 4.9.1 instead of 4.9.2, that's no problem. And if it would be a problem, we just blacklist GCC version 4.9.1 (for all setups, including system GCC 4.9.1).


---

Comment by jdemeyer created at 2014-11-26 17:24:01

Changing component from packages: optional to build.


---

Comment by jdemeyer created at 2014-12-02 11:17:16

Changing status from needs_review to needs_info.


---

Comment by jpflori created at 2014-12-02 11:20:00

Replying to [comment:6 jdemeyer]:
> Replying to [comment:5 jpflori]:
> > I did not check when the `install` script is run, but if it is run at some point after `GCC` installation without `SAGE_INSTALL_GCC=yes`, `GCC` will never get updated if one of its dependencies is or if a new version is merged unless `SAGE_INSTALL_GCC=yes` and `install` get run once again? Am I wrong?
> You are right, but perhaps that isn't a problem. I don't think we need to treat GCC like other packages. If users have GCC 4.9.1 instead of 4.9.2, that's no problem. And if it would be a problem, we just blacklist GCC version 4.9.1 (for all setups, including system GCC 4.9.1).
I agree with that.
So the only problem left is what if MPIR or another GCC dependency gets updated to a binary incompatible version (or let's say the symlinks ends up with different names)?


---

Comment by jdemeyer created at 2014-12-02 13:40:55

Replying to [comment:9 jpflori]:
> So the only problem left is what if MPIR or another GCC dependency gets updated to a binary incompatible version (or let's say the symlinks ends up with different names)?
We don't delete old versions of those packages, so that's not an issue either.


---

Comment by git created at 2014-12-02 13:50:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jpflori created at 2014-12-02 13:55:25

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2014-12-20 12:04:50

I forgot about this ticket here...

I think that the value of `SAGE_INSTALL_GCC` should be ignored when `$SAGE_LOCAL/bin/gcc` is present. I can imagine people putting `SAGE_INSTALL_GCC=yes` in their `.profile` expecting GCC to be built just once.


---

Comment by jdemeyer created at 2014-12-20 12:32:32

I am currently testing

```diff
diff --git a/build/install b/build/install
index 52814ba..258af7f 100755
--- a/build/install
+++ b/build/install
`@``@` -89,6 +89,11 `@``@` if [ -z "$FC" ]; then
     fi
 fi
 
+if [ -f "$SAGE_LOCAL/bin/gcc" ]; then
+    # Ignore SAGE_INSTALL_GCC if GCC is already installed
+    SAGE_INSTALL_GCC=""
+fi
+
 if [ -n "$SAGE_INSTALL_GCC" ]; then
     # Check the value of the environment variable SAGE_INSTALL_GCC
     case "$SAGE_INSTALL_GCC" in
```



---

Comment by jdemeyer created at 2014-12-20 12:32:32

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-12-20 17:51:12

New commits:


---

Comment by jdemeyer created at 2014-12-20 17:51:12

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2014-12-20 17:51:56

I am happy with this ticket, can you review my changes please?


---

Comment by jpflori created at 2014-12-23 11:02:02

Looks good to me.


---

Comment by jpflori created at 2014-12-23 11:02:02

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-01-02 15:46:21

Resolution: fixed
