# Issue 27971: spkg-configure.m4 for symmetrica

Issue created by migration from https://trac.sagemath.org/ticket/28208

Original creator: dimpase

Original creation time: 2019-07-16 23:13:23

CC:  embray fbissey isuruf

Keywords: spkg-configure

Debian packages it, so we can use it on Debian.

The present branch does not try to check the version


---

Comment by dimpase created at 2019-07-17 12:22:43

I wonder whether the Symmetrica Cython interface should be converted to using dynamic library. It's silly to link in a static one, creating a 30Mb
`local/lib/python2.7/site-packages/sage/libs/symmetrica/symmetrica.so`.
For comparison, the 2nd biggest `.so` among
`local/lib/python2.7/site-packages/sage/libs/*/*.so` is just 3Mb.


---

Comment by arojas created at 2019-07-17 12:40:03

Given that the symmetrica spkg is using a custom makefile, it's just a matter of modifying it to build a shared library instead of a static one.


---

Comment by dimpase created at 2019-07-17 12:53:15

well, on OSX and Cygwin it might actually be a problem to get right. I guess it's a primary reason for having it static, it's easier. Buidling a shared library without autotoolization is a pain...


---

Comment by dimpase created at 2019-07-17 14:01:26

symmetrica package also needs a custom uninstall, as `local/lib/libsymmetrica.a` does not get cleaned for some reason. (Or perhaps it's a bug in the build system).

---

EDIT: I had a pre-`sdh_install` installation, on which uninstall failed (it does work on more recent installs). Perhaps we still want a custom uninstall, but at least it's something that will go away eventually by itself.


---

Comment by dimpase created at 2019-07-17 18:59:17

At present, it tests for presense of `symmetrica.h` header, which apparently what Debian has added (we can change it to ``symmetrica/defs.h`, which is one of the two original headers). I wonder what Conda would prefer.


---

Comment by isuruf created at 2019-07-17 19:01:58

conda package has `symmetrica/defs.h` and `symmetrica/macro.h` and no `symmetrica.h`


---

Comment by dimpase created at 2019-07-17 19:23:07

Replying to [comment:6 isuruf]:
> conda package has `symmetrica/defs.h` and `symmetrica/macro.h` and no `symmetrica.h`

Thanks. Is there a place I can look up the sources used (without an actual conda install)? I am trying to understand what patches are applied there by conda.


---

Comment by isuruf created at 2019-07-17 19:27:11

Source used: https://github.com/conda-forge/symmetrica-feedstock/blob/master/recipe/meta.yaml#L10-L12

Patches used: https://github.com/conda-forge/symmetrica-feedstock/tree/master/recipe/patches

We use a CMake file to build which makes it easier to build windows packages and shared libs. (I've opened a PR to build shared libs at https://github.com/conda-forge/symmetrica-feedstock/pull/4/commits/36079653f18d5744fdb32a00fa95de093949b48d)

Built packages are at https://anaconda.org/conda-forge/symmetrica/files


---

Comment by fbissey created at 2019-07-17 20:30:50

Replying to [comment:3 dimpase]:
> well, on OSX and Cygwin it might actually be a problem to get right. I guess it's a primary reason for having it static, it's easier. Buidling a shared library without autotoolization is a pain...

This is antic from way back in probably 2008 and 2009 when I was working with T. Abbott. I have a makefile for linux and a makefile for OS X. I only install a shared library. I should revisit it and do something to merge the makefiles.

I have the same headers than Isuru on conda. 

And I'll certainly want to steal a cmake solution from conda if it is available :) . But cmake is still not an official sage package.


---

Comment by isuruf created at 2019-07-17 20:37:41

> And I'll certainly want to steal a cmake solution from conda if it is available :) 

It is. I just made symmetrica a shared library on conda for linux, osx and windows.

It's unfortunate that sage doesn't have cmake as a standard package.


---

Comment by dimpase created at 2019-07-17 21:00:53

Debian has autotoolised the package, if I am not mistaken:
https://salsa.debian.org/science-team/symmetrica/blob/master/debian/patches/upstream-autotoolization.patch

Anyhow, it's easy to make cmake standard; in practice this would hopefully mean that people will use system's cmake, as we have the relevant `build/pkgs/cmake/spkg-configure.m4` already in place.


---

Comment by git created at 2019-07-17 22:30:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-17 22:40:51

Changing status from new to needs_review.


---

Comment by fbissey created at 2019-07-18 00:47:11

Replying to [comment:10 isuruf]:
> > And I'll certainly want to steal a cmake solution from conda if it is available :) 
> 
> It is. I just made symmetrica a shared library on conda for linux, osx and windows.
> 
> It's unfortunate that sage doesn't have cmake as a standard package. 

I have one issue with your CMakeList.txt

```
    ARCHIVE DESTINATION lib
    LIBRARY DESTINATION lib
```

this should depend on the target. Sometimes it is lib64 or lib/<arch> (debian). I usually use https://cmake.org/cmake/help/v3.15/module/GNUInstallDirs.html in my own cmake scripts. My version is now here
https://github.com/cschwan/sage-on-gentoo/blob/master/sci-libs/symmetrica/files/CMakeLists.txt

One thing interesting about the debian autotool patch is that it looks like they got the test working.


---

Comment by fbissey created at 2019-07-18 00:49:28

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2019-07-18 00:49:28

Looks rather trivial to me.


---

Comment by isuruf created at 2019-07-18 03:24:43

Thanks `@`fbissey for the fixes. I added support for running tests with `ctest` as well.


---

Comment by fbissey created at 2019-07-18 03:35:22

Replying to [comment:16 isuruf]:
> Thanks `@`fbissey for the fixes. I added support for running tests with `ctest` as well.

I think I messed up a little bit by setting `SOVERSION` to 2.0 instead of just 2 (I was trying to get back to what I had before, but it ended up not being possible because I was not using the right scheme). We should check what debian ends up with, but I think we should just use "2".

With the test working I will align myself onto you. No need to have too many versions around.


---

Comment by dimpase created at 2019-07-18 21:13:58

Unfortunately, Fedora comes with a buggy `libsymmetrica-devel` package.
So it needs to be recognised and ruled out.


---

Comment by dimpase created at 2019-07-18 21:13:58

Changing status from positive_review to needs_work.


---

Comment by dimpase created at 2019-07-19 05:39:14

More precisely it appears that the Sage's fixes to symmetrica have been applied to Fedora 30 (perhaps 29 too?), see Changelog in

https://fedora.pkgs.org/30/fedora-x86_64/symmetrica-devel-2.0-22.fc30.x86_64.rpm.html

but not to older ones -- I tested on Fedora 26, which is a year past its EOL.


---

Comment by dimpase created at 2019-07-19 22:28:25

The following C code dumps core on old symmetrica, and works on the good one.

```c
/* compile as follows: cc tt.c -lsymmetrica -lm */

#include "symmetrica/def.h"
#include "symmetrica/macro.h"
int main() 
{
  OP b,n;
  anfang();
  n = callocobject(); b = callocobject();
  sscan_integer("4",n);
  kostka_tafel(n, b);
  println(b);
  ende();
}
```

The output should be (from the good one, and Sage's doctest in `src/sage/libs/symmetrica/kostka.pxi`):

```

[1:0:0:0:0]
[1:1:0:0:0]
[1:1:1:0:0]
[1:2:1:1:0]
[1:3:2:3:1]

```


I'll make a test in the m4 file with it.


---

Comment by git created at 2019-07-20 23:15:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-20 23:33:01

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2019-07-20 23:33:01

OK, so this does the trick of ruling old version out.


---

Comment by isuruf created at 2019-07-21 04:03:17

Changing status from needs_review to positive_review.


---

Comment by isuruf created at 2019-07-21 04:03:17

Checked debian and conda packages and they are picked up.


---

Comment by vbraun created at 2019-07-23 22:07:25

Merge conflict


---

Comment by vbraun created at 2019-07-23 22:07:25

Changing status from positive_review to needs_work.


---

Comment by git created at 2019-07-29 07:51:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2019-07-29 07:54:06

Changing status from needs_work to positive_review.


---

Comment by dimpase created at 2019-07-29 07:54:06

rebased over the branch of #27827 - to avoid merge conflict.


---

Comment by git created at 2019-07-29 08:00:06

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2019-07-29 08:00:06

Changing status from positive_review to needs_review.


---

Comment by dimpase created at 2019-07-29 08:01:28

New commits:


---

Comment by dimpase created at 2019-07-29 20:08:37

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-07-30 22:14:18

Resolution: fixed


---

Comment by mkoeppe created at 2020-03-29 12:46:42

Follow-up: #29405
