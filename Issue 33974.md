# Issue 33974: Fix bug due to a call to SSLContext() in src/sage/graphs/isgci.py

Issue created by migration from https://trac.sagemath.org/ticket/34211

Original creator: dcoudert

Original creation time: 2022-07-22 10:07:49

CC:  chapoton dimpase slabbe


```
sage: graph_classes._download_db()
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
<ipython-input-1-3914f28ce325> in <module>
----> 1 graph_classes._download_db()

/home/dcoudert/sage/local/var/lib/sage/venv-python3.10/lib64/python3.10/site-packages/sage/graphs/isgci.py in _download_db(self)
    829         import tempfile
    830         u = urlopen('https://www.graphclasses.org/data.zip',
--> 831                     context=SSLContext())
    832         with tempfile.NamedTemporaryFile(suffix=".zip") as f:
    833             f.write(u.read())

NameError: name 'SSLContext' is not defined
```


This bug was fixed in #33771, replacing the call to `SSLContext()` in `src/sage/graphs/isgci.py` with a call to `default_context()`, but this changes has been reverted in #33829.

----
Dependency on #34079 since it modifies this file.




---

Comment by dcoudert created at 2022-07-22 10:11:04

New commits:


---

Comment by dcoudert created at 2022-07-22 10:13:07

On the way, I found a new bug: If I do `graph_classes._download_db()` in a sage console, and then `./sage -t src/sage/graphs/isgci.py`, I get errors like:

```
sage -t --warn-long 77.5 --random-seed=217922271289552033231623053257548326399 src/sage/graphs/isgci.py
**********************************************************************
File "src/sage/graphs/isgci.py", line 53, in sage.graphs.isgci
Failed example:
    Chordal.description()
Expected:
    Class of graphs : Chordal
    -------------------------
    id                             :  gc_32
    name                           :  chordal
    type                           :  base
    <BLANKLINE>
    Problems :
    -----------
    3-Colourability                :  Linear
    Clique                         :  Polynomial
    Clique cover                   :  Polynomial
    Cliquewidth                    :  Unbounded
    Cliquewidth expression         :  NP-complete
    Colourability                  :  Linear
    Cutwidth                       :  NP-complete
    Domination                     :  NP-complete
    Feedback vertex set            :  Polynomial
    Hamiltonian cycle              :  NP-complete
    Hamiltonian path               :  NP-complete
    Independent set                :  Linear
    Maximum bisection              :  Unknown
    Maximum cut                    :  NP-complete
    Minimum bisection              :  Unknown
    Recognition                    :  Linear
    Treewidth                      :  Polynomial
    Weighted clique                :  Polynomial
    Weighted feedback vertex set   :  Unknown
    Weighted independent set       :  Linear
Got:
    Class of graphs : Chordal
    -------------------------
    id                             : gc_32
    name                           : chordal
    parameter                      : [{'name': 'acyclic chromatic number', 'boundedness': 'Unbounded'}, {'name': 'bandwidth', 'boundedness': 'Unbounded'}, {'name': 'book thickness', 'boundedness': 'Unbounded'}, {'name': 'booleanwidth', 'boundedness': 'Unbounded'}, {'name': 'branchwidth', 'boundedness': 'Unbounded'}, {'name': 'carvingwidth', 'boundedness': 'Unbounded'}, {'name': 'chromatic number', 'boundedness': 'Unbounded'}, {'name': 'cliquewidth', 'boundedness': 'Unbounded'}, {'name': 'cochromatic number', 'boundedness': 'Unknown'}, {'name': 'cutwidth', 'boundedness': 'Unbounded'}, {'name': 'degeneracy', 'boundedness': 'Unbounded'}, {'name': 'diameter', 'boundedness': 'Unbounded'}, {'name': 'distance to block', 'boundedness': 'Unbounded'}, {'name': 'distance to clique', 'boundedness': 'Unbounded'}, {'name': 'distance to cluster', 'boundedness': 'Unbounded'}, {'name': 'distance to co-cluster', 'boundedness': 'Unbounded'}, {'name': 'distance to cograph', 'boundedness': 'Unbounded'}, {'name': 'distance to linear forest', 'boundedness': 'Unbounded'}, {'name': 'distance to outerplanar', 'boundedness': 'Unbounded'}, {'name': 'genus', 'boundedness': 'Unbounded'}, {'name': 'max-leaf number', 'boundedness': 'Unbounded'}, {'name': 'maximum clique', 'boundedness': 'Unbounded'}, {'name': 'maximum degree', 'boundedness': 'Unbounded'}, {'name': 'maximum independent set', 'boundedness': 'Unbounded'}, {'name': 'maximum induced matching', 'boundedness': 'Unbounded'}, {'name': 'maximum matching', 'boundedness': 'Unbounded'}, {'name': 'minimum clique cover', 'boundedness': 'Unbounded'}, {'name': 'minimum dominating set', 'boundedness': 'Unbounded'}, {'name': 'pathwidth', 'boundedness': 'Unbounded'}, {'name': 'rankwidth', 'boundedness': 'Unbounded'}, {'name': 'tree depth', 'boundedness': 'Unbounded'}, {'name': 'treewidth', 'boundedness': 'Unbounded'}, {'name': 'vertex cover', 'boundedness': 'Unbounded'}]
    speed                          : {'speed': 'Superfactorial-Theta'}
    type                           : base
    <BLANKLINE>
    Problems :
    -----------
    3-Colourability                : Linear
    Clique                         : Polynomial
    Clique cover                   : Polynomial
    Cochromatic colouring          : Unknown
    Colourability                  : Linear
    Domination                     : NP-complete
    Feedback vertex set            : Polynomial
    Graph isomorphism              : GI-complete
    Hamiltonian cycle              : NP-complete
    Hamiltonian path               : NP-complete
    Independent dominating set     : Linear
    Independent set                : Linear
    Maximum bisection              : Unknown
    Maximum cut                    : NP-complete
    Minimum bisection              : Unknown
    Monopolarity                   : Linear
    Polarity                       : Polynomial
    Recognition                    : Linear
    Weighted clique                : Polynomial
    Weighted feedback vertex set   : Unknown
    Weighted independent dominating set : Unknown
    Weighted independent set       : Linear
    Weighted maximum cut           : NP-complete
    book thickness decomposition   : Unknown
    booleanwidth decomposition     : Unknown
    cliquewidth decomposition      : Unknown
    cutwidth decomposition         : NP-complete
    treewidth decomposition        : Polynomial
```



---

Comment by dcoudert created at 2022-07-22 10:17:12

Do you know how to clear the cache / database ?


---

Comment by dcoudert created at 2022-07-22 12:16:00

It seems that we have to update file `local/share/graphs/isgci_sage.xml` (don't know how), update doctests accordingly, and decide what to do with `parameter` and `speed` in the description of the class (parameters added in 2015 and 2018, details can be found at https://www.graphclasses.org/classes/gc_61.html).


---

Comment by dcoudert created at 2022-08-02 06:35:55

Changing status from new to needs_info.


---

Comment by dimpase created at 2022-08-02 08:09:15

isn't it updateable with `graph_classes.update_db()` ?


---

Comment by dcoudert created at 2022-08-02 08:17:53

Yes it is, but I'm not sure if I should push an updated version of the database + corrected doctests in this ticket, or if there is another way to store a version of the database. I don't know where the default file that we have in `local/share/graphs/isgci_sage.xml` comes from and what's the normal procedure to update it.


---

Comment by dimpase created at 2022-08-02 08:44:41

if you read the code you'll see it's downloaded, it's not stored anywhere in Sage git tree.


---

Comment by dimpase created at 2022-08-02 08:53:46

many of these doctests are too verbose, replacing most of them with `...` seems OK.


---

Comment by git created at 2022-08-03 14:54:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-08-03 14:54:59

Changing status from needs_info to needs_review.


---

Comment by dcoudert created at 2022-08-03 14:54:59

I have reduced the verbosity of some doctests.


---

Comment by dcoudert created at 2022-08-04 07:12:33

and we have green bot.


---

Comment by dimpase created at 2022-08-04 08:17:20

lgtm


---

Comment by dimpase created at 2022-08-04 08:17:20

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-08-04 08:20:13

Changing status from positive_review to needs_info.


---

Comment by dimpase created at 2022-08-04 08:20:13

should we actually turn these untested tests into optional (internet) tests? This would improve chances to timely catch upstream changes.


---

Comment by dcoudert created at 2022-08-06 21:38:31

Should I just changed to `# optional - internet` or is it better to add `# long time # optional - internet` ?


---

Comment by dimpase created at 2022-08-08 13:59:03

IMHO `# optional - internet` is good enough.


---

Comment by git created at 2022-08-08 14:58:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2022-08-08 14:58:32

done


---

Comment by dcoudert created at 2022-08-08 14:58:32

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2022-08-08 16:33:07

ok


---

Comment by dimpase created at 2022-08-08 16:33:07

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-08-29 11:23:58

Resolution: fixed


---

Comment by slabbe created at 2022-09-29 10:11:56

see #34612 for a follow-up ticket fixing a doctest failure
