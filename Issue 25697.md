# Issue 25697: Problem creating a number field (fractional) ideal

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2018-07-26 06:02:08

CC:  jdemeyer slelievre

With 8.3.rc1:

```
sage: K.<a> = NumberField(x^6 - x^5 - 5*x^4 + 4*x^3 + 6*x^2 - 3*x - 1)
sage: K.ideal(1,1)
```

takes a long time to return -- why?  Using %time it immediately shows 1ms for the second line but the prompt does not appear until *minutes* later.


---

Comment by cremona created at 2018-07-26 07:01:33

Since the field discriminant is less than `10^6` the string function calls gens_reduced, and that is taking the time.  Specifially the call to self_cache_bnfisprincipal() is.  This suggests that something needs fixing;  but also it might be a good idea to include special case code for the unit ideal -- this ideal has norm 1 which is trivial to compute so returning the string '(1)' could be done as a short cut.


---

Comment by jdemeyer created at 2018-07-26 07:24:49

Replying to [comment:2 cremona]:
> but also it might be a good idea to include special case code for the unit ideal -- this ideal has norm 1 which is trivial to compute so returning the string '(1)' could be done as a short cut.

That's such a special case, I'm not convinced that it's worth it.


---

Comment by jdemeyer created at 2018-07-26 07:33:52

Replying to [comment:2 cremona]:
> Since the field discriminant is less than `10^6` the string function calls gens_reduced, and that is taking the time.

Indeed. So I would say that this heuristic bound of the discriminant is not sufficient to predict that the class group is easy to compute.


---

Comment by jdemeyer created at 2018-07-26 07:38:09

I asked pari-dev.

- http://pari.math.u-bordeaux.fr/archives/pari-dev-1807/msg00001.html


---

Comment by slelievre created at 2020-04-14 10:22:29

From [Karim Belabas's answer on pari-dev](http://pari.math.u-bordeaux.fr/archives/pari-dev-1807/msg00002.html):

> In any case, you should never compute a bnfinit
> when it's not absolutely necessary. [ I.e. you
> should do it on the fly when the extra structure
> is a prerequisite for a specific function call. ]


---

Comment by slelievre created at 2020-04-14 10:23:27

Changing component from PLEASE CHANGE to number fields.


---

Comment by cremona created at 2021-02-02 16:15:09

There is something strange here.  Nothing to do with the representation if ideals really.  For this field, if you construct its pari_bnf, it takes ages to return even with no output:

```
sage: K.<a> = NumberField(x^6 - x^5 - 5*x^4 + 4*x^3 + 6*x^2 - 3*x - 1)                                                                                 
sage: %time pK = K.pari_bnf(proof=False, units=False)                    
CPU times: user 1min 11s, sys: 128 ms, total: 1min 11s
Wall time: 1min 11s
```

but in a fresh Sage session, if I interrupt the second line immediately and then rerun it:

```
sage: K.<a> = NumberField(x^6 - x^5 - 5*x^4 + 4*x^3 + 6*x^2 - 3*x - 1)                                                                                 
sage: %time pK = K.pari_bnf(proof=False, units=False)                
<interrupt after <1s>
sage: %time pK = K.pari_bnf(proof=False, units=False)                                                                                                  
CPU times: user 36 ms, sys: 0 ns, total: 36 ms
Wall time: 37.2 ms
```


Also, after this, displaying K.ideal(1,1) is instantaneous.  So I think that there *is* a bug in here, though I cannot tell what is happening.

Simplifying further:

```
sage: y = polygen(QQ, 'y')                                                                                                                             
sage: f = pari(y^6 - y^5 - 5*y^4 + 4*y^3 + 6*y^2 - 3*y - 1)                                                                                            
sage: %time f.bnfinit() 
CPU times: user 1min 9s, sys: 144 ms, total: 1min 9s
Wall time: 1min 9s
```

while again, interrupting immediately and reissuing the last line gives the output immediately.

Lastly, 

```
sage: %gp                                                                                                                                              

  --> Switching to PARI/GP interpreter <--

pari: K = bnfinit(y^6 - y^5 - 5*y^4 + 4*y^3 + 6*y^2 - 3*y - 1);                                                                                        

pari: ##                                                                                                                                               
  ***   last result computed in 24 ms.
```



---

Comment by vdelecroix created at 2021-02-03 14:50:07

What about 9.3.beta6? Sage 8.3.rc1 is not very relevant unless you precisely bisect where the problem is.


---

Comment by vdelecroix created at 2021-02-03 14:57:40

(implicit note: I can not reproduce on 9.3.beta6)


---

Comment by cremona created at 2021-02-03 15:03:50

The original posting was for an old version, but everything I wrote in the last 24 hours has been for 9.2, running on ubuntu, built from source.


---

Comment by cremona created at 2021-02-03 15:06:01

Ah, and when I try on 9.3.beta6 is is fine.  That's good!  I'll mark this as invalid / won't-fix as something has fixed it between 9.2 and now.


---

Comment by vdelecroix created at 2021-02-03 15:07:35

Maybe cypari2 upgrade #31029?


---

Comment by cremona created at 2021-02-05 09:22:32

Changing status from new to needs_review.


---

Comment by slelievre created at 2021-02-05 12:32:46

Any way to add a doctest for this?


---

Comment by cremona created at 2021-02-05 13:07:08

Replying to [comment:16 slelievre]:
> Any way to add a doctetcst for this?
Sure: the 2 lines of the original post should do.


---

Comment by cremona created at 2021-02-05 14:19:16

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2021-02-05 15:04:01

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2021-02-05 15:04:01

I added a doctest as suggested.  No code changes.
----
New commits:


---

Comment by cremona created at 2021-02-12 14:48:02

Review please?  The patch just adds one tiny doctest.


---

Comment by slelievre created at 2021-02-13 09:56:11

Changing keywords from "" to "NumberField, ideal".


---

Comment by chapoton created at 2021-02-13 10:09:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-01 00:21:02

Resolution: fixed
