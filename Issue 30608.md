# Issue 30608: GH Actions: Add test for conda without SPKG

Issue created by migration from https://trac.sagemath.org/ticket/30845

Original creator: mkoeppe

Original creation time: 2020-11-01 18:57:38

CC:  isuruf @tobiasdiez dimpase saraedum




---

Comment by mkoeppe created at 2020-12-06 18:17:38

Hoping we can make progress on this ticket this week - https://wiki.sagemath.org/days111


---

Comment by mkoeppe created at 2020-12-06 18:17:38

Changing keywords from "" to "sd111".


---

Comment by @tobiasdiez created at 2020-12-22 10:44:04

Something like https://github.com/tobiasdiez/sage/blob/public/build/conda_gh/.github/workflows/ci-conda.yml?

This currently fails with

```
configure: creating ./config.status
config.status: creating build/make/Makefile-auto
config.status: creating build/make/Makefile
config.status: creating src/bin/sage-env-config
config.status: creating src/bin/sage-src-env-config
config.status: creating build/bin/sage-build-env-config
config.status: creating build/pkgs/sage_conf/src/sage_conf.py
config.status: creating build/pkgs/sage_conf/src/setup.cfg
config.status: executing depfiles commands
config.status: executing mkdirs commands
config.status: creating directory /home/runner/work/sage/sage/logs/pkgs
config.status: creating directory 
mkdir: cannot create directory '': No such file or directory
config.status: error: could not create 
Error: Process completed with exit code 1.
```

https://github.com/tobiasdiez/sage/runs/1594237745?check_suite_focus=true
Any idea what could be the reason and how to fix it?


---

Comment by @tobiasdiez created at 2020-12-22 10:46:09

New commits:


---

Comment by git created at 2020-12-22 11:14:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-22 11:57:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-22 11:58:14

Managed to fix the above error, just to be stuck two lines further down:

```
configure: creating ./config.status
config.status: creating build/make/Makefile-auto
config.status: creating build/make/Makefile
config.status: creating src/bin/sage-env-config
config.status: creating src/bin/sage-src-env-config
config.status: creating build/bin/sage-build-env-config
config.status: creating build/pkgs/sage_conf/src/sage_conf.py
config.status: creating build/pkgs/sage_conf/src/setup.cfg
config.status: executing depfiles commands
config.status: executing broken-gcc commands
config.status: executing mkdirs commands
config.status: creating directory /home/runner/work/sage/sage/logs/pkgs
config.status: creating directory /usr/share/miniconda/envs/sage-build
config.status: creating directory /usr/share/miniconda/envs/sage-build/bin
config.status: creating directory /usr/share/miniconda/envs/sage-build/etc
config.status: creating directory /usr/share/miniconda/envs/sage-build/include
config.status: creating directory /usr/share/miniconda/envs/sage-build/lib
config.status: creating directory /usr/share/miniconda/envs/sage-build/lib/pkgconfig
config.status: creating directory /usr/share/miniconda/envs/sage-build/share
config.status: creating directory /usr/share/miniconda/envs/sage-build/var/lib/sage/installed
config.status: error: Cannot perform incremental update, run "make distclean && make"
config.status: /usr/share/miniconda/envs/sage-build/lib64 is not a symlink, see Trac #19782
Error: Process completed with exit code 1.
```

https://github.com/tobiasdiez/sage/runs/1594601374?check_suite_focus=true


---

Comment by @tobiasdiez created at 2020-12-22 12:22:06

Found a hack that fixed it by removing the lib64 folder. It only contained `libcc1.so` (not sure where/how this is needed).


---

Comment by @tobiasdiez created at 2020-12-22 13:18:37

Made a bit more progress, but it currently errors while compiling gcc. Moreover, there is a problem in the detection of the conda/system gcc because "sage-env-config" doesn't exist.
https://github.com/tobiasdiez/sage/runs/1594867631?check_suite_focus=true


---

Comment by git created at 2020-12-22 13:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-22 14:43:24

The `direct` variant should use `src/environment.yml` - which installs the Python packages of Sage in addition to what is listed in `environment.yml`


---

Comment by mkoeppe created at 2020-12-22 14:44:04

The `lib64` looks like a conda packaging bug to me - `@`isuruf, can you help?


---

Comment by mkoeppe created at 2020-12-22 14:45:33

`environment.yml` already includes `compilers` -- I don't think adding `cxx-compiler` should be necessary


---

Comment by git created at 2020-12-22 14:47:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-22 15:02:30

Replying to [comment:13 gh-tobiasdiez]:
> Made a bit more progress, but it currently errors while compiling gcc. Moreover, there is a problem in the detection of the conda/system gcc because "sage-env-config" doesn't exist.
> https://github.com/tobiasdiez/sage/runs/1594867631?check_suite_focus=true

This is now #31097.


---

Comment by isuruf created at 2020-12-22 16:19:55

I don't see a `lib64` folder. Which package is that coming from?


---

Comment by @tobiasdiez created at 2020-12-22 16:40:59

It contains `libcc1.so` so I guess gcc, g++ or some other compiler package.


---

Comment by git created at 2020-12-22 18:01:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-22 18:06:15

Current status:
- Building sage using `make` on top of conda fails, since gcc is not found and the custom build of gcc fails.
- Installing sagelib on top of a conda works, but many doctests fail.

https://github.com/sagemath/sagetrac-mirror/actions?query=workflow%3A%22Build+%26+Test+using+conda%22

I let somebody else with more experience in conda/the intricacies of sage's build system take over from here.


---

Comment by mkoeppe created at 2020-12-22 18:33:37

Thanks for getting this started!


---

Comment by mkoeppe created at 2020-12-22 18:43:28

Unfortunately the runs do not give the config.log


---

Comment by mkoeppe created at 2020-12-22 18:53:30

Now I finally realize that for `on-top-of-spkg` you were trying to do `./configure --prefix=$CONDA_PREFIX` -- that can't work.


---

Comment by git created at 2020-12-22 21:12:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-22 21:29:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-12-22 21:36:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2020-12-22 21:55:12

Replying to [comment:28 mkoeppe]:
> Now I finally realize that for `on-top-of-spkg` you were trying to do `./configure --prefix=$CONDA_PREFIX` -- that can't work. 

Thanks! Removing the prefix part indeed fixed the gcc issue. Now we are further in the build, and find this beautiful error:

```
2020-12-22T21:44:17.7966259Z [cvxopt-1.2.5]   x86_64-conda_cos6-linux-gnu-gcc -pthread -shared -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,-rpath,/usr/share/miniconda/envs/sage-build/lib -L/usr/share/miniconda/envs/sage-build/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,-rpath,/usr/share/miniconda/envs/sage-build/lib -L/usr/share/miniconda/envs/sage-build/lib -Wl,-rpath-link,/home/runner/work/sagetrac-mirror/sagetrac-mirror/local/lib -L/home/runner/work/sagetrac-mirror/sagetrac-mirror/local/lib -Wl,-rpath,/home/runner/work/sagetrac-mirror/sagetrac-mirror/local/lib -Wl,-O2 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,--disable-new-dtags -Wl,--gc-sections -Wl,-rpath,/usr/share/miniconda/envs/sage-build/lib -Wl,-rpath-link,/usr/share/miniconda/envs/sage-build/lib -L/usr/share/miniconda/envs/sage-build/lib -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /usr/share/miniconda/envs/sage-build/include -DNDEBUG -D_FORTIFY_SOURCE=2 -O2 -isystem /usr/share/miniconda/envs/sage-build/include build/temp.linux-x86_64-3.8/src/C/lapack.o -L/usr/share/miniconda/envs/sage-build/lib -lopenblas -lopenblas -o build/lib.linux-x86_64-3.8/cvxopt/lapack.cpython-38-x86_64-linux-gnu.so
2020-12-22T21:44:17.7974135Z [cvxopt-1.2.5]   building 'umfpack' extension
2020-12-22T21:44:17.7979362Z [cvxopt-1.2.5]   /usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-cc -Wno-unused-result -Wsign-compare -DNDEBUG -fwrapv -O2 -Wall -Wstrict-prototypes -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -pipe -march=nocona -mtune=haswell -ftree-vectorize -fPIC -fstack-protector-strong -fno-plt -O2 -ffunction-sections -pipe -isystem /usr/share/miniconda/envs/sage-build/include -DNDEBUG -D_FORTIFY_SOURCE=2 -O2 -isystem /usr/share/miniconda/envs/sage-build/include -fPIC -I/usr/include -I/home/runner/work/sagetrac-mirror/sagetrac-mirror/local/include -I/usr/share/miniconda/envs/sage-build/include/python3.8 -c src/C/umfpack.c -o build/temp.linux-x86_64-3.8/src/C/umfpack.o
2020-12-22T21:44:17.7990748Z [cvxopt-1.2.5]   In file included from /usr/share/miniconda/envs/sage-build/include/python3.8/Python.h:11:0,
2020-12-22T21:44:17.7991831Z [cvxopt-1.2.5]                    from src/C/cvxopt.h:22,
2020-12-22T21:44:17.7992613Z [cvxopt-1.2.5]                    from src/C/umfpack.c:22:
2020-12-22T21:44:17.7993750Z [cvxopt-1.2.5]   /usr/include/limits.h:26:10: fatal error: bits/libc-header-start.h: No such file or directory
2020-12-22T21:44:17.7994924Z [cvxopt-1.2.5]    #include <bits/libc-header-start.h>
2020-12-22T21:44:17.7995741Z [cvxopt-1.2.5]             ^~~~~~~~~~~~~~~~~~~~~~~~~~
2020-12-22T21:44:17.7996470Z [cvxopt-1.2.5]   compilation terminated.
2020-12-22T21:44:17.7997728Z [cvxopt-1.2.5]   error: command '/usr/share/miniconda/envs/sage-build/bin/x86_64-conda-linux-gnu-cc' failed with exit status 1
2020-12-22T21:44:17.7999070Z [cvxopt-1.2.5]   Building wheel for cvxopt (setup.py): finished with status 'error'
```

Could this be related to the fact that libcc1 is installed in `lib64`?


---

Comment by isuruf created at 2020-12-22 21:57:44

This is known. #30710


---

Comment by @tobiasdiez created at 2020-12-22 22:03:32

Ah thx for the pointer!


---

Comment by @tobiasdiez created at 2020-12-22 22:09:07

I guess the main objective of this ticket was to add a workflow verifying that sagelib installed on top of conda works. Since this is accomplished, I'll put it as ready for review.

Fixing the doctests and the build using `make` can be done later (e.g by resolving #30710).


---

Comment by @tobiasdiez created at 2020-12-22 22:09:07

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-12-23 00:13:05

As `on-top-of-spkg` turns out to be a variant of `local-conda-forge-ubuntu-standard`, I think I would want to implement this variant using tox.


---

Comment by mkoeppe created at 2020-12-23 00:22:23

I have opened #31099 for this.


---

Comment by @tobiasdiez created at 2020-12-23 11:25:05

Replying to [comment:36 mkoeppe]:
> As `on-top-of-spkg` turns out to be a variant of `local-conda-forge-ubuntu-standard`, I think I would want to implement this variant using tox.

I thought about using tox as well, but there are

a) problems setting up conda on github actions (this is why the workflow uses a special action for the conda setup) 

b) difficulties with conda and tox environment interactions (which I guess are handled by the tox-conda plugin, but I didn't wanted to dive into this)

c) I still think tox is not the right tool for managing the user's environment beyond the Python environment.


---

Comment by mkoeppe created at 2020-12-23 17:19:42

`local-conda-forge-ubuntu-standard` has been running for months on GH Actions, see for example https://github.com/sagemath/sage/runs/1553907433 for 9.3.beta4.

#31099 is just a matter of creating a variant that uses `conda env create -f environment.yml` instead of `conda install ...`.


---

Comment by chapoton created at 2021-01-31 20:01:29

red branch => needs work


---

Comment by chapoton created at 2021-01-31 20:01:29

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-04-02 20:21:54

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage


---

Comment by git created at 2021-11-12 17:52:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-12 17:54:26

I have reduced the branch to one of the jobs, `direct`, to remove the duplication with the existing workflows.


---

Comment by mkoeppe created at 2021-11-12 17:55:30

Still needs updating to follow the steps of "Conda for Sage Developers" - https://wiki.sagemath.org/Conda - help welcome


---

Comment by @tobiasdiez created at 2022-02-10 20:12:47

Last 10 new commits:


---

Comment by @tobiasdiez created at 2022-02-10 23:20:07

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-10 23:20:07

Okay, this is now ready for review.

Any pointers to the two open issues are welcome. I looked for open tickets in these directions, but couldn't find one.


---

Comment by git created at 2022-02-10 23:20:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-10 23:55:51

In https://github.com/sagemath/sagetrac-mirror/runs/5146995129?check_suite_focus=true I see

I see 

```
building 'sage.libs.lcalc.lcalc_Lfunction' extension
    cc1plus: warning: command line option '-Wstrict-prototypes' is valid for C/ObjC but not for C++
    In file included from sage/libs/lcalc/lcalc_Lfunction.cpp:740:
    sage/libs/lcalc/lcalc_sage.h:1:10: fatal error: lcalc/L.h: No such file or directory
        1 | #include "lcalc/L.h"
          |          ^~~~~~~~~~~
    compilation terminated.
    building 'sage.libs.libecm' extension
```



---

Comment by @tobiasdiez created at 2022-02-11 08:52:58

Good observation. I think, however, this is not the reason why the build terminates as this error occurs somewhere in the middle (and I had similar error messages with `gap` before).
I've added it to the list of "issues" in the ticket description.


---

Comment by mkoeppe created at 2022-02-11 18:18:14

This is the reason for the failure. There's no mystery there.


---

Comment by mkoeppe created at 2022-02-11 18:18:14

Changing status from needs_review to needs_work.


---

Comment by isuruf created at 2022-02-11 19:59:10

Do you get `lcalc>=2` with conda?


---

Comment by @tobiasdiez created at 2022-02-11 20:40:01

Replying to [comment:55 mkoeppe]:
> This is the reason for the failure. There's no mystery there.

Could be. But the point of this ticket is to add the github action, so that one can fix these issues in follow-up tickets and have a direct verification. It might take quite some time until this workflow is green, especially since there are probably quite a few tests that fail.

So except if you think that there is something fundamentally flawed with the current steps which result in the lcalc error, this should be ready for review.


---

Comment by @tobiasdiez created at 2022-02-11 20:40:01

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-11 20:43:16

Replying to [comment:56 isuruf]:
> Do you get `lcalc>=2` with conda?

Nope, its installing lcalc 1.23 h0d16fac_1004 conda-forge. That's probably the reason why its not working.


---

Comment by mkoeppe created at 2022-02-11 20:46:39

So `build/pkgs/lcalc/distros/conda.txt` should be changed


---

Comment by mkoeppe created at 2022-02-11 20:48:08

Replying to [comment:57 gh-tobiasdiez]:
> the point of this ticket is to add the github action

Well, it fails early, so we cannot see whether the later steps work.


---

Comment by @tobiasdiez created at 2022-02-12 15:39:39

Replying to [comment:59 mkoeppe]:
> So `build/pkgs/lcalc/distros/conda.txt` should be changed

I don't think it will be that easy to solve:

```
mamba install lcalc=2.0.5 -n sage-dev
 > package libeantic-1.0.2-hf1f868f_1 requires antic >=0.2.4,<0.3.0a0, but none of the providers can be installed

mamba install libeantic=1.1.0 -n sage-dev
 > package libeantic-1.1.0-h52e3b27_0 requires arb >=2.21.1,<2.22.0a0, but none of the providers can be installed

mamba install arb=2.21.1 -n sage-dev
 > package e-antic-1.0.2-hf1f868f_0 requires arb >=2.19.0,<2.20.0a0, but none of the providers can be installed
```

I appears that there is a funny cyclic dependency thing going on.


---

Comment by @tobiasdiez created at 2022-02-12 15:40:22

Replying to [comment:60 mkoeppe]:
> Replying to [comment:57 gh-tobiasdiez]:
> > the point of this ticket is to add the github action
> 
> Well, it fails early, so we cannot see whether the later steps work.

Should I un-comment the last test step for now?


---

Comment by mkoeppe created at 2022-02-12 16:44:28

Try switching from `src/environment-optional.yml` to `src/environment.yml`.
`e_antic` is an optional package for Sage. Let's try without optional packages first.


---

Comment by git created at 2022-02-12 17:51:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-12 17:58:07

That should indeed work to get `loalc 2.0.5`. Good suggestion.

For the record: first installing `environment.yml` and then updating the env to `environment-optional.yml` yields the following downgrade of packgages:

```
  Downgrade:
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

  - arb                                               2.22.1  hbbd85db_0              installed
  + arb                                               2.19.0  h7e34412_0              conda-forge/linux-64        7MB
  - boost-cpp                                         1.77.0  h359cf19_1              installed
  + boost-cpp                                         1.74.0  h312852a_4              conda-forge/linux-64     Cached
  - cvxopt                                             1.2.7  py310h9fd565e_1         installed
  + cvxopt                                             1.2.6  py38h55e5319_0          conda-forge/linux-64     Cached
  - cysignals                                         1.11.2  py310h15010d2_0         installed
  + cysignals                                         1.10.3  py38hd3cf888_0          conda-forge/linux-64     Cached
  - eclib                                           20210625  h52f5ea4_4              installed
  + eclib                                           20190909  h5b7fb09_3              conda-forge/linux-64       36MB
  - gap-core                                          4.11.1  h1725ef4_2              installed
  + gap-core                                          4.11.0  h1725ef4_7              conda-forge/linux-64       67MB
  - gap-defaults                                      4.11.1  ha770c72_2              installed
  + gap-defaults                                      4.11.0  ha770c72_7              conda-forge/linux-64       88MB
  - gsl                                                  2.7  he838d99_0              installed
  + gsl                                                  2.6  he838d99_2              conda-forge/linux-64     Cached
  - harfbuzz                                           3.3.1  hb4a5f5f_0              installed
  + harfbuzz                                           3.1.1  h83ec7ef_0              conda-forge/linux-64     Cached
  - icu                                                 69.1  h9c3ff4c_0              installed
  + icu                                                 68.2  h9c3ff4c_0              conda-forge/linux-64     Cached
  - lcalc                                              2.0.5  h8cd7e2e_0              installed
  + lcalc                                               1.23  h0d16fac_1004           conda-forge/linux-64     Cached
  - libclang                                          13.0.1  default_hc23dcda_0      installed
  + libclang                                          11.1.0  default_ha53f305_1      conda-forge/linux-64     Cached
  - libflint                                           2.8.4  hd3cd37b_ntl_100        installed
  + libflint                                           2.6.3  h6b702e8_0              conda-forge/linux-64       11MB
  - libpq                                               14.2  hd57d9b9_0              installed
  + libpq                                               13.5  hd57d9b9_1              conda-forge/linux-64     Cached
  - libuv                                             1.43.0  h7f98852_0              installed
  + libuv                                             1.42.0  h7f98852_0              conda-forge/linux-64     Cached
  - pari                                              2.13.3  h82e6b41_1_pthread      installed
  + pari                                              2.11.4  hddaffa3_2              conda-forge/linux-64     Cached
  - python                                            3.10.2  h85951f9_3_cpython      installed
  + python                                            3.8.12  ha38a3c6_3_cpython      conda-forge/linux-64     Cached
  - python_abi                                          3.10  2_cp310                 installed
  + python_abi                                           3.8  2_cp38                  conda-forge/linux-64     Cached
  - r-base                                             4.1.2  hde4fec0_0              installed
  + r-base                                             4.1.1  hb67fd72_0              conda-forge/linux-64     Cached
  - singular                                        4.2.1.p3  haca423c_0              installed
  + singular                                        4.1.1.p2  ha188dad_4              conda-forge/linux-64       22MB

```



---

Comment by mkoeppe created at 2022-02-12 18:07:01

There must be some outdated pins / version constraints in the conda-forge packaging. Likely related to the fact that the Sage distribution has fallen behind upstream regarding `e_antic`/`normaliz` (see #31588).


---

Comment by mkoeppe created at 2022-02-12 18:11:07

`@`isuruf, I think Sage works fine with current upstream versions of normaliz/pynormaliz that use the `e_antic` 1.x series, so it should be safe to remove such constraints. (We just can't yet update within the Sage distribution because of portability bugs in `e_antic`, see #31588.)


---

Comment by mkoeppe created at 2022-02-12 18:13:22

Replying to [comment:59 mkoeppe]:
> So `build/pkgs/lcalc/distros/conda.txt` should be changed
... to say `"lcalc >=2"`


---

Comment by mkoeppe created at 2022-02-12 18:23:58

Regarding the `pari` issue mentioned in the ticket description, we should probably use  `configure --with-system-pari=force` so the error is signalled earlier

Let's also keep the instructions in https://wiki.sagemath.org/Conda updated.


---

Comment by mkoeppe created at 2022-02-12 18:25:16

Oh, and `configure --with-system-lcalc=force` too...


---

Comment by @tobiasdiez created at 2022-02-12 18:34:02

Replying to [comment:70 mkoeppe]:
> Regarding the `pari` issue mentioned in the ticket description, we should probably use  `configure --with-system-pari=force` so the error is signalled earlier
> 
> Let's also keep the instructions in https://wiki.sagemath.org/Conda updated. 

With the basic env, its now also using `pari 2.13.3`.

I guess some of the optional packages is lagging behind a bit and still requiring some older version of some package. This then leads to these various downgrades of arb, ecl, pari, lcalc etc


---

Comment by mkoeppe created at 2022-02-12 18:38:42

Yes, and we are missing many of the version constraints that are in https://github.com/conda-forge/sage-feedstock/blob/master/recipe/meta.yaml


---

Comment by mkoeppe created at 2022-02-12 18:40:14

Many of these should be added to the `conda.txt` files, so that they will be included in our `src/environment*.yml`.


---

Comment by git created at 2022-02-12 18:55:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-12 20:16:36

Okay, after using `environment.yml` the build now succeeds. The tests fail almost immediately at the import of `sage.all`, because `primecountpy` is not installed in the conda env (it is also in neither `environment` file).

I propose to get this ticket in and then work on the improvements to fix the various issues.


---

Comment by mkoeppe created at 2022-02-12 20:19:43

Just add `build/pkgs/primecountpy/distros/conda.txt`


---

Comment by mkoeppe created at 2022-02-12 20:20:42

At the current pace, it will take months before this ticket is merged. Little point in waiting for that to happen. There's a momentum now to fix it.


---

Comment by mkoeppe created at 2022-02-12 20:22:37

comment:70, comment:71, comment:76, comment:82 are actionable


---

Comment by mkoeppe created at 2022-02-12 20:30:32

Also, the ticket description claims that it follows https://wiki.sagemath.org/Conda; but that uses `pip install -r src/requirements.txt`, which would install the missing `primecountpy` too.


---

Comment by isuruf created at 2022-02-12 20:34:28

It's better to not use pip.


---

Comment by @tobiasdiez created at 2022-02-12 20:40:01

Replying to [comment:83 mkoeppe]:
> At the current pace, it will take months before this ticket is merged. Little point in waiting for that to happen. There's a momentum now to fix it.

That's sadly true, but follow-up tickets can easily depend on this ticket here to run the CI.


---

Comment by mkoeppe created at 2022-02-12 20:46:42

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-02-12 22:19:24

Replying to [comment:71 mkoeppe]:
> Oh, and `configure --with-system-lcalc=force` too...

Do you really think we should add a `--with-system-xyz=force` for every system package?


---

Comment by mkoeppe created at 2022-02-12 22:28:22

I don't have a better solution at the moment, but at least there's a reasonably short way to write it as `configure --with-system-{gcc,lcalc}=force`...


---

Comment by mkoeppe created at 2022-02-12 22:30:02

Or generate it as `$(for pkg in $(./sage -package list :standard: --has-file spkg-configure.m4); do echo --with-system-$pkg=force; done)`


---

Comment by isuruf created at 2022-02-12 22:34:49

Why do you need `--with-system-lcalc=force`?


---

Comment by mkoeppe created at 2022-02-12 22:36:21

So that it is an immediate error if the system package is not usable. Here we are testing the workflow that does not run `make` at all.


---

Comment by @tobiasdiez created at 2022-02-12 23:14:39

Replying to [comment:92 mkoeppe]:
> Or generate it as `$(for pkg in $(./sage -package list :standard: --has-file spkg-configure.m4); do echo --with-system-$pkg=force; done)`

But doesn't this trigger errors as soon as a system package is rejected? That currently happens with a lot of packages as you can see in the github workflow.

Moreover, we have complete control over which versions we install in the conda systems, so one could actually skip the whole system check that ̀ configure` currently performs.


---

Comment by mkoeppe created at 2022-02-13 00:07:21

Replying to [comment:95 gh-tobiasdiez]:
> Replying to [comment:92 mkoeppe]:
> > Or generate it as `$(for pkg in $(./sage -package list :standard: --has-file spkg-configure.m4); do echo --with-system-$pkg=force; done)`
> 
> But doesn't this trigger errors as soon as a system package is rejected? That currently happens with a lot of packages as you can see in the github workflow.

Yes, that's the idea. For packages that have an `spkg-configure.m4`, our configure script knows which versions work. It should fail early if there is something that cannot be accepted.


---

Comment by mkoeppe created at 2022-02-13 00:08:08

Replying to [comment:95 gh-tobiasdiez]:
> Moreover, we have complete control over which versions we install in the conda systems, so one could actually skip the whole system check that ̀ configure` currently performs.

That is something that is best left to the downstream packagers.


---

Comment by mkoeppe created at 2022-02-13 00:11:28

Replying to [comment:95 gh-tobiasdiez]:
> That currently happens with a lot of packages as you can see in the github workflow.

`python3` is rejected because your script doesn't follow the instructions at https://wiki.sagemath.org/Conda - `--with-python=$CONDA_PREFIX/bin/python` is missing.


---

Comment by mkoeppe created at 2022-02-13 00:13:31

And many others fail because you use `--without-system-gcc`, which is a bad idea.


---

Comment by git created at 2022-02-13 09:22:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-13 09:39:22

Replying to [comment:99 mkoeppe]:
> And many others fail because you use `--without-system-gcc`, which is a bad idea.

Otherwise configure fails with

```
 configure: error: 

    Given --with-system-gcc=force, but no system package could be used.
    That's an error.  Please install the indicated package to continue.
    (To override this error, use ./configure --without-system-gcc)
```



---

Comment by git created at 2022-02-13 09:44:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @tobiasdiez created at 2022-02-13 09:45:23

Replying to [comment:97 mkoeppe]:
> Replying to [comment:95 gh-tobiasdiez]:
> > Moreover, we have complete control over which versions we install in the conda systems, so one could actually skip the whole system check that ̀ configure` currently performs.
> 
> That is something that is best left to the downstream packagers.
> 

The section has the title "Conda for Sage Developers" so downstream packagers are not involved here.


---

Comment by @tobiasdiez created at 2022-02-13 09:45:58

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-13 11:17:47

Replying to [comment:82 mkoeppe]:
> Just add `build/pkgs/primecountpy/distros/conda.txt`

This is now #33330.


---

Comment by dimpase created at 2022-02-13 12:31:21

I undestand that the GH run on #33330 uses this branch, so it looks good to me.


---

Comment by dimpase created at 2022-02-13 12:31:21

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-02-13 13:17:09

Also here, thanks for the review.


---

Comment by @tobiasdiez created at 2022-02-13 13:59:29

I've now created #33331 for the follow-up issues.


---

Comment by mkoeppe created at 2022-02-13 16:07:43

Replying to [comment:103 gh-tobiasdiez]:
> Replying to [comment:97 mkoeppe]:
> > Replying to [comment:95 gh-tobiasdiez]:
> > > Moreover, we have complete control over which versions we install in the conda systems, so one could actually skip the whole system check that ̀ configure` currently performs.
> > 
> > That is something that is best left to the downstream packagers.
> 
> The section has the title "Conda for Sage Developers" so downstream packagers are not involved here.

Exactly, so in other words we should not attempt to skip `configure`'s checks.


---

Comment by mkoeppe created at 2022-02-13 16:09:07

Replying to [comment:101 gh-tobiasdiez]:
> Replying to [comment:99 mkoeppe]:
> > And many others fail because you use `--without-system-gcc`, which is a bad idea.
> 
> Otherwise configure fails with
> {{{
>  configure: error: 
> 
>     Given --with-system-gcc=force, but no system package could be used.
>     That's an error.  Please install the indicated package to continue.
>     (To override this error, use ./configure --without-system-gcc)
> }}}

Why does it reject gcc?


---

Comment by mkoeppe created at 2022-02-13 16:14:28

comment:98 still unaddressed


---

Comment by dimpase created at 2022-02-13 21:08:22

Replying to [comment:113 mkoeppe]:
> comment:98 still unaddressed

It is addressed in comment:100 (commit ​8a297af), no?


---

Comment by mkoeppe created at 2022-02-13 21:14:39

That commit is not on the current branch


---

Comment by @tobiasdiez created at 2022-02-13 21:33:16

Yes, I had to revert that commit since the workflow didn't passed. https://github.com/sagemath/sagetrac-mirror/actions/runs/1836383017

That conda's python is rejected is #31539. And since sage is not invoking python during the workflow run, it also shouldn't matter if its rejected or not.


---

Comment by mkoeppe created at 2022-02-13 21:47:27

That failure was from `gcc`, not python. So why back out the fix for python?


---

Comment by mkoeppe created at 2022-02-13 21:48:19

Replying to [comment:116 gh-tobiasdiez]:
> since sage is not invoking python during the workflow run

Hm?


---

Comment by @tobiasdiez created at 2022-02-13 21:51:33

Replying to [comment:117 mkoeppe]:
> That failure was from `gcc`, not python. So why back out the fix for python?

Since it is working without this "fix".


---

Comment by mkoeppe created at 2022-02-13 21:54:36

Also, could you please add some steps that package up the logs, like the three last steps of `local-ubuntu` in tox.yml?

Right now we cannot see what went wrong in the `gcc` detection, as we cannot see config.log


---

Comment by mkoeppe created at 2022-02-13 21:58:33

Replying to [comment:119 gh-tobiasdiez]:
> Replying to [comment:117 mkoeppe]:
> > That failure was from `gcc`, not python. So why back out the fix for python?
> 
> Since it is working without this "fix".

But what does it test? Currently certainly not installation steps that we could recommend to developers. The `configure` run should really reflect the system configuration.


---

Comment by dimpase created at 2022-02-14 10:45:38

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-02-14 12:56:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-14 12:57:07

Replying to [comment:120 mkoeppe]:
> Also, could you please add some steps that package up the logs, like the three last steps of `local-ubuntu` in tox.yml?
> 
> Right now we cannot see what went wrong in the `gcc` detection, as we cannot see config.log

Done.


---

Comment by @tobiasdiez created at 2022-02-14 12:58:43

Replying to [comment:121 mkoeppe]:
> Replying to [comment:119 gh-tobiasdiez]:
> > Replying to [comment:117 mkoeppe]:
> > > That failure was from `gcc`, not python. So why back out the fix for python?
> > 
> > Since it is working without this "fix".
> 
> But what does it test? Currently certainly not installation steps that we could recommend to developers. The `configure` run should really reflect the system configuration.

I still don't understand why it's so important that sage's configure script accepts conda's python, but I've added the explicit `--with-python` argument.


---

Comment by dimpase created at 2022-02-14 13:04:45

> I still don't understand why it's so important that sage's configure script accepts conda's python

How else would you expect to be using Conda's Python packages in Sage, if you used another Python?


---

Comment by @tobiasdiez created at 2022-02-14 14:42:56

The workflow is completely bypassing the make-scripts of sage. So using Conda's python packages follows the 'usual' strategy:
- Create (virtual) python environment (done by conda)
- Install other python packages (done by conda)
- Install sagelib into the same environment (done via pip install)

So sage is not managing the python installation nor the python environment. It is simply a normal python package that gets installed in an existing environment. In this context, it is pretty non-standard to pose more requirements at the python installation then a simple version requirement (which is checked by pip). Ideally, you wouldn't even want to call configure, a simple `pip install -e src` should be enough (and that's for example the workflow numpy and scipy are using), but that's of course currently not possible.


---

Comment by dimpase created at 2022-02-14 16:27:20

OK, but note that `./bootstrap` and `./configure` still need to be run to install various things and fill in `*.in` templates.
Passing wrong parameters to `./configure` is not a good idea, IMHO.


---

Comment by mkoeppe created at 2022-02-14 17:09:51

Replying to [comment:125 gh-tobiasdiez]:
> > > Since it is working without this "fix".
> > 
> > But what does it test? Currently certainly not installation steps that we could recommend to developers. The `configure` run should really reflect the system configuration.
> 
> I still don't understand why it's so important that sage's configure script accepts conda's python

As I said before in comment:70, comment:92, etc., the configure script should really be invoked with `--with-system-xyz=force` for all packages for which we have `spkg-configure.m4`.


---

Comment by mkoeppe created at 2022-02-14 17:16:52

Replying to [ticket:30845 mkoeppe]:
> - Documentation doesn't mention the use of `--prefix=$CONDA_PREFIX` (without this things like `ecl-config` are not found)

For example, this one about `ecl-config` is the result of the misconfiguration. The configure script does not accept system ecl because of the misconfiguration `--without-system-gcc`. So the configuration reflects use of an ECL built using SPKG (which is not done because `make` is not involved).


---

Comment by @tobiasdiez created at 2022-02-14 17:52:06

Replying to [comment:128 dimpase]:
> OK, but note that `./bootstrap` and `./configure` still need to be run to install various things and fill in `*.in` templates.
> Passing wrong parameters to `./configure` is not a good idea, IMHO.

Sure, I agree with this!


---

Comment by @tobiasdiez created at 2022-02-14 17:53:53

Replying to [comment:129 mkoeppe]:
> Replying to [comment:125 gh-tobiasdiez]:
> > > > Since it is working without this "fix".
> > > 
> > > But what does it test? Currently certainly not installation steps that we could recommend to developers. The `configure` run should really reflect the system configuration.
> > 
> > I still don't understand why it's so important that sage's configure script accepts conda's python
> 
> As I said before in comment:70, comment:92, etc., the configure script should really be invoked with `--with-system-xyz=force` for all packages for which we have `spkg-configure.m4`.

Not sure if that's really a good idea or if it would be better to just exclude versions of conda packages that are known to not work. But regardless, adding these force statements doesn't currently work.


---

Comment by mkoeppe created at 2022-02-14 17:56:40

Replying to [comment:132 gh-tobiasdiez]:
> adding these force statements doesn't currently work.

You reported that `--with-system-gcc=force` does not work; what else does not work?


---

Comment by mkoeppe created at 2022-02-14 18:01:16

Replying to [comment:133 mkoeppe]:
> Replying to [comment:132 gh-tobiasdiez]:
> > adding these force statements doesn't currently work.
> 
> You reported that `--with-system-gcc=force` does not work

... and we can fix it if you show us the config.log


---

Comment by @tobiasdiez created at 2022-02-14 18:03:49

I didn't check the force argument, but ecl, arb, ntl, ppl are not recognized.


---

Comment by mkoeppe created at 2022-02-14 18:07:00

yes, because of the misconfigured gcc (I just explained it in comment:130)


---

Comment by mkoeppe created at 2022-02-14 18:09:37

Replying to [comment:132 gh-tobiasdiez]:
> > the configure script should really be invoked with `--with-system-xyz=force` for all packages for which we have `spkg-configure.m4`.
> 
> Not sure if that's really a good idea or if it would be better to just exclude versions of conda packages that are known to not work. 

Both.


---

Comment by git created at 2022-02-14 18:23:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-14 19:15:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-14 19:18:19

Replying to [comment:137 mkoeppe]:
> Replying to [comment:132 gh-tobiasdiez]:
> > > the configure script should really be invoked with `--with-system-xyz=force` for all packages for which we have `spkg-configure.m4`.
> > 
> > Not sure if that's really a good idea or if it would be better to just exclude versions of conda packages that are known to not work. 
> 
> Both. 

What's the point of the force except that the workflow fails early? Wouldn't it make more sense to let it run through and see what error it produces?


---

Comment by mkoeppe created at 2022-02-14 19:30:12

Replying to [comment:140 gh-tobiasdiez]:
> What's the point of the force except that the workflow fails early? 

Failing early is good. 

> Wouldn't it make more sense to let it run through and see what error it produces?

No, because we do not want to send developers to manually diagnose build or run problems that have already been diagnosed and codified in our configure tests.


---

Comment by @tobiasdiez created at 2022-02-14 19:53:29

Replying to [comment:139 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[5940d76](https://git.sagemath.org/sage.git/commit/?id=5940d76d46fa1f5762f69f446d756a5a1ca38559)||`Try again with system gcc`||

Locally this fails, output can be found at https://github.com/sagemath/sagetrac-mirror/runs/5189468934?check_suite_focus=true in a bit.

It accepts the conda gcc if I remove the `--prefix=$CONDA_PREFIX` part. But then a few other packages are still not properly recognized:  `ecl bdw-gc libhomfly` (which was the reason why I added the prefix in the first place). Nothing of this is specific to the github action and can easily be investigated after creating a conda env locally.

But can we do this error analysis and corresponding improvements please in a follow-up ticket? The version using prefix works with almost no test failures (apart from giac, which is broken and has already a ticket). Moreover, in this ticket, I tried to codify the instructions of the wiki in a github workflow. The instructions didn't work for me verbatim in a fresh clone, nor via the github action. The current version works relatively well in my eyes. I'm happy to try a different combination of commands, but then please check yourself that these work locally for you.


---

Comment by @tobiasdiez created at 2022-02-14 19:57:00

Replying to [comment:141 mkoeppe]:
> Replying to [comment:140 gh-tobiasdiez]:
> > What's the point of the force except that the workflow fails early? 
> 
> Failing early is good. 
> 
> > Wouldn't it make more sense to let it run through and see what error it produces?
> 
> No, because we do not want to send developers to manually diagnose build or run problems that have already been diagnosed and codified in our configure tests.
> 

What about adding a warning annotation in the github workflow when a system package is not recognized? Then you still get the information that the config didn't work as expected but keep the benefit of seeing error messages. This should become helpful down the road, as the conda packages are quite up to date and thus may fail to be recognized for the simple reason that they are too new.


---

Comment by mkoeppe created at 2022-02-14 19:58:31

comment:121 - the workflow should be testing something that we can recommend to developers. As of the current branch it's "let's misconfigure creatively so that configure does not end with an error; please ignore everything that the configure script says because it does not matter. There may be errors in build and run later, YMMV."


---

Comment by mkoeppe created at 2022-02-14 20:02:36

Replying to [comment:142 gh-tobiasdiez]:
> I'm happy to try a different combination of commands, but then please check yourself that these work locally for you.

I've already offered to fix the problem with `--with-system-gcc=force`


---

Comment by mkoeppe created at 2022-02-14 20:09:04

Replying to [comment:142 gh-tobiasdiez]:
> It accepts the conda gcc if I remove the `--prefix=$CONDA_PREFIX` part. But then a few other packages are still not properly recognized:  `ecl bdw-gc libhomfly` (which was the reason why I added the prefix in the first place).

These reports would be more useful if you attach the config.log


---

Comment by @tobiasdiez created at 2022-02-14 20:10:13

Replying to [comment:145 mkoeppe]:
> Replying to [comment:142 gh-tobiasdiez]:
> > I'm happy to try a different combination of commands, but then please check yourself that these work locally for you.
> 
> I've already offered to fix the problem with `--with-system-gcc=force`

Can you please give the full commands that create a working conda env and are able to recognize gcc and ecl. As you can see here `with-system-gcc` doesn't work: https://github.com/sagemath/sagetrac-mirror/runs/5189468934?check_suite_focus=true


---

Comment by mkoeppe created at 2022-02-14 20:10:48

Replying to [comment:146 mkoeppe]:
> Replying to [comment:142 gh-tobiasdiez]:
> > It accepts the conda gcc if I remove the `--prefix=$CONDA_PREFIX` part. But then a few other packages are still not properly recognized:  `ecl bdw-gc libhomfly` (which was the reason why I added the prefix in the first place).
> 
> These reports would be more useful if you attach the config.log
> 
((Yes, it's available now at https://github.com/sagemath/sagetrac-mirror/runs/5189468934?check_suite_focus=true)


---

Attachment

Replying to [comment:146 mkoeppe]:
> Replying to [comment:142 gh-tobiasdiez]:
> > It accepts the conda gcc if I remove the `--prefix=$CONDA_PREFIX` part. But then a few other packages are still not properly recognized:  `ecl bdw-gc libhomfly` (which was the reason why I added the prefix in the first place).
> 
> These reports would be more useful if you attach the config.log
> 

Now attached to the ticket.


---

Comment by mkoeppe created at 2022-02-14 20:23:09

Replying to [comment:146 mkoeppe]:
> Replying to [comment:142 gh-tobiasdiez]:
> > It accepts the conda gcc if I remove the `--prefix=$CONDA_PREFIX` part.

OK, here's why it does not accept it when the (questionable, but perhaps currently necessary) option `--prefix=$CONDA_PREFIX` is given:
`build/pkgs/gcc/spkg-configure.m4` has these lines:

```
    if test -f "$SAGE_LOCAL/bin/gcc"; then
        # Special value for SAGE_INSTALL_GCC if GCC is already installed
        SAGE_INSTALL_GCC=exists
        # Set yes since this implies we have already installed GCC and want to keep
        # it selected
        sage_spkg_install_gcc=yes

        # Check whether it actually works...
        # See https://trac.sagemath.org/ticket/24599
        SAGE_CHECK_BROKEN_GCC()
[...]
```



---

Comment by mkoeppe created at 2022-02-14 20:25:18

I'll work on a fix for this later today.


---

Comment by mkoeppe created at 2022-02-14 20:29:05

Replying to [comment:149 gh-tobiasdiez]:
> Replying to [comment:146 mkoeppe]:
> > These reports would be more useful if you attach the config.log
> 
> Now attached to the ticket.

Thanks. From config.log:

```
## --------------------------------------------------- ##
## Checking whether SageMath should install SPKG gc... ##
## --------------------------------------------------- ##
configure:19428: checking whether any of libatomic_ops is installed as or will be installed as SPKG
configure:19437: result: no
configure:19440: checking whether we run on WSL
configure:19444: result: yes; disabling using of system gc
configure:19693: no suitable system package found for SPKG gc
```

This is why `ecl` and `homfly` are not used.


---

Comment by dimpase created at 2022-02-14 20:29:41

`ecl` is rejected because `gc` is rejected on WSL, see #30629: Reject system libgc that breaks ECL build on WSL

This rejection should not happen if ECL is already provided, I think. (ditto for the other consumers of `gc` - `libhomfly`)


---

Comment by mkoeppe created at 2022-02-14 20:31:52

Replying to [comment:153 dimpase]:
> This rejection should not happen if ECL is already provided, I think. (ditto for the other consumers of `gc` - `libhomfly`)

This one is pretty subtle. `gc` is used by both ECL and libhomfly. So only if BOTH can be used from the system, then we do not need to build `gc` itself.


---

Comment by dimpase created at 2022-02-14 20:39:38

Actually, Jammy already has fixed `gc`.
https://launchpad.net/ubuntu/+source/libgc
https://bugs.launchpad.net/ubuntu/+source/libgc/+bug/1897371/comments/1


---

Comment by mkoeppe created at 2022-02-14 20:42:27

So we need an improved test


---

Comment by dimpase created at 2022-02-14 20:48:01

is it `gc`  from Conda (it should be OK, right?)


---

Comment by @tobiasdiez created at 2022-02-14 20:55:11

Replying to [comment:157 dimpase]:
> is it `gc`  from Conda (it should be OK, right?)

Yes it's bdw-gc 8.0.4, which is probably to old. There is a PR updating to 8.0.6 but that's unmerged for quite some time now https://github.com/conda-forge/bdw-gc-feedstock/pull/17


---

Comment by git created at 2022-02-14 21:01:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-02-14 21:04:18

Conda's gc would only be too old if it were built with a particular option.

They probably use it to build ecl, and it won't fly if it was broken!


---

Comment by git created at 2022-02-14 21:07:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 21:07:55

Here's an attempt, not really tested yet


---

Comment by git created at 2022-02-14 23:21:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-02-14 23:21:37

Tested locally with `EXTRA_CONFIGURE_ARGS=--prefix=/opt/conda tox -e docker-conda-forge-standard -- config.status`


---

Comment by mkoeppe created at 2022-02-15 01:57:42

Replying to [comment:91 mkoeppe]:
> I don't have a better solution at the moment, but at least there's a reasonably short way to write it as `configure --with-system-{gcc,lcalc}=force`...

Now I have a better solution: With #33345, we can use `configure --with-system-standard-packages=force`.


---

Comment by git created at 2022-02-15 02:05:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-15 04:26:15

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @tobiasdiez created at 2022-02-15 12:15:39

Replying to [comment:152 mkoeppe]:
> Replying to [comment:149 gh-tobiasdiez]:
> > Replying to [comment:146 mkoeppe]:
> > > These reports would be more useful if you attach the config.log
> > 
> > Now attached to the ticket.
> 
> Thanks. From config.log:
> {{{
> ## --------------------------------------------------- ##
> ## Checking whether [SageMath](SageMath) should install SPKG gc... ##
> ## --------------------------------------------------- ##
> configure:19428: checking whether any of libatomic_ops is installed as or will be installed as SPKG
> configure:19437: result: no
> configure:19440: checking whether we run on WSL
> configure:19444: result: yes; disabling using of system gc
> configure:19693: no suitable system package found for SPKG gc
> }}}
> This is why `ecl` and `homfly` are not used.

That makes sense. Sorry, should have investigated this before deviating from the instructions outlined in the wiki. Thanks for your patience and investigation.


---

Comment by @tobiasdiez created at 2022-02-15 12:16:35

Replying to [comment:165 mkoeppe]:
> Replying to [comment:91 mkoeppe]:
> > I don't have a better solution at the moment, but at least there's a reasonably short way to write it as `configure --with-system-{gcc,lcalc}=force`...
> 
> Now I have a better solution: With #33345, we can use `configure --with-system-standard-packages=force`.

https://trac.sagemath.org/ticket/30845#comment:143 ?


---

Comment by dimpase created at 2022-02-15 12:21:28

Replying to [comment:158 gh-tobiasdiez]:
> Replying to [comment:157 dimpase]:
> > is it `gc`  from Conda (it should be OK, right?)
> 
> Yes it's bdw-gc 8.0.4, which is probably to old. There is a PR updating to 8.0.6 but that's unmerged for quite some time now https://github.com/conda-forge/bdw-gc-feedstock/pull/17

Upstream says one has to check that

```
strings /usr/lib/x86_64-linux-gnu/libgc.so | grep "Wrong __data_start/_end pair"
}}} 
does not find anything. But this rules out all 8.0.4 (and possibly earlier) installations of libgc, not only broken ones.


---

Comment by mkoeppe created at 2022-02-15 15:55:42

Replying to [comment:143 gh-tobiasdiez]:
> What about adding a warning annotation in the github workflow when a system package is not recognized? 

We don't have a mechanism for that, see discussion in #29499.


---

Comment by mkoeppe created at 2022-02-15 15:59:11

Replying to [comment:143 gh-tobiasdiez]:
> the conda packages are quite up to date and thus may fail to be recognized for the simple reason that they are too new.

That's not really specific to conda-forge but also true for various cutting-edge distributions including archlinux and gentoo


---

Comment by mkoeppe created at 2022-02-15 16:03:41

How about adding another job (via matrix) that uses `src/environment-optional.yml`?


---

Comment by mkoeppe created at 2022-02-15 16:07:33

Also, adding jobs that test other python versions could probably be useful


---

Comment by @tobiasdiez created at 2022-02-15 16:49:56

Replying to [comment:171 mkoeppe]:
> Replying to [comment:143 gh-tobiasdiez]:
> > What about adding a warning annotation in the github workflow when a system package is not recognized? 
> 
> We don't have a mechanism for that, see discussion in #29499.

One could add a problem matcher for "no suitable system package; standard, will be installed as an SPKG" for now.


---

Comment by @tobiasdiez created at 2022-02-15 16:51:25

Replying to [comment:173 mkoeppe]:
> How about adding another job (via matrix) that uses `src/environment-optional.yml`?

Probably wait with this until this workflow here passes without errors. There is not much of an advantage in having 5 different matrix flows fail.


---

Comment by @tobiasdiez created at 2022-02-15 16:52:52

Replying to [comment:172 mkoeppe]:
> Replying to [comment:143 gh-tobiasdiez]:
> > the conda packages are quite up to date and thus may fail to be recognized for the simple reason that they are too new.
> 
> That's not really specific to conda-forge but also true for various cutting-edge distributions including archlinux and gentoo

But in this case the workflow does not simply fail because the package is not accepted, right?


---

Comment by mkoeppe created at 2022-02-15 17:04:17

Replying to [comment:175 gh-tobiasdiez]:
> Replying to [comment:171 mkoeppe]:
> > Replying to [comment:143 gh-tobiasdiez]:
> > > What about adding a warning annotation in the github workflow when a system package is not recognized? 
> > 
> > We don't have a mechanism for that, see discussion in #29499.
> 
> One could add a problem matcher for "no suitable system package; standard, will be installed as an SPKG" for now.

No, the problem is that the configuration variables need to be set for the accepted system packages. #29499#comment:3


---

Comment by mkoeppe created at 2022-02-15 17:05:49

Replying to [comment:176 gh-tobiasdiez]:
> Replying to [comment:173 mkoeppe]:
> > How about adding another job (via matrix) that uses `src/environment-optional.yml`?
> 
> Probably wait with this until this workflow here passes without errors. 

Just reduce the errors in the `ptest` to warnings. This would be in line with the entire portability test suite.


---

Comment by mkoeppe created at 2022-02-15 17:20:09

Replying to [comment:177 gh-tobiasdiez]:
> Replying to [comment:172 mkoeppe]:
> > Replying to [comment:143 gh-tobiasdiez]:
> > > the conda packages are quite up to date and thus may fail to be recognized for the simple reason that they are too new.
> > 
> > That's not really specific to conda-forge but also true for various cutting-edge distributions including archlinux and gentoo
> 
> But in this case the workflow does not simply fail because the package is not accepted, right?

That's right, Sage will just build the SPKG.


---

Comment by mkoeppe created at 2022-02-15 17:28:32

When a Sage user/developer follows our (to-be-updated) instructions with `--with-system-standard-packages=force` and it gives the configure error regarding the unsuitable system package, there is a clear recourse: Find and install a version that works.

When Sage developers see this in the CI run, there is also a clear course of action: Adjust the conda-specific version constraints in `conda.txt` files if possible; or file a conda bug report. 

Seeing error messages from using a system package that `configure` knows to reject does not help. It only leads to developers engaging in unproductive guesswork. 

For updating Sage and our `spkg-configure.m4` scripts to work with new versions, local development and testing on many platforms is necessary anyway; it does not help if there's 1 platform that already speculatively displays some errors.


---

Comment by @tobiasdiez created at 2022-02-15 17:31:28

Replying to [comment:178 mkoeppe]:
> Replying to [comment:175 gh-tobiasdiez]:
> > Replying to [comment:171 mkoeppe]:
> > > Replying to [comment:143 gh-tobiasdiez]:
> > > > What about adding a warning annotation in the github workflow when a system package is not recognized? 
> > > 
> > > We don't have a mechanism for that, see discussion in #29499.
> > 
> > One could add a problem matcher for "no suitable system package; standard, will be installed as an SPKG" for now.
> 
> No, the problem is that the configuration variables need to be set for the accepted system packages. #29499#comment:3
> 

I meant as a github annotation. Just run configure without `-with-system = force`. Then configure will print "no suitable system package; standard, will be installed as an SPKG", which is detected and reported in the action overview.


---

Comment by mkoeppe created at 2022-02-15 17:32:52

Replying to [comment:182 gh-tobiasdiez]:
> I meant as a github annotation. Just run configure without `-with-system = force`. Then configure will print "no suitable system package; standard, will be installed as an SPKG", which is detected and reported in the action overview. 

Sure, +1 on that, that's a good idea.


---

Comment by mkoeppe created at 2022-02-15 17:35:33

I have some of this in tox.yml, matching configure warnings and error


---

Comment by git created at 2022-02-15 18:02:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2022-02-15 20:49:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-02-16 11:08:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-16 12:32:03

Replying to [comment:183 mkoeppe]:
> Replying to [comment:182 gh-tobiasdiez]:
> > I meant as a github annotation. Just run configure without `-with-system = force`. Then configure will print "no suitable system package; standard, will be installed as an SPKG", which is detected and reported in the action overview. 
> 
> Sure, +1 on that, that's a good idea.

Okay, this is now implemented. See https://github.com/sagemath/sagetrac-mirror/actions/runs/1852417654


---

Comment by @tobiasdiez created at 2022-02-16 12:33:39

The tests now fail with the following error:

```
************************************************************************
It seems that you are attempting to run Sage from an unpacked source
tarball, but you have not compiled it yet (or maybe the build has not
finished). You should run `make` in the Sage root directory first.
If you did not intend to build Sage from source, you should download
a binary tarball instead. Read README.txt for more information.
************************************************************************
```

Is this a consequence of me merging the latest develop branch, or did I accidentally misconfigured something?
How can one overwrite this check?


---

Comment by @tobiasdiez created at 2022-02-16 12:36:51

Replying to [comment:173 mkoeppe]:
> How about adding another job (via matrix) that uses `src/environment-optional.yml`?

Done, but it is currently failing (as reported before). Also added a minimal matrix for python versions 3.8 + 3.9


---

Comment by mkoeppe created at 2022-02-16 16:52:40

Replying to [comment:185 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> ||[c1c9e61](https://git.sagemath.org/sage.git/commit/?id=c1c9e6123b0f4c516e3007415e731dab1f38b5ec)||`Add matrix`||
> ||[6ff193f](https://git.sagemath.org/sage.git/commit/?id=6ff193fe4608756ee7b99b0b9f465beaab5bc7bf)||`Add problem matcher`||

This nuked my changes, intended?


---

Comment by mkoeppe created at 2022-02-16 16:53:36

Replying to [comment:190 gh-tobiasdiez]:
> Dependencies #33330, #33345 deleted

?


---

Comment by @tobiasdiez created at 2022-02-16 17:31:04

Replying to [comment:193 mkoeppe]:
> Replying to [comment:190 gh-tobiasdiez]:
> > Dependencies #33330, #33345 deleted
> 
> ?

No longer needed.


---

Comment by isuruf created at 2022-02-16 17:35:15

Replying to [comment:191 gh-tobiasdiez]:
> Replying to [comment:173 mkoeppe]:
> > How about adding another job (via matrix) that uses `src/environment-optional.yml`?
> 
> Done, but it is currently failing (as reported before). Also added a minimal matrix for python versions 3.8 + 3.9

Should be fixed with #33358


---

Comment by mkoeppe created at 2022-02-16 17:37:33

Replying to [comment:183 mkoeppe]:
> Replying to [comment:182 gh-tobiasdiez]:
> > I meant as a github annotation. Just run configure without `-with-system = force`. Then configure will print "no suitable system package; standard, will be installed as an SPKG", which is detected and reported in the action overview. 
> 
> Sure, +1 on that, that's a good idea.

Wait, I missed that you said "run configure without `-with-system = force`".

I was +1 on adding the problem matchers.


---

Comment by mkoeppe created at 2022-02-16 17:39:40

In comment:181 I explained why we DON'T want to have it run anyway and produce mysterious errors that send developers into doing unproductive guesswork.


---

Comment by mkoeppe created at 2022-02-16 17:39:47

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-02-16 17:58:51

Replying to [comment:197 mkoeppe]:
> In comment:181 I explained why we DON'T want to have it run anyway and produce mysterious errors that send developers into doing unproductive guesswork.

> When Sage developers see this in the CI run, there is also a clear course of action: Adjust the conda-specific version constraints in conda.txt files if possible; or file a conda bug report. 

This is still accomplished with the current problem matchers, and even easier. Developer looks at the workflow run, sees that system packages are not accepted and can take action. In addition, she can directly see what errors result from not accepting the system package.

I don't see any advantage in hiding useful information (what does break because of the missing package).


---

Comment by @tobiasdiez created at 2022-02-16 17:59:22

Replying to [comment:195 isuruf]:
> Replying to [comment:191 gh-tobiasdiez]:
> > Replying to [comment:173 mkoeppe]:
> > > How about adding another job (via matrix) that uses `src/environment-optional.yml`?
> > 
> > Done, but it is currently failing (as reported before). Also added a minimal matrix for python versions 3.8 + 3.9
> 
> Should be fixed with #33358

Thanks!


---

Comment by @tobiasdiez created at 2022-02-16 17:59:44

Any idea on how to fix #30845#comment:189?


---

Comment by mkoeppe created at 2022-02-16 18:01:50

Replying to [comment:199 gh-tobiasdiez]:
> I don't see any advantage in hiding useful information

I've already explained that it's not useful for those who know how to update our configure tests.


---

Comment by mkoeppe created at 2022-02-16 18:04:06

Replying to [comment:201 gh-tobiasdiez]:
> Any idea on how to fix #30845#comment:189?

Yes, you didn't install the Sage library where you promised that it would be installed. `SAGE_LOCAL` (set by `--prefix`) defaults to `SAGE_ROOT/local` and `SAGE_VENV` defaults to a subdirectory of it. But you installed the Sage library instead into the system site-packages.


---

Comment by mkoeppe created at 2022-02-16 18:07:54

Replying to [comment:199 gh-tobiasdiez]:
> Replying to [comment:197 mkoeppe]:
> > In comment:181 I explained why we DON'T want to have it run anyway and produce mysterious errors that send developers into doing unproductive guesswork.
> 
> > When Sage developers see this in the CI run, there is also a clear course of action: Adjust the conda-specific version constraints in conda.txt files if possible; or file a conda bug report. 
> 
> This is still accomplished with the current problem matchers, and even easier. 

But it misses the criterion of comment:121 - does it test what we would recommend to developers.


---

Comment by mkoeppe created at 2022-02-16 18:24:12

Also comment:178.


---

Comment by @tobiasdiez created at 2022-02-16 18:28:43

Replying to [comment:203 mkoeppe]:
> Replying to [comment:201 gh-tobiasdiez]:
> > Any idea on how to fix #30845#comment:189?
> 
> Yes, you didn't install the Sage library where you promised that it would be installed. `SAGE_LOCAL` (set by `--prefix`) defaults to `SAGE_ROOT/local` and `SAGE_VENV` defaults to a subdirectory of it. But you installed the Sage library instead into the system site-packages.

And how does one fix it without using prefix (which according to you isn't desired)?


---

Comment by mkoeppe created at 2022-02-16 18:33:02

For now, using `--prefix` is the best option. That's why I provided commits 9799fd7/757bd73.


---

Comment by git created at 2022-02-16 18:49:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-16 19:34:15

Replying to [comment:195 isuruf]:
> Replying to [comment:191 gh-tobiasdiez]:
> > Replying to [comment:173 mkoeppe]:
> > > How about adding another job (via matrix) that uses `src/environment-optional.yml`?
> > 
> > Done, but it is currently failing (as reported before). Also added a minimal matrix for python versions 3.8 + 3.9
> 
> Should be fixed with #33358

It is indeed correctly using lcalc 2 now. Thanks!


---

Comment by @tobiasdiez created at 2022-02-16 19:35:44

Replying to [comment:207 mkoeppe]:
> For now, using `--prefix` is the best option. That's why I provided commits 9799fd7/757bd73.

Thanks. I've reverted to using --prefix (with --without-system-gcc). Let's put your improvements to the gcc detection script in a follow-up ticket.


---

Comment by @tobiasdiez created at 2022-02-16 19:37:40

Replying to [comment:202 mkoeppe]:
> Replying to [comment:199 gh-tobiasdiez]:
> > I don't see any advantage in hiding useful information
> 
> I've already explained that it's not useful for those who know how to update our configure tests.

There are also people that don't know much about these configure scripts but still want to work on the conda environment.

The point of this ticket (at least for me), is having a CI infrastructure to confirm that updates to the conda evniroment such as #33330 and #33358 indeed have a positive impact. For this it is not helpful if the workflow exists early because some conda package got updated in the meantime and now the corresponding "system" package is rejected by sage.

To be honest, I feel tired by this discussion and think we already invested more time discussing pros and cons then developer will ever spend while chasing mysterious bugs potentially coming from this. If its so important to you, I would like to ask you to implement it in a follow-up ticket.


---

Comment by @tobiasdiez created at 2022-02-16 19:40:41

It's now working: build succeeds and most tests pass in all tested configs. https://github.com/sagemath/sagetrac-mirror/actions/runs/1854640215

Let's move potential improvements (like removing --prefix, --without-system-gcc, fixes to giac, updates to the docs etc) to follow-up tickets.


---

Comment by @tobiasdiez created at 2022-02-16 19:40:41

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-02-16 19:41:10

Replying to [comment:212 gh-tobiasdiez]:
> Replying to [comment:202 mkoeppe]:
> > Replying to [comment:199 gh-tobiasdiez]:
> > > I don't see any advantage in hiding useful information
> > 
> > I've already explained that it's not useful for those who know how to update our configure tests.
> 
> There are also people that don't know much about these configure scripts but still want to work on the conda environment.

Yes, and they can do that as I explained in comment:181. They don't need to see the errors if they don't want to work on the configure scripts.


---

Comment by mkoeppe created at 2022-02-16 19:44:01

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2022-02-16 19:44:01

Replying to [comment:213 gh-tobiasdiez]:
> It's now working: build succeeds and most tests pass in all tested configs.

It still doesn't pass the criterion of comment:121 - does it test what we would recommend to developers.


---

Comment by mkoeppe created at 2022-02-16 19:45:10

Replying to [comment:212 gh-tobiasdiez]:
> If it's so important to you, I would like to ask you to implement it in a follow-up ticket.

I already did, but you removed the commits that implemented it.


---

Comment by @tobiasdiez created at 2022-02-16 19:47:54

Replying to [comment:215 mkoeppe]:
> Replying to [comment:213 gh-tobiasdiez]:
> > It's now working: build succeeds and most tests pass in all tested configs.
> 
> It still doesn't pass the criterion of comment:121 - does it test what we would recommend to developers.
> 

C'mon, according to your own information using --prefix is the best way currently. Without any changes to gcc detection or whatever (which is not the point of this ticket), this only works with --without-system-gcc.


---

Comment by isuruf created at 2022-02-16 20:41:59

`@`gh-tobiasdiez, can you restore `@`mkoeppe's commits that fixed the gcc detection? Then we can use --prefix.


---

Comment by mkoeppe created at 2022-02-16 20:48:09

I'll put these commits on #33361 now


---

Comment by git created at 2022-02-17 12:08:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-02-17 12:09:32

Replying to [comment:219 mkoeppe]:
> I'll put these commits on #33361 now

Thanks


---

Comment by @tobiasdiez created at 2022-02-17 12:11:47

Changing status from needs_work to needs_review.


---

Comment by @tobiasdiez created at 2022-02-17 12:11:47

Replying to [comment:218 isuruf]:
> `@`gh-tobiasdiez, can you restore `@`mkoeppe's commits that fixed the gcc detection? Then we can use --prefix. 

Done by merging #33361. (For the record, I initially removed these commits because it seemed like the whole prefix thing wasn't necessary).

Still a bit confused why #33361 couldn't just be a follow-up on top of this ticket, but, well, I guess I'm used to a different developing/merging strategy.


---

Comment by @tobiasdiez created at 2022-02-17 12:23:44

Seems to work well, no gc errors anymore and all standard conda packages are detected successfully (even with the `environment-optional.yml).

So should be good to go now.


---

Comment by dimpase created at 2022-02-17 17:07:35

How is there no `gc` error any more? What has changed in this respect?


---

Comment by @tobiasdiez created at 2022-02-17 17:45:21

Replying to [comment:225 dimpase]:
> How is there no `gc` error any more? What has changed in this respect? 

#33361 fixed it.


---

Comment by dimpase created at 2022-02-17 17:52:18

Replying to [comment:226 gh-tobiasdiez]:
> Replying to [comment:225 dimpase]:
> > How is there no `gc` error any more? What has changed in this respect? 
> 
> #33361 fixed it.
this must be close a miracle - as only `gcc` was touched there.


---

Comment by mkoeppe created at 2022-02-17 17:53:46

`gc` was rejected via SPKG_DEPCHECK on `gcc`.


---

Comment by dimpase created at 2022-02-17 18:16:15

Replying to [comment:228 mkoeppe]:
> `gc` was rejected via SPKG_DEPCHECK on `gcc`.
Does this mean that somehow #33361 is blessing `gcc`'s deps?
Hmm, not sure I follow.


---

Comment by dimpase created at 2022-02-17 18:52:35

no, that's really weird. `gc` is not used by `gcc`... OK, this is a Church of gcc spkg, and I'm a non-believer...


---

Comment by mkoeppe created at 2022-02-17 18:54:50

Replying to [comment:228 mkoeppe]:
> `gc` was rejected via SPKG_DEPCHECK on `gcc`.

Sorry, I was wrong - I misremembered


---

Comment by mkoeppe created at 2022-02-17 18:55:55

There was no problem with `gc` except within Tobias's WSL install.


---

Comment by @tobiasdiez created at 2022-02-17 19:37:13

Sorry for the missing c and the confusion it caused :-)


---

Comment by dimpase created at 2022-02-17 20:29:26

![](https://i.stack.imgur.com/jiFfM.jpg)


---

Comment by mkoeppe created at 2022-03-15 21:08:31

Replying to [comment:92 mkoeppe]:
> Or generate it as `$(for pkg in $(./sage -package list :standard: --has-file spkg-configure.m4); do echo --with-system-$pkg=force; done)`

With dependency #33361 positively reviewed, but #33345 (`configure --with-system-standard-packages=force`) stalled, let's use the above as a solution.


---

Comment by mkoeppe created at 2022-03-15 21:46:10

`@`isuruf - `--with-system-lrcalc=force` fails because conda-forge does not provide lrcalc 2.x yet


---

Comment by slelievre created at 2022-03-16 08:20:04

Fixed by

- https://github.com/conda-forge/lrcalc-feedstock/pull/7


---

Comment by @tobiasdiez created at 2022-03-16 17:55:07

Replying to [comment:235 mkoeppe]:
> Replying to [comment:92 mkoeppe]:
> > Or generate it as `$(for pkg in $(./sage -package list :standard: --has-file spkg-configure.m4); do echo --with-system-$pkg=force; done)`
> 
> With dependency #33361 positively reviewed, but #33345 (`configure --with-system-standard-packages=force`) stalled, let's use the above as a solution.


If a system package is not used, then an error message is displayed in the github flow, so these force arguments are not necessary (or can later be added as part of #33345) .

Can we please get this ticket in?


---

Comment by git created at 2022-03-16 18:57:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-16 19:00:24

Replying to [comment:238 gh-tobiasdiez]:
> Can we please get this ticket in? 

Working on it, as you can see


---

Comment by mkoeppe created at 2022-03-16 19:13:47

Replying to [comment:237 slelievre]:
> Fixed by
> 
> - https://github.com/conda-forge/lrcalc-feedstock/pull/7

Great, now I see that lrcalc 2.1. Still need https://pypi.org/project/lrcalc/ in conda-forge, or we need to install it with pip.


---

Comment by @tobiasdiez created at 2022-03-16 19:25:36

Replying to [comment:240 mkoeppe]:
> Replying to [comment:238 gh-tobiasdiez]:
> > Can we please get this ticket in? 
> 
> Working on it, as you can see

Can you please revert 574c6df thanks!


---

Comment by mkoeppe created at 2022-03-16 19:40:36

I'm also getting

```
Checking whether SageMath should install SPKG singular...
checking whether any of gmp ntl flint readline mpfr cddlib is installed as or will be installed as SPKG... no
checking for Singular... /usr/share/miniconda/envs/sage-build/bin/Singular
checking for SINGULAR... no
...
configure: error: 

    Given --with-system-singular=force, but no system package could be used.
    That's an error.  Please install the indicated package to continue.
    (To override this error, use ./configure --without-system-singular)
```

(https://github.com/mkoeppe/sage/runs/5575546912?check_suite_focus=true)


---

Comment by mkoeppe created at 2022-03-16 19:41:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-03-16 19:45:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-16 19:48:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2022-03-16 19:58:20

Working on both lrcalc and singular issue. Can you add `python-lrcalc` as the name for conda package for `lrcalc_python`?


---

Comment by mkoeppe created at 2022-03-16 20:00:06

Will do, thanks!


---

Comment by git created at 2022-03-16 20:03:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2022-03-16 20:04:40

Can you also do `singular>=4.2.1.p3`? Apparently conda thinks `4.2.1.p3` is a development version and is `<4.2.1`


---

Comment by git created at 2022-03-16 20:06:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-16 20:07:03

Replying to [comment:243 mkoeppe]:
> I'm also getting
> {{{
> Checking whether [SageMath](SageMath) should install SPKG singular...
> checking whether any of gmp ntl flint readline mpfr cddlib is installed as or will be installed as SPKG... no
> checking for Singular... /usr/share/miniconda/envs/sage-build/bin/Singular
> checking for SINGULAR... no
> ...
> configure: error: 
> 
>     Given --with-system-singular=force, but no system package could be used.
>     That's an error.  Please install the indicated package to continue.
>     (To override this error, use ./configure --without-system-singular)
> }}}
> (https://github.com/mkoeppe/sage/runs/5575546912?check_suite_focus=true)

Can we please do this in a follow-up ticket (i.e. remove the force for now). This has nothing to do with the github action action in this ticket.

Similarly, the changes to the conda package versions / package names should go to their own tickets (based on this ticket here to check if they indeed work as intended).
----
New commits:


---

Comment by mkoeppe created at 2022-03-16 20:09:18

Replying to [comment:253 gh-tobiasdiez]:
> Can we please do this in a follow-up ticket (i.e. remove the force for now). This has nothing to do with the github action action in this ticket.
> 
> Similarly, the changes to the conda package versions / package names should go to their own tickets (based on this ticket here to check if they indeed work as intended).

Please, Tobias, an author repeatedly demanding that the ticket goes in "as is" is not helpful and is not part of the collaborative workflow of the Sage project.


---

Comment by mkoeppe created at 2022-03-16 20:09:52

Replying to [comment:251 isuruf]:
> Can you also do `singular>=4.2.1.p3`? Apparently conda thinks `4.2.1.p3` is a development version and is `<4.2.1`

Thanks, this works.


---

Comment by @tobiasdiez created at 2022-03-16 20:29:54

Replying to [comment:254 mkoeppe]:
> Replying to [comment:253 gh-tobiasdiez]:
> > Can we please do this in a follow-up ticket (i.e. remove the force for now). This has nothing to do with the github action action in this ticket.
> > 
> > Similarly, the changes to the conda package versions / package names should go to their own tickets (based on this ticket here to check if they indeed work as intended).
> 
> Please, Tobias, an author repeatedly demanding that the ticket goes in "as is" is not helpful and is not part of the collaborative workflow of the Sage project. 

That's not what I'm saying. I just don't see the need that these changes, that then need further changes etc need to be part of this ticket. I'm happy to adjust the github workflow if you have any comments/suggestions on this.


---

Comment by mkoeppe created at 2022-03-17 01:17:58

I see that `python-lrcalc` 2.1 is now available in the conda-forge channel. Thanks `@`isuruf! 

Tests running at https://github.com/mkoeppe/sage/actions/runs/1996031338


---

Comment by mkoeppe created at 2022-03-17 03:37:21

There's something wrong with libgiac, in the doctests of `src/sage/calculus/calculus.py` it looks like infinite recursion


---

Comment by git created at 2022-03-17 06:25:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-17 06:26:56

I have also added tests on `macos-latest`. This reproduces an error that I saw on my machine: `ppl` is rejected by the configure script.

see https://github.com/mkoeppe/sage/runs/5581501610?check_suite_focus=true


---

Comment by dimpase created at 2022-03-17 09:24:27

Replying to [comment:260 mkoeppe]:
> I have also added tests on `macos-latest`. This reproduces an error that I saw on my machine: `ppl` is rejected by the configure script.
> 
> see https://github.com/mkoeppe/sage/runs/5581501610?check_suite_focus=true

this looks to me like a bug in `m4/ppl.m4`. They extract `-L`, etc, flags into `PPL_LDFLAGS` but forget
to append them to `LDFLAGS` for testing in `AC_RUN_IF_ELSE`. Something like this should make it work
(assuming these flags are getting into `PPL_LDFLAGS` at all):


```diff
--- a/m4/ppl.m4
+++ b/m4/ppl.m4
@@ -96,9 +96,11 @@ else
   if test "x$enable_ppltest" = xyes
   then
     ac_save_CPPFLAGS="$CPPFLAGS"
+    ac_save_LDFLAGS="$LDFLAGS"
     ac_save_LIBS="$LIBS"
     CPPFLAGS="$CPPFLAGS $PPL_CPPFLAGS"
     LIBS="$LIBS $PPL_LIBS"
+    LDFLAGS="$LDFLAGS $PPL_LDFLAGS"
 
 dnl Now check if the installed PPL is sufficiently new.
 dnl (Also sanity checks the results of ppl-config to some extent.)
@@ -238,6 +240,7 @@ main() {
 
     CPPFLAGS="$ac_save_CPPFLAGS"
     LIBS="$ac_save_LIBS"
+    LDFLAGS="$ac_save_LDFLAGS"
   fi
 fi
 
@@ -261,6 +264,7 @@ else
       echo "*** Could not run PPL test program, checking why..."
       CPPFLAGS="$CPPFLAGS $PPL_CPPFLAGS"
       LIBS="$LIBS $PPL_LIBS"
+      LDFLAGS="$LDFLAGS $PPL_LDFLAGS"
       AC_LINK_IFELSE([AC_LANG_PROGRAM([[
 #include <ppl.hh>
 using namespace Parma_Polyhedra_Library;
@@ -287,6 +291,7 @@ using namespace Parma_Polyhedra_Library;
 ])
       CPPFLAGS="$ac_save_CPPFLAGS"
       LIBS="$ac_save_LIBS"
+      LDFLAGS="$ac_save_LDFLAGS"
     fi
   fi
   PPL_CPPFLAGS=""
```


Untested.


---

Comment by git created at 2022-03-17 09:38:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-17 09:41:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by isuruf created at 2022-03-17 09:44:40

No, it's a bug in the conda package with binary relocation. Will fix shortly.

Replying to [comment:261 dimpase]:
> Replying to [comment:260 mkoeppe]:
> > I have also added tests on `macos-latest`. This reproduces an error that I saw on my machine: `ppl` is rejected by the configure script.
> > 
> > see https://github.com/mkoeppe/sage/runs/5581501610?check_suite_focus=true
> 
> this looks to me like a bug in `m4/ppl.m4`. They extract `-L`, etc, flags into `PPL_LDFLAGS` but forget


---

Comment by @tobiasdiez created at 2022-03-17 12:58:35

I've reverted the changes to the lower bounds to singular and lrcalc since for me they were not necessary. It also looks like on github `lcalc 2.1` and `singular 4.2.1.p3` are used automatically. This is also expected since conda always tries to use the most recent versions and only in very rare instances lower bounds are necessary (essentially only if there are two different branches in the dependency resolution tree, and conda would choose the 'wrong' one). Why did you added these lower bounds?


---

Comment by @tobiasdiez created at 2022-03-17 13:55:07

Replying to [comment:260 mkoeppe]:
> I have also added tests on `macos-latest`. This reproduces an error that I saw on my machine: `ppl` is rejected by the configure script.
> 
> see https://github.com/mkoeppe/sage/runs/5581501610?check_suite_focus=true

And which advantages does one now gain from the fact that the github workflow already quits after the configure step, and doesn't run build and tests?

Moreover, after the change with the force parameter the github matcher is no longer working correctly since now " no suitable system package; this is an error" is displayed in the logs.


---

Comment by git created at 2022-03-17 15:09:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-17 15:10:08

Replying to [comment:265 gh-tobiasdiez]:
> I've reverted the changes to the lower bounds to singular and lrcalc since for me they were not necessary

Yes, they are not needed any more, thanks.


---

Comment by mkoeppe created at 2022-03-17 15:12:38

`@`isuruf, on macos with `environment-optional.yml` (https://github.com/mkoeppe/sage/runs/5586815094?check_suite_focus=true), I am getting an error from gdb

```
Warning: ERROR conda.core.link:_execute(699): An error occurred while installing package 'conda-forge::gdb-11.1-py38h36b043a_3'.
  
  ERROR conda.core.link:_execute(699): An error occurred while installing package 'conda-forge::gdb-11.1-py38h36b043a_3'.
  Rolling back transaction: ...working... done
  Warning: 
  LinkError: post-link script failed for package conda-forge::gdb-11.1-py38h36b043a_3
  location of failed script: /usr/local/miniconda/envs/sage-build/bin/.gdb-post-link.sh
  ==> script messages <==
  <None>
  ==> script output <==
  stdout: Warning: GDB is not codesigned.
  Generating and installing gdb_codesign certificate
  
  stderr: cat: /usr/local/miniconda/envs/sage-build/etc/gdb/.messages.txt: No such file or directory
  error: Something went wrong when installing the certificate
  
  return code: 1
  
  ()
  
  
  
  LinkError: post-link script failed for package conda-forge::gdb-11.1-py38h36b043a_3
  location of failed script: /usr/local/miniconda/envs/sage-build/bin/.gdb-post-link.sh
  ==> script messages <==
  <None>
  ==> script output <==
  stdout: Warning: GDB is not codesigned.
  Generating and installing gdb_codesign certificate
  
  stderr: cat: /usr/local/miniconda/envs/sage-build/etc/gdb/.messages.txt: No such file or directory
  error: Something went wrong when installing the certificate
  
  return code: 1
  
```



---

Comment by mkoeppe created at 2022-03-17 16:32:44

`@`isuruf, on macos I see lots of warnings `ld: warning: -pie being ignored. It is only used when linking a main executable` in the doctests. I see this is coming from `LDFLAGS` in the conda environments. Is this something that can be fixed, or should we silence this warning in our doctest machinery?


---

Comment by mkoeppe created at 2022-03-17 16:37:07

Replying to [comment:258 mkoeppe]:
> There's something wrong with libgiac, in the doctests of `src/sage/calculus/calculus.py` it looks like infinite recursion

This one is specific to Linux; it's fine on macos.


---

Comment by git created at 2022-03-17 17:00:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-17 19:21:02

Replying to [comment:272 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[ed0967c](https://git.sagemath.org/sage.git/commit/?id=ed0967c881b63c928391ce4cbe8f7bf6370d187c)||`.github/workflows/configure-systempackage-problem-matcher.json: Also match 'no suitable system package; this is an error'`||

Error: Unable to process command '::add-matcher::.github/workflows/configure-systempackage-problem-matcher.json' successfully.
Error: After parsing a value an unexpected character was encountered: {. Path 'problemMatcher[0]', line 15, position 8.


---

Comment by @tobiasdiez created at 2022-03-17 19:21:33

Is there something else that is left to do?


---

Comment by isuruf created at 2022-03-17 19:32:16

Replying to [comment:270 mkoeppe]:
> `@`isuruf, on macos I see lots of warnings `ld: warning: -pie being ignored. It is only used when linking a main executable` in the doctests. I see this is coming from `LDFLAGS` in the conda environments. Is this something that can be fixed, or should we silence this warning in our doctest machinery?

Not easy to do. It's better to silence in the doctest machinery


---

Comment by mkoeppe created at 2022-03-17 19:33:37

OK, I'll do that so that the noise from these warnings does not hide real failures


---

Comment by isuruf created at 2022-03-17 19:37:38

Can you open an issue in https://github.com/conda-forge/gdb-feedstock/?

Replying to [comment:269 mkoeppe]:
> `@`isuruf, on macos with `environment-optional.yml` (https://github.com/mkoeppe/sage/runs/5586815094?check_suite_focus=true), I am getting an error from gdb
> {{{
> Warning: ERROR conda.core.link:_execute(699): An error occurred while installing package 'conda-forge::gdb-11.1-py38h36b043a_3'.
>   
>   ERROR conda.core.link:_execute(699): An error occurred while installing package 'conda-forge::gdb-11.1-py38h36b043a_3'.
>   Rolling back transaction: ...working... done
>   Warning: 
>   LinkError: post-link script failed for package conda-forge::gdb-11.1-py38h36b043a_3
>   location of failed script: /usr/local/miniconda/envs/sage-build/bin/.gdb-post-link.sh
>   ==> script messages <==
>   <None>
>   ==> script output <==
>   stdout: Warning: GDB is not codesigned.
>   Generating and installing gdb_codesign certificate
>   
>   stderr: cat: /usr/local/miniconda/envs/sage-build/etc/gdb/.messages.txt: No such file or directory
>   error: Something went wrong when installing the certificate
>   
>   return code: 1
>   
>   ()
>   
>   
>   
>   LinkError: post-link script failed for package conda-forge::gdb-11.1-py38h36b043a_3
>   location of failed script: /usr/local/miniconda/envs/sage-build/bin/.gdb-post-link.sh
>   ==> script messages <==
>   <None>
>   ==> script output <==
>   stdout: Warning: GDB is not codesigned.
>   Generating and installing gdb_codesign certificate
>   
>   stderr: cat: /usr/local/miniconda/envs/sage-build/etc/gdb/.messages.txt: No such file or directory
>   error: Something went wrong when installing the certificate
>   
>   return code: 1
>   
> }}}


---

Comment by mkoeppe created at 2022-03-17 19:41:59

A minor thing to fix: Installing sagelib downgrades `scipy`, `networkx` via install-requires; that's now #33520.


---

Comment by git created at 2022-03-17 19:51:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-17 19:52:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-17 19:53:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-17 20:02:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-03-17 20:05:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-17 20:06:13

Replying to [comment:277 isuruf]:
> Can you open an issue in https://github.com/conda-forge/gdb-feedstock/?

Will do. For now I've disabled it


---

Comment by mkoeppe created at 2022-03-17 20:24:55

I've opened https://github.com/conda-forge/gdb-feedstock/issues/53


---

Comment by git created at 2022-03-17 20:27:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-17 22:27:43

Replying to [comment:287 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[b431edb](https://git.sagemath.org/sage.git/commit/?id=b431edb380db1a4bd7fc07c5619bc350a45ca428)||`.github/workflows/configure-systempackage-problem-matcher.json: Fix 'Duplicate owner name'`||

`echo "::remove-matcher owner=configure-systempackage::"` in the workflow has to be probably be changed as well now.


---

Comment by @tobiasdiez created at 2022-03-17 22:29:34

Btw, the new workflow is running in the sagetrac-mirror repo (https://github.com/sagemath/sagetrac-mirror/actions/workflows/ci-conda.yml) so you don't have to run this manually in your own fork.


---

Comment by mkoeppe created at 2022-03-17 22:56:43

macos-latest-3.8-environment: https://github.com/mkoeppe/sage/runs/5591728773?check_suite_focus=true

```
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/env.py  # 1 doctest failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/interfaces/expect.py  # 40 doctests failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/interfaces/gap.py  # 75 doctests failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/interfaces/mwrank.py  # 6 doctests failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/interfaces/quit.py  # 6 doctests failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/repl/interpreter.py  # 2 doctests failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/repl/interface_magic.py  # 1 doctest failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/repl/ipython_kernel/install.py  # 1 doctest failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/structure/coerce_actions.pyx  # 1 doctest failed
sage -t --random-seed=295057506920321218473335936870781003380 src/sage/tests/cmdline.py  # 2 doctests failed
```



---

Comment by mkoeppe created at 2022-03-17 23:00:48

I think the many failures from `sage.interfaces` are the failure of too recent versions of `ptyprocess` (#32147).


---

Comment by mkoeppe created at 2022-03-17 23:08:09

`@`isuruf unfortunately, the only working version of ptyprocess (0.5.1) on macOS is only available on outdated python versions in conda-forge.

```
ptyprocess                     0.5.1          py27_0  conda-forge         
ptyprocess                     0.5.1          py34_0  conda-forge         
ptyprocess                     0.5.1          py35_0  conda-forge         
ptyprocess                     0.5.1          py36_0  conda-forge         
```



---

Comment by git created at 2022-03-17 23:09:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-17 23:23:03

Replying to [comment:290 gh-tobiasdiez]:
> Btw, the new workflow is running in the sagetrac-mirror repo (https://github.com/sagemath/sagetrac-mirror/actions/workflows/ci-conda.yml) so you don't have to run this manually in your own fork.

Thanks, yes, but the pipeline is pretty clogged


---

Comment by git created at 2022-03-17 23:24:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-03-17 23:32:34

The other failures on macOS are very minor.


---

Comment by mkoeppe created at 2022-03-17 23:36:06

Replying to [comment:258 mkoeppe]:
> There's something wrong with libgiac, in the doctests of `src/sage/calculus/calculus.py` it looks like infinite recursion

This failure on Linux is the remaining big issue.


---

Comment by mkoeppe created at 2022-03-17 23:43:39

(The log of these runs is about 250 MB uncompressed, not fun to look at.)


---

Comment by mkoeppe created at 2022-03-17 23:52:58

There's also some cysignals-related breakage on Linux:

```
2022-03-17T21:25:16.4730359Z **********************************************************************
2022-03-17T21:25:16.4812929Z File "src/sage/functions/min_max.py", line 240, in sage.functions.min_max.MaxSymbolic._evalf_
2022-03-17T21:25:16.4813319Z Failed example:
2022-03-17T21:25:16.4813740Z     sig_on_count() # check sig_on/off pairings (virtual doctest)
2022-03-17T21:25:16.4814033Z Expected:
2022-03-17T21:25:16.4814224Z     0
2022-03-17T21:25:16.4814414Z Got:
2022-03-17T21:25:16.4814603Z     2947
2022-03-17T21:25:16.4935843Z **********************************************************************
```



---

Comment by isuruf created at 2022-03-18 06:55:51

giac error should be fixed with https://github.com/conda-forge/giac-feedstock/pull/29


---

Comment by git created at 2022-03-18 08:58:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-03-18 08:59:15

Most doctests are now passing, so this should be good to go now (leaving fixes to the other tests to follow-up tickets).


---

Comment by @tobiasdiez created at 2022-03-18 08:59:15

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-03-18 15:11:39

`continue-on-error` makes no sense because the unconfigured source tree cannot be tested.


---

Comment by mkoeppe created at 2022-03-18 15:15:44

Replying to [comment:302 isuruf]:
> giac error should be fixed with https://github.com/conda-forge/giac-feedstock/pull/29

Thanks `@`isuruf, looking great.


---

Comment by mkoeppe created at 2022-03-18 15:20:09

Replying to [comment:305 mkoeppe]:
> `continue-on-error` makes no sense because the unconfigured source tree cannot be tested.

Other than that, it's in good shape now. Could someone review my changes please?


---

Comment by @tobiasdiez created at 2022-03-18 15:46:11

Replying to [comment:305 mkoeppe]:
> `continue-on-error` makes no sense because the unconfigured source tree cannot be tested.

That largely depends on the nature of the error. If the error in the config step is critical, then the build step will fail and no tests are run. Moreover, there is no harm in executing also the other steps, the workflow will still be displayed as failed due to the error in the config job. You just get a bit more information.


---

Comment by mkoeppe created at 2022-03-18 15:47:58

Replying to [comment:308 gh-tobiasdiez]:
> Replying to [comment:305 mkoeppe]:
> > `continue-on-error` makes no sense because the unconfigured source tree cannot be tested.
> 
> That largely depends on the nature of the error. 

No, it doesn't. On error, the generated files are not generated.


---

Comment by @tobiasdiez created at 2022-03-18 15:48:29

Replying to [comment:307 mkoeppe]:
> Replying to [comment:305 mkoeppe]:
> > `continue-on-error` makes no sense because the unconfigured source tree cannot be tested.
> 
> Other than that, it's in good shape now. Could someone review my changes please?

I'm fine with these changes (although they probably should have been extracted to their own tickets as they don't have to do anything with the github workflow; but lets not be overly pedantic).


---

Comment by @tobiasdiez created at 2022-03-18 16:10:58

Replying to [comment:309 mkoeppe]:
> Replying to [comment:308 gh-tobiasdiez]:
> > Replying to [comment:305 mkoeppe]:
> > > `continue-on-error` makes no sense because the unconfigured source tree cannot be tested.
> > 
> > That largely depends on the nature of the error. 
> 
> No, it doesn't. On error, the generated files are not generated.

I tried it locally and the necessary files seem to be still present when `with-system-SPKG=force` triggers an error. Having a quick look at the code these errors are also deferred to the very end of the configure script.


---

Comment by mkoeppe created at 2022-03-18 16:18:27

Replying to [comment:314 gh-tobiasdiez]:
> I tried it locally and the necessary files seem to be still present when `with-system-SPKG=force` triggers an error. Having a quick look at the code these errors are also deferred to the very end of the configure script.

You are right.


---

Comment by mkoeppe created at 2022-03-18 16:20:14

Nevertheless, `continue-on-error` makes no sense as I have explained throughout the thread, comment:141 etc.


---

Comment by mkoeppe created at 2022-03-18 16:33:33

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-03-18 16:33:33

But it's fine for now, let's see that we can get it merged in 9.6.


---

Comment by mkoeppe created at 2022-03-18 16:34:40

Onward to documenting it, #33426?


---

Comment by mkoeppe created at 2022-03-18 16:39:37

Changing priority from major to critical.


---

Comment by mkoeppe created at 2022-03-18 16:55:17

Replying to [comment:310 gh-tobiasdiez]:
> they probably should have been extracted to their own tickets as they don't have to do anything with the github workflow

Yes, the fix to `src/sage/features/pkg_systems.py` could perhaps have been made a separate ticket and a dependency here. But it would have been difficult to test it separately because the present ticket is its only use case.

Sometimes the scope of a ticket needs to be adjusted during development. You already know that sometimes the scope turns out to be too big and it is necessary break out smaller, more manageable and more clearly defined tickets.

But sometimes the scope of a ticket also turns out to be too small and the ticket is not viable on its own. This is what happened on the present ticket. The workflow documented in the wiki https://wiki.sagemath.org/Conda has never actually worked. Creating a GH Actions workflow based on a semi-quasi-working variant of it, by itself was not convincing as a ticket (comment:121 - "what does it test"). With the broader scope of actually fixing this way of installing Sage and testing something that we can recommend to developers, the ticket has a viable scope: The changes bring a clear improvement to Sage.


---

Comment by mkoeppe created at 2022-03-18 21:29:56

Some of the test suite failures that we saw are from ipython 8.x; #33170 updates the doctests


---

Comment by @tobiasdiez created at 2022-03-18 22:12:16

Replying to [comment:318 mkoeppe]:
> But it's fine for now, let's see that we can get it merged in 9.6.

Thanks for the review!


---

Comment by @tobiasdiez created at 2022-03-18 22:12:34

Replying to [comment:319 mkoeppe]:
> Onward to documenting it, #33426?

Yes!


---

Comment by @tobiasdiez created at 2022-03-18 22:27:45

Replying to [comment:321 mkoeppe]:
> Replying to [comment:310 gh-tobiasdiez]:
> > they probably should have been extracted to their own tickets as they don't have to do anything with the github workflow
> 
> Yes, the fix to `src/sage/features/pkg_systems.py` could perhaps have been made a separate ticket and a dependency here. But it would have been difficult to test it separately because the present ticket is its only use case.
> 
> Sometimes the scope of a ticket needs to be adjusted during development. You already know that sometimes the scope turns out to be too big and it is necessary break out smaller, more manageable and more clearly defined tickets.
> 
> But sometimes the scope of a ticket also turns out to be too small and the ticket is not viable on its own. This is what happened on the present ticket. The workflow documented in the wiki https://wiki.sagemath.org/Conda has never actually worked. Creating a GH Actions workflow based on a semi-quasi-working variant of it, by itself was not convincing as a ticket (comment:121 - "what does it test"). With the broader scope of actually fixing this way of installing Sage and testing something that we can recommend to developers, the ticket has a viable scope: The changes bring a clear improvement to Sage. 

In general I agree that a ticket has to have a clear scope and improvement. For this ticket here, the github workflow essentially didn't change in the past 4 weeks, and at this point it was already clear that the workflow works in principle, with the caveat that a lot of docstests failed. In my opinion, it would have been better to merge the ticket already (with the few additional improvements to the workflow that we have discussed), then follow-up tickets could have easily improved different aspects of the conda environment, while the previous runs of the ci would have served as a baseline. Even thinks like the addition of the tests for macos could have been small follow-up tickets. I really think the tendency of the sage developers to create a lot of parallel, inter-dependent tickets makes reviewing harder and slows down the process. A more linear approach would increase the dev experience and velocity in my opinion.

Anyway, I'm happy that this ticket is finally ready to be merged.


---

Comment by mkoeppe created at 2022-03-18 22:53:14

Replying to [comment:325 gh-tobiasdiez]:
> it was already clear that the workflow works in principle

The project generally uses a standard for tickets higher than that.
Yes, there's a tradeoff between velocity and stability.


---

Comment by isuruf created at 2022-03-21 07:28:40

Is there a ticket for the remaining failures after this ticket?


---

Comment by @tobiasdiez created at 2022-03-21 10:09:50

Yes, they are collected in #33331.


---

Comment by vbraun created at 2022-03-27 15:44:10

Resolution: fixed
