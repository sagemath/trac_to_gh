# Issue 23956: p-adic factoring bug

Issue created by migration from https://trac.sagemath.org/ticket/24193

Original creator: roed

Original creation time: 2017-11-10 17:26:15


```
sage: f=x^22 + 9*x^21 + 16*x^20 - 92*x^19 - 408*x^18 - 144*x^17 + 2080*x^16 + 4096*x^15 + 128*x^14 - 8192*x^13 - 12800*x^12 - 18432*x^11 - 51200*x^10 - 131072*x^9 + 8192*x^8 + 1048576*x^7 + 2129920*x^6 - 589824*
....: x^5 - 6684672*x^4 - 6029312*x^3 + 4194304*x^2 + 9437184*x + 4194304
....:
sage: f.factor()
(x - 2)^6 * (x + 2)^8 * (x^8 + 5*x^7 + 16*x^6 + 40*x^5 + 88*x^4 + 160*x^3 + 256*x^2 + 320*x + 256)
sage: g=f.change_ring(Qp(2,200))
sage: g.roots()

[(1 + 2 + 2^3 + 2^4 + 2^5 + 2^7 + 2^8 + 2^10 + 2^11 + 2^12 + 2^15 + 2^16 + 2^19 + 2^20 + 2^22 + 2^28 + 2^31 + 2^32 + 2^38 + 2^39 + 2^40 + 2^41 + 2^43 + 2^44 + 2^46 + 2^47 + 2^50 + 2^53 + 2^54 + 2^56 + 2^57 + 2^59 + 2^60 + 2^61 + 2^68 + 2^71 + 2^74 + 2^75 + 2^76 + 2^77 + 2^84 + 2^86 + 2^89 + 2^90 + 2^94 + 2^95 + 2^97 + 2^100 + 2^106 + 2^107 + 2^110 + 2^112 + 2^113 + 2^118 + 2^119 + 2^124 + 2^126 + 2^127 + 2^128 + 2^132 + 2^135 + 2^141 + 2^143 + 2^145 + 2^146 + 2^147 + 2^148 + 2^149 + 2^150 + 2^151 + 2^152 + 2^155 + 2^160 + 2^162 + 2^165 + 2^166 + 2^168 + 2^170 + 2^171 + 2^173 + 2^174 + 2^176 + 2^177 + 2^180 + 2^181 + 2^183 + 2^184 + 2^185 + 2^187 + 2^189 + 2^190 + 2^191 + 2^192 + 2^193 + 2^194 + 2^195 + 2^196 + 2^197 + 2^198 + O(2^200),
  1),
 (2^2 + 2^3 + 2^6 + 2^7 + 2^8 + 2^10 + 2^11 + 2^12 + 2^13 + 2^14 + 2^17 + 2^18 + 2^20 + 2^23 + 2^24 + 2^28 + 2^29 + 2^33 + 2^34 + 2^36 + 2^39 + 2^40 + 2^42 + 2^44 + 2^45 + 2^47 + 2^54 + 2^55 + 2^56 + 2^58 + 2^59 + 2^61 + 2^63 + 2^69 + 2^70 + 2^71 + 2^78 + 2^81 + 2^82 + 2^84 + 2^87 + 2^88 + 2^89 + 2^90 + 2^91 + 2^93 + 2^95 + 2^99 + 2^100 + 2^101 + 2^102 + 2^103 + 2^104 + 2^108 + 2^110 + 2^113 + 2^115 + 2^116 + 2^117 + 2^118 + 2^121 + 2^122 + 2^123 + 2^124 + 2^126 + 2^128 + 2^130 + 2^131 + 2^133 + 2^135 + 2^137 + 2^139 + 2^140 + 2^141 + 2^142 + 2^144 + 2^145 + 2^146 + 2^148 + 2^151 + 2^152 + 2^157 + 2^158 + 2^159 + 2^163 + 2^165 + 2^166 + 2^169 + 2^170 + 2^171 + 2^174 + 2^175 + 2^176 + 2^177 + 2^179 + 2^181 + 2^182 + 2^184 + 2^188 + 2^192 + 2^193 + 2^194 + 2^195 + 2^196 + 2^198 + O(2^200),
  1)]
```


Based on initial experiments with gp, this looks like our fault and not pari's.


---

Comment by roed created at 2017-11-11 00:02:58

So, I can replicate this in GP, but I think the problem is that pari doesn't try to handle the precision issues that arise in factoring.  This polynomial is not squarefree, so small perturbations of the coefficients will yield polynomials with different factorization patterns.  Note the following excerpt from the documentation for pari's `factorpadic`:

```
If pol has inexact t_PADIC coefficients, this is not always well-defined;
in this case, the polynomial is first made integral by dividing out the
p-adic content, then lifted to â„¤ using truncate coefficientwise. Hence
we actually factor exactly a polynomial which is only p-adically close
to the input. To avoid pitfalls, we advise to only factor polynomials
with exact rational coefficients.
```

https://pari.math.u-bordeaux.fr/dochtml/html/Polynomials_and_power_series.html

I think the solution is to implement the reduction to squarefree factorization in Sage.


---

Comment by jdemeyer created at 2017-11-11 08:52:24

I think I remember having this discussion before with you, David.

There is no bug. It's an ill-posed question because there is no uniquely defined answer. To give a simpler example:

```
sage: R.<x> = QQ []
sage: ((x+1)^2 - 0*3^12).factor_padic(3)
((1 + O(3^10))*x + (1 + O(3^10)))^2
sage: ((x+1)^2 - 1*3^12).factor_padic(3)
((1 + O(3^10))*x + (1 + 3^6 + O(3^10))) * ((1 + O(3^10))*x + (1 + 2*3^6 + 2*3^7 + 2*3^8 + 2*3^9 + O(3^10)))
sage: ((x+1)^2 - 3*3^12).factor_padic(3)
(1 + O(3^10))*x^2 + (2 + O(3^10))*x + (1 + O(3^10))
```

These are 3 different factorization patterns for polynomials which are all the same up to `O(3^10)`. So if all you have is the 3-adic approximation, there is no way to guess.


---

Comment by roed created at 2017-11-11 15:46:52

Replying to [comment:2 jdemeyer]:
> I think I remember having this discussion before with you, David.

Yeah, we've talked about it before though I don't remember the ticket/thread.  I agree that this is not a bug in Pari.  But I think we should adopt a principle in Sage along the lines of "assume you are in the smallest dimensional subvariety that is consistent with the given information."  Otherwise asking for the kernel of a p-adic matrix never makes sense.  Though I guess this is inconsistent with the valuation of `O(p^n)` being `n` and not `infinity`.

Anyway, I'm probably not going to work on this ticket immediately.  When I'm ready to propose concrete changes like this, I'll raise it on the sage-padics list (and try to track down the discussions that we've had previously).


---

Comment by jdemeyer created at 2017-11-13 09:41:37

Reduced the bug somewhat.


---

Comment by jdemeyer created at 2017-11-13 09:56:30

Replying to [comment:3 roed]:
> I think we should adopt a principle in Sage along the lines of "assume you are in the smallest dimensional subvariety that is consistent with the given information."  Otherwise asking for the kernel of a p-adic matrix never makes sense.

Right. Knowing a p-adic matrix up to any finite absolute precision is never sufficient to know that it has a kernel.

Similarly, knowing any non-squrefree p-adic polynomial to any finite absolute precision is never sufficient to know that it is non-squarefree.

That is mathematics, which is easy :-) The hard question is how to deal with this. Personally, I would argue that it's simply an error to ask something if the answer is not well-defined. That is what I tried in #15422 for factoring, but apparently it didn't quite work.

That being said, I'm not against "fixing" this "bug". It would make sense to do that as part of #12561 (but that seems to be stalled).
