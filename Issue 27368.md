# Issue 27368: Backport Python trashcan patch

Issue created by migration from https://trac.sagemath.org/ticket/27605

Original creator: jdemeyer

Original creation time: 2019-04-05 13:47:35

CC:  dunfield

It turns out that there is a crazy corner case left due to #27267: if a big nested deallocation occurs which was triggered by the deallocation of an instance of a Python class, the trashcan is not cleaned up: the deallocation ends but not every object is actually deallocated. Allocating a cypari2 `Gen` right after this causes cypari2 to be in an inconsistent state, since it assumes that all `Gen`s on the PARI stack have actually been deleted.

This is fixed by my upstream trashcan patch https://github.com/python/cpython/pull/11841 and its 2.7 backport https://github.com/python/cpython/pull/12699 (the latter is what's in this branch).


---

Comment by jdemeyer created at 2019-04-08 14:27:37

New commits:


---

Comment by git created at 2019-04-08 14:56:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-04-08 14:57:28

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2019-04-19 08:05:31

Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.


---

Comment by jdemeyer created at 2019-04-19 08:42:12

Replying to [comment:7 vdelecroix]:
> Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.

We might as well wait for Godot...


---

Comment by vdelecroix created at 2019-04-19 08:51:01

Replying to [comment:8 jdemeyer]:
> Replying to [comment:7 vdelecroix]:
> > Applied, compiled and tested. Though I believe we should wait for Cpython to merge [pull/11841](https://github.com/python/cpython/pull/11841) first.
> 
> We might as well wait for Godot...

Don't be so pessimistic. The crash with cypari2 used to be really bad. It seems that they at least acknowledge the bug. Patching python2 with a non-accepted upstream patch is a very delicate situation...


---

Comment by dunfield created at 2019-04-19 15:51:15

I tested this patch with Python 3 rather than Python 2.  When I do `sage -python -m snappy.test`, I no longer get the `cypari2` crashes that were observed before, but I do still see a couple messages:

```
RuntimeWarning: cypari2 leaked 384 bytes on the PARI stack
RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
```

Are these harmless?  I had assumed they were connected with the underlying issue here, but perhaps not.  I will also do this test with Python 2 and report back.


---

Comment by jdemeyer created at 2019-04-19 16:14:50

Those warnings are worrying but maybe they are unrelated to the trashcan.


---

Comment by dunfield created at 2019-04-19 18:44:36

Replying to [comment:11 jdemeyer]:
> Those warnings are worrying but maybe they are unrelated to the trashcan.

The warnings also manifest under Python 2.  I checked to see which doctests trigger them, and found that the problem can easily be reproduced by:

```
sage: import snappy
sage: M = snappy.Manifold('m004')
sage: M.high_precision()
/sage/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878: RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
  exec(code_obj, self.user_global_ns, self.user_ns)
```

Turning warnings into exceptions to try to identify the source, I get the following message followed by a hard SIGSEGV crash:

```
sage: import snappy, warnings
sage: warnings.simplefilter('error')
sage: snappy.Manifold('m004').high_precision()
---------------------------------------------------------------------------
RuntimeWarning                            Traceback (most recent call last)
RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
Exception RuntimeWarning: RuntimeWarning(u'cypari2 leaked 192 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored
ERROR: removing wrong instance of Gen
---------------------------------------------------------------------------
RuntimeWarning                            Traceback (most recent call last)
RuntimeWarning: cypari2 leaked 192 bytes on the PARI stack
Exception RuntimeWarning: RuntimeWarning(u'cypari2 leaked 192 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored
Expected: 0.499999999999999 + 0.866025403784439*I
Actual:   0.499999999999999 + 0.866025403784439*I
---------------------------------------------------------------------------
RuntimeWarning                            Traceback (most recent call last)
RuntimeWarning: cypari2 leaked 264 bytes on the PARI stack
Exception RuntimeWarning: RuntimeWarning(u'cypari2 leaked 264 bytes on the PARI stack',) in 'cypari2.stack.remove_from_pari_stack' ignored
ERROR: removing wrong instance of Gen
------------------------------------------------------------------------
[...log clipped...]
```



---

Comment by jdemeyer created at 2019-04-19 20:19:46

Replying to [comment:12 dunfield]:
> Turning warnings into exceptions to try to identify the source

Unfortunately, these warnings happen during deallocation (think of `__del__` in Python), so exceptions are not supported there. That's also the reason why `ERROR: removing wrong instance of Gen` is printed rather than raising an exception.


---

Comment by jdemeyer created at 2019-04-20 07:30:25

Replying to [comment:9 vdelecroix]:
> Patching python2 with a non-accepted upstream patch is a very delicate situation...

This is a pure bug-fix. Adding this patch doesn't make it any harder to support Sage without this patch, so I don't think that it's delicate.


---

Comment by jdemeyer created at 2019-04-20 07:32:32

Replying to [comment:9 vdelecroix]:
> It seems that they at least acknowledge the bug.

Indeed. And in fact four(!) Python core developers approve the patch. Still, because of one guy's bikeshedding, it's not getting merged.


---

Comment by jdemeyer created at 2019-05-15 14:45:00

Patch has been accepted in CPython master, but unlikely to be backported to earlier versions.


---

Comment by vdelecroix created at 2019-05-19 13:40:27

All right then... It is a pity that this will be not backported though! What should be done for cypari2? Mention the bug explicitely in the README?


---

Comment by vdelecroix created at 2019-05-19 13:40:27

Changing status from needs_review to positive_review.


---

Comment by dunfield created at 2019-05-19 14:39:32

Replying to [comment:17 vdelecroix]:
> All right then... It is a pity that this will be not backported though! What should be done for cypari2? Mention the bug explicitely in the README?

Will merging ticket this cause problems for the folks who package Sage for the various Linux distros?  Presumably Debian et al are not going to be willing to apply these patches to their master versions of Python 2.7 and 3.7.  I guess if all of Sage's doctests pass without the patches then it's OK.  (It still surprises me that snappy's doctests, which number only a few 1000 and doesn't use cypari2 that heavily trigger this problem but Sage's massive test suite does not.)


---

Comment by jdemeyer created at 2019-05-19 16:40:57

Replying to [comment:18 dunfield]:
> Will merging ticket this cause problems for the folks who package Sage for the various Linux distros?

No, they will likely just package Python without these patches. This means that the snappy+cypari2 bug will still occur.

> I guess if all of Sage's doctests pass without the patches then it's OK.

It indeed seems not to affect Sage doctests.

> It still surprises me that snappy's doctests, which number only a few 1000 and doesn't use cypari2 that heavily

I have no explanation for that. Maybe it's just coincidence.


---

Comment by vbraun created at 2019-05-24 18:29:56

Resolution: fixed


---

Comment by culler created at 2019-07-28 14:09:21

Sadly, some parts of this issue have not been completely dealt with.  Here is a simple example
(with Sage 8.8 on Ubuntu 18.04):


```
sage: z = complex(pari('1+1*I'))
/XXX/sage-8.8/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2878:
RuntimeWarning: cypari2 leaked 48 bytes on the PARI stack
  exec(code_obj, self.user_global_ns, self.user_ns)
```


I think the core issue here is that the stack management code in cypari2/stack.pyx is
fundamentally unsafe.

Here is the situation, as I understand it.

* Cypari2 allows a PARI GEN which is wrapped by a Gen object to reside either on the PARI stack
  or on the heap, but the stack is preferred.

* The PARI stack is also used by PARI, for example to store intermediate values produced when
  evaluating PARI expressions.  This means that there will be non-wrapped GENS on the PARI stack.  
  Typically one should expect a block of non-wrapped GENS between each pair of adjacent wrapped
  GENS as well as some non-wrapped GENS that were pushed after the last wrapped GEN.

* When a Gen object is deallocated, and if it was the last Gen to have had its GEN X pushed onto
  the PARI stack, then reset_avma is called to set PARI's avma stack pointer to the address of
  the penultimate wrapped GEN Y.  Any non-wrapped GEN pushed after Y will be lost.  This is
  dangerous, because those lost GENS could be clobbered the next time that PARI pushes a GEN.
  That, of course, is the reason for the warning.  Note, though, that the warning is only
  triggered if there are non-wrapped GENS which were pushed after X.  Losing the GENs between
  X and Y is just as dangerous but does not trigger a warning.

I don't see any way to make this scheme safe.  I don't see any reliable way to control when PARI
will push GENS on its stack since, for example, Sage allows execution of arbitrary GP code.
And I don't see any reliable way to control when Sage Gens will be deallocated.  Presumably the
idea of storing wrapped GENS on the PARI stack was intended to be an optimization.  I think
it would be better to forego this optimization in favor of safety.  However, if the optimization
does provide significant performance increases then I would suggest that it be made optional.
A Gen object could store its GEN on the heap by default, but allow as an option that the GEN be
stored on the PARI stack.  That way people who were willing to risk crashes in order to increase
speed would be able to do so while the rest of us could safely store our GENs on the heap.


---

Comment by vdelecroix created at 2019-07-28 18:39:58

Replying to [comment:21 culler]:
> Sadly, some parts of this issue have not been completely dealt with.  Here is a simple example
> (with Sage 8.8 on Ubuntu 18.04):
>
> [...]

Thanks Marc for the report. I opened an [issue on github](https://github.com/sagemath/cypari2/issues/81) where cypari2 is developed.
