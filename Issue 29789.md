# Issue 29789: Expose face iterator algorithm to other parts of sage

Issue created by migration from https://trac.sagemath.org/ticket/30026

Original creator: @kliem

Original creation time: 2020-06-30 09:09:35

CC:  mkoeppe dimpase

The face iterator for polyhedra does not assume a polyhedron. All it requires is a lattice that is locally branched, i.e. every interval of length 2 contains at least 4 elements.

This is not true in general for simplicial complexes. However, almost the same techniques can be used to iterate over all faces of a simplicial complex from the bottom up.


---

Comment by @kliem created at 2020-06-30 09:37:55

Some motivating examples with the test branch:


```
sage: S = simplicial_complexes.PseudoQuaternionicProjectivePlane()
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 458 ms, sys: 12 ms, total: 470 ms
Wall time: 469 ms
[1, 15, 105, 455, 1365, 3003, 4515, 4230, 2205, 490]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 4.57 ms, sys: 5 µs, total: 4.58 ms
Wall time: 4.52 ms
(1, 15, 105, 455, 1365, 3003, 4515, 4230, 2205, 490, 1)

sage: S = simplicial_complexes.ChessboardComplex(7,5)
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 169 ms, sys: 3 µs, total: 169 ms
Wall time: 168 ms
[1, 35, 420, 2100, 4200, 2520]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 37.2 ms, sys: 12 µs, total: 37.2 ms
Wall time: 36.1 ms
(1, 35, 420, 2100, 4200, 2520, 1)
```


However, it does not always work currently. Here is an example where the simplicial complex is not pure and more importantly not all faces are meets of maximal faces:

```
sage: set_random_seed(0)
sage: S = simplicial_complexes.RandomComplex(15,10)
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 1.24 s, sys: 11.6 ms, total: 1.25 s
Wall time: 1.25 s
[1, 15, 105, 455, 1365, 3003, 5005, 6435, 6435, 5005, 3003, 682]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 21.5 ms, sys: 0 ns, total: 21.5 ms
Wall time: 21 ms
(1, 15, 105, 455, 1365, 3003, 5005, 6435, 6435, 5005, 2522, 584, 1)
```

As you can see, it is still much faster, but does not quite hit all faces.

The problem is simply, that we are trying represent the faces as indices of maximal faces, which does not work in our case.

But after all, we are in a simplicial complex which is comfortable to work with:
- We can use the maximal-face-indices (even if not unique) to quickly check if a face is contained in the simplicial complex.
- The join of faces can of course be computed using the vertex-representation.

The main advantage of the dual approach is basically the following: To check whether we have seen a face already, we check if it contains a completely visited face. There are up to `n_vertices` faces to check.

In the non-dual approach there are up to `n_maximal_faces` faces to check.

Overall the implementation should be much faster than the current algorithm for `CombinatorialPolyhedron` and could even be used to improve the face iterator for simplicial/simple polytopes (I never used that for simplicial polytopes the join is given by the union of vertices, if the join is a proper face).


---

Comment by @kliem created at 2020-06-30 09:51:28

A different example of an application might be the regions of an hyperplane arrangement.

That is all applications I can think of at the moment.

If not all faces are meets of maximal faces, I additionally need a list of "ridges" (that are not meets of maximal faces). I think this is a challenging task.
It could be useful for wild polyhedral complexes, but other than hyperplane arrangements, I don't know if we have such a thing in sage.

For simplicial complexes I can work nicely around that property, because the join of faces is trivial to compute.

For cubical complexes it will definitely be more involved. I don't know, if it's worth it.

For delta complexes I don't think it is even possible, as there is no unique vertex-representation of a face.


---

Comment by git created at 2020-07-01 15:14:30

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @kliem created at 2020-07-01 15:27:25

It appears to work now. Here are some tests

```
sage: set_random_seed(0)
sage: S = simplicial_complexes.RandomComplex(15,10)
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 1.28 s, sys: 28.1 ms, total: 1.31 s
Wall time: 1.31 s
[1, 15, 105, 455, 1365, 3003, 5005, 6435, 6435, 5005, 3003, 682]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 132 ms, sys: 7.84 ms, total: 140 ms
Wall time: 139 ms
(1, 15, 105, 455, 1365, 3003, 5005, 6435, 6435, 5005, 3003, 682, 1)
sage: S = simplicial_complexes.RandomComplex(15,10)
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 1.15 s, sys: 139 µs, total: 1.15 s
Wall time: 1.15 s
[1, 15, 105, 455, 1365, 3003, 5005, 6435, 6435, 5005, 3003, 689]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 6.63 ms, sys: 0 ns, total: 6.63 ms
Wall time: 6.59 ms
(1, 15, 105, 455, 1365, 3003, 5005, 6435, 6435, 5005, 3003, 689, 1)
sage: S = simplicial_complexes.RandomComplex(17,12)
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 5.62 s, sys: 60 ms, total: 5.68 s
Wall time: 5.67 s
[1,
 17,
 136,
 680,
 2380,
 6188,
 12376,
 19448,
 24310,
 24310,
 19448,
 12376,
 6188,
 1172]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 24.4 ms, sys: 9 µs, total: 24.5 ms
Wall time: 24.3 ms
(1, 17, 136, 680, 2380, 6188, 12376, 19448, 24310, 24310, 19448, 12376, 6188, 1172, 1)
sage: S = simplicial_complexes.RandomComplex(19,14)
sage: S1 = SimplicialComplex(S.facets())
sage: %time S1.f_vector()
CPU times: user 25.9 s, sys: 248 ms, total: 26.2 s
Wall time: 26.2 s
[1,
 19,
 171,
 969,
 3876,
 11628,
 27132,
 50388,
 75582,
 92378,
 92378,
 75582,
 50388,
 27132,
 11628,
 1941]
sage: %time CombinatorialPolyhedron(S.facets(), simplicial_complex_dimension=S.dimension()).f_vector()
CPU times: user 73 ms, sys: 4.01 ms, total: 77 ms
Wall time: 76.6 ms
(1, 19, 171, 969, 3876, 11628, 27132, 50388, 75582, 92378, 92378, 75582, 50388, 27132, 11628, 1941, 1)
```


Things to do:
- Find a reasonable new place for `FaceIterator`.
- Maybe have some subclasses that mainly differ in the output of `next`.
- Alter `FaceIterator` so that it becomes more useful for simplicial complexes (e.g. generate all faces not in a subcomplex).
- Replace my private implementation of bitsets.
- And of course further improvements (parallelization, intrinsics).


---

Comment by @kliem created at 2020-07-02 05:55:55

Changing keywords from "" to "sd109".


---

Comment by @kliem created at 2020-07-03 19:44:56

Do you happen to know other applications to benchmark against for enumerating faces of simplicial complexes (other than polymake)? Sorry to be off topic.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
