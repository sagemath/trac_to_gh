# Issue 25536: 1 internet doctest failing in databases/findstat.py

Issue created by migration from https://trac.sagemath.org/ticket/25773

Original creator: slabbe

Original creation time: 2018-07-04 19:13:34

In 8.3.beta8, 


```
sage -t --optional=sage,external src/sage/databases/findstat.py 
```


gives


```
Using --optional=external,sage
External software to be detected: cplex,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,scilab
Doctesting 1 file.
sage -t src/sage/databases/findstat.py
**********************************************************************
File "src/sage/databases/findstat.py", line 2211, in sage.databases.findstat.FindStatCollection.to_string
Failed example:
    c.to_string()(p)                                              # optional -- internet
Expected:
    '([(0, 2), (2, 1)], 3)'
Got:
    '([(1, 2), (2, 0)], 3)'
**********************************************************************
1 item had failures:
   1 of   5 in sage.databases.findstat.FindStatCollection.to_string
    [247 tests, 1 failure, 60.84 s]
----------------------------------------------------------------------
sage -t src/sage/databases/findstat.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 61.0 seconds
    cpu time: 8.7 seconds
    cumulative wall time: 60.8 seconds
External software detected for doctesting: internet
```



---

Comment by mantepse created at 2018-08-22 13:11:39

I cannot reproduce this :-( In fact, the function to produce a string from a poset is currently (!) specified in `findstat.py` itself, around line 2425:

```
        14: [None, None, None, FinitePoset,           posets,                  None,
             lambda x: x.cardinality(),
             lambda x, l: x.cardinality() in l,
             lambda X: str((sorted(X._hasse_diagram.canonical_label().cover_relations()), len(X._hasse_diagram.vertices()))),
             lambda x: (lambda R, E: Poset((list(range(E)), R)))(*literal_eval(x))],
```


What does

```
sage: X = Poset((range(3), [[0, 1], [1, 2]]))
sage: str((sorted(X._hasse_diagram.canonical_label().cover_relations()), len(X._hasse_diagram.vertices()))) 
```

produce on your system?

Note that, to findstat it doesn't actually matter.


---

Comment by mantepse created at 2018-08-22 13:14:43

I take the opportunity to fix the doctest failure reported in https://groups.google.com/forum/#!topic/sage-release/XUYlh2DHP9E


---

Comment by mantepse created at 2018-08-22 13:14:43

Changing keywords from "" to "findstat".


---

Comment by mantepse created at 2018-08-22 13:14:43

Changing status from new to needs_info.


---

Comment by tscrim created at 2018-08-22 22:45:22

I am also unable to reproduce the failure in the description, but I do obtain the one noted in comment:2.
----
New commits:


---

Comment by git created at 2018-08-23 03:28:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-08-23 03:28:52

Changing status from needs_info to needs_review.


---

Comment by tscrim created at 2018-08-23 07:32:05

`@`slabbe, do you always get this failure when running the tests on this file?


---

Comment by slabbe created at 2018-08-25 12:17:57

Yes, I still obtain it :


```
$ ./sage --version
SageMath version 8.4.beta1, Release Date: 2018-08-14
$ ./sage -t --optional=sage,external src/sage/databases/findstat.py 
too many failed tests, not using stored timings
Running doctests with ID 2018-08-25-14-13-55-8d9139c5.
Git branch: 25378
Using --optional=external,sage
External software to be detected: cplex,ffmpeg,graphviz,gurobi,imagemagick,internet,latex,macaulay2,magma,maple,mathematica,matlab,octave,pandoc,scilab
Doctesting 1 file.
sage -t src/sage/databases/findstat.py
**********************************************************************
File "src/sage/databases/findstat.py", line 1016, in sage.databases.findstat.FindStatStatistic._find_by_values
Failed example:
    FindStatStatistic(id=0,data=data, first_terms = first_terms, collection = collection, depth=0)._find_by_values() # optional -- internet
Expected:
    0: (St000012: The area of a Dyck path., [], 14)
Got:
    0: (St000012: The area of a Dyck path., [], 14)
    1: (St001228: The vector space dimension of the space of module homomorphisms between J and itself when J denotes the Jacobson radical of the corresponding Nakayama algebra., [], 14)
**********************************************************************
File "src/sage/databases/findstat.py", line 2211, in sage.databases.findstat.FindStatCollection.to_string
Failed example:
    c.to_string()(p)                                              # optional -- internet
Expected:
    '([(0, 2), (2, 1)], 3)'
Got:
    '([(1, 2), (2, 0)], 3)'
**********************************************************************
2 items had failures:
   1 of   5 in sage.databases.findstat.FindStatCollection.to_string
   1 of   9 in sage.databases.findstat.FindStatStatistic._find_by_values
    [247 tests, 2 failures, 58.74 s]
----------------------------------------------------------------------
sage -t src/sage/databases/findstat.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 59.5 seconds
    cpu time: 8.7 seconds
    cumulative wall time: 58.7 seconds
External software detected for doctesting: internet
```



---

Comment by slabbe created at 2018-08-25 12:20:03

And I get this:


```
$ sage
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 8.4.beta1, Release Date: 2018-08-14               │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: sage: X = Poset((range(3), [[0, 1], [1, 2]]))
....: sage: str((sorted(X._hasse_diagram.canonical_label().cover_relations()), len(X._hasse_
....: diagram.vertices())))
....: 
'([(1, 2), (2, 0)], 3)'
```



---

Comment by tscrim created at 2018-08-25 12:42:01

I think I know what the problem is. Do you have bliss installed? Try the same test with

```
sage: str((sorted(X._hasse_diagram.canonical_label(algorithm='sage').cover_relations()),
....:      len(X._hasse_diagram.vertices())))
```

This can result in different canonical labelings (as noted in the doc of `canonical_label`).


---

Comment by slabbe created at 2018-08-26 07:18:52

Yes I do have bliss installed! Other such doctests were fixed in #25399


---

Comment by slabbe created at 2018-08-26 07:20:43

I get:

```
sage: sage: X = Poset((range(3), [[0, 1], [1, 2]]))
sage: sage: str((sorted(X._hasse_diagram.canonical_label(algorithm='sage').cover
....: _relations()),
....: ....:      len(X._hasse_diagram.vertices())))
'([(0, 2), (2, 1)], 3)'
```



---

Comment by tscrim created at 2018-08-27 01:53:59

Yep, it is definitely due to bliss being installed. So we just need to do this change to fix it:

```diff
-             lambda X: str((sorted(X._hasse_diagram.canonical_label().cover_relations()), len(X._hasse_diagram.vertices()))),
+             lambda X: str((sorted(X._hasse_diagram.canonical_label(algorithm='sage').cover_relations()), len(X._hasse_diagram.vertices()))),
```



---

Comment by mantepse created at 2018-08-27 15:25:37

I think the correct fix is to remove `canonical_label` completely.  Currently testing...


---

Comment by git created at 2018-08-27 18:48:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mantepse created at 2018-08-27 18:52:12

Should be OK now, please review!


---

Comment by tscrim created at 2018-08-28 23:44:28

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-08-28 23:44:28

Works for me on an install both with and without bliss.


---

Comment by vbraun created at 2018-08-30 22:24:48

Resolution: fixed
