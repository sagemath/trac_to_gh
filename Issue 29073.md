# Issue 29073: "make distclean" should not run "./configure"

Issue created by migration from https://trac.sagemath.org/ticket/29310

Original creator: jhpalmieri

Original creation time: 2020-03-10 22:30:11

CC:  jhpalmieri mkoeppe slelievre

As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.


---

Comment by mkoeppe created at 2020-03-29 02:19:42

See also: 
- #29098 - Merge build/make/deps into build/make/Makefile.in
- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall
which could be done at the same time.


---

Comment by jhpalmieri created at 2020-04-18 20:32:33

This could presumably be fixed by #29316.


---

Comment by slelievre created at 2020-09-07 20:39:13

Replying to [comment:3 jhpalmieri]:
> This could presumably be fixed by #29316.

Apparently not.


---

Comment by slelievre created at 2020-09-07 20:45:12

Changing keywords from "" to "quiet, speed".


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-10-24 17:56:04

Also, in 9.4.beta5 I am getting with `make distclean`:

```
/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory
```



---

Comment by jhpalmieri created at 2021-10-27 20:27:34

Can we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.


---

Comment by jhpalmieri created at 2021-10-27 22:00:24

I'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:

```
# Defer unknown targets to build/make/Makefile
%::
	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
	$(MAKE) build/make/Makefile --stop
	+build/bin/sage-logger \
		"cd build/make && ./install '$@'" logs/install.log
```

So that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:
- `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`
- `cd "$(SAGE_SRC)" && (do some stuff)`
- `cd "$(SAGE_ROOT)/build/pkgs/sagelib/src/" && rm -rf build`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_docbuild/src" && rm -rf build)`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_setup/src" && rm -rf build)`
- `cd "$(SAGE_SRC)/doc" && $(MAKE) clean`
- `rm -rf "$(SAGE_SHARE)/doc/sage"`


---

Comment by mkoeppe created at 2021-10-29 02:32:21

Moving the cleaning targets to the top-level Makefile could make sense.

Most of the above lines really don't need configured variables.

For cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):

As you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).

So it only matters what is to be done when `SAGE_LOCAL` has been set to something else.

To run a line such as `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.

I'm not sure about `rm -rf "$(SAGE_SHARE)/doc/sage"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.
(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)


---

Comment by jhpalmieri created at 2021-10-29 05:20:35

Here is an attempt. A few comments:
- I added the line `if [ -d "$(SAGE_SRC)" ]; then \` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.
- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.
----
New commits:


---

Comment by jhpalmieri created at 2021-10-29 05:26:45

Oh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like

```
SAGE_ROOT = $$(pwd)

clean-test:
    echo $(SAGE_ROOT)
```

then `make clean-test` would print

```
echo $(pwd)
/Users/palmieri/....
```

With the current version, if I add the same target `clean-test`, then `make clean-test` prints

```
echo /Users/...
/Users/...
```

It seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.


---

Comment by mkoeppe created at 2021-10-29 05:32:20

Try `$(CURDIR)`


---

Comment by git created at 2021-10-29 16:03:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-10-29 16:04:54

Replying to [comment:16 mkoeppe]:
> Try `$(CURDIR)`

Thanks, done.


---

Comment by jhpalmieri created at 2021-12-16 00:05:47

I think this is ready for review.


---

Comment by jhpalmieri created at 2021-12-16 00:05:47

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-12-17 06:33:11


```
+SAGE_ROOT ?= $(CURDIR)
+SAGE_SRC ?= $(SAGE_ROOT)/src
```

I think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here


---

Comment by git created at 2021-12-17 19:44:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2021-12-17 19:45:19

Fixed, thanks.


---

Comment by mkoeppe created at 2021-12-20 23:47:52


```
+clean:
+	@echo "Deleting package build directories..."
+	if [ -x "$(SAGE_SRC)"/bin/sage-env-config ]; then \
+	    . "$(SAGE_SRC)"/bin/sage-env-config; \
+            rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
+	fi
```

The reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.

Also, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...


---

Comment by git created at 2021-12-21 03:22:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-12-21 03:22:54

It was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.


---

Comment by mkoeppe created at 2021-12-23 05:14:28

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-23 05:14:28

LGTM and seems to work well.


---

Comment by jhpalmieri created at 2021-12-23 19:06:05

Thank you!


---

Comment by vbraun created at 2021-12-28 21:15:33

Resolution: fixed
