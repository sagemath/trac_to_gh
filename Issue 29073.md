# Issue 29073: "make distclean" should not run "./configure"

archive/issues_029073.json:
```json
{
    "body": "CC:  @jhpalmieri @mkoeppe @slel\n\nAs the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/29310\n\n",
    "created_at": "2020-03-10T22:30:11Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "\"make distclean\" should not run \"./configure\"",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29073",
    "user": "@jhpalmieri"
}
```
CC:  @jhpalmieri @mkoeppe @slel

As the summary says. It may be good enough to move the targets `clean`, `sagelib-clean`, `build-clean`, `doc-clean`, `doc-src-clean`, and `doc-output-clean` from `build/make/deps` to the top-level `Makefile`.

Issue created by migration from https://trac.sagemath.org/ticket/29310





---

archive/issue_comments_411421.json:
```json
{
    "body": "See also: \n- #29098 - Merge build/make/deps into build/make/Makefile.in\n- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall\nwhich could be done at the same time.",
    "created_at": "2020-03-29T02:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411421",
    "user": "@mkoeppe"
}
```

See also: 
- #29098 - Merge build/make/deps into build/make/Makefile.in
- #29097 - build/make/Makefile.in: Rename make targets SPKG-clean to SPKG-uninstall
which could be done at the same time.



---

archive/issue_comments_411422.json:
```json
{
    "body": "This could presumably be fixed by #29316.",
    "created_at": "2020-04-18T20:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411422",
    "user": "@jhpalmieri"
}
```

This could presumably be fixed by #29316.



---

archive/issue_comments_411423.json:
```json
{
    "body": "Replying to [comment:3 jhpalmieri]:\n> This could presumably be fixed by #29316.\n\nApparently not.",
    "created_at": "2020-09-07T20:39:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411423",
    "user": "@slel"
}
```

Replying to [comment:3 jhpalmieri]:
> This could presumably be fixed by #29316.

Apparently not.



---

archive/issue_comments_411424.json:
```json
{
    "body": "Changing keywords from \"\" to \"quiet, speed\".",
    "created_at": "2020-09-07T20:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411424",
    "user": "@slel"
}
```

Changing keywords from "" to "quiet, speed".



---

archive/issue_comments_411425.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411425",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_411426.json:
```json
{
    "body": "Also, in 9.4.beta5 I am getting with `make distclean`:\n\n```\n/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory\n```\n",
    "created_at": "2021-10-24T17:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411426",
    "user": "@mkoeppe"
}
```

Also, in 9.4.beta5 I am getting with `make distclean`:

```
/bin/sh: /Users/mkoeppe/s/sage/sage-rebasing/worktree-rebase/build/pkgs/sagelib/spkg-uninstall: No such file or directory
```




---

archive/issue_comments_411427.json:
```json
{
    "body": "Can we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.",
    "created_at": "2021-10-27T20:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411427",
    "user": "@jhpalmieri"
}
```

Can we naively define `SAGE_ROOT`, `SAGE_SHARE`, `SAGE_LOCAL`, and `SAGE_SRC` in the top-level Makefile, and then move the various `clean` targets to that file? I think that will solve the problem mentioned in this ticket, but I don't know how careful we need to be about setting those variables.



---

archive/issue_comments_411428.json:
```json
{
    "body": "I'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:\n\n```\n# Defer unknown targets to build/make/Makefile\n%::\n\t@if [ -x relocate-once.py ]; then ./relocate-once.py; fi\n\t$(MAKE) build/make/Makefile --stop\n\t+build/bin/sage-logger \\\n\t\t\"cd build/make && ./install '$@'\" logs/install.log\n```\n\nSo that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:\n- `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`\n- `cd \"$(SAGE_SRC)\" && (do some stuff)`\n- `cd \"$(SAGE_ROOT)/build/pkgs/sagelib/src/\" && rm -rf build`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_docbuild/src\" && rm -rf build)`\n- `(cd \"$(SAGE_ROOT)/build/pkgs/sage_setup/src\" && rm -rf build)`\n- `cd \"$(SAGE_SRC)/doc\" && $(MAKE) clean`\n- `rm -rf \"$(SAGE_SHARE)/doc/sage\"`",
    "created_at": "2021-10-27T22:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411428",
    "user": "@jhpalmieri"
}
```

I'm confused by the logic here. I think that the issues arise from these lines in `Makefile`:

```
# Defer unknown targets to build/make/Makefile
%::
	@if [ -x relocate-once.py ]; then ./relocate-once.py; fi
	$(MAKE) build/make/Makefile --stop
	+build/bin/sage-logger \
		"cd build/make && ./install '$@'" logs/install.log
```

So that's why I want to move the cleaning targets to the top-level `Makefile`. SAGE_LOCAL should be set by the `./configure` script, depending on the `--prefix` argument (for example), but we want `make distclean` to work regardless of whether `./configure` has been run. Part of `make distclean` already does `rm -rf local`. We have the following uses of `SAGE_` variables in the cleaning targets:
- `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`
- `cd "$(SAGE_SRC)" && (do some stuff)`
- `cd "$(SAGE_ROOT)/build/pkgs/sagelib/src/" && rm -rf build`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_docbuild/src" && rm -rf build)`
- `(cd "$(SAGE_ROOT)/build/pkgs/sage_setup/src" && rm -rf build)`
- `cd "$(SAGE_SRC)/doc" && $(MAKE) clean`
- `rm -rf "$(SAGE_SHARE)/doc/sage"`



---

archive/issue_comments_411429.json:
```json
{
    "body": "Moving the cleaning targets to the top-level Makefile could make sense.\n\nMost of the above lines really don't need configured variables.\n\nFor cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):\n\nAs you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).\n\nSo it only matters what is to be done when `SAGE_LOCAL` has been set to something else.\n\nTo run a line such as `rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.\n\nI'm not sure about `rm -rf \"$(SAGE_SHARE)/doc/sage\"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.\n(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)",
    "created_at": "2021-10-29T02:32:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411429",
    "user": "@mkoeppe"
}
```

Moving the cleaning targets to the top-level Makefile could make sense.

Most of the above lines really don't need configured variables.

For cleaning within `SAGE_LOCAL` (and `SAGE_VENV`):

As you say, `make distclean` unconditionally removes all of `SAGE_ROOT/local`.  But if `--prefix` has been used to set `SAGE_LOCAL` to something else, that tree is not removed (and it should not; see discussion in #21775).

So it only matters what is to be done when `SAGE_LOCAL` has been set to something else.

To run a line such as `rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"`, we could try to source `SAGE_ROOT/src/bin/sage-src-env-config`, which defines the configured `SAGE_LOCAL` and `SAGE_VENV`. If that fails (because `configure` has not run), do nothing.

I'm not sure about `rm -rf "$(SAGE_SHARE)/doc/sage"`. This not only removes build artifacts such as the inventory files, but it also uninstalls the built HTML documentation. I don't think this should be done by any target called `...-clean`.
(see #29097 - `build/make/Makefile.in`: Rename make targets `SPKG-clean` to `SPKG-uninstall`)



---

archive/issue_comments_411430.json:
```json
{
    "body": "Here is an attempt. A few comments:\n- I added the line `if [ -d \"$(SAGE_SRC)\" ]; then \\` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.\n- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.\n----\nNew commits:",
    "created_at": "2021-10-29T05:20:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411430",
    "user": "@jhpalmieri"
}
```

Here is an attempt. A few comments:
- I added the line `if [ -d "$(SAGE_SRC)" ]; then \` because I kept making mistakes which resulted in `SAGE_SRC` not being set, and then the ensuing lines did things like `cd $(SAGE_SRC) && rm -rf build` which ended up being bad. So this is a safety net.
- The new target `doc-uninstall` is not currently used anywhere. Maybe it should be.
----
New commits:



---

archive/issue_comments_411431.json:
```json
{
    "body": "Oh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like\n\n```\nSAGE_ROOT = $$(pwd)\n\nclean-test:\n    echo $(SAGE_ROOT)\n```\n\nthen `make clean-test` would print\n\n```\necho $(pwd)\n/Users/palmieri/....\n```\n\nWith the current version, if I add the same target `clean-test`, then `make clean-test` prints\n\n```\necho /Users/...\n/Users/...\n```\n\nIt seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.",
    "created_at": "2021-10-29T05:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411431",
    "user": "@jhpalmieri"
}
```

Oh, and I used `$(shell pwd)` when setting `SAGE_ROOT` because (with what I think is a non-GNU make on OS X) it was the only way I found to set `SAGE_ROOT` and have it expand immediately when being set. When I tried something like

```
SAGE_ROOT = $$(pwd)

clean-test:
    echo $(SAGE_ROOT)
```

then `make clean-test` would print

```
echo $(pwd)
/Users/palmieri/....
```

With the current version, if I add the same target `clean-test`, then `make clean-test` prints

```
echo /Users/...
/Users/...
```

It seems safest to have `SAGE_ROOT` defined once, not defined in terms of `pwd` which could change in the middle of a recipe.



---

archive/issue_comments_411432.json:
```json
{
    "body": "Try `$(CURDIR)`",
    "created_at": "2021-10-29T05:32:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411432",
    "user": "@mkoeppe"
}
```

Try `$(CURDIR)`



---

archive/issue_comments_411433.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-10-29T16:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411433",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_411434.json:
```json
{
    "body": "Replying to [comment:16 mkoeppe]:\n> Try `$(CURDIR)`\n\nThanks, done.",
    "created_at": "2021-10-29T16:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411434",
    "user": "@jhpalmieri"
}
```

Replying to [comment:16 mkoeppe]:
> Try `$(CURDIR)`

Thanks, done.



---

archive/issue_comments_411435.json:
```json
{
    "body": "I think this is ready for review.",
    "created_at": "2021-12-16T00:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411435",
    "user": "@jhpalmieri"
}
```

I think this is ready for review.



---

archive/issue_comments_411436.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-12-16T00:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411436",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_411437.json:
```json
{
    "body": "\n```\n+SAGE_ROOT ?= $(CURDIR)\n+SAGE_SRC ?= $(SAGE_ROOT)/src\n```\n\nI think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here",
    "created_at": "2021-12-17T06:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411437",
    "user": "@mkoeppe"
}
```


```
+SAGE_ROOT ?= $(CURDIR)
+SAGE_SRC ?= $(SAGE_ROOT)/src
```

I think it would be safer to just use `=` instead of `?=`. We don't want environment variable settings to be used here



---

archive/issue_comments_411438.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-12-17T19:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411438",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_411439.json:
```json
{
    "body": "Fixed, thanks.",
    "created_at": "2021-12-17T19:45:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411439",
    "user": "@jhpalmieri"
}
```

Fixed, thanks.



---

archive/issue_comments_411440.json:
```json
{
    "body": "\n```\n+clean:\n+\t@echo \"Deleting package build directories...\"\n+\tif [ -x \"$(SAGE_SRC)\"/bin/sage-env-config ]; then \\\n+\t    . \"$(SAGE_SRC)\"/bin/sage-env-config; \\\n+            rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"; \\\n+\tfi\n```\n\nThe reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.\n\nAlso, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...",
    "created_at": "2021-12-20T23:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411440",
    "user": "@mkoeppe"
}
```


```
+clean:
+	@echo "Deleting package build directories..."
+	if [ -x "$(SAGE_SRC)"/bin/sage-env-config ]; then \
+	    . "$(SAGE_SRC)"/bin/sage-env-config; \
+            rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"; \
+	fi
```

The reference to `SAGE_LOCAL` does not work - the syntax $(...) is referring to a Make variable, but you want a shell variable. So `$$...` should be used instead.

Also, for extra safety, best to test that the variable is nonempty before passing it to `rm -rf`...



---

archive/issue_comments_411441.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-21T03:22:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411441",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_411442.json:
```json
{
    "body": "It was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.",
    "created_at": "2021-12-21T03:22:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411442",
    "user": "@jhpalmieri"
}
```

It was okay because that branch wasn't being run anyway, since `sage-env-config` is not executable. Fixed now.



---

archive/issue_comments_411443.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-12-23T05:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411443",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_411444.json:
```json
{
    "body": "LGTM and seems to work well.",
    "created_at": "2021-12-23T05:14:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411444",
    "user": "@mkoeppe"
}
```

LGTM and seems to work well.



---

archive/issue_comments_411445.json:
```json
{
    "body": "Thank you!",
    "created_at": "2021-12-23T19:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411445",
    "user": "@jhpalmieri"
}
```

Thank you!



---

archive/issue_comments_411446.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-12-28T21:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29073",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29073#issuecomment-411446",
    "user": "@vbraun"
}
```

Resolution: fixed
