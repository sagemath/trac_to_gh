# Issue 25322: py3: an issue with weak cache ?

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2018-06-11 18:51:18

CC:  embray jdemeyer tscrim nthiery

Trying to build the doc with sage3, one meets the following issue, for which I have no clue. Travis had an idea, maybe ?

```
sage: ct=CartanType(['C', 2, 1])
sage: AS=ct.AmbientSpace
sage: AS(RS,QQ)
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6174)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/weak_dict.pyx in sage.misc.weak_dict.WeakValueDictionary.__getitem__ (build/cythonized/sage/misc/weak_dict.c:3561)()

KeyError: ((<class 'sage.combinat.root_system.type_affine.AmbientSpace'>, Root system of type ['C', 2, 1], Rational Field), ())

During handling of the above exception, another exception occurred:

AttributeError                            Traceback (most recent call last)
<ipython-input-34-c74e77f39a4f> in <module>()
----> 1 AS(RS,QQ)

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1639)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/cachefunc.pyx in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6300)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/structure/unique_representation.py in __classcall__(cls, *args, **options)
   1024             True
   1025         """
-> 1026         instance = typecall(cls, *args, **options)
   1027         assert isinstance( instance, cls )
   1028         if instance.__class__.__reduce__ == CachedRepresentation.__reduce__:

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/misc/classcall_metaclass.pyx in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2089)()

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/root_system/type_affine.py in __init__(self, root_system, base_ring)
    158         self.classical().module_morphism(self.monomial, codomain=self).register_as_coercion()
    159         # Duplicated from ambient_space.AmbientSpace
--> 160         coroot_lattice = self.root_system.coroot_lattice()
    161         coroot_lattice.module_morphism(self.simple_coroot, codomain=self).register_as_coercion()
    162 

/home/chapoton/sage3/local/lib/python3.6/site-packages/sage/combinat/root_system/root_system.py in coroot_lattice(self)
    518             Coroot lattice of the Root system of type ['A', 3]
    519         """
--> 520         return self.dual.root_lattice()
    521 
    522     def coroot_space(self, base_ring=QQ):

AttributeError: 'RootSystem' object has no attribute 'dual'
```



---

Comment by chapoton created at 2018-06-11 18:56:03

Note that this works for 

```
ct=CartanType(['C', 2])
```



---

Comment by nbruin created at 2018-06-11 20:08:28

Incidentally, the creation of `RootSystem` includes the construction of its dual, with the root system as a construction parameter. Classic `UniqueRepresentation` memory leak. This is now #25560

(I think this is orthogonal to the problem you're encountering, but I stumbled on it when browsing the relevant code).


---

Comment by tscrim created at 2018-06-11 23:54:59

I'm not sure, but I don't quite understand the construction in full detail. Nicolas, I know you explained it to me once (I think it was at PyCon a few years ago), but I don't remember the details. Could you explain what is needed and why?

Also, #25560 is a duplicate of #18426.


---

Comment by chapoton created at 2018-06-19 12:28:26

aaprently, this was fixed by #25587


---

Comment by chapoton created at 2018-06-19 12:28:26

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-06-19 23:51:28

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-06-19 23:51:28

Okay.


---

Comment by embray created at 2018-07-26 16:27:21

Resolution: worksforme
