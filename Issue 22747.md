# Issue 22747: Upgrade normaliz to 3.3.0 and pynormaliz to 1.7

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2017-05-11 22:07:21

CC:  winfried tmonteil vdelecroix tscrim jipilab @sebasguts

... (when these versions are released)

Among other things this will make computations interruptible with `^C`.


---

Comment by mkoeppe created at 2017-08-26 23:08:42

Tested on Mac OS X. Works well except for interrupting (may require newer pynormaliz...) and the doctest failures reported in #23586 (fixing broken pynormaliz doctests). 
----
New commits:


---

Comment by git created at 2017-08-29 19:20:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-03-03 17:06:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2018-03-03 17:10:33

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-03-03 23:52:23

I am now getting this crash (looks like an upstream problem):

```
sage: ieqs = [[0, 2, 0, -1, 0, 0, 0, 0, 0], [0, 0, 2, 0, -1, 0, 0, 0, 0],
....:         [1, -1, 0, 2, -1, 0, 0, 0, 0], [0, 0, -1, -1, 2, -1, 0, 0, 0],
....:         [0, 0, 0, 0, -1, 2, -1, 0, 0], [0, 0, 0, 0, 0, -1, 2, -1, 0],
....:         [0, 0, 0, 0, 0, 0, -1, 2, -1], [2, 0, 0, 0, 0, 0, 0, -1, 2],
....:         [0, -1, 0, 0, 0, 0, 0, 0, 0], [0, 0, -1, 0, 0, 0, 0, 0, 0],
....:         [0, 0, 0, -1, 0, 0, 0, 0, 0], [0, 0, 0, 0, -1, 0, 0, 0, 0],
....:         [0, 0, 0, 0, 0, -1, 0, 0, 0], [0, 0, 0, 0, 0, 0, -1, 0, 0],
....:         [0, 0, 0, 0, 0, 0, 0, -1, 0], [0, 0, 0, 0, 0, 0, 0, 0, -1],
....:         [-1, -1, -1, -1, -1, -1, -1, -1, -1], [3, 1, 0, 0, 0, 0, 0, 0, 0],
....:         [4, 0, 1, 0, 0, 0, 0, 0, 0], [6, 0, 0, 1, 0, 0, 0, 0, 0],
....:         [8, 0, 0, 0, 1, 0, 0, 0, 0], [6, 0, 0, 0, 0, 1, 0, 0, 0],
....:         [4, 0, 0, 0, 0, 0, 1, 0, 0], [2, 0, 0, 0, 0, 0, 0, 1, 0],
....:         [0, 0, 0, 0, 0, 0, 0, 0, 1]]
sage: P = Polyhedron(ieqs=ieqs, backend='normaliz')
sage: P.integral_points()
python2: ./libnormaliz/matrix.cpp:2901: libnormaliz::Matrix<Integer> libnormaliz::Matrix<Integer>::LLL_red(libnormaliz::Matrix<Integer>&, libnormaliz::Matrix<Integer>&) const [with Integer = double]: Assertion `(int) rank()==n' failed.
------------------------------------------------------------------------
/home/travis/sage-build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x574b)[0x7fa5afdf274b]
/home/travis/sage-build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x57b5)[0x7fa5afdf27b5]
/home/travis/sage-build/local/lib/python2.7/site-packages/cysignals/signals.so(+0x849a)[0x7fa5afdf549a]
/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fa5bcd37390]
/lib/x86_64-linux-gnu/libc.so.6(gsignal+0x38)[0x7fa5bc991428]
/lib/x86_64-linux-gnu/libc.so.6(abort+0x16a)[0x7fa5bc99302a]
/lib/x86_64-linux-gnu/libc.so.6(+0x2dbd7)[0x7fa5bc989bd7]
/lib/x86_64-linux-gnu/libc.so.6(+0x2dc82)[0x7fa5bc989c82]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZNK11libnormaliz6MatrixIdE7LLL_redERS1_S2_+0x5b9)[0x7fa47314f4a9]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZNK11libnormaliz6MatrixIdE17LLL_red_transposeERS1_S2_+0x83)[0x7fa47314fdc3]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZN11libnormaliz15LLL_coordinatesIxdEENS_25Sublattice_RepresentationIT_EERKNS_6MatrixIT0_EE+0x56)[0x7fa4730cfde6]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZN11libnormaliz31LLL_coordinates_without_1st_colIxxEEvRNS_25Sublattice_RepresentationIT_EENS_6MatrixIT0_EES7_b+0x291)[0x7fa4730d0881]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZN11libnormaliz14ProjectAndLiftIxxE7computeEbb+0x194)[0x7fa473104e54]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZN11libnormaliz4ConeI10__gmp_exprIA1_12__mpz_structS3_EE16project_and_liftERNS_14ConePropertiesERNS_6MatrixIS4_EERKS9_SA_b+0x839)[0x7fa473179b69]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZN11libnormaliz4ConeI10__gmp_exprIA1_12__mpz_structS3_EE31try_approximation_or_projectionERNS_14ConePropertiesE+0xf00)[0x7fa4731f5370]
/home/travis/sage-build/local/lib/libnormaliz.so.3(_ZN11libnormaliz4ConeI10__gmp_exprIA1_12__mpz_structS3_EE7computeENS_14ConePropertiesE+0x1e1)[0x7fa4731e8671]
/home/travis/sage-build/local/lib/python2.7/site-packages/PyNormaliz_cpp.so(_Z14_NmzResultImplI10__gmp_exprIA1_12__mpz_structS2_EEP7_objectPN11libnormaliz4ConeIT_EES5_+0x75)[0x7fa4734f6cc5]
/home/travis/sage-build/local/lib/python2.7/site-packages/PyNormaliz_cpp.so(_Z10_NmzResultP7_objectS0_+0x150)[0x7fa4734ed890]
```

Originally found by

```
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *3,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#3,2-macro))
sage: len(RC.module_generators)
python2: ./libnormaliz/matrix.cpp:2901: libnormaliz::Matrix<Integer> libnormaliz::Matrix<Integer>::LLL_red(libnormaliz::Matrix<Integer>&, libnormaliz::Matrix<Integer>&) const [with Integer = double]: Assertion `(int) rank()==n' failed.
```

(Mathematical note, through trying to find a smaller example, I am noticing that E<sub>8</sub><sup>(1)</sup> is special in that it is the only place where I see non-full-dimensional non-empty polytopes in my computations. Well, I also see a 0-dimensional polytope for type D<sub>4</sub><sup>(3)</sup>, but that doesn't cause a crash as it is likely special-cased.)

----

Also can you update the comment before `--enable-flint` to also say you enable flint as it is part of the standard packages of Sage?


---

Comment by tscrim created at 2018-03-03 23:52:23

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-03-04 00:06:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2018-03-04 00:24:07

I can confirm this crash. Here on Mac OS X, this actually becomes an unhandled SIGABRT:

```
Assertion failed: ((int) rank()==n), function LLL_red, file ./libnormaliz/matrix.cpp, line 2901.
------------------------------------------------------------------------
0   signals.so                          0x000000010af572d8 print_backtrace + 40
1   ???                                 0x000000010dcac1e0 0x0 + 4526359008
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
```



---

Comment by mkoeppe created at 2018-03-04 03:57:54

Upstream master branch (8db5b68491a105b9185a01c29c2f126f5115e238) has different behavior but does not fix this.


---

Comment by tmonteil created at 2018-03-04 10:02:05

I confirm that the packages build and pass self-tests and doctests correctly on both 64 and 32 bit architectures on Debian stretch. I also comfirm that there is a crash on both architectures regarding the test provided by Travis (which should be added in our doctests, once the issue is fixed).


---

Comment by Winfried created at 2018-03-04 16:44:17

I am not sure what the matrix ieqs represents. My interpretation: inhomogeneous inequalities, and we want to compute the lattice points in the polytope they define. Under this assumption I have made a Normaliz input file rash.in


```
amb_space auto
inhom_inequalities
[[0, 2, 0, -1, 0, 0, 0, 0, 0],
...
[0, 0, 0, 0, 0, 0, 0, 0, 1]]
HilbertBasis
```


Then a run of 


```
normaliz -c crash.in
```


finishes without any problems in 3.5.1 and the intended 3.5.2. It turns out that the polytope is empty:


```
0 module generators
1252 Hilbert basis elements of recession monoid
0 vertices of polyhedron
39 extreme rays of recession cone
11 support hyperplanes of polyhedron (homogenized)

embedding dimension = 9
affine dimension of the polyhedron = -1
rank of recession monoid = 8
...
```


Is my interpretation of the input correct?


---

Comment by Winfried created at 2018-03-04 16:48:03

Of course, if the matrix represents inhomogeneous inequalities, what is the RHS? My input above assumes it is the last coordinate. I will now try with the first.


---

Comment by Winfried created at 2018-03-04 17:18:20

Unfortunately Normaliz crashes when coordinate 1 is interpreted as the RHS. Will take care of it.


---

Comment by Winfried created at 2018-03-04 20:26:17

The problem is solved. Replace line 323 of source/libnormaliz/sublattice_representation.h

by


```
    if(Vertices.nr_of_rows()==0 || Vertices.rank()<EmbDim){ // use Supps for LLL coordinates
```


i.e., delete "-1" in this line.


---

Comment by tscrim created at 2018-03-04 22:42:12

Replying to [comment:20 Winfried]:
> The problem is solved. Replace line 323 of source/libnormaliz/sublattice_representation.h
> 
> by
> 
> {{{
>     if(Vertices.nr_of_rows()==0 || Vertices.rank()<EmbDim){ // use Supps for LLL coordinates
> }}}
> 
> i.e., delete "-1" in this line.

Great, thank you for figuring it out. I am guessing you are in the process of making a commit upstream or should I do a pull request?


---

Comment by tscrim created at 2018-03-04 23:10:43

I've pushed a branch with a fix for this problem. However, I have now come across another crash:

```
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *4,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#4,2-macro))
sage: len(RC.module_generators)
python2: ./libnormaliz/project_and_lift.cpp:75: std::vector<long unsigned int> libnormaliz::ProjectAndLift<IntegerPL, IntegerRet>::order_supps(const libnormaliz::Matrix<Integer>&) [with IntegerPL = long long int; IntegerRet = long long int]: Assertion `Supps.nr_of_rows()>0' failed.
------------------------------------------------------------------------
```

I have verified that this did at least not crash before (well, up to my patience level of 2 minutes).

However, **much** more worrying is this:

```
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *5,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,2-macro))
sage: %time len(RC.module_generators)
CPU times: user 25 s, sys: 52 ms, total: 25 s
Wall time: 6.95 s
6009
```

versus before

```
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *5,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,2-macro))
sage: %time len(RC.module_generators)
CPU times: user 1min 11s, sys: 320 ms, total: 1min 11s
Wall time: 14.6 s
7066
```

Although the `[5,1]` example both returns 75.

I will extract the polytopes and find out which one gives a different number of lattice points. Give me a few minutes.
----
New commits:


---

Comment by tscrim created at 2018-03-04 23:19:53

Okay, here is the `[4,1]` computation to completion:

```
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *4,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#4,2-macro))
sage: %time len(RC.module_generators)
CPU times: user 19min 37s, sys: 5.2 s, total: 19min 42s
Wall time: 4min 37s
288299
```



---

Comment by tscrim created at 2018-03-04 23:39:38

Okay, here is at least the first polytope that goes wrong:

```
sage: ieqs = [[0, 2, 0, -1, 0, 0, 0, 0, 0],
....:         [0, 0, 2, 0, -1, 0, 0, 0, 0],
....:         [1, -1, 0, 2, -1, 0, 0, 0, 0],
....:         [0, 0, -1, -1, 2, -1, 0, 0, 0],
....:         [0, 0, 0, 0, -1, 2, -1, 0, 0],
....:         [0, 0, 0, 0, 0, -1, 2, -1, 0],
....:         [1, 0, 0, 0, 0, 0, -1, 2, -1],
....:         [0, 0, 0, 0, 0, 0, 0, -1, 2],
....:         [0, -1, 0, 0, 0, 0, 0, 0, 0],
....:         [0, 0, -1, 0, 0, 0, 0, 0, 0],
....:         [0, 0, 0, -1, 0, 0, 0, 0, 0],
....:         [0, 0, 0, 0, -1, 0, 0, 0, 0],
....:         [0, 0, 0, 0, 0, -1, 0, 0, 0],
....:         [0, 0, 0, 0, 0, 0, -1, 0, 0],
....:         [0, 0, 0, 0, 0, 0, 0, -1, 0],
....:         [0, 0, 0, 0, 0, 0, 0, 0, -1],
....:         [-1, -1, -1, -1, -1, -1, -1, -1, -1],
....:         [2, 1, 0, 0, 0, 0, 0, 0, 0],
....:         [4, 0, 1, 0, 0, 0, 0, 0, 0],
....:         [4, 0, 0, 1, 0, 0, 0, 0, 0],
....:         [7, 0, 0, 0, 1, 0, 0, 0, 0],
....:         [6, 0, 0, 0, 0, 1, 0, 0, 0],
....:         [4, 0, 0, 0, 0, 0, 1, 0, 0],
....:         [2, 0, 0, 0, 0, 0, 0, 1, 0],
....:         [1, 0, 0, 0, 0, 0, 0, 0, 1]]
sage: P = Polyhedron(ieqs=ieqs, backend='normaliz')
sage: P.integral_points()
((-2, -2, -4, -5, -4, -3, -2, -1),
 (-2, -2, -4, -5, -4, -3, -2, 0),
 (-1, -2, -3, -4, -3, -2, -2, -1),
 (-1, -2, -3, -4, -3, -2, -1, 0),
 (-1, -1, -2, -2, -2, -2, -2, -1),
 (-1, -1, -2, -2, -1, -1, -1, 0),
 (-1, -1, -2, -2, -1, 0, 0, 0),
 (-1, 0, -2, -2, -2, -2, -2, -1),
 (0, -1, -1, -2, -2, -2, -2, -1),
 (0, 0, -1, -1, -1, -1, -1, 0))
sage: P
A 8-dimensional polyhedron in QQ^8 defined as the convex hull of 134 vertices
```

versus the new version with the patch:

```
sage: P.integral_points()
((-1, -2, -3, -4, -3, -2, -1, 0), (0, -1, -1, -2, -2, -2, -2, -1))
```



---

Comment by tscrim created at 2018-03-04 23:46:29

Here's also the example that causes the new crash:

```
sage: ieqs = [[0, 2, 0, -1, 0, 0, 0, 0, 0],
....:         [0, 0, 2, 0, -1, 0, 0, 0, 0],
....:         [0, -1, 0, 2, -1, 0, 0, 0, 0],
....:         [1, 0, -1, -1, 2, -1, 0, 0, 0],
....:         [0, 0, 0, 0, -1, 2, -1, 0, 0],
....:         [0, 0, 0, 0, 0, -1, 2, -1, 0],
....:         [1, 0, 0, 0, 0, 0, -1, 2, -1],
....:         [0, 0, 0, 0, 0, 0, 0, -1, 2],
....:         [0, -1, 0, 0, 0, 0, 0, 0, 0],
....:         [0, 0, -1, 0, 0, 0, 0, 0, 0],
....:         [0, 0, 0, -1, 0, 0, 0, 0, 0],
....:         [0, 0, 0, 0, -1, 0, 0, 0, 0],
....:         [0, 0, 0, 0, 0, -1, 0, 0, 0],
....:         [0, 0, 0, 0, 0, 0, -1, 0, 0],
....:         [0, 0, 0, 0, 0, 0, 0, -1, 0],
....:         [0, 0, 0, 0, 0, 0, 0, 0, -1],
....:         [-1, -1, -1, -1, -1, -1, -1, -1, -1],
....:         [3, 1, 0, 0, 0, 0, 0, 0, 0],
....:         [4, 0, 1, 0, 0, 0, 0, 0, 0],
....:         [6, 0, 0, 1, 0, 0, 0, 0, 0],
....:         [8, 0, 0, 0, 1, 0, 0, 0, 0],
....:         [6, 0, 0, 0, 0, 1, 0, 0, 0],
....:         [4, 0, 0, 0, 0, 0, 1, 0, 0],
....:         [2, 0, 0, 0, 0, 0, 0, 1, 0],
....:         [1, 0, 0, 0, 0, 0, 0, 0, 1]]
sage: P = Polyhedron(ieqs=ieqs, backend='normaliz')
sage: P.integral_points()
python2: ./libnormaliz/project_and_lift.cpp:75: std::vector<long unsigned int> libnormaliz::ProjectAndLift<IntegerPL, IntegerRet>::order_supps(const libnormaliz::Matrix<Integer>&) [with IntegerPL = long long int; IntegerRet = long long int]: Assertion `Supps.nr_of_rows()>0' failed.
------------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2018-03-04 23:52:22

A hint: If you use `P = Polyhedron(ieqs=ieqs, backend='normaliz', verbose=True)`, the `PyNormaliz` invocations are shown, making it easier for upstream


---

Comment by tscrim created at 2018-03-05 00:09:00

I wasn't aware of that, thank you. Although it does not yield much more information on the new crash:

```
sage: P = Polyhedron(ieqs=ieqs, backend='normaliz', verbose=True)
# Calling PyNormaliz.NmzCone(['inhom_equations', [], 'inhom_inequalities',
 [[2, 0, -1, 0, 0, 0, 0, 0, 0], [0, 2, 0, -1, 0, 0, 0, 0, 0],
 [-1, 0, 2, -1, 0, 0, 0, 0, 0], [0, -1, -1, 2, -1, 0, 0, 0, 1],
 [0, 0, 0, -1, 2, -1, 0, 0, 0], [0, 0, 0, 0, -1, 2, -1, 0, 0],
 [0, 0, 0, 0, 0, -1, 2, -1, 1], [0, 0, 0, 0, 0, 0, -1, 2, 0],
 [-1, 0, 0, 0, 0, 0, 0, 0, 0], [0, -1, 0, 0, 0, 0, 0, 0, 0],
 [0, 0, -1, 0, 0, 0, 0, 0, 0], [0, 0, 0, -1, 0, 0, 0, 0, 0],
 [0, 0, 0, 0, -1, 0, 0, 0, 0], [0, 0, 0, 0, 0, -1, 0, 0, 0],
 [0, 0, 0, 0, 0, 0, -1, 0, 0], [0, 0, 0, 0, 0, 0, 0, -1, 0],
 [-1, -1, -1, -1, -1, -1, -1, -1, -1], [1, 0, 0, 0, 0, 0, 0, 0, 3],
 [0, 1, 0, 0, 0, 0, 0, 0, 4], [0, 0, 1, 0, 0, 0, 0, 0, 6],
 [0, 0, 0, 1, 0, 0, 0, 0, 8], [0, 0, 0, 0, 1, 0, 0, 0, 6],
 [0, 0, 0, 0, 0, 1, 0, 0, 4], [0, 0, 0, 0, 0, 0, 1, 0, 2],
 [0, 0, 0, 0, 0, 0, 0, 1, 1]]])
sage: P.integral_points()
python2: ./libnormaliz/project_and_lift.cpp:75: std::vector<long unsigned int> libnormaliz::ProjectAndLift<IntegerPL, IntegerRet>::order_supps(const libnormaliz::Matrix<Integer>&) [with IntegerPL = long long int; IntegerRet = long long int]: Assertion `Supps.nr_of_rows()>0' failed.
------------------------------------------------------------------------
```


Here is also the output for the lattice point computation:

```
sage: P = Polyhedron(ieqs=ieqs, backend='normaliz', verbose=True)
# Calling PyNormaliz.NmzCone(['inhom_equations', [], 'inhom_inequalities',
 [[2, 0, -1, 0, 0, 0, 0, 0, 0], [0, 2, 0, -1, 0, 0, 0, 0, 0],
 [-1, 0, 2, -1, 0, 0, 0, 0, 1], [0, -1, -1, 2, -1, 0, 0, 0, 0],
 [0, 0, 0, -1, 2, -1, 0, 0, 0], [0, 0, 0, 0, -1, 2, -1, 0, 0],
 [0, 0, 0, 0, 0, -1, 2, -1, 1], [0, 0, 0, 0, 0, 0, -1, 2, 0],
 [-1, 0, 0, 0, 0, 0, 0, 0, 0], [0, -1, 0, 0, 0, 0, 0, 0, 0],
 [0, 0, -1, 0, 0, 0, 0, 0, 0], [0, 0, 0, -1, 0, 0, 0, 0, 0],
 [0, 0, 0, 0, -1, 0, 0, 0, 0], [0, 0, 0, 0, 0, -1, 0, 0, 0],
 [0, 0, 0, 0, 0, 0, -1, 0, 0], [0, 0, 0, 0, 0, 0, 0, -1, 0],
 [-1, -1, -1, -1, -1, -1, -1, -1, -1], [1, 0, 0, 0, 0, 0, 0, 0, 2],
 [0, 1, 0, 0, 0, 0, 0, 0, 4], [0, 0, 1, 0, 0, 0, 0, 0, 4],
 [0, 0, 0, 1, 0, 0, 0, 0, 7], [0, 0, 0, 0, 1, 0, 0, 0, 6],
 [0, 0, 0, 0, 0, 1, 0, 0, 4], [0, 0, 0, 0, 0, 0, 1, 0, 2],
 [0, 0, 0, 0, 0, 0, 0, 1, 1]]])
sage: P.integral_points()
((-1, -2, -3, -4, -3, -2, -1, 0), (0, -1, -1, -2, -2, -2, -2, -1))
```



---

Comment by tscrim created at 2018-03-05 00:11:29

PS - That means the docstring for `Polyhedron` needs a minor adjustment:

```
    - ``verbose`` -- boolean (default: ``False``). Whether to print
      verbose output for debugging purposes. Only supported by the cdd
      backends.
```



---

Comment by Winfried created at 2018-03-05 00:23:15

The wrong number of lattice points is a more severe problem. I don't have an explanation for it.

The (first and solved) problem in sublattice_representation.h has nothing to do with it. After the change in sublattice_representation.h:323 a second problem has become visible there in Normaliz' own tests. One must change line 325 to


```
        if(SuppHelp.rank()<EmbDim-1)
```


But againthis has nothing to do with the wrong number of lattice points.


---

Comment by git created at 2018-03-05 03:30:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-03-05 03:36:35

Replying to [comment:29 Winfried]:
> The wrong number of lattice points is a more severe problem. I don't have an explanation for it.

I am afraid all I can do is give you examples from my use-case as I do not understand too much about how Normaliz works. Thank you for your continued efforts and quick responses.

> The (first and solved) problem in sublattice_representation.h has nothing to do with it. After the change in sublattice_representation.h:323 a second problem has become visible there in Normaliz' own tests. One must change line 325 to
> 
> {{{
>         if(SuppHelp.rank()<EmbDim-1)
> }}}
> 
> But again this has nothing to do with the wrong number of lattice points.

I added that to the patch, but (as you might be aware) I am now getting yet another crash with the same example as in comment:25:

```
sage: P = Polyhedron(ieqs=ieqs, backend='normaliz', verbose=True)
# Calling PyNormaliz.NmzCone(['inhom_equations', [], 'inhom_inequalities',
 [[2, 0, -1, 0, 0, 0, 0, 0, 0], [0, 2, 0, -1, 0, 0, 0, 0, 0],
 [-1, 0, 2, -1, 0, 0, 0, 0, 0], [0, -1, -1, 2, -1, 0, 0, 0, 1],
 [0, 0, 0, -1, 2, -1, 0, 0, 0], [0, 0, 0, 0, -1, 2, -1, 0, 0],
 [0, 0, 0, 0, 0, -1, 2, -1, 1], [0, 0, 0, 0, 0, 0, -1, 2, 0],
 [-1, 0, 0, 0, 0, 0, 0, 0, 0], [0, -1, 0, 0, 0, 0, 0, 0, 0],
 [0, 0, -1, 0, 0, 0, 0, 0, 0], [0, 0, 0, -1, 0, 0, 0, 0, 0],
 [0, 0, 0, 0, -1, 0, 0, 0, 0], [0, 0, 0, 0, 0, -1, 0, 0, 0],
 [0, 0, 0, 0, 0, 0, -1, 0, 0], [0, 0, 0, 0, 0, 0, 0, -1, 0],
 [-1, -1, -1, -1, -1, -1, -1, -1, -1], [1, 0, 0, 0, 0, 0, 0, 0, 3],
 [0, 1, 0, 0, 0, 0, 0, 0, 4], [0, 0, 1, 0, 0, 0, 0, 0, 6],
 [0, 0, 0, 1, 0, 0, 0, 0, 8], [0, 0, 0, 0, 1, 0, 0, 0, 6],
 [0, 0, 0, 0, 0, 1, 0, 0, 4], [0, 0, 0, 0, 0, 0, 1, 0, 2],
 [0, 0, 0, 0, 0, 0, 0, 1, 1]]])
sage: P
A 8-dimensional polyhedron in QQ^8 defined as the convex hull of 132 vertices
sage: P.integral_points()
python2: ./libnormaliz/project_and_lift.cpp:75: std::vector<long unsigned int> libnormaliz::ProjectAndLift<IntegerPL, IntegerRet>::order_supps(const libnormaliz::Matrix<Integer>&) [with IntegerPL = long long int; IntegerRet = long long int]: Assertion `Supps.nr_of_rows()>0' failed.
------------------------------------------------------------------------
```


Addendum - It is the same error as before.


---

Comment by Winfried created at 2018-03-05 06:36:28

I think all the observed problems are solved. More tomorrow.


---

Comment by tscrim created at 2018-03-05 06:43:50

Great, thank you!


---

Comment by Winfried created at 2018-03-05 18:02:48

The problem with the wrong number of lattice points (or a failing assertion) was not caused by a severe problem, but by a silly bug. As a temporary fix I suggest to include as lines cone.cpp:3804 and 3805


```
    if(!is_parallelotope)
        Pair.clear();
```


So with some surrounding the code there should be


```
            is_Computed.set(ConeProperty::IsPointed);
        }
    }
    
    if(!is_parallelotope)
        Pair.clear();
    
    if(!inhomogeneous && !isComputed(ConeProperty::Grading))
        return;
```


I plan to release 3.5.2 at the end of this week. It will contain a more conceptual solution.

Please test.


---

Comment by git created at 2018-03-05 22:07:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-03-05 22:13:33

Thank you. I have verified that I get again

```
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *5,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#5,2-macro))
sage: %time len(RC.module_generators)
CPU times: user 27.6 s, sys: 68 ms, total: 27.7 s
Wall time: 7.8 s
7066
sage: RC = RiggedConfigurations(['E',8,1], [This is the Trac macro *4,2* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#4,2-macro))
sage: %time len(RC.module_generators)
CPU times: user 5min 6s, sys: 944 ms, total: 5min 7s
Wall time: 1min 36s
288299
```

and the >2x speedup is very impressive. :) I've updated the patch accordingly.

`@`mkoeppe Perhaps we should just wait on this upgrade until 3.5.2 is released to avoid the patch since it will be in just a few days?

As far as adding tests go, I think we should explicitly add the polytopes mentioned above rather than the RC code. They are isolated and much faster to test.


---

Comment by mkoeppe created at 2018-03-05 22:30:40

Replying to [comment:36 tscrim]:
> `@`mkoeppe Perhaps we should just wait on this upgrade until 3.5.2 is released to avoid the patch since it will be in just a few days?

Yes, I think so too.

> As far as adding tests go, I think we should explicitly add the polytopes mentioned above rather than the RC code. They are isolated and much faster to test.

I agree.


---

Comment by git created at 2018-03-14 02:14:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-03-14 02:16:18

Here is with 3.5.2 and the tests I did above now work. Where would a good place be to add the doctests?


---

Comment by tscrim created at 2018-03-14 02:16:18

Changing status from needs_work to needs_info.


---

Comment by mkoeppe created at 2018-03-15 00:24:00

I would think the doctests should go to `Polyhedron_normaliz.integral_points`.


---

Comment by mkoeppe created at 2018-03-15 00:24:00

Changing status from needs_info to needs_work.


---

Comment by git created at 2018-03-15 07:10:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-03-15 07:11:25

Okay, done.


---

Comment by tscrim created at 2018-03-15 07:11:25

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2018-03-21 07:32:03

ping


---

Comment by mkoeppe created at 2018-04-02 14:58:13

S. Gutsche informs us that we should upgrade pynormaliz to 1.12


---

Comment by mkoeppe created at 2018-04-02 14:58:13

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2018-04-02 16:58:31

All tests passed with sage8.2.beta8.

`@`Travis: Do you still want to add a comment about the verbose of `Polyhedron`?

Otherwise, it seems that we need to wait for 1.12 of pynormaliz check everything one last time.


---

Comment by mkoeppe created at 2018-04-02 17:05:36

New commits:


---

Comment by mkoeppe created at 2018-04-02 17:05:36

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2018-04-02 17:13:08

New commits:


---

Comment by jipilab created at 2018-04-02 17:13:08

Changing status from needs_review to positive_review.


---

Comment by jipilab created at 2018-04-02 17:13:40

It looks good to me now and all tests pass in the polyhedron folder.


---

Comment by mkoeppe created at 2018-04-02 21:09:13

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2018-04-02 21:09:13

Compilation errors with a specific gcc version with PyNormaliz. Fixed in normaliz 3.5.3


---

Comment by mkoeppe created at 2018-04-02 21:37:21

New commits:


---

Comment by mkoeppe created at 2018-04-02 21:37:21

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2018-04-02 21:48:01

Install the latest normaliz and got:


```
~/sage/src/sage/geometry/polyhedron$ sage -t *.py
Using --optional=4ti2,bliss,latte_int,lidia,lrslib,mpir,normaliz,pynormaliz,python2,sage
Doctesting 25 files.
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

Comment by jipilab created at 2018-04-02 22:01:24

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2018-04-02 22:52:29

Replying to [comment:46 jipilab]:
> `@`Travis: Do you still want to add a comment about the verbose of `Polyhedron`?

It can be on a separate ticket, but the docstring for `verbose` should also say it is supported for the normaliz backend as well.


---

Comment by jipilab created at 2018-04-02 23:57:15

Replying to [comment:57 tscrim]:
> Replying to [comment:46 jipilab]:
> > `@`Travis: Do you still want to add a comment about the verbose of `Polyhedron`?
> 
> It can be on a separate ticket, but the docstring for `verbose` should also say it is supported for the normaliz backend as well.

I went ahead and made the change already... I realized it was not a big deal.


---

Comment by tscrim created at 2018-04-02 23:59:36

Ah, thanks. I didn't look at the diffs.


---

Comment by jipilab created at 2018-04-03 14:46:36

Merged the forgotten commit.
----
New commits:


---

Comment by jipilab created at 2018-04-03 14:56:30

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2018-04-03 17:34:35

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2018-04-04 00:13:40

Changing keywords from "" to "IMA-PolyGeom".


---

Comment by vbraun created at 2018-05-08 17:27:22

Resolution: fixed
