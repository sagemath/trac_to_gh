# Issue 32552: Fix spkg-configure.m4 for singular

Issue created by migration from https://trac.sagemath.org/ticket/32789

Original creator: mkoeppe

Original creation time: 2021-10-29 02:38:28

CC:  dimpase fbissey slelievre isuruf mjo @tobiasdiez thansen

Follow-up from #29024. This time with testing on more than 1 platform.


---

Comment by mkoeppe created at 2021-11-28 03:16:32

Changing priority from major to blocker.


---

Comment by mjo created at 2021-11-28 13:15:31

We already tried to fix the path to libSingular on cygwin once. Where does it really live?


---

Comment by mkoeppe created at 2021-11-28 19:36:41

We have a GH Actions workflow for Cygwin that allows you to download logs and the installation in `SAGE_LOCAL` for inspection, see for example https://github.com/sagemath/sage/actions/runs/1478855916


---

Comment by slelievre created at 2021-11-29 18:59:25

Happy to run any commands under Cygwin too.


---

Comment by mkoeppe created at 2021-11-29 19:53:31

From https://github.com/mkoeppe/sage/suites/4487559073/artifacts/119913634:
The following DLLs are installed in `SAGE_LOCAL/bin`:

```
cygfactory-4-2-1.dll
cygomalloc-0-9-6.dll
cygpolys-4-2-1.dll
cygsingular_resources-4-2-1.dll
cygSingular-4-2-1.dll
```



---

Comment by mjo created at 2021-11-29 20:03:01

Replying to [comment:7 mkoeppe]:
> {{{
> cygSingular-4-2-1.dll
> }}}

Is there a symlink from `cygSingular.dll` to that file?


---

Comment by mkoeppe created at 2021-11-29 20:05:55

No


---

Comment by mkoeppe created at 2021-11-29 20:08:48

There is also a file `SAGE_LOCAL/lib/libSingular.dll.a`, which is used by the linker, and probably contains the information about the name of the actual DLL somehow.


---

Comment by mkoeppe created at 2021-11-29 20:16:09

Apparently https://sourceware.org/binutils/docs/binutils/dlltool.html can be used for reading this info.

`@`slelievre, could you run `dlltool --identify local/lib/libSingular.dll.a` please?


---

Comment by mjo created at 2021-11-29 20:45:01

The SPKG won't be installed yet, so we can't read `local/lib/libSingular.dll.a` to obtain the necessary path during `./configure.` For the SPKG, we could hard-code the value as a last resort. Their library versioning scheme also corresponds to `package-version.txt`, but I doubt that's reliable.

Detecting the system copy should be relatively easy in comparison. Unless there's a way to install multiple copies into the system libdir, we can use `find` to pick out what is hopefully the only copy of `cygSingular*.dll` during `./configure`.


---

Comment by mkoeppe created at 2021-11-29 20:52:05

It would probably be a good idea to first test whether this whole symbol visibility issue is even a thing on Cygwin.


---

Comment by mkoeppe created at 2021-11-29 21:06:04

New commits:


---

Comment by git created at 2021-11-29 21:06:38

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-11-29 21:07:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-29 21:08:18

I've put this on top of other Cygwin fixes for convenience of testing


---

Comment by mkoeppe created at 2021-11-30 21:18:06

Hm, the test with `CYGWIN_VERSION` does not seem to have worked
https://github.com/sagemath/sagetrac-mirror/runs/4371131888?check_suite_focus=true


---

Comment by git created at 2021-11-30 21:55:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-30 22:01:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-01 17:50:23

Changing priority from blocker to critical.


---

Comment by mkoeppe created at 2021-12-01 17:50:23

I've split out the cygwin issue to #32954, ready for review


---

Comment by mkoeppe created at 2021-12-23 19:51:04

Currently on all `ubuntu` including `-jammy`, singular's dependency `cddlib` is rejected - so there's no urgency here


---

Comment by mkoeppe created at 2021-12-23 19:51:04

Changing priority from critical to major.


---

Comment by thansen created at 2021-12-24 12:29:18

Replying to [comment:25 mkoeppe]:
> Currently on all `ubuntu` including `-jammy`, singular's dependency `cddlib` is rejected - so there's no urgency here

I didn't get that. Is there something that needs to be changed in a Debian package?


---

Comment by mkoeppe created at 2021-12-25 19:50:27

Replying to [comment:26 thansen]:
> Replying to [comment:25 mkoeppe]:
> > Currently on all `ubuntu` including `-jammy`, singular's dependency `cddlib` is rejected - so there's no urgency here
> 
> I didn't get that. Is there something that needs to be changed in a Debian package?

Yes, I think Debian's `cddlib` needs upgrading to 0.94m (see https://repology.org/project/cddlib/versions)


---

Comment by thansen created at 2021-12-29 13:25:25

Replying to [comment:27 mkoeppe]:
> Yes, I think Debian's `cddlib` needs upgrading to 0.94m (see https://repology.org/project/cddlib/versions)

Ok, done.


---

Comment by mkoeppe created at 2021-12-30 01:26:56

Replying to [comment:28 thansen]:
> Replying to [comment:27 mkoeppe]:
> > Yes, I think Debian's `cddlib` needs upgrading to 0.94m (see https://repology.org/project/cddlib/versions)
> 
> Ok, done.

Great. `tox -e docker-ubuntu-jammy-standard -- config.status` now gives:

```
Checking whether SageMath should install SPKG singular...
checking whether any of gmp ntl flint readline mpfr cddlib is installed as or will be installed as SPKG... no
checking for Singular... /usr/bin/Singular
checking for Singular >= 4.1.1... yes
checking if we can dlopen(/usr/lib/x86_64-linux-gnu/libSingular.so)... no
configure: no suitable system package found for SPKG singular
```


So it makes sense now to work on the present ticket.


---

Comment by slelievre created at 2022-01-26 16:35:33

Changing priority from major to critical.


---

Comment by slelievre created at 2022-01-26 16:35:33

Changing to critical in view of #33139.


---

Comment by mjo created at 2022-01-26 16:48:35

What does this have to do with a docbuild failure?


---

Comment by slelievre created at 2022-01-26 20:25:59

Changing priority from critical to major.


---

Comment by slelievre created at 2022-01-26 20:25:59

Right, the link with singular was ruled out
in ticket:32954#comment:8.

Sorry for the noise.


---

Comment by dimpase created at 2022-02-11 12:58:58

still testing. the library on Debian is recognised, at least.
----
New commits:


---

Comment by git created at 2022-02-11 17:11:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-02-11 17:21:55

Changing status from new to needs_review.


---

Comment by dimpase created at 2022-02-11 17:21:55

Needs review. I suppose allowing Singular 4.1.1 was to be bumped up, as 4.1.1 doesn't actually have `polylib.lib` (it's called `poly.lib` there, but it's anyway too old, I think).


---

Comment by dimpase created at 2022-02-11 18:35:45

I actually checked that the branch allows using system Singular 4.1.1 on Debian 11, but then the result has test failures due to that `polylib.lib` absense.


---

Comment by mkoeppe created at 2022-02-11 19:56:33

OK, this still correctly rejects singular on all ubuntu releases earlier than `jammy`.


---

Comment by mkoeppe created at 2022-02-11 22:24:22

With `TARGETS_PRE=build-local tox -e docker-ubuntu-jammy-standard -- build ptest` I see the following failures:

```
sage -t --random-seed=75077202530737540355693167266645487963 src/sage/interfaces/singular.py
**********************************************************************
File "src/sage/interfaces/singular.py", line 2243, in sage.interfaces.singular.SingularFunction._instancedoc_
Failed example:
    'groebner' in singular.groebner.__doc__
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.singular.SingularFunction._instancedoc_[0]>", line 1, in <module>
        'groebner' in singular.groebner.__doc__
      File "sage/docs/instancedoc.pyx", line 211, in sage.docs.instancedoc.InstanceDocDescriptor.__get__ (build/cythonized/sage/docs/instancedoc.c:1878)
        return self.instancedoc(obj)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2247, in _instancedoc_
        generate_docstring_dictionary()
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2337, in generate_docstring_dictionary
        with io.open(singular_info_file,
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************
File "src/sage/interfaces/singular.py", line 2283, in sage.interfaces.singular.SingularFunctionElement._instancedoc_
Failed example:
    'matrix_expression' in A.nrows.__doc__
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.singular.SingularFunctionElement._instancedoc_[2]>", line 1, in <module>
        'matrix_expression' in A.nrows.__doc__
      File "sage/docs/instancedoc.pyx", line 211, in sage.docs.instancedoc.InstanceDocDescriptor.__get__ (build/cythonized/sage/docs/instancedoc.c:1878)
        return self.instancedoc(obj)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2287, in _instancedoc_
        generate_docstring_dictionary()
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2337, in generate_docstring_dictionary
        with io.open(singular_info_file,
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************
File "src/sage/interfaces/singular.py", line 2319, in sage.interfaces.singular.generate_docstring_dictionary
Failed example:
    generate_docstring_dictionary()
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.singular.generate_docstring_dictionary[1]>", line 1, in <module>
        generate_docstring_dictionary()
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2337, in generate_docstring_dictionary
        with io.open(singular_info_file,
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************
File "src/sage/interfaces/singular.py", line 2371, in sage.interfaces.singular.get_docstring
Failed example:
    'groebner' in get_docstring('groebner')
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.singular.get_docstring[1]>", line 1, in <module>
        'groebner' in get_docstring('groebner')
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2378, in get_docstring
        generate_docstring_dictionary()
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2337, in generate_docstring_dictionary
        with io.open(singular_info_file,
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************
File "src/sage/interfaces/singular.py", line 2373, in sage.interfaces.singular.get_docstring
Failed example:
    'standard.lib' in get_docstring('groebner')
Exception raised:
    Traceback (most recent call last):
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.interfaces.singular.get_docstring[2]>", line 1, in <module>
        'standard.lib' in get_docstring('groebner')
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2378, in get_docstring
        generate_docstring_dictionary()
      File "/sage/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/interfaces/singular.py", line 2337, in generate_docstring_dictionary
        with io.open(singular_info_file,
    TypeError: expected str, bytes or os.PathLike object, not NoneType
**********************************************************************

sage -t --random-seed=75077202530737540355693167266645487963 src/sage/libs/singular/singular.pyx
**********************************************************************
File "src/sage/libs/singular/singular.pyx", line 1583, in sage.libs.singular.singular.get_resource
Failed example:
    get_resource('i')            # SINGULAR_INFO_FILE
Expected:
    '.../singular...'
Got:
    <BLANKLINE>
**********************************************************************
```

and similar


---

Comment by mkoeppe created at 2022-02-11 22:24:22

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2022-02-12 10:16:12

this appears to be fixed by 

```
export SINGULAR_INFO_FILE=/usr/share/doc/singular/singular.hlp
```

before starting Sage. After this, instead of

```
sage: from sage.libs.singular.singular import get_resource
sage: get_resource('i')
// ** Could not get 'InfoFile'.
// ** Either set environment variable 'SINGULAR_INFO_FILE' to 'InfoFile',
// ** or make sure that 'InfoFile' is at "/usr/bin/../share/info/singular.hlp"
```

one gets, as it should be:

```
sage: from sage.libs.singular.singular import get_resource
sage: get_resource('i')
'/usr/share/doc/singular/singular.hlp'
```

The latter needs `singular-doc` installed, so it must be added to
`build/pkgs/singular/distros/debian.txt`.


---

Comment by dimpase created at 2022-02-12 10:57:20

Should be fixed by

```diff
--- a/src/sage/libs/singular/singular.pyx
+++ b/src/sage/libs/singular/singular.pyx
@@ -1587,5 +1587,8 @@ def get_resource(id):
     """
     cdef char *result = feGetResource(<char>ord(id))
     if result == NULL:
-        return None
+        os.environ['SINGULAR_INFO_FILE']='/usr/share/doc/singular/singular.hlp'
+        result = feGetResource(<char>ord(id))
+        if result == NULL:
+            return None
     return bytes_to_str(result)
```



---

Comment by git created at 2022-02-12 11:00:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2022-02-12 11:01:18

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2022-02-12 16:08:26

All !Debian/Ubuntu Singular 4.2.1 packages are  broken, some of them do not install the needed .hlp file at all.


---

Comment by mkoeppe created at 2022-02-12 16:51:31

Replying to [comment:42 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[cb82ed0](https://git.sagemath.org/sage.git/commit/?id=cb82ed03d722e8e1e1a8fb6e8a0320c28f8a3ea7)||`make singular.hlp known to Sage for Debian Singular`||

I don't think we should have this in our code


---

Comment by mkoeppe created at 2022-02-12 16:52:12

Probably best to wait until there's a suitable version packaged


---

Comment by mkoeppe created at 2022-02-12 16:52:12

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2022-02-12 19:03:40

indeed, there are no packages that work for us atm.


---

Comment by dimpase created at 2022-02-12 23:00:40

It seems that actually something either goes wrong with dpkg in Ubuntu Jammy, or something is wrong in my Docker setup, but
installing singular-doc Ubuntu package results in many (most) missing files.
In particular the crucial file "singular.info" is missing.


---

Comment by dimpase created at 2022-02-12 23:38:18

Disturbingly, while on my Jammy Docker installing singular-doc leads to missing files,
installing the same package on another ("real") Ubuntu system works.
So this might be Docker-specific :-(


---

Comment by mkoeppe created at 2022-02-13 00:46:21

You can use `docker system prune --all` to get rid of bad stuff in the cache


---

Comment by dimpase created at 2022-02-13 00:51:53

cache? No, it's worse, it's `dpkg -i` which does not do the job. 

If I take the same .deb file, unpack it using `ar x` and manually install `data.tar.zst` using tar (one might have to install `zstd` first, to do un-compression), *all* the files from the package get installed.


---

Comment by dimpase created at 2022-02-13 08:45:25

Further inspection shows that the problem is in the official !Ubuntu/Jammy Docker image. Both official Ubuntu's and Debian 
`singular-doc_4.2.1-p3+ds-1_all.deb` files exhibit the same error (apt used dpkg to install files .deb files, and the same error shows up if installation is done by `dpkg -i singular-doc_4.2.1-p3+ds-1_all.deb`).

Could you check it's not only my Docker that plays up here? Steps to reproduce: 

* launch official Jammy image

* get shell prompt there

* run 

```
apt install singular-doc
dpkg -V singular-doc
```


The latter command should not output anything - but for me it outputs a log of missing files.



In !Debian/Bookworm image, which carries the same singular-doc version, everything is fine.

PS. It would be good to check on a non-Docker installation of Jammy, too.


---

Comment by dimpase created at 2022-02-13 08:49:28

We can go forward with this ticker (at least in Debian unstable it will be working) - but we will want a test to check that Singular docs work out of the box.
On a working system

```
# echo "help;" | Singular | grep error
```

does not return anything. On a broken one, one sees

```
# echo "help;" | Singular | grep error
   ? No functioning help browser available.
   ? error occurred in or before STDIN line 1: `help;`
```



---

Comment by dimpase created at 2022-02-13 08:49:57

Replying to [comment:45 mkoeppe]:
> Replying to [comment:42 git]:
> > Branch pushed to git repo; I updated commit sha1. New commits:
> > ||[cb82ed0](https://git.sagemath.org/sage.git/commit/?id=cb82ed03d722e8e1e1a8fb6e8a0320c28f8a3ea7)||`make singular.hlp known to Sage for Debian Singular`||
> 
> I don't think we should have this in our code

indeed, I'll remove it.


---

Comment by git created at 2022-02-13 10:15:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2022-02-13 10:18:08

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2022-02-13 10:18:08

this should pick up system Singular on Debian/bookworm and sid.
(and reject broken one on Jammy)


---

Comment by dimpase created at 2022-02-13 11:22:19

By the way, I see the same Jammy failure with singular-doc in Podman running on Fedora, as I see with Docker on macOS.
So it really points at a faulty image. Or it's fault in OS itself, for this one needs a non-!Docker/Podman test.


---

Comment by dimpase created at 2022-02-13 12:22:14

Everything is fine in Jammy run in an lxc container, so that's really !Docker/Podman.
I filed https://github.com/tianon/docker-brew-ubuntu-core/issues/230


---

Comment by dimpase created at 2022-02-13 20:13:57

I'm told it's Jammy Ubuntu feature, not a bug, here:
https://bugs.launchpad.net/ubuntu/+source/dpkg/+bug/1960749


---

Comment by mkoeppe created at 2022-02-13 20:27:19

Bizarre, so this means we need to add a test for the availability of the info file to `spkg-configure.m4`.


---

Comment by mkoeppe created at 2022-02-13 20:30:30

Oh, I see you already did this in 45f1b19


---

Comment by mkoeppe created at 2022-02-13 20:33:07

https://askubuntu.com/questions/1173337/how-to-prevent-system-from-being-minimized


---

Comment by mkoeppe created at 2022-02-13 20:35:03

We can certainly add this step to `build/bin/write-dockerfile.sh` for Debian/Ubuntu


---

Comment by mkoeppe created at 2022-02-13 20:46:32

Using their `unminimize` command, I see

```
Reinstalling packages with system documentation in /usr/share/doc/ ..
dpkg-query: error: --search needs at least one file name pattern argument

Use --help for help about querying packages.
```

Clearly commercial-grade work there


---

Comment by dimpase created at 2022-02-13 21:13:51

It might be quicker just to remove the `exclude` policy - this won't trigger reinstallation of all the packages already there. 
----
New commits:


---

Comment by mkoeppe created at 2022-02-13 21:29:07

Fine with me, go ahead


---

Comment by dimpase created at 2022-02-14 10:49:44

Replying to [comment:69 mkoeppe]:
> Fine with me, go ahead
Your branch is actually good (I was worried that images will get much bigger, but I haven't noticed this at all).
What worries me is what happens if `unminimize` is not even present, wouldn't it trigger an error?


---

Comment by dimpase created at 2022-02-14 10:59:55

OK, it's ignored if missing. No problem then.
I actually tested this branch in a Ubuntu Jammy Docker, all good (with system Singular).


---

Comment by dimpase created at 2022-02-14 11:13:17

Replying to [comment:66 mkoeppe]:
> Clearly commercial-grade work there

I heard stories from a long-term Canonical insider, such as : "Boss: We're closing down project X, you're fired. 
Programmer: But, but, I'm also doing projects Y, Z, ...?! Boss: Uhm, OK. You can stay then."


---

Comment by mkoeppe created at 2022-02-14 22:26:32

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2022-02-15 07:51:50

Thanks!


---

Comment by vbraun created at 2022-02-20 13:27:51

Resolution: fixed
