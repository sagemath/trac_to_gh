# Issue 22565: Symbolic to  SymPy convertion for generic function

Issue created by migration from https://trac.sagemath.org/ticket/22802

Original creator: mmancini

Original creation time: 2017-04-13 09:40:37

CC:  egourgoulhon rws

Keywords: sympy

Implement generic function coversion from Symbolic to SymPy



```
sage: a = function('A')(x,y)

sage: type(A)
<class 'sage.symbolic.function_factory.NewSymbolicFunction'>

sage: type(a)
<type 'sage.symbolic.expression.Expression'>

sage: a._sympy_()
---------------------------------------------------------------------------
NotImplementedError                       Traceback (most recent call last)
<ipython-input-101-eeb95aeda6e6> in <module>()
----> 1 a._sympy_()

```




---

Comment by mmancini created at 2017-04-13 12:32:12

New commits:


---

Comment by git created at 2017-04-13 12:56:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-04-14 14:22:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-06-08 22:45:11

Is this ready for review (other than removing the commented out debugging code)?


---

Comment by mmancini created at 2017-06-09 08:34:13

No, the work is still not finished : composed functions are not coverted.


---

Comment by mmancini created at 2017-06-28 11:00:30

The inverse transformation was submitted to sympy in the pull request:

"sympy to sage conversion : Abstract function."
https://github.com/sympy/sympy/pull/12826


---

Comment by mforets created at 2017-07-01 06:41:01

`@`mmancini: Thanks for the link to that sympy's thread, this is good news! how is that patch incorporated into 'sage's sympy'?

Please note that there is i think some conflict of commit ff2c44d here, with the branch in #20204.


---

Comment by rws created at 2017-07-01 06:55:32

We can do either a patch ticket (i.e., adding it to `build/pkgs/sympy/patches/`) or wait for SymPy to accept the PR, then do an upgrade ticket here.


---

Comment by mmancini created at 2017-07-12 13:47:22

The PR on sympy si passed , I added tests and resolved some problems.
Add the page will be a great thing but I don't know if it is necessary for the moment.

Concerning the conflicts with #20204 : I did not see this ticket before, but yes, some problems could arrive.


---

Comment by git created at 2017-07-18 14:21:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-07-18 19:38:05

Changing status from new to needs_review.


---

Comment by mmancini created at 2017-07-18 19:38:05

The conversion of generic functions (also derivatives and composed functions) between sage and sympy works fine.
For the full operabilty changes in sympy (https://github.com/sympy/sympy/pull/12826) are needed


---

Comment by tscrim created at 2017-07-18 23:55:50

If you need upstream changes, you will have to add the corresponding patch to our version of sympy. For better granularity, it might be better to do the patching on a separate ticket.


---

Comment by mmancini created at 2017-07-19 05:36:53

How can I patch the sage version of sympy it is not versioned in git. Have you some doc?


---

Comment by tscrim created at 2017-07-19 11:35:57

You create a patch from the git commit. I think the command is something like `git diff -p <commit>`, but it should be easy enough to find examples via Google. From there, you simply add the patch to the `$SAGE_ROOT/build/pkgs/sympy/patches` folder, bump the corresponding `package-version.txt` to `1.0.p3`, and commit. To test, you should simply need to run `make build` and then test as usual.


---

Comment by git created at 2017-07-20 11:29:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-07-20 11:39:03

Hello,
I don't know if the procedure is correct:
in $SYMPY 

```
git diff -p 6929ca35a33ba7813cd6d5828d96bc339ea06cb6 > 02_undeffun_sage.patch
```

then 


```
mv 02_undeffun_sage.patch $SAGE_ROOT/build/pkgs/sympy/patches/
cat 1.0.p2 > $SAGE_ROOT/build/pkgs/sympy/package-version.txt
```


The test are ok. 
I had to modify again sympy : now if the function is known in sympy (like fresneln in calculus.py tests) but not in sage, then the `AttributeError` is raised from sympy and catched in sage as before.


---

Comment by tscrim created at 2017-07-20 13:34:05

It looks okay to me, but I would prefer the sympy patch to go on a separate ticket that this ticket will then depend on. You can just cherry-pick (and squash if desired) your last two commits into a new branch and then merge that branch into this one here.


---

Comment by mmancini created at 2017-07-20 20:03:53

Changes done as required.
I hope it is ok.


---

Comment by tscrim created at 2017-07-24 00:06:14

LGTM (with manually increased my sympy patch level for testing, but that is a change that needs to be done on #23496).


---

Comment by tscrim created at 2017-07-24 00:06:14

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-07-26 12:05:41

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-07-26 12:05:41

Changing status from positive_review to needs_review.


---

Comment by git created at 2017-07-31 02:57:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-07-31 02:58:38

Just a merge in of the latest #23496. Tests still pass, LGTM, thanks.


---

Comment by tscrim created at 2017-07-31 02:58:38

Changing status from needs_review to positive_review.


---

Comment by mforets created at 2017-08-30 20:04:40

Changing status from positive_review to needs_work.


---

Comment by mforets created at 2017-08-30 20:04:40

while this is "on-hold", could `derivative` be revised? the docstring has some defects right now:

- no `INPUT`
- extra spaces that are not conventional in sage library code
- what is `convertion ::` ?

and why should the debug lines `# print(...)` be kept?


---

Comment by git created at 2017-08-31 09:22:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-09-04 08:52:51

Changed name because typo error


---

Comment by mmancini created at 2017-09-04 08:54:26

Last 10 new commits:


---

Comment by git created at 2017-09-04 09:01:23

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mmancini created at 2017-09-04 09:02:39

The name of the branch was corrected


---

Comment by mmancini created at 2017-09-05 09:00:53

Changing status from needs_work to needs_review.


---

Comment by mforets created at 2017-09-05 09:07:16

could you please merge again with #23496 ? i haven't checked in detail, but there seem to be differences in the `composition` function,

https://git.sagemath.org/sage.git/diff?id=eedf6da36d74e1dd3cc996201a4160d101c3b0a6

and

https://git.sagemath.org/sage.git/diff?id2=037272ccbac814ddcacd7f0df60cc68d357d3fa0&id=bc21300122019b04a30dba02aaa2cd728ff7453f

of course in case of conflict we want to keep the changes introduced by #23496.


---

Comment by git created at 2017-09-05 11:15:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-07 00:46:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-09-07 00:56:53

I did some trivial reviewer changes, but I am getting the same two real failures as on the patchbot:

```
sage -t src/sage/symbolic/expression_conversions.py
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 792, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy = df_sage._sympy_(); df_sympy
Exception raised:
    Traceback (most recent call last):
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[4]>", line 1, in <module>
        df_sympy = df_sage._sympy_(); df_sympy
      File "sage/symbolic/expression.pyx", line 1445, in sage.symbolic.expression.Expression._sympy_ (/home/travis/sage-build/src/build/cythonized/sage/symbolic/expression.cpp:11785)
        return sympy(self)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 222, in __call__
        return self.derivative(ex, operator)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/symbolic/expression_conversions.py", line 815, in derivative
        return f_sympy.diff(*sympy_arg)
    AttributeError: 'NoneType' object has no attribute 'diff'
**********************************************************************
File "src/sage/symbolic/expression_conversions.py", line 794, in sage.symbolic.expression_conversions.SympyConverter.derivative
Failed example:
    df_sympy == f_sympy.diff(x, 2, y, 1)
Exception raised:
    Traceback (most recent call last):
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression_conversions.SympyConverter.derivative[5]>", line 1, in <module>
        df_sympy == f_sympy.diff(x, Integer(2), y, Integer(1))
    NameError: name 'df_sympy' is not defined
**********************************************************************
1 item had failures:
   2 of   7 in sage.symbolic.expression_conversions.SympyConverter.derivative
    [489 tests, 2 failures, 2.37 s]
----------------------------------------------------------------------
sage -t src/sage/symbolic/expression_conversions.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by tscrim created at 2017-09-07 00:56:53

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-09-07 14:19:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-09-07 15:39:37

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-09-08 22:30:44

I do not get any of the errors reported by the patchbot. Positive review.


---

Comment by tscrim created at 2017-09-08 22:30:44

Changing status from needs_review to positive_review.


---

Comment by mforets created at 2017-09-09 07:16:57

there is at least a merge conflict with its dependency, introduced in ​5a53e12


---

Comment by tscrim created at 2017-09-09 14:43:25

This is already based on the branch on #23496.


---

Comment by mforets created at 2017-09-09 15:12:09

the branches do have different code for `composition` (since commit ​5a53e12 came after the merge). 

anyway, sorry for my confusion. i didn't realize that it will just overwrite the code in the dependency, but without merge conflict,


```
$ git checkout t/22802/public/22802_sympy_abstract_function
Switched to branch 't/22802/public/22802_sympy_abstract_function'
Your branch is up-to-date with 'trac/public/22802_sympy_abstract_function'.
$ git merge t/23496/public/23496_patch_sympy_abstract_function
Already up-to-date. 
```



---

Comment by mmancini created at 2017-09-09 15:30:39

I had remove the changes in composition because it caused problems in this branch and it was not influent in #23496


---

Comment by vbraun created at 2017-09-10 22:05:42

Resolution: fixed
