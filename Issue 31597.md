# Issue 31597: Make Hrepresentation of `CombinatorialPolyhedron` bit more consistent

Issue created by migration from https://trac.sagemath.org/ticket/31834

Original creator: @kliem

Original creation time: 2021-05-18 07:44:29

CC:  yzh

From #29683.

We change name `equalities` to `equations`, which is mostly used for internals and documentation.

We have the equation always last.

We make `CombinatorialFace.ambient_H_indices`, `CombinatorialFace.ambient_Hrepresentation` and `CombinatorialFace.n_ambient_Hrepresentation` consistent.


---

Comment by @kliem created at 2021-05-18 08:07:17

New commits:


---

Comment by git created at 2021-05-18 10:42:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-18 10:43:01

Changing keywords from "" to "Hrepresentation, combinatorial polyhedron".


---

Comment by @kliem created at 2021-05-18 10:43:01

Changing status from new to needs_review.


---

Comment by yzh created at 2021-05-18 11:57:20

Looks great to me!

Some small suggestions:
- Doctests of `def ambient_H_indices(self, add_equations=True)`: It would be good to test with `add_equations=False` and `add_equations=True` on a polyhedron that has equation (e.g. on the first `P = polytopes.permutahedron(5)`). The second `P =polytopes.cyclic_polytope(4,6)` has no equation, so it doesn't show a difference. I'm also curious if `add_equations` always appends larger indices no matter the backend is `field` or `ppl`.
- `if add_equations and self._ambient_facets:` probably should be two if's, so that `not self._ambient_facets and add_equations and self._equations` does not result in `equations = ()`?
- Docstring of `Hrepr`: the description is unclear, but since it's deprecated, maybe it doesn't matter.


---

Comment by git created at 2021-05-18 12:39:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-18 12:42:48

Replying to [comment:4 yzh]:
> Looks great to me!
> 
> Some small suggestions:
> - Doctests of `def ambient_H_indices(self, add_equations=True)`: It would be good to test with `add_equations=False` and `add_equations=True` on a polyhedron that has equation (e.g. on the first `P = polytopes.permutahedron(5)`). The second `P =polytopes.cyclic_polytope(4,6)` has no equation, so it doesn't show a difference.
Fixed.
> I'm also curious if `add_equations` always appends larger indices no matter the backend is `field` or `ppl`.
Yes, why wouldn't it. It counts the number of facets and then appends indices. The equations are taken out of the Hrepresentation in `base.pyx`.
> - `if add_equations and self._ambient_facets:` probably should be two if's, so that `not self._ambient_facets and add_equations and self._equations` does not result in `equations = ()`?
Fixed.
> - Docstring of `Hrepr`: the description is unclear, but since it's deprecated, maybe it doesn't matter.
I really don't think it matters. It's deprecated for one hear already and has only been with us for one release total. Only there in case someone used it at some point.


---

Comment by yzh created at 2021-05-18 14:06:10

`ambient_H_indices`: 
 - Lines 684-685 with `add_equations=True`?
 - Might be good to move the block `Add the indices of the equation::` (Lines 677-685) to Line 660--, for clear comparison with the above?
 - Line 692 `cdef size_t n_facets, n_equations` is not used anymore. Remove it?

Everything else looks great to me.

Please feel free to set to Positive review once the Status badges becomes green.


---

Comment by git created at 2021-05-18 16:23:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-18 16:30:57

Thank you for the quick review.


---

Comment by @kliem created at 2021-05-18 19:29:08

Changing status from needs_review to positive_review.


---

Comment by yzh created at 2021-05-19 15:39:56

Changing status from positive_review to needs_work.


---

Comment by yzh created at 2021-05-19 15:43:56

While reviewing 29683, I notice that the order of H-indices are disturbed by `combinatorial_face_to_polyhedral_face` in some backends. The problem seems to be in `face.py` Lines 855-856:

```
H_indices = tuple(range(n_ieqs, n_ieqs + n_equations))
H_indices += tuple(x for x in combinatorial_face.ambient_H_indices(add_equations=False))
```

I think it should be 

```
H_indices = tuple(x for x in combinatorial_face.ambient_H_indices(add_equations=False))
H_indices += tuple(range(n_ieqs, n_ieqs + n_equations))
```



---

Comment by yzh created at 2021-05-19 15:47:59

Bug example:

```
sage: P = polytopes.permutahedron(3, backend='field')                                                      
sage: CP = CombinatorialPolyhedron(P)                                                                                                                                                       
sage: cf = next(CP.face_iter())                                                                            
sage: cf.ambient_H_indices()                                                                               
(5, 6)
sage: pf = combinatorial_face_to_polyhedral_face(P, cf)                                                    
sage: pf.ambient_H_indices()                                                                               
(6, 5)
```

The expected output is (5, 6)


---

Comment by git created at 2021-05-19 19:37:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-19 19:38:02

Changing status from needs_work to needs_review.


---

Comment by yzh created at 2021-05-19 19:44:07

Is `def _lrs_calculation(self, verbose=False, Vrep=True, goal='volume')` a replacement for `def _volume_lrs`? I don't quite get it.


---

Comment by yzh created at 2021-05-19 19:50:05

I meant, why is `_lrs_calculation` on this ticket?


---

Comment by @kliem created at 2021-05-19 19:50:51

It was an experimental thing. That's what you get, when you do `commit -am`. Sorry about that.


---

Comment by git created at 2021-05-19 19:54:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2021-05-19 19:54:53

Fixed.


---

Comment by yzh created at 2021-05-19 20:05:51

Waiting for the status badges to report green.


---

Comment by yzh created at 2021-05-19 20:05:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-06-07 21:49:02

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-06-07 21:49:02

Merge conflict


---

Comment by @kliem created at 2021-06-08 07:46:31

New commits:


---

Comment by @kliem created at 2021-06-08 07:46:31

Changing status from needs_work to positive_review.


---

Comment by @kliem created at 2021-06-08 07:46:53

Trivial merge conflict because of whitespaces in `polyhedron/base.py`, which were modified by a different ticket.


---

Comment by @kliem created at 2021-06-19 23:17:41

Changing status from positive_review to needs_review.


---

Comment by @kliem created at 2021-06-19 23:17:41

#31821 adds a new method `__eq__`, which needs to be fixed.
----
New commits:


---

Comment by mkoeppe created at 2021-06-22 00:48:08

Needs rebase


---

Comment by mkoeppe created at 2021-06-22 00:48:08

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-06-22 14:58:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-06-22 14:58:57

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-23 01:15:02

This was already positively reviewed. The current version works and LGTM.


---

Comment by mkoeppe created at 2021-06-23 01:15:02

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-06-23 11:38:19

Thank you.


---

Comment by vbraun created at 2021-06-29 23:08:36

Resolution: fixed
