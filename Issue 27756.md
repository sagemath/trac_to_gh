# Issue 27756: NormalFan: issue with inner and outer normal vectors

Issue created by migration from https://trac.sagemath.org/ticket/27993

Original creator: nailuj

Original creation time: 2019-06-14 14:46:58

CC:  jipilab

Keywords: NormalFan, polytope

As an example, create the polytope on p.193 of Ziegler's "Lectures on Polytopes" with its normal fan:

```
sage: V=[(-8,-4),(-8,6),(-4,-8),(0,-9),(0,6),(4,-8)]
sage: P=Polyhedron(V)
sage: L=LatticePolytope(V)
sage: FanP, FanL = NormalFan(P), NormalFan(L)
sage: FanP == FanL
True
```


The two fans are equal, but they are not the same as the one presented in Ziegler's book.
In fact, following to the definition there, `FanP` and `FanL` give the normal fan of `-P`.

The construction of `NormalFan(polytope)` uses the normal vectors of the facets, given by `polytope.facet_normals()` for a `LatticePolytope` 
or given by `ieq.A() for ieq in polytope.inequalities()` for a `Polyhedron`.
In both cases, the normal vectors obtained are directed towards the interior of the polytope. 
Therefore, the resulting fan differs from what would be obtained when using the outer normal vectors instead.

I propose to add to `NormalFan` an argument `direction` set to either `'outer'` or `'inner'` to determine which of the directions to use. 
In line with the definition in Ziegler's book, I would prefer to make `'outer'` the default choice.

Additionally, I propose to add in `sage.geometry.polyhedron.representation` a method `Inequality.outer_normal`.
This allows to obtain the outer normal vector without having to think about the appropriate sign of `Inequality.A()` whenever dealing with the facet inequalities of a polyhedron.


---

Comment by nailuj created at 2019-06-14 14:49:19

New commits:


---

Comment by nailuj created at 2019-06-14 14:49:19

Changing status from new to needs_info.


---

Comment by embray created at 2019-06-14 14:51:27

Sage 8.8 is to be released fairly soon so unless this is a blocker this should be moved to the next release.


---

Comment by novoselt created at 2019-06-14 16:03:50

I don't care much about adding `direction` argument, but I have **extremely strong objection** to making it the default. There was a reason why inner normals were used for many, many years (like since 2006) - it is consistent with the literature. I understand that some books/articles use the other way, but when neither way is exceptionally uncommon the default choice is pretty much random personal preference when you first create these classes and methods. Once they were created and used for a long time, there is absolutely no reason to change the default whatever it is.


---

Comment by jipilab created at 2019-06-15 09:28:44

Replying to [comment:4 novoselt]:
> I don't care much about adding `direction` argument, but I have **extremely strong objection** to making it the default. There was a reason why inner normals were used for many, many years (like since 2006) - it is consistent with the literature. I understand that some books/articles use the other way, but when neither way is exceptionally uncommon the default choice is pretty much random personal preference when you first create these classes and methods. Once they were created and used for a long time, there is absolutely no reason to change the default whatever it is.

+1

I would leave the default as it is and add the `direction` argument to allow to get the variant.


---

Comment by novoselt created at 2019-06-15 20:01:25

Actually, I think now it would be better to allow quick "direction flip" either on the polytope or the fan, i.e. make them support `-` operator, instead of making constructors more complicated.


---

Comment by jipilab created at 2019-06-15 23:15:22

Replying to [comment:6 novoselt]:
> Actually, I think now it would be better to allow quick "direction flip" either on the polytope or the fan, i.e. make them support `-` operator, instead of making constructors more complicated.

This seems to already be possible for `Polyhedron` objects:


```
sage: p = polytopes.regular_polygon(5)
sage: p.vertices()
(A vertex at (0.5877852522924731?, -0.8090169943749474?),
 A vertex at (0.9510565162951536?, 0.3090169943749474?),
 A vertex at (0, 1),
 A vertex at (-0.5877852522924731?, -0.8090169943749474?),
 A vertex at (-0.9510565162951536?, 0.3090169943749474?))
sage: (-p).vertices()
(A vertex at (-0.5877852522924731?, 0.8090169943749474?),
 A vertex at (-0.9510565162951536?, -0.3090169943749474?),
 A vertex at (0, -1),
 A vertex at (0.587785252292474?, 0.8090169943749474?),
 A vertex at (0.9510565162951536?, -0.3090169943749474?))
```


Or you have something else in mind?

Yes, I would use `NormalFan(-P)`  or `NormalFan(P)` depending on whether one wants the inner or outer. This seems like the easiest thing to do. One does not need to go into the `Polyhedron` constructor...


---

Comment by novoselt created at 2019-06-15 23:21:20

That's exactly what I meant. I think those who care about directions are likely to read the documentation and discover that these are inner normals. After that, if this is not the desired choice for the user, `NormalFan(-P)` seems easier and cleaner to use than `NormalFan(P, direction="outer")`.


---

Comment by jipilab created at 2019-07-17 11:27:49

Changing status from needs_info to needs_work.


---

Comment by jipilab created at 2019-07-17 11:27:49

Replying to [comment:8 novoselt]:
> That's exactly what I meant. I think those who care about directions are likely to read the documentation and discover that these are inner normals. After that, if this is not the desired choice for the user, `NormalFan(-P)` seems easier and cleaner to use than `NormalFan(P, direction="outer")`.

I believe that the proposed change would be in the method `.normal_fan()` of `Polyhedron` objects, and not at the level of `NormalFan`, for the reason you mention.

That said, I would change the description of the ticket as follows:

> I propose to add to `normal_fan` an argument direction set to either `'outer'` or `'inner'` to determine which of the directions to use. The default will stay inner in order to match the default of `NormalFan`.

Above I would keep the current default.

> Additionally, I propose to add in sage.geometry.polyhedron.representation a method Inequality.outer_normal. This allows to obtain the outer normal vector without having to think about the appropriate sign of Inequality.A() whenever dealing with the facet inequalities of a polyhedron. 

This is good to me.

Further, I would suggest to add 

> Use `NormalFan(-P)` to get the outer normal fan.

in the documentation of `NormalFan`.


---

Comment by git created at 2019-07-22 12:51:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-22 12:53:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nailuj created at 2019-07-22 13:15:16

Replying to [comment:9 jipilab]:
> Replying to [comment:8 novoselt]:
> > That's exactly what I meant. I think those who care about directions are likely to read the documentation and discover that these are inner normals. After that, if this is not the desired choice for the user, `NormalFan(-P)` seems easier and cleaner to use than `NormalFan(P, direction="outer")`.
> 
> I believe that the proposed change would be in the method `.normal_fan()` of `Polyhedron` objects, and not at the level of `NormalFan`, for the reason you mention.

Yes. I stumbled upon this inner-outer issue through `Polyhedron.normal_fan()`. This is why I added jipilab in CC in the first place, and this is where I should have proposed to make `'outer'` the default â€“ my bad. I'm fine with `'inner'` as default in both files. My main goal was easier access to outer normal fans, which is now available and explained in the docstrings.

> That said, I would change the description of the ticket as follows:
> 
> > I propose to add to `normal_fan` an argument direction set to either `'outer'` or `'inner'` to determine which of the directions to use. The default will stay inner in order to match the default of `NormalFan`.

Done.
 
> Further, I would suggest to add 
> 
> > Use `NormalFan(-P)` to get the outer normal fan.
> 
> in the documentation of `NormalFan`.

Done.


---

Comment by nailuj created at 2019-07-22 13:15:16

Changing status from needs_work to needs_review.


---

Comment by jipilab created at 2019-07-22 15:58:38

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2019-07-22 15:58:38

Changing keywords from "NormalFan, polytope" to "NormalFan, polytope, days100".


---

Comment by jipilab created at 2019-07-22 15:58:38

- The optional parameters should receive an appropriate doctest. For example:

   {{{
sage: p = polytopes.regular_polygon(4,base_ring=QQ).pyramid()
sage: inner_nf = p.normal_fan()
sage: inner_nf.rays()
N( 1,  0,  0),
N(-1,  1,  1),
N(-1,  1, -1),
N(-1, -1, -1),
N(-1, -1,  1)
in 3-d lattice N

sage: outer_nf = p.normal_fan(direction='outer')
sage: outer_nf.rays()
N(-1,  0,  0),
N( 1,  1, -1),
N( 1,  1,  1),
N( 1, -1,  1),
N( 1, -1, -1)
in 3-d lattice N
}}}

 - Further, it would be nice to disallow such things:

```
sage: outer_nf = p.normal_fan(direction='blabla')
```

   by checking that direction is one of the two allowed things (see the volume function for a similar handling).

 - Remove the space before the semi-colon in the docstring of `normal_fan`.


---

Comment by git created at 2019-07-23 07:59:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nailuj created at 2019-07-23 08:06:01

Changing status from needs_work to needs_review.


---

Comment by nailuj created at 2019-07-23 08:06:01

Replying to [comment:13 jipilab]:
> The optional parameters should receive an appropriate doctest. For example:
> 
>    {{{
> sage: p = polytopes.regular_polygon(4,base_ring=QQ).pyramid()
> sage: inner_nf = p.normal_fan()
> sage: inner_nf.rays()
> N( 1,  0,  0),
> N(-1,  1,  1),
> N(-1,  1, -1),
> N(-1, -1, -1),
> N(-1, -1,  1)
> in 3-d lattice N
> 
> sage: outer_nf = p.normal_fan(direction='outer')
> sage: outer_nf.rays()
> N(-1,  0,  0),
> N( 1,  1, -1),
> N( 1,  1,  1),
> N( 1, -1,  1),
> N( 1, -1, -1)
> in 3-d lattice N
> }}}
I added a 2-d example testing inner, outer, and an invalid direction.

> Further, it would be nice to disallow such things:
> {{{
> sage: outer_nf = p.normal_fan(direction='blabla')
> }}}
> by checking that direction is one of the two allowed things (see the volume function for a similar handling).
Done.
 
> Remove the space before the semi-colon in the docstring of `normal_fan`.
Done.


---

Comment by jipilab created at 2019-07-23 08:44:11

Great!

Could you do one change: the backtick in the error message should be a single quote.

I would also fix the title of the ticket and the description to reflect the actual changes involved.


---

Comment by git created at 2019-07-23 13:39:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nailuj created at 2019-07-23 13:59:59

Replying to [comment:16 jipilab]:
> Could you do one change: the backtick in the error message should be a single quote.
Done.

> I would also fix the title of the ticket and the description to reflect the actual changes involved.
Done.


---

Comment by jipilab created at 2019-07-23 20:30:39

The doctest still has backticks.


---

Comment by git created at 2019-07-24 06:18:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-07-24 09:53:44

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2019-07-24 09:53:44

ok, c'est correct


---

Comment by vbraun created at 2019-07-29 21:54:56

Resolution: fixed
