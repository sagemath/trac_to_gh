# Issue 28479: Construction of a vector frame from a family of vector fields

Issue created by migration from https://trac.sagemath.org/ticket/28716

Original creator: egourgoulhon

Original creation time: 2019-11-11 09:38:09

CC:  tscrim

Keywords: manifolds, vector_frame

This ticket introduces the keyword argument `from_family` to `DifferentiableManifold.vector_frame()` to allow for constructing a vector frame from a spanning family of linearly independent vector fields:

```
sage: M = Manifold(2, 'M')
sage: X.<x,y> = M.chart()
sage: e0 = M.vector_field(1+x^2, 1+y^2)
sage: e1 = M.vector_field(2, -x*y)
sage: e = M.vector_frame('e', from_family=(e0, e1)); e
Vector frame (M, (e_0,e_1))
sage: e[0].display()
e_0 = (x^2 + 1) d/dx + (y^2 + 1) d/dy
sage: e[1].display()
e_1 = 2 d/dx - x*y d/dy
sage: (e[0], e[1]) == (e0, e1)
True
```

Previously, the only way to introduce the vector frame `e` was to first introduce an automorphism relating the frame `(d/dx, d/dy)` to `(e0, e1)` and to pass this automorphism to `VectorFrame.new_frame()`:

```
sage: aut = M.automorphism_field()
sage: aut[:] = [[e0[0], e1[0]], [e0[1], e1[1]]]
sage: e = X.frame().new_frame(aut, 'e')
```

The introduction of `from_family` in `vector_frame()` simplifies this process.

*Implementation details:* such functionality already existed for bases of finite rank free modules; the relevant code is extracted from the method `FiniteRankFreeModule.basis()` and put into the new method `FreeModuleBasis._init_from_family()`, in order to be used in `DifferentiableManifold.vector_frame()` as well.


---

Comment by egourgoulhon created at 2019-11-11 09:39:57

New commits:


---

Comment by egourgoulhon created at 2019-11-11 09:41:31

Changing status from new to needs_review.


---

Comment by tscrim created at 2019-11-11 10:41:52

Do we need the optional parameter? Basically, can we just use the fact that a tuple/list is being given and then assume it is suppose to be a family of vector fields? If it has to be a keyword, I would change `from_family` to the more descriptive `from_vector_fields`.


---

Comment by @DeRhamSource created at 2019-11-11 12:22:07

This is a great idea and would be very useful for vector bundles, too. Sometimes I got really annoyed by this detour. Would you mind to adapt your code, if working, for vector bundles as-well?

By the way: We should combine vector bundles and the previous implementations really really soon (in this case inherit vector frames from local frames) otherwise things could get extremly messy.

Unfortunately, I am quite busy working at my master thesis right now. I can almost feel the deadline touching my skin. I promise to work on that as soon as I've gained some time back.

Even though I don't have the time now, I've opened the corresponding ticket #28718, just to keep this task in mind.


---

Comment by egourgoulhon created at 2019-11-11 17:10:54

Replying to [comment:4 tscrim]:

Thanks for your prompt feedback.
> Do we need the optional parameter? Basically, can we just use the fact that a tuple/list is being given and then assume it is suppose to be a family of vector fields? 

Good idea, this is much more user-friendly! I am on it...


---

Comment by egourgoulhon created at 2019-11-11 17:21:03

Replying to [comment:5 gh-DeRhamSource]:
> This is a great idea and would be very useful for vector bundles, too. Sometimes I got really annoyed by this detour. 

Yes, this should have been done sooner...

>Would you mind to adapt your code, if working, for vector bundles as-well?

OK, I'll try to do this (see below).

> By the way: We should combine vector bundles and the previous implementations really really soon (in this case inherit vector frames from local frames) otherwise things could get extremly messy.
> 

Yes, I agree. Note however that this ticket does not touch the class `VectorFrame`, only the user interface `DifferentiableManifold.vector_frame()`. I'll perform a similar change to the interfaces `TopologicalVectorBundle.local_frame()` and `TensorBundle.local_frame()`.

> Unfortunately, I am quite busy working at my master thesis right now. I can almost feel the deadline touching my skin. 

Good luck with your master thesis!

>I promise to work on that as soon as I've gained some time back.
> 
>Even though I don't have the time now, I've opened the corresponding ticket #28718, just to keep this task in mind.

Thanks.


---

Comment by git created at 2019-11-11 21:50:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-11-11 22:17:03

In the latest version (cf. comment:8 commits) 

- `vector_frame()` accepts a tuple/list of vector fields as a positional argument, the keyword argument `from_family` being suppressed, following the suggestion made in comment:4.
- The `ZeroDivisionError` that occurs if the vector fields are not linearly independent (the exception is raised when computing the inverse of the automorphism relating the new frame to a previous one) is cached with a proper error message.
- The documentation of the module `sage.manifolds.differentiable.vectorframe` has been updated to take into account the new functionality.
- `TensorBundle.local_frame()` has been updated to offer the same functionality, following comment:5.
- A `TODO` section has been added to `TopologicalVectorBundle.local_frame()` for implementing a similar functionality with local sections in the future.

I propose to stay here for this ticket, i.e. to let the modification of `TopologicalVectorBundle.local_frame()` to a future ticket (#28718 ?). This is mostly to avoid code duplication with `DifferentiableManifold.vector_frame()`, waiting for a clearer view of #28718. Besides, I will be extremely busy in the coming weeks and I would like very much the `vector_frame()` functionality introduced in the current ticket to make its way in Sage 9.0.


---

Comment by egourgoulhon created at 2019-11-17 10:10:22

Do you agree with the above changes (comment:9)?


---

Comment by @DeRhamSource created at 2019-11-17 13:44:37

Partially. Of course, we can postpone this to another ticket, preferrably to #28718. However, I think this fits in here perfectly well and enables the feature for vector bundles in Sage 9.0 without too much effort [1] as you already did it for the tensor bundle. But I have no strong opinion on that so just do as you prefer.

One personal reformulation:


```diff
-        any connection with previously defined vector frames or vector fields
-        (the connection can be performed later via the method
+        connecting it to previously defined vector frames or vector fields
+        (this can still be performed later via the method
```


[1] at least so far as I can see


---

Comment by git created at 2019-11-17 23:09:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-11-17 23:14:16

Replying to [comment:11 gh-DeRhamSource]:
> Partially. Of course, we can postpone this to another ticket, preferrably to #28718. However, I think this fits in here perfectly well and enables the feature for vector bundles in Sage 9.0 without too much effort [1] as you already did it for the tensor bundle.
OK I've done it in the above commit. I've also improved the catching of the error in case of linearly dependent elements.

> One personal reformulation:
> 
> {{{#!diff
> -        any connection with previously defined vector frames or vector fields
> -        (the connection can be performed later via the method
> +        connecting it to previously defined vector frames or vector fields
> +        (this can still be performed later via the method
> }}}

Done as well.


---

Comment by @DeRhamSource created at 2019-11-18 09:15:41

Thank you so much! I'll give it a further look this or tomorrow afternoon.

It seems, we are at beta6 now.


---

Comment by @DeRhamSource created at 2019-11-18 14:04:29

I gave it some short tests. This is a huge improvement for using frames! Thanks! :) 

Just a minor thing:


```diff
-          ``self`` (`n` being the dimension of ``self``) defining the local
+          ``self`` (`n` being the rank of ``self``) defining the local
```


Apart from that it looks fine to me. As soon as you merged the recent develop branch into this one and patchbot says "yes", I could give it a positive review. Travis?


---

Comment by git created at 2019-11-18 22:20:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2019-11-18 22:24:25

Replying to [comment:15 gh-DeRhamSource]:
> Just a minor thing:
> 
> {{{#!diff
> -          ``self`` (`n` being the dimension of ``self``) defining the local
> +          ``self`` (`n` being the rank of ``self``) defining the local
> }}}

Thanks for pointing this; it is corrected in the above commit.


---

Comment by @DeRhamSource created at 2019-11-19 12:28:20

There is one thing I'm not sure about. Namely the line:



```
            mat = [[c[[i]] for c in comps] for i in fmodule.irange()]
            aut.add_comp(basis)[:] = mat
   this --> aut.add_comp(self)[:] = mat
            fmodule.set_change_of_basis(basis, self, aut)
```

in `free_module_basis.py`.

Shouldn't it be the identity matrix with respect to that basis? Or did I get something wrong?


---

Comment by egourgoulhon created at 2019-11-19 14:00:28

Replying to [comment:18 gh-DeRhamSource]:
> There is one thing I'm not sure about. Namely the line:
> 
> 
> {{{
>             mat = [This is the Trac macro *c[[i* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#c[[i-macro) for c in comps] for i in fmodule.irange()]
>             aut.add_comp(basis)[:] = mat
>    this --> aut.add_comp(self)[:] = mat
>             fmodule.set_change_of_basis(basis, self, aut)
> }}}
> in `free_module_basis.py`.
> 
> Shouldn't it be the identity matrix with respect to that basis? Or did I get something wrong?

The formula is correct: it should not be the identity matrix but the matrix of the change-of-basis automorphism, which has the same expression in both bases.


---

Comment by @DeRhamSource created at 2019-11-19 15:18:55

Replying to [comment:19 egourgoulhon]:
> The formula is correct: it should not be the identity matrix but the matrix of the change-of-basis automorphism, which has the same expression in both bases.

Yeah, you're absolutely right. I thought it through once again and come to the same conclusion now. Furthermore, some tests on this did work properly. Sorry!

So from my perspective, everything is fine. I'll give it a positive review.


---

Comment by @DeRhamSource created at 2019-11-19 15:18:55

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2019-11-19 15:50:02

Thank you for the review!


---

Comment by vbraun created at 2019-11-27 00:31:55

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-11-27 00:31:55

Merge conflict


---

Comment by egourgoulhon created at 2019-11-27 20:02:19

Replying to [comment:22 vbraun]:
> Merge conflict

There is no conflict with the just released 9.0.beta7. Is it a conflict with #27784 (which is not merged yet)?


---

Comment by @DeRhamSource created at 2019-11-28 08:51:36

Replying to [comment:23 egourgoulhon]:
> Replying to [comment:22 vbraun]:
> > Merge conflict
> 
> There is no conflict with the just released 9.0.beta7. Is it a conflict with #27784 (which is not merged yet)?

Not sure. But to run some tests for my thesis, I merged these two tickets and a conflict occured. Just a very minor thing about lines if I remember correctly.

However, either ticket needs to be merged to be certain.


---

Comment by egourgoulhon created at 2019-11-28 09:45:20

Replying to [comment:24 gh-DeRhamSource]:
> Replying to [comment:23 egourgoulhon]:
> > Replying to [comment:22 vbraun]:
> > > Merge conflict
> > 
> > There is no conflict with the just released 9.0.beta7. Is it a conflict with #27784 (which is not merged yet)?
> 
> Not sure. But to run some tests for my thesis, I merged these two tickets and a conflict occured. Just a very minor thing about lines if I remember correctly.

Yes most of the time these conflicts due to various developments performed in parallel are very minor and easy to solve. 
> 
> However, either ticket needs to be merged to be certain. 

Yes. I am afraid we have to wait for the next beta to solve this...


---

Comment by tscrim created at 2019-11-28 10:27:46

Since you basically know what ticket, I would just merge that in and set this back to positive review with that as a dependency.


---

Comment by @DeRhamSource created at 2019-11-28 10:32:54

Replying to [comment:26 tscrim]:
> Since you basically know what ticket, I would just merge that in and set this back to positive review with that as a dependency. 

Good idea. I'll do that for #27784. I need to add a minor thing into the documentation of characteristic classes anyway.


---

Comment by @DeRhamSource created at 2019-11-28 11:32:03

Replying to [comment:27 gh-DeRhamSource]:
> Replying to [comment:26 tscrim]:
> > Since you basically know what ticket, I would just merge that in and set this back to positive review with that as a dependency. 
> 
> Good idea. I'll do that for #27784. I need to add a minor thing into the documentation of characteristic classes anyway.

Done.


---

Comment by egourgoulhon created at 2019-11-28 12:13:12

Replying to [comment:28 gh-DeRhamSource]:
> Replying to [comment:27 gh-DeRhamSource]:
> > Replying to [comment:26 tscrim]:
> > > Since you basically know what ticket, I would just merge that in and set this back to positive review with that as a dependency. 
> > 
> > Good idea. I'll do that for #27784. I need to add a minor thing into the documentation of characteristic classes anyway.
> 
> Done.

Thanks!

I am then setting this ticket back to positive review and will have a look at #27784.


---

Comment by egourgoulhon created at 2019-11-28 12:14:11

Changing status from needs_work to positive_review.


---

Comment by egourgoulhon created at 2019-11-28 12:14:11

According to comment:29.


---

Comment by vbraun created at 2019-11-30 13:36:31

Resolution: fixed
