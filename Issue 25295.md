# Issue 25295: Upgrade to NTL 11.1.0

Issue created by migration from Trac.

Original creator: slelievre

Original creation time: 2018-06-07 18:15:59

CC:  fbissey @timokau infinity0 jdemeyer jpflori leif saraedum slelievre thansen tscrim vbraun

- Download page: http://www.shoup.net/ntl/download.html
- Tarball: http://www.shoup.net/ntl/ntl-11.1.0.tar.gz


---

Comment by @timokau created at 2018-07-09 22:25:29

NTL compiles with `-std=c++11` from 11.0 upwards. Apparently it is possible to compile with older c standards, but that loses thread safety.

I've added a work in progress PR that also updates the C standard for flint (necessary, see https://github.com/wbhart/flint2/issues/487). However sagelib won't build because lcalc still compiles with gnu++98 (#23341).
----
New commits:


---

Comment by git created at 2018-07-09 22:27:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @timokau created at 2018-07-09 22:28:00

It is not necessary to explicitly set `-std` for flint, instead this relies on the compiler default (which certainly is >=11 now).
----
New commits:


---

Comment by jdemeyer created at 2018-07-09 22:30:34

Add a `#` in front of ticket numbers.


---

Comment by jdemeyer created at 2018-07-09 22:31:16

Why does this depend on #23341? How is lcalc related to NTL?


---

Comment by arojas created at 2018-07-10 06:33:38

ntl 11 uses c++11, so "distutils: extra_compile_args = -std=gnu++98" has to be removed from sage/libs/lcalc/lcalc_Lfunction (which depends on both ntl and lcalc), so lcalc headers need to be c++11 compliant.

FWIW, I've already bumped ntl on Arch, and it mostly works fine in practice. The main issue is that it seems to bail out on some degenerate input, eg


```
> sage -t sage/matrix/matrix_integer_dense.pyx

[...]

sage: matrix(ZZ,3,[1..9]).hermite_form(algorithm='ntl') ## line 1807 ##

halt 2

```



---

Comment by @timokau created at 2018-07-10 12:10:42

Gentoo also has already updated ntl and apparently applied some patches to fix issues. https://github.com/dimpase/lcalc/pull/1 applies similar patches and updates lcalc to latest master (long unmaintained). That seems ready to merge, but was apparently forgotten or something.


---

Comment by jdemeyer created at 2018-07-10 12:23:07

Replying to [comment:10 arojas]:
> sage/libs/lcalc/lcalc_Lfunction (which depends on both ntl and lcalc)

It technically "depends" on NTL but for no good reason.

If that's the only issue, untangling this dependency would be the easiest solution.


---

Comment by @timokau created at 2018-07-11 17:48:14

I'm not sure its the only issue, its just the first non-trivial one I encountered. `@`fbissey probably knows more about that as he apparently already has proper patches for gentoo.


---

Comment by fbissey created at 2018-07-12 01:28:09

Replying to [comment:13 gh-timokau]:
> I'm not sure its the only issue, its just the first non-trivial one I encountered. `@`fbissey probably knows more about that as he apparently already has proper patches for gentoo.

I'll confess that I am not sure what we are talking about here. Patch to `ntl` or to `sage`? At the moment I am using stock `ntl-10.5.0` from the gentoo tree that has no patch. I don't remember doing anything special to sage to use it. 
I have an ebuild for 11.1.0/11.2.0 in a private repository that again is not patched - the only thing to be careful of is that to enable threads in `ntl` you need at least `gf2x-1.2`.


---

Comment by @timokau created at 2018-07-12 10:42:48

Oh I just assumed that you used ntl 11 with sage because you mentioned in https://github.com/dimpase/lcalc/pull/1 that you patched your lcalc for c++11 support.


---

Comment by fbissey created at 2018-07-12 10:46:59

Replying to [comment:15 gh-timokau]:
> Oh I just assumed that you used ntl 11 with sage because you mentioned in https://github.com/dimpase/lcalc/pull/1 that you patched your lcalc for c++11 support.

I seriously need to check to see if I use C++11 with lcalc. I have a good memory but not that good.


---

Comment by fbissey created at 2018-07-12 10:55:17

OK I patch enough that it compile out of the box with g++-7.3.0 without passing a `-std=c++...` flag so I am guessing I get gnu++11 at the least. Lots of warnings that stuff is deprecated or forbidden, but g++ takes it. clang++, on the other hand, breaks

```
fatal error: 'bits/c++config.h' file not found
```

Of course no one should use those kinds of headers in the first place. I am sure it is fixed in the pull request you are quoting at least.


---

Comment by fbissey created at 2018-07-12 10:56:03

But really we should talk about lcalc in another ticket.


---

Comment by @timokau created at 2018-07-12 11:28:24

Yes, that would be #23341. Apparently the work is pretty much done but there is some small regression (?) nobody felt qualified to make a judgement about yet.

More relevant to the discussion in this ticket would be the approach `@`jdmeyer suggested (to "just" remove the dependency).


---

Comment by @timokau created at 2018-07-17 15:24:05

When I tried to update to the last version before 11.0 (10.5.0) I got an interesting error:


```
File "/nix/store/lv32600c4zla3ldyd0l2sz7sr5y6bhkp-sage-src-8.2/src/sage/misc/trace.py", line 67, in sage.misc.trace.trace
Failed example:
    print(s.before[s.before.find('--'):])
Expected:
    --...
    ipdb> c
    2 * 5
Got:
    --Call--
    > <CSI-0;32m>/nix/store/bs9cxmkyslmnizh9gl7gj4
```


10.4.0 is the last version that works without any changes.


---

Comment by fbissey created at 2018-07-17 20:17:22

Replying to [comment:21 gh-timokau]:
> When I tried to update to the last version before 11.0 (10.5.0) I got an interesting error:
> 
> {{{
> File "/nix/store/lv32600c4zla3ldyd0l2sz7sr5y6bhkp-sage-src-8.2/src/sage/misc/trace.py", line 67, in sage.misc.trace.trace
> Failed example:
>     print(s.before[s.before.find('--'):])
> Expected:
>     --...
>     ipdb> c
>     2 * 5
> Got:
>     --Call--
>     > <CSI-0;32m>/nix/store/bs9cxmkyslmnizh9gl7gj4
> }}}
> 
> 10.4.0 is the last version that works without any changes.

I am currently on 10.5.0 in gentoo, how do you get that problem?


---

Comment by @timokau created at 2018-07-18 12:17:26

Huh. I tried to reproduce it to be sure, but I couldn't. If I remember correctly the time it occured I only changed the ntl version. Maybe I changed something else too and forgot it, maybe its a transient failure. I'll see if it occurs again some time.

Thanks for telling me.


---

Comment by arojas created at 2018-07-24 19:43:17

Replying to [comment:10 arojas]:
> FWIW, I've already bumped ntl on Arch, and it mostly works fine in practice. The main issue is that it seems to bail out on some degenerate input, eg
> 
> {{{
> > sage -t sage/matrix/matrix_integer_dense.pyx
> 
> [...]
> 
> sage: matrix(ZZ,3,[1..9]).hermite_form(algorithm='ntl') ## line 1807 ##
> 
> halt 2
> 
> }}}

Scratch that: this is (surprisingly) caused by the Singular 4.1.1 upgrade, not by the NTL one.


---

Comment by @timokau created at 2018-07-24 22:02:09

How did you get sage to build with ntl >= 11? Did you patch lcalc? Any other patches necessary?


---

Comment by arojas created at 2018-07-24 22:14:41

Replying to [comment:25 gh-timokau]:
> How did you get sage to build with ntl >= 11? Did you patch lcalc? Any other patches necessary?

Apply the patch from #23341 to lcalc and

https://git.archlinux.org/svntogit/community.git/tree/trunk/sagemath-lcalc-c++11.patch?h=packages/sagemath


---

Comment by @timokau created at 2018-07-25 12:56:46

I tried to untangle the (apparently unnecessary) `lcalc <- ntl` dependency. I failed. NTL apparently gets added to the `inclue_dirs` of pretty much every sage extension, including lcalc. That is even after I (as an experiment)

- removed `ntl` from `cython.py`s `standard_libs`
- removed `ntl` from `setup.py`s `lib_headers`

I couldn't figure out why `ntl` was still added. Jeroen, do you know why?


---

Comment by slelievre created at 2018-10-21 11:02:06

[NTL 11.3.1 was released.](https://www.shoup.net/ntl/doc/tour-changes.html)


---

Comment by slelievre created at 2018-10-21 11:02:06

Changing keywords from "" to "upgrade, ntl".


---

Comment by @timokau created at 2018-10-21 11:34:42

For what its worth I have since also adopted [this archlinux patch](https://git.archlinux.org/svntogit/community.git/plain/trunk/sagemath-lcalc-c++11.patch?h=packages/sagemath&id=0e31ae526ab7c6b5c0bfacb3f8b1c4fd490035aa) (thanks Antonio!) and haven't seen any issues.


---

Comment by slelievre created at 2018-11-16 12:08:51

NTL 11.3.2 was released, as [announced on sage-devel](https://groups.google.com/d/topic/sage-devel/QIwZE5YawmA/discussion).


---

Comment by git created at 2018-11-22 04:46:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-11-22 04:48:07

New commits:


---

Comment by fbissey created at 2018-11-23 01:07:15

Changing status from new to needs_review.


---

Comment by jpflori created at 2018-11-23 09:13:14

I've not tested it (with or without the specific hunk) but is the flint `export CFLAGS` hunk necessary?
Didn't we pass `CFLAGS` to flint before?


---

Comment by fbissey created at 2018-11-23 09:21:44

Replying to [comment:36 jpflori]:
> I've not tested it (with or without the specific hunk) but is the flint `export CFLAGS` hunk necessary?
> Didn't we pass `CFLAGS` to flint before?

I am not sure what motivated that. `@`Timo can you comment here?

In any case there is an `export CFLAGS` in the conditional for debugging and one outside. We could just keep the one outside. 

Could it be that it was meant for `CXXFLAGS` instead and add `-std=c++11` there? There is a single object built with C++ in flint, the ntl interface. I cannot test that theory because I don't have a compiler old enough that would default to something lower than c++11.


---

Comment by dimpase created at 2018-11-23 09:56:45

I have a weird problem building this NTL with clang on FreeBSD. It keeps telling me that it is g++, and bails out with some weird error. Could you try clang on another platform?


---

Comment by fbissey created at 2018-11-23 10:02:21

Replying to [comment:38 dimpase]:
> I have a weird problem building this NTL with clang on FreeBSD. It keeps telling me that it is g++, and bails out with some weird error. Could you try clang on another platform?

Works as expected with clang+linux.  More details please.


---

Comment by jpflori created at 2018-11-23 10:11:11

Looks ok on macos without `gf2x` and outside of Sage.
`configure` knows `g++`  is `clang` and `make` calls `g++` but finishes ok.


---

Comment by dimpase created at 2018-11-23 10:13:42

Running manually at `sage -sh` prompt:
to start with:

```
$ CC=clang CXX=clang++ ./configure
compiler_name=gcc
language_standard=2014
cpu_type=x86

setting TUNE=x86

*** checking -pthread flag
   CXXAUTOFLAGS=" -pthread"
   -pthread works
*** checking -march=native flag
   CXXAUTOFLAGS=" -pthread -march=native"
   -march=native works
*** checking -ffp-contract=off flag
   -ffp-contract=off works
*** threads are OK 

CXXAUTOFLAGS=" -pthread -march=native"
NOCONTRACT="-ffp-contract=off -DNTL_CONTRACTION_FIXED"

generated makefile
generated ../include/NTL/config.h
generated ../include/NTL/ConfigLog.h
```


why `gcc`? and why `x86`, not `x86_64`? Then,

```
$ gmake
make clobber
rm -f ntl.a mach_desc.h ../include/NTL/mach_desc.h  GetTime.cpp GetPID.cpp
sh ResetFeatures '..' "ALIGNED_ARRAY BUILTIN_CLZL LL_TYPE SSSE3 AVX PCLMUL AVX2 FMA AVX512F  COPY_TRAITS1 COPY_TRAITS2 CHRONO_TIME MACOS_TIME POSIX_TIME"
rm -f ../include/NTL/gmp_aux.h
sh RemoveProg QuickTest ZZTest SSMulTest ZZ_pXTest lzz_pXTest BerlekampTest CanZassTest  ZZXFacTest MoreFacTest LLLTest   BitMatTest MatrixTest mat_lzz_pTest CharPolyTest RRTest QuadTest GF2XTest   GF2EXTest GF2EXGCDTest subset ZZ_pEXTest ZZ_pEXGCDTest lzz_pEXTest lzz_pEXGCDTest  Timing ThreadTest MakeDesc TestGetTime TestGetPID CheckFeatures CheckCompile GenConfigInfo CheckContract  CheckThreads gen_gmp_aux gf2x_version_1_2_or_later_required
rm -f *.o
rm -rf small
rm -f cfileout mfileout
rm -rf .libs *.lo libntl.la
rm -f setup-phase
make setup1
g++ -I../include -I.  -g -O2 -pthread -march=native  -c MakeDescAux.cpp
...
```


on FreeBSD g++ and clang++, or c++ are totally different beasts, and they can live together in the same PATH (but not in this case it seems)


---

Comment by dimpase created at 2018-11-23 10:22:53

Removing gcc/g++ results in

```
$ CC=clang CXX=clang++ ./configure
Compilation failed
See CompilerOutput.log for details
Goodbye! at DoConfig line 616.
$ CC=cc CXX=c++ ./configure
Compilation failed
See CompilerOutput.log for details
Goodbye! at DoConfig line 616.
$ cat CompilerOutput.log 
*** CompilerOutput.log ***
*** building GenConfigInfo
g++ -I../include -I.  -g -O2   -o  GenConfigInfo GenConfigInfo.cpp -lm
make: exec(g++) failed (No such file or directory)
*** Error code 1
...
```


That is, it only works with g++/gcc. A bug, I'd say. In `DoConfig`, on sees
`'CXX'         => 'g++'`  - I don't know Perl, but I gather it means that CXX is hardcoded to be `g++`.

It works with NTL 10, don't ask me how...


---

Comment by fbissey created at 2018-11-23 10:28:30

This is silly

```
$ CC=clang CXX=clang++ ./configure 
compiler_name=gcc
language_standard=2014
cpu_type=x86

setting TUNE=x86

*** checking -pthread flag
   CXXAUTOFLAGS=" -pthread"
   -pthread works
*** checking -march=native flag
   CXXAUTOFLAGS=" -pthread -march=native"
   -march=native works
*** checking -ffp-contract=off flag
   -ffp-contract=off works
*** threads are OK 

CXXAUTOFLAGS=" -pthread -march=native"
NOCONTRACT="-ffp-contract=off -DNTL_CONTRACTION_FIXED"

generated makefile
generated ../include/NTL/config.h
generated ../include/NTL/ConfigLog.h
```

but

```
$ ./configure CXX=clang++
compiler_name=clang
language_standard=2014
cpu_type=x86

setting TUNE=x86

*** checking -pthread flag
   CXXAUTOFLAGS=" -pthread"
   -pthread works
*** checking -march=native flag
   CXXAUTOFLAGS=" -pthread -march=native"
   -march=native works
*** threads are OK 

CXXAUTOFLAGS=" -pthread -march=native"
NOCONTRACT=""

generated makefile
generated ../include/NTL/config.h
generated ../include/NTL/ConfigLog.h
```



---

Comment by fbissey created at 2018-11-23 10:30:59

The thing is `CXX` is an option of the `DoConfig` script. It is not pulled from an environment variable.


---

Comment by dimpase created at 2018-11-23 10:53:33

Hmm, OK, over to Sage's installation. If I start as

```
$ MAKE="gmake -j8" gmake
```

NTL fails with the usual invitation to look in the following file for errors, and there I see

```
$ cat src/src/CompilerOutput.log 
*** CompilerOutput.log ***
*** building GenConfigInfo
make[4]: illegal argument to -j -- must be positive integer!
```

So it seems to assume something about $MAKE...

And if I start as

```
$ MAKE="gmake" gmake
```


I get even weirder

```
*** CompilerOutput.log ***
*** building GenConfigInfo
make[4]: don't know how to make w. Stop
...
```



---

Comment by dimpase created at 2018-11-23 11:11:09

OK, here is the fix:


```diff
diff --git a/build/pkgs/ntl/spkg-install b/build/pkgs/ntl/spkg-install
index 08fb2b148c..88ee9548ea 100644
--- a/build/pkgs/ntl/spkg-install
+++ b/build/pkgs/ntl/spkg-install
`@``@` -99,6 +99,7 `@``@` ntl_configure()
         LDFLAGS="$LDFLAGS" LIBTOOL_LINK_FLAGS="$LIBTOOL_LINK_FLAGS" \
         NTL_GMP_LIP=on NTL_GF2X_LIB=on \
         "$DISABLE_NATIVE" \
+        MAKE_PROG="$MAKE" \
         NTL_THREADS=off || sdh_die "Error configuring NTL."
 }
 
```

Could you add it to the branch?


---

Comment by fbissey created at 2018-11-23 11:18:07

I really need to go to bed now :( but this is a public branch, you are welcome to push to it. And well spotted.


---

Comment by git created at 2018-11-23 11:26:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2018-11-23 11:27:35

Changing status from needs_review to positive_review.


---

Comment by @timokau created at 2018-11-23 13:47:26

Replying to [comment:37 fbissey]:
> Replying to [comment:36 jpflori]:
> > I've not tested it (with or without the specific hunk) but is the flint `export CFLAGS` hunk necessary?
> > Didn't we pass `CFLAGS` to flint before?
> 
> I am not sure what motivated that. `@`Timo can you comment here?
> 
> In any case there is an `export CFLAGS` in the conditional for debugging and one outside. We could just keep the one outside. 
> 
> Could it be that it was meant for `CXXFLAGS` instead and add `-std=c++11` there? There is a single object built with C++ in flint, the ntl interface. I cannot test that theory because I don't have a compiler old enough that would default to something lower than c++11.

I don't remember my reasoning. Probably some leftover of trying to get it to work nicely with the old lcalc.

Thanks for getting this mergeable :)


---

Comment by vbraun created at 2018-11-24 13:30:02

This borks flint on some machines, i guess missing -std=c11 

```
make[7]: Leaving directory '/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p3/src/fq_zech_poly_factor'
if [ "1" -eq "1" ]; then \
  make build/interfaces/NTL-interface.lo; \
  g++   -shared -Wl,-soname,libflint.so.13 -Wl,-rpath,/home/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildbot/slave/sage_git/build/local/lib build/interfaces/NTL-interface.lo  build/printf.lo  build/fprintf.lo  build/sprintf.lo  build/scanf.lo  build/fscanf.lo  build/sscanf.lo  build/clz_tab.lo  build/memory_manager.lo  build/version.lo  build/profiler.lo  build/thread_support.lo  build/ulong_extras.lo  build/long_extras.lo  build/perm.lo  build/fmpz.lo  build/fmpz_vec.lo  build/fmpz_poly.lo  build/fmpq_poly.lo  build/fmpz_mat.lo  build/fmpz_lll.lo  build/mpfr_vec.lo  build/mpfr_mat.lo  build/mpf_vec.lo  build/mpf_mat.lo  build/nmod_vec.lo  build/nmod_poly.lo  build/nmod_poly_factor.lo  build/arith.lo  build/mpn_extras.lo  build/nmod_mat.lo  build/fmpq.lo  build/fmpq_vec.lo  build/fmpq_mat.lo  build/padic.lo  build/fmpz_poly_q.lo  build/fmpz_poly_mat.lo  build/nmod_poly_mat.lo  build/fmpz_mod_poly.lo  build/fmpz_mod_poly_factor.lo  build/fmpz_factor.lo  build/fmpz_poly_factor.lo  build/fft.lo  build/qsieve.lo  build/double_extras.lo  build/d_vec.lo  build/d_mat.lo  build/padic_poly.lo  build/padic_mat.lo  build/qadic.lo  build/fq.lo  build/fq_vec.lo  build/fq_mat.lo  build/fq_poly.lo  build/fq_poly_factor.lo  build/fq_nmod.lo  build/fq_nmod_vec.lo  build/fq_nmod_mat.lo  build/fq_nmod_poly.lo  build/fq_nmod_poly_factor.lo  build/fq_zech.lo  build/fq_zech_vec.lo  build/fq_zech_mat.lo  build/fq_zech_poly.lo  build/fq_zech_poly_factor.lo  -o libflint.so.13.5.2 -L/home/buildbot/slave/sage_git/build/local/lib -Wl,-rpath,/home/buildbot/slave/sage_git/build/local/lib  -L/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p3/src -L/home/buildbot/slave/sage_git/build/local/lib -L/home/buildbot/slave/sage_git/build/local/lib -L/home/buildbot/slave/sage_git/build/local/lib -lmpfr -lgmp -lm -lntl -lpthread ; \
fi
make[7]: Entering directory '/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p3/src'
g++ -fPIC  -I/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p3/src -I/home/buildbot/slave/sage_git/build/local/include -I/home/buildbot/slave/sage_git/build/local/include -I/home/buildbot/slave/sage_git/build/local/include -c interfaces/NTL-interface.cpp -o build/interfaces/NTL-interface.lo
In file included from /usr/include/c++/4.9/type_traits:35:0,
                 from /home/buildbot/slave/sage_git/build/local/include/NTL/tools.h:25,
                 from /home/buildbot/slave/sage_git/build/local/include/NTL/ZZ.h:19,
                 from interfaces/NTL-interface.cpp:32:
/usr/include/c++/4.9/bits/c++0x_warning.h:32:2: error: #error This file requires compiler and library support for the ISO C++ 2011 standard. This support is currently experimental, and must be enabled with the -std=c++11 or -std=gnu++11 compiler options.
 #error This file requires compiler and library support for the \
  ^
In file included from /home/buildbot/slave/sage_git/build/local/include/NTL/ZZ.h:19:0,
                 from interfaces/NTL-interface.cpp:32:
/home/buildbot/slave/sage_git/build/local/include/NTL/tools.h:1075:1: error: 'constexpr' does not name a type
 constexpr bool Relocate_aux_has_trivial_copy(T*)
 ^
/home/buildbot/slave/sage_git/build/local/include/NTL/tools.h:1075:1: note: C++11 'constexpr' only available with -std=c++11 or -std=gnu++11
/home/buildbot/slave/sage_git/build/local/include/NTL/tools.h:1083:1: error: 'constexpr' does not name a type
 constexpr bool Relocate_aux_has_any_copy(T*)
```



---

Comment by vbraun created at 2018-11-24 13:30:02

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-11-24 13:41:07

Also, how about setting -std=c11 globally (like LDFLAGS rpath) instead of a per-package whackamole...


---

Comment by dimpase created at 2018-11-24 16:27:10

Replying to [comment:52 vbraun]:
> Also, how about setting -std=c11 globally (like LDFLAGS rpath) instead of a per-package whackamole...

Do you mean `c++11` in `CXXFLAGS`? 

There are packages (brial is one case) needing `-std=gnu++11`.

But yes, it appears now that the compilers must be told to enforce `c++11` globally,
otherwise some compilers default to something else.

So it seems it cannot be just added, it needs to be a overwriteable per package default in `CXXFLAGS`...


---

Comment by fbissey created at 2018-11-24 19:13:48

To be honest I should have seen that coming and I should have acted in #25532#comment:37 .

Now for the idea to set std=c++11 globally by default. Well we have a variety of compilers out there defaulting to anything from pre-c++11 to c++14 and soon c++17. I don't think we should enforce going from c++14 to c++11 unless we have too. By the way brial compiles perfectly with gcc-8.2.0 which default to c++14 without having to add std=gnu++11.

In any case we can solve that at configure time with the appropriate macro (like brial does now) to check that the compiler support at least this standard and add the appropriate flag to CXXFLAGS if it doesn't.

I would like to finish this ticket as is and I'll note that since #23341 is merged distro are free to upgrade ntl and we do. This ticket is just about keeping up.

We should have a follow up ticket about minimal c++11 support and clean up for 8.6 in my opinion. This would a major feature and I don't want to start it now.


---

Comment by git created at 2018-11-24 20:58:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-11-24 21:02:04

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2018-11-24 21:02:04

To be more precise, we already check for support for C++11 but we don't enforce it if it isn't the default.

Back to positive review because I only made a trivial change.


---

Comment by dimpase created at 2018-11-24 21:44:02

it is not kosher to mix CXXFLAGS with CFLAGS. there are CFLAGS which a C++ compiler won’t take.


---

Comment by git created at 2018-11-24 21:46:19

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2018-11-24 21:46:19

Changing status from positive_review to needs_review.


---

Comment by fbissey created at 2018-11-24 21:47:29

Replying to [comment:57 dimpase]:
> it is not kosher to mix CXXFLAGS with CFLAGS. there are CFLAGS which a C++ compiler won’t take.
> 

Thank you for paying attention (very embarrassed).


---

Comment by dimpase created at 2018-11-24 22:00:37

NTL does depend on flint, but this is not reflected in `build/pkgs/ntl/dependencies`.
Should we fix this here too?

Also, I imagine CXXFLAGS of mpir/gmp and gf2x need attention too.


---

Comment by fbissey created at 2018-11-24 22:05:36

Replying to [comment:60 dimpase]:
> NTL does depend on flint, but this is not reflected in `build/pkgs/ntl/dependencies`.
> Should we fix this here too?
> 

you got that in reverse. flint depends on ntl, so if ntl uses c++11 so does the flint-ntl interface (there is a single C++ file in flint for this interface, the rest is all C).

> Also, I imagine CXXFLAGS of mpir/gmp and gf2x need attention too.

It doesn't currently have any impact, there seem to be some forward compatibility. flint and sage would require backward compatibility.


---

Comment by fbissey created at 2018-11-27 01:05:22

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-11-27 01:05:22

Didn't know that pushing to git makes the ticket go back to "need review". Nice behavior in fact.


---

Comment by vbraun created at 2018-11-28 19:20:43

I'm getting quite a lot of 

```
checking for NTL >= 5.0... not found
configure: WARNING: Unable to find NTL (which is strongly recommended) on your machine: please use --with-ntl=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
```

in Singular. Fun fact: This does not make the build fail, but causes tons of test failures..

Fails on Ubuntu 14, 16, and Debian 8. Works on Ubuntu 18, Debian 9, OSX. Idependent of 32 vs. 64 bit.


---

Comment by vbraun created at 2018-11-28 19:20:43

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2018-11-28 19:55:27

Replying to [comment:63 vbraun]:
> I'm getting quite a lot of 
> {{{
> checking for NTL >= 5.0... not found
> configure: WARNING: Unable to find NTL (which is strongly recommended) on your machine: please use --with-ntl=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
> }}}
> in Singular. Fun fact: This does not make the build fail, but causes tons of test failures..
> 
> Fails on Ubuntu 14, 16, and Debian 8. Works on Ubuntu 18, Debian 9, OSX. Idependent of 32 vs. 64 bit.

Right. That means we would need to make `-std=c++11` pervasive in singular as well and possibly all other dependencies of ntl that are not already switching c++11 in configure. So I think we should postpone this until we enforce c++11 across the board. I thought it would be easy but it is turning in a whack-a-mole kind of thing.


---

Comment by arojas created at 2018-11-28 20:05:34

Replying to [comment:64 fbissey]:

> Right. That means we would need to make `-std=c++11` pervasive in singular as well and possibly all other dependencies of ntl that are not already switching c++11 in configure. So I think we should postpone this until we enforce c++11 across the board. I thought it would be easy but it is turning in a whack-a-mole kind of thing.

Singular already does that itself in 4.1.1.p3


---

Comment by fbissey created at 2018-11-28 20:09:57

But we are stuck at 4.1.1.p2 here. Even if we finish the singular ticket, we may still have to look at giac which probably doesn't go c++11 by itself. eclib and linbox should be OK.


---

Comment by dimpase created at 2018-11-28 20:14:09

Replying to [comment:66 fbissey]:
> But we are stuck at 4.1.1.p2 here. Even if we finish the singular ticket, we may still have to look at giac which probably doesn't go c++11 by itself. eclib and linbox should be OK.

giac's upcoming version 1.5.0 should be compileable with c++11 - at least it does work with clang 6.0.1, which is quite picky, and I think enforces c++11 by default. See #26315.


---

Comment by fbissey created at 2018-11-28 20:18:54

1.4.9.xx compiles with gcc-8.2.0 which is c++14 by default, but of course that doesn't mean clang-6.0.1 (also c++14 I think) won't throw a fit at it. But here I suspect that Volker would find in his logs that giac got configured without ntl on those machines which may or may not cause more failures.


---

Comment by git created at 2018-12-05 21:22:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2018-12-05 21:24:28

Still depends on a good review of #26787 which needs a bit of testing on cygwin.


---

Comment by fbissey created at 2018-12-05 21:24:28

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-01-11 14:09:56

Can somebody either make this not depend on #26787 or add an explanation to #26787?


---

Comment by dimpase created at 2019-01-11 14:50:43

making it independent of #26787 needs passing `std=c++11` in CXXFLAGS...


---

Comment by embray created at 2019-01-15 18:15:21

Retarging tickets optimistically to the next milestone.  If you are responsible for this ticket (either its reporter or owner) and don't believe you are likely to complete this ticket before the next release (8.7) please retarget this ticket's milestone to sage-pending or sage-wishlist.


---

Comment by fbissey created at 2019-03-17 22:18:09

Forgot about this ticket. All the dependencies for this ticket have been cleared so it should go back to positive review.


---

Comment by fbissey created at 2019-03-17 22:18:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-03-24 09:41:26

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2019-03-24 09:41:26


```
/home/buildbot/slave/sage_git/build/local/include/NTL/vector.h:198:31: warning: unused variable 'do_BlockConstruct' [-Wunused-variable]
 { VecStrategy<NTL_RELOC_TAG>::do_BlockConstruct(p, n); }
                               ^~~~~~~~~~~~~~~~~
Makefile:275: recipe for target 'build/interfaces/NTL-interface.lo' failed
make[7]: *** [build/interfaces/NTL-interface.lo] Error 1
make[7]: Leaving directory '/home/buildbot/slave/sage_git/build/local/var/tmp/sage/build/flint-2.5.2.p3/src'
g++: error: build/interfaces/NTL-interface.lo: No such file or directory
Makefile:143: recipe for target 'libflint.so.13.5.2' failed
make[6]: *** [libflint.so.13.5.2] Error 1
```



---

Comment by fbissey created at 2019-03-24 09:45:43

More details please! Version of gcc involved and possibly distro, more logs from flint too. Because this a package upgrade we don't see anything on the patchbot :(


---

Comment by fbissey created at 2019-03-24 23:01:35

OK found the issue. We don't pass any `CFLAGS` or `CXXFLAGS` to flint so the default are used. By default, `-ansi` is added to both `CFLAGS` and `CXXFLAGS`. For C is sets the standard to C99 and for C++, to c++98. Frankly I think we should just remove `-ansi` in both case. And since by default `CXXFLAGS` is copied from `CFLAGS`, that should be easy to do in one single change.

And distros don't choke on this because we usually provide some compilation flags.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-01 01:38:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2019-04-01 01:43:35

flint issue is now fixed, please review.
----
New commits:


---

Comment by fbissey created at 2019-04-01 01:43:35

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-04-04 02:25:49

I am kicking this back to the patchbots for final testing as this works on my machine.


---

Comment by tscrim created at 2019-04-04 02:25:49

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-04-04 14:35:00

Changing status from positive_review to needs_work.


---

Comment by embray created at 2019-04-04 14:35:00

Please give me a chance to test this on Cygwin.


---

Comment by embray created at 2019-04-04 14:35:08

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-04-04 14:35:16

Set assignee to embray.


---

Comment by embray created at 2019-04-04 17:56:12

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-04-04 17:56:12

Alright, I think this is probably fine.  I haven't run the full test suite yet, but it looks good based on an informed subset.  If I notice anything after running the full tests I'll create a follow-up.  Thank you for waiting.


---

Comment by vbraun created at 2019-04-07 15:15:42

Resolution: fixed


---

Comment by dimpase created at 2019-04-18 11:02:21

how do I change `-std=gnu++11` to `c++11` for NTL? It seems that #27212#comment:112 is related to this.
Indeed, if I instead use NTL built with `c++11` at https://github.com/Homebrew/homebrew-core/blob/master/Formula/ntl.rb then everything works.


---

Comment by fbissey created at 2019-04-18 11:55:00

I don't particularly like the fact that the macro for C++ standard looks for gnu++11 before c++11 but that's what it is. You can just add `-std=c++11` to `CXXFLAGS` on OS X in spkg-install. That should work. There are work around of the sort for cygwin already in fplll if my memory serves me right.


---

Comment by dimpase created at 2019-04-18 15:22:09

Replying to [comment:89 fbissey]:
> I don't particularly like the fact that the macro for C++ standard looks for gnu++11 before c++11 but that's what it is. You can just add `-std=c++11` to `CXXFLAGS` on OS X in spkg-install. That should work. There are work around of the sort for cygwin already in fplll if my memory serves me right.

no, this does not work. Which packages do need gnu++11 rather than c++11? I am trying now to set c++11 on Darwin globally, IIRC it used to work.


---

Comment by fbissey created at 2019-04-18 20:37:56

OK to set up things globally you may want to go back to the macro setting c++11/gnu++11 as the standard at https://github.com/sagemath/sage/blob/develop/build/pkgs/gcc/spkg-configure.m4#L97 and follow the model of fplll that asks specifically for c++11 https://github.com/fplll/fplll/blob/master/configure.ac#L56 (but do not make it mandatory).

From what I see, it would be a good idea to update the macro `/ax_cxx_compile_stdcxx` as there is a recent fix for clang. 

Now the question is whether you want to try c++11 instead as the general default or just for OS X. My understanding is that cygwin works better with gnu++11.


---

Comment by embray created at 2019-04-19 14:11:52

Replying to [comment:91 fbissey]:
> OK to set up things globally you may want to go back to the macro setting c++11/gnu++11 as the standard at https://github.com/sagemath/sage/blob/develop/build/pkgs/gcc/spkg-configure.m4#L97 and follow the model of fplll that asks specifically for c++11 https://github.com/fplll/fplll/blob/master/configure.ac#L56 (but do not make it mandatory).
> 
> From what I see, it would be a good idea to update the macro `/ax_cxx_compile_stdcxx` as there is a recent fix for clang. 
> 
> Now the question is whether you want to try c++11 instead as the general default or just for OS X. My understanding is that cygwin works better with gnu++11.

Roughly speaking, as I understand it, the reason `-std=gnu++11` is sometimes required on Cygwin is related to the fact that Cygwin's built-in libc is not glibc but rather Cygnus/Redhat's [newlib](https://en.wikipedia.org/wiki/Newlib).  newlib supports most/all the usual GNU extensions but it is quite strict about requiring them to be explicitly enabled; otherwise you just get pure POSIX.

I have no idea what the problem is on macOS, but presumably there's something that is enabled in NTL when using `-std=gnu++11` but it's probably something subtle.


---

Comment by dimpase created at 2019-04-19 15:33:36

It turns out to be a red herring.

However, one thing I noticed that for fplll there is setting of `-std=gnu++11` for Cygwin, whereas it's already set globally...


---

Comment by fbissey created at 2019-04-19 22:18:42

Replying to [comment:94 dimpase]:
> It turns out to be a red herring.
> 
> However, one thing I noticed that for fplll there is setting of `-std=gnu++11` for Cygwin, whereas it's already set globally... 

This is on purpose. Before I enabled c++11/gnu++11 globally, it was already in place. The reason is that fplll's configure script requires a strict c++11 compiler as noted above. But cygwin needs a gnu++11 one to compile fplll. So we need to override fplll's decision on cygwin. Don't go removing it.
