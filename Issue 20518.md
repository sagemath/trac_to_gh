# Issue 20518: Bug in solve due to a bug in symbolic_expression_from_maxima_string

Issue created by migration from Trac.

Original creator: bruno

Original creation time: 2016-06-01 17:22:16

Keywords: maxima, solve

A bug in `sage.calculus.calculus.symbolic_expression_from_maxima_string` implies bugs in `solve` and `roots` for symbolic expressions.

### Symptoms

The method `solve` for symbolic expressions is buggy (the list of multiplicities has size 2 instead of 4), as well as `roots` as a (serious!) consequence:


```python
sage: w = x^4 - (1+3*i)*x^3 - (2-4*i)*x^2 + (6-2*i)*x - 4 - 4*i
sage: w.solve(x,multiplicities=True)
([x == -1/2*sqrt(2*I) + 3/2*I - 1/2, x == 1/2*sqrt(2*I) + 3/2*I - 1/2, x == (-I + 1), x == (I + 1)],
 [1, 1])
sage: w.roots() # should be 4 roots
[(-1/2*sqrt(2*I) + 3/2*I - 1/2, 1), (1/2*sqrt(2*I) + 3/2*I - 1/2, 1)]
```


### Diagnosis

1. The behavior of `roots` is easily explained by the behavior of `solve`, since `roots` assume that the length of the list of solutions is the same as the length of the list of multiplicities. This should clearly be the case so the bug is not in `roots`.

2. Given the parameter in the example, `solve` calls Maxima and parses the result. The multiplicities are obtained by invoking `P.get('multiplicities')`. This is the right invocation to Maxima, no bug there.

3. To parse the solutions returned by Maxima, `solve` calls `sage.symbolic.relation.string_to_list_of_solutions`, which itself calls `sage.calculus.symbolic_expression_from_maxima_string`. The bug occurs in this last function: Indeed, while there is no apparent reason for this, invoking this function changes the variable `multiplicities` of Maxima. Here is an example:

   {{{#!python
sage: w = x^4 - (1+3*i)*x^3 - (2-4*i)*x^2 + (6-2*i)*x - 4 - 4*i
sage: m = (w == 0)._maxima_()
sage: P = m.parent()
sage: s = m.solve(x).str()
sage: s # the list of solutions returned by Maxima
'[_SAGE_VAR_x=-(sqrt(2*%i)-3*%i+1)/2,_SAGE_VAR_x=(sqrt(2*%i)+3*%i-1)/2,_SAGE_VAR_x=1-%i,_SAGE_VAR_x=%i+1]'
sage: P.get('multiplicities') # correct!
'[1,1,1,1]'
sage: l = sage.calculus.calculus.symbolic_expression_from_maxima_string(s)
sage: l
[x == -1/2*sqrt(2*I) + 3/2*I - 1/2,
 x == 1/2*sqrt(2*I) + 3/2*I - 1/2,
 x == (-I + 1),
 x == (I + 1)]
sage: P.get('multiplicities') # WTF???
'[1,1]'
}}}


---

Comment by bruno created at 2016-06-01 17:22:29

Changing type from PLEASE CHANGE to defect.


---

Comment by nbruin created at 2016-06-01 18:00:03

Well, `multiplicities` is a system variable. See [http://maxima.sourceforge.net/docs/manual/maxima_20.html](http://maxima.sourceforge.net/docs/manual/maxima_20.html). Who knows when it gets updated? In particular, the reconstruction of symbolic expressions from strings might be calling into maxima again.

The quick fix is to get the correct value of `multiplicities` out as soon as we can, before conversion back.

In the longer run, it would be preferable to do the conversion while avoiding strings altogether. See `sr_sum` and `sr_limit` etc. for examples how one can use `sr_to_max` and `max_to_sr` to convert.


---

Comment by chapoton created at 2019-07-09 19:20:15

seems to work in 8.9.b1

one needs to check and add a doctest


---

Comment by bruno created at 2019-08-21 12:43:15

Changing status from new to needs_review.


---

Comment by bruno created at 2019-08-21 12:43:15

The bug seems indeed fixed. I've add a doctest.
----
New commits:


---

Comment by vdelecroix created at 2019-08-21 19:36:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-08-29 20:02:19

Resolution: fixed
