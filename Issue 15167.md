# Issue 15167: Change coprime_integers(n) in Integer class to use sieving instead of naive gcd

Issue created by migration from Trac.

Original creator: spice

Original creation time: 2013-11-12 17:00:23

Assignee: Simon Spicer

CC:  was

Keywords: coprime, integer

As written currently, the coprime_integers(n) method in the Integer class uses gcd naively:

```
    def coprime_integers(self, m):
        ...
        v = []
        for n in range(1,m):
            if self.gcd(n) == 1:
                v.append(Integer(n))
        return v
```


This method should be rewritten to use sieving to speed things up.


---

Comment by spice created at 2013-11-12 17:23:10

Changing status from new to needs_review.


---

Comment by was created at 2013-11-12 18:22:47

It can't work because this makes no sense:

```
for p in self.prime_divisors: 
```



---

Comment by was created at 2013-11-12 18:22:47

Changing status from needs_review to needs_work.


---

Attachment

Included missing parentheses. Doctests now properly pass.


---

Comment by spice created at 2013-11-12 19:15:36

Parentheses have been added.


---

Comment by spice created at 2013-11-12 19:15:36

Changing status from needs_work to needs_review.


---

Comment by was created at 2013-11-12 20:12:27

Changing status from needs_review to needs_work.


---

Comment by was created at 2013-11-12 20:12:27

Hey, it's not 2011 anymore, as much as I like that number

```
    - Simon Spicer (2011-11-12): Rewritten to use sieving methods  
```



---

Attachment

Fixes date typo, now uses naive method for small inputs.


---

Comment by spice created at 2013-11-13 17:00:43

New patch replaces previous patch. The method now uses naive gcd if both self and m are < 1000, since this seems to be faster.

Some timings. Old code:

```
sage: %timeit 100.coprime_integers(100)
10000 loops, best of 3: 44.5 us per loop
sage: %timeit 101.coprime_integers(101)
10000 loops, best of 3: 52.6 us per loop
sage: %timeit 1000.coprime_integers(1000)
1000 loops, best of 3: 529 us per loop
sage: %timeit (10^6+12).coprime_integers(10^6+12)
1 loops, best of 3: 603 ms per loop
sage: %timeit (next_prime(10^6)).coprime_integers(10^6)
1 loops, best of 3: 795 ms per loop
sage: %timeit (10^8+512).coprime_integers(10^5)
10 loops, best of 3: 55.9 ms per loop
sage: %timeit (10^8+512).coprime_integers(10^7)
1 loops, best of 3: 5.61 s per loop
```


New code (without naive method for small inputs):


```
sage: %timeit 100.coprime_integers(100)
10000 loops, best of 3: 145 us per loop
sage: %timeit 101.coprime_integers(101)
10000 loops, best of 3: 139 us per loop
sage: %timeit 1000.coprime_integers(1000)
1000 loops, best of 3: 510 us per loop
sage: %timeit (10^6+12).coprime_integers(10^6+12)
1 loops, best of 3: 373 ms per loop
sage: %timeit (next_prime(10^6)).coprime_integers(10^6)
1 loops, best of 3: 383 ms per loop
sage: %timeit (10^8+512).coprime_integers(10^5)
10 loops, best of 3: 39.8 ms per loop
sage: %timeit (10^8+512).coprime_integers(10^7)
1 loops, best of 3: 3.98 s per loop
#MemoryError for m=10^8
```


The new code should be faster when self has few prime factors, but both old and new code scale with m, the bound to which integers coprime to self are returned, since we need to fit that many sage integers in memory.


---

Comment by chapoton created at 2017-09-14 17:04:37

New commits:


---

Comment by chapoton created at 2017-09-14 17:04:37

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-09-14 18:21:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-09-14 18:28:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-14 18:29:10

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-09-25 20:40:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-09-25 20:44:11

I've written a new implementation that fixes some problems with the old and speeds it up:

* It now handles the case that `self = 0` or negative and that `m` is too large or negative gracefully
* It uses `trial_division()` rather than `prime_divisors()`, which will be faster and deals with the case that `self` has prime factors larger than `m` better.
* It uses bit fiddling rather than a list of booleans.


---

Comment by git created at 2017-09-26 01:03:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-10-02 18:36:44

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2017-10-02 18:36:44

ok


---

Comment by ylchapuy created at 2017-10-02 20:16:48

Just my 2 cents: `mpz_divexact_ui` is expected to be faster than `mpz_fdiv_q`, and `mpz_sgn` instead of comparing to zero.
Also as you have `plong` available (why not unsigned?), it's probably better to use `mpz_cmp_si` and `mpz_divisible_ui_p`.

All this is nitpicking though.


---

Comment by ylchapuy created at 2017-10-02 20:21:32

Replying to [comment:18 ylchapuy]:
>  and `mpz_sgn` instead of comparing to zero.

Oups, forget this was, I misread :)


---

Comment by git created at 2017-10-02 20:37:03

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-10-02 20:37:03

Changing status from positive_review to needs_review.


---

Comment by roed created at 2017-10-02 20:39:12

Thanks.  I've adjusted `plong` and `ilong` to unsigned longs, adjusted the functions and described the algorithm correctly.


---

Comment by ylchapuy created at 2017-10-02 22:23:26

Am I missing something (it's late here) or is this never happening: `mpz_tstbit(sieve.value, plong)` ?
If `p == m` it can't be composite because it's smallest factor would have been removed before.


---

Comment by git created at 2017-10-04 16:59:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-04 16:59:59

Thanks.  I removed that and another test, which were left over from before I added the last break statement.


---

Comment by ylchapuy created at 2017-10-06 08:10:47

Just curious: what's the rationale for the added argument  `algorithm = None`? Are you planning to add another implementation?

Otherwise LGTM.


---

Comment by ylchapuy created at 2017-10-06 08:10:47

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-10-06 09:09:59

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-10-06 09:09:59

Changing status from positive_review to needs_review.


---

Comment by roed created at 2017-10-06 09:12:39

Replying to [comment:25 ylchapuy]:
> Just curious: what's the rationale for the added argument  `algorithm = None`? Are you planning to add another implementation?

That was left over from when I was still experimenting with other implementations.

> Otherwise LGTM.

I've deleted it and set the ticket back to positive review.  Thanks!


---

Comment by roed created at 2017-10-06 09:12:39

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-10-08 07:02:12

Hum, gives me time out in `sage/groups/additive_abelian/qmodnz.py` the backtrace points to stuff here

```
Stack backtrace
---------------
No symbol table info available.
#1  0x00007f83b5e85b53 in print_enhanced_backtrace () from /usr/lib64/python2.7/site-packages/cysignals/signals.so
No symbol table info available.
#2  0x00007f83b5e85c4a in sigdie () from /usr/lib64/python2.7/site-packages/cysignals/signals.so
No symbol table info available.
#3  0x00007f83b5e88247 in cysigs_signal_handler () from /usr/lib64/python2.7/site-packages/cysignals/signals.so
No symbol table info available.
#4  <signal handler called>
No symbol table info available.
#5  0x00007f83b52f0b6a in __gmpz_divexact_ui () from /usr/lib64/libgmp.so.10
No symbol table info available.
#6  0x00007f83aa3ef26e in __pyx_pw_4sage_5rings_7integer_7Integer_131coprime_integers () from /usr/lib64/python2.7/site-packages/sage/rings/integer.so
No symbol table info available.
```



---

Comment by chapoton created at 2017-10-08 07:38:22

Changing status from positive_review to needs_work.


---

Comment by ylchapuy created at 2017-10-08 16:09:06

Hum, 

```sage
p = slf.trial_division(mlong, mpz_get_si(p.value)+1)
ilong = plong = mpz_get_ui(p.value)
```

this might be problematic if `p` is set to `slf` and doesn't fit in a long.

If moreover `plong` end up being `1`, the `while mpz_divisible_ui_p(slf.value, plong):` loop will be infinite.


---

Comment by roed created at 2017-10-09 00:56:20

Replying to [comment:30 ylchapuy]:
> Hum, 
> {{{#!sage
> p = slf.trial_division(mlong, mpz_get_si(p.value)+1)
> ilong = plong = mpz_get_ui(p.value)
> }}}
> this might be problematic if `p` is set to `slf` and doesn't fit in a long.

That can't happen since `trial_division` only goes up to the bound `mlong`.
 
> If moreover `plong` end up being `1`, the `while mpz_divisible_ui_p(slf.value, plong):` loop will be infinite.

That can't happen since `trial_division` starts at `p+1`, which is at least 2.


---

Comment by roed created at 2017-10-09 00:59:07

Replying to [comment:31 roed]:
> Replying to [comment:30 ylchapuy]:
> > Hum, 
> > {{{#!sage
> > p = slf.trial_division(mlong, mpz_get_si(p.value)+1)
> > ilong = plong = mpz_get_ui(p.value)
> > }}}
> > this might be problematic if `p` is set to `slf` and doesn't fit in a long.
> 
> That can't happen since `trial_division` only goes up to the bound `mlong`.

Oh, I was wrong: in this case `p` will equal `slf`.  I'll fix it.


---

Comment by git created at 2017-10-17 08:11:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-17 08:11:44

Changing status from needs_work to needs_review.


---

Comment by ylchapuy created at 2017-10-19 11:33:18

Changing status from needs_review to needs_work.


---

Comment by ylchapuy created at 2017-10-19 11:33:18

Do not compile.

`mpz_cmp_si(p, mlong)` should be `mpz_cmp_si(p.value, mlong)`


---

Comment by git created at 2017-10-19 14:10:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-19 14:11:11

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-10-19 14:11:11

Oops.  Fixed.


---

Comment by ylchapuy created at 2017-10-19 16:50:37

patchbot failures


---

Comment by ylchapuy created at 2017-10-19 16:50:37

Changing status from needs_review to needs_work.


---

Comment by ylchapuy created at 2017-10-19 17:11:10

I think `self = 1` leads to an infinite loop.


---

Comment by git created at 2017-10-19 19:26:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-19 19:28:02

You're right. I've fixed that (plus a problem that would show up if `self` were negative) and added a test.


---

Comment by roed created at 2017-10-19 19:28:02

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-10-20 01:43:31

Tests pass....


---

Comment by ylchapuy created at 2017-10-21 16:20:17

The tests are a useful addition I think :)
LGTM, bots problems seems unrelated


---

Comment by ylchapuy created at 2017-10-21 16:20:17

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-22 05:51:56

Resolution: fixed
