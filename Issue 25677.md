# Issue 25677: New source code links in API documentation

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-07-24 14:59:05

Keywords: odk sphinx

This is work motivated partly by OpenDreamKit's [D3.5 deliverable](https://github.com/OpenDreamKit/OpenDreamKit/issues/64).  For more background on this you can read the [draft of my in-progress report](https://github.com/OpenDreamKit/OpenDreamKit/blob/master/WP3/D3.5/status-report.tex) on the deliverable.

### The "what"

This adds two new links in the header to most, if not all, class, method, and function API docs: One link titled "[source]" and another titled "[edit on gitlab]":

![](source-links.png)

This is inspired by Astropy's API documentation which includes two similar links (except with "github" instead of "gitlab").  See for example: http://docs.astropy.org/en/stable/api/astropy.table.Table.html#astropy.table.Table

The two links seem in some ways redundant, but do serve slightly different purposes.

First of all, the `[source]` link goes to another page directly included in the API docs that simply displays the source code of the linked object exactly as it appears in the version of the code that the documentation was built from.  It is displayed with the API docs' template and source code highlighting, and includes a link back to the rendered API docs for each object:

![](sphinx-source.png)

This makes for a fluid link between source code and API docs.

The `[edit on gitlab]` link is a bit trickier and perhaps more controversial--it might be worth splitting to a separate ticket.  However, Astropy has had a similar feature in its docs for many years, and it has proven generally useful, especially for accepting minor documentation fixes from users and readers.

It is subtly different from the `[source]` link.  Instead of staying on-site (e.g. within `doc.sagemath.org`) it links off-site to a mirror of the Sage repository hosted on [GitLab](GitLab): (e.g. https://gitlab.com/sagemath/sage/blob/develop/src/sage/structure/sage_object.pyx#L89-995)

![](gitlab-source.png)

It also highlights the relevant code for the API docs being linked from.  However, it shows the code in the current "develop" branch, _not_ necessarily the code that the documentation is based on.  Therefore these links can sometimes be slightly off, and in more rare cases are 404s.  However, in most cases, this is a convenient way for readers to go directly from the docs to the latest version of the relevant code, and from there create and propose edits directly through GitLab's web-based editor.

In fact, we _would_ link directly to the editor, but this has a couple issues:

1. [GitLab](GitLab) currently does not allow linking directly to a specific line of a file in the editor.

2. Even if it did, to get to the editor the user has to be already logged into [GitLab](GitLab).  Linking directly to the editor can be confusing in this case.  This is a lesson learned from Astropy's "edit on github" link as well.

The question then becomes: "What happens when someone edits a file through [GitLab](GitLab)?"  There are a few possibilities here, but normally what happens is that [GitLab](GitLab) automatically creates a fork of the sage repository for the user if they don't already have a personal fork.  It then creates a branch off the version of the repository the user is editing, and commits the edits to that branch.  It then gives the user the opportunity to submit the change as a "merge request" (same as what [GitHub](GitHub) calls a "pull request"). 

In order to integrate Sage's current development workflow with [GitLab](GitLab) merge requests, we have implemented (though not yet deployed) and update to Sage's Trac plugin that allows it to listen to merge request hooks on the [GitLab](GitLab) mirror.  For each merge request it will automatically do two things: create a branch for the MR on git.sagemath.org which is synchronized with the branch on the user's [GitLab](GitLab) repository (pushes to the [GitLab](GitLab) branch are synchronized as well), and a Trac ticket for the MR is created, linking back to the MR.  It looks something like this (though the details are not set in stone):

![](mr-ticket.png)


Although if one desires they can use [GitLab](GitLab) for code review, any discussion can also take place on Trac as usual. The git.sagemath.org branch can be merged through the usual process as well, and when the Trac ticket is closed the [GitLab](GitLab) MR is also automatically closed.

This should make it easier in general for new contributors to contribute code changes as well, though the process is specifically geared, for now, towards making it easier to accept documentation fixes--especially minor fixes that readers are less likely to bother submitting if they have to go through the process of registering a Trac account, learning new tools, etc.


### The "how"

Most of change on the Sage side are implemented through a slight fork of the standard `sphinx.ext.viewcode` extension.  The fact that it needed to be forked at all is unfortunate since we're trying to "unfork" our Sage-specific code changes to Sphinx extensions (see e.g. #22604).  However, it was necessary, especially in order to fix issues related to generating source code links for objects defined in Cython modules.

I have kept the commit history such that it's easy to compare the original upstream sources to the modified sources.  However, it should be a priority to get as many of these changes upstreamed as possible.  The bug fixes and workarounds needed for Cython in particular should not be too much trouble to upstream, I don't think.


### TODO

[ ] Submit upstream fixes and feature requests to Sphinx so that we can "unfork" our copy of the viewcode extension as much as possible.

[ ] Submit upstream fix to Pygments (Pygments is used for source highlighting in the source files generated by Sphinx, and there is a small bug in Pygments' Cython lexer).

[ ] Add "[edit on gitlab]" links to non-API documentation pages as well (referring back to Astropy, all of Astropy's prose documentation pages include an "edit this page on GitHub" link as well; we should do the same but this ticket doesn't include that yet).


---

Attachment


---

Attachment


---

Comment by embray created at 2018-08-20 10:53:50

Changing status from new to needs_review.


---

Comment by saraedum created at 2018-08-22 02:19:08

In general this looks good to me. So the idea would be to upstream what can be upstreamed and then put the proposed upstream patches into our SPKGs instead of this monkey patching of sorts?


---

Comment by embray created at 2018-08-22 09:48:26

Yeah, I'm hesitant to rely on source patches until at the very least something close to it looks like it will be accepted upstream.  I will _always_ prefer to monkey-patch or work around things in other ways that don't rely on source code patching (and thus rely on having my patched version of the package to work properly).

It's a tradeoff either way.

I haven't opened any upstream issues for this yet just because I wanted to see if I could get any feedback on the general proposal in the first place.


---

Comment by embray created at 2018-08-22 09:54:38

Also once there are upstream fixes for supporting Cython better in Sphinx, most or all of what I added in `sage_setup.docbuild.ext.pyxcode` will probably be able to go away.  I don't think it will be necessary to go through a deprecation process.  I would consider everything in that module to be non-public API.  I don't know if that needs to be made explicit or not though.


---

Comment by git created at 2018-08-23 15:11:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by saraedum created at 2018-08-23 16:31:38

Replying to [comment:3 embray]:
> Yeah, I'm hesitant to rely on source patches until at the very least something close to it looks like it will be accepted upstream.  I will _always_ prefer to monkey-patch or work around things in other ways that don't rely on source code patching (and thus rely on having my patched version of the package to work properly).
> 
> It's a tradeoff either way.
Ok. I'll quote that at some point :P

> I haven't opened any upstream issues for this yet just because I wanted to see if I could get any feedback on the general proposal in the first place.
Sure. Let us know when you have upstreamed something.


---

Comment by embray created at 2018-09-03 11:57:08

Replying to [comment:6 saraedum]:
> Replying to [comment:3 embray]:
> > I haven't opened any upstream issues for this yet just because I wanted to see if I could get any feedback on the general proposal in the first place.
> Sure. Let us know when you have upstreamed something.

I'm not sure you understood.  My point was that I was not even going to go to the effort until and unless this has otherwise "positive review" (pending, perhaps, opening some upstream PRs).  And more importantly _not_ necessarily waiting for those upstream PRs to be accepted because who knows how long that could take, if it happens ever.  

From "In general this looks good to me" it wasn't clear if that was the case.  No one else has commented on the specific merits or demerits of the change.

One issue _I_ have noticed with this is that sometimes the new "source" links get placed on top of each other instead of side-by-side in an ugly way if the title of the object is too long and forces wrapping.  I'm not sure what to do about that though, short of maybe putting some kind of wrapper around them so that they are forced onto a new line together.


---

Comment by git created at 2018-10-31 12:35:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by @mwageringel created at 2020-08-15 11:42:13

In general, I think it is very desirable to crosslink the source code from within the documentation. The link to [GitLab](GitLab) seems much more important to me than the link to an on-site copy of the source code, for many reasons. It is a more well-known location for the source code, includes the most recent version of the code and all the history, and it allows to edit the code easily.

The only benefit I see in the on-site copy of the source code is the link back to the documentation, which is certainly nice, but only useful if one browses that copy of the code without coming from a link from the documentation. Due to the lack of history, I think this is not the best way to read the source code though. It would however allow to find the documentation page for a particular source file more easily â€“ currently, this is notoriously difficult without using a search engine.

I do think that upstreaming as much as possible is desirable. Could we maybe even replace our Sphinx theme by a more modern one that already has these features, to avoid duplicating efforts? Since we have upgraded to a recent version of Sphinx, unforking our Sphinx code should now be easier I assume.

The branch does not merge, so I am setting this to _needs work_.


---

Comment by @mwageringel created at 2020-08-15 11:42:13

Changing status from needs_review to needs_work.


---

Comment by embray created at 2020-08-31 15:24:36

Thanks, I agree.  I think the only reason I never moved forward on this is that no one really gave any feedback or expressed desire for the feature, though the goal was in part to make it easier for new contributors to make changes.

I don't know what it would require to update this but I don't think it will be too hard.  Most of the Sphinx issues were due to shortcomings in Cython support; I don't think that's any better in Sphinx yet.


---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.
