# Issue 16054: FormalCompositeMap should contain list of Map

archive/issues_016054.json:
```json
{
    "body": "Assignee: sbesnier\n\nCC:  @defeo\n\nKeywords: associativity FormalCompositeMap\n\nThis ticket follows discussions in #16245, comments 4 and 5. This discussion raised a break of associativity in FormalCompositeMap.\n\nCurrently, the `FormalCompositeMap` only stores \"first\" and \"second\" map. Hence `(f*g)*h` builds a tree like:\n\n```\nf g\n```\n\nwhereas  `f*(g*h)` builds a tree like:\n\n```\n||\n | f \\\n  |\\\n  g h\n```\n|\nAs a result, map composition is not associative:\n\n```python\nsage: from sage.categories.map import Map\nsage: f=Map(ZZ,ZZ)\nsage: (f*f)*f==f*(f*f)\nFalse\n```\n\n\nI think this class should contain a list of several Map. I've made a draft of it, the only doctest I had to change was those involving `FormalCompositeMap` string representation. Indeed, this representation was treelike and is now linear.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16291\n\n",
    "created_at": "2014-05-05T16:13:25Z",
    "labels": [
        "component: categories",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "FormalCompositeMap should contain list of Map",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16054",
    "user": "https://trac.sagemath.org/admin/accounts/users/sbesnier"
}
```
Assignee: sbesnier

CC:  @defeo

Keywords: associativity FormalCompositeMap

This ticket follows discussions in #16245, comments 4 and 5. This discussion raised a break of associativity in FormalCompositeMap.

Currently, the `FormalCompositeMap` only stores "first" and "second" map. Hence `(f*g)*h` builds a tree like:

```
f g
```

whereas  `f*(g*h)` builds a tree like:

```
||
 | f \
  |\
  g h
```
|
As a result, map composition is not associative:

```python
sage: from sage.categories.map import Map
sage: f=Map(ZZ,ZZ)
sage: (f*f)*f==f*(f*f)
False
```


I think this class should contain a list of several Map. I've made a draft of it, the only doctest I had to change was those involving `FormalCompositeMap` string representation. Indeed, this representation was treelike and is now linear.

Issue created by migration from https://trac.sagemath.org/ticket/16291





---

archive/issue_comments_208659.json:
```json
{
    "body": "I've commented the \"first\" and \"second\" methods since it is not used in another place in sage. Should I keep them for backward compatibility?\n----\nNew commits:",
    "created_at": "2014-05-05T16:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208659",
    "user": "https://trac.sagemath.org/admin/accounts/users/sbesnier"
}
```

I've commented the "first" and "second" methods since it is not used in another place in sage. Should I keep them for backward compatibility?
----
New commits:



---

archive/issue_comments_208660.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-05T16:18:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208660",
    "user": "https://trac.sagemath.org/admin/accounts/users/sbesnier"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_208661.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-05T16:25:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208661",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208662.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-05T17:46:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208662",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208663.json:
```json
{
    "body": "Is this still meant as a draft as stated in the ticket description?  I think it looks good in general, but maybe you could improve the formatting of the code and try to conform to the Python [style guide](http://legacy.python.org/dev/peps/pep-0008/) and [docstring conventions](http://legacy.python.org/dev/peps/pep-0257/).\n\nIn particular:\n- use consistent spacing (including spaces after punctuation marks and no spaces before them)\n- do not put `if foo: bar` on a single line unless foo and bar are very short\n- docstrings should start with a single line, or two if really necessary; four, as in `__getitem__()`, is definitely too many\n\nAlso, I recommend keeping the `first()` and `second()` methods, since they are public and existing user code may depend on them.",
    "created_at": "2014-05-12T15:51:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208663",
    "user": "https://github.com/pjbruin"
}
```

Is this still meant as a draft as stated in the ticket description?  I think it looks good in general, but maybe you could improve the formatting of the code and try to conform to the Python [style guide](http://legacy.python.org/dev/peps/pep-0008/) and [docstring conventions](http://legacy.python.org/dev/peps/pep-0257/).

In particular:
- use consistent spacing (including spaces after punctuation marks and no spaces before them)
- do not put `if foo: bar` on a single line unless foo and bar are very short
- docstrings should start with a single line, or two if really necessary; four, as in `__getitem__()`, is definitely too many

Also, I recommend keeping the `first()` and `second()` methods, since they are public and existing user code may depend on them.



---

archive/issue_comments_208664.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-12T20:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208664",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208665.json:
```json
{
    "body": "Sorry for being annoying, but I'm afraid you partially misunderstood my request about punctuation...  By punctuation marks I meant one of `. , ; : ? !`, not equality signs or operators.  (See the section \"Whitespace in Expressions and Statements\" on the first linked page in comment:6.)\n\nWhat is the reasoning behind `head()` and `tail()`?  If you think of morphisms as arrows, then composing two morphisms, say by putting `f` first and `g` second, gives\n\n```\n   f      g\n* ---> * ---> *\n```\n\nIn this picture it would be visually suggestive to call `g` the head and `f` the tail!  Why not keep `first()` as it is, implementing a method `last()` and making `second()` a deprecated alias for either `last()` or `__getitem__(1)`?",
    "created_at": "2014-05-12T20:36:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208665",
    "user": "https://github.com/pjbruin"
}
```

Sorry for being annoying, but I'm afraid you partially misunderstood my request about punctuation...  By punctuation marks I meant one of `. , ; : ? !`, not equality signs or operators.  (See the section "Whitespace in Expressions and Statements" on the first linked page in comment:6.)

What is the reasoning behind `head()` and `tail()`?  If you think of morphisms as arrows, then composing two morphisms, say by putting `f` first and `g` second, gives

```
   f      g
* ---> * ---> *
```

In this picture it would be visually suggestive to call `g` the head and `f` the tail!  Why not keep `first()` as it is, implementing a method `last()` and making `second()` a deprecated alias for either `last()` or `__getitem__(1)`?



---

archive/issue_comments_208666.json:
```json
{
    "body": "> What is the reasoning behind `head()` and `tail()`?  \n\nThat was my suggestion. I find *first* and *second* misleading, and think they should be deprecated. *head* and *tail* are standard names in functional languages, e.g. caml. Of course, this is standard terminology for lists, where there is little ambiguity on who's the head and who's the tail. As you point out, it is more confusing if you draw arrows, but *first* and *last* is no less confusing than *first* and *second* in my opinion.\n\nWe could keep *head* and *tail*, but reverse them to be consistent with arrow diagrams (who says *head* should be first in applicative order? We are making up the terminology, anyway). Or maybe *head* and *shaft*, this is even more figurative! Or, if we want to stick with the applicative order, what about *first* and *then*? Whatever we choose, I think we should take names that sound ridiculous enough to force the user to read the docstring, rather than say \"I know what that means\".",
    "created_at": "2014-05-12T21:32:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208666",
    "user": "https://github.com/defeo"
}
```

> What is the reasoning behind `head()` and `tail()`?  

That was my suggestion. I find *first* and *second* misleading, and think they should be deprecated. *head* and *tail* are standard names in functional languages, e.g. caml. Of course, this is standard terminology for lists, where there is little ambiguity on who's the head and who's the tail. As you point out, it is more confusing if you draw arrows, but *first* and *last* is no less confusing than *first* and *second* in my opinion.

We could keep *head* and *tail*, but reverse them to be consistent with arrow diagrams (who says *head* should be first in applicative order? We are making up the terminology, anyway). Or maybe *head* and *shaft*, this is even more figurative! Or, if we want to stick with the applicative order, what about *first* and *then*? Whatever we choose, I think we should take names that sound ridiculous enough to force the user to read the docstring, rather than say "I know what that means".



---

archive/issue_comments_208667.json:
```json
{
    "body": "Replying to [comment:9 defeo]:\n> > What is the reasoning behind `head()` and `tail()`?  \n> \n> That was my suggestion. I find *first* and *second* misleading, and think they should be deprecated. *head* and *tail* are standard names in functional languages, e.g. caml. Of course, this is standard terminology for lists, where there is little ambiguity on who's the head and who's the tail.\nActually, the moment when I read `head` and `tail`, I was reminded of `car` and `cdr`, so that had the desired effect. 8-)\n> As you point out, it is more confusing if you draw arrows, but *first* and *last* is no less confusing than *first* and *second* in my opinion.\nForget what I said about introducing `last`, I was confused.  (Well, we could introduce it anyway, but just as \"the last morphism in the composition\", not with the current meaning of `tail`.)\n> We could keep *head* and *tail*, but reverse them to be consistent with arrow diagrams (who says *head* should be first in applicative order? We are making up the terminology, anyway). Or maybe *head* and *shaft*, this is even more figurative!\nI think it sounds nice, but `shaft` might be a bit annoying for people who don't think of morphisms as arrows.  And I would expect `head` to be the *last* morphism in the composition, not the composition of all except the first.\n> Or, if we want to stick with the applicative order, what about *first* and *then*?\nI like this idea, because it is close to the existing terminology and because `then` is nicely consistent with the way composed morphisms are printed.\n> Whatever we choose, I think we should take names that sound ridiculous enough to force the user to read the docstring, rather than say \"I know what that means\".\nI don't know, at the same time they should preferably also be of the kind that you remember once you have seen them.  And they shouldn't be so ridiculous that they become distracting.\n\nI'm starting to think that altogether `first` and `then` suggests itself as the preferred choice.",
    "created_at": "2014-05-12T22:31:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208667",
    "user": "https://github.com/pjbruin"
}
```

Replying to [comment:9 defeo]:
> > What is the reasoning behind `head()` and `tail()`?  
> 
> That was my suggestion. I find *first* and *second* misleading, and think they should be deprecated. *head* and *tail* are standard names in functional languages, e.g. caml. Of course, this is standard terminology for lists, where there is little ambiguity on who's the head and who's the tail.
Actually, the moment when I read `head` and `tail`, I was reminded of `car` and `cdr`, so that had the desired effect. 8-)
> As you point out, it is more confusing if you draw arrows, but *first* and *last* is no less confusing than *first* and *second* in my opinion.
Forget what I said about introducing `last`, I was confused.  (Well, we could introduce it anyway, but just as "the last morphism in the composition", not with the current meaning of `tail`.)
> We could keep *head* and *tail*, but reverse them to be consistent with arrow diagrams (who says *head* should be first in applicative order? We are making up the terminology, anyway). Or maybe *head* and *shaft*, this is even more figurative!
I think it sounds nice, but `shaft` might be a bit annoying for people who don't think of morphisms as arrows.  And I would expect `head` to be the *last* morphism in the composition, not the composition of all except the first.
> Or, if we want to stick with the applicative order, what about *first* and *then*?
I like this idea, because it is close to the existing terminology and because `then` is nicely consistent with the way composed morphisms are printed.
> Whatever we choose, I think we should take names that sound ridiculous enough to force the user to read the docstring, rather than say "I know what that means".
I don't know, at the same time they should preferably also be of the kind that you remember once you have seen them.  And they shouldn't be so ridiculous that they become distracting.

I'm starting to think that altogether `first` and `then` suggests itself as the preferred choice.



---

archive/issue_comments_208668.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-02T13:38:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208668",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208669.json:
```json
{
    "body": "In the last commit, didn't you want to change `head` back to `first`?  Now the terminology is asymmetric (`head` vs. `then`).",
    "created_at": "2014-06-14T19:34:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208669",
    "user": "https://github.com/pjbruin"
}
```

In the last commit, didn't you want to change `head` back to `first`?  Now the terminology is asymmetric (`head` vs. `then`).



---

archive/issue_comments_208670.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-06-14T20:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208670",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_208671.json:
```json
{
    "body": "Ooops!! I'm sorry! Thank you Peter.",
    "created_at": "2014-06-14T20:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208671",
    "user": "https://trac.sagemath.org/admin/accounts/users/sbesnier"
}
```

Ooops!! I'm sorry! Thank you Peter.



---

archive/issue_comments_208672.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-06-14T23:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208672",
    "user": "https://github.com/pjbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_208673.json:
```json
{
    "body": "Reviewer patch mostly fixes formatting and whitespace issues.  (Also in other parts of `map.pyx`, now that we're at it.)",
    "created_at": "2014-06-14T23:35:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208673",
    "user": "https://github.com/pjbruin"
}
```

Reviewer patch mostly fixes formatting and whitespace issues.  (Also in other parts of `map.pyx`, now that we're at it.)



---

archive/issue_events_015621.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-06-18T12:00:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16054#event-15621"
}
```



---

archive/issue_comments_208674.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-18T12:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16054#issuecomment-208674",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
