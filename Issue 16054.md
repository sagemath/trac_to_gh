# Issue 16054: FormalCompositeMap should contain list of Map

Issue created by migration from Trac.

Original creator: sbesnier

Original creation time: 2014-05-05 16:13:25

Assignee: sbesnier

CC:  defeo

Keywords: associativity FormalCompositeMap

This ticket follows discussions in #16245, comments 4 and 5. This discussion raised a break of associativity in FormalCompositeMap.

Currently, the `FormalCompositeMap` only stores "first" and "second" map. Hence `(f*g)*h` builds a tree like:

```
f g
```

whereas  `f*(g*h)` builds a tree like:

```
||
 | f \
  |\
  g h
```
|
As a result, map composition is not associative:

```python
sage: from sage.categories.map import Map
sage: f=Map(ZZ,ZZ)
sage: (f*f)*f==f*(f*f)
False
```


I think this class should contain a list of several Map. I've made a draft of it, the only doctest I had to change was those involving `FormalCompositeMap` string representation. Indeed, this representation was treelike and is now linear.


---

Comment by sbesnier created at 2014-05-05 16:18:07

I've commented the "first" and "second" methods since it is not used in another place in sage. Should I keep them for backward compatibility?
----
New commits:


---

Comment by sbesnier created at 2014-05-05 16:18:07

Changing status from new to needs_review.


---

Comment by git created at 2014-05-05 16:25:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-05 17:46:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-05-12 15:51:49

Is this still meant as a draft as stated in the ticket description?  I think it looks good in general, but maybe you could improve the formatting of the code and try to conform to the Python [style guide](http://legacy.python.org/dev/peps/pep-0008/) and [docstring conventions](http://legacy.python.org/dev/peps/pep-0257/).

In particular:
- use consistent spacing (including spaces after punctuation marks and no spaces before them)
- do not put `if foo: bar` on a single line unless foo and bar are very short
- docstrings should start with a single line, or two if really necessary; four, as in `__getitem__()`, is definitely too many

Also, I recommend keeping the `first()` and `second()` methods, since they are public and existing user code may depend on them.


---

Comment by git created at 2014-05-12 20:19:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-05-12 20:36:33

Sorry for being annoying, but I'm afraid you partially misunderstood my request about punctuation...  By punctuation marks I meant one of `. , ; : ? !`, not equality signs or operators.  (See the section "Whitespace in Expressions and Statements" on the first linked page in comment:6.)

What is the reasoning behind `head()` and `tail()`?  If you think of morphisms as arrows, then composing two morphisms, say by putting `f` first and `g` second, gives

```
   f      g
* ---> * ---> *
```

In this picture it would be visually suggestive to call `g` the head and `f` the tail!  Why not keep `first()` as it is, implementing a method `last()` and making `second()` a deprecated alias for either `last()` or `__getitem__(1)`?


---

Comment by defeo created at 2014-05-12 21:32:53

> What is the reasoning behind `head()` and `tail()`?  

That was my suggestion. I find _first_ and _second_ misleading, and think they should be deprecated. _head_ and _tail_ are standard names in functional languages, e.g. caml. Of course, this is standard terminology for lists, where there is little ambiguity on who's the head and who's the tail. As you point out, it is more confusing if you draw arrows, but _first_ and _last_ is no less confusing than _first_ and _second_ in my opinion.

We could keep _head_ and _tail_, but reverse them to be consistent with arrow diagrams (who says _head_ should be first in applicative order? We are making up the terminology, anyway). Or maybe _head_ and _shaft_, this is even more figurative! Or, if we want to stick with the applicative order, what about _first_ and _then_? Whatever we choose, I think we should take names that sound ridiculous enough to force the user to read the docstring, rather than say "I know what that means".


---

Comment by pbruin created at 2014-05-12 22:31:35

Replying to [comment:9 defeo]:
> > What is the reasoning behind `head()` and `tail()`?  
> 
> That was my suggestion. I find _first_ and _second_ misleading, and think they should be deprecated. _head_ and _tail_ are standard names in functional languages, e.g. caml. Of course, this is standard terminology for lists, where there is little ambiguity on who's the head and who's the tail.
Actually, the moment when I read `head` and `tail`, I was reminded of `car` and `cdr`, so that had the desired effect. 8-)
> As you point out, it is more confusing if you draw arrows, but _first_ and _last_ is no less confusing than _first_ and _second_ in my opinion.
Forget what I said about introducing `last`, I was confused.  (Well, we could introduce it anyway, but just as "the last morphism in the composition", not with the current meaning of `tail`.)
> We could keep _head_ and _tail_, but reverse them to be consistent with arrow diagrams (who says _head_ should be first in applicative order? We are making up the terminology, anyway). Or maybe _head_ and _shaft_, this is even more figurative!
I think it sounds nice, but `shaft` might be a bit annoying for people who don't think of morphisms as arrows.  And I would expect `head` to be the _last_ morphism in the composition, not the composition of all except the first.
> Or, if we want to stick with the applicative order, what about _first_ and _then_?
I like this idea, because it is close to the existing terminology and because `then` is nicely consistent with the way composed morphisms are printed.
> Whatever we choose, I think we should take names that sound ridiculous enough to force the user to read the docstring, rather than say "I know what that means".
I don't know, at the same time they should preferably also be of the kind that you remember once you have seen them.  And they shouldn't be so ridiculous that they become distracting.

I'm starting to think that altogether `first` and `then` suggests itself as the preferred choice.


---

Comment by git created at 2014-06-02 13:38:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2014-06-14 19:34:45

In the last commit, didn't you want to change `head` back to `first`?  Now the terminology is asymmetric (`head` vs. `then`).


---

Comment by git created at 2014-06-14 20:47:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbesnier created at 2014-06-14 20:49:18

Ooops!! I'm sorry! Thank you Peter.


---

Comment by pbruin created at 2014-06-14 23:35:03

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-06-14 23:35:03

Reviewer patch mostly fixes formatting and whitespace issues.  (Also in other parts of `map.pyx`, now that we're at it.)


---

Comment by vbraun created at 2014-06-18 12:00:28

Resolution: fixed
