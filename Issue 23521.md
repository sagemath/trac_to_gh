# Issue 23521: sage.env: _add_variable_or_fallback depends on the order of a dict

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2017-08-30 18:33:18

CC:  mkoeppe

In `sage/env.py`, the function `_add_variable_or_fallback` does some variable substitution: if a string contains `$VAR`, it substitutes the value of `VAR` in the dictionary `SAGE_ENV`. It does this by iterating through the items of `SAGE_ENV`, which means that if both `VAR` and `VAR_OTHER` are in `SAGE_ENV`, it's sort of a coin toss as to what happens when it comes across `$VAR_OTHER`.

(This arose when I was working on #21469: the string `$SAGE_SRC_ROOT` was being replaced by the value of `SAGE_SRC`, followed by the string `_ROOT`.)


---

Comment by jhpalmieri created at 2017-08-30 18:51:21

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2017-08-30 18:51:21

New commits:


---

Comment by git created at 2017-08-30 20:28:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2017-08-30 23:26:25

I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `"$SAGE_ROOT"`?


---

Comment by mkoeppe created at 2017-08-30 23:41:40

(Could be a follow-up ticket.)


---

Comment by mkoeppe created at 2017-08-30 23:42:05

Perhaps add a doctest?


---

Comment by git created at 2017-08-31 01:18:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2017-08-31 01:19:47

Here is a doctest. The same test fails for me in the develop branch, but I suppose that failure may not be repeatable on all platforms, since dictionaries are not ordered.


---

Comment by jhpalmieri created at 2017-08-31 01:22:05

Replying to [comment:4 mkoeppe]:
> I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `"$SAGE_ROOT"`?

I agree, a followup ticket if we want to address this. I'm not sure what the point of the substitution is, compared to using shell variables or some shortcut for accessing `SAGE_ENV['foo']`.


---

Comment by mkoeppe created at 2017-08-31 04:54:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2017-08-31 05:01:47

Follow up ticket is #23762.


---

Comment by git created at 2017-08-31 22:32:16

Changing status from positive_review to needs_review.


---

Comment by git created at 2017-08-31 22:32:16

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-08-31 22:33:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2017-08-31 22:35:04

Sorry, I accidentally pushed a branch here instead of to the appropriate ticket. The positively reviewed branch has been restored.


---

Comment by mkoeppe created at 2017-09-01 15:53:53

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-04 06:11:11

Resolution: fixed
