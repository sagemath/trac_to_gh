# Issue 23521: sage.env: _add_variable_or_fallback depends on the order of a dict

archive/issues_023521.json:
```json
{
    "body": "CC:  mkoeppe\n\nIn `sage/env.py`, the function `_add_variable_or_fallback` does some variable substitution: if a string contains `$VAR`, it substitutes the value of `VAR` in the dictionary `SAGE_ENV`. It does this by iterating through the items of `SAGE_ENV`, which means that if both `VAR` and `VAR_OTHER` are in `SAGE_ENV`, it's sort of a coin toss as to what happens when it comes across `$VAR_OTHER`.\n\n(This arose when I was working on #21469: the string `$SAGE_SRC_ROOT` was being replaced by the value of `SAGE_SRC`, followed by the string `_ROOT`.)\n\nIssue created by migration from https://trac.sagemath.org/ticket/23758\n\n",
    "created_at": "2017-08-30T18:33:18Z",
    "labels": [
        "build",
        "critical",
        "bug"
    ],
    "title": "sage.env: _add_variable_or_fallback depends on the order of a dict",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23521",
    "user": "jhpalmieri"
}
```
CC:  mkoeppe

In `sage/env.py`, the function `_add_variable_or_fallback` does some variable substitution: if a string contains `$VAR`, it substitutes the value of `VAR` in the dictionary `SAGE_ENV`. It does this by iterating through the items of `SAGE_ENV`, which means that if both `VAR` and `VAR_OTHER` are in `SAGE_ENV`, it's sort of a coin toss as to what happens when it comes across `$VAR_OTHER`.

(This arose when I was working on #21469: the string `$SAGE_SRC_ROOT` was being replaced by the value of `SAGE_SRC`, followed by the string `_ROOT`.)

Issue created by migration from https://trac.sagemath.org/ticket/23758





---

archive/issue_comments_329589.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-08-30T18:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329589",
    "user": "jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_329590.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-08-30T18:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329590",
    "user": "jhpalmieri"
}
```

New commits:



---

archive/issue_comments_329591.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-30T20:28:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329591",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329592.json:
```json
{
    "body": "I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `\"$SAGE_ROOT\"`?",
    "created_at": "2017-08-30T23:26:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329592",
    "user": "mkoeppe"
}
```

I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `"$SAGE_ROOT"`?



---

archive/issue_comments_329593.json:
```json
{
    "body": "(Could be a follow-up ticket.)",
    "created_at": "2017-08-30T23:41:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329593",
    "user": "mkoeppe"
}
```

(Could be a follow-up ticket.)



---

archive/issue_comments_329594.json:
```json
{
    "body": "Perhaps add a doctest?",
    "created_at": "2017-08-30T23:42:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329594",
    "user": "mkoeppe"
}
```

Perhaps add a doctest?



---

archive/issue_comments_329595.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-08-31T01:18:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329595",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_329596.json:
```json
{
    "body": "Here is a doctest. The same test fails for me in the develop branch, but I suppose that failure may not be repeatable on all platforms, since dictionaries are not ordered.",
    "created_at": "2017-08-31T01:19:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329596",
    "user": "jhpalmieri"
}
```

Here is a doctest. The same test fails for me in the develop branch, but I suppose that failure may not be repeatable on all platforms, since dictionaries are not ordered.



---

archive/issue_comments_329597.json:
```json
{
    "body": "Replying to [comment:4 mkoeppe]:\n> I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `\"$SAGE_ROOT\"`?\n\nI agree, a followup ticket if we want to address this. I'm not sure what the point of the substitution is, compared to using shell variables or some shortcut for accessing `SAGE_ENV['foo']`.",
    "created_at": "2017-08-31T01:22:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329597",
    "user": "jhpalmieri"
}
```

Replying to [comment:4 mkoeppe]:
> I don't know, maybe we can just get rid of this whole variable substitution business, by using the Python variable `SAGE_ROOT` instead of `"$SAGE_ROOT"`?

I agree, a followup ticket if we want to address this. I'm not sure what the point of the substitution is, compared to using shell variables or some shortcut for accessing `SAGE_ENV['foo']`.



---

archive/issue_comments_329598.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-08-31T04:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329598",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329599.json:
```json
{
    "body": "Follow up ticket is #23762.",
    "created_at": "2017-08-31T05:01:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329599",
    "user": "mkoeppe"
}
```

Follow up ticket is #23762.



---

archive/issue_comments_329600.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-08-31T22:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329600",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_329601.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-08-31T22:32:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329601",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_329602.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-08-31T22:33:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329602",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_329603.json:
```json
{
    "body": "Sorry, I accidentally pushed a branch here instead of to the appropriate ticket. The positively reviewed branch has been restored.",
    "created_at": "2017-08-31T22:35:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329603",
    "user": "jhpalmieri"
}
```

Sorry, I accidentally pushed a branch here instead of to the appropriate ticket. The positively reviewed branch has been restored.



---

archive/issue_comments_329604.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-01T15:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329604",
    "user": "mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_329605.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-09-04T06:11:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23521",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23521#issuecomment-329605",
    "user": "vbraun"
}
```

Resolution: fixed
