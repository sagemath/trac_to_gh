# Issue 28635: Bug in normaliz/pynormaliz makes sage crash hard

Issue created by migration from https://trac.sagemath.org/ticket/28872

Original creator: @kliem

Original creation time: 2019-12-11 19:41:05

CC:  tscrim dimpase novoselt winfried nthiery vdelecroix moritz jipilab mmasdeu @braunmath @kliem

Keywords: polyhedron, normaliz, volume

The following innocent code leads sage to crash hard.

```
sage: P = polytopes.dodecahedron(backend='normaliz')
sage: P.volume(measure='induced_lattice')
```


There is apparently a bug in normaliz.

Until this is fixed I propose raising a `NotImplementedError`.


---

Comment by @kliem created at 2019-12-11 19:42:12

For the record:

The underlying normaliz error is


```
python3: ./libnormaliz/cone.cpp:2266: mpq_class libnormaliz::Cone<Integer>::getVolume() [with Integer = renf_elem_class; mpq_class = __gmp_expr<__mpq_struct [1], __mpq_struct [1]>]: Assertion `false' failed.
```



---

Comment by @kliem created at 2019-12-11 19:44:27

New commits:


---

Comment by @kliem created at 2019-12-11 19:44:27

Changing status from new to needs_review.


---

Comment by @kliem created at 2019-12-11 20:21:43

I marked it as blocker because it's an easy fix (for now) and it is potentially really annoying. So I would like to see this being taken care of for the next master.


---

Comment by @kliem created at 2019-12-11 21:41:53

I guess the real question is how we can prevent sage to crash, if normaliz throws an error.


---

Comment by @kliem created at 2019-12-11 21:41:53

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2019-12-11 21:41:53

Changing priority from blocker to critical.


---

Comment by git created at 2019-12-11 21:44:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2019-12-11 21:45:41

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2019-12-11 22:13:52

I can confirm that this does work in the sense that doctests pass. Could someone more familiar with polytope theory verify the mathematical correctness?


---

Comment by @kliem created at 2019-12-11 22:23:47

I don't know if that helps you:

If I remember correctly, the problem is just that C++ allows multiple inputs but only one output. So for `Cone<Integer>` one should use `getVolume` and for `Cone<renf_elem_class>` one should use `getRenfVolume`. This is the corresponding code in normaliz (https://github.com/Normaliz/Normaliz/blob/master/source/libnormaliz/cone.cpp)


```
template <typename Integer>
mpq_class Cone<Integer>::getVolume() {
    compute(ConeProperty::Volume);
    return volume;
}

template <typename Integer>
renf_elem_class Cone<Integer>::getRenfVolume() {
    assert(false);
    return {};
}

#ifdef ENFNORMALIZ
template <>
mpq_class Cone<renf_elem_class>::getVolume() {
    assert(false);
    return 0;
}

template <>
renf_elem_class Cone<renf_elem_class>::getRenfVolume() {
    compute(ConeProperty::RenfVolume);
    return renf_volume;
}
#endif
```


This is also spelled out in the manual https://github.com/Normaliz/Normaliz/blob/master/doc/Normaliz.pdf in section D.9

> In return values Integer must be specialized to renf_elem_class . A special return value is > the volume
> that in general is no longer of type mpq_class . It is retrieved by
> renf_elem_class Cone<renf_elem_class>::getRenfVolume().


---

Comment by tscrim created at 2019-12-12 04:55:01

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-12-12 04:55:01

Ah, I think I understand. It is merely an input distinction (not a mathematical one), and the error comes from the fact that things need to be done by reference except for `ZZ` and `QQ`. Thanks.


---

Comment by Winfried created at 2019-12-12 09:04:19

At present, calling 

```
getVolume()
```

for a cone of renf_elem_class results in an 

```
assert(false)
```

and then in a hard crash. This is the standard solution in Normaliz for coding mistakes. I did not think about the possibility that this might happen outside Normaliz. As a first measurte, I will replace the assert(false) by throwing a NonComputableExcetion. It is caught by PyNormaliz. (The disadvantage of exceptions is that they cannot be traced back.)

I will then thry to find a better solution. Perhaps we can overcome the problem by making the return value a template. But this will change the systematics of the interface between libnormaliz and PyNormaliz.


---

Comment by Winfried created at 2019-12-14 10:42:33

The assert(false) has been replaced by an exception. There should be no assert(false) in public methods of the class Cone anymore.

Pushed to [GitHub](GitHub) branch master.


---

Comment by tscrim created at 2019-12-14 11:31:25

On a later ticket, we can either port the fix as a patch or just wait for the upgrade. Since this has been positively reviewed for 2+ days, I don't think we should make more changes here (unless Volker rejects it for some reason).


---

Comment by vbraun created at 2019-12-17 22:46:42

Resolution: fixed
