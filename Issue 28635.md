# Issue 28635: Bug in normaliz/pynormaliz makes sage crash hard

archive/issues_028635.json:
```json
{
    "body": "CC:  @tscrim @dimpase @novoselt winfried @nthiery @videlec @mo271 @jplab @mmasdeu @braunmath @kliem\n\nKeywords: polyhedron, normaliz, volume\n\nThe following innocent code leads sage to crash hard.\n\n```\nsage: P = polytopes.dodecahedron(backend='normaliz')\nsage: P.volume(measure='induced_lattice')\n```\n\n\nThere is apparently a bug in normaliz.\n\nUntil this is fixed I propose raising a `NotImplementedError`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28872\n\n",
    "created_at": "2019-12-11T19:41:05Z",
    "labels": [
        "geometry",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Bug in normaliz/pynormaliz makes sage crash hard",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28635",
    "user": "@kliem"
}
```
CC:  @tscrim @dimpase @novoselt winfried @nthiery @videlec @mo271 @jplab @mmasdeu @braunmath @kliem

Keywords: polyhedron, normaliz, volume

The following innocent code leads sage to crash hard.

```
sage: P = polytopes.dodecahedron(backend='normaliz')
sage: P.volume(measure='induced_lattice')
```


There is apparently a bug in normaliz.

Until this is fixed I propose raising a `NotImplementedError`.

Issue created by migration from https://trac.sagemath.org/ticket/28872





---

archive/issue_comments_404317.json:
```json
{
    "body": "For the record:\n\nThe underlying normaliz error is\n\n\n```\npython3: ./libnormaliz/cone.cpp:2266: mpq_class libnormaliz::Cone<Integer>::getVolume() [with Integer = renf_elem_class; mpq_class = __gmp_expr<__mpq_struct [1], __mpq_struct [1]>]: Assertion `false' failed.\n```\n",
    "created_at": "2019-12-11T19:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404317",
    "user": "@kliem"
}
```

For the record:

The underlying normaliz error is


```
python3: ./libnormaliz/cone.cpp:2266: mpq_class libnormaliz::Cone<Integer>::getVolume() [with Integer = renf_elem_class; mpq_class = __gmp_expr<__mpq_struct [1], __mpq_struct [1]>]: Assertion `false' failed.
```




---

archive/issue_comments_404318.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-12-11T19:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404318",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_404319.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-12-11T19:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404319",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_404320.json:
```json
{
    "body": "I marked it as blocker because it's an easy fix (for now) and it is potentially really annoying. So I would like to see this being taken care of for the next master.",
    "created_at": "2019-12-11T20:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404320",
    "user": "@kliem"
}
```

I marked it as blocker because it's an easy fix (for now) and it is potentially really annoying. So I would like to see this being taken care of for the next master.



---

archive/issue_comments_404321.json:
```json
{
    "body": "I guess the real question is how we can prevent sage to crash, if normaliz throws an error.",
    "created_at": "2019-12-11T21:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404321",
    "user": "@kliem"
}
```

I guess the real question is how we can prevent sage to crash, if normaliz throws an error.



---

archive/issue_comments_404322.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-12-11T21:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404322",
    "user": "@kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_404323.json:
```json
{
    "body": "Changing priority from blocker to critical.",
    "created_at": "2019-12-11T21:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404323",
    "user": "@kliem"
}
```

Changing priority from blocker to critical.



---

archive/issue_comments_404324.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-12-11T21:44:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404324",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_404325.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-12-11T21:45:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404325",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_404326.json:
```json
{
    "body": "I can confirm that this does work in the sense that doctests pass. Could someone more familiar with polytope theory verify the mathematical correctness?",
    "created_at": "2019-12-11T22:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404326",
    "user": "@tscrim"
}
```

I can confirm that this does work in the sense that doctests pass. Could someone more familiar with polytope theory verify the mathematical correctness?



---

archive/issue_comments_404327.json:
```json
{
    "body": "I don't know if that helps you:\n\nIf I remember correctly, the problem is just that C++ allows multiple inputs but only one output. So for `Cone<Integer>` one should use `getVolume` and for `Cone<renf_elem_class>` one should use `getRenfVolume`. This is the corresponding code in normaliz (https://github.com/Normaliz/Normaliz/blob/master/source/libnormaliz/cone.cpp)\n\n\n```\ntemplate <typename Integer>\nmpq_class Cone<Integer>::getVolume() {\n    compute(ConeProperty::Volume);\n    return volume;\n}\n\ntemplate <typename Integer>\nrenf_elem_class Cone<Integer>::getRenfVolume() {\n    assert(false);\n    return {};\n}\n\n#ifdef ENFNORMALIZ\ntemplate <>\nmpq_class Cone<renf_elem_class>::getVolume() {\n    assert(false);\n    return 0;\n}\n\ntemplate <>\nrenf_elem_class Cone<renf_elem_class>::getRenfVolume() {\n    compute(ConeProperty::RenfVolume);\n    return renf_volume;\n}\n#endif\n```\n\n\nThis is also spelled out in the manual https://github.com/Normaliz/Normaliz/blob/master/doc/Normaliz.pdf in section D.9\n\n> In return values Integer must be specialized to renf_elem_class . A special return value is > the volume\n> that in general is no longer of type mpq_class . It is retrieved by\n> renf_elem_class Cone<renf_elem_class>::getRenfVolume().",
    "created_at": "2019-12-11T22:23:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404327",
    "user": "@kliem"
}
```

I don't know if that helps you:

If I remember correctly, the problem is just that C++ allows multiple inputs but only one output. So for `Cone<Integer>` one should use `getVolume` and for `Cone<renf_elem_class>` one should use `getRenfVolume`. This is the corresponding code in normaliz (https://github.com/Normaliz/Normaliz/blob/master/source/libnormaliz/cone.cpp)


```
template <typename Integer>
mpq_class Cone<Integer>::getVolume() {
    compute(ConeProperty::Volume);
    return volume;
}

template <typename Integer>
renf_elem_class Cone<Integer>::getRenfVolume() {
    assert(false);
    return {};
}

#ifdef ENFNORMALIZ
template <>
mpq_class Cone<renf_elem_class>::getVolume() {
    assert(false);
    return 0;
}

template <>
renf_elem_class Cone<renf_elem_class>::getRenfVolume() {
    compute(ConeProperty::RenfVolume);
    return renf_volume;
}
#endif
```


This is also spelled out in the manual https://github.com/Normaliz/Normaliz/blob/master/doc/Normaliz.pdf in section D.9

> In return values Integer must be specialized to renf_elem_class . A special return value is > the volume
> that in general is no longer of type mpq_class . It is retrieved by
> renf_elem_class Cone<renf_elem_class>::getRenfVolume().



---

archive/issue_comments_404328.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-12-12T04:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404328",
    "user": "@tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_404329.json:
```json
{
    "body": "Ah, I think I understand. It is merely an input distinction (not a mathematical one), and the error comes from the fact that things need to be done by reference except for `ZZ` and `QQ`. Thanks.",
    "created_at": "2019-12-12T04:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404329",
    "user": "@tscrim"
}
```

Ah, I think I understand. It is merely an input distinction (not a mathematical one), and the error comes from the fact that things need to be done by reference except for `ZZ` and `QQ`. Thanks.



---

archive/issue_comments_404330.json:
```json
{
    "body": "At present, calling \n\n```\ngetVolume()\n```\n\nfor a cone of renf_elem_class results in an \n\n```\nassert(false)\n```\n\nand then in a hard crash. This is the standard solution in Normaliz for coding mistakes. I did not think about the possibility that this might happen outside Normaliz. As a first measurte, I will replace the assert(false) by throwing a NonComputableExcetion. It is caught by PyNormaliz. (The disadvantage of exceptions is that they cannot be traced back.)\n\nI will then thry to find a better solution. Perhaps we can overcome the problem by making the return value a template. But this will change the systematics of the interface between libnormaliz and PyNormaliz.",
    "created_at": "2019-12-12T09:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404330",
    "user": "Winfried"
}
```

At present, calling 

```
getVolume()
```

for a cone of renf_elem_class results in an 

```
assert(false)
```

and then in a hard crash. This is the standard solution in Normaliz for coding mistakes. I did not think about the possibility that this might happen outside Normaliz. As a first measurte, I will replace the assert(false) by throwing a NonComputableExcetion. It is caught by PyNormaliz. (The disadvantage of exceptions is that they cannot be traced back.)

I will then thry to find a better solution. Perhaps we can overcome the problem by making the return value a template. But this will change the systematics of the interface between libnormaliz and PyNormaliz.



---

archive/issue_comments_404331.json:
```json
{
    "body": "The assert(false) has been replaced by an exception. There should be no assert(false) in public methods of the class Cone anymore.\n\nPushed to [GitHub](GitHub) branch master.",
    "created_at": "2019-12-14T10:42:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404331",
    "user": "Winfried"
}
```

The assert(false) has been replaced by an exception. There should be no assert(false) in public methods of the class Cone anymore.

Pushed to [GitHub](GitHub) branch master.



---

archive/issue_comments_404332.json:
```json
{
    "body": "On a later ticket, we can either port the fix as a patch or just wait for the upgrade. Since this has been positively reviewed for 2+ days, I don't think we should make more changes here (unless Volker rejects it for some reason).",
    "created_at": "2019-12-14T11:31:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404332",
    "user": "@tscrim"
}
```

On a later ticket, we can either port the fix as a patch or just wait for the upgrade. Since this has been positively reviewed for 2+ days, I don't think we should make more changes here (unless Volker rejects it for some reason).



---

archive/issue_comments_404333.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-12-17T22:46:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28635",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28635#issuecomment-404333",
    "user": "@vbraun"
}
```

Resolution: fixed
