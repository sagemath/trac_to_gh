# Issue 18159: Handle substitutions of partial sums and products

archive/issues_018159.json:
```json
{
    "body": "CC:  mjo mmezzarobba\n\nSage is not able to identify partial sum in a substitution\n\n```\nsage: var('x,y,z')\nsage: f = x^4 + x^2 + x\nsage: f.subs(x^4 + x^2 == y)\nx^4 + x^2 + x\n```\n\nSimilarly with products\n\n```\nsage: f = x * cos(x) * sin(x)\nsage: f.subs( cos(x) * sin(x) == y)\nx*cos(x)*sin(x)\n```\n\n\nAs mentioned in the doc, this is the same behavior as in Maple but differ from Mathematica. We should be clearer on the semantic of `substitute` and potentially implement partial sum and product substitutions.\n\nIssue created by migration from https://trac.sagemath.org/ticket/18396\n\n",
    "created_at": "2015-05-10T16:21:49Z",
    "labels": [
        "symbolics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Handle substitutions of partial sums and products",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18159",
    "user": "vdelecroix"
}
```
CC:  mjo mmezzarobba

Sage is not able to identify partial sum in a substitution

```
sage: var('x,y,z')
sage: f = x^4 + x^2 + x
sage: f.subs(x^4 + x^2 == y)
x^4 + x^2 + x
```

Similarly with products

```
sage: f = x * cos(x) * sin(x)
sage: f.subs( cos(x) * sin(x) == y)
x*cos(x)*sin(x)
```


As mentioned in the doc, this is the same behavior as in Maple but differ from Mathematica. We should be clearer on the semantic of `substitute` and potentially implement partial sum and product substitutions.

Issue created by migration from https://trac.sagemath.org/ticket/18396





---

archive/issue_comments_244902.json:
```json
{
    "body": "I'm not so sure we have to do more than document it. Obviously you cannot expect substitutions to happen on any \"equal\" subexpression, since that concept isn't well-defined.\n\nThe thing is: `x+x^2` isn't a syntactical subunit of `x + x^2 + x^4` for the internal representation, which is roughly `('+',x,('^',x,2))` versus `('+',x,('<sup>',x,2),('</sup>',x,4))`\n\nYou'll have to decide how much tricks are worthwhile to implement before you just add the relation `y-(x^2+x)` and ask for elimination of x via groebner bases.",
    "created_at": "2015-05-10T16:47:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18159#issuecomment-244902",
    "user": "nbruin"
}
```

I'm not so sure we have to do more than document it. Obviously you cannot expect substitutions to happen on any "equal" subexpression, since that concept isn't well-defined.

The thing is: `x+x^2` isn't a syntactical subunit of `x + x^2 + x^4` for the internal representation, which is roughly `('+',x,('^',x,2))` versus `('+',x,('<sup>',x,2),('</sup>',x,4))`

You'll have to decide how much tricks are worthwhile to implement before you just add the relation `y-(x^2+x)` and ask for elimination of x via groebner bases.



---

archive/issue_comments_244903.json:
```json
{
    "body": "Replying to [comment:2 nbruin]:\n> I'm not so sure we have to do more than document it. Obviously you cannot expect substitutions to happen on any \"equal\" subexpression, since that concept isn't well-defined.\n\nI do not want to substitute \"equal\" subexpression but only identical ones. And doing so, I want to consider 'a+c' as a unit of 'a+b+c+d' and 'a*c' as a unit in 'a*b*c*d'. This is perhaps not desirable though.\n\n> The thing is: `x+x^2` isn't a syntactical subunit of `x + x^2 + x^4` for the internal representation, which is roughly `('+',x,('^',x,2))` versus `('+',x,('<sup>',x,2),('</sup>',x,4))`\n\nI know, and this is precisely the purpose of the ticket.\n\n> You'll have to decide how much tricks are worthwhile to implement before you just add the relation `y-(x^2+x)` and ask for elimination of x via groebner bases.\n\nNote that `x + y - (u + v)` does not exist. But I agree that there is an ambiguous `+/-` issue (as far as the ticket description is concerned).",
    "created_at": "2015-05-10T18:52:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18159#issuecomment-244903",
    "user": "vdelecroix"
}
```

Replying to [comment:2 nbruin]:
> I'm not so sure we have to do more than document it. Obviously you cannot expect substitutions to happen on any "equal" subexpression, since that concept isn't well-defined.

I do not want to substitute "equal" subexpression but only identical ones. And doing so, I want to consider 'a+c' as a unit of 'a+b+c+d' and 'a*c' as a unit in 'a*b*c*d'. This is perhaps not desirable though.

> The thing is: `x+x^2` isn't a syntactical subunit of `x + x^2 + x^4` for the internal representation, which is roughly `('+',x,('^',x,2))` versus `('+',x,('<sup>',x,2),('</sup>',x,4))`

I know, and this is precisely the purpose of the ticket.

> You'll have to decide how much tricks are worthwhile to implement before you just add the relation `y-(x^2+x)` and ask for elimination of x via groebner bases.

Note that `x + y - (u + v)` does not exist. But I agree that there is an ambiguous `+/-` issue (as far as the ticket description is concerned).



---

archive/issue_comments_244904.json:
```json
{
    "body": "However, even the `whole matching` does not work consistently. See https://github.com/pynac/pynac/issues/269",
    "created_at": "2017-08-10T13:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18159",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18159#issuecomment-244904",
    "user": "rws"
}
```

However, even the `whole matching` does not work consistently. See https://github.com/pynac/pynac/issues/269
