# Issue 17061: Adding Graded/Weighted Hilbert Series Functionality to Sage

Issue created by migration from https://trac.sagemath.org/ticket/17298

Original creator: john_perry

Original creation time: 2014-11-06 06:51:26




---

Comment by john_perry created at 2014-11-06 06:54:59

Changing component from PLEASE CHANGE to commutative algebra.


---

Comment by john_perry created at 2014-11-06 06:54:59

Changing type from PLEASE CHANGE to enhancement.


---

Comment by john_perry created at 2014-11-06 06:54:59

Changing keywords from "" to "Hilbert Series, weighted, singular".


---

Comment by john_perry created at 2014-11-06 07:01:28

Hello

The description should explain the basic issue, but this is the first change I'm submitting via git & I can't seem to click on the "branch" field above, so as to ensure the changes I expected to see are actually there. I did follow the directions in the Developer's Guide, through `git trac push`; as far as I can tell, the subsequent sections don't apply. Please let me know if you also can't see the changes.


---

Comment by john_perry created at 2014-11-06 07:01:28

Changing status from new to needs_review.


---

Comment by jakobkroeker created at 2014-11-06 09:45:02

others also can't see the changes.

you could probably succeed with the sage dev scripts instead of using git directly,
see http://www.sagemath.org/doc/developer/dev_script.html#chapter-devscript


---

Comment by john_perry created at 2014-11-06 09:51:08

Replying to [comment:4 jakobkroeker]:
> others also can't see the changes.

Thanks. Even worse, I found an error, tried to change the file, and discovered after the fact that Sage had reverted all my changes to the original. I'm deeply confused why this is happening.

> you could probably succeed with the sage dev scripts instead of using git directly,
> see http://www.sagemath.org/doc/developer/dev_script.html#chapter-devscript

...which has a green box declaring,

    *Hint:* We recommend to not use the developer scripts. You will have to _learn git_ sooner or later, why not start now?

:-) I'll try it. Thanks again.


---

Comment by jakobkroeker created at 2014-11-06 10:07:28

> re: learn git

If you are unfamiliar with git, I would also recommend that you experiment a bit in a sandbox project first. There are great tutorials on the web.

>Even worse, I found an error, tried to change the file, and discovered after the fact that Sage had >reverted all my changes to the original. I'm deeply confused why this is happening.

just guessing; you checked out a different branch 
(check on which branch you are with 'git branch')? 
Or did a 'git reset' or similar? 
Or you edited an installed file instead a repository file? 
After changing a file before it is committed you should see that something changed with 'git status'


---

Comment by john_perry created at 2014-11-06 10:16:52

Replying to [comment:6 jakobkroeker]:
> >Even worse, I found an error, tried to change the file, and discovered after the fact that Sage had >reverted all my changes to the original. I'm deeply confused why this is happening.
> 
> just guessing; you checked out a different branch

Nope
 
> (check on which branch you are with 'git branch')? 

sage$ git branch
  develop
  master
  multigraded_hilbert
* t/17298/adding_graded_weighted_hilbert_series_functionality_to_sage
  ticket/10716
  ticket_10716

It looks to me that, if anything changed, it was done by git itself. I *should* be on "multigraded_hilbert". (I THINK. I was seeing this problem before I tried to commit, too.)

> Or did a 'git reset' or similar? 

Nope.

> Or you edited an installed file instead a repository file? 

Uhmmm... Where is this distinction made in the developer's guide?

Wait a second. Looking at what `git branch` told me above, I switched to the `multigraded_hilbert` branch, and found the changes I made. I did not create this new branch manually. Apparently, this change occurred when `git commit` created a new trac ticket?


---

Comment by jakobkroeker created at 2014-11-06 10:56:40

> I *should* be on "multigraded_hilbert"

not necessarily. 
The workflow is to create a new ticket using 'git trac create', 
which likely created and switched to
't/17298/adding_graded_weighted_hilbert_series_functionality_to_sage' 
and THEN do the changes on that branch. 

What I would try is while on 'multigraded_hilbert' do 
'git diff t/17298/adding_graded_weighted_hilbert_series_functionality_to_sage' 
and if the diff has only your changes, 
switch to 't/17298/adding_graded_weighted_hilbert_series_functionality_to_sage' ,
and 'git merge multigraded_hilbert'
into your ticket.


---

Comment by vbraun created at 2014-11-06 11:12:12

It seems you are using the git-trac script. 
* `git checkout` switches between local branches
* `git trac checkout` will download a branch from our git server and switch to it

You should figure out which local branch contains your changes, then switch to it, then run `git trac push 17298` to upload it to this ticket (you might need to add `--force`). And delete the unwanted local branch.


---

Comment by git created at 2014-11-06 11:33:42

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-11-06 11:37:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by john_perry created at 2014-11-06 11:38:39

Thank you, Volker! I'm seeing the changes, and they're looking like what I expected. (Forgot to commit the last change before the first push; sorry about that.)


---

Comment by tscrim created at 2014-11-06 18:59:43

So I've made some reviewer changes to clean up the code which better handles things like `grading=(2/2, int(3))`. It might be nice to add support for grading given as a vector or an additive abelian group, but that can be done later. So if you're happy with my changes, then you can set a positive review.
----
New commits:


---

Comment by john_perry created at 2014-11-07 08:05:53

Replying to [comment:13 tscrim]:
> So I've made some reviewer changes to clean up the code which better handles things like `grading=(2/2, int(3))`. It might be nice to add support for grading given as a vector or an additive abelian group, but that can be done later. So if you're happy with my changes, then you can set a positive review.

I had thought about a vector, but it was so little work I figured the client could do it. Grading by an additive abelian group is a new one to me; how does that work? If it isn't too much trouble, we could work it into this ticket; otherwise, I'll just mark it "positive review."


---

Comment by tscrim created at 2014-11-07 08:38:09

Replying to [comment:14 john_perry]:
> I had thought about a vector, but it was so little work I figured the client could do it. Grading by an additive abelian group is a new one to me; how does that work? If it isn't too much trouble, we could work it into this ticket; otherwise, I'll just mark it "positive review."

Well, (free) additive abelian groups of rank n are just ZZ<sup>n</sup>. Although IDK if it makes mathematical sense to consider a grading group with torsion (such as exterior algebras which have a natural ZZ<sub>2</sub> grading), and if it doesn't, that's a bunch of parent checking. Yet from a coding point of view, one just needs to pass it to `tuple`:

```
sage: G = AdditiveAbelianGroup([0,0])
sage: x = G(vector([4,2])); x
(4, 2)
sage: tuple(x)
(4, 2)
```

So since you're okay with making the user do things for a vector, then I'd say set a positive review.


---

Comment by john_perry created at 2014-11-07 09:39:56

Replying to [comment:15 tscrim]:
> So since you're okay with making the user do things for a vector, then I'd say set a positive review.

That's likely what I'll do. The changes you made are definitely an improvement; unfortunately, they require me to rebuild a whole bunch of things, * _some of which don't build! _ *



```
from cpython.slice cimport *
^
------------------------------------------------------------

./sage/ext/python.pxi:23:0: 'cpython.slice.pxd' not found
Traceback (most recent call last):
  File "/Applications/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 919, in cythonize_one_helper
    return cythonize_one(*m[1:])
  File "/Applications/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 902, in cythonize_one
    raise CompileError(None, pyx_file)
CompileError: sage/algebras/quatalg/quaternion_algebra_cython.pyx
Traceback (most recent call last):
  File "setup.py", line 565, in <module>
    run_cythonize()
  File "setup.py", line 557, in run_cythonize
    'profile': profile,
  File "/Applications/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 782, in cythonize
    pool.map(cythonize_one_helper, to_compile)
  File "/Applications/sage/local/lib/python/multiprocessing/pool.py", line 251, in map
Cythonizing sage/modules/vector_complex_double_dense.pyx
    return self.map_async(func, iterable, chunksize).get()
  File "/Applications/sage/local/lib/python/multiprocessing/pool.py", line 558, in get
    raise self._value
Cython.Compiler.Errors.CompileError: sage/algebras/quatalg/quaternion_algebra_cython.pyx
```


So I'm not sure I _can_ put a positive review on it, even though this is clearly a different problem, simply because I can't test it.


---

Comment by john_perry created at 2014-11-07 09:41:58

NOTE: _...and_ it's rebuilding all the Cython code, even when I switch back. That's deeply annoying: the only change here lies in a few lines of *one Python module.*


---

Comment by tscrim created at 2014-11-07 15:41:51

Ah sorry, I forgot to mention that I upgraded it to the latest development version (the `develop` branch), which (likely) requires you to run `make` (or `make build`) from Sage's root directory. So you might want to do the following:

```
git fetch trac develop:develop
```

where `trac` is my remote name for trac's git server, and then base everything off that branch (perhaps merging it into your other branches before running `make`).


---

Comment by john_perry created at 2014-11-07 15:52:01

Replying to [comment:18 tscrim]:
> Ah sorry, I forgot to mention that I upgraded it to the latest development version (the `develop` branch), which (likely) requires you to run `make` (or `make build`) from Sage's root directory. ...

OK. I'm afraid I won't be doing that anytime soon; I can't afford to tie up my installation for 2 hours of compilation every time a few lines of Python code change, and I'm traveling, so I only have one laptop with me, which I need for work. I'll try to do it before too long, though.


---

Comment by tscrim created at 2014-11-07 16:03:40

Well, something you can do to check my commits is create another branch based off `d1703bc` and cherry-pick the 2 non-merge commits.


---

Comment by john_perry created at 2014-11-08 06:14:48

Two comments, requesting change:

    * In the Hilbert numerator function, the documentation is wrong: "Hilbert numerator" changed to "Hilbert series." I presume that's a copy & paste error. :-)

    * The original error message,
         Grading for Hilbert Series must be a list or tuple of integers
      has changed to,
         Grading must be a list or a tuple of integers.
      When I run a script or program, I find it useful when an error message tells me not only _that_ something is wrong, but also _where_ it's wrong. Can you change it back to the original error message? (This is the kind of thing I notice only when I edit the changes by hand.)


---

Comment by git created at 2014-11-08 17:01:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-11-08 17:07:24

Fixed the c/p error. However the traceback tells you where the error occurred:

```
sage: P.<x,y,z> = PolynomialRing(QQ)
sage: I = Ideal([x^3*y^2 + 3*x^2*y^2*z + y^3*z^2 + z^5])
sage: I.hilbert_numerator(grading=5)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-49f8689d83b8> in <module>()
----> 1 I.hilbert_numerator(grading=Integer(5))

/home/travis/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in __call__(self, *args, **kwds)
    603         if not R.base_ring().is_field():
    604             raise ValueError("Coefficient ring must be a field for function '%s'."%(self.f.__name__))
--> 605         return self.f(self._instance, *args, **kwds)
    606 
    607 require_field = RequireField

/home/travis/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/multi_polynomial_ideal.pyc in hilbert_numerator(self, singular, grading)
   2824         if grading is not None:
   2825             if not isinstance(grading, (list, tuple)) or any(a not in ZZ for a in grading):
-> 2826                 raise TypeError("Grading must be a list or a tuple of integers.")
   2827 
   2828             hs = hilb(gb, 1, tuple(grading), attributes={gb: {'isSB': 1}})

TypeError: Grading must be a list or a tuple of integers.
```

I believe the error message should be concise and not repeat information (plus I think most error messages in Sage/python don't tell you this info and rely on the traceback). However if you feel strongly about having `Hilbert series` into the error message, I'll change it.


---

Comment by john_perry created at 2014-11-08 17:12:33

Changing status from needs_review to positive_review.


---

Comment by john_perry created at 2014-11-08 17:12:33

Replying to [comment:23 tscrim]:
> However the traceback tells you where the error occurred: ...
> {{{
> TypeError: Grading must be a list or a tuple of integers.
> }}}
> I believe the error message should be concise and not repeat information (plus I think most error messages in Sage/python don't tell you this info and rely on the traceback).

OK, I think I had confused this type of error message with another (e.g., I'm working with a Cython program, and it doesn't usually tell you where something happened). I'll give it a positive review.

Thank you very much for the help w/improving this patch. :-)


---

Comment by tscrim created at 2014-11-08 17:18:12

Not a problem.


---

Comment by vbraun created at 2014-11-15 16:21:28

Resolution: fixed


---

Comment by john_perry created at 2014-11-19 09:16:36

The Milestone says "sage-6.4", but I'm looking at Sage 6.4 code and it's not in there. Does that happen often?


---

Comment by vbraun created at 2014-11-19 10:27:50

See https://groups.google.com/d/msg/sage-devel/sY0Be1aXxSg/XofRuzl8obkJ
