# Issue 15941: Build maxima fasl without asdf

Issue created by migration from https://trac.sagemath.org/ticket/16178

Original creator: gagern

Original creation time: 2014-04-17 08:16:35

Keywords: maxima ecl

Currently, the maxima install process uses asdf to create a fasl file. This has caused problems in several situations already, most notably in sage-on-gentoo. There I came up with a different approach, which doesn't use asdf but instead patches the maxima build instructions to emit the fasl along with the program. Essentially I duplicate the `c::build-program` invocation and turn that duplicate into `c::build-fasl`. I guess doing so might be beneficial to sage as well. I'll create this ticket here then start working on a branch which includes my approach.

References:

* [sage-on-gentoo ticket 226](https://github.com/cschwan/sage-on-gentoo/issues/226) with detailed analysis of the problems encountered
* [Gentoo ticket 499634](https://bugs.gentoo.org/show_bug.cgi?id=499634) which resulted in the inclusion of my approach into the maxima ebuild for Gentoo
* comment:48:ticket:14636 mentioned the sage-on-gentoo approach, and there was some interest in getting this into sage itself as well


---

Comment by fbissey created at 2014-04-17 11:41:04

Glad to see you taking the lead on that one. I was planning to do something about it post 6.2.
----
New commits:


---

Comment by gagern created at 2014-04-17 11:49:31

Note that this modification here should also allow upgrades to ECL, which in turn might benefit some other issues related to ECL. comment:46:ticket:14636 mentions the support for ECL 13.5.1 currently available for sage-on-gentoo. comment:47:ticket:14636 asks for a discussion related to upgrading the ECL pkg. As far as I can tell, there is no such ticket (yet) in sage trac.

I also notified ticket:11786 since it _might_ be that this change fixes that issue as well.


---

Comment by gagern created at 2014-04-17 11:55:41

Changing status from new to needs_review.


---

Comment by fbissey created at 2014-04-17 12:09:57

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2014-04-17 12:09:57

In principle, I will put this as positive. It is not like we haven't been using the stuff for several months, and I did use it on OS X too.


---

Comment by gagern created at 2014-04-17 14:24:07

I wonder whether I should bump the patch level of the package version. If so, should I update `SPKG.txt` as well? If so, should I add a section about [`maxima-5.29.1.p4`](http://git.sagemath.org/sage.git/commit/?id=148fc5808c66d6d2a0eae8846de6d88fd332d5ff) as well? With what content?


---

Comment by fbissey created at 2014-04-17 20:10:49

Changing status from positive_review to needs_work.


---

Comment by fbissey created at 2014-04-17 20:10:49

I knew I was forgetting something. We need to bump the patch level if we want this to be upgraded from the old way. As for SPKG.txt the new way is to slim them down because most of the interesting stuff is in the commit message, also a few lines about this wouldn't go amiss. Look at eclib and flint for current example.


---

Comment by gagern created at 2014-04-18 15:38:37

Replying to [comment:7 fbissey]:
> We need to bump the patch level if we want this to be upgraded from the old way.

That's the easy part.

> As for SPKG.txt the new way is to slim them down because most of the interesting stuff is in the commit message[…]. Look at eclib and flint for current example.

Looking at them, and at [the Developer's Guide](http://sagemath.org/doc/developer/packaging.html#the-spkg-txt-file), it seems as if the best way would be removing the Changelog.

I'm less sure about the information about “How to make a new version of the Maxima spkg”. I haven't tried it, don't know whether it's correct any more. If it is, should it be moved to the “Special !Update/Build Instructions” section instead?

The part about `spkg-dist` seems to refer to what `spkg-src` does now. Perhaps that should go into a comment inside that script instead? Although this one sentence in the “Special !Update/Build Instructions” already sums it up: “It removes a large amount of unused documentation and disables the associated Makefiles, reducing the size of the SPKG greatly.”

> also a few lines about this wouldn't go amiss.

I'm unsure about what exactly you are referring to here. A few lines about the current `SPKG.txt` conventions, like those in the dev guide? Or a few lines about my modifications, despite the fact that this is against the trend of slimming the files down?


---

Comment by fbissey created at 2014-04-20 11:33:18

spkg-src and spkg-dist are for non trivial sources that requires special steps to produce beyond simple patching (pulling a particular revision and stuff like that). Here removing the documentation to save space. 
But we haven't really changed the sources to be distributed with sage so no concern. 

I think in SPKG.txt you can create a section describing the patches and what they do. pari has a README.txt in the patches sub-folder but it also has a quantity of patches. Other than that, yes you can cull the changelog.


---

Comment by git created at 2014-04-21 13:14:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2014-04-22 07:18:00

Changing status from needs_work to positive_review.


---

Comment by fbissey created at 2014-04-22 07:18:00

Yes, that looks OK now. Let's get on with it.


---

Comment by vbraun created at 2014-04-22 15:23:12

reviewer name


---

Comment by vbraun created at 2014-04-22 17:54:55

Resolution: fixed


---

Comment by dimpase created at 2014-04-23 06:34:23

asdf is the normal way to build Lisp packages, IMHO. Removing it is akin to removing makefiles and replacing them with hand-written scripts. Is it the way to go? asdf is actively developed and maintained. Perhaps one should ask for help instead?

I only saw this ticket on sage-release, that's why a late reaction.


---

Comment by fbissey created at 2014-04-23 07:07:41

Don't worry. The wording may be a bit misleading. We don't ditch asdf but instead of doing a separate invocation at the end to build the maxima library we patch the build system to build it in parallel. So asdf is not gone ;)


---

Comment by gagern created at 2014-04-23 08:01:21

Replying to [comment:14 dimpase]:
> asdf is the normal way to build Lisp packages, IMHO. Removing it is akin to removing makefiles and replacing them with hand-written scripts. Is it the way to go? asdf is actively developed and maintained. Perhaps one should ask for help instead?

To clarify in my own words: I'm not removing asdf, but I'm removing the use of a separate ASDF invocation to build the maxima library. If you look at the diff for [880002d](http://git.sagemath.org/sage.git/commit/?id=880002dc3e5348bfa37ad722f3c099c1898b6128), you will see that up to now, there would be several lines of ecl script in the spkg-install script, which do the asdf calling. As far as I know, noone has been able to make that work with more recent versions of ECL so far. Last I tried, I encountered two problems. The minor one was that apparently a lot of files got compiled twice, which is unneccessary work at the least. The major problem however is the fact that [apparently maxima got initialized twice](https://github.com/cschwan/sage-on-gentoo/issues/226#issuecomment-19102909), which caused a stack overflow due to recursive copying of a cyclic data structure.

The reason for this, as I see it, is that maxima is neither designed to be used as a library, nor to be built with asdf. They directly speak to the [ecl compiler functions](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/cmp/cmpmain.lsp), and call `c::build-program`. And the logical counterpart to `c::build-program` appears to be `c::build-fasl`. So all I'm doing is building a FASL in what seems closest to what Maxima already does.

I don't know enough lisp to decide how standard asdf is. But if asdf really were the (only) way to go, then I'd suggest you file a Maxima bug and ask them to switch their whole compilation process to asdf. Unless you are comfortable doing that, I don't see your argument applying to sage alone. To go with your metaphor: you have an application which is designed to build using a single hand-written build script, and now have to decide whether it is easier to patch that build script or to add an extra makefile to build some additional targets. Both approaches have drawbacks, neither is really clean, but if one is known to fail with newer releases of some component, I'd go with the one that still works.


---

Comment by gagern created at 2014-04-23 12:22:03

comment:14 deleted the *Commit* field of this ticket. What is the effect of that? Will it somehow prevent this feature from being included in the next release? If so, I believe that the current status of this ticket as *closed fixed* is no longer appropriate either. If, on the other hand, deleting the Commit field has not technical consequence, then I don't see the point. What's the intention there? Or was this something done automatically by some Trac plugin?


---

Comment by vbraun created at 2014-04-23 12:30:31

If you edit a comment after a push then trac will helpfully suggest to remove the "Commit:" field. Right now you need to click on the "revert" link in the preview before sending off the comment. Its a bug in our workflow but does not prevent the ticket from being merged (at least until it is fixed).


---

Comment by infinity0 created at 2016-11-12 18:09:31

I've asked Maxima upstream to accept the FASL patch: https://sourceforge.net/p/maxima/patches/80/

I don't know the surrounding Lisp ecosystem very well, so please help me with making points etc in case they have reservations about it.
