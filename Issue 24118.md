# Issue 24118: inconsistent interval evaluation of pFq

archive/issues_024118.json:
```json
{
    "body": "CC:  deinst\n\n\n```\nsage: foo = 1/4*hypergeometric((1, 1, 1, 1, 1), (3/2, 2, 2, 2), 1/8)\nsage: a = RBF(foo); a\n[0.2526850273732758 +/- 5.66e-18]\nsage: b = RealBallField(100)(foo); b\n[0.2526850273732758327317762593029 +/- 4.32e-32]\nsage: a.overlaps(b)\nFalse\n```\n\n\nThis doesn't happen with python-flint and the last version of arb: it may either be a sage-specific issue or a bug in the version of arb that sage is using.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24355\n\n",
    "created_at": "2017-12-09T19:49:53Z",
    "labels": [
        "numerical",
        "major",
        "bug"
    ],
    "title": "inconsistent interval evaluation of pFq",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24118",
    "user": "mmezzarobba"
}
```
CC:  deinst


```
sage: foo = 1/4*hypergeometric((1, 1, 1, 1, 1), (3/2, 2, 2, 2), 1/8)
sage: a = RBF(foo); a
[0.2526850273732758 +/- 5.66e-18]
sage: b = RealBallField(100)(foo); b
[0.2526850273732758327317762593029 +/- 4.32e-32]
sage: a.overlaps(b)
False
```


This doesn't happen with python-flint and the last version of arb: it may either be a sage-specific issue or a bug in the version of arb that sage is using.

Issue created by migration from https://trac.sagemath.org/ticket/24355





---

archive/issue_comments_337884.json:
```json
{
    "body": "The balls are suspiciously precise. It looks like it's going through `RealField`:\n\n\n```\nsage: RealBallField(53)(RealField(53)(foo))\n[0.2526850273732758 +/- 5.66e-18]\nsage: RealBallField(100)(RealField(100)(foo))\n[0.2526850273732758327317762593029 +/- 4.32e-32]\n```\n",
    "created_at": "2018-02-24T15:43:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24118#issuecomment-337884",
    "user": "fredrik.johansson"
}
```

The balls are suspiciously precise. It looks like it's going through `RealField`:


```
sage: RealBallField(53)(RealField(53)(foo))
[0.2526850273732758 +/- 5.66e-18]
sage: RealBallField(100)(RealField(100)(foo))
[0.2526850273732758327317762593029 +/- 4.32e-32]
```




---

archive/issue_comments_337885.json:
```json
{
    "body": "The underlying problem here is in the RBF `element_constructor` the coercion attempts are something like\n1.  Try to convert directly to a RealBall\n2. Try to convert to a pyobject, then to a RealBall\n3. Try to convert the operands of the object to RealBalls, then apply the operator to them to compute the RealBall\n4. Drop back and compute the value as an element of RealIntervalField then convert to a RealBall\n\nIn this case step 3 goes horribly wrong because the first operand  of hypergeometric((1, 1, 1, 1, 1), (3/2, 2, 2, 2), 1/8) is a tuple and any attempt to convert it to a RealBall is doomed to failure.  This coupled with the fact that the RealBall field does not implement the hypergeometric functions (connecting arb_hypgeom_pfq to RealBall seems straightforward, but connecting that somehow to symbolic.expression seems problematic).\n\nWhich basically means that this is all over my head.\n\nThe fact that step 4 succeeds but gives an incorrect answer suggests that there are similar problems with RIF.",
    "created_at": "2018-08-23T00:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24118#issuecomment-337885",
    "user": "deinst"
}
```

The underlying problem here is in the RBF `element_constructor` the coercion attempts are something like
1.  Try to convert directly to a RealBall
2. Try to convert to a pyobject, then to a RealBall
3. Try to convert the operands of the object to RealBalls, then apply the operator to them to compute the RealBall
4. Drop back and compute the value as an element of RealIntervalField then convert to a RealBall

In this case step 3 goes horribly wrong because the first operand  of hypergeometric((1, 1, 1, 1, 1), (3/2, 2, 2, 2), 1/8) is a tuple and any attempt to convert it to a RealBall is doomed to failure.  This coupled with the fact that the RealBall field does not implement the hypergeometric functions (connecting arb_hypgeom_pfq to RealBall seems straightforward, but connecting that somehow to symbolic.expression seems problematic).

Which basically means that this is all over my head.

The fact that step 4 succeeds but gives an incorrect answer suggests that there are similar problems with RIF.



---

archive/issue_comments_337886.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2020-09-05T11:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24118#issuecomment-337886",
    "user": "mmezzarobba"
}
```

Changing priority from major to minor.



---

archive/issue_comments_337887.json:
```json
{
    "body": "Replying to [ticket:24355 mmezzarobba]:\n> {{{\n> sage: foo = 1/4*hypergeometric((1, 1, 1, 1, 1), (3/2, 2, 2, 2), 1/8)\n> sage: a = RBF(foo); a\n> [0.2526850273732758 +/- 5.66e-18]\n> sage: b = RealBallField(100)(foo); b\n> [0.2526850273732758327317762593029 +/- 4.32e-32]\n> sage: a.overlaps(b)\n> False\n> }}}\n> \n> This doesn't happen with python-flint and the last version of arb: it may either be a sage-specific issue or a bug in the version of arb that sage is using.\n\nNow fixed by making the conversion raise an error, probably in #28517 or one of its dependencies. It may still be nice to implement the correct conversion.",
    "created_at": "2020-09-05T11:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24118#issuecomment-337887",
    "user": "mmezzarobba"
}
```

Replying to [ticket:24355 mmezzarobba]:
> {{{
> sage: foo = 1/4*hypergeometric((1, 1, 1, 1, 1), (3/2, 2, 2, 2), 1/8)
> sage: a = RBF(foo); a
> [0.2526850273732758 +/- 5.66e-18]
> sage: b = RealBallField(100)(foo); b
> [0.2526850273732758327317762593029 +/- 4.32e-32]
> sage: a.overlaps(b)
> False
> }}}
> 
> This doesn't happen with python-flint and the last version of arb: it may either be a sage-specific issue or a bug in the version of arb that sage is using.

Now fixed by making the conversion raise an error, probably in #28517 or one of its dependencies. It may still be nice to implement the correct conversion.



---

archive/issue_comments_337888.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2020-09-05T11:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24118",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24118#issuecomment-337888",
    "user": "mmezzarobba"
}
```

Changing type from defect to enhancement.
