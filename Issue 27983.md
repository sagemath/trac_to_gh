# Issue 27983: Cythonize all_simple_paths, all_paths_iterator and _all_paths_iterator

Issue created by migration from https://trac.sagemath.org/ticket/28220

Original creator: @rajat1433

Original creation time: 2019-07-21 02:08:01

CC:  dcoudert

Keywords: gsoc19

This ticket aims to cythonize the above methods using cython variables and cython data structures to make them fast and efficient. It depends on #27859 in which these methods were moved to separate file path_enumeration.pyx


---

Comment by dcoudert created at 2019-07-22 00:54:03

Create distinct methods to make sure you can compare results.


---

Comment by git created at 2019-07-30 10:29:31

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @rajat1433 created at 2019-07-30 10:33:52

Changing status from new to needs_review.


---

Comment by git created at 2019-07-31 16:36:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-07-31 16:44:30

Can you summarize what you did and what else you plan to do. It's not easy to see from the code (ok, the last commit is clear).


---

Comment by @rajat1433 created at 2019-07-31 16:49:58

I have added three new methods all_simple_paths_cython, all_paths_iterator_cython and _all_paths_iterator_cython and used the priority_queue data structure instead of python heap.
I have also used cython variable declarations. I have tested the time complexity and the improvement in time is very minute. I am looking for more cythonic style improvements. If you have any in mind w.r.t. these methods it will be helpful here.


---

Comment by @rajat1433 created at 2019-07-31 17:16:41

Also I have based it on top of #27859.


---

Comment by git created at 2019-07-31 18:11:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-01 03:25:28


```
sage: g = digraphs.Paley(11)
sage: %timeit l = g.all_simple_paths(starting_vertices=[0], ending_vertices=[9],
....:  trivial=False)
1 loop, best of 3: 737 ms per loop
sage: 
sage: %timeit l = g.all_simple_paths_cython(starting_vertices=[0], ending_vertic
....: es=[9], trivial=False)
1 loop, best of 3: 722 ms per loop

sage: d = digraphs.DeBruijn(3, 2)
sage: %timeit l = d.all_simple_paths_cython(starting_vertices=['00'], ending_ver
....: tices=['22'], trivial=False)
100 loops, best of 3: 2.16 ms per loop
sage: %timeit l = d.all_simple_paths(starting_vertices=['00'], ending_vertices=[
....: '22'], trivial=False)
100 loops, best of 3: 2.44 ms per loop
```



---

Comment by git created at 2019-08-01 10:09:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-05 03:20:55

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dcoudert created at 2019-08-06 12:59:05

I'm having hard time identifying the changes done in this ticket, so I will wait for the inclusion of #27859 before starting to review it.


---

Comment by git created at 2019-08-09 05:13:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-09 05:15:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-12 06:21:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-20 16:36:55

You should do as for #28335: modify existing methods instead of creating new ones. There are no big changes in the methods justifying the creation of new methods.


---

Comment by git created at 2019-08-20 18:33:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-20 18:35:18

I had created new methods to compare the time complexities etc. Now the methods have been merged and written in Cython.


---

Comment by dcoudert created at 2019-08-21 09:29:52

Changing status from needs_review to needs_work.


---

Comment by dcoudert created at 2019-08-21 09:29:52

Replying to [comment:19 gh-rajat1433]:
> I had created new methods to compare the time complexities etc. 
Right, I did not though about it. Sorry.

> Now the methods have been merged and written in Cython.
Well, if I understand well what you did, you simply declared the type of some variables and used a c++ priority queue instead of a Python queue at the cost of storing all reported paths in a list. This is not good enough. and I disagree with the current use of `idx_to_path` as this list may become giant.

Can't you try to identify first which parts of the methods are critical and could certainly be improved ?


---

Comment by git created at 2019-08-23 17:26:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-23 18:00:06

all_paths_iterator methods calls _all_paths_iterator method to get all the paths starting from a particular vertex and ending at a list of ending vertices. But as we see the code of _all_paths_iterator method  critical part there seems to be to get to the ending vertex from start but parameter max_length suggests to go step by step to ending vertex which the algorithm does. It explores all the paths to the ending vertices by putting them in the queue.

I don't see much of a scope of improvement from algorithm point of view right now in these methods.  If you have any ideas , please let me know. But these methods are currently in cython now, in alignment with other methods of this module path_enumeration.pyx and faster.


---

Comment by dcoudert created at 2019-08-29 16:18:00

There is a merge conflict with last beta.


---

Comment by git created at 2019-08-29 19:13:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @rajat1433 created at 2019-08-29 19:16:58

Changing status from needs_work to needs_review.


---

Comment by @rajat1433 created at 2019-08-29 19:17:55

I have rebased it on 8.9 beta8 and resolved the merge conflict.


---

Comment by git created at 2019-08-30 09:26:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2019-08-30 09:39:05

I changed 2 doctests to make them compatible with Python 3 (were failing when testing with py3).You may know that we are in the transition to py3 and so some of us are running both a version compiled with py2 and another with py3. For some data structures, like dict, the order in which items are "ordered" change. In this case, it was changing the order in which paths where yielded. The solution was correct nonetheless. With the change I made, it's more robust.


---

Comment by dcoudert created at 2019-08-30 09:40:27

A good news:

with this patch:

```
sage: g = digraphs.Complete(6)
sage: %time _ = g.all_simple_paths()
CPU times: user 24.9 ms, sys: 1.73 ms, total: 26.7 ms
Wall time: 25.7 ms
```


without:

```
sage: g = digraphs.Complete(6)
sage: %time _ = g.all_simple_paths()
CPU times: user 53 ms, sys: 8.88 ms, total: 61.9 ms
Wall time: 55.8 ms
```



---

Comment by dcoudert created at 2019-08-30 09:51:07

A bad news: method `all_simple_paths` uses `all_paths_iterator`, and this method claim that `The paths are enumerated in increasing length order`. However, this is not the case (with and without this patch).

```
sage: g = digraphs.Complete(3)
sage: g.all_simple_paths()
[[0, 1],
 [1, 0],
 [2, 0],
 [0, 1, 0],
 [0, 2],
 [0, 2, 0],
 [0, 1, 2],
 [1, 0, 1],
 [1, 2],
 [1, 2, 1],
 [1, 0, 2],
 [2, 0, 2],
 [2, 1],
 [2, 1, 2],
 [2, 0, 1],
 [0, 1, 2, 0],
 [0, 2, 1],
 [0, 2, 1, 0],
 [1, 0, 2, 1],
 [1, 2, 0],
 [1, 2, 0, 1],
 [2, 0, 1, 2],
 [2, 1, 0],
 [2, 1, 0, 2]]
```


What if we used a priority queue instead of a queue in `_all_paths_iterator` ? As this behavior seems intependent of the changes done here, this can be post-pone to a future patch.


---

Comment by @rajat1433 created at 2019-09-01 11:25:00

It seems that when starting_vertices and ending_vertices are not single vertex then these paths are 
not in increasing no. of edges. 


"What if we used a priority queue instead of a queue in _all_paths_iterator ? As this behavior seems intependent of the changes done here, this can be post-pone to a future patch. "

I tried it but still the results are not in increasing order of edges.

We can fix it in next patch either to reorganize the algorithm to print paths in order of increasing number of edges or stating in simple paths that edges will be in increasing order in case of a single src and destination.


---

Comment by dcoudert created at 2019-09-03 12:09:24

Changing status from needs_review to positive_review.


---

Comment by dcoudert created at 2019-09-03 12:09:24

OK, let's postpone the ordering issue to a specific ticket. You can investigate that before opening a ticket.

LGTM.


---

Comment by vbraun created at 2019-09-05 21:33:16

Resolution: fixed
