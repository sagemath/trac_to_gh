# Issue 17455: The default __invert__ method of an element should avoid coercion

Issue created by migration from Trac.

Original creator: Stefan

Original creation time: 2015-01-29 21:17:18

CC:  vdelecroix tscrim

Currently, the __invert__ methods in element.pyx do

```
    return 1/self
```


This results in a coercion of the integer 1 into the appropriate parent structure. Better would be to do

```
    return self.parent().one_element() / self
```


Additionally, the __invert__ method in MultiplicativeGroupElement relies on a method is_one() that is not provided by the class itself.


---

Comment by vdelecroix created at 2015-01-30 07:52:39

cc'ing me (+ formatting in the description)


---

Comment by vdelecroix created at 2015-01-31 14:49:35

New commits:


---

Comment by vdelecroix created at 2015-01-31 14:49:35

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-02-03 15:16:07

Why do you add

```
if self.is_zero():
    raise ZeroDivisionError("division by zero in a ring")
```


I would say it's the division code which should raise this error, not `__invert__`.


---

Comment by git created at 2015-02-04 13:04:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-02-04 13:05:12

Replying to [comment:4 jdemeyer]:
> Why do you add
>  ...
> I would say it's the division code which should raise this error, not `__invert__`.

Right. Removed in the last commit.


---

Comment by mmezzarobba created at 2015-02-05 08:38:57


```
**********************************************************************
File "src/sage/structure/coerce.pyx", line 463, in sage.structure.coerce.CoercionModel_cache_maps.explain
Failed example:
    cm.explain(ZZ['x'], QQ['x'], operator.div)
Expected:
    Coercion on left operand via
        Ring morphism:
          From: Univariate Polynomial Ring in x over Integer Ring
          To:   Univariate Polynomial Ring in x over Rational Field
          Defn: Induced from base ring by
                Natural morphism:
                  From: Integer Ring
                  To:   Rational Field
    Arithmetic performed after coercions.
    Result lives in Fraction Field of Univariate Polynomial Ring in x over Rational Field
    Fraction Field of Univariate Polynomial Ring in x over Rational Field
Got:
    Coercion on left operand via
        Ring morphism:
          From: Univariate Polynomial Ring in x over Integer Ring
          To:   Univariate Polynomial Ring in x over Rational Field
          Defn: Induced from base ring by
                Natural morphism:
                  From: Integer Ring
                  To:   Rational Field
    Arithmetic performed after coercions.
    Result lives in Univariate Polynomial Ring in x over Rational Field
    Univariate Polynomial Ring in x over Rational Field
**********************************************************************
File "src/sage/structure/coerce.pyx", line 684, in sage.structure.coerce.CoercionModel_cache_maps.division_parent
Failed example:
    cm.division_parent(ZZ['x'])
Expected:
    Fraction Field of Univariate Polynomial Ring in x over Integer Ring
Got:
    Univariate Polynomial Ring in x over Integer Ring
**********************************************************************
```



```
**********************************************************************
File "src/sage/interfaces/maxima_abstract.py", line 2299, in sage.interfaces.maxima_abstract.MaximaAbstractElementFunction.__inv__
Failed example:
    ~f
Expected:
    1/sin(x)
Got:
    one()/sin(x)
**********************************************************************
```



```
**********************************************************************
File "src/sage/interfaces/r.py", line 22, in sage.interfaces.r
Failed example:
    ~x
Expected:
    [1] 0.09615385 0.17857143 0.32258065 0.15625000 0.04608295
Got:
    [1] 0 0 0 0 0
**********************************************************************
```



---

Comment by mmezzarobba created at 2015-02-05 08:38:57

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-05 13:09:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-02-05 13:11:02

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-05 13:22:09

Wouldn't it be better to add the `zero()`/`one()` functions in the base class `src/sage/interfaces/interface.py`?


---

Comment by jdemeyer created at 2015-02-05 13:22:09

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-02-05 13:24:21

Replying to [comment:10 jdemeyer]:
> Wouldn't it be better to add the `zero()`/`one()` functions in the base class `src/sage/interfaces/interface.py`?

True. Will do.


---

Comment by git created at 2015-02-05 13:45:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2015-02-05 13:46:54

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2015-02-05 16:07:39

More doctest failures.


```
**********************************************************************
File "src/sage/rings/infinity.py", line 93, in sage.rings.infinity
Failed example:
    unsigned_oo/0
Expected:
    Traceback (most recent call last):
    ...
    ValueError: unsigned oo times smaller number not defined
Got:
      ...
      File "sage/structure/coerce.pyx", line 798, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:7153)
        return PyObject_CallObject(op, xy)
      File "sage/structure/element.pyx", line 2013, in sage.structure.element.RingElement.__div__ (build/cythonized/sage/structure/element.c:18317)
        return (<RingElement>self)._div_(<RingElement>right)
      File "sage/structure/element.pyx", line 2017, in sage.structure.element.RingElement._div_ (build/cythonized/sage/structure/element.c:18420)
        cpdef RingElement _div_(self, RingElement right):
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/infinity.py", line 458, in _div_
        return self * ~other
      File "sage/structure/element.pyx", line 2073, in sage.structure.element.RingElement.__invert__ (build/cythonized/sage/structure/element.c:19009)
        return self._parent.one() / self
      File "sage/structure/element.pyx", line 2013, in sage.structure.element.RingElement.__div__ (build/cythonized/sage/structure/element.c:18317)
        return (<RingElement>self)._div_(<RingElement>right)
      File "sage/structure/element.pyx", line 2017, in sage.structure.element.RingElement._div_ (build/cythonized/sage/structure/element.c:18420)
        cpdef RingElement _div_(self, RingElement right):
      File "/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/infinity.py", line 814, in _div_
        raise ValueError("quotient of number < oo by number < oo not defined")
    ValueError: quotient of number < oo by number < oo not defined
**********************************************************************
```



```
sage -t --warn-long 30.1 src/sage/schemes/elliptic_curves/formal_group.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/formal_group.py", line 431, in sage.schemes.elliptic_curves.formal_group.EllipticCurveFormalGroup.inverse
Failed example:
    F = E.formal_group().group_law(6)
Exception raised:
    ...
    TypeError: unsupported operand parent(s) for '*': 'Multivariate Polynomial Ring in a1, a2, a3, a4, a6 over Rational Field' and 'Multivariate Polynomial Ring in t1, t2 over Multivariate Polynomial Ring in a1, a2, a3, a4, a6 over Integer Ring'
**********************************************************************
```



```
**********************************************************************
File "src/sage/schemes/elliptic_curves/formal_group.py", line 523, in sage.schemes.elliptic_curves.formal_group.EllipticCurveFormalGroup.group_law
Failed example:
    F(t1, 0)
Expected:
    t1 + O(t1, t2)^5
Got:
    t1 + O(t1, t2)^7
**********************************************************************
```



---

Comment by mmezzarobba created at 2015-02-05 16:15:59

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2015-02-05 18:55:21

Hello,

Indeed! The coercion with polynomial is to blame here... see [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/3wduVqhoLWg). Several people fixed some issue locally (e.g. #7711). In order to go further, I need the coercion to be fixed. I will open a subsequent ticket if it is not yet here.

Vincent


---

Comment by jdemeyer created at 2016-06-05 08:34:33

I actually propose to close this as "wontfix" since we need to get rid of `__invert__` anyway.


---

Comment by vdelecroix created at 2016-06-05 08:57:27

Why? Where?


---

Comment by jdemeyer created at 2016-06-05 12:28:46

Well, everywhere really because `__invert__` is supposed to return the bitwise inverse, not the mathematical inverse. It's the whole reason why I came up with the idea of a unary division.


---

Comment by mkoeppe created at 2022-09-18 02:20:40

Closing suggested in #17965#comment:57


---

Comment by mkoeppe created at 2022-09-18 02:20:40

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2022-09-18 02:31:08

Indeed, this seems to have already been done elsewhere.

There are still a few instances where it does use coercion, but they are all look specific:

```
travis`@`apricot:~/sage-build/src/sage/rings$ grep -R --include \*.p\* "1 */ *self" ../*
../manifolds/chart_func.py:            # NB: self._express.__invert__() would return 1/self._express
../manifolds/chart_func.py:                          expression=self._simplify(1 / self.expr()),
../modular/overconvergent/weightspace.py:            return 1 / self.Lvalue()
../modular/local_comp/smoothchar.py:        return self.character(0, [1/self.ideal(1).residue_field().cardinality()])
../modular/btquotients/pautomorphicform.py:            A = data.parent()._Sigma0(Matrix(QQ,2,2,[0,1/self.prime(),1,0]),check=False)
../modular/modform_hecketriangle/abstract_ring.py:                d = 1 / self.base_ring()(1/d)
../modular/modform_hecketriangle/abstract_ring.py:            return   1/self._group.n() * (X*Z-Y) * dX\
../modular/modform_hecketriangle/abstract_ring.py:            return - 1/self._group.n() * Y*dX\
../plot/plot3d/implicit_surface.pyx:        self.eval_scale_inv.x = 1/self.eval_scale.x
../plot/plot3d/implicit_surface.pyx:        self.eval_scale_inv.y = 1/self.eval_scale.y
../plot/plot3d/implicit_surface.pyx:        self.eval_scale_inv.z = 1/self.eval_scale.z
../rings/qqbar.py:        1/self.
../rings/qqbar.py:        1/self.
../rings/qqbar.py:        1/self.
../rings/function_field/order.py:        return 1/self.function_field().gen()
../rings/function_field/order.py:        return self.ideal( 1/self.function_field().gen() )
../rings/real_double_element_gsl.pyx:        return 1/self.cosh()
../rings/real_double_element_gsl.pyx:        return 1/self.sinh()
../rings/rational_field.py:        yield 1/self.an_element()
../rings/rational_field.py:        yield -1/self.an_element()
../rings/puiseux_series_ring_element.pyx:        # use x.nth_root since x**(1/self._e) returns oo when x = 0
Binary file ../rings/__pycache__/qqbar.cpython-310.pyc matches
../rings/padics/padic_lattice_element.py:        # dx = -(1/self^2)*dself
../rings/padics/padic_extension_generic.py:    #    u = 1 / self(1 - q, prec)
../schemes/riemann_surfaces/riemann_surface.py:                M_tilde = 2*max((m[i].abs())**(1/self._RR(l-i))
../schemes/cyclic_covers/cycliccover_finite_field.py:        iD = 1 / self._Zq0(D.lift() / self._p)
../schemes/cyclic_covers/cycliccover_finite_field.py:                    iD = 1 / self._Zq(D.lift() / self._p)
../schemes/elliptic_curves/padic_lseries.py:                L *= (1-1/self.alpha())**2
../schemes/elliptic_curves/ell_tate_curve.py:        qE = q_in_terms_of_jinv(R(1 / self._E.j_invariant()))
../schemes/projective/projective_point.py:        self.scale_by(1/self[index])
../schemes/berkovich/berkovich_cp_element.py:            return self.parent()(1 / self.center())
../schemes/berkovich/berkovich_cp_element.py:            return self.parent()(1 / self.center(), RR(radius / (self._custom_abs(self.center())**2)))
../schemes/berkovich/berkovich_cp_element.py:                new_center = 1 / self.center()[i]
../schemes/berkovich/berkovich_cp_element.py:            return self.parent()(1 / self.center()[0])
../schemes/berkovich/berkovich_cp_element.py:                return self.parent()(ZZ(0), 1 / self.radius())
../schemes/berkovich/berkovich_cp_element.py:            return self.parent()(1 / self.center()[0], self.radius() / (self._custom_abs(self.center()[0])**2))
../schemes/berkovich/berkovich_cp_element.py:                new_center = 1 / self.center()[i][0]
../symbolic/expression.pyx:        return 1/self
```



---

Comment by tscrim created at 2022-09-18 02:31:08

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-11-14 19:36:43

Resolution: invalid
