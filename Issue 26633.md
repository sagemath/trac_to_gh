# Issue 26633: py3: fix error with map in strongly_regular_db.pyx

Issue created by migration from Trac.

Original creator: dcoudert

Original creation time: 2018-12-11 02:39:14

CC:  tscrim chapoton embray

Keywords: py3, graph

`map` is an iterator in Python3, so some care is needed.
- in `strongly_regular_db.pyx`, the graph constructor was called with a set of vertices defined by a map. We ensure that we build the list of vertices first.
- same for the call to method `IntersectionGraph`.

We also fix some issues with `bytes` and `str`.


---

Comment by dcoudert created at 2018-12-11 02:46:24

New commits:


---

Comment by dcoudert created at 2018-12-11 02:46:24

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-12-11 09:41:23

This looks very suspicious:

```
bytes_to_str(brouwer_data['comments'].encode('ascii', 'ignore')))
```

Probably there should be a shorter way..


---

Comment by embray created at 2018-12-11 09:56:50

Please don't do `list(map(...))`.  Instead convert these to list comprehensions or generator expressions as appropriate.


---

Comment by git created at 2018-12-11 12:07:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2018-12-11 12:12:10

This passes doctests with Python3 but not with Python2. There is an encoding issue as the database contains `Östergård`.

What should I do ?


---

Comment by chapoton created at 2018-12-11 12:31:22

Maybe try adding `encoding='utf-8'` inside the `open(..)` in `cdef load_brouwer_database()` ?


---

Comment by dcoudert created at 2018-12-11 12:45:40

`open(...)` does not accept the encoding parameter in Python2 (`TypeError: 'encoding' is an invalid keyword argument for this function`). It works with Python3.

I also tried to put `encoding='utf-8'` in `json.load(...)` but it does not solve the issue in Python2 :(


---

Comment by chapoton created at 2018-12-11 12:47:27

using io.open() ?


---

Comment by dcoudert created at 2018-12-11 12:57:38

no, still get the same error with py2.

```
Failed example:
    graphs.strongly_regular_graph(324,57,0,12)
Expected:
    Traceback (most recent call last):
    ...
    EmptySetError: Andries Brouwer's database reports that no (324, 57, 0,
    12)-strongly regular graph exists. Comments: <a
    href="srgtabrefs.html#GavrilyukMakhnev05">Gavrilyuk & Makhnev</a> and <a
    href="srgtabrefs.html#KaskiOstergard07">Kaski & Östergård</a>
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.strongly_regular_db.strongly_regular_graph[6]>", line 1, in <module>
        graphs.strongly_regular_graph(Integer(324),Integer(57),Integer(0),Integer(12))
      File "sage/graphs/strongly_regular_db.pyx", line 3002, in sage.graphs.strongly_regular_db.strongly_regular_graph (build/cythonized/sage/graphs/strongly_regular_db.c:42610)
        raise EmptySetError("Andries Brouwer's database reports that no " +
    EmptySetError: Andries Brouwer's database reports that no (324, 57, 0, 12)-strongly regular graph exists. Comments: <a href="srgtabrefs.html#GavrilyukMakhnev05">Gavrilyuk & Makhnev</a> and <a href="srgtabrefs.html#KaskiOstergard07">Kaski & \xd6sterg\xe5rd</a>
```



---

Comment by git created at 2018-12-11 16:15:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-12-11 16:17:32

Try this !^

The problem with the original code, on Python 2, was that it was interpolating unicode strings into templates that were non-unicode strings.  On Python 2 this results in implicit encoding of the unicode strings as ASCII, which results in a `UnicodeEncodeError` for any comments that contain non-ASCII characters.

Would have been better if the original code just used unicode strings for the error messages in the first place.  Now, since this is Cython code, we can use f-strings which are implicitly unicode anyways, and make the formatting look a bit nicer.


---

Comment by dcoudert created at 2018-12-11 16:40:18

It's way nicer. I didn't know `f-strings` which seems very convenient.
However, I still get `Kaski & \xd6sterg\xe5rd` instead of `Kaski & Östergård` with py2 :(


---

Comment by embray created at 2018-12-12 08:32:13

Yikes, I didn't realize this myself (it has not come up often), but it turns out on Python 2 most exceptions can't accept exception messages as unicode objects (rather, it can, but it will still try to implicitly encode them with ASCII)! :(  https://pythonhosted.org/kitchen/unicode-frustrations.html#frustration-5-exceptions

The best thing to do would be to convert them to bytes, but _only_ on Python 2, just using UTF-8 probably.


---

Comment by dcoudert created at 2018-12-12 14:16:46

not sure how to do that...


---

Comment by chapoton created at 2018-12-12 21:17:26

I would just suggest to put `...` at the appropriate place in the failing doctest. We do not really care about these details..


---

Comment by git created at 2018-12-12 21:24:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2018-12-12 21:25:17

good idea.


---

Comment by chapoton created at 2018-12-13 14:15:37

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-12-13 14:15:37

ok, good for me.


---

Comment by vbraun created at 2018-12-23 23:40:07

Resolution: fixed


---

Comment by embray created at 2018-12-28 14:06:38

This tickets were closed as fixed after the Sage 8.5 release.
