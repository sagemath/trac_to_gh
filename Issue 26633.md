# Issue 26633: py3: fix error with map in strongly_regular_db.pyx

archive/issues_026633.json:
```json
{
    "body": "CC:  @tscrim @fchapoton @embray\n\nKeywords: py3, graph\n\n`map` is an iterator in Python3, so some care is needed.\n- in `strongly_regular_db.pyx`, the graph constructor was called with a set of vertices defined by a map. We ensure that we build the list of vertices first.\n- same for the call to method `IntersectionGraph`.\n\nWe also fix some issues with `bytes` and `str`.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26870\n\n",
    "created_at": "2018-12-11T02:39:14Z",
    "labels": [
        "component: graph theory"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.6",
    "title": "py3: fix error with map in strongly_regular_db.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26633",
    "user": "https://github.com/dcoudert"
}
```
CC:  @tscrim @fchapoton @embray

Keywords: py3, graph

`map` is an iterator in Python3, so some care is needed.
- in `strongly_regular_db.pyx`, the graph constructor was called with a set of vertices defined by a map. We ensure that we build the list of vertices first.
- same for the call to method `IntersectionGraph`.

We also fix some issues with `bytes` and `str`.

Issue created by migration from https://trac.sagemath.org/ticket/26870





---

archive/issue_comments_373863.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-12-11T02:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373863",
    "user": "https://github.com/dcoudert"
}
```

New commits:



---

archive/issue_comments_373864.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-11T02:46:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373864",
    "user": "https://github.com/dcoudert"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_373865.json:
```json
{
    "body": "This looks very suspicious:\n\n```\nbytes_to_str(brouwer_data['comments'].encode('ascii', 'ignore')))\n```\n\nProbably there should be a shorter way..",
    "created_at": "2018-12-11T09:41:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373865",
    "user": "https://github.com/fchapoton"
}
```

This looks very suspicious:

```
bytes_to_str(brouwer_data['comments'].encode('ascii', 'ignore')))
```

Probably there should be a shorter way..



---

archive/issue_comments_373866.json:
```json
{
    "body": "Please don't do `list(map(...))`.  Instead convert these to list comprehensions or generator expressions as appropriate.",
    "created_at": "2018-12-11T09:56:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373866",
    "user": "https://github.com/embray"
}
```

Please don't do `list(map(...))`.  Instead convert these to list comprehensions or generator expressions as appropriate.



---

archive/issue_comments_373867.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-11T12:07:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373867",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373868.json:
```json
{
    "body": "This passes doctests with Python3 but not with Python2. There is an encoding issue as the database contains `\u00d6sterg\u00e5rd`.\n\nWhat should I do ?",
    "created_at": "2018-12-11T12:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373868",
    "user": "https://github.com/dcoudert"
}
```

This passes doctests with Python3 but not with Python2. There is an encoding issue as the database contains `Östergård`.

What should I do ?



---

archive/issue_comments_373869.json:
```json
{
    "body": "Maybe try adding `encoding='utf-8'` inside the `open(..)` in `cdef load_brouwer_database()` ?",
    "created_at": "2018-12-11T12:31:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373869",
    "user": "https://github.com/fchapoton"
}
```

Maybe try adding `encoding='utf-8'` inside the `open(..)` in `cdef load_brouwer_database()` ?



---

archive/issue_comments_373870.json:
```json
{
    "body": "`open(...)` does not accept the encoding parameter in Python2 (`TypeError: 'encoding' is an invalid keyword argument for this function`). It works with Python3.\n\nI also tried to put `encoding='utf-8'` in `json.load(...)` but it does not solve the issue in Python2 :(",
    "created_at": "2018-12-11T12:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373870",
    "user": "https://github.com/dcoudert"
}
```

`open(...)` does not accept the encoding parameter in Python2 (`TypeError: 'encoding' is an invalid keyword argument for this function`). It works with Python3.

I also tried to put `encoding='utf-8'` in `json.load(...)` but it does not solve the issue in Python2 :(



---

archive/issue_comments_373871.json:
```json
{
    "body": "using io.open() ?",
    "created_at": "2018-12-11T12:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373871",
    "user": "https://github.com/fchapoton"
}
```

using io.open() ?



---

archive/issue_comments_373872.json:
```json
{
    "body": "no, still get the same error with py2.\n\n```\nFailed example:\n    graphs.strongly_regular_graph(324,57,0,12)\nExpected:\n    Traceback (most recent call last):\n    ...\n    EmptySetError: Andries Brouwer's database reports that no (324, 57, 0,\n    12)-strongly regular graph exists. Comments: <a\n    href=\"srgtabrefs.html#GavrilyukMakhnev05\">Gavrilyuk & Makhnev</a> and <a\n    href=\"srgtabrefs.html#KaskiOstergard07\">Kaski & \u00d6sterg\u00e5rd</a>\nGot:\n    <BLANKLINE>\n    Traceback (most recent call last):\n      File \"/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1086, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.graphs.strongly_regular_db.strongly_regular_graph[6]>\", line 1, in <module>\n        graphs.strongly_regular_graph(Integer(324),Integer(57),Integer(0),Integer(12))\n      File \"sage/graphs/strongly_regular_db.pyx\", line 3002, in sage.graphs.strongly_regular_db.strongly_regular_graph (build/cythonized/sage/graphs/strongly_regular_db.c:42610)\n        raise EmptySetError(\"Andries Brouwer's database reports that no \" +\n    EmptySetError: Andries Brouwer's database reports that no (324, 57, 0, 12)-strongly regular graph exists. Comments: <a href=\"srgtabrefs.html#GavrilyukMakhnev05\">Gavrilyuk & Makhnev</a> and <a href=\"srgtabrefs.html#KaskiOstergard07\">Kaski & \\xd6sterg\\xe5rd</a>\n```\n",
    "created_at": "2018-12-11T12:57:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373872",
    "user": "https://github.com/dcoudert"
}
```

no, still get the same error with py2.

```
Failed example:
    graphs.strongly_regular_graph(324,57,0,12)
Expected:
    Traceback (most recent call last):
    ...
    EmptySetError: Andries Brouwer's database reports that no (324, 57, 0,
    12)-strongly regular graph exists. Comments: <a
    href="srgtabrefs.html#GavrilyukMakhnev05">Gavrilyuk & Makhnev</a> and <a
    href="srgtabrefs.html#KaskiOstergard07">Kaski & Östergård</a>
Got:
    <BLANKLINE>
    Traceback (most recent call last):
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/dcoudert/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1086, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.graphs.strongly_regular_db.strongly_regular_graph[6]>", line 1, in <module>
        graphs.strongly_regular_graph(Integer(324),Integer(57),Integer(0),Integer(12))
      File "sage/graphs/strongly_regular_db.pyx", line 3002, in sage.graphs.strongly_regular_db.strongly_regular_graph (build/cythonized/sage/graphs/strongly_regular_db.c:42610)
        raise EmptySetError("Andries Brouwer's database reports that no " +
    EmptySetError: Andries Brouwer's database reports that no (324, 57, 0, 12)-strongly regular graph exists. Comments: <a href="srgtabrefs.html#GavrilyukMakhnev05">Gavrilyuk & Makhnev</a> and <a href="srgtabrefs.html#KaskiOstergard07">Kaski & \xd6sterg\xe5rd</a>
```




---

archive/issue_comments_373873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-11T16:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373873",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373874.json:
```json
{
    "body": "Try this !^\n\nThe problem with the original code, on Python 2, was that it was interpolating unicode strings into templates that were non-unicode strings.  On Python 2 this results in implicit encoding of the unicode strings as ASCII, which results in a `UnicodeEncodeError` for any comments that contain non-ASCII characters.\n\nWould have been better if the original code just used unicode strings for the error messages in the first place.  Now, since this is Cython code, we can use f-strings which are implicitly unicode anyways, and make the formatting look a bit nicer.",
    "created_at": "2018-12-11T16:17:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373874",
    "user": "https://github.com/embray"
}
```

Try this !^

The problem with the original code, on Python 2, was that it was interpolating unicode strings into templates that were non-unicode strings.  On Python 2 this results in implicit encoding of the unicode strings as ASCII, which results in a `UnicodeEncodeError` for any comments that contain non-ASCII characters.

Would have been better if the original code just used unicode strings for the error messages in the first place.  Now, since this is Cython code, we can use f-strings which are implicitly unicode anyways, and make the formatting look a bit nicer.



---

archive/issue_comments_373875.json:
```json
{
    "body": "It's way nicer. I didn't know `f-strings` which seems very convenient.\nHowever, I still get `Kaski & \\xd6sterg\\xe5rd` instead of `Kaski & \u00d6sterg\u00e5rd` with py2 :(",
    "created_at": "2018-12-11T16:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373875",
    "user": "https://github.com/dcoudert"
}
```

It's way nicer. I didn't know `f-strings` which seems very convenient.
However, I still get `Kaski & \xd6sterg\xe5rd` instead of `Kaski & Östergård` with py2 :(



---

archive/issue_comments_373876.json:
```json
{
    "body": "Yikes, I didn't realize this myself (it has not come up often), but it turns out on Python 2 most exceptions can't accept exception messages as unicode objects (rather, it can, but it will still try to implicitly encode them with ASCII)! :(  https://pythonhosted.org/kitchen/unicode-frustrations.html#frustration-5-exceptions\n\nThe best thing to do would be to convert them to bytes, but *only* on Python 2, just using UTF-8 probably.",
    "created_at": "2018-12-12T08:32:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373876",
    "user": "https://github.com/embray"
}
```

Yikes, I didn't realize this myself (it has not come up often), but it turns out on Python 2 most exceptions can't accept exception messages as unicode objects (rather, it can, but it will still try to implicitly encode them with ASCII)! :(  https://pythonhosted.org/kitchen/unicode-frustrations.html#frustration-5-exceptions

The best thing to do would be to convert them to bytes, but *only* on Python 2, just using UTF-8 probably.



---

archive/issue_comments_373877.json:
```json
{
    "body": "not sure how to do that...",
    "created_at": "2018-12-12T14:16:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373877",
    "user": "https://github.com/dcoudert"
}
```

not sure how to do that...



---

archive/issue_comments_373878.json:
```json
{
    "body": "I would just suggest to put `...` at the appropriate place in the failing doctest. We do not really care about these details..",
    "created_at": "2018-12-12T21:17:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373878",
    "user": "https://github.com/fchapoton"
}
```

I would just suggest to put `...` at the appropriate place in the failing doctest. We do not really care about these details..



---

archive/issue_comments_373879.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-12T21:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373879",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_373880.json:
```json
{
    "body": "good idea.",
    "created_at": "2018-12-12T21:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373880",
    "user": "https://github.com/dcoudert"
}
```

good idea.



---

archive/issue_comments_373881.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-13T14:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373881",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_373882.json:
```json
{
    "body": "ok, good for me.",
    "created_at": "2018-12-13T14:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373882",
    "user": "https://github.com/fchapoton"
}
```

ok, good for me.



---

archive/issue_events_066477.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-12-23T23:40:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26633#event-66477"
}
```



---

archive/issue_comments_373883.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-12-23T23:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373883",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_066478.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2018-12-28T14:06:38Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "milestone": "sage-8.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26633#event-66478"
}
```



---

archive/issue_comments_373884.json:
```json
{
    "body": "This tickets were closed as fixed after the Sage 8.5 release.",
    "created_at": "2018-12-28T14:06:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26633",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26633#issuecomment-373884",
    "user": "https://github.com/embray"
}
```

This tickets were closed as fixed after the Sage 8.5 release.
