# Issue 20855: Unhandled case in EllipticCurve_from_cubic

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-07-25 15:43:24

CC:  cremona leif

I ran into an unexpected error in `EllipticCurve_from_cubic`, with the following cubic and rational point:


```
sage: R.<x,y,z> = QQ[]
sage: cubic = -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
sage: EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5))
```


Note that it works as expected using instead the different rational point (1, 1, 0).

On investigation, I found there is a case that isn’t handled correctly. The code computes

```
P2 = chord_and_tangent(F, P)
```

and if P2 is projectively equivalent to P then it uses a different algorithm. If they’re different, it then computes

```
P3 = chord_and_tangent(F, P2)
```

and uses an algorithm that fails if P3 is equivalent to P2.

I think the attached patch fixes this problem. At least, with this patch it now works for my examples.

Best wishes,
Robin

----------


```diff

diff --git a/src/sage/schemes/elliptic_curves/constructor.py b/src/sage/schemes/elliptic_curves/constructor.py
index ec2d59c..d28dda3 100644
--- a/src/sage/schemes/elliptic_curves/constructor.py
+++ b/src/sage/schemes/elliptic_curves/constructor.py
`@``@` -873,6 +873,16 `@``@` def EllipticCurve_from_cubic(F, P, morphism=True):
         sage: cubic = x^2*y + 4*x*y^2 + x^2*z + 8*x*y*z + 4*y^2*z + 9*x*z^2 + 9*y*z^2
         sage: EllipticCurve_from_cubic(cubic, [1,-1,1], morphism=False)
         Elliptic Curve defined by y^2 - 882*x*y - 2560000*y = x^3 - 127281*x^2 over Rational Field
+
+        sage: R.<x,y,z> = QQ[]
+        sage: cubic = -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
+        sage: EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5) )
+        Scheme morphism:
+          From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:
+          -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
+          To:   Elliptic Curve defined by y^2 + 10*x*y + 112*y = x^3 + 46*x^2 + 336*x over Rational Field
+          Defn: Defined on coordinates by sending (x : y : z) to
+                (1/3*z : y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)
     """
     import sage.matrix.all as matrix
 
`@``@` -895,9 +905,18 `@``@` def EllipticCurve_from_cubic(F, P, morphism=True):
         raise TypeError('%s is not a projective point'%P)
     x, y, z = R.gens()
 
-    # First case: if P = P2 then P is a flex
+    # First case: if P = P2 then P is a flex, or if P2 = P3 then P2 is a flex
     P2 = chord_and_tangent(F, P)
+    flex_point = None
     if are_projectively_equivalent(P, P2, base_ring=K):
+        flex_point = P
+    else:
+        P3 = chord_and_tangent(F, P2)
+        if are_projectively_equivalent(P2, P3, base_ring=K):
+            flex_point = P2
+
+    if flex_point is not None:
+        P = flex_point
         # find the tangent to F in P
         dx = K(F.derivative(x)(P))
         dy = K(F.derivative(y)(P))
`@``@` -934,9 +953,8 `@``@` def EllipticCurve_from_cubic(F, P, morphism=True):
         fwd_defining_poly = [trans_x, trans_y, -b*trans_z]
         fwd_post = -a
 
-    # Second case: P is not a flex, then P, P2, P3 are different
+    # Second case: P, P2, P3 are different
     else:
-        P3 = chord_and_tangent(F, P2)
         # send P, P2, P3 to (1:0:0), (0:1:0), (0:0:1) respectively
         M = matrix.matrix(K, [P, P2, P3]).transpose()
         F2 = M.act_on_polynomial(F)
```



---

Comment by slelievre created at 2016-07-26 07:03:17

Changing status from new to needs_review.


---

Comment by slelievre created at 2016-07-26 07:03:17

Duplicate of #21093.


---

Comment by slelievre created at 2016-07-27 08:44:06

I applied the patch from #21093. Any reason to set the milestone to sage-7.4 rather than sage-7.3?
----
New commits:


---

Comment by slelievre created at 2016-07-27 11:15:06

Testing the patched src/sage/schemes/elliptic_curves/constructor.py fails for me:


```
sage -t --long --warn-long 59.7 src/sage/schemes/elliptic_curves/constructor.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/constructor.py", line 880, in sage.schemes.elliptic_curves.constructor.EllipticCurve_from_cubic
Failed example:
    EllipticCurve_from_cubic(cubic, (-4/5, 4/5, 3/5) )
Expected:
    Scheme morphism:
      From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:
      -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
      To:   Elliptic Curve defined by y^2 + 10*x*y + 112*y = x^3 + 46*x^2 + 336*x over Rational Field
      Defn: Defined on coordinates by sending (x : y : z) to
            (1/3*z : y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)
Got:
    Scheme morphism:
      From: Closed subscheme of Projective Space of dimension 2 over Rational Field defined by:
      -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
      To:   Elliptic Curve defined by y^2 - 6*x*y - 112*y = x^3 + 62*x^2 + 560*x over Rational Field
      Defn: Defined on coordinates by sending (x : y : z) to
            (1/3*z : -y - 1/3*z : 1/112*x - 1/112*y - 1/42*z)
**********************************************************************
1 item had failures:
   1 of  36 in sage.schemes.elliptic_curves.constructor.EllipticCurve_from_cubic
    [185 tests, 1 failure, 81.44 s]
```


Is there some randomness involved?

Also, when this works, it would be worth adding a reference to "`:trac:`21092``".


---

Comment by chapoton created at 2016-07-28 07:59:46

I have changed the result of the failing doctest. Hopefully this is correct.

I have also added the required link to trac.
----
New commits:


---

Comment by cremona created at 2017-11-18 18:25:49

I am looking at this (better late than never).  In the docstring there is a remark that when the supplied point is not a flex then the map returned is a "birational equivalence", and only for a flex is it an isomorphism.  This is incorrect: in both cases it is a birational isomorphism, but in the case where the point is a flex it is a linear isomorphism.  Otherwise it is a quadratic map -- but still an isomorphism of curves.


---

Comment by cremona created at 2017-11-18 18:56:58

While waiting for the branch to build I am looking at the code more.  (I am happy that the patch fixes the bug but...)

It is easy to find any rational flexes (there are 0, 1 or 3):

```
C = Curve(cubic)
hessian_pol = Matrix([[cubic.derivative(v1, v2) for v1 in R.gens()] for v2 in R.gens()]).det()
H = Curve(hessian_pol)
flexes = C.intersection(H).rational_points()
```

and simpler code would (1) test if P is a flex (iff it is on the Hessian), use it if so; else (2) look for any rational flexes and use one instead if they exist; else (3) use the generic case of what is here already.

Something else about the documentation:  assuming that C is smooth, its Jacobian J is an elliptic curve whether or not C has a rational point, and (as already observed) the Jacobian can be constructed using a different function.  But of course unless C has a rational point, C and J cannot be isomorphic.  The Jacobian() function seems to do everything one would want here:

```
sage: Jacobian(cubic, curve=Curve(cubic))

Scheme morphism:
  From: Projective Plane Curve over Rational Field defined by -3*x^2*y + 3*x*y^2 + 4*x^2*z + 4*y^2*z - 3*x*z^2 + 3*y*z^2 - 8*z^3
  To:   Elliptic Curve defined by y^2 = x^3 - 2353/3*x + 227950/27 over Rational Field
  Defn: Defined on coordinates by sending (x : y : z) to
...
```

and the only point about supplying a point on the original cubic is that you then know that this map is an isomorphism.


---

Comment by cremona created at 2017-11-19 15:48:12

I built the branch in order to test it, and was planning to edit the docstrings a little.  But even though "make build" completed successfully, running Sage crashed.  Now "make build" also crashes after trying to build a package called iml.

This is ridiculous.  Reviewing patches never used to be quite this bad, but it is hardly surprising that there are 182 tickets waiting review.  Must I really 'make dist-clean' every time now?

PS After 'git checkout develop' and 'make build' it is now building mpir. Crazy.


---

Comment by cremona created at 2017-11-23 16:43:15

I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.


---

Comment by jdemeyer created at 2017-11-23 17:23:10

Replying to [comment:11 cremona]:
> I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.

Sorry to hear that. I have no idea what you are doing wrong. That never happens to me.

Either you are doing something or there is a genuine bug in Sage. One issue with this ticket is that the branch is based on a very old version. In theory that shouldn't matter, but in practice it probably does.

If you want, you can report such issues. Maybe we can try to see what the problem is.


---

Comment by jdemeyer created at 2017-11-23 17:23:31

Replying to [comment:10 cremona]:
> PS After 'git checkout develop' and 'make build' it is now building mpir. Crazy.

Well, that depends on which you are. If the change of branch caused a change in MPIR version number, obviously MPIR will be rebuilt.


---

Comment by cremona created at 2017-11-23 19:24:52

You are right of course that switching branches can cause dependencies to be rebuilt.  I just merged develop into this branch and am building with that.  Assuming all goes OK I'll make any additional changes to that and upload it here.  I should perhaps trash this sage clone and start a new one on this machine but I have about 8 branches in there which don't get listed with "git branch --merged" so I would have to spend some time working out if there is anything in there I would want to keep.


---

Comment by cremona created at 2017-11-23 19:29:04

Replying to [comment:12 jdemeyer]:
> Replying to [comment:11 cremona]:
> > I'm trying to build this again.  Even the develop branch will not build without failing (while building iml), so after waiting for this build  I'll probably have to make dist-clean again.  By now I have almost forgotten what I was going to do with the code on  this ticket.
> 
> Sorry to hear that. I have no idea what you are doing wrong. That never happens to me.
> 
> Either you are doing something or there is a genuine bug in Sage. One issue with this ticket is that the branch is based on a very old version. In theory that shouldn't matter, but in practice it probably does.
> 
> If you want, you can report such issues. Maybe we can try to see what the problem is.

It would be hard to give a proper reproducible bug report.  From what I remember, I started with a current develop branch in which "make build" runs fine, then checked out the public/21092 branch on this ticket and did "make build" again but that failed, and when I then checked out the develop branch again "make build" failed once again.  I don't think that should happen, but I am quite capable of having done something different in between which would invalidate the report.


---

Comment by jdemeyer created at 2017-11-24 09:25:10

Replying to [comment:15 cremona]:
> when I then checked out the develop branch again "make build" failed once again.

That is the most worrying part. It's somewhat understandable that downgrading to an old version doesn't work, but building latest develop should always work.


---

Comment by cremona created at 2017-11-24 09:40:09

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 cremona]:
> > when I then checked out the develop branch again "make build" failed once again.
> 
> That is the most worrying part. It's somewhat understandable that downgrading to an old version doesn't work, but building latest develop should always work.

That's what I thought.  It might be relevant that this is the same machien where I was trying to install jupyter, jupyter-hub via anaconda and all that, without having much of an idea of what I was doing (the documentation for all that is really bad).

Anyway "make distclean; make build" ran overnight OK and so I do now have a working branch with 8.1.rc2 + the patch from this ticket.


---

Comment by chapoton created at 2018-01-23 14:51:29

ready for another tentative, John ?
----
New commits:


---

Comment by git created at 2018-01-23 14:55:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-01-23 14:58:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2018-01-23 15:54:24

I'll take another look.  Last time I did I started completely rewriting the function, but of course did not finish....however I have an unpushed commit on my branch for this called "work in progress" dated 2 Dec so I'll have to remind myself what that was about too.


---

Comment by cremona created at 2018-01-23 16:52:14

OK, I am doing some more rewriting of this, having found at least one bug (in the line "for tangent in ..." the last entry in the last triple should be dy) which might take years before it was hit.


---

Comment by cremona created at 2018-01-25 17:56:35

I am about to upload a major rewrite of this, with code which (I think) is much clearer, and more examples.  I also rewrote the helper function chord_and_tangent though I no longer use it (and it is misnamed).  I spotted (actually pyflakes did) that there is a call to a non-existent function coefficients_from_cubic elsewhere in the file constructor.py.

Since the code is a different implementation of the same basic algorithm, in quite a few examples the output is different, though on balance I think the equations are simpler.  All the examples are over Q (which is not good) where it is very tempting to compose with the map to the global minimal model, but I have not done that.

I did one possibly controversial thing: it is much easier when there is a rational flex since then there is a linear isomorphism with a Weierstrass cubic, and the new code uses a rational flex when one exists even if the given point is not a flex.  I think this is preferable to using the more complicated code and returning a quadratic map when a linea map is possible.  But I could change that (or make it optional).


---

Comment by cremona created at 2018-01-25 18:09:55

I am pushing my branch to u/cremona/21092, leaving the previous version at public/ticket/21092.
----
New commits:


---

Comment by git created at 2018-01-25 18:10:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2018-01-25 18:12:55

I just noticed that the docstring now promises that it's OK to give P=None if the curve has a rational flex, since it is easy to find these and use one -- but forgot to implement that.  I'll leave is Needs Review anyway but will update the branch with this (and examples) tomorrow.


---

Comment by git created at 2018-01-25 19:56:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-01-27 07:58:06

First review pass:

please use `.. NOTE::` in capital

maybe say somewhere that the given point may be ignored if the curve has a rational flex ?

typo `returned cannor be evaluated`

typo `anf the inverse morphism`

typo `will beused as a base`

typo `if not point is given and there are not rational` where not should be no (twice)

In chord_and_tangent, the new doc line is too long (should break at 80 chars)

In chord_and_tangent, I am concerned that the use of rational points may restrict the use of this function to the field QQ.

Everywhere, we need at least one example over QQ[sqrt(5)] for instance. And if possible one over QQ(t) ?


---

Comment by cremona created at 2018-01-27 09:08:52

Thanks -- I have fixed the typos and will test over other fields.  (Not that the old code was no tested except over Q in the doctests).

Good point (!) about the use of `rational_points`, which is in fact used in the main function here and not just in the (now redundant) {{chord_and_tangent}}}.  We use it in two ways: to find the 3rd intersection point of the cubic with the tangent at some rational point; and to find the intersection of the cubic with its Hessian.  The first could be done "by hand" if necessary, though it is a lot cleaner as it is.  I'll see how it goes.


---

Comment by cremona created at 2018-01-27 09:08:52

Changing status from needs_review to needs_work.


---

Comment by cremona created at 2018-01-27 09:28:03

It seems to work fine as it is over finite fields and number fields.  Over Q(t) it doesn't because somehwere (not in this code itself) a polynomial factorization is done which requires "proof=False"; however the old code (before this patch also fails over Q(t) for a quite different and stupid reason (the function `projective_point` fails when the coordinates of points are not integers (or perhaps rationals)!  So this is already better regarding support of base fields other than Q.

All we need do as add the parameter factor=False each time we call `tangents()` and all these cases work fine!

I will prepare the new patch when I can.


---

Comment by git created at 2018-01-28 15:12:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by cremona created at 2018-01-28 15:17:07

Ready for review again.  I factored out the construction of the tangent line to a separate function which uses the factor=False when necessary only.  Experiment showed that using factor=False over QQ led to worse models since (for example) it would return 3*x+3*y instead of x+y.  Noe the code works over all fields I tried: function fields, finite fields, number fields.  Several extra doctests show this.

I fixed the typos, and hope I did not introduce more.

There was already a note that the supplied point is not always mapped to the point at infinity on the elliptic curve, which I did not change.


---

Comment by cremona created at 2018-01-28 15:17:07

Changing status from needs_work to needs_review.


---

Comment by cremona created at 2018-01-29 08:53:43

BTW some patch bots are reporting errors which only prove that they (the patchbots) are broken, nothing to do with these changes,


---

Comment by chapoton created at 2018-01-29 15:45:03

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2018-01-29 15:45:03

ok, let it be. Thanks!


---

Comment by cremona created at 2018-01-30 09:03:32

Thanks for the review.


---

Comment by vbraun created at 2018-02-01 19:13:31

Resolution: fixed
