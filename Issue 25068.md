# Issue 25068: Adding method sage.external.has_graphviz

Issue created by migration from https://trac.sagemath.org/ticket/25305

Original creator: slabbe

Original creation time: 2018-05-08 08:40:30

Implement this:

```
sage: from sage.doctest.external import has_graphviz
sage: has_graphviz()
True
```


so that graphviz is included in the external software to be detected:


```
$ sage -t --optional=external src/sage/graphs/graph_latex.py
...
Using --optional=external
External software to be detected: cplex,graphviz,gurobi,internet,latex,
macaulay2,magma,maple,mathematica,matlab,octave,scilab
...
```



---

Comment by slabbe created at 2018-05-08 08:43:28

Changing status from new to needs_review.


---

Comment by slabbe created at 2018-05-08 08:43:28

New commits:


---

Comment by git created at 2018-05-08 11:55:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2018-05-08 12:01:45

I added `has_ffmpeg` and `have_imagemagick` in the second commit. 

For references, the list `tests_not_run` below contains all tags of tests that are not run by default. The list was obtained from `grep "not run"` on the log of `./sage -t -p --all --long --show-skipped`:


```
sage: tests_not_run = ['4ti2', 'and', 'axiom', 'beautifulsoup', 'benzene', 'bliss', 'buckygen',
....: 'cbc', 'chomp', 'coxeter3', 'cplex', 'cryptominisat', 'csdp', 'cunningham',
....: 'database', 'database_cremona_ellcurve', 'database_gap',
....: 'database_jones_numfield', 'database_kohel', 'database_mutation_class',
....: 'database_odlyzko_zeta', 'database_pari', 'database_stein_watkins',
....: 'database_symbolic_data', 'debug', 'fes', 'ffmpeg', 'fricas', 'frobby',
....: 'gambit', 'gap3', 'gap_packages', 'gdb', 'giacpy_sage', 'ginv', 'glucose',
....: 'gmp', 'gmpy2', 'gnuplot', 'gperftools', 'graphviz', 'growing', 'gurobi',
....: 'hmisc', 'imagemagick', 'internet', 'java', 'kash', 'latex', 'latte_int',
....: 'libbraiding', 'libhomfly', 'libjpeg', 'lie', 'lrs', 'lrslib', 'macaulay2',
....: 'magma', 'maple', 'mathematica', 'mathematicafrontend', 'matlab', 'mcqd',
....: 'meataxe', 'mupad', 'nonexistent_lp_solver', 'octave', 'ore_algebra', 'phc',
....: 'plantri', 'polymake', 'polytopes_db_4d', 'py3', 'pynormaliz', 'python_igraph',
....: 'qepcad', 'randomly', 'required', 'requires', 'rgraphics', 'rsat', 'runsnake',
....: 'scilab', 'sirocco', 'sloane_database', 'surf', 'tdlib', 'the', 'tides',
....: 'time', 'topcom', 'webbrowser']
```


And this is a tentative list of all "external" packages:


```
sage: S = set(package_versions('standard'))
sage: O = set(package_versions('optional'))
sage: E = set(package_versions('experimental'))
sage: set(tests_not_run) - (S|O|E)
{'and',
 'axiom',
 'beautifulsoup',
 'chomp',
 'cplex',
 'cunningham',
 'database',
 'debug',
 'fes',
 'ffmpeg',
 'ginv',
 'glucose',
 'gnuplot',
 'gperftools',
 'graphviz',
 'growing',
 'gurobi',
 'hmisc',
 'imagemagick',
 'internet',
 'java',
 'kash',
 'latex',
 'libjpeg',
 'lrs',
 'macaulay2',
 'magma',
 'maple',
 'mathematica',
 'mathematicafrontend',
 'matlab',
 'mupad',
 'nonexistent_lp_solver',
 'octave',
 'phc',
 'polytopes_db_4d',
 'py3',
 'randomly',
 'required',
 'requires',
 'rgraphics',
 'rsat',
 'runsnake',
 'scilab',
 'sloane_database',
 'the',
 'time',
 'webbrowser'}
```


Maybe we want to detect some more external packages...


---

Comment by git created at 2018-05-08 12:14:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2018-05-10 14:56:34

Shouldn't this use the recently merged #20382?


---

Comment by vdelecroix created at 2018-05-13 10:18:08

Replying to [comment:9 vdelecroix]:
> Shouldn't this use the recently merged #20382?

Actually, I think that all the `has_xxx` stuff would better be features.


---

Comment by slabbe created at 2018-05-15 14:03:46

New commits:


---

Comment by slabbe created at 2018-05-15 14:05:08

Replying to [comment:9 vdelecroix]:
> Shouldn't this use the recently merged #20382?

Ok as you wish. I am now using `find_executable` from the `Features` stuff instead of the `have_program` from the `misc` stuff.


---

Comment by slabbe created at 2018-05-15 14:18:04

Replying to [comment:10 vdelecroix]: 
> Actually, I think that all the `has_xxx` stuff would better be features.

Why better? To me adding three new `has_key` functions to the `external.py` module makes things better. But changing `has_maple` in a way that it uses `features` does not make anything better.

The way the `external.py` module is coded right now is that the presence of an external software with name `tag` is detected with a method whose name is `has_tag`. The goal of this ticket is not to redesign all of this `external.py` module. So I suggest that further uses of feature inside of `external.py` be postpone to another ticket if this is at all pertinent.

Needs review!


---

Comment by vdelecroix created at 2018-05-17 07:08:17

Changing status from needs_review to needs_info.


---

Comment by vdelecroix created at 2018-05-17 07:08:17

Replying to [comment:14 slabbe]:
> Replying to [comment:10 vdelecroix]: 
> > Actually, I think that all the `has_xxx` stuff would better be features.
> 
> Why better? To me adding three new `has_key` functions to the `external.py` module makes things better. But changing `has_maple` in a way that it uses `features` does not make anything better.

I just realized that it is not possible for `has_maple`. The maple interface allows subtle configurations such as
- an alternative name for the executable
- a remote execution through ssh
This is not the kind of things a feature is aware of.

> The way the `external.py` module is coded right now is that the presence of an external software with name `tag` is detected with a method whose name is `has_tag`. The goal of this ticket is not to redesign all of this `external.py` module. So I suggest that further uses of feature inside of `external.py` be postpone to another ticket if this is at all pertinent.

In your situation, you are just checking for the presence of executable in the path. This is exactly what `sage.features.Executable` is about. The main difference between `has_XXX_ and a feature is that
- a feature is not only about doctest
- a feature can run small tests
- meaningful error messages
- this is not run twice in the same session

What I wanted to suggest with my message is to introduce `sage.features.graphviz`, `sage.features.ffmpeg` and `sage.features.imagemagick` and simply use

```
def has_ffmpeg():
    from sage.features.ffmpeg import FFmpeg
    return FFmpeg.is_present()
```

The software `FFmpeg` is indeed used in other parts of Sage (e.g. `animate`) and it would help to have it as a feature.


---

Comment by vdelecroix created at 2018-05-17 07:08:17

Changing keywords from "" to "thursdaysbdx".


---

Comment by slabbe created at 2018-05-20 13:12:03

Changing status from needs_info to needs_review.


---

Comment by slabbe created at 2018-05-20 13:12:03

I now creates the files for ffmpeg, imagemagick and graphviz in the feature module and I am using these to solve the problem described in this ticket.

I suggest that the use of the `FFmpeg().require()` in `animate.py` etc be postpone to an indenpendent ticket.
----
New commits:


---

Comment by git created at 2018-05-20 13:14:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-05-20 13:21:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-05-20 13:37:00

I fixed some doctests and removed `import os,subprocess` in the previous two forced pushed.


---

Comment by slabbe created at 2018-05-20 13:37:12

Needs review!


---

Comment by vdelecroix created at 2018-05-29 05:57:12

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2018-05-29 05:57:12

Image magick is a suite and not a unique executable:
- `magick`
- `magick-script`
- `convert`
- `mogrify`
- `identify`
- `composite`
- `montage`
- `compare`
- etc


---

Comment by slabbe created at 2018-05-30 20:00:57

Can you provide an example where a command from imagemagick other than `convert` is used in the sage source code?


```
$ sage -grep mogrify
$ sage -grep magick-script
$ sage -grep magick
sage/misc/latex.py:    http://www.imagemagick.org
sage/misc/latex.py:            print("http://www.imagemagick.org to download these programs.")
sage/misc/latex.py:            print("Go to http://www.imagemagick.org to download it.")
sage/misc/latex.py:            print("Go to http://www.imagemagick.org to download it.")
sage/combinat/words/paths.py:            See www.imagemagick.org, for example.
sage/graphs/graph_latex.py:- convert: http://www.imagemagick.org (the ImageMagick suite)
sage/plot/animate.py:- `ImageMagick <http://www.imagemagick.org>`_
sage/plot/animate.py:              See www.imagemagick.org and www.ffmpeg.org for more information.
sage/plot/animate.py:        - `ImageMagick <http://www.imagemagick.org>`_
sage/plot/animate.py:See www.imagemagick.org and www.ffmpeg.org for more information."""
sage/plot/animate.py:See www.imagemagick.org and www.ffmpeg.org for more information."""
sage/plot/animate.py:              See www.imagemagick.org and www.ffmpeg.org for more information.

etc.
```



---

Comment by git created at 2018-05-30 20:21:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-05-30 20:23:00

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2018-05-30 20:23:00

Branch rebased on top of 8.3.beta2.

Added doc about the fact that currently only the presence of convert is checked.

I also fix the doctest that was failing on the patchbot.

Needs review.


---

Comment by vdelecroix created at 2018-06-03 09:09:47

You forgot the copyright.

The rest looks ok.


---

Comment by vdelecroix created at 2018-06-03 09:09:55

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-06-07 13:35:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2018-06-07 13:40:25

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2018-06-07 13:40:25

Rebased the branch on top of 8.3.beta4.

Added a commit which adds the licence to the newly created files.

Needs review.


---

Comment by vdelecroix created at 2018-06-07 15:13:14

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2018-06-07 19:41:29

Thank you for the review


---

Comment by vbraun created at 2018-06-09 17:49:24

Resolution: fixed


---

Comment by slelievre created at 2018-06-13 10:45:29

I noticed that some of the doctests have

    # optional -- graphviz

while some other doctests have

    # optional: graphviz

Are both styles equivalent?
