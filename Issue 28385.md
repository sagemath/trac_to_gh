# Issue 28385: Patchbot and Python 3 doctest failures

archive/issues_028385.json:
```json
{
    "body": "With a Python 3 patchbot, there are doctest failures in three files:\n\n```\nsage -t --long src/sage/repl/attach.py  # 4 doctests failed\nsage -t --long src/sage/libs/singular/function.pyx  # 1 doctest failed\nsage -t --long src/sage/numerical/backends/generic_backend.pyx  # 2 doctests failed\n```\n\nThis can be replicated by hand. Install the patchbot, run Python, and do\n\n```\n>>> from sage_patchbot.patchbot import Patchbot\n>>> P = Patchbot({'sage_root': '/path/to/SAGE_ROOT'})\n>>> P.config['parallelism'] = 4 # to speed things up\n>>> P.test_a_ticket(0)\n```\n\nThe patchbot will do a lot of stuff and then print the command being executed:\n\n```\n/path/to/SAGE_ROOT/sage -tp 10  --all --long\n```\n\nThen it runs `os.system('/path/to/SAGE_ROOT/sage -tp 10  --all --long')`, and the errors should arise. Confusingly, this does not lead to errors:\n\n```\n>>> import os\n>>> os.system('/path/to/SAGE_ROOT/sage -tp 10  --all --long')\n```\n\nSo something particular to the patchbot is leading to these errors.\n\nIssue created by migration from https://trac.sagemath.org/ticket/28622\n\n",
    "created_at": "2019-10-17T17:10:58Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "Patchbot and Python 3 doctest failures",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28385",
    "user": "@jhpalmieri"
}
```
With a Python 3 patchbot, there are doctest failures in three files:

```
sage -t --long src/sage/repl/attach.py  # 4 doctests failed
sage -t --long src/sage/libs/singular/function.pyx  # 1 doctest failed
sage -t --long src/sage/numerical/backends/generic_backend.pyx  # 2 doctests failed
```

This can be replicated by hand. Install the patchbot, run Python, and do

```
>>> from sage_patchbot.patchbot import Patchbot
>>> P = Patchbot({'sage_root': '/path/to/SAGE_ROOT'})
>>> P.config['parallelism'] = 4 # to speed things up
>>> P.test_a_ticket(0)
```

The patchbot will do a lot of stuff and then print the command being executed:

```
/path/to/SAGE_ROOT/sage -tp 10  --all --long
```

Then it runs `os.system('/path/to/SAGE_ROOT/sage -tp 10  --all --long')`, and the errors should arise. Confusingly, this does not lead to errors:

```
>>> import os
>>> os.system('/path/to/SAGE_ROOT/sage -tp 10  --all --long')
```

So something particular to the patchbot is leading to these errors.

Issue created by migration from https://trac.sagemath.org/ticket/28622





---

archive/issue_comments_400836.json:
```json
{
    "body": "The failures:\n\n```\nsage -t --long src/sage/repl/attach.py\n**********************************************************************\nFile \"src/sage/repl/attach.py\", line 36, in sage.repl.attach\nFailed example:\n    try:\n        attach(src)\n    except Exception:\n        traceback.print_exc()\nExpected:\n    Traceback (most recent call last):\n    ...\n        exec(preparse_file(f.read()) + \"\\n\", globals)\n      File \"<string>\", line 3, in <module>\n    ValueError: third\nGot:\n    <BLANKLINE>\n**********************************************************************\nFile \"src/sage/repl/attach.py\", line 45, in sage.repl.attach\nFailed example:\n    detach(src)\nExpected nothing\nGot:\n    Traceback (most recent call last):\n      File \"<doctest sage.repl.attach[10]>\", line 2, in <module>\n        attach(src)\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3697)\n        return self.get_object()(*args, **kwds)\n      File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/attach.py\", line 356, in attach\n        load(filename, globals(), attach=True)\n      File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/load.py\", line 272, in load\n        exec(preparse_file(f.read()) + \"\\n\", globals)\n      File \"<string>\", line 3, in <module>\n    ValueError: third\n**********************************************************************\nFile \"src/sage/repl/attach.py\", line 48, in sage.repl.attach\nFailed example:\n    try:\n        attach(src)\n    except Exception:\n        traceback.print_exc()\nExpected:\n    Traceback (most recent call last):\n    ...\n        exec(code, globals)\n      File \".../foobar.sage....py\", line ..., in <module>\n        raise ValueError(\"third\")   # this should appear in the source snippet\n    ValueError: third\nGot:\n    <BLANKLINE>\n**********************************************************************\nFile \"src/sage/repl/attach.py\", line 58, in sage.repl.attach\nFailed example:\n    detach(src)\nExpected nothing\nGot:\n    Traceback (most recent call last):\n      File \"<doctest sage.repl.attach[13]>\", line 2, in <module>\n        attach(src)\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3697)\n        return self.get_object()(*args, **kwds)\n      File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/attach.py\", line 356, in attach\n        load(filename, globals(), attach=True)\n      File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/load.py\", line 266, in load\n        exec(code, globals)\n      File \"/Users/jpalmier/.sage/temp/jpalmieri138.local/85343/foobar.sageyh9c7b26.py\", line 7, in <module>\n        raise ValueError(\"third\")   # this should appear in the source snippet\n    ValueError: third\n**********************************************************************\n1 item had failures:\n   4 of  16 in sage.repl.attach\n    [129 tests, 4 failures, 2.43 s]\n```\n\nand\n\n```\nsage -t --long src/sage/libs/singular/function.pyx\n**********************************************************************\nFile \"src/sage/libs/singular/function.pyx\", line 1314, in sage.libs.singular.function.SingularFunction.__call__\nFailed example:\n    G= Ideal(I.groebner_basis())\nExpected nothing\nGot:\n    RuntimeError: Error raised calling singular function\n    Exception ignored in: 'sage.libs.singular.function.LibraryCallHandler.handle_call'\n    RuntimeError: Error raised calling singular function\n**********************************************************************\n1 item had failures:\n   1 of  24 in sage.libs.singular.function.SingularFunction.__call__\n    [302 tests, 1 failure, 1.63 s]\n```\n\nand\n\n```\nFile \"src/sage/numerical/backends/generic_backend.pyx\", line 181, in sage.numerical.backends.generic_backend.GenericBackend._test_add_variables\nFailed example:\n    sig_on_count() # check sig_on/off pairings (virtual doctest)\nExpected:\n    0\nGot:\n    NotImplementedError\n    Exception ignored in: 'sage.numerical.backends.generic_backend.GenericBackend.ncols'\n    NotImplementedError: \n    0\n**********************************************************************\nFile \"src/sage/numerical/backends/generic_backend.pyx\", line 646, in sage.numerical.backends.generic_backend.GenericBackend._test_add_linear_constraints\nFailed example:\n    sig_on_count() # check sig_on/off pairings (virtual doctest)\nExpected:\n    0\nGot:\n    NotImplementedError\n    Exception ignored in: 'sage.numerical.backends.generic_backend.GenericBackend.nrows'\n    NotImplementedError: \n    0\n**********************************************************************\n2 items had failures:\n   1 of   4 in sage.numerical.backends.generic_backend.GenericBackend._test_add_linear_constraints\n   1 of   4 in sage.numerical.backends.generic_backend.GenericBackend._test_add_variables\n    [89 tests, 2 failures, 1.04 s]\n```\n",
    "created_at": "2019-10-17T17:13:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400836",
    "user": "@jhpalmieri"
}
```

The failures:

```
sage -t --long src/sage/repl/attach.py
**********************************************************************
File "src/sage/repl/attach.py", line 36, in sage.repl.attach
Failed example:
    try:
        attach(src)
    except Exception:
        traceback.print_exc()
Expected:
    Traceback (most recent call last):
    ...
        exec(preparse_file(f.read()) + "\n", globals)
      File "<string>", line 3, in <module>
    ValueError: third
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/repl/attach.py", line 45, in sage.repl.attach
Failed example:
    detach(src)
Expected nothing
Got:
    Traceback (most recent call last):
      File "<doctest sage.repl.attach[10]>", line 2, in <module>
        attach(src)
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3697)
        return self.get_object()(*args, **kwds)
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/attach.py", line 356, in attach
        load(filename, globals(), attach=True)
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/load.py", line 272, in load
        exec(preparse_file(f.read()) + "\n", globals)
      File "<string>", line 3, in <module>
    ValueError: third
**********************************************************************
File "src/sage/repl/attach.py", line 48, in sage.repl.attach
Failed example:
    try:
        attach(src)
    except Exception:
        traceback.print_exc()
Expected:
    Traceback (most recent call last):
    ...
        exec(code, globals)
      File ".../foobar.sage....py", line ..., in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ValueError: third
Got:
    <BLANKLINE>
**********************************************************************
File "src/sage/repl/attach.py", line 58, in sage.repl.attach
Failed example:
    detach(src)
Expected nothing
Got:
    Traceback (most recent call last):
      File "<doctest sage.repl.attach[13]>", line 2, in <module>
        attach(src)
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3697)
        return self.get_object()(*args, **kwds)
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/attach.py", line 356, in attach
        load(filename, globals(), attach=True)
      File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.0.beta1/local/lib/python3.7/site-packages/sage/repl/load.py", line 266, in load
        exec(code, globals)
      File "/Users/jpalmier/.sage/temp/jpalmieri138.local/85343/foobar.sageyh9c7b26.py", line 7, in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ValueError: third
**********************************************************************
1 item had failures:
   4 of  16 in sage.repl.attach
    [129 tests, 4 failures, 2.43 s]
```

and

```
sage -t --long src/sage/libs/singular/function.pyx
**********************************************************************
File "src/sage/libs/singular/function.pyx", line 1314, in sage.libs.singular.function.SingularFunction.__call__
Failed example:
    G= Ideal(I.groebner_basis())
Expected nothing
Got:
    RuntimeError: Error raised calling singular function
    Exception ignored in: 'sage.libs.singular.function.LibraryCallHandler.handle_call'
    RuntimeError: Error raised calling singular function
**********************************************************************
1 item had failures:
   1 of  24 in sage.libs.singular.function.SingularFunction.__call__
    [302 tests, 1 failure, 1.63 s]
```

and

```
File "src/sage/numerical/backends/generic_backend.pyx", line 181, in sage.numerical.backends.generic_backend.GenericBackend._test_add_variables
Failed example:
    sig_on_count() # check sig_on/off pairings (virtual doctest)
Expected:
    0
Got:
    NotImplementedError
    Exception ignored in: 'sage.numerical.backends.generic_backend.GenericBackend.ncols'
    NotImplementedError: 
    0
**********************************************************************
File "src/sage/numerical/backends/generic_backend.pyx", line 646, in sage.numerical.backends.generic_backend.GenericBackend._test_add_linear_constraints
Failed example:
    sig_on_count() # check sig_on/off pairings (virtual doctest)
Expected:
    0
Got:
    NotImplementedError
    Exception ignored in: 'sage.numerical.backends.generic_backend.GenericBackend.nrows'
    NotImplementedError: 
    0
**********************************************************************
2 items had failures:
   1 of   4 in sage.numerical.backends.generic_backend.GenericBackend._test_add_linear_constraints
   1 of   4 in sage.numerical.backends.generic_backend.GenericBackend._test_add_variables
    [89 tests, 2 failures, 1.04 s]
```




---

archive/issue_comments_400837.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2019-10-17T17:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400837",
    "user": "@jhpalmieri"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_400838.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to python3.",
    "created_at": "2019-10-17T17:14:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400838",
    "user": "@jhpalmieri"
}
```

Changing component from PLEASE CHANGE to python3.



---

archive/issue_comments_400839.json:
```json
{
    "body": "A quicker way to get the failures:\n\n```pycon\n>>> from sage_patchbot.patchbot import Tee\n>>> with Tee('/path/to/logfile', time=True, timeout=40):\n...     os.system('/path/to/SAGE_ROOT/sage -tp 3 --long src/sage/repl/attach.py src/sage/numerical/backends/generic_backend.pyx src/sage/libs/singular/function.pyx')\n```\n",
    "created_at": "2019-10-17T17:20:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400839",
    "user": "@jhpalmieri"
}
```

A quicker way to get the failures:

```pycon
>>> from sage_patchbot.patchbot import Tee
>>> with Tee('/path/to/logfile', time=True, timeout=40):
...     os.system('/path/to/SAGE_ROOT/sage -tp 3 --long src/sage/repl/attach.py src/sage/numerical/backends/generic_backend.pyx src/sage/libs/singular/function.pyx')
```




---

archive/issue_comments_400840.json:
```json
{
    "body": "Could the problem be the [inheritability (or not)](https://docs.python.org/3/library/os.html#os.dup) of the file descriptors in `Tee`? In any case, in `sage_patchbot.patchbot`, if I comment out these lines, the doctests don't fail:\n\n```diff\ndiff --git a/sage_patchbot/patchbot.py b/sage_patchbot/patchbot.py\nindex b411c7c..2994db1 100755\n--- a/sage_patchbot/patchbot.py\n+++ b/sage_patchbot/patchbot.py\n@@ -142,8 +142,8 @@ class Tee(object):\n         self._saved = os.dup(sys.stdout.fileno()), os.dup(sys.stderr.fileno())\n         self.tee = subprocess.Popen([\"tee\", self.filepath],\n                                     stdin=subprocess.PIPE)\n-        os.dup2(self.tee.stdin.fileno(), sys.stdout.fileno())\n-        os.dup2(self.tee.stdin.fileno(), sys.stderr.fileno())\n+        # os.dup2(self.tee.stdin.fileno(), sys.stdout.fileno())\n+        # os.dup2(self.tee.stdin.fileno(), sys.stderr.fileno())\n         if self.time:\n             print(now_str())\n             self.start_time = time.time()\n```\n\nOf course also the log file doesn't get written.",
    "created_at": "2019-10-17T17:40:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400840",
    "user": "@jhpalmieri"
}
```

Could the problem be the [inheritability (or not)](https://docs.python.org/3/library/os.html#os.dup) of the file descriptors in `Tee`? In any case, in `sage_patchbot.patchbot`, if I comment out these lines, the doctests don't fail:

```diff
diff --git a/sage_patchbot/patchbot.py b/sage_patchbot/patchbot.py
index b411c7c..2994db1 100755
--- a/sage_patchbot/patchbot.py
+++ b/sage_patchbot/patchbot.py
@@ -142,8 +142,8 @@ class Tee(object):
         self._saved = os.dup(sys.stdout.fileno()), os.dup(sys.stderr.fileno())
         self.tee = subprocess.Popen(["tee", self.filepath],
                                     stdin=subprocess.PIPE)
-        os.dup2(self.tee.stdin.fileno(), sys.stdout.fileno())
-        os.dup2(self.tee.stdin.fileno(), sys.stderr.fileno())
+        # os.dup2(self.tee.stdin.fileno(), sys.stdout.fileno())
+        # os.dup2(self.tee.stdin.fileno(), sys.stderr.fileno())
         if self.time:
             print(now_str())
             self.start_time = time.time()
```

Of course also the log file doesn't get written.



---

archive/issue_comments_400841.json:
```json
{
    "body": "Could there be some connection to the use of Python's `traceback` module? I'm trying to find common threads among the three files with failures, and I'm not getting very far, but if I make this change, then tests pass in `repl/attach.py`:\n\n```diff\ndiff --git a/src/sage/repl/attach.py b/src/sage/repl/attach.py\nindex c350ec33af..e1c98e32ad 100644\n--- a/src/sage/repl/attach.py\n+++ b/src/sage/repl/attach.py\n@@ -36,7 +36,7 @@ character-by-character::\n     sage: try:\n     ....:     attach(src)\n     ....: except Exception:\n-    ....:     traceback.print_exc()\n+    ....:     raise\n     Traceback (most recent call last):\n     ...\n         exec(preparse_file(f.read()) + \"\\n\", globals)\n@@ -48,7 +48,7 @@ character-by-character::\n     sage: try:\n     ....:     attach(src)\n     ....: except Exception:\n-    ....:     traceback.print_exc()\n+    ....:     raise\n     Traceback (most recent call last):\n     ...\n         exec(code, globals)\n```\n",
    "created_at": "2019-10-17T20:26:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400841",
    "user": "@jhpalmieri"
}
```

Could there be some connection to the use of Python's `traceback` module? I'm trying to find common threads among the three files with failures, and I'm not getting very far, but if I make this change, then tests pass in `repl/attach.py`:

```diff
diff --git a/src/sage/repl/attach.py b/src/sage/repl/attach.py
index c350ec33af..e1c98e32ad 100644
--- a/src/sage/repl/attach.py
+++ b/src/sage/repl/attach.py
@@ -36,7 +36,7 @@ character-by-character::
     sage: try:
     ....:     attach(src)
     ....: except Exception:
-    ....:     traceback.print_exc()
+    ....:     raise
     Traceback (most recent call last):
     ...
         exec(preparse_file(f.read()) + "\n", globals)
@@ -48,7 +48,7 @@ character-by-character::
     sage: try:
     ....:     attach(src)
     ....: except Exception:
-    ....:     traceback.print_exc()
+    ....:     raise
     Traceback (most recent call last):
     ...
         exec(code, globals)
```




---

archive/issue_comments_400842.json:
```json
{
    "body": "The following change to `repl/attach.py` is almost good enough:\n\n```diff\ndiff --git a/src/sage/repl/attach.py b/src/sage/repl/attach.py\nindex c350ec33af..bdfaad4f7f 100644\n--- a/src/sage/repl/attach.py\n+++ b/src/sage/repl/attach.py\n@@ -20,12 +20,8 @@ Check that no file clutter is produced::\n     ['foobar.sage']\n     sage: detach(src)\n \n-In debug mode backtraces contain code snippets. We need to manually\n-print the traceback because the python doctest module has special\n-support for exceptions and does not match them\n-character-by-character::\n+Check printing of code snippets in debug mode::\n \n-    sage: import traceback\n     sage: with open(src, 'w') as f:\n     ....:     _ = f.write('# first line\\n')\n     ....:     _ = f.write('# second line\\n')\n@@ -33,10 +29,7 @@ character-by-character::\n     ....:     _ = f.write('# fourth line\\n')\n \n     sage: load_attach_mode(attach_debug=False)\n-    sage: try:\n-    ....:     attach(src)\n-    ....: except Exception:\n-    ....:     traceback.print_exc()\n+    sage: attach(src)\n     Traceback (most recent call last):\n     ...\n         exec(preparse_file(f.read()) + \"\\n\", globals)\n@@ -45,10 +38,7 @@ character-by-character::\n     sage: detach(src)\n \n     sage: load_attach_mode(attach_debug=True)\n-    sage: try:\n-    ....:     attach(src)\n-    ....: except Exception:\n-    ....:     traceback.print_exc()\n+    sage: attach(src)\n     Traceback (most recent call last):\n     ...\n         exec(code, globals)\n```\n\nThe problem is that it would allow some doctests to pass that should fail. From the file:\n\n```python\n    sage: with open(src, 'w') as f:\n    ....:     _ = f.write('# first line\\n')\n    ....:     _ = f.write('# second line\\n')\n    ....:     _ = f.write('raise ValueError(\"third\")   # this should appear in the source snippet\\n')\n    ....:     _ = f.write('# fourth line\\n')\n```\n\nThen this passes, as it should:\n\n```python\n    sage: load_attach_mode(attach_debug=True)\n    sage: attach(src)\n    Traceback (most recent call last):\n    ...\n        exec(code, globals)\n      File \".../foobar.sage....py\", line ..., in <module>\n        raise ValueError(\"third\")   # this should appear in the source snippet\n    ValueError: third\n```\n\nBut this also passes: note that the second to last line is different:\n\n```python\n    sage: load_attach_mode(attach_debug=True)\n    sage: attach(src)\n    Traceback (most recent call last):\n    ...\n        exec(code, globals)\n      File \".../foobar.sage....py\", line ..., in <module>\n        raise ValueError(\"third\")   # this is gibberish\n    ValueError: third\n```\n\nI guess this is what is meant by \"We need to manually print the traceback because ...\"",
    "created_at": "2019-10-17T20:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400842",
    "user": "@jhpalmieri"
}
```

The following change to `repl/attach.py` is almost good enough:

```diff
diff --git a/src/sage/repl/attach.py b/src/sage/repl/attach.py
index c350ec33af..bdfaad4f7f 100644
--- a/src/sage/repl/attach.py
+++ b/src/sage/repl/attach.py
@@ -20,12 +20,8 @@ Check that no file clutter is produced::
     ['foobar.sage']
     sage: detach(src)
 
-In debug mode backtraces contain code snippets. We need to manually
-print the traceback because the python doctest module has special
-support for exceptions and does not match them
-character-by-character::
+Check printing of code snippets in debug mode::
 
-    sage: import traceback
     sage: with open(src, 'w') as f:
     ....:     _ = f.write('# first line\n')
     ....:     _ = f.write('# second line\n')
@@ -33,10 +29,7 @@ character-by-character::
     ....:     _ = f.write('# fourth line\n')
 
     sage: load_attach_mode(attach_debug=False)
-    sage: try:
-    ....:     attach(src)
-    ....: except Exception:
-    ....:     traceback.print_exc()
+    sage: attach(src)
     Traceback (most recent call last):
     ...
         exec(preparse_file(f.read()) + "\n", globals)
@@ -45,10 +38,7 @@ character-by-character::
     sage: detach(src)
 
     sage: load_attach_mode(attach_debug=True)
-    sage: try:
-    ....:     attach(src)
-    ....: except Exception:
-    ....:     traceback.print_exc()
+    sage: attach(src)
     Traceback (most recent call last):
     ...
         exec(code, globals)
```

The problem is that it would allow some doctests to pass that should fail. From the file:

```python
    sage: with open(src, 'w') as f:
    ....:     _ = f.write('# first line\n')
    ....:     _ = f.write('# second line\n')
    ....:     _ = f.write('raise ValueError("third")   # this should appear in the source snippet\n')
    ....:     _ = f.write('# fourth line\n')
```

Then this passes, as it should:

```python
    sage: load_attach_mode(attach_debug=True)
    sage: attach(src)
    Traceback (most recent call last):
    ...
        exec(code, globals)
      File ".../foobar.sage....py", line ..., in <module>
        raise ValueError("third")   # this should appear in the source snippet
    ValueError: third
```

But this also passes: note that the second to last line is different:

```python
    sage: load_attach_mode(attach_debug=True)
    sage: attach(src)
    Traceback (most recent call last):
    ...
        exec(code, globals)
      File ".../foobar.sage....py", line ..., in <module>
        raise ValueError("third")   # this is gibberish
    ValueError: third
```

I guess this is what is meant by "We need to manually print the traceback because ..."



---

archive/issue_comments_400843.json:
```json
{
    "body": "Nice to see that you are making progress. Sorry that I cannot help.",
    "created_at": "2019-10-18T09:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400843",
    "user": "@fchapoton"
}
```

Nice to see that you are making progress. Sorry that I cannot help.



---

archive/issue_comments_400844.json:
```json
{
    "body": "FWIW, I systematically get these doctest failures outside the patchbot framework, namely on a Ubuntu 18.04 computer when doing `make ptestlong`, cf. https://groups.google.com/d/msg/sage-release/yFwTkcr5AVY/ifqU7-3ZAAAJ",
    "created_at": "2019-10-18T11:38:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400844",
    "user": "@egourgoulhon"
}
```

FWIW, I systematically get these doctest failures outside the patchbot framework, namely on a Ubuntu 18.04 computer when doing `make ptestlong`, cf. https://groups.google.com/d/msg/sage-release/yFwTkcr5AVY/ifqU7-3ZAAAJ



---

archive/issue_comments_400845.json:
```json
{
    "body": "Couldn't some of them be yet another cases of \"flush missing\", as the previous py3 problems that were fixed ? In the repl_attach case, the correct answer seems to appear in the next doctest.",
    "created_at": "2019-10-21T18:51:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400845",
    "user": "@fchapoton"
}
```

Couldn't some of them be yet another cases of "flush missing", as the previous py3 problems that were fixed ? In the repl_attach case, the correct answer seems to appear in the next doctest.



---

archive/issue_comments_400846.json:
```json
{
    "body": "Interesting question. If I add some `sys.stdout.flush()` commands, then I can get the `repl/attach.py` doctests to pass when run as in the ticket description (using tee and output redirection), but then doctests fail when run the usual way. I'll keep experimenting.",
    "created_at": "2019-10-21T21:48:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400846",
    "user": "@jhpalmieri"
}
```

Interesting question. If I add some `sys.stdout.flush()` commands, then I can get the `repl/attach.py` doctests to pass when run as in the ticket description (using tee and output redirection), but then doctests fail when run the usual way. I'll keep experimenting.



---

archive/issue_comments_400847.json:
```json
{
    "body": "Okay, here is an attempt at a fix. It fixes the particular problem in the ticket description, at least for me on OS X. Eric, does it help with your situation?\n\nShould I mark it as \"needs review\", or should some explanatory comments be added? Or is it even the correct approach?\n----\nNew commits:",
    "created_at": "2019-10-21T22:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400847",
    "user": "@jhpalmieri"
}
```

Okay, here is an attempt at a fix. It fixes the particular problem in the ticket description, at least for me on OS X. Eric, does it help with your situation?

Should I mark it as "needs review", or should some explanatory comments be added? Or is it even the correct approach?
----
New commits:



---

archive/issue_comments_400848.json:
```json
{
    "body": "This looks good enough for me, even if this is maybe more fixing symptoms than illness.\n\nI will launch my atlas patchbot on the branch.",
    "created_at": "2019-10-22T07:05:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400848",
    "user": "@fchapoton"
}
```

This looks good enough for me, even if this is maybe more fixing symptoms than illness.

I will launch my atlas patchbot on the branch.



---

archive/issue_comments_400849.json:
```json
{
    "body": "This seems to work with python2 and to fix the python3 issues also on Ubuntu patchbot. I am extremely tempted to give a positive review.",
    "created_at": "2019-10-22T09:01:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400849",
    "user": "@fchapoton"
}
```

This seems to work with python2 and to fix the python3 issues also on Ubuntu patchbot. I am extremely tempted to give a positive review.



---

archive/issue_comments_400850.json:
```json
{
    "body": "Replying to [comment:16 jhpalmieri]:\n> Okay, here is an attempt at a fix. It fixes the particular problem in the ticket description, at least for me on OS X. Eric, does it help with your situation?\n> \nI am just running `make ptestlong` and shall report soon...",
    "created_at": "2019-10-22T12:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400850",
    "user": "@egourgoulhon"
}
```

Replying to [comment:16 jhpalmieri]:
> Okay, here is an attempt at a fix. It fixes the particular problem in the ticket description, at least for me on OS X. Eric, does it help with your situation?
> 
I am just running `make ptestlong` and shall report soon...



---

archive/issue_comments_400851.json:
```json
{
    "body": "Replying to [comment:19 egourgoulhon]:\n> Replying to [comment:16 jhpalmieri]:\n> > Okay, here is an attempt at a fix. It fixes the particular problem in the ticket description, at least for me on OS X. Eric, does it help with your situation?\n> > \n> I am just running `make ptestlong` and shall report soon...\n\nHere is the report from my Ubuntu 18.04 computer:\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 53.0 src/sage/rings/polynomial/polynomial_rational_flint.pyx  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 1357.6 seconds\n```\n\nIn other words, all the doctests discussed here are passed! The only failure is that discussed in #28334.\n\nSo +1 for the positive review.",
    "created_at": "2019-10-22T12:43:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400851",
    "user": "@egourgoulhon"
}
```

Replying to [comment:19 egourgoulhon]:
> Replying to [comment:16 jhpalmieri]:
> > Okay, here is an attempt at a fix. It fixes the particular problem in the ticket description, at least for me on OS X. Eric, does it help with your situation?
> > 
> I am just running `make ptestlong` and shall report soon...

Here is the report from my Ubuntu 18.04 computer:

```
----------------------------------------------------------------------
sage -t --long --warn-long 53.0 src/sage/rings/polynomial/polynomial_rational_flint.pyx  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1357.6 seconds
```

In other words, all the doctests discussed here are passed! The only failure is that discussed in #28334.

So +1 for the positive review.



---

archive/issue_comments_400852.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-10-22T13:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400852",
    "user": "@fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_400853.json:
```json
{
    "body": "ok, so let us first turn to \"needs review\"",
    "created_at": "2019-10-22T13:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400853",
    "user": "@fchapoton"
}
```

ok, so let us first turn to "needs review"



---

archive/issue_comments_400854.json:
```json
{
    "body": "John, do you agree that this could be set to positive ?",
    "created_at": "2019-10-22T15:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400854",
    "user": "@fchapoton"
}
```

John, do you agree that this could be set to positive ?



---

archive/issue_comments_400855.json:
```json
{
    "body": "It\u2019s okay with me.",
    "created_at": "2019-10-22T15:50:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400855",
    "user": "@jhpalmieri"
}
```

Itâ€™s okay with me.



---

archive/issue_comments_400856.json:
```json
{
    "body": "Changing keywords from \"\" to \"python3\".",
    "created_at": "2019-10-22T15:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400856",
    "user": "@fchapoton"
}
```

Changing keywords from "" to "python3".



---

archive/issue_comments_400857.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-22T15:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400857",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400858.json:
```json
{
    "body": "Good. I am setting to positive.",
    "created_at": "2019-10-22T15:51:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400858",
    "user": "@fchapoton"
}
```

Good. I am setting to positive.



---

archive/issue_comments_400859.json:
```json
{
    "body": "Shouldn't we add reference to this ticket to the added lines of code to avoid inadvertent removal ?",
    "created_at": "2019-10-23T07:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400859",
    "user": "@dcoudert"
}
```

Shouldn't we add reference to this ticket to the added lines of code to avoid inadvertent removal ?



---

archive/issue_comments_400860.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2019-10-23T16:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400860",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_400861.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2019-10-23T16:40:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400861",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_400862.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-10-23T16:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400862",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_400863.json:
```json
{
    "body": "Replying to [comment:25 dcoudert]:\n> Shouldn't we add reference to this ticket to the added lines of code to avoid inadvertent removal ?\n\nDone. I'm setting back to positive review, also.",
    "created_at": "2019-10-23T16:41:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400863",
    "user": "@jhpalmieri"
}
```

Replying to [comment:25 dcoudert]:
> Shouldn't we add reference to this ticket to the added lines of code to avoid inadvertent removal ?

Done. I'm setting back to positive review, also.



---

archive/issue_comments_400864.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-27T10:28:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28385",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28385#issuecomment-400864",
    "user": "@vbraun"
}
```

Resolution: fixed
