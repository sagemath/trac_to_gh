# Issue 23614: Fix memoryleak introduced in #11670

archive/issues_023614.json:
```json
{
    "body": "\n\nIssue created by migration from https://trac.sagemath.org/ticket/23851\n\n",
    "created_at": "2017-09-13T22:03:18Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Fix memoryleak introduced in #11670",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23614",
    "user": "@nbruin"
}
```


Issue created by migration from https://trac.sagemath.org/ticket/23851





---

archive/issue_comments_330823.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330823",
    "user": "@nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_330824.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to memleak.",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330824",
    "user": "@nbruin"
}
```

Changing component from PLEASE CHANGE to memleak.



---

archive/issue_comments_330825.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330825",
    "user": "@nbruin"
}
```

New commits:



---

archive/issue_comments_330826.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2017-09-13T22:09:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330826",
    "user": "@nbruin"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_330827.json:
```json
{
    "body": "Cleaned up the docstrings of `absolute_field()` a bit.",
    "created_at": "2017-09-14T06:54:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330827",
    "user": "@pjbruin"
}
```

Cleaned up the docstrings of `absolute_field()` a bit.



---

archive/issue_comments_330828.json:
```json
{
    "body": "I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.",
    "created_at": "2017-09-14T14:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330828",
    "user": "@seblabbe"
}
```

I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.



---

archive/issue_comments_330829.json:
```json
{
    "body": "Changing keywords from \"\" to \"thursdaysbdx\".",
    "created_at": "2017-09-14T14:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330829",
    "user": "@seblabbe"
}
```

Changing keywords from "" to "thursdaysbdx".



---

archive/issue_comments_330830.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-09-14T14:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330830",
    "user": "@seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330831.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-09-17T18:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330831",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_330832.json:
```json
{
    "body": "I'm getting this on various buildbots:\n\n```\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    u,o = K.S_units([])[0]; u, o\nExpected:\n    (-1/2*a + 1/2, 6)\nGot:\n    (1/2*a + 1/2, 6)\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    u^2\nExpected:\n    -1/2*a - 1/2\nGot:\n    1/2*a - 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([])\nExpected:\n    [(-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [(1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([K.ideal(1/2*a - 3/2)])\nExpected:\n    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),\n     (-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),\n     (1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    L.S_units([K.ideal(2)])\nExpected:\n    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),\n     (-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),\n     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),\n     (1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    u = K.units()[0][0]; u\nExpected:\n    -1/2*a + 1/2\nGot:\n    1/2*a + 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    u^2\nExpected:\n    -1/2*a - 1/2\nGot:\n    1/2*a - 1/2\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    L.units()\nExpected:\n    [(-1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\nGot:\n    [(1/2*a + 1/2, 6),\n     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),\n     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\nFailed example:\n    L.unit_group().gens_values()\nExpected:\n    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]\nGot:\n    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]\n**********************************************************************\n2 items had failures:\n   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\n   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units\n    [448 tests, 9 failures, 6.99 s]\n```\n",
    "created_at": "2017-09-17T18:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330832",
    "user": "@vbraun"
}
```

I'm getting this on various buildbots:

```
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u,o = K.S_units([])[0]; u, o
Expected:
    (-1/2*a + 1/2, 6)
Got:
    (1/2*a + 1/2, 6)
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([])
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(1/2*a - 3/2)])
Expected:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(2)])
Expected:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u = K.units()[0][0]; u
Expected:
    -1/2*a + 1/2
Got:
    1/2*a + 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.units()
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.unit_group().gens_values()
Expected:
    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
Got:
    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
**********************************************************************
2 items had failures:
   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
    [448 tests, 9 failures, 6.99 s]
```




---

archive/issue_comments_330833.json:
```json
{
    "body": "With the following change (which is probably a bad idea) I consistently get the same doctest failures as above:\n\n```diff\n--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py\n+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py\n@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):\n         return self(self.polynomial_ring().random_element( \\\n             degree=self.degree()-1, *args, **kwds))\n \n-    @cached_method\n     def _S_decomposition(self, S):\n         \"\"\"\n         Compute the decomposition of self into a product of number fields.\n```\n",
    "created_at": "2017-09-18T12:12:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330833",
    "user": "@pjbruin"
}
```

With the following change (which is probably a bad idea) I consistently get the same doctest failures as above:

```diff
--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py
+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py
@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):
         return self(self.polynomial_ring().random_element( \
             degree=self.degree()-1, *args, **kwds))
 
-    @cached_method
     def _S_decomposition(self, S):
         """
         Compute the decomposition of self into a product of number fields.
```




---

archive/issue_comments_330834.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-09-19T07:35:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330834",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330835.json:
```json
{
    "body": "The above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.",
    "created_at": "2017-09-19T07:36:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330835",
    "user": "@pjbruin"
}
```

The above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.



---

archive/issue_comments_330836.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-19T07:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330836",
    "user": "@pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_330837.json:
```json
{
    "body": "Replying to [comment:4 slabbe]:\n> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.\n\nI confirm that I get the same errors when run alone:\n\n\n```\n sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py\n```\n\n\nI am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:\n\n\n```\nRunning doctests with ID 2017-09-14-16-16-01-0e639740.\nGit branch: 23851\nUsing --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage\nDoctesting entire Sage library.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3587 files using 8 threads.\n...\nsage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py\n    [448 tests, 3.09 s]\n...\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 1623.2 seconds\n    cpu time: 10208.6 seconds\n    cumulative wall time: 12523.8 seconds\n```\n",
    "created_at": "2017-09-19T08:31:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330837",
    "user": "@seblabbe"
}
```

Replying to [comment:4 slabbe]:
> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.

I confirm that I get the same errors when run alone:


```
 sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py
```


I am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:


```
Running doctests with ID 2017-09-14-16-16-01-0e639740.
Git branch: 23851
Using --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3587 files using 8 threads.
...
sage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 3.09 s]
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1623.2 seconds
    cpu time: 10208.6 seconds
    cumulative wall time: 12523.8 seconds
```




---

archive/issue_comments_330838.json:
```json
{
    "body": "\n```\n+        First, we force garbage collection to make the `S`-unit\n+        computations below deterministic::\n```\n\n\nWhy? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?",
    "created_at": "2017-09-19T08:41:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330838",
    "user": "@seblabbe"
}
```


```
+        First, we force garbage collection to make the `S`-unit
+        computations below deterministic::
```


Why? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?



---

archive/issue_comments_330839.json:
```json
{
    "body": "I confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.",
    "created_at": "2017-09-19T08:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330839",
    "user": "@seblabbe"
}
```

I confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.



---

archive/issue_comments_330840.json:
```json
{
    "body": "What is apparently happening is that commit bf22de0 (see comment:2) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run\n\n```\nK = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])\n```\n\nseveral times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.\n\nCommit 55a59ff (see comment:7) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.",
    "created_at": "2017-09-19T09:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330840",
    "user": "@pjbruin"
}
```

What is apparently happening is that commit bf22de0 (see comment:2) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run

```
K = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])
```

several times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.

Commit 55a59ff (see comment:7) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.



---

archive/issue_comments_330841.json:
```json
{
    "body": "With the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:\n\n```\n----------------------------------------------------------------------\nsage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed\n----------------------------------------------------------------------\n```\n\n\nWhen running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:\n\n\n```\nDoctesting 1 file.\nsage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py\n    [448 tests, 1.81 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n\n\nBut the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?",
    "created_at": "2017-09-19T09:37:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330841",
    "user": "@seblabbe"
}
```

With the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:

```
----------------------------------------------------------------------
sage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed
----------------------------------------------------------------------
```


When running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:


```
Doctesting 1 file.
sage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 1.81 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


But the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?



---

archive/issue_comments_330842.json:
```json
{
    "body": "This seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)",
    "created_at": "2017-09-19T09:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330842",
    "user": "@pjbruin"
}
```

This seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)



---

archive/issue_comments_330843.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-09-19T09:49:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330843",
    "user": "@pjbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_330844.json:
```json
{
    "body": "These new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:\n- look at the norms\n- verify they and their inverses are S-integral (factorize the denominator)\n- hard-code an S-unit basis and check that these occur as a power product of the computed set.\nIt's a pain, but I don't think we really have another option.\n(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)\n\nAlso, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.",
    "created_at": "2017-09-19T11:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330844",
    "user": "@nbruin"
}
```

These new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:
- look at the norms
- verify they and their inverses are S-integral (factorize the denominator)
- hard-code an S-unit basis and check that these occur as a power product of the computed set.
It's a pain, but I don't think we really have another option.
(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)

Also, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.



---

archive/issue_comments_330845.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-09-20T09:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330845",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_330846.json:
```json
{
    "body": "The above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.",
    "created_at": "2017-09-20T09:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330846",
    "user": "@pjbruin"
}
```

The above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.



---

archive/issue_comments_330847.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-09-20T09:37:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330847",
    "user": "@pjbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_330848.json:
```json
{
    "body": "Do we really want to delete ``@`cached_method` on `absolute_field`?",
    "created_at": "2017-11-01T21:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330848",
    "user": "@roed314"
}
```

Do we really want to delete ``@`cached_method` on `absolute_field`?



---

archive/issue_comments_330849.json:
```json
{
    "body": "Replying to [comment:19 roed]:\n> Do we really want to delete ``@`cached_method` on `absolute_field`?\n\nOne argument for caching a method is when it takes long time to compute which is not the case here:\n\n\n```\nsage: %time nf = NumberField(x^2-5,'a')\nCPU times: user 1.12 ms, sys: 97 \u00b5s, total: 1.21 ms\nWall time: 962 \u00b5s\nsage: %time nf.absolute_field('b')\nCPU times: user 9 \u00b5s, sys: 1e+03 ns, total: 10 \u00b5s\nWall time: 13.8 \u00b5s\nNumber Field in b with defining polynomial x^2 - 5\n```\n\n\nIs there another reason why `absolute_field` should be cached?",
    "created_at": "2018-05-01T09:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330849",
    "user": "@seblabbe"
}
```

Replying to [comment:19 roed]:
> Do we really want to delete ``@`cached_method` on `absolute_field`?

One argument for caching a method is when it takes long time to compute which is not the case here:


```
sage: %time nf = NumberField(x^2-5,'a')
CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
Wall time: 962 µs
sage: %time nf.absolute_field('b')
CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
Wall time: 13.8 µs
Number Field in b with defining polynomial x^2 - 5
```


Is there another reason why `absolute_field` should be cached?



---

archive/issue_comments_330850.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-05-01T10:03:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330850",
    "user": "@seblabbe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_330851.json:
```json
{
    "body": "Replying to [comment:20 slabbe]:\n> Replying to [comment:19 roed]:\n> > Do we really want to delete ``@`cached_method` on `absolute_field`?\n> \n> One argument for caching a method is when it takes long time to compute which is not the case here:\n> \n> {{{\n> sage: %time nf = NumberField(x^2-5,'a')\n> CPU times: user 1.12 ms, sys: 97 \u00b5s, total: 1.21 ms\n> Wall time: 962 \u00b5s\n> sage: %time nf.absolute_field('b')\n> CPU times: user 9 \u00b5s, sys: 1e+03 ns, total: 10 \u00b5s\n> Wall time: 13.8 \u00b5s\n> Number Field in b with defining polynomial x^2 - 5\n> }}}\n\nYour timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.\n> \n> Is there another reason why `absolute_field` should be cached?",
    "created_at": "2018-05-04T06:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330851",
    "user": "@roed314"
}
```

Replying to [comment:20 slabbe]:
> Replying to [comment:19 roed]:
> > Do we really want to delete ``@`cached_method` on `absolute_field`?
> 
> One argument for caching a method is when it takes long time to compute which is not the case here:
> 
> {{{
> sage: %time nf = NumberField(x^2-5,'a')
> CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
> Wall time: 962 µs
> sage: %time nf.absolute_field('b')
> CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
> Wall time: 13.8 µs
> Number Field in b with defining polynomial x^2 - 5
> }}}

Your timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.
> 
> Is there another reason why `absolute_field` should be cached?



---

archive/issue_comments_330852.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2018-05-05T22:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330852",
    "user": "@vbraun"
}
```

Merge conflict



---

archive/issue_comments_330853.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-05-05T22:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330853",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_330854.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-05-15T12:01:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330854",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_330855.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-05-15T12:02:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330855",
    "user": "@pjbruin"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_330856.json:
```json
{
    "body": "I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with ``@`cached_method`?",
    "created_at": "2018-05-15T12:07:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330856",
    "user": "@jdemeyer"
}
```

I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with ``@`cached_method`?



---

archive/issue_comments_330857.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-05-15T12:07:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330857",
    "user": "@jdemeyer"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_330858.json:
```json
{
    "body": "Does anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.",
    "created_at": "2018-05-15T12:57:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330858",
    "user": "@jdemeyer"
}
```

Does anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.



---

archive/issue_comments_330859.json:
```json
{
    "body": "Replying to [comment:27 jdemeyer]:\n> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with ``@`cached_method`?\nThe leak is caused by the combination of ``@`cached_method` and `UniqueFactory`; see Nils's explanation in comment:14:ticket:23807 and the surrounding discussion, where this bug was found.",
    "created_at": "2018-05-15T13:30:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330859",
    "user": "@pjbruin"
}
```

Replying to [comment:27 jdemeyer]:
> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with ``@`cached_method`?
The leak is caused by the combination of ``@`cached_method` and `UniqueFactory`; see Nils's explanation in comment:14:ticket:23807 and the surrounding discussion, where this bug was found.



---

archive/issue_comments_330860.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2018-05-15T13:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330860",
    "user": "@jdemeyer"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_330861.json:
```json
{
    "body": "Thanks for the pointer! It all makes sense to me now.",
    "created_at": "2018-05-15T13:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330861",
    "user": "@jdemeyer"
}
```

Thanks for the pointer! It all makes sense to me now.



---

archive/issue_comments_330862.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-05-18T17:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23614",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23614#issuecomment-330862",
    "user": "@vbraun"
}
```

Resolution: fixed
