# Issue 23614: Fix memoryleak introduced in #11670

Issue created by migration from https://trac.sagemath.org/ticket/23851

Original creator: nbruin

Original creation time: 2017-09-13 22:03:18




---

Comment by nbruin created at 2017-09-13 22:09:36

Changing status from new to needs_review.


---

Comment by nbruin created at 2017-09-13 22:09:36

Changing component from PLEASE CHANGE to memleak.


---

Comment by nbruin created at 2017-09-13 22:09:36

New commits:


---

Comment by nbruin created at 2017-09-13 22:09:36

Changing type from PLEASE CHANGE to defect.


---

Comment by pbruin created at 2017-09-14 06:54:52

Cleaned up the docstrings of `absolute_field()` a bit.


---

Comment by slabbe created at 2017-09-14 14:48:59

I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.


---

Comment by slabbe created at 2017-09-14 14:48:59

Changing keywords from "" to "thursdaysbdx".


---

Comment by slabbe created at 2017-09-14 14:48:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-17 18:12:19

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-09-17 18:12:19

I'm getting this on various buildbots:

```
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1389, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u,o = K.S_units([])[0]; u, o
Expected:
    (-1/2*a + 1/2, 6)
Got:
    (1/2*a + 1/2, 6)
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1395, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1404, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([])
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1408, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(1/2*a - 3/2)])
Expected:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((-1/6*a - 1/2)*b^2 + (1/3*a - 1)*b + 4/3*a, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1413, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    L.S_units([K.ideal(2)])
Expected:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [((1/2*a - 1/2)*b^2 + (a + 1)*b + 3, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a + 1/2, +Infinity),
     ((1/6*a + 1/2)*b^2 + (-1/3*a + 1)*b - 5/6*a - 1/2, +Infinity),
     (1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1476, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u = K.units()[0][0]; u
Expected:
    -1/2*a + 1/2
Got:
    1/2*a + 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1482, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    u^2
Expected:
    -1/2*a - 1/2
Got:
    1/2*a - 1/2
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1494, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.units()
Expected:
    [(-1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
Got:
    [(1/2*a + 1/2, 6),
     ((-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, +Infinity),
     (2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2, +Infinity)]
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1503, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
Failed example:
    L.unit_group().gens_values()
Expected:
    [1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
Got:
    [-1/2*a + 1/2, (-1/3*a - 1)*b^2 - 4/3*a*b - 5/6*a + 7/2, 2/3*a*b^2 + (2/3*a - 2)*b - 5/6*a - 7/2]
**********************************************************************
2 items had failures:
   5 of  18 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
   4 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.units
    [448 tests, 9 failures, 6.99 s]
```



---

Comment by pbruin created at 2017-09-18 12:12:15

With the following change (which is probably a bad idea) I consistently get the same doctest failures as above:

```diff
--- a/src/sage/rings/polynomial/polynomial_quotient_ring.py
+++ b/src/sage/rings/polynomial/polynomial_quotient_ring.py
@@ -1050,7 +1050,6 @@ class PolynomialQuotientRing_generic(CommutativeRing):
         return self(self.polynomial_ring().random_element( \
             degree=self.degree()-1, *args, **kwds))
 
-    @cached_method
     def _S_decomposition(self, S):
         """
         Compute the decomposition of self into a product of number fields.
```



---

Comment by git created at 2017-09-19 07:35:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2017-09-19 07:36:36

The above commit appears to make the computation deterministic again.  Let's see if the patchbot agrees.


---

Comment by pbruin created at 2017-09-19 07:36:42

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2017-09-19 08:31:31

Replying to [comment:4 slabbe]:
> I do not know what is happening with the patchbot. The bug is fixed and I get `All tests passed` after running `make ptestlong` on my machine.

I confirm that I get the same errors when run alone:


```
 sage -t src/sage/rings/polynomial/polynomial_quotient_ring.py
```


I am sorry, I do not know what happened with my run of `make ptestlong` which said `All tests passed`. I rechecked the log file of ptestlong.log, and I confirm that I got `All tests passed`:


```
Running doctests with ID 2017-09-14-16-16-01-0e639740.
Git branch: 23851
Using --optional=ccache,cmake,cryptominisat,mpir,pandoc_attributes,pandocfilters,python2,rst2ipynb,sage
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3587 files using 8 threads.
...
sage -t --long --warn-long 58.9 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 3.09 s]
...
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1623.2 seconds
    cpu time: 10208.6 seconds
    cumulative wall time: 12523.8 seconds
```



---

Comment by slabbe created at 2017-09-19 08:41:48


```
+        First, we force garbage collection to make the `S`-unit
+        computations below deterministic::
```


Why? Can you add a sentence in this paragraph saying why the computatino of `S`-unit depends on the existence of objects that were not yet collected by the garbage collector?


---

Comment by slabbe created at 2017-09-19 08:44:19

I confirm that the last commit fixes the sage -t of `polynomial_quotient_ring.py` when run alone.


---

Comment by pbruin created at 2017-09-19 09:03:55

What is apparently happening is that commit bf22de0 (see comment:2) causes the quadratic field of discriminant -3 to be garbage-collected more often.  This is in principle a good thing, but every time the field is constructed again, the computed generator of the unit group may be different than the previous time.  This also happens if you run

```
K = nfinit(y^2 + 3); nfbasistoalg(K, nfrootsof1(K)[2])
```

several times in GP; the result varies randomly between `1/2*y + 1/2` and `-1/2*y + 1/2`, the two roots of unity of order 6.

Commit 55a59ff (see comment:7) reduces the randomness in the number of times that `K` is constructed.  Experimentally it seems to work; I ran doctests in `polynomial_quotient_ring.py` 128 times with this commit applied and got no failures.  However, I now realise that it may not be entirely watertight and that we should check if there are other points at which `K` may be randomly garbage-collected.  Alternatively, we could construct `K` once at the beginning of the file, keeping it alive by binding it to a name that is not used anywhere else in the file.


---

Comment by slabbe created at 2017-09-19 09:37:47

With the recent commit, when running `make ptestlong` or when running `sage -t --long` alone on the file, I get problems:

```
----------------------------------------------------------------------
sage -t --long --warn-long 58.5 src/sage/rings/polynomial/polynomial_quotient_ring.py  # 9 doctests failed
----------------------------------------------------------------------
```


When running `sage -t` alone on the file without the option `--long` , I get `All tests passed`:


```
Doctesting 1 file.
sage -t --warn-long 32.7 src/sage/rings/polynomial/polynomial_quotient_ring.py
    [448 tests, 1.81 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


But the failing tests are not marked with `long time` ... ??? Why are they not failing in the second case?


---

Comment by pbruin created at 2017-09-19 09:49:44

This seems to indicate that those tests are still non-deterministic.  We should either make them deterministic again or mark them with `# random` (but then it is harder to notice in case the output actually becomes wrong at some point.)


---

Comment by pbruin created at 2017-09-19 09:49:44

Changing status from needs_review to needs_work.


---

Comment by nbruin created at 2017-09-19 11:20:21

These new changes are just showing that the doctests were fragile to begin with. There's a bunch of things you can do to check the result is correct:
 - look at the norms
 - verify they and their inverses are S-integral (factorize the denominator)
 - hard-code an S-unit basis and check that these occur as a power product of the computed set.
It's a pain, but I don't think we really have another option.
(I guess the answers only differ in some sign choices, so you could just construct the set of all sign choices and check your answer lies in there. That would be a reasonably strict test and will probably take a little longer before it breaks again)

Also, if you want to prevent the field from being garbage collected, just bind it explicitly to an identifier. That's how users should prevent garbage collections too. That doesn't help the non-deterministic doctests, though it may hide the problem for a while.


---

Comment by git created at 2017-09-20 09:35:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by pbruin created at 2017-09-20 09:37:31

The above commit is a more robust alternative to the `gc.collect()` solution; we now just avoid distinguishing between the two generators for the unit group of `QuadraticField(-3)`.


---

Comment by pbruin created at 2017-09-20 09:37:31

Changing status from needs_work to needs_review.


---

Comment by roed created at 2017-11-01 21:24:00

Do we really want to delete ``@`cached_method` on `absolute_field`?


---

Comment by slabbe created at 2018-05-01 09:56:20

Replying to [comment:19 roed]:
> Do we really want to delete ``@`cached_method` on `absolute_field`?

One argument for caching a method is when it takes long time to compute which is not the case here:


```
sage: %time nf = NumberField(x^2-5,'a')
CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
Wall time: 962 µs
sage: %time nf.absolute_field('b')
CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
Wall time: 13.8 µs
Number Field in b with defining polynomial x^2 - 5
```


Is there another reason why `absolute_field` should be cached?


---

Comment by slabbe created at 2018-05-01 10:03:21

Changing status from needs_review to positive_review.


---

Comment by roed created at 2018-05-04 06:00:00

Replying to [comment:20 slabbe]:
> Replying to [comment:19 roed]:
> > Do we really want to delete ``@`cached_method` on `absolute_field`?
> 
> One argument for caching a method is when it takes long time to compute which is not the case here:
> 
> {{{
> sage: %time nf = NumberField(x^2-5,'a')
> CPU times: user 1.12 ms, sys: 97 µs, total: 1.21 ms
> Wall time: 962 µs
> sage: %time nf.absolute_field('b')
> CPU times: user 9 µs, sys: 1e+03 ns, total: 10 µs
> Wall time: 13.8 µs
> Number Field in b with defining polynomial x^2 - 5
> }}}

Your timings, on a quadratic field which is already absolute, aren't particularly convincing that this method is always fast.  However, running some other tests on higher degree relative extensions shows that they're quite fast as well.  I'll withdraw my objection to removing the `cached_method`.
> 
> Is there another reason why `absolute_field` should be cached?


---

Comment by vbraun created at 2018-05-05 22:38:07

Merge conflict


---

Comment by vbraun created at 2018-05-05 22:38:07

Changing status from positive_review to needs_work.


---

Comment by git created at 2018-05-15 12:01:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2018-05-15 12:02:13

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2018-05-15 12:07:15

I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with ``@`cached_method`?


---

Comment by jdemeyer created at 2018-05-15 12:07:46

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2018-05-15 12:57:10

Does anybody have an idea? If not, please say so. I'm just asking to know whether it's worth my time to investigate it.


---

Comment by pbruin created at 2018-05-15 13:30:49

Replying to [comment:27 jdemeyer]:
> I don't really understand the memory leak. If the original code leaks, isn't that a deeper problem with ``@`cached_method`?
The leak is caused by the combination of ``@`cached_method` and `UniqueFactory`; see Nils's explanation in comment:14:ticket:23807 and the surrounding discussion, where this bug was found.


---

Comment by jdemeyer created at 2018-05-15 13:37:58

Changing status from needs_info to positive_review.


---

Comment by jdemeyer created at 2018-05-15 13:37:58

Thanks for the pointer! It all makes sense to me now.


---

Comment by vbraun created at 2018-05-18 17:04:22

Resolution: fixed
