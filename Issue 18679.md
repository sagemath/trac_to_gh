# Issue 18679: Use Kedlaya algorithm to count points on hyperelliptic curves

Issue created by migration from Trac.

Original creator: jpflori

Original creation time: 2015-07-17 11:54:00

CC:  defeo katestange

There is an implementation in `monsky_washnitzer.py`.

Let's use it.


---

Comment by jpflori created at 2015-07-17 14:04:51

The magic line reads something like:

```
monsky_washnitzer.matrix_of_frobenius_hyperelliptic(self.hyperelliptic_polynomials()[0], p, prec)[0]
```


The defining polynomial needs to be monicified which is also required by hypellfrob, so it makes sense to refactor the code a little bit.
And it only works for prime fields.

There is also a PARI/GP implem without these restriction (only p != 2 I'd say)


---

Comment by jdemeyer created at 2015-07-17 14:58:50

+1 to use PARI/GP


---

Comment by kedlaya created at 2016-03-21 16:59:39

Changing keywords from "" to "hyperelliptic curves, matrix of Frobenius".


---

Comment by kedlaya created at 2016-03-21 16:59:39

From a quick inspection of the PARI/GP implementation:

The command hyperellpadicfrobenius appears to only work for prime fields. There is an internal command nfhyperellpadicfrobenius which seems to handle nonprime fields, which is called by hyperellcharpoly to get the characteristic polynomial of Frobenius; but it does not appear to be exposed.

Also, the Frobenius matrix commands have a similar restriction on p as in Harvey's code. The charpoly command seems to be doing a naive point count for smaller p.

In any case, it would be worth updating HyperellipticCurve.frobenius_polynomial and related methods to include calls to PARI as appropriate.


---

Comment by kedlaya created at 2016-03-21 17:41:12

Addendum: naive point counting is already implemented directly in Sage, see #11980.


---

Comment by jpflori created at 2016-03-21 18:06:18

To make things clear, I'm looking at PARI git version, though the version in Sage is quite recent and should be similar as far as `hyperell.c` is concerned.

Replying to [comment:3 kedlaya]:
> From a quick inspection of the PARI/GP implementation:
> 
> The command hyperellpadicfrobenius appears to only work for prime fields. There is an internal command nfhyperellpadicfrobenius which seems to handle nonprime fields, which is called by hyperellcharpoly to get the characteristic polynomial of Frobenius; but it does not appear to be exposed.
I confirm that `hyperellpadicfrobenius` only works for prime fields whereas the `nf...` one handles extensions.
Though both of them are not marked `static` and use `gerepile` magic to leave a clean stack so I guess they are possible and safe to use from outside the PARI library.

> 
> Also, the Frobenius matrix commands have a similar restriction on p as in Harvey's code. The charpoly command seems to be doing a naive point count for smaller p.
Do you mean those in the PARI library?
I don't see at first glance such restriction.
There is some naive point counting involved in `hyperellcharpoly` but that is when the curve is of (very) low genus and the characteristic is small.
Did I miss something else?

For `p == 2` it indeed seems it only works for `F_2` using naive point counting.
> 
> In any case, it would be worth updating HyperellipticCurve.frobenius_polynomial and related methods to include calls to PARI as appropriate.


---

Comment by kedlaya created at 2016-03-22 17:00:39

Replying to [comment:5 jpflori]:
> I confirm that `hyperellpadicfrobenius` only works for prime fields whereas the `nf...` one handles extensions.
> Though both of them are not marked `static` and use `gerepile` magic to leave a clean stack so I guess they are possible and safe to use from outside the PARI library.
> 
Bill Allombert confirmed this. The `nf...` command is not (currently) available in GP, but we can call it from the library.

> > 
> > Also, the Frobenius matrix commands have a similar restriction on p as in Harvey's code. The charpoly command seems to be doing a naive point count for smaller p.
> Do you mean those in the PARI library?
> I don't see at first glance such restriction.
> There is some naive point counting involved in `hyperellcharpoly` but that is when the curve is of (very) low genus and the characteristic is small.
> Did I miss something else?
> 
Oh, maybe that is just an optimization for cases where naive point counting is actually faster?


---

Comment by jpflori created at 2016-03-22 17:05:01

Replying to [comment:6 kedlaya]:
> > Did I miss something else?
> > 
> Oh, maybe that is just an optimization for cases where naive point counting is actually faster?
I guess so, it just looks like hand optimized random values.


---

Comment by kedlaya created at 2016-03-23 12:01:35

I think I need some assistance with the PARI library interface here.

I mentioned above that `nfhyperellpadicfrobenius` is not currently exposed. However, this function does appear in `src/sage/libs/pari/paridecl.pxd`. Does something else need to be done in order to make it visible as a method of a PARI object?


---

Comment by jpflori created at 2016-03-23 12:18:23

Replying to [comment:8 kedlaya]:
> I think I need some assistance with the PARI library interface here.
> 
> I mentioned above that `nfhyperellpadicfrobenius` is not currently exposed. However, this function does appear in `src/sage/libs/pari/paridecl.pxd`. Does something else need to be done in order to make it visible as a method of a PARI object?
The methods of PARI objecgt are in `gen.pxd/pyx`.
You should add a method there calling the C function.
Then in the hyperelliptic curve class, something like

```
pari(H.polynomial()).frobenius()
```

could be called.

Maybe a better option is to add a method directly in Sage's hyperelliptic curve over finite field class.

I'll have some free time in a few hours, I can have a look as well.


---

Comment by jdemeyer created at 2016-03-23 13:00:40

If you do make any changes to the PARI interface, please base them on #20219.


---

Comment by git created at 2016-03-24 16:22:32

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by kedlaya created at 2016-03-24 20:16:19

Replying to [comment:9 jpflori]:
> > I mentioned above that `nfhyperellpadicfrobenius` is not currently exposed. However, this function does appear in `src/sage/libs/pari/paridecl.pxd`. Does something else need to be done in order to make it visible as a method of a PARI object?
> The methods of PARI objecgt are in `gen.pxd/pyx`.
> You should add a method there calling the C function.

Maybe I wasn't clear here. I think there is some mechanism by which most PARI functions appear "automatically" as methods of a PARI object; most of them are not explicitly declared in `src/sage/libs/pari/gen.pyx`. I was wondering why `hyperellpadicfrobenius` (which does not have its own explicitly defined wrapper as far as I can find) shows up this way while `nfhyperellpadicfrobenius` does not. I had thought `paridecl.pxd` was the master source for the autogenerated methods, but it includes both of these functions and yet only one makes it through the rest of the process.


---

Comment by jpflori created at 2016-03-24 20:38:24

Replying to [comment:14 kedlaya]:
> Replying to [comment:9 jpflori]:
> > > I mentioned above that `nfhyperellpadicfrobenius` is not currently exposed. However, this function does appear in `src/sage/libs/pari/paridecl.pxd`. Does something else need to be done in order to make it visible as a method of a PARI object?
> > The methods of PARI objecgt are in `gen.pxd/pyx`.
> > You should add a method there calling the C function.
> 
> Maybe I wasn't clear here. I think there is some mechanism by which most PARI functions appear "automatically" as methods of a PARI object; most of them are not explicitly declared in `src/sage/libs/pari/gen.pyx`. I was wondering why `hyperellpadicfrobenius` (which does not have its own explicitly defined wrapper as far as I can find) shows up this way while `nfhyperellpadicfrobenius` does not. I had thought `paridecl.pxd` was the master source for the autogenerated methods, but it includes both of these functions and yet only one makes it through the rest of the process.
Oh I see.
I'd say it's exactly because the `nf...` function is not in GP.
IIRC functions in GP are described in `pari.desc` which is also used for autogenerating our wrappers.
This puts Cython methods in the `gen_auto` class in some `pxi` auto generated files.

The `paridecl.pxd` file is still handwritten/copied from the PARI library headers and is not involved during the generation of the wrappers (though it is needed to help Cython at compilation time I'd say).
Part of it could surely be auto-generated from `pari.desc` (or even all of it from the C headers though that would be more involved).

Therefore in the end we have Cython access to the `nf...` but no method wrapping it.

See #17631 and #17860 and https://github.com/sagemath/sage/blob/master/src/sage_setup/autogen/pari/generator.py

Jeroen, please correct me if I'm wrong.


---

Comment by kedlaya created at 2016-03-26 14:18:47

Bill Allombert is wondering what use case(s) we have in mind for the Frobenius matrix (rather than just its characteristic polynomial). Keep in mind that they don't (currently) provide Coleman integration, which rules out the Coleman-Gross height pairing. But I think the p-adic sigma function on an elliptic curve does constitute an example where the Frobenius matrix is strictly more useful than its charpoly.


---

Comment by kedlaya created at 2016-03-27 20:31:09

Sorry, I seem to have dragged this ticket somewhat off topic. I created the new ticket #20309 to discuss Frobenius matrices.

The original topic of this ticket was point counting (and by extension zeta functions), and for that by far the easiest solution would be to use PARI's `hyperellcharpoly`. Better would be to intelligently combine this with Harvey's code for Frobenius matrices when it applies (it's very fast but not as general), but maybe that can be a separate ticket later.


---

Comment by kedlaya created at 2016-04-05 04:08:30

I'm having trouble getting the PARI code to work in characteristic 2, but even in odd characteristic there seem to be some issues:

```
pari: T = ffinit(3, 2);
pari: y = ffgen(T, 'y);
pari: hyperellcharpoly(x^3 + y*x)
***   at top-level: hyperellcharpoly(x^3
  ***                 ^--------------------
  *** hyperellcharpoly: bug in PARI/GP (Segmentation Fault), please report.
```

Off to go report this upstream...


---

Comment by jpflori created at 2016-04-05 06:56:54

IIRC PARI supposes that the equation is `y² = f(x)` and the function eats `f(x)`, in particular in char 2 this is a singular curve and so says PARI.


---

Comment by kedlaya created at 2016-04-05 13:30:47

Replying to [comment:18 kedlaya]:
> I'm having trouble getting the PARI code to work in characteristic 2, but even in odd characteristic there seem to be some issues:
> {{{
> pari: T = ffinit(3, 2);
> pari: y = ffgen(T, 'y);
> pari: hyperellcharpoly(x^3 + y*x)
> ***   at top-level: hyperellcharpoly(x^3
>   ***                 ^--------------------
>   *** hyperellcharpoly: bug in PARI/GP (Segmentation Fault), please report.
> }}}
> Off to go report this upstream...

Bill Allombert reports that this particular issue (the one not in characteristic 2) is fixed upstream:

```
commit 31253df93771c72e44c19c245dcf514822a3bdb4
Author: Bill Allombert <Bill.Allombert`@`math.u-bordeaux1.fr>
Date:   Fri Mar 11 12:38:30 2016 +0100

    hyperellcharpoly: fix typo in ZXX_to_FpXC
```



---

Comment by git created at 2016-04-05 16:13:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-04-05 16:18:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-04-05 16:20:49

The previous commits call to PARI in all cases where the characteristic is odd and David Harvey's code is not applicable (either the field is not prime, or the characteristic is too small, or h != 0, or f is of even degree). The naive code is still used in characteristic 2.

There is one failing doctest due to the PARI issue described above. Presumably this will be fixed once we pull from upstream.


---

Comment by git created at 2016-04-08 23:49:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-04-08 23:50:23

The last commit addresses #20391.


---

Comment by git created at 2016-04-09 15:04:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-04-09 15:10:34

... and a doctest to indicate that #20391 is addressed.


---

Comment by jpflori created at 2016-05-09 09:04:42

`@`Kiran: is it in state of review or do you plan further changes?


---

Comment by kedlaya created at 2016-05-09 22:12:53

Replying to [comment:28 jpflori]:
> `@`Kiran: is it in state of review or do you plan further changes?

Even after rebasing to 7.2.rc1, there is still one failing doctest:

```
File "src/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 1348, in sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.zeta_funct
ion
Failed example:
    H.zeta_function()
Exception raised:
    Traceback (most recent call last):
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.hyperelliptic_curves.hyperelliptic_finite_field.HyperellipticCurve_finite_field.zeta_function[8]>", line 1, in <module>
        H.zeta_function()
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 1364, in zeta_function
        P = self.frobenius_polynomial()
      File "sage/misc/cachefunc.pyx", line 2235, in sage.misc.cachefunc.CachedMethodCallerNoArgs.__call__ (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/misc/cac
hefunc.c:12462)
        self.cache = f(self._instance)
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 551, in frobenius_polyno
mial
        return self.frobenius_polynomial_pari()
      File "/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/local/lib/python2.7/site-packages/sage/schemes/hyperelliptic_curves/hyperelliptic_finite_field.py", line 473, in frobenius_polyno
mial_pari
        return ZZ['x'](pari([f, h]).hyperellcharpoly())
      File "sage/libs/pari/auto_gen.pxi", line 8650, in sage.libs.pari.gen.gen_auto.hyperellcharpoly (/projects/b8cc019c-1204-44b1-bea9-eb81c119388e/sage/src/build/cythonized/sage/libs/pari/gen
.c:47546)
        sig_on()
      File "src/cysignals/signals.pyx", line 108, in cysignals.signals.sig_raise_exception (build/src/cysignals/signals.c:1448)
    SignalError: Segmentation fault
```

As noted above, this is due to a bug in PARI which has been fixed upstream. To resolve this, we need to pull from upstream, which is probably worth a separate ticket.


---

Comment by jpflori created at 2016-05-09 22:45:53

Created #20581 for the PARI/GP upgrade.


---

Comment by slelievre created at 2016-07-27 14:40:31

Now that #20581 is in, is this good to go? Or does it need the new Pari update at #21005?


---

Comment by kedlaya created at 2016-07-27 14:51:42

Changing status from new to needs_review.


---

Comment by kedlaya created at 2016-07-27 14:51:42

Replying to [comment:33 slelievre]:
> Now that #20581 is in, is this good to go? Or does it need the new Pari update at #21005?

It should be good to go with just #20581, but I haven't yet had a chance to recompile to see if the broken doctest is now fixed. But let's go ahead and make that part of the review...


---

Comment by chapoton created at 2016-07-28 16:40:28

missing blank line after

```
Over prime fields of odd characteristic, `f` may have even degree::
```


missing blank line after

```
This example shows that ticket #20391 is resolved:
```

which also should instead be

```
This example shows that :trac:`20391` is resolved::
```



---

Comment by jpflori created at 2016-08-09 09:32:17

`@`Frédéric: Do you plan on pushing your changes as a reviewer's action?


---

Comment by chapoton created at 2016-08-09 11:39:59

not today, so please go on


---

Comment by git created at 2016-08-09 12:43:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-08-10 05:50:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-08-10 05:55:47

I fixed the formatting issues that were reported. Separately, I updated to the current (post-7.3) develop, which includes a PARI update, and can confirm that the broken doctest is now fixed.

I would set this back to needs_review except that it was never unset...


---

Comment by chapoton created at 2016-08-10 07:11:59

Here is a public branch with just a small commit on top of your branch,

with just some enhanced details in code and doc formatting.

This is not a full review, sorry.
----
New commits:


---

Comment by jpflori created at 2016-08-10 07:53:10

The changes look good to me.


---

Comment by jpflori created at 2016-08-10 07:53:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-13 09:24:30

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-08-13 09:24:30


```
[sagelib-7.4.beta0] [  8/311] gcc -fno-strict-aliasing -I/Users/buildslave-sage/slave/sage_git/build/local/var/tmp/sage/build/python2-2.7.10.p2/include -DNDEBUG -g -fwrapv -O3 -Wall -Wno-unused -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/cysignals -I/Users/buildslave-sage/slave/sage_git/build/local/include -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -I/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/numpy/core/include -I/Users/buildslave-sage/slave/sage_git/build/src -I/Users/buildslave-sage/slave/sage_git/build/src/sage/ext -I/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized -I/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/ext -I/Users/buildslave-sage/slave/sage_git/build/local/include/python2.7 -c /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.c -o build/temp.macosx-10.9-x86_64-2.7/Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/handle_error.o -fno-strict-aliasing
[sagelib-7.4.beta0] In file included from /Users/buildslave-sage/slave/sage_git/build/local/include/c++/4.9.3/backward/strstream:51:0,
[sagelib-7.4.beta0]                  from /Users/buildslave-sage/slave/sage_git/build/local/include/libLfunction/L.h:34,
[sagelib-7.4.beta0]                  from /Users/buildslave-sage/slave/sage_git/build/src/sage/libs/lcalc/lcalc_sage.h:1,
[sagelib-7.4.beta0]                  from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/lcalc/lcalc_Lfunction.cpp:338:
[sagelib-7.4.beta0] /Users/buildslave-sage/slave/sage_git/build/local/include/c++/4.9.3/backward/backward_warning.h:32:2: warning: #warning This file includes at least one deprecated or antiquated header which may be removed without further notice at a future date. Please use a non-deprecated interface with equivalent functionality instead. For a listing of replacement headers and interfaces, consult the file backward_warning.h. To disable this warning use -Wno-deprecated. [-Wcpp]
[sagelib-7.4.beta0]  #warning \
[sagelib-7.4.beta0]   ^
[sagelib-7.4.beta0] In file included from /Users/buildslave-sage/slave/sage_git/build/src/build/cythonized/sage/libs/pari/gen.c:341:0:
[sagelib-7.4.beta0] /Users/buildslave-sage/slave/sage_git/build/local/include/pari/paripriv.h:16:48: error: unknown type name 'ulong'
```

on 32-bit


---

Comment by git created at 2016-08-14 16:07:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kedlaya created at 2016-08-14 16:10:08

Changing status from needs_work to needs_review.


---

Comment by kedlaya created at 2016-08-14 16:10:08

Between pulling from the PARI-related tickets and updating develop, a couple of unwanted changes to the PARI headers seem to have crept in, causing the build warning. I just removed these; here we go again.


---

Comment by jpflori created at 2016-08-16 12:30:10

I can confirm it now builds on my setup with 7.4.beta0.


---

Comment by jpflori created at 2016-08-16 12:30:10

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-08-19 22:45:17

Resolution: fixed
