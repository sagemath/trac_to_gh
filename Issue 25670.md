# Issue 25670: Better handling of memory limits on tests

Issue created by migration from https://trac.sagemath.org/ticket/25907

Original creator: embray

Original creation time: 2018-07-23 15:38:39

Open to different ideas about this, but here's a proposal for better handling of tests that have the possibility of eating up all memory (such as the test toward the beginning of `matrix_mod2_dense.pyx`:


```
            sage: import resource
            sage: if resource.RLIMIT_AS == getattr(resource, 'RLIMIT_RSS', None):
            ....:     # Skip this test if RLIMIT_AS is not properly
            ....:     # supported like on OS X, see Trac #24190
            ....:     raise RuntimeError("matrix allocation failed")
            ....: else:  # Real test
            ....:     MatrixSpace(GF(2), 2^30)(1)
            Traceback (most recent call last):
            ...
            RuntimeError: matrix allocation failed
```


This fixes #25884, and also maintains the fix for OSX, since now by default this test will not run on those platforms unless the user explicitly passes `--memlimit=0` for no memory limit on tests.


---

Comment by embray created at 2018-07-23 15:38:45

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-07-23 16:07:06

Can't you handle `high mem` through the usual `optional` tag mechanism?


---

Comment by embray created at 2018-07-23 16:09:51

That's what it's already doing, but it works like `--long` in that there's also a command-line flag for it.  The difference is that it's spelled `--memlimit=0`, and the same `--memlimit` option can also be used to set a higher or lower (but non-zero) memory limit.


---

Comment by jdemeyer created at 2018-07-23 16:11:36

Actually, I find the name `high mem` a bit misleading: this is a test specifically designed to allocate a large amount of memory *and fail doing that*. So it has a very specific meaning and I'm not convinced that we need support in the doctest framework for that.

Why not just fix the doctest that is breaking?


---

Comment by embray created at 2018-07-23 16:24:49

I think there are other cases where this might be useful (if not currently, in the past and in the future).  For example a comment in the runtests script says of the old 3300 MB memory limit:

> It is in particular doctests in src/sage/schemes/elliptic_curves/heegner.py which need this much memory.

Except I didn't notice any high memory usage in that module once I tested this.  Perhaps there was a memory leak that was fixed or something else.

"Just" fix the test is not that great either, because the "fix" is a convoluted workaround with the express purpose of effectively _skipping_ that test, duplicating logic that is already needed in sage-runtests to check if it actually makes sense to set a memory limit on some platform or other.  This moves all the platform-specific stuff to one place, and sets a flag as to whether or not the test can be safely run.

So I do believe it's a useful addition.  I'm open to different nomenclature.


---

Comment by jdemeyer created at 2018-07-26 09:48:01

Replying to [comment:5 embray]:
> "Just" fix the test is not that great either, because the "fix" is a convoluted workaround

Isn't it just a matter of checking whether a memory limit was set? You could add a small helper function somewhere for that.

Adding new doctest infrastructure to fix a single broken doctest looks like way overkill to me.


---

Comment by embray created at 2018-07-26 11:08:14

What do you mean?  The fact that a memory limit is set at all is something that the doctest runner does (albeit without any customizability or knowledge of the the user).  Therefore "checking whether a memory limit was set" is a question that must be interrogated of the doctest framework (just as `# long time` is used to mark tests that take long to run, it also makes sense to mark tests that might run out of memory).

This isn't adding any "infrastructure".  It's just adding an option within the existing infrastructure.  It's not just one test either--this could easily come up elsewhere and probably does from time to time.  I don't see what your problem is.


---

Comment by jdemeyer created at 2018-07-26 12:04:43

Replying to [comment:7 embray]:
> I don't see what your problem is.

Maybe my problem is that you should make it very clear what the semantics of `high mem` are (and change the name to something that more accurately reflects the semantics, like `# optional - memlimit`). You are giving too much the incorrect impression that `# high mem` is analogous to `# long time`, but for memory instead of running time.

When you write "tests that might run out of memory" in [comment:7], I have the impression that even you don't understand it (and I really don't mean to offend!). It's a test which is specifically written to allocate more memory than available.


---

Comment by embray created at 2018-07-26 12:11:49

Okay, that's a very different "problem" than "this adds 'infrastructure' just to fix one test".  

I do understand the test clearly, and problem is that on Cygwin it's simply not possible to set a virtual memory limit at all (at least not with `setrlimit`) and on OSX `RLIMIT_AS` is set equivalent to `RLIMIT_RSS`, so while the test may pass, it will gobble up physical memory needlessly :(  Therefore it's better that the test be skipped.

I'd be happy with `# optional - memlimit` though it's not clear to me how that's much different.  I get confused about what `# optional` is supposed to be used for, since it usually (but not always?) seems to pertain to optional packages...


---

Comment by embray created at 2018-07-26 12:34:12

I see now that there's also `# optional - internet`.  So in retrospect I do like the spelling `# optional - memlimit` implying that the `memlimit` option has been set to something > 0.


---

Comment by git created at 2018-07-26 13:05:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-26 13:06:47

Perhaps something more like this then?  Tests marked `# optional - memlimit` will only run if setting `RLIMIT_AS` actually worked, or if `--optional=memlimit` was given explicitly (this allows forcing the test to run).


---

Comment by jdemeyer created at 2018-07-27 09:43:56

1. There are still some traces of `high mem` in the branch.

2. I consider the `--memlimit` option quite specialized, so I would drop the short `-m` option for it.

3. Maybe `if memlimit > 0 and memlimit <= sys.maxsize` -> `if 0 < memlimit <= sys.maxsize`

4. Can you add a doctest test for this? See `src/sage/doctest/test.py`


---

Comment by jdemeyer created at 2018-07-27 09:43:56

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-07-27 09:46:06

Apart from these comments LGTM!


---

Comment by embray created at 2018-07-27 12:04:20

Ok; agreed with all of the above.


---

Comment by embray created at 2018-07-27 12:18:49

I'm not _exactly_ sure how best to test this, given that the result of using the memlimit flag depends largely on the platform, and there's no obvious way around that without writing a largely tautological test.


---

Comment by jdemeyer created at 2018-07-27 14:17:45

I have an idea for a test. I'll push a commit.


---

Comment by jdemeyer created at 2018-07-27 19:47:19

New commits:


---

Comment by embray created at 2018-07-30 16:54:47

Originally the way I was going to test this was not even going to be to test the rlimit itself, but just test the behavior with regard to skipping the tests are not, as well as what setting `--memlimit=0` does.

This could all be added as well of course.  If you're OK with making the test so platform-specific then I could add such tests as well.  I was just trying to avoid that, but it also seems impossible to avoid completely...


---

Comment by embray created at 2018-08-16 10:56:40

Let's just get this finished; if more tests are needed later I'll add them.


---

Comment by embray created at 2018-08-16 10:56:40

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-08-20 23:38:58

Resolution: fixed
