# Issue 29154: preparser: update keywords for Python 3

Issue created by migration from https://trac.sagemath.org/ticket/29391

Original creator: @mwageringel

Original creation time: 2020-03-22 17:44:26

Python 3 has new keywords which the preparser does not know yet:

```
sage: import keyword
sage: [a for a in keyword.kwlist if a not in sage.repl.preparse.keywords]
['False', 'None', 'True', 'async', 'await', 'nonlocal']
```


As a result, preparsing of these keywords conflicts with implicit multiplication:

```
sage: implicit_multiplication(True)
sage: preparse("nonlocal a")
'nonlocal*a'
```


In Python 2, the lists `keyword.kwlist` and `sage.repl.preparse.keywords` are the same up to ordering, so this ticket removes the latter and rewrites the keyword checks using the [keyword module](https://docs.python.org/3.7/library/keyword.html#module-keyword).


---

Comment by @mwageringel created at 2020-03-22 17:52:28

Changing status from new to needs_review.


---

Comment by @mwageringel created at 2020-03-22 17:52:28

New commits:


---

Comment by @kliem created at 2020-03-24 15:52:14

Changing status from needs_review to needs_work.


---

Comment by @kliem created at 2020-03-24 15:52:14

- As you already (implicitly) mentioned, part of the problem is not due to python3:

```
sage: implicit_multiplication(True)
sage: True True
1
```


  I don't think this is the desired behavior and I think the ticket description should include this case.

- More importantly, the reverse check gives us the following

```
sage: [a for a in sage.repl.preparse.keywords if not a in keyword.kwlist]
['print', 'exec']
```

  This means that with this ticket `print 2` will raise a `TypeError` and no longer a `SyntaxError`. Same for `exec 2+2` when implicit multiplication is set.

- While at it, we should really fix that at the moment implicit multiplication destroys the ipython magics:

```
sage: implicit_multiplication(10)
sage: cd Documents
```

  will raise a `NameError` because it tries to multiply `ls` with `Documents`.
  So when replacing spaces with `*` we should really make sure that whatever is before the first space is not a keyword in `get_ipython().magics_manager.magics['line']` (I don't know exactly how do this outside of the interactive shell yet).


---

Comment by @mwageringel created at 2020-03-24 19:23:31

Replying to [comment:2 gh-kliem]:
> {{{
> sage: implicit_multiplication(True)
> sage: True True
> 1
> }}}
> 
>   I don't think this is the desired behavior and I think the ticket description should include this case.

Good point. I have updated the description.


> - More importantly, the reverse check gives us the following
> {{{
> sage: [a for a in sage.repl.preparse.keywords if not a in keyword.kwlist]
> ['print', 'exec']
> }}}
>   This means that with this ticket `print 2` will raise a `TypeError` and no longer a `SyntaxError`. Same for `exec 2+2` when implicit multiplication is set.

In Python 3, `print` is not a keyword anymore, but it is a function. I do not think that it should be treated differently than any other function. For example, `sqrt 2` also results in a `TypeError` if implicit multiplication is enabled, not a syntax error, regardless of the changes on this ticket.


> - While at it, we should really fix that at the moment implicit multiplication destroys the ipython magics:
> {{{
> sage: implicit_multiplication(10)
> sage: cd Documents
> }}}
>   will raise a `NameError` because it tries to multiply `ls` with `Documents`.
>   So when replacing spaces with `*` we should really make sure that whatever is before the first space is not a keyword in `get_ipython().magics_manager.magics['line']` (I don't know exactly how do this outside of the interactive shell yet).

Can the IPython magics be used in a non-interactive setting? IIRC, only the interactive shells use a backend that inherits from `BackendIPython`.

I suggest to move this problem to a separate ticket. I am not entirely sure what the correct thing to do here is. For example it would be reasonable to expect the output

```
sage: implicit_multiplication(True)
sage: ab, cd = 3, 2
sage: cd ab
6
```

rather than switching to a directory named `ab`. This example is artificial, of course, and even without implicit multiplication, the IPython magic would fail in this case because of the variable `cd` in scope. The preparser cannot know about the context of a line without evaluating the code, though, so one would have to decide whether IPython automagics in general overrule implicit multiplication or not (possibly depending on the `level`).

One could also use the more robust (non-automagic) syntax

```
sage: %cd Documents
```



---

Comment by @kliem created at 2020-03-24 21:18:51

If I type `print hello` I get a nice error message

```
SyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?
```

I figured, it would be nice to stay that way.

Then I would suggest to leave a message in the docstring of `implicit_multiplication` that this implicitly turns off automagic for level >= 3.

I think (after looking into it) the class `SageCustomizations` in `ipython_extensions` would be able to pass `self.shell`down to preparse, but this might be a lot of work and I agree that it is not a subject of this ticket. I think it's fine, if it is documented that automagic won't work anymore (except for `%time`, which is was manually excluded).

Otherwise, the ticket looks fine.


---

Comment by git created at 2020-03-25 19:42:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-03-25 19:44:28

Changing status from needs_work to needs_review.


---

Comment by @mwageringel created at 2020-03-25 19:44:28

Replying to [comment:5 gh-kliem]:
> If I type `print hello` I get a nice error message
> {{{
> SyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?
> }}}
> I figured, it would be nice to stay that way.

Ok, `print` is a very special case due to the switch from Python 2 to 3, so this error message is more likely to be useful. I have added `print` and `exec` again.

> Then I would suggest to leave a message in the docstring of `implicit_multiplication` that this implicitly turns off automagic for level >= 3.

Done. Thank you for the suggestions.


---

Comment by @kliem created at 2020-03-26 10:03:19

Ok, thanks. One more thing:

At the moment all the documentation is in `implicit_mul` and not in `implicit_multiplication` including the definition of the `level` and the comment about the automagic.

Wouldn't it be better the other way around as `implicit_multiplication` is the function in the namespace?


---

Comment by git created at 2020-03-27 17:51:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-03-27 17:52:28

Replying to [comment:9 gh-kliem]:
> Wouldn't it be better the other way around as `implicit_multiplication` is the function in the namespace?

I agree. I have updated the documentation.


---

Comment by @kliem created at 2020-03-27 18:09:54

I propose the following change yet:


```diff
     <https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-automagic>`_
     feature cannot be used if ``level >= 3``::
 
-        sage: from sage.repl.preparse import implicit_mul
-        sage: implicit_mul('cd Documents', level=3)
+        sage: implicit_multiplication(3)
+        sage: preparse('cd Documents')
         'cd*Documents'
-        sage: implicit_mul('cd Documents', level=2)
+        sage: implicit_multiplication(2)
+        sage: preparse('cd Documents')
         'cd Documents'
+        sage: implicit_multiplication(False)
```


This is more consistent with the other doctests in `implicit_multiplication` (as `implicit_mul` is never mentioned). Once done, you can put it on positive review on my behalf.

Note that the last line is needed to make later doctests work.


---

Comment by git created at 2020-03-27 18:19:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @mwageringel created at 2020-03-27 18:34:14

Ok, thank you.


---

Comment by @mwageringel created at 2020-03-27 18:34:14

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-04-05 08:30:28

Resolution: fixed
