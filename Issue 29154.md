# Issue 29154: preparser: update keywords for Python 3

archive/issues_029154.json:
```json
{
    "body": "Python 3 has new keywords which the preparser does not know yet:\n\n```\nsage: import keyword\nsage: [a for a in keyword.kwlist if a not in sage.repl.preparse.keywords]\n['False', 'None', 'True', 'async', 'await', 'nonlocal']\n```\n\nAs a result, preparsing of these keywords conflicts with implicit multiplication:\n\n```\nsage: implicit_multiplication(True)\nsage: preparse(\"nonlocal a\")\n'nonlocal*a'\n```\n\nIn Python 2, the lists `keyword.kwlist` and `sage.repl.preparse.keywords` are the same up to ordering, so this ticket removes the latter and rewrites the keyword checks using the [keyword module](https://docs.python.org/3.7/library/keyword.html#module-keyword).\n\nA consequence of these changes is that implicit multiplication of literal booleans is not supported anymore:\n\n```\nsage: True True   # previously, this returned 1\n...\nSyntaxError: invalid syntax\n```\n\nFor the Python 2 keywords `print` and `exec`, implicit multiplication is still avoided with Python 3 in order to keep the error message:\n\n```\nSyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/29391\n\n",
    "closed_at": "2020-04-05T08:30:28Z",
    "created_at": "2020-03-22T17:44:26Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.1",
    "title": "preparser: update keywords for Python 3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29154",
    "user": "https://github.com/mwageringel"
}
```
Python 3 has new keywords which the preparser does not know yet:

```
sage: import keyword
sage: [a for a in keyword.kwlist if a not in sage.repl.preparse.keywords]
['False', 'None', 'True', 'async', 'await', 'nonlocal']
```

As a result, preparsing of these keywords conflicts with implicit multiplication:

```
sage: implicit_multiplication(True)
sage: preparse("nonlocal a")
'nonlocal*a'
```

In Python 2, the lists `keyword.kwlist` and `sage.repl.preparse.keywords` are the same up to ordering, so this ticket removes the latter and rewrites the keyword checks using the [keyword module](https://docs.python.org/3.7/library/keyword.html#module-keyword).

A consequence of these changes is that implicit multiplication of literal booleans is not supported anymore:

```
sage: True True   # previously, this returned 1
...
SyntaxError: invalid syntax
```

For the Python 2 keywords `print` and `exec`, implicit multiplication is still avoided with Python 3 in order to keep the error message:

```
SyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?
```


Issue created by migration from https://trac.sagemath.org/ticket/29391





---

archive/issue_comments_412258.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-03-22T17:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412258",
    "user": "https://github.com/mwageringel"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_412259.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-03-22T17:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412259",
    "user": "https://github.com/mwageringel"
}
```

New commits:



---

archive/issue_comments_412260.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-03-24T15:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412260",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_412261.json:
```json
{
    "body": "- As you already (implicitly) mentioned, part of the problem is not due to python3:\n\n```\nsage: implicit_multiplication(True)\nsage: True True\n1\n```\n\n  I don't think this is the desired behavior and I think the ticket description should include this case.\n\n- More importantly, the reverse check gives us the following\n\n```\nsage: [a for a in sage.repl.preparse.keywords if not a in keyword.kwlist]\n['print', 'exec']\n```\n  This means that with this ticket `print 2` will raise a `TypeError` and no longer a `SyntaxError`. Same for `exec 2+2` when implicit multiplication is set.\n\n- While at it, we should really fix that at the moment implicit multiplication destroys the ipython magics:\n\n```\nsage: implicit_multiplication(10)\nsage: cd Documents\n```\n  will raise a `NameError` because it tries to multiply `ls` with `Documents`.\n  So when replacing spaces with `*` we should really make sure that whatever is before the first space is not a keyword in `get_ipython().magics_manager.magics['line']` (I don't know exactly how do this outside of the interactive shell yet).",
    "created_at": "2020-03-24T15:52:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412261",
    "user": "https://github.com/kliem"
}
```

- As you already (implicitly) mentioned, part of the problem is not due to python3:

```
sage: implicit_multiplication(True)
sage: True True
1
```

  I don't think this is the desired behavior and I think the ticket description should include this case.

- More importantly, the reverse check gives us the following

```
sage: [a for a in sage.repl.preparse.keywords if not a in keyword.kwlist]
['print', 'exec']
```
  This means that with this ticket `print 2` will raise a `TypeError` and no longer a `SyntaxError`. Same for `exec 2+2` when implicit multiplication is set.

- While at it, we should really fix that at the moment implicit multiplication destroys the ipython magics:

```
sage: implicit_multiplication(10)
sage: cd Documents
```
  will raise a `NameError` because it tries to multiply `ls` with `Documents`.
  So when replacing spaces with `*` we should really make sure that whatever is before the first space is not a keyword in `get_ipython().magics_manager.magics['line']` (I don't know exactly how do this outside of the interactive shell yet).



---

archive/issue_comments_412262.json:
```json
{
    "body": "Replying to [comment:2 gh-kliem]:\n> {{{\n> sage: implicit_multiplication(True)\n> sage: True True\n> 1\n> }}}\n> \n>   I don't think this is the desired behavior and I think the ticket description should include this case.\n\n\nGood point. I have updated the description.\n\n\n> - More importantly, the reverse check gives us the following\n> \n> ```\n> sage: [a for a in sage.repl.preparse.keywords if not a in keyword.kwlist]\n> ['print', 'exec']\n> ```\n>   This means that with this ticket `print 2` will raise a `TypeError` and no longer a `SyntaxError`. Same for `exec 2+2` when implicit multiplication is set.\n\n\nIn Python 3, `print` is not a keyword anymore, but it is a function. I do not think that it should be treated differently than any other function. For example, `sqrt 2` also results in a `TypeError` if implicit multiplication is enabled, not a syntax error, regardless of the changes on this ticket.\n\n\n> - While at it, we should really fix that at the moment implicit multiplication destroys the ipython magics:\n> \n> ```\n> sage: implicit_multiplication(10)\n> sage: cd Documents\n> ```\n>   will raise a `NameError` because it tries to multiply `ls` with `Documents`.\n>   So when replacing spaces with `*` we should really make sure that whatever is before the first space is not a keyword in `get_ipython().magics_manager.magics['line']` (I don't know exactly how do this outside of the interactive shell yet).\n\n\nCan the IPython magics be used in a non-interactive setting? IIRC, only the interactive shells use a backend that inherits from `BackendIPython`.\n\nI suggest to move this problem to a separate ticket. I am not entirely sure what the correct thing to do here is. For example it would be reasonable to expect the output\n\n```\nsage: implicit_multiplication(True)\nsage: ab, cd = 3, 2\nsage: cd ab\n6\n```\nrather than switching to a directory named `ab`. This example is artificial, of course, and even without implicit multiplication, the IPython magic would fail in this case because of the variable `cd` in scope. The preparser cannot know about the context of a line without evaluating the code, though, so one would have to decide whether IPython automagics in general overrule implicit multiplication or not (possibly depending on the `level`).\n\nOne could also use the more robust (non-automagic) syntax\n\n```\nsage: %cd Documents\n```",
    "created_at": "2020-03-24T19:23:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412262",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:2 gh-kliem]:
> {{{
> sage: implicit_multiplication(True)
> sage: True True
> 1
> }}}
> 
>   I don't think this is the desired behavior and I think the ticket description should include this case.


Good point. I have updated the description.


> - More importantly, the reverse check gives us the following
> 
> ```
> sage: [a for a in sage.repl.preparse.keywords if not a in keyword.kwlist]
> ['print', 'exec']
> ```
>   This means that with this ticket `print 2` will raise a `TypeError` and no longer a `SyntaxError`. Same for `exec 2+2` when implicit multiplication is set.


In Python 3, `print` is not a keyword anymore, but it is a function. I do not think that it should be treated differently than any other function. For example, `sqrt 2` also results in a `TypeError` if implicit multiplication is enabled, not a syntax error, regardless of the changes on this ticket.


> - While at it, we should really fix that at the moment implicit multiplication destroys the ipython magics:
> 
> ```
> sage: implicit_multiplication(10)
> sage: cd Documents
> ```
>   will raise a `NameError` because it tries to multiply `ls` with `Documents`.
>   So when replacing spaces with `*` we should really make sure that whatever is before the first space is not a keyword in `get_ipython().magics_manager.magics['line']` (I don't know exactly how do this outside of the interactive shell yet).


Can the IPython magics be used in a non-interactive setting? IIRC, only the interactive shells use a backend that inherits from `BackendIPython`.

I suggest to move this problem to a separate ticket. I am not entirely sure what the correct thing to do here is. For example it would be reasonable to expect the output

```
sage: implicit_multiplication(True)
sage: ab, cd = 3, 2
sage: cd ab
6
```
rather than switching to a directory named `ab`. This example is artificial, of course, and even without implicit multiplication, the IPython magic would fail in this case because of the variable `cd` in scope. The preparser cannot know about the context of a line without evaluating the code, though, so one would have to decide whether IPython automagics in general overrule implicit multiplication or not (possibly depending on the `level`).

One could also use the more robust (non-automagic) syntax

```
sage: %cd Documents
```



---

archive/issue_comments_412263.json:
```json
{
    "body": "If I type `print hello` I get a nice error message\n\n```\nSyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?\n```\nI figured, it would be nice to stay that way.\n\nThen I would suggest to leave a message in the docstring of `implicit_multiplication` that this implicitly turns off automagic for level >= 3.\n\nI think (after looking into it) the class `SageCustomizations` in `ipython_extensions` would be able to pass `self.shell`down to preparse, but this might be a lot of work and I agree that it is not a subject of this ticket. I think it's fine, if it is documented that automagic won't work anymore (except for `%time`, which is was manually excluded).\n\nOtherwise, the ticket looks fine.",
    "created_at": "2020-03-24T21:18:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412263",
    "user": "https://github.com/kliem"
}
```

If I type `print hello` I get a nice error message

```
SyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?
```
I figured, it would be nice to stay that way.

Then I would suggest to leave a message in the docstring of `implicit_multiplication` that this implicitly turns off automagic for level >= 3.

I think (after looking into it) the class `SageCustomizations` in `ipython_extensions` would be able to pass `self.shell`down to preparse, but this might be a lot of work and I agree that it is not a subject of this ticket. I think it's fine, if it is documented that automagic won't work anymore (except for `%time`, which is was manually excluded).

Otherwise, the ticket looks fine.



---

archive/issue_comments_412264.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-25T19:42:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412264",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_412265.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-03-25T19:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412265",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_412266.json:
```json
{
    "body": "Replying to [comment:5 gh-kliem]:\n> If I type `print hello` I get a nice error message\n> \n> ```\n> SyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?\n> ```\n> I figured, it would be nice to stay that way.\n\n\nOk, `print` is a very special case due to the switch from Python 2 to 3, so this error message is more likely to be useful. I have added `print` and `exec` again.\n\n> Then I would suggest to leave a message in the docstring of `implicit_multiplication` that this implicitly turns off automagic for level >= 3.\n\n\nDone. Thank you for the suggestions.",
    "created_at": "2020-03-25T19:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412266",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:5 gh-kliem]:
> If I type `print hello` I get a nice error message
> 
> ```
> SyntaxError: Missing parentheses in call to 'print'. Did you mean print('hello')?
> ```
> I figured, it would be nice to stay that way.


Ok, `print` is a very special case due to the switch from Python 2 to 3, so this error message is more likely to be useful. I have added `print` and `exec` again.

> Then I would suggest to leave a message in the docstring of `implicit_multiplication` that this implicitly turns off automagic for level >= 3.


Done. Thank you for the suggestions.



---

archive/issue_comments_412267.json:
```json
{
    "body": "Ok, thanks. One more thing:\n\nAt the moment all the documentation is in `implicit_mul` and not in `implicit_multiplication` including the definition of the `level` and the comment about the automagic.\n\nWouldn't it be better the other way around as `implicit_multiplication` is the function in the namespace?",
    "created_at": "2020-03-26T10:03:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412267",
    "user": "https://github.com/kliem"
}
```

Ok, thanks. One more thing:

At the moment all the documentation is in `implicit_mul` and not in `implicit_multiplication` including the definition of the `level` and the comment about the automagic.

Wouldn't it be better the other way around as `implicit_multiplication` is the function in the namespace?



---

archive/issue_comments_412268.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-27T17:51:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412268",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_412269.json:
```json
{
    "body": "Replying to [comment:9 gh-kliem]:\n> Wouldn't it be better the other way around as `implicit_multiplication` is the function in the namespace?\n\n\nI agree. I have updated the documentation.",
    "created_at": "2020-03-27T17:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412269",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:9 gh-kliem]:
> Wouldn't it be better the other way around as `implicit_multiplication` is the function in the namespace?


I agree. I have updated the documentation.



---

archive/issue_comments_412270.json:
```json
{
    "body": "I propose the following change yet:\n\n```diff\n     <https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-automagic>`_\n     feature cannot be used if ``level >= 3``::\n \n-        sage: from sage.repl.preparse import implicit_mul\n-        sage: implicit_mul('cd Documents', level=3)\n+        sage: implicit_multiplication(3)\n+        sage: preparse('cd Documents')\n         'cd*Documents'\n-        sage: implicit_mul('cd Documents', level=2)\n+        sage: implicit_multiplication(2)\n+        sage: preparse('cd Documents')\n         'cd Documents'\n+        sage: implicit_multiplication(False)\n```\n\nThis is more consistent with the other doctests in `implicit_multiplication` (as `implicit_mul` is never mentioned). Once done, you can put it on positive review on my behalf.\n\nNote that the last line is needed to make later doctests work.",
    "created_at": "2020-03-27T18:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412270",
    "user": "https://github.com/kliem"
}
```

I propose the following change yet:

```diff
     <https://ipython.readthedocs.io/en/stable/interactive/magics.html#magic-automagic>`_
     feature cannot be used if ``level >= 3``::
 
-        sage: from sage.repl.preparse import implicit_mul
-        sage: implicit_mul('cd Documents', level=3)
+        sage: implicit_multiplication(3)
+        sage: preparse('cd Documents')
         'cd*Documents'
-        sage: implicit_mul('cd Documents', level=2)
+        sage: implicit_multiplication(2)
+        sage: preparse('cd Documents')
         'cd Documents'
+        sage: implicit_multiplication(False)
```

This is more consistent with the other doctests in `implicit_multiplication` (as `implicit_mul` is never mentioned). Once done, you can put it on positive review on my behalf.

Note that the last line is needed to make later doctests work.



---

archive/issue_comments_412271.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-03-27T18:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412271",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_412272.json:
```json
{
    "body": "Ok, thank you.",
    "created_at": "2020-03-27T18:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412272",
    "user": "https://github.com/mwageringel"
}
```

Ok, thank you.



---

archive/issue_comments_412273.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-03-27T18:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412273",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_412274.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-04-05T08:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29154#issuecomment-412274",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_074910.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-04-05T08:30:28Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/29154",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/29154#event-74910"
}
```
