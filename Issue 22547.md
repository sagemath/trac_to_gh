# Issue 22547: on clang libgap needs -fPIC

Issue created by migration from https://trac.sagemath.org/ticket/22784

Original creator: dimpase

Original creation time: 2017-04-08 20:11:37

CC:  fbissey

Building libgap with clang on Linux and FreeBSD does not work due to a misconfiguration--- the `-fPIC` flag is not added.

Specifically, it turns out this bit

```
CPPFLAGS="$CPPFLAGS"' -DSYS_DEFAULT_PATHS=\"'"$SAGE_LOCAL/gap/latest"'\"'
```

about `SYS_DEFAULT_PATHS` is breaking the detection of `-fPIC -DPIC` by `autoconf`, so everything is compiled without `-fPIC` and the linking of the shared object fails.


See #12426 and #22679 for details.


---

Comment by fbissey created at 2017-04-08 20:13:23

That's just weird, I just started to work on this, launched a build and bang there is a ticket for me :)


---

Comment by fbissey created at 2017-04-08 20:16:18

And having the definition just in `spkg-check` just works. I need to put things in order and write meaningful comments in the right spots.

```
[libgap-4.8.6] Successfully installed libgap-4.8.6
[libgap-4.8.6] Running the test suite for libgap-4.8.6...
[libgap-4.8.6] Making check in src
[libgap-4.8.6] make[3]: Nothing to be done for `check'.
[libgap-4.8.6] Making check in test
[libgap-4.8.6] make  test shell error_handler
[libgap-4.8.6] clang -DHAVE_CONFIG_H -I.. -I..   -DSYS_DEFAULT_PATHS=\"/Users/fbissey/build/sage-clang/local/gap/latest\" -I/Users/fbissey/build/sage-clang/local/include  -MT test-test.o -MD -MP -MF .deps/test-test.Tpo -c -o test-test.o `test -f 'test.c' || echo './'`test.c
[libgap-4.8.6] mv -f .deps/test-test.Tpo .deps/test-test.Po
[libgap-4.8.6] /bin/sh ../libtool  --tag=CC   --mode=link clang -I/Users/fbissey/build/sage-clang/local/include  -lgmp -lm -L/Users/fbissey/build/sage-clang/local/lib -Wl,-rpath,/Users/fbissey/build/sage-clang/local/lib  -o test test-test.o ../src/libgap.la 
[libgap-4.8.6] libtool: link: clang -I/Users/fbissey/build/sage-clang/local/include -Wl,-rpath -Wl,/Users/fbissey/build/sage-clang/local/lib -o .libs/test test-test.o  -L/Users/fbissey/build/sage-clang/local/lib ../src/.libs/libgap.dylib -lgmp -lm
[libgap-4.8.6] clang -DHAVE_CONFIG_H -I.. -I..   -DSYS_DEFAULT_PATHS=\"/Users/fbissey/build/sage-clang/local/gap/latest\" -I/Users/fbissey/build/sage-clang/local/include  -MT shell-shell.o -MD -MP -MF .deps/shell-shell.Tpo -c -o shell-shell.o `test -f 'shell.c' || echo './'`shell.c
[libgap-4.8.6] mv -f .deps/shell-shell.Tpo .deps/shell-shell.Po
[libgap-4.8.6] /bin/sh ../libtool  --tag=CC   --mode=link clang -I/Users/fbissey/build/sage-clang/local/include  -lgmp -lm -L/Users/fbissey/build/sage-clang/local/lib -Wl,-rpath,/Users/fbissey/build/sage-clang/local/lib  -o shell shell-shell.o ../src/libgap.la 
[libgap-4.8.6] libtool: link: clang -I/Users/fbissey/build/sage-clang/local/include -Wl,-rpath -Wl,/Users/fbissey/build/sage-clang/local/lib -o .libs/shell shell-shell.o  -L/Users/fbissey/build/sage-clang/local/lib ../src/.libs/libgap.dylib -lgmp -lm
[libgap-4.8.6] clang -DHAVE_CONFIG_H -I.. -I..   -DSYS_DEFAULT_PATHS=\"/Users/fbissey/build/sage-clang/local/gap/latest\" -I/Users/fbissey/build/sage-clang/local/include  -MT error_handler-error_handler.o -MD -MP -MF .deps/error_handler-error_handler.Tpo -c -o error_handler-error_handler.o `test -f 'error_handler.c' || echo './'`error_handler.c
[libgap-4.8.6] mv -f .deps/error_handler-error_handler.Tpo .deps/error_handler-error_handler.Po
[libgap-4.8.6] /bin/sh ../libtool  --tag=CC   --mode=link clang -I/Users/fbissey/build/sage-clang/local/include  -lgmp -lm -L/Users/fbissey/build/sage-clang/local/lib -Wl,-rpath,/Users/fbissey/build/sage-clang/local/lib  -o error_handler error_handler-error_handler.o ../src/libgap.la 
[libgap-4.8.6] libtool: link: clang -I/Users/fbissey/build/sage-clang/local/include -Wl,-rpath -Wl,/Users/fbissey/build/sage-clang/local/lib -o .libs/error_handler error_handler-error_handler.o  -L/Users/fbissey/build/sage-clang/local/lib ../src/.libs/libgap.dylib -lgmp -lm
[libgap-4.8.6] make  check-TESTS
[libgap-4.8.6] PASS: test
[libgap-4.8.6] PASS: shell
[libgap-4.8.6] PASS: error_handler
[libgap-4.8.6] ============================================================================
[libgap-4.8.6] Testsuite summary for libGAP 4.8.6
[libgap-4.8.6] ============================================================================
[libgap-4.8.6] # TOTAL: 3
[libgap-4.8.6] # PASS:  3
[libgap-4.8.6] # SKIP:  0
[libgap-4.8.6] # XFAIL: 0
[libgap-4.8.6] # FAIL:  0
[libgap-4.8.6] # XPASS: 0
[libgap-4.8.6] # ERROR: 0
[libgap-4.8.6] ============================================================================
```



---

Comment by fbissey created at 2017-04-08 20:31:07

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-04-08 20:31:07

Ready for review.
----
New commits:


---

Comment by dimpase created at 2017-04-08 21:07:54

Looks good, works on FreeBSD.


---

Comment by dimpase created at 2017-04-08 21:07:54

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-04-08 22:01:55

Just to make sure, you have run it with `SAGE_CHECK=yes`?


---

Comment by fbissey created at 2017-04-08 22:08:31

OK revised the description. Now it has more details than the previously quoted tickets.


---

Comment by dimpase created at 2017-04-08 22:31:53

Replying to [comment:5 fbissey]:
> Just to make sure, you have run it with `SAGE_CHECK=yes`?
with, and without, as well. All good.


---

Comment by vbraun created at 2017-04-10 22:25:05

Resolution: fixed
