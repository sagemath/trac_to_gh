# Issue 20817: Random test failure in moebius_algebra.py

archive/issues_020817.json:
```json
{
    "body": "CC:  tscrim nthiery darij\n\nI get a failed test from\n\n\n```\n./sage -t --randorder 23895 src/sage/combinat/posets/moebius_algebra.py\n```\n\n\nIt works when I change 23895 to 23894 or 23896. No idea why, just noticed this when running other randomized tests.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21054\n\n",
    "created_at": "2016-07-19T10:54:43Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.3",
    "title": "Random test failure in moebius_algebra.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20817",
    "user": "jmantysalo"
}
```
CC:  tscrim nthiery darij

I get a failed test from


```
./sage -t --randorder 23895 src/sage/combinat/posets/moebius_algebra.py
```


It works when I change 23895 to 23894 or 23896. No idea why, just noticed this when running other randomized tests.

Issue created by migration from https://trac.sagemath.org/ticket/21054





---

archive/issue_comments_287658.json:
```json
{
    "body": "So the reason why this gets exposed is not with the M\u00f6bius algebra code, but instead with the `WithRealizations` framework or the `_test_one` method (and coercion) depending on how you look at it. The problem is that running the doctests in that order first produced the `I` basis, which becomes the first basis in the `_realizations` list, and this differs from the `a_realization()` basis (the `E` basis). So the `_an_element_` constructs an element from `realizations()[0]`, but `one()` uses `a_realization().one()`. So this coerces into the `I` basis, and then compares it to the `E` basis (or vice versa). It is this comparison which fails:\n\n```sage\nsage: L = posets.BooleanLattice(4)\nsage: M = L.moebius_algebra(QQ)\nsage: M.I()\nMoebius algebra of Finite lattice containing 16 elements over Rational Field in the idempotent basis\nsage: TestSuite(M).run()\nFailure in _test_one:\n...\n------------------------------------------------------------\nThe following tests failed: _test_one\nsage: I = M.I()\nsage: E = M.E()\nsage: I.one() * E.an_element() == E.an_element()\nTrue\nsage: E.an_element() * I.one() == E.an_element()\nFalse\n```\n\nSo IMO, the simplest fix is to use `a_realization` for `_an_element_` (which will probably fix some other `TestSuite` issues I've noticed in the past, which fails if a realization was never given).\n\nHowever, with all of that being said, there still is a problem with the `one` for the idempotent basis:\n\n```\nsage: E.one()\nE[0]\nsage: I.one()\nI[0] + I[1] + I[2] + I[3] + I[4] + I[5] + I[6] + I[7] + I[8] + I[9] + I[10] + I[11] + I[12] + I[13] + I[14] + I[15]\nsage: E(I.one())\nE[15]\nsage: I(E.one())\nI[0]\nsage: E.an_element() * E(I.one())\n7*E[15]\n```\n\nSo the first issue is now #21059. For the main issue on this ticket, I guess I will have to read the references again to make sure there isn't something like a sign flipped.",
    "created_at": "2016-07-19T20:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287658",
    "user": "tscrim"
}
```

So the reason why this gets exposed is not with the Möbius algebra code, but instead with the `WithRealizations` framework or the `_test_one` method (and coercion) depending on how you look at it. The problem is that running the doctests in that order first produced the `I` basis, which becomes the first basis in the `_realizations` list, and this differs from the `a_realization()` basis (the `E` basis). So the `_an_element_` constructs an element from `realizations()[0]`, but `one()` uses `a_realization().one()`. So this coerces into the `I` basis, and then compares it to the `E` basis (or vice versa). It is this comparison which fails:

```sage
sage: L = posets.BooleanLattice(4)
sage: M = L.moebius_algebra(QQ)
sage: M.I()
Moebius algebra of Finite lattice containing 16 elements over Rational Field in the idempotent basis
sage: TestSuite(M).run()
Failure in _test_one:
...
------------------------------------------------------------
The following tests failed: _test_one
sage: I = M.I()
sage: E = M.E()
sage: I.one() * E.an_element() == E.an_element()
True
sage: E.an_element() * I.one() == E.an_element()
False
```

So IMO, the simplest fix is to use `a_realization` for `_an_element_` (which will probably fix some other `TestSuite` issues I've noticed in the past, which fails if a realization was never given).

However, with all of that being said, there still is a problem with the `one` for the idempotent basis:

```
sage: E.one()
E[0]
sage: I.one()
I[0] + I[1] + I[2] + I[3] + I[4] + I[5] + I[6] + I[7] + I[8] + I[9] + I[10] + I[11] + I[12] + I[13] + I[14] + I[15]
sage: E(I.one())
E[15]
sage: I(E.one())
I[0]
sage: E.an_element() * E(I.one())
7*E[15]
```

So the first issue is now #21059. For the main issue on this ticket, I guess I will have to read the references again to make sure there isn't something like a sign flipped.



---

archive/issue_comments_287659.json:
```json
{
    "body": "FYI - this is independent of #21059. Ready for review.\n----\nNew commits:",
    "created_at": "2016-07-22T14:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287659",
    "user": "tscrim"
}
```

FYI - this is independent of #21059. Ready for review.
----
New commits:



---

archive/issue_comments_287660.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-07-22T14:35:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287660",
    "user": "tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_287661.json:
```json
{
    "body": "The changes look good, except for one thing: Why do you use `triangular='upper'` in the normal M\u00f6bius algebra, and `triangular='lower'` in the quantum one? Maybe this needs to be changed too? Also, does Sage understand what order relation this triangularity refers to? (My knowledge of the modules framework is a bit rusted, so I don't remember the exact semantics of the `triangular` keyword.)",
    "created_at": "2016-07-23T11:56:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287661",
    "user": "darij"
}
```

The changes look good, except for one thing: Why do you use `triangular='upper'` in the normal Möbius algebra, and `triangular='lower'` in the quantum one? Maybe this needs to be changed too? Also, does Sage understand what order relation this triangularity refers to? (My knowledge of the modules framework is a bit rusted, so I don't remember the exact semantics of the `triangular` keyword.)



---

archive/issue_comments_287662.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-23T15:38:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287662",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287663.json:
```json
{
    "body": "Good catch. The triangularity changed because of the change in transition maps.",
    "created_at": "2016-07-23T15:39:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287663",
    "user": "tscrim"
}
```

Good catch. The triangularity changed because of the change in transition maps.



---

archive/issue_comments_287664.json:
```json
{
    "body": "Also, the order relations come from the basis index set.",
    "created_at": "2016-07-23T15:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287664",
    "user": "tscrim"
}
```

Also, the order relations come from the basis index set.



---

archive/issue_comments_287665.json:
```json
{
    "body": "So `module_morphism` is smart enough to compare basis indices using something like `index_set.le` instead of `_cmp_`?\n\nIn this case, and if the tests pass, that's a positive review. Thanks for the fix, and sorry for my inactivity! (This fall I'll hopefully have both more time and a better laptop to work on Sage, plus your live support...)",
    "created_at": "2016-07-23T15:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287665",
    "user": "darij"
}
```

So `module_morphism` is smart enough to compare basis indices using something like `index_set.le` instead of `_cmp_`?

In this case, and if the tests pass, that's a positive review. Thanks for the fix, and sorry for my inactivity! (This fall I'll hopefully have both more time and a better laptop to work on Sage, plus your live support...)



---

archive/issue_comments_287666.json:
```json
{
    "body": "Replying to [comment:7 darij]:\n> So `module_morphism` is smart enough to compare basis indices using something like `index_set.le` instead of `_cmp_`?\n\nNot exactly, but we are moving away from `_cmp_` altogether (#21043 to Python3). So there might be a problem with a facade poset whose elements have a partial ordering which is not compatible with the poset's ordering. Although the triangularity part is somewhat moot because we have an explicit description of both transition maps.\n\n> In this case, and if the tests pass, that's a positive review.\n\nAll tests pass for me, so if you agree with the above, then please set a positive review.\n\n> Thanks for the fix, and sorry for my inactivity! (This fall I'll hopefully have both more time and a better laptop to work on Sage, plus your live support...)\n\nThanks for looking at this. I know you've got a lot on your plate moving out to UMN, and it will be great to have you here.",
    "created_at": "2016-07-23T15:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287666",
    "user": "tscrim"
}
```

Replying to [comment:7 darij]:
> So `module_morphism` is smart enough to compare basis indices using something like `index_set.le` instead of `_cmp_`?

Not exactly, but we are moving away from `_cmp_` altogether (#21043 to Python3). So there might be a problem with a facade poset whose elements have a partial ordering which is not compatible with the poset's ordering. Although the triangularity part is somewhat moot because we have an explicit description of both transition maps.

> In this case, and if the tests pass, that's a positive review.

All tests pass for me, so if you agree with the above, then please set a positive review.

> Thanks for the fix, and sorry for my inactivity! (This fall I'll hopefully have both more time and a better laptop to work on Sage, plus your live support...)

Thanks for looking at this. I know you've got a lot on your plate moving out to UMN, and it will be great to have you here.



---

archive/issue_comments_287667.json:
```json
{
    "body": "Oh; can we remove the \"explicit\" triangularity then? What is it used for, beyond computing inverses?",
    "created_at": "2016-07-23T15:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287667",
    "user": "darij"
}
```

Oh; can we remove the "explicit" triangularity then? What is it used for, beyond computing inverses?



---

archive/issue_comments_287668.json:
```json
{
    "body": "However, it is (uni)triangular, and AFAIK, it currently is only used in the inverses. It is an issue (and separate from this ticket) only if someone does something more perverse, but someone might want to take the inverse of the coerce map independently.",
    "created_at": "2016-07-23T16:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287668",
    "user": "tscrim"
}
```

However, it is (uni)triangular, and AFAIK, it currently is only used in the inverses. It is an issue (and separate from this ticket) only if someone does something more perverse, but someone might want to take the inverse of the coerce map independently.



---

archive/issue_comments_287669.json:
```json
{
    "body": "Can I consider this as a positive review?",
    "created_at": "2016-07-27T15:06:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287669",
    "user": "tscrim"
}
```

Can I consider this as a positive review?



---

archive/issue_comments_287670.json:
```json
{
    "body": "I don't know, sorry. nthiery, can you weigh in? This abuts to infrastructure again, and that's out of my comfort zone...",
    "created_at": "2016-07-27T15:25:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287670",
    "user": "darij"
}
```

I don't know, sorry. nthiery, can you weigh in? This abuts to infrastructure again, and that's out of my comfort zone...



---

archive/issue_comments_287671.json:
```json
{
    "body": "(I guess the main question here is: When we define several bases of a module-with-realizations, then can we regard the transition maps as internal attributes, or should we consider them as being exposed to the user? In the latter case, we cannot afford breaking things like `preimage`; in the former it doesn't matter.)\n\n(For quick reference: https://github.com/sagemath/sage/blob/develop/src/sage/modules/with_basis/morphism.py )",
    "created_at": "2016-07-27T15:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287671",
    "user": "darij"
}
```

(I guess the main question here is: When we define several bases of a module-with-realizations, then can we regard the transition maps as internal attributes, or should we consider them as being exposed to the user? In the latter case, we cannot afford breaking things like `preimage`; in the former it doesn't matter.)

(For quick reference: https://github.com/sagemath/sage/blob/develop/src/sage/modules/with_basis/morphism.py )



---

archive/issue_comments_287672.json:
```json
{
    "body": "They are indirectly exposed to the user through `coerce_map_from`. However, it is (mathematically) correct that they are triangular wrt the poset order. It just might happen that someone gives a very horrible poset that is a facade. However, that is an independent issue than what is fixed here, which really should get into 7.3 because it gives wrong answers, so it belongs on a separate ticket.",
    "created_at": "2016-07-27T15:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287672",
    "user": "tscrim"
}
```

They are indirectly exposed to the user through `coerce_map_from`. However, it is (mathematically) correct that they are triangular wrt the poset order. It just might happen that someone gives a very horrible poset that is a facade. However, that is an independent issue than what is fixed here, which really should get into 7.3 because it gives wrong answers, so it belongs on a separate ticket.



---

archive/issue_comments_287673.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2016-07-27T15:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287673",
    "user": "tscrim"
}
```

Changing priority from major to critical.



---

archive/issue_comments_287674.json:
```json
{
    "body": "Well, one of the examples is a horrible poset that is a facade:\n\n```\nsage: L = posets.BooleanLattice(4)\nsage: L[3] < L[5]\nTrue\nsage: L.le(L[3],L[5])\nFalse\n```\n\nIMHO, we should just remove the `triangular` and `unitriangular` keywords. It's not like the code is losing anything, is it?",
    "created_at": "2016-07-27T15:52:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287674",
    "user": "darij"
}
```

Well, one of the examples is a horrible poset that is a facade:

```
sage: L = posets.BooleanLattice(4)
sage: L[3] < L[5]
True
sage: L.le(L[3],L[5])
False
```

IMHO, we should just remove the `triangular` and `unitriangular` keywords. It's not like the code is losing anything, is it?



---

archive/issue_comments_287675.json:
```json
{
    "body": "No, that is not a horrible poset (which I realize my comment is far to curt) because the natural order is compatible with the partial order. It does lose some mathematical significance, plus any additional code we might add in the future that uses the triangularity.",
    "created_at": "2016-07-27T15:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287675",
    "user": "tscrim"
}
```

No, that is not a horrible poset (which I realize my comment is far to curt) because the natural order is compatible with the partial order. It does lose some mathematical significance, plus any additional code we might add in the future that uses the triangularity.



---

archive/issue_comments_287676.json:
```json
{
    "body": "Perhaps one simple way out is to make the poset indexing the basis a non-facade all the time. This would avoid any incompatibility of the orders, but it might introduce other subtle issues that could take time to debug.",
    "created_at": "2016-07-27T15:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287676",
    "user": "tscrim"
}
```

Perhaps one simple way out is to make the poset indexing the basis a non-facade all the time. This would avoid any incompatibility of the orders, but it might introduce other subtle issues that could take time to debug.



---

archive/issue_comments_287677.json:
```json
{
    "body": "If any additional code we might add uses triangularity, then this subtle point about facades suddenly becomes a bug. Yes, I know that the above poset has a naturally ordered linear extension, but there's nothing that guarantees the same for user input. If I had my virtual machine at arm's reach, I would fire it up, remove those two lines and check that the speed does not regress; unfortunately, right now I don't. Could you?\n\nThis is not to blame any of your work on this ticket! It's just another problem caused by delayed decisions and a lack of standards. Long ago we (the Sage developers) should have figured out what \"the usual comparison function on `J`\" is supposed to mean in `TriangularModuleMorphism`. But we didn't, and now we've got an implementation of triangularity that is easier to avoid than to use properly.",
    "created_at": "2016-07-27T16:03:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287677",
    "user": "darij"
}
```

If any additional code we might add uses triangularity, then this subtle point about facades suddenly becomes a bug. Yes, I know that the above poset has a naturally ordered linear extension, but there's nothing that guarantees the same for user input. If I had my virtual machine at arm's reach, I would fire it up, remove those two lines and check that the speed does not regress; unfortunately, right now I don't. Could you?

This is not to blame any of your work on this ticket! It's just another problem caused by delayed decisions and a lack of standards. Long ago we (the Sage developers) should have figured out what "the usual comparison function on `J`" is supposed to mean in `TriangularModuleMorphism`. But we didn't, and now we've got an implementation of triangularity that is easier to avoid than to use properly.



---

archive/issue_comments_287678.json:
```json
{
    "body": "I'm just going to do what I said in comment:17. It fixes the issues with facade elements and makes the triangular stuff work. Will post code shortly.",
    "created_at": "2016-07-27T16:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287678",
    "user": "tscrim"
}
```

I'm just going to do what I said in comment:17. It fixes the issues with facade elements and makes the triangular stuff work. Will post code shortly.



---

archive/issue_comments_287679.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-07-27T16:10:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287679",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_287680.json:
```json
{
    "body": "This should take care of the issues, and it doesn't have any overt problems.",
    "created_at": "2016-07-27T16:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287680",
    "user": "tscrim"
}
```

This should take care of the issues, and it doesn't have any overt problems.



---

archive/issue_comments_287681.json:
```json
{
    "body": "LGTM now, thanks!",
    "created_at": "2016-07-27T17:48:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287681",
    "user": "darij"
}
```

LGTM now, thanks!



---

archive/issue_comments_287682.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-07-27T17:48:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287682",
    "user": "darij"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_287683.json:
```json
{
    "body": "Thank you! (See you in about a month.)",
    "created_at": "2016-07-27T17:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287683",
    "user": "tscrim"
}
```

Thank you! (See you in about a month.)



---

archive/issue_comments_287684.json:
```json
{
    "body": "Hi Travis and Darij!\n\nSorry for jumping in that late.\n\nI also tend to see the coercion morphisms as being exposed, since, as\nmentioned, the user can recover them through `coerce_map_from`. So it\nwould be indeed better to keep the triangularity feature.\n\nI am uncomfortable with converting the poset to a non facade: this\nforces users to do conversions whenever accessing the basis\nindices. This can be painful and may lead to subtle bugs if the user\ndoes not notice that the lattice was changed to non facades.\n\nInstead we would want the term ordering to be computed through `P`\n(e.g. through `P.le`). I did not follow the details, but in case this\nis easier to implement once some other ticket will be merged, I guess\nthe current workaround can be ok.\n\nI let you decide how to proceed!\n\nCheers,\n                              Nicolas",
    "created_at": "2016-07-28T09:41:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287684",
    "user": "nthiery"
}
```

Hi Travis and Darij!

Sorry for jumping in that late.

I also tend to see the coercion morphisms as being exposed, since, as
mentioned, the user can recover them through `coerce_map_from`. So it
would be indeed better to keep the triangularity feature.

I am uncomfortable with converting the poset to a non facade: this
forces users to do conversions whenever accessing the basis
indices. This can be painful and may lead to subtle bugs if the user
does not notice that the lattice was changed to non facades.

Instead we would want the term ordering to be computed through `P`
(e.g. through `P.le`). I did not follow the details, but in case this
is easier to implement once some other ticket will be merged, I guess
the current workaround can be ok.

I let you decide how to proceed!

Cheers,
                              Nicolas



---

archive/issue_comments_287685.json:
```json
{
    "body": "Thanks, Nicolas -- but I think this is precisely the one combination of decisions that does *not* work. We cannot have all three:\n1. exposed coerce maps,\n2. triangularity being explicitly guaranteed in the coerce maps,\n3. the poset being left as is as opposed to being converted to non-facade.\nBecause triangularity relies on `cmp` rather than on `P.le`. (Actually, I suspect that triangularity wrt a poset is not even implemented in Sage.)",
    "created_at": "2016-07-28T16:13:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287685",
    "user": "darij"
}
```

Thanks, Nicolas -- but I think this is precisely the one combination of decisions that does *not* work. We cannot have all three:
1. exposed coerce maps,
2. triangularity being explicitly guaranteed in the coerce maps,
3. the poset being left as is as opposed to being converted to non-facade.
Because triangularity relies on `cmp` rather than on `P.le`. (Actually, I suspect that triangularity wrt a poset is not even implemented in Sage.)



---

archive/issue_comments_287686.json:
```json
{
    "body": "Thank you for your comments Nicolas. Yes, I strongly agree that forcing the non-facade of the poset could lead to subtle bugs, but I much more strongly believe we should not remove the triangularity just because a user could be evil and we needed to fix the *actual mathematical* error of this ticket.\n\nThe problem with facade parents is we cannot explicitly create elements of them. If we could, then we could then use them as a key with #21043, which would be a better fix. Although it would be somewhat of a hack solution, I could wrap the elements in a very small class which just implements comparison that calls up to the poset.",
    "created_at": "2016-07-28T16:27:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287686",
    "user": "tscrim"
}
```

Thank you for your comments Nicolas. Yes, I strongly agree that forcing the non-facade of the poset could lead to subtle bugs, but I much more strongly believe we should not remove the triangularity just because a user could be evil and we needed to fix the *actual mathematical* error of this ticket.

The problem with facade parents is we cannot explicitly create elements of them. If we could, then we could then use them as a key with #21043, which would be a better fix. Although it would be somewhat of a hack solution, I could wrap the elements in a very small class which just implements comparison that calls up to the poset.



---

archive/issue_comments_287687.json:
```json
{
    "body": "There is no evil involved here! A user could just follow the examples, while not realizing the implicit convention that the standard comparison `cmp` on a poset should be a linear extension of `P.le` (I wasn't aware of it until this very thread), and get something wrong out of it.",
    "created_at": "2016-07-28T16:30:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287687",
    "user": "darij"
}
```

There is no evil involved here! A user could just follow the examples, while not realizing the implicit convention that the standard comparison `cmp` on a poset should be a linear extension of `P.le` (I wasn't aware of it until this very thread), and get something wrong out of it.



---

archive/issue_comments_287688.json:
```json
{
    "body": "You do have to work somewhat hard to have a poset whose elements have a natural order that is not a linear extension of the poset. I don't think any of the examples have this.",
    "created_at": "2016-07-28T16:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287688",
    "user": "tscrim"
}
```

You do have to work somewhat hard to have a poset whose elements have a natural order that is not a linear extension of the poset. I don't think any of the examples have this.



---

archive/issue_comments_287689.json:
```json
{
    "body": "I remember working hard to *not* have such a poset, back when I was writing my own code for birational rowmotion :) Sure, the examples are smarter than that, but the doc never tells the user the reasoning.",
    "created_at": "2016-07-28T16:33:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287689",
    "user": "darij"
}
```

I remember working hard to *not* have such a poset, back when I was writing my own code for birational rowmotion :) Sure, the examples are smarter than that, but the doc never tells the user the reasoning.



---

archive/issue_comments_287690.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-07-28T17:44:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287690",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_287691.json:
```json
{
    "body": "Hi!\n\nI am answering here for locality in the discussion, but of course this\nbelongs to the new ticket.\n\nIs there anything that prevents us from defining a custom cmp function\nthat is consistent with the default linear extension of the poset and\npassing it to `TriangularMorphism`?\n\nHere is a facade poset for which cmp is wrong:\n\n```\n    sage: P = posets.SetPartitions(3)\n    sage: P.category()\n    Join of Category of finite lattice posets and Category of finite enumerated sets and Category of facade sets\n    sage: P.top()\n    {{1, 2, 3}}\n    sage: sorted(P, cmp=cmp)\n    [{{1}, {2}, {3}}, {{1}, {2, 3}}, {{1, 2}, {3}}, {{1, 2, 3}}, {{1, 3}, {2}}]\n```\n\n\nA proper cmp function:\n\n```\n    sage: key = dict((p,i) for i,p in enumerate(P.linear_extension()))\n    sage: def mycmp(p,q): return cmp(key[p], key[q])\n    sage: sorted(P, cmp=mycmp)\n    [{{1}, {2}, {3}}, {{1}, {2, 3}}, {{1, 2}, {3}}, {{1, 3}, {2}}, {{1, 2, 3}}]\n    }}}\n\n{{{\n    sage: TriangularMorphism(..., cmp=mycmp)\n}}}\n\nThis suggests that it would be nice for TriangularMorphism to accept a\n`key` argument, but that's a different discussion.\n\nCheers,\n                                Nicolas",
    "created_at": "2016-07-29T05:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287691",
    "user": "nthiery"
}
```

Hi!

I am answering here for locality in the discussion, but of course this
belongs to the new ticket.

Is there anything that prevents us from defining a custom cmp function
that is consistent with the default linear extension of the poset and
passing it to `TriangularMorphism`?

Here is a facade poset for which cmp is wrong:

```
    sage: P = posets.SetPartitions(3)
    sage: P.category()
    Join of Category of finite lattice posets and Category of finite enumerated sets and Category of facade sets
    sage: P.top()
    {{1, 2, 3}}
    sage: sorted(P, cmp=cmp)
    [{{1}, {2}, {3}}, {{1}, {2, 3}}, {{1, 2}, {3}}, {{1, 2, 3}}, {{1, 3}, {2}}]
```


A proper cmp function:

```
    sage: key = dict((p,i) for i,p in enumerate(P.linear_extension()))
    sage: def mycmp(p,q): return cmp(key[p], key[q])
    sage: sorted(P, cmp=mycmp)
    [{{1}, {2}, {3}}, {{1}, {2, 3}}, {{1, 2}, {3}}, {{1, 3}, {2}}, {{1, 2, 3}}]
    }}}

{{{
    sage: TriangularMorphism(..., cmp=mycmp)
}}}

This suggests that it would be nice for TriangularMorphism to accept a
`key` argument, but that's a different discussion.

Cheers,
                                Nicolas



---

archive/issue_comments_287692.json:
```json
{
    "body": "Oh, sorry, I had not seen the further discussion in the other ticket. Let's follow up there.",
    "created_at": "2016-07-29T06:09:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20817",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20817#issuecomment-287692",
    "user": "nthiery"
}
```

Oh, sorry, I had not seen the further discussion in the other ticket. Let's follow up there.
