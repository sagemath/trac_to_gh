# Issue 31865: Chart: Add init argument coord_restrictions, deprecate method add_restrictions

Issue created by migration from https://trac.sagemath.org/ticket/32102

Original creator: mkoeppe

Original creation time: 2021-07-02 20:38:42

CC:  egourgoulhon @mjungmath tscrim vbraun

(from #31901#comment:22)

This will remove the appearance of mutability of `Chart`s.


---

Comment by egourgoulhon created at 2021-07-03 11:14:30

I like very much replacements 4 and 5. Using `lambda` function is a good idea! Why is this not immediately applicable? i.e. why #32089 and #32103 have been set as dependencies?


---

Comment by mkoeppe created at 2021-07-03 16:10:51

OK, converting a lambda to a callable symbolic expression is in #32103, but I guess for this ticket one could just call the lambda on the chart variables, so it's not really needed.

I was expecting trouble with `UniqueRepresentation` because the mixture of lists and tuples in your format of coordinate restrictions is not hashable. My suggestion was to convert this to a `ConditionSet` (#32089); but I suppose simpler solutions are possible too


---

Comment by mkoeppe created at 2021-07-03 17:16:21

The `lambda` in the init args will unfortunately also create trouble with the pickling tests - lambdas cannot be pickled. So it will have to be transformed to the list/tuple format already in the `__classcall__` method - triggering the trouble with `UniqueRepresentation`...

So we can either go through #32089, or get rid of `UniqueRepresentation` for `Chart`s.


---

Comment by mkoeppe created at 2021-07-03 18:39:20

In the branch of #31894 I have a change from `def _init_coordinates` to ``@`classmethod def _parse_coordinates` that would be useful to implement `__classcall__`.
----
New commits:


---

Comment by mkoeppe created at 2021-07-03 20:02:48

Replying to [comment:8 mkoeppe]:
> In the branch of #31894 I have a change from `def _init_coordinates` to ``@`classmethod def _parse_coordinates` that would be useful to implement `__classcall__`.

That's now on #32116.


---

Comment by git created at 2021-07-03 20:21:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-03 20:54:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-03 20:55:46

Replying to [comment:5 mkoeppe]:
> I was expecting trouble with `UniqueRepresentation` because the mixture of lists and tuples in your format of coordinate restrictions is not hashable. My suggestion was to convert this to a `ConditionSet` (#32089); but I suppose simpler solutions are possible too

I have implemented a simpler solution


---

Comment by git created at 2021-07-03 21:28:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-03 21:29:29

Replacements 1, 2, 3, and 5 should work now. For simplicity, let's skip 4.


---

Comment by git created at 2021-07-03 22:00:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-03 22:48:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-03 23:47:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-03 23:55:06

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-07-03 23:55:06

There is one remaining use of `add_restrictions` in `TopologicalSubmanifold.adapted_chart`, but it is not triggered by any doctest.
Because this code also uses `assume`, it is probably best to defer work on it to a follow-up ticket.


---

Comment by git created at 2021-07-04 23:59:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-05 00:08:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-07-07 23:13:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-07-08 13:24:31

Looks good. Here are some remarks:

1. The argument `calc_method` of `Chart.__init__` has no longer a default value. Is there any reason for this? This is not consistent with `RealChart.__init__`, which has `calc_method=None`. 

2. In the INPUT section of the docstring of class `Chart`:
- the argument `coordinates` is described as having a default value, which is no longer true
- in the description of the argument `coord_restrictions`, all instances of `restrictions` should be replaced by `coord_restrictions`
- the argument `names` should removed
Moreover, the arguments should be ordered in the same way as they appear in `Chart.__init__`. 

3. In the INPUT section of the docstring of class `RealChart`:
- the argument `coordinates` is described as having a default value, which is no longer true
- the argument `coord_restrictions` is missing
- the argument `names` should be removed

4. In the INPUT section of the docstring of `TopologicalManifold.chart`, the argument `coord_restrictions` is missing; also it could be nice to illustrate its use with a lambda function in the corresponding EXAMPLE section. Actually, this is the first piece of documentation about charts that the user encounters when typing `M.chart?`.


---

Comment by git created at 2021-07-08 14:52:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-08 14:55:24

Replying to [comment:26 egourgoulhon]:
> 2. In the INPUT section of the docstring of class `Chart`:
> - the argument `coordinates` is described as having a default value, which is no longer true 
> [...]
> - the argument `names` should removed

Actually, `coordinates` and `names` still have the same behavior as before -- it is implemented by `__classcall__`


---

Comment by git created at 2021-07-08 15:08:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2021-07-08 15:11:43

Replying to [comment:28 mkoeppe]:
> Replying to [comment:26 egourgoulhon]:
> > 2. In the INPUT section of the docstring of class `Chart`:
> > - the argument `coordinates` is described as having a default value, which is no longer true 
> > [...]
> > - the argument `names` should removed
> 
> Actually, `coordinates` and `names` still have the same behavior as before -- it is implemented by `__classcall__`

Yes I understand this; the question is rather about the consistency of the INPUT field with the class declaration as it appears in the reference manual:

```
class sage.manifolds.chart.Chart(domain, coordinates, calc_method, periods=None,
coord_restrictions=None)
```

This is because Sphinx constructs the above from the `__init__` method, not taking into account `__classcall__`. If one looks at the html output of the reference manual, the INPUT field arrives just after the class declaration. But I agree with you that this does not reflect the way the class should be invoked. I don't know what is the policy here. Possibly, this issue appears in other parts of Sage as well. 

----
New commits:


---

Comment by git created at 2021-07-08 15:14:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-07-08 15:29:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-07-08 15:37:55

Replying to [comment:30 egourgoulhon]:
> Replying to [comment:28 mkoeppe]:
> > Replying to [comment:26 egourgoulhon]:
> > > 2. In the INPUT section of the docstring of class `Chart`:
> > > - the argument `coordinates` is described as having a default value, which is no longer true 
> > > [...]
> > > - the argument `names` should removed
> > 
> > Actually, `coordinates` and `names` still have the same behavior as before -- it is implemented by `__classcall__`
> 
> Yes I understand this; the question is rather about the consistency of the INPUT field with the class declaration as it appears in the reference manual:
> {{{
> class sage.manifolds.chart.Chart(domain, coordinates, calc_method, periods=None,
> coord_restrictions=None)
> }}}
> This is because Sphinx constructs the above from the `__init__` method, not taking into account `__classcall__`. If one looks at the html output of the reference manual, the INPUT field arrives just after the class declaration. But I agree with you that this does not reflect the way the class should be invoked. I don't know what is the policy here. Possibly, this issue appears in other parts of Sage as well. 

Great point; I have opened #32163 for this general issue.


---

Comment by egourgoulhon created at 2021-07-09 15:09:29

Replying to [comment:33 mkoeppe]:
> 
> Great point; I have opened #32163 for this general issue.
> 
OK thanks. Meanwhile, let us leave things as they are, i.e. have the INPUT section of `Chart` and `RealChart` docstrings describe `__classcall__`.


---

Comment by egourgoulhon created at 2021-07-09 15:10:51

Thanks for this improvement!


---

Comment by egourgoulhon created at 2021-07-09 15:10:51

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-09 15:50:20

Thanks for reviewing!


---

Comment by git created at 2021-07-12 21:24:50

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-07-12 21:24:50

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by mkoeppe created at 2021-07-12 21:25:16

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-12 21:25:16

Merged updated #32009


---

Comment by git created at 2021-07-19 01:54:59

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-07-19 01:54:59

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-07-19 01:55:40

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-07-24 19:06:00

Resolution: fixed


---

Comment by mkoeppe created at 2021-07-24 19:06:00

Apparently this has been merged as part of #32089.
