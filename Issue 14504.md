# Issue 14504: Graph constructor forgets vertex labels

archive/issues_014504.json:
```json
{
    "body": "Assignee: jason, ncohen, rlm\n\n\n```\nsage: g = Graph()\nsage: g.add_vertex(0)\nsage: g.set_vertex(0, 'foo')\nsage: g.get_vertices()\n{0: 'foo'}\nsage: Graph(g).get_vertices()\n{0: None}\n```\n\nEdge labels are remembered, though:\n\n```\nsage: g.add_vertex(1)\nsage: g.add_edge(0,1, 'bar')\nsage: g.edges()\n[(0, 1, 'bar')]\nsage: Graph(g).edges()\n[(0, 1, 'bar')]\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14708\n\n",
    "created_at": "2013-06-09T20:53:28Z",
    "labels": [
        "component: graph theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Graph constructor forgets vertex labels",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14504",
    "user": "https://github.com/vbraun"
}
```
Assignee: jason, ncohen, rlm


```
sage: g = Graph()
sage: g.add_vertex(0)
sage: g.set_vertex(0, 'foo')
sage: g.get_vertices()
{0: 'foo'}
sage: Graph(g).get_vertices()
{0: None}
```

Edge labels are remembered, though:

```
sage: g.add_vertex(1)
sage: g.add_edge(0,1, 'bar')
sage: g.edges()
[(0, 1, 'bar')]
sage: Graph(g).edges()
[(0, 1, 'bar')]
```


Issue created by migration from https://trac.sagemath.org/ticket/14708





---

archive/issue_comments_183524.json:
```json
{
    "body": "I'm also totally confused about what `set_vertex()` is supposed to achieve. Vertices are already some object. Then you can associate another object to the vertex object. How is that different to just using a pair `(object1, object2)` as vertex?",
    "created_at": "2013-06-10T13:29:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183524",
    "user": "https://github.com/vbraun"
}
```

I'm also totally confused about what `set_vertex()` is supposed to achieve. Vertices are already some object. Then you can associate another object to the vertex object. How is that different to just using a pair `(object1, object2)` as vertex?



---

archive/issue_comments_183525.json:
```json
{
    "body": "Somewhat related:\n\n```\nsage: g = Graph()\nsage: g.set_vertex('foo', 'bar')\nsage: g.get_vertices()\n{}\n```\n\nOk, I would have expected a ValueError when calling `set_vertex()`. But fine, lets continue...\n\n```\nsage: g.add_vertex('foo')\nsage: g.get_vertices()\n{'foo': 'bar'}\n```\n\nwat?",
    "created_at": "2013-06-10T13:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183525",
    "user": "https://github.com/vbraun"
}
```

Somewhat related:

```
sage: g = Graph()
sage: g.set_vertex('foo', 'bar')
sage: g.get_vertices()
{}
```

Ok, I would have expected a ValueError when calling `set_vertex()`. But fine, lets continue...

```
sage: g.add_vertex('foo')
sage: g.get_vertices()
{'foo': 'bar'}
```

wat?



---

archive/issue_comments_183526.json:
```json
{
    "body": "I think that these \"vertex labels\" are meant to associate non-hashable values to a vertex (whose name must be hashable).\n\nI never used it, I also think that it is useless (just use an external dictionary..) and that we would be better without it.\n\nNathann",
    "created_at": "2013-06-11T12:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183526",
    "user": "https://github.com/nathanncohen"
}
```

I think that these "vertex labels" are meant to associate non-hashable values to a vertex (whose name must be hashable).

I never used it, I also think that it is useless (just use an external dictionary..) and that we would be better without it.

Nathann



---

archive/issue_comments_183527.json:
```json
{
    "body": "I would like to address the issue raised in the comments section.\n\nThis is the source code for the ***set_vertex()*** function for generic graphs\n\n\n```python\ndef set_vertex(self, vertex, object):\n    if hasattr(self, '_assoc') is False:\n        self._assoc = {}\n\n    self._assoc[vertex] = object\n```\n\n\nSince _assoc is a dictionary, even if the vertex isn't added beforehand (as in the example demonstrated in the comments section), the dictionary adds an entry into it. For example,\n\n```python\n>>> vert = {}\n>>> vert['foo'] = 'bar'\n>>> vert\n{'foo': 'bar'}\n```\n\n\nBut we are adding a new vertex only on the call of the method ***_backend.add_vertex()*** in the graph. Hence, on calling the method ***get_vertices()***, 'foo' was not displayed.\n\nBut remember that **_alloc** already has the dictionary entry {*foo*: *bar*}. So once the method ***add_vertex('foo')*** is called, the entry *foo* is added to the list of vertices in the graph, and so on calling get_vertices, the entry {*foo*: *bar*} is displayed.",
    "created_at": "2019-03-02T18:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183527",
    "user": "https://github.com/Rithesh17"
}
```

I would like to address the issue raised in the comments section.

This is the source code for the ***set_vertex()*** function for generic graphs


```python
def set_vertex(self, vertex, object):
    if hasattr(self, '_assoc') is False:
        self._assoc = {}

    self._assoc[vertex] = object
```


Since _assoc is a dictionary, even if the vertex isn't added beforehand (as in the example demonstrated in the comments section), the dictionary adds an entry into it. For example,

```python
>>> vert = {}
>>> vert['foo'] = 'bar'
>>> vert
{'foo': 'bar'}
```


But we are adding a new vertex only on the call of the method ***_backend.add_vertex()*** in the graph. Hence, on calling the method ***get_vertices()***, 'foo' was not displayed.

But remember that **_alloc** already has the dictionary entry {*foo*: *bar*}. So once the method ***add_vertex('foo')*** is called, the entry *foo* is added to the list of vertices in the graph, and so on calling get_vertices, the entry {*foo*: *bar*} is displayed.



---

archive/issue_comments_183528.json:
```json
{
    "body": "The issue in the comments is addressed in [https://trac.sagemath.org/ticket/27399](https://trac.sagemath.org/ticket/27399)",
    "created_at": "2019-03-02T18:56:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183528",
    "user": "https://github.com/Rithesh17"
}
```

The issue in the comments is addressed in [https://trac.sagemath.org/ticket/27399](https://trac.sagemath.org/ticket/27399)



---

archive/issue_comments_183529.json:
```json
{
    "body": "Are you also planning to work on the other issue: copy of vertex labels when calling `Graph(g)` or `DiGraph(g)` ?\n\nIf so, there is a minor improvement to do in `get_vertices`: no need to build the list of vertices. So\n\n```diff\n-        if verts is None:\n-            verts = list(self)\n+        if verts is None:\n+            verts = self\n```\n",
    "created_at": "2019-03-06T17:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183529",
    "user": "https://github.com/dcoudert"
}
```

Are you also planning to work on the other issue: copy of vertex labels when calling `Graph(g)` or `DiGraph(g)` ?

If so, there is a minor improvement to do in `get_vertices`: no need to build the list of vertices. So

```diff
-        if verts is None:
-            verts = list(self)
+        if verts is None:
+            verts = self
```




---

archive/issue_comments_183530.json:
```json
{
    "body": "This solution did not work. The problem still persist\n\n```\nsage: g.set_vertex(0, 'foo')\nsage: g.get_vertices()\n{0: 'foo', 1: None, 2: None, 3: None, 4: None}\nsage: Graph(g).get_vertices()\n{0: None, 1: None, 2: None, 3: None, 4: None}\n```\n\nI think the problem is in not communicating the labels of vertices in `g` to `Graph(g)`.\n\nIf we look at the `.set_vertex` method, we have\n\n```\nself._assoc[vertex] = object\n```\n\nwhich, I believe, is not being transferred to Graph(g). On the other hand, in the `.set_edge_label` method, we have\n\n```\nself._backend.set_edge_label(u, v, l, self._directed)\n```\n\nI am not yet sure how these two different implementations affect Graph(g), but edge labels are retained in Graph(g) but not vertex labels",
    "created_at": "2019-03-06T19:21:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183530",
    "user": "https://github.com/Rithesh17"
}
```

This solution did not work. The problem still persist

```
sage: g.set_vertex(0, 'foo')
sage: g.get_vertices()
{0: 'foo', 1: None, 2: None, 3: None, 4: None}
sage: Graph(g).get_vertices()
{0: None, 1: None, 2: None, 3: None, 4: None}
```

I think the problem is in not communicating the labels of vertices in `g` to `Graph(g)`.

If we look at the `.set_vertex` method, we have

```
self._assoc[vertex] = object
```

which, I believe, is not being transferred to Graph(g). On the other hand, in the `.set_edge_label` method, we have

```
self._backend.set_edge_label(u, v, l, self._directed)
```

I am not yet sure how these two different implementations affect Graph(g), but edge labels are retained in Graph(g) but not vertex labels



---

archive/issue_comments_183531.json:
```json
{
    "body": "And this is one more thing I've found: if `g` has multiple edges and loops, then `Graph(g)` allows loops but not multiple edges. But `Graph(g.edges())` allows both (with a warning to set `multiedges` flag to `True`).\n\n\n```\nsage: g = digraphs.DeBruijn(2,2)\nsage: g1 = Graph(g)\nsage: g1.edges()\n[('00', '00', '0'),\n ('00', '01', '1'),\n ('00', '10', '0'),\n ('01', '10', '0'),\n ('01', '11', '1'),\n ('10', '11', '0'),\n ('11', '11', '1')]\nsage: g2 = Graph(g.edges())\nsage: g2.edges()\n[('00', '00', '0'),\n ('00', '01', '1'),\n ('00', '10', '0'),\n ('01', '10', '0'),\n ('01', '10', '1'),\n ('01', '11', '1'),\n ('10', '11', '0'),\n ('11', '11', '1')]\n```\n",
    "created_at": "2019-03-06T19:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183531",
    "user": "https://github.com/Rithesh17"
}
```

And this is one more thing I've found: if `g` has multiple edges and loops, then `Graph(g)` allows loops but not multiple edges. But `Graph(g.edges())` allows both (with a warning to set `multiedges` flag to `True`).


```
sage: g = digraphs.DeBruijn(2,2)
sage: g1 = Graph(g)
sage: g1.edges()
[('00', '00', '0'),
 ('00', '01', '1'),
 ('00', '10', '0'),
 ('01', '10', '0'),
 ('01', '11', '1'),
 ('10', '11', '0'),
 ('11', '11', '1')]
sage: g2 = Graph(g.edges())
sage: g2.edges()
[('00', '00', '0'),
 ('00', '01', '1'),
 ('00', '10', '0'),
 ('01', '10', '0'),
 ('01', '10', '1'),
 ('01', '11', '1'),
 ('10', '11', '0'),
 ('11', '11', '1')]
```




---

archive/issue_comments_183532.json:
```json
{
    "body": "When calling `Graph(g)`, the constructor gives the same settings for loops and multiple edges to the resulting graph than `g`, and here, the digraph `g` has loops but no multiple edges. Hence the returned graph has no multiple edges.\n\nWhen a list of edges is given as input, we get a deprecation warning and the constructor sets parameter for multiple edges to True if necessary, but this behavior will soon be changed to False unless the user specifies `multiedges=True`.",
    "created_at": "2019-03-07T07:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183532",
    "user": "https://github.com/dcoudert"
}
```

When calling `Graph(g)`, the constructor gives the same settings for loops and multiple edges to the resulting graph than `g`, and here, the digraph `g` has loops but no multiple edges. Hence the returned graph has no multiple edges.

When a list of edges is given as input, we get a deprecation warning and the constructor sets parameter for multiple edges to True if necessary, but this behavior will soon be changed to False unless the user specifies `multiedges=True`.



---

archive/issue_comments_183533.json:
```json
{
    "body": "Oh ok Sir. Anything suggestions on comment 13?",
    "created_at": "2019-03-07T15:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183533",
    "user": "https://github.com/Rithesh17"
}
```

Oh ok Sir. Anything suggestions on comment 13?



---

archive/issue_comments_183534.json:
```json
{
    "body": "Replying to [comment:15 gh-Rithesh17]:\n> Oh ok Sir. Anything suggestions on comment 13?\n\nThe current behavior is the right one. So nothing to do for #comment:13.\n\nThere is however something to do for #comment:11",
    "created_at": "2019-03-07T15:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183534",
    "user": "https://github.com/dcoudert"
}
```

Replying to [comment:15 gh-Rithesh17]:
> Oh ok Sir. Anything suggestions on comment 13?

The current behavior is the right one. So nothing to do for #comment:13.

There is however something to do for #comment:11



---

archive/issue_comments_183535.json:
```json
{
    "body": "Sorry Sir. I meant any suggestion on comment 12.",
    "created_at": "2019-03-07T15:36:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183535",
    "user": "https://github.com/Rithesh17"
}
```

Sorry Sir. I meant any suggestion on comment 12.



---

archive/issue_comments_183536.json:
```json
{
    "body": "Check the `Graph` and `DiGraph` constructors.",
    "created_at": "2019-03-08T17:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183536",
    "user": "https://github.com/dcoudert"
}
```

Check the `Graph` and `DiGraph` constructors.



---

archive/issue_comments_183537.json:
```json
{
    "body": "I went through the `__init__` constructa of both `Graph` and `DiGraph` classes and found this line in both of them:\n\n```python\nself.add_vertices(data.vertex_iterator())\nself.add_edges(data.edge_iterator())\n```\n\nNow in the `vertex_iterator` there is no field for the labels\n\n```sage\nsage: g = digraphs.DeBruijn(2,2)\nsage: for v in g.vertex_iterator():\n....:     print(v)\n....:     \n11\n10\n00\n01\n```\n\nBut the labels are displayed in the case of `edge_iterator`\n\n```sage\nsage: for v in g.edge_iterator():\n....:     print(v)\n....:     \n('11', '10', '0')\n('11', '11', '1')\n('10', '00', '0')\n('10', '01', '1')\n('00', '00', '0')\n('00', '01', '1')\n('01', '10', '0')\n('01', '11', '1')\n```\n\nIf we need to modify into the `vertex_iterator` method. we must change the back-end code.\n\n```python\ndef vertex_iterator(self, vertices=None):\n    return self._backend.iterator_verts(vertices)\n```\n\nI'll have to look into the Pyrex file `basic/c_graph.pyx` to modify `_backend.iterator_verts(vertices)`, but can I do it? I generally would not like to touch the backend files because there could be many more methods using it",
    "created_at": "2019-03-09T10:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183537",
    "user": "https://github.com/Rithesh17"
}
```

I went through the `__init__` constructa of both `Graph` and `DiGraph` classes and found this line in both of them:

```python
self.add_vertices(data.vertex_iterator())
self.add_edges(data.edge_iterator())
```

Now in the `vertex_iterator` there is no field for the labels

```sage
sage: g = digraphs.DeBruijn(2,2)
sage: for v in g.vertex_iterator():
....:     print(v)
....:     
11
10
00
01
```

But the labels are displayed in the case of `edge_iterator`

```sage
sage: for v in g.edge_iterator():
....:     print(v)
....:     
('11', '10', '0')
('11', '11', '1')
('10', '00', '0')
('10', '01', '1')
('00', '00', '0')
('00', '01', '1')
('01', '10', '0')
('01', '11', '1')
```

If we need to modify into the `vertex_iterator` method. we must change the back-end code.

```python
def vertex_iterator(self, vertices=None):
    return self._backend.iterator_verts(vertices)
```

I'll have to look into the Pyrex file `basic/c_graph.pyx` to modify `_backend.iterator_verts(vertices)`, but can I do it? I generally would not like to touch the backend files because there could be many more methods using it



---

archive/issue_comments_183538.json:
```json
{
    "body": "Please don't change the backend.\n\nWhat you must do is simply add `self.set_vertices(data.get_vertices())` at the right place in the `__init__` methods.",
    "created_at": "2019-03-09T10:35:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183538",
    "user": "https://github.com/dcoudert"
}
```

Please don't change the backend.

What you must do is simply add `self.set_vertices(data.get_vertices())` at the right place in the `__init__` methods.



---

archive/issue_comments_183539.json:
```json
{
    "body": "Yeah. That's a simpler solution.\n\nI had to also modify `to_undirected` method in DiGraphs and `to_directed` method in Graphs to support vertex labels. And now it is working.\n\n\n```\nsage: g = Graph()\nsage: g.add_vertex(0)\nsage: g.set_vertex(0, 'foo')\nsage: g.get_vertices()\n{0: 'foo'}\nsage: Graph(g).get_vertices()\n{0: 'foo'}\n```\n\nDo I need to add a doctest for this?",
    "created_at": "2019-03-09T11:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183539",
    "user": "https://github.com/Rithesh17"
}
```

Yeah. That's a simpler solution.

I had to also modify `to_undirected` method in DiGraphs and `to_directed` method in Graphs to support vertex labels. And now it is working.


```
sage: g = Graph()
sage: g.add_vertex(0)
sage: g.set_vertex(0, 'foo')
sage: g.get_vertices()
{0: 'foo'}
sage: Graph(g).get_vertices()
{0: 'foo'}
```

Do I need to add a doctest for this?



---

archive/issue_comments_183540.json:
```json
{
    "body": "Yes, you need to add a doctest with a pointer to this ticket, i.e., `:trac:`14708``",
    "created_at": "2019-03-09T17:50:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183540",
    "user": "https://github.com/dcoudert"
}
```

Yes, you need to add a doctest with a pointer to this ticket, i.e., `:trac:`14708``



---

archive/issue_comments_183541.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-03-11T05:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183541",
    "user": "https://github.com/Rithesh17"
}
```

New commits:



---

archive/issue_comments_183542.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-03-11T05:05:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183542",
    "user": "https://github.com/Rithesh17"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_183543.json:
```json
{
    "body": "Can you change the first example in digraph.py to only `DiGraph`, so\n\n```diff\n-            sage: g = Graph()\n+            sage: g = DiGraph()\n```\n\nAlso, add ` (:trac:`14708`)` to each of the added doctests.",
    "created_at": "2019-03-11T08:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183543",
    "user": "https://github.com/dcoudert"
}
```

Can you change the first example in digraph.py to only `DiGraph`, so

```diff
-            sage: g = Graph()
+            sage: g = DiGraph()
```

Also, add ` (:trac:`14708`)` to each of the added doctests.



---

archive/issue_comments_183544.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-03-11T09:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183544",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_183545.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-04-22T10:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183545",
    "user": "https://github.com/dcoudert"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_183546.json:
```json
{
    "body": "Just tested it over 8.8.beta3. LGTM.",
    "created_at": "2019-04-22T10:04:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183546",
    "user": "https://github.com/dcoudert"
}
```

Just tested it over 8.8.beta3. LGTM.



---

archive/issue_comments_183547.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-27T17:44:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14504#issuecomment-183547",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_014266.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-04-27T17:44:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14504",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14504#event-14266"
}
```
