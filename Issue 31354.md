# Issue 31354: Expose MemoryAllocator as python package

Issue created by migration from https://trac.sagemath.org/ticket/31591

Original creator: @kliem

Original creation time: 2021-04-01 16:10:08

CC:  vdelecroix mkoeppe embray tscrim

`MemoryAllocator` doesn't rely on anything in sage, hence we expose it as independet python package. It can be useful for other cython projects.

In order to remove the dependency on `cysignals`, which at the moment doesn't work on windows without cygwin, we remove `sig_block`/`sig_unblock` from the allocation. The seems not harmful as the allocation via `MemoryAllocator` should not be called within `sig_on`/`sig_off` anyway.


---

Comment by @kliem created at 2021-04-01 19:50:35

New commits:


---

Comment by @kliem created at 2021-04-01 19:51:34

Sorry, back to modified description.


---

Comment by @kliem created at 2021-04-01 19:52:46

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-04-01 21:56:36

The python package will need a `pyproject.toml`, in which you declare the build dependency on Cython


---

Comment by @kliem created at 2021-04-02 12:29:58

Replying to [comment:6 mkoeppe]:
> The python package will need a `pyproject.toml`, in which you declare the build dependency on Cython

https://github.com/kliem/memory_allocator/blob/main/pyproject.toml:


```
[build-system]
requires = ["setuptools", "wheel", "Cython"]
build-backend = "setuptools.build_meta"
```


I more or less copied it from pplpy.


---

Comment by tscrim created at 2021-05-26 05:44:45

Your SPKG file needs a bit more information. Also, even though this already is a part of Sage, we should check on sage-devel to confirm there are no objections to short-circuiting adding a new standard package.


---

Comment by dimpase created at 2021-05-26 10:24:48

you have an invitation to Sagemath github "team"; once a member, you'd be able to transfer ownership to `sagemath`

I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.


---

Comment by git created at 2021-05-27 13:58:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-27 13:59:37

Replying to [comment:10 dimpase]:
> you have an invitation to Sagemath github "team"; once a member, you'd be able to transfer ownership to `sagemath`
> 
> I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.

Thank you Dima for setting this up. I also imported the history of `memory_allocator/memory.pxd`, which was just stolen from `cysignals`.


---

Comment by @kliem created at 2021-05-27 14:02:02

Replying to [comment:10 dimpase]:
> you have an invitation to Sagemath github "team"; once a member, you'd be able to transfer ownership to `sagemath`
> 
> I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.

I added dependencies and updated the links. What else is missing?

Note that the project is not on PyPi yet. I'm waiting for an ok of someone, that the prerelease is somewhat acceptable.


---

Comment by git created at 2021-05-27 14:11:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-05-27 14:18:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-05-27 14:21:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-05-27 14:22:52

Sorry about the mess...


---

Comment by dimpase created at 2021-06-02 12:08:47

there is something silly going on with the versions, I guess, I get

```
$ less logs/pkgs/memory_allocator-0.1.0-beta.1.log
Error: Installing old-style SPKGs is no longer supported
```



---

Comment by dimpase created at 2021-06-02 12:51:42

it is due to missing `tarball=...` line in `checksums.ini`


---

Comment by dimpase created at 2021-06-02 13:00:29

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2021-06-02 13:00:29

OK, it installis after 


```diff
diff --git a/build/pkgs/memory_allocator/checksums.ini b/build/pkgs/memory_allocator/checksums.ini
index 14e6cf2a2b..fb9511de83 100644
--- a/build/pkgs/memory_allocator/checksums.ini
+++ b/build/pkgs/memory_allocator/checksums.ini
@@ -1,3 +1,4 @@
+tarball=memory_allocator--VERSION.tar.gz
 sha1=d0eeb3be4462a41b316086a33f4dfbca08b887b4
 md5=74c8a21dd6e79452bae99881d40ab2f9
 cksum=3681970071
diff --git a/build/pkgs/memory_allocator/spkg-install.in b/build/pkgs/memory_allocator/spkg-install.in
index deba1bb42b..058b1344dc 100644
--- a/build/pkgs/memory_allocator/spkg-install.in
+++ b/build/pkgs/memory_allocator/spkg-install.in
@@ -1 +1,3 @@
-cd src && sdh_pip_install .
+cd src
+
+sdh_pip_install .
```


I have also added

```
$ cat build/pkgs/memory_allocator/install-requires.txt
memory_allocator
```



---

Comment by git created at 2021-06-02 14:34:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-06-02 14:34:32

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-06-02 16:28:33

Let's please use a pypi URL in `upstream_url`. For example, use `./sage -package create memory_allocator --pypi --type standard`


---

Comment by git created at 2021-06-02 20:01:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2021-06-02 20:07:33

Replying to [comment:24 mkoeppe]:
> Let's please use a pypi URL in `upstream_url`. For example, use `./sage -package create memory_allocator --pypi --type standard`

That was the plan all along. I was just unsure of whether this was ready to push on pypi. But then again, one can always to a version 0.1.0, if needed.


---

Comment by mkoeppe created at 2021-06-02 20:54:57

The upstream url in the format that the other packages use is better because it will make upgrades easier


---

Comment by dimpase created at 2021-06-02 22:41:03

otherwise, alles gut


---

Comment by dimpase created at 2021-06-02 22:41:03

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2021-06-03 00:03:34

Might make sense to advertise this new package
on the [cython-users mailing list](https://groups.google.com/g/cython-users).


---

Comment by git created at 2021-06-03 05:28:29

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-06-03 05:28:29

Changing status from positive_review to needs_review.


---

Comment by @kliem created at 2021-06-03 05:28:56

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2021-06-03 07:05:17

Replying to [comment:29 dimpase]:
> otherwise, alles gut

Thank you.

I updated the url and wrote a brief advertisment on the cython-users mailing list.


---

Comment by slelievre created at 2021-06-03 21:19:46

Replying to [comment:33 gh-kliem]:
> 
> I updated the url and wrote a brief
> advertisement on the cython-users mailing list.

For reference the post on cython-users is at:

- https://groups.google.com/g/cython-users/c/G1AHva1zlbQ


---

Comment by vbraun created at 2021-06-19 20:58:29

Resolution: fixed
