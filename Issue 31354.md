# Issue 31354: Expose MemoryAllocator as python package

archive/issues_031354.json:
```json
{
    "body": "CC:  @videlec @mkoeppe @embray @tscrim\n\n`MemoryAllocator` doesn't rely on anything in sage, hence we expose it as independet python package. It can be useful for other cython projects.\n\nIn order to remove the dependency on `cysignals`, which at the moment doesn't work on windows without cygwin, we remove `sig_block`/`sig_unblock` from the allocation. The seems not harmful as the allocation via `MemoryAllocator` should not be called within `sig_on`/`sig_off` anyway.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31591\n\n",
    "created_at": "2021-04-01T16:10:08Z",
    "labels": [
        "cython",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.4",
    "title": "Expose MemoryAllocator as python package",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31354",
    "user": "@kliem"
}
```
CC:  @videlec @mkoeppe @embray @tscrim

`MemoryAllocator` doesn't rely on anything in sage, hence we expose it as independet python package. It can be useful for other cython projects.

In order to remove the dependency on `cysignals`, which at the moment doesn't work on windows without cygwin, we remove `sig_block`/`sig_unblock` from the allocation. The seems not harmful as the allocation via `MemoryAllocator` should not be called within `sig_on`/`sig_off` anyway.

Issue created by migration from https://trac.sagemath.org/ticket/31591





---

archive/issue_comments_448648.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-01T19:50:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448648",
    "user": "@kliem"
}
```

New commits:



---

archive/issue_comments_448649.json:
```json
{
    "body": "Sorry, back to modified description.",
    "created_at": "2021-04-01T19:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448649",
    "user": "@kliem"
}
```

Sorry, back to modified description.



---

archive/issue_comments_448650.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-01T19:52:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448650",
    "user": "@kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_448651.json:
```json
{
    "body": "The python package will need a `pyproject.toml`, in which you declare the build dependency on Cython",
    "created_at": "2021-04-01T21:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448651",
    "user": "@mkoeppe"
}
```

The python package will need a `pyproject.toml`, in which you declare the build dependency on Cython



---

archive/issue_comments_448652.json:
```json
{
    "body": "Replying to [comment:6 mkoeppe]:\n> The python package will need a `pyproject.toml`, in which you declare the build dependency on Cython\n\nhttps://github.com/kliem/memory_allocator/blob/main/pyproject.toml:\n\n\n```\n[build-system]\nrequires = [\"setuptools\", \"wheel\", \"Cython\"]\nbuild-backend = \"setuptools.build_meta\"\n```\n\n\nI more or less copied it from pplpy.",
    "created_at": "2021-04-02T12:29:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448652",
    "user": "@kliem"
}
```

Replying to [comment:6 mkoeppe]:
> The python package will need a `pyproject.toml`, in which you declare the build dependency on Cython

https://github.com/kliem/memory_allocator/blob/main/pyproject.toml:


```
[build-system]
requires = ["setuptools", "wheel", "Cython"]
build-backend = "setuptools.build_meta"
```


I more or less copied it from pplpy.



---

archive/issue_comments_448653.json:
```json
{
    "body": "Your SPKG file needs a bit more information. Also, even though this already is a part of Sage, we should check on sage-devel to confirm there are no objections to short-circuiting adding a new standard package.",
    "created_at": "2021-05-26T05:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448653",
    "user": "@tscrim"
}
```

Your SPKG file needs a bit more information. Also, even though this already is a part of Sage, we should check on sage-devel to confirm there are no objections to short-circuiting adding a new standard package.



---

archive/issue_comments_448654.json:
```json
{
    "body": "you have an invitation to Sagemath github \"team\"; once a member, you'd be able to transfer ownership to `sagemath`\n\nI also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.",
    "created_at": "2021-05-26T10:24:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448654",
    "user": "@dimpase"
}
```

you have an invitation to Sagemath github "team"; once a member, you'd be able to transfer ownership to `sagemath`

I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.



---

archive/issue_comments_448655.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-27T13:58:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448655",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448656.json:
```json
{
    "body": "Replying to [comment:10 dimpase]:\n> you have an invitation to Sagemath github \"team\"; once a member, you'd be able to transfer ownership to `sagemath`\n> \n> I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.\n\nThank you Dima for setting this up. I also imported the history of `memory_allocator/memory.pxd`, which was just stolen from `cysignals`.",
    "created_at": "2021-05-27T13:59:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448656",
    "user": "@kliem"
}
```

Replying to [comment:10 dimpase]:
> you have an invitation to Sagemath github "team"; once a member, you'd be able to transfer ownership to `sagemath`
> 
> I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.

Thank you Dima for setting this up. I also imported the history of `memory_allocator/memory.pxd`, which was just stolen from `cysignals`.



---

archive/issue_comments_448657.json:
```json
{
    "body": "Replying to [comment:10 dimpase]:\n> you have an invitation to Sagemath github \"team\"; once a member, you'd be able to transfer ownership to `sagemath`\n> \n> I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.\n\nI added dependencies and updated the links. What else is missing?\n\nNote that the project is not on PyPi yet. I'm waiting for an ok of someone, that the prerelease is somewhat acceptable.",
    "created_at": "2021-05-27T14:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448657",
    "user": "@kliem"
}
```

Replying to [comment:10 dimpase]:
> you have an invitation to Sagemath github "team"; once a member, you'd be able to transfer ownership to `sagemath`
> 
> I also noted in an issue on your repo that one should import there the full history of the code taken out of sagemath.

I added dependencies and updated the links. What else is missing?

Note that the project is not on PyPi yet. I'm waiting for an ok of someone, that the prerelease is somewhat acceptable.



---

archive/issue_comments_448658.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-27T14:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448658",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448659.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-05-27T14:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448659",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_448660.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-05-27T14:21:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448660",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448661.json:
```json
{
    "body": "Sorry about the mess...",
    "created_at": "2021-05-27T14:22:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448661",
    "user": "@kliem"
}
```

Sorry about the mess...



---

archive/issue_comments_448662.json:
```json
{
    "body": "there is something silly going on with the versions, I guess, I get\n\n```\n$ less logs/pkgs/memory_allocator-0.1.0-beta.1.log\nError: Installing old-style SPKGs is no longer supported\n```\n",
    "created_at": "2021-06-02T12:08:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448662",
    "user": "@dimpase"
}
```

there is something silly going on with the versions, I guess, I get

```
$ less logs/pkgs/memory_allocator-0.1.0-beta.1.log
Error: Installing old-style SPKGs is no longer supported
```




---

archive/issue_comments_448663.json:
```json
{
    "body": "it is due to missing `tarball=...` line in `checksums.ini`",
    "created_at": "2021-06-02T12:51:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448663",
    "user": "@dimpase"
}
```

it is due to missing `tarball=...` line in `checksums.ini`



---

archive/issue_comments_448664.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-02T13:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448664",
    "user": "@dimpase"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_448665.json:
```json
{
    "body": "OK, it installis after \n\n\n```diff\ndiff --git a/build/pkgs/memory_allocator/checksums.ini b/build/pkgs/memory_allocator/checksums.ini\nindex 14e6cf2a2b..fb9511de83 100644\n--- a/build/pkgs/memory_allocator/checksums.ini\n+++ b/build/pkgs/memory_allocator/checksums.ini\n@@ -1,3 +1,4 @@\n+tarball=memory_allocator--VERSION.tar.gz\n sha1=d0eeb3be4462a41b316086a33f4dfbca08b887b4\n md5=74c8a21dd6e79452bae99881d40ab2f9\n cksum=3681970071\ndiff --git a/build/pkgs/memory_allocator/spkg-install.in b/build/pkgs/memory_allocator/spkg-install.in\nindex deba1bb42b..058b1344dc 100644\n--- a/build/pkgs/memory_allocator/spkg-install.in\n+++ b/build/pkgs/memory_allocator/spkg-install.in\n@@ -1 +1,3 @@\n-cd src && sdh_pip_install .\n+cd src\n+\n+sdh_pip_install .\n```\n\n\nI have also added\n\n```\n$ cat build/pkgs/memory_allocator/install-requires.txt\nmemory_allocator\n```\n",
    "created_at": "2021-06-02T13:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448665",
    "user": "@dimpase"
}
```

OK, it installis after 


```diff
diff --git a/build/pkgs/memory_allocator/checksums.ini b/build/pkgs/memory_allocator/checksums.ini
index 14e6cf2a2b..fb9511de83 100644
--- a/build/pkgs/memory_allocator/checksums.ini
+++ b/build/pkgs/memory_allocator/checksums.ini
@@ -1,3 +1,4 @@
+tarball=memory_allocator--VERSION.tar.gz
 sha1=d0eeb3be4462a41b316086a33f4dfbca08b887b4
 md5=74c8a21dd6e79452bae99881d40ab2f9
 cksum=3681970071
diff --git a/build/pkgs/memory_allocator/spkg-install.in b/build/pkgs/memory_allocator/spkg-install.in
index deba1bb42b..058b1344dc 100644
--- a/build/pkgs/memory_allocator/spkg-install.in
+++ b/build/pkgs/memory_allocator/spkg-install.in
@@ -1 +1,3 @@
-cd src && sdh_pip_install .
+cd src
+
+sdh_pip_install .
```


I have also added

```
$ cat build/pkgs/memory_allocator/install-requires.txt
memory_allocator
```




---

archive/issue_comments_448666.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-02T14:34:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448666",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448667.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-02T14:34:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448667",
    "user": "@kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_448668.json:
```json
{
    "body": "Let's please use a pypi URL in `upstream_url`. For example, use `./sage -package create memory_allocator --pypi --type standard`",
    "created_at": "2021-06-02T16:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448668",
    "user": "@mkoeppe"
}
```

Let's please use a pypi URL in `upstream_url`. For example, use `./sage -package create memory_allocator --pypi --type standard`



---

archive/issue_comments_448669.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-02T20:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448669",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_448670.json:
```json
{
    "body": "Replying to [comment:24 mkoeppe]:\n> Let's please use a pypi URL in `upstream_url`. For example, use `./sage -package create memory_allocator --pypi --type standard`\n\nThat was the plan all along. I was just unsure of whether this was ready to push on pypi. But then again, one can always to a version 0.1.0, if needed.",
    "created_at": "2021-06-02T20:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448670",
    "user": "@kliem"
}
```

Replying to [comment:24 mkoeppe]:
> Let's please use a pypi URL in `upstream_url`. For example, use `./sage -package create memory_allocator --pypi --type standard`

That was the plan all along. I was just unsure of whether this was ready to push on pypi. But then again, one can always to a version 0.1.0, if needed.



---

archive/issue_comments_448671.json:
```json
{
    "body": "The upstream url in the format that the other packages use is better because it will make upgrades easier",
    "created_at": "2021-06-02T20:54:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448671",
    "user": "@mkoeppe"
}
```

The upstream url in the format that the other packages use is better because it will make upgrades easier



---

archive/issue_comments_448672.json:
```json
{
    "body": "otherwise, alles gut",
    "created_at": "2021-06-02T22:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448672",
    "user": "@dimpase"
}
```

otherwise, alles gut



---

archive/issue_comments_448673.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-02T22:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448673",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448674.json:
```json
{
    "body": "Might make sense to advertise this new package\non the [cython-users mailing list](https://groups.google.com/g/cython-users).",
    "created_at": "2021-06-03T00:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448674",
    "user": "@slel"
}
```

Might make sense to advertise this new package
on the [cython-users mailing list](https://groups.google.com/g/cython-users).



---

archive/issue_comments_448675.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-06-03T05:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448675",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_448676.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-06-03T05:28:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448676",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_448677.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-03T05:28:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448677",
    "user": "@kliem"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_448678.json:
```json
{
    "body": "Replying to [comment:29 dimpase]:\n> otherwise, alles gut\n\nThank you.\n\nI updated the url and wrote a brief advertisment on the cython-users mailing list.",
    "created_at": "2021-06-03T07:05:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448678",
    "user": "@kliem"
}
```

Replying to [comment:29 dimpase]:
> otherwise, alles gut

Thank you.

I updated the url and wrote a brief advertisment on the cython-users mailing list.



---

archive/issue_comments_448679.json:
```json
{
    "body": "Replying to [comment:33 gh-kliem]:\n> \n> I updated the url and wrote a brief\n> advertisement on the cython-users mailing list.\n\nFor reference the post on cython-users is at:\n\n- https://groups.google.com/g/cython-users/c/G1AHva1zlbQ",
    "created_at": "2021-06-03T21:19:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448679",
    "user": "@slel"
}
```

Replying to [comment:33 gh-kliem]:
> 
> I updated the url and wrote a brief
> advertisement on the cython-users mailing list.

For reference the post on cython-users is at:

- https://groups.google.com/g/cython-users/c/G1AHva1zlbQ



---

archive/issue_comments_448680.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-19T20:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31354",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31354#issuecomment-448680",
    "user": "@vbraun"
}
```

Resolution: fixed
