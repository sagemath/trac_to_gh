# Issue 15739: IntegerLattice class

Issue created by migration from https://trac.sagemath.org/ticket/15976

Original creator: malb

Original creation time: 2014-03-19 16:28:48

This ticket implements sage.lattices.integer_lattice.IntegerLattice which represents a discrete subgroup of ZZ<sup>n</sup>.

This class is inspired by #15955 but except for the voronoi cell implementation, it is implemented anew from scratch.

This ticket also includes an updated interface to fpLLL which uses Cython's C++ features, uses the fpLLL 4.0 API and interfaces not only with LLL but also with fpLLL's BKZ and shortest vector enumeration.



---

Comment by malb created at 2014-03-19 16:29:40

New commits:


---

Comment by git created at 2014-03-19 17:09:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-19 17:38:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-20 12:59:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-03-20 13:01:34

Changing status from new to needs_review.


---

Comment by SimonKing created at 2014-03-20 15:34:27

Hi Martin!

You asked me to have a look at your code from the categorical point of view.

It really depends what you want to model.

Currently, you start on top of `SageObject`, which is about as basic as it can be. A `SageObject` hasn't even support for different categories. So, if for you a lattice is not more than an object, then it's fine.

A bit less basic is `CategoryObject`, which is for objects in arbitrary categories. In particular, it would be a suitable starting point for objects that do not have elements (i.e., whose category is not a sub-category of the category of sets). So, if you want that your lattice is a semigroup, but you do not want to implement elements of the semigroup, then it's fine---almost. AFAIK, it _is_ mathematically possible to define the notion of a semigroup just in terms of morphisms and direct products, and it is not needed to refer to elements in the definition. However, Sage's category framework expects semigroups to be sets, and thus the `TestSuite` would complain that element creation fails.

If your lattices are supposed to be groups (in particular, sets), then the lattice should inherit from `Parent`, and you should implement elements as well, inheriting from `Element` (or rather `ModuleElement`, since you want to add elements). I guess it would be fine to import some implementation of integer vectors (I am sure those things exist somewhere in Sage), and assign it as a class attribute `IntegerLattice.Element`.

Next, _if_ you decide to inherit from `Parent` and assign `.Element`, you should do `self._init_category_(Groups())` (or a better category, if there is any) during initialisation of your lattice. This should be enough to enable element creation and let the test suites (`TestSuite(YourLattice).run()`) pass. If it isn't---well, then we'll take care of it later.

It could make sense to have a look at `sage.combinat.free_module.CombinatorialFreeModule` and `sage.combinat.free_module.CombinatorialFreeModuleElement`. I have not much experience with it, but I know that people use it to implement all kind of things, including algebras. And it does inherit from `Parent`.

On a different note: Would it make sense to use `UniqueRepresentation` or at least `CachedRepresentation` for lattices? It seems strange to me to have a function `Lattice` that does nothing more than hand the arguments to the `IntegerLattice` constructor and return the result.

Provided that you want some kind of caching for your lattices, you could do

```python
class Lattice(CachedRepresentation, Parent):
    "This is a stub, non-integral lattices will be implemented later"
    Element = some.suitable.VectorClass
    @staticmethod
    def __classcall_private__(cls, basis, lll_reduce):
        # do some preprocessing of arguments, throw
        # an error if the basis is not integral
        return IntegerLattice(preprocessed_basis, lll_reduce)
    def __cmp__(...):
        # We don't inherit from UniqueRepresentation, hence, we admit the
        # possibility that different bases result in the same lattice.
        # Perhaps move this to IntegerLattice, unless the same algorithm
        # would work for general lattices.

class IntegerLattice(Lattice):
    ...
```



---

Comment by malb created at 2014-03-20 21:03:48

Replying to [comment:6 SimonKing]:

Hi Simon,

thanks a lot for your comments!

 
> If your lattices are supposed to be groups (in particular, sets), then the lattice should inherit from `Parent`, and you should implement elements as well, inheriting from `Element` (or rather `ModuleElement`, since you want to add elements). I guess it would be fine to import some implementation of integer vectors (I am sure those things exist somewhere in Sage), and assign it as a class attribute `IntegerLattice.Element`.
> 
> Next, _if_ you decide to inherit from `Parent` and assign `.Element`, you should do `self._init_category_(Groups())` (or a better category, if there is any) during initialisation of your lattice. This should be enough to enable element creation and let the test suites (`TestSuite(YourLattice).run()`) pass. If it isn't---well, then we'll take care of it later.

I tried to go down this route: I inherited from `Parent` and set         `self._init_category_(CommutativeAdditiveGroups())`. The `TestSuite(L).run()` now first complaints that there is no `_an_element_()` which is easily fixable. However, the next complaint is that elements created by `some_element()` do not live in the lattice but in *Z*<sup>n</sup>. I am not sure I want my lattice vectors to live in the lattice, but if I wanted to do that, I'd have to define my lattice as a proper submodule of *Z*<sup>n</sup>? I'd view the lattice somewhat analogously to an ideal in a multivariate ring, would we want our ideal elements to live anywhere but the ring?

> On a different note: Would it make sense to use `UniqueRepresentation` or at least `CachedRepresentation` for lattices? It seems strange to me to have a function `Lattice` that does nothing more than hand the arguments to the `IntegerLattice` constructor and return the result.

I don't want to cache my representations or make lattices unique. It is useful to have two objects representing the same lattice: one with a good basis and one with a bad basis (that's the secret and public key respectively in many crypto systems). I'd expect `Lattice` to grow when the need arises: lattices over *Q*, over *R*, over polynomial rings and stuff.


---

Comment by SimonKing created at 2014-03-21 08:12:32

Replying to [comment:7 malb]:
> However, the next complaint is that elements created by `some_element()` do not live in the lattice but in *Z*<sup>n</sup>. I am not sure I want my lattice vectors to live in the lattice, but if I wanted to do that, I'd have to define my lattice as a proper submodule of *Z*<sup>n</sup>?

There is something called "facade". I didn't try to fully understand it, but I think the idea is: If you have the set of prime numbers, then its elements are just natural numbers. That's to say, the parent of the elements of `Primes()` is `ZZ`, not `Primes()`:

```
sage: P = Primes()
sage: p = P.an_element()
sage: p
43
sage: p.parent()
Integer Ring
```

This is done by telling that `Primes()` is a "facade set":

```
sage: P.category()
Category of facade infinite enumerated sets
```


Your situation could be similar: You have a lattice `L` in `RR^n`, and the parent of the elements of `L` wouldn't be `L` but `RR^n` (but please not `ZZ^n`, since you need the embedding!).

So, could be that using

```
sage: Category.join([FacadeSets(),CommutativeAdditiveGroups()])
Category of facade commutative additive groups
```

to initialise your lattice's category would suffice.

> I'd view the lattice somewhat analogously to an ideal in a multivariate ring, would we want our ideal elements to live anywhere but the ring?

No, see above. But for historical reasons, we have

```
sage: P.<x,y> = QQ[]
sage: I = P*[x^2+y,y^2+x]
sage: x^2 in I
False
sage: x^2+y in I
True
sage: I.category()
Category of ring ideals in Multivariate Polynomial Ring in x, y over Rational Field
```

without facade. I think today it would be implemented using facades.

> I don't want to cache my representations or make lattices unique. It is useful to have two objects representing the same lattice: one with a good basis and one with a bad basis (that's the secret and public key respectively in many crypto systems).

That's why I suggested `CachedRepresentation` rather than `UniqueRepresentation`. If you use `CachedRepresentation` than starting twice with the same basis yields identical lattices, but starting with different bases will yield non-identical lattices that may still be equal. Only `UniqueRepresentation` would imply a "comparison by identity".


---

Comment by SimonKing created at 2014-03-21 08:16:55

Replying to [comment:8 SimonKing]:
> Your situation could be similar: You have a lattice `L` in `RR^n`, and the parent of the elements of `L` wouldn't be `L` but `RR^n` (but please not `ZZ^n`, since you need the embedding!).

Ahm, or actually it _should_ be `ZZ^n`, since you have integer lattices. But this `ZZ^n` is a subset of `RR^n` and should not be confused with the fact that the lattice itself is isomorphic to `ZZ^n`.


---

Comment by git created at 2014-03-21 10:41:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-03-21 10:45:08

Thanks Simon, 

`Facade` seems to be exactly what I needed!

On the `CachedRepresentation` I think even that is too much. One could, for example, construct the same lattice twice and then run lattice reduction on one instance in order to get a good basis. The design is somewhat unusual as it changes the basis during the life-time of an object.


---

Comment by git created at 2014-03-21 10:59:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-03-21 11:45:29

Replying to [comment:11 malb]:
> On the `CachedRepresentation` I think even that is too much. One could, for example, construct the same lattice twice and then run lattice reduction on one instance in order to get a good basis. The design is somewhat unusual as it changes the basis during the life-time of an object.

OK, it sounds like caching would be bad in such situation.


---

Comment by malb created at 2014-03-21 12:37:58

Okay, excellent. So - as far as I am concerned - our work here is done :)


---

Comment by darij created at 2014-03-30 02:57:06

Are you guys sure that special characters (such as · and δ) don't break the PDF documentation? Just asking.

What exactly does the `jacobi` method do? Sage does have a Cholesky decomposition method, but that's different (yours is rational, which is why I'm curious). Any references or explanations? (They should also go into the docstring -- also, a doctest on something other than a scalar matrix would be nice...)

Finally, I'd suggest not using such a short and generic name for a class like `Lattice` which is not likely to be implemented in foreseeable future (shouldn't the inexactness of the reals prevent such class from being implementable?).


---

Comment by git created at 2014-03-30 22:36:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-03-30 22:38:28

Replying to [comment:15 darij]:
> Are you guys sure that special characters (such as · and δ) don't break the PDF documentation? Just asking.

It didn't, but now it does. Thanks!
 
> What exactly does the `jacobi` method do? Sage does have a Cholesky decomposition method, but that's different (yours is rational, which is why I'm curious). Any references or explanations? (They should also go into the docstring -- also, a doctest on something other than a scalar matrix would be nice...)

I cannot speak for that part of the code as it was taken on-board from the 2012 GSoC project. It seemed like the only non-trivial contribution and I didn't want to delete it. I never touched it. If no-one is comfortable with it, we can drop it though. I asked Daniel Krenn to comment (he was the mentor on that GSoC project)

> Finally, I'd suggest not using such a short and generic name for a class like `Lattice` which is not likely to be implemented in foreseeable future (shouldn't the inexactness of the reals prevent such class from being implementable?).

I don't see the problem with the class itself, that's what namespaces are for, right? Lattice as the basic class for lattices (as discrete subgroups of RR<sup>n</sup>) seems about right. However, I do take your point with Lattice is in the global namespace (i.e. the constructor). Any recommendation?
----
New commits:
----
New commits:


---

Comment by darij created at 2014-03-31 00:14:15

Oh, if it's not in the global namespace, then it's fine. Otherwise, what about `RealLattice`?


---

Comment by darij created at 2014-03-31 00:59:14

*ignore this one*


---

Comment by git created at 2014-03-31 01:02:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by darij created at 2014-03-31 01:04:25

OK, so the method does do something like Cholesky decomposition, except that it never takes square roots and has some diagonal factors. (Don't get me wrong: this makes the method more useful, not wrong.) I've added documentation. Warning: branch change.

I fear this is all I can do for this ticket, though...


---

Comment by git created at 2014-04-02 10:51:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-04-02 10:52:20

I renamed `Lattice` to `RealLattice`


---

Comment by dimpase created at 2014-04-03 09:48:37

Replying to [comment:23 malb]:
> I renamed `Lattice` to `RealLattice`

bad choice, IMHO. People will want to have lattices in things like C^n


---

Comment by malb created at 2014-04-03 10:58:31

Suggestions? `Lattice` seems to be too general for many, `RealLattice` too specific for others. `ComplexLattice` doesn't really seem to make much sense because one normally thinks of a lattice as a discrete subgroup of R<sup>n</sup> (at least in my neck of the woods).


---

Comment by dimpase created at 2014-04-03 11:13:19

How about `VectorSpaceLattice` ?  (well, not all fields might be supported, but still).


---

Comment by malb created at 2014-04-03 13:35:06

Wouldn't people confuse that with vector lattices? Or is that not a common notion? cf. http://www.stat.yale.edu/~pollard/Books/Asymptopia/old-Vectorlattice.pdf

I do have to admit that I also find it a bit awkward but that's clearly a question of taste.


---

Comment by git created at 2014-04-03 14:44:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2014-04-03 14:47:05

Replying to [comment:27 malb]:
> Wouldn't people confuse that with vector lattices? Or is that not a common notion? cf. http://www.stat.yale.edu/~pollard/Books/Asymptopia/old-Vectorlattice.pdf
> 
> I do have to admit that I also find it a bit awkward but that's clearly a question of taste. 

hmm, OK, how about `AdditiveTorsionFreeAbelianGroup` ? This would avoid that other lattices all together...


---

Comment by malb created at 2014-04-03 15:25:56

now that's just mean … for now `VectorSpaceLattice` seems to be a winner.


---

Comment by git created at 2014-04-07 11:34:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-07 11:39:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-04-11 09:47:07

The patch is a lot less invasive now, anyone up for reviewing it?


---

Comment by git created at 2014-05-01 10:43:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-01 10:53:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-12 17:01:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2014-05-12 17:27:33

I've uploaded a couple of minor changes made during review (most of them are whitespace corrections, PEP8, rewriting of long lines, adding ``...`` in documentation.

Here some further comments:

* 

```
diff --git a/src/doc/common/conf.py b/src/doc/common/conf.py
index 25dd9f0..ff9efe3 100644
--- a/src/doc/common/conf.py
+++ b/src/doc/common/conf.py
@@ -296,6 +296,13 @@ latex_elements['preamble'] = r"""
 \DeclareUnicodeCharacter{2510}{+}
 \DeclareUnicodeCharacter{2514}{+}
 \DeclareUnicodeCharacter{2518}{+}
+\DeclareUnicodeCharacter{03BC}{\mu}
+\DeclareUnicodeCharacter{03B4}{\delta}
+\DeclareUnicodeCharacter{03B7}{\eta}
+\DeclareUnicodeCharacter{03BB}{\lambda}
+\DeclareUnicodeCharacter{2266}{\le}
+\DeclareUnicodeCharacter{221A}{\sqrt}
```

I'd appreciate if someone else can make a short review on this part, since I do not know what should be done. (It seems that the code works, but I just don't know if this is how it is done; probably yes).

* changes in fplll.*: The changes look fine for me and the code seem to work. I have to say, I am not really familiar with the fplll interface, so maybe someone else can look at this code (but for me it is positive_review on this part).

* 

```
diff --git a/src/sage/libs/fplll/fplll.pyx b/src/sage/libs/fplll/fplll.pyx
index 59cd53e..b28f5c9 100644
--- a/src/sage/libs/fplll/fplll.pyx
+++ b/src/sage/libs/fplll/fplll.pyx
@@ -18,6 +18,7 @@ AUTHORS:
+#       Copyright (C) 2014 Martin Albrecht <martinralbecht@googlemailc.om>
                                                   ^^^^               ^^^^
```

Is this on purpose?

* fplll.pyx: OUTPUT-blocks are missing (although, most of them will state "Nothing") (The developerguide does not say that those can be skipped if nothing is returned...)

* fplll.pyx: Sometimes there are empty lines between two input-descriptions (in INPUT-block), sometimes not. This should be done in the same way everywhere.

* fplll.pyx: def BKZ: In the INPUT-block you can find the following:

```
        - ``block_size`` - 0 < block size <= nrows

        - ``no_lll`` - 
        - ``bounded_lll`` -
```

The first line looks a bit weird, since this is a mixture of math and verbated text written plain. Maybe add ``...`` or `...` there?
The last two don't have any description.

* I am not sure which of the following one should prefer for `default: 0`: `0` or ``0`` or 0?
(I have a slight preference for `0`). But this should be done in the same way everywhere.

* matrix_integer_dense.pyx:

```
        - ``prune`` - The optional parameter ``prune`` can be set to any
           positive number to invoke the Volume Heuristic from [Schnorr and
           Horner, Eurocrypt '95]. This can significantly reduce the running
           time, and hence allow much bigger block size, but the quality of the
           reduction is of course not as good in general. Higher values of
           ``prune`` mean better quality, and slower running time. When
           ``prune`` == 0, pruning is disabled. Recommended usage: for
           ``block_size`` = 30, set 10 = ``prune`` = 15.
```

The last few lines (== 0, = 30, 10 = ``prune`` = 15) look a bit weird.

* matrix_integer_dense.pyx:

```
        fpLLL SPECIFIC INPUTS:

        - ``precision`` - bit precision to use if ``fp=='rr'`` (default: 0 for automatic choice)
                                             = here ^^^^^^^^ ?
```


* in matrix_integer_dense.pyx: Sometimes there is `OUTPUT: an integer`. Shouldn't this be in separate lines?

* A couple of times the descriptions in the INPUT-block end with a full-stop; most of the times not.

* free_module_integer.py: Some missing OUTPUT-blocks

* 

```
SCORE src/sage/libs/fplll/fplll.pyx: 89.5% (17 of 19)

Missing documentation:
     * line 492: def HKZ(self)

Missing doctests:
     * line 499: def shortest_vector(self, method=None)
```


Apart from those minor things, everything else looks good.


---

Comment by git created at 2014-05-12 19:41:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-12 20:47:28

Replying to [comment:38 dkrenn]:
> I've uploaded a couple of minor changes made during review (most of them are whitespace corrections, PEP8, rewriting of long lines, adding ``...`` in documentation.

Thanks!
 
> Here some further comments:
> 
> * 
> {{{
> diff --git a/src/doc/common/conf.py b/src/doc/common/conf.py
> index 25dd9f0..ff9efe3 100644
> --- a/src/doc/common/conf.py
> +++ b/src/doc/common/conf.py
> `@``@` -296,6 +296,13 `@``@` latex_elements['preamble'] = r"""
>  \DeclareUnicodeCharacter{2510}{+}
>  \DeclareUnicodeCharacter{2514}{+}
>  \DeclareUnicodeCharacter{2518}{+}
> +\DeclareUnicodeCharacter{03BC}{\mu}
> +\DeclareUnicodeCharacter{03B4}{\delta}
> +\DeclareUnicodeCharacter{03B7}{\eta}
> +\DeclareUnicodeCharacter{03BB}{\lambda}
> +\DeclareUnicodeCharacter{2266}{\le}
> +\DeclareUnicodeCharacter{221A}{\sqrt}
> }}}
> I'd appreciate if someone else can make a short review on this part, since I do not know what should be done. (It seems that the code works, but I just don't know if this is how it is done; probably yes).

This essentially allows to write UTF-8 characters like δ directly, which makes the documentation easier to read.
 
> 
> * 
> {{{
> diff --git a/src/sage/libs/fplll/fplll.pyx b/src/sage/libs/fplll/fplll.pyx
> index 59cd53e..b28f5c9 100644
> --- a/src/sage/libs/fplll/fplll.pyx
> +++ b/src/sage/libs/fplll/fplll.pyx
> `@``@` -18,6 +18,7 `@``@` AUTHORS:
> +#       Copyright (C) 2014 Martin Albrecht <martinralbecht`@`googlemailc.om>
>                                                    <sup>^</sup>^               <sup>^</sup>^
> }}}
> Is this on purpose?

Fixed.

> * fplll.pyx: OUTPUT-blocks are missing (although, most of them will state "Nothing") (The developerguide does not say that those can be skipped if nothing is returned...)

I added those.

> * fplll.pyx: Sometimes there are empty lines between two input-descriptions (in INPUT-block), sometimes not. This should be done in the same way everywhere.

I should have fixed all of those.

> * fplll.pyx: def BKZ: In the INPUT-block you can find the following:
> {{{
>         - ``block_size`` - 0 < block size <= nrows
> 
>         - ``no_lll`` - 
>         - ``bounded_lll`` -
> }}}
> The first line looks a bit weird, since this is a mixture of math and verbated text written plain. Maybe add ``...`` or `...` there?
> The last two don't have any description.

Fixed.
 
> * I am not sure which of the following one should prefer for `default: 0`: `0` or ``0`` or 0?
> (I have a slight preference for `0`). But this should be done in the same way everywhere.

I opted for ``0`` so that ``True`` etc. look the same?

> * matrix_integer_dense.pyx:
> {{{
>         - ``prune`` - The optional parameter ``prune`` can be set to any
>            positive number to invoke the Volume Heuristic from [Schnorr and
>            Horner, Eurocrypt '95]. This can significantly reduce the running
>            time, and hence allow much bigger block size, but the quality of the
>            reduction is of course not as good in general. Higher values of
>            ``prune`` mean better quality, and slower running time. When
>            ``prune`` == 0, pruning is disabled. Recommended usage: for
>            ``block_size`` = 30, set 10 = ``prune`` = 15.
> }}}
> The last few lines (== 0, = 30, 10 = ``prune`` = 15) look a bit weird.

Fixed.

> * matrix_integer_dense.pyx:
> {{{
>         fpLLL SPECIFIC INPUTS:
> 
>         - ``precision`` - bit precision to use if ``fp=='rr'`` (default: 0 for automatic choice)
>                                              = here <sup>^</sup><sup>^</sup>^^ ?
> }}}

I don't understand this point, fp='rr' is a valid parameter.

> * in matrix_integer_dense.pyx: Sometimes there is `OUTPUT: an integer`. Shouldn't this be in separate lines?

I fixed those.
 
> * A couple of times the descriptions in the INPUT-block end with a full-stop; most of the times not.

I tried to unify those.

> * free_module_integer.py: Some missing OUTPUT-blocks

Fixed.

> * 
> {{{
> SCORE src/sage/libs/fplll/fplll.pyx: 89.5% (17 of 19)
> 
> Missing documentation:
>      * line 492: def HKZ(self)
> 
> Missing doctests:
>      * line 499: def shortest_vector(self, method=None)
> }}}

Fixed.

> Apart from those minor things, everything else looks good.


---

Comment by git created at 2014-05-12 20:47:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-12 21:38:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-12 21:41:16

I figured I should make a conservative choice and removed `IntegerLattice` from the global name space. This way, the stakes of accepting this ticket are a lot lower.


---

Comment by dkrenn created at 2014-05-13 07:31:27

Replying to [comment:40 malb]:
> > * matrix_integer_dense.pyx:
> > {{{
> >         fpLLL SPECIFIC INPUTS:
> > 
> >         - ``precision`` - bit precision to use if ``fp=='rr'`` (default: 0 for automatic choice)
> >                                              = here <sup>^</sup><sup>^</sup>^^ ?
> > }}}
> 
> I don't understand this point, fp='rr' is a valid parameter.

Yes it is. Therefore I'd prefer `fp='rr'`, since this parameter is specified like this and not testing for equality with `==`.


---

Comment by git created at 2014-05-13 08:35:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-13 08:36:36

Replying to [comment:44 dkrenn]:
> Yes it is. Therefore I'd prefer `fp='rr'`, since this parameter is specified like this and not testing for equality with `==`.

Ah, gotcha. Fixed. Thanks!


---

Comment by git created at 2014-05-14 09:22:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2014-05-14 09:23:06

Thanks for your changes. Look good. 

There is one problem: the documentation does not build:

```
[modules  ] /local/data/krenn/sage-develop/local/lib/python2.7/site-packages/sage/modules/free_module_integer.py:docstring of sage.modules.free_module_integer:3: WARNING: Bullet list ends without a blank line; unexpected unindent.
[modules  ] /local/data/krenn/sage-develop/local/lib/python2.7/site-packages/sage/modules/free_module_integer.py:docstring of sage.modules.free_module_integer:6: WARNING: Block quote ends without a blank line; unexpected unindent.
Error building the documentation.
Traceback (most recent call last):
  File "/local/data/krenn/sage-develop/src/doc/common/builder.py", line 1477, in <module>
    getattr(get_builder(name), type)()
  File "/local/data/krenn/sage-develop/src/doc/common/builder.py", line 276, in _wrapper
    getattr(get_builder(document), 'inventory')(*args, **kwds)
  File "/local/data/krenn/sage-develop/src/doc/common/builder.py", line 487, in _wrapper
    x.get(99999)
  File "/local/data/krenn/sage-develop/local/lib/python/multiprocessing/pool.py", line 554, in get
    raise self._value
OSError: [modules  ] /local/data/krenn/sage-develop/local/lib/python2.7/site-packages/sage/modules/free_module_integer.py:docstring of sage.modules.free_module_integer:3: WARNING: Bullet list ends without a blank line; unexpected unindent.

make: *** [doc-html] Fehler 1
```



---

Comment by malb created at 2014-05-14 10:52:53

Thanks! I'm trying to fix it, but the error message doesn't seem very helpful:


```
OSError: [modules  ] /local/data/krenn/sage-develop/local/lib/python2.7/site-packages/sage/modules/free_module_integer.py:docstring of sage.modules.free_module_integer:3: WARNING: Bullet list ends without a blank line; unexpected unindent.
```


The error doesn't seem to actually be in line 3 of the file.


---

Comment by dkrenn created at 2014-05-14 10:58:48

Replying to [comment:49 malb]:
> Thanks! I'm trying to fix it, but the error message doesn't seem very helpful:
> 
> {{{
> OSError: [modules  ] /local/data/krenn/sage-develop/local/lib/python2.7/site-packages/sage/modules/free_module_integer.py:docstring of sage.modules.free_module_integer:3: WARNING: Bullet list ends without a blank line; unexpected unindent.
> }}}
> 
> The error doesn't seem to actually be in line 3 of the file.

That is true. I had this (and similar error messages) a couple of times and amost every time I had to solve it by a divide-and-conquer-comment-out procedure...


---

Comment by git created at 2014-05-14 11:08:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dkrenn created at 2014-05-14 11:43:34

Maybe one should also rewrite references like 

```
[Schnorr and Horner, Eurocrypt '95]
```

into a true reference as in 

```
This docstring is referencing [SC]_. Just remember that references
are global, so we can also reference to [Nat2000]_ in the ALGORITHM
block, even if it is in a separate file. However we would not
include the reference here since it would cause a conflict.

REFERENCES:

.. [SC] Conventions for coding in sage.
   http://www.sagemath.org/doc/developer/conventions.html.
```

(copied from the developer guide)


---

Comment by dkrenn created at 2014-05-14 11:43:48

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-05-14 12:01:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-05-14 12:44:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-14 12:45:20

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-05-14 12:45:20

I think it got them all now.


---

Comment by dkrenn created at 2014-05-14 14:39:25

Everything looks good now. Doctests are still running...


---

Comment by dkrenn created at 2014-05-14 15:05:19

Changing status from needs_review to positive_review.


---

Comment by malb created at 2014-05-14 15:30:59

Whooohoo! Thank you so much!


---

Comment by vbraun created at 2014-05-16 09:27:44

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-05-16 09:27:44

Please merge in the latest beta and resolve the doctest failurues

```
sage -t --long src/sage/modules/free_module_integer.py
**********************************************************************
File "src/sage/modules/free_module_integer.py", line 437, in sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer.BKZ
Failed example:
    L.LLL()
Expected:
    100 x 100 dense matrix over Integer Ring
Got:
    100 x 100 dense matrix over Integer Ring (use the '.str()' method to see the entries)
```

On a related note, how is the doctest runtime on 100x100 matrices... is this the smallest example that provides adequate test coverage?


---

Comment by git created at 2014-05-16 11:10:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-16 11:11:16

Running times are okay, but I reduced the dimension to 60 anyway. Also, I marked a long doctest as long (a voronoi cell computation).


```python
sage: from sage.modules.free_module_integer import IntegerLattice
sage: A = sage.crypto.gen_lattice(type='random', n=1, m=100, q=2^60, seed=42)
sage: L = IntegerLattice(A, lll_reduce=False)
sage: min(v.norm().n() for v in L.reduced_basis)
4.17330740711759e15

sage: %time L.LLL()
CPU times: user 268 ms, sys: 0 ns, total: 268 ms
Wall time: 269 ms
100 x 100 dense matrix over Integer Ring

sage: %time L.BKZ(block_size=10)
CPU times: user 1.25 s, sys: 0 ns, total: 1.25 s
Wall time: 1.25 s
100 x 100 dense matrix over Integer Ring
```


However, doctests pass on my machine, which is strange.


```bash
$./sage -version
Sage Version 6.3.beta0, Release Date: 2014-05-10
```

----
New commits:


---

Comment by vbraun created at 2014-05-16 11:18:31

Latest beta = 6.3.beta1


---

Comment by git created at 2014-05-16 11:48:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-16 11:48:58

Doctests fixed ... sorry, I missed beta1 somehow before.


---

Comment by malb created at 2014-05-19 13:26:56

Changing status from needs_work to needs_review.


---

Comment by dkrenn created at 2014-05-21 12:36:05

Reviewed changes.....positive.


---

Comment by dkrenn created at 2014-05-21 12:36:05

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2014-05-22 06:40:14

There's a couple of little things scattered throughout that I think should be fixed before this gets merged. For example, in the `LLL` definition, you have non-ascii characters where I think you should just use the latex equivalents. The reference should be:

```
.. [Ref] blah on first line that needs continuing on
   the second line
```

(you have one space less and would be slightly surprised the doc builds and has well-formatted output). You could likely benefit from raw string formatting:

```
def foo():
    r"""
    The r in front makes this a "raw" string, so the backslash isn't an
    escape character. So you can do things like this: `\ZZ` and `\alpha`.
    """
    pass
```

Bring stuff up to python3 compliance. I can go through and do these things tomorrow morning if you don't mind the tweaks (and/or don't do it while I sleep `:P`).


---

Comment by dkrenn created at 2014-05-22 07:49:01

Changing status from positive_review to needs_work.


---

Comment by malb created at 2014-05-22 07:59:25

Replying to [comment:68 tscrim]:
> There's a couple of little things scattered throughout that I think should be fixed before this gets merged. For example, in the `LLL` definition, you have non-ascii characters where I think you should just use the latex equivalents. 

I disagree, using UTF-8 makes it a lot more readable and compact. Changing it to TeX would be a step backward IMHO.

> The reference should be:
> {{{
> .. [Ref] blah on first line that needs continuing on
>    the second line
> }}}
> (you have one space less and would be slightly surprised the doc builds and has well-formatted output). 

The documentation builds and - as far as I can tell - has well formated output. If you'd prefer it to be aligned for consistency, I'm not objecting.

> You could likely benefit from raw string formatting:
> {{{
> def foo():
>     r"""
>     The r in front makes this a "raw" string, so the backslash isn't an
>     escape character. So you can do things like this: `\ZZ` and `\alpha`.
>     """
>     pass
> }}}

I know this exists, but I find ``\\ZZ`` more straight-forward. I don't think it needs to be changed, but if you prefer it differently, feel free to go ahead.

> Bring stuff up to python3 compliance. 

Python 3 compliance would be good :)

> I can go through and do these things tomorrow morning if you don't mind the tweaks (and/or don't do it while I sleep `:P`).

Thanks.


---

Comment by git created at 2014-05-22 20:45:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2014-05-22 20:48:50

Okay, I've made a bunch of fixes and tweaks. I've created a separate branch which changes the UTF to latex and adds fplll to the doc as well. IMO, the latex version looks better in the html doc (and in the pdf, you've made it so they are the same). However if you really prefer to keep it with the UTF, then you can switch the branch back and set a positive review on that one (after checking it of course).

PS - I remember that it used to be that the references would fail to build if they weren't aligned properly. Good to know it's more robust now.
----
New commits:


---

Comment by tscrim created at 2014-05-22 20:48:50

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-05-23 11:31:10

Changing status from needs_review to positive_review.


---

Comment by malb created at 2014-05-23 11:31:10

looks okay, thanks.


---

Comment by vbraun created at 2014-05-23 11:35:35

Conflicts with #16216


---

Comment by vbraun created at 2014-05-23 11:35:35

Changing status from positive_review to needs_work.


---

Comment by git created at 2014-05-23 12:40:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-23 12:41:25

merged


---

Comment by malb created at 2014-05-23 12:41:25

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-05-23 13:34:35

Resolution: fixed


---

Comment by vbraun created at 2014-05-24 13:13:44

PDF docs fail:

```
! Package inputenc Error: Unicode char \u8:̣ not set up for use with LaTeX.

See the inputenc package documentation for explanation.
Type  H <return>  for immediate help.
 ...                                              
                                                  
l.24326 A lattice $(b_1, b_2, ..., b_d)$ is $(̣
                                                δ, η)$-LLL-reduced
? 
! Emergency stop.
```

I think there is a zero-width space or something like that before the delta. But really, why did you remove the original TeX codes?


---

Comment by vbraun created at 2014-05-24 13:14:21

Last 10 new commits:


---

Comment by vbraun created at 2014-05-24 13:14:21

Resolution changed from fixed to 


---

Comment by vbraun created at 2014-05-24 13:14:21

Changing status from closed to new.


---

Comment by vbraun created at 2014-05-24 13:21:37

In fact, there is a http://www.fileformat.info/info/unicode/char/0323/index.htm before the delta (depending on your editor you see a dot below the delta)


---

Comment by git created at 2014-05-24 16:44:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-05-24 16:45:23

Changing status from new to needs_review.


---

Comment by malb created at 2014-05-24 16:45:23

should be fixed now.


---

Comment by malb created at 2014-05-25 12:47:55

What's the policy on such "doctest failure" like fixes? Does someone have to review them or is it enough to check it again using the automatic tools checking such things?


---

Comment by vbraun created at 2014-05-25 13:43:44

Use your own judgement... but if you set it back to positive review you better be sure that it works ;-)


---

Comment by malb created at 2014-05-25 13:57:18

living on the edge … it did work on my machine :)


---

Comment by malb created at 2014-05-25 13:57:18

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-25 17:31:44

Resolution: fixed


---

Comment by dimpase created at 2020-06-17 09:39:49

there is a strange rounding going on in

```
hv = [QQ(round(elmt, 6)) for elmt in hv]
```


Can anyone explain it? A careless change there initiated #29866,
but still why `6`, and not `42` - or better, something input-dependent?


---

Comment by malb created at 2020-06-17 10:16:00

This is in `diamond_cut` in `diamond_cutting.py`, right? Maybe the underlying software uses single precision floats and this is meant to approximate that?


---

Comment by dimpase created at 2020-06-17 12:06:07

Replying to [comment:89 malb]:
> This is in `diamond_cut` in `diamond_cutting.py`, right? 
yes

> Maybe the underlying software uses single precision floats and this is meant to approximate that?

No, since ages (libppl interface was added in 2011 or 2012, I gather - although it could have taken more time for it to become default) `Polyhedron()` uses ppl as backend, if given rational data, so it's exact.
I thought that line does some clever rounding to speed things up, but still I can't imagine a maths statement which could make it rigorous.

Should we just drop the rounding?


---

Comment by dimpase created at 2020-06-17 12:11:44

It's actually quite strange - you first convert your data to `float()`, and then build a polyhedron with coodinates obtained by rounding these floats and converting them into QQ.

It's a miracle to me that it (mostly) works.
