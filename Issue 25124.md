# Issue 25124: Windows install: a variety of doctest failures for Sage 8.2

Issue created by migration from https://trac.sagemath.org/ticket/25361

Original creator: embray

Original creation time: 2018-05-14 13:30:45

CC:  slelievre dimpase

I have all the doctests passing for Sage 8.2 when I run them out of the source tree.  However, I've found that when running the doctests from and installation of the Sage binary distribution for Windows there are a few different strange test failures that I'm getting consistently.  Will probably make separate tickets for each of these as I investigate them.  They are probably not serious issues since they only appear in the binary install, but not when running the tests from source, so they are more likely to be issues with the tests and/or test runner themselves.

First in `sage.misc.cython`:


```
sage -t --long --warn-long 174.9 /opt/sagemath-8.2/src/sage/misc/cython.py
**********************************************************************
File "/opt/sagemath-8.2/src/sage/misc/cython.py", line 242, in sage.misc.cython._pyx_preparse
Failed example:
    _pyx_preparse("")
Expected:
    ('',
    ['mpfr',
    'gmp',
    'gmpxx',
    'stdc++',
    'pari',
    'm',
    'ec',
    'gsl',
    ...,
    'ntl'],
    ['.../include',
    '.../include/python...',
    '.../python.../numpy/core/include',
    '...',
    '.../sage/ext',
    '.../cysignals'],
    'c',
    [], ['-w', '-O2'],...)
Got:
    ('',
     ['mpfr', 'gmp', 'gmpxx', 'stdc++', 'pari', 'm', 'ec', 'gsl', 'ntl'],
     ['/opt/sagemath-8.2/local/include',
      '/opt/sagemath-8.2/local/include/python2.7',
      '/opt/sagemath-8.2/local/lib/python2.7/site-packages/numpy/core/include',
      '/opt/sagemath-8.2/local/lib/python2.7/site-packages',
      '/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/ext',
      '/opt/sagemath-8.2/local/lib/python2.7/site-packages/cysignals'],
     'c',
     [],
     ['-w', '-O2'],
     [])
**********************************************************************
File "/opt/sagemath-8.2/src/sage/misc/cython.py", line 275, in sage.misc.cython._pyx_preparse
Failed example:
    libs
Expected:
    ['foo', 'mpfr',
    'gmp', 'gmpxx',
    'stdc++',
    'pari',
    'm',
    'ec',
    'gsl',
    ...,
    'ntl']
Got:
    ['foo', 'mpfr', 'gmp', 'gmpxx', 'stdc++', 'pari', 'm', 'ec', 'gsl', 'ntl']
**********************************************************************
File "/opt/sagemath-8.2/src/sage/misc/cython.py", line 413, in sage.misc.cython.?
Failed example:
    cython(os.linesep.join(code))
Exception raised:
    Traceback (most recent call last):
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 551, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 961, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cython.?[1]>", line 1, in <module>
        cython(os.linesep.join(code))
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)
        return self.get_object()(*args, **kwds)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/misc/cython.py", line 1012, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/misc/cython.py", line 902, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/misc/cython.py", line 877, in cython_import
        name, build_dir = cython(filename, **kwds)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/misc/cython.py", line 676, in cython
        raise RuntimeError(msg.strip())
    RuntimeError: command 'gcc' failed with exit status 1
    In file included from /dot_sage/temp/NAVI-Brick/8136/spyx/_dot_sage_temp_NAVI_Brick_8136_tmp_Xd9EI1_pyx/_dot_sage_temp_NAVI_Brick_8136_tmp_Xd9EI1_pyx_0.cpp:619:0:
    /opt/sagemath-8.2/local/include/singular/Singular/libsingular.h:6:28: fatal error: singularconfig.h: No such file or directory
     #include <singularconfig.h>
                                ^
    compilation terminated.
**********************************************************************
File "/opt/sagemath-8.2/src/sage/misc/cython.py", line 419, in sage.misc.cython.?
Failed example:
    test(x)
Exception raised:
    Traceback (most recent call last):
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 551, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 961, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cython.?[3]>", line 1, in <module>
        test(x)
    NameError: name 'test' is not defined
**********************************************************************
File "/opt/sagemath-8.2/src/sage/misc/cython.py", line 420, in sage.misc.cython.?
Failed example:
    x
Expected:
    x^2
Got:
    x
**********************************************************************
2 items had failures:
   3 of  23 in sage.misc.cython.?
   2 of  12 in sage.misc.cython._pyx_preparse
    [81 tests, 5 failures, 159.17 s]
```


Next, I get several failures like:


```
sage -t --long --warn-long 174.9 /opt/sagemath-8.2/src/sage/repl/ipython_tests.py
**********************************************************************
File "/opt/sagemath-8.2/src/sage/repl/ipython_tests.py", line 10, in sage.repl.ipython_tests
Failed example:
    shell.run_cell(u'%pinfo dummy')
Expected:
    Signature:      dummy(argument, optional=None)
    Docstring:
       Dummy Docstring Title
    <BLANKLINE>
       Dummy docstring explanation.
    <BLANKLINE>
       INPUT:
    <BLANKLINE>
       * "argument" -- anything. Dummy argument.
    <BLANKLINE>
       * "optional" -- anything (optional). Dummy optional.
    <BLANKLINE>
       EXAMPLES:
    <BLANKLINE>
    ...
    Init docstring: x.__init__(...) initializes x; see help(type(x)) for signature
    File:           .../sage/repl/ipython_tests.py
    Type:           function
Got:
    <CSI-1;31m>Signature:<CSI-0m>      <CSI-0m>dummy<CSI-0m><CSI-1;33m>(<CSI-0m><CSI-0m>argument<CSI-0m><CSI-1;33m>,<CSI-0m> <CSI-0m>optional<CSI-0m><CSI-1;33m>=<CSI-0m><CSI-0m>None<CSI-0m><CSI-1;33m>)<CSI-0m><CSI-1;33m><CSI-0m><CSI-0m>
    <CSI-1;31m>Docstring:<CSI-0m>
...
```


and so on.  Something weird having to do with terminal control codes, though I don't know why I don't get this when running from source (it might also be a Cygwin version difference?)

I get failures like this in:

* `sage.repl,ipython_tests`
* `sage.repl.interface_magic`
* `sage.repl.interpreter`

Next, I get this failure for some reason:


```
sage -t --long --warn-long 174.9 /opt/sagemath-8.2/src/sage/doctest/control.py
**********************************************************************
File "/opt/sagemath-8.2/src/sage/doctest/control.py", line 605, in sage.doctest.control.DocTestController.test_safe_directory
Failed example:
    DC.test_safe_directory(d)
Expected:
    Traceback (most recent call last):
    ...
    RuntimeError: refusing to run doctests...
Got:
    <BLANKLINE>
```


and a few failures like this:


```
sage -t --long --warn-long 174.9 /opt/sagemath-8.2/src/sage/repl/ipython_kernel/install.py
**********************************************************************
File "/opt/sagemath-8.2/src/sage/repl/ipython_kernel/install.py", line 107, in sage.repl.ipython_kernel.install.SageKernelSpec.use_local_mathjax
Failed example:
    spec.use_local_mathjax()
Exception raised:
    Traceback (most recent call last):
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 551, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 961, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.repl.ipython_kernel.install.SageKernelSpec.use_local_mathjax[2]>", line 1, in <module>
        spec.use_local_mathjax()
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 114, in use_local_mathjax
        self.symlink(src, dst)
      File "/opt/sagemath-8.2/local/lib/python2.7/site-packages/sage/repl/ipython_kernel/install.py", line 97, in symlink
        os.symlink(src, dst)
    OSError: [Errno 17] File exists
```


this


```
File "/opt/sagemath-8.2/src/sage/parallel/decorate.py", line 564, in sage.parallel.decorate.fork
Failed example:
    print("this works"); g()
Expected:
    this works...
    <BLANKLINE>
    ------------------------------------------------------------------------
    Unhandled SIG...
    ------------------------------------------------------------------------
    'NO DATA'
Got:
    this works
    ------------------------------------------------------------------------
    'NO DATA'
```



and this


```
File "/opt/sagemath-8.2/src/sage/tests/py3_syntax.py", line 17, in sage.tests.py3_syntax
Failed example:
    py3_syntax.run_tests('.py')   # long time
Expected nothing
Got:
    Invalid Python 3 syntax found:
    Traceback (most recent call last):
      File "/opt/sagemath-8.2/local/lib/python3.6/runpy.py", line 193, in _run_module_as_main
        "__main__", mod_spec)
      File "/opt/sagemath-8.2/local/lib/python3.6/runpy.py", line 85, in _run_code
        exec(code, run_globals)
      File "/opt/sagemath-8.2/local/lib/python3.6/py_compile.py", line 186, in <module>
        sys.exit(main())
      File "/opt/sagemath-8.2/local/lib/python3.6/py_compile.py", line 178, in main
        compile(filename, doraise=True)
      File "/opt/sagemath-8.2/local/lib/python3.6/py_compile.py", line 136, in compile
        os.makedirs(dirname)
      File "/opt/sagemath-8.2/local/lib/python3.6/os.py", line 220, in makedirs
        mkdir(name, mode)
    PermissionError: [Errno 13] Permission denied: '../../opt/sagemath-8.2/src/sage/__pycache__'
    <BLANKLINE>
...
```


and finally


```
sage -t --long --warn-long 174.9 /opt/sagemath-8.2/src/sage/doctest/test.py
**********************************************************************
File "/opt/sagemath-8.2/src/sage/doctest/test.py", line 164, in sage.doctest.test
Failed example:
    subprocess.call(["sage", "-t", "--warn-long", "0", "99seconds.rst"], **kwds2)  # long time
Expected:
    Running doctests...
    Doctesting 1 file.
    sage -t --warn-long 0.0 99seconds.rst
        Timed out
    **********************************************************************
    Tests run before process (pid=...) timed out:
    ...
    ----------------------------------------------------------------------
    sage -t --warn-long 0.0 99seconds.rst  # Timed out
    ----------------------------------------------------------------------
    ...
    4
Got:
    Running doctests with ID 2018-05-12-22-47-23-7419eab6.
    Using --optional=atlas,mpir,python2,sage
    Doctesting 1 file.
    sage -t --warn-long 0.0 99seconds.rst
        Timed out (with segmentation fault after interrupt)
    **********************************************************************
    Tests run before process (pid=2832) timed out:
    sage: import time ## line 3 ##
    sage: time.sleep(99) ## line 4 ##
    ------------------------------------------------------------------------
    <BLANKLINE>
    **********************************************************************
    ----------------------------------------------------------------------
    sage -t --warn-long 0.0 99seconds.rst  # Timed out (with segmentation fault after interrupt)
    ----------------------------------------------------------------------
    Total time for all tests: 3.7 seconds
        cpu time: 0.0 seconds
        cumulative wall time: 0.0 seconds
    4
```



---

Comment by embray created at 2018-05-14 13:54:47

Set assignee to embray.


---

Comment by embray created at 2018-08-10 16:39:35

Still haven't fixed any of these yet, and with 8.3 I get a ton of new failures:


```
sage -t --long /opt/sagemath-8.3/src/sage/misc/sagedoc.py  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/tests/cmdline.py  # 6 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/features/__init__.py  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/cachefunc.pyx  # 54 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/cython.py  # 22 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/sageinspect.py  # 35 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/structure/element.pyx  # 44 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/structure/element.pxd  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/parallel/decorate.py  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/libs/gap/util.pyx  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/doctest/control.py  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/repl/ipython_extension.py  # 5 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/structure/factory.pyx  # 8 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/cpython/getattr.pyx  # 4 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/cpython/cython_metaclass.pyx  # 4 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/ext/memory_allocator.pyx  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/lazy_attribute.pyx  # 3 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/persist.pyx  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/arith/long.pxd  # 9 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/superseded.py  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/ext/stdsage.pxi  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/rings/integer_fake.pxd  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/inherit_comparison.pyx  # 5 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/ext/cdefs.pxi  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/session.pyx  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/repl/load.py  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/nested_class.pyx  # 6 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/libs/glpk/error.pyx  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/docs/instancedoc.pyx  # 4 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/cython_c.pyx  # 1 doctest failed
sage -t --long /opt/sagemath-8.3/src/sage/misc/inline_fortran.py  # 3 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/cpython/string.pyx  # 1 doctest failed
```


I'm not overly worried about this because all the tests pass when run from source, whereas this is running the tests in the build installed by the installer, which may fail due to assumptions the tests make about the context in which they're run (a source checkout, typically).

That said, some of these could point to real bugs, and should be investigated.


---

Comment by embray created at 2018-08-10 16:43:12

Right off the bat, I can see that a lot of these are caused by failures like:


```
File "/opt/sagemath-8.3/src/sage/misc/cachefunc.pyx", line 129, in sage.misc.cachefunc
Failed example:
    cython('\n'.join(cython_code))
Exception raised:
    Traceback (most recent call last):
      File "/opt/sagemath-8.3/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/opt/sagemath-8.3/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.cachefunc[19]>", line 1, in <module>
        cython('\n'.join(cython_code))
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3756)
        return self.get_object()(*args, **kwds)
      File "/opt/sagemath-8.3/local/lib/python2.7/site-packages/sage/misc/cython.py", line 1011, in cython_compile
        return cython_import_all(tmpfile, get_globals(), **kwds)
      File "/opt/sagemath-8.3/local/lib/python2.7/site-packages/sage/misc/cython.py", line 901, in cython_import_all
        m = cython_import(filename, **kwds)
      File "/opt/sagemath-8.3/local/lib/python2.7/site-packages/sage/misc/cython.py", line 876, in cython_import
        name, build_dir = cython(filename, **kwds)
      File "/opt/sagemath-8.3/local/lib/python2.7/site-packages/sage/misc/cython.py", line 675, in cython
        raise RuntimeError(msg.strip())
    RuntimeError: command 'gcc' failed with exit status 1
    In file included from /home/sage/.sage/temp/NAVI-Brick/10276/spyx/_home_sage__sage_temp_NAVI_Brick_10276_tmp_Lp88sQ_pyx/_home_sage__sage_temp_NAVI_Brick_10276_tmp_Lp88sQ_pyx_0.c:37:0:
    /opt/sagemath-8.3/local/include/python2.7/Python.h:47:10: fatal error: crypt.h: No such file or directory
     #include <crypt.h>
              ^~~~~~~~~
    compilation terminated.
```


So it seems that maybe there are some header files missing from the distribution that are necessary in order to be able to compile cython code.  This would be something to be fixed in the Windows installer distribution and released as a new installer.


---

Comment by embray created at 2018-08-10 16:50:29

Okay, a lot of these I was able to fix right away by installing a couple develop packages with:


```
$ apt-cyg install libcrypt-devel liblapack-devel
```


These should really be included in the runtime distribution for Sage.  So I will work on a new installer build next week.  In the meantime, in the off chance anyone is affected by this, the above workaround will work on Sage 8.3 (which includes the apt-cyg program now).


---

Comment by embray created at 2018-08-10 16:51:12

And to be clear, that's not the only problem with the tests, but it was the reason for many of these failures.

In fact, the above workaround reduced the failures to two:


```
----------------------------------------------------------------------
sage -t --long /opt/sagemath-8.3/src/sage/tests/cmdline.py  # 2 doctests failed
sage -t --long /opt/sagemath-8.3/src/sage/doctest/control.py  # 1 doctest failed
----------------------------------------------------------------------
```


So that's a relief.


---

Comment by jdemeyer created at 2018-08-10 19:25:42

Replying to [comment:5 embray]:
> So it seems that maybe there are some header files missing from the distribution that are necessary in order to be able to compile cython code.

So how do you compile Python in the first place without `<crypt.h>`?


---

Comment by embray created at 2018-08-16 13:25:18

Replying to [comment:8 jdemeyer]:
> Replying to [comment:5 embray]:
> > So it seems that maybe there are some header files missing from the distribution that are necessary in order to be able to compile cython code.
> 
> So how do you compile Python in the first place without `<crypt.h>`?

There are separate build and runtime environments for the Windows binary.  Not all the build dependencies are needed at runtime, so what ends up in the installer is a smaller runtime environment.  Granted, it's not _that_ much smaller, since there is functionality in Sage that requires being able to compile things, and it seems I somehow dropped a couple devel packages from the runtime environment. 

I never had them listed explicitly as runtime dependencies, so it's possible they used to be listed as dependencies of some other package, but that dependency chain was broken.


---

Comment by embray created at 2018-12-28 14:09:23

Retargeting some of my tickets.


---

Comment by embray created at 2019-03-25 10:44:36

Removing most of the rest of my open tickets out of the 8.7 milestone, which should be closed.


---

Comment by embray created at 2019-07-30 09:55:08

Fixing #28289 would also likely fix some of these failures.  ipython_config.py should be ignored by default in the doctests, and _especially_ in the REPL tests.


---

Comment by mkoeppe created at 2021-01-10 18:46:39

Outdated, should be closed.


---

Comment by mkoeppe created at 2021-01-10 18:46:39

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-01-12 09:20:41

ok


---

Comment by dimpase created at 2021-01-12 09:20:41

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2021-02-04 14:09:09

Erik, can we close this one ? and what about #25205 ?


---

Comment by embray created at 2021-03-10 15:10:24

Definitely outdated by now.  Some of the failures mentioned here have already been addressed, or have other tickets, or are not even Windows-specific (like the 99seconds.rst one).


---

Comment by embray created at 2021-03-10 15:10:24

Resolution: worksforme
