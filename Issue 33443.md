# Issue 33443: moving _repr_fixups list from doctest/parsing.py header to method do_fixup

Issue created by migration from https://trac.sagemath.org/ticket/33680

Original creator: slabbe

Original creation time: 2022-04-11 13:27:25

CC:  chapoton jhpalmieri fbissey

As a follow-up of #33588 where we suggested in [comment:10](https://trac.sagemath.org/ticket/33588#comment:10) to move out of context `_repr_fixups` list from the header of  `doctest/parsing.py` to the method `do_fixup`.


---

Comment by slabbe created at 2022-04-11 13:30:37

New commits:


---

Comment by slabbe created at 2022-04-11 14:25:30

Changing status from new to needs_review.


---

Comment by git created at 2022-04-18 11:15:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-07-25 02:29:36

Seems to need rebasing.


---

Comment by mkoeppe created at 2022-09-26 00:35:45

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2022-09-26 03:16:19

Probably due to #34533?


---

Comment by git created at 2022-09-29 09:09:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-09-29 09:13:18

I solved the conflict. The interest in the current ticket is that it is more readable and testable when fixing an issue. For instance, new doctests could be added in the `do_fixup` method for the newly added fixup introduced in #34533 (I let someone else do it). Need review!


---

Comment by slabbe created at 2022-09-29 09:13:18

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-09-29 18:48:00

As an overarching issue, I don't understand why so many regular expressions are defined at the top level in `parsing.py`. For example, `optional_regex` is used just once in the file, so why not define it and `re.compile` it right before it's used? I tried moving that definition inside the function `parse_optional_tags` and did some timing with `./sage -tp src/sage/misc`: there was no difference from before the change to after.

Anyway, for this ticket, should we move `glpk_simplex_warning_regex` etc. to the method `do_fixup`? Again, I see no changes in the timing, although I have only run very limited tests.


---

Comment by jhpalmieri created at 2022-09-29 18:56:49

I like the change, in any case.


---

Comment by jhpalmieri created at 2022-09-29 20:37:44

I can push a change that moves all of the regular expressions out of the top level, if you would like.


---

Comment by slabbe created at 2022-09-30 08:39:20

Replying to [comment:14 John Palmieri]:
> As an overarching issue, I don't understand why so many regular expressions are defined at the top level in `parsing.py`. For example, `optional_regex` is used just once in the file, so why not define it and `re.compile` it right before it's used? 

I wonder if the reason is the following. Even if it is used only once in the file, the method can be called many times (for instance when doctesting the entire sage library), so that the compilation of the regex will be done only once and not thousands of times. What do you think?


---

Comment by jhpalmieri created at 2022-09-30 18:36:13

Replying to [comment:17 Sébastien Labbé]:
> Replying to [comment:14 John Palmieri]:
> > As an overarching issue, I don't understand why so many regular expressions are defined at the top level in `parsing.py`. For example, `optional_regex` is used just once in the file, so why not define it and `re.compile` it right before it's used? 
> 
> I wonder if the reason is the following. Even if it is used only once in the file, the method can be called many times (for instance when doctesting the entire sage library), so that the compilation of the regex will be done only once and not thousands of times. What do you think?

That's possible, but I didn't see any difference in timings. See https://stackoverflow.com/questions/452104/is-it-worth-using-pythons-re-compile/452143#452143 for a little analysis that reaches the conclusion that it doesn't save time to compile. I found the discussion at https://stackoverflow.com/questions/452104/is-it-worth-using-pythons-re-compile helpful in general. It seems that Python internally compiles and caches regular expressions anyway, so this shouldn't be saving us time, and in my observations it isn't. So I think we can make the decision based on what makes the code most readable.

See also the note here: https://docs.python.org/3/library/re.html#re.compile. This is all talking about compiling vs. not, but I think the same applies to where the compile statements are in the code.


---

Comment by git created at 2022-10-03 09:55:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2022-10-03 09:56:24

I agree, I just did a commit doing that.


---

Comment by jhpalmieri created at 2022-10-03 19:01:24

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2022-10-03 19:01:24

Looks good to me.


---

Comment by vbraun created at 2022-10-11 09:14:46

Resolution: fixed
