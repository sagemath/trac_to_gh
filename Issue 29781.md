# Issue 29781: Can't deepcopy expression containing function

archive/issues_029781.json:
```json
{
    "body": "CC:  @tscrim @rburing\n\nWhen I deepcopy expression containing function, a segmentation fault occurred.\n\n\n```\nsage: var('t');\nsage: x = function('x')(t);\nsage: l = [[x(t) == 1]];\nsage: l\n[[x(t) == 1]]\nsage: l2 = deepcopy(l);\nsage: l2\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n/Applications/SageMath-9.1.app/Contents/Resources/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.pyx in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)()\n    491         olist = [func._name]\n    492     olist.extend(['(', ', '.join(map(repr, args)), ')'])\n--> 493     return ''.join(olist)\n    494 \n    495 cdef stdstring* py_print_function(unsigned id, args):\n\nTypeError: sequence item 0: expected str instance, bytes found\nException ignored in: 'sage.libs.pynac.pynac.py_print_function'\nTraceback (most recent call last):\n  File \"sage/libs/pynac/pynac.pyx\", line 493, in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)\nTypeError: sequence item 0: expected str instance, bytes found\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n/Applications/SageMath-9.1.app/Contents/Resources/sage/src/bin/sage-python: line 2: 14997 Segmentation fault: 11  sage -python \"$@\"\n```\n\n\nIs this known issue?\n\nIssue created by migration from https://trac.sagemath.org/ticket/30018\n\n",
    "created_at": "2020-06-29T13:26:07Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Can't deepcopy expression containing function",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29781",
    "user": "@YunosukeY"
}
```
CC:  @tscrim @rburing

When I deepcopy expression containing function, a segmentation fault occurred.


```
sage: var('t');
sage: x = function('x')(t);
sage: l = [[x(t) == 1]];
sage: l
[[x(t) == 1]]
sage: l2 = deepcopy(l);
sage: l2
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/Applications/SageMath-9.1.app/Contents/Resources/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.pyx in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)()
    491         olist = [func._name]
    492     olist.extend(['(', ', '.join(map(repr, args)), ')'])
--> 493     return ''.join(olist)
    494 
    495 cdef stdstring* py_print_function(unsigned id, args):

TypeError: sequence item 0: expected str instance, bytes found
Exception ignored in: 'sage.libs.pynac.pynac.py_print_function'
Traceback (most recent call last):
  File "sage/libs/pynac/pynac.pyx", line 493, in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)
TypeError: sequence item 0: expected str instance, bytes found
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/Applications/SageMath-9.1.app/Contents/Resources/sage/src/bin/sage-python: line 2: 14997 Segmentation fault: 11  sage -python "$@"
```


Is this known issue?

Issue created by migration from https://trac.sagemath.org/ticket/30018





---

archive/issue_comments_423081.json:
```json
{
    "body": "Doing\n\n```diff\ndiff --git a/src/sage/libs/pynac/pynac.pyx b/src/sage/libs/pynac/pynac.pyx\nindex 0ebc8b5..b87e94e 100644\n--- a/src/sage/libs/pynac/pynac.pyx\n+++ b/src/sage/libs/pynac/pynac.pyx\n@@ -490,7 +490,7 @@ def py_print_function_pystring(id, args, fname_paren=False):\n     else:\n         olist = [func._name]\n     olist.extend(['(', ', '.join(map(repr, args)), ')'])\n-    return ''.join(olist)\n+    return ''.join((a.decode('utf-8') if isinstance(a,bytes) else a) for a in olist)\n \n cdef stdstring* py_print_function(unsigned id, args):\n     return string_from_pystr(py_print_function_pystring(id, args))\n```\n\nallows to fix the issue, but I don't know if this is a desirable fix. Maybe something else is better to do when the copy is done instead. But I don't know where this is done.",
    "created_at": "2020-06-29T14:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423081",
    "user": "@seblabbe"
}
```

Doing

```diff
diff --git a/src/sage/libs/pynac/pynac.pyx b/src/sage/libs/pynac/pynac.pyx
index 0ebc8b5..b87e94e 100644
--- a/src/sage/libs/pynac/pynac.pyx
+++ b/src/sage/libs/pynac/pynac.pyx
@@ -490,7 +490,7 @@ def py_print_function_pystring(id, args, fname_paren=False):
     else:
         olist = [func._name]
     olist.extend(['(', ', '.join(map(repr, args)), ')'])
-    return ''.join(olist)
+    return ''.join((a.decode('utf-8') if isinstance(a,bytes) else a) for a in olist)
 
 cdef stdstring* py_print_function(unsigned id, args):
     return string_from_pystr(py_print_function_pystring(id, args))
```

allows to fix the issue, but I don't know if this is a desirable fix. Maybe something else is better to do when the copy is done instead. But I don't know where this is done.



---

archive/issue_comments_423082.json:
```json
{
    "body": "Replying to [comment:1 slabbe]:\n> Doing\n> {{{\n> #!diff\n> diff --git a/src/sage/libs/pynac/pynac.pyx b/src/sage/libs/pynac/pynac.pyx\n> index 0ebc8b5..b87e94e 100644\n> --- a/src/sage/libs/pynac/pynac.pyx\n> +++ b/src/sage/libs/pynac/pynac.pyx\n> `@``@` -490,7 +490,7 `@``@` def py_print_function_pystring(id, args, fname_paren=False):\n>      else:\n>          olist = [func._name]\n>      olist.extend(['(', ', '.join(map(repr, args)), ')'])\n> -    return ''.join(olist)\n> +    return ''.join((a.decode('utf-8') if isinstance(a,bytes) else a) for a in olist)\n>  \n>  cdef stdstring* py_print_function(unsigned id, args):\n>      return string_from_pystr(py_print_function_pystring(id, args))\n> }}}\n> allows to fix the issue, but I don't know if this is a desirable fix. Maybe something else is better to do when the copy is done instead. But I don't know where this is done.\n\nThanks for your comment.\\\\\nBut it doesn't seem to work in my environment.\n\n```\nsage: var('t');\nsage: x = function('x')(t);\nsage: l = [[x(t) == 1]];\nsage: l2 = deepcopy(l);\nsage: l2\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n/Applications/SageMath-9.1.app/Contents/Resources/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.pyx in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)()\n    491         olist = [func._name]\n    492     olist.extend(['(', ', '.join(map(repr, args)), ')'])\n--> 493     return ''.join((a.decode('utf-8') if isinstance(a,bytes) else a) for a in olist)\n    494 \n    495 cdef stdstring* py_print_function(unsigned id, args):\n\nTypeError: sequence item 0: expected str instance, bytes found\nException ignored in: 'sage.libs.pynac.pynac.py_print_function'\nTraceback (most recent call last):\n  File \"sage/libs/pynac/pynac.pyx\", line 493, in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)\nTypeError: sequence item 0: expected str instance, bytes found\n------------------------------------------------------------------------\n(no backtrace available)\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred.\nThis probably occurred because a *compiled* module has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nPython will now terminate.\n------------------------------------------------------------------------\n/Applications/SageMath-9.1.app/Contents/Resources/sage/src/bin/sage-python: line 2: 16125 Segmentation fault: 11  sage -python \"$@\"\n```\n",
    "created_at": "2020-06-29T23:21:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423082",
    "user": "@YunosukeY"
}
```

Replying to [comment:1 slabbe]:
> Doing
> {{{
> #!diff
> diff --git a/src/sage/libs/pynac/pynac.pyx b/src/sage/libs/pynac/pynac.pyx
> index 0ebc8b5..b87e94e 100644
> --- a/src/sage/libs/pynac/pynac.pyx
> +++ b/src/sage/libs/pynac/pynac.pyx
> `@``@` -490,7 +490,7 `@``@` def py_print_function_pystring(id, args, fname_paren=False):
>      else:
>          olist = [func._name]
>      olist.extend(['(', ', '.join(map(repr, args)), ')'])
> -    return ''.join(olist)
> +    return ''.join((a.decode('utf-8') if isinstance(a,bytes) else a) for a in olist)
>  
>  cdef stdstring* py_print_function(unsigned id, args):
>      return string_from_pystr(py_print_function_pystring(id, args))
> }}}
> allows to fix the issue, but I don't know if this is a desirable fix. Maybe something else is better to do when the copy is done instead. But I don't know where this is done.

Thanks for your comment.\\
But it doesn't seem to work in my environment.

```
sage: var('t');
sage: x = function('x')(t);
sage: l = [[x(t) == 1]];
sage: l2 = deepcopy(l);
sage: l2
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
/Applications/SageMath-9.1.app/Contents/Resources/sage/local/lib/python3.7/site-packages/sage/libs/pynac/pynac.pyx in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)()
    491         olist = [func._name]
    492     olist.extend(['(', ', '.join(map(repr, args)), ')'])
--> 493     return ''.join((a.decode('utf-8') if isinstance(a,bytes) else a) for a in olist)
    494 
    495 cdef stdstring* py_print_function(unsigned id, args):

TypeError: sequence item 0: expected str instance, bytes found
Exception ignored in: 'sage.libs.pynac.pynac.py_print_function'
Traceback (most recent call last):
  File "sage/libs/pynac/pynac.pyx", line 493, in sage.libs.pynac.pynac.py_print_function_pystring (build/cythonized/sage/libs/pynac/pynac.cpp:7182)
TypeError: sequence item 0: expected str instance, bytes found
------------------------------------------------------------------------
(no backtrace available)
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred.
This probably occurred because a *compiled* module has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Python will now terminate.
------------------------------------------------------------------------
/Applications/SageMath-9.1.app/Contents/Resources/sage/src/bin/sage-python: line 2: 16125 Segmentation fault: 11  sage -python "$@"
```




---

archive/issue_comments_423083.json:
```json
{
    "body": "Replying to [comment:1 slabbe]:\n\nI noticed that the file is in Cython and tried to make it, but it failed.\n\n```\n...(I omitted)...\n[sagelib-9.1] build/cythonized/sage/tests/stl_vector.cpp: In function 'PyObject* __pyx_pf_4sage_5tests_10stl_vector_14stl_int_vector_4__getitem__(__pyx_obj_4sage_5tests_10stl_vector_stl_int_vector*, int)':\n[sagelib-9.1] build/cythonized/sage/tests/stl_vector.cpp:2892:30: warning: comparison of integer expressions of different signedness: 'int' and 'std::vector<int>::size_type' {aka 'long unsigned int'} [-Wsign-compare]\n[sagelib-9.1]  2892 |       __pyx_t_1 = (__pyx_v_i < __pyx_v_self->data->size());\n[sagelib-9.1]       |                    ~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~\n[sagelib-9.1] error: command 'gcc' failed with exit status 1\n[sagelib-9.1] make[4]: *** [sage] Error 1\n[sagelib-9.1] \n[sagelib-9.1] real      3m48.105s\n[sagelib-9.1] user      2m58.864s\n[sagelib-9.1] sys       0m23.285s\nmake[3]: *** [sagelib] Error 2\nmake[2]: *** [all-start] Error 2\n\nreal    3m48.678s\nuser    2m59.280s\nsys     0m23.488s\n***************************************************************\nError building Sage.\n\nThe following package(s) may have failed to build (not necessarily\nduring this run of 'make all-start'):\n\nIt is safe to delete any log files and build directories, but they\ncontain information that is helpful for debugging build problems.\nWARNING: If you now run 'make' again, the build directory of the\nsame version of the package will, by default, be deleted. Set the\nenvironment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.\n\nmake[1]: *** [all-start] Error 1\nmake: *** [all] Error 2\n```\n",
    "created_at": "2020-06-30T01:12:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423083",
    "user": "@YunosukeY"
}
```

Replying to [comment:1 slabbe]:

I noticed that the file is in Cython and tried to make it, but it failed.

```
...(I omitted)...
[sagelib-9.1] build/cythonized/sage/tests/stl_vector.cpp: In function 'PyObject* __pyx_pf_4sage_5tests_10stl_vector_14stl_int_vector_4__getitem__(__pyx_obj_4sage_5tests_10stl_vector_stl_int_vector*, int)':
[sagelib-9.1] build/cythonized/sage/tests/stl_vector.cpp:2892:30: warning: comparison of integer expressions of different signedness: 'int' and 'std::vector<int>::size_type' {aka 'long unsigned int'} [-Wsign-compare]
[sagelib-9.1]  2892 |       __pyx_t_1 = (__pyx_v_i < __pyx_v_self->data->size());
[sagelib-9.1]       |                    ~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~
[sagelib-9.1] error: command 'gcc' failed with exit status 1
[sagelib-9.1] make[4]: *** [sage] Error 1
[sagelib-9.1] 
[sagelib-9.1] real      3m48.105s
[sagelib-9.1] user      2m58.864s
[sagelib-9.1] sys       0m23.285s
make[3]: *** [sagelib] Error 2
make[2]: *** [all-start] Error 2

real    3m48.678s
user    2m59.280s
sys     0m23.488s
***************************************************************
Error building Sage.

The following package(s) may have failed to build (not necessarily
during this run of 'make all-start'):

It is safe to delete any log files and build directories, but they
contain information that is helpful for debugging build problems.
WARNING: If you now run 'make' again, the build directory of the
same version of the package will, by default, be deleted. Set the
environment variable SAGE_KEEP_BUILT_SPKGS=yes to prevent this.

make[1]: *** [all-start] Error 1
make: *** [all] Error 2
```




---

archive/issue_comments_423084.json:
```json
{
    "body": "Maybe it depends on the way you installed sage. For example, if you installed sage from a binary download, you may not have all the tools to compile such changes... The README of Sage gives information on the prerequisite necessary to compile sage.",
    "created_at": "2020-06-30T07:13:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423084",
    "user": "@seblabbe"
}
```

Maybe it depends on the way you installed sage. For example, if you installed sage from a binary download, you may not have all the tools to compile such changes... The README of Sage gives information on the prerequisite necessary to compile sage.



---

archive/issue_comments_423085.json:
```json
{
    "body": "Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage",
    "created_at": "2021-04-02T20:21:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423085",
    "user": "@mkoeppe"
}
```

Moving this ticket to 9.4, as it seems unlikely that it will be merged in 9.3, which is in the release candidate stage



---

archive/issue_comments_423086.json:
```json
{
    "body": "still broken in 9.5.beta0; #32480 will fix it",
    "created_at": "2021-09-06T05:49:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423086",
    "user": "@mkoeppe"
}
```

still broken in 9.5.beta0; #32480 will fix it



---

archive/issue_comments_423087.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2021-09-06T06:05:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423087",
    "user": "@mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_423088.json:
```json
{
    "body": "However, the underlying issue is that unpickling gives a segfault -- this needs to be fixed.",
    "created_at": "2021-09-06T06:08:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423088",
    "user": "@mkoeppe"
}
```

However, the underlying issue is that unpickling gives a segfault -- this needs to be fixed.



---

archive/issue_comments_423089.json:
```json
{
    "body": "Let me just point out (re: the title) the detail that the segfault occurs when printing/`repr`ing, e.g.\n\n\n```\nf = loads(dumps(function('f')(x)))\n```\n\n\nor\n\n\n```\nf = deepcopy(function('f')(x))\n```\n\n\ndoes not segfault, it is the printing of the (badly) (un)pickled/copied object that segfaults.",
    "created_at": "2021-11-09T19:48:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29781",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29781#issuecomment-423089",
    "user": "@rburing"
}
```

Let me just point out (re: the title) the detail that the segfault occurs when printing/`repr`ing, e.g.


```
f = loads(dumps(function('f')(x)))
```


or


```
f = deepcopy(function('f')(x))
```


does not segfault, it is the printing of the (badly) (un)pickled/copied object that segfaults.
