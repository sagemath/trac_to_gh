# Issue 14602: Immutable graph backend

archive/issues_014602.json:
```json
{
    "body": "Assignee: tbd\n\nCC:  dimpase azi slani simonking vbraun stefan nthiery hivert\n\nAs the title says, this patch implements a data structure atop of the current \"static sparse graphs\" which can be used as a backend for a Sage Graph. Smaller in memory, and faster.\n\nNathann\n\nIssue created by migration from https://trac.sagemath.org/ticket/14806\n\n",
    "created_at": "2013-06-22T12:35:53Z",
    "labels": [
        "PLEASE CHANGE",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.12",
    "title": "Immutable graph backend",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14602",
    "user": "ncohen"
}
```
Assignee: tbd

CC:  dimpase azi slani simonking vbraun stefan nthiery hivert

As the title says, this patch implements a data structure atop of the current "static sparse graphs" which can be used as a backend for a Sage Graph. Smaller in memory, and faster.

Nathann

Issue created by migration from https://trac.sagemath.org/ticket/14806





---

archive/issue_comments_185692.json:
```json
{
    "body": "Changing assignee from tbd to jason, ncohen, rlm.",
    "created_at": "2013-06-24T09:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185692",
    "user": "ncohen"
}
```

Changing assignee from tbd to jason, ncohen, rlm.



---

archive/issue_comments_185693.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to graph theory.",
    "created_at": "2013-06-24T09:05:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185693",
    "user": "ncohen"
}
```

Changing component from PLEASE CHANGE to graph theory.



---

archive/issue_comments_185694.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-06-24T09:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185694",
    "user": "ncohen"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_185695.json:
```json
{
    "body": "* Its either \"Thou shalt not add a vertex to an immutable graph!\"\n  (Shakespeare) or \"cannot add vertex to an immutable graph\"\n  (Python). In particular, lower case and no exclamation mark at the\n  end ;)\n\n* Methods that fail due to being immutable should raise `ValueError`,\n  not `NotImplementedError` (are you going to implement it in the\n  future?)\n\n* It would be nice if INPUT/OUTPUT were consistent and would actually\n  list all arguments, for example (though there are many more)\n  `StaticSparseBackend.degree` does not document the \"directed\"\n  argument.\n\n* static_sparse_backend module docstring \"Two classes\" names the same\n  class twice.\n\n* StaticSparseCGraph docstring: \":mod:`CGraph\n  <sage.graphs.base.c_graph>` class over :mod:`static sparse graphs\n  <sage.graphs.base.static_dense_graph>`\". I don't know what thats\n  supposed to mean.\n\n* The Python special `__copy__()` method does not allow any\n  arguments. In particular, `copy(graph)` should return a mutable copy\n  if the original `graph` is immutable.\n\n* Having to write `data_structure=\"sparse\"` is a lot less intuitive\n  than the old `sparse=True`. It would be better to allow for both\n  and raise a `ValueError` if both are changed from their default\n  values.",
    "created_at": "2013-06-24T11:57:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185695",
    "user": "vbraun"
}
```

* Its either "Thou shalt not add a vertex to an immutable graph!"
  (Shakespeare) or "cannot add vertex to an immutable graph"
  (Python). In particular, lower case and no exclamation mark at the
  end ;)

* Methods that fail due to being immutable should raise `ValueError`,
  not `NotImplementedError` (are you going to implement it in the
  future?)

* It would be nice if INPUT/OUTPUT were consistent and would actually
  list all arguments, for example (though there are many more)
  `StaticSparseBackend.degree` does not document the "directed"
  argument.

* static_sparse_backend module docstring "Two classes" names the same
  class twice.

* StaticSparseCGraph docstring: ":mod:`CGraph
  <sage.graphs.base.c_graph>` class over :mod:`static sparse graphs
  <sage.graphs.base.static_dense_graph>`". I don't know what thats
  supposed to mean.

* The Python special `__copy__()` method does not allow any
  arguments. In particular, `copy(graph)` should return a mutable copy
  if the original `graph` is immutable.

* Having to write `data_structure="sparse"` is a lot less intuitive
  than the old `sparse=True`. It would be better to allow for both
  and raise a `ValueError` if both are changed from their default
  values.



---

archive/issue_comments_185696.json:
```json
{
    "body": "Hello !\n\n> * Its either \"Thou shalt not add a vertex to an immutable graph!\"\n>   (Shakespeare) or \"cannot add vertex to an immutable graph\"\n>   (Python). In particular, lower case and no exclamation mark at the\n>   end ;)\n\nI obviously chosed the \"Thou shalt not add a vertex to an immutable graph\".\n\n> * Methods that fail due to being immutable should raise `ValueError`,\n>   not `NotImplementedError` (are you going to implement it in the\n>   future?)\n\nI change my mind so often that I wouldn't put it beyond reach. But just to please you I fixed it `:-P`\n\n> * It would be nice if INPUT/OUTPUT were consistent and would actually\n>   list all arguments, for example (though there are many more)\n>   `StaticSparseBackend.degree` does not document the \"directed\"\n>   argument.\n\nWell, I defined the \"INPUT\" where it was not, but usually the outputs are pretty clear... Not to mention that those are rather meant to Sage developpers.\n\n> * static_sparse_backend module docstring \"Two classes\" names the same\n>   class twice.\n\nIt's a poetic license.\n \n> * StaticSparseCGraph docstring: \":mod:`CGraph\n>   <sage.graphs.base.c_graph>` class over :mod:`static sparse graphs\n>   <sage.graphs.base.static_dense_graph>`\". I don't know what thats\n>   supposed to mean.\n\nThat it uses static sparse graphs as a data structure. By the way, the link and the name did not match. I rephrased it.\n\n> * The Python special `__copy__()` method does not allow any\n>   arguments. In particular, `copy(graph)` should return a mutable copy\n>   if the original `graph` is immutable.\n\nThere were arguments there before I learnt that Sage existed, and it is because this method can also be used through `G.copy(whatever)`. This being said, I don't see why one should get a mutable graph as a copy of an immutable one. Copying a tuple certainly does not make it a list, and it would produce rather unexpected behaviour `O_o`\n\n> * Having to write `data_structure=\"sparse\"` is a lot less intuitive\n>   than the old `sparse=True`. It would be better to allow for both\n>   and raise a `ValueError` if both are changed from their default\n>   values.\n\nYou have no idea how many hours I wasted on that. Unfortunately, you are right. I reversed those modifications and both keywords can now be used.\n\nPatch updated !\n\nNathann",
    "created_at": "2013-06-24T13:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185696",
    "user": "ncohen"
}
```

Hello !

> * Its either "Thou shalt not add a vertex to an immutable graph!"
>   (Shakespeare) or "cannot add vertex to an immutable graph"
>   (Python). In particular, lower case and no exclamation mark at the
>   end ;)

I obviously chosed the "Thou shalt not add a vertex to an immutable graph".

> * Methods that fail due to being immutable should raise `ValueError`,
>   not `NotImplementedError` (are you going to implement it in the
>   future?)

I change my mind so often that I wouldn't put it beyond reach. But just to please you I fixed it `:-P`

> * It would be nice if INPUT/OUTPUT were consistent and would actually
>   list all arguments, for example (though there are many more)
>   `StaticSparseBackend.degree` does not document the "directed"
>   argument.

Well, I defined the "INPUT" where it was not, but usually the outputs are pretty clear... Not to mention that those are rather meant to Sage developpers.

> * static_sparse_backend module docstring "Two classes" names the same
>   class twice.

It's a poetic license.
 
> * StaticSparseCGraph docstring: ":mod:`CGraph
>   <sage.graphs.base.c_graph>` class over :mod:`static sparse graphs
>   <sage.graphs.base.static_dense_graph>`". I don't know what thats
>   supposed to mean.

That it uses static sparse graphs as a data structure. By the way, the link and the name did not match. I rephrased it.

> * The Python special `__copy__()` method does not allow any
>   arguments. In particular, `copy(graph)` should return a mutable copy
>   if the original `graph` is immutable.

There were arguments there before I learnt that Sage existed, and it is because this method can also be used through `G.copy(whatever)`. This being said, I don't see why one should get a mutable graph as a copy of an immutable one. Copying a tuple certainly does not make it a list, and it would produce rather unexpected behaviour `O_o`

> * Having to write `data_structure="sparse"` is a lot less intuitive
>   than the old `sparse=True`. It would be better to allow for both
>   and raise a `ValueError` if both are changed from their default
>   values.

You have no idea how many hours I wasted on that. Unfortunately, you are right. I reversed those modifications and both keywords can now be used.

Patch updated !

Nathann



---

archive/issue_comments_185697.json:
```json
{
    "body": "Hello! \n\nAs promised I peeked at the code!! In general the patch looks good to me with the exception of the above comments.\n\n\n* Can we use xrange instead of range when we only iterate over something?\n\n* Can we raise a ValeError in  *'in_neighbors* if u is not in the graph as to be consistent with how out_degree works? \n\n* In the function **iterator_in_edges** why do we need the call to iter in the following line ?\n\n\n```\n            for x in iter(self.iterator_out_edges(vertices, labels)): \n\n```\n",
    "created_at": "2013-08-16T17:32:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185697",
    "user": "azi"
}
```

Hello! 

As promised I peeked at the code!! In general the patch looks good to me with the exception of the above comments.


* Can we use xrange instead of range when we only iterate over something?

* Can we raise a ValeError in  *'in_neighbors* if u is not in the graph as to be consistent with how out_degree works? 

* In the function **iterator_in_edges** why do we need the call to iter in the following line ?


```
            for x in iter(self.iterator_out_edges(vertices, labels)): 

```




---

archive/issue_comments_185698.json:
```json
{
    "body": "Cython detects \"for i in range(n)\" loops and replaces them with a C loop. So there is no point in using xrange.",
    "created_at": "2013-08-16T18:17:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185698",
    "user": "vbraun"
}
```

Cython detects "for i in range(n)" loops and replaces them with a C loop. So there is no point in using xrange.



---

archive/issue_comments_185699.json:
```json
{
    "body": "Hellooooooo !!\n\n> As promised I peeked at the code!!\n\nCooooooooooool ! `:-P`\n\n> * Can we use xrange instead of range when we only iterate over something?\n\nVolker beat me to this one.\n\n> * Can we raise a ValeError in  *'in_neighbors* if u is not in the graph as to be consistent with how out_degree works? \n\n`T_T`\n\nYou are right. Fixed.\n\n> * In the function **iterator_in_edges** why do we need the call to iter in the following line ?\n\nBecause I am an idiot. It actually explains a lot of things `:-P`\n\nFiiiiiiiiixed !\n\nNathann",
    "created_at": "2013-08-16T18:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185699",
    "user": "ncohen"
}
```

Hellooooooo !!

> As promised I peeked at the code!!

Cooooooooooool ! `:-P`

> * Can we use xrange instead of range when we only iterate over something?

Volker beat me to this one.

> * Can we raise a ValeError in  *'in_neighbors* if u is not in the graph as to be consistent with how out_degree works? 

`T_T`

You are right. Fixed.

> * In the function **iterator_in_edges** why do we need the call to iter in the following line ?

Because I am an idiot. It actually explains a lot of things `:-P`

Fiiiiiiiiixed !

Nathann



---

archive/issue_comments_185700.json:
```json
{
    "body": "Good! \n\nAs far as I am concerned the code is good to go! Do you want me to review it positively or wish for another less confused soul to review it as well?\n\n\n...as for xrange/range... I can see the reason for using range to be compatible with Python 3.x but somehow I am afraid the transition will never happen :-)",
    "created_at": "2013-08-16T18:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185700",
    "user": "azi"
}
```

Good! 

As far as I am concerned the code is good to go! Do you want me to review it positively or wish for another less confused soul to review it as well?


...as for xrange/range... I can see the reason for using range to be compatible with Python 3.x but somehow I am afraid the transition will never happen :-)



---

archive/issue_comments_185701.json:
```json
{
    "body": "Well... For me the code is good to go too, so if you agree with it I would be glad to see it in Sage ! Not to mention that I wrote this patch because of #14806, and that those guys will probably want to use it for their own dark ends once it will be merged `:-)`\n\nAs for Python 3, I don't know. It feels like it may take forever to move there, but then again things happened very efficiently to move to git, sooo... Well. Sage devs are surprising guys `:-)`\n\nNathann",
    "created_at": "2013-08-16T18:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185701",
    "user": "ncohen"
}
```

Well... For me the code is good to go too, so if you agree with it I would be glad to see it in Sage ! Not to mention that I wrote this patch because of #14806, and that those guys will probably want to use it for their own dark ends once it will be merged `:-)`

As for Python 3, I don't know. It feels like it may take forever to move there, but then again things happened very efficiently to move to git, sooo... Well. Sage devs are surprising guys `:-)`

Nathann



---

archive/issue_comments_185702.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-08-16T18:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185702",
    "user": "azi"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_185703.json:
```json
{
    "body": "Wow. THaaaaaaaaaaaaaaaaaanks ! `:-)`\n\nNathann",
    "created_at": "2013-08-16T19:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185703",
    "user": "ncohen"
}
```

Wow. THaaaaaaaaaaaaaaaaaanks ! `:-)`

Nathann



---

archive/issue_comments_185704.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-08-20T13:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185704",
    "user": "jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_185705.json:
```json
{
    "body": "This needs to be rebased to sage-5.12.beta2.",
    "created_at": "2013-08-20T13:28:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185705",
    "user": "jdemeyer"
}
```

This needs to be rebased to sage-5.12.beta2.



---

archive/issue_comments_185706.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2013-08-20T14:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185706",
    "user": "ncohen"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_185707.json:
```json
{
    "body": "Attachment [sparselabel.patch](tarball://root/attachments/some-uuid/ticket14806/sparselabel.patch) by ncohen created at 2013-08-20 14:58:39\n\nDone !",
    "created_at": "2013-08-20T14:58:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185707",
    "user": "ncohen"
}
```

Attachment [sparselabel.patch](tarball://root/attachments/some-uuid/ticket14806/sparselabel.patch) by ncohen created at 2013-08-20 14:58:39

Done !



---

archive/issue_comments_185708.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-08-30T07:12:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185708",
    "user": "jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_185709.json:
```json
{
    "body": "Merci Nathann!",
    "created_at": "2013-08-30T07:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185709",
    "user": "nthiery"
}
```

Merci Nathann!



---

archive/issue_comments_185710.json:
```json
{
    "body": "> Merci Nathann!\n\nMaintenant pour me remercier faut l'utiliser, genre pour me convaincre que je ne l'ai pas cod\u00e9 pour rien `:-P`\n\nNathann",
    "created_at": "2013-08-30T08:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14602",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14602#issuecomment-185710",
    "user": "ncohen"
}
```

> Merci Nathann!

Maintenant pour me remercier faut l'utiliser, genre pour me convaincre que je ne l'ai pas codé pour rien `:-P`

Nathann
