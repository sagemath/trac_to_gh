# Issue 19989: Implement conversion PARI <-> Python int/long without mpz

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2016-03-17 09:46:36

CC:  defeo jpflori

Convert PARI integers to/from Python integers without relying on the GMP/MPIR library.


---

Comment by jdemeyer created at 2016-03-18 11:23:50

New commits:


---

Comment by jdemeyer created at 2016-03-18 17:59:36

Changing status from new to needs_review.


---

Comment by git created at 2016-04-03 19:04:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by defeo created at 2016-04-05 09:21:50

It runs ok and all tests pass.

Minor drawbacks:
- it would be useful to have links to the Python and Pari longint specs.
- I am personally against `from ... import *`, but won't block the ticket if you want to keep it.


---

Comment by git created at 2016-04-05 11:35:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by defeo created at 2016-04-05 14:30:32

Changing status from needs_review to positive_review.


---

Comment by defeo created at 2016-04-05 14:30:32

Thanks


---

Comment by vbraun created at 2016-04-06 07:09:52


```
sage -t --long src/sage/libs/pari/gen.pyx
**********************************************************************
File "src/sage/libs/pari/gen.pyx", line 1343, in sage.libs.pari.gen.gen.__int__
Failed example:
    int(pari(-2^31))
Expected:
    -2147483648
Got:
    -2147483648L
**********************************************************************
```



---

Comment by jdemeyer created at 2016-04-06 08:13:35

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2016-04-06 10:40:12

That's a PARI bug...


---

Comment by git created at 2016-04-06 16:26:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-04-06 16:50:22

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-04-06 16:51:10

It's not a PARI bug, it's a PARI _feature_ :-)


---

Comment by jdemeyer created at 2016-04-08 20:47:20

Changing keywords from "" to "days77".


---

Comment by vdelecroix created at 2016-04-15 18:52:07

Would it be possible to test the subtle `LONG_MIN` case in `gen_to_integer`? Maybe along

```
sage: a = gen_to_integer(pari("2^63-1")); a; type(a)
9223372036854775807
<type 'int'>
sage: a = gen_to_integer(pari("2^63")); a; type(a)
9223372036854775808L
<type 'long'>
sage: a = gen_to_integer(pari("-2^63")); a; type(a)
-9223372036854775808
<type 'int'>
sage: a = gen_to_integer(pari("-2^63-1")); a; type(a)
-9223372036854775809L
<type 'long'>
```


What do you think of moving `gtoi` into PARI (not necessarily for this ticket)? This function is only about PARI's internal.


---

Comment by jdemeyer created at 2016-04-15 18:57:55

Replying to [comment:17 vdelecroix]:
> What do you think of moving `gtoi` into PARI (not necessarily for this ticket)? This function is only about PARI's internal.

Are you still in Bordeaux physically? If so, maybe you could talk to PARI upstream about this?


---

Comment by jdemeyer created at 2016-04-15 18:59:01

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-04-15 19:02:39

Replying to [comment:18 jdemeyer]:
> Replying to [comment:17 vdelecroix]:
> > What do you think of moving `gtoi` into PARI (not necessarily for this ticket)? This function is only about PARI's internal.
> 
> Are you still in Bordeaux physically? If so, maybe you could talk to PARI upstream about this?

Sadly not (I am until september in Santiago de Chile). However, I can submit a patch if not already done.


---

Comment by jdemeyer created at 2016-04-15 19:04:56

Replying to [comment:20 vdelecroix]:
> Sadly not (I am until september in Santiago de Chile).

Doesn't sound so sad :-)

> However, I can submit a patch if not already done.

For the moment, I lack the mental energy to try to push yet another patch to upstream PARI...


---

Comment by git created at 2016-04-20 10:33:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-04-20 10:35:50

I added a test which checks that the conversion of integers via PARI is the same as the Python conversion `str -> int`. By checking that the result is the same as Python, we don't need to special-case 32-bit vs. 64-bit.


---

Comment by jdemeyer created at 2016-04-20 10:35:50

Changing status from needs_work to needs_review.


---

Comment by embray created at 2016-04-22 13:46:53

So, what specifically was the issue with this that it required blacklisting GCC 4.8?  Is there a simple way to reproduce the issue, or at least a specific doctest that exhibits it that I could run?


---

Comment by jdemeyer created at 2016-04-22 13:49:35

It was some doctest in `src/sage/libs/pari/convert.pyx`. Let me know if you're unable to reproduce it.


---

Comment by embray created at 2016-04-25 10:15:24

Okay, I'll give it a look.  I appreciate the need for the blacklisting _for now_ just to get moving on things.  But it will be good to fix if I can. I have set `SAGE_INSTALL_GCC=no` on my system, but that will mean I'll ultimately have a broken Sage if we can't resolve this :(


---

Comment by git created at 2016-05-17 12:02:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-05-17 19:42:59

I'm now using the flag `-fno-tree-copyrename` which seems to fix all instances of the GCC 4.8 problem.


---

Comment by embray created at 2016-05-19 10:08:19

Interesting--not sure why that would do it but okay.  But if it's not a problem on newer GCC versions maybe whatever the problem is is since fixed.

This might have something to do with it: https://gcc.gnu.org/ml/gcc-patches/2015-03/msg01460.html


---

Comment by jdemeyer created at 2016-05-19 11:20:19

Replying to [comment:31 embray]:
> Interesting--not sure why that would do it but okay.  But if it's not a problem on newer GCC versions maybe whatever the problem is is since fixed.

The problem is indeed fixed in GCC-4.9, see http://gcc.gnu.org/bugzilla/show_bug.cgi?id=56982


---

Comment by vdelecroix created at 2016-05-30 09:25:56

Could you use the macro `Py_SIZE` instead of calling `py_long_object->ob_size`? In particular, it will simplify the switch to Python3. Sadly, Cython does not accept the macro expansion `Py_SIZE(my_object) = whatever` and the C-API does not document an alternative way of doing things.


---

Comment by jdemeyer created at 2016-05-30 09:34:34

Replying to [comment:33 vdelecroix]:
> In particular, it will simplify the switch to Python3.

I don't understand why: `ob_size` still exists in Python 3.

Especially given that we cannot assign to `Py_SIZE()`, I don't really see the point.


---

Comment by vdelecroix created at 2016-05-30 10:00:23

In Python 3 `(<PyLongObject*>x).ob_size` just doesn't compile

```
.../cython_test.c: In function ‘__pyx_pf_11cython_test_f’:
.../cython_test.c:593:61: error: ‘PyLongObject’ has no member named ‘ob_size’
   __pyx_t_1 = PyInt_FromSsize_t(((PyLongObject *)__pyx_v_s)->ob_size); if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 8; __pyx_clineno = __LINE__; goto __pyx_L1_error;}                                           
```



---

Comment by jdemeyer created at 2016-05-30 10:06:52

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-05-30 10:06:52

I see. Python 3 adds an extra level of indirection `ob_base->ob_size`.


---

Comment by jdemeyer created at 2016-05-31 09:58:31

On the other hand, to avoid getting stuck, I would prefer to defer the Python 3 porting to a new ticket.


---

Comment by jdemeyer created at 2016-05-31 09:58:31

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2016-05-31 10:01:36

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2016-05-31 10:01:36

Changing keywords from "days77" to "days77, days74".


---

Comment by vbraun created at 2016-05-31 22:53:55

Resolution: fixed
