# Issue 19583: Improve __eq__ for triangular module morphisms

archive/issues_019583.json:
```json
{
    "body": "Assignee: @tscrim\n\nCC:  @darijgr @nthiery simonking\n\nKeywords: triangular module morphism\n\nRight now, a comparison by the underlying `__dict__` is done, which causes problems when trying to define a cached method on a morphism. We need to implement a better `__eq__` for each subclass with more controllable behavior. See the discussion on #19609.\n\nIssue created by migration from https://trac.sagemath.org/ticket/19820\n\n",
    "created_at": "2016-01-01T23:32:08Z",
    "labels": [
        "categories",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.6",
    "title": "Improve __eq__ for triangular module morphisms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19583",
    "user": "@tscrim"
}
```
Assignee: @tscrim

CC:  @darijgr @nthiery simonking

Keywords: triangular module morphism

Right now, a comparison by the underlying `__dict__` is done, which causes problems when trying to define a cached method on a morphism. We need to implement a better `__eq__` for each subclass with more controllable behavior. See the discussion on #19609.

Issue created by migration from https://trac.sagemath.org/ticket/19820





---

archive/issue_comments_269071.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-01-01T23:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269071",
    "user": "@tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_269072.json:
```json
{
    "body": "New commits:",
    "created_at": "2016-01-01T23:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269072",
    "user": "@tscrim"
}
```

New commits:



---

archive/issue_comments_269073.json:
```json
{
    "body": "some failing doctests, due to use of cmp instead of key",
    "created_at": "2016-11-04T19:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269073",
    "user": "@fchapoton"
}
```

some failing doctests, due to use of cmp instead of key



---

archive/issue_comments_269074.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-11-04T19:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269074",
    "user": "@fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_269075.json:
```json
{
    "body": "Why is there no `__ne__` implementation? I do not really see where such an implementation should come from, i.e., it just checks inequality on generators I believe. In fact (without claiming that this has any mathematical content)\n\n```\nsage: f = X.module_morphism(on_basis=X.monomial, zero=X.monomial(0), category=Sets())\nsage: \nsage: g = X.module_morphism(on_basis=X.monomial, zero=X.zero(), category=Sets())\nsage: \nsage: f == g\nFalse\nsage: f != g\nFalse\n```\n\nSo, I guess we should override the `_richcmp_` implementation instead.",
    "created_at": "2016-11-20T02:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269075",
    "user": "@saraedum"
}
```

Why is there no `__ne__` implementation? I do not really see where such an implementation should come from, i.e., it just checks inequality on generators I believe. In fact (without claiming that this has any mathematical content)

```
sage: f = X.module_morphism(on_basis=X.monomial, zero=X.monomial(0), category=Sets())
sage: 
sage: g = X.module_morphism(on_basis=X.monomial, zero=X.zero(), category=Sets())
sage: 
sage: f == g
False
sage: f != g
False
```

So, I guess we should override the `_richcmp_` implementation instead.



---

archive/issue_comments_269076.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-20T03:50:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269076",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269077.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-11-20T03:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269077",
    "user": "@saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_269078.json:
```json
{
    "body": "Travis: Could you have a look at my changes? I implemented `_richcmp_`, to provide an implementation of `!=`. I also, removed the comparison on `_cmp` since I did not understand where this property would come from. Finally, I removed one call to the superclass, since `self._on_basis == other._on_basis` causes an infinite recursion when `_on_basis` is a normal method since comparing it triggers comparison of the `im_self` attribute\u2026\n\nTo be honest, I do not really understand what much if this code is about, so I might have broken something.",
    "created_at": "2016-11-20T03:52:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269078",
    "user": "@saraedum"
}
```

Travis: Could you have a look at my changes? I implemented `_richcmp_`, to provide an implementation of `!=`. I also, removed the comparison on `_cmp` since I did not understand where this property would come from. Finally, I removed one call to the superclass, since `self._on_basis == other._on_basis` causes an infinite recursion when `_on_basis` is a normal method since comparing it triggers comparison of the `im_self` attribute…

To be honest, I do not really understand what much if this code is about, so I might have broken something.



---

archive/issue_comments_269079.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-20T12:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269079",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269080.json:
```json
{
    "body": "Just my 2 cents: IIRC, the main motivation so far for the implementation of `__eq__` was to please pickling tests. We can't hope to have `==` on triangular module morphisms to be mathematical equality in general (this would require to have mathematical equality on arbitrary Python functions). If there is an easy way to get \"syntactical equality\" (e.g. when a morphism is built twice from the same function), that's a nice improvement.\n\nCheers,",
    "created_at": "2016-11-20T19:30:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269080",
    "user": "@nthiery"
}
```

Just my 2 cents: IIRC, the main motivation so far for the implementation of `__eq__` was to please pickling tests. We can't hope to have `==` on triangular module morphisms to be mathematical equality in general (this would require to have mathematical equality on arbitrary Python functions). If there is an easy way to get "syntactical equality" (e.g. when a morphism is built twice from the same function), that's a nice improvement.

Cheers,



---

archive/issue_comments_269081.json:
```json
{
    "body": "nthiery: Sure. As we discussed at some point, mathematical equality is probably not what we should aim for in the first place: `==` should detect whether two objects are indistinguishable (in a reasonable sense,) everything else does not play well with dictionaries, hashes, \u2026 in the long run.\nAnyway, if we have `==` we should at least have a `!=`.",
    "created_at": "2016-11-20T21:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269081",
    "user": "@saraedum"
}
```

nthiery: Sure. As we discussed at some point, mathematical equality is probably not what we should aim for in the first place: `==` should detect whether two objects are indistinguishable (in a reasonable sense,) everything else does not play well with dictionaries, hashes, … in the long run.
Anyway, if we have `==` we should at least have a `!=`.



---

archive/issue_comments_269082.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-11-24T23:26:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269082",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269083.json:
```json
{
    "body": "The patchbot still complains about a few `cmp`s. These are, however, not actual invocations of the cmp function of python but just a keyword argument that is called `cmp`.\n----\nNew commits:\n----\nNew commits:",
    "created_at": "2016-11-24T23:26:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269083",
    "user": "@saraedum"
}
```

The patchbot still complains about a few `cmp`s. These are, however, not actual invocations of the cmp function of python but just a keyword argument that is called `cmp`.
----
New commits:
----
New commits:



---

archive/issue_comments_269084.json:
```json
{
    "body": "warning: this is going to conflict very heavily with one closed python3 ticket, which already did the same job\n\n**EDIT**: or maybe not, I confused two morphism files",
    "created_at": "2016-11-25T06:57:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269084",
    "user": "@fchapoton"
}
```

warning: this is going to conflict very heavily with one closed python3 ticket, which already did the same job

**EDIT**: or maybe not, I confused two morphism files



---

archive/issue_comments_269085.json:
```json
{
    "body": "It would be great if somebody who understands what these classes are supposed to do could have a look at my changes. This is a dependency of #21996. But sadly, the people who care about #21996 are not exactly sure what these classes here are doing, so we can not review this ourselves. Thanks!",
    "created_at": "2016-12-06T21:47:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269085",
    "user": "@saraedum"
}
```

It would be great if somebody who understands what these classes are supposed to do could have a look at my changes. This is a dependency of #21996. But sadly, the people who care about #21996 are not exactly sure what these classes here are doing, so we can not review this ourselves. Thanks!



---

archive/issue_comments_269086.json:
```json
{
    "body": "I have been told not to use magic numbers \"op == 2\" but rather \"op == Py_NE\" or \"op == op_NE\", imported from somwhere.",
    "created_at": "2016-12-11T14:55:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269086",
    "user": "@fchapoton"
}
```

I have been told not to use magic numbers "op == 2" but rather "op == Py_NE" or "op == op_NE", imported from somwhere.



---

archive/issue_comments_269087.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-12-11T17:37:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269087",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269088.json:
```json
{
    "body": "Thanks, I did not know that there was `op_NE`.",
    "created_at": "2016-12-11T17:38:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269088",
    "user": "@saraedum"
}
```

Thanks, I did not know that there was `op_NE`.



---

archive/issue_comments_269089.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-16T16:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269089",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269090.json:
```json
{
    "body": "Changing keywords from \"triangular module morphism\" to \"triangular module morphism, days85\".",
    "created_at": "2017-03-16T16:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269090",
    "user": "@tscrim"
}
```

Changing keywords from "triangular module morphism" to "triangular module morphism, days85".



---

archive/issue_comments_269091.json:
```json
{
    "body": "I made it `return NotImplemented` instead of raising an error because that is the more standard way of doing things. Specifically it allows the other object to try its comparison operations. If my changes are good, then positive review.",
    "created_at": "2017-03-16T16:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269091",
    "user": "@tscrim"
}
```

I made it `return NotImplemented` instead of raising an error because that is the more standard way of doing things. Specifically it allows the other object to try its comparison operations. If my changes are good, then positive review.



---

archive/issue_comments_269092.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-03-16T18:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269092",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_269093.json:
```json
{
    "body": "`_richcmp_()` will only get called for equal parents. So this check is not needed: `self.parent() == other.parent()`\n\n(just pointing this point, I don't actually care about this ticket)",
    "created_at": "2017-03-16T18:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269093",
    "user": "@jdemeyer"
}
```

`_richcmp_()` will only get called for equal parents. So this check is not needed: `self.parent() == other.parent()`

(just pointing this point, I don't actually care about this ticket)



---

archive/issue_comments_269094.json:
```json
{
    "body": "In case that this parent only has one element class (which is often the case), also the check \n\n```\nself.__class__ is other.__class__\n```\n\ncan be skipped.",
    "created_at": "2017-03-16T18:20:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269094",
    "user": "@jdemeyer"
}
```

In case that this parent only has one element class (which is often the case), also the check 

```
self.__class__ is other.__class__
```

can be skipped.



---

archive/issue_comments_269095.json:
```json
{
    "body": "Just remove this line instead of commenting it:\n\n```\n#from sage.misc.cachefunc import cached_method, cached_function\n```\n",
    "created_at": "2017-03-16T18:20:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269095",
    "user": "@jdemeyer"
}
```

Just remove this line instead of commenting it:

```
#from sage.misc.cachefunc import cached_method, cached_function
```




---

archive/issue_comments_269096.json:
```json
{
    "body": "Replying to [comment:16 saraedum]:\n> Thanks, I did not know that there was `op_NE`.\n\nIt was added pretty recently to Sage. It is there to allow pure Python code to use/implement rich comparisons the same way as Cython.",
    "created_at": "2017-03-16T18:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269096",
    "user": "@jdemeyer"
}
```

Replying to [comment:16 saraedum]:
> Thanks, I did not know that there was `op_NE`.

It was added pretty recently to Sage. It is there to allow pure Python code to use/implement rich comparisons the same way as Cython.



---

archive/issue_comments_269097.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-03-16T21:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269097",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_269098.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-03-16T21:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269098",
    "user": "@tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_269099.json:
```json
{
    "body": "Essentially all of these could be created from the same parent (`Hom(V,W)`) as the classes represent certain special properties of the morphism. So we have to check the class. However, I've removed the commented line and the parent comparisons.",
    "created_at": "2017-03-16T21:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269099",
    "user": "@tscrim"
}
```

Essentially all of these could be created from the same parent (`Hom(V,W)`) as the classes represent certain special properties of the morphism. So we have to check the class. However, I've removed the commented line and the parent comparisons.



---

archive/issue_comments_269100.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-03-16T21:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269100",
    "user": "@saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_269101.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-03-27T20:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19583",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19583#issuecomment-269101",
    "user": "@vbraun"
}
```

Resolution: fixed
