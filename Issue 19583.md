# Issue 19583: Improve __eq__ for triangular module morphisms

Issue created by migration from Trac.

Original creator: tscrim

Original creation time: 2016-01-01 23:32:08

Assignee: tscrim

CC:  darij nthiery simonking

Keywords: triangular module morphism

Right now, a comparison by the underlying `__dict__` is done, which causes problems when trying to define a cached method on a morphism. We need to implement a better `__eq__` for each subclass with more controllable behavior. See the discussion on #19609.


---

Comment by tscrim created at 2016-01-01 23:33:41

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-01-01 23:33:41

New commits:


---

Comment by chapoton created at 2016-11-04 19:58:00

some failing doctests, due to use of cmp instead of key


---

Comment by chapoton created at 2016-11-04 19:58:00

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2016-11-20 02:54:01

Why is there no `__ne__` implementation? I do not really see where such an implementation should come from, i.e., it just checks inequality on generators I believe. In fact (without claiming that this has any mathematical content)

```
sage: f = X.module_morphism(on_basis=X.monomial, zero=X.monomial(0), category=Sets())
sage: 
sage: g = X.module_morphism(on_basis=X.monomial, zero=X.zero(), category=Sets())
sage: 
sage: f == g
False
sage: f != g
False
```

So, I guess we should override the `_richcmp_` implementation instead.


---

Comment by git created at 2016-11-20 03:50:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-11-20 03:52:52

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2016-11-20 03:52:52

Travis: Could you have a look at my changes? I implemented `_richcmp_`, to provide an implementation of `!=`. I also, removed the comparison on `_cmp` since I did not understand where this property would come from. Finally, I removed one call to the superclass, since `self._on_basis == other._on_basis` causes an infinite recursion when `_on_basis` is a normal method since comparing it triggers comparison of the `im_self` attribute…

To be honest, I do not really understand what much if this code is about, so I might have broken something.


---

Comment by git created at 2016-11-20 12:49:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by nthiery created at 2016-11-20 19:30:04

Just my 2 cents: IIRC, the main motivation so far for the implementation of `__eq__` was to please pickling tests. We can't hope to have `==` on triangular module morphisms to be mathematical equality in general (this would require to have mathematical equality on arbitrary Python functions). If there is an easy way to get "syntactical equality" (e.g. when a morphism is built twice from the same function), that's a nice improvement.

Cheers,


---

Comment by saraedum created at 2016-11-20 21:07:34

nthiery: Sure. As we discussed at some point, mathematical equality is probably not what we should aim for in the first place: `==` should detect whether two objects are indistinguishable (in a reasonable sense,) everything else does not play well with dictionaries, hashes, … in the long run.
Anyway, if we have `==` we should at least have a `!=`.


---

Comment by git created at 2016-11-24 23:26:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-11-24 23:26:46

The patchbot still complains about a few `cmp`s. These are, however, not actual invocations of the cmp function of python but just a keyword argument that is called `cmp`.
----
New commits:
----
New commits:


---

Comment by chapoton created at 2016-11-25 06:57:01

warning: this is going to conflict very heavily with one closed python3 ticket, which already did the same job

**EDIT**: or maybe not, I confused two morphism files


---

Comment by saraedum created at 2016-12-06 21:47:44

It would be great if somebody who understands what these classes are supposed to do could have a look at my changes. This is a dependency of #21996. But sadly, the people who care about #21996 are not exactly sure what these classes here are doing, so we can not review this ourselves. Thanks!


---

Comment by chapoton created at 2016-12-11 14:55:51

I have been told not to use magic numbers "op == 2" but rather "op == Py_NE" or "op == op_NE", imported from somwhere.


---

Comment by git created at 2016-12-11 17:37:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2016-12-11 17:38:18

Thanks, I did not know that there was `op_NE`.


---

Comment by git created at 2017-03-16 16:55:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-16 16:58:19

Changing keywords from "triangular module morphism" to "triangular module morphism, days85".


---

Comment by tscrim created at 2017-03-16 16:58:19

I made it `return NotImplemented` instead of raising an error because that is the more standard way of doing things. Specifically it allows the other object to try its comparison operations. If my changes are good, then positive review.


---

Comment by jdemeyer created at 2017-03-16 18:18:20

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-03-16 18:18:20

`_richcmp_()` will only get called for equal parents. So this check is not needed: `self.parent() == other.parent()`

(just pointing this point, I don't actually care about this ticket)


---

Comment by jdemeyer created at 2017-03-16 18:20:14

In case that this parent only has one element class (which is often the case), also the check 

```
self.__class__ is other.__class__
```

can be skipped.


---

Comment by jdemeyer created at 2017-03-16 18:20:59

Just remove this line instead of commenting it:

```
#from sage.misc.cachefunc import cached_method, cached_function
```



---

Comment by jdemeyer created at 2017-03-16 18:22:25

Replying to [comment:16 saraedum]:
> Thanks, I did not know that there was `op_NE`.

It was added pretty recently to Sage. It is there to allow pure Python code to use/implement rich comparisons the same way as Cython.


---

Comment by git created at 2017-03-16 21:36:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-03-16 21:38:58

Changing status from needs_work to needs_review.


---

Comment by tscrim created at 2017-03-16 21:38:58

Essentially all of these could be created from the same parent (`Hom(V,W)`) as the classes represent certain special properties of the morphism. So we have to check the class. However, I've removed the commented line and the parent comparisons.


---

Comment by saraedum created at 2017-03-16 21:47:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-03-27 20:43:00

Resolution: fixed
