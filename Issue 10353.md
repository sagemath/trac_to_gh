# Issue 10353: Remove deprecated word objects from the pickle jar

Issue created by migration from https://trac.sagemath.org/ticket/10354

Original creator: slabbe

Original creation time: 2010-11-29 17:43:37

Assignee: slabbe

CC:  abmasse saliola nthiery

The [sage-words google code](http://code.google.com/p/sage-words/) was merged into sage-3.2.2 two years ago in December 2008 (#4653). At that time, about a dozen of objects were added in the sage pickle jar using that code.

Then, in January 2009, we realized that all of our work was not that good and we started to change all the hierarchy of classes. Basically, we decided after discussions that it was better to get the mathematical classes independent of the chosen representation. This was achieved by ticket #6519 merged in sage-4.1.1 during summer 2009.

Twist in the code were made to make the dozen of old word objects pickled from version < 4.1.1 still usable. As written by Franco Saliola in #6519 :


```
this way, an old-style word can be unpickled, and during the unpickling, it
gets converted to a new-style word, and the user is given a warning to re-save
the word

[...]

This is a temporary fix: since the WordContent code is not necessary for any
other part of Sage, it will be deleted in a few months. In the meantime, if
there is anyone with some saved word objects, then unpickling will work. 
```


Those deprecation warnings now exists since more than one year, so it's now time to complete the cleaning. As I [wrote](http://groups.google.com/group/sage-combinat-devel/browse_thread/thread/440ae08a74c35df7) on sage-combinat devel mailing list in June 2010 :


```
I would like to remove those 6 pickled object from the pickle jar and replace
them with the new generation of words that got in Sage during summer 2009. This
way, it would really make sure that we do not break the pickle of objects that
are really used. Also, this will allow us to then clean up the code a lot,
because some kind of arabesques are being done to support the old stuff...

I know William prefer to keep old objects in the pickle jar, but in this case,
I would like to remove them.... Will put time on this when I have time...
```


Then, William answered in the same conversation :


```
I do prefer keeping old pickles (that's the point of the pickle jar), but I
definitely don't want to get in the way of the sage-combinatorics group, and
understand that your code is under very active development.

Thanks for the work you're doing on cleanup!

William 
```


So let's do the cleanup now!

By the way, the current output of the unpickle testing (taken from `sage/structure/sage_object.pyx`) is ugly and will be fixed by this ticket :


```
sage: std = os.environ['SAGE_DATA'] + '/extcode/pickle_jar/pickle_jar.tar.bz2'
sage: print "x"; sage.structure.sage_object.unpickle_all(std)
x
/Users/slabbe/Applications/sage-4.6/local/bin/sage-ipython:1:
DeprecationWarning: Your word object is saved in an old file format since
FiniteWord_over_OrderedAlphabet is deprecated and will be deleted in a future
version of Sage (you can use FiniteWord_list instead). You can re-save your
word by typing "word.save(filename)" to ensure that it will load in future
versions of Sage.  #!/usr/bin/env python
/Users/slabbe/Applications/sage-4.6/local/bin/sage-ipython:1:
DeprecationWarning: Your word object is saved in an old file format since
AbstractWord is deprecated and will be deleted in a future version of Sage (you
can use FiniteWord_list instead). You can re-save your word by typing
"word.save(filename)" to ensure that it will load in future versions of Sage.
#!/usr/bin/env python
/Users/slabbe/Applications/sage-4.6/local/bin/sage-ipython:1:
DeprecationWarning: Your word object is saved in an old file format since
Word_over_Alphabet is deprecated and will be deleted in a future version of
Sage (you can use FiniteWord_list instead). You can re-save your word by typing
"word.save(filename)" to ensure that it will load in future versions of Sage.
#!/usr/bin/env python
/Users/slabbe/Applications/sage-4.6/local/bin/sage-ipython:1:
DeprecationWarning: Your word object is saved in an old file format since
Word_over_OrderedAlphabet is deprecated and will be deleted in a future version
of Sage (you can use FiniteWord_list instead). You can re-save your word by
typing "word.save(filename)" to ensure that it will load in future versions of
Sage.  #!/usr/bin/env python
/Users/slabbe/Applications/sage-4.6/local/bin/sage-ipython:1:
DeprecationWarning: ChristoffelWord_Lower is deprecated, use
LowerChristoffelWord instead #!/usr/bin/env python
Successfully unpickled 586 objects.
Failed to unpickle 0 objects.
```


The goal of this ticket is to remove, update or add objects to the pickle jar so that one can remove the deprecated file `sage/combinat/words/utils.py` and `sage/combinat/words/content.py`. I need more testing to do before saying what to do on each object, but the following objects will be certainly considered :

 - `_class__sage_combinat_lyndon_word_LyndonWords_evaluation__.sobj`
 - `_class__sage_combinat_lyndon_word_LyndonWords_nk__.sobj`
 - `_class__sage_combinat_lyndon_word_StandardBracketedLyndonWords_nk__.sobj`
 - `_class__sage_combinat_subword_Subwords_w__.sobj`
 - `_class__sage_combinat_subword_Subwords_wk__.sobj`
 - `_class__sage_combinat_words_alphabet_OrderedAlphabet_Finite__.sobj`
 - `_class__sage_combinat_words_alphabet_OrderedAlphabet_NaturalNumbers__.sobj`
 - `_class__sage_combinat_words_alphabet_OrderedAlphabet_PositiveIntegers__.sobj`
 - `_class__sage_combinat_words_morphism_WordMorphism__.sobj`
 - `_class__sage_combinat_words_shuffle_product_ShuffleProduct_overlapping__.sobj`
 - `_class__sage_combinat_words_shuffle_product_ShuffleProduct_overlapping_r__.sobj`
 - `_class__sage_combinat_words_shuffle_product_ShuffleProduct_shifted__.sobj`
 - `_class__sage_combinat_words_shuffle_product_ShuffleProduct_w1w2__.sobj`
 - `_class__sage_combinat_words_suffix_trees_ImplicitSuffixTree__.sobj`
 - `_class__sage_combinat_words_suffix_trees_SuffixTrie__.sobj`
 - `_class__sage_combinat_words_utils_Factorization__.sobj`
 - `_class__sage_combinat_words_word_AbstractWord__.sobj`
 - `_class__sage_combinat_words_word_Word_over_Alphabet__.sobj`
 - `_class__sage_combinat_words_word_Word_over_OrderedAlphabet__.sobj`
 - `_class__sage_combinat_words_word_content_WordContentFromFunction__.sobj`
 - `_class__sage_combinat_words_word_content_WordContentFromList__.sobj`
 - `_class__sage_combinat_words_word_generators_ChristoffelWord_Lower__.sobj`
 - `_class__sage_combinat_words_word_generators_WordGenerator__.sobj`
 - `_class__sage_combinat_words_words_FiniteWords_length_k_over_OrderedAlphabet__.sobj`
 - `_class__sage_combinat_words_words_FiniteWords_over_OrderedAlphabet__.sobj`
 - `_class__sage_combinat_words_words_InfiniteWords_over_OrderedAlphabet__.sobj`
 - `_class__sage_combinat_words_words_Words_n__.sobj`
 - `_class__sage_combinat_words_words_Words_over_Alphabet__.sobj`
 - `_class__sage_combinat_words_words_Words_over_OrderedAlphabet__.sobj`


For references, a ticket where objects were removed/updated from the pickle jar : #8911. The update was made by uploading the modified `sage/data/extcode/pickle_jar.tar.bz2` directly on the trac ticket.


---

Comment by slabbe created at 2011-01-28 19:26:40

Here is a pickle jar made of the objects I am adding to the pickle jar :

http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2


---

Comment by slabbe created at 2011-01-28 19:41:22

Here is the command I am using to remove the 19 pickled object from the pickle_jar directory :


``` 
mv _class__sage_combinat_words_morphism_WordMorphism__.sobj
_class__sage_combinat_words_shuffle_product_ShuffleProduct_overlapping__.sobj
_class__sage_combinat_words_shuffle_product_ShuffleProduct_overlapping_r__.sobj
_class__sage_combinat_words_shuffle_product_ShuffleProduct_shifted__.sobj
_class__sage_combinat_words_shuffle_product_ShuffleProduct_w1w2__.sobj
_class__sage_combinat_words_suffix_trees_ImplicitSuffixTree__.sobj
_class__sage_combinat_words_suffix_trees_SuffixTrie__.sobj
_class__sage_combinat_words_utils_Factorization__.sobj
_class__sage_combinat_words_word_AbstractWord__.sobj
_class__sage_combinat_words_word_Word_over_Alphabet__.sobj
_class__sage_combinat_words_word_Word_over_OrderedAlphabet__.sobj
_class__sage_combinat_words_word_content_WordContentFromFunction__.sobj
_class__sage_combinat_words_word_content_WordContentFromList__.sobj
_class__sage_combinat_words_word_generators_ChristoffelWord_Lower__.sobj
_class__sage_combinat_words_words_FiniteWords_length_k_over_OrderedAlphabet__.sobj
_class__sage_combinat_words_words_FiniteWords_over_OrderedAlphabet__.sobj
_class__sage_combinat_words_words_InfiniteWords_over_OrderedAlphabet__.sobj
_class__sage_combinat_words_words_Words_over_Alphabet__.sobj
_class__sage_combinat_words_words_Words_over_OrderedAlphabet__.sobj ../removed
```



``` 
mv _class__sage_combinat_words_morphism_WordMorphism__.txt
_class__sage_combinat_words_shuffle_product_ShuffleProduct_overlapping__.txt
_class__sage_combinat_words_shuffle_product_ShuffleProduct_overlapping_r__.txt
_class__sage_combinat_words_shuffle_product_ShuffleProduct_shifted__.txt
_class__sage_combinat_words_shuffle_product_ShuffleProduct_w1w2__.txt
_class__sage_combinat_words_suffix_trees_ImplicitSuffixTree__.txt
_class__sage_combinat_words_suffix_trees_SuffixTrie__.txt
_class__sage_combinat_words_utils_Factorization__.txt
_class__sage_combinat_words_word_AbstractWord__.txt
_class__sage_combinat_words_word_Word_over_Alphabet__.txt
_class__sage_combinat_words_word_Word_over_OrderedAlphabet__.txt
_class__sage_combinat_words_word_content_WordContentFromFunction__.txt
_class__sage_combinat_words_word_content_WordContentFromList__.txt
_class__sage_combinat_words_word_generators_ChristoffelWord_Lower__.txt
_class__sage_combinat_words_words_FiniteWords_length_k_over_OrderedAlphabet__.txt
_class__sage_combinat_words_words_FiniteWords_over_OrderedAlphabet__.txt
_class__sage_combinat_words_words_InfiniteWords_over_OrderedAlphabet__.txt
_class__sage_combinat_words_words_Words_over_Alphabet__.txt
_class__sage_combinat_words_words_Words_over_OrderedAlphabet__.txt ../removed
```



---

Comment by slabbe created at 2011-01-28 20:03:01

Here is the pickle jar I suggest for replacement (removed 19 word object mentionned above and added 19 new word objects) :

http://sage.math.washington.edu/home/slabbe/pickle_jar.tar.bz2

This new pickle jar should replace the one found here : `SAGE_ROOT/data/extcode/pickle_jar/pickle_jar.tar.bz2`.


---

Comment by slabbe created at 2011-01-28 20:10:47

Changing status from new to needs_review.


---

Comment by saliola created at 2011-02-18 20:42:45

Short version: positive review for the proposed changes and the proposed patch.

Slightly longer version. I dropped the provided tarball 

    [http://sage.math.washington.edu/home/slabbe/pickle_jar.tar.bz2](http://sage.math.washington.edu/home/slabbe/pickle_jar.tar.bz2)

into place and tested unpickling; everything works:

```
sage: sage.structure.sage_object.unpickle_all()
Successfully unpickled 586 objects.
Failed to unpickle 0 objects.
sage: 
```

I also compared new pickle jar directory with the old (using `diff -rq`), and no other pickles were effected.


---

Comment by saliola created at 2011-02-18 20:42:45

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-02-20 17:55:40

Instead of providing a whole new pickle jar, could you make a tarball containing *only* the new pickles?  I would prefer that for merging as opposed to replacing the pickle jar as a whole.


---

Comment by jdemeyer created at 2011-02-20 17:55:40

Changing status from positive_review to needs_work.


---

Comment by slabbe created at 2011-02-21 14:54:10

Replying to [comment:11 jdemeyer]:
> Instead of providing a whole new pickle jar, could you make a tarball containing *only* the new pickles?  I would prefer that for merging as opposed to replacing the pickle jar as a whole.

Already done. A tarball containing the new 19 pickles is here : [comment:4 comment 4]. Should Franco take a look at this tarball before putting the status back to positive review?

Also, see [comment:5 comment 5] for the command I use to remove the 19 deprecated objects from the pickle jar.


---

Comment by slabbe created at 2011-02-21 14:54:10

Changing status from needs_work to needs_review.


---

Comment by slabbe created at 2011-02-21 15:14:30

Some notes about things I learned on the pickle jar during this ticket:

1. Create a Sage object :


```
sage: w = Word(range(10))
sage: type(w)
<class 'sage.combinat.words.word.FiniteWord_list'>
```


2. Add this object to the current pickle jar:


```
sage: sage.structure.sage_object.picklejar(w)
```


3. By default, the current pickle jar is in `SAGE_ROOT/tmp/pickle_jar-4.6.1` :


```
cd sage-4.6.1/tmp/pickle_jar-4.6.1
ls
_class__sage_combinat_words_word_FiniteWord_list__.sobj
_class__sage_combinat_words_word_FiniteWord_list__.txt
```


4. The command to create a .tar.bz2 from a directory:
 

```
tar -jcvf archive_name.tar.bz2 directory_to_compress 
```



---

Comment by jdemeyer created at 2011-02-21 15:49:09

Changing status from needs_review to positive_review.


---

Attachment

I just refreshed the patch because of conflicts with #10712 merged in sage-4.6.2.


---

Comment by slabbe created at 2011-03-21 20:37:22

Applies over the precedent patch


---

Attachment

In a recent thread on [sage-combinat-devel](http://groups.google.com/group/sage-combinat-devel/browse_thread/thread/3690f524b5cae1a7), it was mentioned to revert the long test comment on the unpickleall test. I am fixing this here for practical reasons.

This last patch needs review (Nicolas Thierry proposed himself).

Sébastien


---

Comment by slabbe created at 2011-03-21 20:44:17

Changing status from positive_review to needs_work.


---

Comment by slabbe created at 2011-03-21 20:46:24

> This last patch needs review (Nicolas Thierry proposed himself).

Thiéry, sorry.


---

Comment by slabbe created at 2011-03-21 20:47:33

Changing status from needs_work to needs_review.


---

Comment by nthiery created at 2011-03-21 21:09:43

Replying to [comment:16 slabbe]:
> In a recent thread on [sage-combinat-devel](http://groups.google.com/group/sage-combinat-devel/browse_thread/thread/3690f524b5cae1a7), it was mentioned to revert the long test comment on the unpickleall test. I am fixing this here for practical reasons.
> 
> This last patch needs review (Nicolas Thiéry proposed himself).

Done. Back to positive review! (assuming the builbot is happy, which I assume it will)


---

Comment by nthiery created at 2011-03-21 21:09:51

Changing status from needs_review to positive_review.


---

Comment by slabbe created at 2011-03-21 21:36:23

> Done. Back to positive review! (assuming the builbot is happy, which I assume it will

It will not be "All tests passed!" because the buildbot is testing the applied patches with sage-4.6.2 which still uses the old pickles. But no other error should be raised.

Sébastien


---

Comment by jdemeyer created at 2011-03-27 14:02:15

The new pickles ([http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2](http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2)) are in a directory called `pickle_jar-4.6.1`.  Is there a reason for this?  If not, please fix this.


---

Comment by jdemeyer created at 2011-03-27 14:02:15

Changing status from positive_review to needs_work.


---

Comment by slabbe created at 2011-03-27 19:03:35

> The new pickles ([http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2](http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2)) are in a directory called `pickle_jar-4.6.1`.  Is there a reason for this?  

Not really. That is the default directory name when one creates pickles :


```
sage: import os
sage: os.listdir(SAGE_ROOT+'/tmp')
['COPYING.txt', 'install', 'README.txt', 'sage-README-osx.txt', 'VERSION.txt']
sage: from sage.structure.sage_object import picklejar    
sage: picklejar(matrix([0,1,1]))
sage: os.listdir(SAGE_ROOT+'/tmp')
['COPYING.txt', 'install', 'pickle_jar-4.6.2', 'README.txt', 'sage-README-osx.txt', 'VERSION.txt']
sage: os.listdir(SAGE_ROOT+'/tmp/pickle_jar-4.6.2')
['_type__sage_matrix_matrix_integer_dense_Matrix_integer_dense__.sobj', '_type__sage_matrix_matrix_integer_dense_Matrix_integer_dense__.txt']
```


> If not, please fix this.

Of course, I can rename the directory `pickle_jar-4.6.1`. What name should I chose ?

I think there are no documentation anywhere for adding/removing objects from the pickle jar. So, if there is anything I should do better, we should write it somewhere so that the next time, it will be done the right way.

Sébastien


---

Comment by jdemeyer created at 2011-03-28 08:17:57

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2011-03-28 08:17:57

Replying to [comment:25 slabbe]:
> > The new pickles ([http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2](http://sage.math.washington.edu/home/slabbe/pickle_jar_new_word_objects.tar.bz2)) are in a directory called `pickle_jar-4.6.1`.  Is there a reason for this?  
> 
> Not really. That is the default directory name when one creates pickles :
Okay, point taken.  You can leave the file as it is.

Question is: why does the default directory name for creating pickles contain the version number of Sage?  It might be better to simply use "$SAGE_ROOT/tmp/pickle_jar" without version number.


---

Comment by jdemeyer created at 2011-03-28 08:46:32

See #11069 for a follow-up.


---

Comment by jdemeyer created at 2011-03-28 19:24:51

Resolution: fixed


---

Comment by slabbe created at 2011-03-28 22:05:17

> Question is: why does the default directory name for creating pickles contain the version number of Sage?  It might be better to simply use "$SAGE_ROOT/tmp/pickle_jar" without version number.

Personally, I don't have argument for one or the other. But I know that Nicolas Thiéry proposed in #10768 (Revisit the pickle jar procedure) that :

"For each version of Sage (say 4.6.2), a fresh pickle jar (say pickle_jar-4.6.2.tar.bz2) would be produced by the release manager, and *added* to the Sage distribution."

So if this proposition is followed, maybe version number could be kept as a default. Am I confusing the name of the directory with the name of the archive?

Sébastien


---

Comment by jdemeyer created at 2011-03-29 07:33:32

I left some comments at #10768, let's see what happens.  In any case, I propose to move the discussion to the relevant tickets: #10768 and #11069 and not anymore on this ticket.
