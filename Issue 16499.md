# Issue 16499: sagenb: SandboxViolation in webassets

Issue created by migration from Trac.

Original creator: vbraun

Original creation time: 2014-07-30 01:42:26

CC:  ppurka leif rws fbissey


```
Processing webassets-0.9.tar.gz
Writing /tmp/easy_install-hklIUJ/webassets-0.9/setup.cfg
Running webassets-0.9/setup.py -q bdist_egg --dist-dir /tmp/easy_install-hklIUJ/webassets-0.9/egg-dist-tmp-Cwkw_W
error: SandboxViolation: chmod('/home/buildslave-sage/slave/sage_git/dot_sage/.python-eggs/Pillow-2.2.2-py2.7-linux-x86_64.egg-tmp/PIL/tmpelb5a7.$extract', 493) {}
```

Possibly due to the newer setuptools doing a better job at checking for shenanigans...


---

Comment by vbraun created at 2014-07-30 02:45:14

The reason is that webasset setup.py imports sphinx to do some crap. Which ultimately imports PIL/Pillow which causes the egg to be unpacked, violating the sandbox.

Why does sagenb come with webassets to start with? Its not used anywhere, it seems. Some packaged js files were generated with it?


---

Comment by vbraun created at 2014-07-30 03:19:33

I guess the ideal solution would be to use distutils / pip instead of easy_install (who cares about binary eggs)? Though that would probably be a bigger task. For now, just allow chmod outside of the setuptools sandbox (and, really, fixing permissions isn't so bad).

Updating to the latest setuptools alone didn't fix it, but we should do that anyway.
----
New commits:


---

Comment by vbraun created at 2014-07-30 03:19:33

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-07-30 03:20:04

Changing priority from major to blocker.


---

Comment by fbissey created at 2014-07-30 03:30:00

Not sure what webassets does either. Is it just me or there is a violent inflation in setuptools version numbers - worse than chrome even.


---

Comment by fbissey created at 2014-07-30 03:42:01

In fact I hadn't noticed that webassets had been upgraded past 0.7.1.


---

Comment by vbraun created at 2014-07-30 03:46:52

The whole packages-inside-sagenb thing needs to be fixed at one point, too. But this is also not the scope of this ticket, but make a new beta that can be installed from scratch.


---

Comment by vbraun created at 2014-07-30 21:13:45

This seems to be caused by #16733, so I'll unmerge that upgrade until somebody can review this.


---

Comment by vbraun created at 2014-07-30 21:14:30

Changing priority from blocker to major.


---

Comment by vbraun created at 2014-07-30 21:14:30

Changing component from user interface to packages: standard.


---

Comment by fbissey created at 2014-07-31 05:24:46

I am not convinced by the solution I will try something in the next few hours before accepting this.


---

Comment by fbissey created at 2014-07-31 09:53:40

So far I haven't been able to reproduce this. I am guessing this is a from scratch install while I am working on top of beta7 which may have an impact.


---

Comment by vbraun created at 2014-07-31 14:01:19

You probably need to (re-)install by hand the new docutils and pillow. Or rebuild from scratch (with #16733 merged in).


---

Comment by strogdon created at 2014-08-02 19:13:51

This is very curious. I merged #16733 and this ticket w/o the `sandbox.patch` (the patch was removed and the change was committed with `git commit -a`). The following sequence did not give a `SandboxViolation` in webassets:
* ./sage -f docutils
* ./sage -f setuptools
* ./sage -f sagenb
But the following sequence did yield the violation (new docutils installed)
* ./sage -f pillow
* ./sage -f setuptools
* ./sage -f sagenb
Then adding the sandbox patch in and doing
* ./sage -f setuptools
* ./sage -f sagenb
seemed to resolve things. So where is the real problem? Maybe it doesn't matter. The sandbox patch does work.


---

Comment by fbissey created at 2014-08-02 20:06:38

Interesting digging Steve. I am sure the patch works, I just think it is the wrong thing to do but I don't know any alternative, apart from trying to upgrade webassets since there is a newer release - of course it is likely it will suffer the same fate.


---

Comment by vbraun created at 2014-08-03 00:53:32

I tried upgrading webassets and it didn't work. The setup.py is till importing sphinx, so it'll die if that ends up pulling in pil(low)


---

Comment by fbissey created at 2014-08-03 03:25:37

OK so that potentially pushes the problem in sphinx and upgrading that brings its own problems. Or may be pillow, that would be easier to try that.


---

Comment by strogdon created at 2014-08-03 05:11:52

I've installed sphinx-1.2.2, merged #16733 and this ticket w/o the sandbox patch and I have no `SandboxViolation`. However, #16396 can't be merged w/o some work. Is it possible that sphinx-1.2.2 doesn't import pillow? I believe what I've done is correct. But maybe the sandbox patch is the thing to do in the short-term.


---

Comment by fbissey created at 2014-08-03 22:49:32

I really think that shooting an element of the sandbox for just one package is not good. It would be better if an exception could be made until we fix the faulty package rather than sabotaging setuptools.


---

Comment by fbissey created at 2014-08-03 22:58:51

OK the call to sphinx in webassets is really limited to

```
try:
    from sphinx.setup_command import BuildDoc
    cmdclass = {'build_sphinx': BuildDoc}
except ImportError:
    cmdclass = {}
```

at the top of setup.py There are calls in docs/conf.py but they probably won't be called if we remove the above. I propose we have a patched webassets in sagenb rather than breaking setuptools' sandbox.


---

Comment by strogdon created at 2014-08-04 23:40:29

Perhaps naive but is there any undesirable side effect of adding something like

`export PYTHON_EGG_CACHE="./.python-eggs"` 

to `build/pkgs/sagenb/spkg-install`? I'm not sure where `"."` is during the install of sagenb but it's apparently not outside the sandbox.


---

Comment by strogdon created at 2014-08-05 03:52:54

Doing the above, a build from scratch was successful w/o the sandbox patch.


---

Comment by fbissey created at 2014-08-05 10:48:55

Replying to [comment:22 strogdon]:
> Doing the above, a build from scratch was successful w/o the sandbox patch.

I definitely would take that over the current patch. It is much simpler.


---

Comment by vbraun created at 2014-08-05 12:46:33

Putting the egg cache in a location that you aren't sure of is potentially a security issue.

I've asked on sage-devel whether we can remove webassets: https://groups.google.com/d/msg/sage-devel/fEeGgVWuk7I/Nmc5kcVXfZYJ


---

Comment by vbraun created at 2014-08-11 14:29:30

Any news? If you want a different solution then post a branch...


---

Comment by fbissey created at 2014-08-11 21:15:10

I think the best fix is to push for #16396 to be finished.


---

Comment by kcrisman created at 2014-10-21 20:22:24

Just to note that [the reason for webassets](https://groups.google.com/d/msg/sage-devel/fEeGgVWuk7I/nDOHbclqLUAJ) was discovered, though hopefully this is a moot point now that #16396 is positive review.


---

Comment by fbissey created at 2014-10-21 20:51:54

I very much hope we can fix it invalid once the whole new docutils/sphinx/sagenb is in.


---

Comment by strogdon created at 2014-10-21 22:20:35

If things are fixed then there is perhaps the question of whether to upgrade setuptools anyway. But maybe another ticket.


---

Comment by strogdon created at 2014-10-21 23:59:29

OK, I've merged #16396 and #16733 on top of 6.4.beta6 and I don't see the `SandboxViolation` when building sagenb. I would feel more comfortable if someone else would also confirm this. I also tried things with setuptool-5.4.1 and when rebuilding sphinx-1.2.2 (after a make) I get an error

```
Removing old version of Sphinx...
rm: cannot remove '/64bitdev/storage/sage-git_develop/sage/local/lib/python/site-packages/Sphinx-1.2.2-py2.7.egg/sphinx': Directo
ry not empty
Error building Sphinx: 'Error deleting previous version'
```


The only file in the subject folder is

```
ls /64bitdev/storage/sage-git_develop/sage/local/lib/python/site-packages/Sphinx-1.2.2-py2.7.egg/sphinx
__init__.pyc
```



---

Comment by strogdon created at 2014-10-22 04:20:11

Well I'm unable to reproduce the above sphinx build error. I'm not sure what the source could have been. Also I see no `SandboxViolation` with setuptools-5.4.1 added on top of #16396 and #16733 without the `sandbox.patch`.


---

Comment by fbissey created at 2014-11-02 00:41:51

A bit late. I just noticed we haven't updated docutils in 6.4.rc0/rc1 because this ticket is blocking it. This is a positive review "works for me/invalid" I guess.


---

Comment by fbissey created at 2014-11-02 00:41:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-11-15 16:25:35

Resolution: invalid


---

Comment by vbraun created at 2014-11-15 16:25:35

You are supposed to set the milestone to invalid...


---

Comment by vbraun created at 2015-01-06 22:54:08

FWCW, I just triggered it again while building Sage in a subdirectory of /tmp:

```
Processing webassets-0.10.1.tar.gz
Writing /tmp/easy_install-OSzZkb/webassets-0.10.1/setup.cfg
Running webassets-0.10.1/setup.py -q bdist_egg --dist-dir /tmp/easy_install-OSzZkb/webassets-0.10.1/egg-dist-tmp-H58hNo
error: SandboxViolation: chmod('/home/vbraun/.sage/.python-eggs/Pillow-2.2.2-py2.7-linux-x86_64.egg-tmp/PIL/tmpMF0VYS.$extract', 493) {}
```



---

Comment by strogdon created at 2015-01-07 06:37:12

This is curious. I did a fresh build under /tmp after cloning from the `develop` branch and I get on my gentoo box:

```
Processing webassets-0.10.1.tar.gz
Writing /tmp/easy_install-KBbcXK/webassets-0.10.1/setup.cfg
Running webassets-0.10.1/setup.py -q bdist_egg --dist-dir /tmp/easy_install-KBbcXK/webassets-0.10.1/egg-dist-tmp-7cFRfA
warning: no files found matching 'run_tests.py'
no previously-included directories found matching 'docs/_build'
warning: no previously-included files matching 'out.css' found under directory 'examples'
warning: no previously-included files matching 'out.js' found under directory 'examples'
no previously-included directories found matching 'examples/appengine-sdk'
warning: no previously-included files matching '*.pyc' found anywhere in distribution
warning: no previously-included files matching '.gitignore' found anywhere in distribution
warning: no previously-included files matching '*.orig' found anywhere in distribution
warning: no previously-included files matching 'webassets-cache/*' found anywhere in distribution
warning: no previously-included files matching '.sass-cache/*' found anywhere in distribution
zip_safe flag not set; analyzing archive contents...
webassets.filter.__init__: module references __file__
Adding webassets 0.10.1 to easy-install.pth file
Installing webassets script to /tmp/sage_sandbox/sage/local/bin

Installed /tmp/sage_sandbox/sage/local/lib/python2.7/site-packages/webassets-0.10.1-py2.7.egg
Processing dependencies for webassets==0.10.1
Finished processing dependencies for webassets==0.10.1
```

I wonder what's up?


---

Comment by fbissey created at 2015-01-07 07:03:22

OK guys that prompt 2 questions from me:

 * Is it only happening when building in /tmp ?
 * /tmp/easy_install-${random}? is it really the spkg being installed or easy_install acting on its own?


---

Comment by vbraun created at 2015-01-07 09:21:40

Only happens when building in /tmp. Seems that easy_install does something different in that case.


---

Comment by vbraun created at 2015-02-16 22:35:06

I'm getting this again with sagenb-11.4 on some but not all user accounts. No idea what the difference is. This is in my home directory, not compiling in /tmp. 

```
Processing webassets-0.10.1.tar.gz
Writing /tmp/easy_install-AR1rXi/webassets-0.10.1/setup.cfg
Running webassets-0.10.1/setup.py -q bdist_egg --dist-dir /tmp/easy_install-AR1rXi/webassets-0.10.1/egg-dist-tmp-dpb_Mg
error: SandboxViolation: chmod('/home/vbraun/.sage/.python-eggs/Pillow-2.2.2-py2.7-linux-x86_64.egg-tmp/PIL/tmpZhc7i8.$extract', 493) {}
```

How about we just get rid of the unused webassets?


---

Comment by vbraun created at 2015-02-16 22:35:06

Changing status from closed to new.


---

Comment by vbraun created at 2015-02-16 22:35:06

Resolution changed from invalid to 


---

Comment by vbraun created at 2015-02-16 22:36:55

PS: the directory is created by setuptools just for webassets:

```
$ grep AR1rXi logs/pkgs/sagenb.log 
Writing /tmp/easy_install-AR1rXi/webassets-0.10.1/setup.cfg
Running webassets-0.10.1/setup.py -q bdist_egg --dist-dir /tmp/easy_install-AR1rXi/webassets-0.10.1/egg-dist-tmp-dpb_Mg
```



---

Comment by fbissey created at 2015-02-16 22:42:23

Yes get rid of it, especially if it is such a headache. Is the problem happening on some distros and not others or something more subtle?


---

Comment by vbraun created at 2015-02-16 22:45:07

A different account can install webassets (again in its respective home directory):

```
Processing webassets-0.10.1.tar.gz
Writing /tmp/easy_install-Fd5CnH/webassets-0.10.1/setup.cfg
Running webassets-0.10.1/setup.py -q bdist_egg --dist-dir /tmp/easy_install-Fd5CnH/webassets-0.10.1/egg-dist-tmp-f2qRbU
warning: no files found matching 'run_tests.py'
[...]
```



---

Comment by kcrisman created at 2015-02-17 01:08:02

Again, webassets is there so that people can use the "newui" branch of sagenb, which apparently people are indeed trying out and using (based on discussions there).


---

Comment by strogdon created at 2015-02-17 03:19:31

Just off the top of my head. Would it be possible to avoid the issue by removing webassets from sagenb and then installing it separately?


---

Comment by vbraun created at 2015-02-17 09:20:41

If you need webassets you can just "pip install webassets". But if its not used by default then don't ship it.


---

Comment by kcrisman created at 2015-02-17 12:43:28

> If you need webassets you can just "pip install webassets". But if its not used by default then don't ship it.

I'd be open to a pull request, but whatever solution there is should probably have a good and easy way to tell a user to install webassets _before_ they attempt to switch to that.  It's also possible migeruhito's changes with that will have removed the need for webassets, I really know nothing about it beyond why it was added (included not knowing why that was actually necessary).


---

Comment by vbraun created at 2015-02-17 13:19:57

Then just add it to the instructions for trying out the newui branch, wherever those might be.


---

Comment by jdemeyer created at 2016-04-07 20:23:51

webassets is being removed at #14840.


---

Comment by jdemeyer created at 2016-04-07 20:23:51

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-04-07 20:23:58

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-06-12 12:02:30

Resolution: fixed
