# Issue 32900: Don't use distutils in sage

archive/issues_032900.json:
```json
{
    "body": "CC:  arojas dimpase\n\nFrom #33135.\n\n- `src/sage/env.py` uses `distutils.sysconfig.get_python_inc()` which is deprecated, it has no replacement in sysconfig.\n\n Suggestion from fbissey: \"we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value.\" #33135#comment:7\n\n- `src/sage/features/__init__.py` uses `distutils.errors.CCompilerError` which is not present in `setuptools.errors`.\n\n Comment from arojas: \"I don't see any code in sagelib or cython that would emit this. Is this still needed at all?\"\n\nOnce these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33137\n\n",
    "created_at": "2022-01-09T22:37:24Z",
    "labels": [
        "misc",
        "major",
        "enhancement"
    ],
    "title": "Don't use distutils in sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32900",
    "user": "tornaria"
}
```
CC:  arojas dimpase

From #33135.

- `src/sage/env.py` uses `distutils.sysconfig.get_python_inc()` which is deprecated, it has no replacement in sysconfig.

 Suggestion from fbissey: "we could use sysconfig.get_config_var('INCLUDEPY') which should give the same value." #33135#comment:7

- `src/sage/features/__init__.py` uses `distutils.errors.CCompilerError` which is not present in `setuptools.errors`.

 Comment from arojas: "I don't see any code in sagelib or cython that would emit this. Is this still needed at all?"

Once these uses of distutils are removed, their modules can be removed from the regex in the call to filterwarnings introduced by #33135.

Issue created by migration from https://trac.sagemath.org/ticket/33137





---

archive/issue_comments_469244.json:
```json
{
    "body": "`get_config_var` as the other advantage to be usable from python 3.8 and 3.9. So we could use it now.\n\n```\nfbissey@tarazed ~ $ python3.9\nPython 3.9.9 (main, Dec  1 2021, 10:05:37) \n[GCC 11.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import distutils.sysconfig\n>>> distutils.sysconfig.get_python_inc()\n'/usr/include/python3.9'\n>>> import sysconfig\n>>> sysconfig.get_config_var('INCLUDEPY')\n'/usr/include/python3.9'\n>>> \nfbissey@tarazed ~ $ python3.8\nPython 3.8.12 (default, Nov  4 2021, 22:08:42) \n[GCC 11.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sysconfig\n>>> sysconfig.get_config_var('INCLUDEPY')\n'/usr/include/python3.8'\n>>> \n```\n",
    "created_at": "2022-01-09T23:35:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469244",
    "user": "fbissey"
}
```

`get_config_var` as the other advantage to be usable from python 3.8 and 3.9. So we could use it now.

```
fbissey@tarazed ~ $ python3.9
Python 3.9.9 (main, Dec  1 2021, 10:05:37) 
[GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import distutils.sysconfig
>>> distutils.sysconfig.get_python_inc()
'/usr/include/python3.9'
>>> import sysconfig
>>> sysconfig.get_config_var('INCLUDEPY')
'/usr/include/python3.9'
>>> 
fbissey@tarazed ~ $ python3.8
Python 3.8.12 (default, Nov  4 2021, 22:08:42) 
[GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import sysconfig
>>> sysconfig.get_config_var('INCLUDEPY')
'/usr/include/python3.8'
>>> 
```




---

archive/issue_comments_469245.json:
```json
{
    "body": "une tentative. \n----\nNew commits:",
    "created_at": "2022-01-10T20:16:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469245",
    "user": "chapoton"
}
```

une tentative. 
----
New commits:



---

archive/issue_comments_469246.json:
```json
{
    "body": "I'd have done the first part last night [exactly that code] but I couldn't push to trac. Turns out my ssh key is now too old and needs replacing :)",
    "created_at": "2022-01-10T20:38:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469246",
    "user": "fbissey"
}
```

I'd have done the first part last night [exactly that code] but I couldn't push to trac. Turns out my ssh key is now too old and needs replacing :)



---

archive/issue_comments_469247.json:
```json
{
    "body": "Salut,\n\npour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError",
    "created_at": "2022-01-10T21:03:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469247",
    "user": "chapoton"
}
```

Salut,

pour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError



---

archive/issue_comments_469248.json:
```json
{
    "body": "Replying to [comment:4 chapoton]:\n> Salut,\n> \n> pour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError\n\nToi, tu vas encore te faire taper sur les doigts parce que tu parle Fran\u00e7ais sur un syst\u00e8me o\u00f9 l'Anglais est la \"lingua Franca\" (je sais, c'est bizarre d'\u00e9crire \u00e7a).\n\nOtherwise, I am not too fussed about removing that block. I cannot see a test showing what it is supposed to catch and how. Antonio says it is a dead code path and there is clearly no proof otherwise anywhere.",
    "created_at": "2022-01-10T21:24:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469248",
    "user": "fbissey"
}
```

Replying to [comment:4 chapoton]:
> Salut,
> 
> pour le reste, on peut aussi virer le bloc, plutot que de mettre RuntimeError

Toi, tu vas encore te faire taper sur les doigts parce que tu parle Français sur un système où l'Anglais est la "lingua Franca" (je sais, c'est bizarre d'écrire ça).

Otherwise, I am not too fussed about removing that block. I cannot see a test showing what it is supposed to catch and how. Antonio says it is a dead code path and there is clearly no proof otherwise anywhere.



---

archive/issue_comments_469249.json:
```json
{
    "body": "apparemment le changement dans features est en conflit avec #32873",
    "created_at": "2022-01-11T11:44:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469249",
    "user": "chapoton"
}
```

apparemment le changement dans features est en conflit avec #32873



---

archive/issue_comments_469250.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-01-11T11:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469250",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469251.json:
```json
{
    "body": "Replying to [comment:8 chapoton]:\n> apparemment le changement dans features est en conflit avec #32873\n\nYes and I positively reviewed that ticket. I thought we were dealing with something different. In another ticket of mine about doctest failures on distro, Matthias pointed me out to three tickets - one of which I reviewed, again. It seems to me there are far too many tickets of that kind not included in 9.5.rc0. It is hard to figure out what is already on trac.",
    "created_at": "2022-01-11T18:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469251",
    "user": "fbissey"
}
```

Replying to [comment:8 chapoton]:
> apparemment le changement dans features est en conflit avec #32873

Yes and I positively reviewed that ticket. I thought we were dealing with something different. In another ticket of mine about doctest failures on distro, Matthias pointed me out to three tickets - one of which I reviewed, again. It seems to me there are far too many tickets of that kind not included in 9.5.rc0. It is hard to figure out what is already on trac.



---

archive/issue_comments_469252.json:
```json
{
    "body": "From `tornaria` #33473#comment:22:\n  indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:\n  {{{\n        # Put the Python \"system\" include dir at the end, so that\n        # any local include dirs take precedence.\n  }}}",
    "created_at": "2022-07-02T22:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469252",
    "user": "mkoeppe"
}
```

From `tornaria` #33473#comment:22:
  indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:
  {{{
        # Put the Python "system" include dir at the end, so that
        # any local include dirs take precedence.
  }}}



---

archive/issue_comments_469253.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-07-02T22:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469253",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_469254.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-07-02T23:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469254",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_469255.json:
```json
{
    "body": "Replying to [comment:12 mkoeppe]:\n> From `tornaria` #33473#comment:22:\n>   indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:\n>   {{{\n>         # Put the Python \"system\" include dir at the end, so that\n>         # any local include dirs take precedence.\n>   }}}\n\nNevertheless, I have put `sysconfig.get_config_var('INCLUDEPY')` back in: `sage.misc.cython.cython` appends some directories to the result of `sage_include_directories()`, so let's not provoke some subtle changes in the order of looking up libraries when users use the runtime Cython.",
    "created_at": "2022-07-02T23:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469255",
    "user": "mkoeppe"
}
```

Replying to [comment:12 mkoeppe]:
> From `tornaria` #33473#comment:22:
>   indeed it seems setuptools adds the python include location to the compiler command line, in fact with the following comment in setuptools/_distutils/command/build_ext.py:
>   {{{
>         # Put the Python "system" include dir at the end, so that
>         # any local include dirs take precedence.
>   }}}

Nevertheless, I have put `sysconfig.get_config_var('INCLUDEPY')` back in: `sage.misc.cython.cython` appends some directories to the result of `sage_include_directories()`, so let's not provoke some subtle changes in the order of looking up libraries when users use the runtime Cython.



---

archive/issue_comments_469256.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-02T23:27:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469256",
    "user": "mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_469257.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-09-26T00:27:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32900",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32900#issuecomment-469257",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
