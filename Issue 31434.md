# Issue 31434: add gc.collect() to the memleak test from #31313

Issue created by migration from https://trac.sagemath.org/ticket/31671

Original creator: dimpase

Original creation time: 2021-04-15 09:06:03

CC:  mderickx jhpalmieri vbraun

the memleak test added in #31313 does not use `gc.collect()`, which leads to random errors sometimes.


---

Comment by dimpase created at 2021-04-15 09:14:52

Changing status from new to needs_review.


---

Comment by dimpase created at 2021-04-15 09:14:52

New commits:


---

Comment by dimpase created at 2021-04-15 09:16:38

Please review!


---

Comment by jhpalmieri created at 2021-04-15 16:29:56

I still get the same occasional doctest failure:

```
sage [t/31671/graphs/add_gccollect_to_memleak_test] % ./sage -t src/sage/graphs/bipartite_graph.py
Running doctests with ID 2021-04-15-09-29-14-4df85c26.
Git branch: t/31671/graphs/add_gccollect_to_memleak_test
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py
**********************************************************************
File "src/sage/graphs/bipartite_graph.py", line 329, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
Failed example:
    print(round(get_memory_usage() - start_mem))
Expected:
    0.0
Got:
    1.0
**********************************************************************
1 item had failures:
   1 of  14 in sage.graphs.bipartite_graph.BipartiteGraph.__init__
    [320 tests, 1 failure, 1.32 s]
----------------------------------------------------------------------
sage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.4 seconds
    cpu time: 1.3 seconds
    cumulative wall time: 1.3 seconds
```



---

Comment by dimpase created at 2021-04-15 16:34:56

well, then there is a real platform-specific (macOS) bug.
Still, this patch makes sense to get in now and here.


---

Comment by dimpase created at 2021-04-15 16:36:03

or should we tag it as a `# known bug` ?


---

Comment by jhpalmieri created at 2021-04-15 16:53:24

I agree that the patch here can't hurt, and it could certainly help in some cases. We can merge this and separately can try to track down what's going on with OS X.


---

Comment by jhpalmieri created at 2021-04-15 16:53:24

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-04-17 21:57:17

Resolution: fixed


---

Comment by slelievre created at 2021-06-28 09:52:56

Discussed again:

- [sage-release (Sage 9.4.beta2 thread)](https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/SlwZrUBuBgAJ)


---

Comment by dimpase created at 2021-06-28 11:54:01

well, there is a bug in bipartite_graph, no way around it...
