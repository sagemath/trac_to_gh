# Issue 31434: add gc.collect() to the memleak test from #31313

archive/issues_031434.json:
```json
{
    "body": "CC:  mderickx jhpalmieri vbraun\n\nthe memleak test added in #31313 does not use `gc.collect()`, which leads to random errors sometimes.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31671\n\n",
    "created_at": "2021-04-15T09:06:03Z",
    "labels": [
        "graph theory",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "add gc.collect() to the memleak test from #31313",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31434",
    "user": "dimpase"
}
```
CC:  mderickx jhpalmieri vbraun

the memleak test added in #31313 does not use `gc.collect()`, which leads to random errors sometimes.

Issue created by migration from https://trac.sagemath.org/ticket/31671





---

archive/issue_comments_449613.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-04-15T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449613",
    "user": "dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_449614.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-04-15T09:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449614",
    "user": "dimpase"
}
```

New commits:



---

archive/issue_comments_449615.json:
```json
{
    "body": "Please review!",
    "created_at": "2021-04-15T09:16:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449615",
    "user": "dimpase"
}
```

Please review!



---

archive/issue_comments_449616.json:
```json
{
    "body": "I still get the same occasional doctest failure:\n\n```\nsage [t/31671/graphs/add_gccollect_to_memleak_test] % ./sage -t src/sage/graphs/bipartite_graph.py\nRunning doctests with ID 2021-04-15-09-29-14-4df85c26.\nGit branch: t/31671/graphs/add_gccollect_to_memleak_test\nUsing --optional=build,dochtml,homebrew,pip,sage,sage_spkg\nDoctesting 1 file.\nsage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py\n**********************************************************************\nFile \"src/sage/graphs/bipartite_graph.py\", line 329, in sage.graphs.bipartite_graph.BipartiteGraph.__init__\nFailed example:\n    print(round(get_memory_usage() - start_mem))\nExpected:\n    0.0\nGot:\n    1.0\n**********************************************************************\n1 item had failures:\n   1 of  14 in sage.graphs.bipartite_graph.BipartiteGraph.__init__\n    [320 tests, 1 failure, 1.32 s]\n----------------------------------------------------------------------\nsage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py  # 1 doctest failed\n----------------------------------------------------------------------\nTotal time for all tests: 1.4 seconds\n    cpu time: 1.3 seconds\n    cumulative wall time: 1.3 seconds\n```\n",
    "created_at": "2021-04-15T16:29:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449616",
    "user": "jhpalmieri"
}
```

I still get the same occasional doctest failure:

```
sage [t/31671/graphs/add_gccollect_to_memleak_test] % ./sage -t src/sage/graphs/bipartite_graph.py
Running doctests with ID 2021-04-15-09-29-14-4df85c26.
Git branch: t/31671/graphs/add_gccollect_to_memleak_test
Using --optional=build,dochtml,homebrew,pip,sage,sage_spkg
Doctesting 1 file.
sage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py
**********************************************************************
File "src/sage/graphs/bipartite_graph.py", line 329, in sage.graphs.bipartite_graph.BipartiteGraph.__init__
Failed example:
    print(round(get_memory_usage() - start_mem))
Expected:
    0.0
Got:
    1.0
**********************************************************************
1 item had failures:
   1 of  14 in sage.graphs.bipartite_graph.BipartiteGraph.__init__
    [320 tests, 1 failure, 1.32 s]
----------------------------------------------------------------------
sage -t --warn-long 103.4 --random-seed=0 src/sage/graphs/bipartite_graph.py  # 1 doctest failed
----------------------------------------------------------------------
Total time for all tests: 1.4 seconds
    cpu time: 1.3 seconds
    cumulative wall time: 1.3 seconds
```




---

archive/issue_comments_449617.json:
```json
{
    "body": "well, then there is a real platform-specific (macOS) bug.\nStill, this patch makes sense to get in now and here.",
    "created_at": "2021-04-15T16:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449617",
    "user": "dimpase"
}
```

well, then there is a real platform-specific (macOS) bug.
Still, this patch makes sense to get in now and here.



---

archive/issue_comments_449618.json:
```json
{
    "body": "or should we tag it as a `# known bug` ?",
    "created_at": "2021-04-15T16:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449618",
    "user": "dimpase"
}
```

or should we tag it as a `# known bug` ?



---

archive/issue_comments_449619.json:
```json
{
    "body": "I agree that the patch here can't hurt, and it could certainly help in some cases. We can merge this and separately can try to track down what's going on with OS X.",
    "created_at": "2021-04-15T16:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449619",
    "user": "jhpalmieri"
}
```

I agree that the patch here can't hurt, and it could certainly help in some cases. We can merge this and separately can try to track down what's going on with OS X.



---

archive/issue_comments_449620.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-15T16:53:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449620",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_449621.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-17T21:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449621",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_449622.json:
```json
{
    "body": "Discussed again:\n\n- [sage-release (Sage 9.4.beta2 thread)](https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/SlwZrUBuBgAJ)",
    "created_at": "2021-06-28T09:52:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449622",
    "user": "slelievre"
}
```

Discussed again:

- [sage-release (Sage 9.4.beta2 thread)](https://groups.google.com/g/sage-release/c/lmUFq4d7is0/m/SlwZrUBuBgAJ)



---

archive/issue_comments_449623.json:
```json
{
    "body": "well, there is a bug in bipartite_graph, no way around it...",
    "created_at": "2021-06-28T11:54:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31434",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31434#issuecomment-449623",
    "user": "dimpase"
}
```

well, there is a bug in bipartite_graph, no way around it...
