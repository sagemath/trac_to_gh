# Issue 17128: ATLAS does not build shared lib on Cygwin64

Issue created by migration from https://trac.sagemath.org/ticket/17365

Original creator: jpflori

Original creation time: 2014-11-18 15:32:39

CC:  tscrim vbraun gouezel

It tries to use some MSVCRT thread functions instead of Cygwin's ones and fails at link time because of undefined references.
(And later on numpy fails to build because of the same undefined references.)

See:
* https://cygwin.com/ml/cygwin/2005-01/msg00883.html
* http://msdn.microsoft.com/fr-fr/library/kdzttdcb.aspx


---

Attachment


---

Comment by jpflori created at 2014-11-18 15:33:43

Attached patch should treat Cygwin and Cygwin64 as Cygwin used to be treated already.


---

Comment by jpflori created at 2014-11-18 15:34:25

(Not tested yet, I want to reproduce a failed build first as I did not have access to the first failed build log and it takes ages...)


---

Comment by jpflori created at 2014-11-20 09:40:19

Tested now and works ok.
Or rather ATLAS now builds correctly, I don't promise it is functional at this point.


---

Comment by jpflori created at 2014-11-20 11:20:36

Changing status from new to needs_review.


---

Comment by jpflori created at 2014-11-20 11:20:36

New commits:


---

Comment by git created at 2014-11-20 11:22:05

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2014-11-25 16:06:27

I will try to get to this today or tomorrow.


---

Comment by vbraun created at 2014-12-29 11:53:04

Looks good, did you send your patch upstream?


---

Comment by jpflori created at 2014-12-29 12:23:52

Nope, I wanted to have a look at the devel version of ATLAS first (as it would also be a good thing to use it in Sage if working and more or less stabilized, the version we ship right now is very suboptimal or broken on some platforms), but found no time yet...


---

Comment by jpflori created at 2014-12-29 12:30:08

Reported upstream:
https://sourceforge.net/p/math-atlas/support-requests/975/


---

Attachment


---

Comment by tscrim created at 2015-01-01 05:55:03

I'm unable to build ATLAS with this branch on the latest `develop` + #15015 (after running a `make distclean`). I've attached the build log and I was compiling on a single thread with Win 8 on a Intel quad-core. I also ran a rebase and still got the same error - it stems from a permission denied error in part of ATLAS's source code. Is this an issue with my setup?


---

Comment by jpflori created at 2015-01-06 16:20:59

I'd say it comes from your setup.

I'll have a closer look right now.


---

Comment by jpflori created at 2015-01-06 16:25:05

The problematic files have suspicious timestamps:

```
...atlconf_misc.c: Timestamp out of range; substituting 2514-05-29 18:53:03.999999999
...atlconf_misc.c' has modification time 15759751875 s in the future
```

and end up with permission errors:

```
...atlconf_misc.c: Permission denied
```

Can you have a closer look at these files in the build directory?

But this has nothing to do with the patch here.
Maybe with our repackaged ATLAS tarball, but that was not changed here.


---

Comment by tscrim created at 2015-01-08 16:31:36

Here's some info on the file

```
$ stat atlconf_misc.c
  File: ‘atlconf_misc.c’
  Size: 25087           Blocks: 28         IO Block: 65536  regular file
Device: f458da8eh/4099463822d   Inode: 19140298416521874  Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1001/  Travis)   Gid: (  513/    None)
Access: 2015-01-01 05:44:33.963182200 -0800
Modify: 2014-07-10 09:22:02.000000000 -0700
Change: 2015-01-01 05:44:33.963182200 -0800
 Birth: 2015-01-01 05:44:33.963182200 -0800
```

This is consistent with other files that I randomly `stat`'ed, including the file permissions. However I'm not quite sure what I should be looking for...


---

Comment by jpflori created at 2015-01-12 16:06:26

`@`Sébastien: any report on this one?

`@`Travis: I don't have any clue yet for your problem...


---

Comment by gouezel created at 2015-01-12 16:13:15

With the patch (and SAGE_ATLAS_ARCH=base, so maybe some part of the configuration process was skipped), ATLAS compiles fine for me (Win 7, 4 cores, compiling on a single thread).


---

Comment by jpflori created at 2015-01-12 16:35:11

We would need to make sure that it works for a multi threaded build (e.g. with autotuning or maybe with SAGE_ATLAS_ARCH=fast if that works on Cygwin), otherwise the problematic code in ATLAS is not used IIRC.
In particular I used to build on Cygwin64 with SAGE_ATLAS_ARCH=base as well and did not have this problem until I stopped using SAGE_ATLAS_ARCH=base and that triggered a completely autotuned build.


---

Comment by jpflori created at 2015-01-13 08:02:34

Seems to work fine for me once again...
The compilation did not finish yet so I can not ensure that the thread fix is working once again, but I don't get Travis' problem.

My stat output looks similar, I'll quickly attach the (start of the) log of the ongoing build.

```
$ stat atlconf_misc.c
  Fichier : « atlconf_misc.c »
   Taille : 25087       Blocs : 28         Blocs d'E/S : 65536  fichier
Périphérique : 784a2af6h/2018126582d    Inœud : 16044073672726054  Liens : 1
Accès : (0644/-rw-r--r--)  UID : ( 1001/      jp)   GID : (  513/    None)
 Accès : 2015-01-13 06:46:54.816090400 +0100
Modif. : 2014-07-10 18:22:02.000000000 +0200
Changt : 2015-01-13 06:46:54.819090600 +0100
  Créé : 2015-01-13 06:46:54.816090400 +0100
```



---

Attachment


---

Comment by jpflori created at 2015-01-13 08:06:41

Note that I don't have timestamps issues.


---

Comment by tscrim created at 2015-01-13 14:30:28

My Win8 laptop tends to make things behave like their multithreaded...at least they seem to jump from processor to processor...so maybe that's the issue? I'll try it with `SAGE_ATLAS_ARCH=base` and/or `SAGE_ATLAS_ARCH=fast` to see if that works, and perhaps with a variety of other build flags.


---

Comment by jpflori created at 2015-01-13 14:52:27

Note that `SAGE_ATLAS_ARCH=base` explicitely disable threads so that won't actually test that the patch here is working...
The `fast` setting should use threads (if your CPU has more than one logical core).

Whatsoever, your compilation fails very early and it really looks like it is a filesystem issue.
Did you test installing ATLAS without this branch as well?


---

Comment by gouezel created at 2015-01-13 15:05:17

I am confused: I compiled with SAGE_ATLAS_ARCH=fast, and it compiles fine with and without the patch. Build time multiplied by 10 compared to SAGE_ATLAS_ARCH=base, so the flag is taken into account, but it seems from CPU use that the build was using only one core (on a CPU with 4 cores). The build was started with ./sage -f atlas, what else should I do to build it multithreaded and trigger the bug?


---

Comment by tscrim created at 2015-01-13 15:15:54

I don't remember exactly fit worked or not, but I know it didn't fail at this point. I will try it without this branch when I get back from the JMM tomorrow.


---

Comment by jpflori created at 2015-01-13 16:01:16

Just look in the log and see at the end if it built a shared lib or not.
To detect if not, you can look for "undefined ref".
Or just post your logs here and I'll tell!


---

Comment by gouezel created at 2015-01-13 16:22:27

I looked at the proper place in my logs. Compilation with SAGE_ATLAS_ARCH=fast
- with the patch, the library is correctly built
- without the patch, it is not built

So, the patch works for me. No problem such as Travis'.


---

Comment by jpflori created at 2015-01-13 18:23:04

By the way, the atlas/cblas linking situation is very broken on cygwin anyway.
See #17630.


---

Comment by tscrim created at 2015-01-17 18:05:06

I get the same error now based on develop, so it must be something specific to my Win8 machine (which is also a dual boot with Ubuntu). So don't let me hold this up.


---

Comment by jpflori created at 2015-01-17 19:00:55

So I guess that Sébastien and Volker reviews are enough.


---

Comment by jpflori created at 2015-01-17 19:00:55

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-01-23 23:40:47

Resolution: fixed


---

Comment by kcrisman created at 2015-02-23 13:53:00

(I'm making the change in name, but also it would be okay to change all previous instances to the one with the accent aigu.)
