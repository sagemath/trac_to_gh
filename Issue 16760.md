# Issue 16760: Upgrade PARI to git master

Issue created by migration from https://trac.sagemath.org/ticket/16997

Original creator: jdemeyer

Original creation time: 2014-09-17 08:28:46

CC:  pbruin fbissey




---

Comment by jdemeyer created at 2014-09-17 13:35:23

New commits:


---

Comment by git created at 2014-09-19 13:12:50

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-23 14:16:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-23 16:27:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-23 16:30:36

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-23 19:44:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-23 20:20:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-24 06:40:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-24 10:05:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-24 11:19:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-09-24 11:38:56

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2014-09-24 11:42:22

This patch changes a French book doctest.


---

Attachment

Removed patch


---

Comment by git created at 2014-10-08 14:03:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by zimmerma created at 2014-10-08 14:56:58

I removed my name in the cc list, since it makes no sense to try to maintain coherence of the french
doctests with our book: there are now too many changes which break the examples from the book.

Paul


---

Comment by git created at 2014-10-08 15:35:20

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-08 15:39:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-08 16:02:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-08 20:59:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-09 08:44:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-10-09 09:13:58

I have removed the controversial patches, it now needs review again.


---

Comment by git created at 2014-10-13 06:24:16

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-10-13 06:58:09

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-12-03 14:02:40

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-12-03 14:09:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-12-03 15:04:03

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-12-03 15:58:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2014-12-03 20:49:45

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-01-12 13:19:35

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-01-12 14:03:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-01-12 16:12:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-01-12 16:12:43

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-01-15 09:25:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-02-07 21:14:31

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-02-08 07:41:52

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-02-08 07:42:10

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2015-02-24 10:40:45

Do we change the package name to `sage-pari` as it was discussed on sage-devel?


---

Comment by fbissey created at 2015-02-24 10:52:37

After my long rant (and mostly getting stuff out of my chest) I no longer think it is necessary. Let me explain:
 * it is not just giving a name to the tarball. You would want a distinct name for the library and the executable.
 * for sanity reason you don't want to carry 2 versions of pari, one for the package and one for the library. So you get to change all the packages that link to pari at least.
 * Last but not least. There are not that many packages using pari that are not in sage and a lot of them depend on ancient pari (2.3). So unless someone pulls a list of software using pari from under their beds i think the point on maintaining the stack is moot.

I did some homework on the last point in Gentoo I am not sure what it would hold for debian but I am willing to bet it will be about the same.


---

Comment by jdemeyer created at 2015-02-24 11:32:10

By the way: if somebody actually feels like reviewing this, let me know. Then I will update the branch.


---

Comment by fbissey created at 2015-02-24 20:40:27

I'll need a little bit of time to get over all the dependency but once I get there I may review this.
One question however: is the new patch public_memory_functions.patch something waiting for inclusion upstream? As of this morning it would probably still apply (I now have a live ebuild for pari and this morning master is not *broken*, not like 2 days ago).


---

Comment by jdemeyer created at 2015-02-24 20:55:38

Replying to [comment:54 fbissey]:
> One question however: is the new patch public_memory_functions.patch something waiting for inclusion upstream?
Consider this a "transient" patch. PARI upstream has changed their stack-handling in a non-backwards-compatible way. This patch `public_memory_functions.patch` is what's needed to use the current Sage hooks for dealing with the PARI stack. A follow-up ticket could use the new PARI stack mechanism.


---

Comment by jdemeyer created at 2015-02-25 09:32:29

Replying to [comment:54 fbissey]:
> I'll need a little bit of time to get over all the dependency
What does "get over all the dependency" mean???


---

Comment by jdemeyer created at 2015-02-25 09:42:25

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2015-02-25 09:48:24

To be honest I thought there would be more package depending on pari and that more would be impacted. But apart from sage itself that's just lcalc. If we are looking at optional package there may be MaCaulay2.


---

Comment by jdemeyer created at 2015-02-25 09:56:37

`eclib` also depends on `pari`.


---

Comment by fbissey created at 2015-02-25 10:03:34

Replying to [comment:59 jdemeyer]:
> `eclib` also depends on `pari`.

And I noticed that the extent of your fix is adding the standard patching code in spkg-install. I can do some more checking with it but I can believe eclib will be unaffected since John already did a fix for pari 2.8 https://github.com/JohnCremona/eclib/commit/652337883464b277f52901c7bcaf9c71001e0c3c


---

Comment by fbissey created at 2015-02-25 10:05:24

And if we want to be complete sympow depends on pari but only through gp.


---

Comment by jdemeyer created at 2015-02-25 10:16:47

Replying to [comment:60 fbissey]:
> Replying to [comment:59 jdemeyer]:
> > `eclib` also depends on `pari`.
> 
> And I noticed that the extent of your fix is adding the standard patching code in spkg-install. I can do some more checking with it but I can believe eclib will be unaffected since John already did a fix for pari 2.8

Yes, I know. In an earlier version of this branch, I had to explicitly add a patch and the "patching loop" in `spkg-install`. I left the patching loop since it makes sense anyway to have it.

I am currently in the process of upgrading this branch to the latest PARI.


---

Comment by fbissey created at 2015-02-25 10:22:56

Can you put an spkg-src this time? "make snapshot" is not enough to reproduce a given tarball, we should know the precise commit at which you snapshot.


---

Comment by jdemeyer created at 2015-02-25 10:25:55

Replying to [comment:63 fbissey]:
> "make snapshot" is not enough to reproduce a given tarball, we should know the precise commit at which you snapshot.

The commit is in `build/pkgs/pari/package-version.txt`, is that not sufficient?


---

Comment by fbissey created at 2015-02-25 10:52:11

Replying to [comment:64 jdemeyer]:
> Replying to [comment:63 fbissey]:
> > "make snapshot" is not enough to reproduce a given tarball, we should know the precise commit at which you snapshot.
> 
> The commit is in `build/pkgs/pari/package-version.txt`, is that not sufficient?

I guess it is. I am too lazy ;)


---

Comment by git created at 2015-02-25 11:11:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-02-25 11:12:31

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-02-25 11:20:40

Replying to [comment:61 fbissey]:
> And if we want to be complete sympow depends on pari but only through gp.
I didn't know that, but you're right.


---

Comment by fbissey created at 2015-02-25 20:23:23

OK now I am starting tests. A technical question about upstream's intention. The current soname for pari 2.7 is libpari-gmp.so.4 the one from git master is libpari-gmp-2.8.so.0 do you know if it is temporary until 2.8 is released (and switch to something like libpari-gmp.so.5) or it is their plan to stick with that soname?


---

Comment by fbissey created at 2015-02-25 20:33:09

I think I found the answer to my own question in config directory. They have a different scheme for even numbered release on purpose. Which makes life hard for automated rebuilding in gentoo. I'll have to force things there.


---

Comment by fbissey created at 2015-02-25 22:47:11

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-02-25 22:47:11

OK passes a few sanity checks so this is ready for bot testing.


---

Comment by git created at 2015-02-26 12:25:14

Changing status from positive_review to needs_review.


---

Comment by git created at 2015-02-26 12:25:14

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by jdemeyer created at 2015-02-26 12:27:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-02-26 12:55:23

I also get on some buildbots:

```
sage -t --long src/sage/modular/modform_hecketriangle/hecke_triangle_group_element.py
**********************************************************************
File "src/sage/modular/modform_hecketriangle/hecke_triangle_group_element.py", line 38, in sage.modular.modform_hecketriangle.hecke_triangle_group_element.coerce_AA
Failed example:
    AA(p)._exact_field()
Expected:
    Number Field in a with defining polynomial y^16 + ... with a in ...
Got:
    Number Field in a with defining polynomial y^16 - 1312*y^14 + 864612*y^12 - 2512720*y^11 - 50780668*y^10 + 360028808*y^9 - 48779642409*y^8 + 290398268512*y^7 + 15186503722504*y^6 - 566858046818416*y^5 + 27431234189939174*y^4 - 226711842252026288*y^3 + 7395502353944441460*y^2 - 39603059247494358200*y + 911555406262192128578 with a in -25.34269035681775? - 10.68732885060488?*I
**********************************************************************
1 item had failures:
   1 of   5 in sage.modular.modform_hecketriangle.hecke_triangle_group_element.coerce_AA
    [709 tests, 1 failure, 115.89 s]
```

and

```
sage -t --long src/sage/lfunctions/dokchitser.py
**********************************************************************
File "src/sage/lfunctions/dokchitser.py", line 127, in sage.lfunctions.dokchitser.Dokchitser
Failed example:
    L.taylor_series(1,4)
Expected:
    2.90614059330736e-20 + (-1.64690098288532e-20)*z + 0.759316500288427*z^2 - 0.430302337583362*z^3 + O(z^4)  
Got:
    -1.15498883731660e-19 + (6.54528640417060e-20)*z + 0.759316500288427*z^2 - 0.430302337583362*z^3 + O(z^4)
**********************************************************************
```



---

Comment by jdemeyer created at 2015-02-26 13:01:23

The first one is because of interaction with #16976.


---

Comment by jdemeyer created at 2015-02-26 13:15:03

The `dokchitser` failure is at least related to this ticket, but I don't see what could cause the failure... Maybe there is also some interaction with another ticket?


---

Comment by git created at 2015-02-26 13:42:59

Changing status from positive_review to needs_review.


---

Comment by git created at 2015-02-26 13:42:59

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. Last 10 new commits:


---

Comment by jdemeyer created at 2015-02-26 13:43:23

Merged with #16976 and fixed first failure.


---

Comment by jdemeyer created at 2015-02-26 14:01:19

For the `dokchitser` failure, there is some annoying global state (which is probably a bug) in the `computel.gp` script. For example, in the doctest

```
        sage: E = EllipticCurve('389a')
        sage: L = E.lseries().dokchitser()
        sage: L.num_coeffs ()
        156
        sage: L.derivative(1,E.rank())
        1.51863300057685
        sage: L.taylor_series(1,4)
        2.90760251490292e-20 + (-1.64772944938078e-20)*z + 0.759316500288427*z^2 - 0.430302337583362*z^3 + O(z^4)  # 32-bit
        2.90614059330736e-20 + (-1.64690098288532e-20)*z + 0.759316500288427*z^2 - 0.430302337583362*z^3 + O(z^4)  # 64-bit
```


removing the `L.num_coeffs ()` test changes the last results.


---

Comment by vbraun created at 2015-02-26 14:16:07

Aren't both answers valid (up to numerical precision). Its somewhat annoying for testing purposes, maybe reset the state with other rng seeds.


---

Comment by vdelecroix created at 2015-02-26 14:21:00

Indeed

```
sage: E = EllipticCurve('389a')
sage: L = E.lseries().dokchitser()
sage: L.derivative(1,E.rank())
1.51863300057685
sage: s4_1 = L.taylor_series(1,4)
sage: L.num_coeffs ()
156
sage: s4_2 = L.taylor_series(1,4)
sage: s4_1 == s4_2
False
sage: s4_1 - s4_2
-2.90886971068887e-20 + (1.64844756535569e-20)*z + O(z^4)
```



---

Comment by jdemeyer created at 2015-02-26 14:37:20

AFAIK, it's not a rng issue. It's just that the result depends on seemingly unrelated things (like whether or not `L.num_coeffs()` has been called).

Volker, do have an idea which elliptic-curve/L-function related ticket could have caused this?


---

Comment by vbraun created at 2015-02-26 14:59:11

All doctests pass without the pari update, so its this ticket.


---

Comment by jdemeyer created at 2015-02-26 16:05:29

Replying to [comment:83 vbraun]:
> All doctests pass without the pari update, so its this ticket.
All doctests also pass when just this ticket is applied, so it must be some interaction between this ticket and another unspecified ticket.


---

Comment by vdelecroix created at 2015-02-26 16:15:02

Sided note: why is `dokchister` included as such in Sage source files? Wouldn't it be better as an external gp library (let say `$SAGE_ROOT/local/pari/`)? Morever, we ship version 1.3 and current version is 1.3.3 (see [http://www.maths.bris.ac.uk/~matyd/computel/index.html](http://www.maths.bris.ac.uk/~matyd/computel/index.html)). Though the last version does not solve the issue at all (but at least the `src/ext/pari/dokchister/testall` script is not emitting any warning anymore).


---

Comment by jdemeyer created at 2015-02-26 16:18:52

Replying to [comment:85 vdelecroix]:
> Sided note: why is `dokchister` included as such in Sage source files?
Historical reasons. There are various such scripts in `src/ext`.

> Wouldn't it be better as an external gp library (let say `$SAGE_ROOT/local/pari/`)? Morever, we ship version 1.3 and current version is 1.3.3 (see [http://www.maths.bris.ac.uk/~matyd/computel/index.html](http://www.maths.bris.ac.uk/~matyd/computel/index.html)). Though the last version does not solve the issue at all (but at least the `src/ext/pari/dokchister/testall` script is not emitting any warning anymore).
Perhaps, but let's leave that for a different ticket.


---

Comment by git created at 2015-02-27 16:28:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-03-01 20:44:48

I cannot reproduce the `src/sage/lfunctions/dokchitser.py` failure, even with 6.6.beta2. Can you confirm that the problem still exists?


---

Comment by vbraun created at 2015-03-02 08:57:17

Yep, still happens (this time on UW redhawk)


---

Comment by fbissey created at 2015-03-02 09:09:21

What kind of machine is redhawk?


---

Comment by jdemeyer created at 2015-03-02 09:14:06

I guess we could easily solve this with some `# tol` but I'm very curious to know _why_ this is happening. It would be the first time that the result of PARI was different on different 64-bit systems (it is well known that PARI often has different results for 32-bit vs. 64-bit, but all 32-bit and all 64-bit systems should be the same).


---

Comment by zimmerma created at 2015-03-02 09:18:09

> but all 32-bit and all 64-bit systems should be the same).

I would not bet on this. It suffices that some processor provides a fused multiply-add and
that Pari uses it to get different results.

Paul


---

Comment by jdemeyer created at 2015-03-02 09:23:32

Replying to [comment:92 zimmerma]:
> > but all 32-bit and all 64-bit systems should be the same).
> 
> I would not bet on this. It suffices that some processor provides a fused multiply-add and
> that Pari uses it to get different results.

As far as I know, PARI doesn't use native floating-point operations. They use custom arbitrary-precision arithmetic which shouldn't depend on the system.

The reason there is a difference between 32-bit and 64-bit is because their precision is measured in words: some computation which would use 96 bits on a 32-bit system would use 128 bits on a 64-bit system.


---

Comment by jdemeyer created at 2015-03-02 14:17:35

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2015-03-02 14:17:35

I confirm that PARI indeed gives a different result on redhawk. Upgrading Dokchitser's GP scripts seems to fix the issue, so that is what I will do.


---

Comment by git created at 2015-03-02 14:40:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-03-02 14:53:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-03-02 14:55:31

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2015-03-02 14:56:49

Note: the file `computel.gp` is exactly Dokchitser's `computel` with 2 minor changes: DOS newlines converted to Unix and trailing whitespace removed.


---

Comment by fbissey created at 2015-03-02 21:41:38

I am happy to put it back to positive review.


---

Comment by fbissey created at 2015-03-02 21:41:38

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-03-02 22:31:41

Thanks, let's hope it can be merged this time.


---

Comment by vbraun created at 2015-03-03 13:08:22

I now get this on linux 32-bit:

```
sage -t --long src/doc/en/reference/coercion/index.rst
**********************************************************************
File "src/doc/en/reference/coercion/index.rst", line 65, in doc.en.reference.coercion.index
Failed example:
    f = EllipticCurve('37a').lseries().taylor_series(10); f
Expected:
    0.997997869801216 + 0.00140712894524925*z - 0.000498127610960097*z^2 + 0.000118835596665956*z^3 - 0.0000215906522442707*z^4 + (3.20363155418419e-6)*z^5 + O(z^6)
Got:
    0.990010459847588 + 0.0191338632530789*z - 0.0197489006172923*z^2 + 0.0137240085327618*z^3 - 0.00703880791607153*z^4 + 0.00280906165766519*z^5 + O(z^6)
**********************************************************************
1 item had failures:
   1 of  99 in doc.en.reference.coercion.index
    [84 tests, 1 failure, 0.98 s]
```



---

Comment by vbraun created at 2015-03-03 13:08:22

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-03-03 15:52:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-03-03 15:53:51

Fixed and tested on arando (32-bit).


---

Comment by jdemeyer created at 2015-03-03 15:53:51

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-03-03 20:46:10

Resolution: fixed


---

Comment by tmonteil created at 2015-03-05 17:07:07

Doctests should help tracking bugs, not hide them (last commit). Last digit noise is ok but 0.990010459847588  should not be considered as a correct 32-bits approximation of 0.997997869801216, this is too much noise and there should be a bug somewhere. Since the ticket is closed, there is a followup at #17903.
