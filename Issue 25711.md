# Issue 25711: py3: a few more miscellaneous dict iterator (dict.keys, dict.values) fixes

archive/issues_025711.json:
```json
{
    "body": "As in #25947, found by grepping through the test output.  A couple of these are far-reaching.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25948\n\n",
    "created_at": "2018-07-27T11:45:54Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.4",
    "title": "py3: a few more miscellaneous dict iterator (dict.keys, dict.values) fixes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25711",
    "user": "https://github.com/embray"
}
```
As in #25947, found by grepping through the test output.  A couple of these are far-reaching.

Issue created by migration from https://trac.sagemath.org/ticket/25948





---

archive/issue_comments_362532.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-07-27T11:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362532",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_362533.json:
```json
{
    "body": "Changing keywords from \"\" to \"sagedays@icerm\".",
    "created_at": "2018-07-27T12:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362533",
    "user": "https://github.com/tscrim"
}
```

Changing keywords from "" to "sagedays@icerm".



---

archive/issue_comments_362534.json:
```json
{
    "body": "I think it would be better to do `list(d.values())` than `list(itervalues(d))`, both because it means less `six` dependence (which means it looks like Python3 in terms of the code) and for speed in Python2:\n\n```\nsage: from six import itervalues\nsage: d = {i:i for i in range(100)}\nsage: %timeit list(itervalues(d))\nThe slowest run took 33.55 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 1.34 \u00b5s per loop\nsage: %timeit list(d.values())\nThe slowest run took 13.27 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 899 ns per loop\n```\n\nGiven that these lists are likely small (less than 100, probably averaging between 5-10), I think any memory duplication is negligible.\n\nOtherwise LGTM.",
    "created_at": "2018-07-27T12:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362534",
    "user": "https://github.com/tscrim"
}
```

I think it would be better to do `list(d.values())` than `list(itervalues(d))`, both because it means less `six` dependence (which means it looks like Python3 in terms of the code) and for speed in Python2:

```
sage: from six import itervalues
sage: d = {i:i for i in range(100)}
sage: %timeit list(itervalues(d))
The slowest run took 33.55 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.34 Âµs per loop
sage: %timeit list(d.values())
The slowest run took 13.27 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 899 ns per loop
```

Given that these lists are likely small (less than 100, probably averaging between 5-10), I think any memory duplication is negligible.

Otherwise LGTM.



---

archive/issue_comments_362535.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-27T13:29:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362535",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362536.json:
```json
{
    "body": "Added a few more; still all trivial one-liners I think.",
    "created_at": "2018-07-27T13:29:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362536",
    "user": "https://github.com/embray"
}
```

Added a few more; still all trivial one-liners I think.



---

archive/issue_comments_362537.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-27T13:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362537",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362538.json:
```json
{
    "body": "We've had this discussion before, and IMO unless you can show that it has a noticeable performance impact in this specific case I don't care enough to change it.",
    "created_at": "2018-07-27T14:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362538",
    "user": "https://github.com/embray"
}
```

We've had this discussion before, and IMO unless you can show that it has a noticeable performance impact in this specific case I don't care enough to change it.



---

archive/issue_comments_362539.json:
```json
{
    "body": "I care a little bit more. :) If my change is good, then positive review.\n----\nNew commits:",
    "created_at": "2018-07-27T20:16:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362539",
    "user": "https://github.com/tscrim"
}
```

I care a little bit more. :) If my change is good, then positive review.
----
New commits:



---

archive/issue_comments_362540.json:
```json
{
    "body": "It looks like you changed it in some places but not others.  Was that a result of more specific benchmarks?\n\nThe only reason I don't care as that the benchmark you cite could be very significant in some contexts, or very insignificant or even wrong in other contexts.  I certainly care about about more specific benchmarks.",
    "created_at": "2018-07-30T16:49:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362540",
    "user": "https://github.com/embray"
}
```

It looks like you changed it in some places but not others.  Was that a result of more specific benchmarks?

The only reason I don't care as that the benchmark you cite could be very significant in some contexts, or very insignificant or even wrong in other contexts.  I certainly care about about more specific benchmarks.



---

archive/issue_comments_362541.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-07-30T21:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362541",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_362542.json:
```json
{
    "body": "My branch\n\n```\nsage: A = ClusterAlgebra(['A',[1,2],1])\nsage: A.current_seed()\nThe initial seed of a Cluster Algebra with cluster variables x0, x1, x2 and no coefficients over Integer Ring\nsage: for k in [0,1,2]*4:\n....:     A.current_seed().mutate(k)\n....:     \nsage: %timeit A.F_polynomials_so_far()\nThe slowest run took 11.30 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 443 ns per loop\n```\n\nvs your branch\n\n```\nsage: %timeit A.F_polynomials_so_far()\nThe slowest run took 64.77 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000000 loops, best of 3: 806 ns per loop\n```\n\n\nSo while this is not a big shift in timings (despite the 2x speedup), running this method repeatedly can start taking time:\n\n```\nsage: A = ClusterAlgebra(['A',[1,2],1])\nsage: %%timeit\n....: A.reset_current_seed()\n....: for k in [0,1,2]*6:\n....:     A.current_seed().mutate(k)\n....:     A.F_polynomials_so_far()\n....: \nThe slowest run took 12.77 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.49 ms per loop\n```\n\nvs your branch\n\n```\nThe slowest run took 12.22 times longer than the fastest. This could mean that an intermediate result is being cached.\n1000 loops, best of 3: 1.58 ms per loop\n```\n\n\n----\n\nI also changed some tests as they were failing on my machine and the patchbot to make them machine-independent (I am assuming they were passing on your machine).",
    "created_at": "2018-07-30T22:05:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362542",
    "user": "https://github.com/tscrim"
}
```

My branch

```
sage: A = ClusterAlgebra(['A',[1,2],1])
sage: A.current_seed()
The initial seed of a Cluster Algebra with cluster variables x0, x1, x2 and no coefficients over Integer Ring
sage: for k in [0,1,2]*4:
....:     A.current_seed().mutate(k)
....:     
sage: %timeit A.F_polynomials_so_far()
The slowest run took 11.30 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 443 ns per loop
```

vs your branch

```
sage: %timeit A.F_polynomials_so_far()
The slowest run took 64.77 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 806 ns per loop
```


So while this is not a big shift in timings (despite the 2x speedup), running this method repeatedly can start taking time:

```
sage: A = ClusterAlgebra(['A',[1,2],1])
sage: %%timeit
....: A.reset_current_seed()
....: for k in [0,1,2]*6:
....:     A.current_seed().mutate(k)
....:     A.F_polynomials_so_far()
....: 
The slowest run took 12.77 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.49 ms per loop
```

vs your branch

```
The slowest run took 12.22 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.58 ms per loop
```


----

I also changed some tests as they were failing on my machine and the patchbot to make them machine-independent (I am assuming they were passing on your machine).



---

archive/issue_comments_362543.json:
```json
{
    "body": "> I also changed some tests as they were failing on my machine and the patchbot to make them machine-independent (I am assuming they were passing on your machine).\n\nI'm not sure I understand this.  Why would the polynomials be sorted differently on different machines?  The sorting I had looks like it makes sense.  If it was giving different results on Python 2 that still might be a real issue worth looking into instead of just doing key=str.",
    "created_at": "2018-07-31T14:09:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362543",
    "user": "https://github.com/embray"
}
```

> I also changed some tests as they were failing on my machine and the patchbot to make them machine-independent (I am assuming they were passing on your machine).

I'm not sure I understand this.  Why would the polynomials be sorted differently on different machines?  The sorting I had looks like it makes sense.  If it was giving different results on Python 2 that still might be a real issue worth looking into instead of just doing key=str.



---

archive/issue_comments_362544.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-07-31T14:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362544",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_362545.json:
```json
{
    "body": "I see, here are a couple examples:\n\n\n```\nsage -t --long src/sage/algebras/cluster_algebra.py\n**********************************************************************\nFile \"src/sage/algebras/cluster_algebra.py\", line 101, in sage.algebras.cluster_algebra\nFailed example:\n    sorted(A.cluster_variables_so_far())\nExpected:\n    [x0, x1, (x0 + 1)/x1, (x1 + 1)/x0, (x0 + x1 + 1)/(x0*x1)]\nGot:\n    [x1, (x0 + 1)/x1, x0, (x1 + 1)/x0, (x0 + x1 + 1)/(x0*x1)]\n**********************************************************************\nFile \"src/sage/algebras/cluster_algebra.py\", line 1678, in sage.algebras.cluster_algebra.ClusterAlgebra.cluster_variables_so_far\nFailed example:\n    sorted(A.cluster_variables_so_far())\nExpected:\n    [x0, x1, (x1 + 1)/x0]\nGot:\n    [x1, x0, (x1 + 1)/x0]\n```\n\n\nI'm not sure what's up with that.  Maybe there's another change on my Python 3 branch this is dependent on...",
    "created_at": "2018-07-31T14:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362545",
    "user": "https://github.com/embray"
}
```

I see, here are a couple examples:


```
sage -t --long src/sage/algebras/cluster_algebra.py
**********************************************************************
File "src/sage/algebras/cluster_algebra.py", line 101, in sage.algebras.cluster_algebra
Failed example:
    sorted(A.cluster_variables_so_far())
Expected:
    [x0, x1, (x0 + 1)/x1, (x1 + 1)/x0, (x0 + x1 + 1)/(x0*x1)]
Got:
    [x1, (x0 + 1)/x1, x0, (x1 + 1)/x0, (x0 + x1 + 1)/(x0*x1)]
**********************************************************************
File "src/sage/algebras/cluster_algebra.py", line 1678, in sage.algebras.cluster_algebra.ClusterAlgebra.cluster_variables_so_far
Failed example:
    sorted(A.cluster_variables_so_far())
Expected:
    [x0, x1, (x1 + 1)/x0]
Got:
    [x1, x0, (x1 + 1)/x0]
```


I'm not sure what's up with that.  Maybe there's another change on my Python 3 branch this is dependent on...



---

archive/issue_comments_362546.json:
```json
{
    "body": "I see now--`ClusterAlgebraElement` obtains its comparison operators from `ElementWrapper`, and defines things such that both `<` and `>` always return `False`.  I'm not sure how I feel about that, but nevertheless it means from Python's perspective they can be \"sorted\", but the sorting is meaningless.\n\nI'm not 100% sure I like `str` as a sort key in these examples, but it doesn't really matter either way, as long as it gives consistent results.",
    "created_at": "2018-08-14T14:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362546",
    "user": "https://github.com/embray"
}
```

I see now--`ClusterAlgebraElement` obtains its comparison operators from `ElementWrapper`, and defines things such that both `<` and `>` always return `False`.  I'm not sure how I feel about that, but nevertheless it means from Python's perspective they can be "sorted", but the sorting is meaningless.

I'm not 100% sure I like `str` as a sort key in these examples, but it doesn't really matter either way, as long as it gives consistent results.



---

archive/issue_comments_362547.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-08-14T14:08:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362547",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_events_023924.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-08-17T21:14:03Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25711#event-23924"
}
```



---

archive/issue_comments_362548.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-08-17T21:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25711",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25711#issuecomment-362548",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
