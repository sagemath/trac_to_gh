# Issue 25711: py3: a few more miscellaneous dict iterator (dict.keys, dict.values) fixes

Issue created by migration from Trac.

Original creator: embray

Original creation time: 2018-07-27 11:45:54

As in #25947, found by grepping through the test output.  A couple of these are far-reaching.


---

Comment by embray created at 2018-07-27 11:50:23

Changing status from new to needs_review.


---

Comment by tscrim created at 2018-07-27 12:42:34

Changing keywords from "" to "sagedays@icerm".


---

Comment by tscrim created at 2018-07-27 12:42:34

I think it would be better to do `list(d.values())` than `list(itervalues(d))`, both because it means less `six` dependence (which means it looks like Python3 in terms of the code) and for speed in Python2:

```
sage: from six import itervalues
sage: d = {i:i for i in range(100)}
sage: %timeit list(itervalues(d))
The slowest run took 33.55 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 1.34 Âµs per loop
sage: %timeit list(d.values())
The slowest run took 13.27 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 899 ns per loop
```

Given that these lists are likely small (less than 100, probably averaging between 5-10), I think any memory duplication is negligible.

Otherwise LGTM.


---

Comment by git created at 2018-07-27 13:29:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-27 13:29:54

Added a few more; still all trivial one-liners I think.


---

Comment by git created at 2018-07-27 13:58:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2018-07-27 14:31:06

We've had this discussion before, and IMO unless you can show that it has a noticeable performance impact in this specific case I don't care enough to change it.


---

Comment by tscrim created at 2018-07-27 20:16:12

I care a little bit more. :) If my change is good, then positive review.
----
New commits:


---

Comment by embray created at 2018-07-30 16:49:29

It looks like you changed it in some places but not others.  Was that a result of more specific benchmarks?

The only reason I don't care as that the benchmark you cite could be very significant in some contexts, or very insignificant or even wrong in other contexts.  I certainly care about about more specific benchmarks.


---

Comment by git created at 2018-07-30 21:53:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-07-30 22:05:25

My branch

```
sage: A = ClusterAlgebra(['A',[1,2],1])
sage: A.current_seed()
The initial seed of a Cluster Algebra with cluster variables x0, x1, x2 and no coefficients over Integer Ring
sage: for k in [0,1,2]*4:
....:     A.current_seed().mutate(k)
....:     
sage: %timeit A.F_polynomials_so_far()
The slowest run took 11.30 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 443 ns per loop
```

vs your branch

```
sage: %timeit A.F_polynomials_so_far()
The slowest run took 64.77 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 806 ns per loop
```


So while this is not a big shift in timings (despite the 2x speedup), running this method repeatedly can start taking time:

```
sage: A = ClusterAlgebra(['A',[1,2],1])
sage: %%timeit
....: A.reset_current_seed()
....: for k in [0,1,2]*6:
....:     A.current_seed().mutate(k)
....:     A.F_polynomials_so_far()
....: 
The slowest run took 12.77 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.49 ms per loop
```

vs your branch

```
The slowest run took 12.22 times longer than the fastest. This could mean that an intermediate result is being cached.
1000 loops, best of 3: 1.58 ms per loop
```


----

I also changed some tests as they were failing on my machine and the patchbot to make them machine-independent (I am assuming they were passing on your machine).


---

Comment by embray created at 2018-07-31 14:09:09

> I also changed some tests as they were failing on my machine and the patchbot to make them machine-independent (I am assuming they were passing on your machine).

I'm not sure I understand this.  Why would the polynomials be sorted differently on different machines?  The sorting I had looks like it makes sense.  If it was giving different results on Python 2 that still might be a real issue worth looking into instead of just doing key=str.


---

Comment by embray created at 2018-07-31 14:11:26

Changing status from needs_review to needs_work.


---

Comment by embray created at 2018-07-31 14:11:26

I see, here are a couple examples:


```
sage -t --long src/sage/algebras/cluster_algebra.py
**********************************************************************
File "src/sage/algebras/cluster_algebra.py", line 101, in sage.algebras.cluster_algebra
Failed example:
    sorted(A.cluster_variables_so_far())
Expected:
    [x0, x1, (x0 + 1)/x1, (x1 + 1)/x0, (x0 + x1 + 1)/(x0*x1)]
Got:
    [x1, (x0 + 1)/x1, x0, (x1 + 1)/x0, (x0 + x1 + 1)/(x0*x1)]
**********************************************************************
File "src/sage/algebras/cluster_algebra.py", line 1678, in sage.algebras.cluster_algebra.ClusterAlgebra.cluster_variables_so_far
Failed example:
    sorted(A.cluster_variables_so_far())
Expected:
    [x0, x1, (x1 + 1)/x0]
Got:
    [x1, x0, (x1 + 1)/x0]
```


I'm not sure what's up with that.  Maybe there's another change on my Python 3 branch this is dependent on...


---

Comment by embray created at 2018-08-14 14:08:46

I see now--`ClusterAlgebraElement` obtains its comparison operators from `ElementWrapper`, and defines things such that both `<` and `>` always return `False`.  I'm not sure how I feel about that, but nevertheless it means from Python's perspective they can be "sorted", but the sorting is meaningless.

I'm not 100% sure I like `str` as a sort key in these examples, but it doesn't really matter either way, as long as it gives consistent results.


---

Comment by embray created at 2018-08-14 14:08:46

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2018-08-17 21:14:03

Resolution: fixed
