# Issue 15363: Exact computations in QQbar spend unreasonable amounts of time in do_polred

archive/issues_015363.json:
```json
{
    "body": "CC:  @jdemeyer @gagern @videlec @cheuberg\n\nZero-tests in `QQbar` and `AA` are very slow\u2014slower than can be reasonably expected of exact computations with algebraic numbers IMHO.\n\nOn some examples, it turns out that 80% or more of the time is spent calling PARI's `polredbest`. The current implementation apparently calls `polredbest` each time exact computations in a new extension are required, which can be pretty expensive. It does so in the hope of finding a \"nice\" primitive element whose use will speed up subsequent computations (and perhaps also make the descriptions of the elements slightly more readable?), but otherwise my understanding is that this step is completely optional.\n\nLet's try to disable it except for small degrees (the value of `max_deg` was chosen to avoid changing the output of the tests in `qqbar.py`):\n\n```diff\n--- a/src/sage/rings/qqbar.py\n+++ b/src/sage/rings/qqbar.py\n@@ -1510,7 +1510,7 @@ def clear_denominators(poly):\n     poly = poly(poly.parent().gen() / change)\n     return change, poly\n \n-def do_polred(poly):\n+def do_polred(poly, max_deg=8):\n     r\"\"\"\n     Find a polynomial of reasonably small discriminant that generates\n     the same number field as ``poly``, using the PARI ``polredbest``\n@@ -1554,9 +1554,12 @@ def do_polred(poly):\n         sage: do_polred(x^4 - 4294967296*x^2 + 54265257667816538374400)\n         (1/4*x, 4*x, x^4 - 268435456*x^2 + 211973662764908353025)\n     \"\"\"\n+    parent = poly.parent()\n+    if poly.degree() > max_deg:\n+        return parent.gen(), parent.gen(), poly\n+\n     new_poly, elt_back = poly._pari_().polredbest(flag=1)\n \n-    parent = poly.parent()\n     elt_fwd = elt_back.modreverse()\n     return parent(elt_fwd.lift()), parent(elt_back.lift()), parent(new_poly)\n }}}\nBefore (`master` as of a few days ago):\n{{{\n    sage -t --long src/sage/rings/qqbar.py\n        [1355 tests, 34.81 s]\n    ----------------------------------------------------------------------\n    All tests passed!\n    ----------------------------------------------------------------------\n    Total time for all tests: 35.2 seconds\n        cpu time: 34.8 seconds\n        cumulative wall time: 34.8 seconds\n}}}\nAfter:\n{{{\n    sage -t --long src/sage/rings/qqbar.py\n        [1355 tests, 6.09 s]\n    ----------------------------------------------------------------------\n    All tests passed!\n    ----------------------------------------------------------------------\n    Total time for all tests: 6.4 seconds\n        cpu time: 6.1 seconds\n        cumulative wall time: 6.1 seconds\n}}}\n\nNow these examples may not be representative of anything, and the above patch is a very naive solution. But it should certainly be possible to come up with a better strategy than calling `polredbest` every time!\n\nIssue created by migration from https://trac.sagemath.org/ticket/15600\n\n",
    "created_at": "2013-12-28T11:13:58Z",
    "labels": [
        "component: performance",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Exact computations in QQbar spend unreasonable amounts of time in do_polred",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15363",
    "user": "https://github.com/mezzarobba"
}
```
CC:  @jdemeyer @gagern @videlec @cheuberg

Zero-tests in `QQbar` and `AA` are very slowâ€”slower than can be reasonably expected of exact computations with algebraic numbers IMHO.

On some examples, it turns out that 80% or more of the time is spent calling PARI's `polredbest`. The current implementation apparently calls `polredbest` each time exact computations in a new extension are required, which can be pretty expensive. It does so in the hope of finding a "nice" primitive element whose use will speed up subsequent computations (and perhaps also make the descriptions of the elements slightly more readable?), but otherwise my understanding is that this step is completely optional.

Let's try to disable it except for small degrees (the value of `max_deg` was chosen to avoid changing the output of the tests in `qqbar.py`):

```diff
--- a/src/sage/rings/qqbar.py
+++ b/src/sage/rings/qqbar.py
@@ -1510,7 +1510,7 @@ def clear_denominators(poly):
     poly = poly(poly.parent().gen() / change)
     return change, poly
 
-def do_polred(poly):
+def do_polred(poly, max_deg=8):
     r"""
     Find a polynomial of reasonably small discriminant that generates
     the same number field as ``poly``, using the PARI ``polredbest``
@@ -1554,9 +1554,12 @@ def do_polred(poly):
         sage: do_polred(x^4 - 4294967296*x^2 + 54265257667816538374400)
         (1/4*x, 4*x, x^4 - 268435456*x^2 + 211973662764908353025)
     """
+    parent = poly.parent()
+    if poly.degree() > max_deg:
+        return parent.gen(), parent.gen(), poly
+
     new_poly, elt_back = poly._pari_().polredbest(flag=1)
 
-    parent = poly.parent()
     elt_fwd = elt_back.modreverse()
     return parent(elt_fwd.lift()), parent(elt_back.lift()), parent(new_poly)
 }}}
Before (`master` as of a few days ago):
{{{
    sage -t --long src/sage/rings/qqbar.py
        [1355 tests, 34.81 s]
    ----------------------------------------------------------------------
    All tests passed!
    ----------------------------------------------------------------------
    Total time for all tests: 35.2 seconds
        cpu time: 34.8 seconds
        cumulative wall time: 34.8 seconds
}}}
After:
{{{
    sage -t --long src/sage/rings/qqbar.py
        [1355 tests, 6.09 s]
    ----------------------------------------------------------------------
    All tests passed!
    ----------------------------------------------------------------------
    Total time for all tests: 6.4 seconds
        cpu time: 6.1 seconds
        cumulative wall time: 6.1 seconds
}}}

Now these examples may not be representative of anything, and the above patch is a very naive solution. But it should certainly be possible to come up with a better strategy than calling `polredbest` every time!

Issue created by migration from https://trac.sagemath.org/ticket/15600





---

archive/issue_comments_197805.json:
```json
{
    "body": "I don't think this is the right solution, using caching would be a better idea I think. In fact, in the code there are various places with\n\n```\n# XXX need more caching here\n```\n",
    "created_at": "2013-12-28T11:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197805",
    "user": "https://github.com/jdemeyer"
}
```

I don't think this is the right solution, using caching would be a better idea I think. In fact, in the code there are various places with

```
# XXX need more caching here
```




---

archive/issue_comments_197806.json:
```json
{
    "body": "I agree that QQbar *also* needs more caching. (And not only in the marked places. For instance, look how many times `nfinit` is called by `sage_input(pol.roots(...,ring=QQbar), verify=True)`: it seems to me that lots of expensive purely algebraic computations could be performed only once when we have `AlgebraicGenerator`s corresponding to several roots of the same irreducible polynomial.)\n\nBut even with caching, is it reasonable to spend tens of seconds optimizing the representation of an extension that may be used only once to check that some expression is zero?",
    "created_at": "2013-12-28T12:42:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197806",
    "user": "https://github.com/mezzarobba"
}
```

I agree that QQbar *also* needs more caching. (And not only in the marked places. For instance, look how many times `nfinit` is called by `sage_input(pol.roots(...,ring=QQbar), verify=True)`: it seems to me that lots of expensive purely algebraic computations could be performed only once when we have `AlgebraicGenerator`s corresponding to several roots of the same irreducible polynomial.)

But even with caching, is it reasonable to spend tens of seconds optimizing the representation of an extension that may be used only once to check that some expression is zero?



---

archive/issue_comments_197807.json:
```json
{
    "body": "I asked Karim Belabas. Here is what I understand of his answer:\n* the cost of `polredbest` for a polynomial of degree `n` with coefficients of bit size `B` is roughly `n^5 B^2`;\n* the best it can do is to reduce the cost of subsequent computations in the extension by a factor of roughly `B^2`;\n* it is essentially never worth calling it on polynomials of moderately large degree;\n* ...except before performing very expensive operations (typically `bnfinit()`) on the extension, when there is reason to expect that it will find a defining polynomial of very small height.\n\nOn a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large. Karim suggested that the Pari function `rnfpolredbest` could be useful in this case.",
    "created_at": "2014-01-15T17:57:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197807",
    "user": "https://github.com/mezzarobba"
}
```

I asked Karim Belabas. Here is what I understand of his answer:
* the cost of `polredbest` for a polynomial of degree `n` with coefficients of bit size `B` is roughly `n^5 B^2`;
* the best it can do is to reduce the cost of subsequent computations in the extension by a factor of roughly `B^2`;
* it is essentially never worth calling it on polynomials of moderately large degree;
* ...except before performing very expensive operations (typically `bnfinit()`) on the extension, when there is reason to expect that it will find a defining polynomial of very small height.

On a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large. Karim suggested that the Pari function `rnfpolredbest` could be useful in this case.



---

archive/issue_comments_197808.json:
```json
{
    "body": "I agree that dropping that function seems a reasonable approach to the problem at hand. In particular, if we follow the idea from #17886 then operations within a single number field would become even rarer, so the benefit of a reduced basis would be less as well.\n\nAs a middle ground, it might be possible to do the reduction lazily, once it looks as if there would be a sufficient number of operations performed in the same number field to justify the time spent for this computation. But since implementing this could be a major effort, I'm not really suggesting this approach, just mentioning it as an idea if there is too much objection to dropping the reduction altogether.\n\nHere is one example which doesn't complete in over 6 hours, due to the call to `polredbest`. I had this as the motivating example for #17896 which looks like a duplicate of this one here.\n\n\n```\nsage: x,y = polygens(QQ,\"x,y\")\nsage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422\nsage: p2 = p1(x=(x-1)^2)\nsage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()\nsage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]\nsage: ival = CIF((0.77, 0.78), (-0.08, -0.07))\nsage: z, = [r for r in p4.roots(QQbar, False) if r in ival]\nsage: %time z.exactify()\n```\n",
    "created_at": "2015-04-18T19:43:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197808",
    "user": "https://github.com/gagern"
}
```

I agree that dropping that function seems a reasonable approach to the problem at hand. In particular, if we follow the idea from #17886 then operations within a single number field would become even rarer, so the benefit of a reduced basis would be less as well.

As a middle ground, it might be possible to do the reduction lazily, once it looks as if there would be a sufficient number of operations performed in the same number field to justify the time spent for this computation. But since implementing this could be a major effort, I'm not really suggesting this approach, just mentioning it as an idea if there is too much objection to dropping the reduction altogether.

Here is one example which doesn't complete in over 6 hours, due to the call to `polredbest`. I had this as the motivating example for #17896 which looks like a duplicate of this one here.


```
sage: x,y = polygens(QQ,"x,y")
sage: p1 = x^5 + 6*x^4 - 42*x^3 - 142*x^2 + 467*x + 422
sage: p2 = p1(x=(x-1)^2)
sage: p3 = p2(x=x*y).resultant(p2,x).univariate_polynomial()
sage: p4, = [f[0] for f in p3.factor() if f[0].degree() == 80]
sage: ival = CIF((0.77, 0.78), (-0.08, -0.07))
sage: z, = [r for r in p4.roots(QQbar, False) if r in ival]
sage: %time z.exactify()
```




---

archive/issue_comments_197809.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-12-23T08:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197809",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_197810.json:
```json
{
    "body": "I'd like to revive this ticket. It's been five years, and (in spite of a bit of progress on related issues), there is still no other viable solution. While the change suggested here will not make QQbar very fast, it can at least make it usable.\n----\nNew commits:",
    "created_at": "2018-12-23T08:02:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197810",
    "user": "https://github.com/mezzarobba"
}
```

I'd like to revive this ticket. It's been five years, and (in spite of a bit of progress on related issues), there is still no other viable solution. While the change suggested here will not make QQbar very fast, it can at least make it usable.
----
New commits:



---

archive/issue_comments_197811.json:
```json
{
    "body": "Replying to [comment:3 mmezzarobba]:\n> On a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large.\n\nAs we realized with Pascal Molin, this is related in particular to #26898. What used to happen is that hashing an algebraic number \u03b1 would trigger the exact computation, not just of\u00a0\u03b1 itself, but of the *real and imaginary parts* of \u03b1\u00a0*+\u00a0\u03b2* for some \u03b2\u00a0\u2208\u00a0\u211a[i]...",
    "created_at": "2018-12-23T08:08:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197811",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:3 mmezzarobba]:
> On a related note, I noticed that `QQbar` often calls `polredbest` on polynomials of the form `p(x^k)` where `k` can be pretty large.

As we realized with Pascal Molin, this is related in particular to #26898. What used to happen is that hashing an algebraic number Î± would trigger the exact computation, not just ofÂ Î± itself, but of the *real and imaginary parts* of Î±Â *+Â Î²* for some Î²Â âˆˆÂ â„š[i]...



---

archive/issue_comments_197812.json:
```json
{
    "body": "Just a copy of the example in #21095 that never terminates\n\n```\nsage: x = polygen(ZZ)\nsage: p = 67*x^4 - 33*x^3 + 94*x^2 - 30*x + 57\nsage: r = p.roots(QQbar, multiplicities=False)\nsage: r[0].abs().exactify()  # <- takes forever\n```\n",
    "created_at": "2018-12-23T09:12:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197812",
    "user": "https://github.com/videlec"
}
```

Just a copy of the example in #21095 that never terminates

```
sage: x = polygen(ZZ)
sage: p = 67*x^4 - 33*x^3 + 94*x^2 - 30*x + 57
sage: r = p.roots(QQbar, multiplicities=False)
sage: r[0].abs().exactify()  # <- takes forever
```




---

archive/issue_comments_197813.json:
```json
{
    "body": "Do you have some timings that make you decide about this threshold?",
    "created_at": "2018-12-23T09:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197813",
    "user": "https://github.com/videlec"
}
```

Do you have some timings that make you decide about this threshold?



---

archive/issue_comments_197814.json:
```json
{
    "body": "Replying to [comment:11 vdelecroix]:\n> Do you have some timings that make you decide about this threshold?\n\nNothing rigorous. But for instance, degree 40 with 30-bit coefficients seems to take a second or two, degree 60 (still with 30-bit coeffs) ~9s, and  degree 80 more than 30s.",
    "created_at": "2018-12-23T10:02:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197814",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:11 vdelecroix]:
> Do you have some timings that make you decide about this threshold?

Nothing rigorous. But for instance, degree 40 with 30-bit coefficients seems to take a second or two, degree 60 (still with 30-bit coeffs) ~9s, and  degree 80 more than 30s.



---

archive/issue_comments_197815.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-25T10:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197815",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197816.json:
```json
{
    "body": "This is a good move! Thanks.",
    "created_at": "2018-12-31T08:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197816",
    "user": "https://github.com/videlec"
}
```

This is a good move! Thanks.



---

archive/issue_comments_197817.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-12-31T08:19:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197817",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_197818.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-01-01T09:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15363#issuecomment-197818",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_015017.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2019-01-01T09:51:24Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15363",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15363#event-15017"
}
```
