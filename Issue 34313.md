# Issue 34313: EllipticCurve.element_class

Issue created by migration from https://trac.sagemath.org/ticket/34550

Original creator: mkoeppe

Original creation time: 2022-09-17 17:11:14

CC:  tscrim caruso @davidayotte lorenz

(from #33713)

In Sage, `Schemes` are `Sets`. An `EllipticCurve` is in `Schemes` but does not support `element_class` etc.

```
sage: E = EllipticCurve([0,0,1,-1,0])
sage: E.an_element()
(0 : -1 : 1)
sage: E.element_class
AttributeError: 'EllipticCurve_rational_field_with_category' object has no attribute 'element_class'
sage: TestSuite(E).run()
  Failure in _test_category:
  Traceback (most recent call last):
    File "/Users/mkoeppe/s/sage/sage-rebasing/local/var/lib/sage/venv-python3.9/lib/python3.9/site-packages/sage/misc/sage_unittest.py", line 297, in run
      test_method(tester=tester)
    File "sage/structure/element.pyx", line 722, in sage.structure.element.Element._test_category (build/cythonized/sage/structure/element.c:6954)
      tester.assertTrue(isinstance(self, self.parent().category().element_class))
    File "/Library/Frameworks/Python.framework/Versions/3.9/lib/python3.9/unittest/case.py", line 688, in assertTrue
      raise self.failureException(msg)
  AssertionError: False is not true
  ------------------------------------------------------------
  The following tests failed: _test_category
Failure in _test_elements
The following tests failed: _test_elements
```




---

Comment by @spaenlehauer created at 2022-09-18 08:51:28

A quick guess: wouldn't it be because affine schemes have a natural notion of elements (prime ideals in their coordinate rings), whereas more general schemes do not (or it would require to use the knowledge of the way affine charts are glued together)? An elliptic curve is a projective scheme, so defining what a point is would require to specify in which affine chart we are.

Here is an example which seems to indicate that projective schemes/spaces do not support `element_class`, which seems consistent which the fact that elliptic curves do not support `element_class`:


```
sage: Spec(QQ).element_class
<class 'sage.schemes.generic.scheme.AffineScheme_with_category.element_class'>
sage: ProjectiveSpace(10, QQ).element_class
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
/usr/lib/python3/dist-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7175)()
    838         try:
--> 839             return self.__cached_methods[name]
    840         except KeyError:

KeyError: 'element_class'

During handling of the above exception, another exception occurred:

AttributeError                            Traceback (most recent call last)
<ipython-input-2-929915fb0a23> in <module>
----> 1 ProjectiveSpace(Integer(10), QQ).element_class

/usr/lib/python3/dist-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.__getattr__ (build/cythonized/sage/structure/category_object.c:7094)()
    831             AttributeError: 'PrimeNumbers_with_category' object has no attribute 'sadfasdf'
    832         """
--> 833         return self.getattr_from_category(name)
    834 
    835     cdef getattr_from_category(self, name):

/usr/lib/python3/dist-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7260)()
    846                 cls = self._category.parent_class
    847 
--> 848             attr = getattr_from_other_class(self, cls, name)
    849             self.__cached_methods[name] = attr
    850             return attr

/usr/lib/python3/dist-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2653)()
    354         dummy_error_message.cls = type(self)
    355         dummy_error_message.name = name
--> 356         raise AttributeError(dummy_error_message)
    357     cdef PyObject* attr = instance_getattr(cls, name)
    358     if attr is NULL:

AttributeError: 'ProjectiveSpace_rational_field_with_category' object has no attribute 'element_class'

```



---

Comment by caruso created at 2022-09-18 14:11:38

Replying to [comment:2 gh-spaenlehauer]:
> A quick guess: wouldn't it be because affine schemes have a natural notion of elements (prime ideals in their coordinate rings), whereas more general schemes do not (or it would require to use the knowledge of the way affine charts are glued together)? An elliptic curve is a projective scheme, so defining what a point is would require to specify in which affine chart we are.

Well, general schemes have points exactly like affine schemes have. I think there is no difference here.


---

Comment by mkoeppe created at 2022-09-18 17:19:12

A rule of thumb: If a parent has a working `an_element`, then it should have a working `element_class` (unless it is a facade parent)


---

Comment by @spaenlehauer created at 2022-09-19 06:49:12

Replying to [comment:4 Xavier Caruso]:
> Well, general schemes have points exactly like affine schemes have. I think there is no difference here.

Yes, I agree. What I wanted to express in my previous message was that defining a natural data structure for points in a non-affine scheme seems complicated in general (because in theory you need the data of a neighborhood which is isomorphic to an affine scheme). But indeed, for projective schemes of the form `Proj(R/I)` where `R` is a polynomial ring and `I` is a homogeneous ideal (most cases of non-affine schemes in Sage, I believe), there is a convenient representation via prime homogeneous ideals saturated with respect to the irrelevant ideal.


---

Comment by @spaenlehauer created at 2022-09-19 06:51:54

Replying to [comment:5 Matthias KÃ¶ppe]:
> A rule of thumb: If a parent has a working `an_element`, then it should have a working `element_class` (unless it is a facade parent)

Ah, ok, thanks for this precision.

On a side note, this ticket might also apply to projective spaces, which seem to have a similar behavior. Perhaps this happens for all projective schemes in Sage.

```
sage: P = ProjectiveSpace(2, QQ)
sage: P.an_element()
(7/2 : 3 : 1)
sage: P.element_class
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
/usr/lib/python3/dist-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7175)()
    838         try:
--> 839             return self.__cached_methods[name]
    840         except KeyError:

KeyError: 'element_class'

During handling of the above exception, another exception occurred:

AttributeError                            Traceback (most recent call last)
<ipython-input-3-527f7b774ffa> in <module>
----> 1 P.element_class

/usr/lib/python3/dist-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.__getattr__ (build/cythonized/sage/structure/category_object.c:7094)()
    831             AttributeError: 'PrimeNumbers_with_category' object has no attribute 'sadfasdf'
    832         """
--> 833         return self.getattr_from_category(name)
    834 
    835     cdef getattr_from_category(self, name):

/usr/lib/python3/dist-packages/sage/structure/category_object.pyx in sage.structure.category_object.CategoryObject.getattr_from_category (build/cythonized/sage/structure/category_object.c:7260)()
    846                 cls = self._category.parent_class
    847 
--> 848             attr = getattr_from_other_class(self, cls, name)
    849             self.__cached_methods[name] = attr
    850             return attr

/usr/lib/python3/dist-packages/sage/cpython/getattr.pyx in sage.cpython.getattr.getattr_from_other_class (build/cythonized/sage/cpython/getattr.c:2653)()
    354         dummy_error_message.cls = type(self)
    355         dummy_error_message.name = name
--> 356         raise AttributeError(dummy_error_message)
    357     cdef PyObject* attr = instance_getattr(cls, name)
    358     if attr is NULL:

AttributeError: 'ProjectiveSpace_rational_field_with_category' object has no attribute 'element_class'
```

