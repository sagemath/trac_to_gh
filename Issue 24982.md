# Issue 24982: Implement reverse() for LaurentSeries

archive/issues_024982.json:
```json
{
    "body": "Power series have a `reverse()` method for series of valuation 1.\n\nThis enhancement wraps the power series method and makes it available for LaurentSeries of valuation 1.\n\n\n```\nsage: R.<x> = Frac(QQ[['x']])\nsage: f = 2*x + 3*x^2 - x^4 + O(x^5)\nsage: g = f.reverse()\nsage: g\n1/2*x - 3/8*x^2 + 9/16*x^3 - 131/128*x^4 + O(x^5)\nsage: f(g)\nx + O(x^5)\nsage: g(f)\nx + O(x^5)\n```\n\n\nThere is a known bug:\n\n\n```\nsage: B.<b> = PolynomialRing(ZZ)\nsage: A.<t> = LaurentSeriesRing(B)\nsage: f = 2*b*t + b*t^2 + 3*b^2*t^3 + O(t^4)\nsage: g = f.reverse(); g\n1/(2*b)*t - 1/(8*b^2)*t^2 + ((-3*b + 1)/(16*b^3))*t^3 + O(t^4)\nsage: f(g)\nt + O(t^4)\n```\n\n\nBut now...\n\n\n```\nsage: g(f)\n(256*b^6*t + O(t^4))/(256*b^6)\n```\n\n\nIt seems to be a coercion problem, as `g` was computed correctly,\nbut `f` doesn't coerce properly and must be explicitly converted:\n\n\n```\nsage: g(g.parent()(f))\nt + O(t^4)\n```\n\n\nI've concluded that this bug lies elsewhere in the code and should be given a separate ticket.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25219\n\n",
    "created_at": "2018-04-20T05:29:56Z",
    "labels": [
        "algebra",
        "minor",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.8",
    "title": "Implement reverse() for LaurentSeries",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24982",
    "user": "@BrentBaccala"
}
```
Power series have a `reverse()` method for series of valuation 1.

This enhancement wraps the power series method and makes it available for LaurentSeries of valuation 1.


```
sage: R.<x> = Frac(QQ[['x']])
sage: f = 2*x + 3*x^2 - x^4 + O(x^5)
sage: g = f.reverse()
sage: g
1/2*x - 3/8*x^2 + 9/16*x^3 - 131/128*x^4 + O(x^5)
sage: f(g)
x + O(x^5)
sage: g(f)
x + O(x^5)
```


There is a known bug:


```
sage: B.<b> = PolynomialRing(ZZ)
sage: A.<t> = LaurentSeriesRing(B)
sage: f = 2*b*t + b*t^2 + 3*b^2*t^3 + O(t^4)
sage: g = f.reverse(); g
1/(2*b)*t - 1/(8*b^2)*t^2 + ((-3*b + 1)/(16*b^3))*t^3 + O(t^4)
sage: f(g)
t + O(t^4)
```


But now...


```
sage: g(f)
(256*b^6*t + O(t^4))/(256*b^6)
```


It seems to be a coercion problem, as `g` was computed correctly,
but `f` doesn't coerce properly and must be explicitly converted:


```
sage: g(g.parent()(f))
t + O(t^4)
```


I've concluded that this bug lies elsewhere in the code and should be given a separate ticket.

Issue created by migration from https://trac.sagemath.org/ticket/25219





---

archive/issue_comments_351562.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-04-20T05:31:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351562",
    "user": "@BrentBaccala"
}
```

New commits:



---

archive/issue_comments_351563.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-04-20T19:49:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351563",
    "user": "@BrentBaccala"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_351564.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-12-09T03:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351564",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351565.json:
```json
{
    "body": "Rather than `type(self)(self._parent, rev)` couldn't you use the parent call method? (something like `self._parent(rev)`?",
    "created_at": "2019-03-04T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351565",
    "user": "vdelecroix"
}
```

Rather than `type(self)(self._parent, rev)` couldn't you use the parent call method? (something like `self._parent(rev)`?



---

archive/issue_comments_351566.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-03-04T19:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351566",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_351567.json:
```json
{
    "body": "Also, I am not able to reproduce the bug that you mention in the ticket description on 8.7.beta6...",
    "created_at": "2019-03-04T19:36:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351567",
    "user": "vdelecroix"
}
```

Also, I am not able to reproduce the bug that you mention in the ticket description on 8.7.beta6...



---

archive/issue_comments_351568.json:
```json
{
    "body": "Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)",
    "created_at": "2019-03-25T10:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351568",
    "user": "embray"
}
```

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)



---

archive/issue_comments_351569.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-12T03:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351569",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351570.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-12T03:08:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351570",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351571.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2019-04-12T03:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351571",
    "user": "@BrentBaccala"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_351572.json:
```json
{
    "body": "Code updated as suggested.\n\nI can't reproduce the bug anymore, either.  I added it as a test case.",
    "created_at": "2019-04-12T03:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351572",
    "user": "@BrentBaccala"
}
```

Code updated as suggested.

I can't reproduce the bug anymore, either.  I added it as a test case.



---

archive/issue_comments_351573.json:
```json
{
    "body": "Does power series really behave this way\n\n```\n+        if rev.parent() == u.parent():\n+            return self._parent(rev)\n+        else:\n+            P = self._parent.change_ring(rev.parent().base_ring())\n+            return P(rev)\n```\n\nIt is very counterintuitive to have methods whose output type depends on the nature of the answer. If you do `4/2` in Sage you do not obtain an integer but a rational number. I don't understand why `.reverse()` should be any different.\n\nI would suggest to have `reverse` and `reverse_unit`.\n\nI am just asking for your opinion as this is beyond the scope of the ticket.",
    "created_at": "2019-04-12T06:15:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351573",
    "user": "vdelecroix"
}
```

Does power series really behave this way

```
+        if rev.parent() == u.parent():
+            return self._parent(rev)
+        else:
+            P = self._parent.change_ring(rev.parent().base_ring())
+            return P(rev)
```

It is very counterintuitive to have methods whose output type depends on the nature of the answer. If you do `4/2` in Sage you do not obtain an integer but a rational number. I don't understand why `.reverse()` should be any different.

I would suggest to have `reverse` and `reverse_unit`.

I am just asking for your opinion as this is beyond the scope of the ticket.



---

archive/issue_comments_351574.json:
```json
{
    "body": "Replying to [comment:11 vdelecroix]:\n> Does power series really behave this way\n> {{{\n> +        if rev.parent() == u.parent():\n> +            return self._parent(rev)\n> +        else:\n> +            P = self._parent.change_ring(rev.parent().base_ring())\n> +            return P(rev)\n> }}}\n> It is very counterintuitive to have methods whose output type depends on the nature of the answer. If you do `4/2` in Sage you do not obtain an integer but a rational number. I don't understand why `.reverse()` should be any different.\n> \n> I would suggest to have `reverse` and `reverse_unit`.\n> \n> I am just asking for your opinion as this is beyond the scope of the ticket.\n\nI chose to mimic the behavior of the existing `reverse` method in `PowerSeries_poly`.  Its docstring states:\n\n    If the leading coefficient is not a unit, we pass to its fraction field if possible\n\nThe Laurent series code calls the power series code, and follows its lead.  So the answer to your question is yes, power series really do behave this way:\n\n\n```\nsage: R.<x> = ZZ[[]]\nsage: (2*x+x^2).parent()\nPower Series Ring in x over Integer Ring\nsage: (2*x+x^2).reverse()\n1/2*x - 1/8*x^2 + 1/16*x^3 - 5/128*x^4 + 7/256*x^5 - 21/1024*x^6 + 33/2048*x^7 - 429/32768*x^8 + 715/65536*x^9 - 2431/262144*x^10 + 4199/524288*x^11 - 29393/4194304*x^12 + 52003/8388608*x^13 - 185725/33554432*x^14 + 334305/67108864*x^15 - 9694845/2147483648*x^16 + 17678835/4294967296*x^17 - 64822395/17179869184*x^18 + 119409675/34359738368*x^19 + O(x^20)\nsage: (2*x+x^2).reverse().parent()\nPower Series Ring in x over Rational Field\n```\n\n\nI would tend to think that it should work this way, that `4/2` should return an integer and only `3/2` should return a rational, but I haven't thought about it enough to have a really informed opinion.",
    "created_at": "2019-04-12T17:11:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351574",
    "user": "@BrentBaccala"
}
```

Replying to [comment:11 vdelecroix]:
> Does power series really behave this way
> {{{
> +        if rev.parent() == u.parent():
> +            return self._parent(rev)
> +        else:
> +            P = self._parent.change_ring(rev.parent().base_ring())
> +            return P(rev)
> }}}
> It is very counterintuitive to have methods whose output type depends on the nature of the answer. If you do `4/2` in Sage you do not obtain an integer but a rational number. I don't understand why `.reverse()` should be any different.
> 
> I would suggest to have `reverse` and `reverse_unit`.
> 
> I am just asking for your opinion as this is beyond the scope of the ticket.

I chose to mimic the behavior of the existing `reverse` method in `PowerSeries_poly`.  Its docstring states:

    If the leading coefficient is not a unit, we pass to its fraction field if possible

The Laurent series code calls the power series code, and follows its lead.  So the answer to your question is yes, power series really do behave this way:


```
sage: R.<x> = ZZ[[]]
sage: (2*x+x^2).parent()
Power Series Ring in x over Integer Ring
sage: (2*x+x^2).reverse()
1/2*x - 1/8*x^2 + 1/16*x^3 - 5/128*x^4 + 7/256*x^5 - 21/1024*x^6 + 33/2048*x^7 - 429/32768*x^8 + 715/65536*x^9 - 2431/262144*x^10 + 4199/524288*x^11 - 29393/4194304*x^12 + 52003/8388608*x^13 - 185725/33554432*x^14 + 334305/67108864*x^15 - 9694845/2147483648*x^16 + 17678835/4294967296*x^17 - 64822395/17179869184*x^18 + 119409675/34359738368*x^19 + O(x^20)
sage: (2*x+x^2).reverse().parent()
Power Series Ring in x over Rational Field
```


I would tend to think that it should work this way, that `4/2` should return an integer and only `3/2` should return a rational, but I haven't thought about it enough to have a really informed opinion.



---

archive/issue_comments_351575.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2019-04-14T16:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351575",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_351576.json:
```json
{
    "body": "The following test is working for me\n\n```\nsage: B.<b> = PolynomialRing(ZZ)\nsage: A.<t> = LaurentSeriesRing(B)\nsage: f = 2*b*t + b*t^2 + 3*b^2*t^3 + O(t^4)\nsage: g = f.reverse()\nsage: g(f)  # known bug - f fails to coerce properly, but next test works\nt + O(t^4)\n```\n\nWhy is it discarded?",
    "created_at": "2019-04-14T16:32:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351576",
    "user": "vdelecroix"
}
```

The following test is working for me

```
sage: B.<b> = PolynomialRing(ZZ)
sage: A.<t> = LaurentSeriesRing(B)
sage: f = 2*b*t + b*t^2 + 3*b^2*t^3 + O(t^4)
sage: g = f.reverse()
sage: g(f)  # known bug - f fails to coerce properly, but next test works
t + O(t^4)
```

Why is it discarded?



---

archive/issue_comments_351577.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-04-14T16:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351577",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_351578.json:
```json
{
    "body": "Replying to [comment:13 vdelecroix]:\n> The following test is working for me\n> {{{\n> sage: B.<b> = PolynomialRing(ZZ)\n> sage: A.<t> = LaurentSeriesRing(B)\n> sage: f = 2*b*t + b*t^2 + 3*b<sup>2*t</sup>3 + O(t^4)\n> sage: g = f.reverse()\n> sage: g(f)  # known bug - f fails to coerce properly, but next test works\n> t + O(t^4)\n> }}}\n> Why is it discarded?\n\nIt used to fail.  I don't know what changed to fix it, but it was somewhere else in Sage.  I'll bisect the code if you really want to track it down.\n\nOnce it was working, I added it as a test case, but forgot that it was already there as a \"known bug\" example.  Fixed.",
    "created_at": "2019-04-14T16:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351578",
    "user": "@BrentBaccala"
}
```

Replying to [comment:13 vdelecroix]:
> The following test is working for me
> {{{
> sage: B.<b> = PolynomialRing(ZZ)
> sage: A.<t> = LaurentSeriesRing(B)
> sage: f = 2*b*t + b*t^2 + 3*b<sup>2*t</sup>3 + O(t^4)
> sage: g = f.reverse()
> sage: g(f)  # known bug - f fails to coerce properly, but next test works
> t + O(t^4)
> }}}
> Why is it discarded?

It used to fail.  I don't know what changed to fix it, but it was somewhere else in Sage.  I'll bisect the code if you really want to track it down.

Once it was working, I added it as a test case, but forgot that it was already there as a "known bug" example.  Fixed.



---

archive/issue_comments_351579.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2019-04-14T16:57:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351579",
    "user": "vdelecroix"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_351580.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-04-15T17:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24982#issuecomment-351580",
    "user": "vbraun"
}
```

Resolution: fixed
