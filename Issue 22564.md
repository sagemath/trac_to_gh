# Issue 22564: SymPy as optional symbolic method for manifolds

Issue created by migration from Trac.

Original creator: mmancini

Original creation time: 2017-04-13 09:13:12

CC:  egourgoulhon

The symbolic method used for manifolds and differentiable manifolds is "symbolic", the default in [SageMath](SageMath).
In this ticket we introduce the use of SymPy as an option when the Chart in the manifold is created.


---

Comment by mmancini created at 2017-04-13 11:31:56

New commits:


---

Comment by rws created at 2017-05-12 08:11:26

Changing component from symbolics to geometry.


---

Comment by git created at 2017-06-01 15:38:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-01 16:09:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-08 13:41:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-06-27 14:03:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-07-19 12:20:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-08 14:30:34

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2017-09-13 09:28:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-13 12:08:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-09-13 12:16:11

Changing status from new to needs_review.


---

Comment by git created at 2017-09-14 11:18:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2017-09-15 20:48:01

There are a few things that need fixing.

- Not all methods have docstrings/tests
- There are a number of tests where the line before is informational, but it needs a blankline, e.g.:
  {{{#!diff
`@``@` -1641,6 +1641,19 `@``@` class TopologicalManifold(ManifoldSubset):
             F: U --> R
                (x, y, z) |--> cos(y)*sin(x) + z
 
+
+        Same tests with ``sympy``::
+            sage: c_xyz.set_calculus_method('sympy')
+            sage: f = U.scalar_field(sin(x)*cos(y) + z, name='F'); f
+            Scalar field F on the Open subset U of the 3-dimensional topological manifold M
+            sage: f.display()
+            F: U --> R
+               (x, y, z) |--> cos(y)*sin(x) + z
+
+            sage: type(f.coord_function(c_xyz).expr())
+               <class 'sympy.core.add.Add'>
+
+
}}}
- IMO, you are too liberal with your blanklines spacing things out that makes the code a little uneven to read.


---

Comment by tscrim created at 2017-09-15 20:48:01

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-09-21 13:39:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-09-21 13:40:49

Changing status from needs_work to needs_review.


---

Comment by mmancini created at 2017-09-21 13:40:49

I hope that now the docstring is better (and less liberal)


---

Comment by egourgoulhon created at 2017-09-21 19:35:51

Replying to [comment:19 mmancini]:
> I hope that now the docstring is better (and less liberal) 

Thanks a lot for these improvements! I'll have a look at the code next week. Just a quick comment: as revealed by the patchbot, there are still some coverage issue, as well as a problem with `sage/manifolds/chart_func.py` when building the documentation. There are also some doctest failures.


---

Comment by git created at 2017-09-22 14:36:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-02 09:17:13

According to the patchbots, there are still failing doctests in `tensorfield.py` and the doc does not build.


---

Comment by egourgoulhon created at 2017-10-02 09:17:13

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-02 19:52:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-10-02 19:54:48

Changing status from needs_work to needs_review.


---

Comment by egourgoulhon created at 2017-10-03 16:20:14

The last commit fixes the doc build, but not the doctest failures in `tensorfield.py`.


---

Comment by egourgoulhon created at 2017-10-03 16:20:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-04 14:19:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-05 06:59:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-10-05 07:02:59

Display for ``ChartFunction`` has been changed: now the result is different for  ``Sympy`` and ``SR``. All test results have been modified.


---

Comment by mmancini created at 2017-10-05 07:02:59

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-06 16:29:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-10-06 20:38:26

Replying to [comment:29 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[fb0fb7e](https://git.sagemath.org/sage.git/commit/?id=fb0fb7e66395268a1c3e7d9abbf8b5613bf813bf)||`SymPy on manifolds: first reviewer tweaks (more to come)`||

I see in the difference the following one:


```
`@``@` -231,7 +225,7 `@``@` class DiffForm(TensorField):
         sage: a.display(eU)
         a = x*(y**2 + 2) dx/\dy
         sage: a.display(eV)
-        a = (-u**3/16 + u**2*v/16 + u*v**2/16 - u/2 - v**3/16 - v/2) du/\dv
+        a = (-u**3/16 + u*v**2/16 - u/2 - v**3/16 + v*(u**2 - 8)/16) du/\dv
```


I found is surprising : do you know where this difference comes from?


---

Comment by egourgoulhon created at 2017-10-07 12:12:26

Replying to [comment:30 mmancini]:
> 
> I see in the difference the following one:
> 
> {{{
> `@``@` -231,7 +225,7 `@``@` class DiffForm(TensorField):
>          sage: a.display(eU)
>          a = x*(y**2 + 2) dx/\dy
>          sage: a.display(eV)
> -        a = (-u**3/16 + u**2*v/16 + u*v**2/16 - u/2 - v**3/16 - v/2) du/\dv
> +        a = (-u**3/16 + u*v**2/16 - u/2 - v**3/16 + v*(u**2 - 8)/16) du/\dv
> }}}
> 
> I found is surprising : do you know where this difference comes from? 
It is due to a different setting: in the previous version, the transition map `xy_to_uv` was redefined, thereby causing a different handling of computations between `SR` and `sympy`. Note that the two expressions of `a` are mathematically equivalent, which is satisfactory.


---

Comment by git created at 2017-10-08 21:25:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-08 21:39:29

The above commit contains some polishing of the code (mostly layout) and improvements in the documentation. In particular, it restores the section the rubric _Differences between chart fucntions and callable symbolic expressions_ of the previous class `CoordFunctionSymb`. 

Two questions: 

- Why is there an argument `expression` in method `ChartFunction._simplify`? I mean, if `expression` is not `self.expr(method=calc_method)`, why not calling directly the `simplify` method of `CalculusMethod` on it?

- In the docstring of `ChartFunctionRing._coerce_map_from_`, there is a TODO section with _There is a problem with coercion with rationals_. What is that?


---

Comment by mmancini created at 2017-10-09 08:56:16

Replying to [comment:33 egourgoulhon]:
> The above commit contains some polishing of the code (mostly layout) and improvements in the documentation. In particular, it restores the section the rubric _Differences between chart fucntions and callable symbolic expressions_ of the previous class `CoordFunctionSymb`. 

Thanks

> 
> Two questions: 
> 
> - Why is there an argument `expression` in method `ChartFunction._simplify`? I mean, if `expression` is not `self.expr(method=calc_method)`, why not calling directly the `simplify` method of `CalculusMethod` on it?

At a particular moment during development I introduced it but I don't remember its functionality. As it is used only internally to `ChartFunction` I will remove this argument. 
 
> - In the docstring of `ChartFunctionRing._coerce_map_from_`, there is a TODO section with _There is a problem with coercion with rationals_. What is that?
Look at this example:

```
M = Manifold(2, 'M', structure='topological')
X.<x,y> = M.chart()
f = X.function(x^2+3*y+1)
g = f+1/2

TypeError                                 Traceback (most recent call last)
<ipython-input-5-83503284e242> in <module>()
----> 1 g=f+Integer(1)/Integer(2)

/home/mmancini/Sage-last/sage/src/sage/structure/element.pyx in sage.structure.element.Element.__add__ (build/cythonized/sage/structure/element.c:10823)()
   1240         # Left and right are Sage elements => use coercion model
   1241         if BOTH_ARE_ELEMENT(cl):
-> 1242             return coercion_model.bin_op(left, right, add)
   1243 
   1244         try:

...
...
...
```



---

Comment by git created at 2017-10-09 09:22:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-09 15:53:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-09 19:15:59

The above commit

- makes `_simplify` a mere shortcut to `CalculusMethod.simplify` in `ChartFunction`
- introduces the data member `._chart` in class `ChartFunction`
- uses SymPy substitutions (instead of forcing a conversion to `SR`) in `ChartFunction.__call__` when dealing with SymPy expressions
- makes sure that `simplify_chain_real_sympy` returns a SymPy object
- fixes the issue of coercion of `QQ` to `ChartFunctionRing`


---

Comment by git created at 2017-10-09 21:23:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-10 13:36:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-11 14:09:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-16 09:37:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-17 15:30:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2017-10-17 16:38:02

Better base everything on #20204 as it contains all SymPy Interface improvements, ie abstract functions.


---

Comment by git created at 2017-10-17 17:34:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-18 14:18:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-10-20 19:07:11

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-20 19:16:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-10-23 11:19:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-10-23 11:20:22

Changing status from needs_work to needs_review.


---

Comment by rws created at 2017-10-24 06:31:58

Changing status from needs_review to positive_review.


---

Comment by rws created at 2017-10-24 06:31:58

I cannot confirm the one patchbot failure. Most of this was reviewed by Eric, and the rest by me, LGTM.


---

Comment by egourgoulhon created at 2017-10-24 08:57:36

Changing status from positive_review to needs_review.


---

Comment by egourgoulhon created at 2017-10-24 12:05:41

Thank you Ralf but I would like to check a few more things before the final positive review


---

Comment by git created at 2017-10-26 12:35:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-26 12:43:15

The above commit fixes the computation of metric determinants when sympy is the calculus method. With it, most of the manifold tutorial passes with all calculations performed with SymPy: http://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.1/SM_tutorial_sympy.ipynb.

I have still to check a few extra things to complete the review.


---

Comment by rllozes created at 2017-10-26 18:59:17

Grep finds a few mentions of 'manifolds.coord_func' in commentary:

differentiable/scalarfield.py:    :class:`~sage.manifolds.coord_func.CoordFunction`::
differentiable/affine_connection.py:    :class:`~sage.manifolds.coord_func.CoordFunction` (of the subclass
differentiable/affine_connection.py:    :class:`~sage.manifolds.coord_func_symb.CoordFunctionSymb` in the current
differentiable/affine_connection.py:          :class:`~sage.manifolds.coord_func.CoordFunction`
differentiable/chart.py:          (cf. :class:`~sage.manifolds.coord_func.CoordFunction`)
differentiable/chart.py:          (cf. :class:`~sage.manifolds.coord_func.CoordFunction`)
differentiable/diff_map.py:          :class:`~sage.manifolds.coord_func.CoordFunction`


---

Comment by git created at 2017-10-27 09:52:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-10-27 09:53:30

Replying to [comment:57 rllozes]:

I removed the old references, thanks

> Grep finds a few mentions of 'manifolds.coord_func' in commentary:
> 
> differentiable/scalarfield.py:    :class:`~sage.manifolds.coord_func.CoordFunction`::
> differentiable/affine_connection.py:    :class:`~sage.manifolds.coord_func.CoordFunction` (of the subclass
> differentiable/affine_connection.py:    :class:`~sage.manifolds.coord_func_symb.CoordFunctionSymb` in the current
> differentiable/affine_connection.py:          :class:`~sage.manifolds.coord_func.CoordFunction`
> differentiable/chart.py:          (cf. :class:`~sage.manifolds.coord_func.CoordFunction`)
> differentiable/chart.py:          (cf. :class:`~sage.manifolds.coord_func.CoordFunction`)
> differentiable/diff_map.py:          :class:`~sage.manifolds.coord_func.CoordFunction`
>


---

Comment by git created at 2017-10-27 22:16:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-27 22:34:42

With the above two commits, all the S<sup>2</sup> notebook passes with SymPy:
http://nbviewer.jupyter.org/github/sagemanifolds/SageManifolds/blob/master/Worksheets/v1.1/SM_sphere_S2_sympy.ipynb
except for the 3D graphics of the tangent vector field to the loxodrome (commented cell 193); this is because Sage's matrix constructor (`sage.matrix.constructor.prepare`) cannot take SymPy numbers (`sympy.core.numbers.Float`) as elements: it generates the error

```
TypeError: unable to find a common ring for all elements
}}} 
The need for such a matrix arises from a change of basis in some tangent space to the sphere, where all tensor components are expressed in terms of SymPy floats (because of the sampling for the drawing). Probably some workaround can be found.

Besides, I am still checking a few other things...


---

Comment by git created at 2017-10-28 16:52:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-28 17:02:18

The above commit mostly improves the documentation. In particular, it adds the missing item `calc_method` in some `INPUT` sections and slightly improves some doctests.


---

Comment by git created at 2017-10-29 22:26:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-29 22:30:15

I am almost done checking the documentation; shall finish tomorrow...


---

Comment by rllozes created at 2017-10-30 15:32:28

On my 3-manifold, I observe the following timings:

# One thread takes 317s in Sage, 9311s in SymPy!\\

nabla = g.connection()

# One thread takes 95s in Sage, 1134s in SymPy!\\

LBpsi = nabla(nabla(psi).up(g)).trace(); LBpsi;

# One thread takes 872s in Sage, 36221s in SymPy!\\

Ric_g = g.ricci_scalar()

# One thread takes 482s in Sage, 24220s in SymPy!\\

Cot_g = g.cotton(); Cot_g.parent(); Cot_g.display()

I suggest we take a deeper look _after_ getting the functionality released.


---

Comment by egourgoulhon created at 2017-10-30 16:12:18

Replying to [comment:66 rllozes]:

I also noticed that SymPy is slower than Sage's symbolic (in particular in the tutorial and S<sup>2</sup> notebooks mentioned in comment:56 and comment:61).

> 
> I suggest we take a deeper look _after_ getting the functionality released.

I agree.


---

Attachment


---

Comment by rllozes created at 2017-10-30 22:29:14

The above attached notebook shows a failure when run with the multiprocessing directive 

```
Parallelism().set(nproc=4)
```

while computing the Laplace-Beltrami operator acting on a scalar field

```
nabla(nabla(psi).up(g)).trace()
}}} 
defined on a manifold having the 'sympy' option set
{{{
M.set_calculus_method('sympy')
}}}
When multiprocessing is turned off (nproc=1), this notebook completes without error.

I will try to find a quicker-running example.


---

Comment by egourgoulhon created at 2017-10-31 09:51:54

Replying to [comment:68 rllozes]:
> The above attached notebook shows a failure when run with the multiprocessing directive 

Can you resend the notebook? When I try to open it, I get the error

```
Unreadable Notebook: /home/eric/sage/8.1.beta8/22801_4threads_failure.ipynb NotJSONError("Notebook does not appear to be JSON:u'\\n{{{id=44|\\n# trac 22801 on top of .....",)
```



---

Comment by git created at 2017-10-31 12:12:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-10-31 12:19:45

I've finished to review the ticket. Marco, Ralf or Richard, if you agree with my changes, please set the ticket back to positive review (the parallelization issue raised in comment:68, if confirmed, could be dealt with in a separate ticket).

Thank you very much Marco for your work on this; it will be great to have the SymPy functionaly for manifolds in Sage 8.1!


---

Comment by rllozes created at 2017-10-31 15:08:20

I will abstain, having not read through all the changes. 
I can say that I am able to successfully build and run all the doctests (ptestlong).


---

Comment by mmancini created at 2017-11-02 08:49:01

Thanks to all for the review. 
I am going to treat the issue of parallelization (comment:68) which it seems not connencted to sympy.


---

Comment by mmancini created at 2017-11-02 09:42:10

Changing status from needs_review to positive_review.


---

Attachment

Showing failure with computations using sympy and parallelism (proc>1)


---

Comment by rllozes created at 2017-11-02 17:41:53

Replying to [comment:69 egourgoulhon]:
> Replying to [comment:68 rllozes]:
> > The above attached notebook shows a failure when run with the multiprocessing directive 
> 
> Can you resend the notebook? When I try to open it, I get the error
> {{{
> Unreadable Notebook: /home/eric/sage/8.1.beta8/22801_4threads_failure.ipynb NotJSONError("Notebook does not appear to be JSON:u'\\n{{{id=44|\\n# trac 22801 on top of .....",)
> }}}

Sorry - Please see second attachment. I will still try to find a simpler case.


---

Comment by rllozes created at 2017-11-02 21:22:18

Changing status from positive_review to needs_work.


---

Comment by rllozes created at 2017-11-02 21:22:18

1) Please remove redundant word "curve" which occurs within the documentation of curve.py and integrated_curve.py.
2) Are we letting the TODO's remain undone for this release?
3) In vectorfield_module.py, two occurrences each of "from the North pole" and "from the South pole" were changed to "from North pole" and "from South pole", respectively, resulting in non-standard English.


---

Comment by git created at 2017-11-03 09:28:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by egourgoulhon created at 2017-11-03 09:30:20

Replying to [comment:75 rllozes]:
> 
> Sorry - Please see second attachment. I will still try to find a simpler case.

Sorry I still cannot read this file: when I run `sage -n sagenb` and try to open it, I get "500: internal server error".


---

Comment by egourgoulhon created at 2017-11-03 09:38:01

Replying to [comment:76 rllozes]:
> 1) Please remove redundant word "curve" which occurs within the documentation of curve.py and integrated_curve.py.

Done in the above commit.

> 2) Are we letting the TODO's remain undone for this release?

IMHO yes, because they require substantial work and do not hinder the functionality implemented here.

> 3) In vectorfield_module.py, two occurrences each of "from the North pole" and "from the South pole" were changed to "from North pole" and "from South pole", respectively, resulting in non-standard English.

Corrected in the above commit; thanks.

Besides the above typos, the last commit restores the trig simplification that was commented out in `simplify_chain_generic_sympy` and `simplify_chain_real_sympy`. On general grounds, the SymPy simplification chain should be improved in another ticket.


---

Comment by egourgoulhon created at 2017-11-03 09:38:20

Changing status from needs_work to positive_review.


---

Comment by rllozes created at 2017-11-04 01:42:06

Finished review of all changed code and docs. 
I concur with status of positive_review.


---

Attachment

Replying to [comment:78 egourgoulhon]:
> Replying to [comment:75 rllozes]:
> > 
> > Sorry - Please see second attachment. I will still try to find a simpler case.
> 
> Sorry I still cannot read this file: when I run `sage -n sagenb` and try to open it, I get "500: internal server error".

I have just uploaded another copy, with a new name, after stripping the output and a few commented-out cells. It should open with the standard upload link in the Sage Notebook. It should run as is, and it should fail after changing Parallelism().set(nproc=1) from 1 to 2.


---

Comment by mmancini created at 2017-11-04 05:53:37

I have the same error,
looking into the file I don't see any sage command.


---

Comment by egourgoulhon created at 2017-11-04 08:21:10

Replying to [comment:82 rllozes]:
> 
> I have just uploaded another copy, with a new name, after stripping the output and a few commented-out cells. It should open with the standard upload link in the Sage Notebook. It should run as is, and it should fail after changing Parallelism().set(nproc=1) from 1 to 2.

This time, I can open the worksheet. Thank you. I am just running it.


---

Comment by vbraun created at 2017-11-04 23:31:19

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2017-11-04 23:31:19

Merge conflict with #24062


---

Comment by git created at 2017-11-06 10:15:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmancini created at 2017-11-06 10:16:26

Changing status from needs_work to needs_review.


---

Comment by mmancini created at 2017-11-06 10:16:26

The merge with #24062 done in the last commit. 
No problem for me


---

Comment by rws created at 2017-11-06 14:48:07

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-11-12 13:45:21

Changing status from positive_review to needs_review.


---

Comment by git created at 2017-11-12 13:45:21

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by egourgoulhon created at 2017-11-12 13:47:50

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2017-11-12 13:47:50

The above commit simply fixes a conflict with #24199. So I am setting the ticket back to "positive review".


---

Comment by git created at 2017-11-23 16:01:23

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-11-23 16:01:23

Changing status from positive_review to needs_review.


---

Comment by egourgoulhon created at 2017-11-23 16:03:40

Changing status from needs_review to positive_review.


---

Comment by egourgoulhon created at 2017-11-23 16:03:40

The above commit simply solves a new merge conflict that appeared after the replacement of #24199 by #24232 in the dependencies.


---

Comment by dimpase created at 2017-11-26 10:22:11

See the following bug report, in case
https://groups.google.com/d/msg/sage-devel/3sN7gVTdNuY/U9v70LoDAwAJ

By the way, I wonder why you prefer using pexpect interface to maxima, instead of much faster maxima_calcuclus loadable library interface?


---

Comment by egourgoulhon created at 2017-11-26 14:19:11

Replying to [comment:94 dimpase]:
> See the following bug report, in case
> https://groups.google.com/d/msg/sage-devel/3sN7gVTdNuY/U9v70LoDAwAJ
> 

As you pointed out in https://groups.google.com/d/msg/sage-devel/3sN7gVTdNuY/U9v70LoDAwAJ , this bug is not related to this ticket.

> By the way, I wonder why you prefer using pexpect interface to maxima, instead of much faster maxima_calcuclus loadable library interface?

Certainly by lack of knowledge... Thanks for your feedback! Can you elaborate a little bit though? Do you mean it is bad to use `expr._maxima_()` for `expr` in `SR`?


---

Comment by rws created at 2017-11-26 14:28:22

Replying to [comment:95 egourgoulhon]:
> Certainly by lack of knowledge... Thanks for your feedback! Can you elaborate a little bit though? Do you mean it is bad to use `expr._maxima_()` for `expr` in `SR`?

This uses `sage/interfaces/interfaces.py` which is pexpect. The libmaxima functionality can be found in `sage/interfaces/maxima_lib.py`.


---

Comment by dimpase created at 2017-11-26 15:46:35

I wonder why `_maxima_lib_()` is used only in few places in the library code, as opposed to `_maxima_()`. Should one open a ticket to modify all these places? 

Certainly `maxima_lib` is more robust and ought to be faster on large data of certain type, at least. It runs Maxima in a Python extension module rather than talks to Maxima run as an external process.


---

Comment by egourgoulhon created at 2017-11-26 16:36:49

Replying to [comment:97 dimpase]:
> I wonder why `_maxima_lib_()` is used only in few places in the library code, as opposed to `_maxima_()`. Should one open a ticket to modify all these places? 
> 

From what you say about `maxima_lib`, I would say yes. In particular, `_maxima_()` is used in various methods of `sage.symbolic.expression.Expression`, like `simplify()`, `simplify_factorial()` and `simplify_trig()`.


---

Comment by rws created at 2017-11-26 16:43:26

See #17753 and https://trac.sagemath.org/wiki/symbolics/maxima for a summary.


---

Comment by rllozes created at 2017-11-28 02:45:41

In the code at https://groups.google.com/d/msg/sage-devel/3sN7gVTdNuY/U9v70LoDAwAJ, if we change the computation method from 'SR' to 'sympy', the same Maxima/ECL bug occurs when computing g.inverse(), where 'g' is the Riemannian metric. Why does the code call the same simplification logic, disregarding the computation method setting as 'sympy'?


---

Comment by rws created at 2017-11-28 06:51:52

Please open a new ticket.


---

Comment by egourgoulhon created at 2017-11-28 08:43:30

Replying to [comment:101 rws]:
> Please open a new ticket.

This is #24290. It was on the todo list anyway (cf. the TODO statement in line 794 of https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/manifolds/utilities.py?id=780e1a477fe81c46d32286174fcb58d53e8cbe4c ).


---

Comment by vbraun created at 2017-12-13 17:38:43

Resolution: fixed
