# Issue 14292: Race conditions in doctester

archive/issues_014088.json:
```json
{
    "body": "The writing of the JSON file is prone to race conditions.\n\n**Assignee:** @roed314\n\n**Reviewer:** Volker Braun\n\n**Author:** Jeroen Demeyer\n\n**Merged:** sage-5.9.beta4\n\nIssue created by migration from https://trac.sagemath.org/ticket/14292\n\n",
    "closed_at": "2013-04-06T14:49:55Z",
    "created_at": "2013-03-17T11:42:58Z",
    "labels": [
        "component: doctest framework",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Race conditions in doctester",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14292",
    "user": "https://github.com/jdemeyer"
}
```
The writing of the JSON file is prone to race conditions.

**Assignee:** @roed314

**Reviewer:** Volker Braun

**Author:** Jeroen Demeyer

**Merged:** sage-5.9.beta4

Issue created by migration from https://trac.sagemath.org/ticket/14292





---

archive/issue_comments_173618.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+The writing of the JSON file is prone to race conditions.\n``````\n",
    "created_at": "2013-03-17T15:34:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173618",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+The writing of the JSON file is prone to race conditions.
``````




---

archive/issue_comments_173619.json:
```json
{
    "body": "<a id='comment:2'></a>\nWhat exactly goes wrong?  Loading and saving stats is done in `DocTestController`, so there aren't multiple processes trying to write to the same file...",
    "created_at": "2013-03-17T18:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173619",
    "user": "https://github.com/roed314"
}
```

<a id='comment:2'></a>
What exactly goes wrong?  Loading and saving stats is done in `DocTestController`, so there aren't multiple processes trying to write to the same file...



---

archive/issue_comments_173620.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [roed](#comment%3A2):\n> so there aren't multiple processes trying to write to the same file...\n\nThere could be when testing the doctester in parallel. Anyway I have a patch ready but it's on `sage.math` which is currently down.",
    "created_at": "2013-03-17T22:20:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173620",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Replying to [roed](#comment%3A2):
> so there aren't multiple processes trying to write to the same file...

There could be when testing the doctester in parallel. Anyway I have a patch ready but it's on `sage.math` which is currently down.



---

archive/issue_events_123716.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2013-03-28T22:46:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "component: doctest coverage",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123716"
}
```



---

archive/issue_events_123717.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2013-03-28T22:46:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "component: doctest framework",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123717"
}
```



---

archive/issue_comments_173621.json:
```json
{
    "body": "**Changing assignee** from mvngu to @roed314.",
    "created_at": "2013-03-28T22:46:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173621",
    "user": "https://github.com/roed314"
}
```

**Changing assignee** from mvngu to @roed314.



---

archive/issue_comments_173622.json:
```json
{
    "body": "<a id='comment:5'></a>\nOK, I managed to recover the data from `sage.math` including this patch. It's not the final version, but it shows the main idea.",
    "created_at": "2013-04-04T12:18:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173622",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:5'></a>
OK, I managed to recover the data from `sage.math` including this patch. It's not the final version, but it shows the main idea.



---

archive/issue_events_123718.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T13:17:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123718"
}
```



---

archive/issue_events_123719.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T13:58:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123719"
}
```



---

archive/issue_events_123720.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T13:58:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123720"
}
```



---

archive/issue_comments_173623.json:
```json
{
    "body": "<a id='comment:8'></a>\nIts good to have a general solution to this recurring problem. But writing via a temporary file is an ugly workaround for file locking, which is what we really want to do. It is also likely to hide race conditions. Also, on Win32 (and possibly other non-posix platforms) there is no atomic replace. File locking is also useful as a simple synchronization tool for clusters with a shared file system.",
    "created_at": "2013-04-04T14:01:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173623",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>
Its good to have a general solution to this recurring problem. But writing via a temporary file is an ugly workaround for file locking, which is what we really want to do. It is also likely to hide race conditions. Also, on Win32 (and possibly other non-posix platforms) there is no atomic replace. File locking is also useful as a simple synchronization tool for clusters with a shared file system.



---

archive/issue_comments_173624.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [vbraun](#comment%3A8):\n> But writing via a temporary file is an ugly workaround for file locking\n\nNot always. Locking has different goals. Locks should be held as short as possible, which cannot be guaranteed (for example when writing the GAP workspace). My solution also solves the problem of exceptions/crashes during the write and it doesn't need any changes to the reading of files.",
    "created_at": "2013-04-04T14:39:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173624",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:9'></a>
Replying to [vbraun](#comment%3A8):
> But writing via a temporary file is an ugly workaround for file locking

Not always. Locking has different goals. Locks should be held as short as possible, which cannot be guaranteed (for example when writing the GAP workspace). My solution also solves the problem of exceptions/crashes during the write and it doesn't need any changes to the reading of files.



---

archive/issue_events_123721.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T14:41:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123721"
}
```



---

archive/issue_events_123722.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T14:41:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123722"
}
```



---

archive/issue_comments_173625.json:
```json
{
    "body": "<a id='comment:11'></a>\nBut we really do want locking when creating the gap workspace instead of 10 processes creating the workspace 10 times and then fighting over the workspace file (last process standing wins).",
    "created_at": "2013-04-04T14:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173625",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
But we really do want locking when creating the gap workspace instead of 10 processes creating the workspace 10 times and then fighting over the workspace file (last process standing wins).



---

archive/issue_comments_173626.json:
```json
{
    "body": "<a id='comment:12'></a>\nDoes Python have *portable* file locking commands?",
    "created_at": "2013-04-04T15:02:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173626",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Does Python have *portable* file locking commands?



---

archive/issue_comments_173627.json:
```json
{
    "body": "<a id='comment:13'></a>\nNot natively, but e.g. https://github.com/smontanaro/pylockfile looks quite sane to me.",
    "created_at": "2013-04-04T15:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173627",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:13'></a>
Not natively, but e.g. https://github.com/smontanaro/pylockfile looks quite sane to me.



---

archive/issue_comments_173628.json:
```json
{
    "body": "<a id='comment:14'></a>\nVolker, I don't object to using that, but I still think this patch here is ready for review. I would rather use file locking *in addition* to the current patch such that we can have all advantages of both approaches.",
    "created_at": "2013-04-04T15:29:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173628",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Volker, I don't object to using that, but I still think this patch here is ready for review. I would rather use file locking *in addition* to the current patch such that we can have all advantages of both approaches.



---

archive/issue_comments_173629.json:
```json
{
    "body": "<a id='comment:15'></a>\nI agree that using a temp file is good enough for now. But it would be nice if we could rename `write_via_temp` to something that embodies the underlying idea instead of the implementation. Then we could improve the implementation later without having to change the usage. Maybe `write_safely` or `write_threadsafe`.",
    "created_at": "2013-04-04T15:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173629",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>
I agree that using a temp file is good enough for now. But it would be nice if we could rename `write_via_temp` to something that embodies the underlying idea instead of the implementation. Then we could improve the implementation later without having to change the usage. Maybe `write_safely` or `write_threadsafe`.



---

archive/issue_comments_173630.json:
```json
{
    "body": "<a id='comment:16'></a>\nIf you prefer `write_safely`, that's fine for me. However, I do think that using locking and using a temporary file are two different solutions which are sufficiently different to warrant different names. Given this, perhaps it is better to be explicit about the implementation.",
    "created_at": "2013-04-04T17:24:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173630",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
If you prefer `write_safely`, that's fine for me. However, I do think that using locking and using a temporary file are two different solutions which are sufficiently different to warrant different names. Given this, perhaps it is better to be explicit about the implementation.



---

archive/issue_comments_173631.json:
```json
{
    "body": "<a id='comment:17'></a>\nWell if your goal is to eventually have both proper locking and atomic writing separately then thats fine. But the name should still convey why we are doing that, not how. \n\nObviously many Sage developers are not familiar with which file system operations are atomic, so they will rightfully be confused when they see code that writes a cache with `write_via_temp`. Clearly there is an optimization where you take out that extra step ;-)\n\nHow about `atomic_write`?",
    "created_at": "2013-04-04T18:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173631",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>
Well if your goal is to eventually have both proper locking and atomic writing separately then thats fine. But the name should still convey why we are doing that, not how. 

Obviously many Sage developers are not familiar with which file system operations are atomic, so they will rightfully be confused when they see code that writes a cache with `write_via_temp`. Clearly there is an optimization where you take out that extra step ;-)

How about `atomic_write`?



---

archive/issue_comments_173632.json:
```json
{
    "body": "<a id='comment:18'></a>\nDo you agree with the patch, modulo the naming of `write_via_temp`?",
    "created_at": "2013-04-04T18:26:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173632",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Do you agree with the patch, modulo the naming of `write_via_temp`?



---

archive/issue_comments_173633.json:
```json
{
    "body": "<a id='comment:19'></a>\nYes, I think its great to use a with block and the actual implementation seems fine. With the caveat that Windows can't do atomic replace, but then there is nothing we can do about it.",
    "created_at": "2013-04-04T18:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173633",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>
Yes, I think its great to use a with block and the actual implementation seems fine. With the caveat that Windows can't do atomic replace, but then there is nothing we can do about it.



---

archive/attachments_019312.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "14292_doctest_race.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket14292/14292_doctest_race.patch",
    "created_at": "2013-04-05T09:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_173634.json:
```json
{
    "body": "",
    "created_at": "2013-04-05T09:23:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173634",
    "user": "https://github.com/jdemeyer"
}
```





---

archive/issue_comments_173635.json:
```json
{
    "body": "**Reviewer:** Volker Braun",
    "created_at": "2013-04-05T09:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173635",
    "user": "https://github.com/jdemeyer"
}
```

**Reviewer:** Volker Braun



---

archive/issue_events_123723.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-05T09:24:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123723"
}
```



---

archive/issue_events_123724.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-05T09:24:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123724"
}
```



---

archive/issue_comments_173636.json:
```json
{
    "body": "<a id='comment:20'></a>\nOK, renamed to `atomic_write`.",
    "created_at": "2013-04-05T09:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173636",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:20'></a>
OK, renamed to `atomic_write`.



---

archive/issue_comments_173637.json:
```json
{
    "body": "**Merged:** sage-5.9.beta4",
    "created_at": "2013-04-06T14:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14292#issuecomment-173637",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.9.beta4



---

archive/issue_events_123725.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-06T14:49:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123725"
}
```



---

archive/issue_events_123726.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-06T14:49:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14292",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14292#event-123726"
}
```
