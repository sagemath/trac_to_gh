# Issue 14292: Race conditions in doctester

archive/issues_014088.json:
```json
{
    "assignees": [],
    "body": "The writing of the JSON file is prone to race conditions.\n\nAssignee: **@roed314**\n\nReviewer: **Volker Braun**\n\nAuthor: **Jeroen Demeyer**\n\nMerged: **sage-5.9.beta4**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14292_\n\n",
    "closed_at": "2013-04-06T14:49:55Z",
    "created_at": "2013-03-17T11:42:58Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Race conditions in doctester",
    "type": "issue",
    "updated_at": "2013-04-06T14:49:55Z",
    "url": "https://github.com/sagemath/sage/issues/14292",
    "user": "https://github.com/jdemeyer"
}
```
The writing of the JSON file is prone to race conditions.

Assignee: **@roed314**

Reviewer: **Volker Braun**

Author: **Jeroen Demeyer**

Merged: **sage-5.9.beta4**

_Issue created by migration from https://trac.sagemath.org/ticket/14292_





---

archive/issue_events_184972.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-17T11:42:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184972"
}
```



---

archive/issue_events_184973.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-17T11:42:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184973"
}
```



---

archive/issue_events_184974.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-17T11:42:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184974"
}
```



---

archive/issue_events_184975.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-17T11:42:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184975"
}
```



---

archive/issue_comments_173684.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-\n+The writing of the JSON file is prone to race conditions.\n``````\n",
    "created_at": "2013-03-17T15:34:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173684",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1 @@
-
+The writing of the JSON file is prone to race conditions.
``````




---

archive/issue_comments_173685.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nWhat exactly goes wrong?  Loading and saving stats is done in `DocTestController`, so there aren't multiple processes trying to write to the same file...",
    "created_at": "2013-03-17T18:27:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173685",
    "user": "https://github.com/roed314"
}
```

<div id="comment:2" align="right">Comment 2</div>

What exactly goes wrong?  Loading and saving stats is done in `DocTestController`, so there aren't multiple processes trying to write to the same file...



---

archive/issue_comments_173686.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nReplying to [@roed314](#comment%3A2):\n> so there aren't multiple processes trying to write to the same file...\n\nThere could be when testing the doctester in parallel. Anyway I have a patch ready but it's on `sage.math` which is currently down.",
    "created_at": "2013-03-17T22:20:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173686",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">Comment 3</div>

Replying to [@roed314](#comment%3A2):
> so there aren't multiple processes trying to write to the same file...

There could be when testing the doctester in parallel. Anyway I have a patch ready but it's on `sage.math` which is currently down.



---

archive/issue_events_184976.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2013-03-28T22:46:23Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184976"
}
```



---

archive/issue_events_184977.json:
```json
{
    "actor": "https://github.com/roed314",
    "created_at": "2013-03-28T22:46:23Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20doctest%20framework",
    "label_color": "000080",
    "label_name": "component: doctest framework",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184977"
}
```



---

archive/issue_comments_173687.json:
```json
{
    "body": "Changed assignee from **@sagetrac-mvngu** to **@roed314**",
    "created_at": "2013-03-28T22:46:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173687",
    "user": "https://github.com/roed314"
}
```

Changed assignee from **@sagetrac-mvngu** to **@roed314**



---

archive/issue_comments_173688.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nOK, I managed to recover the data from `sage.math` including this patch. It's not the final version, but it shows the main idea.",
    "created_at": "2013-04-04T12:18:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173688",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">Comment 5</div>

OK, I managed to recover the data from `sage.math` including this patch. It's not the final version, but it shows the main idea.



---

archive/issue_events_184978.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T13:17:14Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184978"
}
```



---

archive/issue_events_184979.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T13:58:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184979"
}
```



---

archive/issue_events_184980.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T13:58:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184980"
}
```



---

archive/issue_comments_173689.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nIts good to have a general solution to this recurring problem. But writing via a temporary file is an ugly workaround for file locking, which is what we really want to do. It is also likely to hide race conditions. Also, on Win32 (and possibly other non-posix platforms) there is no atomic replace. File locking is also useful as a simple synchronization tool for clusters with a shared file system.",
    "created_at": "2013-04-04T14:01:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173689",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">Comment 8</div>

Its good to have a general solution to this recurring problem. But writing via a temporary file is an ugly workaround for file locking, which is what we really want to do. It is also likely to hide race conditions. Also, on Win32 (and possibly other non-posix platforms) there is no atomic replace. File locking is also useful as a simple synchronization tool for clusters with a shared file system.



---

archive/issue_comments_173690.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@vbraun](#comment%3A8):\n> But writing via a temporary file is an ugly workaround for file locking\n\nNot always. Locking has different goals. Locks should be held as short as possible, which cannot be guaranteed (for example when writing the GAP workspace). My solution also solves the problem of exceptions/crashes during the write and it doesn't need any changes to the reading of files.",
    "created_at": "2013-04-04T14:39:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173690",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@vbraun](#comment%3A8):
> But writing via a temporary file is an ugly workaround for file locking

Not always. Locking has different goals. Locks should be held as short as possible, which cannot be guaranteed (for example when writing the GAP workspace). My solution also solves the problem of exceptions/crashes during the write and it doesn't need any changes to the reading of files.



---

archive/issue_events_184981.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T14:41:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184981"
}
```



---

archive/issue_events_184982.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T14:41:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184982"
}
```



---

archive/issue_comments_173691.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nBut we really do want locking when creating the gap workspace instead of 10 processes creating the workspace 10 times and then fighting over the workspace file (last process standing wins).",
    "created_at": "2013-04-04T14:49:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173691",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:11" align="right">Comment 11</div>

But we really do want locking when creating the gap workspace instead of 10 processes creating the workspace 10 times and then fighting over the workspace file (last process standing wins).



---

archive/issue_comments_173692.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nDoes Python have *portable* file locking commands?",
    "created_at": "2013-04-04T15:02:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173692",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">Comment 12</div>

Does Python have *portable* file locking commands?



---

archive/issue_comments_173693.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nNot natively, but e.g. https://github.com/smontanaro/pylockfile looks quite sane to me.",
    "created_at": "2013-04-04T15:08:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173693",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:13" align="right">Comment 13</div>

Not natively, but e.g. https://github.com/smontanaro/pylockfile looks quite sane to me.



---

archive/issue_comments_173694.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nVolker, I don't object to using that, but I still think this patch here is ready for review. I would rather use file locking *in addition* to the current patch such that we can have all advantages of both approaches.",
    "created_at": "2013-04-04T15:29:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173694",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">Comment 14</div>

Volker, I don't object to using that, but I still think this patch here is ready for review. I would rather use file locking *in addition* to the current patch such that we can have all advantages of both approaches.



---

archive/issue_comments_173695.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nI agree that using a temp file is good enough for now. But it would be nice if we could rename `write_via_temp` to something that embodies the underlying idea instead of the implementation. Then we could improve the implementation later without having to change the usage. Maybe `write_safely` or `write_threadsafe`.",
    "created_at": "2013-04-04T15:43:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173695",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:15" align="right">Comment 15</div>

I agree that using a temp file is good enough for now. But it would be nice if we could rename `write_via_temp` to something that embodies the underlying idea instead of the implementation. Then we could improve the implementation later without having to change the usage. Maybe `write_safely` or `write_threadsafe`.



---

archive/issue_comments_173696.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nIf you prefer `write_safely`, that's fine for me. However, I do think that using locking and using a temporary file are two different solutions which are sufficiently different to warrant different names. Given this, perhaps it is better to be explicit about the implementation.",
    "created_at": "2013-04-04T17:24:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173696",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">Comment 16</div>

If you prefer `write_safely`, that's fine for me. However, I do think that using locking and using a temporary file are two different solutions which are sufficiently different to warrant different names. Given this, perhaps it is better to be explicit about the implementation.



---

archive/issue_comments_173697.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nWell if your goal is to eventually have both proper locking and atomic writing separately then thats fine. But the name should still convey why we are doing that, not how. \n\nObviously many Sage developers are not familiar with which file system operations are atomic, so they will rightfully be confused when they see code that writes a cache with `write_via_temp`. Clearly there is an optimization where you take out that extra step ;-)\n\nHow about `atomic_write`?",
    "created_at": "2013-04-04T18:03:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173697",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:17" align="right">Comment 17</div>

Well if your goal is to eventually have both proper locking and atomic writing separately then thats fine. But the name should still convey why we are doing that, not how. 

Obviously many Sage developers are not familiar with which file system operations are atomic, so they will rightfully be confused when they see code that writes a cache with `write_via_temp`. Clearly there is an optimization where you take out that extra step ;-)

How about `atomic_write`?



---

archive/issue_comments_173698.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nDo you agree with the patch, modulo the naming of `write_via_temp`?",
    "created_at": "2013-04-04T18:26:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173698",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">Comment 18</div>

Do you agree with the patch, modulo the naming of `write_via_temp`?



---

archive/issue_comments_173699.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nYes, I think its great to use a with block and the actual implementation seems fine. With the caveat that Windows can't do atomic replace, but then there is nothing we can do about it.",
    "created_at": "2013-04-04T18:33:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173699",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">Comment 19</div>

Yes, I think its great to use a with block and the actual implementation seems fine. With the caveat that Windows can't do atomic replace, but then there is nothing we can do about it.



---

archive/issue_comments_173700.json:
```json
{
    "body": "Attachment: **[14292_doctest_race.patch.gz](https://github.com/sagemath/sage/files/ticket14292/14292_doctest_race.patch.gz)**",
    "created_at": "2013-04-05T09:23:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173700",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[14292_doctest_race.patch.gz](https://github.com/sagemath/sage/files/ticket14292/14292_doctest_race.patch.gz)**



---

archive/issue_comments_173701.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2013-04-05T09:24:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173701",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Volker Braun**



---

archive/issue_events_184983.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-05T09:24:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184983"
}
```



---

archive/issue_events_184984.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-05T09:24:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184984"
}
```



---

archive/issue_comments_173702.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nOK, renamed to `atomic_write`.",
    "created_at": "2013-04-05T09:24:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173702",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">Comment 20</div>

OK, renamed to `atomic_write`.



---

archive/issue_comments_173703.json:
```json
{
    "body": "Merged: **sage-5.9.beta4**",
    "created_at": "2013-04-06T14:49:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14292#issuecomment-173703",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.9.beta4**



---

archive/issue_events_184985.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-06T14:49:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184985"
}
```



---

archive/issue_events_184986.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-06T14:49:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14292",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14292#event-184986"
}
```
