# Issue 14976: integration with non symbolic bounds broken

archive/issues_014739.json:
```json
{
    "body": "[Reported on sage-support by Victor Miller](https://groups.google.com/d/topic/sage-support/o0rwQId7ELU/discussion):\n\n```\nsage: var('a'); function('f',a)\nsage: g = f(a).integrate(a,0,a^2)\nsage: g\nintegrate(f(a),0,a^2)\n\nsage: g.derivative(a)\n\nError in lines 1-1\nTraceback (most recent call last):\n  File \"/mnt/home/lQoU8m2s/.sagemathcloud/sage_server.py\", line 498, in execute\n    exec compile(block+'\\n', '', 'single') in namespace, locals\n  File \"\", line 1, in <module>\n  File \"expression.pyx\", line 3006, in sage.symbolic.expression.Expression.derivative (sage/symbolic/expression.cpp:15855)\n  File \"derivative.pyx\", line 216, in sage.misc.derivative.multi_derivative (sage/misc/derivative.c:2715)\n  File \"expression.pyx\", line 3078, in sage.symbolic.expression.Expression._derivative (sage/symbolic/expression.cpp:16245)\n  File \"/usr/local/sage/sage-5.10.rc1/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py\", line 224, in _tderivative_\n    - f.subs(x==a)*a.diff(diff_param)\n  File \"element.pyx\", line 344, in sage.structure.element.Element.__getattr__ (sage/structure/element.c:3871)\n  File \"misc.pyx\", line 257, in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1696)\nAttributeError: 'sage.rings.integer.Integer' object has no attribute 'diff'\n\nsage: g1 = f(a).integrate(a)\nsage: g1(0)\nError in lines 1-1\nTraceback (most recent call last):\n  File \"/mnt/home/lQoU8m2s/.sagemathcloud/sage_server.py\", line 498, in execute\n    exec compile(block+'\\n', '', 'single') in namespace, locals\n  File \"\", line 1, in <module>\n  File \"expression.pyx\", line 3973, in sage.symbolic.expression.Expression.__call__ (sage/symbolic/expression.cpp:19900)\n  File \"ring.pyx\", line 685, in sage.symbolic.ring.SymbolicRing._call_element_ (sage/symbolic/ring.cpp:7672)\n  File \"expression.pyx\", line 3824, in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:19177)\n  File \"/usr/local/sage/sage-5.10.rc1/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py\", line 75, in _eval_\n    if len(x.variables()) == 1:\n  File \"element.pyx\", line 344, in sage.structure.element.Element.__getattr__ (sage/structure/element.c:3871)\n  File \"misc.pyx\", line 257, in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1696)\nAttributeError: 'sage.rings.integer.Integer' object has no attribute 'variables'\n```\n\n**CC:**  @kcrisman\n\n**Keywords:** integration\n\n**Status:** new\n\nIssue created by migration from https://trac.sagemath.org/ticket/14976\n\n",
    "created_at": "2013-07-26T09:10:05Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "integration with non symbolic bounds broken",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14976",
    "user": "https://github.com/burcin"
}
```
[Reported on sage-support by Victor Miller](https://groups.google.com/d/topic/sage-support/o0rwQId7ELU/discussion):

```
sage: var('a'); function('f',a)
sage: g = f(a).integrate(a,0,a^2)
sage: g
integrate(f(a),0,a^2)

sage: g.derivative(a)

Error in lines 1-1
Traceback (most recent call last):
  File "/mnt/home/lQoU8m2s/.sagemathcloud/sage_server.py", line 498, in execute
    exec compile(block+'\n', '', 'single') in namespace, locals
  File "", line 1, in <module>
  File "expression.pyx", line 3006, in sage.symbolic.expression.Expression.derivative (sage/symbolic/expression.cpp:15855)
  File "derivative.pyx", line 216, in sage.misc.derivative.multi_derivative (sage/misc/derivative.c:2715)
  File "expression.pyx", line 3078, in sage.symbolic.expression.Expression._derivative (sage/symbolic/expression.cpp:16245)
  File "/usr/local/sage/sage-5.10.rc1/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py", line 224, in _tderivative_
    - f.subs(x==a)*a.diff(diff_param)
  File "element.pyx", line 344, in sage.structure.element.Element.__getattr__ (sage/structure/element.c:3871)
  File "misc.pyx", line 257, in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1696)
AttributeError: 'sage.rings.integer.Integer' object has no attribute 'diff'

sage: g1 = f(a).integrate(a)
sage: g1(0)
Error in lines 1-1
Traceback (most recent call last):
  File "/mnt/home/lQoU8m2s/.sagemathcloud/sage_server.py", line 498, in execute
    exec compile(block+'\n', '', 'single') in namespace, locals
  File "", line 1, in <module>
  File "expression.pyx", line 3973, in sage.symbolic.expression.Expression.__call__ (sage/symbolic/expression.cpp:19900)
  File "ring.pyx", line 685, in sage.symbolic.ring.SymbolicRing._call_element_ (sage/symbolic/ring.cpp:7672)
  File "expression.pyx", line 3824, in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:19177)
  File "/usr/local/sage/sage-5.10.rc1/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py", line 75, in _eval_
    if len(x.variables()) == 1:
  File "element.pyx", line 344, in sage.structure.element.Element.__getattr__ (sage/structure/element.c:3871)
  File "misc.pyx", line 257, in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1696)
AttributeError: 'sage.rings.integer.Integer' object has no attribute 'variables'
```

**CC:**  @kcrisman

**Keywords:** integration

**Status:** new

Issue created by migration from https://trac.sagemath.org/ticket/14976





---

archive/issue_comments_225890.json:
```json
{
    "body": "<a id='comment:1'></a>\nThe problem is that (maxima's ?) integrate needs to assert that integration bounds are real: consider this (slightly generalized) example:\n\n```\nMaxima 5.30.0 http://maxima.sourceforge.net\nusing Lisp GNU Common Lisp (GCL) GCL 2.6.7 (a.k.a. GCL)\nDistributed under the GNU Public License. See the file COPYING.\nDedicated to the memory of William Schelter.\nThe function bug_report() provides bug reporting information.\n(%i1) display2d:false;\n\n(%o1) false\n(%i2) define(h(x), integrate(f(t), t, g1(x), g2(x)));\n\ndefint: lower limit of integration must be real; found g1(x)\n -- an error. To debug this try: debugmode(true);\n(%i3) declare(g1, real, g2, real);\n\n(%o3) done\n(%i4) define(h(x), integrate(f(t), t, g1(x), g2(x)));\n\n(%o4) h(x):='integrate(f(t),t,g1(x),g2(x))\n(%i5) diff(h(x), x);\n\n(%o5) f(g2(x))*'diff(g2(x),x,1)-f(g1(x))*'diff(g1(x),x,1)\n(%i6) \n```\nMaxima allows for declaring \"after the fact\" that g1 and g2 are sympbols for real values, and extends this declaration to the case where g1 and 2 are symbols for functions, which are now interpreted as real-valued functions.\n\nAs far as I know, there is no way to declare the domain of a function in Sage.\n\nAnd, since the Sage-to-Maxima interface uses arbitrary (and volatile !) symbols, one cannot simply use \"maxima('declare(g1, real, g2, real);')\" to this effect...\n\n```\nsage: var(\"x,t\")\n(x, t)\nsage: f=function(\"f\",t)\nsage: g1=function(\"g1\",t)\nsage: g2=function(\"g2\",t)\nsage: maxima(\"declare(g1,real,g2,real);\")\ndone\nsage: h(x)=integrate(f(t),t,g1(x),g2(x))\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2721: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)\nSee http://trac.sagemath.org/5930 for details.\n  exec code_obj in self.user_global_ns, self.user_ns\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n<ipython-input-10-7dd129794e9a> in <module>()\n----> 1 __tmp__=var(\"x\"); h = symbolic_expression(integrate(f(t),t,g1(x),g2(x))).function(x)\n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/misc/functional.pyc in integral(x, *args, **kwds)\n    738     \"\"\"\n    739     if hasattr(x, 'integral'):\n--> 740         return x.integral(*args, **kwds)\n    741     else:\n    742         from sage.symbolic.ring import SR\n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.integral (sage/symbolic/expression.cpp:39592)()\n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.pyc in integrate(expression, v, a, b, algorithm)\n    686         return indefinite_integral(expression, v)\n    687     else:\n--> 688         return definite_integral(expression, v, a, b)\n    689 \n    690 integral= integrate\n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/function.so in sage.symbolic.function.Function.__call__ (sage/symbolic/function.cpp:5114)()\n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.pyc in _eval_(self, f, x, a, b)\n    171         for integrator in self.integrators:\n    172             try:\n--> 173                 return integrator(*args)\n    174             except NotImplementedError:\n    175                 pass\n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/integration/external.pyc in maxima_integrator(expression, v, a, b)\n     19         result = maxima.sr_integral(expression,v)\n     20     else:\n---> 21         result = maxima.sr_integral(expression, v, a, b)\n     22     return result._sage_()\n     23 \n\n/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.pyc in sr_integral(self, *args)\n    745                 raise ValueError, \"Computation failed since Maxima requested additional constraints; using the 'assume' command before integral evaluation *may* help (example of legal syntax is 'assume(\" + s[4:k] +\">0)', see `assume?` for more details)\\n\" + s\n    746             else:\n--> 747                 raise error\n    748 \n    749     def sr_sum(self,*args):\n\nRuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g1(x)\n\n```\nMaxima won't, however, accept to declare a function as real :\n\n```\n(%i6) declare(s(x), real);\n\ndeclare: improper argument: s(x)\n -- an error. To debug this try: debugmode(true);\n```\nThere is an *horrible* workaround : create *variables*, g1 and g2, assume them real, then create functions f, g1 and g2:\n\n```\nsage: var(\"x, t, g1, g2\")\n(x, t, g1, g2)\nsage: assume(g1, \"real\", g2, \"real\")\nsage: f=function(\"f\",t)\nsage: g1=function(\"g1\",x)\nsage: g2=function(\"g2\",x)\nsage: h(x)=integrate(f(t), t,g1(x), g2(x))\nsage: h(x)\nintegrate(f(t), t, g1(x), g2(x))\nsage: diff(h(x),x)\n-f(g1(x))*D[0](g1)(x) + f(g2(x))*D[0](g2)(x)\nsage: \n```\nThe core of the problem is, however, the inability to declare a function as real. Maxima's declaration of a *symbol's* domain \"happens to work\", but a cleaner solution is needed. I am afraid that it involves work both on Sage *and* Maxima.\n\nHTH,\n\nEmmanuel Charpentier",
    "created_at": "2013-07-28T09:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225890",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:1'></a>
The problem is that (maxima's ?) integrate needs to assert that integration bounds are real: consider this (slightly generalized) example:

```
Maxima 5.30.0 http://maxima.sourceforge.net
using Lisp GNU Common Lisp (GCL) GCL 2.6.7 (a.k.a. GCL)
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) display2d:false;

(%o1) false
(%i2) define(h(x), integrate(f(t), t, g1(x), g2(x)));

defint: lower limit of integration must be real; found g1(x)
 -- an error. To debug this try: debugmode(true);
(%i3) declare(g1, real, g2, real);

(%o3) done
(%i4) define(h(x), integrate(f(t), t, g1(x), g2(x)));

(%o4) h(x):='integrate(f(t),t,g1(x),g2(x))
(%i5) diff(h(x), x);

(%o5) f(g2(x))*'diff(g2(x),x,1)-f(g1(x))*'diff(g1(x),x,1)
(%i6) 
```
Maxima allows for declaring "after the fact" that g1 and g2 are sympbols for real values, and extends this declaration to the case where g1 and 2 are symbols for functions, which are now interpreted as real-valued functions.

As far as I know, there is no way to declare the domain of a function in Sage.

And, since the Sage-to-Maxima interface uses arbitrary (and volatile !) symbols, one cannot simply use "maxima('declare(g1, real, g2, real);')" to this effect...

```
sage: var("x,t")
(x, t)
sage: f=function("f",t)
sage: g1=function("g1",t)
sage: g2=function("g2",t)
sage: maxima("declare(g1,real,g2,real);")
done
sage: h(x)=integrate(f(t),t,g1(x),g2(x))
/usr/local/sage-5.10/local/lib/python2.7/site-packages/IPython/core/interactiveshell.py:2721: DeprecationWarning: Substitution using function-call syntax and unnamed arguments is deprecated and will be removed from a future release of Sage; you can use named arguments instead, like EXPR(x=..., y=...)
See http://trac.sagemath.org/5930 for details.
  exec code_obj in self.user_global_ns, self.user_ns
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-10-7dd129794e9a> in <module>()
----> 1 __tmp__=var("x"); h = symbolic_expression(integrate(f(t),t,g1(x),g2(x))).function(x)

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/misc/functional.pyc in integral(x, *args, **kwds)
    738     """
    739     if hasattr(x, 'integral'):
--> 740         return x.integral(*args, **kwds)
    741     else:
    742         from sage.symbolic.ring import SR

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/expression.so in sage.symbolic.expression.Expression.integral (sage/symbolic/expression.cpp:39592)()

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.pyc in integrate(expression, v, a, b, algorithm)
    686         return indefinite_integral(expression, v)
    687     else:
--> 688         return definite_integral(expression, v, a, b)
    689 
    690 integral= integrate

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/function.so in sage.symbolic.function.Function.__call__ (sage/symbolic/function.cpp:5114)()

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.pyc in _eval_(self, f, x, a, b)
    171         for integrator in self.integrators:
    172             try:
--> 173                 return integrator(*args)
    174             except NotImplementedError:
    175                 pass

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/symbolic/integration/external.pyc in maxima_integrator(expression, v, a, b)
     19         result = maxima.sr_integral(expression,v)
     20     else:
---> 21         result = maxima.sr_integral(expression, v, a, b)
     22     return result._sage_()
     23 

/usr/local/sage-5.10/local/lib/python2.7/site-packages/sage/interfaces/maxima_lib.pyc in sr_integral(self, *args)
    745                 raise ValueError, "Computation failed since Maxima requested additional constraints; using the 'assume' command before integral evaluation *may* help (example of legal syntax is 'assume(" + s[4:k] +">0)', see `assume?` for more details)\n" + s
    746             else:
--> 747                 raise error
    748 
    749     def sr_sum(self,*args):

RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g1(x)

```
Maxima won't, however, accept to declare a function as real :

```
(%i6) declare(s(x), real);

declare: improper argument: s(x)
 -- an error. To debug this try: debugmode(true);
```
There is an *horrible* workaround : create *variables*, g1 and g2, assume them real, then create functions f, g1 and g2:

```
sage: var("x, t, g1, g2")
(x, t, g1, g2)
sage: assume(g1, "real", g2, "real")
sage: f=function("f",t)
sage: g1=function("g1",x)
sage: g2=function("g2",x)
sage: h(x)=integrate(f(t), t,g1(x), g2(x))
sage: h(x)
integrate(f(t), t, g1(x), g2(x))
sage: diff(h(x),x)
-f(g1(x))*D[0](g1)(x) + f(g2(x))*D[0](g2)(x)
sage: 
```
The core of the problem is, however, the inability to declare a function as real. Maxima's declaration of a *symbol's* domain "happens to work", but a cleaner solution is needed. I am afraid that it involves work both on Sage *and* Maxima.

HTH,

Emmanuel Charpentier



---

archive/issue_comments_225891.json:
```json
{
    "body": "<a id='comment:2'></a>\nLooking at the returned error, I do not get the impression this has anything to do with maxima or with checking whether something is real-valued. The error we're getting is that attributes like `variables` and `derivative` end up being looked up on sage integer objects rather than on SR elements. This must happen somewhere during the picking apart of the expression:\n\n```\nsage: g\nintegrate(f(a), a, 0, a^2)\nsage: [type(o) for o in g.operands()]\n[sage.symbolic.expression.Expression,\n sage.symbolic.expression.Expression,\n sage.symbolic.expression.Expression,\n sage.symbolic.expression.Expression]\nsage: g.operands()[2].diff(a)\n0\n```\nas you see, all quantities involved are symbolic expressions and this \"symbolic constant 0\" has no problem being differentiated.\n\n```\nsage: g.derivative(a)\nAttributeError\nsage: %debug\nipdb> up\n> /usr/local/sage/5.7/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py(224)_tderivative_()\n    223         return ans + f.subs(x==b)*b.diff(diff_param) \\\n--> 224                     - f.subs(x==a)*a.diff(diff_param)\n    225 \nipdb> p [(c,type(c)) for c in [f,x,a,b,diff_param]]\n[(f(a), <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>), (0, <type 'sage.rings.integer.Integer'>), (a^2, <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>)]\n```\nI suspect that this lower bound `a=0` (here a is the local variable in `_tderivative`) is coming from the lower integration bound involved in the definition of `g`, and apparently this bound got stripped out of SR a little prematurely for this purpose. Probably replacing the code above with\n\n```\n        return ans + f.subs(x==b)*SR(b).diff(diff_param) \\\n                    - f.subs(x==a)*SR(a).diff(diff_param)\n```\nwould solve the problem. However it might be worthwhile to look why `a` got stripped out of SR in the first place and whether that should simply be prevented at the spot (so that `_tderivative` gets called with symbolic `a,b` regardless of whether they happen to be integer constants)",
    "created_at": "2013-07-30T16:25:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225891",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'></a>
Looking at the returned error, I do not get the impression this has anything to do with maxima or with checking whether something is real-valued. The error we're getting is that attributes like `variables` and `derivative` end up being looked up on sage integer objects rather than on SR elements. This must happen somewhere during the picking apart of the expression:

```
sage: g
integrate(f(a), a, 0, a^2)
sage: [type(o) for o in g.operands()]
[sage.symbolic.expression.Expression,
 sage.symbolic.expression.Expression,
 sage.symbolic.expression.Expression,
 sage.symbolic.expression.Expression]
sage: g.operands()[2].diff(a)
0
```
as you see, all quantities involved are symbolic expressions and this "symbolic constant 0" has no problem being differentiated.

```
sage: g.derivative(a)
AttributeError
sage: %debug
ipdb> up
> /usr/local/sage/5.7/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py(224)_tderivative_()
    223         return ans + f.subs(x==b)*b.diff(diff_param) \
--> 224                     - f.subs(x==a)*a.diff(diff_param)
    225 
ipdb> p [(c,type(c)) for c in [f,x,a,b,diff_param]]
[(f(a), <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>), (0, <type 'sage.rings.integer.Integer'>), (a^2, <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>)]
```
I suspect that this lower bound `a=0` (here a is the local variable in `_tderivative`) is coming from the lower integration bound involved in the definition of `g`, and apparently this bound got stripped out of SR a little prematurely for this purpose. Probably replacing the code above with

```
        return ans + f.subs(x==b)*SR(b).diff(diff_param) \
                    - f.subs(x==a)*SR(a).diff(diff_param)
```
would solve the problem. However it might be worthwhile to look why `a` got stripped out of SR in the first place and whether that should simply be prevented at the spot (so that `_tderivative` gets called with symbolic `a,b` regardless of whether they happen to be integer constants)



---

archive/issue_comments_225892.json:
```json
{
    "body": "<a id='comment:3'></a>\nI disagree. See below :\n\nReplying to [nbruin](#comment%3A2):\n> Looking at the returned error, I do not get the impression this has anything to do with maxima or with checking whether something is real-valued. The error we're getting is that attributes like `variables` and `derivative` end up being looked up on sage integer objects rather than on SR elements. This must happen somewhere during the picking apart of the expression:\n> \n> ```\n> sage: g\n> integrate(f(a), a, 0, a^2)\n> sage: [type(o) for o in g.operands()]\n> [sage.symbolic.expression.Expression,\n>  sage.symbolic.expression.Expression,\n>  sage.symbolic.expression.Expression,\n>  sage.symbolic.expression.Expression]\n> sage: g.operands()[2].diff(a)\n> 0\n> ```\n> as you see, all quantities involved are symbolic expressions and this \"symbolic constant 0\" has no problem being differentiated.\n> \n> ```\n> sage: g.derivative(a)\n> AttributeError\n> sage: %debug\n> ipdb> up\n> > /usr/local/sage/5.7/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py(224)_tderivative_()\n>     223         return ans + f.subs(x==b)*b.diff(diff_param) \\\n> --> 224                     - f.subs(x==a)*a.diff(diff_param)\n>     225 \n> ipdb> p [(c,type(c)) for c in [f,x,a,b,diff_param]]\n> [(f(a), <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>), (0, <type 'sage.rings.integer.Integer'>), (a^2, <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>)]\n> ```\n> I suspect that this lower bound `a=0` (here a is the local variable in `_tderivative`) is coming from the lower integration bound involved in the definition of `g`, and apparently this bound got stripped out of SR a little prematurely for this purpose.\n\n\nSo ? If this was tre source of the error, it shouldn't happen with symbolic lower and upper bounds (see my slightly generalized example), but it does. Furrthermore, declaring the bounds as real allows for completing the task (bothh from maxima and from sage)...\n\n Probably replacing the code above with\n> \n> ```\n>         return ans + f.subs(x==b)*SR(b).diff(diff_param) \\\n>                     - f.subs(x==a)*SR(a).diff(diff_param)\n> ```\n> would solve the problem. However it might be worthwhile to look why `a` got stripped out of SR in the first place and whether that should simply be prevented at the spot (so that `_tderivative` gets called with symbolic `a,b` regardless of whether they happen to be integer constants)\n",
    "created_at": "2013-07-31T15:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225892",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:3'></a>
I disagree. See below :

Replying to [nbruin](#comment%3A2):
> Looking at the returned error, I do not get the impression this has anything to do with maxima or with checking whether something is real-valued. The error we're getting is that attributes like `variables` and `derivative` end up being looked up on sage integer objects rather than on SR elements. This must happen somewhere during the picking apart of the expression:
> 
> ```
> sage: g
> integrate(f(a), a, 0, a^2)
> sage: [type(o) for o in g.operands()]
> [sage.symbolic.expression.Expression,
>  sage.symbolic.expression.Expression,
>  sage.symbolic.expression.Expression,
>  sage.symbolic.expression.Expression]
> sage: g.operands()[2].diff(a)
> 0
> ```
> as you see, all quantities involved are symbolic expressions and this "symbolic constant 0" has no problem being differentiated.
> 
> ```
> sage: g.derivative(a)
> AttributeError
> sage: %debug
> ipdb> up
> > /usr/local/sage/5.7/local/lib/python2.7/site-packages/sage/symbolic/integration/integral.py(224)_tderivative_()
>     223         return ans + f.subs(x==b)*b.diff(diff_param) \
> --> 224                     - f.subs(x==a)*a.diff(diff_param)
>     225 
> ipdb> p [(c,type(c)) for c in [f,x,a,b,diff_param]]
> [(f(a), <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>), (0, <type 'sage.rings.integer.Integer'>), (a^2, <type 'sage.symbolic.expression.Expression'>), (a, <type 'sage.symbolic.expression.Expression'>)]
> ```
> I suspect that this lower bound `a=0` (here a is the local variable in `_tderivative`) is coming from the lower integration bound involved in the definition of `g`, and apparently this bound got stripped out of SR a little prematurely for this purpose.


So ? If this was tre source of the error, it shouldn't happen with symbolic lower and upper bounds (see my slightly generalized example), but it does. Furrthermore, declaring the bounds as real allows for completing the task (bothh from maxima and from sage)...

 Probably replacing the code above with
> 
> ```
>         return ans + f.subs(x==b)*SR(b).diff(diff_param) \
>                     - f.subs(x==a)*SR(a).diff(diff_param)
> ```
> would solve the problem. However it might be worthwhile to look why `a` got stripped out of SR in the first place and whether that should simply be prevented at the spot (so that `_tderivative` gets called with symbolic `a,b` regardless of whether they happen to be integer constants)




---

archive/issue_comments_225893.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [charpent](#comment%3A3):\n> So ? If this was tre source of the error, it shouldn't happen with symbolic lower and upper bounds (see my slightly generalized example), but it does. Furrthermore, declaring the bounds as real allows for completing the task (bothh from maxima and from sage)...\n\n\nIt's the source of the errors reported in the ticket. The problems reported in the ticket arise without interaction with maxima.\n\nYou're diagnosing a different problem, that integration with certain *symbolic* bounds is *also* broken. Compare:\n\n```\nsage: var('x,t,a,b')\n(x, t, a, b)\nsage: function('f')\nf\nsage: function('g')\ng\nsage: integrate(f(x),x,a,b)\nintegrate(f(x), x, a, b)\nsage: integrate(f(x),x,sin(t),b)\nintegrate(f(x), x, sin(t), b)\nsage: integrate(f(x),x,sin(1+i*t),b)\nRuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found sin(%i*t+1)\nsage: integrate(f(x),x,g(t),b)\nRuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g(t)\n```\n\nIndeed, for definite integrals, maxima seems to want to know if the integration bounds are real.\nHowever, Maxima seems to assume quite happily by itself that `a,b,sin(t)` are real, but doesn't think `sin(1+i*t)` is real and for some reason refuses to assume anything about `g(t)`.\n\nYour workaround is interesting in that it shows that maxima's \"assume\" facility can be of some help to nudge maxima into the desired direction. It seems to me the problem you're diagnosing is best addressed by working mainly on maxima. As far as I've seen, sage is offering reasonable input to maxima.",
    "created_at": "2013-07-31T17:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225893",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:4'></a>
Replying to [charpent](#comment%3A3):
> So ? If this was tre source of the error, it shouldn't happen with symbolic lower and upper bounds (see my slightly generalized example), but it does. Furrthermore, declaring the bounds as real allows for completing the task (bothh from maxima and from sage)...


It's the source of the errors reported in the ticket. The problems reported in the ticket arise without interaction with maxima.

You're diagnosing a different problem, that integration with certain *symbolic* bounds is *also* broken. Compare:

```
sage: var('x,t,a,b')
(x, t, a, b)
sage: function('f')
f
sage: function('g')
g
sage: integrate(f(x),x,a,b)
integrate(f(x), x, a, b)
sage: integrate(f(x),x,sin(t),b)
integrate(f(x), x, sin(t), b)
sage: integrate(f(x),x,sin(1+i*t),b)
RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found sin(%i*t+1)
sage: integrate(f(x),x,g(t),b)
RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g(t)
```

Indeed, for definite integrals, maxima seems to want to know if the integration bounds are real.
However, Maxima seems to assume quite happily by itself that `a,b,sin(t)` are real, but doesn't think `sin(1+i*t)` is real and for some reason refuses to assume anything about `g(t)`.

Your workaround is interesting in that it shows that maxima's "assume" facility can be of some help to nudge maxima into the desired direction. It seems to me the problem you're diagnosing is best addressed by working mainly on maxima. As far as I've seen, sage is offering reasonable input to maxima.



---

archive/issue_comments_225894.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [nbruin](#comment%3A4):\n\n> Replying to [charpent](#comment%3A3)  :\n> > So ? If this was tre source of the error, it shouldn't happen with symbolic lower and upper bounds (see my slightly generalized example), but it does. Furrthermore, declaring the bounds as real allows for completing the task (bothh from maxima and from sage)...\n\n> It's the source of the errors reported in the ticket. The problems reported in the ticket arise without interaction with maxima.\n\nYou might be right. I tend to think too much like a physician and tend to attach all symptoms to the same cause (it is rare that a patient has symptoms caused by two different diseases with onset at the same time...).\n\n> You're diagnosing a different problem, that integration with certain *  symbolic*   bounds is *  also*   broken. Compare:\u00a0sage: var('x,t,a,b') (x, t, a, b) sage: function('f') f sage: function('g') g sage: integrate(f(x),x,a,b) integrate(f(x), x, a, b) sage: integrate(f(x),x,sin(t),b) integrate(f(x), x, sin(t), b) sage: integrate(f(x),x,sin(1+i*t),b) RuntimeError : ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found sin(%i*t+1) sage: integrate(f(x),x,g(t),b) RuntimeError : ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g(t)Indeed, for definite integrals, maxima seems to want to know if the integration bounds are real. However, Maxima seems to assume quite happily by itself that `a,b,sin(t)`   are real, but doesn't think `sin(1+i*t)`   is real and for some reason refuses to assume anything about `g(t)`  . Your workaround is interesting in that it shows that maxima's \"assume\" facility can be of some help to nudge maxima into the desired direction. It seems to me the problem you're diagnosing is best addressed by working mainly on maxima. As far as I've seen, sage is offering reasonable input to maxima.\n\n\nHmmm... Maxima's \"assume\" also has serious limitations. Many questions Maxima may ask during a computation cannot be prevented by previous assumptions, since those cannot use expressions. For example, during an (unrelated) integration, maxima asked \"`Is (m/s) an integer ?`\". I checked that maxima does *not* allow  for \"`assume(m/s, noninteger);`\".\n\nFurthermore, sage noes not (currently) allows for interaction during such a computation. Instead, it spits out an error suggesting to use assume...\n\nSo we have *two* limitations : Maxima's assumption system, which is indeed maxima-specific, *AND* sage's non-use of interactions.\n\nIIRC, Mathematica, when confronted with such a question, does not interact with user but tries to generate a list (a tree ?) of possible questions and gives a list of answers along a set of conditions. Of course, there is no guarantee that such a tree is finite...\n\nAny thoughts ? I reported the gist of the problem to Maxima's mailing list. Should I file a bug abainst Maxima's assume ?",
    "created_at": "2013-08-01T11:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225894",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:6'></a>
Replying to [nbruin](#comment%3A4):

> Replying to [charpent](#comment%3A3)  :
> > So ? If this was tre source of the error, it shouldn't happen with symbolic lower and upper bounds (see my slightly generalized example), but it does. Furrthermore, declaring the bounds as real allows for completing the task (bothh from maxima and from sage)...

> It's the source of the errors reported in the ticket. The problems reported in the ticket arise without interaction with maxima.

You might be right. I tend to think too much like a physician and tend to attach all symptoms to the same cause (it is rare that a patient has symptoms caused by two different diseases with onset at the same time...).

> You're diagnosing a different problem, that integration with certain *  symbolic*   bounds is *  also*   broken. Compare: sage: var('x,t,a,b') (x, t, a, b) sage: function('f') f sage: function('g') g sage: integrate(f(x),x,a,b) integrate(f(x), x, a, b) sage: integrate(f(x),x,sin(t),b) integrate(f(x), x, sin(t), b) sage: integrate(f(x),x,sin(1+i*t),b) RuntimeError : ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found sin(%i*t+1) sage: integrate(f(x),x,g(t),b) RuntimeError : ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g(t)Indeed, for definite integrals, maxima seems to want to know if the integration bounds are real. However, Maxima seems to assume quite happily by itself that `a,b,sin(t)`   are real, but doesn't think `sin(1+i*t)`   is real and for some reason refuses to assume anything about `g(t)`  . Your workaround is interesting in that it shows that maxima's "assume" facility can be of some help to nudge maxima into the desired direction. It seems to me the problem you're diagnosing is best addressed by working mainly on maxima. As far as I've seen, sage is offering reasonable input to maxima.


Hmmm... Maxima's "assume" also has serious limitations. Many questions Maxima may ask during a computation cannot be prevented by previous assumptions, since those cannot use expressions. For example, during an (unrelated) integration, maxima asked "`Is (m/s) an integer ?`". I checked that maxima does *not* allow  for "`assume(m/s, noninteger);`".

Furthermore, sage noes not (currently) allows for interaction during such a computation. Instead, it spits out an error suggesting to use assume...

So we have *two* limitations : Maxima's assumption system, which is indeed maxima-specific, *AND* sage's non-use of interactions.

IIRC, Mathematica, when confronted with such a question, does not interact with user but tries to generate a list (a tree ?) of possible questions and gives a list of answers along a set of conditions. Of course, there is no guarantee that such a tree is finite...

Any thoughts ? I reported the gist of the problem to Maxima's mailing list. Should I file a bug abainst Maxima's assume ?



---

archive/issue_comments_225895.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [charpent](#comment%3A6):\n> Hmmm... Maxima's \"assume\" also has serious limitations. Many questions Maxima may ask during a computation cannot be prevented by previous assumptions, since those cannot use expressions. For example, during an (unrelated) integration, maxima asked \"`Is (m/s) an integer ?`\". I checked that maxima does *not* allow  for \"`assume(m/s, noninteger);`\".\n\n\nIt's known and widely acknowledged that maxima's assume facility is rather weak and not very well integrated (many functions that could benefit from assumptions do not look at them). If you search you'll find many threads about it.\n\nThere also have been various attempts in changing maxima's tendency to ask questions (but never in maxima proper, as far as I know. It's simply taken as a design decision there).\n\nFor sage's purposes, our only reasonable option is to treat a question as an error condition, because we simply cannot assume there is anyone to answer the question. That's at least what people have found up to now. If you have a viable prototype for handling questions otherwise, it can always be considered, of course.\n\n> Any thoughts ? I reported the gist of the problem to Maxima's mailing list. Should I file a bug abainst Maxima's assume ?\n\n\nMentioning the difference between the handling of\n\n```\nintegrate(f(x),x,a,b)\n```\nand\n\n```\nintegrate(f(x),x,a(t),b(t))\n```\nis probably worthwhile. For the rest, you're just pointing out well-known shortcomings.",
    "created_at": "2013-08-01T22:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225895",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:7'></a>
Replying to [charpent](#comment%3A6):
> Hmmm... Maxima's "assume" also has serious limitations. Many questions Maxima may ask during a computation cannot be prevented by previous assumptions, since those cannot use expressions. For example, during an (unrelated) integration, maxima asked "`Is (m/s) an integer ?`". I checked that maxima does *not* allow  for "`assume(m/s, noninteger);`".


It's known and widely acknowledged that maxima's assume facility is rather weak and not very well integrated (many functions that could benefit from assumptions do not look at them). If you search you'll find many threads about it.

There also have been various attempts in changing maxima's tendency to ask questions (but never in maxima proper, as far as I know. It's simply taken as a design decision there).

For sage's purposes, our only reasonable option is to treat a question as an error condition, because we simply cannot assume there is anyone to answer the question. That's at least what people have found up to now. If you have a viable prototype for handling questions otherwise, it can always be considered, of course.

> Any thoughts ? I reported the gist of the problem to Maxima's mailing list. Should I file a bug abainst Maxima's assume ?


Mentioning the difference between the handling of

```
integrate(f(x),x,a,b)
```
and

```
integrate(f(x),x,a(t),b(t))
```
is probably worthwhile. For the rest, you're just pointing out well-known shortcomings.



---

archive/issue_events_049613.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14976#event-49613"
}
```



---

archive/issue_events_049614.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14976#event-49614"
}
```



---

archive/issue_events_049615.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:19:32Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14976#event-49615"
}
```



---

archive/issue_comments_225896.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [charpent](#comment%3A6):\n\nThe unnecessary interaction with the user is now treated in #16653. Now back to the originally reported error which can be presumably fixed in Sage.",
    "created_at": "2014-07-13T06:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225896",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>
Replying to [charpent](#comment%3A6):

The unnecessary interaction with the user is now treated in #16653. Now back to the originally reported error which can be presumably fixed in Sage.



---

archive/issue_events_049616.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14976#event-49616"
}
```



---

archive/issue_events_049617.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14976#event-49617"
}
```



---

archive/issue_comments_225897.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [nbruin](#comment%3A4):\n> You're diagnosing a different problem, that integration with certain *symbolic* bounds is *also* broken. Compare:\n> \n> ```\n> sage: var('x,t,a,b')\n> (x, t, a, b)\n> sage: function('f')\n> f\n> sage: function('g')\n> g\n> sage: integrate(f(x),x,a,b)\n> integrate(f(x), x, a, b)\n> sage: integrate(f(x),x,sin(t),b)\n> integrate(f(x), x, sin(t), b)\n> sage: integrate(f(x),x,sin(1+i*t),b)\n> RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found sin(%i*t+1)\n> sage: integrate(f(x),x,g(t),b)\n> RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g(t)\n> ```\n\nThis no longer gives an error.",
    "created_at": "2014-12-02T10:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14976",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14976#issuecomment-225897",
    "user": "https://github.com/rwst"
}
```

<a id='comment:12'></a>
Replying to [nbruin](#comment%3A4):
> You're diagnosing a different problem, that integration with certain *symbolic* bounds is *also* broken. Compare:
> 
> ```
> sage: var('x,t,a,b')
> (x, t, a, b)
> sage: function('f')
> f
> sage: function('g')
> g
> sage: integrate(f(x),x,a,b)
> integrate(f(x), x, a, b)
> sage: integrate(f(x),x,sin(t),b)
> integrate(f(x), x, sin(t), b)
> sage: integrate(f(x),x,sin(1+i*t),b)
> RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found sin(%i*t+1)
> sage: integrate(f(x),x,g(t),b)
> RuntimeError: ECL says: Error executing code in Maxima: defint: lower limit of integration must be real; found g(t)
> ```

This no longer gives an error.
