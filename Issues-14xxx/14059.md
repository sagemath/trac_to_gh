# Issue 14059: Fix refcount/deallocation of integers

archive/issues_013855.json:
```json
{
    "assignees": [],
    "body": "In #2435, the deallocation function in sage/rings/integer.pyx became as follows:\n\n```python\ncdef void fast_tp_dealloc(PyObject* o):\n\n    # If there is room in the pool for a used integer object,\n    # then put it in rather than deallocating it.\n\n    global integer_pool, integer_pool_count\n    \n    if integer_pool_count < integer_pool_size:\n    \n        # Here we free any extra memory used by the mpz_t by\n        # setting it to a single limb. \n        if (<__mpz_struct *>( <char *>o + mpz_t_offset))._mp_alloc > 10:\n            _mpz_realloc(<mpz_t *>( <char *>o + mpz_t_offset), 10)\n            \n        # It's cheap to zero out an integer, so do it here. \n        (<__mpz_struct *>( <char *>o + mpz_t_offset))._mp_size = 0\n        \n        # And add it to the pool.\n        integer_pool[integer_pool_count] = o\n        integer_pool_count += 1\n        return\n\n    # Again, we move to the mpz_t and clear it. See above, why this is evil.\n    # The clean version of this line would be:\n    #   mpz_clear(<mpz_t>(<char *>o + mpz_t_offset))\n\n    mpz_free((<__mpz_struct *>( <char *>o + mpz_t_offset) )._mp_d, 0)\n\n    # Free the object. This assumes that Py_TPFLAGS_HAVE_GC is not\n    # set. If it was set another free function would need to be\n    # called.\n\n    PyObject_FREE(o)\n```\n\nThe purpose of #2435 was to fix a memory leak introduced in #1337. Problem: One has to manually incref `ONE`, which I find a bit suspicious.\n\nWhen I build sage-5.7.beta2 in debug version (as by #13864), Sage crashes at exit, while attempting `PyObject_FREE(o)`. I will attach backtraces in comments.\n\nThe problem is the workaround for ONE (which is not cdefed so get collected at exit) got removed (accidently?) at #12615.\nWe simplify the workaround nd completetly remove the use of ONE and use the new one from #12615.\nThere still are strange things going one with allocation and deallocation before and after setting up the hooked functions with debug builds of Python, but with the current setting everything seems, so the workarounds are sufficient.\n\nApply [attachment:trac_14059.patch](https://github.com/sagemath/sage/files/ticket14059/trac_14059.patch).\n\n**Assignee:** @rlmill\n\n**CC:**  @nbruin @robertwb @nathanncohen\n\n**Reviewer:** Jean-Pierre Flori\n\n**Author:** Simon King\n\n**Merged:** sage-5.7.beta4\n\nIssue created by migration from https://trac.sagemath.org/ticket/14059\n\n",
    "closed_at": "2013-02-09T12:16:02Z",
    "created_at": "2013-02-05T10:56:03Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20memleak",
        "https://github.com/sagemath/sage/labels/blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix refcount/deallocation of integers",
    "type": "issue",
    "updated_at": "2013-02-09T12:16:02Z",
    "url": "https://github.com/sagemath/sage/issues/14059",
    "user": "https://github.com/simon-king-jena"
}
```
In #2435, the deallocation function in sage/rings/integer.pyx became as follows:

```python
cdef void fast_tp_dealloc(PyObject* o):

    # If there is room in the pool for a used integer object,
    # then put it in rather than deallocating it.

    global integer_pool, integer_pool_count
    
    if integer_pool_count < integer_pool_size:
    
        # Here we free any extra memory used by the mpz_t by
        # setting it to a single limb. 
        if (<__mpz_struct *>( <char *>o + mpz_t_offset))._mp_alloc > 10:
            _mpz_realloc(<mpz_t *>( <char *>o + mpz_t_offset), 10)
            
        # It's cheap to zero out an integer, so do it here. 
        (<__mpz_struct *>( <char *>o + mpz_t_offset))._mp_size = 0
        
        # And add it to the pool.
        integer_pool[integer_pool_count] = o
        integer_pool_count += 1
        return

    # Again, we move to the mpz_t and clear it. See above, why this is evil.
    # The clean version of this line would be:
    #   mpz_clear(<mpz_t>(<char *>o + mpz_t_offset))

    mpz_free((<__mpz_struct *>( <char *>o + mpz_t_offset) )._mp_d, 0)

    # Free the object. This assumes that Py_TPFLAGS_HAVE_GC is not
    # set. If it was set another free function would need to be
    # called.

    PyObject_FREE(o)
```

The purpose of #2435 was to fix a memory leak introduced in #1337. Problem: One has to manually incref `ONE`, which I find a bit suspicious.

When I build sage-5.7.beta2 in debug version (as by #13864), Sage crashes at exit, while attempting `PyObject_FREE(o)`. I will attach backtraces in comments.

The problem is the workaround for ONE (which is not cdefed so get collected at exit) got removed (accidently?) at #12615.
We simplify the workaround nd completetly remove the use of ONE and use the new one from #12615.
There still are strange things going one with allocation and deallocation before and after setting up the hooked functions with debug builds of Python, but with the current setting everything seems, so the workarounds are sufficient.

Apply [attachment:trac_14059.patch](https://github.com/sagemath/sage/files/ticket14059/trac_14059.patch).

**Assignee:** @rlmill

**CC:**  @nbruin @robertwb @nathanncohen

**Reviewer:** Jean-Pierre Flori

**Author:** Simon King

**Merged:** sage-5.7.beta4

Issue created by migration from https://trac.sagemath.org/ticket/14059





---

archive/issue_events_167546.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-05T10:56:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "milestone_number": null,
    "milestone_title": "sage-5.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167546"
}
```



---

archive/issue_events_167547.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-05T10:56:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20memleak",
    "label_color": "08517b",
    "label_name": "component: memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167547"
}
```



---

archive/issue_events_167548.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-05T10:56:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/blocker",
    "label_color": "ff0000",
    "label_name": "blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167548"
}
```



---

archive/issue_events_167549.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-05T10:56:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "008080",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167549"
}
```



---

archive/issue_comments_169440.json:
```json
{
    "body": "<a id='comment:1'>**Comment 1:**</a>\nStarting and quitting Sage yields (with the optional gdb package from #13866)\n\n```\nsage: \nExiting Sage (CPU time 0m0.06s, Wall time 0m7.51s).\nDebug memory block at address p=0x1c817e0: API '\ufffd'\n    18302628885633695743 bytes originally requested\n    The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):\n        at p-7: 0xcb *** OUCH\n        at p-6: 0xcb *** OUCH\n        at p-5: 0xcb *** OUCH\n        at p-4: 0xcb *** OUCH\n        at p-3: 0xcb *** OUCH\n        at p-2: 0xcb *** OUCH\n        at p-1: 0xcb *** OUCH\n    Because memory is corrupted at the start, the count of bytes requested\n       may be bogus, and checking the trailing pad bytes may segfault.\n    The 8 pad bytes at tail=0xfe00000001c817df are ------------------------------------------------------------------------\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so(print_backtrace+0x31)[0x7fa099a7210d]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so(sigdie+0x3d)[0x7fa099a7228f]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so(sage_signal_handler+0x199)[0x7fa099a71ae3]\n/lib64/libpthread.so.0(+0xfd00)[0x7fa09cf83d00]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugDumpAddress+0x292)[0x7fa09d24eebe]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugCheckAddressApi+0x114)[0x7fa09d24ec1e]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugFreeApi+0x36)[0x7fa09d24e8de]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugFree+0x1d)[0x7fa09d24e78a]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python2.7/site-packages/sage/rings/integer.so(+0x80292)[0x7fa08a30d292]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_Py_Dealloc+0x35)[0x7fa09d24cbe4]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(+0xace8e)[0x7fa09d23de8e]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_Py_Dealloc+0x35)[0x7fa09d24cbe4]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(+0xace8e)[0x7fa09d23de8e]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_Py_Dealloc+0x35)[0x7fa09d24cbe4]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyImport_Fini+0x80)[0x7fa09d306b45]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(Py_Finalize+0x58)[0x7fa09d31ab86]\n/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(Py_Main+0xec1)[0x7fa09d33776b]\npython(main+0x20)[0x4007b4]\n/lib64/libc.so.6(__libc_start_main+0xed)[0x7fa09c5a723d]\npython[0x4006d9]\n------------------------------------------------------------------------\nAttaching gdb to process id 29767.\nGNU gdb (GDB) 7.5.1\nCopyright (C) 2012 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"x86_64-unknown-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>.\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\n0x00007fa09cf838bd in waitpid () from /lib64/libpthread.so.0\n\nStack backtrace\n---------------\nNo symbol table info available.\n#1  0x00007fa099a72250 in print_enhanced_backtrace () from /home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so\nNo symbol table info available.\n#2  0x00007fa099a722c2 in sigdie () from /home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so\nNo symbol table info available.\n#3  0x00007fa099a71ae3 in sage_signal_handler () from /home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so\nNo symbol table info available.\n#4  <signal handler called>\nNo symbol table info available.\n#5  0x00007fa09d24eebe in _PyObject_DebugDumpAddress (p=0x1c817e0) at Objects/obmalloc.c:1649\n        q = 0x1c817e0 \"\"\n        tail = 0xfe00000001c817df <Address 0xfe00000001c817df out of bounds>\n        nbytes = 18302628885633695743\n        serial = 29890528\n        i = 0\n        ok = 1\n        id = -53 '\\313'\n#6  0x00007fa09d24ec1e in _PyObject_DebugCheckAddressApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1590\n        q = 0x1c817e0 \"\"\n        msgbuf = \"bad ID: Allocated using API '\\313', verified using API 'o'\\000\\000\\000\\000\\000\\000\\000\\000\"\n        msg = 0x7fff6ce1a910 \"bad ID: Allocated using API '\\313', verified using API 'o'\"\n        nbytes = 28403168\n        tail = 0x67 <Address 0x67 out of bounds>\n        i = 32767\n        id = -53 '\\313'\n#7  0x00007fa09d24e8de in _PyObject_DebugFreeApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1478\n        q = 0x1c817d0 \"\\375\\377\\377\\377\\377\\377\\377\\377\\313\\313\\313\\313\\313\\313\\313\", <incomplete sequence \\313>\n        nbytes = 28429568\n#8  0x00007fa09d24e78a in _PyObject_DebugFree (p=0x1c817e0) at Objects/obmalloc.c:1422\nNo locals.\n#9  0x00007fa08a30d292 in __pyx_f_4sage_5rings_7integer_fast_tp_dealloc (__pyx_v_o=0x1c817e0) at sage/rings/integer.c:35775\n        __pyx_t_1 = 0\n#10 0x00007fa09d24cbe4 in _Py_Dealloc (op=0x1c817e0) at Objects/object.c:2243\n        dealloc = 0x7fa08a30d1c4 <__pyx_f_4sage_5rings_7integer_fast_tp_dealloc>\n#11 0x00007fa09d23de8e in dict_dealloc (mp=0x1ccef60) at Objects/dictobject.c:985\n        ep = 0x1cd31a8\n        fill = 25\n#12 0x00007fa09d24cbe4 in _Py_Dealloc (op=0x1ccef60) at Objects/object.c:2243\n        dealloc = 0x7fa09d23dd5b <dict_dealloc>\n#13 0x00007fa09d23de8e in dict_dealloc (mp=0x673ba0) at Objects/dictobject.c:985\n        ep = 0x1b86bd8\n        fill = 277\n#14 0x00007fa09d24cbe4 in _Py_Dealloc (op=0x673ba0) at Objects/object.c:2243\n        dealloc = 0x7fa09d23dd5b <dict_dealloc>\n#15 0x00007fa09d306b45 in _PyImport_Fini () at Python/import.c:244\nNo locals.\n#16 0x00007fa09d31ab86 in Py_Finalize () at Python/pythonrun.c:470\n        interp = 0x602010\n        tstate = 0x6020a0\n#17 0x00007fa09d33776b in Py_Main (argc=3, argv=0x7fff6ce1ad68) at Modules/main.c:664\n        c = -1\n        sts = 0\n        command = 0x0\n        filename = 0x7fff6ce1b856 \"/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/sage-ipython\"\n        module = 0x0\n        fp = 0x684a90\n        p = 0x0\n        unbuffered = 0\n        skipfirstline = 0\n        stdin_is_interactive = 1\n        help = 0\n        version = 0\n        saw_unbuffered_flag = 0\n        cf = {cf_flags = 0}\n#18 0x00000000004007b4 in main (argc=3, argv=0x7fff6ce1ad68) at ./Modules/python.c:23\nNo locals.\n\n\nCython backtrace (newest frame = last)\n--------------------------------------\n#0  0x0000000000400794 in main()\n#1  0x00007fa09d3368aa in Py_Main()\n#2  0x00007fa09d31ab2e in Py_Finalize()\n#3  0x00007fa09d306ac5 in _PyImport_Fini()\n#4  0x00007fa09d24cbaf in _Py_Dealloc()\n#5  0x00007fa09d23dd5b in dict_dealloc()\n#6  0x00007fa09d24cbaf in _Py_Dealloc()\n#7  0x00007fa09d23dd5b in dict_dealloc()\n#8  0x00007fa09d24cbaf in _Py_Dealloc()\n#9  0x00007fa08a30d1c4 in fast_tp_dealloc() at /home/simon/SAGE/debug/sage-5.7.beta2/devel/sage-main/sage/rings/integer.pyx:6053\n  6048    \n  6049        # Free the object. This assumes that Py_TPFLAGS_HAVE_GC is not\n  6050        # set. If it was set another free function would need to be\n  6051        # called.\n  6052    \n> 6053        PyObject_FREE(o)\n  6054    \n  6055    \n  6056    hook_fast_tp_functions()\n  6057    from sage.misc.allocator cimport hook_tp_functions\n#10 0x00007fa09d24e76d in _PyObject_DebugFree()\n#11 0x00007fa09d24e8a8 in _PyObject_DebugFreeApi()\n#12 0x00007fa09d24eb0a in _PyObject_DebugCheckAddressApi()\n#13 0x00007fa09d24ec2c in _PyObject_DebugDumpAddress()\n#14 0x00007fa09d617a10 in __restore_rt()\n#15 0x00007fa099a7194a in sage_signal_handler()\n#16 0x00007fa099a72252 in sigdie()\n#17 0x00007fa099a7212b in print_enhanced_backtrace()\n#18 0x00007fa09cf83860 in waitpid()\n\n\nSaved trace to /home/simon/.sage/crash_logs/sage_crash_WekcH8.log\n------------------------------------------------------------------------\nUnhandled SIGSEGV: A segmentation fault occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off(). You might\nwant to run Sage under gdb with 'sage -gdb' to debug this.\nSage will now terminate.\n------------------------------------------------------------------------\n../../sage: Zeile 135: 29767 Speicherzugriffsfehler  \"$SAGE_ROOT/spkg/bin/sage\" \"$@\"\n```",
    "created_at": "2013-02-05T11:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169440",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'>**Comment 1:**</a>
Starting and quitting Sage yields (with the optional gdb package from #13866)

```
sage: 
Exiting Sage (CPU time 0m0.06s, Wall time 0m7.51s).
Debug memory block at address p=0x1c817e0: API '�'
    18302628885633695743 bytes originally requested
    The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):
        at p-7: 0xcb *** OUCH
        at p-6: 0xcb *** OUCH
        at p-5: 0xcb *** OUCH
        at p-4: 0xcb *** OUCH
        at p-3: 0xcb *** OUCH
        at p-2: 0xcb *** OUCH
        at p-1: 0xcb *** OUCH
    Because memory is corrupted at the start, the count of bytes requested
       may be bogus, and checking the trailing pad bytes may segfault.
    The 8 pad bytes at tail=0xfe00000001c817df are ------------------------------------------------------------------------
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so(print_backtrace+0x31)[0x7fa099a7210d]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so(sigdie+0x3d)[0x7fa099a7228f]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so(sage_signal_handler+0x199)[0x7fa099a71ae3]
/lib64/libpthread.so.0(+0xfd00)[0x7fa09cf83d00]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugDumpAddress+0x292)[0x7fa09d24eebe]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugCheckAddressApi+0x114)[0x7fa09d24ec1e]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugFreeApi+0x36)[0x7fa09d24e8de]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyObject_DebugFree+0x1d)[0x7fa09d24e78a]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python2.7/site-packages/sage/rings/integer.so(+0x80292)[0x7fa08a30d292]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_Py_Dealloc+0x35)[0x7fa09d24cbe4]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(+0xace8e)[0x7fa09d23de8e]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_Py_Dealloc+0x35)[0x7fa09d24cbe4]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(+0xace8e)[0x7fa09d23de8e]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_Py_Dealloc+0x35)[0x7fa09d24cbe4]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(_PyImport_Fini+0x80)[0x7fa09d306b45]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(Py_Finalize+0x58)[0x7fa09d31ab86]
/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libpython2.7.so.1.0(Py_Main+0xec1)[0x7fa09d33776b]
python(main+0x20)[0x4007b4]
/lib64/libc.so.6(__libc_start_main+0xed)[0x7fa09c5a723d]
python[0x4006d9]
------------------------------------------------------------------------
Attaching gdb to process id 29767.
GNU gdb (GDB) 7.5.1
Copyright (C) 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-unknown-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib64/libthread_db.so.1".
0x00007fa09cf838bd in waitpid () from /lib64/libpthread.so.0

Stack backtrace
---------------
No symbol table info available.
#1  0x00007fa099a72250 in print_enhanced_backtrace () from /home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so
No symbol table info available.
#2  0x00007fa099a722c2 in sigdie () from /home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so
No symbol table info available.
#3  0x00007fa099a71ae3 in sage_signal_handler () from /home/simon/SAGE/debug/sage-5.7.beta2/local/lib/libcsage.so
No symbol table info available.
#4  <signal handler called>
No symbol table info available.
#5  0x00007fa09d24eebe in _PyObject_DebugDumpAddress (p=0x1c817e0) at Objects/obmalloc.c:1649
        q = 0x1c817e0 ""
        tail = 0xfe00000001c817df <Address 0xfe00000001c817df out of bounds>
        nbytes = 18302628885633695743
        serial = 29890528
        i = 0
        ok = 1
        id = -53 '\313'
#6  0x00007fa09d24ec1e in _PyObject_DebugCheckAddressApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1590
        q = 0x1c817e0 ""
        msgbuf = "bad ID: Allocated using API '\313', verified using API 'o'\000\000\000\000\000\000\000\000"
        msg = 0x7fff6ce1a910 "bad ID: Allocated using API '\313', verified using API 'o'"
        nbytes = 28403168
        tail = 0x67 <Address 0x67 out of bounds>
        i = 32767
        id = -53 '\313'
#7  0x00007fa09d24e8de in _PyObject_DebugFreeApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1478
        q = 0x1c817d0 "\375\377\377\377\377\377\377\377\313\313\313\313\313\313\313", <incomplete sequence \313>
        nbytes = 28429568
#8  0x00007fa09d24e78a in _PyObject_DebugFree (p=0x1c817e0) at Objects/obmalloc.c:1422
No locals.
#9  0x00007fa08a30d292 in __pyx_f_4sage_5rings_7integer_fast_tp_dealloc (__pyx_v_o=0x1c817e0) at sage/rings/integer.c:35775
        __pyx_t_1 = 0
#10 0x00007fa09d24cbe4 in _Py_Dealloc (op=0x1c817e0) at Objects/object.c:2243
        dealloc = 0x7fa08a30d1c4 <__pyx_f_4sage_5rings_7integer_fast_tp_dealloc>
#11 0x00007fa09d23de8e in dict_dealloc (mp=0x1ccef60) at Objects/dictobject.c:985
        ep = 0x1cd31a8
        fill = 25
#12 0x00007fa09d24cbe4 in _Py_Dealloc (op=0x1ccef60) at Objects/object.c:2243
        dealloc = 0x7fa09d23dd5b <dict_dealloc>
#13 0x00007fa09d23de8e in dict_dealloc (mp=0x673ba0) at Objects/dictobject.c:985
        ep = 0x1b86bd8
        fill = 277
#14 0x00007fa09d24cbe4 in _Py_Dealloc (op=0x673ba0) at Objects/object.c:2243
        dealloc = 0x7fa09d23dd5b <dict_dealloc>
#15 0x00007fa09d306b45 in _PyImport_Fini () at Python/import.c:244
No locals.
#16 0x00007fa09d31ab86 in Py_Finalize () at Python/pythonrun.c:470
        interp = 0x602010
        tstate = 0x6020a0
#17 0x00007fa09d33776b in Py_Main (argc=3, argv=0x7fff6ce1ad68) at Modules/main.c:664
        c = -1
        sts = 0
        command = 0x0
        filename = 0x7fff6ce1b856 "/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/sage-ipython"
        module = 0x0
        fp = 0x684a90
        p = 0x0
        unbuffered = 0
        skipfirstline = 0
        stdin_is_interactive = 1
        help = 0
        version = 0
        saw_unbuffered_flag = 0
        cf = {cf_flags = 0}
#18 0x00000000004007b4 in main (argc=3, argv=0x7fff6ce1ad68) at ./Modules/python.c:23
No locals.


Cython backtrace (newest frame = last)
--------------------------------------
#0  0x0000000000400794 in main()
#1  0x00007fa09d3368aa in Py_Main()
#2  0x00007fa09d31ab2e in Py_Finalize()
#3  0x00007fa09d306ac5 in _PyImport_Fini()
#4  0x00007fa09d24cbaf in _Py_Dealloc()
#5  0x00007fa09d23dd5b in dict_dealloc()
#6  0x00007fa09d24cbaf in _Py_Dealloc()
#7  0x00007fa09d23dd5b in dict_dealloc()
#8  0x00007fa09d24cbaf in _Py_Dealloc()
#9  0x00007fa08a30d1c4 in fast_tp_dealloc() at /home/simon/SAGE/debug/sage-5.7.beta2/devel/sage-main/sage/rings/integer.pyx:6053
  6048    
  6049        # Free the object. This assumes that Py_TPFLAGS_HAVE_GC is not
  6050        # set. If it was set another free function would need to be
  6051        # called.
  6052    
> 6053        PyObject_FREE(o)
  6054    
  6055    
  6056    hook_fast_tp_functions()
  6057    from sage.misc.allocator cimport hook_tp_functions
#10 0x00007fa09d24e76d in _PyObject_DebugFree()
#11 0x00007fa09d24e8a8 in _PyObject_DebugFreeApi()
#12 0x00007fa09d24eb0a in _PyObject_DebugCheckAddressApi()
#13 0x00007fa09d24ec2c in _PyObject_DebugDumpAddress()
#14 0x00007fa09d617a10 in __restore_rt()
#15 0x00007fa099a7194a in sage_signal_handler()
#16 0x00007fa099a72252 in sigdie()
#17 0x00007fa099a7212b in print_enhanced_backtrace()
#18 0x00007fa09cf83860 in waitpid()


Saved trace to /home/simon/.sage/crash_logs/sage_crash_WekcH8.log
------------------------------------------------------------------------
Unhandled SIGSEGV: A segmentation fault occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off(). You might
want to run Sage under gdb with 'sage -gdb' to debug this.
Sage will now terminate.
------------------------------------------------------------------------
../../sage: Zeile 135: 29767 Speicherzugriffsfehler  "$SAGE_ROOT/spkg/bin/sage" "$@"
```



---

archive/issue_comments_169441.json:
```json
{
    "body": "<a id='comment:2'>**Comment 2:**</a>\nI can indeed repodruce the problem.",
    "created_at": "2013-02-05T11:04:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169441",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:2'>**Comment 2:**</a>
I can indeed repodruce the problem.



---

archive/issue_comments_169442.json:
```json
{
    "body": "<a id='comment:3'>**Comment 3:**</a>\nThe same with sage -gdb yields\n\n```\nsage: \nExiting Sage (CPU time 0m2.67s, Wall time 0m27.17s).\n[Thread 0x7fffef932700 (LWP 29861) exited]\nDebug memory block at address p=0x1c817e0: API '\ufffd'\n    18302628885633695743 bytes originally requested\n    The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):\n        at p-7: 0xcb *** OUCH\n        at p-6: 0xcb *** OUCH\n        at p-5: 0xcb *** OUCH\n        at p-4: 0xcb *** OUCH\n        at p-3: 0xcb *** OUCH\n        at p-2: 0xcb *** OUCH\n        at p-1: 0xcb *** OUCH\n    Because memory is corrupted at the start, the count of bytes requested\n       may be bogus, and checking the trailing pad bytes may segfault.\n    The 8 pad bytes at tail=0xfe00000001c817df are \nProgram received signal SIGSEGV, Segmentation fault.\n0x00007ffff7a29ebe in _PyObject_DebugDumpAddress (p=0x1c817e0) at Objects/obmalloc.c:1649\n1649    Objects/obmalloc.c: Datei oder Verzeichnis nicht gefunden.\n(gdb) bt\n#0  0x00007ffff7a29ebe in _PyObject_DebugDumpAddress (p=0x1c817e0) at Objects/obmalloc.c:1649\n#1  0x00007ffff7a29c1e in _PyObject_DebugCheckAddressApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1590\n#2  0x00007ffff7a298de in _PyObject_DebugFreeApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1478\n#3  0x00007ffff7a2978a in _PyObject_DebugFree (p=0x1c817e0) at Objects/obmalloc.c:1422\n#4  0x00007fffe4a40292 in __pyx_f_4sage_5rings_7integer_fast_tp_dealloc (__pyx_v_o=<sage.rings.integer.Integer at remote 0x1c817e0>) at sage/rings/integer.c:35775\n#5  0x00007ffff7a27be4 in _Py_Dealloc (op=<sage.rings.integer.Integer at remote 0x1c817e0>) at Objects/object.c:2243\n#6  0x00007ffff7a18e8e in dict_dealloc (mp=\n    {'gmp_randrange': <built-in method gmp_randrange of builtin_function_or_method object at remote 0x239aba0>, 'LCM_list': <built-in method LCM_list of builtin_function_or_method object at remote 0x1b23c18>, '_test_mpz_set_longlong': <built-in method _test_mpz_set_longlong of builtin_function_or_method object at remote 0x1b16d08>, 'initialized': False, 'operator': <module at remote 0x8a7f68>, 'make_integer': <built-in method make_integer of builtin_function_or_method object at remote 0x1c8b588>, '__package__': <unknown at remote 0x1b1cdc0>, 'IntegerWrapper': <type sage.rings.integer.IntegerWrapper at remote 0x7fffe4c74d20>, 'CoercionException': <type CoercionException at remote 0x16d53e0>, 'ONE': <sage.rings.integer.Integer at remote 0x1c817e0>, 'clear_mpz_globals': <built-in function clear_mpz_globals>, '__pyx_capi__': {'smallInteger': <PyCapsule at remote 0x1a2bac0>}, 'integer_ring': <module at remote 0x1b30e30>, 'Integer': <type sage.rings.integer.Integer at remote 0x7fffe4c74980>, '__doc__': \"File: sage/ring...(truncated)) at Objects/dictobject.c:985\n#7  0x00007ffff7a27be4 in _Py_Dealloc (op=\n    {'gmp_randrange': <built-in method gmp_randrange of builtin_function_or_method object at remote 0x239aba0>, 'LCM_list': <built-in method LCM_list of builtin_function_or_method object at remote 0x1b23c18>, '_test_mpz_set_longlong': <built-in method _test_mpz_set_longlong of builtin_function_or_method object at remote 0x1b16d08>, 'initialized': False, 'operator': <module at remote 0x8a7f68>, 'make_integer': <built-in method make_integer of builtin_function_or_method object at remote 0x1c8b588>, '__package__': <unknown at remote 0x1b1cdc0>, 'IntegerWrapper': <type sage.rings.integer.IntegerWrapper at remote 0x7fffe4c74d20>, 'CoercionException': <type CoercionException at remote 0x16d53e0>, 'ONE': <sage.rings.integer.Integer at remote 0x1c817e0>, 'clear_mpz_globals': <built-in function clear_mpz_globals>, '__pyx_capi__': {'smallInteger': <PyCapsule at remote 0x1a2bac0>}, 'integer_ring': <module at remote 0x1b30e30>, 'Integer': <type sage.rings.integer.Integer at remote 0x7fffe4c74980>, '__doc__': \"File: sage/ring...(truncated)) at Objects/object.c:2243\n#8  0x00007ffff7a18e8e in dict_dealloc (mp=\n    {<unknown at remote 0x23365b8>: <unknown at remote 0x237d650>, <unknown at remote 0x26c1428>: <unknown at remote 0x26903a0>, <unknown at remote 0x290b100>: <unknown at remote 0x293db00>, <unknown at remote 0x17865c0>: <unknown at remote 0x17b9b70>, <unknown at remote 0x2b92640>: <unknown at remote 0x2caa5e0>, <unknown at remote 0x2413100>: <unknown at remote 0x2407470>, <unknown at remote 0x2a67a50>: <unknown at remote 0x2a28140>, <unknown at remote 0x5d5eeb0>: <unknown at remote 0x5d9f410>, <unknown at remote 0x13a78c8>: <unknown at remote 0x13ee740>, <unknown at remote 0x2e0e880>: <unknown at remote 0x2e22b60>, <unknown at remote 0x24b2998>: <unknown at remote 0x2508e50>, <unknown at remote 0x2a67bc0>: <unknown at remote 0x2a2b0c0>, <unknown at remote 0x2b924c0>: <unknown at remote 0x2aec980>, <unknown at remote 0x3579040>: <unknown at remote 0x3522620>, 'gc': <unknown at remote 0x98eba0>, <unknown at remote 0x2b21998>: <unknown at remote 0x2ab35e0>, <unknown at remote 0x19483d8>: <unknown at remote 0x197fd...(truncated)) at Objects/dictobject.c:985\n#9  0x00007ffff7a27be4 in _Py_Dealloc (op=\n    {<unknown at remote 0x23365b8>: <unknown at remote 0x237d650>, <unknown at remote 0x26c1428>: <unknown at remote 0x26903a0>, <unknown at remote 0x290b100>: <unknown at remote 0x293db00>, <unknown at remote 0x17865c0>: <unknown at remote 0x17b9b70>, <unknown at remote 0x2b92640>: <unknown at remote 0x2caa5e0>, <unknown at remote 0x2413100>: <unknown at remote 0x2407470>, <unknown at remote 0x2a67a50>: <unknown at remote 0x2a28140>, <unknown at remote 0x5d5eeb0>: <unknown at remote 0x5d9f410>, <unknown at remote 0x13a78c8>: <unknown at remote 0x13ee740>, <unknown at remote 0x2e0e880>: <unknown at remote 0x2e22b60>, <unknown at remote 0x24b2998>: <unknown at remote 0x2508e50>, <unknown at remote 0x2a67bc0>: <unknown at remote 0x2a2b0c0>, <unknown at remote 0x2b924c0>: <unknown at remote 0x2aec980>, <unknown at remote 0x3579040>: <unknown at remote 0x3522620>, 'gc': <unknown at remote 0x98eba0>, <unknown at remote 0x2b21998>: <unknown at remote 0x2ab35e0>, <unknown at remote 0x19483d8>: <unknown at remote 0x197fd...(truncated)) at Objects/object.c:2243\n#10 0x00007ffff7ae1b45 in _PyImport_Fini () at Python/import.c:244\n#11 0x00007ffff7af5b86 in Py_Finalize () at Python/pythonrun.c:470\n#12 0x00007ffff7b1276b in Py_Main (argc=3, argv=0x7fffffffd168) at Modules/main.c:664\n#13 0x00000000004007b4 in main (argc=3, argv=0x7fffffffd168) at ./Modules/python.c:23\n(gdb) q\n```",
    "created_at": "2013-02-05T11:06:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169442",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:3'>**Comment 3:**</a>
The same with sage -gdb yields

```
sage: 
Exiting Sage (CPU time 0m2.67s, Wall time 0m27.17s).
[Thread 0x7fffef932700 (LWP 29861) exited]
Debug memory block at address p=0x1c817e0: API '�'
    18302628885633695743 bytes originally requested
    The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):
        at p-7: 0xcb *** OUCH
        at p-6: 0xcb *** OUCH
        at p-5: 0xcb *** OUCH
        at p-4: 0xcb *** OUCH
        at p-3: 0xcb *** OUCH
        at p-2: 0xcb *** OUCH
        at p-1: 0xcb *** OUCH
    Because memory is corrupted at the start, the count of bytes requested
       may be bogus, and checking the trailing pad bytes may segfault.
    The 8 pad bytes at tail=0xfe00000001c817df are 
Program received signal SIGSEGV, Segmentation fault.
0x00007ffff7a29ebe in _PyObject_DebugDumpAddress (p=0x1c817e0) at Objects/obmalloc.c:1649
1649    Objects/obmalloc.c: Datei oder Verzeichnis nicht gefunden.
(gdb) bt
#0  0x00007ffff7a29ebe in _PyObject_DebugDumpAddress (p=0x1c817e0) at Objects/obmalloc.c:1649
#1  0x00007ffff7a29c1e in _PyObject_DebugCheckAddressApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1590
#2  0x00007ffff7a298de in _PyObject_DebugFreeApi (api=111 'o', p=0x1c817e0) at Objects/obmalloc.c:1478
#3  0x00007ffff7a2978a in _PyObject_DebugFree (p=0x1c817e0) at Objects/obmalloc.c:1422
#4  0x00007fffe4a40292 in __pyx_f_4sage_5rings_7integer_fast_tp_dealloc (__pyx_v_o=<sage.rings.integer.Integer at remote 0x1c817e0>) at sage/rings/integer.c:35775
#5  0x00007ffff7a27be4 in _Py_Dealloc (op=<sage.rings.integer.Integer at remote 0x1c817e0>) at Objects/object.c:2243
#6  0x00007ffff7a18e8e in dict_dealloc (mp=
    {'gmp_randrange': <built-in method gmp_randrange of builtin_function_or_method object at remote 0x239aba0>, 'LCM_list': <built-in method LCM_list of builtin_function_or_method object at remote 0x1b23c18>, '_test_mpz_set_longlong': <built-in method _test_mpz_set_longlong of builtin_function_or_method object at remote 0x1b16d08>, 'initialized': False, 'operator': <module at remote 0x8a7f68>, 'make_integer': <built-in method make_integer of builtin_function_or_method object at remote 0x1c8b588>, '__package__': <unknown at remote 0x1b1cdc0>, 'IntegerWrapper': <type sage.rings.integer.IntegerWrapper at remote 0x7fffe4c74d20>, 'CoercionException': <type CoercionException at remote 0x16d53e0>, 'ONE': <sage.rings.integer.Integer at remote 0x1c817e0>, 'clear_mpz_globals': <built-in function clear_mpz_globals>, '__pyx_capi__': {'smallInteger': <PyCapsule at remote 0x1a2bac0>}, 'integer_ring': <module at remote 0x1b30e30>, 'Integer': <type sage.rings.integer.Integer at remote 0x7fffe4c74980>, '__doc__': "File: sage/ring...(truncated)) at Objects/dictobject.c:985
#7  0x00007ffff7a27be4 in _Py_Dealloc (op=
    {'gmp_randrange': <built-in method gmp_randrange of builtin_function_or_method object at remote 0x239aba0>, 'LCM_list': <built-in method LCM_list of builtin_function_or_method object at remote 0x1b23c18>, '_test_mpz_set_longlong': <built-in method _test_mpz_set_longlong of builtin_function_or_method object at remote 0x1b16d08>, 'initialized': False, 'operator': <module at remote 0x8a7f68>, 'make_integer': <built-in method make_integer of builtin_function_or_method object at remote 0x1c8b588>, '__package__': <unknown at remote 0x1b1cdc0>, 'IntegerWrapper': <type sage.rings.integer.IntegerWrapper at remote 0x7fffe4c74d20>, 'CoercionException': <type CoercionException at remote 0x16d53e0>, 'ONE': <sage.rings.integer.Integer at remote 0x1c817e0>, 'clear_mpz_globals': <built-in function clear_mpz_globals>, '__pyx_capi__': {'smallInteger': <PyCapsule at remote 0x1a2bac0>}, 'integer_ring': <module at remote 0x1b30e30>, 'Integer': <type sage.rings.integer.Integer at remote 0x7fffe4c74980>, '__doc__': "File: sage/ring...(truncated)) at Objects/object.c:2243
#8  0x00007ffff7a18e8e in dict_dealloc (mp=
    {<unknown at remote 0x23365b8>: <unknown at remote 0x237d650>, <unknown at remote 0x26c1428>: <unknown at remote 0x26903a0>, <unknown at remote 0x290b100>: <unknown at remote 0x293db00>, <unknown at remote 0x17865c0>: <unknown at remote 0x17b9b70>, <unknown at remote 0x2b92640>: <unknown at remote 0x2caa5e0>, <unknown at remote 0x2413100>: <unknown at remote 0x2407470>, <unknown at remote 0x2a67a50>: <unknown at remote 0x2a28140>, <unknown at remote 0x5d5eeb0>: <unknown at remote 0x5d9f410>, <unknown at remote 0x13a78c8>: <unknown at remote 0x13ee740>, <unknown at remote 0x2e0e880>: <unknown at remote 0x2e22b60>, <unknown at remote 0x24b2998>: <unknown at remote 0x2508e50>, <unknown at remote 0x2a67bc0>: <unknown at remote 0x2a2b0c0>, <unknown at remote 0x2b924c0>: <unknown at remote 0x2aec980>, <unknown at remote 0x3579040>: <unknown at remote 0x3522620>, 'gc': <unknown at remote 0x98eba0>, <unknown at remote 0x2b21998>: <unknown at remote 0x2ab35e0>, <unknown at remote 0x19483d8>: <unknown at remote 0x197fd...(truncated)) at Objects/dictobject.c:985
#9  0x00007ffff7a27be4 in _Py_Dealloc (op=
    {<unknown at remote 0x23365b8>: <unknown at remote 0x237d650>, <unknown at remote 0x26c1428>: <unknown at remote 0x26903a0>, <unknown at remote 0x290b100>: <unknown at remote 0x293db00>, <unknown at remote 0x17865c0>: <unknown at remote 0x17b9b70>, <unknown at remote 0x2b92640>: <unknown at remote 0x2caa5e0>, <unknown at remote 0x2413100>: <unknown at remote 0x2407470>, <unknown at remote 0x2a67a50>: <unknown at remote 0x2a28140>, <unknown at remote 0x5d5eeb0>: <unknown at remote 0x5d9f410>, <unknown at remote 0x13a78c8>: <unknown at remote 0x13ee740>, <unknown at remote 0x2e0e880>: <unknown at remote 0x2e22b60>, <unknown at remote 0x24b2998>: <unknown at remote 0x2508e50>, <unknown at remote 0x2a67bc0>: <unknown at remote 0x2a2b0c0>, <unknown at remote 0x2b924c0>: <unknown at remote 0x2aec980>, <unknown at remote 0x3579040>: <unknown at remote 0x3522620>, 'gc': <unknown at remote 0x98eba0>, <unknown at remote 0x2b21998>: <unknown at remote 0x2ab35e0>, <unknown at remote 0x19483d8>: <unknown at remote 0x197fd...(truncated)) at Objects/object.c:2243
#10 0x00007ffff7ae1b45 in _PyImport_Fini () at Python/import.c:244
#11 0x00007ffff7af5b86 in Py_Finalize () at Python/pythonrun.c:470
#12 0x00007ffff7b1276b in Py_Main (argc=3, argv=0x7fffffffd168) at Modules/main.c:664
#13 0x00000000004007b4 in main (argc=3, argv=0x7fffffffd168) at ./Modules/python.c:23
(gdb) q
```



---

archive/issue_comments_169443.json:
```json
{
    "body": "<a id='comment:4'>**Comment 4:**</a>\nOne detail:\n\n```\nsage: quit\n'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'\n```\n\nI.e., quit does not work as normally. Is this due to the debug version? Or what is happening here?",
    "created_at": "2013-02-05T11:09:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169443",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'>**Comment 4:**</a>
One detail:

```
sage: quit
'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'
```

I.e., quit does not work as normally. Is this due to the debug version? Or what is happening here?



---

archive/issue_comments_169444.json:
```json
{
    "body": "<a id='comment:5'>**Comment 5:**</a>\nReplying to [@simon-king-jena](#comment%3A4):\n> One detail:\n> \n> ```\n> sage: quit\n> 'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'\n> ```\n> \n> I.e., quit does not work as normally. Is this due to the debug version? Or what is happening here?\n\nAt least, this is not due to Python being built with --pydebug as it happens on my 5.7.beta[1|2] with SAGE_DEBUG=yes but without the correct Python spkg.\nThis does not happen on 5.6 (with SAGE_DEBUG as well I think).\nMaybe an upgrade to ipython ?",
    "created_at": "2013-02-05T11:12:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169444",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:5'>**Comment 5:**</a>
Replying to [@simon-king-jena](#comment%3A4):
> One detail:
> 
> ```
> sage: quit
> 'Use Ctrl-D (i.e. EOF), %Exit, or %Quit to exit without confirmation.'
> ```
> 
> I.e., quit does not work as normally. Is this due to the debug version? Or what is happening here?

At least, this is not due to Python being built with --pydebug as it happens on my 5.7.beta[1|2] with SAGE_DEBUG=yes but without the correct Python spkg.
This does not happen on 5.6 (with SAGE_DEBUG as well I think).
Maybe an upgrade to ipython ?



---

archive/issue_comments_169445.json:
```json
{
    "body": "<a id='comment:6'>**Comment 6:**</a>\nWhat is the original purpose of fast_tp_dealloc? If I understand it correctly, if there is enough room left on the stack, then dead integers are put there (and I guess get freed in a whole bunch, which is cheaper than freeing them one by one), otherwise fast_tp_dealloc explicitly removes them.\n\nAnd I see that the Integer class has a `__dealloc__` method; but it seems that \n\n```\nhook_tp_functions(global_dummy_Integer, NULL, <newfunc>&fast_tp_new, NULL, &fast_tp_dealloc, False)\n```\nis then used to override the `__dealloc__`, or what?\n\nAnd concerning the global_dummy_Integer, I see the comment\n\n```\n# We use a global Integer element to steal all the references\n# from.  DO NOT INITIALIZE IT AGAIN and DO NOT REFERENCE IT!\ncdef Integer global_dummy_Integer\nglobal_dummy_Integer = Integer()\n```\n\nSounds like black magic to me. Robert, can you elaborate how it all works?",
    "created_at": "2013-02-05T12:03:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169445",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'>**Comment 6:**</a>
What is the original purpose of fast_tp_dealloc? If I understand it correctly, if there is enough room left on the stack, then dead integers are put there (and I guess get freed in a whole bunch, which is cheaper than freeing them one by one), otherwise fast_tp_dealloc explicitly removes them.

And I see that the Integer class has a `__dealloc__` method; but it seems that 

```
hook_tp_functions(global_dummy_Integer, NULL, <newfunc>&fast_tp_new, NULL, &fast_tp_dealloc, False)
```
is then used to override the `__dealloc__`, or what?

And concerning the global_dummy_Integer, I see the comment

```
# We use a global Integer element to steal all the references
# from.  DO NOT INITIALIZE IT AGAIN and DO NOT REFERENCE IT!
cdef Integer global_dummy_Integer
global_dummy_Integer = Integer()
```

Sounds like black magic to me. Robert, can you elaborate how it all works?



---

archive/issue_comments_169446.json:
```json
{
    "body": "<a id='comment:7'>**Comment 7:**</a>\n\n```\n> grep global_dummy_Integer -R sage | grep REF\nsage/rings/integer.c:  if_Py_TRACE_REFS_then_PyObject_INIT(__pyx_v_new, ((PyObject *)__pyx_v_4sage_5rings_7integer_global_dummy_Integer)->ob_type);\nsage/rings/integer.c:  __pyx_v_4sage_5rings_7integer_global_dummy_Integer = ((struct __pyx_obj_4sage_5rings_7integer_Integer *)Py_None); Py_INCREF(Py_None);\nsage/rings/integer.c:  __Pyx_XGOTREF(((PyObject *)__pyx_v_4sage_5rings_7integer_global_dummy_Integer));\nsage/rings/integer.c:  __Pyx_DECREF(((PyObject *)__pyx_v_4sage_5rings_7integer_global_dummy_Integer));\n```\n\nI am not expert enough to see whether the lines above gives rise to a wrong reference count.",
    "created_at": "2013-02-05T12:08:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169446",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:7'>**Comment 7:**</a>

```
> grep global_dummy_Integer -R sage | grep REF
sage/rings/integer.c:  if_Py_TRACE_REFS_then_PyObject_INIT(__pyx_v_new, ((PyObject *)__pyx_v_4sage_5rings_7integer_global_dummy_Integer)->ob_type);
sage/rings/integer.c:  __pyx_v_4sage_5rings_7integer_global_dummy_Integer = ((struct __pyx_obj_4sage_5rings_7integer_Integer *)Py_None); Py_INCREF(Py_None);
sage/rings/integer.c:  __Pyx_XGOTREF(((PyObject *)__pyx_v_4sage_5rings_7integer_global_dummy_Integer));
sage/rings/integer.c:  __Pyx_DECREF(((PyObject *)__pyx_v_4sage_5rings_7integer_global_dummy_Integer));
```

I am not expert enough to see whether the lines above gives rise to a wrong reference count.



---

archive/issue_comments_169447.json:
```json
{
    "body": "<a id='comment:8'>**Comment 8:**</a>\nInteresting. When I add a print statement to the beginning of fast_tp_new and fast_tp_dealloc then the crash vanishes.",
    "created_at": "2013-02-05T12:31:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169447",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'>**Comment 8:**</a>
Interesting. When I add a print statement to the beginning of fast_tp_new and fast_tp_dealloc then the crash vanishes.



---

archive/issue_comments_169448.json:
```json
{
    "body": "<a id='comment:9'>**Comment 9:**</a>\nThe Integer's `__cinit__` method gets called 7 times at startup -- even though it appears to get overriden by the hook_tp_functions line. When one creates an integer *after* startup, then only fast_tp_new is called, but not `__cinit__`. And `__dealloc__` never gets called.",
    "created_at": "2013-02-05T12:36:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169448",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'>**Comment 9:**</a>
The Integer's `__cinit__` method gets called 7 times at startup -- even though it appears to get overriden by the hook_tp_functions line. When one creates an integer *after* startup, then only fast_tp_new is called, but not `__cinit__`. And `__dealloc__` never gets called.



---

archive/issue_comments_169449.json:
```json
{
    "body": "<a id='comment:10'>**Comment 10:**</a>\nI wonder about this message when Sage crashes:\n\n```\n    The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):\n        at p-7: 0xcb *** OUCH\n        at p-6: 0xcb *** OUCH\n        at p-5: 0xcb *** OUCH\n        at p-4: 0xcb *** OUCH\n        at p-3: 0xcb *** OUCH\n        at p-2: 0xcb *** OUCH\n        at p-1: 0xcb *** OUCH\n```\nCould it be that fast_tp_new writes to the wrong location when it does\n\n```\n        (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)\n```\n?",
    "created_at": "2013-02-05T12:47:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169449",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:10'>**Comment 10:**</a>
I wonder about this message when Sage crashes:

```
    The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):
        at p-7: 0xcb *** OUCH
        at p-6: 0xcb *** OUCH
        at p-5: 0xcb *** OUCH
        at p-4: 0xcb *** OUCH
        at p-3: 0xcb *** OUCH
        at p-2: 0xcb *** OUCH
        at p-1: 0xcb *** OUCH
```
Could it be that fast_tp_new writes to the wrong location when it does

```
        (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)
```
?



---

archive/issue_comments_169450.json:
```json
{
    "body": "<a id='comment:11'>**Comment 11:**</a>\nAt least for educational purposes, the following comments have to change:\n\n```\n        # We take the address 'new' and move mpz_t_offset bytes (chars)\n        # to the address of 'value'. We treat that address as a pointer\n        # to a mpz_t struct and allocate memory for the _mp_d element of\n        # that struct. We allocate one limb.\n        #\n        # What is done here is potentially very dangerous as it reaches\n        # deeply into the internal structure of GMP. Consequently things\n        # may break if a new release of GMP changes some internals. To\n        # emphasize this, this is what the GMP manual has to say about\n        # the documentation for the struct we are using:\n        #\n        #  \"This chapter is provided only for informational purposes and the\n        #  various internals described here may change in future GMP releases.\n        #  Applications expecting to be compatible with future releases should use\n        #  only the documented interfaces described in previous chapters.\"\n        #\n        # If this line is used Sage is not such an application.\n        #\n        # The clean version of the following line is:\n        #\n        # mpz_init( <mpz_t>(<char *>new + mpz_t_offset) )\n        #\n        # We save time both by avoiding an extra function call and\n        # because the rest of the mpz struct was already initialized\n        # fully using the memcpy above.\n\n        (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)\n```\nNamely, when I uncomment `mpz_init( <mpz_t>(<char *>new + mpz_t_offset) )` and comment the last line, then the module won't build:\n\n```\nsage/rings/integer.c: In function \u2018__pyx_f_4sage_5rings_7integer_fast_tp_new\u2019:\nsage/rings/integer.c:35637:18: error: cast specifies array type\nerror: command 'gcc' failed with exit status 1\nError installing modified sage library code.\n```\n\nSo, the \"clean version\" doesn't even build.",
    "created_at": "2013-02-05T12:53:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169450",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:11'>**Comment 11:**</a>
At least for educational purposes, the following comments have to change:

```
        # We take the address 'new' and move mpz_t_offset bytes (chars)
        # to the address of 'value'. We treat that address as a pointer
        # to a mpz_t struct and allocate memory for the _mp_d element of
        # that struct. We allocate one limb.
        #
        # What is done here is potentially very dangerous as it reaches
        # deeply into the internal structure of GMP. Consequently things
        # may break if a new release of GMP changes some internals. To
        # emphasize this, this is what the GMP manual has to say about
        # the documentation for the struct we are using:
        #
        #  "This chapter is provided only for informational purposes and the
        #  various internals described here may change in future GMP releases.
        #  Applications expecting to be compatible with future releases should use
        #  only the documented interfaces described in previous chapters."
        #
        # If this line is used Sage is not such an application.
        #
        # The clean version of the following line is:
        #
        # mpz_init( <mpz_t>(<char *>new + mpz_t_offset) )
        #
        # We save time both by avoiding an extra function call and
        # because the rest of the mpz struct was already initialized
        # fully using the memcpy above.

        (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)
```
Namely, when I uncomment `mpz_init( <mpz_t>(<char *>new + mpz_t_offset) )` and comment the last line, then the module won't build:

```
sage/rings/integer.c: In function ‘__pyx_f_4sage_5rings_7integer_fast_tp_new’:
sage/rings/integer.c:35637:18: error: cast specifies array type
error: command 'gcc' failed with exit status 1
Error installing modified sage library code.
```

So, the "clean version" doesn't even build.



---

archive/issue_comments_169451.json:
```json
{
    "body": "<a id='comment:12'>**Comment 12:**</a>\nI think the point of this black magic is to keep a pool of pointers to Sage integers rather than allocating/freeing one each time a new one is needed/deleted.\n\nSo when you want a new integer and there are preallocated ones left you just grab one and when you want to delete one, and there is room left in the pool, you put it back there.\n\nFLINT more or less uses a similar strategy (in single threaded mode).\n\nThe commented out line makes sense, inside the memory allocated for a Sage integer, we move to the address reserved for the mpz structure and initialize it, I guess its just illegal to cast to mpz_t type which is a typedef for an array of mpz of size one, something like mpz* should be used.\n\nNot quite sure what the global dummy integer is used for, obviously for dark magic refcounting, but still unclear to me.\n\nThe point of the global dummy integer is to fool.",
    "created_at": "2013-02-05T13:52:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169451",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:12'>**Comment 12:**</a>
I think the point of this black magic is to keep a pool of pointers to Sage integers rather than allocating/freeing one each time a new one is needed/deleted.

So when you want a new integer and there are preallocated ones left you just grab one and when you want to delete one, and there is room left in the pool, you put it back there.

FLINT more or less uses a similar strategy (in single threaded mode).

The commented out line makes sense, inside the memory allocated for a Sage integer, we move to the address reserved for the mpz structure and initialize it, I guess its just illegal to cast to mpz_t type which is a typedef for an array of mpz of size one, something like mpz* should be used.

Not quite sure what the global dummy integer is used for, obviously for dark magic refcounting, but still unclear to me.

The point of the global dummy integer is to fool.



---

archive/issue_comments_169452.json:
```json
{
    "body": "<a id='comment:13'>**Comment 13:**</a>\nReplying to [@simon-king-jena](#comment%3A10):\n> I wonder about this message when Sage crashes:\n> \n> ```\n>     The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):\n>         at p-7: 0xcb *** OUCH\n>         at p-6: 0xcb *** OUCH\n>         at p-5: 0xcb *** OUCH\n>         at p-4: 0xcb *** OUCH\n>         at p-3: 0xcb *** OUCH\n>         at p-2: 0xcb *** OUCH\n>         at p-1: 0xcb *** OUCH\n> ```\n> Could it be that fast_tp_new writes to the wrong location when it does\n> \n> ```\n>         (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)\n> ```\n> ?\n\nThe size allocated looks fine, the address of the pointer as well.",
    "created_at": "2013-02-05T14:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169452",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:13'>**Comment 13:**</a>
Replying to [@simon-king-jena](#comment%3A10):
> I wonder about this message when Sage crashes:
> 
> ```
>     The 7 pad bytes at p-7 are not all FORBIDDENBYTE (0xfb):
>         at p-7: 0xcb *** OUCH
>         at p-6: 0xcb *** OUCH
>         at p-5: 0xcb *** OUCH
>         at p-4: 0xcb *** OUCH
>         at p-3: 0xcb *** OUCH
>         at p-2: 0xcb *** OUCH
>         at p-1: 0xcb *** OUCH
> ```
> Could it be that fast_tp_new writes to the wrong location when it does
> 
> ```
>         (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)
> ```
> ?

The size allocated looks fine, the address of the pointer as well.



---

archive/issue_comments_169453.json:
```json
{
    "body": "<a id='comment:15'>**Comment 15:**</a>\nReplying to [jpflori](#comment%3A12):\n> I think the point of this black magic is to keep a pool of pointers to Sage integers rather than allocating/freeing one each time a new one is needed/deleted.\n\nYep, I understood that much.\n\n> The commented out line makes sense, inside the memory allocated for a Sage integer, we move to the address reserved for the mpz structure and initialize it, I guess its just illegal to cast to mpz_t type which is a typedef for an array of mpz of size one, something like mpz* should be used.\n\nSo, you think one needs to write `mpz_init( <__mpz_struct*>(<char *>new + mpz_t_offset)`instead of `mpz_init( <mpz_t>(<char *>new + mpz_t_offset)`, and similar for deallocation?\n\nI tried\n\n```diff\ndiff --git a/sage/rings/integer.pyx b/sage/rings/integer.pyx\n--- a/sage/rings/integer.pyx\n+++ b/sage/rings/integer.pyx\n@@ -5989,13 +5989,13 @@\n         #\n         # The clean version of the following line is:\n         #\n-        #  mpz_init( <mpz_t>(<char *>new + mpz_t_offset) )\n+        mpz_init( <__mpz_struct*>(<char *>new + mpz_t_offset) )\n         #\n         # We save time both by avoiding an extra function call and\n         # because the rest of the mpz struct was already initialized\n         # fully using the memcpy above.\n \n-        (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)\n+        #(<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)\n \n     # This line is only needed if Python is compiled in debugging mode\n     # './configure --with-pydebug' or SAGE_DEBUG=yes. If that is the\n@@ -6042,9 +6042,9 @@\n \n     # Again, we move to the mpz_t and clear it. See above, why this is evil.\n     # The clean version of this line would be:\n-    #   mpz_clear(<mpz_t>(<char *>o + mpz_t_offset))\n-\n-    mpz_free((<__mpz_struct *>( <char *>o + mpz_t_offset) )._mp_d, 0)\n+    mpz_clear(<__mpz_struct *>(<char *>o + mpz_t_offset))\n+\n+    #mpz_free((<__mpz_struct *>( <char *>o + mpz_t_offset) )._mp_d, 0)\n \n     # Free the object. This assumes that Py_TPFLAGS_HAVE_GC is not\n     # set. If it was set another free function would need to be\n```\nbut it still segfaults at exit.",
    "created_at": "2013-02-05T15:58:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169453",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'>**Comment 15:**</a>
Replying to [jpflori](#comment%3A12):
> I think the point of this black magic is to keep a pool of pointers to Sage integers rather than allocating/freeing one each time a new one is needed/deleted.

Yep, I understood that much.

> The commented out line makes sense, inside the memory allocated for a Sage integer, we move to the address reserved for the mpz structure and initialize it, I guess its just illegal to cast to mpz_t type which is a typedef for an array of mpz of size one, something like mpz* should be used.

So, you think one needs to write `mpz_init( <__mpz_struct*>(<char *>new + mpz_t_offset)`instead of `mpz_init( <mpz_t>(<char *>new + mpz_t_offset)`, and similar for deallocation?

I tried

```diff
diff --git a/sage/rings/integer.pyx b/sage/rings/integer.pyx
--- a/sage/rings/integer.pyx
+++ b/sage/rings/integer.pyx
@@ -5989,13 +5989,13 @@
         #
         # The clean version of the following line is:
         #
-        #  mpz_init( <mpz_t>(<char *>new + mpz_t_offset) )
+        mpz_init( <__mpz_struct*>(<char *>new + mpz_t_offset) )
         #
         # We save time both by avoiding an extra function call and
         # because the rest of the mpz struct was already initialized
         # fully using the memcpy above.
 
-        (<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)
+        #(<__mpz_struct *>( <char *>new + mpz_t_offset) )._mp_d = <mp_ptr>mpz_alloc(GMP_LIMB_BITS >> 3)
 
     # This line is only needed if Python is compiled in debugging mode
     # './configure --with-pydebug' or SAGE_DEBUG=yes. If that is the
@@ -6042,9 +6042,9 @@
 
     # Again, we move to the mpz_t and clear it. See above, why this is evil.
     # The clean version of this line would be:
-    #   mpz_clear(<mpz_t>(<char *>o + mpz_t_offset))
-
-    mpz_free((<__mpz_struct *>( <char *>o + mpz_t_offset) )._mp_d, 0)
+    mpz_clear(<__mpz_struct *>(<char *>o + mpz_t_offset))
+
+    #mpz_free((<__mpz_struct *>( <char *>o + mpz_t_offset) )._mp_d, 0)
 
     # Free the object. This assumes that Py_TPFLAGS_HAVE_GC is not
     # set. If it was set another free function would need to be
```
but it still segfaults at exit.



---

archive/issue_comments_169454.json:
```json
{
    "body": "<a id='comment:16'>**Comment 16:**</a>\nI did not say it could solve the segfault :)\nIn fact it should do basically the same thing as before, but using the proper functions.",
    "created_at": "2013-02-05T16:09:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169454",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:16'>**Comment 16:**</a>
I did not say it could solve the segfault :)
In fact it should do basically the same thing as before, but using the proper functions.



---

archive/issue_comments_169455.json:
```json
{
    "body": "<a id='comment:17'>**Comment 17:**</a>\nThe problem occurs when deallocating ONE, which is allocated before the hooks are setup, with the hooked method.\n\nCreating ONE after hooking up the method (seemingly) solves the problem.",
    "created_at": "2013-02-05T16:17:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169455",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:17'>**Comment 17:**</a>
The problem occurs when deallocating ONE, which is allocated before the hooks are setup, with the hooked method.

Creating ONE after hooking up the method (seemingly) solves the problem.



---

archive/issue_comments_169456.json:
```json
{
    "body": "<a id='comment:18'>**Comment 18:**</a>\nReplying to [jpflori](#comment%3A17):\n> The problem occurs when deallocating ONE, which is allocated before the hooks are setup, with the hooked method.\n\nOK. But ONE is not the only integer that gets created before setting the hook.\n\nThe created integers are:\n\n* 0\n* 1\n* ONE (hence, the integer 1 is created, and then another 1 is created and assigned to ONE)\n* -1\n* 0\n* 1\n* `global_dummy_Integer` (which is 0)\n\nAnd them the hooks are established.\n \n> Creating ONE after hooking up the method (seemingly) solves the problem.\n\nBut probably we should take care of the other elements as well.\n\nBy the way: There is another way to make the segfault vanish. We could simply insert print statements, that print the memory addresses of the integers when they are created/deleted/taken from the pool/put into the pool. It works (but don't take it as a serious suggestion...)!\n\nSo, how did you find out that ONE is deallocated with the hooked method?",
    "created_at": "2013-02-05T16:28:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169456",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:18'>**Comment 18:**</a>
Replying to [jpflori](#comment%3A17):
> The problem occurs when deallocating ONE, which is allocated before the hooks are setup, with the hooked method.

OK. But ONE is not the only integer that gets created before setting the hook.

The created integers are:

* 0
* 1
* ONE (hence, the integer 1 is created, and then another 1 is created and assigned to ONE)
* -1
* 0
* 1
* `global_dummy_Integer` (which is 0)

And them the hooks are established.
 
> Creating ONE after hooking up the method (seemingly) solves the problem.

But probably we should take care of the other elements as well.

By the way: There is another way to make the segfault vanish. We could simply insert print statements, that print the memory addresses of the integers when they are created/deleted/taken from the pool/put into the pool. It works (but don't take it as a serious suggestion...)!

So, how did you find out that ONE is deallocated with the hooked method?



---

archive/issue_comments_169457.json:
```json
{
    "body": "<a id='comment:19'>**Comment 19:**</a>\nHummm, I don't see the Py_INCREF(ONE) you mention in the ticket description in my 5.7.beta1 and 5.7.beta2 install (it is in my 5.6 install).",
    "created_at": "2013-02-05T16:29:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169457",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:19'>**Comment 19:**</a>
Hummm, I don't see the Py_INCREF(ONE) you mention in the ticket description in my 5.7.beta1 and 5.7.beta2 install (it is in my 5.6 install).



---

archive/issue_comments_169458.json:
```json
{
    "body": "<a id='comment:20'>**Comment 20:**</a>\nThat's \"because\" of #12615.",
    "created_at": "2013-02-05T16:30:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169458",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:20'>**Comment 20:**</a>
That's "because" of #12615.



---

archive/issue_comments_169459.json:
```json
{
    "body": "<a id='comment:21'>**Comment 21:**</a>\nAnd it was indeed merged in 5.7.beta1.",
    "created_at": "2013-02-05T16:30:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169459",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:21'>**Comment 21:**</a>
And it was indeed merged in 5.7.beta1.



---

archive/issue_comments_169460.json:
```json
{
    "body": "<a id='comment:22'>**Comment 22:**</a>\nReplying to [@simon-king-jena](#comment%3A18):\n> Replying to [jpflori](#comment%3A17):\n> > The problem occurs when deallocating ONE, which is allocated before the hooks are setup, with the hooked method.\n\n> \n> OK. But ONE is not the only integer that gets created before setting the hook.\n\nI agree it is a problem.\n> \n> The created integers are:\n> \n> * 0\n> * 1\n> * ONE (hence, the integer 1 is created, and then another 1 is created and assigned to ONE)\n> * -1\n> * 0\n> * 1\n> * `global_dummy_Integer` (which is 0)\n> \n> And them the hooks are established.\n>  \n> > Creating ONE after hooking up the method (seemingly) solves the problem.\n\n> \n> But probably we should take care of the other elements as well.\n\nYup.\n> \n> By the way: There is another way to make the segfault vanish. We could simply insert print statements, that print the memory addresses of the integers when they are created/deleted/taken from the pool/put into the pool. It works (but don't take it as a serious suggestion...)!\n> \n> So, how did you find out that ONE is deallocated with the hooked method?\n\nLooking at the enhanced backtrace.\nA dict is deallocated and our tools are smart enough to print the name of the object in the dict with there address and one step further the fats_tp_dealloc method is called on the address corresponding to ONE.",
    "created_at": "2013-02-05T16:32:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169460",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:22'>**Comment 22:**</a>
Replying to [@simon-king-jena](#comment%3A18):
> Replying to [jpflori](#comment%3A17):
> > The problem occurs when deallocating ONE, which is allocated before the hooks are setup, with the hooked method.

> 
> OK. But ONE is not the only integer that gets created before setting the hook.

I agree it is a problem.
> 
> The created integers are:
> 
> * 0
> * 1
> * ONE (hence, the integer 1 is created, and then another 1 is created and assigned to ONE)
> * -1
> * 0
> * 1
> * `global_dummy_Integer` (which is 0)
> 
> And them the hooks are established.
>  
> > Creating ONE after hooking up the method (seemingly) solves the problem.

> 
> But probably we should take care of the other elements as well.

Yup.
> 
> By the way: There is another way to make the segfault vanish. We could simply insert print statements, that print the memory addresses of the integers when they are created/deleted/taken from the pool/put into the pool. It works (but don't take it as a serious suggestion...)!
> 
> So, how did you find out that ONE is deallocated with the hooked method?

Looking at the enhanced backtrace.
A dict is deallocated and our tools are smart enough to print the name of the object in the dict with there address and one step further the fats_tp_dealloc method is called on the address corresponding to ONE.



---

archive/issue_comments_169461.json:
```json
{
    "body": "<a id='comment:23'>**Comment 23:**</a>\nReplying to [jpflori](#comment%3A19):\n> Hummm, I don't see the Py_INCREF(ONE) you mention in the ticket description in my 5.7.beta1 and 5.7.beta2 install (it is in my 5.6 install).\n\nLine 3584 has `Py_INCREF(ONE)` (still in sage-5.7.beta2).\n\nBut it seems to be different from the incref introduced in #2435. The incref we currently find was hg commit number 4442 of David Roe, who doesn't mention a ticket number in the commit message.",
    "created_at": "2013-02-05T16:37:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169461",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:23'>**Comment 23:**</a>
Replying to [jpflori](#comment%3A19):
> Hummm, I don't see the Py_INCREF(ONE) you mention in the ticket description in my 5.7.beta1 and 5.7.beta2 install (it is in my 5.6 install).

Line 3584 has `Py_INCREF(ONE)` (still in sage-5.7.beta2).

But it seems to be different from the incref introduced in #2435. The incref we currently find was hg commit number 4442 of David Roe, who doesn't mention a ticket number in the commit message.



---

archive/issue_comments_169462.json:
```json
{
    "body": "<a id='comment:24'>**Comment 24:**</a>\nI'm speaking of line 5651 which was removed in #12615 and was the fix of #2435.",
    "created_at": "2013-02-05T16:41:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169462",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:24'>**Comment 24:**</a>
I'm speaking of line 5651 which was removed in #12615 and was the fix of #2435.



---

archive/issue_comments_169463.json:
```json
{
    "body": "<a id='comment:25'>**Comment 25:**</a>\nReplying to [jpflori](#comment%3A22):\n> > The created integers are:\n> > \n> > * 0\n> > * 1\n> > * ONE (hence, the integer 1 is created, and then another 1 is created and assigned to ONE)\n> > * -1\n> > * 0\n> > * 1\n> > * `global_dummy_Integer` (which is 0)\n> > \n> > And them the hooks are established.\n> >  \n> > > Creating ONE after hooking up the method (seemingly) solves the problem.\n\n> > \n> > But probably we should take care of the other elements as well.\n\n> Yup.\n\nIt is obvious where the integers between ONE and `global_dummy_Integer` come from:\n\n```\nONE = Integer(1)\ncdef long small_pool_min = -1\ncdef long small_pool_max = 1\ncdef list small_pool = [Integer(k) for k in range(small_pool_min, small_pool_max+1)]\ncdef inline Integer smallInteger(long value):\n    cdef Integer z\n    if small_pool_min <= value <= small_pool_max:\n        return <Integer>small_pool[value - small_pool_min]\n    else:\n        z = PY_NEW(Integer)\n        mpz_set_si(z.value, value)\n        return z\n```\nBefore ONE, the function `zero_one_elements()` creates 0 and 1.\n\nSo, our current guess is that we should move the creation of the dummy and the hooking to the very beginning of the module, right?",
    "created_at": "2013-02-05T16:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169463",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:25'>**Comment 25:**</a>
Replying to [jpflori](#comment%3A22):
> > The created integers are:
> > 
> > * 0
> > * 1
> > * ONE (hence, the integer 1 is created, and then another 1 is created and assigned to ONE)
> > * -1
> > * 0
> > * 1
> > * `global_dummy_Integer` (which is 0)
> > 
> > And them the hooks are established.
> >  
> > > Creating ONE after hooking up the method (seemingly) solves the problem.

> > 
> > But probably we should take care of the other elements as well.

> Yup.

It is obvious where the integers between ONE and `global_dummy_Integer` come from:

```
ONE = Integer(1)
cdef long small_pool_min = -1
cdef long small_pool_max = 1
cdef list small_pool = [Integer(k) for k in range(small_pool_min, small_pool_max+1)]
cdef inline Integer smallInteger(long value):
    cdef Integer z
    if small_pool_min <= value <= small_pool_max:
        return <Integer>small_pool[value - small_pool_min]
    else:
        z = PY_NEW(Integer)
        mpz_set_si(z.value, value)
        return z
```
Before ONE, the function `zero_one_elements()` creates 0 and 1.

So, our current guess is that we should move the creation of the dummy and the hooking to the very beginning of the module, right?



---

archive/issue_comments_169464.json:
```json
{
    "body": "<a id='comment:26'>**Comment 26:**</a>\nWe should also get rid of ONE as we now have one.\n\nAnd I'm not sure what the remaining Py_INCREF really is for...\nDoes not the assignment automatically increase the refcount?",
    "created_at": "2013-02-05T16:48:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169464",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:26'>**Comment 26:**</a>
We should also get rid of ONE as we now have one.

And I'm not sure what the remaining Py_INCREF really is for...
Does not the assignment automatically increase the refcount?



---

archive/issue_comments_169465.json:
```json
{
    "body": "<a id='comment:27'>**Comment 27:**</a>\nDon't really now why, but the other integers are cdef'ed which I guess is why they don't cause trouble.\nSee https://github.com/sagemath/sage/issues/2435#comment:4",
    "created_at": "2013-02-05T16:52:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169465",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:27'>**Comment 27:**</a>
Don't really now why, but the other integers are cdef'ed which I guess is why they don't cause trouble.
See https://github.com/sagemath/sage/issues/2435#comment:4



---

archive/issue_comments_169466.json:
```json
{
    "body": "<a id='comment:28'>**Comment 28:**</a>\nReplying to [jpflori](#comment%3A26):\n> We should also get rid of ONE as we now have one.\n\nWorth trying, anyway. We could define ONE=one.\n\n> And I'm not sure what the remaining Py_INCREF really is for...\n> Does not the assignment automatically increase the refcount?\n\nLooks mysterious. Perhaps it is explained in #2435 or #12615. Robert?",
    "created_at": "2013-02-05T16:53:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169466",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'>**Comment 28:**</a>
Replying to [jpflori](#comment%3A26):
> We should also get rid of ONE as we now have one.

Worth trying, anyway. We could define ONE=one.

> And I'm not sure what the remaining Py_INCREF really is for...
> Does not the assignment automatically increase the refcount?

Looks mysterious. Perhaps it is explained in #2435 or #12615. Robert?



---

archive/issue_comments_169467.json:
```json
{
    "body": "<a id='comment:29'>**Comment 29:**</a>\nReplying to [jpflori](#comment%3A27):\n> Don't really now why, but the other integers are cdef'ed which I guess is why they don't cause trouble.\n> See https://github.com/sagemath/sage/issues/2435#comment:4\n\n... which says: \"Any easy fix is to cdef it or incref it, but that isn't what the real problem is.\" Hence, the incref was a work-around, but no solution.",
    "created_at": "2013-02-05T16:54:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169467",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:29'>**Comment 29:**</a>
Replying to [jpflori](#comment%3A27):
> Don't really now why, but the other integers are cdef'ed which I guess is why they don't cause trouble.
> See https://github.com/sagemath/sage/issues/2435#comment:4

... which says: "Any easy fix is to cdef it or incref it, but that isn't what the real problem is." Hence, the incref was a work-around, but no solution.



---

archive/issue_comments_169468.json:
```json
{
    "body": "<a id='comment:30'>**Comment 30:**</a>\nAbout the other INCREF, unfortunately:\nhttps://github.com/sagemath/sage/issues/2435#comment:6",
    "created_at": "2013-02-05T16:56:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169468",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:30'>**Comment 30:**</a>
About the other INCREF, unfortunately:
https://github.com/sagemath/sage/issues/2435#comment:6



---

archive/issue_comments_169469.json:
```json
{
    "body": "<a id='comment:31'>**Comment 31:**</a>\nI think the removal of #12615 is a typo, it really makes no sense.",
    "created_at": "2013-02-05T16:59:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169469",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:31'>**Comment 31:**</a>
I think the removal of #12615 is a typo, it really makes no sense.



---

archive/issue_comments_169470.json:
```json
{
    "body": "<a id='comment:32'>**Comment 32:**</a>\nWith the patch, sage starts and quits without a crash. I don't know if it is ready for review, but you may have a look.",
    "created_at": "2013-02-05T17:05:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169470",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:32'>**Comment 32:**</a>
With the patch, sage starts and quits without a crash. I don't know if it is ready for review, but you may have a look.



---

archive/issue_comments_169471.json:
```json
{
    "body": "**Author:** Simon King",
    "created_at": "2013-02-05T17:05:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169471",
    "user": "https://github.com/simon-king-jena"
}
```

**Author:** Simon King



---

archive/issue_events_167550.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-05T17:05:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167550"
}
```



---

archive/issue_comments_169472.json:
```json
{
    "body": "<a id='comment:33'>**Comment 33:**</a>\nI don't really think your solution is right.\nAs I mentioned these small integers won't be deallocated anyway as they are cdefed, so we don't care.\n\nAnd I'm not really sure that doing anything after the global dummy is created rather than after the hook is in place (I'm aware of https://github.com/sagemath/sage/issues/2435#comment:10, but that might just be cosmic rays).\n\nFor further investigation, the Py_INCREF of the global dummy in sage/misc/allocator.pyx seems useless as well now as it is cdefed and won't be collected.",
    "created_at": "2013-02-05T17:10:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169472",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:33'>**Comment 33:**</a>
I don't really think your solution is right.
As I mentioned these small integers won't be deallocated anyway as they are cdefed, so we don't care.

And I'm not really sure that doing anything after the global dummy is created rather than after the hook is in place (I'm aware of https://github.com/sagemath/sage/issues/2435#comment:10, but that might just be cosmic rays).

For further investigation, the Py_INCREF of the global dummy in sage/misc/allocator.pyx seems useless as well now as it is cdefed and won't be collected.



---

archive/issue_comments_169473.json:
```json
{
    "body": "<a id='comment:34'>**Comment 34:**</a>\nAnyway, I think we should wait for Robert feedback.",
    "created_at": "2013-02-05T17:12:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169473",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:34'>**Comment 34:**</a>
Anyway, I think we should wait for Robert feedback.



---

archive/issue_comments_169474.json:
```json
{
    "body": "<a id='comment:35'>**Comment 35:**</a>\nMaybe we are just f***ing up with Python debug memory api.\n\nWhat Python rants about is that the first bytes before the actual object ONE, which should have been allocated in PyObject_DebugMallocAPI and set to FORBIDDENBYTE are in fact worth CLEANBYTE, which is what the debug memory api sets for the space reserved for the object itself...",
    "created_at": "2013-02-05T18:41:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169474",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:35'>**Comment 35:**</a>
Maybe we are just f***ing up with Python debug memory api.

What Python rants about is that the first bytes before the actual object ONE, which should have been allocated in PyObject_DebugMallocAPI and set to FORBIDDENBYTE are in fact worth CLEANBYTE, which is what the debug memory api sets for the space reserved for the object itself...



---

archive/issue_comments_169475.json:
```json
{
    "body": "<a id='comment:36'>**Comment 36:**</a>\nAny clue on how to speak with GDB before Sage is initialized?",
    "created_at": "2013-02-05T18:47:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169475",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:36'>**Comment 36:**</a>
Any clue on how to speak with GDB before Sage is initialized?



---

archive/issue_comments_169476.json:
```json
{
    "body": "<a id='comment:37'>**Comment 37:**</a>\nOr its Cython which is too hackish.\nWhen global_dummy_Integer is initialized, the preceding bytes are worth CLEANBYTE rather than FORBIDDENBYTE, so there is no chance deallocation will fail with a debug build.",
    "created_at": "2013-02-05T19:17:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169476",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:37'>**Comment 37:**</a>
Or its Cython which is too hackish.
When global_dummy_Integer is initialized, the preceding bytes are worth CLEANBYTE rather than FORBIDDENBYTE, so there is no chance deallocation will fail with a debug build.



---

archive/issue_comments_169477.json:
```json
{
    "body": "<a id='comment:38'>**Comment 38:**</a>\nReplying to [jpflori](#comment%3A33):\n> I don't really think your solution is right.\n> As I mentioned these small integers won't be deallocated anyway as they are cdefed, so we don't care.\n\nAnyway. I believe it should be cleaner to avoid integers being created in one way and then deleted in a different way.\n\n> And I'm not really sure that doing anything after the global dummy is created rather than after the hook is in place.\n\nI can't parse that phrase. Do you say: There should be no code whatsoever between the creation of the global dummy and the creation of the hook?\n\n> For further investigation, the Py_INCREF of the global dummy in sage/misc/allocator.pyx seems useless as well now as it is cdefed and won't be collected.\n\nI removed the Py_INCREF, and Sage starts and quits without problem. But would it hurt to have the incref?",
    "created_at": "2013-02-05T20:57:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169477",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:38'>**Comment 38:**</a>
Replying to [jpflori](#comment%3A33):
> I don't really think your solution is right.
> As I mentioned these small integers won't be deallocated anyway as they are cdefed, so we don't care.

Anyway. I believe it should be cleaner to avoid integers being created in one way and then deleted in a different way.

> And I'm not really sure that doing anything after the global dummy is created rather than after the hook is in place.

I can't parse that phrase. Do you say: There should be no code whatsoever between the creation of the global dummy and the creation of the hook?

> For further investigation, the Py_INCREF of the global dummy in sage/misc/allocator.pyx seems useless as well now as it is cdefed and won't be collected.

I removed the Py_INCREF, and Sage starts and quits without problem. But would it hurt to have the incref?



---

archive/issue_comments_169478.json:
```json
{
    "body": "<a id='comment:39'>**Comment 39:**</a>\nReplying to [@simon-king-jena](#comment%3A38):\n> Replying to [jpflori](#comment%3A33):\n> > I don't really think your solution is right.\n> > As I mentioned these small integers won't be deallocated anyway as they are cdefed, so we don't care.\n\n> \n> Anyway. I believe it should be cleaner to avoid integers being created in one way and then deleted in a different way.\n\nI agree.\n> \n> > And I'm not really sure that doing anything after the global dummy is created rather than after the hook is in place.\n\n> \n> I can't parse that phrase. Do you say: There should be no code whatsoever between the creation of the global dummy and the creation of the hook?\n\nI meant that following what you posted you should have tried to create the integers different from the dummy one just after the dummy one and not after the hooks are in place.\n\nBut as stated above, I agree that it is cleaner to create everything after the hooks are in place, except for dummy of course cos its not possible.\nAnd anyway these integers are cdefed so wont be garbage collected automatically, although you can trigger their deletion by calling del on them.\n> \n> > For further investigation, the Py_INCREF of the global dummy in sage/misc/allocator.pyx seems useless as well now as it is cdefed and won't be collected.\n\n> \n> I removed the Py_INCREF, and Sage starts and quits without problem. But would it hurt to have the incref?\n\nI don't think having code no one understands is a good thing.\nAnd it would make a small slowdown to keep this incref :)\nAnd prevent a proper deallocation of ONE when Sage quits, if we ever want or manage to do that.",
    "created_at": "2013-02-05T21:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169478",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:39'>**Comment 39:**</a>
Replying to [@simon-king-jena](#comment%3A38):
> Replying to [jpflori](#comment%3A33):
> > I don't really think your solution is right.
> > As I mentioned these small integers won't be deallocated anyway as they are cdefed, so we don't care.

> 
> Anyway. I believe it should be cleaner to avoid integers being created in one way and then deleted in a different way.

I agree.
> 
> > And I'm not really sure that doing anything after the global dummy is created rather than after the hook is in place.

> 
> I can't parse that phrase. Do you say: There should be no code whatsoever between the creation of the global dummy and the creation of the hook?

I meant that following what you posted you should have tried to create the integers different from the dummy one just after the dummy one and not after the hooks are in place.

But as stated above, I agree that it is cleaner to create everything after the hooks are in place, except for dummy of course cos its not possible.
And anyway these integers are cdefed so wont be garbage collected automatically, although you can trigger their deletion by calling del on them.
> 
> > For further investigation, the Py_INCREF of the global dummy in sage/misc/allocator.pyx seems useless as well now as it is cdefed and won't be collected.

> 
> I removed the Py_INCREF, and Sage starts and quits without problem. But would it hurt to have the incref?

I don't think having code no one understands is a good thing.
And it would make a small slowdown to keep this incref :)
And prevent a proper deallocation of ONE when Sage quits, if we ever want or manage to do that.



---

archive/issue_comments_169479.json:
```json
{
    "body": "<a id='comment:40'>**Comment 40:**</a>\nReplying to [jpflori](#comment%3A35):\n> Maybe we are just f***ing up with Python debug memory api.\n> \n> What Python rants about is that the first bytes before the actual object ONE, which should have been allocated in PyObject_DebugMallocAPI and set to FORBIDDENBYTE are in fact worth CLEANBYTE, which is what the debug memory api sets for the space reserved for the object itself...\n\nWhat is the problem with it? Can we prevent it? Does it make sense to prevent it when we are not in debug mode?",
    "created_at": "2013-02-05T21:33:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169479",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:40'>**Comment 40:**</a>
Replying to [jpflori](#comment%3A35):
> Maybe we are just f***ing up with Python debug memory api.
> 
> What Python rants about is that the first bytes before the actual object ONE, which should have been allocated in PyObject_DebugMallocAPI and set to FORBIDDENBYTE are in fact worth CLEANBYTE, which is what the debug memory api sets for the space reserved for the object itself...

What is the problem with it? Can we prevent it? Does it make sense to prevent it when we are not in debug mode?



---

archive/issue_comments_169480.json:
```json
{
    "body": "<a id='comment:41'>**Comment 41:**</a>\nReplying to [@simon-king-jena](#comment%3A40):\n> Replying to [jpflori](#comment%3A35):\n> > Maybe we are just f***ing up with Python debug memory api.\n> > \n> > What Python rants about is that the first bytes before the actual object ONE, which should have been allocated in PyObject_DebugMallocAPI and set to FORBIDDENBYTE are in fact worth CLEANBYTE, which is what the debug memory api sets for the space reserved for the object itself...\n\n> \n> What is the problem with it? Can we prevent it? Does it make sense to prevent it when we are not in debug mode?\n\nIt is not a problem outside of debug mode I guess.\n\nIn debug mode the problem is that it seems that the object has been malloced/created without these surrounding FORBIDDENBYTE (and some additional info including the size allocated, and what API was used), but when it is deallocaed (what happened because a Py_INCREF was removed in #12615, and ONE was not cdefed), the dealloc functions look for these bytes (that's the OUCH part), and then try to reach something based on the size allocated which should be stored next to these bytes.\nUnfortunately this additional info is not present (not written when alloced? overwritten later? I don't know...) so the dealloc function gets a random size (look at \"18302628885633695743 bytes originally requested\" in your first comment) and it leads to a segfault.",
    "created_at": "2013-02-05T21:38:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169480",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:41'>**Comment 41:**</a>
Replying to [@simon-king-jena](#comment%3A40):
> Replying to [jpflori](#comment%3A35):
> > Maybe we are just f***ing up with Python debug memory api.
> > 
> > What Python rants about is that the first bytes before the actual object ONE, which should have been allocated in PyObject_DebugMallocAPI and set to FORBIDDENBYTE are in fact worth CLEANBYTE, which is what the debug memory api sets for the space reserved for the object itself...

> 
> What is the problem with it? Can we prevent it? Does it make sense to prevent it when we are not in debug mode?

It is not a problem outside of debug mode I guess.

In debug mode the problem is that it seems that the object has been malloced/created without these surrounding FORBIDDENBYTE (and some additional info including the size allocated, and what API was used), but when it is deallocaed (what happened because a Py_INCREF was removed in #12615, and ONE was not cdefed), the dealloc functions look for these bytes (that's the OUCH part), and then try to reach something based on the size allocated which should be stored next to these bytes.
Unfortunately this additional info is not present (not written when alloced? overwritten later? I don't know...) so the dealloc function gets a random size (look at "18302628885633695743 bytes originally requested" in your first comment) and it leads to a segfault.



---

archive/issue_comments_169481.json:
```json
{
    "body": "<a id='comment:42'>**Comment 42:**</a>\nRobert, do you agree that letting global_dummy_Integer be the only integer created without pool and with `__cinit__` is a valid solution?",
    "created_at": "2013-02-05T21:43:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169481",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:42'>**Comment 42:**</a>
Robert, do you agree that letting global_dummy_Integer be the only integer created without pool and with `__cinit__` is a valid solution?



---

archive/issue_comments_169482.json:
```json
{
    "body": "<a id='comment:43'>**Comment 43:**</a>\nConcerning removal of the INCREF: I could imagine removing it is a bad idea. After all, the allocator appears to be of general use. Hence, we have no guarantee that in other (potential) uses of sage.misc.allocator we could guarantee *externally* that the dummy will live forever.\n\nPlus: hook_tp_functions (and thus Py_INCREF) is called exactly once. I don't think that the slowdown caused by it really matters...",
    "created_at": "2013-02-05T21:48:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169482",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:43'>**Comment 43:**</a>
Concerning removal of the INCREF: I could imagine removing it is a bad idea. After all, the allocator appears to be of general use. Hence, we have no guarantee that in other (potential) uses of sage.misc.allocator we could guarantee *externally* that the dummy will live forever.

Plus: hook_tp_functions (and thus Py_INCREF) is called exactly once. I don't think that the slowdown caused by it really matters...



---

archive/issue_comments_169483.json:
```json
{
    "body": "<a id='comment:44'>**Comment 44:**</a>\nReplying to [@simon-king-jena](#comment%3A43):\n> Concerning removal of the INCREF: I could imagine removing it is a bad idea. After all, the allocator appears to be of general use. Hence, we have no guarantee that in other (potential) uses of sage.misc.allocator we could guarantee *externally* that the dummy will live forever.\n\nI meant the other INCREF mentioned here https://github.com/sagemath/sage/issues/2435#comment:6 and with no info on why it would be needed.\n\nAbout the INCREF on dummy, my point is that it is useless as dummy is cdefed and won't be automatically collected.\nBut indeedit could be called on something not cdefed so let's keep it.\n> \n> Plus: hook_tp_functions (and thus Py_INCREF) is called exactly once. I don't think that the slowdown caused by it really matters...\n\nYeah, even the other which gets called every time the method is called won't be that terrible, I was kidding.",
    "created_at": "2013-02-05T21:52:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169483",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:44'>**Comment 44:**</a>
Replying to [@simon-king-jena](#comment%3A43):
> Concerning removal of the INCREF: I could imagine removing it is a bad idea. After all, the allocator appears to be of general use. Hence, we have no guarantee that in other (potential) uses of sage.misc.allocator we could guarantee *externally* that the dummy will live forever.

I meant the other INCREF mentioned here https://github.com/sagemath/sage/issues/2435#comment:6 and with no info on why it would be needed.

About the INCREF on dummy, my point is that it is useless as dummy is cdefed and won't be automatically collected.
But indeedit could be called on something not cdefed so let's keep it.
> 
> Plus: hook_tp_functions (and thus Py_INCREF) is called exactly once. I don't think that the slowdown caused by it really matters...

Yeah, even the other which gets called every time the method is called won't be that terrible, I was kidding.



---

archive/issue_comments_169484.json:
```json
{
    "body": "<a id='comment:45'>**Comment 45:**</a>\nIn fact I don't even feel that it is necessary to ensure that the global dummy never gets collected.\nI mean what's the matter if it gets collected when Sage quits and we are sure no other Integer will be created ?\nThis should be the case for a more general use of sage/misc/allocator.pyx whence the unnecessity of the INCREF in general.",
    "created_at": "2013-02-05T22:47:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169484",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:45'>**Comment 45:**</a>
In fact I don't even feel that it is necessary to ensure that the global dummy never gets collected.
I mean what's the matter if it gets collected when Sage quits and we are sure no other Integer will be created ?
This should be the case for a more general use of sage/misc/allocator.pyx whence the unnecessity of the INCREF in general.



---

archive/issue_comments_169485.json:
```json
{
    "body": "<a id='comment:46'>**Comment 46:**</a>\nHere comes another proposition of patch.",
    "created_at": "2013-02-05T22:57:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169485",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:46'>**Comment 46:**</a>
Here comes another proposition of patch.



---

archive/issue_comments_169486.json:
```json
{
    "body": "<a id='comment:47'>**Comment 47:**</a>\nHum, the problem with this BYTE marker has really something to do with the change of allocator/deallocator.\n\nIf I remove the call to hook_fast_tp_functions, then the integers created, even during an interactive session, are preceded by CLEANBYTE rather than FORBIDDENBYTE and deallocated without problems.\n\nSo I guess I'll have to have a closer look at Python's code...\nI must have missed what the default allocator for Integer is, but it does not finish in PyObject_Malloc I guess.",
    "created_at": "2013-02-05T23:18:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169486",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:47'>**Comment 47:**</a>
Hum, the problem with this BYTE marker has really something to do with the change of allocator/deallocator.

If I remove the call to hook_fast_tp_functions, then the integers created, even during an interactive session, are preceded by CLEANBYTE rather than FORBIDDENBYTE and deallocated without problems.

So I guess I'll have to have a closer look at Python's code...
I must have missed what the default allocator for Integer is, but it does not finish in PyObject_Malloc I guess.



---

archive/issue_comments_169487.json:
```json
{
    "body": "<a id='comment:48'>**Comment 48:**</a>\nThe alternative patch is incomplete: It removes ONE, but it does not change the import line \"from sage.rings.integer import ONE\" in sage/structure/factorization_integer.py.\n\nIt seems to me that the alternative patch is not essentially different from the original patch, but mainly adds more comments - or did I miss something? Could you turn it into a referee patch?",
    "created_at": "2013-02-05T23:24:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169487",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:48'>**Comment 48:**</a>
The alternative patch is incomplete: It removes ONE, but it does not change the import line "from sage.rings.integer import ONE" in sage/structure/factorization_integer.py.

It seems to me that the alternative patch is not essentially different from the original patch, but mainly adds more comments - or did I miss something? Could you turn it into a referee patch?



---

archive/issue_comments_169488.json:
```json
{
    "body": "<a id='comment:49'>**Comment 49:**</a>\nYup, I'll do that.",
    "created_at": "2013-02-05T23:26:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169488",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:49'>**Comment 49:**</a>
Yup, I'll do that.



---

archive/issue_comments_169489.json:
```json
{
    "body": "Cleanup hooked functions and integer allocation.",
    "created_at": "2013-02-05T23:32:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169489",
    "user": "https://github.com/sagetrac-jpflori"
}
```

Cleanup hooked functions and integer allocation.



---

archive/issue_comments_169490.json:
```json
{
    "body": "<a id='comment:50'>**Comment 50:**</a>\n**Attachment:** [trac_14059.patch.gz](https://github.com/sagemath/sage/files/ticket14059/trac_14059.patch.gz)\n\nIf Robert has any comment, feel free to change the status of the ticket or enlighten us.",
    "created_at": "2013-02-05T23:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169490",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:50'>**Comment 50:**</a>
**Attachment:** [trac_14059.patch.gz](https://github.com/sagemath/sage/files/ticket14059/trac_14059.patch.gz)

If Robert has any comment, feel free to change the status of the ticket or enlighten us.



---

archive/issue_comments_169491.json:
```json
{
    "body": "**Reviewer:** Jean-Pierre Flori",
    "created_at": "2013-02-05T23:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169491",
    "user": "https://github.com/sagetrac-jpflori"
}
```

**Reviewer:** Jean-Pierre Flori



---

archive/issue_events_167551.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2013-02-05T23:37:05Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167551"
}
```



---

archive/issue_events_167552.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2013-02-05T23:37:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167552"
}
```



---

archive/issue_comments_169492.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -39,3 +39,9 @@\n The purpose of #2435 was to fix a memory leak introduced in #1337. Problem: One has to manually incref `ONE`, which I find a bit suspicious.\n \n When I build sage-5.7.beta2 in debug version (as by #13864), Sage crashes at exit, while attempting `PyObject_FREE(o)`. I will attach backtraces in comments.\n+\n+The problem is the workaround for ONE (which is not cdefed so get collected at exit) got removed (accidently?) at #12615.\n+We simplify the workaround nd completetly remove the use of ONE and use the new one from #12615.\n+There still are strange things going one with allocation and deallocation before and after setting up the hooked functions with debug builds of Python, but with the current setting everything seems, so the workarounds are sufficient.\n+\n+Apply [attachment:trac_14059.patch](https://github.com/sagemath/sage/files/ticket14059/trac_14059.patch).\n``````\n",
    "created_at": "2013-02-05T23:37:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169492",
    "user": "https://github.com/sagetrac-jpflori"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -39,3 +39,9 @@
 The purpose of #2435 was to fix a memory leak introduced in #1337. Problem: One has to manually incref `ONE`, which I find a bit suspicious.
 
 When I build sage-5.7.beta2 in debug version (as by #13864), Sage crashes at exit, while attempting `PyObject_FREE(o)`. I will attach backtraces in comments.
+
+The problem is the workaround for ONE (which is not cdefed so get collected at exit) got removed (accidently?) at #12615.
+We simplify the workaround nd completetly remove the use of ONE and use the new one from #12615.
+There still are strange things going one with allocation and deallocation before and after setting up the hooked functions with debug builds of Python, but with the current setting everything seems, so the workarounds are sufficient.
+
+Apply [attachment:trac_14059.patch](https://github.com/sagemath/sage/files/ticket14059/trac_14059.patch).
``````




---

archive/issue_comments_169493.json:
```json
{
    "body": "<a id='comment:51'>**Comment 51:**</a>\nOne question: Why is it a problem that ONE was created via `__cinit__` but deleted via `fast_tp_dealloc`? After all, if the pool is not involved, this function does the same as `__dealloc__` plus decref. Isn't that the same as without the hooks?",
    "created_at": "2013-02-06T10:59:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169493",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:51'>**Comment 51:**</a>
One question: Why is it a problem that ONE was created via `__cinit__` but deleted via `fast_tp_dealloc`? After all, if the pool is not involved, this function does the same as `__dealloc__` plus decref. Isn't that the same as without the hooks?



---

archive/issue_comments_169494.json:
```json
{
    "body": "<a id='comment:52'>**Comment 52:**</a>\nReplying to [@simon-king-jena](#comment%3A51):\n> One question: Why is it a problem that ONE was created via `__cinit__` but deleted via `fast_tp_dealloc`? After all, if the pool is not involved, this function does the same as `__dealloc__` plus decref. Isn't that the same as without the hooks?\n\nThat's quite exactly what I've been ranting about and hoped we could better understand although the problem is not at this level but deeper it seems.\n\nA first guess is that somehow the deep PyObject_Malloc function used before the hooks are setup is not the debug version and do not produce the FORBIDDENBYTE markers (and additional info including the size alloced) and the PyObject_Free function is not as well and does not expect them and everything is fine if we try to deallocate ONE (you can put an explicit del statement and check there is not crash, or completely remove the hooks setup).\nBut when the hooks are setup, these two functions get replaced by the Malloc and Free debug functions which set and expect the FORBIDDENBYTE markers (and some additional info).\nSo at dealloc time it bangs.\nWhat I don't understand is why these two last debug version would not used from the start.\nAfter all were living in a debug build of Python...",
    "created_at": "2013-02-06T11:09:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169494",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:52'>**Comment 52:**</a>
Replying to [@simon-king-jena](#comment%3A51):
> One question: Why is it a problem that ONE was created via `__cinit__` but deleted via `fast_tp_dealloc`? After all, if the pool is not involved, this function does the same as `__dealloc__` plus decref. Isn't that the same as without the hooks?

That's quite exactly what I've been ranting about and hoped we could better understand although the problem is not at this level but deeper it seems.

A first guess is that somehow the deep PyObject_Malloc function used before the hooks are setup is not the debug version and do not produce the FORBIDDENBYTE markers (and additional info including the size alloced) and the PyObject_Free function is not as well and does not expect them and everything is fine if we try to deallocate ONE (you can put an explicit del statement and check there is not crash, or completely remove the hooks setup).
But when the hooks are setup, these two functions get replaced by the Malloc and Free debug functions which set and expect the FORBIDDENBYTE markers (and some additional info).
So at dealloc time it bangs.
What I don't understand is why these two last debug version would not used from the start.
After all were living in a debug build of Python...



---

archive/issue_comments_169495.json:
```json
{
    "body": "<a id='comment:53'>**Comment 53:**</a>\nSo our workaround here is just to make sure that Integer allocated before the hooks are setup do not get deallocated, even when Sage start.\n\nIt has two flavours:\n* cdef the Integer, so there is no automatic collection,\n* artificially increase its refcount so that it never reaches zero.\n\nAnd we use both.",
    "created_at": "2013-02-06T11:11:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169495",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:53'>**Comment 53:**</a>
So our workaround here is just to make sure that Integer allocated before the hooks are setup do not get deallocated, even when Sage start.

It has two flavours:
* cdef the Integer, so there is no automatic collection,
* artificially increase its refcount so that it never reaches zero.

And we use both.



---

archive/issue_comments_169496.json:
```json
{
    "body": "<a id='comment:54'>**Comment 54:**</a>\nOk got it.\n\nThe problem is that the dummy is allocated with the PyObject_GC_Malloc function and that adds an additional header of 32 bytes before the object itself.\nAnd if you look 36 bytes before the object itself you indeed find the FORBIDDENBYTE markers.",
    "created_at": "2013-02-06T15:51:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169496",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:54'>**Comment 54:**</a>
Ok got it.

The problem is that the dummy is allocated with the PyObject_GC_Malloc function and that adds an additional header of 32 bytes before the object itself.
And if you look 36 bytes before the object itself you indeed find the FORBIDDENBYTE markers.



---

archive/issue_comments_169497.json:
```json
{
    "body": "<a id='comment:55'>**Comment 55:**</a>\nReplying to [jpflori](#comment%3A54):\n> Ok got it.\n> \n> The problem is that the dummy is allocated with the PyObject_GC_Malloc function and that adds an additional header of 32 bytes before the object itself.\n\nAnd `fast_tp_new` can not use that? What is the difference between `PyObject_GC_Malloc` and `PyObject_MALLOC`? I guess it's about the cyclic garbage collection, which seemingly we don't want here. But if we don't want it, why are integers created with `PyObject_GC_Malloc` before establishing the hook?",
    "created_at": "2013-02-06T16:21:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169497",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:55'>**Comment 55:**</a>
Replying to [jpflori](#comment%3A54):
> Ok got it.
> 
> The problem is that the dummy is allocated with the PyObject_GC_Malloc function and that adds an additional header of 32 bytes before the object itself.

And `fast_tp_new` can not use that? What is the difference between `PyObject_GC_Malloc` and `PyObject_MALLOC`? I guess it's about the cyclic garbage collection, which seemingly we don't want here. But if we don't want it, why are integers created with `PyObject_GC_Malloc` before establishing the hook?



---

archive/issue_comments_169498.json:
```json
{
    "body": "<a id='comment:56'>**Comment 56:**</a>\nBecause I guess that all cdef'ed classes are created with GC enabled (by default?).",
    "created_at": "2013-02-06T16:24:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169498",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:56'>**Comment 56:**</a>
Because I guess that all cdef'ed classes are created with GC enabled (by default?).



---

archive/issue_comments_169499.json:
```json
{
    "body": "<a id='comment:57'>**Comment 57:**</a>\nReplying to [jpflori](#comment%3A56):\n> Because I guess that all cdef'ed classes are created with GC enabled (by default?).\n\nOK. But what is the reason for not using it in the hooked functions?",
    "created_at": "2013-02-06T16:55:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169499",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:57'>**Comment 57:**</a>
Replying to [jpflori](#comment%3A56):
> Because I guess that all cdef'ed classes are created with GC enabled (by default?).

OK. But what is the reason for not using it in the hooked functions?



---

archive/issue_comments_169500.json:
```json
{
    "body": "<a id='comment:58'>**Comment 58:**</a>\nDon't know.\nMaybe speed?\n\nAs you can see in sage/misc/allocator.pyx we pass a flag to explicitely disable GC.",
    "created_at": "2013-02-06T17:00:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169500",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:58'>**Comment 58:**</a>
Don't know.
Maybe speed?

As you can see in sage/misc/allocator.pyx we pass a flag to explicitely disable GC.



---

archive/issue_comments_169501.json:
```json
{
    "body": "<a id='comment:59'>**Comment 59:**</a>\nReplying to [jpflori](#comment%3A58):\n> Don't know. Maybe speed?\n\nIndeed. Types that are not container type (types that do not hold references to other python objects) need not be tracked by GC. I don't think Cython supports \"not GC tracked\" by default. Basically all Sage objects formally are container types because they have a _parent pointer or something like that.\n\nIntegers do too, but since ZZ is supposed to be immortal anyway, it doesn't matter.\n\nIt means that\n\n```\ndel ZZ\n```\nwould not lead to ZZ actually being deallocated (even if there are no other references to it anymore, because `ZZ.one_element` would have a pointer to `ZZ` that can't be discovered to be part of the cycle by GC.",
    "created_at": "2013-02-06T18:06:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169501",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:59'>**Comment 59:**</a>
Replying to [jpflori](#comment%3A58):
> Don't know. Maybe speed?

Indeed. Types that are not container type (types that do not hold references to other python objects) need not be tracked by GC. I don't think Cython supports "not GC tracked" by default. Basically all Sage objects formally are container types because they have a _parent pointer or something like that.

Integers do too, but since ZZ is supposed to be immortal anyway, it doesn't matter.

It means that

```
del ZZ
```
would not lead to ZZ actually being deallocated (even if there are no other references to it anymore, because `ZZ.one_element` would have a pointer to `ZZ` that can't be discovered to be part of the cycle by GC.



---

archive/issue_comments_169502.json:
```json
{
    "body": "**Merged:** sage-5.7.beta4",
    "created_at": "2013-02-09T12:16:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14059#issuecomment-169502",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.7.beta4



---

archive/issue_events_167553.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-09T12:16:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167553"
}
```



---

archive/issue_events_167554.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-09T12:16:02Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14059",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14059#event-167554"
}
```
