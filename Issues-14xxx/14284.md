# Issue 14284: Sampling in unit tests

archive/issues_014080.json:
```json
{
    "body": "In writing unit tests (e.g. `_test_associativity`) it can be useful to pass in lots of elements to test.  But some tests scale linearly while others scale cubically, so it's not practical to have the same list of elements for all tests.  This patch adds a `max_runs` option for `TestSuite.run` that forces sampling of the element list when a large list is specified.\n\n---\n\nApply\n\n1. [attachment:14284.patch]\n2. [attachment:trac_14284_review.patch]\n3. [attachment:trac_14284_review_review.patch]\n4. [attachment:trac_14284_fix.patch]\n\n**Assignee:** @jasongrout\n\n**Reviewer:** Julian Rueth\n\n**Author:** David Roe\n\n**Merged:** sage-5.9.beta2\n\n**Dependencies:** #14285\n\nIssue created by migration from https://trac.sagemath.org/ticket/14284\n\n",
    "closed_at": "2013-03-26T22:31:10Z",
    "created_at": "2013-03-16T19:50:46Z",
    "labels": [
        "component: misc",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.9",
    "title": "Sampling in unit tests",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14284",
    "user": "https://github.com/roed314"
}
```
In writing unit tests (e.g. `_test_associativity`) it can be useful to pass in lots of elements to test.  But some tests scale linearly while others scale cubically, so it's not practical to have the same list of elements for all tests.  This patch adds a `max_runs` option for `TestSuite.run` that forces sampling of the element list when a large list is specified.

---

Apply

1. [attachment:14284.patch]
2. [attachment:trac_14284_review.patch]
3. [attachment:trac_14284_review_review.patch]
4. [attachment:trac_14284_fix.patch]

**Assignee:** @jasongrout

**Reviewer:** Julian Rueth

**Author:** David Roe

**Merged:** sage-5.9.beta2

**Dependencies:** #14285

Issue created by migration from https://trac.sagemath.org/ticket/14284





---

archive/issue_comments_211208.json:
```json
{
    "body": "**Dependencies:** #14285",
    "created_at": "2013-03-16T20:51:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211208",
    "user": "https://github.com/roed314"
}
```

**Dependencies:** #14285



---

archive/issue_comments_211209.json:
```json
{
    "body": "**Author:** David Roe",
    "created_at": "2013-03-17T01:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211209",
    "user": "https://github.com/roed314"
}
```

**Author:** David Roe



---

archive/issue_comments_211210.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-03-17T01:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211210",
    "user": "https://github.com/roed314"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_211211.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2013-03-17T03:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211211",
    "user": "https://github.com/saraedum"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_211212.json:
```json
{
    "body": "<a id='comment:3'></a>\nThere is a problem with short lists.",
    "created_at": "2013-03-17T03:34:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211212",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:3'></a>
There is a problem with short lists.



---

archive/issue_comments_211213.json:
```json
{
    "body": "**Reviewer:** Julian Rueth",
    "created_at": "2013-03-17T03:35:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211213",
    "user": "https://github.com/saraedum"
}
```

**Reviewer:** Julian Rueth



---

archive/issue_comments_211214.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-03-17T05:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211214",
    "user": "https://github.com/roed314"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_211215.json:
```json
{
    "body": "<a id='comment:5'></a>\nFixed the problem with nth root and with unrank not working correctly.",
    "created_at": "2013-03-17T05:52:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211215",
    "user": "https://github.com/roed314"
}
```

<a id='comment:5'></a>
Fixed the problem with nth root and with unrank not working correctly.



---

archive/attachments_019291.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "14284.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket14284/14284.patch",
    "created_at": "2013-03-17T18:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/roed314"
}
```



---

archive/issue_comments_211216.json:
```json
{
    "body": "<a id='comment:6'></a>\nSee #14293 for a bug revealed by this ticket.",
    "created_at": "2013-03-17T18:54:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211216",
    "user": "https://github.com/roed314"
}
```

<a id='comment:6'></a>
See #14293 for a bug revealed by this ticket.



---

archive/issue_comments_211217.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,8 @@\n In writing unit tests (e.g. `_test_associativity`) it can be useful to pass in lots of elements to test.  But some tests scale linearly while others scale cubically, so it's not practical to have the same list of elements for all tests.  This patch adds a `max_runs` option for `TestSuite.run` that forces sampling of the element list when a large list is specified.\n+\n+---\n+\n+Apply\n+\n+1. [attachment:14284.patch]\n+2. [attachment:trac_14284_review.patch]\n``````\n",
    "created_at": "2013-03-18T05:37:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211217",
    "user": "https://github.com/saraedum"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,8 @@
 In writing unit tests (e.g. `_test_associativity`) it can be useful to pass in lots of elements to test.  But some tests scale linearly while others scale cubically, so it's not practical to have the same list of elements for all tests.  This patch adds a `max_runs` option for `TestSuite.run` that forces sampling of the element list when a large list is specified.
+
+---
+
+Apply
+
+1. [attachment:14284.patch]
+2. [attachment:trac_14284_review.patch]
``````




---

archive/attachments_019292.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_14284_review.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket14284/trac_14284_review.patch",
    "created_at": "2013-03-18T05:37:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/saraedum"
}
```



---

archive/issue_comments_211218.json:
```json
{
    "body": "<a id='comment:7'></a>\n",
    "created_at": "2013-03-18T05:37:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211218",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:7'></a>




---

archive/issue_comments_211219.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-03-18T08:55:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211219",
    "user": "https://github.com/saraedum"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_211220.json:
```json
{
    "body": "<a id='comment:9'></a>\nHi!\n\nSorry to jump in a bit late in the discussion; I had not noticed this ticket before.\n\nI definitely see and approve the point of the ticket. On the other hand, I find the current idiom to be used in `_test_associativity` and friends a bit heavy. What about an idiom like:\n\n```\n    S = tester.some_elements()\n    for x,y,z in tester.some_elements(CartesianProduct(S,S,S)):\n        ...\n```\n\nIt's short, and encapsulate TestSuite's inner logic for testing strategies (on how many elements to run the tests, whether to do tests at random or not, ...).\n\nThis of course requires implementing:\n\n```\ntester.some_elements(XXX)\n```\n\nThe default implementation could be to run XXX.some_elements(). Or iterate through XXX, stopping if there are more than n_max elements. Or take a sample if XXX implements sample. Or ...\n\nWhat do you think? If you agree, then I would suggest doing the changes in this ticket, in order to minimize changes and counter changes (they probably will require some rebasing of my upcoming category patches; the less rebasing the better :-)).\n\nBy the way: for reproducibility of test failures, I am not super comfortable with random testing as a default; but that might be just me.\n\nCheers,\n                                   Nicolas",
    "created_at": "2013-03-19T03:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211220",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:9'></a>
Hi!

Sorry to jump in a bit late in the discussion; I had not noticed this ticket before.

I definitely see and approve the point of the ticket. On the other hand, I find the current idiom to be used in `_test_associativity` and friends a bit heavy. What about an idiom like:

```
    S = tester.some_elements()
    for x,y,z in tester.some_elements(CartesianProduct(S,S,S)):
        ...
```

It's short, and encapsulate TestSuite's inner logic for testing strategies (on how many elements to run the tests, whether to do tests at random or not, ...).

This of course requires implementing:

```
tester.some_elements(XXX)
```

The default implementation could be to run XXX.some_elements(). Or iterate through XXX, stopping if there are more than n_max elements. Or take a sample if XXX implements sample. Or ...

What do you think? If you agree, then I would suggest doing the changes in this ticket, in order to minimize changes and counter changes (they probably will require some rebasing of my upcoming category patches; the less rebasing the better :-)).

By the way: for reproducibility of test failures, I am not super comfortable with random testing as a default; but that might be just me.

Cheers,
                                   Nicolas



---

archive/issue_comments_211221.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2013-03-19T04:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211221",
    "user": "https://github.com/roed314"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_211222.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [nthiery](#comment%3A9):\n> Hi!\n> \n> Sorry to jump in a bit late in the discussion; I had not noticed this ticket before.\n\n\nWell, we did just open it a couple days ago (Julian's visiting me in Calgary so we're working in person).\n\n> I definitely see and approve the point of the ticket. On the other hand, I find the current idiom to be used in `_test_associativity` and friends a bit heavy. What about an idiom like:\n> \n> ```\n>     S = tester.some_elements()\n>     for x,y,z in tester.some_elements(CartesianProduct(S,S,S)):\n>         ...\n> ```\n> \n> It's short, and encapsulate TestSuite's inner logic for testing strategies (on how many elements to run the tests, whether to do tests at random or not, ...).\n> \n> This of course requires implementing:\n> \n> ```\n> tester.some_elements(XXX)\n> ```\n> \n> The default implementation could be to run XXX.some_elements(). Or iterate through XXX, stopping if there are more than n_max elements. Or take a sample if XXX implements sample. Or ...\n> \n> What do you think? If you agree, then I would suggest doing the changes in this ticket, in order to minimize changes and counter changes (they probably will require some rebasing of my upcoming category patches; the less rebasing the better :-)).\n\n\nSounds okay to me: I'll make a new version.  There will be a couple tests that can't use this idiom (`_test_eq_symmetric` for example), but they can certainly use the current approach.\n> \n> By the way: for reproducibility of test failures, I am not super comfortable with random testing as a default; but that might be just me.\n\n\nSince Sage sets the random seed at the beginning of each run, tests that use randomness should be reproducible....",
    "created_at": "2013-03-19T04:13:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211222",
    "user": "https://github.com/roed314"
}
```

<a id='comment:10'></a>
Replying to [nthiery](#comment%3A9):
> Hi!
> 
> Sorry to jump in a bit late in the discussion; I had not noticed this ticket before.


Well, we did just open it a couple days ago (Julian's visiting me in Calgary so we're working in person).

> I definitely see and approve the point of the ticket. On the other hand, I find the current idiom to be used in `_test_associativity` and friends a bit heavy. What about an idiom like:
> 
> ```
>     S = tester.some_elements()
>     for x,y,z in tester.some_elements(CartesianProduct(S,S,S)):
>         ...
> ```
> 
> It's short, and encapsulate TestSuite's inner logic for testing strategies (on how many elements to run the tests, whether to do tests at random or not, ...).
> 
> This of course requires implementing:
> 
> ```
> tester.some_elements(XXX)
> ```
> 
> The default implementation could be to run XXX.some_elements(). Or iterate through XXX, stopping if there are more than n_max elements. Or take a sample if XXX implements sample. Or ...
> 
> What do you think? If you agree, then I would suggest doing the changes in this ticket, in order to minimize changes and counter changes (they probably will require some rebasing of my upcoming category patches; the less rebasing the better :-)).


Sounds okay to me: I'll make a new version.  There will be a couple tests that can't use this idiom (`_test_eq_symmetric` for example), but they can certainly use the current approach.
> 
> By the way: for reproducibility of test failures, I am not super comfortable with random testing as a default; but that might be just me.


Since Sage sets the random seed at the beginning of each run, tests that use randomness should be reproducible....



---

archive/issue_comments_211223.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [roed](#comment%3A10):\n> Sounds okay to me: I'll make a new version.  There will be a couple\n> tests that can't use this idiom (`_test_eq_symmetric` for example),\n> but they can certainly use the current approach.\n\n\nThanks!\n\nBy the way: there are quite a few spots where _test_associativity is\ndisabled, precisely because they are too expensive (either due to too\nmany elements, but also in some cases because of high degree\ncalculations). See:\n\n    grep -r _test_associativity  . | grep skip\n\nYou might want to play around with those and maybe fix a couple if\nthings work better now.\n\n> Since Sage sets the random seed at the beginning of each run, tests\n> that use randomness should be reproducible....\n\n\nUnless some edit elsewhere in the file changes the order in which\nthings are run. Or if one wants to reproduce an error in the terminal\n(hopefully not so critical with the upcoming doctest framework if one\ncan finally explore a failing test with the debugger).\n\nBut I see the advantages too.",
    "created_at": "2013-03-19T13:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211223",
    "user": "https://github.com/nthiery"
}
```

<a id='comment:11'></a>
Replying to [roed](#comment%3A10):
> Sounds okay to me: I'll make a new version.  There will be a couple
> tests that can't use this idiom (`_test_eq_symmetric` for example),
> but they can certainly use the current approach.


Thanks!

By the way: there are quite a few spots where _test_associativity is
disabled, precisely because they are too expensive (either due to too
many elements, but also in some cases because of high degree
calculations). See:

    grep -r _test_associativity  . | grep skip

You might want to play around with those and maybe fix a couple if
things work better now.

> Since Sage sets the random seed at the beginning of each run, tests
> that use randomness should be reproducible....


Unless some edit elsewhere in the file changes the order in which
things are run. Or if one wants to reproduce an error in the terminal
(hopefully not so critical with the upcoming doctest framework if one
can finally explore a failing test with the debugger).

But I see the advantages too.



---

archive/attachments_019293.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_14284_review_review.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket14284/trac_14284_review_review.patch",
    "created_at": "2013-03-19T20:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/saraedum"
}
```



---

archive/issue_comments_211224.json:
```json
{
    "body": "",
    "created_at": "2013-03-19T20:42:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211224",
    "user": "https://github.com/saraedum"
}
```





---

archive/issue_comments_211225.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-03-19T20:45:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211225",
    "user": "https://github.com/saraedum"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_211226.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -6,3 +6,5 @@\n \n 1. [attachment:14284.patch]\n 2. [attachment:trac_14284_review.patch]\n+3. [attachment:trac_14284_review_review.patch]\n+4. [attachment:trac_14284_fix.patch]\n``````\n",
    "created_at": "2013-03-21T01:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211226",
    "user": "https://github.com/roed314"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -6,3 +6,5 @@
 
 1. [attachment:14284.patch]
 2. [attachment:trac_14284_review.patch]
+3. [attachment:trac_14284_review_review.patch]
+4. [attachment:trac_14284_fix.patch]
``````




---

archive/attachments_019294.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_14284_fix.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket14284/trac_14284_fix.patch",
    "created_at": "2013-03-21T01:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/roed314"
}
```



---

archive/issue_comments_211227.json:
```json
{
    "body": "<a id='comment:13'></a>\n",
    "created_at": "2013-03-21T01:53:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211227",
    "user": "https://github.com/roed314"
}
```

<a id='comment:13'></a>




---

archive/issue_comments_211228.json:
```json
{
    "body": "<a id='comment:14'></a>\n[I uploaded the patches, but they were actually written by David Roe]",
    "created_at": "2013-03-22T02:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211228",
    "user": "https://github.com/saraedum"
}
```

<a id='comment:14'></a>
[I uploaded the patches, but they were actually written by David Roe]



---

archive/issue_comments_211229.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-03-22T02:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211229",
    "user": "https://github.com/saraedum"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_events_046917.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-26T22:31:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14284#event-46917"
}
```



---

archive/issue_comments_211230.json:
```json
{
    "body": "**Merged:** sage-5.9.beta2",
    "created_at": "2013-03-26T22:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14284",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14284#issuecomment-211230",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.9.beta2
