# Issue 14371: Race condition in singular doctest

archive/issues_014167.json:
```json
{
    "assignees": [
        "https://github.com/sagetrac-mvngu"
    ],
    "body": "On hawk (OpenSolaris), after applying [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) to get a useful traceback:\n\n```\nsage -t devel/sage/sage/interfaces/expect.py\n**********************************************************************\nFile \"devel/sage/sage/interfaces/expect.py\", line 1089, in sage.interfaces.expect.Expect._crash_msg\nFailed example:\n    singular('2+3')\nException raised:\n    Traceback (most recent call last):\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 466, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 825, in execute\n        exec compiled in globs\n      File \"<doctest sage.interfaces.expect.Expect._crash_msg[4]>\", line 1, in <module>\n        singular('2+3')\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 724, in __call__\n        return SingularElement(self, type, x, False)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1184, in __init__\n        self._name = parent._create( value, type)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 685, in _create\n        self.set(type, name, value)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 626, in set\n        out = self.eval(cmd)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 580, in eval\n        s = Expect.eval(self, x, **kwds)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1197, in eval\n        for L in code.split('\\n') if L != ''])\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 818, in _eval_line\n        E.sendline(line)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py\", line 677, in sendline\n        n = n + self.send (os.linesep)\n      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py\", line 669, in send\n        c = os.write(self.child_fd, str)\n    TypeError: [Errno 22] Invalid argument\n    Error evaluating def sage51=2+3; in Singular\n**********************************************************************\n```\n\n**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive_alt.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive_alt.patch.gz)\n\nCC:  @jpflori\n\nReviewer: **Volker Braun, Jeroen Demeyer**\n\nAuthor: **Jeroen Demeyer, Volker Braun**\n\nMerged: **sage-5.9.rc0**\n\nComponent: **doctest coverage**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14371_\n\n",
    "closed_at": "2013-04-25T12:56:43Z",
    "created_at": "2013-03-27T22:40:15Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/doctest%20coverage",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Race condition in singular doctest",
    "type": "issue",
    "updated_at": "2013-04-25T12:56:43Z",
    "url": "https://github.com/sagemath/sage/issues/14371",
    "user": "https://github.com/jdemeyer"
}
```
On hawk (OpenSolaris), after applying [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) to get a useful traceback:

```
sage -t devel/sage/sage/interfaces/expect.py
**********************************************************************
File "devel/sage/sage/interfaces/expect.py", line 1089, in sage.interfaces.expect.Expect._crash_msg
Failed example:
    singular('2+3')
Exception raised:
    Traceback (most recent call last):
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 466, in _run
        self.execute(example, compiled, test.globs)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 825, in execute
        exec compiled in globs
      File "<doctest sage.interfaces.expect.Expect._crash_msg[4]>", line 1, in <module>
        singular('2+3')
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 724, in __call__
        return SingularElement(self, type, x, False)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init__
        self._name = parent._create( value, type)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 685, in _create
        self.set(type, name, value)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 626, in set
        out = self.eval(cmd)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 580, in eval
        s = Expect.eval(self, x, **kwds)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1197, in eval
        for L in code.split('\n') if L != ''])
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 818, in _eval_line
        E.sendline(line)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py", line 677, in sendline
        n = n + self.send (os.linesep)
      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py", line 669, in send
        c = os.write(self.child_fd, str)
    TypeError: [Errno 22] Invalid argument
    Error evaluating def sage51=2+3; in Singular
**********************************************************************
```

**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive_alt.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive_alt.patch.gz)

CC:  @jpflori

Reviewer: **Volker Braun, Jeroen Demeyer**

Author: **Jeroen Demeyer, Volker Braun**

Merged: **sage-5.9.rc0**

Component: **doctest coverage**

_Issue created by migration from https://trac.sagemath.org/ticket/14371_





---

archive/issue_events_203054.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-27T22:40:15Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "milestone_number": null,
    "milestone_title": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203054"
}
```



---

archive/issue_events_203055.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-27T22:40:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/doctest%20coverage",
    "label_color": "696969",
    "label_name": "doctest coverage",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203055"
}
```



---

archive/issue_events_203056.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-27T22:40:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203056"
}
```



---

archive/issue_events_203057.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-27T22:40:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203057"
}
```



---

archive/issue_events_203058.json:
```json
{
    "actor": "https://github.com/sagetrac-mvngu",
    "created_at": "2013-03-27T22:40:15Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203058"
}
```



---

archive/issue_events_203059.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-29T01:20:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203059"
}
```



---

archive/issue_comments_172791.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nIt's not the best solution possible, but after spending more than 1 hour trying stuff and reading the pexpect source code, there is nothing better I could come up with.",
    "created_at": "2013-03-29T01:20:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172791",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">comment:1</div>

It's not the best solution possible, but after spending more than 1 hour trying stuff and reading the pexpect source code, there is nothing better I could come up with.



---

archive/issue_comments_172792.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nWhich syscall is failing with invalid argument? Can we get the full backtrace? Why do we catch the RuntimeError at all in `set()`?",
    "created_at": "2013-04-05T12:29:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172792",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:2" align="right">comment:2</div>

Which syscall is failing with invalid argument? Can we get the full backtrace? Why do we catch the RuntimeError at all in `set()`?



---

archive/issue_comments_172793.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@vbraun](#comment:2):\n> Which syscall is failing with invalid argument?\n\n`os.write()` to the terminal, from the `send()` function in `site-packages/pexpect.py`",
    "created_at": "2013-04-05T13:03:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172793",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@vbraun](#comment:2):
> Which syscall is failing with invalid argument?

`os.write()` to the terminal, from the `send()` function in `site-packages/pexpect.py`



---

archive/issue_comments_172794.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nDoes that only happen in parallel testing but not in serial tests? The only thing I can think of is that we are running out of file descriptors. Solaris defaults to a really low `ulimit -n`, I think.",
    "created_at": "2013-04-07T11:13:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172794",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

Does that only happen in parallel testing but not in serial tests? The only thing I can think of is that we are running out of file descriptors. Solaris defaults to a really low `ulimit -n`, I think.



---

archive/issue_comments_172795.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@vbraun](#comment:4):\n> The only thing I can think of is that we are running out of file descriptors.\n\nI don't that has anything to do with it. I think it has to do with the fact that the Singular process dies and that therefore, writing to the pty fails. But unfortunately, it is more complicated than that.",
    "created_at": "2013-04-07T12:03:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172795",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@vbraun](#comment:4):
> The only thing I can think of is that we are running out of file descriptors.

I don't that has anything to do with it. I think it has to do with the fact that the Singular process dies and that therefore, writing to the pty fails. But unfortunately, it is more complicated than that.



---

archive/issue_comments_172796.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThis doesn't make sense, if something is wrong with the file descriptor then write would cause EBADF not EINVAL. Are you sure that the error comes from writing to the old, dead subprocess and not to the newly-forked one? And why are we even catching RuntimeError in sage.interface.singular.set?\n\nI would guess that the issue is the absence of `forkpty()` on Solaris? I.e. no `os.forkpty` in Python, so `pty.fork` falls back to an alternate implementation which presumably triggers a race in Solaris. Contact upstream ;-)\n\nIt seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`. If this doesn't work then your platform just can't run Sage.",
    "created_at": "2013-04-07T13:51:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172796",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">comment:6</div>

This doesn't make sense, if something is wrong with the file descriptor then write would cause EBADF not EINVAL. Are you sure that the error comes from writing to the old, dead subprocess and not to the newly-forked one? And why are we even catching RuntimeError in sage.interface.singular.set?

I would guess that the issue is the absence of `forkpty()` on Solaris? I.e. no `os.forkpty` in Python, so `pty.fork` falls back to an alternate implementation which presumably triggers a race in Solaris. Contact upstream ;-)

It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`. If this doesn't work then your platform just can't run Sage.



---

archive/issue_comments_172797.json:
```json
{
    "body": "Attachment: **[trac_14371_dont_catch_runtimeerror.patch.gz](https://github.com/sagemath/sage/files/ticket14371/trac_14371_dont_catch_runtimeerror.patch.gz)**\n\nInitial patch",
    "created_at": "2013-04-07T16:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172797",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_14371_dont_catch_runtimeerror.patch.gz](https://github.com/sagemath/sage/files/ticket14371/trac_14371_dont_catch_runtimeerror.patch.gz)**

Initial patch



---

archive/issue_comments_172798.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI've added a patch that weans off the singular interface from RuntimeError abuse. Maybe you can try with that patch, then we ought to get a actually useful backtrace. All tests pass with the patch on my machine...",
    "created_at": "2013-04-07T16:10:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172798",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

I've added a patch that weans off the singular interface from RuntimeError abuse. Maybe you can try with that patch, then we ought to get a actually useful backtrace. All tests pass with the patch on my machine...



---

archive/issue_comments_172799.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@vbraun](#comment:6):\n> It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`.\n\nI agree, but my workaround (adding the `sleep()`) worked and everything else which I tried didn't work. But I'll certainly try your patch.",
    "created_at": "2013-04-07T19:48:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172799",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@vbraun](#comment:6):
> It seems ridiculous to change the doctest here instead of adding a workaround to `sage.interface`.

I agree, but my workaround (adding the `sleep()`) worked and everything else which I tried didn't work. But I'll certainly try your patch.



---

archive/issue_comments_172800.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**",
    "created_at": "2013-04-08T06:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172800",
    "user": "https://github.com/jdemeyer"
}
```

Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**



---

archive/issue_comments_172801.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nAttachment: **[14371_traceback.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz)**",
    "created_at": "2013-04-08T06:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172801",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Attachment: **[14371_traceback.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz)**



---

archive/issue_comments_172802.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,27 +1,38 @@\n-On hawk (OpenSolaris):\n+On hawk (OpenSolaris), after applying [attachment: 14371:traceback.patch](https://github.com/sagemath/sage/files/ticket14371/368e8460a164a4a3013b6e8a7d4d071d.gz) to get a useful traceback:\n \n ```\n-sage -t --long devel/sage/sage/interfaces/expect.py\n+sage -t devel/sage/sage/interfaces/expect.py\n **********************************************************************\n File \"devel/sage/sage/interfaces/expect.py\", line 1089, in sage.interfaces.expect.Expect._crash_msg\n Failed example:\n     singular('2+3')\n Exception raised:\n     Traceback (most recent call last):\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 460, in _run\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 466, in _run\n         self.execute(example, compiled, test.globs)\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 819, in execute\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 825, in execute\n         exec compiled in globs\n       File \"<doctest sage.interfaces.expect.Expect._crash_msg[4]>\", line 1, in <module>\n         singular('2+3')\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 724, in __call__\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 724, in __call__\n         return SingularElement(self, type, x, False)\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1184, in __init__\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1184, in __init_\n+_\n         self._name = parent._create( value, type)\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 685, in _create\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 685, in _create\n         self.set(type, name, value)\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 628, in set\n-        raise TypeError, msg\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 626, in set\n+        out = self.eval(cmd)\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 580, in eval\n+        s = Expect.eval(self, x, **kwds)\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1197, in eval\n+        for L in code.split('\\n') if L != ''])\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 818, in _eval_line\n+        E.sendline(line)\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py\", line 677, in sendline\n+        n = n + self.send (os.linesep)\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py\", line 669, in send\n+        c = os.write(self.child_fd, str)\n     TypeError: [Errno 22] Invalid argument\n     Error evaluating def sage51=2+3; in Singular\n **********************************************************************\n``````\n",
    "created_at": "2013-04-08T06:18:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172802",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,27 +1,38 @@
-On hawk (OpenSolaris):
+On hawk (OpenSolaris), after applying [attachment: 14371:traceback.patch](https://github.com/sagemath/sage/files/ticket14371/368e8460a164a4a3013b6e8a7d4d071d.gz) to get a useful traceback:
 
 ```
-sage -t --long devel/sage/sage/interfaces/expect.py
+sage -t devel/sage/sage/interfaces/expect.py
 **********************************************************************
 File "devel/sage/sage/interfaces/expect.py", line 1089, in sage.interfaces.expect.Expect._crash_msg
 Failed example:
     singular('2+3')
 Exception raised:
     Traceback (most recent call last):
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 460, in _run
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 466, in _run
         self.execute(example, compiled, test.globs)
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 819, in execute
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 825, in execute
         exec compiled in globs
       File "<doctest sage.interfaces.expect.Expect._crash_msg[4]>", line 1, in <module>
         singular('2+3')
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 724, in __call__
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 724, in __call__
         return SingularElement(self, type, x, False)
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init__
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init_
+_
         self._name = parent._create( value, type)
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 685, in _create
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 685, in _create
         self.set(type, name, value)
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_suncc/build/sage-5.9.beta2/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 628, in set
-        raise TypeError, msg
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 626, in set
+        out = self.eval(cmd)
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 580, in eval
+        s = Expect.eval(self, x, **kwds)
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1197, in eval
+        for L in code.split('\n') if L != ''])
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 818, in _eval_line
+        E.sendline(line)
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py", line 677, in sendline
+        n = n + self.send (os.linesep)
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/pexpect.py", line 669, in send
+        c = os.write(self.child_fd, str)
     TypeError: [Errno 22] Invalid argument
     Error evaluating def sage51=2+3; in Singular
 **********************************************************************
``````




---

archive/issue_comments_172803.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-On hawk (OpenSolaris), after applying [attachment: 14371:traceback.patch](https://github.com/sagemath/sage/files/ticket14371/368e8460a164a4a3013b6e8a7d4d071d.gz) to get a useful traceback:\n+On hawk (OpenSolaris), after applying [attachment: 14371_traceback.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz) to get a useful traceback:\n \n ```\n sage -t devel/sage/sage/interfaces/expect.py\n``````\n",
    "created_at": "2013-04-08T06:19:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172803",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-On hawk (OpenSolaris), after applying [attachment: 14371:traceback.patch](https://github.com/sagemath/sage/files/ticket14371/368e8460a164a4a3013b6e8a7d4d071d.gz) to get a useful traceback:
+On hawk (OpenSolaris), after applying [attachment: 14371_traceback.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz) to get a useful traceback:
 
 ```
 sage -t devel/sage/sage/interfaces/expect.py
``````




---

archive/issue_comments_172804.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -16,8 +16,7 @@\n         singular('2+3')\n       File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 724, in __call__\n         return SingularElement(self, type, x, False)\n-      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1184, in __init_\n-_\n+      File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1184, in __init__\n         self._name = parent._create( value, type)\n       File \"/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 685, in _create\n         self.set(type, name, value)\n``````\n",
    "created_at": "2013-04-08T06:19:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172804",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -16,8 +16,7 @@
         singular('2+3')
       File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 724, in __call__
         return SingularElement(self, type, x, False)
-      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init_
-_
+      File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1184, in __init__
         self._name = parent._create( value, type)
       File "/export/home/buildbot/build/sage/hawk-1/hawk_full/build/sage-5.9.beta4/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 685, in _create
         self.set(type, name, value)
``````




---

archive/issue_comments_172805.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\n[attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) = [attachment: trac_14371_dont_catch_runtimeerror.patch](https://github.com/sagemath/sage/files/ticket14371/trac_14371_dont_catch_runtimeerror.patch.gz) + [attachment: 14371_traceback.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz) with 1 change: inherit `SingularError` from `RuntimeError` for backwards compatibility.",
    "created_at": "2013-04-08T06:33:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172805",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:12" align="right">comment:12</div>

[attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) = [attachment: trac_14371_dont_catch_runtimeerror.patch](https://github.com/sagemath/sage/files/ticket14371/trac_14371_dont_catch_runtimeerror.patch.gz) + [attachment: 14371_traceback.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz) with 1 change: inherit `SingularError` from `RuntimeError` for backwards compatibility.



---

archive/issue_comments_172806.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nOK, useful traceback now, any ideas?",
    "created_at": "2013-04-08T06:36:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172806",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

OK, useful traceback now, any ideas?



---

archive/issue_comments_172807.json:
```json
{
    "body": "Attachment: **[14371_singular_race.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_singular_race.patch.gz)**",
    "created_at": "2013-04-08T06:40:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172807",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[14371_singular_race.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_singular_race.patch.gz)**



---

archive/issue_comments_172808.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -36,3 +36,5 @@\n     Error evaluating def sage51=2+3; in Singular\n **********************************************************************\n ```\n+\n+**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_singular_race.patch](https://github.com/sagemath/sage/files/ticket14371/14371_singular_race.patch.gz)\n``````\n",
    "created_at": "2013-04-08T06:41:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172808",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -36,3 +36,5 @@
     Error evaluating def sage51=2+3; in Singular
 **********************************************************************
 ```
+
+**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_singular_race.patch](https://github.com/sagemath/sage/files/ticket14371/14371_singular_race.patch.gz)
``````




---

archive/issue_comments_172809.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\n`os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.",
    "created_at": "2013-04-08T09:27:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172809",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:15" align="right">comment:15</div>

`os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.



---

archive/issue_comments_172810.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nMaybe run the doctest under dtrace to figure out where the EINVAL comes from? Somebody who is actually using OpenSolaris should make an effort.",
    "created_at": "2013-04-08T09:47:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172810",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:16" align="right">comment:16</div>

Maybe run the doctest under dtrace to figure out where the EINVAL comes from? Somebody who is actually using OpenSolaris should make an effort.



---

archive/issue_comments_172811.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@vbraun](#comment:15):\n> `os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.\n\nThese are all true statements, but what's the point you're trying to make?\n\nPerhaps you are confused by the use of `sys.exc_info()[2]`, which allows to raise a new exception with the old traceback. So it really is the `os.write()` which is failing.",
    "created_at": "2013-04-08T12:21:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172811",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@vbraun](#comment:15):
> `os.write` can never raise a TypeError, only OSError. It is the point where the exception originates, but the exception type and message come from the `except OSError:` branch in `_eval_line`.

These are all true statements, but what's the point you're trying to make?

Perhaps you are confused by the use of `sys.exc_info()[2]`, which allows to raise a new exception with the old traceback. So it really is the `os.write()` which is failing.



---

archive/issue_comments_172812.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nReplying to [@vbraun](#comment:16):\n> Somebody who is actually using OpenSolaris should make an effort.\n\nI did, but I really couldn't figure out what is going wrong.",
    "created_at": "2013-04-08T12:21:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172812",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Replying to [@vbraun](#comment:16):
> Somebody who is actually using OpenSolaris should make an effort.

I did, but I really couldn't figure out what is going wrong.



---

archive/issue_comments_172813.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThat `os.write` fails is ok, we catch the `OSError` and restart the process. But your hack prints the traceback starting from `os.write`, which is not the relevant one. The except: branch fails somewhere and that is the issue.",
    "created_at": "2013-04-08T12:34:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172813",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:19" align="right">comment:19</div>

That `os.write` fails is ok, we catch the `OSError` and restart the process. But your hack prints the traceback starting from `os.write`, which is not the relevant one. The except: branch fails somewhere and that is the issue.



---

archive/issue_comments_172814.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nAttachment: **[14371_traceback_dont_catch.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz)**",
    "created_at": "2013-04-08T14:49:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172814",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Attachment: **[14371_traceback_dont_catch.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz)**



---

archive/issue_comments_172815.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-On hawk (OpenSolaris), after applying [attachment: 14371_traceback.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz) to get a useful traceback:\n+On hawk (OpenSolaris), after applying [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) to get a useful traceback:\n \n ```\n sage -t devel/sage/sage/interfaces/expect.py\n``````\n",
    "created_at": "2013-04-08T14:49:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172815",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-On hawk (OpenSolaris), after applying [attachment: 14371_traceback.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback.patch.gz) to get a useful traceback:
+On hawk (OpenSolaris), after applying [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) to get a useful traceback:
 
 ```
 sage -t devel/sage/sage/interfaces/expect.py
``````




---

archive/issue_comments_172816.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@vbraun](#comment:19):\n> That `os.write` fails is ok, we catch the `OSError` and restart the process.\n\nNo, we don't because pexpect hasn't realized that the process is dead (`E.isalive()` is still true).",
    "created_at": "2013-04-08T14:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172816",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@vbraun](#comment:19):
> That `os.write` fails is ok, we catch the `OSError` and restart the process.

No, we don't because pexpect hasn't realized that the process is dead (`E.isalive()` is still true).



---

archive/issue_comments_172817.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nKnown bug? This is from `pexpect.py`:\n\n```\n    def isalive(self):\n        \"\"\"This tests if the child process is running or not.\n        This is non-blocking. If the child was terminated then this\n        will read the exitstatus or signalstatus of the child.\n        This returns 1 if the child process appears to be running or 0 if not.\n        It can take literally SECONDS for Solaris to return the right status.\n        \"\"\"\n```\nHow about we wait for 5 seconds after an `os.write` error on Slowaris?",
    "created_at": "2013-04-09T10:52:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172817",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:22" align="right">comment:22</div>

Known bug? This is from `pexpect.py`:

```
    def isalive(self):
        """This tests if the child process is running or not.
        This is non-blocking. If the child was terminated then this
        will read the exitstatus or signalstatus of the child.
        This returns 1 if the child process appears to be running or 0 if not.
        It can take literally SECONDS for Solaris to return the right status.
        """
```
How about we wait for 5 seconds after an `os.write` error on Slowaris?



---

archive/issue_comments_172818.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -37,4 +37,4 @@\n **********************************************************************\n ```\n \n-**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_singular_race.patch](https://github.com/sagemath/sage/files/ticket14371/14371_singular_race.patch.gz)\n+**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive.patch.gz)\n``````\n",
    "created_at": "2013-04-09T11:37:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172818",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -37,4 +37,4 @@
 **********************************************************************
 ```
 
-**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_singular_race.patch](https://github.com/sagemath/sage/files/ticket14371/14371_singular_race.patch.gz)
+**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive.patch.gz)
``````




---

archive/issue_comments_172819.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nSomething like this (needs review)?",
    "created_at": "2013-04-09T11:37:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172819",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Something like this (needs review)?



---

archive/issue_comments_172820.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nAttachment: **[14371_sleep_isalive.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive.patch.gz)**\n\nI was more thingking about that:\n\n```\n    except OSError, msg: \n        if sys.platform.startswith('sunos'):\n            # OpenSolaris bug workaround\n            time.sleep(5)\n        if not E.isalive():\n```\nThere is no point in waiting if your OS works correctly. But more importantly, does it fix the issue?",
    "created_at": "2013-04-09T11:55:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172820",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:24" align="right">comment:24</div>

Attachment: **[14371_sleep_isalive.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive.patch.gz)**

I was more thingking about that:

```
    except OSError, msg: 
        if sys.platform.startswith('sunos'):
            # OpenSolaris bug workaround
            time.sleep(5)
        if not E.isalive():
```
There is no point in waiting if your OS works correctly. But more importantly, does it fix the issue?



---

archive/issue_comments_172821.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nReplying to [@vbraun](#comment:24):\n> There is no point in waiting if your OS works correctly.\n\nTrue, but I don't like special-casing operating systems. How can we be certain that it only affects (Open)Solaris? Since this failure (`OSError` when the process is truly alive) essentially never happens, I don't think it is a problem. On sane systems, this doesn't affect the doctest since those `time.sleep()` calls will not be done as `E.isalive()` is false.\n\n> But more importantly, does it fix the issue?\n\nI haven't checked it yet, but it should.",
    "created_at": "2013-04-09T12:02:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172821",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">comment:25</div>

Replying to [@vbraun](#comment:24):
> There is no point in waiting if your OS works correctly.

True, but I don't like special-casing operating systems. How can we be certain that it only affects (Open)Solaris? Since this failure (`OSError` when the process is truly alive) essentially never happens, I don't think it is a problem. On sane systems, this doesn't affect the doctest since those `time.sleep()` calls will not be done as `E.isalive()` is false.

> But more importantly, does it fix the issue?

I haven't checked it yet, but it should.



---

archive/issue_comments_172822.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@jdemeyer](#comment:25):\n> How can we be certain that it only affects (Open)Solaris?\n\nWe can't, thats why I would like to special case only Solaris so we get doctest failures if other (better) OS'es have a bug that causes `os.write` to fail while `isalive()`.",
    "created_at": "2013-04-09T12:11:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172822",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@jdemeyer](#comment:25):
> How can we be certain that it only affects (Open)Solaris?

We can't, thats why I would like to special case only Solaris so we get doctest failures if other (better) OS'es have a bug that causes `os.write` to fail while `isalive()`.



---

archive/issue_comments_172823.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@vbraun](#comment:26):\n> Replying to [@jdemeyer](#comment:25):\n> > How can we be certain that it only affects (Open)Solaris?\n\n> \n> We can't, thats why I would like to special case only Solaris so we get doctest failures\n\nAnd then what? Add a fix for that other operating system? Better just fix all hypothetical errors in one go.",
    "created_at": "2013-04-09T12:14:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172823",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@vbraun](#comment:26):
> Replying to [@jdemeyer](#comment:25):
> > How can we be certain that it only affects (Open)Solaris?

> 
> We can't, thats why I would like to special case only Solaris so we get doctest failures

And then what? Add a fix for that other operating system? Better just fix all hypothetical errors in one go.



---

archive/issue_comments_172824.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nAnyway, the OpenSolaris issue seems to be fixed by this patch.",
    "created_at": "2013-04-09T12:14:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172824",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Anyway, the OpenSolaris issue seems to be fixed by this patch.



---

archive/issue_comments_172825.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@jdemeyer](#comment:27):\n> And then what?\n\nAnd then hopefully not make an OS with such a glaring kernel bug a first-class supported platform.",
    "created_at": "2013-04-09T12:18:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172825",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@jdemeyer](#comment:27):
> And then what?

And then hopefully not make an OS with such a glaring kernel bug a first-class supported platform.



---

archive/issue_comments_172826.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nFYI, this is also happening on Solaris 10, so not only OpenSolaris (which is dead isn't it? we should maybe rather try OpenIndiana?).",
    "created_at": "2013-04-10T09:35:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172826",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:31" align="right">comment:31</div>

FYI, this is also happening on Solaris 10, so not only OpenSolaris (which is dead isn't it? we should maybe rather try OpenIndiana?).



---

archive/issue_comments_172827.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\n(Although OpenIndiana does not support SPARC yet...)",
    "created_at": "2013-04-10T09:43:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172827",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:32" align="right">comment:32</div>

(Although OpenIndiana does not support SPARC yet...)



---

archive/issue_events_203060.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-24T12:18:50Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "milestone_number": null,
    "milestone_title": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203060"
}
```



---

archive/issue_events_203061.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-24T12:18:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203061"
}
```



---

archive/issue_comments_172828.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nFwiw, here is an alternative patch.",
    "created_at": "2013-04-24T15:12:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172828",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:34" align="right">comment:34</div>

Fwiw, here is an alternative patch.



---

archive/issue_comments_172829.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nVolker, for the record: do you give positive review to [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz)?",
    "created_at": "2013-04-24T15:35:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172829",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:35" align="right">comment:35</div>

Volker, for the record: do you give positive review to [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz)?



---

archive/issue_comments_172830.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nYes, to the extend that I can give positive review to a patch that I wrote for the most part ;-)",
    "created_at": "2013-04-24T15:51:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172830",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:36" align="right">comment:36</div>

Yes, to the extend that I can give positive review to a patch that I wrote for the most part ;-)



---

archive/issue_comments_172831.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nVolker, as release manager I need this bug to be fixed, so I'm going to apply your version, even though I still prefer to fix the potential problem on all systems.\n\nUnfortunately, David Kirkby's OpenSolaris machine is down for the moment, so I cannot test your patch (although it should work).",
    "created_at": "2013-04-25T11:53:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172831",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">comment:37</div>

Volker, as release manager I need this bug to be fixed, so I'm going to apply your version, even though I still prefer to fix the potential problem on all systems.

Unfortunately, David Kirkby's OpenSolaris machine is down for the moment, so I cannot test your patch (although it should work).



---

archive/issue_comments_172832.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nSorry for being a PITA sometimes ;-)",
    "created_at": "2013-04-25T11:59:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172832",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:38" align="right">comment:38</div>

Sorry for being a PITA sometimes ;-)



---

archive/issue_comments_172833.json:
```json
{
    "body": "Attachment: **[14371_sleep_isalive_alt.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive_alt.patch.gz)**\n\nAlternative patch",
    "created_at": "2013-04-25T12:02:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172833",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[14371_sleep_isalive_alt.patch.gz](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive_alt.patch.gz)**

Alternative patch



---

archive/issue_comments_172834.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -37,4 +37,4 @@\n **********************************************************************\n ```\n \n-**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive.patch.gz)\n+**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive_alt.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive_alt.patch.gz)\n``````\n",
    "created_at": "2013-04-25T12:02:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172834",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -37,4 +37,4 @@
 **********************************************************************
 ```
 
-**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive.patch.gz)
+**Apply** [attachment: 14371_traceback_dont_catch.patch](https://github.com/sagemath/sage/files/ticket14371/14371_traceback_dont_catch.patch.gz) and [attachment: 14371_sleep_isalive_alt.patch](https://github.com/sagemath/sage/files/ticket14371/14371_sleep_isalive_alt.patch.gz)
``````




---

archive/issue_comments_172835.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nComment-only change to your patch. Volker, if you agree, then this one is good to go.",
    "created_at": "2013-04-25T12:02:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172835",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

Comment-only change to your patch. Volker, if you agree, then this one is good to go.



---

archive/issue_comments_172836.json:
```json
{
    "body": "Reviewer: **Volker Braun, Jeroen Demeyer**",
    "created_at": "2013-04-25T12:02:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172836",
    "user": "https://github.com/jdemeyer"
}
```

Reviewer: **Volker Braun, Jeroen Demeyer**



---

archive/issue_comments_172837.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nSounds good to me.",
    "created_at": "2013-04-25T12:06:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172837",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:40" align="right">comment:40</div>

Sounds good to me.



---

archive/issue_events_203062.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-25T12:06:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203062"
}
```



---

archive/issue_events_203063.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-25T12:06:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203063"
}
```



---

archive/issue_comments_172838.json:
```json
{
    "body": "Merged: **sage-5.9.rc0**",
    "created_at": "2013-04-25T12:56:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14371#issuecomment-172838",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.9.rc0**



---

archive/issue_events_203064.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-25T12:56:43Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203064"
}
```



---

archive/issue_events_203065.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-25T12:56:43Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14371",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14371#event-203065"
}
```
