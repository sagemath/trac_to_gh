# Issue 14523: can't exit or detach after error in attached file

archive/issues_014319.json:
```json
{
    "body": "```\n17:57:03:~$ touch myfile.sage\n17:57:05:~$ sage\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: %attach myfile.sage\nsage: file('myfile.sage', 'w').write('1/0')\nsage: 1+1\n...\nZeroDivisionError: Rational division by zero\nsage: exit\n...\nZeroDivisionError: Rational division by zero\nsage: detach('myfile.sage')\n...\nZeroDivisionError: Rational division by zero\n```\n| Sage Version 5.8, Release Date: 2013-03-15                         |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\nIt seems like the only way to continue using this Sage session is to fix the error first. But suppose you have some reason not to (e.g. are in a hurry, and the error is hard to fix). I think it would be much better if Sage was to evaluate \"1+1\" and especially \"exit\" and \"detach\" even when unable to reload one of the attached files.\n\nPossible ways to fix this are discussed on [sage-devel](http://groups.google.com/forum/?fromgroups=#!topic/sage-devel/FM7EAAmJhuk).\n\nApply\n* [attachment:trac_14523_improve_attach.patch]\n* [attachment:trac_14523_readline.patch]\n\nAssignee: @williamstein\n\nCC:  @nexttime @nbruin @seblabbe\n\nReviewer: Travis Scrimshaw\n\nAuthor: Volker Braun\n\nMerged: sage-5.11.rc0\n\nDependencies: #14266\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14523\n\n",
    "closed_at": "2013-07-31T12:55:05Z",
    "created_at": "2013-05-03T08:23:41Z",
    "labels": [
        "component: user interface",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.11",
    "title": "can't exit or detach after error in attached file",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14523",
    "user": "https://github.com/mstreng"
}
```
```
17:57:03:~$ touch myfile.sage
17:57:05:~$ sage
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: %attach myfile.sage
sage: file('myfile.sage', 'w').write('1/0')
sage: 1+1
...
ZeroDivisionError: Rational division by zero
sage: exit
...
ZeroDivisionError: Rational division by zero
sage: detach('myfile.sage')
...
ZeroDivisionError: Rational division by zero
```
| Sage Version 5.8, Release Date: 2013-03-15                         |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
It seems like the only way to continue using this Sage session is to fix the error first. But suppose you have some reason not to (e.g. are in a hurry, and the error is hard to fix). I think it would be much better if Sage was to evaluate "1+1" and especially "exit" and "detach" even when unable to reload one of the attached files.

Possible ways to fix this are discussed on [sage-devel](http://groups.google.com/forum/?fromgroups=#!topic/sage-devel/FM7EAAmJhuk).

Apply
* [attachment:trac_14523_improve_attach.patch]
* [attachment:trac_14523_readline.patch]

Assignee: @williamstein

CC:  @nexttime @nbruin @seblabbe

Reviewer: Travis Scrimshaw

Author: Volker Braun

Merged: sage-5.11.rc0

Dependencies: #14266

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/14523





---

archive/issue_comments_192685.json:
```json
{
    "body": "<a id='comment:1'></a>* only reload once per time stamp change\n* reload without having to press any key in Sage\n* collect all attach-related files in one module instead of sprinkling it around",
    "created_at": "2013-05-03T19:32:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192685",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>* only reload once per time stamp change
* reload without having to press any key in Sage
* collect all attach-related files in one module instead of sprinkling it around



---

archive/issue_comments_192686.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-05-03T19:33:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192686",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_192687.json:
```json
{
    "body": "<a id='comment:3'></a>I'm not knowledgeable enough to offer a useful review of the code.  It does seem like a good solution to the observed problem.  \n\nThere is a behaviour of \"attach\" which bugs me.  If the file you try to attach generates an error when you attach it, then it doesn't actually get attached.  I don't see the point of this.  It makes even less sense now than before.  Would it be easy to fix on this ticket, or should I open another one?  \n\nI do also have one comment about the current patch -- if it wouldn't be too complicated, I think it would be nice to get a new sage prompt after the reloading is finished, to indicate that it has completed.",
    "created_at": "2013-05-03T22:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192687",
    "user": "https://github.com/hughrthomas"
}
```

<a id='comment:3'></a>I'm not knowledgeable enough to offer a useful review of the code.  It does seem like a good solution to the observed problem.  

There is a behaviour of "attach" which bugs me.  If the file you try to attach generates an error when you attach it, then it doesn't actually get attached.  I don't see the point of this.  It makes even less sense now than before.  Would it be easy to fix on this ticket, or should I open another one?  

I do also have one comment about the current patch -- if it wouldn't be too complicated, I think it would be nice to get a new sage prompt after the reloading is finished, to indicate that it has completed.



---

archive/issue_comments_192688.json:
```json
{
    "body": "<a id='comment:4'></a>Updated patch \n* remember that files is attached even if load fails\n* don't reload files that are in the process of being written",
    "created_at": "2013-05-04T10:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192688",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'></a>Updated patch 
* remember that files is attached even if load fails
* don't reload files that are in the process of being written



---

archive/issue_comments_192689.json:
```json
{
    "body": "<a id='comment:6'></a>Thanks very much!  (I have tested attaching a file with an error.)",
    "created_at": "2013-05-04T12:14:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192689",
    "user": "https://github.com/hughrthomas"
}
```

<a id='comment:6'></a>Thanks very much!  (I have tested attaching a file with an error.)



---

archive/issue_comments_192690.json:
```json
{
    "body": "<a id='comment:7'></a>Bonus: this also seems to fix the issue reported at #14149: when files are attached, spurious files are created in the current directory.",
    "created_at": "2013-05-12T17:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192690",
    "user": "https://github.com/hughrthomas"
}
```

<a id='comment:7'></a>Bonus: this also seems to fix the issue reported at #14149: when files are attached, spurious files are created in the current directory.



---

archive/issue_comments_192691.json:
```json
{
    "body": "<a id='comment:8'></a>Updated patch fixes some minor things, makes imports lazy, and adds doctests.",
    "created_at": "2013-05-12T20:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192691",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>Updated patch fixes some minor things, makes imports lazy, and adds doctests.



---

archive/issue_comments_192692.json:
```json
{
    "body": "<a id='comment:9'></a>`@`Volker: Thanks for the explanation (at #14149), and the new doctests, which clarify what is happening with the creation of files.  Would it be possible to create the temp files somewhere else?  (I guess there are security concerns with putting them in /tmp, but isn't there any alternative?)  Or, would it be possible to keep track of them and remove them?  I guess at each update, the previous copy could be deleted, and detach or quit could delete the otherwise-remaining copy?",
    "created_at": "2013-05-12T21:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192692",
    "user": "https://github.com/hughrthomas"
}
```

<a id='comment:9'></a>`@`Volker: Thanks for the explanation (at #14149), and the new doctests, which clarify what is happening with the creation of files.  Would it be possible to create the temp files somewhere else?  (I guess there are security concerns with putting them in /tmp, but isn't there any alternative?)  Or, would it be possible to keep track of them and remove them?  I guess at each update, the previous copy could be deleted, and detach or quit could delete the otherwise-remaining copy?



---

archive/issue_comments_192693.json:
```json
{
    "body": "<a id='comment:10'></a>I think the \"debug mode\" for load and attach should be removed. Files should always be preparsed in memory. We should keep a user-accessible list of loaded/attached files with some state, preparsed form, etc. Any debugging that you can do with temporary files can be done much nicer by querying the files on the command line.\n\nBut thats for another ticket.",
    "created_at": "2013-05-12T23:17:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192693",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:10'></a>I think the "debug mode" for load and attach should be removed. Files should always be preparsed in memory. We should keep a user-accessible list of loaded/attached files with some state, preparsed form, etc. Any debugging that you can do with temporary files can be done much nicer by querying the files on the command line.

But thats for another ticket.



---

archive/issue_comments_192694.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [comment:10 vbraun]:\n> I think the \"debug mode\" for load and attach should be removed. Files should always be preparsed in memory. We should keep a user-accessible list of loaded/attached files with some state, preparsed form, etc. Any debugging that you can do with temporary files can be done much nicer by querying the files on the command line.\n\n\nI don't understand the last sentence, and (so?) I completely disagree with the rest. Tracebacks for attached files should be completely detailed, with code snippets. Anything that has to be done by hand for each of the steps in the traceback is far from as useful as immediately seeing the code itself. See #11812 and [this discussion](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4).",
    "created_at": "2013-05-13T05:15:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192694",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:11'></a>Replying to [comment:10 vbraun]:
> I think the "debug mode" for load and attach should be removed. Files should always be preparsed in memory. We should keep a user-accessible list of loaded/attached files with some state, preparsed form, etc. Any debugging that you can do with temporary files can be done much nicer by querying the files on the command line.


I don't understand the last sentence, and (so?) I completely disagree with the rest. Tracebacks for attached files should be completely detailed, with code snippets. Anything that has to be done by hand for each of the steps in the traceback is far from as useful as immediately seeing the code itself. See #11812 and [this discussion](http://groups.google.com/group/sage-devel/browse_thread/thread/761f69944e21efd4).



---

archive/issue_comments_192695.json:
```json
{
    "body": "<a id='comment:12'></a>The updated patch \n* changes the default back to \"attach debug mode\" (really execute-via-file mode)\n* moves the temp file to Sage's temporary directory\n* adds doctests that the source snippet is shown",
    "created_at": "2013-05-13T19:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192695",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>The updated patch 
* changes the default back to "attach debug mode" (really execute-via-file mode)
* moves the temp file to Sage's temporary directory
* adds doctests that the source snippet is shown



---

archive/issue_comments_192696.json:
```json
{
    "body": "<a id='comment:13'></a>Is `SAGE_LOAD_ATTACH_PATH` cleared for doctesting?  Otherwise some doctests may fail (if the user has actually set it).",
    "created_at": "2013-05-13T20:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192696",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:13'></a>Is `SAGE_LOAD_ATTACH_PATH` cleared for doctesting?  Otherwise some doctests may fail (if the user has actually set it).



---

archive/issue_comments_192697.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 leif]:\n> Is `SAGE_LOAD_ATTACH_PATH` cleared for doctesting?  Otherwise some doctests may fail (if the user has actually set it).\n\n\nJust checked in vanilla Sage 5.10.beta1, and there indeed three doctests fail (in `sage/misc/preparser.py`) if it is set to something non-empty.\n\nSo apparently this is not new, but could you also fix it here?",
    "created_at": "2013-05-13T20:27:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192697",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:14'></a>Replying to [comment:13 leif]:
> Is `SAGE_LOAD_ATTACH_PATH` cleared for doctesting?  Otherwise some doctests may fail (if the user has actually set it).


Just checked in vanilla Sage 5.10.beta1, and there indeed three doctests fail (in `sage/misc/preparser.py`) if it is set to something non-empty.

So apparently this is not new, but could you also fix it here?



---

archive/issue_comments_192698.json:
```json
{
    "body": "<a id='comment:15'></a>I think the undocumented `SAGE_LOAD_ATTACH_PATH` should be removed, not groomed further. There should be a Python-level way to set the search path if desired. If you really need the functionality then you just have to call `sage.path(os.environ['SAGE_LOAD_ATTACH_PATH'])` in your own code. But that should be done on another ticket.",
    "created_at": "2013-05-14T08:02:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192698",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:15'></a>I think the undocumented `SAGE_LOAD_ATTACH_PATH` should be removed, not groomed further. There should be a Python-level way to set the search path if desired. If you really need the functionality then you just have to call `sage.path(os.environ['SAGE_LOAD_ATTACH_PATH'])` in your own code. But that should be done on another ticket.



---

archive/issue_comments_192699.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:15 vbraun]:\n> I think the undocumented `SAGE_LOAD_ATTACH_PATH` should be removed, not groomed further.\n\n\nI have no strong opinion on doing so.  Although it's apparently not documented (at least not in Sage's documentation besides the docstring; it may get mentioned in some 3rd party documentation), I bet a couple of people will complain (probably much) later if we remove it... ;-)\n\nBut I'd rather tend to leave the (IMHO convenient) functionality, probably documenting it more prominently (it doesn't really fit into the Sage *Installation* Guide, just like other environment variables, which is a different story), and fixing potential doctest failures (which is a minor issue anyway) -- elsewhere, on another ticket.\n\n\n\n  \n> There should be a Python-level way to set the search path if desired. If you really need the functionality then you just have to call `sage.path(os.environ['SAGE_LOAD_ATTACH_PATH'])` in your own code. But that should be done on another ticket.\n\n\nSo you don't intend to remove it here either?  (Ok for me, just asking.)",
    "created_at": "2013-05-14T09:02:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192699",
    "user": "https://github.com/nexttime"
}
```

<a id='comment:16'></a>Replying to [comment:15 vbraun]:
> I think the undocumented `SAGE_LOAD_ATTACH_PATH` should be removed, not groomed further.


I have no strong opinion on doing so.  Although it's apparently not documented (at least not in Sage's documentation besides the docstring; it may get mentioned in some 3rd party documentation), I bet a couple of people will complain (probably much) later if we remove it... ;-)

But I'd rather tend to leave the (IMHO convenient) functionality, probably documenting it more prominently (it doesn't really fit into the Sage *Installation* Guide, just like other environment variables, which is a different story), and fixing potential doctest failures (which is a minor issue anyway) -- elsewhere, on another ticket.



  
> There should be a Python-level way to set the search path if desired. If you really need the functionality then you just have to call `sage.path(os.environ['SAGE_LOAD_ATTACH_PATH'])` in your own code. But that should be done on another ticket.


So you don't intend to remove it here either?  (Ok for me, just asking.)



---

archive/issue_comments_192700.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:16 leif]:\n> So you don't intend to remove it here either?  (Ok for me, just asking.)\n\n\nNo, I'd rather leave that for later. The whole load/attach functionality should be collected into an object instead of multiple global functions, including the search path functionality. Then we can go ahead and deprecate `SAGE_LOAD_ATTACH_PATH`...",
    "created_at": "2013-05-14T09:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192700",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Replying to [comment:16 leif]:
> So you don't intend to remove it here either?  (Ok for me, just asking.)


No, I'd rather leave that for later. The whole load/attach functionality should be collected into an object instead of multiple global functions, including the search path functionality. Then we can go ahead and deprecate `SAGE_LOAD_ATTACH_PATH`...



---

archive/issue_comments_192701.json:
```json
{
    "body": "<a id='comment:18'></a>Fixed failing doctest on patchbot",
    "created_at": "2013-05-16T09:20:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192701",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>Fixed failing doctest on patchbot



---

archive/issue_comments_192702.json:
```json
{
    "body": "<a id='comment:19'></a>Conflicts with the otherwise unrelated #14266, this is now a dependency.",
    "created_at": "2013-05-28T10:15:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192702",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:19'></a>Conflicts with the otherwise unrelated #14266, this is now a dependency.



---

archive/issue_comments_192703.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-06-08T21:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192703",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_192704.json:
```json
{
    "body": "<a id='comment:20'></a>Attachment [trac_14523_improve_attach.patch](tarball://root/attachments/some-uuid/ticket14523/trac_14523_improve_attach.patch) by @tscrim created at 2013-06-12 15:44:07\n\nHey Volker,\n\nLooks good for the most part. It's somewhat minor, but is there some way we can get it so that we get it to end with the sage prompt? For me it currently ends at a blank line, although it still accepts input correctly.\n\nThanks,\n\nTravis",
    "created_at": "2013-06-12T15:44:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192704",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Attachment [trac_14523_improve_attach.patch](tarball://root/attachments/some-uuid/ticket14523/trac_14523_improve_attach.patch) by @tscrim created at 2013-06-12 15:44:07

Hey Volker,

Looks good for the most part. It's somewhat minor, but is there some way we can get it so that we get it to end with the sage prompt? For me it currently ends at a blank line, although it still accepts input correctly.

Thanks,

Travis



---

archive/issue_comments_192705.json:
```json
{
    "body": "<a id='comment:21'></a>Its not just print a new prompt, you want to redraw the current line (since you could have a partially-written command there). I think its possible to call `rl_refresh_line` in readline, but that would need some careful testing so we don't break other stuff.",
    "created_at": "2013-06-12T16:05:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192705",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:21'></a>Its not just print a new prompt, you want to redraw the current line (since you could have a partially-written command there). I think its possible to call `rl_refresh_line` in readline, but that would need some careful testing so we don't break other stuff.



---

archive/issue_comments_192706.json:
```json
{
    "body": "<a id='comment:22'></a>True. I'm happy with getting this into Sage as is.",
    "created_at": "2013-06-12T16:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192706",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:22'></a>True. I'm happy with getting this into Sage as is.



---

archive/issue_comments_192707.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-06-12T16:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192707",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_041331.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-13T07:19:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14523#event-41331"
}
```



---

archive/issue_comments_192708.json:
```json
{
    "body": "<a id='comment:24'></a>Doctest failures:\n\n```\nsage -t devel/sage/sage/misc/sageinspect.py\n**********************************************************************\nFile \"devel/sage/sage/misc/sageinspect.py\", line 57, in sage.misc.sageinspect\nFailed example:\n    import sage.misc.attach\nException raised:\n    Traceback (most recent call last):\n      File \"/mazur/release/merger/sage-5.11.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 486, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/mazur/release/merger/sage-5.11.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 845, in execute\n        exec compiled in globs\n      File \"<doctest sage.misc.sageinspect[10]>\", line 1, in <module>\n        import sage.misc.attach\n    ImportError: No module named attach\n**********************************************************************\n```\nand\n\n```\nsage -t --long devel/sage/sage/misc/inputhook.py\n**********************************************************************\nFile \"devel/sage/sage/misc/inputhook.py\", line 42, in sage.misc.inputhook.sage_inputhook\nFailed example:\n    shell.run_cell('sage_inputhook()')\nExpected:\n    ### reloading attached file tmp_....py modified at ... ###\n    0\nGot:\n    0\n**********************************************************************\nFile \"devel/sage/sage/misc/inputhook.py\", line 46, in sage.misc.inputhook.sage_inputhook\nFailed example:\n    shell.run_cell('a')\nExpected:\n    3\nGot:\n    2\n**********************************************************************\n```",
    "created_at": "2013-06-14T12:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192708",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:24'></a>Doctest failures:

```
sage -t devel/sage/sage/misc/sageinspect.py
**********************************************************************
File "devel/sage/sage/misc/sageinspect.py", line 57, in sage.misc.sageinspect
Failed example:
    import sage.misc.attach
Exception raised:
    Traceback (most recent call last):
      File "/mazur/release/merger/sage-5.11.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 486, in _run
        self.execute(example, compiled, test.globs)
      File "/mazur/release/merger/sage-5.11.beta2/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 845, in execute
        exec compiled in globs
      File "<doctest sage.misc.sageinspect[10]>", line 1, in <module>
        import sage.misc.attach
    ImportError: No module named attach
**********************************************************************
```
and

```
sage -t --long devel/sage/sage/misc/inputhook.py
**********************************************************************
File "devel/sage/sage/misc/inputhook.py", line 42, in sage.misc.inputhook.sage_inputhook
Failed example:
    shell.run_cell('sage_inputhook()')
Expected:
    ### reloading attached file tmp_....py modified at ... ###
    0
Got:
    0
**********************************************************************
File "devel/sage/sage/misc/inputhook.py", line 46, in sage.misc.inputhook.sage_inputhook
Failed example:
    shell.run_cell('a')
Expected:
    3
Got:
    2
**********************************************************************
```



---

archive/issue_comments_192709.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2013-06-14T12:05:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192709",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_192710.json:
```json
{
    "body": "<a id='comment:25'></a>Another issue: computations from attach'ed files are uninterruptable. This is because readline installs its own signal handlers while it is sitting at the input prompt, and (by default) only restores the previous handler when you press enter.",
    "created_at": "2013-06-16T14:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192710",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:25'></a>Another issue: computations from attach'ed files are uninterruptable. This is because readline installs its own signal handlers while it is sitting at the input prompt, and (by default) only restores the previous handler when you press enter.



---

archive/issue_comments_192711.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 vbraun]:\n> \n\n\nCould this cause other problems with CTRL-C as well? See [#14740:6](http://trac.sagemath.org/sage_trac/ticket/14740#comment:6)",
    "created_at": "2013-06-16T18:14:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192711",
    "user": "https://github.com/mstreng"
}
```

<a id='comment:26'></a>Replying to [comment:25 vbraun]:
> 


Could this cause other problems with CTRL-C as well? See [#14740:6](http://trac.sagemath.org/sage_trac/ticket/14740#comment:6)



---

archive/issue_comments_192712.json:
```json
{
    "body": "<a id='comment:27'></a>A closer reading of IPython reveals that it intentionally overwrites the SIGINT handler when you set an inputhook (as we do to poll for file changes). So interrupting computations is completely messed up, even if its not attached. I'm working on a new patch...",
    "created_at": "2013-06-17T05:19:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192712",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:27'></a>A closer reading of IPython reveals that it intentionally overwrites the SIGINT handler when you set an inputhook (as we do to poll for file changes). So interrupting computations is completely messed up, even if its not attached. I'm working on a new patch...



---

archive/issue_comments_192713.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -22,6 +22,10 @@\n \n Possible ways to fix this are discussed on [sage-devel](http://groups.google.com/forum/?fromgroups=#!topic/sage-devel/FM7EAAmJhuk).\n \n+Apply\n+* [attachment:trac_14523_improve_attach.patch]\n+* [attachment:trac_14523_readline.patch]\n+\n Comment: 1\n \n Issue created by migration from https://trac.sagemath.org/ticket/14523\n``````\n",
    "created_at": "2013-06-17T19:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192713",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -22,6 +22,10 @@
 
 Possible ways to fix this are discussed on [sage-devel](http://groups.google.com/forum/?fromgroups=#!topic/sage-devel/FM7EAAmJhuk).
 
+Apply
+* [attachment:trac_14523_improve_attach.patch]
+* [attachment:trac_14523_readline.patch]
+
 Comment: 1
 
 Issue created by migration from https://trac.sagemath.org/ticket/14523
``````




---

archive/issue_comments_192714.json:
```json
{
    "body": "<a id='comment:28'></a>All subsequent changes will be in the separate `trac_14523_readline.patch`. This does now sidesteps IPython to preserve our signal handlers. Also, it really needs to be implemented in Cython since the inputhook must be able to ignore signals so it does not get interrupted immediately when you press Ctrl-C at the prompt.",
    "created_at": "2013-06-17T19:54:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192714",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:28'></a>All subsequent changes will be in the separate `trac_14523_readline.patch`. This does now sidesteps IPython to preserve our signal handlers. Also, it really needs to be implemented in Cython since the inputhook must be able to ignore signals so it does not get interrupted immediately when you press Ctrl-C at the prompt.



---

archive/issue_comments_192715.json:
```json
{
    "body": "<a id='comment:29'></a>I also added an interface to readline so we can redraw the prompt.",
    "created_at": "2013-06-17T19:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192715",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:29'></a>I also added an interface to readline so we can redraw the prompt.



---

archive/issue_comments_192716.json:
```json
{
    "body": "<a id='comment:30'></a>Also fixed Jeroen's doctest failures. First is stale python file (you need to run `sage -sync-build` to reproduce it), second is filesystem timestamp granularity.",
    "created_at": "2013-06-17T20:42:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192716",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:30'></a>Also fixed Jeroen's doctest failures. First is stale python file (you need to run `sage -sync-build` to reproduce it), second is filesystem timestamp granularity.



---

archive/issue_comments_192717.json:
```json
{
    "body": "<a id='comment:31'></a>Slightly beautified so the old command line is erased:\n\n```\nsage: attach('foo.py')\noutput from attached file\nsage: 123_<-- cursor here 456\n```\nNow edit and save attached file, and you get\n\n```\nsage: attach('foo.py')\noutput from attached file\n### reloading attached file t.py modified at 18:04:08 ###\noutput from changed attached file\nsage: 123_<-- cursor here 456\n```\n\nOn a related note, attaching files in the notebook is completely broken (with and without this ticket).",
    "created_at": "2013-06-18T18:06:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192717",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:31'></a>Slightly beautified so the old command line is erased:

```
sage: attach('foo.py')
output from attached file
sage: 123_<-- cursor here 456
```
Now edit and save attached file, and you get

```
sage: attach('foo.py')
output from attached file
### reloading attached file t.py modified at 18:04:08 ###
output from changed attached file
sage: 123_<-- cursor here 456
```

On a related note, attaching files in the notebook is completely broken (with and without this ticket).



---

archive/issue_comments_192718.json:
```json
{
    "body": "<a id='comment:32'></a>Notebook issue is here: https://github.com/sagemath/sagenb/issues/169",
    "created_at": "2013-06-18T18:22:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192718",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>Notebook issue is here: https://github.com/sagemath/sagenb/issues/169



---

archive/issue_comments_192719.json:
```json
{
    "body": "<a id='comment:33'></a>Patch rebased for sage-5.11.beta1 (not yet released)",
    "created_at": "2013-06-18T22:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192719",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:33'></a>Patch rebased for sage-5.11.beta1 (not yet released)



---

archive/issue_comments_192720.json:
```json
{
    "body": "<a id='comment:34'></a>I'm getting doctest failures:\n\n```\nsage -t devel/sage/sage/misc/sage_extension.py\n**********************************************************************\nFile \"devel/sage/sage/misc/sage_extension.py\", line 107, in sage.misc.sage_extension.SageMagics.attach\nFailed example:\n    shell.run_cell('sage_inputhook()')\nExpected:\n    ### reloading attached file run_cell.py modified at ... ###\n    0\nGot:\n    0\n**********************************************************************\nFile \"devel/sage/sage/misc/sage_extension.py\", line 111, in sage.misc.sage_extension.SageMagics.attach\nFailed example:\n    shell.run_cell('a')\nExpected:\n    3\nGot:\n    2\n**********************************************************************\n1 item had failures:\n   2 of  15 in sage.misc.sage_extension.SageMagics.attach\n    [45 tests, 2 failures, 2.13 s]\n----------------------------------------------------------------------\nsage -t devel/sage/sage/misc/sage_extension.py  # 2 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2013-06-21T20:36:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192720",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:34'></a>I'm getting doctest failures:

```
sage -t devel/sage/sage/misc/sage_extension.py
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 107, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('sage_inputhook()')
Expected:
    ### reloading attached file run_cell.py modified at ... ###
    0
Got:
    0
**********************************************************************
File "devel/sage/sage/misc/sage_extension.py", line 111, in sage.misc.sage_extension.SageMagics.attach
Failed example:
    shell.run_cell('a')
Expected:
    3
Got:
    2
**********************************************************************
1 item had failures:
   2 of  15 in sage.misc.sage_extension.SageMagics.attach
    [45 tests, 2 failures, 2.13 s]
----------------------------------------------------------------------
sage -t devel/sage/sage/misc/sage_extension.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_192721.json:
```json
{
    "body": "Attachment [trac_14523_readline.2.patch](tarball://root/attachments/some-uuid/ticket14523/trac_14523_readline.2.patch) by @vbraun created at 2013-06-23 14:40:32\n\nUpdated patch",
    "created_at": "2013-06-23T14:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192721",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14523_readline.2.patch](tarball://root/attachments/some-uuid/ticket14523/trac_14523_readline.2.patch) by @vbraun created at 2013-06-23 14:40:32

Updated patch



---

archive/issue_comments_192722.json:
```json
{
    "body": "Attachment [trac_14523_readline.patch](tarball://root/attachments/some-uuid/ticket14523/trac_14523_readline.patch) by @vbraun created at 2013-06-23 14:40:38\n\nUpdated patch",
    "created_at": "2013-06-23T14:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192722",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14523_readline.patch](tarball://root/attachments/some-uuid/ticket14523/trac_14523_readline.patch) by @vbraun created at 2013-06-23 14:40:38

Updated patch



---

archive/issue_comments_192723.json:
```json
{
    "body": "<a id='comment:35'></a>Thanks, fixed. Was another instance of filesytem timestamp granularity in the doctest.\n\npatchbot: \napply trac_14523_improve_attach.patch trac_14523_readline.patch",
    "created_at": "2013-06-23T14:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192723",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:35'></a>Thanks, fixed. Was another instance of filesytem timestamp granularity in the doctest.

patchbot: 
apply trac_14523_improve_attach.patch trac_14523_readline.patch



---

archive/issue_comments_192724.json:
```json
{
    "body": "<a id='comment:36'></a>For a reference, #14149 and #14169 were closed as duplicate of this ticket (they are not obvious duplicate just looking at the titles or descriptions).",
    "created_at": "2013-06-24T12:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192724",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:36'></a>For a reference, #14149 and #14169 were closed as duplicate of this ticket (they are not obvious duplicate just looking at the titles or descriptions).



---

archive/issue_comments_192725.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-06-26T03:16:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192725",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_192726.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-07-08T14:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192726",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_192727.json:
```json
{
    "body": "<a id='comment:38'></a>Hey Volker,\n\nSorry for letting this sit for so long. Looks good to me (I remembered to run sync-build this time to remove the old files before testing).\n\n(Side note, does the patchbot run sync-build after applying patches? If not, I think doing this would be beneficial.)\n\nBest,\n\nTravis",
    "created_at": "2013-07-08T14:18:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192727",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:38'></a>Hey Volker,

Sorry for letting this sit for so long. Looks good to me (I remembered to run sync-build this time to remove the old files before testing).

(Side note, does the patchbot run sync-build after applying patches? If not, I think doing this would be beneficial.)

Best,

Travis



---

archive/issue_comments_192728.json:
```json
{
    "body": "<a id='comment:39'></a>Thanks! I believe the patchbot uses separate branches so it doesn't have to sync-build.",
    "created_at": "2013-07-08T14:27:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192728",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:39'></a>Thanks! I believe the patchbot uses separate branches so it doesn't have to sync-build.



---

archive/issue_events_041332.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-31T12:55:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14523#event-41332"
}
```



---

archive/issue_comments_192729.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-07-31T12:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192729",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_comments_192730.json:
```json
{
    "body": "<a id='comment:41'></a>See http://ask.sagemath.org/question/3084/notebook-and-initsage and #15308.",
    "created_at": "2013-10-19T22:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192730",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:41'></a>See http://ask.sagemath.org/question/3084/notebook-and-initsage and #15308.



---

archive/issue_comments_192731.json:
```json
{
    "body": "<a id='comment:42'></a>See #16784 for a followup.",
    "created_at": "2014-08-08T19:48:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14523",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14523#issuecomment-192731",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:42'></a>See #16784 for a followup.
