# Issue 14254: OverflowErrors in TripleDictEraser

archive/issues_014050.json:
```json
{
    "assignees": [],
    "body": "With the new doctesting framework (#12415), I sometimes see errors like\n\n```\nsage -t --long devel/sage/sage/combinat/sf/sfa.py\n**********************************************************************\nFile \"devel/sage/sage/combinat/sf/sfa.py\", line 388, in sage.combinat.sf.sfa.is_SymmetricFunctionAlgebra\nFailed example:\n    is_SymmetricFunctionAlgebra(SymmetricFunctions(FractionField(QQ['q','t'])).macdonald().P())\nExpected:\n    True\nGot:\n    Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x9531b3c> ignored\n    True\n**********************************************************************\n```\non 32-bit systems.\n\nThese appear randomly non-reproducibly in doctests.\n\nDepends on #13387\n\nAssignee: **@robertwb**\n\nCC:  @simon-king-jena @nbruin\n\nReviewer: **Simon King**\n\nAuthor: **Jeroen Demeyer**\n\nMerged: **sage-5.8.rc0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14254_\n\n",
    "closed_at": "2013-03-13T10:51:42Z",
    "created_at": "2013-03-11T09:01:43Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20coercion",
        "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "OverflowErrors in TripleDictEraser",
    "type": "issue",
    "updated_at": "2013-03-13T10:51:42Z",
    "url": "https://github.com/sagemath/sage/issues/14254",
    "user": "https://github.com/jdemeyer"
}
```
With the new doctesting framework (#12415), I sometimes see errors like

```
sage -t --long devel/sage/sage/combinat/sf/sfa.py
**********************************************************************
File "devel/sage/sage/combinat/sf/sfa.py", line 388, in sage.combinat.sf.sfa.is_SymmetricFunctionAlgebra
Failed example:
    is_SymmetricFunctionAlgebra(SymmetricFunctions(FractionField(QQ['q','t'])).macdonald().P())
Expected:
    True
Got:
    Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x9531b3c> ignored
    True
**********************************************************************
```
on 32-bit systems.

These appear randomly non-reproducibly in doctests.

Depends on #13387

Assignee: **@robertwb**

CC:  @simon-king-jena @nbruin

Reviewer: **Simon King**

Author: **Jeroen Demeyer**

Merged: **sage-5.8.rc0**

_Issue created by migration from https://trac.sagemath.org/ticket/14254_





---

archive/issue_events_184289.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T09:01:43Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184289"
}
```



---

archive/issue_events_184290.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T09:01:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20coercion",
    "label_color": "0000ff",
    "label_name": "component: coercion",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184290"
}
```



---

archive/issue_events_184291.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T09:01:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/p1%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184291"
}
```



---

archive/issue_events_184292.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T09:01:43Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184292"
}
```



---

archive/issue_events_184293.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T09:02:24Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184293"
}
```



---

archive/issue_events_184294.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T09:02:24Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184294"
}
```



---

archive/issue_comments_172895.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nThere is a comment\n\n```\n# A note about how to store \"id\" keys in python structures:\n#\n# In python a \"pointer length integer\" (size_t) normally, is encoded\n# as a *signed* integer, of type Py_ssize_t. This has an advantage in that\n# if the value gets encoded as a *python integer* it can do so in a sign-preserving\n# way and still make use of all the bits that python offers to store (small) integers.\n#\n# There is one place where we have to be careful about signs:\n# Our hash values most naturally live in Py_ssize_t. We convert those into\n# an index into our bucket list by taking the hash modulo the number of buckets.\n# However, the modulo operator in C preserves the sign of the number we take the\n# modulus of, which is not what we want.\n# The solution is to always do\n# (<size_t) h)% modulus\n# to ensure we're doing an unsigned modulus.\n```\n\nCould it be that this is relevant here?\n\nIs it really safe to do\n\n```\n        cdef Py_ssize_t k1,k2,k3\n        cdef int offset\n        k1,k2,k3,offset = r.key\n        cdef Py_ssize_t h = (k1 + 13*k2 ^ 503*k3)\n        PyList_GET_ITEM(buckets, (<size_t>h) % PyList_GET_SIZE(buckets))\n```\n?\n\nYes, we need to care about the sign. But we also have\n\n```\n Py_ssize_t PyList_GET_SIZE(object list)\n PyObject* PyList_GET_ITEM(object list, Py_ssize_t i)\n```\n(hence, the modulus is Py_ssize_t, and the result will be translated into Py_ssize_t, too)\n\nI am afraid I have no 32 bit machine to test.",
    "created_at": "2013-03-11T10:37:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172895",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">Comment 2</div>

There is a comment

```
# A note about how to store "id" keys in python structures:
#
# In python a "pointer length integer" (size_t) normally, is encoded
# as a *signed* integer, of type Py_ssize_t. This has an advantage in that
# if the value gets encoded as a *python integer* it can do so in a sign-preserving
# way and still make use of all the bits that python offers to store (small) integers.
#
# There is one place where we have to be careful about signs:
# Our hash values most naturally live in Py_ssize_t. We convert those into
# an index into our bucket list by taking the hash modulo the number of buckets.
# However, the modulo operator in C preserves the sign of the number we take the
# modulus of, which is not what we want.
# The solution is to always do
# (<size_t) h)% modulus
# to ensure we're doing an unsigned modulus.
```

Could it be that this is relevant here?

Is it really safe to do

```
        cdef Py_ssize_t k1,k2,k3
        cdef int offset
        k1,k2,k3,offset = r.key
        cdef Py_ssize_t h = (k1 + 13*k2 ^ 503*k3)
        PyList_GET_ITEM(buckets, (<size_t>h) % PyList_GET_SIZE(buckets))
```
?

Yes, we need to care about the sign. But we also have

```
 Py_ssize_t PyList_GET_SIZE(object list)
 PyObject* PyList_GET_ITEM(object list, Py_ssize_t i)
```
(hence, the modulus is Py_ssize_t, and the result will be translated into Py_ssize_t, too)

I am afraid I have no 32 bit machine to test.



---

archive/issue_comments_172896.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nPS: Note the discussion that we had on #715 on that matter.\n\nIs there a reason why we use ssize_t and not size_t?",
    "created_at": "2013-03-11T10:41:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172896",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">Comment 3</div>

PS: Note the discussion that we had on #715 on that matter.

Is there a reason why we use ssize_t and not size_t?



---

archive/issue_comments_172897.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nAny idea on how to debug this? The problem is that currently we have no idea where this exception is generated.",
    "created_at": "2013-03-11T10:45:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172897",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:4" align="right">Comment 4</div>

Any idea on how to debug this? The problem is that currently we have no idea where this exception is generated.



---

archive/issue_comments_172898.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nGoogle seems to tell me that one should use size_t and not ssize_t here anyway. Not sure though.\n\nNils, do you think it could help to consistently replace ssize_t and Py_ssize_t by size_t?",
    "created_at": "2013-03-11T10:46:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172898",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">Comment 5</div>

Google seems to tell me that one should use size_t and not ssize_t here anyway. Not sure though.

Nils, do you think it could help to consistently replace ssize_t and Py_ssize_t by size_t?



---

archive/issue_comments_172899.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nReplying to [@jdemeyer](#comment%3A4):\n> Any idea on how to debug this? The problem is that currently we have no idea where this exception is generated.\n\nSage's debug version?",
    "created_at": "2013-03-11T10:47:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172899",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">Comment 6</div>

Replying to [@jdemeyer](#comment%3A4):
> Any idea on how to debug this? The problem is that currently we have no idea where this exception is generated.

Sage's debug version?



---

archive/issue_comments_172900.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nReplying to [@simon-king-jena](#comment%3A2):\n> \n> ```\n>         k1,k2,k3,offset = r.key\n> ```\n\nThis line might be problematic if there is no guarantee that the components of `r.key` fit in the respective types (`Py_ssize_t`, `Py_ssize_t`, `Py_ssize_t`, `int`).",
    "created_at": "2013-03-11T10:48:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172900",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">Comment 7</div>

Replying to [@simon-king-jena](#comment%3A2):
> 
> ```
>         k1,k2,k3,offset = r.key
> ```

This line might be problematic if there is no guarantee that the components of `r.key` fit in the respective types (`Py_ssize_t`, `Py_ssize_t`, `Py_ssize_t`, `int`).



---

archive/issue_comments_172901.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nReplying to [@simon-king-jena](#comment%3A6):\n> Sage's debug version?\n\nWould it really give more information about where the exception is generated?",
    "created_at": "2013-03-11T10:49:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172901",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">Comment 8</div>

Replying to [@simon-king-jena](#comment%3A6):
> Sage's debug version?

Would it really give more information about where the exception is generated?



---

archive/issue_comments_172902.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@jdemeyer](#comment%3A8):\n> Replying to [@simon-king-jena](#comment%3A6):\n> > Sage's debug version?\n\n> Would it really give more information about where the exception is generated?\n\nI thought that this is the point of a debug version? Is there an environment variable similar to MALLOC_CHECK_ that makes the program segfault on an overflow error, so that one could then analyse the problem using gdb?",
    "created_at": "2013-03-11T10:54:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172902",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@jdemeyer](#comment%3A8):
> Replying to [@simon-king-jena](#comment%3A6):
> > Sage's debug version?

> Would it really give more information about where the exception is generated?

I thought that this is the point of a debug version? Is there an environment variable similar to MALLOC_CHECK_ that makes the program segfault on an overflow error, so that one could then analyse the problem using gdb?



---

archive/issue_comments_172903.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nHow many bytes is Py_ssize_t using? On 32-bit machines, is Py_ssize_t perhaps using more bytes than size_t? Then, the problem could be here:\n\n```\n        cdef Py_ssize_t h1 = <Py_ssize_t><void *>k1\n        cdef Py_ssize_t h2 = <Py_ssize_t><void *>k2\n        cdef Py_ssize_t h3 = <Py_ssize_t><void *>k3\n        cdef Py_ssize_t h = (h1 + 13*h2 ^ 503*h3)\n```\nWhile h1, h2, and h3 should be fine (they are obtained from a pointer and are thus using 32 bit), I could imagine that Python tries to be clever and uses more byte (long versus int) for h, if 13*h2 or 503*h3 happen to be larger than the greatest number representable by 32 bit.\n\nIf this is the case, then the line\n\n```\ncdef list bucket = <object>PyList_GET_ITEM(all_buckets, (<size_t>h) % PyList_GET_SIZE(all_buckets))\n```\n(when the \"long\" Py_ssize_t h is converted down to 32 bit of size_t) could overflow, isn't it?\n\nCaveat: I am not an expert for the subtleties of Py_ssize_t on 32 versus 64 bit...",
    "created_at": "2013-03-11T11:34:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172903",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">Comment 10</div>

How many bytes is Py_ssize_t using? On 32-bit machines, is Py_ssize_t perhaps using more bytes than size_t? Then, the problem could be here:

```
        cdef Py_ssize_t h1 = <Py_ssize_t><void *>k1
        cdef Py_ssize_t h2 = <Py_ssize_t><void *>k2
        cdef Py_ssize_t h3 = <Py_ssize_t><void *>k3
        cdef Py_ssize_t h = (h1 + 13*h2 ^ 503*h3)
```
While h1, h2, and h3 should be fine (they are obtained from a pointer and are thus using 32 bit), I could imagine that Python tries to be clever and uses more byte (long versus int) for h, if 13*h2 or 503*h3 happen to be larger than the greatest number representable by 32 bit.

If this is the case, then the line

```
cdef list bucket = <object>PyList_GET_ITEM(all_buckets, (<size_t>h) % PyList_GET_SIZE(all_buckets))
```
(when the "long" Py_ssize_t h is converted down to 32 bit of size_t) could overflow, isn't it?

Caveat: I am not an expert for the subtleties of Py_ssize_t on 32 versus 64 bit...



---

archive/issue_comments_172904.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nReplying to [@simon-king-jena](#comment%3A10):\n> How many bytes is Py_ssize_t using? On 32-bit machines, is Py_ssize_t perhaps using more bytes than size_t? Then, the problem could be here:\n> \n> ```\n>         cdef Py_ssize_t h1 = <Py_ssize_t><void *>k1\n>         cdef Py_ssize_t h2 = <Py_ssize_t><void *>k2\n>         cdef Py_ssize_t h3 = <Py_ssize_t><void *>k3\n>         cdef Py_ssize_t h = (h1 + 13*h2 ^ 503*h3)\n> ```\n> While h1, h2, and h3 should be fine (they are obtained from a pointer and are thus using 32 bit), I could imagine that Python tries to be clever and uses more byte (long versus int) for h\n\nNo, that cannot be the problem, arithmetic on pure C types (like here) doesn't use Python at all.",
    "created_at": "2013-03-11T11:41:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172904",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">Comment 11</div>

Replying to [@simon-king-jena](#comment%3A10):
> How many bytes is Py_ssize_t using? On 32-bit machines, is Py_ssize_t perhaps using more bytes than size_t? Then, the problem could be here:
> 
> ```
>         cdef Py_ssize_t h1 = <Py_ssize_t><void *>k1
>         cdef Py_ssize_t h2 = <Py_ssize_t><void *>k2
>         cdef Py_ssize_t h3 = <Py_ssize_t><void *>k3
>         cdef Py_ssize_t h = (h1 + 13*h2 ^ 503*h3)
> ```
> While h1, h2, and h3 should be fine (they are obtained from a pointer and are thus using 32 bit), I could imagine that Python tries to be clever and uses more byte (long versus int) for h

No, that cannot be the problem, arithmetic on pure C types (like here) doesn't use Python at all.



---

archive/issue_comments_172905.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nI found the following on [PEP 353](http://www.python.org/dev/peps/pep-0353/):\n\n```\nConceptually, Py_intptr_t and Py_ssize_t are different things: Py_intptr_t needs\nto be the same size as void*, and Py_ssize_t the same size as size_t. These could\ndiffer, e.g. on machines where pointers have segment and offset. On current\nflat-address space machines, there is no difference, so for all practical purposes,\nPy_intptr_t would have worked as well.\n```\nNote that we actually *do* want a conversion from and to <void*>. So, shouldn't we actually use Py_intptr_t, not Py_ssize_t?",
    "created_at": "2013-03-11T11:56:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172905",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">Comment 12</div>

I found the following on [PEP 353](http://www.python.org/dev/peps/pep-0353/):

```
Conceptually, Py_intptr_t and Py_ssize_t are different things: Py_intptr_t needs
to be the same size as void*, and Py_ssize_t the same size as size_t. These could
differ, e.g. on machines where pointers have segment and offset. On current
flat-address space machines, there is no difference, so for all practical purposes,
Py_intptr_t would have worked as well.
```
Note that we actually *do* want a conversion from and to <void*>. So, shouldn't we actually use Py_intptr_t, not Py_ssize_t?



---

archive/issue_comments_172906.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nDoes Py_intptr_t even exist in Sage? I did a grep for it, to no avail.",
    "created_at": "2013-03-11T12:20:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172906",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">Comment 13</div>

Does Py_intptr_t even exist in Sage? I did a grep for it, to no avail.



---

archive/issue_comments_172907.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@simon-king-jena](#comment%3A12):\n> I found the following on [PEP 353](http://www.python.org/dev/peps/pep-0353/):\n> \n> ```\n> Conceptually, Py_intptr_t and Py_ssize_t are different things: Py_intptr_t needs\n> to be the same size as void*, and Py_ssize_t the same size as size_t. These could\n> differ, e.g. on machines where pointers have segment and offset. On current\n> flat-address space machines, there is no difference, so for all practical purposes,\n> Py_intptr_t would have worked as well.\n> ```\n> Note that we actually *do* want a conversion from and to <void*>. So, shouldn't we actually use Py_intptr_t, not Py_ssize_t?\n\nThat's all true but it wouldn't solve this error.",
    "created_at": "2013-03-11T12:29:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172907",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@simon-king-jena](#comment%3A12):
> I found the following on [PEP 353](http://www.python.org/dev/peps/pep-0353/):
> 
> ```
> Conceptually, Py_intptr_t and Py_ssize_t are different things: Py_intptr_t needs
> to be the same size as void*, and Py_ssize_t the same size as size_t. These could
> differ, e.g. on machines where pointers have segment and offset. On current
> flat-address space machines, there is no difference, so for all practical purposes,
> Py_intptr_t would have worked as well.
> ```
> Note that we actually *do* want a conversion from and to <void*>. So, shouldn't we actually use Py_intptr_t, not Py_ssize_t?

That's all true but it wouldn't solve this error.



---

archive/issue_comments_172908.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@jdemeyer](#comment%3A14):\n> > Note that we actually *do* want a conversion from and to <void*>. So, shouldn't we actually use Py_intptr_t, not Py_ssize_t?\n\n> \n> That's all true but it wouldn't solve this error.\n\nWell, you didn't tell yet were exactly the error is located.\n\nLacking more information, my guess was that an overflow could occur on systems where `sizeof(Py_ssize_t)==sizeof(size_t)` differs from `sizeof(Py_intptr_t)==sizeof(void*)`. So, why are you sure that the problem is *not* related with conversion between size_t and pointers?",
    "created_at": "2013-03-11T12:36:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172908",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@jdemeyer](#comment%3A14):
> > Note that we actually *do* want a conversion from and to <void*>. So, shouldn't we actually use Py_intptr_t, not Py_ssize_t?

> 
> That's all true but it wouldn't solve this error.

Well, you didn't tell yet were exactly the error is located.

Lacking more information, my guess was that an overflow could occur on systems where `sizeof(Py_ssize_t)==sizeof(size_t)` differs from `sizeof(Py_intptr_t)==sizeof(void*)`. So, why are you sure that the problem is *not* related with conversion between size_t and pointers?



---

archive/issue_comments_172909.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@simon-king-jena](#comment%3A15):\n> Well, you didn't tell yet were exactly the error is located.\n\nIf I would know that, fixing the error would probably be trivial.",
    "created_at": "2013-03-11T13:29:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172909",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@simon-king-jena](#comment%3A15):
> Well, you didn't tell yet were exactly the error is located.

If I would know that, fixing the error would probably be trivial.



---

archive/issue_comments_172910.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nI see it also *all over the place* when building the docs:\n\n```\n[...]\n[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings    ] no targets are out of date.\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored\n[rings_num] no targets are out of date.\n[...]\n```",
    "created_at": "2013-03-11T13:30:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172910",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">Comment 17</div>

I see it also *all over the place* when building the docs:

```
[...]
[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings    ] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings    ] no targets are out of date.
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] Exception OverflowError: 'long int too large to convert to int' in <sage.structure.coerce_dict.TripleDictEraser object at 0x949611c> ignored
[rings_num] no targets are out of date.
[...]
```



---

archive/issue_comments_172911.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nCan you test `sizeof(Py_ssize_t)==sizeof(void*)` on those machines that exposed the error? Namely, this equality would falsify my guess.",
    "created_at": "2013-03-11T13:32:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172911",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">Comment 18</div>

Can you test `sizeof(Py_ssize_t)==sizeof(void*)` on those machines that exposed the error? Namely, this equality would falsify my guess.



---

archive/issue_comments_172912.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nReplying to [@simon-king-jena](#comment%3A15):\n> Lacking more information, my guess was that an overflow could occur on systems where `sizeof(Py_ssize_t)==sizeof(size_t)` differs from `sizeof(Py_intptr_t)==sizeof(void*)`. So, why are you sure that the problem is *not* related with conversion between size_t and pointers?\n\nThis is a typical 32-bit system where the types `int`, `long`, `size_t`, `Py_ssize_t`, `void*`, `intptr_t` are all 4 bytes.",
    "created_at": "2013-03-11T13:34:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172912",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">Comment 19</div>

Replying to [@simon-king-jena](#comment%3A15):
> Lacking more information, my guess was that an overflow could occur on systems where `sizeof(Py_ssize_t)==sizeof(size_t)` differs from `sizeof(Py_intptr_t)==sizeof(void*)`. So, why are you sure that the problem is *not* related with conversion between size_t and pointers?

This is a typical 32-bit system where the types `int`, `long`, `size_t`, `Py_ssize_t`, `void*`, `intptr_t` are all 4 bytes.



---

archive/issue_comments_172913.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">Comment 20</div>\n\nBesides, even if `void*` would be larger than `Py_ssize_t`, I still don't see how it could cause the error that we're seeing. The cast `void*` -> `Py_ssize_t` is pure C, so it couldn't overflow.",
    "created_at": "2013-03-11T13:36:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172913",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">Comment 20</div>

Besides, even if `void*` would be larger than `Py_ssize_t`, I still don't see how it could cause the error that we're seeing. The cast `void*` -> `Py_ssize_t` is pure C, so it couldn't overflow.



---

archive/issue_comments_172914.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nI am debugging building the docs, as I can reliably get the failure this way.",
    "created_at": "2013-03-11T13:37:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172914",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:21" align="right">Comment 21</div>

I am debugging building the docs, as I can reliably get the failure this way.



---

archive/issue_comments_172915.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nThe error happens in the last line here:\n\n```\n        cdef TripleDict D = <object>PyWeakref_GetObject(self.D)\n        if D is None:\n            return\n        cdef list buckets = D.buckets\n        if buckets is None:\n            return\n        # r is a (weak) reference (typically to a parent), and it knows the\n        # stored key of the unique triple r() had been part of.\n        # We remove that unique triple from self.D\n        cdef Py_ssize_t k1,k2,k3\n        k1,k2,k3 = r.key\n```",
    "created_at": "2013-03-11T13:45:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172915",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">Comment 22</div>

The error happens in the last line here:

```
        cdef TripleDict D = <object>PyWeakref_GetObject(self.D)
        if D is None:
            return
        cdef list buckets = D.buckets
        if buckets is None:
            return
        # r is a (weak) reference (typically to a parent), and it knows the
        # stored key of the unique triple r() had been part of.
        # We remove that unique triple from self.D
        cdef Py_ssize_t k1,k2,k3
        k1,k2,k3 = r.key
```



---

archive/issue_comments_172916.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">Comment 23</div>\n\nReplying to [@jdemeyer](#comment%3A22):\n> The error happens in the last line here: \n> \n> ```\n>         cdef Py_ssize_t k1,k2,k3\n>         k1,k2,k3 = r.key\n> ```\n\nInteresting. So, this would probably mean that the actual error occurs when *storing* the key. Let's see what is done there...\n\nJust out of curiosity: Does the same problem also occur with #14159 and dependencies?",
    "created_at": "2013-03-11T13:50:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172916",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">Comment 23</div>

Replying to [@jdemeyer](#comment%3A22):
> The error happens in the last line here: 
> 
> ```
>         cdef Py_ssize_t k1,k2,k3
>         k1,k2,k3 = r.key
> ```

Interesting. So, this would probably mean that the actual error occurs when *storing* the key. Let's see what is done there...

Just out of curiosity: Does the same problem also occur with #14159 and dependencies?



---

archive/issue_comments_172917.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nAha!\n\nWe have\n\n```\n        cdef size_t h1 = <size_t><void *>k1\n        cdef size_t h2 = <size_t><void *>k2\n        cdef size_t h3 = <size_t><void *>k3\n        try:\n            ref1 = KeyedRef(k1,self.eraser,(h1, h2, h3))\n        except TypeError:\n            ref1 = k1\n```\n\nHence, the three items of the key originally were size_t. But they are assigned to Py_ssize_t.",
    "created_at": "2013-03-11T13:53:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172917",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">Comment 24</div>

Aha!

We have

```
        cdef size_t h1 = <size_t><void *>k1
        cdef size_t h2 = <size_t><void *>k2
        cdef size_t h3 = <size_t><void *>k3
        try:
            ref1 = KeyedRef(k1,self.eraser,(h1, h2, h3))
        except TypeError:
            ref1 = k1
```

Hence, the three items of the key originally were size_t. But they are assigned to Py_ssize_t.



---

archive/issue_comments_172918.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nI can't find this code, where is it?",
    "created_at": "2013-03-11T13:55:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172918",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:25" align="right">Comment 25</div>

I can't find this code, where is it?



---

archive/issue_comments_172919.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">Comment 26</div>\n\nReplying to [@simon-king-jena](#comment%3A23):\n> Interesting. So, this would probably mean that the actual error occurs when *storing* the key.\n\nIndeed.\n\nAnd `r.key` does indeed take values like `k1,k2,k3 = (3043219468L, 154417500, 150140108)`, the first of which would not fit in a `Py_ssize_t`.\n\nSo the question is: where does this tuple come from?",
    "created_at": "2013-03-11T13:55:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172919",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:26" align="right">Comment 26</div>

Replying to [@simon-king-jena](#comment%3A23):
> Interesting. So, this would probably mean that the actual error occurs when *storing* the key.

Indeed.

And `r.key` does indeed take values like `k1,k2,k3 = (3043219468L, 154417500, 150140108)`, the first of which would not fit in a `Py_ssize_t`.

So the question is: where does this tuple come from?



---

archive/issue_comments_172920.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">Comment 27</div>\n\nIn sage/categories/homset.py:\n\n```\n    _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))\n```\n\n`id()` returns `<type 'int'>`. I don't know if assigning `int` to `Py_ssize_t` can be a problem.",
    "created_at": "2013-03-11T14:00:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172920",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:27" align="right">Comment 27</div>

In sage/categories/homset.py:

```
    _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))
```

`id()` returns `<type 'int'>`. I don't know if assigning `int` to `Py_ssize_t` can be a problem.



---

archive/issue_comments_172921.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">Comment 28</div>\n\nReplying to [@jdemeyer](#comment%3A26):\n> And `r.key` does indeed take values like `k1,k2,k3 = (3043219468L, 154417500, 150140108)`, the first of which would not fit in a `Py_ssize_t`.\n> \n> So the question is: where does this tuple come from?\n\nThere are (as much as I know) only the two places that I mentioned (by the way, #14159 would change it).\n\nIs `size_t-->Py_ssize_t` a potential problem? Or is `id(...)-->Py_ssize_t` a potential problem?",
    "created_at": "2013-03-11T14:05:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172921",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:28" align="right">Comment 28</div>

Replying to [@jdemeyer](#comment%3A26):
> And `r.key` does indeed take values like `k1,k2,k3 = (3043219468L, 154417500, 150140108)`, the first of which would not fit in a `Py_ssize_t`.
> 
> So the question is: where does this tuple come from?

There are (as much as I know) only the two places that I mentioned (by the way, #14159 would change it).

Is `size_t-->Py_ssize_t` a potential problem? Or is `id(...)-->Py_ssize_t` a potential problem?



---

archive/issue_comments_172922.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">Comment 29</div>\n\nReplying to [@simon-king-jena](#comment%3A27):\n> In sage/categories/homset.py:\n> \n> ```\n>     _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))\n> ```\n> \n> `id()` returns `<type 'int'>`. I don't know if assigning `int` to `Py_ssize_t` can be a problem.\n\nBingo!  That's the problem indeed.",
    "created_at": "2013-03-11T14:14:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172922",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:29" align="right">Comment 29</div>

Replying to [@simon-king-jena](#comment%3A27):
> In sage/categories/homset.py:
> 
> ```
>     _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))
> ```
> 
> `id()` returns `<type 'int'>`. I don't know if assigning `int` to `Py_ssize_t` can be a problem.

Bingo!  That's the problem indeed.



---

archive/issue_comments_172923.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">Comment 30</div>\n\nReplying to [@jdemeyer](#comment%3A29):\n> Replying to [@simon-king-jena](#comment%3A27):\n> > In sage/categories/homset.py:\n> > \n> > ```\n> >     _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))\n> > ```\n> > \n> > `id()` returns `<type 'int'>`. I don't know if assigning `int` to `Py_ssize_t` can be a problem.\n\n> Bingo!  That's the problem indeed.\n\nOK. Then it is solved in #14159, I suppose.",
    "created_at": "2013-03-11T14:17:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172923",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:30" align="right">Comment 30</div>

Replying to [@jdemeyer](#comment%3A29):
> Replying to [@simon-king-jena](#comment%3A27):
> > In sage/categories/homset.py:
> > 
> > ```
> >     _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))
> > ```
> > 
> > `id()` returns `<type 'int'>`. I don't know if assigning `int` to `Py_ssize_t` can be a problem.

> Bingo!  That's the problem indeed.

OK. Then it is solved in #14159, I suppose.



---

archive/issue_comments_172924.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">Comment 31</div>\n\nBut I would really like a quick fix independently of #14159. Then this quick fix here could be merged in sage-5.8.rc0 while #14159 wouldn't. Would you mind if I create a patch?",
    "created_at": "2013-03-11T14:21:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172924",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:31" align="right">Comment 31</div>

But I would really like a quick fix independently of #14159. Then this quick fix here could be merged in sage-5.8.rc0 while #14159 wouldn't. Would you mind if I create a patch?



---

archive/issue_comments_172925.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">Comment 32</div>\n\nReplying to [@jdemeyer](#comment%3A31):\n> But I would really like a quick fix independently of #14159. Then this quick fix here could be merged in sage-5.8.rc0 while #14159 wouldn't. Would you mind if I create a patch?\n\nNo, I wouldn't mind (rebasing #14159 should be easy enough).\n\nBut how can one change the id() thingy in sage/categories/homset.py? After all, it is a Python file, hence, one can not just do `<size_t><void*>X`.",
    "created_at": "2013-03-11T14:23:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172925",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:32" align="right">Comment 32</div>

Replying to [@jdemeyer](#comment%3A31):
> But I would really like a quick fix independently of #14159. Then this quick fix here could be merged in sage-5.8.rc0 while #14159 wouldn't. Would you mind if I create a patch?

No, I wouldn't mind (rebasing #14159 should be easy enough).

But how can one change the id() thingy in sage/categories/homset.py? After all, it is a Python file, hence, one can not just do `<size_t><void*>X`.



---

archive/issue_comments_172926.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">Comment 33</div>\n\nReplying to [@simon-king-jena](#comment%3A32):\n> But how can one change the id() thingy in sage/categories/homset.py? After all, it is a Python file, hence, one can not just do `<size_t><void*>X`.\n\nYou can't, but you could write a small function to do just this in `coerce_dict.pyx` for example.",
    "created_at": "2013-03-11T14:24:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172926",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:33" align="right">Comment 33</div>

Replying to [@simon-king-jena](#comment%3A32):
> But how can one change the id() thingy in sage/categories/homset.py? After all, it is a Python file, hence, one can not just do `<size_t><void*>X`.

You can't, but you could write a small function to do just this in `coerce_dict.pyx` for example.



---

archive/issue_comments_172927.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2013-03-11T14:57:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172927",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_events_184295.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-11T14:57:20Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184295"
}
```



---

archive/issue_comments_172928.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">Comment 34</div>\n\nAttachment: **[14254_signed_id.patch.gz](https://github.com/sagemath/sage/files/ticket14254/14254_signed_id.patch.gz)**",
    "created_at": "2013-03-11T14:57:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172928",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">Comment 34</div>

Attachment: **[14254_signed_id.patch.gz](https://github.com/sagemath/sage/files/ticket14254/14254_signed_id.patch.gz)**



---

archive/issue_comments_172929.json:
```json
{
    "body": "Dependencies: **#13387**",
    "created_at": "2013-03-11T15:12:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172929",
    "user": "https://github.com/simon-king-jena"
}
```

Dependencies: **#13387**



---

archive/issue_comments_172930.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">Comment 36</div>\n\nThe patch looks fine to me, and it applies cleanly after #13387. Now I wonder what the patchbots have to tell.\n\nProblem: I have no 32-bit machine available. Will the machines on which you first noticed the problem report here, in the hopefully green) blob?",
    "created_at": "2013-03-11T15:17:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172930",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:36" align="right">Comment 36</div>

The patch looks fine to me, and it applies cleanly after #13387. Now I wonder what the patchbots have to tell.

Problem: I have no 32-bit machine available. Will the machines on which you first noticed the problem report here, in the hopefully green) blob?



---

archive/issue_comments_172931.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">Comment 37</div>\n\nReplying to [@simon-king-jena](#comment%3A36):\n> Will the machines on which you first noticed the problem report here, in the (hopefully green) blob?\n\nI don't think so.\n\nIn any case, the machine in question managed to build the documentation without errors, so that's a good sign. I'm running tests now, but it's a slow machine so I'll report back tomorrow.\n\nRegardless, I think you can review the patch without access to a 32-bit system and assume that I have done my duty in testing the patch.",
    "created_at": "2013-03-11T15:41:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172931",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:37" align="right">Comment 37</div>

Replying to [@simon-king-jena](#comment%3A36):
> Will the machines on which you first noticed the problem report here, in the (hopefully green) blob?

I don't think so.

In any case, the machine in question managed to build the documentation without errors, so that's a good sign. I'm running tests now, but it's a slow machine so I'll report back tomorrow.

Regardless, I think you can review the patch without access to a 32-bit system and assume that I have done my duty in testing the patch.



---

archive/issue_comments_172932.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">Comment 38</div>\n\nReplying to [@simon-king-jena](#comment%3A30):\n> > \n> > ```\n> > _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))\n> > ```\n> > Bingo!  That's the problem indeed.\n\n> OK. Then it is solved in #14159, I suppose.\n\nGood work guys! That line made me feel uncomfortable when I was reviewing it, because it was reaching into implementation details of `_cache.eraser` and indeed, it *wasn't* properly doing that, in a way I did not spot. This is even more confirmation that #14159 is the right solution and not just over-engineering.",
    "created_at": "2013-03-11T16:19:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172932",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:38" align="right">Comment 38</div>

Replying to [@simon-king-jena](#comment%3A30):
> > 
> > ```
> > _cache[key] = KeyedRef(H, _cache.eraser, (id(X),id(Y),id(category)))
> > ```
> > Bingo!  That's the problem indeed.

> OK. Then it is solved in #14159, I suppose.

Good work guys! That line made me feel uncomfortable when I was reviewing it, because it was reaching into implementation details of `_cache.eraser` and indeed, it *wasn't* properly doing that, in a way I did not spot. This is even more confirmation that #14159 is the right solution and not just over-engineering.



---

archive/issue_comments_172933.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">Comment 39</div>\n\nOK, I believe Jeroen when he says that building the documentation on his 32-bit systems works with the patch, while it reproducibly failed without the patch.\n\nI think the solution makes sense: id(X) returns a positive number, and this may very well be beyond what a signed number type of the same size (such as Py_ssize_t) can take.\n\nThe patchbot gives a green blob, too. Hence, I hope it is safe to give this a positive review (but I think #14159 will be better, on the long run).",
    "created_at": "2013-03-11T16:31:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172933",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:39" align="right">Comment 39</div>

OK, I believe Jeroen when he says that building the documentation on his 32-bit systems works with the patch, while it reproducibly failed without the patch.

I think the solution makes sense: id(X) returns a positive number, and this may very well be beyond what a signed number type of the same size (such as Py_ssize_t) can take.

The patchbot gives a green blob, too. Hence, I hope it is safe to give this a positive review (but I think #14159 will be better, on the long run).



---

archive/issue_comments_172934.json:
```json
{
    "body": "Reviewer: **SimonKing**",
    "created_at": "2013-03-11T16:31:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172934",
    "user": "https://github.com/simon-king-jena"
}
```

Reviewer: **SimonKing**



---

archive/issue_events_184296.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-03-11T16:31:46Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184296"
}
```



---

archive/issue_events_184297.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-03-11T16:31:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184297"
}
```



---

archive/issue_comments_172935.json:
```json
{
    "body": "Changed reviewer from **SimonKing** to **Simon King**",
    "created_at": "2013-03-13T10:51:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172935",
    "user": "https://github.com/jdemeyer"
}
```

Changed reviewer from **SimonKing** to **Simon King**



---

archive/issue_events_184298.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-13T10:51:42Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184298"
}
```



---

archive/issue_events_184299.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-13T10:51:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14254#event-184299"
}
```



---

archive/issue_comments_172936.json:
```json
{
    "body": "Merged: **sage-5.8.rc0**",
    "created_at": "2013-03-13T10:51:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14254",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14254#issuecomment-172936",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.8.rc0**
