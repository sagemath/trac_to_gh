# Issue 14228: Caching of data needed for computations in k_dual

archive/issues_014024.json:
```json
{
    "body": "#12313 brought a severe slow-down to sage.combinat.sf.k_dual. The purpose of task #13991 is to mitigate this. The purpose of this ticket is to deal with one aspect of the slow-down.\n\nCertain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.\n\nApply\n\n- [attachment:trac_14228-sym_speedup-ts.patch]\n- [attachment:trac_14228-reviewer.patch]\n\nAssignee: sage-combinat\n\nCC:  sage-combinat @tscrim @nthiery @nbruin @zabrocki\n\nReviewer: Simon King\n\nAuthor: Travis Scrimshaw\n\nMerged: sage-5.8.beta4\n\nDependencies: #13605, #14225\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14228\n\n",
    "closed_at": "2013-03-07T18:26:48Z",
    "created_at": "2013-03-05T12:43:59Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.8",
    "title": "Caching of data needed for computations in k_dual",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14228",
    "user": "https://github.com/simon-king-jena"
}
```
#12313 brought a severe slow-down to sage.combinat.sf.k_dual. The purpose of task #13991 is to mitigate this. The purpose of this ticket is to deal with one aspect of the slow-down.

Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.

Apply

- [attachment:trac_14228-sym_speedup-ts.patch]
- [attachment:trac_14228-reviewer.patch]

Assignee: sage-combinat

CC:  sage-combinat @tscrim @nthiery @nbruin @zabrocki

Reviewer: Simon King

Author: Travis Scrimshaw

Merged: sage-5.8.beta4

Dependencies: #13605, #14225

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/14228





---

archive/issue_comments_218749.json:
```json
{
    "body": "<a id='comment:1'></a>Attachment [trac_14288-partition_caches.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14288-partition_caches.patch) by @simon-king-jena created at 2013-03-05 12:48:06",
    "created_at": "2013-03-05T12:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218749",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:1'></a>Attachment [trac_14288-partition_caches.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14288-partition_caches.patch) by @simon-king-jena created at 2013-03-05 12:48:06



---

archive/issue_comments_218750.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-03-05T12:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218750",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_218751.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#13605\"",
    "created_at": "2013-03-05T12:48:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218751",
    "user": "https://github.com/simon-king-jena"
}
```

Changing dependencies from "" to "#13605"



---

archive/issue_comments_218752.json:
```json
{
    "body": "Attachment [trac_14228-partition_caches.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14228-partition_caches.patch) by @simon-king-jena created at 2013-03-05 12:50:41\n\nDisregard the first patch, it has a wrong ticket number.",
    "created_at": "2013-03-05T12:50:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218752",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac_14228-partition_caches.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14228-partition_caches.patch) by @simon-king-jena created at 2013-03-05 12:50:41

Disregard the first patch, it has a wrong ticket number.



---

archive/issue_comments_218753.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n #12313 brought a severe slow-down to sage.combinat.sf.k_dual. The purpose of task #13991 is to mitigate this. The purpose of this ticket is to deal with one aspect of the slow-down.\n \n Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.\n+\n+Apply [attachment:trac_14228-partition_caches.patch]\n``````\n",
    "created_at": "2013-03-05T12:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218753",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 #12313 brought a severe slow-down to sage.combinat.sf.k_dual. The purpose of task #13991 is to mitigate this. The purpose of this ticket is to deal with one aspect of the slow-down.
 
 Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.
+
+Apply [attachment:trac_14228-partition_caches.patch]
``````




---

archive/issue_comments_218754.json:
```json
{
    "body": "<a id='comment:2'></a>Sorry for the \"wrong\" patch name.\n\nApply trac_14228-partition_caches.patch",
    "created_at": "2013-03-05T12:51:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218754",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:2'></a>Sorry for the "wrong" patch name.

Apply trac_14228-partition_caches.patch



---

archive/issue_comments_218755.json:
```json
{
    "body": "<a id='comment:3'></a>I'm wondering how much of a speedup we'd get if we made `IntegerListsLex` a cached representation (currently it takes lambda functions as arguments which makes it impossible to hash).\n\n```\nsage: P = Partitions(4, max_part=2)\nsage: P\nPartitions of the integer 4 satisfying constraints max_part=2\nsage: type(P)\nsage.combinat.integer_list.IntegerListsLex_with_category\nsage: P is Partitions(4, max_part=2)\nFalse\n```\nSo we alternatively want to make a new partitions parent specifically for this which just wraps the iterator given by `IntegerListsLex`...\n\nI also restructured it slightly by creating an abstract base class for the actual bases for easier maintenance.\n\nAnyways, I've attached my patch.",
    "created_at": "2013-03-05T13:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218755",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:3'></a>I'm wondering how much of a speedup we'd get if we made `IntegerListsLex` a cached representation (currently it takes lambda functions as arguments which makes it impossible to hash).

```
sage: P = Partitions(4, max_part=2)
sage: P
Partitions of the integer 4 satisfying constraints max_part=2
sage: type(P)
sage.combinat.integer_list.IntegerListsLex_with_category
sage: P is Partitions(4, max_part=2)
False
```
So we alternatively want to make a new partitions parent specifically for this which just wraps the iterator given by `IntegerListsLex`...

I also restructured it slightly by creating an abstract base class for the actual bases for easier maintenance.

Anyways, I've attached my patch.



---

archive/issue_comments_218756.json:
```json
{
    "body": "Changing author from \"Simon King\" to \"Simon King Travis Scrimshaw\"",
    "created_at": "2013-03-05T13:12:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218756",
    "user": "https://github.com/tscrim"
}
```

Changing author from "Simon King" to "Simon King Travis Scrimshaw"



---

archive/issue_comments_218757.json:
```json
{
    "body": "Changing dependencies from \"#13605\" to \"#13605, #14225\"",
    "created_at": "2013-03-05T13:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218757",
    "user": "https://github.com/simon-king-jena"
}
```

Changing dependencies from "#13605" to "#13605, #14225"



---

archive/issue_comments_218758.json:
```json
{
    "body": "<a id='comment:4'></a>There is one hunk of my patch that only applies with #14225. Hence, new dependency.",
    "created_at": "2013-03-05T13:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218758",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:4'></a>There is one hunk of my patch that only applies with #14225. Hence, new dependency.



---

archive/issue_comments_218759.json:
```json
{
    "body": "<a id='comment:5'></a>Wow. You made a major restructuring of code. It will be difficult to merge the two approaches.",
    "created_at": "2013-03-05T13:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218759",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>Wow. You made a major restructuring of code. It will be difficult to merge the two approaches.



---

archive/issue_comments_218760.json:
```json
{
    "body": "<a id='comment:6'></a>There was one failing doctest in the first version of my patch. Because of the structural changes, the error thrown is changed (although it fundamentally is the same error).",
    "created_at": "2013-03-05T13:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218760",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>There was one failing doctest in the first version of my patch. Because of the structural changes, the error thrown is changed (although it fundamentally is the same error).



---

archive/issue_comments_218761.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [SimonKing](#comment%3A5):\n> Wow. You made a major restructuring of code. It will be difficult to merge the two approaches.\n\n\nThe big thing that I did was pulled out the common code for the bases into an ABC. It looks scarier than it is. I also avoided calling `Partition()` directly in case what was being passed in was a list, in which case it should be slower than constructing an element from the appropriate parent. Although it's faster if we are passing in a `Partition` object, but this might be a marginal speed change... I'll do some investigating to see what's being passed around.\n\nI can handle the merging.",
    "created_at": "2013-03-05T13:25:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218761",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:7'></a>Replying to [SimonKing](#comment%3A5):
> Wow. You made a major restructuring of code. It will be difficult to merge the two approaches.


The big thing that I did was pulled out the common code for the bases into an ABC. It looks scarier than it is. I also avoided calling `Partition()` directly in case what was being passed in was a list, in which case it should be slower than constructing an element from the appropriate parent. Although it's faster if we are passing in a `Partition` object, but this might be a marginal speed change... I'll do some investigating to see what's being passed around.

I can handle the merging.



---

archive/issue_comments_218762.json:
```json
{
    "body": "<a id='comment:8'></a>Arrgh. I tried to post this twice, but trac didn't accept because you posted too. A minute later, trac didn't seem to accept posts at all. Let's try again.\n\nSome timings:\n\n- With #13605 and #14225:\n  {{{\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))\nsage: %time TestSuite(F).run()\nCPU times: user 11.17 s, sys: 0.09 s, total: 11.26 s\nWall time: 11.42 s\nsage: %time TestSuite(F).run()\nCPU times: user 9.80 s, sys: 0.09 s, total: 9.89 s\nWall time: 9.93 s\n  }}}\n- With #13605 and #14225 and [attachment:trac_14228-sym_speedup-ts.patch]\n  {{{\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))\nsage: %time TestSuite(F).run()\nCPU times: user 9.14 s, sys: 0.04 s, total: 9.18 s\nWall time: 9.19 s\nsage: %time TestSuite(F).run()\nCPU times: user 7.05 s, sys: 0.02 s, total: 7.08 s\nWall time: 7.08 s\n  }}}\n- With #13605 and #14225 and [attachment:trac_14228-partition_caches.patch]:\n  {{{\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))\nsage: %time TestSuite(F).run()\nCPU times: user 5.94 s, sys: 0.04 s, total: 5.98 s\nWall time: 6.09 s\nsage: %time TestSuite(F).run()\nCPU times: user 3.49 s, sys: 0.03 s, total: 3.52 s\nWall time: 3.52 s\n  }}}\n\nUnfortunately, our two patches are incompatible. How to get the best of both worlds?",
    "created_at": "2013-03-05T13:28:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218762",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>Arrgh. I tried to post this twice, but trac didn't accept because you posted too. A minute later, trac didn't seem to accept posts at all. Let's try again.

Some timings:

- With #13605 and #14225:
  {{{
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))
sage: %time TestSuite(F).run()
CPU times: user 11.17 s, sys: 0.09 s, total: 11.26 s
Wall time: 11.42 s
sage: %time TestSuite(F).run()
CPU times: user 9.80 s, sys: 0.09 s, total: 9.89 s
Wall time: 9.93 s
  }}}
- With #13605 and #14225 and [attachment:trac_14228-sym_speedup-ts.patch]
  {{{
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))
sage: %time TestSuite(F).run()
CPU times: user 9.14 s, sys: 0.04 s, total: 9.18 s
Wall time: 9.19 s
sage: %time TestSuite(F).run()
CPU times: user 7.05 s, sys: 0.02 s, total: 7.08 s
Wall time: 7.08 s
  }}}
- With #13605 and #14225 and [attachment:trac_14228-partition_caches.patch]:
  {{{
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))
sage: %time TestSuite(F).run()
CPU times: user 5.94 s, sys: 0.04 s, total: 5.98 s
Wall time: 6.09 s
sage: %time TestSuite(F).run()
CPU times: user 3.49 s, sys: 0.03 s, total: 3.52 s
Wall time: 3.52 s
  }}}

Unfortunately, our two patches are incompatible. How to get the best of both worlds?



---

archive/issue_comments_218763.json:
```json
{
    "body": "<a id='comment:9'></a>Replying to [tscrim](#comment%3A7):\n> Replying to [SimonKing](#comment%3A5):\n> > Wow. You made a major restructuring of code. It will be difficult to merge the two approaches.\n  \n> \n> The big thing that I did was pulled out the common code for the bases into an ABC. It looks scarier than it is. I also avoided calling `Partition()` directly in case what was being passed in was a list, in which case it should be slower than constructing an element from the appropriate parent. Although it's faster if we are passing in a `Partition` object, but this might be a marginal speed change... I'll do some investigating to see what's being passed around.\n> \n> I can handle the merging.\n\n\nGreat, thank you. Looking at your patch, it seems that your code includes parts of the changes that I suggested (but differently in the case of the Weyl group), and I think other parts of my code (namely the cached method _Partitions) make sense to be used in your patch, too.",
    "created_at": "2013-03-05T13:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218763",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>Replying to [tscrim](#comment%3A7):
> Replying to [SimonKing](#comment%3A5):
> > Wow. You made a major restructuring of code. It will be difficult to merge the two approaches.
  
> 
> The big thing that I did was pulled out the common code for the bases into an ABC. It looks scarier than it is. I also avoided calling `Partition()` directly in case what was being passed in was a list, in which case it should be slower than constructing an element from the appropriate parent. Although it's faster if we are passing in a `Partition` object, but this might be a marginal speed change... I'll do some investigating to see what's being passed around.
> 
> I can handle the merging.


Great, thank you. Looking at your patch, it seems that your code includes parts of the changes that I suggested (but differently in the case of the Weyl group), and I think other parts of my code (namely the cached method _Partitions) make sense to be used in your patch, too.



---

archive/issue_comments_218764.json:
```json
{
    "body": "<a id='comment:10'></a>I'll let you know what happens some of my other possible speedups as well. Expect something within a few hours.",
    "created_at": "2013-03-05T13:40:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218764",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>I'll let you know what happens some of my other possible speedups as well. Expect something within a few hours.



---

archive/issue_comments_218765.json:
```json
{
    "body": "<a id='comment:11'></a>Okay, I've merged the patches (I didn't incorperate the Weyl group) and made `IntegerListsLex` a cached representation (this was desirable anyways). However I realized that `PartitionsGreatestLE` does exactly what `Partitions(n, max_part=k)` does except it already is a unique representation, so I'm using that instead. I saw a very small difference between caching this in a function and just explicitly calling this, but I feel safer not having this be strongly cached (however feel free to ignore my opinion as I'm not a python/sage memory expert).\n\nHere's some data. Without patch (with #14225):\n\n```\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(4,>\nsage: %time TestSuite(F).run()\nCPU times: user 7.79 s, sys: 0.22 s, total: 8.01 s\nWall time: 8.39 s\nsage: %time TestSuite(F).run()\nCPU times: user 4.82 s, sys: 0.04 s, total: 4.86 s\nWall time: 5.07 s\n```\nWith:\n\n```\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(4,>\nsage: %time TestSuite(F).run()\nCPU times: user 7.17 s, sys: 0.09 s, total: 7.26 s\nWall time: 7.52 s\nsage: %time TestSuite(F).run()\nCPU times: user 4.26 s, sys: 0.03 s, total: 4.29 s\nWall time: 4.58 s\n```\n\nEdit - I still have not been able to see the approx 2x speedup that you got with just your patch, so I'm still doing something relatively slow...",
    "created_at": "2013-03-05T16:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218765",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>Okay, I've merged the patches (I didn't incorperate the Weyl group) and made `IntegerListsLex` a cached representation (this was desirable anyways). However I realized that `PartitionsGreatestLE` does exactly what `Partitions(n, max_part=k)` does except it already is a unique representation, so I'm using that instead. I saw a very small difference between caching this in a function and just explicitly calling this, but I feel safer not having this be strongly cached (however feel free to ignore my opinion as I'm not a python/sage memory expert).

Here's some data. Without patch (with #14225):

```
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(4,>
sage: %time TestSuite(F).run()
CPU times: user 7.79 s, sys: 0.22 s, total: 8.01 s
Wall time: 8.39 s
sage: %time TestSuite(F).run()
CPU times: user 4.82 s, sys: 0.04 s, total: 4.86 s
Wall time: 5.07 s
```
With:

```
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(4,>
sage: %time TestSuite(F).run()
CPU times: user 7.17 s, sys: 0.09 s, total: 7.26 s
Wall time: 7.52 s
sage: %time TestSuite(F).run()
CPU times: user 4.26 s, sys: 0.03 s, total: 4.29 s
Wall time: 4.58 s
```

Edit - I still have not been able to see the approx 2x speedup that you got with just your patch, so I'm still doing something relatively slow...



---

archive/issue_comments_218766.json:
```json
{
    "body": "Changing author from \"Simon King Travis Scrimshaw\" to \"Simon King, Travis Scrimshaw\"",
    "created_at": "2013-03-05T16:28:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218766",
    "user": "https://github.com/tscrim"
}
```

Changing author from "Simon King Travis Scrimshaw" to "Simon King, Travis Scrimshaw"



---

archive/issue_comments_218767.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [tscrim](#comment%3A11):\n> ... but I feel safer not having this be strongly cached...\n> ...\n> Edit - I still have not been able to see the approx 2x speedup that you got with just your patch, ...\n\n\nI suppose that's why...\n\n`UniqueRepresentation` is weakly cached. Hence, if you call the same Partitions, Weyl groups or permutation groups, you will get different instances, unless you keep a strong reference. Since the same Partitions (and Weyl groups or permutation groups, too) occur in *different* methods, it won't help to keep the reference inside of a method. Instead, one needs a cache that is shared by the methods.\n\nIt would probably be bad to have a global cache. That's why in my patch I suggested to have the cache local to the parent that uses the data. In that way, the data can still be garbage collected (it is *not* a global cache!), as soon as the parent using the data is done.\n\nIt seems to me that we will not get up to speed, unless we cache the few partitions that are local to these k-bounded thingies.",
    "created_at": "2013-03-05T17:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218767",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:12'></a>Replying to [tscrim](#comment%3A11):
> ... but I feel safer not having this be strongly cached...
> ...
> Edit - I still have not been able to see the approx 2x speedup that you got with just your patch, ...


I suppose that's why...

`UniqueRepresentation` is weakly cached. Hence, if you call the same Partitions, Weyl groups or permutation groups, you will get different instances, unless you keep a strong reference. Since the same Partitions (and Weyl groups or permutation groups, too) occur in *different* methods, it won't help to keep the reference inside of a method. Instead, one needs a cache that is shared by the methods.

It would probably be bad to have a global cache. That's why in my patch I suggested to have the cache local to the parent that uses the data. In that way, the data can still be garbage collected (it is *not* a global cache!), as soon as the parent using the data is done.

It seems to me that we will not get up to speed, unless we cache the few partitions that are local to these k-bounded thingies.



---

archive/issue_comments_218768.json:
```json
{
    "body": "<a id='comment:13'></a>Your patch seems to perform quite well:\n\n```\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))\nsage: %time TestSuite(F).run()\nCPU times: user 5.78 s, sys: 0.12 s, total: 5.90 s\nWall time: 5.92 s\nsage: %time TestSuite(F).run()\nCPU times: user 3.18 s, sys: 0.03 s, total: 3.21 s\nWall time: 3.22 s\n```\nwith\n\n```\ntrac11490-coercion_tutorial.patch\n14182_whitespace.patch\ntrac_13618-rings_doc_real-ts.patch\ntrac_13618-rings_doc_complex-ts.patch\ntrac_13618-rings_doc_others-ts.patch\ntrac_14040_housekeeping.patch\ntrac_14040_repr_option.patch\ntrac_14040_doctest.patch\ntrac_14040_review.patch\ntrac14054_fast_methods-5.8.patch\ntrac_12313-mono_dict-combined-random-sk.patch\ntrac_13387-combined.patch\ntrac_13387-guard_gc.patch\ntrac_14159_weak_value_triple_dict.patch\ntrac_14159_use_cdef_get.patch\ntrac12951_cached_extension.patch\ntrac_14214-cython_homset.patch\ntrac_14214-backup_cache.patch\ntrac_14063-remove_cc_compositions-ts.patch\ntrac_13688-finite_sets_cardinality_override-ts.patch\ntrac_14138.patch\ntrac_14138-doctests.patch\ntrac_13605-partition_options-ts.patch\ntrac_14011-Sphinx_roles-fh.patch\ntrac_14054-fix-rigged-list.2.patch\ntrac_11410-zero_one_sequence_partitions-pod.v2.patch\ntrac_11410-zero_one_sequence_partitions-review-ts.patch\ntrac_14225-partition_classcall_private.patch\ntrac_14228-sym_speedup-ts.patch\n```\n\nLet's see if caching the few permutations gives us yet some more speed.",
    "created_at": "2013-03-05T17:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218768",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>Your patch seems to perform quite well:

```
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))
sage: %time TestSuite(F).run()
CPU times: user 5.78 s, sys: 0.12 s, total: 5.90 s
Wall time: 5.92 s
sage: %time TestSuite(F).run()
CPU times: user 3.18 s, sys: 0.03 s, total: 3.21 s
Wall time: 3.22 s
```
with

```
trac11490-coercion_tutorial.patch
14182_whitespace.patch
trac_13618-rings_doc_real-ts.patch
trac_13618-rings_doc_complex-ts.patch
trac_13618-rings_doc_others-ts.patch
trac_14040_housekeeping.patch
trac_14040_repr_option.patch
trac_14040_doctest.patch
trac_14040_review.patch
trac14054_fast_methods-5.8.patch
trac_12313-mono_dict-combined-random-sk.patch
trac_13387-combined.patch
trac_13387-guard_gc.patch
trac_14159_weak_value_triple_dict.patch
trac_14159_use_cdef_get.patch
trac12951_cached_extension.patch
trac_14214-cython_homset.patch
trac_14214-backup_cache.patch
trac_14063-remove_cc_compositions-ts.patch
trac_13688-finite_sets_cardinality_override-ts.patch
trac_14138.patch
trac_14138-doctests.patch
trac_13605-partition_options-ts.patch
trac_14011-Sphinx_roles-fh.patch
trac_14054-fix-rigged-list.2.patch
trac_11410-zero_one_sequence_partitions-pod.v2.patch
trac_11410-zero_one_sequence_partitions-review-ts.patch
trac_14225-partition_classcall_private.patch
trac_14228-sym_speedup-ts.patch
```

Let's see if caching the few permutations gives us yet some more speed.



---

archive/issue_comments_218769.json:
```json
{
    "body": "<a id='comment:14'></a>Question about your merged patch: In partition.py, you've put a cached_method in front of one of the two young_subgroup methods and one of the two young_soubgroup_generator methods.\n\nWas that intended? I thought it would be better to keep a pointer to the resulting permutation groups, not to some lists.",
    "created_at": "2013-03-05T17:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218769",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:14'></a>Question about your merged patch: In partition.py, you've put a cached_method in front of one of the two young_subgroup methods and one of the two young_soubgroup_generator methods.

Was that intended? I thought it would be better to keep a pointer to the resulting permutation groups, not to some lists.



---

archive/issue_comments_218770.json:
```json
{
    "body": "<a id='comment:15'></a>I tried with the cached method in the parent as well and got approximately the same timings:\n\n```\nsage: %time TestSuite(F).run()\nCPU times: user 7.23 s, sys: 0.10 s, total: 7.33 s\nWall time: 7.46 s\nsage: %time TestSuite(F).run()\nCPU times: user 4.38 s, sys: 0.01 s, total: 4.40 s\nWall time: 4.63 s\n```\nHmm...strange we're getting such different timings. I'm running `5.8.beta1` with the following patches:\n\n```\ntrac_14040_doctest.patch\ntrac_14040_housekeeping.patch\ntrac_14040_repr_option.patch\ntrac_14040_review.patch\ntrac_14085-root_system-ambient_spaces-nt.patch\ntrac_14000.patch\ntrac_14000-doctests.patch\ntrac_14174-coxeter_matrix-type_H.patch\ntrac_14063-remove_cc_compositions-ts.patch\ntrac_8920-alphabet.patch\ntrac_7886_conjugacy_classes_combined.patch\ntrac_7886-conjugacy_classes-review-ts.patch\ntrac_14177-graph-color_by_labels-nt.patch\ntrac_14176-polyhedrons-operators-nt.patch\n14182_whitespace.patch\ntrac_14130-gyw-bs.patch\ntrac_13605-partition_options-ts.patch\ntrac_14111-qsym_tutorial-sb.patch\ntrac_14111-qsym_tutorial-review-ts.patch\ntrac_12543-import_statements-vd.patch\ntrac14054_fast_methods-5.8.patch\ntrac_14054-fix-rigged-list.2.patch\ntrac_2023-dynkin_graphs-ts.patch\ntrac_11410-zero_one_sequence_partitions-pod.v2.patch\ntrac_11410-zero_one_sequence_partitions-review-ts.patch\ntrac_14225-partition_classcall_private.patch\ntrac_14228-sym_speedup-ts.patch\n```\n\nI thought that's what your patch did. Whoops! I'll change it on the next version. There's still a few more things I want to try.",
    "created_at": "2013-03-05T17:26:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218770",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>I tried with the cached method in the parent as well and got approximately the same timings:

```
sage: %time TestSuite(F).run()
CPU times: user 7.23 s, sys: 0.10 s, total: 7.33 s
Wall time: 7.46 s
sage: %time TestSuite(F).run()
CPU times: user 4.38 s, sys: 0.01 s, total: 4.40 s
Wall time: 4.63 s
```
Hmm...strange we're getting such different timings. I'm running `5.8.beta1` with the following patches:

```
trac_14040_doctest.patch
trac_14040_housekeeping.patch
trac_14040_repr_option.patch
trac_14040_review.patch
trac_14085-root_system-ambient_spaces-nt.patch
trac_14000.patch
trac_14000-doctests.patch
trac_14174-coxeter_matrix-type_H.patch
trac_14063-remove_cc_compositions-ts.patch
trac_8920-alphabet.patch
trac_7886_conjugacy_classes_combined.patch
trac_7886-conjugacy_classes-review-ts.patch
trac_14177-graph-color_by_labels-nt.patch
trac_14176-polyhedrons-operators-nt.patch
14182_whitespace.patch
trac_14130-gyw-bs.patch
trac_13605-partition_options-ts.patch
trac_14111-qsym_tutorial-sb.patch
trac_14111-qsym_tutorial-review-ts.patch
trac_12543-import_statements-vd.patch
trac14054_fast_methods-5.8.patch
trac_14054-fix-rigged-list.2.patch
trac_2023-dynkin_graphs-ts.patch
trac_11410-zero_one_sequence_partitions-pod.v2.patch
trac_11410-zero_one_sequence_partitions-review-ts.patch
trac_14225-partition_classcall_private.patch
trac_14228-sym_speedup-ts.patch
```

I thought that's what your patch did. Whoops! I'll change it on the next version. There's still a few more things I want to try.



---

archive/issue_comments_218771.json:
```json
{
    "body": "<a id='comment:16'></a>Did you do tests with your patch?\n\nI get errors such as\n\n```\n    Traceback (most recent call last):\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[17]>\", line 1, in <module>\n        Partitions(Integer(4), outer=[Integer(3),Integer(1),Integer(1)]).list()###line 138:\n    sage: Partitions(4, outer=[3,1,1]).list()\n      File \"classcall_metaclass.pyx\", line 279, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:932)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python/site-packages/sage/combinat/partition.py\", line 4006, in __classcall_private__\n        return IntegerListsLex(n, **kwargs)\n      File \"classcall_metaclass.pyx\", line 279, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:932)\n      File \"cachefunc.pyx\", line 991, in sage.misc.cachefunc.WeakCachedFunction.__call__ (sage/misc/cachefunc.c:5120)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python2.7/weakref.py\", line 56, in __getitem__\n        o = self.data[key]()\n    TypeError: unhashable type: 'list'\n```\nHence, it seems that IntegerListsLex should have a `__classcall_private__` or something like that. `UniqueRepresentation` will only work if the defining data are hashable.",
    "created_at": "2013-03-05T17:35:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218771",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:16'></a>Did you do tests with your patch?

I get errors such as

```
    Traceback (most recent call last):
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[17]>", line 1, in <module>
        Partitions(Integer(4), outer=[Integer(3),Integer(1),Integer(1)]).list()###line 138:
    sage: Partitions(4, outer=[3,1,1]).list()
      File "classcall_metaclass.pyx", line 279, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:932)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python/site-packages/sage/combinat/partition.py", line 4006, in __classcall_private__
        return IntegerListsLex(n, **kwargs)
      File "classcall_metaclass.pyx", line 279, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (sage/misc/classcall_metaclass.c:932)
      File "cachefunc.pyx", line 991, in sage.misc.cachefunc.WeakCachedFunction.__call__ (sage/misc/cachefunc.c:5120)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python2.7/weakref.py", line 56, in __getitem__
        o = self.data[key]()
    TypeError: unhashable type: 'list'
```
Hence, it seems that IntegerListsLex should have a `__classcall_private__` or something like that. `UniqueRepresentation` will only work if the defining data are hashable.



---

archive/issue_comments_218772.json:
```json
{
    "body": "<a id='comment:17'></a>I just did them and removed the `CachedRepresentation` since that no longer will affect the timing (since I'm using `PartitionsGreatestLE` which already is a `UniqueRepresentation`). I'm also removing the (near) duplicate `young_subgroup`* methods.",
    "created_at": "2013-03-05T17:38:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218772",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>I just did them and removed the `CachedRepresentation` since that no longer will affect the timing (since I'm using `PartitionsGreatestLE` which already is a `UniqueRepresentation`). I'm also removing the (near) duplicate `young_subgroup`* methods.



---

archive/issue_comments_218773.json:
```json
{
    "body": "<a id='comment:18'></a>Okay, I also added a little micro-optimization by explicitly calling the `element_class` of the stored k bounded partitions parent which circumvents some the additional/duplicate `_element_constructor_` tests and doctests in modified files all pass. I don't know what else to do (or we can do) at this point. With your patches, it seems we're back close to the original speed.",
    "created_at": "2013-03-05T17:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218773",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:18'></a>Okay, I also added a little micro-optimization by explicitly calling the `element_class` of the stored k bounded partitions parent which circumvents some the additional/duplicate `_element_constructor_` tests and doctests in modified files all pass. I don't know what else to do (or we can do) at this point. With your patches, it seems we're back close to the original speed.



---

archive/issue_comments_218774.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,4 @@\n \n Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.\n \n-Apply [attachment:trac_14228-partition_caches.patch]\n+Apply [attachment:trac_14228-sym_speedup-ts.patch]\n``````\n",
    "created_at": "2013-03-05T17:47:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218774",
    "user": "https://github.com/tscrim"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,4 @@
 
 Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.
 
-Apply [attachment:trac_14228-partition_caches.patch]
+Apply [attachment:trac_14228-sym_speedup-ts.patch]
``````




---

archive/issue_comments_218775.json:
```json
{
    "body": "<a id='comment:19'></a>With the patch that you posted last, I get\n\n```\nsage: from sage.combinat.sf.k_dual import AffineSchurFunctions\nsage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))\nsage: %time TestSuite(F).run()\nCPU times: user 5.77 s, sys: 0.06 s, total: 5.83 s\nWall time: 5.87 s\nsage: %time TestSuite(F).run()\nCPU times: user 3.19 s, sys: 0.04 s, total: 3.24 s\nWall time: 3.24 s\n```\nAdditionally using a local cache for Partitions or Weyl group gives no further improvement.\n\nSo, I suggest we use the merged patch as basis for a our reviews. Is it cross review? Does this patch contain my code?",
    "created_at": "2013-03-05T17:53:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218775",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:19'></a>With the patch that you posted last, I get

```
sage: from sage.combinat.sf.k_dual import AffineSchurFunctions
sage: F = AffineSchurFunctions(SymmetricFunctions(QQ['t']).kBoundedQuotient(Integer(4),t=Integer(1)))
sage: %time TestSuite(F).run()
CPU times: user 5.77 s, sys: 0.06 s, total: 5.83 s
Wall time: 5.87 s
sage: %time TestSuite(F).run()
CPU times: user 3.19 s, sys: 0.04 s, total: 3.24 s
Wall time: 3.24 s
```
Additionally using a local cache for Partitions or Weyl group gives no further improvement.

So, I suggest we use the merged patch as basis for a our reviews. Is it cross review? Does this patch contain my code?



---

archive/issue_comments_218776.json:
```json
{
    "body": "<a id='comment:20'></a>I believe only the cached method on `young_subgroup()` and the change in the import statements in `partition.py`.",
    "created_at": "2013-03-05T18:01:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218776",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>I believe only the cached method on `young_subgroup()` and the change in the import statements in `partition.py`.



---

archive/issue_comments_218777.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Simon King\"",
    "created_at": "2013-03-05T18:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218777",
    "user": "https://github.com/simon-king-jena"
}
```

Changing reviewer from "" to "Simon King"



---

archive/issue_comments_218778.json:
```json
{
    "body": "Changing author from \"Simon King, Travis Scrimshaw\" to \"Travis Scrimshaw\"",
    "created_at": "2013-03-05T18:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218778",
    "user": "https://github.com/simon-king-jena"
}
```

Changing author from "Simon King, Travis Scrimshaw" to "Travis Scrimshaw"



---

archive/issue_comments_218779.json:
```json
{
    "body": "<a id='comment:21'></a>OK. So, I am supposed to review it, then.",
    "created_at": "2013-03-05T18:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218779",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:21'></a>OK. So, I am supposed to review it, then.



---

archive/issue_comments_218780.json:
```json
{
    "body": "<a id='comment:22'></a>The change to `PartitionsGreatestLE` gives the following errors in sage.combinat.sf.kschur. I know that this module is deprecated, but nevertheless, I think the following attribute error (occurring in several tests) should be fixed:\n\n```\nFile \"/home/simon/SAGE/prerelease/sage-5.8.beta0/devel/sage-main/sage/combinat/sf/kschur.py\", line 42:\n    sage: s(ks3([3,2,1]))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_1[5]>\", line 1, in <module>\n        s(ks3([Integer(3),Integer(2),Integer(1)]))###line 42:\n    sage: s(ks3([3,2,1]))\n      File \"parent.pyx\", line 914, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7826)\n      File \"coerce_maps.pyx\", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3656)\n      File \"coerce_maps.pyx\", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3558)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python/site-packages/sage/combinat/free_module.py\", line 1469, in _element_constructor_\n        return self.monomial(self._basis_keys(x))\n      File \"parent.pyx\", line 910, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7772)\n      File \"parent.pyx\", line 2288, in sage.structure.parent.Parent.convert_map_from (sage/structure/parent.c:15651)\n      File \"parent.pyx\", line 2295, in sage.structure.parent.Parent.discover_convert_map_from (sage/structure/parent.c:15816)\n      File \"parent.pyx\", line 2106, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14358)\n      File \"parent.pyx\", line 2927, in sage.structure.parent._register_pair (sage/structure/parent.c:21520)\n      File \"parent.pyx\", line 2901, in sage.structure.parent.EltPair.__hash__ (sage/structure/parent.c:21168)\n      File \"category_object.pyx\", line 788, in sage.structure.category_object.CategoryObject.__hash__ (sage/structure/category_object.c:8150)\n      File \"sage_object.pyx\", line 154, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1769)\n      File \"/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python/site-packages/sage/combinat/partition.py\", line 5653, in _repr_\n        return \"Partitions of %s having parts less than or equal to %s\"%(self.n, self.k)\n      File \"parent.pyx\", line 669, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6277)\n      File \"misc.pyx\", line 205, in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1406)\n    AttributeError: 'PartitionsGreatestLE_with_category' object has no attribute 'n'\n```\n\n\nFor the patchbot:\n\nApply trac_14228-sym_speedup-ts.patch",
    "created_at": "2013-03-05T21:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218780",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:22'></a>The change to `PartitionsGreatestLE` gives the following errors in sage.combinat.sf.kschur. I know that this module is deprecated, but nevertheless, I think the following attribute error (occurring in several tests) should be fixed:

```
File "/home/simon/SAGE/prerelease/sage-5.8.beta0/devel/sage-main/sage/combinat/sf/kschur.py", line 42:
    sage: s(ks3([3,2,1]))
Exception raised:
    Traceback (most recent call last):
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_1[5]>", line 1, in <module>
        s(ks3([Integer(3),Integer(2),Integer(1)]))###line 42:
    sage: s(ks3([3,2,1]))
      File "parent.pyx", line 914, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7826)
      File "coerce_maps.pyx", line 82, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3656)
      File "coerce_maps.pyx", line 77, in sage.structure.coerce_maps.DefaultConvertMap_unique._call_ (sage/structure/coerce_maps.c:3558)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python/site-packages/sage/combinat/free_module.py", line 1469, in _element_constructor_
        return self.monomial(self._basis_keys(x))
      File "parent.pyx", line 910, in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:7772)
      File "parent.pyx", line 2288, in sage.structure.parent.Parent.convert_map_from (sage/structure/parent.c:15651)
      File "parent.pyx", line 2295, in sage.structure.parent.Parent.discover_convert_map_from (sage/structure/parent.c:15816)
      File "parent.pyx", line 2106, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14358)
      File "parent.pyx", line 2927, in sage.structure.parent._register_pair (sage/structure/parent.c:21520)
      File "parent.pyx", line 2901, in sage.structure.parent.EltPair.__hash__ (sage/structure/parent.c:21168)
      File "category_object.pyx", line 788, in sage.structure.category_object.CategoryObject.__hash__ (sage/structure/category_object.c:8150)
      File "sage_object.pyx", line 154, in sage.structure.sage_object.SageObject.__repr__ (sage/structure/sage_object.c:1769)
      File "/home/simon/SAGE/prerelease/sage-5.8.beta0/local/lib/python/site-packages/sage/combinat/partition.py", line 5653, in _repr_
        return "Partitions of %s having parts less than or equal to %s"%(self.n, self.k)
      File "parent.pyx", line 669, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6277)
      File "misc.pyx", line 205, in sage.structure.misc.getattr_from_other_class (sage/structure/misc.c:1406)
    AttributeError: 'PartitionsGreatestLE_with_category' object has no attribute 'n'
```


For the patchbot:

Apply trac_14228-sym_speedup-ts.patch



---

archive/issue_comments_218781.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-05T21:20:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218781",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_218782.json:
```json
{
    "body": "<a id='comment:24'></a>PS: According to the traceback of this error, it uses the hash of `CategoryObject`---which is extremely slow, as it involves computing the string representation. So, does `PartitionsGreatestLE_with_category` not have a reasonable hash?",
    "created_at": "2013-03-05T21:44:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218782",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:24'></a>PS: According to the traceback of this error, it uses the hash of `CategoryObject`---which is extremely slow, as it involves computing the string representation. So, does `PartitionsGreatestLE_with_category` not have a reasonable hash?



---

archive/issue_comments_218783.json:
```json
{
    "body": "<a id='comment:25'></a>I'll implement a custom hash for it and fix those attribute errors shortly.",
    "created_at": "2013-03-05T22:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218783",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>I'll implement a custom hash for it and fix those attribute errors shortly.



---

archive/issue_comments_218784.json:
```json
{
    "body": "Fixed doctests",
    "created_at": "2013-03-06T02:28:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218784",
    "user": "https://github.com/tscrim"
}
```

Fixed doctests



---

archive/issue_comments_218785.json:
```json
{
    "body": "<a id='comment:26'></a>Attachment [trac_14228-sym_speedup-ts.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14228-sym_speedup-ts.patch) by @tscrim created at 2013-03-06 02:34:40\n\nSorry that took so long. I went out for dinner in between. I fixed the doctests in `kschur.py`, it was trying to pass in a `NonNegativeIntergers()` (which is currently not really supported by `Partitions` but probably should be), so I just removed that. I also implemented a custom hash which may not generate the best hash values, but it should do the job.",
    "created_at": "2013-03-06T02:34:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218785",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:26'></a>Attachment [trac_14228-sym_speedup-ts.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14228-sym_speedup-ts.patch) by @tscrim created at 2013-03-06 02:34:40

Sorry that took so long. I went out for dinner in between. I fixed the doctests in `kschur.py`, it was trying to pass in a `NonNegativeIntergers()` (which is currently not really supported by `Partitions` but probably should be), so I just removed that. I also implemented a custom hash which may not generate the best hash values, but it should do the job.



---

archive/issue_comments_218786.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-06T02:34:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218786",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_218787.json:
```json
{
    "body": "<a id='comment:27'></a>I also forgot:\n\nFor patchbot:\n\nApply: trac_14228-sym_speedup-ts.patch",
    "created_at": "2013-03-06T02:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218787",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:27'></a>I also forgot:

For patchbot:

Apply: trac_14228-sym_speedup-ts.patch



---

archive/issue_comments_218788.json:
```json
{
    "body": "<a id='comment:28'></a>It seems that the coverage script is complaining. Indeed, `KBoundedQuotientBasis.__init__` needs a test, and perhaps documentation what it is doing.\n\nYou now define a hash for `PartitionsGreatestLE`. But I see that it inherits from unique representation. Hence, it should have a blazingly fast hash anyway! So, I wonder where that hash (and comparison!) has disappeared!\n\nI reckon that one should do\n\n```\nclass PartitionsGreatestLE(UniqueRepresentation, IntegerListsLex):\n```\nand not\n\n```\nclass PartitionsGreatestLE(IntegerListsLex, UniqueRepresentation):\n```\nI think it is documented somewhere that `UniqueRepresentation` should be the *first* base class given.\n\nMy plan is to add a reviewer patch, removing the custom hash and bringing `UniqueRepresentation`'s hash forward, and adding documentation plus test for the new base class.",
    "created_at": "2013-03-06T06:46:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218788",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:28'></a>It seems that the coverage script is complaining. Indeed, `KBoundedQuotientBasis.__init__` needs a test, and perhaps documentation what it is doing.

You now define a hash for `PartitionsGreatestLE`. But I see that it inherits from unique representation. Hence, it should have a blazingly fast hash anyway! So, I wonder where that hash (and comparison!) has disappeared!

I reckon that one should do

```
class PartitionsGreatestLE(UniqueRepresentation, IntegerListsLex):
```
and not

```
class PartitionsGreatestLE(IntegerListsLex, UniqueRepresentation):
```
I think it is documented somewhere that `UniqueRepresentation` should be the *first* base class given.

My plan is to add a reviewer patch, removing the custom hash and bringing `UniqueRepresentation`'s hash forward, and adding documentation plus test for the new base class.



---

archive/issue_comments_218789.json:
```json
{
    "body": "Attachment [trac_14228-reviewer.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14228-reviewer.patch) by @simon-king-jena created at 2013-03-06 08:06:52",
    "created_at": "2013-03-06T08:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218789",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment [trac_14228-reviewer.patch](tarball://root/attachments/some-uuid/ticket14228/trac_14228-reviewer.patch) by @simon-king-jena created at 2013-03-06 08:06:52



---

archive/issue_comments_218790.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,4 +2,7 @@\n \n Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.\n \n-Apply [attachment:trac_14228-sym_speedup-ts.patch]\n+Apply\n+\n+- [attachment:trac_14228-sym_speedup-ts.patch]\n+- [attachment:trac_14228-reviewer.patch]\n``````\n",
    "created_at": "2013-03-06T08:07:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218790",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,4 +2,7 @@
 
 Certain data of partitions should be cached, namely `WeylGroup` and the Young subgroup. And sage.combinat.sf.k_dual constructs a couple of partitions, but they are only weakly cached, so that they eventually are created repeatedly. Hence, they should be cached, too.
 
-Apply [attachment:trac_14228-sym_speedup-ts.patch]
+Apply
+
+- [attachment:trac_14228-sym_speedup-ts.patch]
+- [attachment:trac_14228-reviewer.patch]
``````




---

archive/issue_comments_218791.json:
```json
{
    "body": "<a id='comment:30'></a>I added a reviewer patch, as I indicated in my previous post. Hope you agree with my changes. I will finish the review as soon as all tests pass.\n\nApply trac_14228-sym_speedup-ts.patch trac_14228-reviewer.patch",
    "created_at": "2013-03-06T08:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218791",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:30'></a>I added a reviewer patch, as I indicated in my previous post. Hope you agree with my changes. I will finish the review as soon as all tests pass.

Apply trac_14228-sym_speedup-ts.patch trac_14228-reviewer.patch



---

archive/issue_comments_218792.json:
```json
{
    "body": "<a id='comment:31'></a>The tests pass (including the review patch), Travis' patch looks fine to me, and things in k_dual become a lot faster. Hence, it is a positive review here. I will now see how the new timings compare with pre-#12313 and post-#12313, so that hopefully #13991 can be resolved as fixed.",
    "created_at": "2013-03-06T11:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218792",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:31'></a>The tests pass (including the review patch), Travis' patch looks fine to me, and things in k_dual become a lot faster. Hence, it is a positive review here. I will now see how the new timings compare with pre-#12313 and post-#12313, so that hopefully #13991 can be resolved as fixed.



---

archive/issue_comments_218793.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-03-06T11:04:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218793",
    "user": "https://github.com/simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_218794.json:
```json
{
    "body": "<a id='comment:33'></a>Looks good to me too. Thank you Simon.\n\nBest,\n\nTravis",
    "created_at": "2013-03-06T12:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218794",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:33'></a>Looks good to me too. Thank you Simon.

Best,

Travis



---

archive/issue_events_040213.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T18:26:48Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14228#event-40213"
}
```



---

archive/issue_comments_218795.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.8.beta4\"",
    "created_at": "2013-03-07T18:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218795",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.8.beta4"



---

archive/issue_comments_218796.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-03-07T18:26:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14228",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14228#issuecomment-218796",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
