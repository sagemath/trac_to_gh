# Issue 14353: Factor toric morphism into surjective and generically injective

archive/issues_014149.json:
```json
{
    "body": "This ticket implements factorization into a surjective, birational, and injective toric morphism.\n\n**Apply:**\n1. [attachment:trac_14353_fan_morphism_factoring.patch]\n2. [attachment:trac_14353_auxiliary_methods.patch]\n3. [attachment:trac_14353_toric_morphism_factoring.patch]\n4. [attachment:trac_14353_toric_morphism_composition.patch]\n\nAssignee: @aghitza\n\nCC:  @novoselt\n\nKeywords: toric, sd48\n\nReviewer: Andrey Novoseltsev, Volker Braun\n\nAuthor: Volker Braun, Andrey Novoseltsev\n\nMerged: sage-5.11.beta3\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14353\n\n",
    "closed_at": "2013-06-20T21:36:41Z",
    "created_at": "2013-03-24T22:26:57Z",
    "labels": [
        "component: algebraic geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.11",
    "title": "Factor toric morphism into surjective and generically injective",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14353",
    "user": "https://github.com/vbraun"
}
```
This ticket implements factorization into a surjective, birational, and injective toric morphism.

**Apply:**
1. [attachment:trac_14353_fan_morphism_factoring.patch]
2. [attachment:trac_14353_auxiliary_methods.patch]
3. [attachment:trac_14353_toric_morphism_factoring.patch]
4. [attachment:trac_14353_toric_morphism_composition.patch]

Assignee: @aghitza

CC:  @novoselt

Keywords: toric, sd48

Reviewer: Andrey Novoseltsev, Volker Braun

Author: Volker Braun, Andrey Novoseltsev

Merged: sage-5.11.beta3

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/14353





---

archive/issue_comments_177380.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-03-24T22:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177380",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_177381.json:
```json
{
    "body": "<a id='comment:2'></a>The support of a fan is in general not a cone at all! Unless I have a severe misunderstanding, it is a set-theoretic union of all its cones, e.g. for the fan generated by 1-cones (1,0) and (0,1) is not a cone. It would be great to have a method for support, but I am not sure how we can represent it at the moment apart from the fan itself.",
    "created_at": "2013-03-25T04:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177381",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:2'></a>The support of a fan is in general not a cone at all! Unless I have a severe misunderstanding, it is a set-theoretic union of all its cones, e.g. for the fan generated by 1-cones (1,0) and (0,1) is not a cone. It would be great to have a method for support, but I am not sure how we can represent it at the moment apart from the fan itself.



---

archive/issue_comments_177382.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-25T04:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177382",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_177383.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-03-27T08:22:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177383",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_177384.json:
```json
{
    "body": "Attachment [trac_14353_factor_fan_morphism.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_factor_fan_morphism.patch) by @vbraun created at 2013-03-27 08:22:35\n\nUpdated patch",
    "created_at": "2013-03-27T08:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177384",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14353_factor_fan_morphism.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_factor_fan_morphism.patch) by @vbraun created at 2013-03-27 08:22:35

Updated patch



---

archive/issue_comments_177385.json:
```json
{
    "body": "<a id='comment:3'></a>You are of course right. Fixed now.",
    "created_at": "2013-03-27T08:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177385",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>You are of course right. Fixed now.



---

archive/issue_comments_177386.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-27T08:23:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177386",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_177387.json:
```json
{
    "body": "<a id='comment:4'></a>Hey Volker, thanks for opening this ticket!\n\nAs I was thinking more about it, toric morphisms naturally factor into THREE: if `f: Sigma --> Sigma'`, then we have\n\n`Sigma --f_s--> Sigma_s --f_b--> Sigma_i --f_i--> Sigma'`\n\nwhere `f_s` is surjection onto the fan which is the image of Sigma, `f_i` is injection of Sigma' intersected with the image sublattice, and `f_b` is a birational map between the intermediate toric varieties which does not have to be surjective or injective. The map from a single blowup chart into the original variety is precisely `f_b` with the other two being identities.\n\nI would like to do the following:\n- adjust factoring to return three morphisms instead of two;\n- make intermediate fans live in the `image_sublattice`;\n- name them, perhaps, `domain_fan_image` (under the map of lattices) and `codomain_fan_restriction` (to the `image_sublattice`);\n- get rid of `restrict_to_image` method as it is misleading, if not wrong: restriction to the image of a toric morphism is not necessarily a toric morphism (it is not for the blow up chart). It does not seem like it is used anywhere but one place and basically it was trying to do the factoring in a not very good way.\n\nI am working on it now on top of your patches, so let me know if you have severe objections!",
    "created_at": "2013-04-02T18:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177387",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:4'></a>Hey Volker, thanks for opening this ticket!

As I was thinking more about it, toric morphisms naturally factor into THREE: if `f: Sigma --> Sigma'`, then we have

`Sigma --f_s--> Sigma_s --f_b--> Sigma_i --f_i--> Sigma'`

where `f_s` is surjection onto the fan which is the image of Sigma, `f_i` is injection of Sigma' intersected with the image sublattice, and `f_b` is a birational map between the intermediate toric varieties which does not have to be surjective or injective. The map from a single blowup chart into the original variety is precisely `f_b` with the other two being identities.

I would like to do the following:
- adjust factoring to return three morphisms instead of two;
- make intermediate fans live in the `image_sublattice`;
- name them, perhaps, `domain_fan_image` (under the map of lattices) and `codomain_fan_restriction` (to the `image_sublattice`);
- get rid of `restrict_to_image` method as it is misleading, if not wrong: restriction to the image of a toric morphism is not necessarily a toric morphism (it is not for the blow up chart). It does not seem like it is used anywhere but one place and basically it was trying to do the factoring in a not very good way.

I am working on it now on top of your patches, so let me know if you have severe objections!



---

archive/issue_comments_177388.json:
```json
{
    "body": "<a id='comment:5'></a>I don't think there are particularly good names for the intermediate fans. Instead of trying to invent some name, we can just let a user use `domain_fan()` / `image_fan()` on the factored morphism.\n\nWe have a choice for `Sigma_i`. Just the intersection with the image sublattice will in general contain cones whose preimage under `f_b` is empty. We can leave (some of) those out and get a smaller `Sigma_i`. E.g. take the composition of the half blowup chart with the embedding `C^2-> P^2`. The natural thing to do is probably take this smaller fan. So `f_i` would be the embedding `C<sup>2->P</sup>2` in the example. \n\nI'm happy to get rid of `restrict_to_image`, I was tempted to do that myself....",
    "created_at": "2013-04-02T21:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177388",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>I don't think there are particularly good names for the intermediate fans. Instead of trying to invent some name, we can just let a user use `domain_fan()` / `image_fan()` on the factored morphism.

We have a choice for `Sigma_i`. Just the intersection with the image sublattice will in general contain cones whose preimage under `f_b` is empty. We can leave (some of) those out and get a smaller `Sigma_i`. E.g. take the composition of the half blowup chart with the embedding `C^2-> P^2`. The natural thing to do is probably take this smaller fan. So `f_i` would be the embedding `C<sup>2->P</sup>2` in the example. 

I'm happy to get rid of `restrict_to_image`, I was tempted to do that myself....



---

archive/issue_comments_177389.json:
```json
{
    "body": "<a id='comment:6'></a>Here is some work in progress, does not look good in the patch, but it removes `restrict_to_image` in the end and adds `factor` instead, diff blends these activities.\n\nNo other new methods apart `is_birational` which is not proper yet and there are some failures with composition of morphisms - I completely agree that these fans have to be accessed through morphisms, no need for new names.\n\nAs for `Sigma_i` indeed we have a choice, but I'd rather stick with \"the big one\" because:\n- it makes it independent of the domain fan, which is symmetrical to `Sigma_s` not depending on the codomain fan;\n- the corresponding variety will be a closed subvariety of the codomain;\n- it is easier to implement/faster to compute;\n- last but not least - I already have it in the patch ;-)",
    "created_at": "2013-04-02T21:46:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177389",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'></a>Here is some work in progress, does not look good in the patch, but it removes `restrict_to_image` in the end and adds `factor` instead, diff blends these activities.

No other new methods apart `is_birational` which is not proper yet and there are some failures with composition of morphisms - I completely agree that these fans have to be accessed through morphisms, no need for new names.

As for `Sigma_i` indeed we have a choice, but I'd rather stick with "the big one" because:
- it makes it independent of the domain fan, which is symmetrical to `Sigma_s` not depending on the codomain fan;
- the corresponding variety will be a closed subvariety of the codomain;
- it is easier to implement/faster to compute;
- last but not least - I already have it in the patch ;-)



---

archive/issue_comments_177390.json:
```json
{
    "body": "Attachment [trac_14353_fan_morphism_factoring.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_fan_morphism_factoring.patch) by @novoselt created at 2013-04-10 00:01:08",
    "created_at": "2013-04-10T00:01:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177390",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_14353_fan_morphism_factoring.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_fan_morphism_factoring.patch) by @novoselt created at 2013-04-10 00:01:08



---

archive/issue_comments_177391.json:
```json
{
    "body": "Attachment [trac_14353_auxiliary_methods.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_auxiliary_methods.patch) by @novoselt created at 2013-04-10 05:04:01\n\nMade from Volker's patch",
    "created_at": "2013-04-10T05:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177391",
    "user": "https://github.com/novoselt"
}
```

Attachment [trac_14353_auxiliary_methods.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_auxiliary_methods.patch) by @novoselt created at 2013-04-10 05:04:01

Made from Volker's patch



---

archive/issue_comments_177392.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-04-10T05:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177392",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_177393.json:
```json
{
    "body": "Changing keywords from \"\" to \"toric\".",
    "created_at": "2013-04-10T05:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177393",
    "user": "https://github.com/novoselt"
}
```

Changing keywords from "" to "toric".



---

archive/issue_comments_177394.json:
```json
{
    "body": "<a id='comment:7'></a>Hi Volker, I propose this version based on triple factorization for both fan and variety morphisms. I hope the documentation is written clearly and the example chosen gives a good idea what is what. The only remaining problem is that I really want to multiply factors back into the original one. For fan morphisms I just added `__mul__` as they are standalone (although it may make sense to change that...), but toric morphisms should follow coercion rules, so implementing the double underscore method as it is done now is not acceptable. And even with it there is an issue of comparing, although it does seem that the result is correct.\n\nAnyway: let me know what you think of composition and if the rest looks OK!",
    "created_at": "2013-04-10T05:14:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177394",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:7'></a>Hi Volker, I propose this version based on triple factorization for both fan and variety morphisms. I hope the documentation is written clearly and the example chosen gives a good idea what is what. The only remaining problem is that I really want to multiply factors back into the original one. For fan morphisms I just added `__mul__` as they are standalone (although it may make sense to change that...), but toric morphisms should follow coercion rules, so implementing the double underscore method as it is done now is not acceptable. And even with it there is an issue of comparing, although it does seem that the result is correct.

Anyway: let me know what you think of composition and if the rest looks OK!



---

archive/issue_comments_177395.json:
```json
{
    "body": "<a id='comment:8'></a>I think we shouldn't do more than implement the factorization in this ticket, fixing composition of morphisms is another task. Though right now this doctest fails, maybe you want to mark it as `# known bug`?\n\n```\nsage -t sage/schemes/toric/morphism.py\n**********************************************************************\nFile \"sage/schemes/toric/morphism.py\", line 544, in sage.schemes.toric.morphism.SchemeMorphism_fan_toric_variety.factor\nFailed example:\n    prod(phi.factor()) == phi\nExpected:\n    True\nGot:\n    False\n```",
    "created_at": "2013-04-14T07:01:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177395",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'></a>I think we shouldn't do more than implement the factorization in this ticket, fixing composition of morphisms is another task. Though right now this doctest fails, maybe you want to mark it as `# known bug`?

```
sage -t sage/schemes/toric/morphism.py
**********************************************************************
File "sage/schemes/toric/morphism.py", line 544, in sage.schemes.toric.morphism.SchemeMorphism_fan_toric_variety.factor
Failed example:
    prod(phi.factor()) == phi
Expected:
    True
Got:
    False
```



---

archive/issue_comments_177396.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-17T14:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177396",
    "user": "https://github.com/novoselt"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_177397.json:
```json
{
    "body": "<a id='comment:9'></a>Attachment [trac_14353_toric_morphism_factoring.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_toric_morphism_factoring.patch) by @novoselt created at 2013-04-17 14:46:34\n\nWell, since composition was actually working and the problem was in comparison, I've added `__cmp__` - composing factors to compare with the original is the most natural doctest here. All tests pass now, ready for review!",
    "created_at": "2013-04-17T14:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177397",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'></a>Attachment [trac_14353_toric_morphism_factoring.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_toric_morphism_factoring.patch) by @novoselt created at 2013-04-17 14:46:34

Well, since composition was actually working and the problem was in comparison, I've added `__cmp__` - composing factors to compare with the original is the most natural doctest here. All tests pass now, ready for review!



---

archive/issue_comments_177398.json:
```json
{
    "body": "<a id='comment:10'></a>Apply trac_14353_fan_morphism_factoring.patch trac_14353_auxiliary_methods.patch trac_14353_toric_morphism_factoring.patch",
    "created_at": "2013-06-18T20:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177398",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:10'></a>Apply trac_14353_fan_morphism_factoring.patch trac_14353_auxiliary_methods.patch trac_14353_toric_morphism_factoring.patch



---

archive/issue_comments_177399.json:
```json
{
    "body": "Attachment [trac_14353_toric_morphism_composition.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_toric_morphism_composition.patch) by @vbraun created at 2013-06-20 02:14:09\n\nInitial patch",
    "created_at": "2013-06-20T02:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177399",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14353_toric_morphism_composition.patch](tarball://root/attachments/some-uuid/ticket14353/trac_14353_toric_morphism_composition.patch) by @vbraun created at 2013-06-20 02:14:09

Initial patch



---

archive/issue_comments_177400.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-06-20T02:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177400",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_177401.json:
```json
{
    "body": "Changing keywords from \"toric\" to \"toric, sd48\".",
    "created_at": "2013-06-20T02:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177401",
    "user": "https://github.com/vbraun"
}
```

Changing keywords from "toric" to "toric, sd48".



---

archive/issue_comments_177402.json:
```json
{
    "body": "<a id='comment:12'></a>Positive review after in-persion discussion with Andrey",
    "created_at": "2013-06-20T02:18:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177402",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'></a>Positive review after in-persion discussion with Andrey



---

archive/issue_comments_177403.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-06-20T21:36:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177403",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_040698.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-20T21:36:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14353#event-40698"
}
```



---

archive/issue_comments_177404.json:
```json
{
    "body": "<a id='comment:14'></a>Follow-up: #14975. Please fix that soon or I will unmerge this ticket.",
    "created_at": "2013-07-26T06:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14353#issuecomment-177404",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>Follow-up: #14975. Please fix that soon or I will unmerge this ticket.
