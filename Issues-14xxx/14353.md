# Issue 14353: Factor toric morphism into surjective and generically injective

archive/issues_014149.json:
```json
{
    "assignees": [],
    "body": "This ticket implements factorization into a surjective, birational, and injective toric morphism.\n\n**Apply:**\n1. [attachment: trac_14353_fan_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)\n2. [attachment: trac_14353_auxiliary_methods.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)\n3. [attachment: trac_14353_toric_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)\n4. [attachment: trac_14353_toric_morphism_composition.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_composition.patch.gz)\n\nAssignee: **@aghitza**\n\nCC:  @novoselt\n\nKeywords: **toric, sd48**\n\nReviewer: **Andrey Novoseltsev, Volker Braun**\n\nAuthor: **Volker Braun, Andrey Novoseltsev**\n\nMerged: **sage-5.11.beta3**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14353_\n\n",
    "closed_at": "2013-06-20T21:36:41Z",
    "created_at": "2013-03-24T22:26:57Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20algebraic%20geometry",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.11",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Factor toric morphism into surjective and generically injective",
    "type": "issue",
    "updated_at": "2013-07-26T06:11:49Z",
    "url": "https://github.com/sagemath/sage/issues/14353",
    "user": "https://github.com/vbraun"
}
```
This ticket implements factorization into a surjective, birational, and injective toric morphism.

**Apply:**
1. [attachment: trac_14353_fan_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)
2. [attachment: trac_14353_auxiliary_methods.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)
3. [attachment: trac_14353_toric_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)
4. [attachment: trac_14353_toric_morphism_composition.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_composition.patch.gz)

Assignee: **@aghitza**

CC:  @novoselt

Keywords: **toric, sd48**

Reviewer: **Andrey Novoseltsev, Volker Braun**

Author: **Volker Braun, Andrey Novoseltsev**

Merged: **sage-5.11.beta3**

_Issue created by migration from https://trac.sagemath.org/ticket/14353_





---

archive/issue_events_186006.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-24T22:26:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186006"
}
```



---

archive/issue_events_186007.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-24T22:26:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20algebraic%20geometry",
    "label_color": "0000ff",
    "label_name": "component: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186007"
}
```



---

archive/issue_events_186008.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-24T22:26:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186008"
}
```



---

archive/issue_events_186009.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-24T22:26:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186009"
}
```



---

archive/issue_events_186010.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-24T22:32:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186010"
}
```



---

archive/issue_comments_174881.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nThe support of a fan is in general not a cone at all! Unless I have a severe misunderstanding, it is a set-theoretic union of all its cones, e.g. for the fan generated by 1-cones (1,0) and (0,1) is not a cone. It would be great to have a method for support, but I am not sure how we can represent it at the moment apart from the fan itself.",
    "created_at": "2013-03-25T04:52:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174881",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:2" align="right">Comment 2</div>

The support of a fan is in general not a cone at all! Unless I have a severe misunderstanding, it is a set-theoretic union of all its cones, e.g. for the fan generated by 1-cones (1,0) and (0,1) is not a cone. It would be great to have a method for support, but I am not sure how we can represent it at the moment apart from the fan itself.



---

archive/issue_events_186011.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-03-25T04:52:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186011"
}
```



---

archive/issue_events_186012.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-03-25T04:52:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186012"
}
```



---

archive/issue_comments_174882.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-03-27T08:22:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174882",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_174883.json:
```json
{
    "body": "Attachment: **[trac_14353_fan_cone_intersection.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_cone_intersection.patch.gz)**\n\nAttachment: **[trac_14353_factor_fan_morphism.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_factor_fan_morphism.patch.gz)**\n\nUpdated patch",
    "created_at": "2013-03-27T08:22:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174883",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_14353_fan_cone_intersection.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_cone_intersection.patch.gz)**

Attachment: **[trac_14353_factor_fan_morphism.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_factor_fan_morphism.patch.gz)**

Updated patch



---

archive/issue_comments_174884.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nYou are of course right. Fixed now.",
    "created_at": "2013-03-27T08:23:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174884",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:3" align="right">Comment 3</div>

You are of course right. Fixed now.



---

archive/issue_events_186013.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-27T08:23:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186013"
}
```



---

archive/issue_events_186014.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-03-27T08:23:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186014"
}
```



---

archive/issue_comments_174885.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nHey Volker, thanks for opening this ticket!\n\nAs I was thinking more about it, toric morphisms naturally factor into THREE: if `f: Sigma --> Sigma'`, then we have\n\n`Sigma --f_s--> Sigma_s --f_b--> Sigma_i --f_i--> Sigma'`\n\nwhere `f_s` is surjection onto the fan which is the image of Sigma, `f_i` is injection of Sigma' intersected with the image sublattice, and `f_b` is a birational map between the intermediate toric varieties which does not have to be surjective or injective. The map from a single blowup chart into the original variety is precisely `f_b` with the other two being identities.\n\nI would like to do the following:\n- adjust factoring to return three morphisms instead of two;\n- make intermediate fans live in the `image_sublattice`;\n- name them, perhaps, `domain_fan_image` (under the map of lattices) and `codomain_fan_restriction` (to the `image_sublattice`);\n- get rid of `restrict_to_image` method as it is misleading, if not wrong: restriction to the image of a toric morphism is not necessarily a toric morphism (it is not for the blow up chart). It does not seem like it is used anywhere but one place and basically it was trying to do the factoring in a not very good way.\n\nI am working on it now on top of your patches, so let me know if you have severe objections!",
    "created_at": "2013-04-02T18:17:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174885",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:4" align="right">Comment 4</div>

Hey Volker, thanks for opening this ticket!

As I was thinking more about it, toric morphisms naturally factor into THREE: if `f: Sigma --> Sigma'`, then we have

`Sigma --f_s--> Sigma_s --f_b--> Sigma_i --f_i--> Sigma'`

where `f_s` is surjection onto the fan which is the image of Sigma, `f_i` is injection of Sigma' intersected with the image sublattice, and `f_b` is a birational map between the intermediate toric varieties which does not have to be surjective or injective. The map from a single blowup chart into the original variety is precisely `f_b` with the other two being identities.

I would like to do the following:
- adjust factoring to return three morphisms instead of two;
- make intermediate fans live in the `image_sublattice`;
- name them, perhaps, `domain_fan_image` (under the map of lattices) and `codomain_fan_restriction` (to the `image_sublattice`);
- get rid of `restrict_to_image` method as it is misleading, if not wrong: restriction to the image of a toric morphism is not necessarily a toric morphism (it is not for the blow up chart). It does not seem like it is used anywhere but one place and basically it was trying to do the factoring in a not very good way.

I am working on it now on top of your patches, so let me know if you have severe objections!



---

archive/issue_comments_174886.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nI don't think there are particularly good names for the intermediate fans. Instead of trying to invent some name, we can just let a user use `domain_fan()` / `image_fan()` on the factored morphism.\n\nWe have a choice for `Sigma_i`. Just the intersection with the image sublattice will in general contain cones whose preimage under `f_b` is empty. We can leave (some of) those out and get a smaller `Sigma_i`. E.g. take the composition of the half blowup chart with the embedding `C^2-> P^2`. The natural thing to do is probably take this smaller fan. So `f_i` would be the embedding `C<sup>2->P</sup>2` in the example. \n\nI'm happy to get rid of `restrict_to_image`, I was tempted to do that myself....",
    "created_at": "2013-04-02T21:05:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174886",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:5" align="right">Comment 5</div>

I don't think there are particularly good names for the intermediate fans. Instead of trying to invent some name, we can just let a user use `domain_fan()` / `image_fan()` on the factored morphism.

We have a choice for `Sigma_i`. Just the intersection with the image sublattice will in general contain cones whose preimage under `f_b` is empty. We can leave (some of) those out and get a smaller `Sigma_i`. E.g. take the composition of the half blowup chart with the embedding `C^2-> P^2`. The natural thing to do is probably take this smaller fan. So `f_i` would be the embedding `C<sup>2->P</sup>2` in the example. 

I'm happy to get rid of `restrict_to_image`, I was tempted to do that myself....



---

archive/issue_comments_174887.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nHere is some work in progress, does not look good in the patch, but it removes `restrict_to_image` in the end and adds `factor` instead, diff blends these activities.\n\nNo other new methods apart `is_birational` which is not proper yet and there are some failures with composition of morphisms - I completely agree that these fans have to be accessed through morphisms, no need for new names.\n\nAs for `Sigma_i` indeed we have a choice, but I'd rather stick with \"the big one\" because:\n- it makes it independent of the domain fan, which is symmetrical to `Sigma_s` not depending on the codomain fan;\n- the corresponding variety will be a closed subvariety of the codomain;\n- it is easier to implement/faster to compute;\n- last but not least - I already have it in the patch ;-)",
    "created_at": "2013-04-02T21:46:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174887",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:6" align="right">Comment 6</div>

Here is some work in progress, does not look good in the patch, but it removes `restrict_to_image` in the end and adds `factor` instead, diff blends these activities.

No other new methods apart `is_birational` which is not proper yet and there are some failures with composition of morphisms - I completely agree that these fans have to be accessed through morphisms, no need for new names.

As for `Sigma_i` indeed we have a choice, but I'd rather stick with "the big one" because:
- it makes it independent of the domain fan, which is symmetrical to `Sigma_s` not depending on the codomain fan;
- the corresponding variety will be a closed subvariety of the codomain;
- it is easier to implement/faster to compute;
- last but not least - I already have it in the patch ;-)



---

archive/issue_comments_174888.json:
```json
{
    "body": "Attachment: **[trac_14353_fan_morphism_factoring.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)**",
    "created_at": "2013-04-10T00:01:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174888",
    "user": "https://github.com/novoselt"
}
```

Attachment: **[trac_14353_fan_morphism_factoring.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)**



---

archive/issue_comments_174889.json:
```json
{
    "body": "Attachment: **[trac_14353_auxiliary_methods.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)**\n\nMade from Volker's patch",
    "created_at": "2013-04-10T05:04:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174889",
    "user": "https://github.com/novoselt"
}
```

Attachment: **[trac_14353_auxiliary_methods.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)**

Made from Volker's patch



---

archive/issue_events_186015.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-04-10T05:14:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186015"
}
```



---

archive/issue_events_186016.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-04-10T05:14:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186016"
}
```



---

archive/issue_comments_174890.json:
```json
{
    "body": "Reviewer: **Andrey Novoseltsev, Volker Braun**",
    "created_at": "2013-04-10T05:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174890",
    "user": "https://github.com/novoselt"
}
```

Reviewer: **Andrey Novoseltsev, Volker Braun**



---

archive/issue_comments_174891.json:
```json
{
    "body": "Changed author from **Volker Braun** to **Volker Braun, Andrey Novoseltsev**",
    "created_at": "2013-04-10T05:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174891",
    "user": "https://github.com/novoselt"
}
```

Changed author from **Volker Braun** to **Volker Braun, Andrey Novoseltsev**



---

archive/issue_comments_174892.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,6 @@\n-This ticket implements the HLY factorization into a surjective and a generically injective toric morphism.\n+This ticket implements factorization into a surjective, birational, and injective toric morphism.\n+\n+**Apply:**\n+1. [attachment: trac_14353_fan_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)\n+2. [attachment: trac_14353_auxiliary_methods.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)\n+3. [attachment: trac_14353_toric_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)\n``````\n",
    "created_at": "2013-04-10T05:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174892",
    "user": "https://github.com/novoselt"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,6 @@
-This ticket implements the HLY factorization into a surjective and a generically injective toric morphism.
+This ticket implements factorization into a surjective, birational, and injective toric morphism.
+
+**Apply:**
+1. [attachment: trac_14353_fan_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)
+2. [attachment: trac_14353_auxiliary_methods.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)
+3. [attachment: trac_14353_toric_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)
``````




---

archive/issue_comments_174893.json:
```json
{
    "body": "Work Issues: **morphism composition**",
    "created_at": "2013-04-10T05:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174893",
    "user": "https://github.com/novoselt"
}
```

Work Issues: **morphism composition**



---

archive/issue_comments_174894.json:
```json
{
    "body": "Changed keywords from **** to **toric**",
    "created_at": "2013-04-10T05:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174894",
    "user": "https://github.com/novoselt"
}
```

Changed keywords from **** to **toric**



---

archive/issue_comments_174895.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nHi Volker, I propose this version based on triple factorization for both fan and variety morphisms. I hope the documentation is written clearly and the example chosen gives a good idea what is what. The only remaining problem is that I really want to multiply factors back into the original one. For fan morphisms I just added `__mul__` as they are standalone (although it may make sense to change that...), but toric morphisms should follow coercion rules, so implementing the double underscore method as it is done now is not acceptable. And even with it there is an issue of comparing, although it does seem that the result is correct.\n\nAnyway: let me know what you think of composition and if the rest looks OK!",
    "created_at": "2013-04-10T05:14:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174895",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:7" align="right">Comment 7</div>

Hi Volker, I propose this version based on triple factorization for both fan and variety morphisms. I hope the documentation is written clearly and the example chosen gives a good idea what is what. The only remaining problem is that I really want to multiply factors back into the original one. For fan morphisms I just added `__mul__` as they are standalone (although it may make sense to change that...), but toric morphisms should follow coercion rules, so implementing the double underscore method as it is done now is not acceptable. And even with it there is an issue of comparing, although it does seem that the result is correct.

Anyway: let me know what you think of composition and if the rest looks OK!



---

archive/issue_comments_174896.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nI think we shouldn't do more than implement the factorization in this ticket, fixing composition of morphisms is another task. Though right now this doctest fails, maybe you want to mark it as `# known bug`?\n\n```\nsage -t sage/schemes/toric/morphism.py\n**********************************************************************\nFile \"sage/schemes/toric/morphism.py\", line 544, in sage.schemes.toric.morphism.SchemeMorphism_fan_toric_variety.factor\nFailed example:\n    prod(phi.factor()) == phi\nExpected:\n    True\nGot:\n    False\n```",
    "created_at": "2013-04-14T07:01:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174896",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">Comment 8</div>

I think we shouldn't do more than implement the factorization in this ticket, fixing composition of morphisms is another task. Though right now this doctest fails, maybe you want to mark it as `# known bug`?

```
sage -t sage/schemes/toric/morphism.py
**********************************************************************
File "sage/schemes/toric/morphism.py", line 544, in sage.schemes.toric.morphism.SchemeMorphism_fan_toric_variety.factor
Failed example:
    prod(phi.factor()) == phi
Expected:
    True
Got:
    False
```



---

archive/issue_comments_174897.json:
```json
{
    "body": "Changed work issues from **morphism composition** to none",
    "created_at": "2013-04-17T14:46:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174897",
    "user": "https://github.com/novoselt"
}
```

Changed work issues from **morphism composition** to none



---

archive/issue_events_186017.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-04-17T14:46:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186017"
}
```



---

archive/issue_events_186018.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-04-17T14:46:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186018"
}
```



---

archive/issue_comments_174898.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nAttachment: **[trac_14353_toric_morphism_factoring.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)**\n\nWell, since composition was actually working and the problem was in comparison, I've added `__cmp__` - composing factors to compare with the original is the most natural doctest here. All tests pass now, ready for review!",
    "created_at": "2013-04-17T14:46:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174898",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:9" align="right">Comment 9</div>

Attachment: **[trac_14353_toric_morphism_factoring.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)**

Well, since composition was actually working and the problem was in comparison, I've added `__cmp__` - composing factors to compare with the original is the most natural doctest here. All tests pass now, ready for review!



---

archive/issue_comments_174899.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nApply trac_14353_fan_morphism_factoring.patch trac_14353_auxiliary_methods.patch trac_14353_toric_morphism_factoring.patch",
    "created_at": "2013-06-18T20:52:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174899",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:10" align="right">Comment 10</div>

Apply trac_14353_fan_morphism_factoring.patch trac_14353_auxiliary_methods.patch trac_14353_toric_morphism_factoring.patch



---

archive/issue_comments_174900.json:
```json
{
    "body": "Attachment: **[trac_14353_toric_morphism_composition.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_composition.patch.gz)**\n\nInitial patch",
    "created_at": "2013-06-20T02:14:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174900",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_14353_toric_morphism_composition.patch.gz](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_composition.patch.gz)**

Initial patch



---

archive/issue_comments_174901.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,3 +4,4 @@\n 1. [attachment: trac_14353_fan_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)\n 2. [attachment: trac_14353_auxiliary_methods.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)\n 3. [attachment: trac_14353_toric_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)\n+4. [attachment: trac_14353_toric_morphism_composition.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_composition.patch.gz)\n``````\n",
    "created_at": "2013-06-20T02:14:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174901",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,3 +4,4 @@
 1. [attachment: trac_14353_fan_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_fan_morphism_factoring.patch.gz)
 2. [attachment: trac_14353_auxiliary_methods.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_auxiliary_methods.patch.gz)
 3. [attachment: trac_14353_toric_morphism_factoring.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_factoring.patch.gz)
+4. [attachment: trac_14353_toric_morphism_composition.patch](https://github.com/sagemath/sage/files/ticket14353/trac_14353_toric_morphism_composition.patch.gz)
``````




---

archive/issue_events_186019.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-06-20T02:18:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186019"
}
```



---

archive/issue_events_186020.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-06-20T02:18:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186020"
}
```



---

archive/issue_comments_174902.json:
```json
{
    "body": "Changed keywords from **toric** to **toric, sd48**",
    "created_at": "2013-06-20T02:18:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174902",
    "user": "https://github.com/vbraun"
}
```

Changed keywords from **toric** to **toric, sd48**



---

archive/issue_comments_174903.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nPositive review after in-persion discussion with Andrey",
    "created_at": "2013-06-20T02:18:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174903",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">Comment 12</div>

Positive review after in-persion discussion with Andrey



---

archive/issue_comments_174904.json:
```json
{
    "body": "Merged: **sage-5.11.beta3**",
    "created_at": "2013-06-20T21:36:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174904",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.11.beta3**



---

archive/issue_events_186021.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-20T21:36:41Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186021"
}
```



---

archive/issue_events_186022.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-20T21:36:41Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14353#event-186022"
}
```



---

archive/issue_comments_174905.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nFollow-up: #14975. Please fix that soon or I will unmerge this ticket.",
    "created_at": "2013-07-26T06:11:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14353",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14353#issuecomment-174905",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:14" align="right">Comment 14</div>

Follow-up: #14975. Please fix that soon or I will unmerge this ticket.
