# Issue 14211: Crash due to missing Cython exception handling for relational_to_bool()

archive/issues_014007.json:
```json
{
    "body": "\n```\nsage: f(x)=matrix()                           \nsage: bool(f(x)==f(x))\n\nterminate called after throwing an instance of 'std::runtime_error'\n  what():  Number_T::hash() python function (__hash__) raised exception\n------------------------------------------------------------------------\nUnhandled SIGABRT: An abort() occurred in Sage.\nThis probably occurred because a *compiled* component of Sage has a bug\nin it and is not properly wrapped with sig_on(), sig_off().\nSage will now terminate.\n------------------------------------------------------------------------\n```\n\n**Assignee:** @burcin\n\nIssue created by migration from https://trac.sagemath.org/ticket/14211\n\n",
    "closed_at": "2015-10-22T08:32:18Z",
    "created_at": "2013-03-01T17:45:10Z",
    "labels": [
        "component: symbolics",
        "critical",
        "bug",
        "invalid"
    ],
    "title": "Crash due to missing Cython exception handling for relational_to_bool()",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/14211",
    "user": "https://github.com/orlitzky"
}
```

```
sage: f(x)=matrix()                           
sage: bool(f(x)==f(x))

terminate called after throwing an instance of 'std::runtime_error'
  what():  Number_T::hash() python function (__hash__) raised exception
------------------------------------------------------------------------
Unhandled SIGABRT: An abort() occurred in Sage.
This probably occurred because a *compiled* component of Sage has a bug
in it and is not properly wrapped with sig_on(), sig_off().
Sage will now terminate.
------------------------------------------------------------------------
```

**Assignee:** @burcin

Issue created by migration from https://trac.sagemath.org/ticket/14211





---

archive/issue_events_122656.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122656"
}
```



---

archive/issue_events_122657.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122657"
}
```



---

archive/issue_events_122658.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122658"
}
```



---

archive/issue_events_122659.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122659"
}
```



---

archive/issue_events_122660.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122660"
}
```



---

archive/issue_events_122661.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122661"
}
```



---

archive/issue_events_122662.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122662"
}
```



---

archive/issue_events_122663.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122663"
}
```



---

archive/issue_events_122664.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-01-31T10:00:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "critical",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122664"
}
```



---

archive/issue_events_122665.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-31T12:51:34Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122665"
}
```



---

archive/issue_events_122666.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-01-31T12:51:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122666"
}
```



---

archive/issue_comments_171949.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -5,11 +5,13 @@\n sage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         \n sage: d = (pB-pU).row()*(pB-pU).column()                                                              \n sage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()\n-sage: f1(x) == f2(x)\n-([4*(tau - 1)^2]) == ([4*tau^2 - 8*tau + 4])\n sage: bool(f1(x) == f2(x))\n terminate called after throwing an instance of 'std::runtime_error'\n   what():  Number_T::hash() python function (__hash__) raised exception\n-...\n+------------------------------------------------------------------------\n+Unhandled SIGABRT: An abort() occurred in Sage.\n+This probably occurred because a *compiled* component of Sage has a bug\n+in it and is not properly wrapped with sig_on(), sig_off().\n+Sage will now terminate.\n+------------------------------------------------------------------------\n ```\n-\n``````\n",
    "created_at": "2015-01-31T12:51:34Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171949",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -5,11 +5,13 @@
 sage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         
 sage: d = (pB-pU).row()*(pB-pU).column()                                                              
 sage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()
-sage: f1(x) == f2(x)
-([4*(tau - 1)^2]) == ([4*tau^2 - 8*tau + 4])
 sage: bool(f1(x) == f2(x))
 terminate called after throwing an instance of 'std::runtime_error'
   what():  Number_T::hash() python function (__hash__) raised exception
-...
+------------------------------------------------------------------------
+Unhandled SIGABRT: An abort() occurred in Sage.
+This probably occurred because a *compiled* component of Sage has a bug
+in it and is not properly wrapped with sig_on(), sig_off().
+Sage will now terminate.
+------------------------------------------------------------------------
 ```
-
``````




---

archive/issue_comments_171950.json:
```json
{
    "body": "**Upstream:** Reported upstream. Developers acknowledge bug.",
    "created_at": "2015-05-03T07:02:16Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171950",
    "user": "https://github.com/rwst"
}
```

**Upstream:** Reported upstream. Developers acknowledge bug.



---

archive/issue_comments_171951.json:
```json
{
    "body": "<a id='comment:7'></a>\nReported as https://github.com/pynac/pynac/issues/34",
    "created_at": "2015-05-03T07:02:16Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171951",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>
Reported as https://github.com/pynac/pynac/issues/34



---

archive/issue_events_122667.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-03T07:02:16Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122667"
}
```



---

archive/issue_events_122668.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-03T07:02:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122668"
}
```



---

archive/issue_comments_171952.json:
```json
{
    "body": "<a id='comment:8'></a>\nMinimal case given. In Sage `hash(matrix())` will not allow hashing probably because `PyObject_Hash` will fail and to prevent that. The fail happens in Pynac nevertheless because the check is avoided due to function expansion and there leads to the crash.\n\nOne part of the fix is preventing Sage from crashing. Surrounding the call to Pynac in `Expression::__nonzero__` with guards:\n\n```\n            sig_on()\n            pynac_result = relational_to_bool(self._gobj)\n            sig_off()\n```\nleads to:\n\n```\nsage: bool(f(x)==f(x))\nterminate called after throwing an instance of 'std::runtime_error'\n  what():  Number_T::hash() python function (__hash__) raised exception\n---------------------------------------------------------------------------\nTypeError: mutable matrices are unhashable\n```\nwhich is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?",
    "created_at": "2015-05-03T08:53:29Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171952",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>
Minimal case given. In Sage `hash(matrix())` will not allow hashing probably because `PyObject_Hash` will fail and to prevent that. The fail happens in Pynac nevertheless because the check is avoided due to function expansion and there leads to the crash.

One part of the fix is preventing Sage from crashing. Surrounding the call to Pynac in `Expression::__nonzero__` with guards:

```
            sig_on()
            pynac_result = relational_to_bool(self._gobj)
            sig_off()
```
leads to:

```
sage: bool(f(x)==f(x))
terminate called after throwing an instance of 'std::runtime_error'
  what():  Number_T::hash() python function (__hash__) raised exception
---------------------------------------------------------------------------
TypeError: mutable matrices are unhashable
```
which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?



---

archive/issue_comments_171953.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,11 +1,8 @@\n \n ```\n-sage: pU = vector([0,0])                            \n-sage: pB = vector([2,0])                            \n-sage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         \n-sage: d = (pB-pU).row()*(pB-pU).column()                                                              \n-sage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()\n-sage: bool(f1(x) == f2(x))\n+sage: f(x)=matrix()                           \n+sage: bool(f(x)==f(x))\n+\n terminate called after throwing an instance of 'std::runtime_error'\n   what():  Number_T::hash() python function (__hash__) raised exception\n ------------------------------------------------------------------------\n``````\n",
    "created_at": "2015-05-03T08:53:29Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171953",
    "user": "https://github.com/rwst"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,11 +1,8 @@
 
 ```
-sage: pU = vector([0,0])                            
-sage: pB = vector([2,0])                            
-sage: f1(tau) = (pU + (tau - 1)*(pB - pU)).row()*(pU + (tau - 1)*(pB - pU)).column()                                         
-sage: d = (pB-pU).row()*(pB-pU).column()                                                              
-sage: f2(tau) = tau^2 * d + 2*tau*(pU.row()*(pB-pU).column() - d) + (pB-2*pU).row()*(pB-2*pU).column()
-sage: bool(f1(x) == f2(x))
+sage: f(x)=matrix()                           
+sage: bool(f(x)==f(x))
+
 terminate called after throwing an instance of 'std::runtime_error'
   what():  Number_T::hash() python function (__hash__) raised exception
 ------------------------------------------------------------------------
``````




---

archive/issue_events_122669.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-03T15:00:02Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "rename": {
        "from": "Crash in GiNaC::Number_T::hash()",
        "to": "Crash due to missing sig_on in Expresion.__nonzero__"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122669"
}
```



---

archive/issue_comments_171954.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. Developers acknowledge bug.\" to \"Reported upstream. Developers deny it's a bug.\".",
    "created_at": "2015-05-03T15:00:02Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171954",
    "user": "https://github.com/rwst"
}
```

**Changing upstream** from "Reported upstream. Developers acknowledge bug." to "Reported upstream. Developers deny it's a bug.".



---

archive/issue_events_122670.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-03T15:00:27Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "rename": {
        "from": "Crash due to missing sig_on in Expresion.__nonzero__",
        "to": "Crash due to missing sig_on in Expression.__nonzero__"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122670"
}
```



---

archive/issue_comments_171955.json:
```json
{
    "body": "<a id='comment:11'></a>\nReplying to [rws](#comment%3A8):\n> which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?\n\n\nBecause the default for matrix creation is to create a mutable matrix. That's because a mutable matrix can be turned into an immutable one, but not the other way around (that requires copying the matrix to a new, mutable, one). That default is probably inconvenient for symbolics.\n\nAre you sure this is the sole problem, though? If we try this:\n\n```\ndef imm_mt(*args,**kwargs):\n    M=matrix(*args,**kwargs)\n    M.set_immutable()\n    return M\nf(x)=imm_mt()\n```\nthen we get\n\n```\nsage: hash(f(x))\n0\n```\nbut `bool(f(x)==f(x))` still crashes. is it trying to see if `f(x)*f(x)^(-1)` is one?",
    "created_at": "2015-05-03T17:07:02Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171955",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:11'></a>
Replying to [rws](#comment%3A8):
> which is the same you get with `hash(matrix())`, so quite sensible. What more? Why are matrices generated by `vector*vector` (the original case) or those in a function definition (like above) mutable at all?


Because the default for matrix creation is to create a mutable matrix. That's because a mutable matrix can be turned into an immutable one, but not the other way around (that requires copying the matrix to a new, mutable, one). That default is probably inconvenient for symbolics.

Are you sure this is the sole problem, though? If we try this:

```
def imm_mt(*args,**kwargs):
    M=matrix(*args,**kwargs)
    M.set_immutable()
    return M
f(x)=imm_mt()
```
then we get

```
sage: hash(f(x))
0
```
but `bool(f(x)==f(x))` still crashes. is it trying to see if `f(x)*f(x)^(-1)` is one?



---

archive/issue_comments_171956.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [nbruin](#comment%3A11):\n> Are you sure this is the sole problem, though?\n\nI have reopened the Pynac issue. The crash is in exactly the same call tree. It happens while trying to multiply the rhs with `-1` to get `lhs-rhs`. So:\n\n```\nsage: f(x)=matrix()\nsage: bool(f(x)==1)\nTrue\nsage: bool(1==f(x))\n<crash>\n```\nAlso no, I don't think it's the sole problem. Either Sage or Pynac will have to check somewhere before evaluating that all mutable Python objects of the expression are switched to immutable (or make immutable copies).\n\nEDIT: But that would be a different ticket: #18360",
    "created_at": "2015-05-04T06:41:12Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171956",
    "user": "https://github.com/rwst"
}
```

<a id='comment:12'></a>
Replying to [nbruin](#comment%3A11):
> Are you sure this is the sole problem, though?

I have reopened the Pynac issue. The crash is in exactly the same call tree. It happens while trying to multiply the rhs with `-1` to get `lhs-rhs`. So:

```
sage: f(x)=matrix()
sage: bool(f(x)==1)
True
sage: bool(1==f(x))
<crash>
```
Also no, I don't think it's the sole problem. Either Sage or Pynac will have to check somewhere before evaluating that all mutable Python objects of the expression are switched to immutable (or make immutable copies).

EDIT: But that would be a different ticket: #18360



---

archive/issue_comments_171957.json:
```json
{
    "body": "<a id='comment:13'></a>\nPlease read [http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions](http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions)",
    "created_at": "2015-05-04T06:48:08Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171957",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:13'></a>
Please read [http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions](http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#exceptions)



---

archive/issue_events_122671.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-04T06:48:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "rename": {
        "from": "Crash due to missing sig_on in Expression.__nonzero__",
        "to": "Crash due to missing Cython exception handling for relational_to_bool()"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122671"
}
```



---

archive/issue_comments_171958.json:
```json
{
    "body": "**Changing upstream** from \"Reported upstream. Developers deny it's a bug.\" to \"\".",
    "created_at": "2015-05-04T06:49:13Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171958",
    "user": "https://github.com/jdemeyer"
}
```

**Changing upstream** from "Reported upstream. Developers deny it's a bug." to "".



---

archive/issue_comments_171959.json:
```json
{
    "body": "**Branch:** [u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__)",
    "created_at": "2015-05-04T14:55:50Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171959",
    "user": "https://github.com/rwst"
}
```

**Branch:** [u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__)



---

archive/issue_comments_171960.json:
```json
{
    "body": "**Author:** Ralf Stephan",
    "created_at": "2015-05-04T15:11:46Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171960",
    "user": "https://github.com/rwst"
}
```

**Author:** Ralf Stephan



---

archive/issue_comments_171961.json:
```json
{
    "body": "**Commit:** [b9698e065034425ff9d563b66a59616301288958](https://github.com/sagemath/sagetrac-mirror/commit/b9698e065034425ff9d563b66a59616301288958)",
    "created_at": "2015-05-04T15:11:46Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171961",
    "user": "https://github.com/rwst"
}
```

**Commit:** [b9698e065034425ff9d563b66a59616301288958](https://github.com/sagemath/sagetrac-mirror/commit/b9698e065034425ff9d563b66a59616301288958)



---

archive/issue_events_122672.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-04T15:11:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122672"
}
```



---

archive/issue_comments_171962.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [nbruin](#comment%3A11):\n> If we try this:\n> \n> ```\n> def imm_mt(*args,**kwargs):\n>     M=matrix(*args,**kwargs)\n>     M.set_immutable()\n>     return M\n> f(x)=imm_mt()\n> ```\n> then we get\n> \n> ```\n> sage: hash(f(x))\n> 0\n> ```\n> but `bool(f(x)==f(x))` still crashes.\n\nMy best guess at the moment is that somewhere in between a copy is made which, as you suggested, is then mutable again. This can only be fixed by a dedicated ticket such as #18360. \n\nAs to this code, the reviewer should check doubly if what I did here was right. There was not a single example in Sage with a special function catching exceptions from which I could have learned.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b9698e065034425ff9d563b66a59616301288958\">b9698e0</a></td><td><code>14211: catch exceptions from Expression.__nonzero__</code></td></tr></table>\n",
    "created_at": "2015-05-04T15:11:46Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171962",
    "user": "https://github.com/rwst"
}
```

<a id='comment:17'></a>
Replying to [nbruin](#comment%3A11):
> If we try this:
> 
> ```
> def imm_mt(*args,**kwargs):
>     M=matrix(*args,**kwargs)
>     M.set_immutable()
>     return M
> f(x)=imm_mt()
> ```
> then we get
> 
> ```
> sage: hash(f(x))
> 0
> ```
> but `bool(f(x)==f(x))` still crashes.

My best guess at the moment is that somewhere in between a copy is made which, as you suggested, is then mutable again. This can only be fixed by a dedicated ticket such as #18360. 

As to this code, the reviewer should check doubly if what I did here was right. There was not a single example in Sage with a special function catching exceptions from which I could have learned.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b9698e065034425ff9d563b66a59616301288958">b9698e0</a></td><td><code>14211: catch exceptions from Expression.__nonzero__</code></td></tr></table>




---

archive/issue_comments_171963.json:
```json
{
    "body": "<a id='comment:18'></a>\nObviously, a doctest is needed.\n\nBesides that, it makes no sense to add an additional layer `_nonzero_`. The exception should be handled in the pynac interface, i.e. the `relational_to_bool()` function.",
    "created_at": "2015-05-04T16:19:45Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171963",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Obviously, a doctest is needed.

Besides that, it makes no sense to add an additional layer `_nonzero_`. The exception should be handled in the pynac interface, i.e. the `relational_to_bool()` function.



---

archive/issue_events_122673.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-04T16:19:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122673"
}
```



---

archive/issue_events_122674.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-04T16:19:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122674"
}
```



---

archive/issue_comments_171964.json:
```json
{
    "body": "**Changing branch** from \"[u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__)\" to \"[u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)\".",
    "created_at": "2015-05-05T06:39:31Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171964",
    "user": "https://github.com/rwst"
}
```

**Changing branch** from "[u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/crash_due_to_missing_cython_exception_handling_for_relational_to_bool__)" to "[u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)".



---

archive/issue_comments_171965.json:
```json
{
    "body": "<a id='comment:20'></a>\nInteresting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.\n  \n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30\">e1374da</a></td><td><code>14211: catch Pynac exceptions</code></td></tr></table>\n",
    "created_at": "2015-05-05T06:42:44Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171965",
    "user": "https://github.com/rwst"
}
```

<a id='comment:20'></a>
Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.
  
---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30">e1374da</a></td><td><code>14211: catch Pynac exceptions</code></td></tr></table>




---

archive/issue_events_122675.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-05T06:42:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122675"
}
```



---

archive/issue_events_122676.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-05-05T06:42:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122676"
}
```



---

archive/issue_comments_171966.json:
```json
{
    "body": "**Changing commit** from \"[b9698e065034425ff9d563b66a59616301288958](https://github.com/sagemath/sagetrac-mirror/commit/b9698e065034425ff9d563b66a59616301288958)\" to \"[e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)\".",
    "created_at": "2015-05-05T06:42:44Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171966",
    "user": "https://github.com/rwst"
}
```

**Changing commit** from "[b9698e065034425ff9d563b66a59616301288958](https://github.com/sagemath/sagetrac-mirror/commit/b9698e065034425ff9d563b66a59616301288958)" to "[e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)".



---

archive/issue_comments_171967.json:
```json
{
    "body": "<a id='comment:21'></a>\nReplying to [rws](#comment%3A20):\n> Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.\n\n\nWell, behaviour shouldn't depend on what \"presumably\" happens (does the traceback look sensible? If not, you're certainly doing it wrong). I admit I don't know the proper way to deal with this (a C++ exception and `PyErr_Occurred() != NULL`), but it's not right like this.\n\nBesides that, I would never print the C++ exception.",
    "created_at": "2015-05-05T07:16:01Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171967",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
Replying to [rws](#comment%3A20):
> Interesting. The C++ layer outputs an error message, and the Python layer deals with the error too, because presumably the error from calling `PyHash` from the C++ layer is still pending.


Well, behaviour shouldn't depend on what "presumably" happens (does the traceback look sensible? If not, you're certainly doing it wrong). I admit I don't know the proper way to deal with this (a C++ exception and `PyErr_Occurred() != NULL`), but it's not right like this.

Besides that, I would never print the C++ exception.



---

archive/issue_events_122677.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-05T07:16:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122677"
}
```



---

archive/issue_events_122678.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2015-05-05T07:16:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122678"
}
```



---

archive/issue_comments_171968.json:
```json
{
    "body": "<a id='comment:23'></a>\nI can have a look at how to properly deal with this, but not now.",
    "created_at": "2015-05-05T07:19:43Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171968",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:23'></a>
I can have a look at how to properly deal with this, but not now.



---

archive/issue_comments_171969.json:
```json
{
    "body": "**Changing commit** from \"[e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)\" to \"\".",
    "created_at": "2015-06-17T14:34:19Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171969",
    "user": "https://github.com/rwst"
}
```

**Changing commit** from "[e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)" to "".



---

archive/issue_comments_171970.json:
```json
{
    "body": "**Changing author** from \"Ralf Stephan\" to \"\".",
    "created_at": "2015-06-17T14:34:19Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171970",
    "user": "https://github.com/rwst"
}
```

**Changing author** from "Ralf Stephan" to "".



---

archive/issue_comments_171971.json:
```json
{
    "body": "**Changing branch** from \"[u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)\" to \"\".",
    "created_at": "2015-06-17T14:34:19Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171971",
    "user": "https://github.com/rwst"
}
```

**Changing branch** from "[u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)" to "".



---

archive/issue_comments_171972.json:
```json
{
    "body": "<a id='comment:24'></a>\nNow that the actual bug is fixed in future Pynac (#18360) the given doctest will not work in the future, so I removed the commit.",
    "created_at": "2015-06-17T14:34:19Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171972",
    "user": "https://github.com/rwst"
}
```

<a id='comment:24'></a>
Now that the actual bug is fixed in future Pynac (#18360) the given doctest will not work in the future, so I removed the commit.



---

archive/issue_comments_171973.json:
```json
{
    "body": "<a id='comment:25'></a>\nBranch reset because other exceptions can be thrown.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30\">e1374da</a></td><td><code>14211: catch Pynac exceptions</code></td></tr></table>\n",
    "created_at": "2015-06-22T15:03:48Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171973",
    "user": "https://github.com/rwst"
}
```

<a id='comment:25'></a>
Branch reset because other exceptions can be thrown.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30">e1374da</a></td><td><code>14211: catch Pynac exceptions</code></td></tr></table>




---

archive/issue_comments_171974.json:
```json
{
    "body": "**Commit:** [e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)",
    "created_at": "2015-06-22T15:03:48Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171974",
    "user": "https://github.com/rwst"
}
```

**Commit:** [e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)



---

archive/issue_comments_171975.json:
```json
{
    "body": "**Branch:** [u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)",
    "created_at": "2015-06-22T15:03:48Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171975",
    "user": "https://github.com/rwst"
}
```

**Branch:** [u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)



---

archive/issue_events_122679.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-10-19T14:09:03Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122679"
}
```



---

archive/issue_events_122680.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-10-19T14:09:03Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122680"
}
```



---

archive/issue_comments_171976.json:
```json
{
    "body": "**Changing commit** from \"[e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)\" to \"\".",
    "created_at": "2015-10-19T14:09:03Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171976",
    "user": "https://github.com/rwst"
}
```

**Changing commit** from "[e1374da2834bca4788084c91972e8c8c714e3b30](https://github.com/sagemath/sagetrac-mirror/commit/e1374da2834bca4788084c91972e8c8c714e3b30)" to "".



---

archive/issue_events_122681.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-10-19T14:09:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "milestone": "sage-6.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122681"
}
```



---

archive/issue_comments_171977.json:
```json
{
    "body": "**Changing branch** from \"[u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)\" to \"\".",
    "created_at": "2015-10-19T14:09:03Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171977",
    "user": "https://github.com/rwst"
}
```

**Changing branch** from "[u/rws/14211](https://github.com/sagemath/sagetrac-mirror/tree/u/rws/14211)" to "".



---

archive/issue_comments_171978.json:
```json
{
    "body": "<a id='comment:26'></a>\nNo longer necessary (doctest added in #18360)",
    "created_at": "2015-10-19T14:09:03Z",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14211#issuecomment-171978",
    "user": "https://github.com/rwst"
}
```

<a id='comment:26'></a>
No longer necessary (doctest added in #18360)



---

archive/issue_events_122682.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-10-22T08:32:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122682"
}
```



---

archive/issue_events_122683.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-10-22T08:32:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14211",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14211#event-122683"
}
```
