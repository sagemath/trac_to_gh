# Issue 14909: Gap package HAP does not load

archive/issues_014705.json:
```json
{
    "assignees": [],
    "body": "The optional `gap_packages` spkg contains HAP, but it fails to load because of missing dependency on polycyclic. See http://ask.sagemath.org/question/2822/how-to-load-optional-gap-packages\n\nUpdated optional spkg: http://boxen.math.washington.edu/home/vbraun/spkg/gap_packages-4.6.4.p1.spkg\n\nApply [attachment: trac_14909_gap_packages_doctests.patch\u200b](https://github.com/sagemath/sage/files/ticket14909/8a2d437ed2a57812a359042671a68605.gz) to the Sage library\n\nCC:  @SnarkBoojum @miguelmarco @tscrim @dimpase @nilesjohnson @wdjoyner\n\nReviewer: **Niles Johnson**\n\nAuthor: **Volker Braun**\n\nMerged: **sage-5.12.beta0**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14909_\n\n",
    "closed_at": "2013-08-02T14:18:29Z",
    "created_at": "2013-07-18T19:34:07Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.12",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Gap package HAP does not load",
    "type": "issue",
    "updated_at": "2013-08-02T14:18:29Z",
    "url": "https://github.com/sagemath/sage/issues/14909",
    "user": "https://github.com/vbraun"
}
```
The optional `gap_packages` spkg contains HAP, but it fails to load because of missing dependency on polycyclic. See http://ask.sagemath.org/question/2822/how-to-load-optional-gap-packages

Updated optional spkg: http://boxen.math.washington.edu/home/vbraun/spkg/gap_packages-4.6.4.p1.spkg

Apply [attachment: trac_14909_gap_packages_doctests.patch​](https://github.com/sagemath/sage/files/ticket14909/8a2d437ed2a57812a359042671a68605.gz) to the Sage library

CC:  @SnarkBoojum @miguelmarco @tscrim @dimpase @nilesjohnson @wdjoyner

Reviewer: **Niles Johnson**

Author: **Volker Braun**

Merged: **sage-5.12.beta0**

_Issue created by migration from https://trac.sagemath.org/ticket/14909_





---

archive/issue_events_194701.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-18T19:34:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194701"
}
```



---

archive/issue_events_194702.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-18T19:34:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20packages%3A%20optional",
    "label_color": "000080",
    "label_name": "component: packages: optional",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194702"
}
```



---

archive/issue_events_194703.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-18T19:34:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194703"
}
```



---

archive/issue_events_194704.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-18T19:34:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194704"
}
```



---

archive/issue_comments_185483.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nIt seems that a number of packages fail to load, possibly for similar reasons.  Perhaps the people from #14682 know how to fix this:\n\n\n```\nsage: optional_packages()[0]\n['database_gap-4.6.4', 'gap_packages-4.6.4']\nsage: version()\n'Sage Version 5.11.beta3, Release Date: 2013-06-21'\n```\n\n```\nsage: gap_package_names = ['braid','crime','cryst','ctbllib','design','factint','gapdoc','grape','guava','hap','hapcryst','happrime','laguna','polymake','sonata','toric']\n\nsage: for name in gap_package_names:\n    stat = gap('LoadPackage(\"{0}\")'.format(name))\n    prefix = ' ' if str(stat) == 'true' else 'x'\n    print(\"{2} : {0: <8} got '{1}' when loading.\".format(name,stat,prefix))\n....:     \n\n  : braid    got 'true' when loading.\n  : crime    got 'true' when loading.\nx : cryst    got 'fail' when loading.\n  : ctbllib  got 'true' when loading.\n  : design   got 'true' when loading.\n  : factint  got 'true' when loading.\n  : gapdoc   got 'true' when loading.\n  : grape    got 'true' when loading.\n  : guava    got 'true' when loading.\nx : hap      got 'fail' when loading.\nx : hapcryst got 'fail' when loading.\nx : happrime got 'fail' when loading.\n  : laguna   got 'true' when loading.\nx : polymake got 'fail' when loading.\n  : sonata   got 'true' when loading.\n  : toric    got 'true' when loading.\n\n```\n\nThis leads to a number of failing doctests:\n\n```\n$ ./sage -t --optional=gap_packages devel/sage/sage\n\n----------------------------------------------------------------------\nsage -t devel/sage/sage/coding/linear_code.py  # 12 doctests failed\nsage -t devel/sage/sage/combinat/designs/incidence_structures.py  # 2 doctests failed\nsage -t devel/sage/sage/combinat/designs/design_catalog.py  # 1 doctest failed\nsage -t devel/sage/sage/groups/perm_gps/permgroup.py  # 19 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2013-07-18T20:39:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185483",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:1" align="right">Comment 1</div>

It seems that a number of packages fail to load, possibly for similar reasons.  Perhaps the people from #14682 know how to fix this:


```
sage: optional_packages()[0]
['database_gap-4.6.4', 'gap_packages-4.6.4']
sage: version()
'Sage Version 5.11.beta3, Release Date: 2013-06-21'
```

```
sage: gap_package_names = ['braid','crime','cryst','ctbllib','design','factint','gapdoc','grape','guava','hap','hapcryst','happrime','laguna','polymake','sonata','toric']

sage: for name in gap_package_names:
    stat = gap('LoadPackage("{0}")'.format(name))
    prefix = ' ' if str(stat) == 'true' else 'x'
    print("{2} : {0: <8} got '{1}' when loading.".format(name,stat,prefix))
....:     

  : braid    got 'true' when loading.
  : crime    got 'true' when loading.
x : cryst    got 'fail' when loading.
  : ctbllib  got 'true' when loading.
  : design   got 'true' when loading.
  : factint  got 'true' when loading.
  : gapdoc   got 'true' when loading.
  : grape    got 'true' when loading.
  : guava    got 'true' when loading.
x : hap      got 'fail' when loading.
x : hapcryst got 'fail' when loading.
x : happrime got 'fail' when loading.
  : laguna   got 'true' when loading.
x : polymake got 'fail' when loading.
  : sonata   got 'true' when loading.
  : toric    got 'true' when loading.

```

This leads to a number of failing doctests:

```
$ ./sage -t --optional=gap_packages devel/sage/sage

----------------------------------------------------------------------
sage -t devel/sage/sage/coding/linear_code.py  # 12 doctests failed
sage -t devel/sage/sage/combinat/designs/incidence_structures.py  # 2 doctests failed
sage -t devel/sage/sage/combinat/designs/design_catalog.py  # 1 doctest failed
sage -t devel/sage/sage/groups/perm_gps/permgroup.py  # 19 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_185484.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nFixed by adding missing dependency packages. Will upload spkg tomorrow. \n\nAlso, HAPprime was never included, fixed in the docs. \n\nThe packages cryst isn't included and therefore HAPcryst can't work. I'll leave this for later.",
    "created_at": "2013-07-19T03:31:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185484",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:2" align="right">Comment 2</div>

Fixed by adding missing dependency packages. Will upload spkg tomorrow. 

Also, HAPprime was never included, fixed in the docs. 

The packages cryst isn't included and therefore HAPcryst can't work. I'll leave this for later.



---

archive/issue_events_194705.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-19T17:54:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194705"
}
```



---

archive/issue_comments_185485.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,5 @@\n The optional `gap_packages` spkg contains HAP, but it fails to load because of missing dependency on polycyclic. See http://ask.sagemath.org/question/2822/how-to-load-optional-gap-packages\n+\n+Updated optional spkg: http://boxen.math.washington.edu/home/vbraun/spkg/gap_packages-4.6.4.p1.spkg\n+\n+Apply [attachment: trac_14909_gap_packages_doctests.patch\u200b](https://github.com/sagemath/sage/files/ticket14909/8a2d437ed2a57812a359042671a68605.gz) to the Sage library\n``````\n",
    "created_at": "2013-07-19T17:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185485",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,5 @@
 The optional `gap_packages` spkg contains HAP, but it fails to load because of missing dependency on polycyclic. See http://ask.sagemath.org/question/2822/how-to-load-optional-gap-packages
+
+Updated optional spkg: http://boxen.math.washington.edu/home/vbraun/spkg/gap_packages-4.6.4.p1.spkg
+
+Apply [attachment: trac_14909_gap_packages_doctests.patch​](https://github.com/sagemath/sage/files/ticket14909/8a2d437ed2a57812a359042671a68605.gz) to the Sage library
``````




---

archive/issue_comments_185486.json:
```json
{
    "body": "Author: **Volker Braun**",
    "created_at": "2013-07-19T17:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185486",
    "user": "https://github.com/vbraun"
}
```

Author: **Volker Braun**



---

archive/issue_comments_185487.json:
```json
{
    "body": "Branch: **[u/niles/14909](https://github.com/sagemath/sagetrac-mirror/tree/u/niles/14909)**",
    "created_at": "2013-07-19T19:29:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185487",
    "user": "https://github.com/nilesjohnson"
}
```

Branch: **[u/niles/14909](https://github.com/sagemath/sagetrac-mirror/tree/u/niles/14909)**



---

archive/issue_comments_185488.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">Comment 4</div>\n\nI had trouble with this at first, and then I realized one needs to use `--optional=sage,gap_packages`; without `sage` there, `_only_` the #optional lines are run, which makes a lot of tests fail.  (The tests above still fail with `--optional=sage,gap_packages` though.)\n\nI like the idea of adding tests for the gap packages, but maybe the test in this patch is too verbose.  It would fail, for example, if the user had some extra gap packages installed manually, even if they load correctly.  Thoughts on changing it to something like the following?\n\n```\n    sage: from sage.tests.gap_packages import all_installed_packages                  \n    sage: for name in all_installed_packages():       # optional: gap_packages        \n    ....:     stat = libgap.eval('LoadPackage(\"{0}\")'.format(name))                   \n    ....:     message = \"{2} : {0: <10} got '{1}' when loading.\"                      \n    ....:     if str(stat) == 'true':                                                 \n    ....:         prefix = ' '                                                        \n    ....:     else:                                                                   \n    ....:         prefix = 'x'                                                        \n    ....:         print(message.format(name,stat,prefix))                                                                                 \n    x : HAPcryst   got 'fail' when loading.       \n```\n\nIn fact, maybe I have attached a git branch with this version of the test! (Still figuring out the git workflow . . .)\n\n\nAnd another issue:  Why do we have \n\n```\n$ ./sage -t --optional=sage,gap_packages src/sage/tests/gap_packages.py \nRunning doctests with ID 2013-07-19-15-20-57-fee4b5ac.\n...\nTotal time for all tests: 7.3 seconds\n    cpu time: 7.2 seconds\n    cumulative wall time: 7.2 seconds\n```\n\nand\n\n```\nsage: %time import sage.tests.gap_packages\nCPU times: user 5.55 s, sys: 0.05 s, total: 5.61 s\nWall time: 5.61 s\n```\n\nThe rest of the things in sage/tests seem to import instantly . . . is there something I'm doing wrong which makes this one so slow?",
    "created_at": "2013-07-19T19:29:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185488",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:4" align="right">Comment 4</div>

I had trouble with this at first, and then I realized one needs to use `--optional=sage,gap_packages`; without `sage` there, `_only_` the #optional lines are run, which makes a lot of tests fail.  (The tests above still fail with `--optional=sage,gap_packages` though.)

I like the idea of adding tests for the gap packages, but maybe the test in this patch is too verbose.  It would fail, for example, if the user had some extra gap packages installed manually, even if they load correctly.  Thoughts on changing it to something like the following?

```
    sage: from sage.tests.gap_packages import all_installed_packages                  
    sage: for name in all_installed_packages():       # optional: gap_packages        
    ....:     stat = libgap.eval('LoadPackage("{0}")'.format(name))                   
    ....:     message = "{2} : {0: <10} got '{1}' when loading."                      
    ....:     if str(stat) == 'true':                                                 
    ....:         prefix = ' '                                                        
    ....:     else:                                                                   
    ....:         prefix = 'x'                                                        
    ....:         print(message.format(name,stat,prefix))                                                                                 
    x : HAPcryst   got 'fail' when loading.       
```

In fact, maybe I have attached a git branch with this version of the test! (Still figuring out the git workflow . . .)


And another issue:  Why do we have 

```
$ ./sage -t --optional=sage,gap_packages src/sage/tests/gap_packages.py 
Running doctests with ID 2013-07-19-15-20-57-fee4b5ac.
...
Total time for all tests: 7.3 seconds
    cpu time: 7.2 seconds
    cumulative wall time: 7.2 seconds
```

and

```
sage: %time import sage.tests.gap_packages
CPU times: user 5.55 s, sys: 0.05 s, total: 5.61 s
Wall time: 5.61 s
```

The rest of the things in sage/tests seem to import instantly . . . is there something I'm doing wrong which makes this one so slow?



---

archive/issue_events_194706.json:
```json
{
    "actor": "https://github.com/nilesjohnson",
    "created_at": "2013-07-19T19:29:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194706"
}
```



---

archive/issue_events_194707.json:
```json
{
    "actor": "https://github.com/nilesjohnson",
    "created_at": "2013-07-19T19:29:40Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194707"
}
```



---

archive/issue_comments_185489.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nActually, maybe I should leave the \"Branch\" field for the branch which the patch author might submit, so I can be the patch reviewer.  I guess someone who finds it useful can view my commits at\n\nhttp://trac.sagemath.org/browser/?rev=6b5515c48c7440a7c15e81937883a39130bbff8e\n\nand (somehow) merge the branch u/niles/14909.",
    "created_at": "2013-07-19T19:44:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185489",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:5" align="right">Comment 5</div>

Actually, maybe I should leave the "Branch" field for the branch which the patch author might submit, so I can be the patch reviewer.  I guess someone who finds it useful can view my commits at

http://trac.sagemath.org/browser/?rev=6b5515c48c7440a7c15e81937883a39130bbff8e

and (somehow) merge the branch u/niles/14909.



---

archive/issue_comments_185490.json:
```json
{
    "body": "Changed branch from **[u/niles/14909](https://github.com/sagemath/sagetrac-mirror/tree/u/niles/14909)** to none",
    "created_at": "2013-07-19T19:44:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185490",
    "user": "https://github.com/nilesjohnson"
}
```

Changed branch from **[u/niles/14909](https://github.com/sagemath/sagetrac-mirror/tree/u/niles/14909)** to none



---

archive/issue_comments_185491.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nI've updated the patch to only check for the failures and some misc cleanup. Since we don't have a way of working with optional spkgs yet I propose to stick to the old workflow in this ticket.\n\nStartup is probably slow since this makes use of libgap, which doesn't yet use cached workspaces (search trac if you want to know more)",
    "created_at": "2013-07-20T02:24:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185491",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:6" align="right">Comment 6</div>

I've updated the patch to only check for the failures and some misc cleanup. Since we don't have a way of working with optional spkgs yet I propose to stick to the old workflow in this ticket.

Startup is probably slow since this makes use of libgap, which doesn't yet use cached workspaces (search trac if you want to know more)



---

archive/issue_events_194708.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-20T02:24:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194708"
}
```



---

archive/issue_events_194709.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-20T02:24:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194709"
}
```



---

archive/issue_events_194710.json:
```json
{
    "actor": "https://github.com/nilesjohnson",
    "created_at": "2013-07-22T15:24:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194710"
}
```



---

archive/issue_events_194711.json:
```json
{
    "actor": "https://github.com/nilesjohnson",
    "created_at": "2013-07-22T15:24:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194711"
}
```



---

archive/issue_comments_185492.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nIndeed, I have verified that all of the import time comes from importing libgap.  The new version of the patch looks good, and in particular the new test for loading packages is much better.\n\nNow checking (long) doctests, I find failures in 3 files:\n\n```\n----------------------------------------------------------------------\nsage -t --long sage/combinat/designs/incidence_structures.py  # 2 doctests failed\nsage -t --long sage/combinat/designs/design_catalog.py  # 1 doctest failed\nsage -t --long sage/coding/linear_code.py  # 8 doctests failed\n----------------------------------------------------------------------\n```\n\n\nThe first two seem to be introduced by #14499; fixing these is now #14950\n\n\n\n\nThe failures in coding/linear_code are all in optional `gap_packages` doctests, and they all have to do with the GUAVA package.  My guess is that these come from a version change or something similar, because guava does load, and some guava-dependent doctests do work, such as\n\n```\nsage: C = HammingCode(5,GF(2))\nsage: C.covering_radius()  # optional - gap_packages (Guava package)\n1\n```\n\n```\nsage: C = HammingCode(3,GF(2))\nsage: MS = MatrixSpace(GF(2),1,7)\nsage: F = GF(2); a = F.gen()\nsage: v1 = [a,a,F(0),a,a,F(0),a]\nsage: C.decode(v1,algorithm=\"guava\")  # optional - gap_packages (Guava package)\n```\n\nOne failure comes from \n\n```\nsage: print bounds_minimum_distance(10,5,GF(2)) # optional - gap_packages (Guava package)\n```\n\nThis seems to give the same record as expected (see [here](http://www.sagemath.org/doc/reference/coding/sage/coding/linear_code.html#sage.coding.linear_code.bounds_minimum_distance)), but the entries aren't printed in the correct order, hence causing a doctest failure.\n\n\nAnother failure comes from \n\n```\nsage: MS = MatrixSpace(GF(2),4,7)\nsage: G = MS([[1,1,1,0,0,0,0],[1,0,0,1,1,0,0],[0,1,0,1,0,1,0],[1,1,0,1,0,0,1]])\nsage: C = LinearCode(G)\nsage: C.spectrum()\n[1, 0, 0, 7, 7, 0, 0, 1]\nsage: C.spectrum(algorithm=\"leon\")     # optional - gap_packages (Guava package)\nsh: /home/johnson.5320/sage/local/gap/latest/pkg/guava-3.12/bin/wtdist: No such file or directory\n---------------------------------------------------------------------------\nRuntimeError                              Traceback (most recent call last)\n...\nRuntimeError: Problem calling Leon's wtdist program. Install gap_packages*.spkg and run './configure ../..; make'.\n```\n\nFor this last error, I see that the file \n\n`SAGE_ROOT/local/gap/latest/pkg/guava-3.12/bin/wtdist` \n\ndoes not exist, but  \n\n`SAGE_ROOT/local/gap/latest/pkg/guava-3.12/bin/x86_64-unknown-linux-gnu-gcc-default64/wtdist` \n\ndoes exist.  So probably this is an error coming from rearranging files.  I haven't checked the other failures here; I am inclined to believe that fixing them belongs on a new ticket, but I'm not sure.",
    "created_at": "2013-07-22T15:24:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185492",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:7" align="right">Comment 7</div>

Indeed, I have verified that all of the import time comes from importing libgap.  The new version of the patch looks good, and in particular the new test for loading packages is much better.

Now checking (long) doctests, I find failures in 3 files:

```
----------------------------------------------------------------------
sage -t --long sage/combinat/designs/incidence_structures.py  # 2 doctests failed
sage -t --long sage/combinat/designs/design_catalog.py  # 1 doctest failed
sage -t --long sage/coding/linear_code.py  # 8 doctests failed
----------------------------------------------------------------------
```


The first two seem to be introduced by #14499; fixing these is now #14950




The failures in coding/linear_code are all in optional `gap_packages` doctests, and they all have to do with the GUAVA package.  My guess is that these come from a version change or something similar, because guava does load, and some guava-dependent doctests do work, such as

```
sage: C = HammingCode(5,GF(2))
sage: C.covering_radius()  # optional - gap_packages (Guava package)
1
```

```
sage: C = HammingCode(3,GF(2))
sage: MS = MatrixSpace(GF(2),1,7)
sage: F = GF(2); a = F.gen()
sage: v1 = [a,a,F(0),a,a,F(0),a]
sage: C.decode(v1,algorithm="guava")  # optional - gap_packages (Guava package)
```

One failure comes from 

```
sage: print bounds_minimum_distance(10,5,GF(2)) # optional - gap_packages (Guava package)
```

This seems to give the same record as expected (see [here](http://www.sagemath.org/doc/reference/coding/sage/coding/linear_code.html#sage.coding.linear_code.bounds_minimum_distance)), but the entries aren't printed in the correct order, hence causing a doctest failure.


Another failure comes from 

```
sage: MS = MatrixSpace(GF(2),4,7)
sage: G = MS([[1,1,1,0,0,0,0],[1,0,0,1,1,0,0],[0,1,0,1,0,1,0],[1,1,0,1,0,0,1]])
sage: C = LinearCode(G)
sage: C.spectrum()
[1, 0, 0, 7, 7, 0, 0, 1]
sage: C.spectrum(algorithm="leon")     # optional - gap_packages (Guava package)
sh: /home/johnson.5320/sage/local/gap/latest/pkg/guava-3.12/bin/wtdist: No such file or directory
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
...
RuntimeError: Problem calling Leon's wtdist program. Install gap_packages*.spkg and run './configure ../..; make'.
```

For this last error, I see that the file 

`SAGE_ROOT/local/gap/latest/pkg/guava-3.12/bin/wtdist` 

does not exist, but  

`SAGE_ROOT/local/gap/latest/pkg/guava-3.12/bin/x86_64-unknown-linux-gnu-gcc-default64/wtdist` 

does exist.  So probably this is an error coming from rearranging files.  I haven't checked the other failures here; I am inclined to believe that fixing them belongs on a new ticket, but I'm not sure.



---

archive/issue_comments_185493.json:
```json
{
    "body": "Attachment: **[trac_14909_gap_packages_doctests.patch.gz](https://github.com/sagemath/sage/files/ticket14909/trac_14909_gap_packages_doctests.patch.gz)**\n\nUpdated patch",
    "created_at": "2013-07-22T21:06:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185493",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_14909_gap_packages_doctests.patch.gz](https://github.com/sagemath/sage/files/ticket14909/trac_14909_gap_packages_doctests.patch.gz)**

Updated patch



---

archive/issue_comments_185494.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nI've fixed the guava package path and the trivial failures. There are still three failures in linear_code.py with guava that seem to be bugs in guava. For all of them we have native code that does the same, only the optional guava-based implementation fails. Needs to be debugged further by somebody else.",
    "created_at": "2013-07-22T21:11:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185494",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:8" align="right">Comment 8</div>

I've fixed the guava package path and the trivial failures. There are still three failures in linear_code.py with guava that seem to be bugs in guava. For all of them we have native code that does the same, only the optional guava-based implementation fails. Needs to be debugged further by somebody else.



---

archive/issue_comments_185495.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nReplying to [@vbraun](#comment%3A8):\n> I've fixed the guava package path and the trivial failures. There are still three failures in linear_code.py with guava that seem to be bugs in guava. For all of them we have native code that does the same, only the optional guava-based implementation fails. Needs to be debugged further by somebody else.\n\nis this a libgap-related issue? I'm not aware of guava bugs in the \"main\" Sage code.",
    "created_at": "2013-07-23T08:36:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185495",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">Comment 9</div>

Replying to [@vbraun](#comment%3A8):
> I've fixed the guava package path and the trivial failures. There are still three failures in linear_code.py with guava that seem to be bugs in guava. For all of them we have native code that does the same, only the optional guava-based implementation fails. Needs to be debugged further by somebody else.

is this a libgap-related issue? I'm not aware of guava bugs in the "main" Sage code.



---

archive/issue_comments_185496.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nIt could be a libgap issue; I've pasted the output of the 3 failing tests below.  Since we are now talking about nontrivial problems with either guava or libgap on a ticket whose issue was loading the HAP package, I propose that we finish this one and open a new ticket for the guava failures.  \n\nWhile we're at it, we might try to think of ways to ensure that the optional doctests are somehow run more regularly.  I don't see how to phrase this as a reasonable ticket (it seems more like a general complaint than a specific fixable problem), and I imagine there have already been some attempts at doing this.\n\n```\nFile \"sage/coding/linear_code.py\", line 1311, in sage.coding.linear_code.LinearCode.decode\nFailed example:\n    C.decode(v, algorithm=\"guava\")  # optional - gap_packages (Guava package)\nException raised:\n    Traceback (most recent call last):\n    ...\n    RuntimeError: Gap produced error output\n    Error, List Element: <list>[2] must have an assigned value\n\n       executing Decodeword($sage11,$sage32);\n```\n\n```\nFile \"sage/coding/linear_code.py\", line 2165, in sage.coding.linear_code.LinearCode.permutation_automorphism_group\nFailed example:\n    C.permutation_automorphism_group(algorithm=\"gap\")  # optional - gap_packages (Guava package)\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: Gap produced error output\n    Error, no method found! For debugging hints type ?Recovery from NoMethodFound\n    Error, no 1st choice method found for `MatrixAutomorphisms' on 1 arguments\n\n       executing $sage19:=MatrixAutomorphisms(matCwt);;\n```\n\n```\nFile \"sage/coding/linear_code.py\", line 2167, in sage.coding.linear_code.LinearCode.permutation_automorphism_group\nFailed example:\n    C.permutation_automorphism_group(algorithm=\"gap\")  # optional - gap_packages (Guava package)\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: Gap produced error output\n    Error, no method found! For debugging hints type ?Recovery from NoMethodFound\n    Error, no 1st choice method found for `MatrixAutomorphisms' on 1 arguments\n\n       executing $sage31:=MatrixAutomorphisms(matCwt);;\n```",
    "created_at": "2013-07-23T12:45:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185496",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:10" align="right">Comment 10</div>

It could be a libgap issue; I've pasted the output of the 3 failing tests below.  Since we are now talking about nontrivial problems with either guava or libgap on a ticket whose issue was loading the HAP package, I propose that we finish this one and open a new ticket for the guava failures.  

While we're at it, we might try to think of ways to ensure that the optional doctests are somehow run more regularly.  I don't see how to phrase this as a reasonable ticket (it seems more like a general complaint than a specific fixable problem), and I imagine there have already been some attempts at doing this.

```
File "sage/coding/linear_code.py", line 1311, in sage.coding.linear_code.LinearCode.decode
Failed example:
    C.decode(v, algorithm="guava")  # optional - gap_packages (Guava package)
Exception raised:
    Traceback (most recent call last):
    ...
    RuntimeError: Gap produced error output
    Error, List Element: <list>[2] must have an assigned value

       executing Decodeword($sage11,$sage32);
```

```
File "sage/coding/linear_code.py", line 2165, in sage.coding.linear_code.LinearCode.permutation_automorphism_group
Failed example:
    C.permutation_automorphism_group(algorithm="gap")  # optional - gap_packages (Guava package)
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: Gap produced error output
    Error, no method found! For debugging hints type ?Recovery from NoMethodFound
    Error, no 1st choice method found for `MatrixAutomorphisms' on 1 arguments

       executing $sage19:=MatrixAutomorphisms(matCwt);;
```

```
File "sage/coding/linear_code.py", line 2167, in sage.coding.linear_code.LinearCode.permutation_automorphism_group
Failed example:
    C.permutation_automorphism_group(algorithm="gap")  # optional - gap_packages (Guava package)
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: Gap produced error output
    Error, no method found! For debugging hints type ?Recovery from NoMethodFound
    Error, no 1st choice method found for `MatrixAutomorphisms' on 1 arguments

       executing $sage31:=MatrixAutomorphisms(matCwt);;
```



---

archive/issue_comments_185497.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">Comment 11</div>\n\nNone of the failing doctests uses libgap, its all ancient code using the gap pexpect interface. At least one of them works fine with prime finite fields but fails in the non-prime case:\n\n```\n            sage: F.<a> = GF(4)\n            sage: C = HammingCode(2,F)\n            sage: v = vector(F, [1,0,0,a,1])\n            sage: C.decode(v)\n            (a + 1, 0, 0, a, 1)\n            sage: C.decode(v, algorithm=\"nearest neighbor\")\n            (a + 1, 0, 0, a, 1)\n            sage: C.decode(v, algorithm=\"guava\")  # optional - gap_packages (Guava package)\n            BOOM!\n```",
    "created_at": "2013-07-23T14:53:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185497",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:11" align="right">Comment 11</div>

None of the failing doctests uses libgap, its all ancient code using the gap pexpect interface. At least one of them works fine with prime finite fields but fails in the non-prime case:

```
            sage: F.<a> = GF(4)
            sage: C = HammingCode(2,F)
            sage: v = vector(F, [1,0,0,a,1])
            sage: C.decode(v)
            (a + 1, 0, 0, a, 1)
            sage: C.decode(v, algorithm="nearest neighbor")
            (a + 1, 0, 0, a, 1)
            sage: C.decode(v, algorithm="guava")  # optional - gap_packages (Guava package)
            BOOM!
```



---

archive/issue_events_194712.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-23T18:06:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194712"
}
```



---

archive/issue_events_194713.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-23T18:06:32Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194713"
}
```



---

archive/issue_comments_185498.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nReplying to [@vbraun](#comment%3A11):\n> None of the failing doctests uses libgap, its all ancient code using the gap pexpect interface. \n\nSeems like an even stronger reason to move this to a new ticket.  I'll do that tomorrow unless someone objects.",
    "created_at": "2013-07-23T18:13:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185498",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:13" align="right">Comment 13</div>

Replying to [@vbraun](#comment%3A11):
> None of the failing doctests uses libgap, its all ancient code using the gap pexpect interface. 

Seems like an even stronger reason to move this to a new ticket.  I'll do that tomorrow unless someone objects.



---

archive/issue_comments_185499.json:
```json
{
    "body": "Reviewer: **Niles Johnson**",
    "created_at": "2013-07-26T12:21:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185499",
    "user": "https://github.com/nilesjohnson"
}
```

Reviewer: **Niles Johnson**



---

archive/issue_events_194714.json:
```json
{
    "actor": "https://github.com/nilesjohnson",
    "created_at": "2013-07-26T12:21:34Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194714"
}
```



---

archive/issue_events_194715.json:
```json
{
    "actor": "https://github.com/nilesjohnson",
    "created_at": "2013-07-26T12:21:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194715"
}
```



---

archive/issue_comments_185500.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nThe remaining problems in `linear_code.py` have been reported at #14979.  The patch here resolves the issue in this ticket, and more!",
    "created_at": "2013-07-26T12:21:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185500",
    "user": "https://github.com/nilesjohnson"
}
```

<div id="comment:14" align="right">Comment 14</div>

The remaining problems in `linear_code.py` have been reported at #14979.  The patch here resolves the issue in this ticket, and more!



---

archive/issue_comments_185501.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nupdated spkg landed on the servers \u2026",
    "created_at": "2013-07-30T10:36:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185501",
    "user": "https://github.com/haraldschilly"
}
```

<div id="comment:15" align="right">Comment 15</div>

updated spkg landed on the servers …



---

archive/issue_comments_185502.json:
```json
{
    "body": "Merged: **sage-5.12.beta0**",
    "created_at": "2013-08-02T14:18:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14909#issuecomment-185502",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.12.beta0**



---

archive/issue_events_194716.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-02T14:18:29Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194716"
}
```



---

archive/issue_events_194717.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-02T14:18:29Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14909",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14909#event-194717"
}
```
