# Issue 14204: Building unchanged documentation takes very long

archive/issues_014000.json:
```json
{
    "assignees": [
        "https://github.com/jdemeyer"
    ],
    "body": "Even with #14156, rebuilding the documentation when nothing needs to be done (`make doc` right after `make doc`) still takes a very long time.\n\nIn sage-5.7:\n\n```\nreal    0m48.142s\nuser    0m37.120s\nsys     0m10.110s\n```\n\nIn sage-5.8.beta2:\n\n```\nreal    5m52.020s\nuser    4m39.910s\nsys     1m5.140s\n```\n\nCC:  @jhpalmieri @vbraun @hivert @williamstein\n\nReviewer: **John Palmieri**\n\nAuthor: **Jeroen Demeyer**\n\nMerged: **sage-5.8.beta4**\n\nComponent: **build**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14204_\n\n",
    "closed_at": "2013-03-07T18:26:32Z",
    "created_at": "2013-02-28T11:09:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20build",
        "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Building unchanged documentation takes very long",
    "type": "issue",
    "updated_at": "2013-05-31T12:30:43Z",
    "url": "https://github.com/sagemath/sage/issues/14204",
    "user": "https://github.com/jdemeyer"
}
```
Even with #14156, rebuilding the documentation when nothing needs to be done (`make doc` right after `make doc`) still takes a very long time.

In sage-5.7:

```
real    0m48.142s
user    0m37.120s
sys     0m10.110s
```

In sage-5.8.beta2:

```
real    5m52.020s
user    4m39.910s
sys     1m5.140s
```

CC:  @jhpalmieri @vbraun @hivert @williamstein

Reviewer: **John Palmieri**

Author: **Jeroen Demeyer**

Merged: **sage-5.8.beta4**

Component: **build**

_Issue created by migration from https://trac.sagemath.org/ticket/14204_





---

archive/issue_events_200888.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:09:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200888"
}
```



---

archive/issue_events_200889.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:09:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20build",
    "label_color": "000080",
    "label_name": "c: build",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200889"
}
```



---

archive/issue_events_200890.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:09:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/p%3A%201%20%E2%80%93%20blocker",
    "label_color": "ff0000",
    "label_name": "p: 1 \u2013 blocker",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200890"
}
```



---

archive/issue_events_200891.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T11:09:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200891"
}
```



---

archive/issue_events_200892.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2013-02-28T11:09:49Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200892"
}
```



---

archive/issue_comments_169493.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI don't know. I think there are 74 documents that need to be built: 56 modules in the reference manual, 1 master reference manual doc, and 17 others. When you run `make doc`, 57 of those get built twice. For each build, on my machine, it takes 6 seconds to run Sphinx and decide that nothing needs to be done.  This all adds up.\n\nI wonder if it could be sped up much by calling Sphinx internally in Python, instead of as a command-line call each time. Otherwise, I don't have any ideas. Users should be advised to run `sage --docbuild reference/algebras html`, etc., rather than rebuilding the full reference manual. They should also be advised to buy a machine with lots of cores and set `MAKE=make -jN` for some large number `N` :)\n\nShould this really be a blocker?",
    "created_at": "2013-02-28T21:01:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169493",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:1" align="right">comment:1</div>

I don't know. I think there are 74 documents that need to be built: 56 modules in the reference manual, 1 master reference manual doc, and 17 others. When you run `make doc`, 57 of those get built twice. For each build, on my machine, it takes 6 seconds to run Sphinx and decide that nothing needs to be done.  This all adds up.

I wonder if it could be sped up much by calling Sphinx internally in Python, instead of as a command-line call each time. Otherwise, I don't have any ideas. Users should be advised to run `sage --docbuild reference/algebras html`, etc., rather than rebuilding the full reference manual. They should also be advised to buy a machine with lots of cores and set `MAKE=make -jN` for some large number `N` :)

Should this really be a blocker?



---

archive/issue_comments_169494.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFor what it's worth, you can cut down on the build time by setting `MAKE=make -jN`, where `N` is somewhat larger than the number of processors, at least if nothing needs to be rebuilt. On my machine, which has 2 processors:\n\n```\n$ export MAKE='make -j2' \n$ time make doc\n...\nreal\t4m59.845s\nuser\t4m33.320s\nsys\t2m0.269s\n```\nand\n\n```\n$ export MAKE='make -j4' \n$ time make doc\n...\nreal\t4m4.408s\nuser\t4m41.729s\nsys\t1m59.842s\n```",
    "created_at": "2013-02-28T21:55:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169494",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:2" align="right">comment:2</div>

For what it's worth, you can cut down on the build time by setting `MAKE=make -jN`, where `N` is somewhat larger than the number of processors, at least if nothing needs to be rebuilt. On my machine, which has 2 processors:

```
$ export MAKE='make -j2' 
$ time make doc
...
real	4m59.845s
user	4m33.320s
sys	2m0.269s
```
and

```
$ export MAKE='make -j4' 
$ time make doc
...
real	4m4.408s
user	4m41.729s
sys	1m59.842s
```



---

archive/issue_comments_169495.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nReplying to [@jhpalmieri](#comment:1):\n> Should this really be a blocker?\n\nThat's a personal opinion of course.\n\nIn my opinion, the answer is absolutely \"Yes\". If you regularly run `make ptestlong`, this really is a massive regression. I think the problem mentioned in this ticket is much worse than the problem solved in #6495.",
    "created_at": "2013-03-01T07:51:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169495",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:3" align="right">comment:3</div>

Replying to [@jhpalmieri](#comment:1):
> Should this really be a blocker?

That's a personal opinion of course.

In my opinion, the answer is absolutely "Yes". If you regularly run `make ptestlong`, this really is a massive regression. I think the problem mentioned in this ticket is much worse than the problem solved in #6495.



---

archive/issue_comments_169496.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nHow long does the rest of `make ptestlong` take? Why does a few extra minutes matter that much?",
    "created_at": "2013-03-01T15:44:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169496",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:4" align="right">comment:4</div>

How long does the rest of `make ptestlong` take? Why does a few extra minutes matter that much?



---

archive/issue_comments_169497.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@jhpalmieri](#comment:4):\n> How long does the rest of `make ptestlong` take? Why does a few extra minutes matter that much?\n\nOK, with 4 processes on `sage.math`, the documentation takes 188s and the doctesting (without `--long`) takes 1065s, with #12415. So, it's certainly noticable.\n\n> Why does a few extra minutes matter that much?\n\nIt's not that those extra minutes matter that much, but those lost minutes matter much more to me than the minutes saved by #6495.",
    "created_at": "2013-03-01T19:01:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169497",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@jhpalmieri](#comment:4):
> How long does the rest of `make ptestlong` take? Why does a few extra minutes matter that much?

OK, with 4 processes on `sage.math`, the documentation takes 188s and the doctesting (without `--long`) takes 1065s, with #12415. So, it's certainly noticable.

> Why does a few extra minutes matter that much?

It's not that those extra minutes matter that much, but those lost minutes matter much more to me than the minutes saved by #6495.



---

archive/issue_comments_169498.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@jhpalmieri](#comment:1):\n> For each build, on my machine, it takes 6 seconds to run Sphinx and decide that nothing needs to be done.\n\nDo you have any idea what Sphinx does in those 6 seconds? Does it import something from `sage`?",
    "created_at": "2013-03-01T19:22:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169498",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@jhpalmieri](#comment:1):
> For each build, on my machine, it takes 6 seconds to run Sphinx and decide that nothing needs to be done.

Do you have any idea what Sphinx does in those 6 seconds? Does it import something from `sage`?



---

archive/issue_comments_169499.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIf I put a call to `cProfile` in the docbuild command in `spkg/bin/sage` when building `reference/homology`, it doesn't tell me much:\n\n```\n         178370 function calls (174697 primitive calls) in 5.695 seconds\n\n   Ordered by: internal time\n\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n        2    4.087    2.043    4.087    2.043 {posix.waitpid}\n       29    1.125    0.039    1.125    0.039 {method 'read' of 'file' objects}\n        1    0.041    0.041    5.696    5.696 builder.py:12(<module>)\n       15    0.019    0.001    0.032    0.002 sre_compile.py:301(_optimize_unicode)\n       ...\n```\nIf I put it instead into the Python command called in builder.py, I get more information:\n\n```\n         962034 function calls (948847 primitive calls) in 4.297 seconds\n   Ordered by: internal time\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\n    18537    1.142    0.000    1.142    0.000 {method 'read' of 'file' objects}\n       64    0.199    0.003    2.480    0.039 all.py:1(<module>)\n    23751    0.159    0.000    0.279    0.000 intersphinx.py:90(split_lines)\n35847/35841    0.133    0.000    0.172    0.000 posixpath.py:60(join)\n       57    0.112    0.002    0.571    0.010 intersphinx.py:74(read_inventory_v2)\n        1    0.081    0.081    2.803    2.803 all.py:38(<module>)\n        2    0.079    0.039    0.079    0.040 {cPickle.load}\n    29365    0.063    0.000    0.063    0.000 {_codecs.utf_8_decode}\n 2269/568    0.057    0.000    0.163    0.000 sre_parse.py:379(_parse)\n       17    0.053    0.003    2.075    0.122 all.py:3(<module>)\n       ...\n```\nWe're calling certain functions a huge number of times, but we're not importing sage.all (as far as I can tell). I don't know why we're calling posixpath.join 35000 times, for example: that seems like a lot. Could it be reading every file in the Sage library each time, instead of only the files referenced in that section?",
    "created_at": "2013-03-01T23:52:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169499",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:7" align="right">comment:7</div>

If I put a call to `cProfile` in the docbuild command in `spkg/bin/sage` when building `reference/homology`, it doesn't tell me much:

```
         178370 function calls (174697 primitive calls) in 5.695 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        2    4.087    2.043    4.087    2.043 {posix.waitpid}
       29    1.125    0.039    1.125    0.039 {method 'read' of 'file' objects}
        1    0.041    0.041    5.696    5.696 builder.py:12(<module>)
       15    0.019    0.001    0.032    0.002 sre_compile.py:301(_optimize_unicode)
       ...
```
If I put it instead into the Python command called in builder.py, I get more information:

```
         962034 function calls (948847 primitive calls) in 4.297 seconds
   Ordered by: internal time
   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    18537    1.142    0.000    1.142    0.000 {method 'read' of 'file' objects}
       64    0.199    0.003    2.480    0.039 all.py:1(<module>)
    23751    0.159    0.000    0.279    0.000 intersphinx.py:90(split_lines)
35847/35841    0.133    0.000    0.172    0.000 posixpath.py:60(join)
       57    0.112    0.002    0.571    0.010 intersphinx.py:74(read_inventory_v2)
        1    0.081    0.081    2.803    2.803 all.py:38(<module>)
        2    0.079    0.039    0.079    0.040 {cPickle.load}
    29365    0.063    0.000    0.063    0.000 {_codecs.utf_8_decode}
 2269/568    0.057    0.000    0.163    0.000 sre_parse.py:379(_parse)
       17    0.053    0.003    2.075    0.122 all.py:3(<module>)
       ...
```
We're calling certain functions a huge number of times, but we're not importing sage.all (as far as I can tell). I don't know why we're calling posixpath.join 35000 times, for example: that seems like a lot. Could it be reading every file in the Sage library each time, instead of only the files referenced in that section?



---

archive/issue_comments_169500.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nActually, it is importing sage.all every time.",
    "created_at": "2013-03-02T03:04:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169500",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:8" align="right">comment:8</div>

Actually, it is importing sage.all every time.



---

archive/issue_comments_169501.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI think the issue is\n\n```\n        build_command = 'python '+os.path.join(SAGE_DOC, 'common', 'custom-sphinx-build.py')\n        build_command += ' -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),\n                                                  options, self.dir,\n                                                  output_dir)\n        logger.debug(build_command)\n        subprocess.call(build_command, shell=True)\n```\n\nCould we replace this subprocess stuff by a simple Python function call or an `execfile()`?",
    "created_at": "2013-03-02T14:27:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169501",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

I think the issue is

```
        build_command = 'python '+os.path.join(SAGE_DOC, 'common', 'custom-sphinx-build.py')
        build_command += ' -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),
                                                  options, self.dir,
                                                  output_dir)
        logger.debug(build_command)
        subprocess.call(build_command, shell=True)
```

Could we replace this subprocess stuff by a simple Python function call or an `execfile()`?



---

archive/issue_comments_169502.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@jdemeyer](#comment:9):\n> I think the issue is\n> \n> ```\n>         build_command = 'python '+os.path.join(SAGE_DOC, 'common', 'custom-sphinx-build.py')\n>         build_command += ' -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),\n>                                                   options, self.dir,\n>                                                   output_dir)\n>         logger.debug(build_command)\n>         subprocess.call(build_command, shell=True)\n> ```\n> \n> Could we replace this subprocess stuff by a simple Python function call or an `execfile()`?\n\nI tried to do that, but I think Sphinx has a memory leak (this has been suggested before). For whatever reason, after a little while it uses a lot of memory and slows way down. Actually, the inventory build sped up (from almost 2 minutes before down to about half a minute on an OS X machine with 2 cores), but the html build does not.\n\nIn more detail, I tried importing sage.all once, and then using a Python function call to build each document: I basically stuck all of custom-sphinx-builder.py into builder.py, and replaced the `subprocess.call(...)` with \n\n```\n        from sphinx.cmdline import main\n        main(args)\n```\nThis way sage.all would be imported just once, not 75 times. But there are issues. Maybe we should call `main(args)` some other way, so the memory is guaranteed to be released afterward? Any suggestions?",
    "created_at": "2013-03-02T16:01:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169502",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@jdemeyer](#comment:9):
> I think the issue is
> 
> ```
>         build_command = 'python '+os.path.join(SAGE_DOC, 'common', 'custom-sphinx-build.py')
>         build_command += ' -b %s -d %s %s %s %s'%(type, self._doctrees_dir(),
>                                                   options, self.dir,
>                                                   output_dir)
>         logger.debug(build_command)
>         subprocess.call(build_command, shell=True)
> ```
> 
> Could we replace this subprocess stuff by a simple Python function call or an `execfile()`?

I tried to do that, but I think Sphinx has a memory leak (this has been suggested before). For whatever reason, after a little while it uses a lot of memory and slows way down. Actually, the inventory build sped up (from almost 2 minutes before down to about half a minute on an OS X machine with 2 cores), but the html build does not.

In more detail, I tried importing sage.all once, and then using a Python function call to build each document: I basically stuck all of custom-sphinx-builder.py into builder.py, and replaced the `subprocess.call(...)` with 

```
        from sphinx.cmdline import main
        main(args)
```
This way sage.all would be imported just once, not 75 times. But there are issues. Maybe we should call `main(args)` some other way, so the memory is guaranteed to be released afterward? Any suggestions?



---

archive/issue_comments_169503.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jhpalmieri](#comment:10):\n> Any suggestions?\n\nUse `multiprocessing.Pool(maxtasksperchild=1)`.  This way, every child would just call Sphinx once, no cleanup to worry about. Make sure that everything that needs to be imported is imported by the master process (the one that calls ``multiprocessing.Pool()`.",
    "created_at": "2013-03-02T16:21:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169503",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jhpalmieri](#comment:10):
> Any suggestions?

Use `multiprocessing.Pool(maxtasksperchild=1)`.  This way, every child would just call Sphinx once, no cleanup to worry about. Make sure that everything that needs to be imported is imported by the master process (the one that calls ``multiprocessing.Pool()`.



---

archive/issue_comments_169504.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nMy laptop builds the new-style documentation in 55 seconds with 8x parallel if nothing is changed. And this is from cold caches. \n\nJeroen, you are just trying to replace the subprocess call with a fork. That just saves us a couple of Sage startups, each of which is 1.5 seconds. Thats maybe 10% performance that you can get out of there, right?\n\nYou need to pull in a number of files across the different doc pieces to figure out if stuff is out-of-date, so I guess this makes this ticket extremely dependent on small file read performance. Thats just the price of having to synchronize multiple separate sub-documents.\n\nWilliam, is there a chance to get a SSD (presumably into sage.math) for Jeroen?",
    "created_at": "2013-03-03T07:57:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169504",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:12" align="right">comment:12</div>

My laptop builds the new-style documentation in 55 seconds with 8x parallel if nothing is changed. And this is from cold caches. 

Jeroen, you are just trying to replace the subprocess call with a fork. That just saves us a couple of Sage startups, each of which is 1.5 seconds. Thats maybe 10% performance that you can get out of there, right?

You need to pull in a number of files across the different doc pieces to figure out if stuff is out-of-date, so I guess this makes this ticket extremely dependent on small file read performance. Thats just the price of having to synchronize multiple separate sub-documents.

William, is there a chance to get a SSD (presumably into sage.math) for Jeroen?



---

archive/issue_comments_169505.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [@vbraun](#comment:12):\n> My laptop builds the new-style documentation in 55 seconds with 8x parallel if nothing is changed. And this is from cold caches. \n\nWhich is probably about the same time as **one process** for the old docbuilder.\n\n> Jeroen, you are just trying to replace the subprocess call with a fork.\n\nSure.\n\n> That just saves us a couple of Sage startups, each of which is 1.5 seconds. Thats maybe 10% performance that you can get out of there, right?\n\nI doubt it. My timings suggest that some documents need 2 ~ 3 seconds to build, which is pretty close to the Sage startup time. So I think there is a substantial gain there.\n\nI think the elephant in the room is still: why did we care so much about speeding up the *initial* build of the documentation (#6495) at the expense of *rebuilds* of the documentation? When doing a few rebuilds of the documentation, you lose all the time which is gained by #6495.",
    "created_at": "2013-03-03T10:25:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169505",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [@vbraun](#comment:12):
> My laptop builds the new-style documentation in 55 seconds with 8x parallel if nothing is changed. And this is from cold caches. 

Which is probably about the same time as **one process** for the old docbuilder.

> Jeroen, you are just trying to replace the subprocess call with a fork.

Sure.

> That just saves us a couple of Sage startups, each of which is 1.5 seconds. Thats maybe 10% performance that you can get out of there, right?

I doubt it. My timings suggest that some documents need 2 ~ 3 seconds to build, which is pretty close to the Sage startup time. So I think there is a substantial gain there.

I think the elephant in the room is still: why did we care so much about speeding up the *initial* build of the documentation (#6495) at the expense of *rebuilds* of the documentation? When doing a few rebuilds of the documentation, you lose all the time which is gained by #6495.



---

archive/issue_comments_169506.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\n> Why did we care so much about speeding up the initial build of the documentation (#6495) at the expense of rebuilds of the documentation?\n\nWhen I was thinking about #6495, I was imagining the following situations, among others:\n\n- the initial `make`\n- some people still clone the Sage repo, which usually triggers a full rebuild of the docs\n- edit some files (say in `combinat`) and run `sage --docbuild reference/combinat html`\n- building the pdf docs\n\nFor all of these, #6495 helps considerably. When I think about running `make ptestlong` (which I do more frequently than `make ptest`), I didn't think a little added time was much of an issue.",
    "created_at": "2013-03-03T16:28:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169506",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:14" align="right">comment:14</div>

> Why did we care so much about speeding up the initial build of the documentation (#6495) at the expense of rebuilds of the documentation?

When I was thinking about #6495, I was imagining the following situations, among others:

- the initial `make`
- some people still clone the Sage repo, which usually triggers a full rebuild of the docs
- edit some files (say in `combinat`) and run `sage --docbuild reference/combinat html`
- building the pdf docs

For all of these, #6495 helps considerably. When I think about running `make ptestlong` (which I do more frequently than `make ptest`), I didn't think a little added time was much of an issue.



---

archive/issue_comments_169507.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nCould we at the very least get rid of the `subprocess` call? It probably won't make the documentation build as fast as before, but there should be some considerable gain.",
    "created_at": "2013-03-04T07:28:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169507",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Could we at the very least get rid of the `subprocess` call? It probably won't make the documentation build as fast as before, but there should be some considerable gain.



---

archive/issue_comments_169508.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@vbraun](#comment:12):\n> William, is there a chance to get a SSD (presumably into sage.math) for Jeroen?\n\nThere already is a SSD in `sage.math` for Jeroen, and the timings I mention are with that SSD.",
    "created_at": "2013-03-04T07:32:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169508",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@vbraun](#comment:12):
> William, is there a chance to get a SSD (presumably into sage.math) for Jeroen?

There already is a SSD in `sage.math` for Jeroen, and the timings I mention are with that SSD.



---

archive/issue_comments_169509.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nThis is a proof-of-concept patch for getting rid of `subprocess`, giving a speedup of roughly a factor 2.",
    "created_at": "2013-03-04T10:14:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169509",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:17" align="right">comment:17</div>

This is a proof-of-concept patch for getting rid of `subprocess`, giving a speedup of roughly a factor 2.



---

archive/issue_comments_169510.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nPerhaps more imports could be done it the master process, but I don't know how much there is to gain. Running `strace` shows that the docbuilder tries to `open()` a non-existing file 270200 times(!).",
    "created_at": "2013-03-04T10:23:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169510",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:18" align="right">comment:18</div>

Perhaps more imports could be done it the master process, but I don't know how much there is to gain. Running `strace` shows that the docbuilder tries to `open()` a non-existing file 270200 times(!).



---

archive/issue_comments_169511.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nAdd a cache for the intersphinx inventory, reducing the total time again by more than a factor of 2. Still untested proof-of-concept.",
    "created_at": "2013-03-04T13:15:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169511",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

Add a cache for the intersphinx inventory, reducing the total time again by more than a factor of 2. Still untested proof-of-concept.



---

archive/issue_events_200893.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-04T14:45:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200893"
}
```



---

archive/issue_comments_169512.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nPatch seems to work, I'm setting it to needs_review very tentatively. Somebody who knows Sphinx better than me should look at it.\n\nWith this patch, building the documentation with 2 threads is now faster than before #6495, so it would fix the issue.",
    "created_at": "2013-03-04T14:45:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169512",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Patch seems to work, I'm setting it to needs_review very tentatively. Somebody who knows Sphinx better than me should look at it.

With this patch, building the documentation with 2 threads is now faster than before #6495, so it would fix the issue.



---

archive/issue_comments_169513.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2013-03-04T14:45:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169513",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_169514.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nThe patch seems to work as advertised, and the changes make sense to me. Volker, do you concur? (Note that the commit message is not ideal ;)",
    "created_at": "2013-03-04T23:06:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169514",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

The patch seems to work as advertised, and the changes make sense to me. Volker, do you concur? (Note that the commit message is not ideal ;)



---

archive/issue_comments_169515.json:
```json
{
    "body": "Attachment: **[14204_sphinx_fork.patch.gz](https://github.com/sagemath/sage/files/ticket14204/14204_sphinx_fork.patch.gz)**",
    "created_at": "2013-03-05T09:34:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169515",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[14204_sphinx_fork.patch.gz](https://github.com/sagemath/sage/files/ticket14204/14204_sphinx_fork.patch.gz)**



---

archive/issue_comments_169516.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nFixed commit message.",
    "created_at": "2013-03-05T09:35:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169516",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

Fixed commit message.



---

archive/issue_events_200894.json:
```json
{
    "actor": "https://github.com/sagetrac-GeorgSWeber",
    "created_at": "2013-03-05T09:35:16Z",
    "event": "unassigned",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200894"
}
```



---

archive/issue_events_200895.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-05T09:35:16Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200895"
}
```



---

archive/issue_comments_169517.json:
```json
{
    "body": "Reviewer: **John Palmieri**",
    "created_at": "2013-03-06T19:22:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169517",
    "user": "https://github.com/jhpalmieri"
}
```

Reviewer: **John Palmieri**



---

archive/issue_events_200896.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2013-03-06T19:22:09Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200896"
}
```



---

archive/issue_events_200897.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2013-03-06T19:22:09Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200897"
}
```



---

archive/issue_comments_169518.json:
```json
{
    "body": "Merged: **sage-5.8.beta4**",
    "created_at": "2013-03-07T18:26:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169518",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.8.beta4**



---

archive/issue_events_200898.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T18:26:32Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200898"
}
```



---

archive/issue_events_200899.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T18:26:32Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14204#event-200899"
}
```



---

archive/issue_comments_169519.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nI have a followup question.  I'm working with a student on learning to develop, and his first patch is a pretty basic documentation upgrade. Changing just one file and then doing `sage -docbuild reference html` takes eons on a reasonably modern Ubuntu laptop because it checks ALL the files.  It's true that we didn't necessarily set the number of parallel cores.  But it still really slows down checking whether things look right.  Any thoughts, or is this a wontfix?  I'm hesitant to open a ticket until I know it really should be considered a bug, though I do think it is a pretty nasty (non-mathematical) regression.",
    "created_at": "2013-05-31T03:51:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169519",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:25" align="right">comment:25</div>

I have a followup question.  I'm working with a student on learning to develop, and his first patch is a pretty basic documentation upgrade. Changing just one file and then doing `sage -docbuild reference html` takes eons on a reasonably modern Ubuntu laptop because it checks ALL the files.  It's true that we didn't necessarily set the number of parallel cores.  But it still really slows down checking whether things look right.  Any thoughts, or is this a wontfix?  I'm hesitant to open a ticket until I know it really should be considered a bug, though I do think it is a pretty nasty (non-mathematical) regression.



---

archive/issue_comments_169520.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nAll the more reason to set `MAKE` so it uses multiple threads! On my (not reasonably modern) OS X machine, rebuilding the documentation after modifying one file, with `MAKE` unset, takes\n\n```\nreal\t2m44.637s\nuser\t2m7.278s\nsys\t0m22.776s\n```\nWith `MAKE` set to use two cores:\n\n```\nreal\t1m55.552s\nuser\t2m12.224s\nsys\t0m24.907s\n```\nOn sage.math, with `MAKE='make -j12'`:\n\n```\nreal\t0m34.899s\nuser\t1m34.650s\nsys\t0m16.800s\n```\nSo using multiple cores is very advantageous. Note also that if you are only modifying a single file, or files within one section of the reference manual, be aware that you can do\n\n```\nsage --docbuild reference/homology html\n```\n(or `reference/combinat` or `reference/matrices` or ...). This will be very fast (except when rebuilding the `combinat` docs ;), even with a single core.",
    "created_at": "2013-05-31T05:09:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169520",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:26" align="right">comment:26</div>

All the more reason to set `MAKE` so it uses multiple threads! On my (not reasonably modern) OS X machine, rebuilding the documentation after modifying one file, with `MAKE` unset, takes

```
real	2m44.637s
user	2m7.278s
sys	0m22.776s
```
With `MAKE` set to use two cores:

```
real	1m55.552s
user	2m12.224s
sys	0m24.907s
```
On sage.math, with `MAKE='make -j12'`:

```
real	0m34.899s
user	1m34.650s
sys	0m16.800s
```
So using multiple cores is very advantageous. Note also that if you are only modifying a single file, or files within one section of the reference manual, be aware that you can do

```
sage --docbuild reference/homology html
```
(or `reference/combinat` or `reference/matrices` or ...). This will be very fast (except when rebuilding the `combinat` docs ;), even with a single core.



---

archive/issue_comments_169521.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nReplying to [@kcrisman](#comment:25):\n> I have a followup question.  I'm working with a student on learning to develop, and his first patch is a pretty basic documentation upgrade. Changing just one file and then doing `sage -docbuild reference html` takes eons on a reasonably modern Ubuntu laptop because it checks ALL the files.\n\nOn my reasonably modern Gentoo laptop, this takes about 40 seconds (with 1 thread), which I personally find reasonable.\n\n> I do think it is a pretty nasty (non-mathematical) regression.\n\nI don't think it's such a big regression. With 1 thread, it is slightly slower than before, but not by much.\n\nIf you do want to create a ticket, this is the place to do it: [http://bitbucket.org/birkenfeld/sphinx/issues/](http://bitbucket.org/birkenfeld/sphinx/issues/)",
    "created_at": "2013-05-31T06:39:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169521",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:27" align="right">comment:27</div>

Replying to [@kcrisman](#comment:25):
> I have a followup question.  I'm working with a student on learning to develop, and his first patch is a pretty basic documentation upgrade. Changing just one file and then doing `sage -docbuild reference html` takes eons on a reasonably modern Ubuntu laptop because it checks ALL the files.

On my reasonably modern Gentoo laptop, this takes about 40 seconds (with 1 thread), which I personally find reasonable.

> I do think it is a pretty nasty (non-mathematical) regression.

I don't think it's such a big regression. With 1 thread, it is slightly slower than before, but not by much.

If you do want to create a ticket, this is the place to do it: [http://bitbucket.org/birkenfeld/sphinx/issues/](http://bitbucket.org/birkenfeld/sphinx/issues/)



---

archive/issue_comments_169522.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nI see, so this isn't something we can fix more without getting rid of parallel documentation building.  I think this was a lot faster before because it only had to do a sweep through one directory.\n\nWith Sage 5.2, after touching one file and `sage -b`, the documentation build takes well under 15 seconds, but in 5.9 the same thing took about 80 seconds (I had to use a watch for this, since it didn't print it out).\n\nMaybe we could add something about *both* of John's solutions to [the Sage manuals developer page](http://www.sagemath.org/doc/developer/sage_manuals.html#building-the-manuals)?  I'd be open to opening such a ticket.  Maybe my student could even write the patch ;-)",
    "created_at": "2013-05-31T12:30:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14204",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14204#issuecomment-169522",
    "user": "https://github.com/kcrisman"
}
```

<div id="comment:28" align="right">comment:28</div>

I see, so this isn't something we can fix more without getting rid of parallel documentation building.  I think this was a lot faster before because it only had to do a sweep through one directory.

With Sage 5.2, after touching one file and `sage -b`, the documentation build takes well under 15 seconds, but in 5.9 the same thing took about 80 seconds (I had to use a watch for this, since it didn't print it out).

Maybe we could add something about *both* of John's solutions to [the Sage manuals developer page](http://www.sagemath.org/doc/developer/sage_manuals.html#building-the-manuals)?  I'd be open to opening such a ticket.  Maybe my student could even write the patch ;-)
