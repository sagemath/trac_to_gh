# Issue 14007: Better heuristics for determinant over ZZ and GF(p)

archive/issues_013803.json:
```json
{
    "body": "This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.\n\nAlso misc improvements to `integer_mod.pyx`\n\n**Apply** [attachment:14007_determinant.patch]\n\n**Assignee:** @jasongrout, @williamstein\n\n**Reviewer:** Charles Bouillaguet\n\n**Author:** Jeroen Demeyer\n\n**Merged:** sage-5.7.beta3\n\n**Dependencies:** #14032\n\nIssue created by migration from https://trac.sagemath.org/ticket/14007\n\n",
    "closed_at": "2013-02-05T08:21:12Z",
    "created_at": "2013-01-24T17:15:19Z",
    "labels": [
        "component: linear algebra",
        "critical",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "Better heuristics for determinant over ZZ and GF(p)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14007",
    "user": "https://github.com/jdemeyer"
}
```
This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.

Also misc improvements to `integer_mod.pyx`

**Apply** [attachment:14007_determinant.patch]

**Assignee:** @jasongrout, @williamstein

**Reviewer:** Charles Bouillaguet

**Author:** Jeroen Demeyer

**Merged:** sage-5.7.beta3

**Dependencies:** #14032

Issue created by migration from https://trac.sagemath.org/ticket/14007





---

archive/issue_comments_205909.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2013-01-24T20:50:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205909",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_205910.json:
```json
{
    "body": "<a id='comment:2'></a>\nDoes there exist a possible doctest for this ticket? There is no doctest added in the patch.",
    "created_at": "2013-01-25T11:50:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205910",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:2'></a>
Does there exist a possible doctest for this ticket? There is no doctest added in the patch.



---

archive/issue_comments_205911.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [slabbe](#comment%3A2):\n> There is no doctest added in the patch.\n\nThere are already doctests computing determinants over `GF(p)`, so I don't see why we should add a new one.",
    "created_at": "2013-01-25T12:16:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205911",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:3'></a>
Replying to [slabbe](#comment%3A2):
> There is no doctest added in the patch.

There are already doctests computing determinants over `GF(p)`, so I don't see why we should add a new one.



---

archive/issue_comments_205912.json:
```json
{
    "body": "<a id='comment:4'></a>\nWell, I was also asking this to help me do the review. But I will look again at the example in the original sage-devel post.",
    "created_at": "2013-01-25T14:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205912",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:4'></a>
Well, I was also asking this to help me do the review. But I will look again at the example in the original sage-devel post.



---

archive/issue_comments_205913.json:
```json
{
    "body": "**Reviewer:** Charles Bouillaguet",
    "created_at": "2013-01-26T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205913",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

**Reviewer:** Charles Bouillaguet



---

archive/issue_comments_205914.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-01-26T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205914",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_205915.json:
```json
{
    "body": "<a id='comment:5'></a>\nThere is a convincing improvement : \n\n```\nsage: M = random_matrix( Integers( next_prime( factorial(10) ) ), 400 )\nsage: time M.det()\nTime: CPU 0.04 s, Wall: 0.03 s\n```\nversus :\n\n```\nsage: M = random_matrix( Integers( next_prime( factorial(10) ) + 1), 400 )\nsage: time M.det()\nTime: CPU 4.65 s, Wall: 3.99 s\n```\n\nPositive review !",
    "created_at": "2013-01-26T11:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205915",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:5'></a>
There is a convincing improvement : 

```
sage: M = random_matrix( Integers( next_prime( factorial(10) ) ), 400 )
sage: time M.det()
Time: CPU 0.04 s, Wall: 0.03 s
```
versus :

```
sage: M = random_matrix( Integers( next_prime( factorial(10) ) + 1), 400 )
sage: time M.det()
Time: CPU 4.65 s, Wall: 3.99 s
```

Positive review !



---

archive/issue_comments_205916.json:
```json
{
    "body": "**Changing status** from positive_review to needs_work.",
    "created_at": "2013-01-26T19:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205916",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

**Changing status** from positive_review to needs_work.



---

archive/issue_comments_205917.json:
```json
{
    "body": "<a id='comment:6'></a>\nThere are cases where the patch is in fact a huge regression !\n\nI ran the following test : \n\n```\nsage: sage: for i in range(1,6):\n    M = random_matrix( Integers(p), 75*i )\n    time d = M.det()\n```\nwith ``p = next_prime( factorial(20) )`` and ``sage: p = next_prime( factorial(21) )``\n\nBefore patch:\n\n```\n# 20!\nTime: CPU 0.10 s, Wall: 0.10 s\nTime: CPU 0.56 s, Wall: 0.55 s\nTime: CPU 1.56 s, Wall: 1.51 s\nTime: CPU 3.62 s, Wall: 3.10 s\nTime: CPU 6.46 s, Wall: 5.26 s\n\n# 21!\nTime: CPU 0.17 s, Wall: 0.17 s\nTime: CPU 0.61 s, Wall: 0.59 s\nTime: CPU 1.72 s, Wall: 1.67 s\nTime: CPU 3.92 s, Wall: 3.36 s\nTime: CPU 6.85 s, Wall: 5.63 s\n```\n\nAfter patch:\n\n```\n# 20!\nTime: CPU 0.11 s, Wall: 0.11 s\nTime: CPU 0.51 s, Wall: 0.51 s\nTime: CPU 1.17 s, Wall: 1.17 s\nTime: CPU 2.15 s, Wall: 2.15 s\nTime: CPU 3.43 s, Wall: 3.43 s            # this is cool\n\n# 21!\nTime: CPU 0.17 s, Wall: 0.17 s\nTime: CPU 0.65 s, Wall: 0.65 s\nTime: CPU 1.77 s, Wall: 1.77 s\nTime: CPU 4.06 s, Wall: 4.06 s\nTime: CPU 36.89 s, Wall: 36.89 s        # problem here\n```",
    "created_at": "2013-01-26T19:18:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205917",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:6'></a>
There are cases where the patch is in fact a huge regression !

I ran the following test : 

```
sage: sage: for i in range(1,6):
    M = random_matrix( Integers(p), 75*i )
    time d = M.det()
```
with ``p = next_prime( factorial(20) )`` and ``sage: p = next_prime( factorial(21) )``

Before patch:

```
# 20!
Time: CPU 0.10 s, Wall: 0.10 s
Time: CPU 0.56 s, Wall: 0.55 s
Time: CPU 1.56 s, Wall: 1.51 s
Time: CPU 3.62 s, Wall: 3.10 s
Time: CPU 6.46 s, Wall: 5.26 s

# 21!
Time: CPU 0.17 s, Wall: 0.17 s
Time: CPU 0.61 s, Wall: 0.59 s
Time: CPU 1.72 s, Wall: 1.67 s
Time: CPU 3.92 s, Wall: 3.36 s
Time: CPU 6.85 s, Wall: 5.63 s
```

After patch:

```
# 20!
Time: CPU 0.11 s, Wall: 0.11 s
Time: CPU 0.51 s, Wall: 0.51 s
Time: CPU 1.17 s, Wall: 1.17 s
Time: CPU 2.15 s, Wall: 2.15 s
Time: CPU 3.43 s, Wall: 3.43 s            # this is cool

# 21!
Time: CPU 0.17 s, Wall: 0.17 s
Time: CPU 0.65 s, Wall: 0.65 s
Time: CPU 1.77 s, Wall: 1.77 s
Time: CPU 4.06 s, Wall: 4.06 s
Time: CPU 36.89 s, Wall: 36.89 s        # problem here
```



---

archive/issue_comments_205918.json:
```json
{
    "body": "<a id='comment:7'></a>\nThe threshold is very clearly at ``2^64``. This is with the patch: \n\n```\nsage: p = next_prime(2^64-60)\nsage: M = random_matrix( Integers(p), 75*5 )\nsage: M2 = matrix(ZZ, M)\n\nsage: time d = M.det()\nTime: CPU 3.49 s, Wall: 3.49 s      # PARI prime case is faster\nsage: time d = M2.det()\nTime: CPU 6.29 s, Wall: 5.09 s\n\n\nsage: p = next_prime(2^64)\nsage: M = random_matrix( Integers(p), 75*5 )\nsage: M2 = matrix(ZZ, M)\n\nsage: time d = M.det()\nTime: CPU 8.83 s, Wall: 8.83 s       # PARI prime case is slower\nsage: time d = M2.det()\nTime: CPU 6.77 s, Wall: 5.52 s\n```",
    "created_at": "2013-01-26T19:41:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205918",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:7'></a>
The threshold is very clearly at ``2^64``. This is with the patch: 

```
sage: p = next_prime(2^64-60)
sage: M = random_matrix( Integers(p), 75*5 )
sage: M2 = matrix(ZZ, M)

sage: time d = M.det()
Time: CPU 3.49 s, Wall: 3.49 s      # PARI prime case is faster
sage: time d = M2.det()
Time: CPU 6.29 s, Wall: 5.09 s


sage: p = next_prime(2^64)
sage: M = random_matrix( Integers(p), 75*5 )
sage: M2 = matrix(ZZ, M)

sage: time d = M.det()
Time: CPU 8.83 s, Wall: 8.83 s       # PARI prime case is slower
sage: time d = M2.det()
Time: CPU 6.77 s, Wall: 5.52 s
```



---

archive/issue_comments_205919.json:
```json
{
    "body": "<a id='comment:8'></a>\nPerhaps only use PARI for moduli up to the machine word size?",
    "created_at": "2013-01-26T21:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205919",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:8'></a>
Perhaps only use PARI for moduli up to the machine word size?



---

archive/issue_comments_205920.json:
```json
{
    "body": "<a id='comment:9'></a>\nsounds reasonable, but I don't have a 32-bit machine under my hand to test this.",
    "created_at": "2013-01-27T08:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205920",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:9'></a>
sounds reasonable, but I don't have a 32-bit machine under my hand to test this.



---

archive/issue_comments_205921.json:
```json
{
    "body": "<a id='comment:10'></a>\nwith OSX 10.5.8, 32-bit, sage-5.6.rc0 + 14007_matrix_modp.patch :\n\n```\nsage: p = next_prime(2^32-60)              \nsage: p < 2^32                             \nTrue                                       \nsage: M = random_matrix(Integers(p), 75*5) \nsage: M2 = matrix(ZZ, M)                   \nsage: time d = M.det()                     \nTime: CPU 7.49 s, Wall: 7.53 s             \nsage: time d = M2.det()                    \nTime: CPU 9.55 s, Wall: 9.49 s   \n\nsage: p = next_prime(2^32)                 \nsage: M = random_matrix(Integers(p), 75*5) \nsage: M2 = matrix(ZZ, M)                   \nsage: time d = M.det()                     \nTime: CPU 14.15 s, Wall: 14.59 s           \nsage: time d = M2.det()                    \nTime: CPU 9.81 s, Wall: 9.72 s             \n\nsage: p = next_prime(2^64-60)                \nsage: M = random_matrix(Integers(p), 75*5)   \nsage: M2 = matrix(ZZ, M)        \nsage: time d = M.det()                       \nTime: CPU 15.82 s, Wall: 16.08 s             \nsage: time d = M2.det()                     \nTime: CPU 14.91 s, Wall: 15.72 s  \n\nsage: p = next_prime(2^64)                 \nsage: M = random_matrix(Integers(p), 75*5) \nsage: M2 = matrix(ZZ, M)     \nsage: time d = M.det()                     \nTime: CPU 18.14 s, Wall: 18.23 s           \nsage: time d = M2.det()                    \nTime: CPU 14.59 s, Wall: 14.63 s           \n```",
    "created_at": "2013-01-29T10:55:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205921",
    "user": "https://github.com/seblabbe"
}
```

<a id='comment:10'></a>
with OSX 10.5.8, 32-bit, sage-5.6.rc0 + 14007_matrix_modp.patch :

```
sage: p = next_prime(2^32-60)              
sage: p < 2^32                             
True                                       
sage: M = random_matrix(Integers(p), 75*5) 
sage: M2 = matrix(ZZ, M)                   
sage: time d = M.det()                     
Time: CPU 7.49 s, Wall: 7.53 s             
sage: time d = M2.det()                    
Time: CPU 9.55 s, Wall: 9.49 s   

sage: p = next_prime(2^32)                 
sage: M = random_matrix(Integers(p), 75*5) 
sage: M2 = matrix(ZZ, M)                   
sage: time d = M.det()                     
Time: CPU 14.15 s, Wall: 14.59 s           
sage: time d = M2.det()                    
Time: CPU 9.81 s, Wall: 9.72 s             

sage: p = next_prime(2^64-60)                
sage: M = random_matrix(Integers(p), 75*5)   
sage: M2 = matrix(ZZ, M)        
sage: time d = M.det()                       
Time: CPU 15.82 s, Wall: 16.08 s             
sage: time d = M2.det()                     
Time: CPU 14.91 s, Wall: 15.72 s  

sage: p = next_prime(2^64)                 
sage: M = random_matrix(Integers(p), 75*5) 
sage: M2 = matrix(ZZ, M)     
sage: time d = M.det()                     
Time: CPU 18.14 s, Wall: 18.23 s           
sage: time d = M2.det()                    
Time: CPU 14.59 s, Wall: 14.63 s           
```



---

archive/issue_comments_205922.json:
```json
{
    "body": "<a id='comment:11'></a>\nSounds good. I don't know how to detect the word size inside sage (?). It amazes me that moving from \"less than 64 bits\" to \"more than 64 bits\" actually speeds up the process instead of slowing it down in the integer case...\n\nI also checked that the corresponding PARI routine (`Flm_det_sp_OK` in `src/basemath/linalg1.c`) does not require the characteristic of the ring to be prime. The same procedure in PARI deals with determinants in ZZ/6ZZ and ZZ/11ZZ. So, in theory, we could use PARI for all kinds of `IntegerMod(...)`, with a clear benefit when p is small enough to fit in a machine word. I tried to get rid of the prime limitation but failed with an error I did not understand... Jeroen, could you try?\n\nAlso, note that the PARI implementation is rather na\u00efve : is performs a simple gaussian elimination (no strassen, no fancy stuff). A longer-term objective would be to let FFLAS do this.\n\nAlso, another longer-term objective would ben when the modulus is too large, to use the chinese reminder theorem to work only modulo small primes (this can also be done  modulo the integers). But this would require PARI to handle the non-prime cases.",
    "created_at": "2013-01-29T11:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205922",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:11'></a>
Sounds good. I don't know how to detect the word size inside sage (?). It amazes me that moving from "less than 64 bits" to "more than 64 bits" actually speeds up the process instead of slowing it down in the integer case...

I also checked that the corresponding PARI routine (`Flm_det_sp_OK` in `src/basemath/linalg1.c`) does not require the characteristic of the ring to be prime. The same procedure in PARI deals with determinants in ZZ/6ZZ and ZZ/11ZZ. So, in theory, we could use PARI for all kinds of `IntegerMod(...)`, with a clear benefit when p is small enough to fit in a machine word. I tried to get rid of the prime limitation but failed with an error I did not understand... Jeroen, could you try?

Also, note that the PARI implementation is rather naïve : is performs a simple gaussian elimination (no strassen, no fancy stuff). A longer-term objective would be to let FFLAS do this.

Also, another longer-term objective would ben when the modulus is too large, to use the chinese reminder theorem to work only modulo small primes (this can also be done  modulo the integers). But this would require PARI to handle the non-prime cases.



---

archive/issue_comments_205923.json:
```json
{
    "body": "<a id='comment:12'></a>\nReplying to [Bouillaguet](#comment%3A11):\n> I also checked that the corresponding PARI routine (`Flm_det_sp_OK` in `src/basemath/linalg1.c`) does not require the characteristic of the ring to be prime. The same procedure in PARI deals with determinants in ZZ/6ZZ and ZZ/11ZZ.\n\nPARI does require that the characteristic is prime, or at least that it won't encounter non-invertible elements:\n\n```\ngp> matdet([2,1,0;2,3,0;0,0,1]*Mod(1,4))\n  ***   at top-level: matdet([2,1,0;2,3,0;\n  ***                 ^--------------------\n  *** matdet: impossible inverse modulo: Mod(2, 4).\n```\n\n> Another longer-term objective would ben when the modulus is too large, to use the chinese reminder theorem to work only modulo small primes\n\nThis is what newer versions of PARI do.",
    "created_at": "2013-01-29T12:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205923",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:12'></a>
Replying to [Bouillaguet](#comment%3A11):
> I also checked that the corresponding PARI routine (`Flm_det_sp_OK` in `src/basemath/linalg1.c`) does not require the characteristic of the ring to be prime. The same procedure in PARI deals with determinants in ZZ/6ZZ and ZZ/11ZZ.

PARI does require that the characteristic is prime, or at least that it won't encounter non-invertible elements:

```
gp> matdet([2,1,0;2,3,0;0,0,1]*Mod(1,4))
  ***   at top-level: matdet([2,1,0;2,3,0;
  ***                 ^--------------------
  *** matdet: impossible inverse modulo: Mod(2, 4).
```

> Another longer-term objective would ben when the modulus is too large, to use the chinese reminder theorem to work only modulo small primes

This is what newer versions of PARI do.



---

archive/issue_comments_205924.json:
```json
{
    "body": "<a id='comment:13'></a>\nFine. This looks like a serious bug in PARI, because the determinant still exists even though this specific algorithm cannot compute it...\n\nSo : modify the patch so that it chooses the threshold to call PARI according to the length of the machine word, and we're good to go.",
    "created_at": "2013-01-29T13:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205924",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:13'></a>
Fine. This looks like a serious bug in PARI, because the determinant still exists even though this specific algorithm cannot compute it...

So : modify the patch so that it chooses the threshold to call PARI according to the length of the machine word, and we're good to go.



---

archive/issue_comments_205925.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [Bouillaguet](#comment%3A13):\n> This looks like a serious bug in PARI\n\nThat's not a bug, it's just something which hasn't been implemented (yet).",
    "created_at": "2013-01-29T13:56:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205925",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:14'></a>
Replying to [Bouillaguet](#comment%3A13):
> This looks like a serious bug in PARI

That's not a bug, it's just something which hasn't been implemented (yet).



---

archive/issue_comments_205926.json:
```json
{
    "body": "<a id='comment:15'></a>\nI get different timings, the patch always seems to help.\n\nI used the script\n\n```\ndef dettest(k):\n    print \"Testing\", k\n    for s in [50,75..300]:\n        M = random_matrix(k, s)\n        print \"Size%4i\"%s,\n        time d = M.det()\n\ndettest(Integers(2432902008176640029))\ndettest(Integers(51090942171709440031))\n```\n\nWithout patch:\n\n```\nTesting Ring of integers modulo 2432902008176640029\nSize  50 Time: CPU 1.43 s, Wall: 1.43 s\nSize  75 Time: CPU 0.28 s, Wall: 0.43 s\nSize 100 Time: CPU 0.33 s, Wall: 0.33 s\nSize 125 Time: CPU 0.51 s, Wall: 0.51 s\nSize 150 Time: CPU 0.88 s, Wall: 0.88 s\nSize 175 Time: CPU 1.17 s, Wall: 1.17 s\nSize 200 Time: CPU 1.64 s, Wall: 1.64 s\nSize 225 Time: CPU 2.19 s, Wall: 2.19 s\nSize 250 Time: CPU 2.90 s, Wall: 2.91 s\nSize 275 Time: CPU 3.82 s, Wall: 3.83 s\nSize 300 Time: CPU 4.50 s, Wall: 4.50 s\nTesting Ring of integers modulo 51090942171709440031\nSize  50 Time: CPU 1.53 s, Wall: 1.53 s\nSize  75 Time: CPU 0.18 s, Wall: 0.18 s\nSize 100 Time: CPU 0.34 s, Wall: 0.34 s\nSize 125 Time: CPU 0.54 s, Wall: 0.53 s\nSize 150 Time: CPU 0.88 s, Wall: 0.88 s\nSize 175 Time: CPU 1.28 s, Wall: 1.28 s\nSize 200 Time: CPU 1.71 s, Wall: 1.72 s\nSize 225 Time: CPU 2.29 s, Wall: 2.33 s\nSize 250 Time: CPU 2.99 s, Wall: 3.00 s\nSize 275 Time: CPU 3.83 s, Wall: 3.84 s\nSize 300 Time: CPU 4.67 s, Wall: 4.67 s\n```\n\nWith patch:\n\n```\nTesting Ring of integers modulo 2432902008176640029\nSize  50 Time: CPU 0.09 s, Wall: 0.09 s\nSize  75 Time: CPU 0.20 s, Wall: 0.20 s\nSize 100 Time: CPU 0.36 s, Wall: 0.36 s\nSize 125 Time: CPU 0.58 s, Wall: 0.61 s\nSize 150 Time: CPU 0.92 s, Wall: 0.92 s\nSize 175 Time: CPU 1.26 s, Wall: 1.26 s\nSize 200 Time: CPU 1.64 s, Wall: 1.64 s\nSize 225 Time: CPU 2.06 s, Wall: 2.05 s\nSize 250 Time: CPU 2.62 s, Wall: 2.62 s\nSize 275 Time: CPU 3.19 s, Wall: 3.19 s\nSize 300 Time: CPU 3.73 s, Wall: 3.73 s\nTesting Ring of integers modulo 51090942171709440031\nSize  50 Time: CPU 0.10 s, Wall: 0.10 s\nSize  75 Time: CPU 0.32 s, Wall: 0.32 s\nSize 100 Time: CPU 0.47 s, Wall: 0.47 s\nSize 125 Time: CPU 0.86 s, Wall: 0.86 s\nSize 150 Time: CPU 1.29 s, Wall: 1.29 s\nSize 175 Time: CPU 1.82 s, Wall: 1.82 s\nSize 200 Time: CPU 2.46 s, Wall: 2.46 s\nSize 225 Time: CPU 3.34 s, Wall: 3.36 s\nSize 250 Time: CPU 4.48 s, Wall: 4.48 s\nSize 275 Time: CPU 5.85 s, Wall: 5.85 s\nSize 300 Time: CPU 7.71 s, Wall: 7.72 s\n```\n\nThis seems to suggest that improvements are needed in the integer `determinant()` function.",
    "created_at": "2013-01-29T14:19:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205926",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:15'></a>
I get different timings, the patch always seems to help.

I used the script

```
def dettest(k):
    print "Testing", k
    for s in [50,75..300]:
        M = random_matrix(k, s)
        print "Size%4i"%s,
        time d = M.det()

dettest(Integers(2432902008176640029))
dettest(Integers(51090942171709440031))
```

Without patch:

```
Testing Ring of integers modulo 2432902008176640029
Size  50 Time: CPU 1.43 s, Wall: 1.43 s
Size  75 Time: CPU 0.28 s, Wall: 0.43 s
Size 100 Time: CPU 0.33 s, Wall: 0.33 s
Size 125 Time: CPU 0.51 s, Wall: 0.51 s
Size 150 Time: CPU 0.88 s, Wall: 0.88 s
Size 175 Time: CPU 1.17 s, Wall: 1.17 s
Size 200 Time: CPU 1.64 s, Wall: 1.64 s
Size 225 Time: CPU 2.19 s, Wall: 2.19 s
Size 250 Time: CPU 2.90 s, Wall: 2.91 s
Size 275 Time: CPU 3.82 s, Wall: 3.83 s
Size 300 Time: CPU 4.50 s, Wall: 4.50 s
Testing Ring of integers modulo 51090942171709440031
Size  50 Time: CPU 1.53 s, Wall: 1.53 s
Size  75 Time: CPU 0.18 s, Wall: 0.18 s
Size 100 Time: CPU 0.34 s, Wall: 0.34 s
Size 125 Time: CPU 0.54 s, Wall: 0.53 s
Size 150 Time: CPU 0.88 s, Wall: 0.88 s
Size 175 Time: CPU 1.28 s, Wall: 1.28 s
Size 200 Time: CPU 1.71 s, Wall: 1.72 s
Size 225 Time: CPU 2.29 s, Wall: 2.33 s
Size 250 Time: CPU 2.99 s, Wall: 3.00 s
Size 275 Time: CPU 3.83 s, Wall: 3.84 s
Size 300 Time: CPU 4.67 s, Wall: 4.67 s
```

With patch:

```
Testing Ring of integers modulo 2432902008176640029
Size  50 Time: CPU 0.09 s, Wall: 0.09 s
Size  75 Time: CPU 0.20 s, Wall: 0.20 s
Size 100 Time: CPU 0.36 s, Wall: 0.36 s
Size 125 Time: CPU 0.58 s, Wall: 0.61 s
Size 150 Time: CPU 0.92 s, Wall: 0.92 s
Size 175 Time: CPU 1.26 s, Wall: 1.26 s
Size 200 Time: CPU 1.64 s, Wall: 1.64 s
Size 225 Time: CPU 2.06 s, Wall: 2.05 s
Size 250 Time: CPU 2.62 s, Wall: 2.62 s
Size 275 Time: CPU 3.19 s, Wall: 3.19 s
Size 300 Time: CPU 3.73 s, Wall: 3.73 s
Testing Ring of integers modulo 51090942171709440031
Size  50 Time: CPU 0.10 s, Wall: 0.10 s
Size  75 Time: CPU 0.32 s, Wall: 0.32 s
Size 100 Time: CPU 0.47 s, Wall: 0.47 s
Size 125 Time: CPU 0.86 s, Wall: 0.86 s
Size 150 Time: CPU 1.29 s, Wall: 1.29 s
Size 175 Time: CPU 1.82 s, Wall: 1.82 s
Size 200 Time: CPU 2.46 s, Wall: 2.46 s
Size 225 Time: CPU 3.34 s, Wall: 3.36 s
Size 250 Time: CPU 4.48 s, Wall: 4.48 s
Size 275 Time: CPU 5.85 s, Wall: 5.85 s
Size 300 Time: CPU 7.71 s, Wall: 7.72 s
```

This seems to suggest that improvements are needed in the integer `determinant()` function.



---

archive/issue_comments_205927.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [jdemeyer](#comment%3A15):\n> I get different timings, the patch always seems to help.\n\n\nWhat I understand from your timings is that (apparently) over the larger ring (where the modulus does not fit on 64 bits), things are slower with the patch.\n\n> This seems to suggest that improvements are needed in the integer `determinant()` function.\n\n\nAgreed, on another ticket?",
    "created_at": "2013-01-29T14:31:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205927",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:16'></a>
Replying to [jdemeyer](#comment%3A15):
> I get different timings, the patch always seems to help.


What I understand from your timings is that (apparently) over the larger ring (where the modulus does not fit on 64 bits), things are slower with the patch.

> This seems to suggest that improvements are needed in the integer `determinant()` function.


Agreed, on another ticket?



---

archive/issue_comments_205928.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [Bouillaguet](#comment%3A16):\n> Agreed, on another ticket?\n\n#14032 perhaps?",
    "created_at": "2013-01-29T14:45:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205928",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:17'></a>
Replying to [Bouillaguet](#comment%3A16):
> Agreed, on another ticket?

#14032 perhaps?



---

archive/issue_comments_205929.json:
```json
{
    "body": "**Dependencies:** #14032",
    "created_at": "2013-01-30T12:55:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205929",
    "user": "https://github.com/jdemeyer"
}
```

**Dependencies:** #14032



---

archive/issue_events_045144.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "rename": {
        "from": "When computing determinant over GF(p), don't lift to ZZ",
        "to": "Better heuristics for determinent over ZZ and GF(p)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14007#event-45144"
}
```



---

archive/issue_comments_205930.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1 @@\n-It seems we compute determinants over `GF(p)` by lifting the matrix to `ZZ`.  This is a stupid idea.\n+This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.\n``````\n",
    "created_at": "2013-01-30T13:21:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205930",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1 @@
-It seems we compute determinants over `GF(p)` by lifting the matrix to `ZZ`.  This is a stupid idea.
+This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.
``````




---

archive/issue_comments_205931.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,3 @@\n This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.\n+\n+Also misc improvements to `integer_mod.pyx`\n``````\n",
    "created_at": "2013-01-30T15:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205931",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,3 @@
 This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.
+
+Also misc improvements to `integer_mod.pyx`
``````




---

archive/issue_events_045145.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "rename": {
        "from": "Better heuristics for determinent over ZZ and GF(p)",
        "to": "Better heuristics for determinant over ZZ and GF(p)"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14007#event-45145"
}
```



---

archive/issue_comments_205932.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-01-30T15:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205932",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_205933.json:
```json
{
    "body": "<a id='comment:21'></a>\nIn the end I found a lot of various inefficiencies, so the patch is quite a bit larger than initially.  However, both over `ZZ` and over `GF(p)`, determinants should be faster with this patch.",
    "created_at": "2013-01-30T15:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205933",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:21'></a>
In the end I found a lot of various inefficiencies, so the patch is quite a bit larger than initially.  However, both over `ZZ` and over `GF(p)`, determinants should be faster with this patch.



---

archive/issue_comments_205934.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,3 +1,5 @@\n This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.\n \n Also misc improvements to `integer_mod.pyx`\n+\n+**Apply** [attachment:14007_determinant.patch]\n``````\n",
    "created_at": "2013-01-30T15:09:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205934",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,3 +1,5 @@
 This patch improves on the heuristics to decide which algorithm to use for determinants over `ZZ` and `GF(p)`.
 
 Also misc improvements to `integer_mod.pyx`
+
+**Apply** [attachment:14007_determinant.patch]
``````




---

archive/issue_comments_205935.json:
```json
{
    "body": "**Changing status** from needs_review to needs_work.",
    "created_at": "2013-01-30T15:16:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205935",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_review to needs_work.



---

archive/issue_comments_205936.json:
```json
{
    "body": "**Changing status** from needs_work to needs_review.",
    "created_at": "2013-01-30T15:38:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205936",
    "user": "https://github.com/jdemeyer"
}
```

**Changing status** from needs_work to needs_review.



---

archive/issue_comments_205937.json:
```json
{
    "body": "<a id='comment:24'></a>\nEchelonization of matrices over the rationals could use some similar love. See #13925.",
    "created_at": "2013-01-30T17:03:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205937",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:24'></a>
Echelonization of matrices over the rationals could use some similar love. See #13925.



---

archive/attachments_018912.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "14007_determinant.patch",
    "asset_url": "tarball://root/attachments/some-uuid/ticket14007/14007_determinant.patch",
    "created_at": "2013-02-01T13:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.patch",
    "user": "https://github.com/jdemeyer"
}
```



---

archive/issue_comments_205938.json:
```json
{
    "body": "",
    "created_at": "2013-02-01T13:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205938",
    "user": "https://github.com/jdemeyer"
}
```





---

archive/issue_comments_205939.json:
```json
{
    "body": "<a id='comment:25'></a>\nWhat is this thing about sage/schemes/elliptic_curves/ell_point.py ? Is it actually supposed to be here ?",
    "created_at": "2013-02-01T21:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205939",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:25'></a>
What is this thing about sage/schemes/elliptic_curves/ell_point.py ? Is it actually supposed to be here ?



---

archive/issue_comments_205940.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [Bouillaguet](#comment%3A25):\n> Is it actually supposed to be here ?\nYes.  Because of the changed implementation of the `_pari_()` method of integermods, that exposed #11868.",
    "created_at": "2013-02-02T10:36:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205940",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:26'></a>
Replying to [Bouillaguet](#comment%3A25):
> Is it actually supposed to be here ?
Yes.  Because of the changed implementation of the `_pari_()` method of integermods, that exposed #11868.



---

archive/issue_comments_205941.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2013-02-02T10:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205941",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_205942.json:
```json
{
    "body": "<a id='comment:27'></a>\nLet's roll",
    "created_at": "2013-02-02T10:43:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205942",
    "user": "https://trac.sagemath.org/admin/accounts/users/Bouillaguet"
}
```

<a id='comment:27'></a>
Let's roll



---

archive/issue_events_045146.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-05T08:21:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14007#event-45146"
}
```



---

archive/issue_comments_205943.json:
```json
{
    "body": "**Merged:** sage-5.7.beta3",
    "created_at": "2013-02-05T08:21:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14007",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14007#issuecomment-205943",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.7.beta3
