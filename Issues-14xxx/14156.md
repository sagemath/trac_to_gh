# Issue 14156: New docbuilder always rebuilds everything

archive/issues_013952.json:
```json
{
    "body": "Assignee: mvngu\n\nCC:  @hivert @vbraun\n\nWhen running `make doc`, the whole documentation is always rebuilt, even if no source file has changed.\n\nBefore #6495, only **changed** files would be rebuilt:\n\n```\n$ make doc  # Initial build\n[...]\n\n$ time make doc  # Nothing changed\n[...]\nreal    0m51.266s\nuser    0m36.840s\nsys     0m10.040s\n\n$ touch devel/sage/sage/symbolic/function_factory.py\n\n$ time make doc  # Just one file changed\n[...]\nbuilding [html]: targets for 1 source files that are out of date\nupdating environment: 0 added, 1 changed, 0 removed\nreading sources... [100%] sage/symbolic/function_factory\n[...]\nwriting output... [ 33%] calculus\nwriting output... [ 66%] index\nwriting output... [100%] sage/symbolic/function_factory\n[...]\nreal    1m5.918s\nuser    0m51.900s\nsys     0m10.620s\n```\n\n---\n\nApply [attachment:trac_14156.v2.patch].\n\nIssue created by migration from https://trac.sagemath.org/ticket/14156\n\n",
    "closed_at": "2013-02-28T10:33:31Z",
    "created_at": "2013-02-21T13:01:23Z",
    "labels": [
        "component: documentation",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.8",
    "title": "New docbuilder always rebuilds everything",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14156",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: mvngu

CC:  @hivert @vbraun

When running `make doc`, the whole documentation is always rebuilt, even if no source file has changed.

Before #6495, only **changed** files would be rebuilt:

```
$ make doc  # Initial build
[...]

$ time make doc  # Nothing changed
[...]
real    0m51.266s
user    0m36.840s
sys     0m10.040s

$ touch devel/sage/sage/symbolic/function_factory.py

$ time make doc  # Just one file changed
[...]
building [html]: targets for 1 source files that are out of date
updating environment: 0 added, 1 changed, 0 removed
reading sources... [100%] sage/symbolic/function_factory
[...]
writing output... [ 33%] calculus
writing output... [ 66%] index
writing output... [100%] sage/symbolic/function_factory
[...]
real    1m5.918s
user    0m51.900s
sys     0m10.620s
```

---

Apply [attachment:trac_14156.v2.patch].

Issue created by migration from https://trac.sagemath.org/ticket/14156





---

archive/issue_comments_173846.json:
```json
{
    "body": "Note that running `sage --docbuild reference html` doesn't rebuild everything, so I guess the problem is that running `sage --docbuild reference inventory` rebuilds the inventory files no matter what, and then the html build sees that something has changed, so it rebuilds everything.",
    "created_at": "2013-02-21T18:58:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173846",
    "user": "https://github.com/jhpalmieri"
}
```

Note that running `sage --docbuild reference html` doesn't rebuild everything, so I guess the problem is that running `sage --docbuild reference inventory` rebuilds the inventory files no matter what, and then the html build sees that something has changed, so it rebuilds everything.



---

archive/issue_comments_173847.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-02-22T23:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173847",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_173848.json:
```json
{
    "body": "I think there are two problems. First, the inventory builder did not have a working `get_outdated_docs` method: it was inheriting the method from `StandaloneHTMLBuilder`, and it was always saying that all docs were outdated: it was comparing the modification time of the appropriate `rst` file to some nonexistent file. I've put in a new method which is identical to the inherited one, except that it compares to the modification time of `objects.inv`. \n\nThe second problem is that any change to the configuration triggers a rebuild, so passing `-D multidoc_first_pass=0` vs. `-D multidoc_first_pass=1`, or changing the setting of `app.config.intersphinx_mapping`, turn out to be bad ideas. I've deleted those, and instead filtered out the useless warning message (\"search index couldn't be loaded...\") during the inventory build.\n\nThis now works for me: I can type `make doc` twice, and it doesn't rebuild, and then I can type `sage --docbuild all html` or `sage --docbuild reference inventory` or variations on these and it doesn't rebuild. Touching a single file, running `sage -b` and then building the docs behaves properly.",
    "created_at": "2013-02-22T23:30:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173848",
    "user": "https://github.com/jhpalmieri"
}
```

I think there are two problems. First, the inventory builder did not have a working `get_outdated_docs` method: it was inheriting the method from `StandaloneHTMLBuilder`, and it was always saying that all docs were outdated: it was comparing the modification time of the appropriate `rst` file to some nonexistent file. I've put in a new method which is identical to the inherited one, except that it compares to the modification time of `objects.inv`. 

The second problem is that any change to the configuration triggers a rebuild, so passing `-D multidoc_first_pass=0` vs. `-D multidoc_first_pass=1`, or changing the setting of `app.config.intersphinx_mapping`, turn out to be bad ideas. I've deleted those, and instead filtered out the useless warning message ("search index couldn't be loaded...") during the inventory build.

This now works for me: I can type `make doc` twice, and it doesn't rebuild, and then I can type `sage --docbuild all html` or `sage --docbuild reference inventory` or variations on these and it doesn't rebuild. Touching a single file, running `sage -b` and then building the docs behaves properly.



---

archive/issue_comments_173849.json:
```json
{
    "body": "Attachment [trac_14156.patch](tarball://root/attachments/some-uuid/ticket14156/trac_14156.patch) by @vbraun created at 2013-02-23 02:42:29\n\nDoesn't that open us up to races again? The `if not (os.path.exists(refpath) and os.path.exists(invpath)):` saves us the first time round, but subsequent inventory builds will again read and write simultaneously in the inventory directory. It might be difficult to trigger since you usually don't do that much in subsequent runs...\n\nWe could just use an environment variable to sneak information past the command line interface...",
    "created_at": "2013-02-23T02:42:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173849",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14156.patch](tarball://root/attachments/some-uuid/ticket14156/trac_14156.patch) by @vbraun created at 2013-02-23 02:42:29

Doesn't that open us up to races again? The `if not (os.path.exists(refpath) and os.path.exists(invpath)):` saves us the first time round, but subsequent inventory builds will again read and write simultaneously in the inventory directory. It might be difficult to trigger since you usually don't do that much in subsequent runs...

We could just use an environment variable to sneak information past the command line interface...



---

archive/issue_comments_173850.json:
```json
{
    "body": "It's easy enough to bypass the `multidoc_first_pass` argument with an environment variable, but to get around `app.config.intersphinx_mapping = {}`, I think we will have to rewrite another chunk of Sphinx (intersphinx.py, maybe?).",
    "created_at": "2013-02-23T04:46:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173850",
    "user": "https://github.com/jhpalmieri"
}
```

It's easy enough to bypass the `multidoc_first_pass` argument with an environment variable, but to get around `app.config.intersphinx_mapping = {}`, I think we will have to rewrite another chunk of Sphinx (intersphinx.py, maybe?).



---

archive/issue_comments_173851.json:
```json
{
    "body": "Hi there,\n\nI'm sorry not being able to help more: this is my last message from my flat in Paris. I'm moving today and tomorrow to a suburb house and I won't have access to the network until Monday. \n\nReplying to [comment:5 jhpalmieri]:\n> It's easy enough to bypass the `multidoc_first_pass` argument with an environment variable, but to get around `app.config.intersphinx_mapping = {}`, I think we will have to rewrite another chunk of Sphinx (intersphinx.py, maybe?).\n\n\nThis is strange. When declaring a sphinx environment variable, there is a way to tell sphinx that changing this variable triggers the rebuild. See [Sphinx doc of add_config_value](http://sphinx-doc.org/ext/appapi.html#sphinx.application.Sphinx.add_config_value). Maybe I screwed up, but this shouldn't triggers rebuild.\n\nFlorent",
    "created_at": "2013-02-23T07:43:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173851",
    "user": "https://github.com/hivert"
}
```

Hi there,

I'm sorry not being able to help more: this is my last message from my flat in Paris. I'm moving today and tomorrow to a suburb house and I won't have access to the network until Monday. 

Replying to [comment:5 jhpalmieri]:
> It's easy enough to bypass the `multidoc_first_pass` argument with an environment variable, but to get around `app.config.intersphinx_mapping = {}`, I think we will have to rewrite another chunk of Sphinx (intersphinx.py, maybe?).


This is strange. When declaring a sphinx environment variable, there is a way to tell sphinx that changing this variable triggers the rebuild. See [Sphinx doc of add_config_value](http://sphinx-doc.org/ext/appapi.html#sphinx.application.Sphinx.add_config_value). Maybe I screwed up, but this shouldn't triggers rebuild.

Florent



---

archive/issue_comments_173852.json:
```json
{
    "body": "Florent, sorry, I didn't realize that. So I guess the problem is not `multidoc_first_pass`, as you point out. But setting `app.config.intersphinx_mapping` definitely triggers a rebuild, so I made this change in conf.py:\n\n```diff\ndiff --git a/doc/common/conf.py b/doc/common/conf.py\n--- a/doc/common/conf.py\n+++ b/doc/common/conf.py\n@@ -630,7 +630,7 @@\n     # set to a temporary directory.  We don't want to use intersphinx,\n     # etc., when doing introspection.\n     if app.srcdir.startswith(SAGE_DOC):\n-        app.add_config_value('intersphinx_mapping', {}, True)\n+        app.add_config_value('intersphinx_mapping', {}, False)\n         app.add_config_value('intersphinx_cache_limit', 5, False)\n         # We do *not* fully initialize intersphinx since we call it by hand\n         # in find_sage_dangling_links.\n```\nI'm still adding a `get_outdated_docs` method to the inventory builder. See the \"v2\" patch.",
    "created_at": "2013-02-23T17:36:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173852",
    "user": "https://github.com/jhpalmieri"
}
```

Florent, sorry, I didn't realize that. So I guess the problem is not `multidoc_first_pass`, as you point out. But setting `app.config.intersphinx_mapping` definitely triggers a rebuild, so I made this change in conf.py:

```diff
diff --git a/doc/common/conf.py b/doc/common/conf.py
--- a/doc/common/conf.py
+++ b/doc/common/conf.py
@@ -630,7 +630,7 @@
     # set to a temporary directory.  We don't want to use intersphinx,
     # etc., when doing introspection.
     if app.srcdir.startswith(SAGE_DOC):
-        app.add_config_value('intersphinx_mapping', {}, True)
+        app.add_config_value('intersphinx_mapping', {}, False)
         app.add_config_value('intersphinx_cache_limit', 5, False)
         # We do *not* fully initialize intersphinx since we call it by hand
         # in find_sage_dangling_links.
```
I'm still adding a `get_outdated_docs` method to the inventory builder. See the "v2" patch.



---

archive/issue_comments_173853.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-24T03:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173853",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_173854.json:
```json
{
    "body": "Attachment [trac_14156.v2.patch](tarball://root/attachments/some-uuid/ticket14156/trac_14156.v2.patch) by @vbraun created at 2013-02-24 03:38:21\n\nLooks good to me!",
    "created_at": "2013-02-24T03:38:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173854",
    "user": "https://github.com/vbraun"
}
```

Attachment [trac_14156.v2.patch](tarball://root/attachments/some-uuid/ticket14156/trac_14156.v2.patch) by @vbraun created at 2013-02-24 03:38:21

Looks good to me!



---

archive/issue_comments_173855.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-28T10:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173855",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_039957.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-28T10:33:31Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14156#event-39957"
}
```



---

archive/issue_comments_173856.json:
```json
{
    "body": "Even with this patch, rebuilding the documentation when nothing needs to be done still takes a very long time.\n\nIn sage-5.7:\n\n```\nreal    0m48.142s\nuser    0m37.120s\nsys     0m10.110s\n```\n\nIn sage-5.8.beta2:\n\n```\nreal    5m52.020s\nuser    4m39.910s\nsys     1m5.140s\n```\n\nDo you think this can be improved? See #14204 for a ticket.",
    "created_at": "2013-02-28T11:10:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14156",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14156#issuecomment-173856",
    "user": "https://github.com/jdemeyer"
}
```

Even with this patch, rebuilding the documentation when nothing needs to be done still takes a very long time.

In sage-5.7:

```
real    0m48.142s
user    0m37.120s
sys     0m10.110s
```

In sage-5.8.beta2:

```
real    5m52.020s
user    4m39.910s
sys     1m5.140s
```

Do you think this can be improved? See #14204 for a ticket.
