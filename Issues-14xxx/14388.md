# Issue 14388: Fix plural polynomials overflow error

archive/issues_014184.json:
```json
{
    "assignees": [],
    "body": "On 32-bit systems we sometimes see failures are of the following nature.\n\n```\nsage -t  devel/sage-main/sage/algebras/free_algebra.py\nException KeyError: (The ring pointer -0x1f5282c,) in 'sage.libs.singular.ring.singular_ring_delete' ignored\nException KeyError: (The ring pointer -0x1f52768,) in 'sage.libs.singular.ring.singular_ring_delete' ignored\nException KeyError: (The ring pointer -0x1f526a4,) in 'sage.libs.singular.ring.singular_ring_delete' ignored\n**********************************************************************\nFile \"/home/sagetest/sage-5.8.beta4/devel/sage-main/sage/algebras/free_algebra.py\", line 820:\n    sage: G=A.g_algebra({y*x:-x*y})\nException raised:\n    Traceback (most recent call last):\n      File \"/home/sagetest/sage-5.8.beta4/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/sagetest/sage-5.8.beta4/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/sagetest/sage-5.8.beta4/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_18[3]>\", line 1, in <module>\n        G=A.g_algebra({y*x:-x*y})###line 820:\n    sage: G=A.g_algebra({y*x:-x*y})\n      File \"/home/sagetest/sage-5.8.beta4/local/lib/python/site-packages/sage/algebras/free_algebra.py\", line 872, in g_algebra\n        order=order, check=check)\n      File \"factory.pyx\", line 143, in sage.structure.factory.UniqueFactory.__call__ (sage/structure/factory.c:1119)\n      File \"factory.pyx\", line 170, in sage.structure.factory.UniqueFactory.get_object (sage/structure/factory.c:1311)\n      File \"plural.pyx\", line 180, in sage.rings.polynomial.plural.G_AlgFactory.create_object (sage/rings/polynomial/plural.cpp:4289)\n      File \"plural.pyx\", line 358, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__init__ (sage/rings/polynomial/plural.cpp:5351)\n      File \"plural.pyx\", line 1471, in sage.rings.polynomial.plural.NCPolynomial_plural.__richcmp__ (sage/rings/polynomial/plural.cpp:11452)\n      File \"element.pyx\", line 855, in sage.structure.element.Element._richcmp (sage/structure/element.c:7980)\n      File \"coerce.pyx\", line 913, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8304)\n      File \"coerce.pyx\", line 1068, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps (sage/structure/coerce.c:9855)\n      File \"coerce.pyx\", line 1209, in sage.structure.coerce.CoercionModel_cache_maps.discover_coercion (sage/structure/coerce.c:11405)\n      File \"parent.pyx\", line 2116, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14383)\n      File \"parent.pyx\", line 2937, in sage.structure.parent._register_pair (sage/structure/parent.c:21545)\n      File \"parent.pyx\", line 2911, in sage.structure.parent.EltPair.__hash__ (sage/structure/parent.c:21193)\n      File \"plural.pyx\", line 573, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__hash__ (sage/rings/polynomial/plural.cpp:6487)\n    OverflowError: Python int too large to convert to C long\n```\n\nApply [attachment: trac_14388.patch.gz](https://github.com/sagemath/sage/files/ticket14388/trac_14388.patch.gz)\n\nCC:  jpflori @dimpase\n\nKeywords: **32-bit**\n\nReviewer: **Jean-Pierre Flori, Karl-Dieter Crisman**\n\nAuthor: **Nils Bruin, Jean-Pierre Flori**\n\nMerged: **sage-5.9.beta4**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14388_\n\n",
    "closed_at": "2013-04-04T17:40:40Z",
    "created_at": "2013-03-30T01:28:05Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20porting",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix plural polynomials overflow error",
    "type": "issue",
    "updated_at": "2013-04-04T17:40:40Z",
    "url": "https://github.com/sagemath/sage/issues/14388",
    "user": "https://github.com/kcrisman"
}
```
On 32-bit systems we sometimes see failures are of the following nature.

```
sage -t  devel/sage-main/sage/algebras/free_algebra.py
Exception KeyError: (The ring pointer -0x1f5282c,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
Exception KeyError: (The ring pointer -0x1f52768,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
Exception KeyError: (The ring pointer -0x1f526a4,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
**********************************************************************
File "/home/sagetest/sage-5.8.beta4/devel/sage-main/sage/algebras/free_algebra.py", line 820:
    sage: G=A.g_algebra({y*x:-x*y})
Exception raised:
    Traceback (most recent call last):
      File "/home/sagetest/sage-5.8.beta4/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/sagetest/sage-5.8.beta4/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/sagetest/sage-5.8.beta4/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_18[3]>", line 1, in <module>
        G=A.g_algebra({y*x:-x*y})###line 820:
    sage: G=A.g_algebra({y*x:-x*y})
      File "/home/sagetest/sage-5.8.beta4/local/lib/python/site-packages/sage/algebras/free_algebra.py", line 872, in g_algebra
        order=order, check=check)
      File "factory.pyx", line 143, in sage.structure.factory.UniqueFactory.__call__ (sage/structure/factory.c:1119)
      File "factory.pyx", line 170, in sage.structure.factory.UniqueFactory.get_object (sage/structure/factory.c:1311)
      File "plural.pyx", line 180, in sage.rings.polynomial.plural.G_AlgFactory.create_object (sage/rings/polynomial/plural.cpp:4289)
      File "plural.pyx", line 358, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__init__ (sage/rings/polynomial/plural.cpp:5351)
      File "plural.pyx", line 1471, in sage.rings.polynomial.plural.NCPolynomial_plural.__richcmp__ (sage/rings/polynomial/plural.cpp:11452)
      File "element.pyx", line 855, in sage.structure.element.Element._richcmp (sage/structure/element.c:7980)
      File "coerce.pyx", line 913, in sage.structure.coerce.CoercionModel_cache_maps.canonical_coercion (sage/structure/coerce.c:8304)
      File "coerce.pyx", line 1068, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps (sage/structure/coerce.c:9855)
      File "coerce.pyx", line 1209, in sage.structure.coerce.CoercionModel_cache_maps.discover_coercion (sage/structure/coerce.c:11405)
      File "parent.pyx", line 2116, in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14383)
      File "parent.pyx", line 2937, in sage.structure.parent._register_pair (sage/structure/parent.c:21545)
      File "parent.pyx", line 2911, in sage.structure.parent.EltPair.__hash__ (sage/structure/parent.c:21193)
      File "plural.pyx", line 573, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__hash__ (sage/rings/polynomial/plural.cpp:6487)
    OverflowError: Python int too large to convert to C long
```

Apply [attachment: trac_14388.patch.gz](https://github.com/sagemath/sage/files/ticket14388/trac_14388.patch.gz)

CC:  jpflori @dimpase

Keywords: **32-bit**

Reviewer: **Jean-Pierre Flori, Karl-Dieter Crisman**

Author: **Nils Bruin, Jean-Pierre Flori**

Merged: **sage-5.9.beta4**

_Issue created by migration from https://trac.sagemath.org/ticket/14388_





---

archive/issue_events_180004.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-03-30T01:28:05Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180004"
}
```



---

archive/issue_events_180005.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-03-30T01:28:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "component: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180005"
}
```



---

archive/issue_events_180006.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-03-30T01:28:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180006"
}
```



---

archive/issue_events_180007.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-03-30T01:28:05Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180007"
}
```



---

archive/issue_comments_175526.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nNote that, technically speaking, there are two errors - the overflow issue, and the pointer exception.  Either one could be fixed here, and then a new ticket opened for the other, if necessary.",
    "created_at": "2013-03-30T01:29:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175526",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:1'>Comment 1:</a>
Note that, technically speaking, there are two errors - the overflow issue, and the pointer exception.  Either one could be fixed here, and then a new ticket opened for the other, if necessary.



---

archive/issue_comments_175527.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nWe have seen such overflow errors before due to storing an unsigned long into a python int and then trying to put it in a signed long.",
    "created_at": "2013-03-30T02:22:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175527",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:2'>Comment 2:</a>
We have seen such overflow errors before due to storing an unsigned long into a python int and then trying to put it in a signed long.



---

archive/issue_comments_175528.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\n> We have seen such overflow errors before due to storing an unsigned long into a python int and then trying to put it in a signed long.\n\nSo you think it could be basically the same type of problem as #14254?  Unfortunately this particular set of errors wasn't fixed by that ticket.",
    "created_at": "2013-03-30T02:24:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175528",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:3'>Comment 3:</a>
> We have seen such overflow errors before due to storing an unsigned long into a python int and then trying to put it in a signed long.

So you think it could be basically the same type of problem as #14254?  Unfortunately this particular set of errors wasn't fixed by that ticket.



---

archive/issue_comments_175529.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nIn particular, do you think that \n\n```\ncdef long result = 0 # store it in a c-int and just let the overflowing additions wrap\n```\nin sage/rings/polynomial/plural.pyx could be the problem?  This is just a very naive idea, but all the problems do come in this same place (hash).",
    "created_at": "2013-03-30T02:30:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175529",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'>Comment 4:</a>
In particular, do you think that 

```
cdef long result = 0 # store it in a c-int and just let the overflowing additions wrap
```
in sage/rings/polynomial/plural.pyx could be the problem?  This is just a very naive idea, but all the problems do come in this same place (hash).



---

archive/issue_comments_175530.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nReplying to [@kcrisman](#comment%3A3):\n> So you think it could be basically the same type of problem as #14254?  Unfortunately this particular set of errors wasn't fixed by that ticket.\n\nIt looks like it's exactly that problem. Look at line 573 of plural.pyx\n\n```\n    def __hash__(self):\n...\n        return id(self)\n```\nThe special method `__hash__` is supposed to return a `Py_hash_t` (probably a \"long\"). The code is trying to return `id`, which is a python integer, and on a machine where ints are 32 bits, can easily exceed `2^31`. So it won't be able to convert to an int. Explicitly cast instead, via something like\n\n```\n    return <Py_hash_t><void*>self\n```\nwhich will be orders of magnitude faster too.\n\nIncidentally, Python itself shifts right by 2 any time an id gets used as a hash, because the lowest two bits are almost certainly 0.\n\nLooks like this line is due to #4539, patch `trac4539_fix_docs_rel10903.patch`. This is liable to fail on any 32-bit platform (64 bit too, very few systems make it into the upper half of the address space there).\n\nI'm pretty sure that the proposed fix would be safe.",
    "created_at": "2013-03-30T03:30:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175530",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:5'>Comment 5:</a>
Replying to [@kcrisman](#comment%3A3):
> So you think it could be basically the same type of problem as #14254?  Unfortunately this particular set of errors wasn't fixed by that ticket.

It looks like it's exactly that problem. Look at line 573 of plural.pyx

```
    def __hash__(self):
...
        return id(self)
```
The special method `__hash__` is supposed to return a `Py_hash_t` (probably a "long"). The code is trying to return `id`, which is a python integer, and on a machine where ints are 32 bits, can easily exceed `2^31`. So it won't be able to convert to an int. Explicitly cast instead, via something like

```
    return <Py_hash_t><void*>self
```
which will be orders of magnitude faster too.

Incidentally, Python itself shifts right by 2 any time an id gets used as a hash, because the lowest two bits are almost certainly 0.

Looks like this line is due to #4539, patch `trac4539_fix_docs_rel10903.patch`. This is liable to fail on any 32-bit platform (64 bit too, very few systems make it into the upper half of the address space there).

I'm pretty sure that the proposed fix would be safe.



---

archive/issue_comments_175531.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nYou might want to use the `signed_id()` function from `sage/structure/coerce_dict.pyx` (see #14254)",
    "created_at": "2013-03-30T03:55:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175531",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:6'>Comment 6:</a>
You might want to use the `signed_id()` function from `sage/structure/coerce_dict.pyx` (see #14254)



---

archive/issue_comments_175532.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nOr yes, perhaps\n\n```\n    return <Py_hash_t><void*>self\n```\nis even better (and guaranteed to be safe).",
    "created_at": "2013-03-30T03:56:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175532",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:7'>Comment 7:</a>
Or yes, perhaps

```
    return <Py_hash_t><void*>self
```
is even better (and guaranteed to be safe).



---

archive/issue_comments_175533.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nOkay, I'll definitely try this soon.  I noticed that `id` was a problem before, but since #14254 didn't fix this particular one, and I'm still learning about all these C-type (no pun intended) things, I was reluctant to mess about in such dangerous waters.",
    "created_at": "2013-03-30T12:12:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175533",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:8'>Comment 8:</a>
Okay, I'll definitely try this soon.  I noticed that `id` was a problem before, but since #14254 didn't fix this particular one, and I'm still learning about all these C-type (no pun intended) things, I was reluctant to mess about in such dangerous waters.



---

archive/issue_comments_175534.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nThanks for your help.  I'd love to use this, but I get a compilation error \n\n```\nError compiling Cython file:\n------------------------------------------------------------\n...\n            sage: P = A.g_algebra(relations={y*x:-x*y}, order = 'lex')\n            sage: {P:2}[P]            # indirect doctest\n            2\n\n        \"\"\"\n        return <Py_hash_t><void*>self\n               ^\n------------------------------------------------------------\n\nsage/rings/polynomial/plural.pyx:573:16: 'Py_hash_t' is not a type identifier\nError running command, failed with status 256.\n```\nand apparently this `Py_hash_t` doesn't even show up in the Sage source code!  Or so `search_src` says.",
    "created_at": "2013-03-30T13:32:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175534",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:9'>Comment 9:</a>
Thanks for your help.  I'd love to use this, but I get a compilation error 

```
Error compiling Cython file:
------------------------------------------------------------
...
            sage: P = A.g_algebra(relations={y*x:-x*y}, order = 'lex')
            sage: {P:2}[P]            # indirect doctest
            2

        """
        return <Py_hash_t><void*>self
               ^
------------------------------------------------------------

sage/rings/polynomial/plural.pyx:573:16: 'Py_hash_t' is not a type identifier
Error running command, failed with status 256.
```
and apparently this `Py_hash_t` doesn't even show up in the Sage source code!  Or so `search_src` says.



---

archive/issue_comments_175535.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nI cannot reproduce this one on 5.9.beta0 on (64 bits, but this should not really interfere) Windows 7.\nTrying a 32 bits W7 later.",
    "created_at": "2013-03-30T13:38:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175535",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:10'>Comment 10:</a>
I cannot reproduce this one on 5.9.beta0 on (64 bits, but this should not really interfere) Windows 7.
Trying a 32 bits W7 later.



---

archive/issue_comments_175536.json:
```json
{
    "body": "<a id='comment:11'>Comment 11:</a>\nReplying to [@kcrisman](#comment%3A9):\n> and apparently this `Py_hash_t` doesn't even show up in the Sage source code!  Or so `search_src` says.   \n\nIt's a standard type in CPython, so then it simply doesn't get imported into cython. Something along the lines of\n\n```\n    cdef extern ctypedef int Py_hash_t\n```\nshould do the trick (as far as cython is concerned, typechecking on `int` is close enough. The generated `C` will see the proper definition).\n\nIf you feel that's too heavy handed  you can also just cast `<long><void *>self`, which will be close enough.",
    "created_at": "2013-03-30T16:15:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175536",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:11'>Comment 11:</a>
Replying to [@kcrisman](#comment%3A9):
> and apparently this `Py_hash_t` doesn't even show up in the Sage source code!  Or so `search_src` says.   

It's a standard type in CPython, so then it simply doesn't get imported into cython. Something along the lines of

```
    cdef extern ctypedef int Py_hash_t
```
should do the trick (as far as cython is concerned, typechecking on `int` is close enough. The generated `C` will see the proper definition).

If you feel that's too heavy handed  you can also just cast `<long><void *>self`, which will be close enough.



---

archive/issue_comments_175537.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nReplying to [jpflori](#comment%3A10):\n> I cannot reproduce this one on 5.9.beta0 on (64 bits, but this should not really interfere)\n\nIf that means 64 bit system word types it makes all the difference for the overflow error. As a result, you won't see the \"ignored exceptions\" either. Those don't trigger a doctest failure. You just get to see them if another failure causes the output to be printed (probably stderr gets spooled to the same file, but not tested by the doctest code)",
    "created_at": "2013-03-30T16:18:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175537",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:12'>Comment 12:</a>
Replying to [jpflori](#comment%3A10):
> I cannot reproduce this one on 5.9.beta0 on (64 bits, but this should not really interfere)

If that means 64 bit system word types it makes all the difference for the overflow error. As a result, you won't see the "ignored exceptions" either. Those don't trigger a doctest failure. You just get to see them if another failure causes the output to be printed (probably stderr gets spooled to the same file, but not tested by the doctest code)



---

archive/issue_comments_175538.json:
```json
{
    "body": "<a id='comment:13'>Comment 13:</a>\nCygwin is 32 bits only so I don't think the fact that Windows is or not matters.\nAnyway I'll check on a completly 32 bits setup later.",
    "created_at": "2013-03-30T16:24:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175538",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:13'>Comment 13:</a>
Cygwin is 32 bits only so I don't think the fact that Windows is or not matters.
Anyway I'll check on a completly 32 bits setup later.



---

archive/issue_comments_175539.json:
```json
{
    "body": "<a id='comment:14'>Comment 14:</a>\nSame result with 5.9.beta1 on the completely 32 bits system, I mean no error for me.\n\nKarl-Dieter, I know it will take some time, but could you give sage-5.9.beta* a shot?\n\nAnyway, if the id(self) looks really fishy, we could just relpace it, even if the error disappear in 5.9.",
    "created_at": "2013-03-30T17:42:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175539",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:14'>Comment 14:</a>
Same result with 5.9.beta1 on the completely 32 bits system, I mean no error for me.

Karl-Dieter, I know it will take some time, but could you give sage-5.9.beta* a shot?

Anyway, if the id(self) looks really fishy, we could just relpace it, even if the error disappear in 5.9.



---

archive/issue_comments_175540.json:
```json
{
    "body": "<a id='comment:15'>Comment 15:</a>\nReplying to [jpflori](#comment%3A14):\n> Same result with 5.9.beta1 on the completely 32 bits system, I mean no error for me.\n\nYes, that just means that the pointers in question happen to end up in the lower half of the memory map on your machine.",
    "created_at": "2013-03-30T17:48:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175540",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:15'>Comment 15:</a>
Replying to [jpflori](#comment%3A14):
> Same result with 5.9.beta1 on the completely 32 bits system, I mean no error for me.

Yes, that just means that the pointers in question happen to end up in the lower half of the memory map on your machine.



---

archive/issue_comments_175541.json:
```json
{
    "body": "<a id='comment:16'>Comment 16:</a>\nSorry, JP - this *is* on a 5.9.beta2 as well, I just pasted one from earlier.\n\nUnfortunately, this needs more massaging, apparently.  I wish I knew more about this.\n\n```\n$ ../../sage -b\n\n----------------------------------------------------------\nsage: Building and installing modified Sage library files.\n\n\nInstalling c_lib\nscons: `install' is up to date.\nUpdating Cython code....\nBuilding modified file sage/rings/polynomial/plural.pyx.\nExecuting 1 command (using 1 thread)\ncython --gdb --cplus --old-style-globals --embed-positions --directive cdivision=True,autotestdict=False,fast_getattr=True -I/home/sagetest/sage-5.9.beta2/devel/sage-main -o sage/rings/polynomial/plural.cpp sage/rings/polynomial/plural.pyx\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n\n\"\"\"\ninclude \"sage/ext/stdsage.pxi\"\ninclude \"sage/ext/interrupt.pxi\"\n\ncdef extern ctypedef int Py_hash_t\n           ^\n------------------------------------------------------------\n\nsage/rings/polynomial/plural.pyx:108:12: Expected an identifier, found 'ctypedef'\n\nError compiling Cython file:\n------------------------------------------------------------\n...\n\n\"\"\"\ninclude \"sage/ext/stdsage.pxi\"\ninclude \"sage/ext/interrupt.pxi\"\n\ncdef extern ctypedef int Py_hash_t\n                        ^\n------------------------------------------------------------\n\nsage/rings/polynomial/plural.pyx:108:25: Syntax error in C variable declaration\nError running command, failed with status 256.\nError installing modified sage library code.\n```\n\nHowever, casting to longs did the trick - `<long><void *>self` - as you suggested. I don't know how robust that is, though, say on other systems.",
    "created_at": "2013-03-30T18:54:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175541",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:16'>Comment 16:</a>
Sorry, JP - this *is* on a 5.9.beta2 as well, I just pasted one from earlier.

Unfortunately, this needs more massaging, apparently.  I wish I knew more about this.

```
$ ../../sage -b

----------------------------------------------------------
sage: Building and installing modified Sage library files.


Installing c_lib
scons: `install' is up to date.
Updating Cython code....
Building modified file sage/rings/polynomial/plural.pyx.
Executing 1 command (using 1 thread)
cython --gdb --cplus --old-style-globals --embed-positions --directive cdivision=True,autotestdict=False,fast_getattr=True -I/home/sagetest/sage-5.9.beta2/devel/sage-main -o sage/rings/polynomial/plural.cpp sage/rings/polynomial/plural.pyx

Error compiling Cython file:
------------------------------------------------------------
...

"""
include "sage/ext/stdsage.pxi"
include "sage/ext/interrupt.pxi"

cdef extern ctypedef int Py_hash_t
           ^
------------------------------------------------------------

sage/rings/polynomial/plural.pyx:108:12: Expected an identifier, found 'ctypedef'

Error compiling Cython file:
------------------------------------------------------------
...

"""
include "sage/ext/stdsage.pxi"
include "sage/ext/interrupt.pxi"

cdef extern ctypedef int Py_hash_t
                        ^
------------------------------------------------------------

sage/rings/polynomial/plural.pyx:108:25: Syntax error in C variable declaration
Error running command, failed with status 256.
Error installing modified sage library code.
```

However, casting to longs did the trick - `<long><void *>self` - as you suggested. I don't know how robust that is, though, say on other systems.



---

archive/issue_comments_175542.json:
```json
{
    "body": "<a id='comment:17'>Comment 17:</a>\nReplying to [@kcrisman](#comment%3A16):\n\nIt should be clear now that I'm not the best reference for such cython-specific things either. How about:\n\n```\ncdef extern from *:\n    ctypedef long Py_hash_t\n```\nAll we need to do is convince Cython it can use the type `Py_hash_t` in long-like contexts and that the C-compiler will know how to handle it. Cython-generated c-files *contain* the type definition for `Py_hash_t` already anyway.\n\nThe python C-api actually specifies that `tp_hash` special methods should return a `C long`, so perhaps the `Py_hash_t` thing is a Cython internal type anyway.",
    "created_at": "2013-03-30T19:23:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175542",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:17'>Comment 17:</a>
Replying to [@kcrisman](#comment%3A16):

It should be clear now that I'm not the best reference for such cython-specific things either. How about:

```
cdef extern from *:
    ctypedef long Py_hash_t
```
All we need to do is convince Cython it can use the type `Py_hash_t` in long-like contexts and that the C-compiler will know how to handle it. Cython-generated c-files *contain* the type definition for `Py_hash_t` already anyway.

The python C-api actually specifies that `tp_hash` special methods should return a `C long`, so perhaps the `Py_hash_t` thing is a Cython internal type anyway.



---

archive/issue_comments_175543.json:
```json
{
    "body": "<a id='comment:18'>Comment 18:</a>\nThe last solution looks ok.",
    "created_at": "2013-03-30T19:29:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175543",
    "user": "https://github.com/sagetrac-jpflori"
}
```

<a id='comment:18'>Comment 18:</a>
The last solution looks ok.



---

archive/issue_comments_175544.json:
```json
{
    "body": "Attachment: **[trac_14388.patch.gz](https://github.com/sagemath/sage/files/ticket14388/trac_14388.patch.gz)**",
    "created_at": "2013-03-30T19:34:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175544",
    "user": "https://github.com/sagetrac-jpflori"
}
```

Attachment: **[trac_14388.patch.gz](https://github.com/sagemath/sage/files/ticket14388/trac_14388.patch.gz)**



---

archive/issue_events_180008.json:
```json
{
    "actor": "https://github.com/sagetrac-jpflori",
    "created_at": "2013-03-30T19:35:30Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180008"
}
```



---

archive/issue_comments_175545.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -36,3 +36,5 @@\n       File \"plural.pyx\", line 573, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__hash__ (sage/rings/polynomial/plural.cpp:6487)\n     OverflowError: Python int too large to convert to C long\n ```\n+\n+Apply [attachment: trac_14388.patch.gz](https://github.com/sagemath/sage/files/ticket14388/trac_14388.patch.gz)\n``````\n",
    "created_at": "2013-03-30T19:35:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175545",
    "user": "https://github.com/sagetrac-jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -36,3 +36,5 @@
       File "plural.pyx", line 573, in sage.rings.polynomial.plural.NCPolynomialRing_plural.__hash__ (sage/rings/polynomial/plural.cpp:6487)
     OverflowError: Python int too large to convert to C long
 ```
+
+Apply [attachment: trac_14388.patch.gz](https://github.com/sagemath/sage/files/ticket14388/trac_14388.patch.gz)
``````




---

archive/issue_events_180009.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-03-30T20:54:45Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180009"
}
```



---

archive/issue_events_180010.json:
```json
{
    "actor": "https://github.com/kcrisman",
    "created_at": "2013-03-30T20:54:45Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180010"
}
```



---

archive/issue_comments_175546.json:
```json
{
    "body": "<a id='comment:20'>Comment 20:</a>\nAh, I see, the header files... I think this works fine, let's get it in.",
    "created_at": "2013-03-30T20:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175546",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:20'>Comment 20:</a>
Ah, I see, the header files... I think this works fine, let's get it in.



---

archive/issue_comments_175547.json:
```json
{
    "body": "Author: **Nils Bruin, Jean-Pierre Flori**",
    "created_at": "2013-03-30T20:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175547",
    "user": "https://github.com/kcrisman"
}
```

Author: **Nils Bruin, Jean-Pierre Flori**



---

archive/issue_comments_175548.json:
```json
{
    "body": "Reviewer: **Jean-Pierre Flori, Karl-Dieter Crisman**",
    "created_at": "2013-03-30T20:54:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175548",
    "user": "https://github.com/kcrisman"
}
```

Reviewer: **Jean-Pierre Flori, Karl-Dieter Crisman**



---

archive/issue_events_180011.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-01T13:03:56Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "title_is": "Fix plural polynomials overflow error",
    "title_was": "Fix Cygwin failure in plural polynomials overflow error",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180011"
}
```



---

archive/issue_comments_175549.json:
```json
{
    "body": "Changed keywords from **Cygwin** to **32-bit**",
    "created_at": "2013-04-01T13:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175549",
    "user": "https://github.com/jdemeyer"
}
```

Changed keywords from **Cygwin** to **32-bit**



---

archive/issue_events_180012.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-01T13:03:56Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20porting%3A%20cygwin",
    "label_color": "000080",
    "label_name": "component: porting: cygwin",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180012"
}
```



---

archive/issue_events_180013.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-01T13:03:56Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20porting",
    "label_color": "000080",
    "label_name": "component: porting",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180013"
}
```



---

archive/issue_comments_175550.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-On Cygwin we see that now most failures are of the following nature.\n+On 32-bit systems we sometimes see failures are of the following nature.\n \n ```\n sage -t  devel/sage-main/sage/algebras/free_algebra.py\n``````\n",
    "created_at": "2013-04-01T13:03:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175550",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-On Cygwin we see that now most failures are of the following nature.
+On 32-bit systems we sometimes see failures are of the following nature.
 
 ```
 sage -t  devel/sage-main/sage/algebras/free_algebra.py
``````




---

archive/issue_comments_175551.json:
```json
{
    "body": "Merged: **sage-5.9.beta4**",
    "created_at": "2013-04-04T17:40:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14388#issuecomment-175551",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.9.beta4**



---

archive/issue_events_180014.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T17:40:40Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180014"
}
```



---

archive/issue_events_180015.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-04T17:40:40Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14388",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14388#event-180015"
}
```
