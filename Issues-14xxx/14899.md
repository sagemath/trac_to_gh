# Issue 14899: Anticanonical hypersurfaces cannot handle finite fields

archive/issues_014695.json:
```json
{
    "assignees": [],
    "body": "As originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion\n\nThe problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)\n\nApply\n* [attachment: trac_14899_fraction_field_string.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_fraction_field_string.patch.gz)\n* [attachment: trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch\u200b.gz](https://github.com/sagemath/sage/files/ticket14899/4753885a30410106ebc01b521fb9270a.gz)\n\nAssignee: **@aghitza**\n\nCC:  @vbraun\n\nKeywords: **toric**\n\nReviewer: **Volker Braun**\n\nAuthor: **Andrey Novoseltsev**\n\nMerged: **sage-5.12.beta1**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14899_\n\n",
    "closed_at": "2013-08-16T21:14:59Z",
    "created_at": "2013-07-16T16:58:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20algebraic%20geometry",
        "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.12",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Anticanonical hypersurfaces cannot handle finite fields",
    "type": "issue",
    "updated_at": "2013-08-16T21:14:59Z",
    "url": "https://github.com/sagemath/sage/issues/14899",
    "user": "https://github.com/novoselt"
}
```
As originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion

The problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)

Apply
* [attachment: trac_14899_fraction_field_string.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_fraction_field_string.patch.gz)
* [attachment: trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch​.gz](https://github.com/sagemath/sage/files/ticket14899/4753885a30410106ebc01b521fb9270a.gz)

Assignee: **@aghitza**

CC:  @vbraun

Keywords: **toric**

Reviewer: **Volker Braun**

Author: **Andrey Novoseltsev**

Merged: **sage-5.12.beta1**

_Issue created by migration from https://trac.sagemath.org/ticket/14899_





---

archive/issue_events_194564.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-07-16T16:58:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194564"
}
```



---

archive/issue_events_194565.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-07-16T16:58:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20algebraic%20geometry",
    "label_color": "0000ff",
    "label_name": "component: algebraic geometry",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194565"
}
```



---

archive/issue_events_194566.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-07-16T16:58:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194566"
}
```



---

archive/issue_events_194567.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-07-16T16:58:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194567"
}
```



---

archive/issue_comments_185309.json:
```json
{
    "body": "Author: **Andrey Novoseltsev**",
    "created_at": "2013-07-16T17:05:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185309",
    "user": "https://github.com/novoselt"
}
```

Author: **Andrey Novoseltsev**



---

archive/issue_comments_185310.json:
```json
{
    "body": "<a id='comment:1'>Comment 1:</a>\nI've also added checks that the number of coefficients is correct - it is easy to mess up...",
    "created_at": "2013-07-16T17:05:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185310",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:1'>Comment 1:</a>
I've also added checks that the number of coefficients is correct - it is easy to mess up...



---

archive/issue_events_194568.json:
```json
{
    "actor": "https://github.com/novoselt",
    "created_at": "2013-07-16T17:05:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194568"
}
```



---

archive/issue_comments_185311.json:
```json
{
    "body": "<a id='comment:2'>Comment 2:</a>\nI still don't understand why there is the hack with the symbolic ring at all. Can you give an example of an input where it is necessary?",
    "created_at": "2013-07-16T17:55:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185311",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'>Comment 2:</a>
I still don't understand why there is the hack with the symbolic ring at all. Can you give an example of an input where it is necessary?



---

archive/issue_comments_185312.json:
```json
{
    "body": "<a id='comment:3'>Comment 3:</a>\n\n```\nsage: R = PolynomialRing(QQ, 3, \"x\").fraction_field()\nsage: print R(SR(\"x0/x1\"))\nx0/x1\nsage: print R(\"x0/x1\")\nTraceback (most recent call last):\n...\nTypeError: no canonical coercion from Fraction Field of Multivariate Polynomial Ring in x0, x1, x2 over Rational Field to Rational Field\n```\nWhen entering symbolic coefficients, I find it quite convenient to enter them as `coefficients=[\"a/b\", \"c^2\", ...]` and it does not work unless we pass through SR. Ideally, having or not having SR conversion should make no difference (apart from speed), but apparently with strings things don't work without SR and with finite fields they don't work with SR.",
    "created_at": "2013-07-16T18:20:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185312",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:3'>Comment 3:</a>

```
sage: R = PolynomialRing(QQ, 3, "x").fraction_field()
sage: print R(SR("x0/x1"))
x0/x1
sage: print R("x0/x1")
Traceback (most recent call last):
...
TypeError: no canonical coercion from Fraction Field of Multivariate Polynomial Ring in x0, x1, x2 over Rational Field to Rational Field
```
When entering symbolic coefficients, I find it quite convenient to enter them as `coefficients=["a/b", "c^2", ...]` and it does not work unless we pass through SR. Ideally, having or not having SR conversion should make no difference (apart from speed), but apparently with strings things don't work without SR and with finite fields they don't work with SR.



---

archive/issue_comments_185313.json:
```json
{
    "body": "<a id='comment:4'>Comment 4:</a>\nI don't think we should promote that, there are lots of special variables in the symbolic ring. Is `\"e\"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.",
    "created_at": "2013-07-16T18:37:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185313",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:4'>Comment 4:</a>
I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `"e"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.



---

archive/issue_comments_185314.json:
```json
{
    "body": "Attachment: **[trac_14899_fraction_field_string.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_fraction_field_string.patch.gz)**\n\nInitial patch",
    "created_at": "2013-07-16T19:06:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185314",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_14899_fraction_field_string.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_fraction_field_string.patch.gz)**

Initial patch



---

archive/issue_comments_185315.json:
```json
{
    "body": "<a id='comment:5'>Comment 5:</a>\nI've added a patch to allow conversion of strings into fraction fields, this ought to work similar to polynomial rings.",
    "created_at": "2013-07-16T19:09:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185315",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'>Comment 5:</a>
I've added a patch to allow conversion of strings into fraction fields, this ought to work similar to polynomial rings.



---

archive/issue_comments_185316.json:
```json
{
    "body": "<a id='comment:6'>Comment 6:</a>\nReplying to [@vbraun](#comment%3A4):\n> I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `\"e\"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.\n\nThat's a valid point about special constants, but in general it is quite similar to specifying names of generators and constructing base rings manually is a bit annoying especially when you don't want iterated fractions fields. In any case you let it though and prohibiting it now is breaking backward compatibility ;-) It is also on purpose that explicit symbolic coefficients (i.e. elements of SR, not strings) are converted to names in a polynomial ring: polynomials are way faster and more convenient to work with. In general, it would be nice to have Macaulay2 feature of \"generic elements of a given ring\"...",
    "created_at": "2013-07-16T20:12:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185316",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:6'>Comment 6:</a>
Replying to [@vbraun](#comment%3A4):
> I don't think we should promote that, there are lots of special variables in the symbolic ring. Is `"e"` to be interpreted as a variable or 2.718...? The Sage philosophy is to require the user to declare ring variables. If that is too cumbersome for you then you can always switch to `automatic_names(True)`. We should just use `get_coercion_model().common_parent()` to construct the common parent of all coefficients and the base ring of the variety.

That's a valid point about special constants, but in general it is quite similar to specifying names of generators and constructing base rings manually is a bit annoying especially when you don't want iterated fractions fields. In any case you let it though and prohibiting it now is breaking backward compatibility ;-) It is also on purpose that explicit symbolic coefficients (i.e. elements of SR, not strings) are converted to names in a polynomial ring: polynomials are way faster and more convenient to work with. In general, it would be nice to have Macaulay2 feature of "generic elements of a given ring"...



---

archive/issue_comments_185317.json:
```json
{
    "body": "<a id='comment:7'>Comment 7:</a>\nPositive review to Volker's patch, no need in SR with it.",
    "created_at": "2013-07-16T20:21:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185317",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:7'>Comment 7:</a>
Positive review to Volker's patch, no need in SR with it.



---

archive/issue_comments_185318.json:
```json
{
    "body": "<a id='comment:8'>Comment 8:</a>\nBut if you really want symbolic coefficients then it should be possible to do so:\n\n```\nsage: toric_varieties.P1().anticanonical_hypersurface(coefficients=[sin(x), 1, 1])\n[...]\nTypeError: unable to convert sin(x) to a rational\n```\nI don't really mind converting coefficients given as strings to polynomials / fraction field elements but at the end you should find the `common_parent()` and use that.",
    "created_at": "2013-07-16T20:42:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185318",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:8'>Comment 8:</a>
But if you really want symbolic coefficients then it should be possible to do so:

```
sage: toric_varieties.P1().anticanonical_hypersurface(coefficients=[sin(x), 1, 1])
[...]
TypeError: unable to convert sin(x) to a rational
```
I don't really mind converting coefficients given as strings to polynomials / fraction field elements but at the end you should find the `common_parent()` and use that.



---

archive/issue_comments_185319.json:
```json
{
    "body": "<a id='comment:9'>Comment 9:</a>\nGood point, and it does bug me that \"e\" given as a string will not be just a variable of the base ring with this name. I think that both convenient and sensible solution it to treat anything in passed strings as a variable name (including e/i/cos) and find a common parent for all other coefficients. Will do this unless there are objections.",
    "created_at": "2013-07-18T22:07:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185319",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:9'>Comment 9:</a>
Good point, and it does bug me that "e" given as a string will not be just a variable of the base ring with this name. I think that both convenient and sensible solution it to treat anything in passed strings as a variable name (including e/i/cos) and find a common parent for all other coefficients. Will do this unless there are objections.



---

archive/issue_comments_185320.json:
```json
{
    "body": "Make use of Volker's patch",
    "created_at": "2013-07-18T23:26:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185320",
    "user": "https://github.com/novoselt"
}
```

Make use of Volker's patch



---

archive/issue_comments_185321.json:
```json
{
    "body": "<a id='comment:10'>Comment 10:</a>\nAttachment: **[trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch.gz)**\n\nDone, needs review!",
    "created_at": "2013-07-18T23:27:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185321",
    "user": "https://github.com/novoselt"
}
```

<a id='comment:10'>Comment 10:</a>
Attachment: **[trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch.gz)**

Done, needs review!



---

archive/issue_comments_185322.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,7 @@\n As originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion\n \n The problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)\n+\n+Apply\n+* [attachment: trac_14899_fraction_field_string.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_fraction_field_string.patch.gz)\n+* [attachment: trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch\u200b.gz](https://github.com/sagemath/sage/files/ticket14899/4753885a30410106ebc01b521fb9270a.gz)\n``````\n",
    "created_at": "2013-07-19T03:34:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185322",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,7 @@
 As originally reported on sage-devel: https://groups.google.com/d/topic/sage-devel/4QPBF_BDnfE/discussion
 
 The problem is that coefficients are converted to the symbolic ring and then back, which does not work (and is a bug of symbolic ring / finite field coercion). A workaround which may help in other cases and improve speed is to go through symbolic ring only when direct conversion fails. (Which, of course, is the bug for the corresponding ring and has to be solved as well...)
+
+Apply
+* [attachment: trac_14899_fraction_field_string.patch.gz](https://github.com/sagemath/sage/files/ticket14899/trac_14899_fraction_field_string.patch.gz)
+* [attachment: trac_14899_limit_SR_conversion_in_anticanonical_hypersurface.patch​.gz](https://github.com/sagemath/sage/files/ticket14899/4753885a30410106ebc01b521fb9270a.gz)
``````




---

archive/issue_comments_185323.json:
```json
{
    "body": "<a id='comment:12'>Comment 12:</a>\nThanks, looks great!",
    "created_at": "2013-07-19T03:42:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185323",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:12'>Comment 12:</a>
Thanks, looks great!



---

archive/issue_events_194569.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-19T03:42:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194569"
}
```



---

archive/issue_events_194570.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-07-19T03:42:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194570"
}
```



---

archive/issue_comments_185324.json:
```json
{
    "body": "Reviewer: **Volker Braun**",
    "created_at": "2013-07-19T03:42:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185324",
    "user": "https://github.com/vbraun"
}
```

Reviewer: **Volker Braun**



---

archive/issue_comments_185325.json:
```json
{
    "body": "Merged: **sage-5.12.beta1**",
    "created_at": "2013-08-16T21:14:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14899#issuecomment-185325",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.12.beta1**



---

archive/issue_events_194571.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:14:59Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194571"
}
```



---

archive/issue_events_194572.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-16T21:14:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14899",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14899#event-194572"
}
```
