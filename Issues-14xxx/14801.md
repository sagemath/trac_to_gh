# Issue 14801: Piecewise functions done right

archive/issues_014597.json:
```json
{
    "body": "Rewrite piecewise functions as symbolic functions.\n\nFor a (late) discussion about interface issues see https://groups.google.com/forum/?hl=en#!topic/sage-devel/dgwUMsdiHfM\n\nAssignee: @rwst\n\nCC:  @eviatarbach @kcrisman @slel @mkoeppe\n\nBranch/Commit: 966859c030256f78b656d9a7cb514364518fecc1\n\nReviewer: Volker Braun, Ralf Stephan\n\nAuthor: Volker Braun, Ralf Stephan\n\nDependencies: #14800, #14780, #13125, #14802, #16397, #17759\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14801\n\n",
    "closed_at": "2016-04-23T08:45:39Z",
    "created_at": "2013-06-21T21:56:38Z",
    "labels": [
        "component: symbolics",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Piecewise functions done right",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14801",
    "user": "https://github.com/vbraun"
}
```
Rewrite piecewise functions as symbolic functions.

For a (late) discussion about interface issues see https://groups.google.com/forum/?hl=en#!topic/sage-devel/dgwUMsdiHfM

Assignee: @rwst

CC:  @eviatarbach @kcrisman @slel @mkoeppe

Branch/Commit: 966859c030256f78b656d9a7cb514364518fecc1

Reviewer: Volker Braun, Ralf Stephan

Author: Volker Braun, Ralf Stephan

Dependencies: #14800, #14780, #13125, #14802, #16397, #17759

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/14801





---

archive/issue_comments_197875.json:
```json
{
    "body": "<a id='comment:1'></a>Patch is just a first proof of concept now",
    "created_at": "2013-06-21T22:09:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197875",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:1'></a>Patch is just a first proof of concept now



---

archive/issue_comments_197876.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-06-27T15:16:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197876",
    "user": "https://github.com/vbraun"
}
```

Updated patch



---

archive/issue_comments_197877.json:
```json
{
    "body": "<a id='comment:3'></a>Attachment [trac_14801_piecewiese.patch](tarball://root/attachments/some-uuid/ticket14801/trac_14801_piecewiese.patch) by @eviatarbach created at 2013-07-11 05:27:46",
    "created_at": "2013-07-11T05:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197877",
    "user": "https://github.com/eviatarbach"
}
```

<a id='comment:3'></a>Attachment [trac_14801_piecewiese.patch](tarball://root/attachments/some-uuid/ticket14801/trac_14801_piecewiese.patch) by @eviatarbach created at 2013-07-11 05:27:46



---

archive/issue_comments_197878.json:
```json
{
    "body": "<a id='comment:4'></a>Presumably this would (help) solve #11225, #1773, #8994, and #8603.  And #12123.  Or maybe this won't help if it removes support for those things...\n\nSee also [Maxima's pw.mac](http://sourceforge.net/projects/piecewisefunc/).",
    "created_at": "2013-07-11T15:01:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197878",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:4'></a>Presumably this would (help) solve #11225, #1773, #8994, and #8603.  And #12123.  Or maybe this won't help if it removes support for those things...

See also [Maxima's pw.mac](http://sourceforge.net/projects/piecewisefunc/).



---

archive/issue_events_042476.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42476"
}
```



---

archive/issue_comments_197879.json:
```json
{
    "body": "<a id='comment:6'></a>New commits:",
    "created_at": "2014-04-01T07:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197879",
    "user": "https://github.com/rwst"
}
```

<a id='comment:6'></a>New commits:



---

archive/issue_comments_197880.json:
```json
{
    "body": "<a id='comment:7'></a>Many doctests fail in the new code. For example:\n\n```\nsage: f = piecewise([((0,1), x^3), ([-1,0], -x^2)]);  f\npiecewise(x|-->x^3 on (0, 1), x|-->-x^2 on [-1, 0]; x)\nsage: f(x=1/2)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-6d710eda1bb0> in <module>()\n----> 1 f(x=Integer(1)/Integer(2))\n\nTypeError: new_f() got an unexpected keyword argument 'x'\n```\nI am not well versed in Python. I think there is maybe a problem in `symbolic/function_factory.pyx:eval_on_operands()` (dynamic methods for symbolic expressions, added with #9556) which is uncovered with this ticket.\n\n```\ndef eval_on_operands(f):\n    @sage_wraps(f)\n    def new_f(ex):\n        return f(*ex.operands())\n    return new_f\n```\nApparently `f` gets some `new_f` on creation and tries to call it with a named parameter but python barfs because the parameter wasn't expected in `new_f`. Moreover, even without name `f(1/2)` barfs because the number of arguments to `new_f` doesn't fit anymore. So only `f()` will call `new_f` succesfully but that's useless.",
    "created_at": "2014-04-01T08:55:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197880",
    "user": "https://github.com/rwst"
}
```

<a id='comment:7'></a>Many doctests fail in the new code. For example:

```
sage: f = piecewise([((0,1), x^3), ([-1,0], -x^2)]);  f
piecewise(x|-->x^3 on (0, 1), x|-->-x^2 on [-1, 0]; x)
sage: f(x=1/2)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-6d710eda1bb0> in <module>()
----> 1 f(x=Integer(1)/Integer(2))

TypeError: new_f() got an unexpected keyword argument 'x'
```
I am not well versed in Python. I think there is maybe a problem in `symbolic/function_factory.pyx:eval_on_operands()` (dynamic methods for symbolic expressions, added with #9556) which is uncovered with this ticket.

```
def eval_on_operands(f):
    @sage_wraps(f)
    def new_f(ex):
        return f(*ex.operands())
    return new_f
```
Apparently `f` gets some `new_f` on creation and tries to call it with a named parameter but python barfs because the parameter wasn't expected in `new_f`. Moreover, even without name `f(1/2)` barfs because the number of arguments to `new_f` doesn't fit anymore. So only `f()` will call `new_f` succesfully but that's useless.



---

archive/issue_comments_197881.json:
```json
{
    "body": "<a id='comment:8'></a>There is new code for `symbolic/function_factory.pyx:eval_on_operands()` in #14802, but if I use that I get `TypeError: 'NoneType' object is not callable` for every call to `f()`.",
    "created_at": "2014-04-01T09:23:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197881",
    "user": "https://github.com/rwst"
}
```

<a id='comment:8'></a>There is new code for `symbolic/function_factory.pyx:eval_on_operands()` in #14802, but if I use that I get `TypeError: 'NoneType' object is not callable` for every call to `f()`.



---

archive/issue_comments_197882.json:
```json
{
    "body": "<a id='comment:9'></a>Ok, with the dependencies #13125 and #14802 there remain two failing doctests in `piecewise.py`:\n\n```\nFile \"src/sage/functions/piecewise.py\", line 493, in sage.functions.piecewise.PiecewiseFunction.EvaluationMethods.extension\nFailed example:\n    g(3)\n...\n      File \"<doctest sage.functions.piecewise.PiecewiseFunction.EvaluationMethods.extension[3]>\", line 1, in <module>\n        g(Integer(3))\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/function_factory.py\", line 387, in new_f\n        return f(ex, *new_args, **kwds)\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/piecewise.py\", line 398, in __call__\n        return self.subs(substitution)\n      File \"expression.pyx\", line 4212, in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:20863)\n      File \"/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/piecewise.py\", line 209, in _subs_\n        raise ValueError('point is not in the domain')\n    ValueError: point is not in the domain\n```\nand the same in line `498`, as well as more than 200 failing doctests in `piecewise-old.py` because of the deprecation.",
    "created_at": "2014-04-03T14:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197882",
    "user": "https://github.com/rwst"
}
```

<a id='comment:9'></a>Ok, with the dependencies #13125 and #14802 there remain two failing doctests in `piecewise.py`:

```
File "src/sage/functions/piecewise.py", line 493, in sage.functions.piecewise.PiecewiseFunction.EvaluationMethods.extension
Failed example:
    g(3)
...
      File "<doctest sage.functions.piecewise.PiecewiseFunction.EvaluationMethods.extension[3]>", line 1, in <module>
        g(Integer(3))
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/symbolic/function_factory.py", line 387, in new_f
        return f(ex, *new_args, **kwds)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/piecewise.py", line 398, in __call__
        return self.subs(substitution)
      File "expression.pyx", line 4212, in sage.symbolic.expression.Expression.substitute (sage/symbolic/expression.cpp:20863)
      File "/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/piecewise.py", line 209, in _subs_
        raise ValueError('point is not in the domain')
    ValueError: point is not in the domain
```
and the same in line `498`, as well as more than 200 failing doctests in `piecewise-old.py` because of the deprecation.



---

archive/issue_comments_197883.json:
```json
{
    "body": "<a id='comment:10'></a>It appears that by checking `RealSet.are_pairwise_disjoint(*domain_list)` in `piecewise.py:145`, intervals with any boundaries from SR will not be accepted anymore.\n\n```\nage: piecewise([((-1, sqrt(2)), -x), ((sqrt(3), 2), x)], var=x)\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-27-571b9720cf91> in <module>()\n----> 1 piecewise([((-Integer(1), sqrt(Integer(2))), -x), ((sqrt(Integer(3)), Integer(2)), x)], var=x)\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.so in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:2696)()\n\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/piecewise.pyc in __call__(self, function_pieces, **kwds)\n    143             domain_list.append(domain)\n    144         if not RealSet.are_pairwise_disjoint(*domain_list):\n--> 145             raise ValueError('domains must be pairwise disjoint')\n```\nbut, since the old class didn't bother, it accepted all input. So the doctests in the old class will fail because the old class is redirected to the new. Personally I would just remove all doctests from the old class instead of fiddling together 200 working ones for a deprecated class. Is this allowed?\n\nIn any case I consider the restriction to reals surprising. At least I would want to see a better error msg.",
    "created_at": "2014-04-03T16:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197883",
    "user": "https://github.com/rwst"
}
```

<a id='comment:10'></a>It appears that by checking `RealSet.are_pairwise_disjoint(*domain_list)` in `piecewise.py:145`, intervals with any boundaries from SR will not be accepted anymore.

```
age: piecewise([((-1, sqrt(2)), -x), ((sqrt(3), 2), x)], var=x)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-27-571b9720cf91> in <module>()
----> 1 piecewise([((-Integer(1), sqrt(Integer(2))), -x), ((sqrt(Integer(3)), Integer(2)), x)], var=x)

/home/ralf/sage/local/lib/python2.7/site-packages/sage/misc/lazy_import.so in sage.misc.lazy_import.LazyImport.__call__ (sage/misc/lazy_import.c:2696)()

/home/ralf/sage/local/lib/python2.7/site-packages/sage/functions/piecewise.pyc in __call__(self, function_pieces, **kwds)
    143             domain_list.append(domain)
    144         if not RealSet.are_pairwise_disjoint(*domain_list):
--> 145             raise ValueError('domains must be pairwise disjoint')
```
but, since the old class didn't bother, it accepted all input. So the doctests in the old class will fail because the old class is redirected to the new. Personally I would just remove all doctests from the old class instead of fiddling together 200 working ones for a deprecated class. Is this allowed?

In any case I consider the restriction to reals surprising. At least I would want to see a better error msg.



---

archive/issue_comments_197884.json:
```json
{
    "body": "<a id='comment:11'></a>> and the same in line `498`, as well as more than 200 failing doctests in `piecewise-old.py` because of the deprecation.\n\nYeah, I don't know how we are going to deal with this.   I suspect we should have `Piecewise` for the old-style one for a deprecation period and `piecewise` for the new ones.  The current changes here aren't really a deprecation at all, but rather a backwards-incompatible change.",
    "created_at": "2014-04-08T01:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197884",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:11'></a>> and the same in line `498`, as well as more than 200 failing doctests in `piecewise-old.py` because of the deprecation.

Yeah, I don't know how we are going to deal with this.   I suspect we should have `Piecewise` for the old-style one for a deprecation period and `piecewise` for the new ones.  The current changes here aren't really a deprecation at all, but rather a backwards-incompatible change.



---

archive/issue_comments_197885.json:
```json
{
    "body": "<a id='comment:12'></a>My solution would be to leave `piecewise.py` as is and put the new code as `piecewise_real = PiecewiseRealFunction()` into `piecewise_real.py`. I have uploaded the alternative branch `public/piecewise-alt` to trac and set the Branch: field to it. Feel free to revert to the old one named `public/piecewise`.\n\n---\nNew commits:",
    "created_at": "2014-04-08T16:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197885",
    "user": "https://github.com/rwst"
}
```

<a id='comment:12'></a>My solution would be to leave `piecewise.py` as is and put the new code as `piecewise_real = PiecewiseRealFunction()` into `piecewise_real.py`. I have uploaded the alternative branch `public/piecewise-alt` to trac and set the Branch: field to it. Feel free to revert to the old one named `public/piecewise`.

---
New commits:



---

archive/issue_comments_197886.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-04-10T09:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197886",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197887.json:
```json
{
    "body": "<a id='comment:14'></a>Now on to the remaining two errors. This code throws:\n\n```\nsage: f = piecewise_real([((-1,1), x)]);  f; g = f.extension(0);  g; g(3)\n```\nIt works however if I patch `rings/real_lazy.pyx`:\n\n```\ndiff --git a/src/sage/sets/real_set.py b/src/sage/sets/real_set.py\nindex adc41d3..1d43cc4 100644\n--- a/src/sage/sets/real_set.py\n+++ b/src/sage/sets/real_set.py\n@@ -582,8 +582,8 @@ class RealInterval(UniqueRepresentation, Parent):\n             sage: i.contains(2)\n             True\n         \"\"\"\n-        cmp_lower = cmp(self._lower, x)\n-        cmp_upper = cmp(x, self._upper)\n+        cmp_lower = cmp(self._lower._value, x)\n+        cmp_upper = cmp(x, self._upper._value)\n         if cmp_lower == cmp_upper == -1:\n             return True\n         if cmp_lower == 0:\n```\nSo, as this fixes it and passes tests, I'm committing and proposing this branch for review.\n\n---\nNew commits:",
    "created_at": "2014-04-10T09:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197887",
    "user": "https://github.com/rwst"
}
```

<a id='comment:14'></a>Now on to the remaining two errors. This code throws:

```
sage: f = piecewise_real([((-1,1), x)]);  f; g = f.extension(0);  g; g(3)
```
It works however if I patch `rings/real_lazy.pyx`:

```
diff --git a/src/sage/sets/real_set.py b/src/sage/sets/real_set.py
index adc41d3..1d43cc4 100644
--- a/src/sage/sets/real_set.py
+++ b/src/sage/sets/real_set.py
@@ -582,8 +582,8 @@ class RealInterval(UniqueRepresentation, Parent):
             sage: i.contains(2)
             True
         """
-        cmp_lower = cmp(self._lower, x)
-        cmp_upper = cmp(x, self._upper)
+        cmp_lower = cmp(self._lower._value, x)
+        cmp_upper = cmp(x, self._upper._value)
         if cmp_lower == cmp_upper == -1:
             return True
         if cmp_lower == 0:
```
So, as this fixes it and passes tests, I'm committing and proposing this branch for review.

---
New commits:



---

archive/issue_comments_197888.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-10T09:06:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197888",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_events_042477.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42477"
}
```



---

archive/issue_events_042478.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42478"
}
```



---

archive/issue_comments_197889.json:
```json
{
    "body": "<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-25T14:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197889",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197890.json:
```json
{
    "body": "<a id='comment:17'></a>Now that the comparisons with infinity are fixed we should be able to get this finished. I don't like the separate `piecewise_real` thing. If there is some problem with symbolic expressions then that should be fixed. I'll have a look now.",
    "created_at": "2014-05-25T14:27:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197890",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:17'></a>Now that the comparisons with infinity are fixed we should be able to get this finished. I don't like the separate `piecewise_real` thing. If there is some problem with symbolic expressions then that should be fixed. I'll have a look now.



---

archive/issue_comments_197891.json:
```json
{
    "body": "<a id='comment:18'></a>New commits:",
    "created_at": "2014-05-25T17:35:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197891",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:18'></a>New commits:



---

archive/issue_comments_197892.json:
```json
{
    "body": "<a id='comment:19'></a>It looks like there is still no proper deprecation for the \"old\" piecewise stuff.  Given that there seems to be a significant amount of stuff that that has (even if in an antiquated form that should be redone), perhaps a potential solution would be to do a deprecation of `Piecewise` that leads to the old version, but where `piecewise` is the new one? (Wait, I already said this in comment:11.)  I agree with Volker that `piecewise_real` is probably too involved, but this is not so crucial a change that we shouldn't follow normal deprecation policy, especially since apparently people really do use the plotting and convolution/fourier stuff, buggy though it is.",
    "created_at": "2014-05-27T14:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197892",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:19'></a>It looks like there is still no proper deprecation for the "old" piecewise stuff.  Given that there seems to be a significant amount of stuff that that has (even if in an antiquated form that should be redone), perhaps a potential solution would be to do a deprecation of `Piecewise` that leads to the old version, but where `piecewise` is the new one? (Wait, I already said this in comment:11.)  I agree with Volker that `piecewise_real` is probably too involved, but this is not so crucial a change that we shouldn't follow normal deprecation policy, especially since apparently people really do use the plotting and convolution/fourier stuff, buggy though it is.



---

archive/issue_comments_197893.json:
```json
{
    "body": "<a id='comment:20'></a>Well the old branch should be still there, as I said in comment:12",
    "created_at": "2014-05-27T16:01:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197893",
    "user": "https://github.com/rwst"
}
```

<a id='comment:20'></a>Well the old branch should be still there, as I said in comment:12



---

archive/issue_events_042479.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42479"
}
```



---

archive/issue_events_042480.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42480"
}
```



---

archive/issue_comments_197894.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:19 kcrisman]:\n> It looks like there is still no proper deprecation for the \"old\" piecewise stuff.  Given that there seems to be a significant amount of stuff that that has (even if in an antiquated form that should be redone), perhaps a potential solution would be to do a deprecation of `Piecewise` that leads to the old version, but where `piecewise` is the new one? (Wait, I already said this in comment:11.)\n\nSeems that Volker already implemented it, just the doctests have to be adapted, and the `cmp` stuff from #16397:\n\n```\nsage: R.<x> = PolynomialRing(QQ, 'x')\nsage: f = Piecewise([[(0,1),1*x^0]])\n/home/ralf/sage/src/bin/sage-ipython:1: DeprecationWarning: use lower-case piecewise instead\nSee http://trac.sagemath.org/14801 for details.\n  #!/usr/bin/env python\n----------------------------------------------------------------------\nsage -t --long src/sage/functions/piecewise.py  # 3 doctests failed\nsage -t --long src/sage/functions/piecewise-old.py  # 203 doctests failed\n```\nI think I'll put some work into it to reduce doctest failures a bit.",
    "created_at": "2014-09-04T14:23:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197894",
    "user": "https://github.com/rwst"
}
```

<a id='comment:22'></a>Replying to [comment:19 kcrisman]:
> It looks like there is still no proper deprecation for the "old" piecewise stuff.  Given that there seems to be a significant amount of stuff that that has (even if in an antiquated form that should be redone), perhaps a potential solution would be to do a deprecation of `Piecewise` that leads to the old version, but where `piecewise` is the new one? (Wait, I already said this in comment:11.)

Seems that Volker already implemented it, just the doctests have to be adapted, and the `cmp` stuff from #16397:

```
sage: R.<x> = PolynomialRing(QQ, 'x')
sage: f = Piecewise([[(0,1),1*x^0]])
/home/ralf/sage/src/bin/sage-ipython:1: DeprecationWarning: use lower-case piecewise instead
See http://trac.sagemath.org/14801 for details.
  #!/usr/bin/env python
----------------------------------------------------------------------
sage -t --long src/sage/functions/piecewise.py  # 3 doctests failed
sage -t --long src/sage/functions/piecewise-old.py  # 203 doctests failed
```
I think I'll put some work into it to reduce doctest failures a bit.



---

archive/issue_comments_197895.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-09-04T15:39:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197895",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197896.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-05T08:08:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197896",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_197897.json:
```json
{
    "body": "<a id='comment:25'></a>Could you please explain why we need to keep all the old stuff? What functionality/syntax worked with the old `Piecewise` but not with the new `piecewise`?",
    "created_at": "2014-09-05T08:10:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197897",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:25'></a>Could you please explain why we need to keep all the old stuff? What functionality/syntax worked with the old `Piecewise` but not with the new `piecewise`?



---

archive/issue_comments_197898.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 jdemeyer]:\n> Could you please explain why we need to keep all the old stuff? What functionality/syntax worked with the old `Piecewise` but not with the new `piecewise`?\n\nNot sure if we need these, they are demonstrated in the failing `src/doc/en/constructions/calculus.rst` doctests:\n* `convolution()`\n* `critical_points()`\n* `riemann_sum_integral_approximation()`\n* `trapezoid()`\nThe rest of `piecewise-old.py` appears not to be used elsewhere, or doesn't contribute to failing doctests.",
    "created_at": "2014-09-05T08:28:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197898",
    "user": "https://github.com/rwst"
}
```

<a id='comment:26'></a>Replying to [comment:25 jdemeyer]:
> Could you please explain why we need to keep all the old stuff? What functionality/syntax worked with the old `Piecewise` but not with the new `piecewise`?

Not sure if we need these, they are demonstrated in the failing `src/doc/en/constructions/calculus.rst` doctests:
* `convolution()`
* `critical_points()`
* `riemann_sum_integral_approximation()`
* `trapezoid()`
The rest of `piecewise-old.py` appears not to be used elsewhere, or doesn't contribute to failing doctests.



---

archive/issue_comments_197899.json:
```json
{
    "body": "<a id='comment:27'></a>This is a bug:\n\n```\nsage: var('y')\ny\nsage: f(x) = piecewise([((0,2), y^3)])\nsage: f(1)\n1\n```\n\nThe result should be `y^3` as in:\n\n```\nsage: f(x) = y^3\nsage: f(1)\ny^3\n```",
    "created_at": "2014-09-05T08:30:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197899",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:27'></a>This is a bug:

```
sage: var('y')
y
sage: f(x) = piecewise([((0,2), y^3)])
sage: f(1)
1
```

The result should be `y^3` as in:

```
sage: f(x) = y^3
sage: f(1)
y^3
```



---

archive/issue_comments_197900.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [comment:27 jdemeyer]:\n> This is a bug:\n> \n> ```\n> sage: var('y')\n> y\n> sage: f(x) = piecewise([((0,2), y^3)])\n> sage: f(1)\n> 1\n> ```\n> \n> The result should be `y^3` as in:\n> \n> ```\n> sage: f(x) = y^3\n> sage: f(1)\n> y^3\n> ```\n\nReally?\n\n```\nsage: f(x) = piecewise([((0,2), y^3)],var=x)\nsage: f\nx |--> piecewise(x|-->y^3 on (0, 2); x)\nsage: f(1)\ny^3\n```",
    "created_at": "2014-09-05T09:03:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197900",
    "user": "https://github.com/rwst"
}
```

<a id='comment:28'></a>Replying to [comment:27 jdemeyer]:
> This is a bug:
> 
> ```
> sage: var('y')
> y
> sage: f(x) = piecewise([((0,2), y^3)])
> sage: f(1)
> 1
> ```
> 
> The result should be `y^3` as in:
> 
> ```
> sage: f(x) = y^3
> sage: f(1)
> y^3
> ```

Really?

```
sage: f(x) = piecewise([((0,2), y^3)],var=x)
sage: f
x |--> piecewise(x|-->y^3 on (0, 2); x)
sage: f(1)
y^3
```



---

archive/issue_comments_197901.json:
```json
{
    "body": "<a id='comment:29'></a>Replying to [comment:28 rws]:\n> {{{\n> sage: f(x) = piecewise([((0,2), y^3)],var=x)\n> }}}\n\nI don't like that one need to write `var=x`. I think the following should work somehow:\n\n```\nsage: f(x) = piecewise([((0,2), y^3)])\n```\nI understand the semantics are not easy, because you are using the variable twice: once for the condition on the domain (`0 < x < 2`) and once to evaluate the function (`y^3`). In a way, you want the result of `piecewise(...)` to be like `sin` but also like `sin(x)`.",
    "created_at": "2014-09-05T09:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197901",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:29'></a>Replying to [comment:28 rws]:
> {{{
> sage: f(x) = piecewise([((0,2), y^3)],var=x)
> }}}

I don't like that one need to write `var=x`. I think the following should work somehow:

```
sage: f(x) = piecewise([((0,2), y^3)])
```
I understand the semantics are not easy, because you are using the variable twice: once for the condition on the domain (`0 < x < 2`) and once to evaluate the function (`y^3`). In a way, you want the result of `piecewise(...)` to be like `sin` but also like `sin(x)`.



---

archive/issue_comments_197902.json:
```json
{
    "body": "<a id='comment:30'></a>Given that\n\n```\nf(x) = foo\n```\nis preprocessor syntactic sugar for\n\n```\nf = foo.function(x)\n```\nthe simplest solution might be to override the `.function()` method to also change the variable name of the piecewise function.",
    "created_at": "2014-09-05T09:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197902",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:30'></a>Given that

```
f(x) = foo
```
is preprocessor syntactic sugar for

```
f = foo.function(x)
```
the simplest solution might be to override the `.function()` method to also change the variable name of the piecewise function.



---

archive/issue_comments_197903.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 jdemeyer]:\n> Given that\n> \n> ```\n> f(x) = foo\n> ```\n> is preprocessor syntactic sugar for\n> \n> ```\n> f = foo.function(x)\n> ```\n> the simplest solution might be to override the `.function()` method to also change the variable name of the piecewise function.\n\nAs far as I understand it, the only time `symbolic_expr.function(..)` recurses into the expression is when converting into the `CallableSymbolicExpressionRing` which calls `SymbolicRing._element_constructor_()`. I don't think I can easily hand `var` down to that machinery, recognize when a `piecewise` get converted, and call a member func then.\n\nIOW, the `piecewise` on the r.h.s. of `f(x) = piecewise([((0,2), y^3)])` may be buried within an expression, and I find it not the \"simplest solution\" to handle its `var` via `.function()`. But that's from a first look at parts of the code I have never worked with, so I would appreciate any hint.",
    "created_at": "2014-10-14T15:36:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197903",
    "user": "https://github.com/rwst"
}
```

<a id='comment:31'></a>Replying to [comment:30 jdemeyer]:
> Given that
> 
> ```
> f(x) = foo
> ```
> is preprocessor syntactic sugar for
> 
> ```
> f = foo.function(x)
> ```
> the simplest solution might be to override the `.function()` method to also change the variable name of the piecewise function.

As far as I understand it, the only time `symbolic_expr.function(..)` recurses into the expression is when converting into the `CallableSymbolicExpressionRing` which calls `SymbolicRing._element_constructor_()`. I don't think I can easily hand `var` down to that machinery, recognize when a `piecewise` get converted, and call a member func then.

IOW, the `piecewise` on the r.h.s. of `f(x) = piecewise([((0,2), y^3)])` may be buried within an expression, and I find it not the "simplest solution" to handle its `var` via `.function()`. But that's from a first look at parts of the code I have never worked with, so I would appreciate any hint.



---

archive/issue_comments_197904.json:
```json
{
    "body": "<a id='comment:32'></a>Now that we have #17759 (for review) the tree can be walked conveniently and the variable set---or so I thought, but the `piecewise` object appears stateless: any call will reinitialize it...",
    "created_at": "2015-02-10T16:25:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197904",
    "user": "https://github.com/rwst"
}
```

<a id='comment:32'></a>Now that we have #17759 (for review) the tree can be walked conveniently and the variable set---or so I thought, but the `piecewise` object appears stateless: any call will reinitialize it...



---

archive/issue_comments_197905.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-11T14:01:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197905",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197906.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:27 jdemeyer]:\n> The result should be `y^3` as in:\n> \n> ```\n> sage: f(x) = y^3\n> sage: f(1)\n> y^3\n> ```\n\nOK, this works now with **one** variable, dependent on #17759 (please review). I'm of the opinion this should work too:\n\n```\nsage: f(x,y) = piecewise([((0,2), y^3)])\nsage: f(1,1)\nTypeError: __call__() takes at most 5 arguments (6 given)\n```\nbut I have no idea atm what changes are needed for this. `piecewise([((0,2), y^3)], var=(x,y))` is certainly not supported now.",
    "created_at": "2015-02-11T14:07:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197906",
    "user": "https://github.com/rwst"
}
```

<a id='comment:34'></a>Replying to [comment:27 jdemeyer]:
> The result should be `y^3` as in:
> 
> ```
> sage: f(x) = y^3
> sage: f(1)
> y^3
> ```

OK, this works now with **one** variable, dependent on #17759 (please review). I'm of the opinion this should work too:

```
sage: f(x,y) = piecewise([((0,2), y^3)])
sage: f(1,1)
TypeError: __call__() takes at most 5 arguments (6 given)
```
but I have no idea atm what changes are needed for this. `piecewise([((0,2), y^3)], var=(x,y))` is certainly not supported now.



---

archive/issue_comments_197907.json:
```json
{
    "body": "<a id='comment:35'></a>Maybe the class needs redesign to support this format: `piecewise([([(x,0,2),(y,0,2)], x*y^3)])` but I'd rather make this an enhancement.",
    "created_at": "2015-02-11T14:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197907",
    "user": "https://github.com/rwst"
}
```

<a id='comment:35'></a>Maybe the class needs redesign to support this format: `piecewise([([(x,0,2),(y,0,2)], x*y^3)])` but I'd rather make this an enhancement.



---

archive/issue_comments_197908.json:
```json
{
    "body": "<a id='comment:36'></a>Anyway, if no rectangular 2D-pieces are supported in this ticket then also no 2D-strips are supported, i.e., this:\n\n```\nsage: f(x,y) = piecewise([((0,2), y^3)], var=x)\nsage: f(1,1)\nTypeError: __call__() takes at most 5 arguments (6 given)\n```\nmaybe should raise an error already in the first command. Having specified what this ticket can do there remain these fails:\n\n```\nsage -t src/sage/functions/piecewise.py  # fast_callable, .extension()\nsage -t src/doc/en/constructions/plotting.rst  # TypeError\nsage -t src/doc/en/constructions/calculus.rst  # missing .critical_points(), .convolution(), trapezoid(), riemann_sum_integral_approximation(), .integral(), laplace(), fourier_series_cosine_coefficient(), TypeError\nsage -t src/sage/calculus/wester.py  # missing .integral()\n```\nEDIT: added problem issues",
    "created_at": "2015-02-14T14:12:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197908",
    "user": "https://github.com/rwst"
}
```

<a id='comment:36'></a>Anyway, if no rectangular 2D-pieces are supported in this ticket then also no 2D-strips are supported, i.e., this:

```
sage: f(x,y) = piecewise([((0,2), y^3)], var=x)
sage: f(1,1)
TypeError: __call__() takes at most 5 arguments (6 given)
```
maybe should raise an error already in the first command. Having specified what this ticket can do there remain these fails:

```
sage -t src/sage/functions/piecewise.py  # fast_callable, .extension()
sage -t src/doc/en/constructions/plotting.rst  # TypeError
sage -t src/doc/en/constructions/calculus.rst  # missing .critical_points(), .convolution(), trapezoid(), riemann_sum_integral_approximation(), .integral(), laplace(), fourier_series_cosine_coefficient(), TypeError
sage -t src/sage/calculus/wester.py  # missing .integral()
```
EDIT: added problem issues



---

archive/issue_comments_197909.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2015-02-19T17:14:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197909",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_197910.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-21T14:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197910",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197911.json:
```json
{
    "body": "<a id='comment:40'></a>This leaves the ordering stuff, the plot warnings, and some Fourier code (in `calculus.rst`).",
    "created_at": "2015-02-21T14:47:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197911",
    "user": "https://github.com/rwst"
}
```

<a id='comment:40'></a>This leaves the ordering stuff, the plot warnings, and some Fourier code (in `calculus.rst`).



---

archive/issue_events_042481.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-02-21T14:48:29Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42481"
}
```



---

archive/issue_events_042482.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2015-02-21T14:48:29Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42482"
}
```



---

archive/issue_comments_197912.json:
```json
{
    "body": "Changing assignee from @burcin to @rwst.",
    "created_at": "2015-02-21T14:48:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197912",
    "user": "https://github.com/rwst"
}
```

Changing assignee from @burcin to @rwst.



---

archive/issue_comments_197913.json:
```json
{
    "body": "<a id='comment:44'></a>The remaining fails happen because:\n* cannot use pi/2 as interval endpoint because of symbolic `cmp` bug (#16397)\n\n```\nsage: cmp(pi/2,SR(0))\n-1\nsage: cmp(pi/2,0)\n1\n```\n* unsuppressed doctest warnings (#17815)\n* missing `piecewise.laplace`\n* missing `piecewise.fourier_series_sine_coefficient`\n* missing `piecewise.fourier_series_cosine_coefficient`\n* missing `piecewise.fourier_series_partial_sum`\nThe last four are due to a single example in `doc/en/constructions/calculus.rst`.\n\n---\nNew commits:",
    "created_at": "2015-03-22T09:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197913",
    "user": "https://github.com/rwst"
}
```

<a id='comment:44'></a>The remaining fails happen because:
* cannot use pi/2 as interval endpoint because of symbolic `cmp` bug (#16397)

```
sage: cmp(pi/2,SR(0))
-1
sage: cmp(pi/2,0)
1
```
* unsuppressed doctest warnings (#17815)
* missing `piecewise.laplace`
* missing `piecewise.fourier_series_sine_coefficient`
* missing `piecewise.fourier_series_cosine_coefficient`
* missing `piecewise.fourier_series_partial_sum`
The last four are due to a single example in `doc/en/constructions/calculus.rst`.

---
New commits:



---

archive/issue_comments_197914.json:
```json
{
    "body": "<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-03-22T14:21:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197914",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197915.json:
```json
{
    "body": "<a id='comment:46'></a>New commits:",
    "created_at": "2015-03-22T14:22:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197915",
    "user": "https://github.com/rwst"
}
```

<a id='comment:46'></a>New commits:



---

archive/issue_comments_197916.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n-Rewrite piecewise functions as symbolic functions\n+Rewrite piecewise functions as symbolic functions.\n \n-Assignee: @burcin\n+For a (late) discussion about interface issues see https://groups.google.com/forum/?hl=en#!topic/sage-devel/dgwUMsdiHfM\n \n Author: Volker Braun\n \n``````\n",
    "created_at": "2016-03-05T06:30:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197916",
    "user": "https://github.com/rwst"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
-Rewrite piecewise functions as symbolic functions
+Rewrite piecewise functions as symbolic functions.
 
-Assignee: @burcin
+For a (late) discussion about interface issues see https://groups.google.com/forum/?hl=en#!topic/sage-devel/dgwUMsdiHfM
 
 Author: Volker Braun
 
``````




---

archive/issue_comments_197917.json:
```json
{
    "body": "<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:",
    "created_at": "2016-03-19T09:30:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197917",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>Branch pushed to git repo; I updated commit sha1. Last 10 new commits:



---

archive/issue_comments_197918.json:
```json
{
    "body": "<a id='comment:51'></a>Indeed, as the discussion in https://groups.google.com/forum/?hl=en#!topic/sage-devel/dgwUMsdiHfM foresaw, lambdas will be a problem with this, as they cannot be coerced to SR. \n\n```\nsage: f1 = lambda x: -1; f2 = lambda x: 2                   \nsage: piecewise([((0,pi/2),f1), ((pi/2,pi),f2)])\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n```\nThere is one doctest in src/doc/en/constructions/calculus.rst that requires it.\n\nBut it doesn't even work with `NewSymbolicFunction`:\n\n```\nsage: function('newf2')(x)                      \nnewf2(x)\nsage: piecewise([((0,pi/2),x), ((pi/2,pi),f2)])\n```\nfor which there seems a solution in #17701.",
    "created_at": "2016-03-19T15:47:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197918",
    "user": "https://github.com/rwst"
}
```

<a id='comment:51'></a>Indeed, as the discussion in https://groups.google.com/forum/?hl=en#!topic/sage-devel/dgwUMsdiHfM foresaw, lambdas will be a problem with this, as they cannot be coerced to SR. 

```
sage: f1 = lambda x: -1; f2 = lambda x: 2                   
sage: piecewise([((0,pi/2),f1), ((pi/2,pi),f2)])
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
```
There is one doctest in src/doc/en/constructions/calculus.rst that requires it.

But it doesn't even work with `NewSymbolicFunction`:

```
sage: function('newf2')(x)                      
newf2(x)
sage: piecewise([((0,pi/2),x), ((pi/2,pi),f2)])
```
for which there seems a solution in #17701.



---

archive/issue_comments_197919.json:
```json
{
    "body": "<a id='comment:52'></a>Any ideas about how to resolve this?",
    "created_at": "2016-03-24T08:49:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197919",
    "user": "https://github.com/rwst"
}
```

<a id='comment:52'></a>Any ideas about how to resolve this?



---

archive/issue_comments_197920.json:
```json
{
    "body": "<a id='comment:53'></a>As #16397 is accepted let's summarize the current situation. There are two doctests failing with just a different number of graphics objects, easily fixed, which leaves five fails in `doc/en/constructions/calculus.rst` due to:\n* missing `piecewise.laplace`\n* missing `piecewise.fourier_series_sine_coefficient`\n* missing `piecewise.fourier_series_cosine_coefficient`\n* missing `piecewise.fourier_series_partial_sum`\n* lambdas not coercible into SR (line 381)\n\nAs to the last item I think the doctest could be changed to no longer use a lambda. Users depending on it could use `piecewise_old`. We could make this ticket dependent on #17701 to at least have anonymous symbolic functions working as in `function('newf2')(x)`.\n\nIf people insist on lambdas and def'ed Python functions as arguments to `piecewise` it might be an idea to create a temporary anonymous function (check for `types.FunctionType`) but this depends on #17701 if the idea can be made to work.",
    "created_at": "2016-04-16T07:17:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197920",
    "user": "https://github.com/rwst"
}
```

<a id='comment:53'></a>As #16397 is accepted let's summarize the current situation. There are two doctests failing with just a different number of graphics objects, easily fixed, which leaves five fails in `doc/en/constructions/calculus.rst` due to:
* missing `piecewise.laplace`
* missing `piecewise.fourier_series_sine_coefficient`
* missing `piecewise.fourier_series_cosine_coefficient`
* missing `piecewise.fourier_series_partial_sum`
* lambdas not coercible into SR (line 381)

As to the last item I think the doctest could be changed to no longer use a lambda. Users depending on it could use `piecewise_old`. We could make this ticket dependent on #17701 to at least have anonymous symbolic functions working as in `function('newf2')(x)`.

If people insist on lambdas and def'ed Python functions as arguments to `piecewise` it might be an idea to create a temporary anonymous function (check for `types.FunctionType`) but this depends on #17701 if the idea can be made to work.



---

archive/issue_comments_197921.json:
```json
{
    "body": "<a id='comment:54'></a>The Laplace transform code as well depends on function arguments being coercible/convertible to SR: `result =  sum([(SR(f)*exp(-s*x)).integral(x,a,b) for (a,b),f in self.list()])`. I don't think there is an easy solution and I'm wondering why the new `piecewise` should come up with something that wasn't resolved with other parts of Sage, like `diff`, `desolve`, `integral` etc.",
    "created_at": "2016-04-16T07:38:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197921",
    "user": "https://github.com/rwst"
}
```

<a id='comment:54'></a>The Laplace transform code as well depends on function arguments being coercible/convertible to SR: `result =  sum([(SR(f)*exp(-s*x)).integral(x,a,b) for (a,b),f in self.list()])`. I don't think there is an easy solution and I'm wondering why the new `piecewise` should come up with something that wasn't resolved with other parts of Sage, like `diff`, `desolve`, `integral` etc.



---

archive/issue_comments_197922.json:
```json
{
    "body": "<a id='comment:55'></a>The solution is to change the doctest to:\n\n```\n    sage: f1 = lambda x: -1\n    sage: f2 = lambda x: 2\n    sage: f = piecewise([((0,pi/2),f1(x)), ((pi/2,pi),f2(x))])\n```\nOr, if function objects are used to apply the call inside `piecewise`.",
    "created_at": "2016-04-16T07:50:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197922",
    "user": "https://github.com/rwst"
}
```

<a id='comment:55'></a>The solution is to change the doctest to:

```
    sage: f1 = lambda x: -1
    sage: f2 = lambda x: 2
    sage: f = piecewise([((0,pi/2),f1(x)), ((pi/2,pi),f2(x))])
```
Or, if function objects are used to apply the call inside `piecewise`.



---

archive/issue_comments_197923.json:
```json
{
    "body": "<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-16T14:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197923",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:56'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197924.json:
```json
{
    "body": "<a id='comment:57'></a>That should be it.",
    "created_at": "2016-04-16T14:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197924",
    "user": "https://github.com/rwst"
}
```

<a id='comment:57'></a>That should be it.



---

archive/issue_events_042483.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-04-16T14:36:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-6.6",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42483"
}
```



---

archive/issue_events_042484.json:
```json
{
    "actor": "https://github.com/rwst",
    "created_at": "2016-04-16T14:36:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "milestone": "sage-7.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42484"
}
```



---

archive/issue_comments_197925.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-16T14:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197925",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_197926.json:
```json
{
    "body": "<a id='comment:58'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-22T06:28:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197926",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:58'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197927.json:
```json
{
    "body": "<a id='comment:59'></a>See also #8603 regarding the most recent additions - thanks for doing them.",
    "created_at": "2016-04-22T14:37:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197927",
    "user": "https://github.com/kcrisman"
}
```

<a id='comment:59'></a>See also #8603 regarding the most recent additions - thanks for doing them.



---

archive/issue_comments_197928.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-22T15:16:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197928",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_197929.json:
```json
{
    "body": "<a id='comment:61'></a>Thanks for working on it... I'm of course happy with your changes.",
    "created_at": "2016-04-22T15:18:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197929",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:61'></a>Thanks for working on it... I'm of course happy with your changes.



---

archive/issue_comments_197930.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-22T15:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197930",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_197931.json:
```json
{
    "body": "<a id='comment:62'></a>And I'm so with your part of this.",
    "created_at": "2016-04-22T15:23:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197931",
    "user": "https://github.com/rwst"
}
```

<a id='comment:62'></a>And I'm so with your part of this.



---

archive/issue_comments_197932.json:
```json
{
    "body": "<a id='comment:63'></a>Ralf and Volker have done such great work on this and I really am very much looking forward to this being put into Sage. Also, I don't see any examples which used to work but don't work with the new version you've made.\n\nA comment on how I tested this (since I don't know git), I downloaded your piecewise.py file from git. Added it to a new version of [SageMath](SageMath) (since \"sage -clone\" no longer works) and ran \"sage -b\". Then I started sage and just ran then examples in the docstring. I tweeked several just to see how minor changes affected things. They all went perfectly.",
    "created_at": "2016-04-22T20:10:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197932",
    "user": "https://github.com/wdjoyner"
}
```

<a id='comment:63'></a>Ralf and Volker have done such great work on this and I really am very much looking forward to this being put into Sage. Also, I don't see any examples which used to work but don't work with the new version you've made.

A comment on how I tested this (since I don't know git), I downloaded your piecewise.py file from git. Added it to a new version of [SageMath](SageMath) (since "sage -clone" no longer works) and ran "sage -b". Then I started sage and just ran then examples in the docstring. I tweeked several just to see how minor changes affected things. They all went perfectly.



---

archive/issue_events_042485.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2016-04-23T08:45:39Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14801#event-42485"
}
```



---

archive/issue_comments_197933.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-23T08:45:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14801",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14801#issuecomment-197933",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
