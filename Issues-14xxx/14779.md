# Issue 14779: LibGAP exits when out of memory and takes Sage with it

archive/issues_014575.json:
```json
{
    "assignees": [
        "https://github.com/wdjoyner"
    ],
    "body": "The original example is no longer valid as of Sage 8.2-beta6. The following works nicely and the reason for why it was not working for Sage 5 and 6 was apparently never found.\n\nThis is correct and expected behaviour:\n\n```\nsage: G=FreeGroup(2)\nsage: G.inject_variables()                                                                                                                          \nsage: H=G.quotient([x0*x1^2])                                                                                                                       \nsage: H.as_permutation_group()\nDefining x0, x1\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-2-2fcc9750489e> in <module>()\n      2 G.inject_variables()\n      3 H=G.quotient([x0*x1**Integer(2)])\n----> 4 H.as_permutation_group()\n\n/home/vit/bin/sage-dev/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)\n   1008                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()\n   1009             except ValueError:\n-> 1010                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')\n   1011         from sage.combinat.permutation import Permutation\n   1012         from sage.groups.perm_gps.permgroup import PermutationGroup\n\nValueError: Coset enumeration exceeded limit, is the group finite?\n```\n\nBut the problem persists in some form as the following (real life) example shows.\n\n```\nsage: k = 3\nsage: p = 18\nsage: d = 2*p/(p-6)\nsage: l = 2*p*k/(p*k-2*k-2*p)\nsage: F.<J,P,R1,R2> = FreeGroup()\nsage: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]\nsage: k = G.rewriting_system()\nsage: x = k.reduce(P^8)\nsage: y = k.reduce(G([-4,2,3]))\nsage: t = k.reduce(x*y)\nsage: t == G.one()\ngap: cannot extend the workspace any more!\nvit@HP-EliteBook-8460p:~/bin/sage-dev$ \n```\n\nSage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was GAP who caused the crash.)\n\n\nDepends on #22626\n\nKeywords: **gap libgap**\n\nComponent: **group theory**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14779_\n\n",
    "created_at": "2013-06-19T21:03:46Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20group%20theory",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/pending"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "LibGAP exits when out of memory and takes Sage with it",
    "type": "issue",
    "updated_at": "2022-07-02T09:50:17Z",
    "url": "https://github.com/sagemath/sage/issues/14779",
    "user": "https://github.com/vbraun"
}
```
The original example is no longer valid as of Sage 8.2-beta6. The following works nicely and the reason for why it was not working for Sage 5 and 6 was apparently never found.

This is correct and expected behaviour:

```
sage: G=FreeGroup(2)
sage: G.inject_variables()                                                                                                                          
sage: H=G.quotient([x0*x1^2])                                                                                                                       
sage: H.as_permutation_group()
Defining x0, x1
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-2-2fcc9750489e> in <module>()
      2 G.inject_variables()
      3 H=G.quotient([x0*x1**Integer(2)])
----> 4 H.as_permutation_group()

/home/vit/bin/sage-dev/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)
   1008                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()
   1009             except ValueError:
-> 1010                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')
   1011         from sage.combinat.permutation import Permutation
   1012         from sage.groups.perm_gps.permgroup import PermutationGroup

ValueError: Coset enumeration exceeded limit, is the group finite?
```

But the problem persists in some form as the following (real life) example shows.

```
sage: k = 3
sage: p = 18
sage: d = 2*p/(p-6)
sage: l = 2*p*k/(p*k-2*k-2*p)
sage: F.<J,P,R1,R2> = FreeGroup()
sage: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]
sage: k = G.rewriting_system()
sage: x = k.reduce(P^8)
sage: y = k.reduce(G([-4,2,3]))
sage: t = k.reduce(x*y)
sage: t == G.one()
gap: cannot extend the workspace any more!
vit@HP-EliteBook-8460p:~/bin/sage-dev$ 
```

Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was GAP who caused the crash.)


Depends on #22626

Keywords: **gap libgap**

Component: **group theory**

_Issue created by migration from https://trac.sagemath.org/ticket/14779_





---

archive/issue_events_207965.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-06-19T21:03:46Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207965"
}
```



---

archive/issue_events_207966.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-06-19T21:03:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20group%20theory",
    "label_color": "0000ff",
    "label_name": "c: group theory",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207966"
}
```



---

archive/issue_events_207967.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-06-19T21:03:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207967"
}
```



---

archive/issue_events_207968.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-06-19T21:03:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207968"
}
```



---

archive/issue_events_207969.json:
```json
{
    "actor": "https://github.com/wdjoyner",
    "created_at": "2013-06-19T21:03:46Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "subject": "https://github.com/vbraun",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207969"
}
```



---

archive/issue_comments_180390.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nActually this is in Sage-5.11.beta1 which still has libgap-4.5.7. Something in Sage changed, not libgap.",
    "created_at": "2013-06-19T22:30:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180390",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:1" align="right">comment:1</div>

Actually this is in Sage-5.11.beta1 which still has libgap-4.5.7. Something in Sage changed, not libgap.



---

archive/issue_events_207970.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207970"
}
```



---

archive/issue_events_207971.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207971"
}
```



---

archive/issue_events_207972.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207972"
}
```



---

archive/issue_events_207973.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207973"
}
```



---

archive/issue_events_207974.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207974"
}
```



---

archive/issue_events_207975.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207975"
}
```



---

archive/issue_events_207976.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207976"
}
```



---

archive/issue_events_207977.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207977"
}
```



---

archive/issue_comments_180391.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nFor Sage 8.2-beta6 I get nice error exception. \n\n\n```\n---------------------------------------------------------------------------\nValueError                                Traceback (most recent call last)\n<ipython-input-2-599244da5541> in <module>()\n      2 G.inject_variables()\n      3 H=G.quotient([x0*x1**Integer(2)])\n----> 4 H.as_permutation_group()\n\n/home/vit/bin/sage-dev/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)\n   1008                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()\n   1009             except ValueError:\n-> 1010                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')\n   1011         from sage.combinat.permutation import Permutation\n   1012         from sage.groups.perm_gps.permgroup import PermutationGroup\n\nValueError: Coset enumeration exceeded limit, is the group finite?\n\n```\n\n\nBut checking for equality in a finitely presented group can still lead to the error described here. \n\n\n```\nk = 3\np = 18\nd = 2*p/(p-6)\nl = 2*p*k/(p*k-2*k-2*p)\nF.<J,P,R1,R2>=FreeGroup()\nG = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]\nk = G.rewriting_system()\nx = k.reduce(P^8)\ny = k.reduce(G([-4,2,3]))\nt = k.reduce(x*y)\nt == G.one()\n```",
    "created_at": "2018-02-21T15:53:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180391",
    "user": "https://github.com/vit-tucek"
}
```

<div id="comment:6" align="right">comment:6</div>

For Sage 8.2-beta6 I get nice error exception. 


```
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
<ipython-input-2-599244da5541> in <module>()
      2 G.inject_variables()
      3 H=G.quotient([x0*x1**Integer(2)])
----> 4 H.as_permutation_group()

/home/vit/bin/sage-dev/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)
   1008                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()
   1009             except ValueError:
-> 1010                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')
   1011         from sage.combinat.permutation import Permutation
   1012         from sage.groups.perm_gps.permgroup import PermutationGroup

ValueError: Coset enumeration exceeded limit, is the group finite?

```


But checking for equality in a finitely presented group can still lead to the error described here. 


```
k = 3
p = 18
d = 2*p/(p-6)
l = 2*p*k/(p*k-2*k-2*p)
F.<J,P,R1,R2>=FreeGroup()
G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]
k = G.rewriting_system()
x = k.reduce(P^8)
y = k.reduce(G([-4,2,3]))
t = k.reduce(x*y)
t == G.one()
```



---

archive/issue_comments_180392.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nChecking for equality is undesideable, GAP does try coset enumeration. I suppose you are saying Sage should recover gracefully from this. It is hard as GAP manages memory itself, and crashes.",
    "created_at": "2018-02-21T17:33:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180392",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">comment:7</div>

Checking for equality is undesideable, GAP does try coset enumeration. I suppose you are saying Sage should recover gracefully from this. It is hard as GAP manages memory itself, and crashes.



---

archive/issue_comments_180393.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nYes, that's what I am saying. Whatever GAP does it shouldn't take Sage with it.",
    "created_at": "2018-02-21T17:39:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180393",
    "user": "https://github.com/vit-tucek"
}
```

<div id="comment:8" align="right">comment:8</div>

Yes, that's what I am saying. Whatever GAP does it shouldn't take Sage with it.



---

archive/issue_comments_180394.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nReplying to [@vit-tucek](#comment:6):\n> the error described here.\n\nDetails please. Can you update the ticket description?",
    "created_at": "2018-02-21T19:05:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180394",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:9" align="right">comment:9</div>

Replying to [@vit-tucek](#comment:6):
> the error described here.

Details please. Can you update the ticket description?



---

archive/issue_events_207978.json:
```json
{
    "actor": "https://github.com/vit-tucek",
    "created_at": "2018-02-21T21:21:21Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "title_is": "LibGAP exits when out of memory and takes Sage with it",
    "title_was": "LibGAP exits when out of memory",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207978"
}
```



---

archive/issue_comments_180395.json:
```json
{
    "body": "Changed keywords from none to **gap**",
    "created_at": "2018-02-21T21:21:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180395",
    "user": "https://github.com/vit-tucek"
}
```

Changed keywords from none to **gap**



---

archive/issue_events_207979.json:
```json
{
    "actor": "https://github.com/vit-tucek",
    "created_at": "2018-02-21T21:21:21Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207979"
}
```



---

archive/issue_events_207980.json:
```json
{
    "actor": "https://github.com/vit-tucek",
    "created_at": "2018-02-21T21:21:21Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207980"
}
```



---

archive/issue_comments_180396.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,28 +1,51 @@\n+The original example is no longer valid as of Sage 8.2-beta6. The following works nicely and the reason for why it was not working for Sage 5 and 6 was apparently never found.\n+\n+This is correct and expected behaviour:\n \n ```\n-sage: G=FreeGroup(2)\n-sage: G.inject_variables()                                                                                                                          \n+sage: sage: G=FreeGroup(2)\n+....: sage: G.inject_variables()                                                                                                                          \n+....: sage: H=G.quotient([x0*x1^2])                                                                                                                       \n+....: sage: H.as_permutation_group()                                                                                                                      \n+....: \n+\n Defining x0, x1\n-sage: H=G.quotient([x0*x1^2])                                                                                                                       \n-sage: H.as_permutation_group()                                                                                                                      \n-gap: cannot extend the workspace any more!\n-...back to shell...\n-```\n-Older versions raised an error that we caught:\n-\n-```\n-sage: sage: H.as_permutation_group()                                                                                                                      \n ---------------------------------------------------------------------------\n ValueError                                Traceback (most recent call last)\n-<ipython-input-5-8ec056aa16c3> in <module>()\n-----> 1 H.as_permutation_group()\n+<ipython-input-2-2fcc9750489e> in <module>()\n+      2 G.inject_variables()\n+      3 H=G.quotient([x0*x1**Integer(2)])\n+----> 4 H.as_permutation_group()\n \n-/home/vbraun/opt/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)\n-    667                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()\n-    668             except ValueError:\n---> 669                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')\n-    670         from sage.combinat.permutation import Permutation\n-    671         from sage.groups.perm_gps.permgroup import PermutationGroup\n+/home/vit/bin/sage-dev/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)\n+   1008                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()\n+   1009             except ValueError:\n+-> 1010                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')\n+   1011         from sage.combinat.permutation import Permutation\n+   1012         from sage.groups.perm_gps.permgroup import PermutationGroup\n \n ValueError: Coset enumeration exceeded limit, is the group finite?\n ```\n+\n+But the problem persists in some form as the following (real life) example shows.\n+\n+```\n+sage: k = 3\n+....: p = 18\n+....: d = 2*p/(p-6)\n+....: l = 2*p*k/(p*k-2*k-2*p)\n+....: F.<J,P,R1,R2>=FreeGroup()\n+....: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]\n+....: k = G.rewriting_system()\n+....: x = k.reduce(P^8)\n+....: y = k.reduce(G([-4,2,3]))\n+....: t = k.reduce(x*y)\n+....: t == G.one()\n+....: \n+gap: cannot extend the workspace any more!\n+vit@HP-EliteBook-8460p:~/bin/sage-dev$ \n+```\n+\n+\n+Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was gap who caused the crash.)\n+\n``````\n",
    "created_at": "2018-02-21T21:21:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180396",
    "user": "https://github.com/vit-tucek"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,28 +1,51 @@
+The original example is no longer valid as of Sage 8.2-beta6. The following works nicely and the reason for why it was not working for Sage 5 and 6 was apparently never found.
+
+This is correct and expected behaviour:
 
 ```
-sage: G=FreeGroup(2)
-sage: G.inject_variables()                                                                                                                          
+sage: sage: G=FreeGroup(2)
+....: sage: G.inject_variables()                                                                                                                          
+....: sage: H=G.quotient([x0*x1^2])                                                                                                                       
+....: sage: H.as_permutation_group()                                                                                                                      
+....: 
+
 Defining x0, x1
-sage: H=G.quotient([x0*x1^2])                                                                                                                       
-sage: H.as_permutation_group()                                                                                                                      
-gap: cannot extend the workspace any more!
-...back to shell...
-```
-Older versions raised an error that we caught:
-
-```
-sage: sage: H.as_permutation_group()                                                                                                                      
 ---------------------------------------------------------------------------
 ValueError                                Traceback (most recent call last)
-<ipython-input-5-8ec056aa16c3> in <module>()
-----> 1 H.as_permutation_group()
+<ipython-input-2-2fcc9750489e> in <module>()
+      2 G.inject_variables()
+      3 H=G.quotient([x0*x1**Integer(2)])
+----> 4 H.as_permutation_group()
 
-/home/vbraun/opt/sage-5.10.rc2/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)
-    667                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()
-    668             except ValueError:
---> 669                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')
-    670         from sage.combinat.permutation import Permutation
-    671         from sage.groups.perm_gps.permgroup import PermutationGroup
+/home/vit/bin/sage-dev/local/lib/python2.7/site-packages/sage/groups/finitely_presented.pyc in as_permutation_group(self, limit)
+   1008                 coset_table = self.gap().CosetTable(trivial_subgroup).sage()
+   1009             except ValueError:
+-> 1010                 raise ValueError('Coset enumeration exceeded limit, is the group finite?')
+   1011         from sage.combinat.permutation import Permutation
+   1012         from sage.groups.perm_gps.permgroup import PermutationGroup
 
 ValueError: Coset enumeration exceeded limit, is the group finite?
 ```
+
+But the problem persists in some form as the following (real life) example shows.
+
+```
+sage: k = 3
+....: p = 18
+....: d = 2*p/(p-6)
+....: l = 2*p*k/(p*k-2*k-2*p)
+....: F.<J,P,R1,R2>=FreeGroup()
+....: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]
+....: k = G.rewriting_system()
+....: x = k.reduce(P^8)
+....: y = k.reduce(G([-4,2,3]))
+....: t = k.reduce(x*y)
+....: t == G.one()
+....: 
+gap: cannot extend the workspace any more!
+vit@HP-EliteBook-8460p:~/bin/sage-dev$ 
+```
+
+
+Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was gap who caused the crash.)
+
``````




---

archive/issue_comments_180397.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThis ticket is something that should be fixed after the GAP + libGAP convergence. Once GAP ==  libGAP has a proper error handler, this should be easy to fix.",
    "created_at": "2018-02-21T22:47:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180397",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:11" align="right">comment:11</div>

This ticket is something that should be fixed after the GAP + libGAP convergence. Once GAP ==  libGAP has a proper error handler, this should be easy to fix.



---

archive/issue_comments_180398.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nReplying to [@jdemeyer](#comment:11):\n> This ticket is something that should be fixed after the GAP + libGAP convergence.\n> Once GAP ==  libGAP has a proper error handler, this should be easy to fix.\n\nMarking #22626 as a dependency to reflect that.",
    "created_at": "2018-02-28T19:11:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180398",
    "user": "https://github.com/slel"
}
```

<div id="comment:12" align="right">comment:12</div>

Replying to [@jdemeyer](#comment:11):
> This ticket is something that should be fixed after the GAP + libGAP convergence.
> Once GAP ==  libGAP has a proper error handler, this should be easy to fix.

Marking #22626 as a dependency to reflect that.



---

archive/issue_comments_180399.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,12 +3,10 @@\n This is correct and expected behaviour:\n \n ```\n-sage: sage: G=FreeGroup(2)\n-....: sage: G.inject_variables()                                                                                                                          \n-....: sage: H=G.quotient([x0*x1^2])                                                                                                                       \n-....: sage: H.as_permutation_group()                                                                                                                      \n-....: \n-\n+sage: G=FreeGroup(2)\n+sage: G.inject_variables()                                                                                                                          \n+sage: H=G.quotient([x0*x1^2])                                                                                                                       \n+sage: H.as_permutation_group()\n Defining x0, x1\n ---------------------------------------------------------------------------\n ValueError                                Traceback (most recent call last)\n@@ -31,21 +29,19 @@\n \n ```\n sage: k = 3\n-....: p = 18\n-....: d = 2*p/(p-6)\n-....: l = 2*p*k/(p*k-2*k-2*p)\n-....: F.<J,P,R1,R2>=FreeGroup()\n-....: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]\n-....: k = G.rewriting_system()\n-....: x = k.reduce(P^8)\n-....: y = k.reduce(G([-4,2,3]))\n-....: t = k.reduce(x*y)\n-....: t == G.one()\n-....: \n+sage: p = 18\n+sage: d = 2*p/(p-6)\n+sage: l = 2*p*k/(p*k-2*k-2*p)\n+sage: F.<J,P,R1,R2> = FreeGroup()\n+sage: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]\n+sage: k = G.rewriting_system()\n+sage: x = k.reduce(P^8)\n+sage: y = k.reduce(G([-4,2,3]))\n+sage: t = k.reduce(x*y)\n+sage: t == G.one()\n gap: cannot extend the workspace any more!\n vit@HP-EliteBook-8460p:~/bin/sage-dev$ \n ```\n \n+Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was GAP who caused the crash.)\n \n-Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was gap who caused the crash.)\n-\n``````\n",
    "created_at": "2018-02-28T19:11:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180399",
    "user": "https://github.com/slel"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,12 +3,10 @@
 This is correct and expected behaviour:
 
 ```
-sage: sage: G=FreeGroup(2)
-....: sage: G.inject_variables()                                                                                                                          
-....: sage: H=G.quotient([x0*x1^2])                                                                                                                       
-....: sage: H.as_permutation_group()                                                                                                                      
-....: 
-
+sage: G=FreeGroup(2)
+sage: G.inject_variables()                                                                                                                          
+sage: H=G.quotient([x0*x1^2])                                                                                                                       
+sage: H.as_permutation_group()
 Defining x0, x1
 ---------------------------------------------------------------------------
 ValueError                                Traceback (most recent call last)
@@ -31,21 +29,19 @@
 
 ```
 sage: k = 3
-....: p = 18
-....: d = 2*p/(p-6)
-....: l = 2*p*k/(p*k-2*k-2*p)
-....: F.<J,P,R1,R2>=FreeGroup()
-....: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]
-....: k = G.rewriting_system()
-....: x = k.reduce(P^8)
-....: y = k.reduce(G([-4,2,3]))
-....: t = k.reduce(x*y)
-....: t == G.one()
-....: 
+sage: p = 18
+sage: d = 2*p/(p-6)
+sage: l = 2*p*k/(p*k-2*k-2*p)
+sage: F.<J,P,R1,R2> = FreeGroup()
+sage: G = F / [J^3, P^(3*d), R1^p, R2^p, (F([-2,1]))^k, (F([4,3,1]))^l, F([-4,2,3,-2]), F([-4,1,3,-1]), F([-2,3,4])]
+sage: k = G.rewriting_system()
+sage: x = k.reduce(P^8)
+sage: y = k.reduce(G([-4,2,3]))
+sage: t = k.reduce(x*y)
+sage: t == G.one()
 gap: cannot extend the workspace any more!
 vit@HP-EliteBook-8460p:~/bin/sage-dev$ 
 ```
 
+Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was GAP who caused the crash.)
 
-Sage should gracefully recover from errors and crashes of external libraries. (Moreover, the notebook interface doesn't give you any clue as to what went wrong. In this case you don't even know that it was gap who caused the crash.)
-
``````




---

archive/issue_comments_180400.json:
```json
{
    "body": "Dependencies: **#22626**",
    "created_at": "2018-02-28T19:11:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180400",
    "user": "https://github.com/slel"
}
```

Dependencies: **#22626**



---

archive/issue_comments_180401.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThis is likely OBE but it would be good to double-check what happens in this case with the new implementation.",
    "created_at": "2019-04-02T14:20:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180401",
    "user": "https://github.com/embray"
}
```

<div id="comment:13" align="right">comment:13</div>

This is likely OBE but it would be good to double-check what happens in this case with the new implementation.



---

archive/issue_comments_180402.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nIt seems that I get a segmentation fault, which is to be expected. But at least it's caught by cysignals and raised as a Python exception and everything seems to recover fine. So I think that's what we want here? I'm not sure that there's a better solution.",
    "created_at": "2019-04-02T14:30:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180402",
    "user": "https://github.com/embray"
}
```

<div id="comment:14" align="right">comment:14</div>

It seems that I get a segmentation fault, which is to be expected. But at least it's caught by cysignals and raised as a Python exception and everything seems to recover fine. So I think that's what we want here? I'm not sure that there's a better solution.



---

archive/issue_comments_180403.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nI guess at the very least the Sage code for this equality comparison should catch the exception and do something more user-friendly with it.",
    "created_at": "2019-04-02T14:39:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180403",
    "user": "https://github.com/embray"
}
```

<div id="comment:15" align="right">comment:15</div>

I guess at the very least the Sage code for this equality comparison should catch the exception and do something more user-friendly with it.



---

archive/issue_events_207981.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-02-16T13:00:17Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "milestone_number": null,
    "milestone_title": "sage-8.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207981"
}
```



---

archive/issue_events_207982.json:
```json
{
    "actor": "https://github.com/embray",
    "created_at": "2021-02-16T13:00:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "label": "https://github.com/sagemath/sage/labels/pending",
    "label_color": "008080",
    "label_name": "pending",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14779#event-207982"
}
```



---

archive/issue_comments_180404.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nWith gappy this example results in:\n\n```\nGAPError: Error, reached the pre-set memory limit\n(change it with the -o command line option)\n```\n\nBut there is not actually a way to change the pre-set memory limit through the libgap/gappy interface.  Of course, this needs to be done before initializing the GAP interpreter.\n\nBut according to the GAP docs for `-o`:\n\n> If more than this amount is required during the GAP session, GAP prints an error message and enters a break loop. In that case you can enter return; which implicitly doubles the amount given with this option.\n\nApparently this doesn't happen with libgap/gappy since they do not enter the break loop.  I'll have to figure out where exactly in GAP this is implemented and see if we can reproduce that functionality.  I think it should just happen automatically, but with a warning.",
    "created_at": "2021-02-16T13:09:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180404",
    "user": "https://github.com/embray"
}
```

<div id="comment:17" align="right">comment:17</div>

With gappy this example results in:

```
GAPError: Error, reached the pre-set memory limit
(change it with the -o command line option)
```

But there is not actually a way to change the pre-set memory limit through the libgap/gappy interface.  Of course, this needs to be done before initializing the GAP interpreter.

But according to the GAP docs for `-o`:

> If more than this amount is required during the GAP session, GAP prints an error message and enters a break loop. In that case you can enter return; which implicitly doubles the amount given with this option.

Apparently this doesn't happen with libgap/gappy since they do not enter the break loop.  I'll have to figure out where exactly in GAP this is implemented and see if we can reproduce that functionality.  I think it should just happen automatically, but with a warning.



---

archive/issue_comments_180405.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nApparently this doubling just happens automatically when the allocator notices that it's trying to allocate more than the limit.  At this point it breaks into the error loop, and if you `return;` it will just continue allowing the larger allocation to proceed.  This might be new functionality in GAP since this ticket was first reported 8 years ago.\n\nFrom the libgap/gappy perspective this means you can just repeat the same operation and have more memory allowed for it.  However, it seems to take forever in this case...\n\nI still think maybe we could catch this specific error and reproduce it as a warning (cypari2 does something similar when it needs to extend PARI's workspace).",
    "created_at": "2021-02-16T13:21:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180405",
    "user": "https://github.com/embray"
}
```

<div id="comment:18" align="right">comment:18</div>

Apparently this doubling just happens automatically when the allocator notices that it's trying to allocate more than the limit.  At this point it breaks into the error loop, and if you `return;` it will just continue allowing the larger allocation to proceed.  This might be new functionality in GAP since this ticket was first reported 8 years ago.

From the libgap/gappy perspective this means you can just repeat the same operation and have more memory allowed for it.  However, it seems to take forever in this case...

I still think maybe we could catch this specific error and reproduce it as a warning (cypari2 does something similar when it needs to extend PARI's workspace).



---

archive/issue_comments_180406.json:
```json
{
    "body": "Changed keywords from **gap** to **gap libgap**",
    "created_at": "2021-02-16T13:21:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180406",
    "user": "https://github.com/embray"
}
```

Changed keywords from **gap** to **gap libgap**



---

archive/issue_comments_180407.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\ncf #34041 for the current state of affairs with this.",
    "created_at": "2022-07-02T09:50:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14779",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14779#issuecomment-180407",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:20" align="right">comment:20</div>

cf #34041 for the current state of affairs with this.
