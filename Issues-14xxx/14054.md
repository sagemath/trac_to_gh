# Issue 14054: Cythoned UniqueRepresentation

archive/issues_013850.json:
```json
{
    "assignees": [],
    "body": "`UniqueRepresentation` provides a comfortable way to create unique parent structures, and automatically provides a hash and certain comparison methods.\n\nProblems:\n\n- It relies on a metaclass, namely `ClasscallMetaclass` and thus has to be a Python class. That's bad for speed.\n- It combines two features, namely a cache and unique instance behaviour. But in many some cases we want a cache so that two distinct instances can still be equal.\n\nHere, I suggest to \n\n1. separate the two features, by creating a new class `sage.unique_representation.CachedRepresentation` as one base of `UniqueRepresentation`.\n2. create a new cdef class `sage.misc.fast_methods.WithRichCmpById`, that provides hash and rich comparison, as expected for unique instance behaviour.\n\n__Apply__\n\n- [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)\n- [attachment: trac_14054-fix-rigged-list.2.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.2.patch.gz)\n\nDepends on #14017\nDepends on #6495\nDepends on #14182\nDepends on #14040\nDepends on #14011\n\nCC:  @nthiery\n\nKeywords: **cython UniqueRepresentation**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Simon King**\n\nMerged: **sage-5.8.beta4**\n\nComponent: **performance**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14054_\n\n",
    "closed_at": "2013-03-07T18:26:18Z",
    "created_at": "2013-02-03T22:08:02Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/performance",
        "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
        "https://github.com/sagemath/sage/labels/enhancement",
        "https://github.com/sagemath/sage/labels/c%3A%20cython"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Cythoned UniqueRepresentation",
    "type": "issue",
    "updated_at": "2013-03-07T18:26:18Z",
    "url": "https://github.com/sagemath/sage/issues/14054",
    "user": "https://github.com/simon-king-jena"
}
```
`UniqueRepresentation` provides a comfortable way to create unique parent structures, and automatically provides a hash and certain comparison methods.

Problems:

- It relies on a metaclass, namely `ClasscallMetaclass` and thus has to be a Python class. That's bad for speed.
- It combines two features, namely a cache and unique instance behaviour. But in many some cases we want a cache so that two distinct instances can still be equal.

Here, I suggest to 

1. separate the two features, by creating a new class `sage.unique_representation.CachedRepresentation` as one base of `UniqueRepresentation`.
2. create a new cdef class `sage.misc.fast_methods.WithRichCmpById`, that provides hash and rich comparison, as expected for unique instance behaviour.

__Apply__

- [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)
- [attachment: trac_14054-fix-rigged-list.2.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.2.patch.gz)

Depends on #14017
Depends on #6495
Depends on #14182
Depends on #14040
Depends on #14011

CC:  @nthiery

Keywords: **cython UniqueRepresentation**

Reviewer: **Travis Scrimshaw**

Author: **Simon King**

Merged: **sage-5.8.beta4**

Component: **performance**

_Issue created by migration from https://trac.sagemath.org/ticket/14054_





---

archive/issue_events_195675.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-03T22:08:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195675"
}
```



---

archive/issue_events_195676.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-03T22:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/performance",
    "label_color": "696969",
    "label_name": "performance",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195676"
}
```



---

archive/issue_events_195677.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-03T22:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20major%20/%203",
    "label_color": "ffbb00",
    "label_name": "p: major / 3",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195677"
}
```



---

archive/issue_events_195678.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-03T22:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195678"
}
```



---

archive/issue_events_195679.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-03T22:08:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20cython",
    "label_color": "0000b0",
    "label_name": "c: cython",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195679"
}
```



---

archive/issue_comments_166700.json:
```json
{
    "body": "Attachment: **[trac_14054_cythoned_unique_representation.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac_14054_cythoned_unique_representation.patch.gz)**",
    "created_at": "2013-02-03T22:09:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166700",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac_14054_cythoned_unique_representation.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac_14054_cythoned_unique_representation.patch.gz)**



---

archive/issue_events_195680.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-03T22:16:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195680"
}
```



---

archive/issue_comments_166701.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nNote that the patch also needed to change some auxiliary class `CartanType_simple_finite`, which is used to unpickle some old data. It used to inherit from `object`, but for an incompatibility of Cython types it has to inherit from `UniqueRepresentation` instead.\n\nFor the timings, I use `MatrixSpace`, which inherits from `UniqueRepresentation`:\n\n```\nsage: isinstance(MatrixSpace(GF(3),2,3), UniqueRepresentation)\nTrue\n```\n\nWith sage-5.6.rc0 plus #14017:\n\n```\nsage: %time L = [MatrixSpace(GF(3),n) for n in range(10000)]\nCPU times: user 1.94 s, sys: 0.05 s, total: 2.00 s\nWall time: 2.00 s\nsage: %time D = dict(zip(L,range(len(L))))\nCPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s\nWall time: 0.01 s\nsage: MS = MatrixSpace(GF(3),10000)\nsage: MS in D\nFalse\nsage: timeit(\"MS in D\", number = 10^6)\n1000000 loops, best of 3: 552 ns per loop\nsage: MS = L[5000]\nsage: MS in D\nTrue\nsage: timeit(\"MS in D\", number = 10^6)\n1000000 loops, best of 3: 540 ns per loop\n```\n\nAdding the patch from here:\n\n```\nsage: %time L = [MatrixSpace(GF(3),n) for n in range(10000)]\nCPU times: user 1.96 s, sys: 0.04 s, total: 2.00 s\nWall time: 2.00 s\nsage: %time D = dict(zip(L,range(len(L))))\nCPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s\nWall time: 0.01 s\nsage: MS = MatrixSpace(GF(3),10000)\nsage: MS in D\nFalse\nsage: timeit(\"MS in D\", number = 10^6)\n1000000 loops, best of 3: 187 ns per loop\nsage: MS = L[5000]\nsage: MS in D\nTrue\nsage: timeit(\"MS in D\", number = 10^6)\n1000000 loops, best of 3: 176 ns per loop\n```\n\nHence, the time drops by 2/3. I did run make ptest successfully. Needs review!",
    "created_at": "2013-02-03T22:16:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166701",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:1" align="right">comment:1</div>

Note that the patch also needed to change some auxiliary class `CartanType_simple_finite`, which is used to unpickle some old data. It used to inherit from `object`, but for an incompatibility of Cython types it has to inherit from `UniqueRepresentation` instead.

For the timings, I use `MatrixSpace`, which inherits from `UniqueRepresentation`:

```
sage: isinstance(MatrixSpace(GF(3),2,3), UniqueRepresentation)
True
```

With sage-5.6.rc0 plus #14017:

```
sage: %time L = [MatrixSpace(GF(3),n) for n in range(10000)]
CPU times: user 1.94 s, sys: 0.05 s, total: 2.00 s
Wall time: 2.00 s
sage: %time D = dict(zip(L,range(len(L))))
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.01 s
sage: MS = MatrixSpace(GF(3),10000)
sage: MS in D
False
sage: timeit("MS in D", number = 10^6)
1000000 loops, best of 3: 552 ns per loop
sage: MS = L[5000]
sage: MS in D
True
sage: timeit("MS in D", number = 10^6)
1000000 loops, best of 3: 540 ns per loop
```

Adding the patch from here:

```
sage: %time L = [MatrixSpace(GF(3),n) for n in range(10000)]
CPU times: user 1.96 s, sys: 0.04 s, total: 2.00 s
Wall time: 2.00 s
sage: %time D = dict(zip(L,range(len(L))))
CPU times: user 0.01 s, sys: 0.00 s, total: 0.01 s
Wall time: 0.01 s
sage: MS = MatrixSpace(GF(3),10000)
sage: MS in D
False
sage: timeit("MS in D", number = 10^6)
1000000 loops, best of 3: 187 ns per loop
sage: MS = L[5000]
sage: MS in D
True
sage: timeit("MS in D", number = 10^6)
1000000 loops, best of 3: 176 ns per loop
```

Hence, the time drops by 2/3. I did run make ptest successfully. Needs review!



---

archive/issue_comments_166702.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nCc to Nicolas as the original author of `UniqueRepresentation`.",
    "created_at": "2013-02-04T10:06:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166702",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

Cc to Nicolas as the original author of `UniqueRepresentation`.



---

archive/issue_comments_166703.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nI just did some experiments with the tp_hash function from Python's C-API: It is 1/3 faster than a cythoned hash. I'll try to do similar things with the comparison methods.",
    "created_at": "2013-02-15T16:15:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166703",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:3" align="right">comment:3</div>

I just did some experiments with the tp_hash function from Python's C-API: It is 1/3 faster than a cythoned hash. I'll try to do similar things with the comparison methods.



---

archive/issue_comments_166704.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nWhile we are at speeding up `UniqueRepresentation`, I think we should actually refactor it. Namely, `UniqueRepresentation` serves two purposes, namely (1) caching, and (2) comparison and hash by identity.\n\nSome classes misuse `UniqueRepresentation` by only using feature (1), overriding comparison in a way that violates the unique representation condition. See my monologue at [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/EOWWTK-bUm8).\n\nI suggest to split the two features.",
    "created_at": "2013-02-17T11:30:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166704",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:4" align="right">comment:4</div>

While we are at speeding up `UniqueRepresentation`, I think we should actually refactor it. Namely, `UniqueRepresentation` serves two purposes, namely (1) caching, and (2) comparison and hash by identity.

Some classes misuse `UniqueRepresentation` by only using feature (1), overriding comparison in a way that violates the unique representation condition. See my monologue at [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/EOWWTK-bUm8).

I suggest to split the two features.



---

archive/issue_comments_166705.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nFWIW, I finished a more experimental and rather intrusive version of `UniqueRepresentation`.\n\nIdea:\n\n- Create a cdef function, that results in faster C code than what Cython makes of\n\n  ```\n  def __hash__(self):\n      return id(self)\n  ```\n- Override tp_hash with this function, for every instance of `UniqueRepresentation`. Likewise for tp_richcompare.\n\nIt remains possible to override those parts of comparison that can't be decided by looking at identity (such as \"a<b\" if \"a is not b\").\n\nIt would be great to just define the fast hash and comparison for `UniqueRepresentation` itself, but alas it seems that subclasses forget these settings, whether they override `__hash__` or not. See the comments on sage-devel.\n\nI still think it is a good idea to separate `UniqueRepresentation` from `CachedRepresentation`, but I am not so sure about *enforcing* the uniqueness behaviour, without the possibility to override it---this wouldn't be pythonic...\n\nLet the patchbot do some work:\n\nApply trac14054_fast_methods.patch",
    "created_at": "2013-02-18T06:30:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166705",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:5" align="right">comment:5</div>

FWIW, I finished a more experimental and rather intrusive version of `UniqueRepresentation`.

Idea:

- Create a cdef function, that results in faster C code than what Cython makes of

  ```
  def __hash__(self):
      return id(self)
  ```
- Override tp_hash with this function, for every instance of `UniqueRepresentation`. Likewise for tp_richcompare.

It remains possible to override those parts of comparison that can't be decided by looking at identity (such as "a<b" if "a is not b").

It would be great to just define the fast hash and comparison for `UniqueRepresentation` itself, but alas it seems that subclasses forget these settings, whether they override `__hash__` or not. See the comments on sage-devel.

I still think it is a good idea to separate `UniqueRepresentation` from `CachedRepresentation`, but I am not so sure about *enforcing* the uniqueness behaviour, without the possibility to override it---this wouldn't be pythonic...

Let the patchbot do some work:

Apply trac14054_fast_methods.patch



---

archive/issue_comments_166706.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nFrom [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/EOWWTK-bUm8), I understand that people think that separating the cache feature from the uniqueness feature of `UniqueRepresentation` is a good idea.\n\nHowever, in my old patch, I was *enforcing* uniqueness behaviour for instances of `UniqueRepresentation`. This isn't pythonic. Hence, I do differently in the new patch version.\n\n**__Question__**\n\nIn the current implementation, inheritance from `UniqueRepresentation` will overload rich comparison (==, >=, !=, etc.) inherited from a base class, but it will not overload comparison (cmp). Do you think that *both* should be overloaded?\n\nPatchbot reported two failures with the previous patch version. I guess that's because of an additional dependency. So, as soon as I have a decent internet connection, I'll download the latest beta, and rebase on top of it.\n\nApply trac14054_fast_methods.patch",
    "created_at": "2013-02-19T08:52:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166706",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:6" align="right">comment:6</div>

From [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/EOWWTK-bUm8), I understand that people think that separating the cache feature from the uniqueness feature of `UniqueRepresentation` is a good idea.

However, in my old patch, I was *enforcing* uniqueness behaviour for instances of `UniqueRepresentation`. This isn't pythonic. Hence, I do differently in the new patch version.

**__Question__**

In the current implementation, inheritance from `UniqueRepresentation` will overload rich comparison (==, >=, !=, etc.) inherited from a base class, but it will not overload comparison (cmp). Do you think that *both* should be overloaded?

Patchbot reported two failures with the previous patch version. I guess that's because of an additional dependency. So, as soon as I have a decent internet connection, I'll download the latest beta, and rebase on top of it.

Apply trac14054_fast_methods.patch



---

archive/issue_comments_166707.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nOther question: Does `provide_hash_by_id` really make sense to have?",
    "created_at": "2013-02-19T09:41:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166707",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:7" align="right">comment:7</div>

Other question: Does `provide_hash_by_id` really make sense to have?



---

archive/issue_comments_166708.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nThe updated patch should make the coverage script happy, but three tests with 5.7.rc0 currently fail. I am downloading 5.7.rc0 now.\n\nApply trac14054_fast_methods.patch",
    "created_at": "2013-02-19T10:17:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166708",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:8" align="right">comment:8</div>

The updated patch should make the coverage script happy, but three tests with 5.7.rc0 currently fail. I am downloading 5.7.rc0 now.

Apply trac14054_fast_methods.patch



---

archive/issue_comments_166709.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI am not qualified to look over this ticket, but glancing at it I spotted this\n\n```\n308\t        complete = complete = self.complete() \n```\nwhich looks like a typo.",
    "created_at": "2013-02-19T12:38:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166709",
    "user": "https://github.com/sagetrac-jlopez"
}
```

<div id="comment:9" align="right">comment:9</div>

I am not qualified to look over this ticket, but glancing at it I spotted this

```
308	        complete = complete = self.complete() 
```
which looks like a typo.



---

archive/issue_comments_166710.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [@sagetrac-jlopez](#comment%3A9):\n> I am not qualified to look over this ticket, but glancing at it I spotted this\n> \n> ```\n> 308\t        complete = complete = self.complete() \n> ```\n> which looks like a typo.\n\nYes, thank you for spotting it! Will remove it when I rebase the patch against 5.7.rc0.",
    "created_at": "2013-02-19T12:47:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166710",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [@sagetrac-jlopez](#comment%3A9):
> I am not qualified to look over this ticket, but glancing at it I spotted this
> 
> ```
> 308	        complete = complete = self.complete() 
> ```
> which looks like a typo.

Yes, thank you for spotting it! Will remove it when I rebase the patch against 5.7.rc0.



---

archive/issue_comments_166711.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nHey Simon,\n\nLet me know when this is ready for review again.\n\nBest,\n\nTravis",
    "created_at": "2013-02-19T15:24:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166711",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:11" align="right">comment:11</div>

Hey Simon,

Let me know when this is ready for review again.

Best,

Travis



---

archive/issue_comments_166712.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2013-02-19T15:24:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166712",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_166713.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nThe patch should now be ready for review.\n\nTwo questions that I'd like to have addressed:\n\n1. I introduce `provide_hash_by_id`, but I don't use it. Shall it be deleted?\n2. Is it enough to override the rich comparison methods? Currently, one can have `hash(a)!=hash(b)` but `cmp(a,b)==0`. Does this violate the contract of hash functions? Or is it enough that `hash(a)!=hash(b)` implies `a!=b`?\n\nPathbot:\n\nApply trac14054_fast_methods.patch",
    "created_at": "2013-02-19T16:00:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166713",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:12" align="right">comment:12</div>

The patch should now be ready for review.

Two questions that I'd like to have addressed:

1. I introduce `provide_hash_by_id`, but I don't use it. Shall it be deleted?
2. Is it enough to override the rich comparison methods? Currently, one can have `hash(a)!=hash(b)` but `cmp(a,b)==0`. Does this violate the contract of hash functions? Or is it enough that `hash(a)!=hash(b)` implies `a!=b`?

Pathbot:

Apply trac14054_fast_methods.patch



---

archive/issue_comments_166714.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,5 +1,15 @@\n-`UniqueRepresentation` provides a comfortable way to create unique parent structures, and automatically provides a hash and certain comparison methods. Problem: It relies on a metaclass, namely `ClasscallMetaclass` and thus has to be a Python class. That's bad for speed.\n+`UniqueRepresentation` provides a comfortable way to create unique parent structures, and automatically provides a hash and certain comparison methods.\n \n-Here, I suggest to create a new cdef class `UniqueRepresentation_c` that provides hash and comparison, and let `UniqueRepresentation` inherit from it, just adding the classcall method.\n+Problems:\n \n-The problem is that `UniqueRepresentation` relies on cached_method, and this decorator had problems to work on methods defined in Cython with varargs and keywords arguments. That is fixed in #14017, which is thus a dependency.\n+- It relies on a metaclass, namely `ClasscallMetaclass` and thus has to be a Python class. That's bad for speed.\n+- It combines two features, namely a cache and unique instance behaviour. But in many some cases we want a cache so that two distinct instances can still be equal.\n+\n+Here, I suggest to \n+\n+1. separate the two features, by creating a new class `sage.unique_representation.CachedRepresentation` as one base of `UniqueRepresentation`.\n+2. create a new cdef class `sage.misc.fast_methods.WithRichCmpById`, that provides hash and rich comparison, as expected for unique instance behaviour.\n+\n+__Apply__\n+\n+- [attachment: trac14054_fast_methods.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods.patch.gz)\n``````\n",
    "created_at": "2013-02-19T16:00:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166714",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,5 +1,15 @@
-`UniqueRepresentation` provides a comfortable way to create unique parent structures, and automatically provides a hash and certain comparison methods. Problem: It relies on a metaclass, namely `ClasscallMetaclass` and thus has to be a Python class. That's bad for speed.
+`UniqueRepresentation` provides a comfortable way to create unique parent structures, and automatically provides a hash and certain comparison methods.
 
-Here, I suggest to create a new cdef class `UniqueRepresentation_c` that provides hash and comparison, and let `UniqueRepresentation` inherit from it, just adding the classcall method.
+Problems:
 
-The problem is that `UniqueRepresentation` relies on cached_method, and this decorator had problems to work on methods defined in Cython with varargs and keywords arguments. That is fixed in #14017, which is thus a dependency.
+- It relies on a metaclass, namely `ClasscallMetaclass` and thus has to be a Python class. That's bad for speed.
+- It combines two features, namely a cache and unique instance behaviour. But in many some cases we want a cache so that two distinct instances can still be equal.
+
+Here, I suggest to 
+
+1. separate the two features, by creating a new class `sage.unique_representation.CachedRepresentation` as one base of `UniqueRepresentation`.
+2. create a new cdef class `sage.misc.fast_methods.WithRichCmpById`, that provides hash and rich comparison, as expected for unique instance behaviour.
+
+__Apply__
+
+- [attachment: trac14054_fast_methods.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods.patch.gz)
``````




---

archive/issue_comments_166715.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nTo answer the question about the hash contract:\n\nApparently dictionaries use the rich comparison methods and not cmp:\n\n```\nsage: class Bla(object):\n....:     def __hash__(self):\n....:         return 2\n....:     def __cmp__(self, other):\n....:         return 0\n....:     def __eq__(self, other):\n....:         return self is other\n....:     def __ne__(self, other):\n....:         return self is not other\n....:     \nsage: a = Bla()\nsage: b = Bla()\nsage: a==b\nFalse\nsage: hash(a)==hash(b)\nTrue\nsage: cmp(a,b)\n0\nsage: D = {a:1}\n```\n\nSince `hash(a)==hash(b)`, a and b belong to the same hash bucket of the dictionary. And comparison by cmp tells that they are equal. But we still have:\n\n```\nsage: D[b]\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\n<ipython-input-8-6cf1ee6b63d5> in <module>()\n----> 1 D[b]\n\nKeyError: <__main__.Bla object at 0x5064310>\n```\n\nHence, dictionaries use comparison by `==`, and thus my patch does the right thing, IMHO.",
    "created_at": "2013-02-19T16:04:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166715",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

To answer the question about the hash contract:

Apparently dictionaries use the rich comparison methods and not cmp:

```
sage: class Bla(object):
....:     def __hash__(self):
....:         return 2
....:     def __cmp__(self, other):
....:         return 0
....:     def __eq__(self, other):
....:         return self is other
....:     def __ne__(self, other):
....:         return self is not other
....:     
sage: a = Bla()
sage: b = Bla()
sage: a==b
False
sage: hash(a)==hash(b)
True
sage: cmp(a,b)
0
sage: D = {a:1}
```

Since `hash(a)==hash(b)`, a and b belong to the same hash bucket of the dictionary. And comparison by cmp tells that they are equal. But we still have:

```
sage: D[b]
---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-8-6cf1ee6b63d5> in <module>()
----> 1 D[b]

KeyError: <__main__.Bla object at 0x5064310>
```

Hence, dictionaries use comparison by `==`, and thus my patch does the right thing, IMHO.



---

archive/issue_comments_166716.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nReplying to [@simon-king-jena](#comment%3A12):\n> 1. I introduce `provide_hash_by_id`, but I don't use it. Shall it be deleted?\n\nYes, you should. I'm pretty sure changing `type->tp_hash` after calling `PyType_Ready()` is not supported by the Python C-API (see the inheritance problems we saw).\n\n> 2. Is it enough to override the rich comparison methods? Currently, one can have `hash(a)!=hash(b)` but `cmp(a,b)==0`.\n\n> Does this violate the contract of hash functions? Or is it enough that `hash(a)!=hash(b)` implies `a!=b`?\n\nI think Python requires `hash(a)!=hash(b)` implies `not(a==b)`, which Python does not enforce to be the same thing. In any case, I'm pretty sure that \"rich comparison\" is fully exhausted before trying to use `__cmp__`, which is only there because of backward compatibility.\n\nThere's another peculiarity for membership and lookup in python:\n\n```\nsage: class neq(object):\n....:     def __eq__(self,other):\n....:         return False\n....:     def __ne__(self,other):\n....:         return True\n....:     \nsage: a=neq()\nsage: V={a}\nsage: a in V\nTrue\nsage: sage: [a == v for v in V]\n[False]\n```\nThey explicitly mention this in the documentation: because hash collisions are rare, they first test \"is\" for dict lookup before trying \"==\" (it's cheaper).",
    "created_at": "2013-02-19T17:25:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166716",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:14" align="right">comment:14</div>

Replying to [@simon-king-jena](#comment%3A12):
> 1. I introduce `provide_hash_by_id`, but I don't use it. Shall it be deleted?

Yes, you should. I'm pretty sure changing `type->tp_hash` after calling `PyType_Ready()` is not supported by the Python C-API (see the inheritance problems we saw).

> 2. Is it enough to override the rich comparison methods? Currently, one can have `hash(a)!=hash(b)` but `cmp(a,b)==0`.

> Does this violate the contract of hash functions? Or is it enough that `hash(a)!=hash(b)` implies `a!=b`?

I think Python requires `hash(a)!=hash(b)` implies `not(a==b)`, which Python does not enforce to be the same thing. In any case, I'm pretty sure that "rich comparison" is fully exhausted before trying to use `__cmp__`, which is only there because of backward compatibility.

There's another peculiarity for membership and lookup in python:

```
sage: class neq(object):
....:     def __eq__(self,other):
....:         return False
....:     def __ne__(self,other):
....:         return True
....:     
sage: a=neq()
sage: V={a}
sage: a in V
True
sage: sage: [a == v for v in V]
[False]
```
They explicitly mention this in the documentation: because hash collisions are rare, they first test "is" for dict lookup before trying "==" (it's cheaper).



---

archive/issue_comments_166717.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@nbruin](#comment%3A14):\n> Replying to [@simon-king-jena](#comment%3A12):\n> > 1. I introduce `provide_hash_by_id`, but I don't use it. Shall it be deleted?\n\n> \n> Yes, you should.\n\nOK.\n\n> > Does this violate the contract of hash functions? Or is it enough that `hash(a)!=hash(b)` implies `a!=b`?\n\n> \n> I think Python requires `hash(a)!=hash(b)` implies `not(a==b)`,\n\nRight, that's a difference.\n\n> In any case, I'm pretty sure that \"rich comparison\" is fully exhausted before trying to use `__cmp__`, which is only there because of backward compatibility.\n\nNope! See my post on [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/EOWWTK-bUm8).\n\nIf you have a non-cdef class, then it seems `__richcmp__` is simply ignored (but methods like `__eq__` have precedence over `__cmp__`). In a cdef class, `__richcmp__` has priority over `__cmp__` when deciding binary relations such as ==, <, <=, etc. But for cmp(*,*), `__cmp__` will be used, even if there is `__richcmp__`!\n\nSo, the decisive question is: Do dictionaries compare stuff by cmp(a,b)==0 or by a==b?\n\nIt is the latter, and thus making `__richcmp__` compatible with `__hash__` was the right thing to do.\n\nFor now, it needs work, because I will delete the C API hack, and apparently some script of the patchbot has a complaint...",
    "created_at": "2013-02-19T17:45:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166717",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@nbruin](#comment%3A14):
> Replying to [@simon-king-jena](#comment%3A12):
> > 1. I introduce `provide_hash_by_id`, but I don't use it. Shall it be deleted?

> 
> Yes, you should.

OK.

> > Does this violate the contract of hash functions? Or is it enough that `hash(a)!=hash(b)` implies `a!=b`?

> 
> I think Python requires `hash(a)!=hash(b)` implies `not(a==b)`,

Right, that's a difference.

> In any case, I'm pretty sure that "rich comparison" is fully exhausted before trying to use `__cmp__`, which is only there because of backward compatibility.

Nope! See my post on [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/EOWWTK-bUm8).

If you have a non-cdef class, then it seems `__richcmp__` is simply ignored (but methods like `__eq__` have precedence over `__cmp__`). In a cdef class, `__richcmp__` has priority over `__cmp__` when deciding binary relations such as ==, <, <=, etc. But for cmp(*,*), `__cmp__` will be used, even if there is `__richcmp__`!

So, the decisive question is: Do dictionaries compare stuff by cmp(a,b)==0 or by a==b?

It is the latter, and thus making `__richcmp__` compatible with `__hash__` was the right thing to do.

For now, it needs work, because I will delete the C API hack, and apparently some script of the patchbot has a complaint...



---

archive/issue_comments_166718.json:
```json
{
    "body": "Attachment: **[trac14054_fast_methods.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods.patch.gz)**\n\nSeparate cache and uniqueness.",
    "created_at": "2013-02-19T17:50:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166718",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac14054_fast_methods.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods.patch.gz)**

Separate cache and uniqueness.



---

archive/issue_comments_166719.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nDone!\n\nIt seems that the patchbot complains about an increased startup time. How did that happen? Is it because of a slightly longer mro for `UniqueRepresentation`?\n\nPatchbot:\n\nApply trac14054_fast_methods.patch",
    "created_at": "2013-02-19T17:51:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166719",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

Done!

It seems that the patchbot complains about an increased startup time. How did that happen? Is it because of a slightly longer mro for `UniqueRepresentation`?

Patchbot:

Apply trac14054_fast_methods.patch



---

archive/issue_comments_166720.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nWhat's your rationale to define 'a < b' etc. when `a is b`? I agree that it's likely that your answers are what any ordering override will want, but Python does not mandate any particular properties of semantics of these operators. So I think the proper thing is to just not do anything there. It's going to be a rare occasion anyway, so a little speed gain won't be very noticeable anyway.\n\nThe behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.\n\nI think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way. Your motivation here seems to be as much to provide conceptual units in preference of just technical implementation tools as to provide more efficient implementations. Someone writing a Python class may not know what \"richcomp\" is, and doesn't need to.",
    "created_at": "2013-02-20T17:51:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166720",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:17" align="right">comment:17</div>

What's your rationale to define 'a < b' etc. when `a is b`? I agree that it's likely that your answers are what any ordering override will want, but Python does not mandate any particular properties of semantics of these operators. So I think the proper thing is to just not do anything there. It's going to be a rare occasion anyway, so a little speed gain won't be very noticeable anyway.

The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.

I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way. Your motivation here seems to be as much to provide conceptual units in preference of just technical implementation tools as to provide more efficient implementations. Someone writing a Python class may not know what "richcomp" is, and doesn't need to.



---

archive/issue_comments_166721.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nHey,\n\nReplying to [@nbruin](#comment%3A17):\n> What's your rationale to define 'a < b' etc. when `a is b`? I agree that it's likely that your answers are what any ordering override will want, but Python does not mandate any particular properties of semantics of these operators. So I think the proper thing is to just not do anything there. It's going to be a rare occasion anyway, so a little speed gain won't be very noticeable anyway.\n\nSo how would you want comparisons in the complex numbers to behave? In python, they return an error:\n\n```\nsage: complex(2+2*i) < complex(2-2*i)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-2-ce2e269601f6> in <module>()\n----> 1 complex(Integer(2)+Integer(2)*i) < complex(Integer(2)-Integer(2)*i)\n\nTypeError: no ordering relation is defined for complex numbers\n```\nHowever in sage they are not so well-behaved (see #14088):\n\n```\nsage: CC(1+2*i) < CC(2-2*i)\nTrue\n```\nso there's no prescribed sage way.\n\nAs far as the actual comparison code, I think it would be better to do something like\n\n```\nif m == 2:\n    return True\nelif m == 3:\n    return False\nelse:\n    return m == 1 or m == 5\n```\nbut this is a micro-optimization, so feel free to ignore this.\n\n> The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.\n> \n> I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way. Your motivation here seems to be as much to provide conceptual units in preference of just technical implementation tools as to provide more efficient implementations. Someone writing a Python class may not know what \"richcomp\" is, and doesn't need to.\n\nI believe the response to both of these points depends on how we want to do comparison between objects (when there is not a [natural] ordering).\n\nLast thing for now, shouldn't we issue a deprecation warning for `FastHashable_class` since it has changed locations?\n\nThanks,\n\nTravis",
    "created_at": "2013-02-20T20:03:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166721",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:18" align="right">comment:18</div>

Hey,

Replying to [@nbruin](#comment%3A17):
> What's your rationale to define 'a < b' etc. when `a is b`? I agree that it's likely that your answers are what any ordering override will want, but Python does not mandate any particular properties of semantics of these operators. So I think the proper thing is to just not do anything there. It's going to be a rare occasion anyway, so a little speed gain won't be very noticeable anyway.

So how would you want comparisons in the complex numbers to behave? In python, they return an error:

```
sage: complex(2+2*i) < complex(2-2*i)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-2-ce2e269601f6> in <module>()
----> 1 complex(Integer(2)+Integer(2)*i) < complex(Integer(2)-Integer(2)*i)

TypeError: no ordering relation is defined for complex numbers
```
However in sage they are not so well-behaved (see #14088):

```
sage: CC(1+2*i) < CC(2-2*i)
True
```
so there's no prescribed sage way.

As far as the actual comparison code, I think it would be better to do something like

```
if m == 2:
    return True
elif m == 3:
    return False
else:
    return m == 1 or m == 5
```
but this is a micro-optimization, so feel free to ignore this.

> The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.
> 
> I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way. Your motivation here seems to be as much to provide conceptual units in preference of just technical implementation tools as to provide more efficient implementations. Someone writing a Python class may not know what "richcomp" is, and doesn't need to.

I believe the response to both of these points depends on how we want to do comparison between objects (when there is not a [natural] ordering).

Last thing for now, shouldn't we issue a deprecation warning for `FastHashable_class` since it has changed locations?

Thanks,

Travis



---

archive/issue_comments_166722.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nThe issue is that if someone wants to define\n\n```\nclass C(WithEqualityById):\n    def __cmp__(self,other):\n        return -1\n```\nthey will find that\n\n```\nsage: a=C()\nsage: a < a\nFalse\n```\nwhich might surprise them, because they thought that `WithEqualityById` only affected (in)equality testing and let ordering comparisons fall through to `__cmp__` if implemented. With the current code, this is not the case if the two arguments are identical.\n\nThere have been extensive discussions about what inequality testing SHOULD be in sage and for the most part the implementation here is staying clear of the topic (which I think is a good thing). There's just this one small optimization that's probably usually OK, but if left out makes for much more predictable behaviour.",
    "created_at": "2013-02-20T20:36:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166722",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

The issue is that if someone wants to define

```
class C(WithEqualityById):
    def __cmp__(self,other):
        return -1
```
they will find that

```
sage: a=C()
sage: a < a
False
```
which might surprise them, because they thought that `WithEqualityById` only affected (in)equality testing and let ordering comparisons fall through to `__cmp__` if implemented. With the current code, this is not the case if the two arguments are identical.

There have been extensive discussions about what inequality testing SHOULD be in sage and for the most part the implementation here is staying clear of the topic (which I think is a good thing). There's just this one small optimization that's probably usually OK, but if left out makes for much more predictable behaviour.



---

archive/issue_comments_166723.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@nbruin](#comment%3A17):\n> What's your rationale to define 'a < b' etc. when `a is b`? I agree that it's likely that your answers are what any ordering override will want, but Python does not mandate any particular properties of semantics of these operators.\n\nPython does not. But I think \"comparison by identity\" implies a semantics. And that is: `a < a` is False, `a <= a` is True.\n\n> The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.\n\nOK. \n\n> I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way.\n\nGood idea.\n\nReplying to [@tscrim](#comment%3A18):\n> Last thing for now, shouldn't we issue a deprecation warning for `FastHashable_class` since it has changed locations?\n\nI think I introduced it. But when? Or what ticket? I don't think anyone used it.",
    "created_at": "2013-02-20T21:56:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166723",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@nbruin](#comment%3A17):
> What's your rationale to define 'a < b' etc. when `a is b`? I agree that it's likely that your answers are what any ordering override will want, but Python does not mandate any particular properties of semantics of these operators.

Python does not. But I think "comparison by identity" implies a semantics. And that is: `a < a` is False, `a <= a` is True.

> The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.

OK. 

> I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way.

Good idea.

Replying to [@tscrim](#comment%3A18):
> Last thing for now, shouldn't we issue a deprecation warning for `FastHashable_class` since it has changed locations?

I think I introduced it. But when? Or what ticket? I don't think anyone used it.



---

archive/issue_comments_166724.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nReplying to [@simon-king-jena](#comment%3A20):\n> > The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.\n\n> \n> OK. \n> \n> > I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way.\n\n> \n> Good idea.\n\nNote: I would not like the name \"`WithCmpById`\", because `cmp` relies on `__cmp__` (which is not touched) even if `__richcmp__` exists.\n \n> Replying to [@tscrim](#comment%3A18):\n> > Last thing for now, shouldn't we issue a deprecation warning for `FastHashable_class` since it has changed locations?\n\n> \n> I think I introduced it. But when? Or what ticket? I don't think anyone used it.\n\n\nIt was in #11900. We could of course keep it in sage.categories.category_singleton, but I think that's not the right place. Note that I remove the dependency of `CategorySingleton` on `FastHashable_class`, because the new cythoned hash is slightly faster.",
    "created_at": "2013-02-21T11:10:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166724",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:21" align="right">comment:21</div>

Replying to [@simon-king-jena](#comment%3A20):
> > The behaviour you are implementing is much easier to explain if you don't override those cases: Then you can just say that `WithRichCmpById` provides `__hash__`, `__eq__` and `__ne__`, period.

> 
> OK. 
> 
> > I think `WithEqualityById` would make a better conceptual name that is less dependent on the implementation, by the way.

> 
> Good idea.

Note: I would not like the name "`WithCmpById`", because `cmp` relies on `__cmp__` (which is not touched) even if `__richcmp__` exists.
 
> Replying to [@tscrim](#comment%3A18):
> > Last thing for now, shouldn't we issue a deprecation warning for `FastHashable_class` since it has changed locations?

> 
> I think I introduced it. But when? Or what ticket? I don't think anyone used it.


It was in #11900. We could of course keep it in sage.categories.category_singleton, but I think that's not the right place. Note that I remove the dependency of `CategorySingleton` on `FastHashable_class`, because the new cythoned hash is slightly faster.



---

archive/issue_comments_166725.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThis will not go into 5.7 anyway. Hence, I was rebasing against #6495 (which is a minor change anyway). In addition, I took into account your comments:\n\n- I rename the new class into `WithEqualityById`.\n- I move `FastHashable_class` back into category_singleton (wrong as this may be...)\n\nI hope this addresses all complaints.\n\nApply trac14054_fast_methods-5.8.patch",
    "created_at": "2013-02-21T17:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166725",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

This will not go into 5.7 anyway. Hence, I was rebasing against #6495 (which is a minor change anyway). In addition, I took into account your comments:

- I rename the new class into `WithEqualityById`.
- I move `FastHashable_class` back into category_singleton (wrong as this may be...)

I hope this addresses all complaints.

Apply trac14054_fast_methods-5.8.patch



---

archive/issue_comments_166726.json:
```json
{
    "body": "Changed dependencies from **#14017** to **#14017, #6495**",
    "created_at": "2013-02-21T17:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166726",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#14017** to **#14017, #6495**



---

archive/issue_comments_166727.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,4 +12,4 @@\n \n __Apply__\n \n-- [attachment: trac14054_fast_methods.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods.patch.gz)\n+- [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)\n``````\n",
    "created_at": "2013-02-21T17:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166727",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,4 +12,4 @@
 
 __Apply__
 
-- [attachment: trac14054_fast_methods.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods.patch.gz)
+- [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)
``````




---

archive/issue_comments_166728.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nOops, I forgot to rename two occurrences of `WithRichCmpById` into `WithEqualityById`...\n\nShould now pass all tests.\n\nApply trac14054_fast_methods-5.8.patch",
    "created_at": "2013-02-22T13:15:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166728",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

Oops, I forgot to rename two occurrences of `WithRichCmpById` into `WithEqualityById`...

Should now pass all tests.

Apply trac14054_fast_methods-5.8.patch



---

archive/issue_comments_166729.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nStrange. I can not replicate the error reported by the patchbot.",
    "created_at": "2013-02-22T23:48:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166729",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

Strange. I can not replicate the error reported by the patchbot.



---

archive/issue_comments_166730.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nNeither can I by hand or testing the individual files. It has to be something since the testbot can reproduce it... Have you tried running testall by chance? I ran tests in the `categories` folder than on `free_module.py` and that passed.\n\nIt must have something to testing things in the right order...I'm wondering if the problem lies with `free_module.tensor_constructor()` being a cached_method and something is being improperly stored...",
    "created_at": "2013-02-23T16:26:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166730",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:25" align="right">comment:25</div>

Neither can I by hand or testing the individual files. It has to be something since the testbot can reproduce it... Have you tried running testall by chance? I ran tests in the `categories` folder than on `free_module.py` and that passed.

It must have something to testing things in the right order...I'm wondering if the problem lies with `free_module.tensor_constructor()` being a cached_method and something is being improperly stored...



---

archive/issue_comments_166731.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@tscrim](#comment%3A25):\n> It must have something to testing things in the right order...I'm wondering if the problem lies with `free_module.tensor_constructor()` being a cached_method and something is being improperly stored...\n\nThe failing assertion is\n\n```\n      File \"/mnt/storage2TB/patchbot/Sage/sage-5.8.beta0/local/lib/python/site-packages/sage/categories/modules_with_basis.py\", line 1387, in __call__\n        assert(x.parent() is self.domain())\n```\n\nI can hardly imagine that there is yet another premature deallocation via weak references in play. After all, both `x._parent` and `self._domain` are just plain strong references.",
    "created_at": "2013-02-23T18:58:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166731",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@tscrim](#comment%3A25):
> It must have something to testing things in the right order...I'm wondering if the problem lies with `free_module.tensor_constructor()` being a cached_method and something is being improperly stored...

The failing assertion is

```
      File "/mnt/storage2TB/patchbot/Sage/sage-5.8.beta0/local/lib/python/site-packages/sage/categories/modules_with_basis.py", line 1387, in __call__
        assert(x.parent() is self.domain())
```

I can hardly imagine that there is yet another premature deallocation via weak references in play. After all, both `x._parent` and `self._domain` are just plain strong references.



---

archive/issue_comments_166732.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nThis parent mismatch happens in a morphism call. If a morphism gets registered in the wrong slot in a conversion/coercion then it could indeed end up getting mismatched input (shouldn't `__call__` be a little more permissive about its arguments by the way? Certainly, an error would be more appropriate than an assert if this is something that actually can go wrong)\n\nAnyway, `TripleDict` does store homomorphisms and we've recently seen it's not entirely safe wrt. garbage collections that can happen during update procedures. That can cause homomorphisms to get registered under the wrong domain/codomain keys.\n\nI think it's extremely unlikely that this is happening in this particular situation, but if all other conceivable alternatives are impossible ... (since the corruption would be dependent on a GC happening at just the wrong time, it would be extremely fickle behaviour that is very hard to reproduce).\n\nOf course, if this test is using a map that wasn't retrieved from a `TripleDict` or a `MonoDict` the above explanation is impossible.",
    "created_at": "2013-02-23T19:32:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166732",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:27" align="right">comment:27</div>

This parent mismatch happens in a morphism call. If a morphism gets registered in the wrong slot in a conversion/coercion then it could indeed end up getting mismatched input (shouldn't `__call__` be a little more permissive about its arguments by the way? Certainly, an error would be more appropriate than an assert if this is something that actually can go wrong)

Anyway, `TripleDict` does store homomorphisms and we've recently seen it's not entirely safe wrt. garbage collections that can happen during update procedures. That can cause homomorphisms to get registered under the wrong domain/codomain keys.

I think it's extremely unlikely that this is happening in this particular situation, but if all other conceivable alternatives are impossible ... (since the corruption would be dependent on a GC happening at just the wrong time, it would be extremely fickle behaviour that is very hard to reproduce).

Of course, if this test is using a map that wasn't retrieved from a `TripleDict` or a `MonoDict` the above explanation is impossible.



---

archive/issue_comments_166733.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@nbruin](#comment%3A27):\n> This parent mismatch happens in a morphism call. If a morphism gets registered in the wrong slot in a conversion/coercion then it could indeed end up getting mismatched input\n\nIf it is in a wrong slot (you mean: Addressed by a non-identic copy of a parent?) then it should simply not occur here, because `TripleDict` would compare by identity.\n\n> (shouldn't `__call__` be a little more permissive about its arguments by the way? Certainly, an error would be more appropriate than an assert if this is something that actually can go wrong)\n\nNo, I think an assertion is the right thing to do here. Perhaps one could provide the assertion with an error message that names the two parents that don't match. In that way, we could at least see what two parents are involved.\n\nNote that my patch changes `CombinatorialFreeModule` from `UniqueRepresentation` to `CachedRepresentation`, since it overrides the equality tests. So, it could actually be that the two parents are genuinely non-unique. And since a cached_method is involved here, which does comparison by equality and not identity, we could really be in trouble here.\n\nOf course, it could be that changing to `CachedRepresentation` was wrong in this case.",
    "created_at": "2013-02-23T19:44:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166733",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@nbruin](#comment%3A27):
> This parent mismatch happens in a morphism call. If a morphism gets registered in the wrong slot in a conversion/coercion then it could indeed end up getting mismatched input

If it is in a wrong slot (you mean: Addressed by a non-identic copy of a parent?) then it should simply not occur here, because `TripleDict` would compare by identity.

> (shouldn't `__call__` be a little more permissive about its arguments by the way? Certainly, an error would be more appropriate than an assert if this is something that actually can go wrong)

No, I think an assertion is the right thing to do here. Perhaps one could provide the assertion with an error message that names the two parents that don't match. In that way, we could at least see what two parents are involved.

Note that my patch changes `CombinatorialFreeModule` from `UniqueRepresentation` to `CachedRepresentation`, since it overrides the equality tests. So, it could actually be that the two parents are genuinely non-unique. And since a cached_method is involved here, which does comparison by equality and not identity, we could really be in trouble here.

Of course, it could be that changing to `CachedRepresentation` was wrong in this case.



---

archive/issue_comments_166734.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nReplying to [@simon-king-jena](#comment%3A28):\n> If it is in a wrong slot (you mean: Addressed by a non-identic copy of a parent?) then it should simply not occur here, because `TripleDict` would compare by identity.\n\nNo, what I meant is: bucket position to write value into gets determined, dictionary gets changed due to a GC, value gets placed into bucket position determined earlier, which now belongs to an entirely different key triple. Without #13387 we couldn't strictly exclude that from happening, but it would need extreme bad luck.\n\nYour hypothesis sounds much more probable.",
    "created_at": "2013-02-24T02:46:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166734",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:29" align="right">comment:29</div>

Replying to [@simon-king-jena](#comment%3A28):
> If it is in a wrong slot (you mean: Addressed by a non-identic copy of a parent?) then it should simply not occur here, because `TripleDict` would compare by identity.

No, what I meant is: bucket position to write value into gets determined, dictionary gets changed due to a GC, value gets placed into bucket position determined earlier, which now belongs to an entirely different key triple. Without #13387 we couldn't strictly exclude that from happening, but it would need extreme bad luck.

Your hypothesis sounds much more probable.



---

archive/issue_comments_166735.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nBy the way: One reason for removing `FastHashable_class` from sage.categories.category_singleton is the fact that the hash inherited from the cythoned version of `UniqueRepresentation` is faster than what was provided by `FastHashable_class`.",
    "created_at": "2013-02-24T21:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166735",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:30" align="right">comment:30</div>

By the way: One reason for removing `FastHashable_class` from sage.categories.category_singleton is the fact that the hash inherited from the cythoned version of `UniqueRepresentation` is faster than what was provided by `FastHashable_class`.



---

archive/issue_comments_166736.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\nReplying to [@simon-king-jena](#comment%3A30):\n> By the way: One reason for removing `FastHashable_class` from sage.categories.category_singleton is the fact that the hash inherited from the cythoned version of `UniqueRepresentation` is faster than what was provided by `FastHashable_class`.\n\nI didn't want it to not be removed, but I thought it was suppose to have a deprecation warning saying the class had moved/changed namespaces?",
    "created_at": "2013-02-25T04:02:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166736",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:31" align="right">comment:31</div>

Replying to [@simon-king-jena](#comment%3A30):
> By the way: One reason for removing `FastHashable_class` from sage.categories.category_singleton is the fact that the hash inherited from the cythoned version of `UniqueRepresentation` is faster than what was provided by `FastHashable_class`.

I didn't want it to not be removed, but I thought it was suppose to have a deprecation warning saying the class had moved/changed namespaces?



---

archive/issue_comments_166737.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@tscrim](#comment%3A31):\n> I didn't want it to not be removed, but I thought it was suppose to have a deprecation warning saying the class had moved/changed namespaces?\n\nWould you mind to just leave it in its original space (being an orphan, though)?\n\nOtherwise: How does one deprecate a class that has no init method?",
    "created_at": "2013-02-25T06:29:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166737",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@tscrim](#comment%3A31):
> I didn't want it to not be removed, but I thought it was suppose to have a deprecation warning saying the class had moved/changed namespaces?

Would you mind to just leave it in its original space (being an orphan, though)?

Otherwise: How does one deprecate a class that has no init method?



---

archive/issue_comments_166738.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [@simon-king-jena](#comment%3A32): \n> Otherwise: How does one deprecate a class that has no init method?\n\n\"Had\" no init method, I should say.\n\nAnyway, if I move it to a different file, then the import statement \"`from sage.categories.category_singleton import FastHashable_class`\" should result in a deprecation warning. How can this be achieved?",
    "created_at": "2013-02-25T06:31:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166738",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [@simon-king-jena](#comment%3A32): 
> Otherwise: How does one deprecate a class that has no init method?

"Had" no init method, I should say.

Anyway, if I move it to a different file, then the import statement "`from sage.categories.category_singleton import FastHashable_class`" should result in a deprecation warning. How can this be achieved?



---

archive/issue_comments_166739.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nLet's test whether the safer use of callbacks for weak references to Homsets stored in a `TripleDict` from #14159 will fix the problem here.\n\nApply https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz",
    "created_at": "2013-02-25T12:06:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166739",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:34" align="right">comment:34</div>

Let's test whether the safer use of callbacks for weak references to Homsets stored in a `TripleDict` from #14159 will fix the problem here.

Apply https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz



---

archive/issue_comments_166740.json:
```json
{
    "body": "Changed dependencies from **#14017, #6495** to **#14017, #6495, #14159**",
    "created_at": "2013-02-25T12:06:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166740",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#14017, #6495** to **#14017, #6495, #14159**



---

archive/issue_comments_166741.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nPatchbot,\n\nApply trac14054_fast_methods-5.8.patch",
    "created_at": "2013-02-25T13:14:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166741",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:35" align="right">comment:35</div>

Patchbot,

Apply trac14054_fast_methods-5.8.patch



---

archive/issue_comments_166742.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nHooray, I can reproduce the assertion error (it only occurs with the patch from here)! So, that should make it possible to debug it.",
    "created_at": "2013-02-25T13:35:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166742",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:36" align="right">comment:36</div>

Hooray, I can reproduce the assertion error (it only occurs with the patch from here)! So, that should make it possible to debug it.



---

archive/issue_comments_166743.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@simon-king-jena](#comment%3A32):\n> Would you mind to just leave it in its original space (being an orphan, though)?\n> \n> Otherwise: How does one deprecate a class that has no init method?\n\nWhat I've done is turned the class into a function and have that function return the desired class after issuing the deprecation warning. I guess an alternative would be to implement a custom `__call__` which does the same as above.\n\nHow are you reproducing the assertion error?",
    "created_at": "2013-02-25T13:46:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166743",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@simon-king-jena](#comment%3A32):
> Would you mind to just leave it in its original space (being an orphan, though)?
> 
> Otherwise: How does one deprecate a class that has no init method?

What I've done is turned the class into a function and have that function return the desired class after issuing the deprecation warning. I guess an alternative would be to implement a custom `__call__` which does the same as above.

How are you reproducing the assertion error?



---

archive/issue_comments_166744.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@tscrim](#comment%3A37):\n> How are you reproducing the assertion error?\n\nBy running `./sage -t  -force_lib devel/sage/sage/combinat/free_module.py` with sage-5.8.beta0 plus #12313, #13387, #14159 and #14054.",
    "created_at": "2013-02-25T13:55:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166744",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@tscrim](#comment%3A37):
> How are you reproducing the assertion error?

By running `./sage -t  -force_lib devel/sage/sage/combinat/free_module.py` with sage-5.8.beta0 plus #12313, #13387, #14159 and #14054.



---

archive/issue_comments_166745.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nReplying to [@tscrim](#comment%3A37):\n> Replying to [@simon-king-jena](#comment%3A32):\n> What I've done is turned the class into a function and have that function return the desired class after issuing the deprecation warning.\n\n\nPerhaps like this:\n\n```\n            sage: from sage.misc.superseded import deprecated_function_alias\n            sage: g = deprecated_function_alias(13109, number_of_partitions)\n```",
    "created_at": "2013-02-25T13:58:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166745",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:39" align="right">comment:39</div>

Replying to [@tscrim](#comment%3A37):
> Replying to [@simon-king-jena](#comment%3A32):
> What I've done is turned the class into a function and have that function return the desired class after issuing the deprecation warning.


Perhaps like this:

```
            sage: from sage.misc.superseded import deprecated_function_alias
            sage: g = deprecated_function_alias(13109, number_of_partitions)
```



---

archive/issue_comments_166746.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nI hesitate to do things like\n\n```\nfrom sage.misc.superseded import deprecated_function_alias\nfrom sage.misc.fast_methods import FastFashable_class as FH_class\nFastHashable_class = deprecated_function_alias(14054,FH_class)\n```\nin sage.categories.category_singleton:\n\n- It adds an unneeded import statement\n- `FastHashable_class` is a base class, and hence one would like to inherit from it. But doing the above, `FastHashable_class` would not be a class but a function in sage.categories.category_singleton.\n- In its now deprecated use, it was necessary to *cimport* (not just import!) the class. That will be impossible, no matter what way of deprecation warning we use, because deprecation warnings won't work at compile time.\n\nIs there a \"lazy import statement with deprecation\"? Then, one would not actually import `FastHashable_class` in category_singleton, but `from sage.categories.category_singleton import FastHashable_class` would result in a deprecation warning. And we can't cope with the compile time cimport problem anyway.",
    "created_at": "2013-02-25T14:06:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166746",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:40" align="right">comment:40</div>

I hesitate to do things like

```
from sage.misc.superseded import deprecated_function_alias
from sage.misc.fast_methods import FastFashable_class as FH_class
FastHashable_class = deprecated_function_alias(14054,FH_class)
```
in sage.categories.category_singleton:

- It adds an unneeded import statement
- `FastHashable_class` is a base class, and hence one would like to inherit from it. But doing the above, `FastHashable_class` would not be a class but a function in sage.categories.category_singleton.
- In its now deprecated use, it was necessary to *cimport* (not just import!) the class. That will be impossible, no matter what way of deprecation warning we use, because deprecation warnings won't work at compile time.

Is there a "lazy import statement with deprecation"? Then, one would not actually import `FastHashable_class` in category_singleton, but `from sage.categories.category_singleton import FastHashable_class` would result in a deprecation warning. And we can't cope with the compile time cimport problem anyway.



---

archive/issue_comments_166747.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@simon-king-jena](#comment%3A39):\n> Perhaps like this:\n> \n> ```\n>             sage: from sage.misc.superseded import deprecated_function_alias\n>             sage: g = deprecated_function_alias(13109, number_of_partitions)\n> ```\n\nThat might work, but I haven't tried it (in principle, I don't see why it wouldn't). What I've done is like this:\n\n```\ndef DeprecatedClass(self, arg1, arg2, ..., *old_args, **old_kwds):\n    from sage.misc.superseded import deprecation\n    deprecation(14054, \"DepC is deprecated. Use path.to.new_mod.NewClass instead\")\n    # Do whatever needs to be done to convert to NewClass's inputs\n    from path.to.new_mod import NewClass\n    return NewClass(arg1, arg2, ..., *old_args, **old_kwds)\n```\nHowever that's a good point about the inheritance...perhaps something like\n\n```\nclass Dep(NewClass):\n    def __init__(self, arg1, arg2, ..., *args, **kwds):\n        from sage.misc.superseded import deprecation\n        deprecation(14054, \"DepC is deprecated. Use path.to.new_mod.NewClass instead\")\n        NewClass.__init__(self, arg1, arg2, ..., *args, **kwds)\n```\n?",
    "created_at": "2013-02-25T14:09:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166747",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@simon-king-jena](#comment%3A39):
> Perhaps like this:
> 
> ```
>             sage: from sage.misc.superseded import deprecated_function_alias
>             sage: g = deprecated_function_alias(13109, number_of_partitions)
> ```

That might work, but I haven't tried it (in principle, I don't see why it wouldn't). What I've done is like this:

```
def DeprecatedClass(self, arg1, arg2, ..., *old_args, **old_kwds):
    from sage.misc.superseded import deprecation
    deprecation(14054, "DepC is deprecated. Use path.to.new_mod.NewClass instead")
    # Do whatever needs to be done to convert to NewClass's inputs
    from path.to.new_mod import NewClass
    return NewClass(arg1, arg2, ..., *old_args, **old_kwds)
```
However that's a good point about the inheritance...perhaps something like

```
class Dep(NewClass):
    def __init__(self, arg1, arg2, ..., *args, **kwds):
        from sage.misc.superseded import deprecation
        deprecation(14054, "DepC is deprecated. Use path.to.new_mod.NewClass instead")
        NewClass.__init__(self, arg1, arg2, ..., *args, **kwds)
```
?



---

archive/issue_comments_166748.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@tscrim](#comment%3A41):\n> However that's a good point about the inheritance...perhaps something like\n> \n> ```\n> class Dep(NewClass):\n>     def __init__(self, arg1, arg2, ..., *args, **kwds):\n>         from sage.misc.superseded import deprecation\n>         deprecation(14054, \"DepC is deprecated. Use path.to.new_mod.NewClass instead\")\n>         NewClass.__init__(self, arg1, arg2, ..., *args, **kwds)\n> ```\n> ?\n\nWell, that would still mean that we need to actually import it.\n\nI am tempted to ask what sage-devel has to say about this issue.",
    "created_at": "2013-02-25T14:15:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166748",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@tscrim](#comment%3A41):
> However that's a good point about the inheritance...perhaps something like
> 
> ```
> class Dep(NewClass):
>     def __init__(self, arg1, arg2, ..., *args, **kwds):
>         from sage.misc.superseded import deprecation
>         deprecation(14054, "DepC is deprecated. Use path.to.new_mod.NewClass instead")
>         NewClass.__init__(self, arg1, arg2, ..., *args, **kwds)
> ```
> ?

Well, that would still mean that we need to actually import it.

I am tempted to ask what sage-devel has to say about this issue.



---

archive/issue_comments_166749.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@simon-king-jena](#comment%3A42):\n> Well, that would still mean that we need to actually import it.\n\nI thought if we turn it into a python class, we wouldn't need to cimport it and it would only be imported if the old class was actually used? (To me honest, part of me is still wondering if we even really need a deprecation warning since it is such a low-level base class.)\n\n> I am tempted to ask what sage-devel has to say about this issue.\n\nThat might be for the best.",
    "created_at": "2013-02-25T14:43:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166749",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@simon-king-jena](#comment%3A42):
> Well, that would still mean that we need to actually import it.

I thought if we turn it into a python class, we wouldn't need to cimport it and it would only be imported if the old class was actually used? (To me honest, part of me is still wondering if we even really need a deprecation warning since it is such a low-level base class.)

> I am tempted to ask what sage-devel has to say about this issue.

That might be for the best.



---

archive/issue_comments_166750.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@tscrim](#comment%3A43):\n> Replying to [@simon-king-jena](#comment%3A42):\n> > Well, that would still mean that we need to actually import it.\n\n> \n> I thought if we turn it into a python class, we wouldn't need to cimport it\n\nIts original use *requires* cimport. Namely, it had no `__init__`, and setting the hash value requires writing into the cdef attribute `_hash`, thus we need cimport. Now, I added an init method---hence, *now* an import is enough.\n\n> (To me honest, part of me is still wondering if we even really need a deprecation warning since it is \n> such a low-level base class.)\n\nSame here...",
    "created_at": "2013-02-25T14:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166750",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@tscrim](#comment%3A43):
> Replying to [@simon-king-jena](#comment%3A42):
> > Well, that would still mean that we need to actually import it.

> 
> I thought if we turn it into a python class, we wouldn't need to cimport it

Its original use *requires* cimport. Namely, it had no `__init__`, and setting the hash value requires writing into the cdef attribute `_hash`, thus we need cimport. Now, I added an init method---hence, *now* an import is enough.

> (To me honest, part of me is still wondering if we even really need a deprecation warning since it is 
> such a low-level base class.)

Same here...



---

archive/issue_comments_166751.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nBack to the failing assertion:\n\nBy inserting information on the mismatching parents, I find that indeed we get two distinct instances of the same parent `Free module generated by {1, 2, 3, 4} over Integer Ring`.\n\nSo, how is it possible to create these distinct instances? Aha! They have indeed been created in different ways. Namely, by printing the `_reduction` attribute that is set during classcall, I found that x.parent() is created with the arguments\n\n```\n(Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'y'})\n```\nbut self.domain() is created using\n\n```\n(Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'G'})\n```",
    "created_at": "2013-02-25T15:01:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166751",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:45" align="right">comment:45</div>

Back to the failing assertion:

By inserting information on the mismatching parents, I find that indeed we get two distinct instances of the same parent `Free module generated by {1, 2, 3, 4} over Integer Ring`.

So, how is it possible to create these distinct instances? Aha! They have indeed been created in different ways. Namely, by printing the `_reduction` attribute that is set during classcall, I found that x.parent() is created with the arguments

```
(Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'y'})
```
but self.domain() is created using

```
(Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'G'})
```



---

archive/issue_comments_166752.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@simon-king-jena](#comment%3A45):\n> \n> ```\n> (Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'y'})\n> ```\n> \n> ```\n> (Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'G'})\n> ```\n\nThat's astounding! There is no example in modules_with_basis.py which uses prefix 'y' or prefix 'G'. So, no idea where the two distinct but equal instances comes from.",
    "created_at": "2013-02-25T15:06:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166752",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@simon-king-jena](#comment%3A45):
> 
> ```
> (Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'y'})
> ```
> 
> ```
> (Integer Ring, {1, 2, 3, 4}), {'category': Category of modules with basis over Integer Ring, 'prefix': 'G'})
> ```

That's astounding! There is no example in modules_with_basis.py which uses prefix 'y' or prefix 'G'. So, no idea where the two distinct but equal instances comes from.



---

archive/issue_comments_166753.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nArgh, sorry for my preceding post. It would have been needed to look at sage/combinat/free_module.py, not at sage/categories/modules_with_basis.py, where the assertion error is raised.",
    "created_at": "2013-02-25T15:08:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166753",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:47" align="right">comment:47</div>

Argh, sorry for my preceding post. It would have been needed to look at sage/combinat/free_module.py, not at sage/categories/modules_with_basis.py, where the assertion error is raised.



---

archive/issue_comments_166754.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nWe have\n\n```\n        def _repr_term(self, term):\n            \"\"\"\n            TESTS::\n\n                sage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix=\"F\")\n                sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix=\"G\")\n                sage: f =   F.monomial(1) + 2 * F.monomial(2)\n                sage: g = 2*G.monomial(3) +     G.monomial(4)\n                sage: tensor([f, g]) # indirect doctest\n                2*F[1] # G[3] + F[1] # G[4] + 4*F[2] # G[3] + 2*F[2] # G[4]\n            \"\"\"\n```\nand \n\n```\n        def _latex_term(self, term):\n            \"\"\"\n            TESTS::\n\n                sage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix='x')\n                sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix='y')\n                sage: f =   F.monomial(1) + 2 * F.monomial(2)\n                sage: g = 2*G.monomial(3) +     G.monomial(4)\n                sage: latex(tensor([f, g])) # indirect doctest\n                2x_{1} \\otimes y_{3} + x_{1} \\otimes y_{4} + 4x_{2} \\otimes y_{3} + 2x_{2} \\otimes y_{4}\n            \"\"\"\n```\nApparently, this is where the two equal free modules generated by {1, 2, 3, 4} over Integer Ring with prefix 'G' respectively 'y' are defined.\n\nNow, I see what is happening.\n\nWe have two distinct but equal parents, and the tensor construction uses a strong cache (hence, has a side-effect across tests) using comparison by *equality*. But later, we want comparison by identity. Boom. I'll ask sage-combinat-devel for advice.",
    "created_at": "2013-02-25T15:15:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166754",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:48" align="right">comment:48</div>

We have

```
        def _repr_term(self, term):
            """
            TESTS::

                sage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix="F")
                sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix="G")
                sage: f =   F.monomial(1) + 2 * F.monomial(2)
                sage: g = 2*G.monomial(3) +     G.monomial(4)
                sage: tensor([f, g]) # indirect doctest
                2*F[1] # G[3] + F[1] # G[4] + 4*F[2] # G[3] + 2*F[2] # G[4]
            """
```
and 

```
        def _latex_term(self, term):
            """
            TESTS::

                sage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix='x')
                sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix='y')
                sage: f =   F.monomial(1) + 2 * F.monomial(2)
                sage: g = 2*G.monomial(3) +     G.monomial(4)
                sage: latex(tensor([f, g])) # indirect doctest
                2x_{1} \otimes y_{3} + x_{1} \otimes y_{4} + 4x_{2} \otimes y_{3} + 2x_{2} \otimes y_{4}
            """
```
Apparently, this is where the two equal free modules generated by {1, 2, 3, 4} over Integer Ring with prefix 'G' respectively 'y' are defined.

Now, I see what is happening.

We have two distinct but equal parents, and the tensor construction uses a strong cache (hence, has a side-effect across tests) using comparison by *equality*. But later, we want comparison by identity. Boom. I'll ask sage-combinat-devel for advice.



---

archive/issue_comments_166755.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nYessss! The following is *without* the patch. Hence, what we see here is an existing bug, that did not show up by mere coincidence (different ordering of the doctests)!!\n\nI can trigger it on the command line (with sage-5.6.rc0 without the patch from here):\n\n```\nsage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix=\"F\")\nsage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix=\"G\")\nsage: f =   F.monomial(1) + 2 * F.monomial(2)\nsage: g = 2*G.monomial(3) +     G.monomial(4)\nsage: tensor([f, g]) # indirect doctest\n2*F[1] # G[3] + F[1] # G[4] + 4*F[2] # G[3] + 2*F[2] # G[4]\nsage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix='x')\nsage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix='y')\nsage: f =   F.monomial(1) + 2 * F.monomial(2)\nsage: g = 2*G.monomial(3) +     G.monomial(4)\nsage: latex(tensor([f, g])) # indirect doctest\nTraceback (most recent call last):\n...\n/home/simon/SAGE/prerelease/sage-5.6.rc0/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in __call__(self, *args)\n   1385         after = args[self._position+1:len(args)]\n   1386         x = args[self._position]\n-> 1387         assert(x.parent() is self.domain())\n   1388 \n   1389         if self._is_module_with_basis_over_same_base_ring:\n\nAssertionError: \n```",
    "created_at": "2013-02-25T15:26:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166755",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:49" align="right">comment:49</div>

Yessss! The following is *without* the patch. Hence, what we see here is an existing bug, that did not show up by mere coincidence (different ordering of the doctests)!!

I can trigger it on the command line (with sage-5.6.rc0 without the patch from here):

```
sage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix="F")
sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix="G")
sage: f =   F.monomial(1) + 2 * F.monomial(2)
sage: g = 2*G.monomial(3) +     G.monomial(4)
sage: tensor([f, g]) # indirect doctest
2*F[1] # G[3] + F[1] # G[4] + 4*F[2] # G[3] + 2*F[2] # G[4]
sage: F = CombinatorialFreeModule(ZZ, [1,2,3], prefix='x')
sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix='y')
sage: f =   F.monomial(1) + 2 * F.monomial(2)
sage: g = 2*G.monomial(3) +     G.monomial(4)
sage: latex(tensor([f, g])) # indirect doctest
Traceback (most recent call last):
...
/home/simon/SAGE/prerelease/sage-5.6.rc0/local/lib/python2.7/site-packages/sage/categories/modules_with_basis.pyc in __call__(self, *args)
   1385         after = args[self._position+1:len(args)]
   1386         x = args[self._position]
-> 1387         assert(x.parent() is self.domain())
   1388 
   1389         if self._is_module_with_basis_over_same_base_ring:

AssertionError: 
```



---

archive/issue_comments_166756.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nSo then this ticket does not depend on #14159, correct?",
    "created_at": "2013-02-25T15:46:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166756",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:50" align="right">comment:50</div>

So then this ticket does not depend on #14159, correct?



---

archive/issue_comments_166757.json:
```json
{
    "body": "Work Issues: **Fix non-uniqueness trouble of combinatorial free modules**",
    "created_at": "2013-02-25T15:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166757",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Fix non-uniqueness trouble of combinatorial free modules**



---

archive/issue_comments_166758.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nReplying to [@tscrim](#comment%3A50):\n> So then this ticket does not depend on #14159, correct?\n\nCorrect (and corrected).",
    "created_at": "2013-02-25T15:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166758",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:51" align="right">comment:51</div>

Replying to [@tscrim](#comment%3A50):
> So then this ticket does not depend on #14159, correct?

Correct (and corrected).



---

archive/issue_comments_166759.json:
```json
{
    "body": "Changed dependencies from **#14017, #6495, #14159** to **#14017, #6495**",
    "created_at": "2013-02-25T15:48:16Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166759",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#14017, #6495, #14159** to **#14017, #6495**



---

archive/issue_events_195681.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-25T15:48:16Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195681"
}
```



---

archive/issue_events_195682.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-25T15:48:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195682"
}
```



---

archive/issue_comments_166760.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nBack to the deprecation: Volker Braun stated on [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ZsszjMSynmY): \"Deprecation is for user-visible functionality. No need to deprecate hash implementation details, otherwise it'll be total and immediate development standstill.\"\n\nSo, I think no deprecation for removing `FastHashable_class` should  be needed.",
    "created_at": "2013-02-25T20:17:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166760",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:52" align="right">comment:52</div>

Back to the deprecation: Volker Braun stated on [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ZsszjMSynmY): "Deprecation is for user-visible functionality. No need to deprecate hash implementation details, otherwise it'll be total and immediate development standstill."

So, I think no deprecation for removing `FastHashable_class` should  be needed.



---

archive/issue_comments_166761.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nAlright. It's good to know exactly when we don't need a deprecation.",
    "created_at": "2013-02-25T20:24:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166761",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:53" align="right">comment:53</div>

Alright. It's good to know exactly when we don't need a deprecation.



---

archive/issue_comments_166762.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nI found:\n\n- Before this patch, `CombinatorialFreeModule` did inherit from `UniqueRepresentation`, but destroyed the uniqueness property.\n- With my changes to `UniqueRepresentation`, `CombinatorialFreeModule` behaves as follows, *if* one keeps inheriting from `UniqueRepresentation`:\n\n  ```\n  sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix=\"G\")\n  sage: y = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix='y')\n  sage: G is y\n  False\n  sage: G == y\n  False\n  sage: G <= y\n  True\n  sage: y <= G\n  True\n  ```\n  Hence, while the uniqueness of the old `UniqueRepresentation` was destroyed, it is preserved in the new version.\n- Since uniqueness is preserved, the bug exposed in [comment:49](#comment%3A49) has actually been fixed!\n- However, since I wanted to preserve the old behaviour, I made `CombinatorialFreeModule` inherit from `CachedRepresentation`, not from `UniqueRepresentation`. In this way, the original bug was re-established. And since by coincidence the order of tests changed, the bug surfaced.\n\nI am now trying if anything breaks if one returns to the old layout of `CombinatorialFreeModule`.",
    "created_at": "2013-02-25T20:46:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166762",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:54" align="right">comment:54</div>

I found:

- Before this patch, `CombinatorialFreeModule` did inherit from `UniqueRepresentation`, but destroyed the uniqueness property.
- With my changes to `UniqueRepresentation`, `CombinatorialFreeModule` behaves as follows, *if* one keeps inheriting from `UniqueRepresentation`:

  ```
  sage: G = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix="G")
  sage: y = CombinatorialFreeModule(ZZ, [1,2,3,4], prefix='y')
  sage: G is y
  False
  sage: G == y
  False
  sage: G <= y
  True
  sage: y <= G
  True
  ```
  Hence, while the uniqueness of the old `UniqueRepresentation` was destroyed, it is preserved in the new version.
- Since uniqueness is preserved, the bug exposed in [comment:49](#comment%3A49) has actually been fixed!
- However, since I wanted to preserve the old behaviour, I made `CombinatorialFreeModule` inherit from `CachedRepresentation`, not from `UniqueRepresentation`. In this way, the original bug was re-established. And since by coincidence the order of tests changed, the bug surfaced.

I am now trying if anything breaks if one returns to the old layout of `CombinatorialFreeModule`.



---

archive/issue_comments_166763.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nVery minor nitpick: I think providing `<=` and `>=` even for identical inputs is not quite the correct thing to do. Python has objects for which those are false or for which those raise an exception:\n\n```\nsage: a=float('NaN')\nsage: a <= a\nFalse\nsage: b=complex(1,2)\nsage: b<=b\nTypeError: no ordering relation is defined for complex numbers\n```\nIn python 3 this is even the default:\n\n```\nPython 3.2.3 (default, Jun  8 2012, 05:40:07) \n[GCC 4.6.3 20120306 (Red Hat 4.6.3-2)] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> a=object()\n>>> a<=a\nTypeError: unorderable types: object() <= object()\n>>> a==a\nTrue\n>>> a is a\nTrue\n```\nI think not providing `(a <= a) == True` for `UniqueRepresentation` is less likely to cause surprises in the future.",
    "created_at": "2013-02-25T21:01:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166763",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:55" align="right">comment:55</div>

Very minor nitpick: I think providing `<=` and `>=` even for identical inputs is not quite the correct thing to do. Python has objects for which those are false or for which those raise an exception:

```
sage: a=float('NaN')
sage: a <= a
False
sage: b=complex(1,2)
sage: b<=b
TypeError: no ordering relation is defined for complex numbers
```
In python 3 this is even the default:

```
Python 3.2.3 (default, Jun  8 2012, 05:40:07) 
[GCC 4.6.3 20120306 (Red Hat 4.6.3-2)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> a=object()
>>> a<=a
TypeError: unorderable types: object() <= object()
>>> a==a
True
>>> a is a
True
```
I think not providing `(a <= a) == True` for `UniqueRepresentation` is less likely to cause surprises in the future.



---

archive/issue_comments_166764.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@nbruin](#comment%3A55):\n> I think not providing `(a <= a) == True` for `UniqueRepresentation` is less likely to cause surprises in the future.\n\nOK, this should be the next thing I'll test.",
    "created_at": "2013-02-25T21:06:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166764",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@nbruin](#comment%3A55):
> I think not providing `(a <= a) == True` for `UniqueRepresentation` is less likely to cause surprises in the future.

OK, this should be the next thing I'll test.



---

archive/issue_comments_166765.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nUsing `UniqueRepresentation` on `CombinatorialFreeModule` works mostly fine. There were only some error in tests that were testing the *absence* of the unique parent condition (so, these are tests against behaviour I would like to fix!), and also there was some error in my new coercion tutorial.",
    "created_at": "2013-02-26T00:08:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166765",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:57" align="right">comment:57</div>

Using `UniqueRepresentation` on `CombinatorialFreeModule` works mostly fine. There were only some error in tests that were testing the *absence* of the unique parent condition (so, these are tests against behaviour I would like to fix!), and also there was some error in my new coercion tutorial.



---

archive/issue_events_195683.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-26T12:04:10Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195683"
}
```



---

archive/issue_events_195684.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-02-26T12:04:10Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195684"
}
```



---

archive/issue_comments_166766.json:
```json
{
    "body": "Changed dependencies from **#14017, #6495** to **#14017, #6495, #14182**",
    "created_at": "2013-02-26T12:04:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166766",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#14017, #6495** to **#14017, #6495, #14182**



---

archive/issue_comments_166767.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nI think I fixed all the remaining issues. This includes a fix to my recently added coercion tutorial (the number of inherited methods in two examples changes).\n\nConcerning combinatorial free modules: They used to violate the unique parent condition, even though they inherited from `UniqueRepresentation`. I have demonstrated that this was a bug, when combining the failure to be unique with a cache on the tensor product construction. It is automatically fixed with the changes to `UniqueRepresentation` introduced in this patch, and gave rise to a new doctest.\n\nNeeds review!\n\nApply trac14054_fast_methods-5.8.patch",
    "created_at": "2013-02-26T12:04:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166767",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:58" align="right">comment:58</div>

I think I fixed all the remaining issues. This includes a fix to my recently added coercion tutorial (the number of inherited methods in two examples changes).

Concerning combinatorial free modules: They used to violate the unique parent condition, even though they inherited from `UniqueRepresentation`. I have demonstrated that this was a bug, when combining the failure to be unique with a cache on the tensor product construction. It is automatically fixed with the changes to `UniqueRepresentation` introduced in this patch, and gave rise to a new doctest.

Needs review!

Apply trac14054_fast_methods-5.8.patch



---

archive/issue_comments_166768.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nPS: The new dependency #14182 is because of the change to the coercion tutorial.\n\nApply trac14054_fast_methods-5.8.patch",
    "created_at": "2013-02-26T12:05:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166768",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:59" align="right">comment:59</div>

PS: The new dependency #14182 is because of the change to the coercion tutorial.

Apply trac14054_fast_methods-5.8.patch



---

archive/issue_comments_166769.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nLooks good to me now.\n\nThank you Simon,\n\nTravis",
    "created_at": "2013-02-26T17:32:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166769",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:60" align="right">comment:60</div>

Looks good to me now.

Thank you Simon,

Travis



---

archive/issue_events_195685.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-02-26T17:32:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195685"
}
```



---

archive/issue_events_195686.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-02-26T17:32:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195686"
}
```



---

archive/issue_comments_166770.json:
```json
{
    "body": "Changed work issues from **Fix non-uniqueness trouble of combinatorial free modules** to none",
    "created_at": "2013-02-26T17:33:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166770",
    "user": "https://github.com/tscrim"
}
```

Changed work issues from **Fix non-uniqueness trouble of combinatorial free modules** to none



---

archive/issue_comments_166771.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nThis should be rebased to #14040.",
    "created_at": "2013-02-28T10:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166771",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:62" align="right">comment:62</div>

This should be rebased to #14040.



---

archive/issue_comments_166772.json:
```json
{
    "body": "Changed dependencies from **#14017, #6495, #14182** to **#14017, #6495, #14182, #14040**",
    "created_at": "2013-02-28T10:49:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166772",
    "user": "https://github.com/jdemeyer"
}
```

Changed dependencies from **#14017, #6495, #14182** to **#14017, #6495, #14182, #14040**



---

archive/issue_comments_166773.json:
```json
{
    "body": "Attachment: **[trac14054_fast_methods-5.8.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)**\n\nSeparate cache and uniqueness. Rel #6495 and #14040",
    "created_at": "2013-02-28T12:13:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166773",
    "user": "https://github.com/simon-king-jena"
}
```

Attachment: **[trac14054_fast_methods-5.8.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)**

Separate cache and uniqueness. Rel #6495 and #14040



---

archive/issue_comments_166774.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nDone. I only needed to change the expected result for one example in the coercion tutorial: The number of available methods for matrix spaces changes with #14040.",
    "created_at": "2013-02-28T12:15:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166774",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:63" align="right">comment:63</div>

Done. I only needed to change the expected result for one example in the coercion tutorial: The number of available methods for matrix spaces changes with #14040.



---

archive/issue_comments_166775.json:
```json
{
    "body": "Merged: **sage-5.8.beta3**",
    "created_at": "2013-03-04T07:36:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166775",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.8.beta3**



---

archive/issue_events_195687.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-04T07:36:26Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195687"
}
```



---

archive/issue_events_195688.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-04T07:36:26Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195688"
}
```



---

archive/issue_comments_166776.json:
```json
{
    "body": "Changed merged from **sage-5.8.beta3** to none",
    "created_at": "2013-03-05T10:55:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166776",
    "user": "https://github.com/jdemeyer"
}
```

Changed merged from **sage-5.8.beta3** to none



---

archive/issue_events_195689.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-05T10:55:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195689"
}
```



---

archive/issue_events_195690.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-05T10:55:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195690"
}
```



---

archive/issue_comments_166777.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nThis causes a doctest failure on Solaris SPARC 32-bit (Skynet machine `mark`):\n\n```\nsage -t  --long -force_lib devel/sage/sage/combinat/rigged_configurations/rigged_configurations.py\n**********************************************************************\nFile \"/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.8.beta3/devel/sage-main/sage/combinat/rigged_configurations/rigged_configurations.py\", line 48:\n    sage: RC.list()\nExpected:\n    [\n    (/)\n    <BLANKLINE>\n    (/)\n    <BLANKLINE>\n    (/)\n    ,\n    (/)\n    <BLANKLINE>\n    -1[ ]-1\n    <BLANKLINE>\n    (/)\n    ,\n    (/)\n    <BLANKLINE>\n    0[ ]0\n    <BLANKLINE>\n    -1[ ]-1\n    ,\n    -1[ ]-1\n    <BLANKLINE>\n    0[ ]0\n    <BLANKLINE>\n    (/)\n    ,\n    -1[ ]-1\n    <BLANKLINE>\n    1[ ]1\n    <BLANKLINE>\n    -1[ ]-1\n    ,\n    0[ ]0\n    <BLANKLINE>\n    -1[ ]-1\n    -1[ ]-1\n    <BLANKLINE>\n    0[ ]0\n    ]\nGot:\n    [\n    (/)\n    <BLANKLINE>\n    (/)\n    <BLANKLINE>\n    (/)\n    , \n    (/)\n    <BLANKLINE>\n    -1[ ]-1\n    <BLANKLINE>\n    (/)\n    , \n    -1[ ]-1\n    <BLANKLINE>\n    0[ ]0\n    <BLANKLINE>\n    (/)\n    , \n    -1[ ]-1\n    <BLANKLINE>\n    1[ ]1\n    <BLANKLINE>\n    -1[ ]-1\n    , \n    (/)\n    <BLANKLINE>\n    0[ ]0\n    <BLANKLINE>\n    -1[ ]-1\n    , \n    0[ ]0\n    <BLANKLINE>\n    -1[ ]-1\n    -1[ ]-1\n    <BLANKLINE>\n    0[ ]0\n    ]\n**********************************************************************\n```",
    "created_at": "2013-03-05T10:55:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166777",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:65" align="right">comment:65</div>

This causes a doctest failure on Solaris SPARC 32-bit (Skynet machine `mark`):

```
sage -t  --long -force_lib devel/sage/sage/combinat/rigged_configurations/rigged_configurations.py
**********************************************************************
File "/home/buildbot/build/sage/mark-1/mark_full/build/sage-5.8.beta3/devel/sage-main/sage/combinat/rigged_configurations/rigged_configurations.py", line 48:
    sage: RC.list()
Expected:
    [
    (/)
    <BLANKLINE>
    (/)
    <BLANKLINE>
    (/)
    ,
    (/)
    <BLANKLINE>
    -1[ ]-1
    <BLANKLINE>
    (/)
    ,
    (/)
    <BLANKLINE>
    0[ ]0
    <BLANKLINE>
    -1[ ]-1
    ,
    -1[ ]-1
    <BLANKLINE>
    0[ ]0
    <BLANKLINE>
    (/)
    ,
    -1[ ]-1
    <BLANKLINE>
    1[ ]1
    <BLANKLINE>
    -1[ ]-1
    ,
    0[ ]0
    <BLANKLINE>
    -1[ ]-1
    -1[ ]-1
    <BLANKLINE>
    0[ ]0
    ]
Got:
    [
    (/)
    <BLANKLINE>
    (/)
    <BLANKLINE>
    (/)
    , 
    (/)
    <BLANKLINE>
    -1[ ]-1
    <BLANKLINE>
    (/)
    , 
    -1[ ]-1
    <BLANKLINE>
    0[ ]0
    <BLANKLINE>
    (/)
    , 
    -1[ ]-1
    <BLANKLINE>
    1[ ]1
    <BLANKLINE>
    -1[ ]-1
    , 
    (/)
    <BLANKLINE>
    0[ ]0
    <BLANKLINE>
    -1[ ]-1
    , 
    0[ ]0
    <BLANKLINE>
    -1[ ]-1
    -1[ ]-1
    <BLANKLINE>
    0[ ]0
    ]
**********************************************************************
```



---

archive/issue_events_195691.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-05T10:55:03Z",
    "event": "reopened",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195691"
}
```



---

archive/issue_comments_166778.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nOK. Since the list is not sorted, I guess the cleanest solution is to test against `sorted(RC.list())`.",
    "created_at": "2013-03-05T11:48:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166778",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:66" align="right">comment:66</div>

OK. Since the list is not sorted, I guess the cleanest solution is to test against `sorted(RC.list())`.



---

archive/issue_events_195692.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-03-05T11:56:33Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "milestone_number": null,
    "milestone_title": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195692"
}
```



---

archive/issue_events_195693.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-03-05T11:56:33Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "milestone_number": null,
    "milestone_title": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195693"
}
```



---

archive/issue_comments_166779.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,3 +13,4 @@\n __Apply__\n \n - [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)\n+- [attachment: trac_14054-fix-rigged-list.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.patch.gz)\n``````\n",
    "created_at": "2013-03-05T11:56:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166779",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,3 +13,4 @@
 __Apply__
 
 - [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)
+- [attachment: trac_14054-fix-rigged-list.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.patch.gz)
``````




---

archive/issue_comments_166780.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nCan this really not go into 5.8, if the tests pass with the second patch?\n\nApply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.patch",
    "created_at": "2013-03-05T11:56:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166780",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:67" align="right">comment:67</div>

Can this really not go into 5.8, if the tests pass with the second patch?

Apply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.patch



---

archive/issue_events_195694.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-03-05T11:56:33Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195694"
}
```



---

archive/issue_comments_166781.json:
```json
{
    "body": "Sort output of RiggedConfigurations.list(), to make it reproducible on different machines",
    "created_at": "2013-03-05T13:12:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166781",
    "user": "https://github.com/jdemeyer"
}
```

Sort output of RiggedConfigurations.list(), to make it reproducible on different machines



---

archive/issue_comments_166782.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nAttachment: **[trac_14054-fix-rigged-list.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.patch.gz)**\n\nTrivial rebase to #14011.",
    "created_at": "2013-03-05T13:12:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166782",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:68" align="right">comment:68</div>

Attachment: **[trac_14054-fix-rigged-list.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.patch.gz)**

Trivial rebase to #14011.



---

archive/issue_comments_166783.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nNow that is strange. With the sorted output, one gets another error, this time on several patchbots. \n\nIt seems that I messed up something. Try to fix it now...",
    "created_at": "2013-03-05T14:52:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166783",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:69" align="right">comment:69</div>

Now that is strange. With the sorted output, one gets another error, this time on several patchbots. 

It seems that I messed up something. Try to fix it now...



---

archive/issue_comments_166784.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nFWIW I also get the same error as the patchbot.",
    "created_at": "2013-03-05T14:53:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166784",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:70" align="right">comment:70</div>

FWIW I also get the same error as the patchbot.



---

archive/issue_comments_166785.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,4 +13,4 @@\n __Apply__\n \n - [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)\n-- [attachment: trac_14054-fix-rigged-list.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.patch.gz)\n+- [attachment: trac_14054-fix-rigged-list.2.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.2.patch.gz)\n``````\n",
    "created_at": "2013-03-05T14:59:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166785",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,4 +13,4 @@
 __Apply__
 
 - [attachment: trac14054_fast_methods-5.8.patch](https://github.com/sagemath/sage/files/ticket14054/trac14054_fast_methods-5.8.patch.gz)
-- [attachment: trac_14054-fix-rigged-list.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.patch.gz)
+- [attachment: trac_14054-fix-rigged-list.2.patch](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.2.patch.gz)
``````




---

archive/issue_comments_166786.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nNow it should work<sup>(T)</sup>.\n\nApply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch",
    "created_at": "2013-03-05T14:59:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166786",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:71" align="right">comment:71</div>

Now it should work<sup>(T)</sup>.

Apply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch



---

archive/issue_comments_166787.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nThis fails to apply for me:\n\n```\npatching file sage/combinat/rigged_configurations/rigged_configurations.py\nHunk #3 FAILED at 930\n1 out of 3 hunks FAILED -- saving rejects to file sage/combinat/rigged_configurations/rigged_configurations.py.rej\npatch failed, unable to continue (try -v)\npatch failed, rejects left in working dir\nerrors during apply, please fix and refresh trac_14054-fix-rigged-list.patch\n```",
    "created_at": "2013-03-05T15:06:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166787",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:72" align="right">comment:72</div>

This fails to apply for me:

```
patching file sage/combinat/rigged_configurations/rigged_configurations.py
Hunk #3 FAILED at 930
1 out of 3 hunks FAILED -- saving rejects to file sage/combinat/rigged_configurations/rigged_configurations.py.rej
patch failed, unable to continue (try -v)
patch failed, rejects left in working dir
errors during apply, please fix and refresh trac_14054-fix-rigged-list.patch
```



---

archive/issue_comments_166788.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nArgh. Jeroen forgot to update the list of dependencies, it seems.",
    "created_at": "2013-03-05T15:21:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166788",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:73" align="right">comment:73</div>

Argh. Jeroen forgot to update the list of dependencies, it seems.



---

archive/issue_comments_166789.json:
```json
{
    "body": "Changed dependencies from **#14017, #6495, #14182, #14040** to **#14017, #6495, #14182, #14040, #14011**",
    "created_at": "2013-03-05T15:21:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166789",
    "user": "https://github.com/simon-king-jena"
}
```

Changed dependencies from **#14017, #6495, #14182, #14040** to **#14017, #6495, #14182, #14040, #14011**



---

archive/issue_comments_166790.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nRebasing really has been trivial. The error was about a missing newline at the end of the file...\n\nApply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch",
    "created_at": "2013-03-05T15:24:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166790",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:74" align="right">comment:74</div>

Rebasing really has been trivial. The error was about a missing newline at the end of the file...

Apply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch



---

archive/issue_comments_166791.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nNote that the tests in rigged_configurations do pass for me, with\n\n```\ntrac11490-coercion_tutorial.patch\n14182_whitespace.patch\ntrac_13618-rings_doc_real-ts.patch\ntrac_13618-rings_doc_complex-ts.patch\ntrac_13618-rings_doc_others-ts.patch\ntrac_14040_housekeeping.patch\ntrac_14040_repr_option.patch\ntrac_14040_doctest.patch\ntrac_14040_review.patch\ntrac14054_fast_methods-5.8.patch\ntrac_12313-mono_dict-combined-random-sk.patch\ntrac_13387-combined.patch\ntrac_13387-guard_gc.patch\ntrac_14159_weak_value_triple_dict.patch\ntrac_14159_use_cdef_get.patch\ntrac12951_cached_extension.patch\ntrac_14214-cython_homset.patch\ntrac_14214-backup_cache.patch\ntrac_14063-remove_cc_compositions-ts.patch\ntrac_13688-finite_sets_cardinality_override-ts.patch\ntrac_14138.patch\ntrac_14138-doctests.patch\ntrac_13605-partition_options-ts.patch\ntrac_14011-Sphinx_roles-fh.patch\ntrac_14054-fix-rigged-list.2.patch\n```\napplied on top of sage-5.8.beta0. But they fail if I have some more patches applied.\n\nIn other words, I get the impression that sorting of the output of `RiggedConfigurations.list()` is broken.",
    "created_at": "2013-03-05T15:28:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166791",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:75" align="right">comment:75</div>

Note that the tests in rigged_configurations do pass for me, with

```
trac11490-coercion_tutorial.patch
14182_whitespace.patch
trac_13618-rings_doc_real-ts.patch
trac_13618-rings_doc_complex-ts.patch
trac_13618-rings_doc_others-ts.patch
trac_14040_housekeeping.patch
trac_14040_repr_option.patch
trac_14040_doctest.patch
trac_14040_review.patch
trac14054_fast_methods-5.8.patch
trac_12313-mono_dict-combined-random-sk.patch
trac_13387-combined.patch
trac_13387-guard_gc.patch
trac_14159_weak_value_triple_dict.patch
trac_14159_use_cdef_get.patch
trac12951_cached_extension.patch
trac_14214-cython_homset.patch
trac_14214-backup_cache.patch
trac_14063-remove_cc_compositions-ts.patch
trac_13688-finite_sets_cardinality_override-ts.patch
trac_14138.patch
trac_14138-doctests.patch
trac_13605-partition_options-ts.patch
trac_14011-Sphinx_roles-fh.patch
trac_14054-fix-rigged-list.2.patch
```
applied on top of sage-5.8.beta0. But they fail if I have some more patches applied.

In other words, I get the impression that sorting of the output of `RiggedConfigurations.list()` is broken.



---

archive/issue_comments_166792.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nArrgh. Can it be that `sage.combinat.rigged_configurations.rigged_configuration_element.RiggedConfigurationElement` has no sorting implemented? Travis, you are the author. How can one implement comparison of these things?\n\nJeroen, what can we do, since apparently sorting the output is not available here? I would say that it is not the fault (for a reasonable definition of \"fault\") of my patch that the test in rigged_configurations is unstable.",
    "created_at": "2013-03-05T15:33:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166792",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:76" align="right">comment:76</div>

Arrgh. Can it be that `sage.combinat.rigged_configurations.rigged_configuration_element.RiggedConfigurationElement` has no sorting implemented? Travis, you are the author. How can one implement comparison of these things?

Jeroen, what can we do, since apparently sorting the output is not available here? I would say that it is not the fault (for a reasonable definition of "fault") of my patch that the test in rigged_configurations is unstable.



---

archive/issue_comments_166793.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nWould it be better to give them an (somewhat unnatural) ordering or to change the doctest? \n\nActually...why not just make it `#random` with a note saying the output order can be random since there is no ordering?",
    "created_at": "2013-03-05T15:41:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166793",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:77" align="right">comment:77</div>

Would it be better to give them an (somewhat unnatural) ordering or to change the doctest? 

Actually...why not just make it `#random` with a note saying the output order can be random since there is no ordering?



---

archive/issue_comments_166794.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nReplying to [@simon-king-jena](#comment%3A76):\n> I would say that it is not the fault (for a reasonable definition of \"fault\") of my patch that the test in rigged_configurations is unstable.\n\nTrue, but with doctests there is no alternative but to shoot the messenger (i.e. the person adding the patch causing the doctest failure always gets the blame)",
    "created_at": "2013-03-05T15:48:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166794",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:78" align="right">comment:78</div>

Replying to [@simon-king-jena](#comment%3A76):
> I would say that it is not the fault (for a reasonable definition of "fault") of my patch that the test in rigged_configurations is unstable.

True, but with doctests there is no alternative but to shoot the messenger (i.e. the person adding the patch causing the doctest failure always gets the blame)



---

archive/issue_comments_166795.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nReplying to [@tscrim](#comment%3A77):\n> Would it be better to give them an (somewhat unnatural) ordering or to change the doctest? \n> \n> Actually...why not just make it `#random` with a note saying the output order can be random since there is no ordering?\n\nI would be fine with making it random, *and* test that the length of the output (or another easy invariant) is correct.\n\nIs there a mathematically meaningful ordering? From the code, I guess that rigged configuration elements rely on list of tableaus, and if the tableaus can be ordered then one might have some kind of lexicographical ordering, perhaps. But this should be on a different ticket (and perhaps would not make sense at all), so that I would prefer to change the test.\n\nJeroen, what is your opinion on that matter?",
    "created_at": "2013-03-05T15:49:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166795",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:79" align="right">comment:79</div>

Replying to [@tscrim](#comment%3A77):
> Would it be better to give them an (somewhat unnatural) ordering or to change the doctest? 
> 
> Actually...why not just make it `#random` with a note saying the output order can be random since there is no ordering?

I would be fine with making it random, *and* test that the length of the output (or another easy invariant) is correct.

Is there a mathematically meaningful ordering? From the code, I guess that rigged configuration elements rely on list of tableaus, and if the tableaus can be ordered then one might have some kind of lexicographical ordering, perhaps. But this should be on a different ticket (and perhaps would not make sense at all), so that I would prefer to change the test.

Jeroen, what is your opinion on that matter?



---

archive/issue_comments_166796.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nThankfully I'm here to take the bullet. :P\n\nI don't know of any mathematical meaning of sorting rigged configurations. I don't think there is one...\n\nThe reason why there's different (unsorted) outputs is because at the backend of the iterator in `TransitiveIdeal`, there is a (python) `set` working. If this is changed to a list, there should be no real loss of speed, but the iteration should be completely consistent across all machines (and for anything else which uses `TransitiveIdeal` for iteration and does not have a valid sorting).",
    "created_at": "2013-03-05T15:53:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166796",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:80" align="right">comment:80</div>

Thankfully I'm here to take the bullet. :P

I don't know of any mathematical meaning of sorting rigged configurations. I don't think there is one...

The reason why there's different (unsorted) outputs is because at the backend of the iterator in `TransitiveIdeal`, there is a (python) `set` working. If this is changed to a list, there should be no real loss of speed, but the iteration should be completely consistent across all machines (and for anything else which uses `TransitiveIdeal` for iteration and does not have a valid sorting).



---

archive/issue_comments_166797.json:
```json
{
    "body": "Mark output of `RiggedConfigurations.list()` random and test against cardinality, to make it reproducible on different machines.",
    "created_at": "2013-03-05T15:54:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166797",
    "user": "https://github.com/simon-king-jena"
}
```

Mark output of `RiggedConfigurations.list()` random and test against cardinality, to make it reproducible on different machines.



---

archive/issue_comments_166798.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nAttachment: **[trac_14054-fix-rigged-list.2.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.2.patch.gz)**\n\nI have updated the patch, marking the test random and testing that the length of the list coincides with the cardinality.\n\nApply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch",
    "created_at": "2013-03-05T15:55:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166798",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:81" align="right">comment:81</div>

Attachment: **[trac_14054-fix-rigged-list.2.patch.gz](https://github.com/sagemath/sage/files/ticket14054/trac_14054-fix-rigged-list.2.patch.gz)**

I have updated the patch, marking the test random and testing that the length of the list coincides with the cardinality.

Apply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch



---

archive/issue_comments_166799.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\nPS: With the new patch, the tests will also pass (for me, at least) when I apply the remaining patches in my queue...",
    "created_at": "2013-03-05T15:56:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166799",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:82" align="right">comment:82</div>

PS: With the new patch, the tests will also pass (for me, at least) when I apply the remaining patches in my queue...



---

archive/issue_events_195695.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-03-05T18:05:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195695"
}
```



---

archive/issue_events_195696.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-03-05T18:05:18Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195696"
}
```



---

archive/issue_comments_166800.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nEverything looks good to me as well. I don't know why the patchbot just timed-out so I gave it a kick.\n\nFor patchbot:\n\nApply: trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch",
    "created_at": "2013-03-05T18:05:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166800",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:83" align="right">comment:83</div>

Everything looks good to me as well. I don't know why the patchbot just timed-out so I gave it a kick.

For patchbot:

Apply: trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch



---

archive/issue_comments_166801.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">comment:84</div>\n\nHooray, and the patchbot doesn't complain either, except for the fact that a new module is loaded during start-up. But this can hardly be avoided in this case, and the patchbot does not observe the slightest increase in startup time :-)",
    "created_at": "2013-03-05T18:27:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166801",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:84" align="right">comment:84</div>

Hooray, and the patchbot doesn't complain either, except for the fact that a new module is loaded during start-up. But this can hardly be avoided in this case, and the patchbot does not observe the slightest increase in startup time :-)



---

archive/issue_comments_166802.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nReplying to [@simon-king-jena](#comment%3A81):\n> I have updated the patch, marking the test random and testing that the length of the list coincides with the cardinality.\n> \n> Apply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch \n\nJust for the record: in similar situations, I occasionally used the following idiom:\n\n    sage: sorted(..., key=str)\n    ...\n\nWhich makes the output deterministic (well, assumming repr is ...) even if there is no natural total ordering on the objects to be sorted.",
    "created_at": "2013-03-06T04:23:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166802",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:85" align="right">comment:85</div>

Replying to [@simon-king-jena](#comment%3A81):
> I have updated the patch, marking the test random and testing that the length of the list coincides with the cardinality.
> 
> Apply trac14054_fast_methods-5.8.patch trac_14054-fix-rigged-list.2.patch 

Just for the record: in similar situations, I occasionally used the following idiom:

    sage: sorted(..., key=str)
    ...

Which makes the output deterministic (well, assumming repr is ...) even if there is no natural total ordering on the objects to be sorted.



---

archive/issue_comments_166803.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nI forgot to say: great job getting this done! Thanks!",
    "created_at": "2013-03-06T04:34:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166803",
    "user": "https://github.com/nthiery"
}
```

<div id="comment:86" align="right">comment:86</div>

I forgot to say: great job getting this done! Thanks!



---

archive/issue_comments_166804.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nReplying to [@simon-king-jena](#comment%3A67):\n> Can this really not go into 5.8, if the tests pass with the second patch?\n\nWell, it didn't pass tests :-)\n\nBut seriously: is there any particular reason this patch should be in sage-5.8? I'd rather not take the risk and postpone it for sage-5.9.beta0.",
    "created_at": "2013-03-06T10:33:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166804",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:87" align="right">comment:87</div>

Replying to [@simon-king-jena](#comment%3A67):
> Can this really not go into 5.8, if the tests pass with the second patch?

Well, it didn't pass tests :-)

But seriously: is there any particular reason this patch should be in sage-5.8? I'd rather not take the risk and postpone it for sage-5.9.beta0.



---

archive/issue_comments_166805.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">comment:88</div>\n\nReplying to [@jdemeyer](#comment%3A87):\n> Replying to [@simon-king-jena](#comment%3A67):\n> > Can this really not go into 5.8, if the tests pass with the second patch?\n\n> Well, it didn't pass tests :-)\n\nWell, it *does*, with the current version of the second patch.",
    "created_at": "2013-03-06T10:57:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166805",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:88" align="right">comment:88</div>

Replying to [@jdemeyer](#comment%3A87):
> Replying to [@simon-king-jena](#comment%3A67):
> > Can this really not go into 5.8, if the tests pass with the second patch?

> Well, it didn't pass tests :-)

Well, it *does*, with the current version of the second patch.



---

archive/issue_comments_166806.json:
```json
{
    "body": "Merged: **sage-5.8.beta4**",
    "created_at": "2013-03-07T18:26:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14054#issuecomment-166806",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.8.beta4**



---

archive/issue_events_195697.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T18:26:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195697"
}
```



---

archive/issue_events_195698.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-03-07T18:26:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14054",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14054#event-195698"
}
```
