# Issue 14022: Get scipy fortran objects be built with -fPIC again

archive/issues_013818.json:
```json
{
    "body": "Assignee: tbd\n\nThis is a follow up to #13985. After that ticket was merged FC/F90/F77 are not set to something that includes -fPIC. This leads to problems like the one reported by Stephen Montgomery-Smith working on the BSD port.\n\n```\n/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/bin/gfortran\n-Wall -shared\n-Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib\n-Wl,-rpath=/usr/local/lib/gcc46\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/_fftpackmodule.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zfft.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/drfft.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zrfft.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zfftnd.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/dct.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/dst.o\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/fortranobject.o\n-L/usr/local/lib/gcc46/gcc/x86_64-portbld-freebsd8.3/4.6.3\n-Lbuild/temp.freebsd-8.3-STABLE-amd64-2.7 -ldfftpack -lfftpack\n-lpython2.7 -lgfortran -o\nbuild/lib.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/_fftpack.so\n/usr/local/bin/ld:\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a(dffti1.o):\nrelocation R_X86_64_32S against `.rodata' can not be used when making a\nshared object; recompile with -fPIC\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a: could not read\nsymbols: Bad value\ncollect2: ld returned 1 exit status\n/usr/local/bin/ld:\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a(dffti1.o):\nrelocation R_X86_64_32S against `.rodata' can not be used when making a\nshared object; recompile with -fPIC\nbuild/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a: could not read\nsymbols: Bad value\ncollect2: ld returned 1 exit status\n```\n\n{F,FC}FLAGS should be set to append \"-fPIC\" when compiling scipy.\n\n* new spkg:\n[http://spkg-upload.googlecode.com/files/scipy-0.11.0.p1.spkg](http://spkg-upload.googlecode.com/files/scipy-0.11.0.p1.spkg)\n\nIssue created by migration from https://trac.sagemath.org/ticket/14022\n\n",
    "closed_at": "2013-01-31T09:19:27Z",
    "created_at": "2013-01-28T08:39:54Z",
    "labels": [
        "component: packages: standard",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.7",
    "title": "Get scipy fortran objects be built with -fPIC again",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14022",
    "user": "https://github.com/kiwifb"
}
```
Assignee: tbd

This is a follow up to #13985. After that ticket was merged FC/F90/F77 are not set to something that includes -fPIC. This leads to problems like the one reported by Stephen Montgomery-Smith working on the BSD port.

```
/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/bin/gfortran
-Wall -shared
-Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib
-Wl,-rpath=/usr/local/lib/gcc46
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/_fftpackmodule.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zfft.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/drfft.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zrfft.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/zfftnd.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/dct.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/src/dst.o
build/temp.freebsd-8.3-STABLE-amd64-2.7/build/src.freebsd-8.3-STABLE-amd64-2.7/fortranobject.o
-L/usr/local/lib/gcc46/gcc/x86_64-portbld-freebsd8.3/4.6.3
-Lbuild/temp.freebsd-8.3-STABLE-amd64-2.7 -ldfftpack -lfftpack
-lpython2.7 -lgfortran -o
build/lib.freebsd-8.3-STABLE-amd64-2.7/scipy/fftpack/_fftpack.so
/usr/local/bin/ld:
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a(dffti1.o):
relocation R_X86_64_32S against `.rodata' can not be used when making a
shared object; recompile with -fPIC
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a: could not read
symbols: Bad value
collect2: ld returned 1 exit status
/usr/local/bin/ld:
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a(dffti1.o):
relocation R_X86_64_32S against `.rodata' can not be used when making a
shared object; recompile with -fPIC
build/temp.freebsd-8.3-STABLE-amd64-2.7/libdfftpack.a: could not read
symbols: Bad value
collect2: ld returned 1 exit status
```

{F,FC}FLAGS should be set to append "-fPIC" when compiling scipy.

* new spkg:
[http://spkg-upload.googlecode.com/files/scipy-0.11.0.p1.spkg](http://spkg-upload.googlecode.com/files/scipy-0.11.0.p1.spkg)

Issue created by migration from https://trac.sagemath.org/ticket/14022





---

archive/issue_comments_171533.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages.",
    "created_at": "2013-01-28T08:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171533",
    "user": "https://github.com/jdemeyer"
}
```

Changing component from PLEASE CHANGE to packages.



---

archive/issue_comments_171534.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2013-01-28T08:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171534",
    "user": "https://github.com/jdemeyer"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_171535.json:
```json
{
    "body": "Changing priority from major to blocker.",
    "created_at": "2013-01-28T08:55:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171535",
    "user": "https://github.com/jdemeyer"
}
```

Changing priority from major to blocker.



---

archive/issue_comments_171536.json:
```json
{
    "body": "Before jumping to conclusions, I'd like to see the full logfile of the failed build first.  Because on other systems, I am seeing in the SciPy logs\n\n```\nbuilding 'dfftpack' library\ncompiling Fortran sources\nFortran f77 compiler: gfortran -Wall -ffixed-form -fno-second-underscore -fPIC -O3 -funroll-loops\nFortran f90 compiler: gfortran -Wall -fno-second-underscore -fPIC -O3 -funroll-loops\nFortran fix compiler: gfortran -Wall -ffixed-form -fno-second-underscore -Wall -fno-second-underscore -fPIC -O3 -funroll-loops\n```",
    "created_at": "2013-01-28T08:58:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171536",
    "user": "https://github.com/jdemeyer"
}
```

Before jumping to conclusions, I'd like to see the full logfile of the failed build first.  Because on other systems, I am seeing in the SciPy logs

```
building 'dfftpack' library
compiling Fortran sources
Fortran f77 compiler: gfortran -Wall -ffixed-form -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran f90 compiler: gfortran -Wall -fno-second-underscore -fPIC -O3 -funroll-loops
Fortran fix compiler: gfortran -Wall -ffixed-form -fno-second-underscore -Wall -fno-second-underscore -fPIC -O3 -funroll-loops
```



---

archive/issue_comments_171537.json:
```json
{
    "body": "OK, but I have the spkg ready just in case.",
    "created_at": "2013-01-28T09:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171537",
    "user": "https://github.com/kiwifb"
}
```

OK, but I have the spkg ready just in case.



---

archive/issue_comments_171538.json:
```json
{
    "body": "Actually I am not sure why you asked for the ATLAS log. Does scipy takes some cues from ATLAS (if it is the cblas/lapack of choice)?",
    "created_at": "2013-01-28T09:08:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171538",
    "user": "https://github.com/kiwifb"
}
```

Actually I am not sure why you asked for the ATLAS log. Does scipy takes some cues from ATLAS (if it is the cblas/lapack of choice)?



---

archive/issue_comments_171539.json:
```json
{
    "body": "Replying to [comment:4 fbissey]:\n> Does scipy takes some cues from ATLAS (if it is the cblas/lapack of choice)?\n\nI don't know but SciPy at least *mentions* the ATLAS build flags:\n\n```\nATLAS version 3.8.4 built by buildbot on Sat Jan 26 08:53:30 SGT 2013:\n   UNAME    : Linux arando 3.2.0-32-generic-pae #51-Ubuntu SMP Wed Sep 26 21:54:23 UTC 2012 i686 i686 i386 GNU/Linux\n   INSTFLG  : -1 0 -a 1\n   ARCHDEFS : -DATL_OS_Linux -DATL_ARCH_Corei2 -DATL_CPUMHZ=3301 -DATL_SSE3 -DATL_SSE2 -DATL_SSE1 -DATL_GAS_x8632\n   F2CDEFS  : -DAdd_ -DF77_INTEGER=int -DStringSunStyle\n   CACHEEDGE: 0\n   F77      : sage_fortran, version GNU Fortran (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3\n   F77FLAGS : -O -fPIC -m32\n   SMC      : gcc, version gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3\n   SMCFLAGS : -fomit-frame-pointer -mfpmath=sse -mavx -O2 -fno-schedule-insns2 -fPIC -m32\n   SKC      : gcc, version gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3\n   SKCFLAGS : -fomit-frame-pointer -mfpmath=sse -mavx -O2 -fno-schedule-insns2 -fPIC -m32\n```",
    "created_at": "2013-01-28T09:45:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171539",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:4 fbissey]:
> Does scipy takes some cues from ATLAS (if it is the cblas/lapack of choice)?

I don't know but SciPy at least *mentions* the ATLAS build flags:

```
ATLAS version 3.8.4 built by buildbot on Sat Jan 26 08:53:30 SGT 2013:
   UNAME    : Linux arando 3.2.0-32-generic-pae #51-Ubuntu SMP Wed Sep 26 21:54:23 UTC 2012 i686 i686 i386 GNU/Linux
   INSTFLG  : -1 0 -a 1
   ARCHDEFS : -DATL_OS_Linux -DATL_ARCH_Corei2 -DATL_CPUMHZ=3301 -DATL_SSE3 -DATL_SSE2 -DATL_SSE1 -DATL_GAS_x8632
   F2CDEFS  : -DAdd_ -DF77_INTEGER=int -DStringSunStyle
   CACHEEDGE: 0
   F77      : sage_fortran, version GNU Fortran (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3
   F77FLAGS : -O -fPIC -m32
   SMC      : gcc, version gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3
   SMCFLAGS : -fomit-frame-pointer -mfpmath=sse -mavx -O2 -fno-schedule-insns2 -fPIC -m32
   SKC      : gcc, version gcc (Ubuntu/Linaro 4.6.3-1ubuntu5) 4.6.3
   SKCFLAGS : -fomit-frame-pointer -mfpmath=sse -mavx -O2 -fno-schedule-insns2 -fPIC -m32
```



---

archive/issue_comments_171540.json:
```json
{
    "body": "Log of failed FreeBSD build",
    "created_at": "2013-01-29T08:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171540",
    "user": "https://github.com/jdemeyer"
}
```

Log of failed FreeBSD build



---

archive/issue_comments_171541.json:
```json
{
    "body": "Attachment [scipy-0.11.0.p0.log](tarball://root/attachments/some-uuid/ticket14022/scipy-0.11.0.p0.log) by @jdemeyer created at 2013-01-29 09:04:43\n\nAt least it's clear now that `-fPIC` isn't added on FreeBSD.  But I would still really like to know where `SciPy` (or `SCons`) gets the flags from:\n\n```\nFortran f77 compiler: gfortran -Wall -ffixed-form -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops\nFortran f90 compiler: gfortran -Wall -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops\nFortran fix compiler: gfortran -Wall -ffixed-form -fno-second-underscore -Wall -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops\n```",
    "created_at": "2013-01-29T09:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171541",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [scipy-0.11.0.p0.log](tarball://root/attachments/some-uuid/ticket14022/scipy-0.11.0.p0.log) by @jdemeyer created at 2013-01-29 09:04:43

At least it's clear now that `-fPIC` isn't added on FreeBSD.  But I would still really like to know where `SciPy` (or `SCons`) gets the flags from:

```
Fortran f77 compiler: gfortran -Wall -ffixed-form -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops
Fortran f90 compiler: gfortran -Wall -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops
Fortran fix compiler: gfortran -Wall -ffixed-form -fno-second-underscore -Wall -fno-second-underscore -pipe -Wl,-rpath=/usr/home/stephen/sage-devel/work/sage-5.7.beta1/local/lib -Wl,-rpath=/usr/local/lib/gcc46 -O3 -funroll-loops
```



---

archive/issue_comments_171542.json:
```json
{
    "body": "Replying to [comment:3 fbissey]:\n> OK, but I have the spkg ready just in case.\n\nCare to put it up?",
    "created_at": "2013-01-29T09:21:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171542",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:3 fbissey]:
> OK, but I have the spkg ready just in case.

Care to put it up?



---

archive/issue_comments_171543.json:
```json
{
    "body": "Sure. It will take a few minutes. Also, I don't think Stephen has a trac account so we cannot add him to the ticket so he could see your question.\nThe presence of all those -Wl,-rpath= make me think he has set some of the fortran flags manually but it would be nice to have confirmation. My other thought was libgfortan.spec but that wouldn't show up.",
    "created_at": "2013-01-29T09:25:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171543",
    "user": "https://github.com/kiwifb"
}
```

Sure. It will take a few minutes. Also, I don't think Stephen has a trac account so we cannot add him to the ticket so he could see your question.
The presence of all those -Wl,-rpath= make me think he has set some of the fortran flags manually but it would be nice to have confirmation. My other thought was libgfortan.spec but that wouldn't show up.



---

archive/issue_comments_171544.json:
```json
{
    "body": "New spkg available in ticket description.",
    "created_at": "2013-01-29T09:30:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171544",
    "user": "https://github.com/kiwifb"
}
```

New spkg available in ticket description.



---

archive/issue_comments_171545.json:
```json
{
    "body": "Looks good to me if you remove `scipy-0.11.0.p1-review.diff`\n\nBut we should let Stephen test it before putting positive review.",
    "created_at": "2013-01-29T09:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171545",
    "user": "https://github.com/jdemeyer"
}
```

Looks good to me if you remove `scipy-0.11.0.p1-review.diff`

But we should let Stephen test it before putting positive review.



---

archive/issue_comments_171546.json:
```json
{
    "body": "I can confirm that scipy-0.11.0.p1 builds on FreeBSD.  (And I do have a trac account.)",
    "created_at": "2013-01-29T13:32:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171546",
    "user": "https://trac.sagemath.org/admin/accounts/users/stephen"
}
```

I can confirm that scipy-0.11.0.p1 builds on FreeBSD.  (And I do have a trac account.)



---

archive/issue_comments_171547.json:
```json
{
    "body": "Sorry, I didn't see your name on the wiki front page and I didn't search any further. I'll do the clean up, which shouldn't be too hard as the file is not tracked.",
    "created_at": "2013-01-29T17:12:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171547",
    "user": "https://github.com/kiwifb"
}
```

Sorry, I didn't see your name on the wiki front page and I didn't search any further. I'll do the clean up, which shouldn't be too hard as the file is not tracked.



---

archive/issue_comments_171548.json:
```json
{
    "body": "No problem.",
    "created_at": "2013-01-29T23:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171548",
    "user": "https://trac.sagemath.org/admin/accounts/users/stephen"
}
```

No problem.



---

archive/issue_comments_171549.json:
```json
{
    "body": "spkg updated. Your comment reminded me to do it.",
    "created_at": "2013-01-30T00:14:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171549",
    "user": "https://github.com/kiwifb"
}
```

spkg updated. Your comment reminded me to do it.



---

archive/issue_comments_171550.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-30T07:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171550",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_171551.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-01-30T07:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171551",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_039442.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-01-31T09:19:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14022#event-39442"
}
```



---

archive/issue_comments_171552.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-01-31T09:19:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14022",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14022#issuecomment-171552",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
