# Issue 14416: weird conversion from QQ to RDF

archive/issues_014212.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @robertwb\n\nthe following is weird:\n\n```\nsage: RDF(1/10)-RDF(1)/RDF(10)\n-1.38777878078e-17\n```\nOne would expect that the conversion from 1/10 to RDF is done as follows:\n- first convert 1 to RDF, which is exact\n- then convert 10 to RDF, which is exact\n- then divide RDF(1) by RDF(10)\n\nFor RR we get as a comparison:\n\n```\nsage: RR(1/10)-RR(1)/RR(10) \n0.000000000000000\n```\n\nMore examples:\n\n```\nsage: for p in [1..10]:\n....:     for q in [1..10]:\n....:         if RDF(p/q) <> RDF(p)/RDF(q):\n....:             print p, q\n....:             \n1 5\n1 10\n2 5\n2 10\n4 5\n4 10\n5 3\n5 6\n5 7\n5 9\n7 3\n7 6\n7 9\n8 5\n8 10\n9 5\n9 7\n9 10\n10 3\n10 6\n10 7\n10 9\n```\nand for RR:\n\n```\nsage: for p in [1..10]: \n....:     for q in [1..10]:\n....:         if RR(p/q) <> RR(p)/RR(q):\n....:             print p, q\n....:             \nsage:\n```\n\n**Apply** [attachment:14416_QQ_to_RDF_v2.patch]\n\nIssue created by migration from https://trac.sagemath.org/ticket/14416\n\n",
    "closed_at": "2013-06-06T12:32:33Z",
    "created_at": "2013-04-05T14:31:37Z",
    "labels": [
        "component: basic arithmetic",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.11",
    "title": "weird conversion from QQ to RDF",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14416",
    "user": "https://github.com/zimmermann6"
}
```
Assignee: @aghitza

CC:  @robertwb

the following is weird:

```
sage: RDF(1/10)-RDF(1)/RDF(10)
-1.38777878078e-17
```
One would expect that the conversion from 1/10 to RDF is done as follows:
- first convert 1 to RDF, which is exact
- then convert 10 to RDF, which is exact
- then divide RDF(1) by RDF(10)

For RR we get as a comparison:

```
sage: RR(1/10)-RR(1)/RR(10) 
0.000000000000000
```

More examples:

```
sage: for p in [1..10]:
....:     for q in [1..10]:
....:         if RDF(p/q) <> RDF(p)/RDF(q):
....:             print p, q
....:             
1 5
1 10
2 5
2 10
4 5
4 10
5 3
5 6
5 7
5 9
7 3
7 6
7 9
8 5
8 10
9 5
9 7
9 10
10 3
10 6
10 7
10 9
```
and for RR:

```
sage: for p in [1..10]: 
....:     for q in [1..10]:
....:         if RR(p/q) <> RR(p)/RR(q):
....:             print p, q
....:             
sage:
```

**Apply** [attachment:14416_QQ_to_RDF_v2.patch]

Issue created by migration from https://trac.sagemath.org/ticket/14416





---

archive/issue_comments_178535.json:
```json
{
    "body": "Tracing things back, the conversion eventually gets done by:\n\n```\nmpq_get_d(self.value)\n```\n\nsince `Rational` is just a wrapper around an `mpq`.  This is where the weirdness seems to be.",
    "created_at": "2013-04-05T14:52:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178535",
    "user": "https://github.com/mwhansen"
}
```

Tracing things back, the conversion eventually gets done by:

```
mpq_get_d(self.value)
```

since `Rational` is just a wrapper around an `mpq`.  This is where the weirdness seems to be.



---

archive/issue_comments_178536.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-05T14:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178536",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_178537.json:
```json
{
    "body": "ok, then the explanation is that `mpq_get_d` (according to the GMP manual) rounds towards zero.\n\nOne could call `mpz_get_d(numerator)/mpz_get(denominator)` but then for large numerator and denominator one would get three roundings, instead of only one when calling `mpq_get_d`.\n\nI propose to close this ticket.\n\nPaul",
    "created_at": "2013-04-05T14:58:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178537",
    "user": "https://github.com/zimmermann6"
}
```

ok, then the explanation is that `mpq_get_d` (according to the GMP manual) rounds towards zero.

One could call `mpz_get_d(numerator)/mpz_get(denominator)` but then for large numerator and denominator one would get three roundings, instead of only one when calling `mpq_get_d`.

I propose to close this ticket.

Paul



---

archive/issue_comments_178538.json:
```json
{
    "body": "So it's okay that\n\n```\nsage: RDF(1/10)*10 == RDF(1)\nFalse\nsage: RDF(1/10)*10 - RDF(1)\n-1.11022302463e-16\n\nsage: RR(1/10)*10 == RR(1)  \nTrue\nsage: sage: RR(1/10)*10 - RR(1) \n0.000000000000000\n```\nas Thierry pointed out  [here](http://ask.sagemath.org/question/2444/what-are-the-differences-between-realdoublefield)?  Just asking.  Or is it RR that is behaving sub-optimally in this case?  I assume that three roundings is ordinarily worse than one - my apologies for asking dumb questions.",
    "created_at": "2013-04-05T17:21:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178538",
    "user": "https://github.com/kcrisman"
}
```

So it's okay that

```
sage: RDF(1/10)*10 == RDF(1)
False
sage: RDF(1/10)*10 - RDF(1)
-1.11022302463e-16

sage: RR(1/10)*10 == RR(1)  
True
sage: sage: RR(1/10)*10 - RR(1) 
0.000000000000000
```
as Thierry pointed out  [here](http://ask.sagemath.org/question/2444/what-are-the-differences-between-realdoublefield)?  Just asking.  Or is it RR that is behaving sub-optimally in this case?  I assume that three roundings is ordinarily worse than one - my apologies for asking dumb questions.



---

archive/issue_comments_178539.json:
```json
{
    "body": "`RR` is not the same as `RDF` in regards to *how* rounding is done, so I would say yes, it is okay. I'd suspect if you change the rounding mode, you should get a similar result, but rounding and computations in `RDF` are tied to your hardware (up to a certain precision) since I believe they are done in your native machine `double` type. In particular, the ALU (arithmetic logic unit) of whatever CPU you're using. I should state for the record I'm not 100% certain of this.\n\nThe reason why `RR` works uniformly is as it was noted in the ask sage, it is *emulating* a CPU in a program (one can think of it as constant hardware).\n\nHowever instead of closing this ticket, I propose someone should implement a tutorial and/or improve the documentation and/or sage basics. I can do it if needbe.",
    "created_at": "2013-04-05T18:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178539",
    "user": "https://github.com/tscrim"
}
```

`RR` is not the same as `RDF` in regards to *how* rounding is done, so I would say yes, it is okay. I'd suspect if you change the rounding mode, you should get a similar result, but rounding and computations in `RDF` are tied to your hardware (up to a certain precision) since I believe they are done in your native machine `double` type. In particular, the ALU (arithmetic logic unit) of whatever CPU you're using. I should state for the record I'm not 100% certain of this.

The reason why `RR` works uniformly is as it was noted in the ask sage, it is *emulating* a CPU in a program (one can think of it as constant hardware).

However instead of closing this ticket, I propose someone should implement a tutorial and/or improve the documentation and/or sage basics. I can do it if needbe.



---

archive/issue_comments_178540.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2013-04-05T18:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178540",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_178541.json:
```json
{
    "body": "Changing component from basic arithmetic to documentation.",
    "created_at": "2013-04-05T18:34:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178541",
    "user": "https://github.com/tscrim"
}
```

Changing component from basic arithmetic to documentation.



---

archive/issue_events_040943.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-04-05T18:34:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "milestone": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14416#event-40943"
}
```



---

archive/issue_comments_178542.json:
```json
{
    "body": "Whoops, didn't mean to change the milestone.",
    "created_at": "2013-04-05T18:35:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178542",
    "user": "https://github.com/tscrim"
}
```

Whoops, didn't mean to change the milestone.



---

archive/issue_events_040944.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-04-05T18:35:08Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "milestone": "sage-5.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14416#event-40944"
}
```



---

archive/issue_events_040945.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2013-04-05T18:35:08Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "milestone": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14416#event-40945"
}
```



---

archive/issue_comments_178543.json:
```json
{
    "body": "As Paul explained, the rounding is the same for RR and RDF: RDF rounds its computations to the nearest. \n\nActually, the problem is somewhere else: the conversion from QQ to RDF rounds towards zero, which is not consistent with the general behaviour of RDF.\n\nIMHO, this conversion from QQ to RDF should be fixed, if possible.",
    "created_at": "2013-04-05T19:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178543",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

As Paul explained, the rounding is the same for RR and RDF: RDF rounds its computations to the nearest. 

Actually, the problem is somewhere else: the conversion from QQ to RDF rounds towards zero, which is not consistent with the general behaviour of RDF.

IMHO, this conversion from QQ to RDF should be fixed, if possible.



---

archive/issue_comments_178544.json:
```json
{
    "body": "Changing component from documentation to basic arithmetic.",
    "created_at": "2013-04-05T19:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178544",
    "user": "https://github.com/tscrim"
}
```

Changing component from documentation to basic arithmetic.



---

archive/issue_comments_178545.json:
```json
{
    "body": "Ah I see. I misread/misinterpreted Paul's explanation. I also agree that this should be fixed for consistency:\n\n```\nsage: RDF(RDF(1)/10) - RDF(1)/RDF(10)      \n0.0\nsage: RDF(RR(1)/10) - RDF(1)/RDF(10) \n0.0\nsage: RDF(1/RDF(10)) - RDF(1)/RDF(10)\n0.0\nsage: RDF(1/float(10)) - RDF(1)/RDF(10)\n0.0\n```",
    "created_at": "2013-04-05T19:31:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178545",
    "user": "https://github.com/tscrim"
}
```

Ah I see. I misread/misinterpreted Paul's explanation. I also agree that this should be fixed for consistency:

```
sage: RDF(RDF(1)/10) - RDF(1)/RDF(10)      
0.0
sage: RDF(RR(1)/10) - RDF(1)/RDF(10) 
0.0
sage: RDF(1/RDF(10)) - RDF(1)/RDF(10)
0.0
sage: RDF(1/float(10)) - RDF(1)/RDF(10)
0.0
```



---

archive/issue_comments_178546.json:
```json
{
    "body": "Karl-Dieter,\n\nReplying to [comment:3 kcrisman]:\n> So it's okay that\n> \n> ```\n> sage: RDF(1/10)*10 == RDF(1)\n> False\n> sage: RDF(1/10)*10 - RDF(1)\n> -1.11022302463e-16\n> \n> sage: RR(1/10)*10 == RR(1)  \n> True\n> sage: sage: RR(1/10)*10 - RR(1) \n> 0.000000000000000\n> ```\n> as Thierry pointed out  [here](http://ask.sagemath.org/question/2444/what-are-the-differences-between-realdoublefield)?  Just asking.  Or is it RR that is behaving sub-optimally in this case?  I assume that three roundings is ordinarily worse than one - my apologies for asking dumb questions.\n\n\nwhat is annoying is that RDF and RR give different results. The fact that RR gives `0.0` in that case\nis not that important, for example:\n\n```\nsage: RR(1/49)*49-RR(1)\n-1.11022302462516e-16\n```\nPaul",
    "created_at": "2013-04-05T20:50:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178546",
    "user": "https://github.com/zimmermann6"
}
```

Karl-Dieter,

Replying to [comment:3 kcrisman]:
> So it's okay that
> 
> ```
> sage: RDF(1/10)*10 == RDF(1)
> False
> sage: RDF(1/10)*10 - RDF(1)
> -1.11022302463e-16
> 
> sage: RR(1/10)*10 == RR(1)  
> True
> sage: sage: RR(1/10)*10 - RR(1) 
> 0.000000000000000
> ```
> as Thierry pointed out  [here](http://ask.sagemath.org/question/2444/what-are-the-differences-between-realdoublefield)?  Just asking.  Or is it RR that is behaving sub-optimally in this case?  I assume that three roundings is ordinarily worse than one - my apologies for asking dumb questions.


what is annoying is that RDF and RR give different results. The fact that RR gives `0.0` in that case
is not that important, for example:

```
sage: RR(1/49)*49-RR(1)
-1.11022302462516e-16
```
Paul



---

archive/issue_comments_178547.json:
```json
{
    "body": "> IMHO, this conversion from QQ to RDF should be fixed, if possible. \n\n\nit is possible: first call the MPFR function `mpfr_set_q` on the rational fraction\n(which is what `RR(p/q)` does) then convert back to `double` with `mpfr_get_d`, but this might be less efficient than the current code, since it would convert from QQ to RR, then from RR to RDF.\n\nConverting separately the numerator and the denominator to RDF, then dividing in RDF does not work,\ndue to double rounding.\nConsider for example the fraction `p/q` where `p=2403806706169061971` and `q=983883817941434958`. If you first round p and q to RDF (say with `mpz_get_d`), then you get\n`2403806706169061888/983883817941435008`, which is rounded to nearest to \n`5501555564164225/2251799813685248`, whereas the direct rounding of p/q to nearest gives\n`2750777782082113/1125899906842624`:\n\n```\nsage: p=2403806706169061971; q=983883817941434958; pp=RR(p); qq=RR(q)\nsage: (pp/qq).exact_rational()\n5501555564164225/2251799813685248\nsage: RR(p/q).exact_rational()\n2750777782082113/1125899906842624\n```\nPaul",
    "created_at": "2013-04-05T21:06:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178547",
    "user": "https://github.com/zimmermann6"
}
```

> IMHO, this conversion from QQ to RDF should be fixed, if possible. 


it is possible: first call the MPFR function `mpfr_set_q` on the rational fraction
(which is what `RR(p/q)` does) then convert back to `double` with `mpfr_get_d`, but this might be less efficient than the current code, since it would convert from QQ to RR, then from RR to RDF.

Converting separately the numerator and the denominator to RDF, then dividing in RDF does not work,
due to double rounding.
Consider for example the fraction `p/q` where `p=2403806706169061971` and `q=983883817941434958`. If you first round p and q to RDF (say with `mpz_get_d`), then you get
`2403806706169061888/983883817941435008`, which is rounded to nearest to 
`5501555564164225/2251799813685248`, whereas the direct rounding of p/q to nearest gives
`2750777782082113/1125899906842624`:

```
sage: p=2403806706169061971; q=983883817941434958; pp=RR(p); qq=RR(q)
sage: (pp/qq).exact_rational()
5501555564164225/2251799813685248
sage: RR(p/q).exact_rational()
2750777782082113/1125899906842624
```
Paul



---

archive/issue_comments_178548.json:
```json
{
    "body": "RDF is for when you want your computations to be fast, at the expense of a little bit of accuracy/less control of rounding/platform dependence.  As such, I think different behavior than RR is completely acceptable.  It would be nice if `mpq_get_d` rounded towards nearest, but until someone implements that in a manner that's at least comparable in speed to `mpq_get_d` I think the current behavior is more in line with the philosophy of RDF than making things slow to get the last bit correct.",
    "created_at": "2013-04-06T00:42:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178548",
    "user": "https://github.com/robertwb"
}
```

RDF is for when you want your computations to be fast, at the expense of a little bit of accuracy/less control of rounding/platform dependence.  As such, I think different behavior than RR is completely acceptable.  It would be nice if `mpq_get_d` rounded towards nearest, but until someone implements that in a manner that's at least comparable in speed to `mpq_get_d` I think the current behavior is more in line with the philosophy of RDF than making things slow to get the last bit correct.



---

archive/issue_comments_178549.json:
```json
{
    "body": "Robert, would the following be ok in what concerns speed?\n\nLet p/q the fraction to be converted to RDF, I assume p, q > 0.\n\n1) multiply p or q by a power of 2 into pp and qq so that both have the same number of bits\n   (using mpz_sizeinbase and mpz_mul_2exp from GMP)\n\n2) if pp < qq, multiply pp by 2<sup>54</sup>, otherwise multiply pp by 2<sup>53</sup>, using mpz_mul_2exp\n\n3) now 2<sup>53</sup> <= pp/qq < 2<sup>54</sup>, compute (using mpz_tdiv_qr) the quotient r = trunc(pp/qq) and the\n   remainder s; we know that r has exactly 54 bits\n\n4) if r is even, return r*2<sup>k</sup> where k is the normalizing constant (exact since r is exact on 53 bits)\n\n5) if s is not zero, return (r+1)*2<sup>k</sup> [r+1 is even, and exact on 53 bits, even in the\n   case where r+1 = 2<sup>54</sup>]\n\n5a) if s=0, return (r-1)*2<sup>k</sup> if the bit of weight 1 of r is 0, otherwise (r+1)*2<sup>k</sup>\n\nI guess mpq_get_d does basically steps 1-4, thus it should be comparable in speed.\n\nPaul",
    "created_at": "2013-04-06T07:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178549",
    "user": "https://github.com/zimmermann6"
}
```

Robert, would the following be ok in what concerns speed?

Let p/q the fraction to be converted to RDF, I assume p, q > 0.

1) multiply p or q by a power of 2 into pp and qq so that both have the same number of bits
   (using mpz_sizeinbase and mpz_mul_2exp from GMP)

2) if pp < qq, multiply pp by 2<sup>54</sup>, otherwise multiply pp by 2<sup>53</sup>, using mpz_mul_2exp

3) now 2<sup>53</sup> <= pp/qq < 2<sup>54</sup>, compute (using mpz_tdiv_qr) the quotient r = trunc(pp/qq) and the
   remainder s; we know that r has exactly 54 bits

4) if r is even, return r*2<sup>k</sup> where k is the normalizing constant (exact since r is exact on 53 bits)

5) if s is not zero, return (r+1)*2<sup>k</sup> [r+1 is even, and exact on 53 bits, even in the
   case where r+1 = 2<sup>54</sup>]

5a) if s=0, return (r-1)*2<sup>k</sup> if the bit of weight 1 of r is 0, otherwise (r+1)*2<sup>k</sup>

I guess mpq_get_d does basically steps 1-4, thus it should be comparable in speed.

Paul



---

archive/issue_comments_178550.json:
```json
{
    "body": "here is some tentative code which converts from QQ to RDF with rounding to nearest.\nIn the usual case where both the numerator and the denominator are less than 2<sup>53</sup> in absolute value, it is about twice as fast as `mpq_get_d`.\n\n```\ndouble\nmpq_get_d_nearest (mpq_t q)\n{\n  mpz_ptr a = mpq_numref (q);\n  mpz_ptr b = mpq_denref (q);\n  size_t sa = mpz_sizeinbase (a, 2);\n  size_t sb = mpz_sizeinbase (b, 2);\n  size_t na, nb;\n  mpz_t aa, bb;\n  double d;\n\n  /* easy case: |a|, |b| < 2^53, no overflow nor underflow can occur */\n  if (sa <= 53 && sb <= 53)\n    return mpz_get_d (a) / mpz_get_d (b);\n\n  /* same if a = m*2^e with m representable on 53 bits, idem for b, but beware  \n     that both a and b do not give an overflow */\n  na = sa - mpz_scan1 (a, 0);\n  nb = sb - mpz_scan1 (b, 0);\n  if (sa <= 1024 && na <= 53 && sb <= 1024 && nb <= 53)\n    return mpz_get_d (a) / mpz_get_d (b);\n\n  /* hard case */\n  mpz_init (aa);\n  mpz_init (bb);\n\n  if (sa >= sb)\n    {\n      mpz_set (aa, a);\n      mpz_mul_2exp (bb, b, sa - sb);\n    }\n  else\n    {\n      mpz_mul_2exp (aa, a, sb - sa);\n      mpz_set (bb, b);\n    }\n\n  /* q = aa/bb*2^(sa-sb) */\n\n  if (mpz_cmpabs (aa, bb) >= 0)\n    {\n      mpz_mul_2exp (bb, bb, 1);\n      sa ++;\n    }\n\n  mpz_mul_2exp (aa, aa, 54);\n  sb += 54;\n\n  mpz_tdiv_qr (aa, bb, aa, bb);\n\n  /* the quotient aa should have exactly 54 bits */\n\n  if (mpz_tstbit (aa, 0) == 0)\n    {\n    }\n  else if (mpz_cmp_ui (bb, 0) != 0)\n    {\n      if (mpz_sgn (aa) > 0)\n        mpz_add_ui (aa, aa, 1);\n      else\n        mpz_sub_ui (aa, aa, 1);\n    }\n  else /* mid case: round to even */\n    {\n      if (mpz_tstbit (aa, 1) == 0)\n        {\n          if (mpz_sgn (aa) > 0)\n            mpz_sub_ui (aa, aa, 1);\n          else\n            mpz_add_ui (aa, aa, 1);\n        }\n      else\n        {\n          if (mpz_sgn (aa) > 0)\n            mpz_add_ui (aa, aa, 1);\n          else\n            mpz_sub_ui (aa, aa, 1);\n        }\n    }\n\n  mpz_clear (aa);\n  mpz_clear (bb);\n  d = mpz_get_d (aa); /* exact */\n  return ldexp (d, (long) sa - (long) sb);\n}\n```\nHowever I don't know where to incorporate that code in Sage. Could someone help?\n\nPaul",
    "created_at": "2013-04-09T13:55:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178550",
    "user": "https://github.com/zimmermann6"
}
```

here is some tentative code which converts from QQ to RDF with rounding to nearest.
In the usual case where both the numerator and the denominator are less than 2<sup>53</sup> in absolute value, it is about twice as fast as `mpq_get_d`.

```
double
mpq_get_d_nearest (mpq_t q)
{
  mpz_ptr a = mpq_numref (q);
  mpz_ptr b = mpq_denref (q);
  size_t sa = mpz_sizeinbase (a, 2);
  size_t sb = mpz_sizeinbase (b, 2);
  size_t na, nb;
  mpz_t aa, bb;
  double d;

  /* easy case: |a|, |b| < 2^53, no overflow nor underflow can occur */
  if (sa <= 53 && sb <= 53)
    return mpz_get_d (a) / mpz_get_d (b);

  /* same if a = m*2^e with m representable on 53 bits, idem for b, but beware  
     that both a and b do not give an overflow */
  na = sa - mpz_scan1 (a, 0);
  nb = sb - mpz_scan1 (b, 0);
  if (sa <= 1024 && na <= 53 && sb <= 1024 && nb <= 53)
    return mpz_get_d (a) / mpz_get_d (b);

  /* hard case */
  mpz_init (aa);
  mpz_init (bb);

  if (sa >= sb)
    {
      mpz_set (aa, a);
      mpz_mul_2exp (bb, b, sa - sb);
    }
  else
    {
      mpz_mul_2exp (aa, a, sb - sa);
      mpz_set (bb, b);
    }

  /* q = aa/bb*2^(sa-sb) */

  if (mpz_cmpabs (aa, bb) >= 0)
    {
      mpz_mul_2exp (bb, bb, 1);
      sa ++;
    }

  mpz_mul_2exp (aa, aa, 54);
  sb += 54;

  mpz_tdiv_qr (aa, bb, aa, bb);

  /* the quotient aa should have exactly 54 bits */

  if (mpz_tstbit (aa, 0) == 0)
    {
    }
  else if (mpz_cmp_ui (bb, 0) != 0)
    {
      if (mpz_sgn (aa) > 0)
        mpz_add_ui (aa, aa, 1);
      else
        mpz_sub_ui (aa, aa, 1);
    }
  else /* mid case: round to even */
    {
      if (mpz_tstbit (aa, 1) == 0)
        {
          if (mpz_sgn (aa) > 0)
            mpz_sub_ui (aa, aa, 1);
          else
            mpz_add_ui (aa, aa, 1);
        }
      else
        {
          if (mpz_sgn (aa) > 0)
            mpz_add_ui (aa, aa, 1);
          else
            mpz_sub_ui (aa, aa, 1);
        }
    }

  mpz_clear (aa);
  mpz_clear (bb);
  d = mpz_get_d (aa); /* exact */
  return ldexp (d, (long) sa - (long) sb);
}
```
However I don't know where to incorporate that code in Sage. Could someone help?

Paul



---

archive/issue_comments_178551.json:
```json
{
    "body": "[Volker points](http://ask.sagemath.org/question/2444/what-are-the-differences-between-realdoublefield?answer=3357#3357) to [here](http://hg.sagemath.org/sage-main/file/5714ed3eab6a/sage/rings/rational.pyx#l2020) in sage/rings/rational.pyx.  I imagine that one could just replace that `return mpq_get_d(self.value)` with your code, or maybe make an auxiliary function since I suspect yours is pure C or C++ and this is a Cython file.",
    "created_at": "2013-04-09T14:27:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178551",
    "user": "https://github.com/kcrisman"
}
```

[Volker points](http://ask.sagemath.org/question/2444/what-are-the-differences-between-realdoublefield?answer=3357#3357) to [here](http://hg.sagemath.org/sage-main/file/5714ed3eab6a/sage/rings/rational.pyx#l2020) in sage/rings/rational.pyx.  I imagine that one could just replace that `return mpq_get_d(self.value)` with your code, or maybe make an auxiliary function since I suspect yours is pure C or C++ and this is a Cython file.



---

archive/issue_comments_178552.json:
```json
{
    "body": "That looks like pure C code. Isn't there an mpz/mpq package with the underlying C(++) code, and wouldn't this go in there...?",
    "created_at": "2013-04-09T14:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178552",
    "user": "https://github.com/tscrim"
}
```

That looks like pure C code. Isn't there an mpz/mpq package with the underlying C(++) code, and wouldn't this go in there...?



---

archive/issue_comments_178553.json:
```json
{
    "body": "yes this is pure C code.\n\nPaul",
    "created_at": "2013-04-09T14:48:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178553",
    "user": "https://github.com/zimmermann6"
}
```

yes this is pure C code.

Paul



---

archive/issue_comments_178554.json:
```json
{
    "body": "note that we have currently:\n\n```\nsage: RDF(2^(-1075))\n0.0\nsage: RDF(-2^(-1075))\n0.0\n```\nThe last result should be `-0.0`, as in `-RDF(2^(-1075))`.\nI guess my code above fixes that (not tested).\n\nPaul",
    "created_at": "2013-04-10T09:09:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178554",
    "user": "https://github.com/zimmermann6"
}
```

note that we have currently:

```
sage: RDF(2^(-1075))
0.0
sage: RDF(-2^(-1075))
0.0
```
The last result should be `-0.0`, as in `-RDF(2^(-1075))`.
I guess my code above fixes that (not tested).

Paul



---

archive/issue_comments_178555.json:
```json
{
    "body": "Is it really worth to do\n\n```\n  /* same if a = m*2^e with m representable on 53 bits, idem for b, but beware  \n     that both a and b do not give an overflow */\n  na = sa - mpz_scan1 (a, 0);\n  nb = sb - mpz_scan1 (b, 0);\n  if (sa <= 1024 && na <= 53 && sb <= 1024 && nb <= 53)\n    return mpz_get_d (a) / mpz_get_d (b);\n```\nI think that this case is pretty rare, so I wouldn't special-case it.",
    "created_at": "2013-04-10T10:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178555",
    "user": "https://github.com/jdemeyer"
}
```

Is it really worth to do

```
  /* same if a = m*2^e with m representable on 53 bits, idem for b, but beware  
     that both a and b do not give an overflow */
  na = sa - mpz_scan1 (a, 0);
  nb = sb - mpz_scan1 (b, 0);
  if (sa <= 1024 && na <= 53 && sb <= 1024 && nb <= 53)
    return mpz_get_d (a) / mpz_get_d (b);
```
I think that this case is pretty rare, so I wouldn't special-case it.



---

archive/issue_comments_178556.json:
```json
{
    "body": "Jeroen,\n\n> I think that this case is pretty rare, so I wouldn't special-case it.\n\n\nthis was my first idea. Then I realized I was often using say `RDF(1/2^100)`.\nYes we can remove that special case, but it would be interesting to see how often it is used in the whole Sage test suite.\n\nPaul",
    "created_at": "2013-04-10T10:16:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178556",
    "user": "https://github.com/zimmermann6"
}
```

Jeroen,

> I think that this case is pretty rare, so I wouldn't special-case it.


this was my first idea. Then I realized I was often using say `RDF(1/2^100)`.
Yes we can remove that special case, but it would be interesting to see how often it is used in the whole Sage test suite.

Paul



---

archive/issue_comments_178557.json:
```json
{
    "body": "There is also this obvious bug:\n\n```\nmpz_clear (aa);\n[...]\nmpz_get_d (aa);\n```",
    "created_at": "2013-04-10T10:19:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178557",
    "user": "https://github.com/jdemeyer"
}
```

There is also this obvious bug:

```
mpz_clear (aa);
[...]
mpz_get_d (aa);
```



---

archive/issue_comments_178558.json:
```json
{
    "body": "> There is also this obvious bug:...\n\n\nsorry, please replace the last lines by:\n\n```\n  d = mpz_get_d (aa); /* exact */\n  mpz_clear (aa);\n  mpz_clear (bb);\n  return ldexp (d, (long) sa - (long) sb);\n```\nI also realize in the \"hard case\", there is a double-rounding issue for subnormals. This could be fixed if needed.\n\nPaul",
    "created_at": "2013-04-10T10:59:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178558",
    "user": "https://github.com/zimmermann6"
}
```

> There is also this obvious bug:...


sorry, please replace the last lines by:

```
  d = mpz_get_d (aa); /* exact */
  mpz_clear (aa);
  mpz_clear (bb);
  return ldexp (d, (long) sa - (long) sb);
```
I also realize in the "hard case", there is a double-rounding issue for subnormals. This could be fixed if needed.

Paul



---

archive/issue_comments_178559.json:
```json
{
    "body": "I'm working on a Sage patch based on Paul's code.",
    "created_at": "2013-04-10T13:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178559",
    "user": "https://github.com/jdemeyer"
}
```

I'm working on a Sage patch based on Paul's code.



---

archive/issue_comments_178560.json:
```json
{
    "body": "> I'm working on a Sage patch based on Paul's code.\n\n\ngreat! Please ask if you need some help. My code should deal correctly with underflow or overflow (through the call to ldexp).\n\nPaul",
    "created_at": "2013-04-10T13:45:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178560",
    "user": "https://github.com/zimmermann6"
}
```

> I'm working on a Sage patch based on Paul's code.


great! Please ask if you need some help. My code should deal correctly with underflow or overflow (through the call to ldexp).

Paul



---

archive/issue_comments_178561.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2013-04-11T07:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178561",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_178562.json:
```json
{
    "body": "Jeroen,\n\nas an author I'm not supposed to review that ticket, but I have a few questions:\n\n- why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?\n\n- in `matrix/matrix_mod2e_dense.pyx` I wonder why you had to change only one value,\n  and not all from lines 788 to 811\n\n- in `plot/colors.py` the new value is closer to 2/7 than the old one (as expected):\n\n```\nsage: (RR(rainbow(7, 'rgbtuple')[5][0]).exact_rational()-2/7)*1.0\n-1.26882631385732e-16\n```\n\n- idem in `rings/contfrac.py`:\n\n```\nsage: (RR(float(a)).exact_rational()+17/389)*1.0\n-1.60539961787057e-18\n```\n\n- the test `float(1/10) * 10 == float(1)` is misleading: it might make think that this is now true for any value of q instead of 10, which is wrong (consider q=49).\n\n- efficiency is not that bad in the \"easy\" case (was 4.8 ms before):\n\n```\nsage: l=[a/b for a in [1..99] for b in [1..99]]\nsage: %timeit c = map(RDF,l)\n100 loops, best of 3: 2.97 ms per loop\n```\n\n- we have lost a little in the \"general\" case (was 5.04 ms before):\n\n```\nsage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]\nsage: %timeit c = map(RDF,l)                                 \n100 loops, best of 3: 7.38 ms per loop\n```\n\n- `q0 = aa/bb / 2^shift` should be `q0 = a/b / 2^shift`\n\n- `|d| <= 2^-1075` should be `|d| < 2^-1075`\n\n- `shift >= 972` can be changed to `shift >= 971`, since for 971 we get `|d| >= 2^1024` and `2^1024` gives infinity\n\n- maybe we can avoid the copy done by `mpz_init_set` and point directly to the corresponding numerator or denominator?\n\n- I would add an example showing that the conversion now agrees with RR:\n\n```\nsage: all([RDF(a/b) == RR(a/b) for a in [1..99] for b in [1..99]])\nTrue\n```\n\nI see you have dealt with the subnormal case too: great!\n\nPaul",
    "created_at": "2013-04-12T07:45:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178562",
    "user": "https://github.com/zimmermann6"
}
```

Jeroen,

as an author I'm not supposed to review that ticket, but I have a few questions:

- why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?

- in `matrix/matrix_mod2e_dense.pyx` I wonder why you had to change only one value,
  and not all from lines 788 to 811

- in `plot/colors.py` the new value is closer to 2/7 than the old one (as expected):

```
sage: (RR(rainbow(7, 'rgbtuple')[5][0]).exact_rational()-2/7)*1.0
-1.26882631385732e-16
```

- idem in `rings/contfrac.py`:

```
sage: (RR(float(a)).exact_rational()+17/389)*1.0
-1.60539961787057e-18
```

- the test `float(1/10) * 10 == float(1)` is misleading: it might make think that this is now true for any value of q instead of 10, which is wrong (consider q=49).

- efficiency is not that bad in the "easy" case (was 4.8 ms before):

```
sage: l=[a/b for a in [1..99] for b in [1..99]]
sage: %timeit c = map(RDF,l)
100 loops, best of 3: 2.97 ms per loop
```

- we have lost a little in the "general" case (was 5.04 ms before):

```
sage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]
sage: %timeit c = map(RDF,l)                                 
100 loops, best of 3: 7.38 ms per loop
```

- `q0 = aa/bb / 2^shift` should be `q0 = a/b / 2^shift`

- `|d| <= 2^-1075` should be `|d| < 2^-1075`

- `shift >= 972` can be changed to `shift >= 971`, since for 971 we get `|d| >= 2^1024` and `2^1024` gives infinity

- maybe we can avoid the copy done by `mpz_init_set` and point directly to the corresponding numerator or denominator?

- I would add an example showing that the conversion now agrees with RR:

```
sage: all([RDF(a/b) == RR(a/b) for a in [1..99] for b in [1..99]])
True
```

I see you have dealt with the subnormal case too: great!

Paul



---

archive/issue_comments_178563.json:
```json
{
    "body": "Shouldn't we push that upstream to MPIR/GMP? From a cursory Google search it seems that we are not the first ones to trip over this. Did anybody contact upstream for their opinion?",
    "created_at": "2013-04-12T08:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178563",
    "user": "https://github.com/vbraun"
}
```

Shouldn't we push that upstream to MPIR/GMP? From a cursory Google search it seems that we are not the first ones to trip over this. Did anybody contact upstream for their opinion?



---

archive/issue_comments_178564.json:
```json
{
    "body": "Volker, you are right. I will ask the GMP developers.\n\nPaul",
    "created_at": "2013-04-12T09:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178564",
    "user": "https://github.com/zimmermann6"
}
```

Volker, you are right. I will ask the GMP developers.

Paul



---

archive/issue_comments_178565.json:
```json
{
    "body": "cf http://gmplib.org/list-archives/gmp-devel/2013-April/003223.html\n\nPaul",
    "created_at": "2013-04-12T09:14:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178565",
    "user": "https://github.com/zimmermann6"
}
```

cf http://gmplib.org/list-archives/gmp-devel/2013-April/003223.html

Paul



---

archive/issue_comments_178566.json:
```json
{
    "body": "Replying to [comment:24 zimmerma]:\n> Jeroen,\n> \n> as an author I'm not supposed to review that ticket\n\nI don't think that's true. I read your patch, understood it (so that's a review of your code) and made some modifications. So I think it is perfectly fine if you review the patch.\n\n> - why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?\n \nThat's a cool doctest trick I learned recently. If the condition fails, it will output the exact value of `A.condition()` instead of simply returning `False`.\n\n> - in `matrix/matrix_mod2e_dense.pyx` I wonder why you had to change only one value,\n>   and not all from lines 788 to 811\n \nWell, I assume the others are cases where the old and new mpq->double conversion code agree.\n\n> - the test `float(1/10) * 10 == float(1)` is misleading: it might make think that this is now true for any value of q instead of 10, which is wrong (consider q=49).\n \nOK, true. I will remove that test.\n\n> - maybe we can avoid the copy done by `mpz_init_set` and point directly to the corresponding numerator or denominator?\n \nI have no idea how to do that in Cython. Besides, we do change the value of `aa` and `bb`, so we need an init anyway.\n\n> - I would add an example showing that the conversion now agrees with RR:\n> \n> ```\n> sage: all([RDF(a/b) == RR(a/b) for a in [1..99] for b in [1..99]])\n> True\n> ```\n\nOK, good idea. I'll also test negative numerators.",
    "created_at": "2013-04-12T09:44:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178566",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:24 zimmerma]:
> Jeroen,
> 
> as an author I'm not supposed to review that ticket

I don't think that's true. I read your patch, understood it (so that's a review of your code) and made some modifications. So I think it is perfectly fine if you review the patch.

> - why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?
 
That's a cool doctest trick I learned recently. If the condition fails, it will output the exact value of `A.condition()` instead of simply returning `False`.

> - in `matrix/matrix_mod2e_dense.pyx` I wonder why you had to change only one value,
>   and not all from lines 788 to 811
 
Well, I assume the others are cases where the old and new mpq->double conversion code agree.

> - the test `float(1/10) * 10 == float(1)` is misleading: it might make think that this is now true for any value of q instead of 10, which is wrong (consider q=49).
 
OK, true. I will remove that test.

> - maybe we can avoid the copy done by `mpz_init_set` and point directly to the corresponding numerator or denominator?
 
I have no idea how to do that in Cython. Besides, we do change the value of `aa` and `bb`, so we need an init anyway.

> - I would add an example showing that the conversion now agrees with RR:
> 
> ```
> sage: all([RDF(a/b) == RR(a/b) for a in [1..99] for b in [1..99]])
> True
> ```

OK, good idea. I'll also test negative numerators.



---

archive/issue_comments_178567.json:
```json
{
    "body": "Jeroen,\n\n> > as an author I'm not supposed to review that ticket\n\n> I don't think that's true. I read your patch, understood it (so that's a review of your code) and made some modifications. So I think it is perfectly fine if you review the patch.\n\nI'm fine in giving comments, but I would prefer someone else gives \"positive review\".\n\n> > - why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?\n \n> That's a cool doctest trick I learned recently. If the condition fails, it will output the exact value of `A.condition()` instead of simply returning `False`.\n\ngood. I learned something too!\n\n> > - in `matrix/matrix_mod2e_dense.pyx` I wonder why you had to change only one value,\n> >   and not all from lines 788 to 811\n \n> Well, I assume the others are cases where the old and new mpq->double conversion code agree.\n\nwhen I did those tests by hand in a vanilla session, I got different values, thus I guess they depend on the seed value, and the previous tests, which is not very good.\n\n> > - maybe we can avoid the copy done by `mpz_init_set` and point directly to the corresponding numerator or denominator?\n \n> I have no idea how to do that in Cython. Besides, we do change the value of `aa` and `bb`, so we need an init anyway.\n\nyou could have different variables to store the quotient and remainder, and split the code\nto perform the division directly on a or b.\n\nPaul",
    "created_at": "2013-04-12T09:56:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178567",
    "user": "https://github.com/zimmermann6"
}
```

Jeroen,

> > as an author I'm not supposed to review that ticket

> I don't think that's true. I read your patch, understood it (so that's a review of your code) and made some modifications. So I think it is perfectly fine if you review the patch.

I'm fine in giving comments, but I would prefer someone else gives "positive review".

> > - why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?
 
> That's a cool doctest trick I learned recently. If the condition fails, it will output the exact value of `A.condition()` instead of simply returning `False`.

good. I learned something too!

> > - in `matrix/matrix_mod2e_dense.pyx` I wonder why you had to change only one value,
> >   and not all from lines 788 to 811
 
> Well, I assume the others are cases where the old and new mpq->double conversion code agree.

when I did those tests by hand in a vanilla session, I got different values, thus I guess they depend on the seed value, and the previous tests, which is not very good.

> > - maybe we can avoid the copy done by `mpz_init_set` and point directly to the corresponding numerator or denominator?
 
> I have no idea how to do that in Cython. Besides, we do change the value of `aa` and `bb`, so we need an init anyway.

you could have different variables to store the quotient and remainder, and split the code
to perform the division directly on a or b.

Paul



---

archive/issue_comments_178568.json:
```json
{
    "body": "Attachment [14416_QQ_to_RDF.patch](tarball://root/attachments/some-uuid/ticket14416/14416_QQ_to_RDF.patch) by @jdemeyer created at 2013-04-12 11:22:13\n\nReplying to [comment:29 zimmerma]:\n> you could have different variables to store the quotient and remainder, and split the code\n> to perform the division directly on a or b.\n\nYes, that's what I did in the new patch.",
    "created_at": "2013-04-12T11:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178568",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14416_QQ_to_RDF.patch](tarball://root/attachments/some-uuid/ticket14416/14416_QQ_to_RDF.patch) by @jdemeyer created at 2013-04-12 11:22:13

Replying to [comment:29 zimmerma]:
> you could have different variables to store the quotient and remainder, and split the code
> to perform the division directly on a or b.

Yes, that's what I did in the new patch.



---

archive/issue_comments_178569.json:
```json
{
    "body": "with the new patch (I did not check with the old one) I get warnings:\n\n```\nwarning: sage/rings/../ext/gmp.pxi:65:22: local variable 'p1' referenced before assignment\nwarning: sage/rings/../ext/gmp.pxi:66:15: local variable 'p2' referenced before assignment\nwarning: sage/rings/../ext/gmp.pxi:87:22: local variable 'p1' referenced before assignment\nwarning: sage/rings/../ext/gmp.pxi:173:14: local variable 'g' referenced before assignment\nwarning: sage/rings/../ext/gmp.pxi:173:27: local variable 's' referenced before assignment\nwarning: sage/rings/../ext/gmp.pxi:173:40: local variable 't' referenced before assignment\nwarning: sage/rings/../ext/gmp.pxi:173:54: local variable 'mn' referenced before assignment\nwarning: sage/rings/rational.pyx:1433:25: local variable 'prod' referenced before assignment\nwarning: sage/rings/rational.pyx:1444:29: local variable 'prod' referenced before assignment\nwarning: sage/rings/rational.pyx:1454:33: local variable 'prod' referenced before assignment\nwarning: sage/rings/rational.pyx:1465:33: local variable 'prod' referenced before assignment\nwarning: sage/rings/rational.pyx:1467:29: local variable 'prod' referenced before assignment\nwarning: sage/rings/rational.pyx:1768:20: local variable 'tmp' referenced before assignment\nwarning: sage/rings/rational.pyx:2427:20: local variable 'num' referenced before assignment\nwarning: sage/rings/rational.pyx:2428:20: local variable 'den' referenced before assignment\nwarning: sage/rings/rational.pyx:2763:22: local variable 'x' referenced before assignment\nwarning: sage/rings/rational.pyx:3576:14: local variable 'q' referenced before assignment\nwarning: sage/rings/rational.pyx:3577:14: local variable 'r' referenced before assignment\n```\nPaul",
    "created_at": "2013-04-12T11:38:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178569",
    "user": "https://github.com/zimmermann6"
}
```

with the new patch (I did not check with the old one) I get warnings:

```
warning: sage/rings/../ext/gmp.pxi:65:22: local variable 'p1' referenced before assignment
warning: sage/rings/../ext/gmp.pxi:66:15: local variable 'p2' referenced before assignment
warning: sage/rings/../ext/gmp.pxi:87:22: local variable 'p1' referenced before assignment
warning: sage/rings/../ext/gmp.pxi:173:14: local variable 'g' referenced before assignment
warning: sage/rings/../ext/gmp.pxi:173:27: local variable 's' referenced before assignment
warning: sage/rings/../ext/gmp.pxi:173:40: local variable 't' referenced before assignment
warning: sage/rings/../ext/gmp.pxi:173:54: local variable 'mn' referenced before assignment
warning: sage/rings/rational.pyx:1433:25: local variable 'prod' referenced before assignment
warning: sage/rings/rational.pyx:1444:29: local variable 'prod' referenced before assignment
warning: sage/rings/rational.pyx:1454:33: local variable 'prod' referenced before assignment
warning: sage/rings/rational.pyx:1465:33: local variable 'prod' referenced before assignment
warning: sage/rings/rational.pyx:1467:29: local variable 'prod' referenced before assignment
warning: sage/rings/rational.pyx:1768:20: local variable 'tmp' referenced before assignment
warning: sage/rings/rational.pyx:2427:20: local variable 'num' referenced before assignment
warning: sage/rings/rational.pyx:2428:20: local variable 'den' referenced before assignment
warning: sage/rings/rational.pyx:2763:22: local variable 'x' referenced before assignment
warning: sage/rings/rational.pyx:3576:14: local variable 'q' referenced before assignment
warning: sage/rings/rational.pyx:3577:14: local variable 'r' referenced before assignment
```
Paul



---

archive/issue_comments_178570.json:
```json
{
    "body": "performance is not better in the general case:\n\n```\nsage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]\nsage: %timeit c = map(RDF,l)     \n10 loops, best of 3: 8.66 ms per loop\nsage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]\nsage: %timeit c = map(RDF,l)                                 \n100 loops, best of 3: 9.38 ms per loop\nsage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]\nsage: %timeit c = map(RDF,l)                                 \n100 loops, best of 3: 10.8 ms per loop\n```\nPaul",
    "created_at": "2013-04-12T11:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178570",
    "user": "https://github.com/zimmermann6"
}
```

performance is not better in the general case:

```
sage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]
sage: %timeit c = map(RDF,l)     
10 loops, best of 3: 8.66 ms per loop
sage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]
sage: %timeit c = map(RDF,l)                                 
100 loops, best of 3: 9.38 ms per loop
sage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]
sage: %timeit c = map(RDF,l)                                 
100 loops, best of 3: 10.8 ms per loop
```
Paul



---

archive/issue_comments_178571.json:
```json
{
    "body": "Replying to [comment:31 zimmerma]:\n> with the new patch (I did not check with the old one) I get warnings\n\nSure, we get these warnings all over the place. One could say this is a Cython bug.",
    "created_at": "2013-04-12T11:45:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178571",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:31 zimmerma]:
> with the new patch (I did not check with the old one) I get warnings

Sure, we get these warnings all over the place. One could say this is a Cython bug.



---

archive/issue_comments_178572.json:
```json
{
    "body": "I added a second version which uses `uint64_t` in the second part, which is hopefully slightly faster.",
    "created_at": "2013-04-12T12:49:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178572",
    "user": "https://github.com/jdemeyer"
}
```

I added a second version which uses `uint64_t` in the second part, which is hopefully slightly faster.



---

archive/issue_comments_178573.json:
```json
{
    "body": "Replying to [comment:24 zimmerma]:\n> - why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?\n\n\nTo elaborate on this: `X or Y` returns `X` if `bool(X)` is true and returns `Y` if `bool(X)` is false. The opposite for `X and Y`.",
    "created_at": "2013-04-12T13:05:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178573",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:24 zimmerma]:
> - why the `or A.condition()` in `matrix/matrix_double_dense.pyx`?


To elaborate on this: `X or Y` returns `X` if `bool(X)` is true and returns `Y` if `bool(X)` is false. The opposite for `X and Y`.



---

archive/issue_comments_178574.json:
```json
{
    "body": "the new version is slightly better in the general case:\n\n```\nsage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]\nsage: %timeit c = map(RDF,l)                                 \n100 loops, best of 3: 8.15 ms per loop\nsage: %timeit c = map(RDF,l)\n100 loops, best of 3: 8.07 ms per loop\nsage: %timeit c = map(RDF,l)\n100 loops, best of 3: 7.97 ms per loop\n```\nPaul",
    "created_at": "2013-04-12T13:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178574",
    "user": "https://github.com/zimmermann6"
}
```

the new version is slightly better in the general case:

```
sage: l=[(2^53+a)/(3^53+b) for a in [1..99] for b in [1..99]]
sage: %timeit c = map(RDF,l)                                 
100 loops, best of 3: 8.15 ms per loop
sage: %timeit c = map(RDF,l)
100 loops, best of 3: 8.07 ms per loop
sage: %timeit c = map(RDF,l)
100 loops, best of 3: 7.97 ms per loop
```
Paul



---

archive/issue_comments_178575.json:
```json
{
    "body": "I believe it will be difficult to do better, unless we avoid mpz and use mpn instead.\nAssuming all tests still work, I am fine with the new code.\n\nCould anybody out there have a final look and give a positive review?\n\nPaul",
    "created_at": "2013-04-12T13:34:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178575",
    "user": "https://github.com/zimmermann6"
}
```

I believe it will be difficult to do better, unless we avoid mpz and use mpn instead.
Assuming all tests still work, I am fine with the new code.

Could anybody out there have a final look and give a positive review?

Paul



---

archive/issue_comments_178576.json:
```json
{
    "body": "btw, a small typo in the patch: occured should be occurred...\n\nPaul",
    "created_at": "2013-04-12T14:40:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178576",
    "user": "https://github.com/zimmermann6"
}
```

btw, a small typo in the patch: occured should be occurred...

Paul



---

archive/issue_comments_178577.json:
```json
{
    "body": "I am definitely not able to review this ticket, but i would suggest to add the initial bug in the doctest to detect regression (not only comparing RDF with RR since they could change their behaviour simultaneously).\n\n```\nsage: RDF(1/10)*10 == RDF(1)\nTrue\n```\n\nand even\n\n```\nsage: all([RDF(p/q) == RDF(p)/RDF(q) for p in [-100..100] for q in [1..100]])\nTrue\n```",
    "created_at": "2013-04-12T22:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178577",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

I am definitely not able to review this ticket, but i would suggest to add the initial bug in the doctest to detect regression (not only comparing RDF with RR since they could change their behaviour simultaneously).

```
sage: RDF(1/10)*10 == RDF(1)
True
```

and even

```
sage: all([RDF(p/q) == RDF(p)/RDF(q) for p in [-100..100] for q in [1..100]])
True
```



---

archive/issue_comments_178578.json:
```json
{
    "body": "Thierry, I asked Jeroen to remove from the doctest `RDF(1/10)*10 == RDF(1)` since this is wrong if you replace 10 by say 49, so this was not a bug, but a feature of rounding.\n\nThe second test you propose is good (however there is a very small probability that RDF and RR change simultaneously, but the current test doesn't exercise negative p).\n\nPaul",
    "created_at": "2013-04-13T07:30:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178578",
    "user": "https://github.com/zimmermann6"
}
```

Thierry, I asked Jeroen to remove from the doctest `RDF(1/10)*10 == RDF(1)` since this is wrong if you replace 10 by say 49, so this was not a bug, but a feature of rounding.

The second test you propose is good (however there is a very small probability that RDF and RR change simultaneously, but the current test doesn't exercise negative p).

Paul



---

archive/issue_comments_178579.json:
```json
{
    "body": "Replying to [comment:39 tmonteil]:\n> {{{\n> sage: all([RDF(p/q) == RDF(p)/RDF(q) for p in [-100..100] for q in [1..100]])\n> True\n> }}}\n\nI would say this test is also misleading since `RDF(p/q)` and `RDF(p)/RDF(q)` don't have to be the same for large value of `p` and `q`.",
    "created_at": "2013-04-13T11:09:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178579",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:39 tmonteil]:
> {{{
> sage: all([RDF(p/q) == RDF(p)/RDF(q) for p in [-100..100] for q in [1..100]])
> True
> }}}

I would say this test is also misleading since `RDF(p/q)` and `RDF(p)/RDF(q)` don't have to be the same for large value of `p` and `q`.



---

archive/issue_comments_178580.json:
```json
{
    "body": "> I would say this test is also misleading since RDF(p/q) and RDF(p)/RDF(q) don't have to be the same...\n\n\nyes, but for p, q integers in [-100,100] the conversion to RDF is exact.\n\nPaul",
    "created_at": "2013-04-13T17:11:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178580",
    "user": "https://github.com/zimmermann6"
}
```

> I would say this test is also misleading since RDF(p/q) and RDF(p)/RDF(q) don't have to be the same...


yes, but for p, q integers in [-100,100] the conversion to RDF is exact.

Paul



---

archive/issue_comments_178581.json:
```json
{
    "body": "Attachment [trac_14416_rounding_doctest-tm.patch](tarball://root/attachments/some-uuid/ticket14416/trac_14416_rounding_doctest-tm.patch) by tmonteil created at 2013-04-14 22:48:02\n\nTested on sage 5.9.beta5, depends on #14448",
    "created_at": "2013-04-14T22:48:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178581",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Attachment [trac_14416_rounding_doctest-tm.patch](tarball://root/attachments/some-uuid/ticket14416/trac_14416_rounding_doctest-tm.patch) by tmonteil created at 2013-04-14 22:48:02

Tested on sage 5.9.beta5, depends on #14448



---

archive/issue_comments_178582.json:
```json
{
    "body": "Perhaps the following test has a better semantics, and still represents the initial bug.\n\n```\nfor p in [-100..100]:\n    for q in [1..100]:\n        r = p/q\n        s, m, e = RDF(r).sign_mantissa_exponent()\n        if not abs(s*m*2^(e) - r) <= 2^(e-1):\n            print 'Bug #14416 reappeared with rational', r\n```\n\nUnfortunately, this lets me found a bug in the `.sign_mantissa_exponent()` (which currently gives negative mantissa to negative numbers), see #14448.",
    "created_at": "2013-04-14T22:49:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178582",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```

Perhaps the following test has a better semantics, and still represents the initial bug.

```
for p in [-100..100]:
    for q in [1..100]:
        r = p/q
        s, m, e = RDF(r).sign_mantissa_exponent()
        if not abs(s*m*2^(e) - r) <= 2^(e-1):
            print 'Bug #14416 reappeared with rational', r
```

Unfortunately, this lets me found a bug in the `.sign_mantissa_exponent()` (which currently gives negative mantissa to negative numbers), see #14448.



---

archive/issue_comments_178583.json:
```json
{
    "body": "OK, I added your doctest in a simplified way such that it doesn't depend on #14448.",
    "created_at": "2013-04-15T07:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178583",
    "user": "https://github.com/jdemeyer"
}
```

OK, I added your doctest in a simplified way such that it doesn't depend on #14448.



---

archive/issue_comments_178584.json:
```json
{
    "body": "Jeroen, what is status of this ticket for the patchbot? Last time I looked, some tests were failing.\n\nPaul",
    "created_at": "2013-04-15T07:44:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178584",
    "user": "https://github.com/zimmermann6"
}
```

Jeroen, what is status of this ticket for the patchbot? Last time I looked, some tests were failing.

Paul



---

archive/issue_comments_178585.json:
```json
{
    "body": "Replying to [comment:45 zimmerma]:\n> Jeroen, what is status of this ticket for the patchbot? Last time I looked, some tests were failing.\n\n\nI fixed some more doctest failures in `sage/matrix/matrix_double_dense.pyx`.",
    "created_at": "2013-04-15T08:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178585",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:45 zimmerma]:
> Jeroen, what is status of this ticket for the patchbot? Last time I looked, some tests were failing.


I fixed some more doctest failures in `sage/matrix/matrix_double_dense.pyx`.



---

archive/issue_comments_178586.json:
```json
{
    "body": "> I fixed some more doctest failures in sage/matrix/matrix_double_dense.pyx.\n\n\nall tests do pass now?\n\nPaul",
    "created_at": "2013-04-15T08:27:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178586",
    "user": "https://github.com/zimmermann6"
}
```

> I fixed some more doctest failures in sage/matrix/matrix_double_dense.pyx.


all tests do pass now?

Paul



---

archive/issue_comments_178587.json:
```json
{
    "body": "Some tests might be machine-specific, but at least on most machines, all tests pass indeed.",
    "created_at": "2013-04-15T08:35:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178587",
    "user": "https://github.com/jdemeyer"
}
```

Some tests might be machine-specific, but at least on most machines, all tests pass indeed.



---

archive/issue_comments_178588.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-04-30T11:11:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178588",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_178589.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-04-30T20:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178589",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_178590.json:
```json
{
    "body": "Rebased for doctest failures with #14336.\n\nPaul: are you sure you don't want to review the patch? If the both of us look at the patch, that should be sufficient, no?",
    "created_at": "2013-04-30T20:33:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178590",
    "user": "https://github.com/jdemeyer"
}
```

Rebased for doctest failures with #14336.

Paul: are you sure you don't want to review the patch? If the both of us look at the patch, that should be sufficient, no?



---

archive/issue_comments_178591.json:
```json
{
    "body": "I will try to review it next week. But if someone beats me, no problem!\n\nPaul",
    "created_at": "2013-05-03T15:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178591",
    "user": "https://github.com/zimmermann6"
}
```

I will try to review it next week. But if someone beats me, no problem!

Paul



---

archive/issue_comments_178592.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-05-07T06:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178592",
    "user": "https://github.com/zimmermann6"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_178593.json:
```json
{
    "body": "Jeroen, a few tiny comments:\n\n* in the following test, you can replace 20 by 13. Also, you could add `all([RDF(q) == RR(q) for q  in Q])` which would exercise the code for large numerators and denominators.\n\n```\nsage: Q = continued_fraction(pi, bits=3000).convergents()[20:]\nsage: RDFpi = RDF(pi) \nsage: all([RDF(q) == RDFpi for q  in Q]) \n```\n\n* is the `except?` value really needed in `mpq_get_d_nearest`?\n\n* please replace `round-to-even` with `round-to-nearest-even`. Round to even and round to odd also exist.\n\n* please replace `occured` by `occurred` (several places, already mentioned)\n\nApart from that (and if tests still pass) I'm fine with the patch.\n\nPaul",
    "created_at": "2013-05-07T06:19:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178593",
    "user": "https://github.com/zimmermann6"
}
```

Jeroen, a few tiny comments:

* in the following test, you can replace 20 by 13. Also, you could add `all([RDF(q) == RR(q) for q  in Q])` which would exercise the code for large numerators and denominators.

```
sage: Q = continued_fraction(pi, bits=3000).convergents()[20:]
sage: RDFpi = RDF(pi) 
sage: all([RDF(q) == RDFpi for q  in Q]) 
```

* is the `except?` value really needed in `mpq_get_d_nearest`?

* please replace `round-to-even` with `round-to-nearest-even`. Round to even and round to odd also exist.

* please replace `occured` by `occurred` (several places, already mentioned)

Apart from that (and if tests still pass) I'm fine with the patch.

Paul



---

archive/issue_comments_178594.json:
```json
{
    "body": "Replying to [comment:52 zimmerma]:\n> Jeroen, a few tiny comments:\n> \n> * in the following test, you can replace 20 by 13.\n \nSure, but I wanted some safety margin.\n\n> Also, you could add `all([RDF(q) == RR(q) for q  in Q])`\n\nOK, but then for all covergents (before throwing away the first 20).\n\n> * is the `except?` value really needed in `mpq_get_d_nearest`?\n \nYes, because `sig_on()` can throw exceptions.",
    "created_at": "2013-05-07T06:43:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178594",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:52 zimmerma]:
> Jeroen, a few tiny comments:
> 
> * in the following test, you can replace 20 by 13.
 
Sure, but I wanted some safety margin.

> Also, you could add `all([RDF(q) == RR(q) for q  in Q])`

OK, but then for all covergents (before throwing away the first 20).

> * is the `except?` value really needed in `mpq_get_d_nearest`?
 
Yes, because `sig_on()` can throw exceptions.



---

archive/issue_comments_178595.json:
```json
{
    "body": "I could not apply the patch to 5.9 (after applying successfully the two dependencies):\n\n```\n----------------------------------------------------------------------\n----------------------------------------------------------------------\nsage: hg_sage.import_patch(\"/tmp/14416_QQ_to_RDF_v2.patch\")\ncd \"/localdisk/tmp/sage-5.9/devel/sage\" && sage --hg import   \"/tmp/14416_QQ_to_RDF_v2.patch\"\napplying /tmp/14416_QQ_to_RDF_v2.patch\npatching file sage/matrix/matrix_double_dense.pyx\nHunk #1 FAILED at 1018\nHunk #2 FAILED at 1947\nHunk #3 FAILED at 2087\n3 out of 3 hunks FAILED -- saving rejects to file sage/matrix/matrix_double_dense.pyx.rej\npatching file sage/plot/colors.py\nHunk #1 FAILED at 1301\n1 out of 1 hunks FAILED -- saving rejects to file sage/plot/colors.py.rej\npatching file sage/rings/contfrac.py\nHunk #1 FAILED at 632\n1 out of 1 hunks FAILED -- saving rejects to file sage/rings/contfrac.py.rej\npatching file sage/rings/rational.pyx\nHunk #1 FAILED at 73\nHunk #2 FAILED at 1999\nHunk #3 succeeded at 3660 with fuzz 2 (offset 228 lines).\n2 out of 3 hunks FAILED -- saving rejects to file sage/rings/rational.pyx.rej\nabort: patch failed to apply\n```\nThus I cannot check all tests still pass. We'll have to rely on the testbot.\n| Sage Version 5.9, Release Date: 2013-04-30                         |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\nPaul",
    "created_at": "2013-05-07T07:47:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178595",
    "user": "https://github.com/zimmermann6"
}
```

I could not apply the patch to 5.9 (after applying successfully the two dependencies):

```
----------------------------------------------------------------------
----------------------------------------------------------------------
sage: hg_sage.import_patch("/tmp/14416_QQ_to_RDF_v2.patch")
cd "/localdisk/tmp/sage-5.9/devel/sage" && sage --hg import   "/tmp/14416_QQ_to_RDF_v2.patch"
applying /tmp/14416_QQ_to_RDF_v2.patch
patching file sage/matrix/matrix_double_dense.pyx
Hunk #1 FAILED at 1018
Hunk #2 FAILED at 1947
Hunk #3 FAILED at 2087
3 out of 3 hunks FAILED -- saving rejects to file sage/matrix/matrix_double_dense.pyx.rej
patching file sage/plot/colors.py
Hunk #1 FAILED at 1301
1 out of 1 hunks FAILED -- saving rejects to file sage/plot/colors.py.rej
patching file sage/rings/contfrac.py
Hunk #1 FAILED at 632
1 out of 1 hunks FAILED -- saving rejects to file sage/rings/contfrac.py.rej
patching file sage/rings/rational.pyx
Hunk #1 FAILED at 73
Hunk #2 FAILED at 1999
Hunk #3 succeeded at 3660 with fuzz 2 (offset 228 lines).
2 out of 3 hunks FAILED -- saving rejects to file sage/rings/rational.pyx.rej
abort: patch failed to apply
```
Thus I cannot check all tests still pass. We'll have to rely on the testbot.
| Sage Version 5.9, Release Date: 2013-04-30                         |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
Paul



---

archive/issue_comments_178596.json:
```json
{
    "body": "Attachment [14416_QQ_to_RDF_v2.patch](tarball://root/attachments/some-uuid/ticket14416/14416_QQ_to_RDF_v2.patch) by @jdemeyer created at 2013-05-07 08:58:45\n\nReplying to [comment:54 zimmerma]:\n> I could not apply the patch to 5.9 (after applying successfully the two dependencies):\n\nSince essentially every hunk fails, it looks like you're applying the patch on top of itself.\n\nAnyway, I updated the patch with your suggestions.",
    "created_at": "2013-05-07T08:58:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178596",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [14416_QQ_to_RDF_v2.patch](tarball://root/attachments/some-uuid/ticket14416/14416_QQ_to_RDF_v2.patch) by @jdemeyer created at 2013-05-07 08:58:45

Replying to [comment:54 zimmerma]:
> I could not apply the patch to 5.9 (after applying successfully the two dependencies):

Since essentially every hunk fails, it looks like you're applying the patch on top of itself.

Anyway, I updated the patch with your suggestions.



---

archive/issue_comments_178597.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-05-07T08:59:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178597",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_178598.json:
```json
{
    "body": "Paul, any chance for a review again?",
    "created_at": "2013-05-24T11:59:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178598",
    "user": "https://github.com/jdemeyer"
}
```

Paul, any chance for a review again?



---

archive/issue_comments_178599.json:
```json
{
    "body": "> Paul, any chance for a review again?\n\n\nyes, will do.",
    "created_at": "2013-05-24T12:24:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178599",
    "user": "https://github.com/zimmermann6"
}
```

> Paul, any chance for a review again?


yes, will do.



---

archive/issue_comments_178600.json:
```json
{
    "body": "on top of Sage 5.9, I get doctest failures:\n\n```\nsage -t --long __init__.pyc  # AttributeError in doctesting framework\nsage -t --long env.pyc  # AttributeError in doctesting framework\nsage -t --long misc/interpreter.py  # 1 doctest failed\nsage -t --long misc/trace.py  # 2 doctests failed\nsage -t --long tests/cmdline.py  # 11 doctests failed\nsage -t --long version.pyc  # AttributeError in doctesting framework\nsage -t --long tests/interrupt.pyx  # Time out\n```\nPaul",
    "created_at": "2013-05-27T08:26:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178600",
    "user": "https://github.com/zimmermann6"
}
```

on top of Sage 5.9, I get doctest failures:

```
sage -t --long __init__.pyc  # AttributeError in doctesting framework
sage -t --long env.pyc  # AttributeError in doctesting framework
sage -t --long misc/interpreter.py  # 1 doctest failed
sage -t --long misc/trace.py  # 2 doctests failed
sage -t --long tests/cmdline.py  # 11 doctests failed
sage -t --long version.pyc  # AttributeError in doctesting framework
sage -t --long tests/interrupt.pyx  # Time out
```
Paul



---

archive/issue_comments_178601.json:
```json
{
    "body": "None of these failures look related to this ticket, what does a \"clean\" Sage 5.9 (without any applied patches) give? Please attach the actual doctest failures, not just the summary at the end, otherwise it is impossible to find out what went wrong.",
    "created_at": "2013-05-27T08:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178601",
    "user": "https://github.com/jdemeyer"
}
```

None of these failures look related to this ticket, what does a "clean" Sage 5.9 (without any applied patches) give? Please attach the actual doctest failures, not just the summary at the end, otherwise it is impossible to find out what went wrong.



---

archive/issue_comments_178602.json:
```json
{
    "body": "maybe the doctest failures are due to some interaction with a spkg I installed in another clone of Sage (I installed the patches needed for #9880, and I believe there is side effect from one clone to the other ones for installed spkgs). Is there any way to get a \"clean\" Sage 5.9 without recompiling the sources again?\n\nAnyway my remarks from comment [comment:52] are taken into account, thus provided all tests pass with the testbot, I give a positive review.\n\nPaul",
    "created_at": "2013-05-27T08:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178602",
    "user": "https://github.com/zimmermann6"
}
```

maybe the doctest failures are due to some interaction with a spkg I installed in another clone of Sage (I installed the patches needed for #9880, and I believe there is side effect from one clone to the other ones for installed spkgs). Is there any way to get a "clean" Sage 5.9 without recompiling the sources again?

Anyway my remarks from comment [comment:52] are taken into account, thus provided all tests pass with the testbot, I give a positive review.

Paul



---

archive/issue_events_040946.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-30T08:01:36Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "milestone": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14416#event-40946"
}
```



---

archive/issue_events_040947.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-30T08:01:36Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "milestone": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14416#event-40947"
}
```



---

archive/issue_comments_178603.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-05-30T08:01:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178603",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_178604.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-06-06T12:32:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14416#issuecomment-178604",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_040948.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-06T12:32:33Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14416",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14416#event-40948"
}
```
