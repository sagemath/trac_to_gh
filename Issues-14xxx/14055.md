# Issue 14055: Fix sage-cleaner

archive/issues_013851.json:
```json
{
    "assignees": [
        "https://github.com/nexttime"
    ],
    "body": "`sage-cleaner` got completely broken due to incompatible filenames between `sage-cleaner` and the Sage library.\n\n**Apply**:\n1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.\n2. [attachment: 14055_simplify_env.patch](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz) to the Sage library.\n3. [attachment: trac_14055_maxima_debug.patch](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz) to the Sage library.\n4. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n5. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n\nUpdate ECL spkg with http://boxen.math.washington.edu/home/vbraun/spkg/ecl-12.12.1.p3.spkg\n\nCC:  @ppurka @nbruin\n\nReviewer: **John Palmieri, Leif Leonhardy, Volker Braun**\n\nAuthor: **Jeroen Demeyer, Volker Braun**\n\nMerged: **sage-5.10.beta2**\n\nComponent: **scripts**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14055_\n\n",
    "closed_at": "2013-05-08T07:43:49Z",
    "created_at": "2013-02-04T16:43:49Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20scripts",
        "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.10",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Fix sage-cleaner",
    "type": "issue",
    "updated_at": "2013-05-08T07:43:49Z",
    "url": "https://github.com/sagemath/sage/issues/14055",
    "user": "https://github.com/jdemeyer"
}
```
`sage-cleaner` got completely broken due to incompatible filenames between `sage-cleaner` and the Sage library.

**Apply**:
1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.
2. [attachment: 14055_simplify_env.patch](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz) to the Sage library.
3. [attachment: trac_14055_maxima_debug.patch](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz) to the Sage library.
4. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
5. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.

Update ECL spkg with http://boxen.math.washington.edu/home/vbraun/spkg/ecl-12.12.1.p3.spkg

CC:  @ppurka @nbruin

Reviewer: **John Palmieri, Leif Leonhardy, Volker Braun**

Author: **Jeroen Demeyer, Volker Braun**

Merged: **sage-5.10.beta2**

Component: **scripts**

_Issue created by migration from https://trac.sagemath.org/ticket/14055_





---

archive/issue_events_197586.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-04T16:43:49Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "milestone_number": null,
    "milestone_title": "sage-5.10",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197586"
}
```



---

archive/issue_events_197587.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-04T16:43:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20scripts",
    "label_color": "000080",
    "label_name": "c: scripts",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197587"
}
```



---

archive/issue_events_197588.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-04T16:43:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/p%3A%202%20%E2%80%93%20critical",
    "label_color": "ff7700",
    "label_name": "p: 2 \u2013 critical",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197588"
}
```



---

archive/issue_events_197589.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-04T16:43:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197589"
}
```



---

archive/issue_events_197590.json:
```json
{
    "actor": "https://github.com/nexttime",
    "created_at": "2013-02-04T16:43:49Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "subject": "https://github.com/jdemeyer",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197590"
}
```



---

archive/issue_comments_166863.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nI am working on a patch.",
    "created_at": "2013-02-04T16:44:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166863",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:1" align="right">comment:1</div>

I am working on a patch.



---

archive/issue_events_197591.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-04T21:08:31Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197591"
}
```



---

archive/issue_comments_166864.json:
```json
{
    "body": "Author: **Jeroen Demeyer**",
    "created_at": "2013-02-04T21:08:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166864",
    "user": "https://github.com/jdemeyer"
}
```

Author: **Jeroen Demeyer**



---

archive/issue_comments_166865.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nIn the line\n\n```\npidfile = os.path.join(DOT_SAGE, 'tmp', 'cleaner-%s.pid'%HOSTNAME)\n```\nwould it make sense to use `'temp'` instead of `'tmp'`, so all of the sage-cleaner information is in the same directory?\n\n(Is there any good reason for having both directories `tmp` and `temp`? At some point, we should clean this up.)",
    "created_at": "2013-03-20T15:30:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166865",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:4" align="right">comment:4</div>

In the line

```
pidfile = os.path.join(DOT_SAGE, 'tmp', 'cleaner-%s.pid'%HOSTNAME)
```
would it make sense to use `'temp'` instead of `'tmp'`, so all of the sage-cleaner information is in the same directory?

(Is there any good reason for having both directories `tmp` and `temp`? At some point, we should clean this up.)



---

archive/issue_comments_166866.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nTHERE ARE STILL SOME INSTANCES OF UPPERCASE SAGE.\n\nI don't like the mixture of tmp, temp, TMP and TEMP or whatever.\n\n\n\n\n`temp` and `tmp` shouldn't be hardcoded.\n\n\"Deleting `.../spawned_processes`\" gets printed even if `.../spawned_processes` is not a directory (`not e`), and also `rmtree()` is attempted, ignoring any `OSError`.\n\n\n\n\nI don't like `\"%s\" % i` where `i` is (or should be) an `int`. \n\n\n\n\nCommand line option handling is certainly suboptimal.  (`argv[1]` could be a `float` as well, there's no usage, and additional parameters simply get ignored.)\n\nLikewise, if `DOT_SAGE` isn't set, an ugly `KeyError` is raised, instead of printing a meaningful message.",
    "created_at": "2013-03-20T15:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166866",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:5" align="right">comment:5</div>

THERE ARE STILL SOME INSTANCES OF UPPERCASE SAGE.

I don't like the mixture of tmp, temp, TMP and TEMP or whatever.




`temp` and `tmp` shouldn't be hardcoded.

"Deleting `.../spawned_processes`" gets printed even if `.../spawned_processes` is not a directory (`not e`), and also `rmtree()` is attempted, ignoring any `OSError`.




I don't like `"%s" % i` where `i` is (or should be) an `int`. 




Command line option handling is certainly suboptimal.  (`argv[1]` could be a `float` as well, there's no usage, and additional parameters simply get ignored.)

Likewise, if `DOT_SAGE` isn't set, an ugly `KeyError` is raised, instead of printing a meaningful message.



---

archive/issue_comments_166867.json:
```json
{
    "body": "Changed keywords from none to **orphans**",
    "created_at": "2013-03-20T15:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166867",
    "user": "https://github.com/nexttime"
}
```

Changed keywords from none to **orphans**



---

archive/issue_comments_166868.json:
```json
{
    "body": "Reviewer: **Punarbasu Purkayastha, Leif Leonhardy**",
    "created_at": "2013-03-20T15:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166868",
    "user": "https://github.com/nexttime"
}
```

Reviewer: **Punarbasu Purkayastha, Leif Leonhardy**



---

archive/issue_comments_166869.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nOoops.",
    "created_at": "2013-03-20T15:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166869",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:6" align="right">comment:6</div>

Ooops.



---

archive/issue_comments_166870.json:
```json
{
    "body": "Changed reviewer from **Punarbasu Purkayastha, Leif Leonhardy** to **John Palmieri, Leif Leonhardy**",
    "created_at": "2013-03-20T15:47:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166870",
    "user": "https://github.com/nexttime"
}
```

Changed reviewer from **Punarbasu Purkayastha, Leif Leonhardy** to **John Palmieri, Leif Leonhardy**



---

archive/issue_comments_166871.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nLeif: the subject of this ticket is not \"Fix all possible issues in sage-cleaner\", the goal is to just make it work.",
    "created_at": "2013-03-20T16:56:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166871",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:7" align="right">comment:7</div>

Leif: the subject of this ticket is not "Fix all possible issues in sage-cleaner", the goal is to just make it work.



---

archive/issue_comments_166872.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nReplying to [@jhpalmieri](#comment:4):\n> Is there any good reason for having both directories `tmp` and `temp`?\n\nAbsolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.",
    "created_at": "2013-03-20T16:57:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166872",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:8" align="right">comment:8</div>

Replying to [@jhpalmieri](#comment:4):
> Is there any good reason for having both directories `tmp` and `temp`?

Absolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.



---

archive/issue_comments_166873.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nI am having a problem with this patch, but I don't know why. I am repeatedly running `sage -tp 2 devel/sage/sage/homology/s*`. Without the patch applied, everything is fine. With the patch, after the first successful run, I get this (I also removed the `&>/dev/null` after the call to `sage-cleaner` in `spkg/bin/sage`):\n\n```\n$ sage -tp 2 devel/sage/sage/homology/s*\nSAGE_TMP_ROOT = /Users/palmieri/.sage/temp/jpalmieri538\nStarting sage-cleaner\nChecking PIDs []\nsage-cleaner is finished\nRunning doctests with ID 2013-03-20-11-16-30-613ad8e5.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3 files using 2 threads.\nsage -t devel/sage/sage/homology/simplicial_complex_morphism.py\n    [187 tests, 0.3 s]\nsage -t devel/sage/sage/homology/simplicial_complex_homset.py\n    [49 tests, 0.1 s]\nsage -t devel/sage/sage/homology/simplicial_complex.py\n    Time out after testing finished\n**********************************************************************\nTests run before process timed out:\n\n...\n\n**********************************************************************\n----------------------------------------------------------------------\nsage -t devel/sage/sage/homology/simplicial_complex.py  # Time out after testing finished\n----------------------------------------------------------------------\nTotal time for all tests: 26.9 seconds\n    cpu time: 0.4 seconds\n    cumulative wall time: 0.5 seconds\n```\nWithout the patch, the file `simplicial_complex.py` passes tests in under 7 seconds; cpu time and cumulative wall time are each around 6 or 7 seconds. With the patch, the time out is pretty consistent for each run after the first. I'm seeing this on two different OS X 10.8 machines.\n\nAlso, if I delete the directory `DOT_SAGE/tmp`, then the pidfile won't get written at all during doctesting or when running sage. What script is responsible for creating that directory? If this directory is missing, I don't get the time-out any more, so the problem is really with sage-cleaner.\n\nOn the bright side, it seems to be cleaning out the appropriate files, directories, and processes.",
    "created_at": "2013-03-20T18:46:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166873",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:9" align="right">comment:9</div>

I am having a problem with this patch, but I don't know why. I am repeatedly running `sage -tp 2 devel/sage/sage/homology/s*`. Without the patch applied, everything is fine. With the patch, after the first successful run, I get this (I also removed the `&>/dev/null` after the call to `sage-cleaner` in `spkg/bin/sage`):

```
$ sage -tp 2 devel/sage/sage/homology/s*
SAGE_TMP_ROOT = /Users/palmieri/.sage/temp/jpalmieri538
Starting sage-cleaner
Checking PIDs []
sage-cleaner is finished
Running doctests with ID 2013-03-20-11-16-30-613ad8e5.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3 files using 2 threads.
sage -t devel/sage/sage/homology/simplicial_complex_morphism.py
    [187 tests, 0.3 s]
sage -t devel/sage/sage/homology/simplicial_complex_homset.py
    [49 tests, 0.1 s]
sage -t devel/sage/sage/homology/simplicial_complex.py
    Time out after testing finished
**********************************************************************
Tests run before process timed out:

...

**********************************************************************
----------------------------------------------------------------------
sage -t devel/sage/sage/homology/simplicial_complex.py  # Time out after testing finished
----------------------------------------------------------------------
Total time for all tests: 26.9 seconds
    cpu time: 0.4 seconds
    cumulative wall time: 0.5 seconds
```
Without the patch, the file `simplicial_complex.py` passes tests in under 7 seconds; cpu time and cumulative wall time are each around 6 or 7 seconds. With the patch, the time out is pretty consistent for each run after the first. I'm seeing this on two different OS X 10.8 machines.

Also, if I delete the directory `DOT_SAGE/tmp`, then the pidfile won't get written at all during doctesting or when running sage. What script is responsible for creating that directory? If this directory is missing, I don't get the time-out any more, so the problem is really with sage-cleaner.

On the bright side, it seems to be cleaning out the appropriate files, directories, and processes.



---

archive/issue_comments_166874.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nMaybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away. I'm not sure why that results in a timeout in the doctesting, but anyway, this change fixes the problem for me:\n\n```diff\ndiff --git a/sage-cleaner b/sage-cleaner\n--- a/sage-cleaner\n+++ b/sage-cleaner\n@@ -115,6 +115,7 @@\n         else:\n             wait = 10\n     \n+        time.sleep(wait)\n         # Initial cleanup, ignore time\n         running_sages = cleanup()\n         cleanup_time = 0.0\n```\nI don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?",
    "created_at": "2013-03-20T20:08:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166874",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:10" align="right">comment:10</div>

Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away. I'm not sure why that results in a timeout in the doctesting, but anyway, this change fixes the problem for me:

```diff
diff --git a/sage-cleaner b/sage-cleaner
--- a/sage-cleaner
+++ b/sage-cleaner
@@ -115,6 +115,7 @@
         else:
             wait = 10
     
+        time.sleep(wait)
         # Initial cleanup, ignore time
         running_sages = cleanup()
         cleanup_time = 0.0
```
I don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?



---

archive/issue_comments_166875.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nReplying to [@jdemeyer](#comment:8):\n> Replying to [@jhpalmieri](#comment:4):\n> > Is there any good reason for having both directories `tmp` and `temp`?\n\n> Absolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.\n\nWhere is `DOTSAGE/tmp` used? Certainly the `temp` version is used in the definition of `SAGE_TMP`, so that is ubiquitous. For the file `cleaner-HOSTNAME.pid`, is that referenced anywhere in the Sage library? It looks like we could put that file in `temp` instead of `tmp` safely. Indeed, I can't find any other references to `DOTSAGE/tmp`...",
    "created_at": "2013-03-20T20:37:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166875",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:11" align="right">comment:11</div>

Replying to [@jdemeyer](#comment:8):
> Replying to [@jhpalmieri](#comment:4):
> > Is there any good reason for having both directories `tmp` and `temp`?

> Absolutely not, but at least the directory used in `sage-cleaner` should match the directory used in the Sage library.

Where is `DOTSAGE/tmp` used? Certainly the `temp` version is used in the definition of `SAGE_TMP`, so that is ubiquitous. For the file `cleaner-HOSTNAME.pid`, is that referenced anywhere in the Sage library? It looks like we could put that file in `temp` instead of `tmp` safely. Indeed, I can't find any other references to `DOTSAGE/tmp`...



---

archive/issue_comments_166876.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI've applied this patch to SAGE_ROOT/local/bin, ran \"make ptestlong\" and still got two ecl processes eating RAM when tests were finished without errors.",
    "created_at": "2013-03-20T21:27:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166876",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:12" align="right">comment:12</div>

I've applied this patch to SAGE_ROOT/local/bin, ran "make ptestlong" and still got two ecl processes eating RAM when tests were finished without errors.



---

archive/issue_comments_166877.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\njhpalmieri: I can totally reproduce problems with `devel/sage/sage/homology/simplicial_complex.py`, but they are different from yours and unrelated to `sage-cleaner`: #14323.",
    "created_at": "2013-03-20T21:54:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166877",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:13" align="right">comment:13</div>

jhpalmieri: I can totally reproduce problems with `devel/sage/sage/homology/simplicial_complex.py`, but they are different from yours and unrelated to `sage-cleaner`: #14323.



---

archive/issue_comments_166878.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nIf you look at the output from the doctest command, I find it suspicious that the message \"sage-cleaner is finished\" appears before any doctests are run.",
    "created_at": "2013-03-20T22:04:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166878",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:14" align="right">comment:14</div>

If you look at the output from the doctest command, I find it suspicious that the message "sage-cleaner is finished" appears before any doctests are run.



---

archive/issue_comments_166879.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nReplying to [@jhpalmieri](#comment:14):\n> I find it suspicious that the message \"sage-cleaner is finished\" appears before any doctests are run.\n\nSure, but I don't see how that could lead to doctest failures. It could be that your problem is also an instance of #14323, let's first fix that.",
    "created_at": "2013-03-20T22:11:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166879",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:15" align="right">comment:15</div>

Replying to [@jhpalmieri](#comment:14):
> I find it suspicious that the message "sage-cleaner is finished" appears before any doctests are run.

Sure, but I don't see how that could lead to doctest failures. It could be that your problem is also an instance of #14323, let's first fix that.



---

archive/issue_comments_166880.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@jhpalmieri](#comment:10):\n> Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away.\n> [...]\n> I don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?\n\nI wouldn't rely on some wall time.\n\nUnfortunately the cleaner cannot `wait()` for its parent, but it could poll whether it is still running (or -- much better I think -- wait for another signal), and do nothing until its parent has \"vanished\" (terminated, and no other process with the same PID is meanwhile running -- that's also a potential, although probably unlikely, problem with left-over Sage cleaner and `spawned_processes` PID files; in the latter case, even unrelated processes of the same user could get killed.)\n\nIf there's already another Sage cleaner instance running, it could of course exit immediately (modulo the problem mentioned before).",
    "created_at": "2013-03-20T22:13:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166880",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@jhpalmieri](#comment:10):
> Maybe the problem is that `time.sleep(wait + 3)` used to be called before the first call to `cleanup()`, and now it's not. So now `cleanup()` can be called before any doctesting processes have started, so it returns zero, so sage-cleaner thinks there is nothing to be cleaned up and exits right away.
> [...]
> I don't know if the initial sleep should be for `wait` or a smaller number. Does it matter?

I wouldn't rely on some wall time.

Unfortunately the cleaner cannot `wait()` for its parent, but it could poll whether it is still running (or -- much better I think -- wait for another signal), and do nothing until its parent has "vanished" (terminated, and no other process with the same PID is meanwhile running -- that's also a potential, although probably unlikely, problem with left-over Sage cleaner and `spawned_processes` PID files; in the latter case, even unrelated processes of the same user could get killed.)

If there's already another Sage cleaner instance running, it could of course exit immediately (modulo the problem mentioned before).



---

archive/issue_comments_166881.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nI also get the same problem with `devel/sage/sage/homology/examples.py`, but that file uses libGAP, too. If I doctest both of these, I only get a failure in `examples.py`, while the other passes doctests. Adding my patch from [my comment above](#comment:10) makes the failures go away. I'm still not sure if these problems are related to #14323 or not. If they are, then at least I can reliably produce the failures, and maybe that will help to track them down.",
    "created_at": "2013-03-20T22:20:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166881",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:17" align="right">comment:17</div>

I also get the same problem with `devel/sage/sage/homology/examples.py`, but that file uses libGAP, too. If I doctest both of these, I only get a failure in `examples.py`, while the other passes doctests. Adding my patch from [my comment above](#comment:10) makes the failures go away. I'm still not sure if these problems are related to #14323 or not. If they are, then at least I can reliably produce the failures, and maybe that will help to track them down.



---

archive/issue_comments_166882.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nIn case it helps, I can duplicate this problem on bsd.math.washington.edu.",
    "created_at": "2013-03-21T01:25:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166882",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:18" align="right">comment:18</div>

In case it helps, I can duplicate this problem on bsd.math.washington.edu.



---

archive/issue_comments_166883.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nJohn: please check whether the new spkg at #14323 fixes your problem.",
    "created_at": "2013-03-21T10:49:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166883",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:19" align="right">comment:19</div>

John: please check whether the new spkg at #14323 fixes your problem.



---

archive/issue_comments_166884.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [@jhpalmieri](#comment:18):\n> In case it helps, I can duplicate this problem on bsd.math.washington.edu.\n\nI can indeed reproduce the problem and #14323 doesn't help.",
    "created_at": "2013-03-21T11:37:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166884",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [@jhpalmieri](#comment:18):
> In case it helps, I can duplicate this problem on bsd.math.washington.edu.

I can indeed reproduce the problem and #14323 doesn't help.



---

archive/issue_comments_166885.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nOn boxen, with the spkg from #14323, I see that the issue from that ticket seems to be fixed, but then I can reproduce the issue here.",
    "created_at": "2013-03-21T18:02:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166885",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:21" align="right">comment:21</div>

On boxen, with the spkg from #14323, I see that the issue from that ticket seems to be fixed, but then I can reproduce the issue here.



---

archive/issue_comments_166886.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nI found the problem with `expect.py`: the doctest process starts the `sage-cleaner`, somehow leading to trouble.",
    "created_at": "2013-03-22T08:27:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166886",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:22" align="right">comment:22</div>

I found the problem with `expect.py`: the doctest process starts the `sage-cleaner`, somehow leading to trouble.



---

archive/issue_comments_166887.json:
```json
{
    "body": "Attachment: **[14055_cleaner_sagelib.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz)**",
    "created_at": "2013-03-22T09:29:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166887",
    "user": "https://github.com/jdemeyer"
}
```

Attachment: **[14055_cleaner_sagelib.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz)**



---

archive/issue_comments_166888.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1 +1,5 @@\n `sage-cleaner` got completely broken due to incompatible filenames between `sage-cleaner` and the Sage library.\n+\n+**Apply**:\n+1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.\n+2. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n``````\n",
    "created_at": "2013-03-22T09:31:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166888",
    "user": "https://github.com/jdemeyer"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1 +1,5 @@
 `sage-cleaner` got completely broken due to incompatible filenames between `sage-cleaner` and the Sage library.
+
+**Apply**:
+1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.
+2. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
``````




---

archive/issue_comments_166889.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nAttachment: **[14055_cleaner.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz)**\n\nNeeds review.",
    "created_at": "2013-03-22T09:31:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166889",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:23" align="right">comment:23</div>

Attachment: **[14055_cleaner.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz)**

Needs review.



---

archive/issue_comments_166890.json:
```json
{
    "body": "Changed keywords from **orphans** to none",
    "created_at": "2013-03-22T09:31:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166890",
    "user": "https://github.com/jdemeyer"
}
```

Changed keywords from **orphans** to none



---

archive/issue_comments_166891.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nOnce or twice, after running Sage, quitting, and starting it again, or doing doctests and then running Sage, I've seen this (again, I have allowed sage-cleaner to print its output to the screen):\n\n```\n----------------------------------------------------------------------\n| Sage Version 5.9.beta1, Release Date: 2013-03-22                   |\n| Type \"notebook()\" for the browser-based notebook interface.        |\n| Type \"help()\" for help.                                            |\n----------------------------------------------------------------------\n**********************************************************************\n*                                                                    *\n* Warning: this is a prerelease version, and it may be unstable.     *\n*                                                                    *\n**********************************************************************\nSAGE_TMP_ROOT = /Users/palmieri/.sage/temp/Macintosh_001b639d44a1.local\nsage-cleaner is already running with PID 78006, exiting\nChecking PIDs []\ncleanup() #13 took 0.00s\nsage-cleaner is finished\nsage: \n```\nSure enough, in this case sage-cleaner isn't running while Sage is. Is this a problem? (It does start up if asked to by `interfaces/cleaner.py`.)\n\nI can, not very reliably, reproduce this by starting Sage, letting the count go above 10, quit Sage, wait a second or two, and then restart it.\n\nOtherwise, I think I'm happy with this.",
    "created_at": "2013-03-22T21:46:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166891",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:24" align="right">comment:24</div>

Once or twice, after running Sage, quitting, and starting it again, or doing doctests and then running Sage, I've seen this (again, I have allowed sage-cleaner to print its output to the screen):

```
----------------------------------------------------------------------
| Sage Version 5.9.beta1, Release Date: 2013-03-22                   |
| Type "notebook()" for the browser-based notebook interface.        |
| Type "help()" for help.                                            |
----------------------------------------------------------------------
**********************************************************************
*                                                                    *
* Warning: this is a prerelease version, and it may be unstable.     *
*                                                                    *
**********************************************************************
SAGE_TMP_ROOT = /Users/palmieri/.sage/temp/Macintosh_001b639d44a1.local
sage-cleaner is already running with PID 78006, exiting
Checking PIDs []
cleanup() #13 took 0.00s
sage-cleaner is finished
sage: 
```
Sure enough, in this case sage-cleaner isn't running while Sage is. Is this a problem? (It does start up if asked to by `interfaces/cleaner.py`.)

I can, not very reliably, reproduce this by starting Sage, letting the count go above 10, quit Sage, wait a second or two, and then restart it.

Otherwise, I think I'm happy with this.



---

archive/issue_comments_166892.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nSee #14342 for a sort of follow-up (an attempt to stop using `DOT_SAGE/tmp` altogether).",
    "created_at": "2013-03-22T23:34:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166892",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:25" align="right">comment:25</div>

See #14342 for a sort of follow-up (an attempt to stop using `DOT_SAGE/tmp` altogether).



---

archive/issue_comments_166893.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [@novoselt](#comment:12):\n> I've applied this patch to SAGE_ROOT/local/bin, ran \"make ptestlong\" and still got two ecl processes eating RAM when tests were finished without errors.\n\nDid you meanwhile also try the new versions?  (There's now a patch to the Sage library as well.)",
    "created_at": "2013-03-24T16:40:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166893",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [@novoselt](#comment:12):
> I've applied this patch to SAGE_ROOT/local/bin, ran "make ptestlong" and still got two ecl processes eating RAM when tests were finished without errors.

Did you meanwhile also try the new versions?  (There's now a patch to the Sage library as well.)



---

archive/issue_comments_166894.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nSame story: compile 5.9.beta1, apply both patches here, run \"make ptestlong\" and there are two ecl processes. I also got failures\n\n```\nsage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\nsage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\nsage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\n```",
    "created_at": "2013-03-28T16:59:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166894",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:27" align="right">comment:27</div>

Same story: compile 5.9.beta1, apply both patches here, run "make ptestlong" and there are two ecl processes. I also got failures

```
sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
```



---

archive/issue_comments_166895.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nReplying to [@novoselt](#comment:27):\n> Same story: compile 5.9.beta1, apply both patches here, run \"make ptestlong\" and there are two ecl processes. I also got failures\n> \n> ```\n> sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\n> sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\n> sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\n> ```\n\nPlease show which tests are failing.",
    "created_at": "2013-03-28T17:10:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166895",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:28" align="right">comment:28</div>

Replying to [@novoselt](#comment:27):
> Same story: compile 5.9.beta1, apply both patches here, run "make ptestlong" and there are two ecl processes. I also got failures
> 
> ```
> sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
> sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
> sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
> ```

Please show which tests are failing.



---

archive/issue_comments_166896.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\n\n```\nnovoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\nRunning doctests with ID 2013-03-28-13-53-51-e8efe0bf.\nDoctesting 1 file.\nsage -t --long devel/sage/sage/homology/simplicial_complex.py\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3134, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    S.automorphism_group().is_isomorphic(SymmetricGroup(4))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[1]>\", line 1, in <module>\n        S.automorphism_group().is_isomorphic(SymmetricGroup(Integer(4)))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1285, in __init__\n        raise TypeError, x\n    TypeError: list.remove(x): x not in list\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3138, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    P.automorphism_group().is_isomorphic(AlternatingGroup(5))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[3]>\", line 1, in <module>\n        P.automorphism_group().is_isomorphic(AlternatingGroup(Integer(5)))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 730, in _eval_line\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1175, in _start\n        Expect._start(self, \"Failed to start GAP.\")\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 443, in _start\n        self._expect.expect(self._prompt)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 916, in expect\n        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 967, in expect_list\n        c = self.read_nonblocking (self.maxread, timeout)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 548, in read_nonblocking\n        r, w, e = select.select([self.child_fd], [], [], timeout)\n    error: (4, 'Interrupted system call')\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3142, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(2))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[5]>\", line 1, in <module>\n        Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(Integer(2)))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 736, in _eval_line\n        expect_eof= (self._quit_string() in line))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 597, in _execute_line\n        x = E.expect_list(self._compiled_full_pattern)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 516, in __getattr__\n        return ParentWithBase.__getattribute__(self, attrname)\n      File \"parent.pyx\", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)\n    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3144, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    group, dict = Z.automorphism_group(translation=True)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[6]>\", line 1, in <module>\n        group, dict = Z.automorphism_group(translation=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py\", line 3155, in automorphism_group\n        [f.tuple() for f in self.facets()]])\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py\", line 16543, in automorphism_group\n        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))\n      File \"refinement_graphs.pyx\", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py\", line 653, in __call__\n        return self._element_class()(x, self, check=check)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 736, in _eval_line\n        expect_eof= (self._quit_string() in line))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 597, in _execute_line\n        x = E.expect_list(self._compiled_full_pattern)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 516, in __getattr__\n        return ParentWithBase.__getattribute__(self, attrname)\n      File \"parent.pyx\", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)\n    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'\n**********************************************************************\nFile \"devel/sage/sage/homology/simplicial_complex.py\", line 3145, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\nFailed example:\n    Set([dict[s] for s in Z.vertices()])\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[7]>\", line 1, in <module>\n        Set([dict[s] for s in Z.vertices()])\n    TypeError: 'type' object has no attribute '__getitem__'\n**********************************************************************\n1 item had failures:\n   5 of   9 in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group\n    [409 tests, 5 failures, 10.0 s]\n----------------------------------------------------------------------\nsage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 10.3 seconds\n    cpu time: 7.9 seconds\n    cumulative wall time: 10.0 seconds\n```\n\n```\nnovoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\nRunning doctests with ID 2013-03-28-13-55-04-e18989af.\nDoctesting 1 file.\nsage -t --long devel/sage/sage/libs/gap/libgap.pyx\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 23, in sage.libs.gap.libgap\nFailed example:\n    b = gap('10')\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[5]>\", line 1, in <module>\n        b = gap('10')\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1285, in __init__\n        raise TypeError, x\n    TypeError: list.remove(x): x not in list\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 24, in sage.libs.gap.libgap\nFailed example:\n    timeit('b*b')   # random output\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[6]>\", line 1, in <module>\n        timeit('b*b')   # random output\n      File \"sage_timeit_class.pyx\", line 114, in sage.misc.sage_timeit_class.SageTimeit.__call__ (sage/misc/sage_timeit_class.c:931)\n      File \"sage_timeit_class.pyx\", line 78, in sage.misc.sage_timeit_class.SageTimeit.eval (sage/misc/sage_timeit_class.c:731)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/sage_timeit.py\", line 236, in sage_timeit\n        if timer.timeit(number) >= 0.2:\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python/timeit.py\", line 195, in timeit\n        timing = self.inner(it, self.timer)\n      File \"<magic-timeit>\", line 6, in inner\n    NameError: global name 'b' is not defined\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 52, in sage.libs.gap.libgap\nFailed example:\n    generators = libgap.AlternatingGroup(4).GeneratorsOfGroup().sage()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[13]>\", line 1, in <module>\n        generators = libgap.AlternatingGroup(Integer(4)).GeneratorsOfGroup().sage()\n      File \"element.pyx\", line 1617, in sage.libs.gap.element.GapElement_List.sage (sage/libs/gap/element.c:9500)\n      File \"element.pyx\", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 730, in _eval_line\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1175, in _start\n        Expect._start(self, \"Failed to start GAP.\")\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 443, in _start\n        self._expect.expect(self._prompt)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 916, in expect\n        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 967, in expect_list\n        c = self.read_nonblocking (self.maxread, timeout)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 548, in read_nonblocking\n        r, w, e = select.select([self.child_fd], [], [], timeout)\n    error: (4, 'Interrupted system call')\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 53, in sage.libs.gap.libgap\nFailed example:\n    generators   # a Sage list of Sage permutations!\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[14]>\", line 1, in <module>\n        generators   # a Sage list of Sage permutations!\n    NameError: name 'generators' is not defined\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/libgap.pyx\", line 55, in sage.libs.gap.libgap\nFailed example:\n    PermutationGroup(generators).cardinality()   # computed in Sage\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.libgap[15]>\", line 1, in <module>\n        PermutationGroup(generators).cardinality()   # computed in Sage\n    NameError: name 'generators' is not defined\n**********************************************************************\n1 item had failures:\n   5 of  36 in sage.libs.gap.libgap\n    [63 tests, 5 failures, 5.3 s]\n----------------------------------------------------------------------\nsage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 5.4 seconds\n    cpu time: 5.1 seconds\n    cumulative wall time: 5.3 seconds\n```\n\n```\nnovoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\nRunning doctests with ID 2013-03-28-13-55-47-94cfc7ed.\nDoctesting 1 file.\nsage -t --long devel/sage/sage/libs/gap/element.pyx\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/element.pyx\", line 1400, in sage.libs.gap.element.GapElement_Function._sage_doc_\nFailed example:\n    'constructs  the  cyclic  group' in f._sage_doc_()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.element.GapElement_Function._sage_doc_[1]>\", line 1, in <module>\n        'constructs  the  cyclic  group' in f._sage_doc_()\n      File \"element.pyx\", line 1407, in sage.libs.gap.element.GapElement_Function._sage_doc_ (sage/libs/gap/element.c:8928)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1287, in help\n        tmp_to_use = self._local_tmpfile()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 581, in _local_tmpfile\n        self.__local_tmpfile = os.path.join(SAGE_TMP_INTERFACE, 'tmp' + str(self.pid()))\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 298, in pid\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1180, in _start\n        expect.failed_to_start.remove(self.name())\n    ValueError: list.remove(x): x not in list\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/element.pyx\", line 1666, in sage.libs.gap.element.GapElement_Permutation.sage\nFailed example:\n    perm_gap.sage()\nException raised:\n    Traceback (most recent call last):\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 459, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 815, in execute\n        exec compiled in globs\n      File \"<doctest sage.libs.gap.element.GapElement_Permutation.sage[1]>\", line 1, in <module>\n        perm_gap.sage()\n      File \"element.pyx\", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)\n      File \"permgroup_element.pyx\", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)\n      File \"sage_object.pyx\", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1322, in set\n        out = self._eval_line(cmd, allow_use_file=True)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 730, in _eval_line\n        self._start()\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py\", line 1175, in _start\n        Expect._start(self, \"Failed to start GAP.\")\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 443, in _start\n        self._expect.expect(self._prompt)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 916, in expect\n        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 967, in expect_list\n        c = self.read_nonblocking (self.maxread, timeout)\n      File \"/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py\", line 548, in read_nonblocking\n        r, w, e = select.select([self.child_fd], [], [], timeout)\n    error: (4, 'Interrupted system call')\n**********************************************************************\nFile \"devel/sage/sage/libs/gap/element.pyx\", line 1668, in sage.libs.gap.element.GapElement_Permutation.sage\nFailed example:\n    type(_)\nExpected:\n    <type 'sage.groups.perm_gps.permgroup_element.PermutationGroupElement'>\nGot:\n    <type 'sage.libs.gap.element.GapElement_Permutation'>\n**********************************************************************\n2 items had failures:\n   1 of   3 in sage.libs.gap.element.GapElement_Function._sage_doc_\n   2 of   4 in sage.libs.gap.element.GapElement_Permutation.sage\n    [256 tests, 3 failures, 5.5 s]\n----------------------------------------------------------------------\nsage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 5.6 seconds\n    cpu time: 5.3 seconds\n    cumulative wall time: 5.5 seconds\n```",
    "created_at": "2013-03-28T19:56:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166896",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:29" align="right">comment:29</div>


```
novoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
Running doctests with ID 2013-03-28-13-53-51-e8efe0bf.
Doctesting 1 file.
sage -t --long devel/sage/sage/homology/simplicial_complex.py
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3134, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    S.automorphism_group().is_isomorphic(SymmetricGroup(4))
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[1]>", line 1, in <module>
        S.automorphism_group().is_isomorphic(SymmetricGroup(Integer(4)))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1285, in __init__
        raise TypeError, x
    TypeError: list.remove(x): x not in list
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3138, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    P.automorphism_group().is_isomorphic(AlternatingGroup(5))
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[3]>", line 1, in <module>
        P.automorphism_group().is_isomorphic(AlternatingGroup(Integer(5)))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 730, in _eval_line
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1175, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 443, in _start
        self._expect.expect(self._prompt)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 916, in expect
        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 967, in expect_list
        c = self.read_nonblocking (self.maxread, timeout)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 548, in read_nonblocking
        r, w, e = select.select([self.child_fd], [], [], timeout)
    error: (4, 'Interrupted system call')
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3142, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(2))
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[5]>", line 1, in <module>
        Z.automorphism_group().is_isomorphic(CyclicPermutationGroup(Integer(2)))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 736, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 597, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 516, in __getattr__
        return ParentWithBase.__getattribute__(self, attrname)
      File "parent.pyx", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)
    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3144, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    group, dict = Z.automorphism_group(translation=True)
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[6]>", line 1, in <module>
        group, dict = Z.automorphism_group(translation=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/homology/simplicial_complex.py", line 3155, in automorphism_group
        [f.tuple() for f in self.facets()]])
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/graphs/generic_graph.py", line 16543, in automorphism_group
        output.append(PermutationGroup([perm_group_elt(aa) for aa in a]))
      File "refinement_graphs.pyx", line 941, in sage.groups.perm_gps.partn_ref.refinement_graphs.perm_group_elt (sage/groups/perm_gps/partn_ref/refinement_graphs.c:32796)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/groups/perm_gps/permgroup.py", line 653, in __call__
        return self._element_class()(x, self, check=check)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 736, in _eval_line
        expect_eof= (self._quit_string() in line))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 597, in _execute_line
        x = E.expect_list(self._compiled_full_pattern)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 516, in __getattr__
        return ParentWithBase.__getattribute__(self, attrname)
      File "parent.pyx", line 675, in sage.structure.parent.Parent.__getattr__ (sage/structure/parent.c:6215)
    AttributeError: 'Gap' object has no attribute '_compiled_full_pattern'
**********************************************************************
File "devel/sage/sage/homology/simplicial_complex.py", line 3145, in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
Failed example:
    Set([dict[s] for s in Z.vertices()])
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.homology.simplicial_complex.SimplicialComplex.automorphism_group[7]>", line 1, in <module>
        Set([dict[s] for s in Z.vertices()])
    TypeError: 'type' object has no attribute '__getitem__'
**********************************************************************
1 item had failures:
   5 of   9 in sage.homology.simplicial_complex.SimplicialComplex.automorphism_group
    [409 tests, 5 failures, 10.0 s]
----------------------------------------------------------------------
sage -t --long devel/sage/sage/homology/simplicial_complex.py  # 5 doctests failed
----------------------------------------------------------------------
Total time for all tests: 10.3 seconds
    cpu time: 7.9 seconds
    cumulative wall time: 10.0 seconds
```

```
novoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
Running doctests with ID 2013-03-28-13-55-04-e18989af.
Doctesting 1 file.
sage -t --long devel/sage/sage/libs/gap/libgap.pyx
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 23, in sage.libs.gap.libgap
Failed example:
    b = gap('10')
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[5]>", line 1, in <module>
        b = gap('10')
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1285, in __init__
        raise TypeError, x
    TypeError: list.remove(x): x not in list
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 24, in sage.libs.gap.libgap
Failed example:
    timeit('b*b')   # random output
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[6]>", line 1, in <module>
        timeit('b*b')   # random output
      File "sage_timeit_class.pyx", line 114, in sage.misc.sage_timeit_class.SageTimeit.__call__ (sage/misc/sage_timeit_class.c:931)
      File "sage_timeit_class.pyx", line 78, in sage.misc.sage_timeit_class.SageTimeit.eval (sage/misc/sage_timeit_class.c:731)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/misc/sage_timeit.py", line 236, in sage_timeit
        if timer.timeit(number) >= 0.2:
      File "/home/novoselt/sage-5.9.beta1/local/lib/python/timeit.py", line 195, in timeit
        timing = self.inner(it, self.timer)
      File "<magic-timeit>", line 6, in inner
    NameError: global name 'b' is not defined
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 52, in sage.libs.gap.libgap
Failed example:
    generators = libgap.AlternatingGroup(4).GeneratorsOfGroup().sage()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[13]>", line 1, in <module>
        generators = libgap.AlternatingGroup(Integer(4)).GeneratorsOfGroup().sage()
      File "element.pyx", line 1617, in sage.libs.gap.element.GapElement_List.sage (sage/libs/gap/element.c:9500)
      File "element.pyx", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 730, in _eval_line
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1175, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 443, in _start
        self._expect.expect(self._prompt)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 916, in expect
        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 967, in expect_list
        c = self.read_nonblocking (self.maxread, timeout)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 548, in read_nonblocking
        r, w, e = select.select([self.child_fd], [], [], timeout)
    error: (4, 'Interrupted system call')
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 53, in sage.libs.gap.libgap
Failed example:
    generators   # a Sage list of Sage permutations!
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[14]>", line 1, in <module>
        generators   # a Sage list of Sage permutations!
    NameError: name 'generators' is not defined
**********************************************************************
File "devel/sage/sage/libs/gap/libgap.pyx", line 55, in sage.libs.gap.libgap
Failed example:
    PermutationGroup(generators).cardinality()   # computed in Sage
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.libgap[15]>", line 1, in <module>
        PermutationGroup(generators).cardinality()   # computed in Sage
    NameError: name 'generators' is not defined
**********************************************************************
1 item had failures:
   5 of  36 in sage.libs.gap.libgap
    [63 tests, 5 failures, 5.3 s]
----------------------------------------------------------------------
sage -t --long devel/sage/sage/libs/gap/libgap.pyx  # 5 doctests failed
----------------------------------------------------------------------
Total time for all tests: 5.4 seconds
    cpu time: 5.1 seconds
    cumulative wall time: 5.3 seconds
```

```
novoselt@sage:~/sage-5.9.beta1$ ./sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
Running doctests with ID 2013-03-28-13-55-47-94cfc7ed.
Doctesting 1 file.
sage -t --long devel/sage/sage/libs/gap/element.pyx
**********************************************************************
File "devel/sage/sage/libs/gap/element.pyx", line 1400, in sage.libs.gap.element.GapElement_Function._sage_doc_
Failed example:
    'constructs  the  cyclic  group' in f._sage_doc_()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.element.GapElement_Function._sage_doc_[1]>", line 1, in <module>
        'constructs  the  cyclic  group' in f._sage_doc_()
      File "element.pyx", line 1407, in sage.libs.gap.element.GapElement_Function._sage_doc_ (sage/libs/gap/element.c:8928)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1287, in help
        tmp_to_use = self._local_tmpfile()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 581, in _local_tmpfile
        self.__local_tmpfile = os.path.join(SAGE_TMP_INTERFACE, 'tmp' + str(self.pid()))
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 298, in pid
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1180, in _start
        expect.failed_to_start.remove(self.name())
    ValueError: list.remove(x): x not in list
**********************************************************************
File "devel/sage/sage/libs/gap/element.pyx", line 1666, in sage.libs.gap.element.GapElement_Permutation.sage
Failed example:
    perm_gap.sage()
Exception raised:
    Traceback (most recent call last):
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 459, in _run
        self.execute(example, compiled, test.globs)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 815, in execute
        exec compiled in globs
      File "<doctest sage.libs.gap.element.GapElement_Permutation.sage[1]>", line 1, in <module>
        perm_gap.sage()
      File "element.pyx", line 1673, in sage.libs.gap.element.GapElement_Permutation.sage (sage/libs/gap/element.c:9699)
      File "permgroup_element.pyx", line 452, in sage.groups.perm_gps.permgroup_element.PermutationGroupElement.__init__ (sage/groups/perm_gps/permgroup_element.c:4490)
      File "sage_object.pyx", line 474, in sage.structure.sage_object.SageObject._gap_ (sage/structure/sage_object.c:4544)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1322, in set
        out = self._eval_line(cmd, allow_use_file=True)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 730, in _eval_line
        self._start()
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/gap.py", line 1175, in _start
        Expect._start(self, "Failed to start GAP.")
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 443, in _start
        self._expect.expect(self._prompt)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 916, in expect
        return self.expect_list(compiled_pattern_list, timeout, searchwindowsize)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 967, in expect_list
        c = self.read_nonblocking (self.maxread, timeout)
      File "/home/novoselt/sage-5.9.beta1/local/lib/python2.7/site-packages/pexpect.py", line 548, in read_nonblocking
        r, w, e = select.select([self.child_fd], [], [], timeout)
    error: (4, 'Interrupted system call')
**********************************************************************
File "devel/sage/sage/libs/gap/element.pyx", line 1668, in sage.libs.gap.element.GapElement_Permutation.sage
Failed example:
    type(_)
Expected:
    <type 'sage.groups.perm_gps.permgroup_element.PermutationGroupElement'>
Got:
    <type 'sage.libs.gap.element.GapElement_Permutation'>
**********************************************************************
2 items had failures:
   1 of   3 in sage.libs.gap.element.GapElement_Function._sage_doc_
   2 of   4 in sage.libs.gap.element.GapElement_Permutation.sage
    [256 tests, 3 failures, 5.5 s]
----------------------------------------------------------------------
sage -t --long devel/sage/sage/libs/gap/element.pyx  # 3 doctests failed
----------------------------------------------------------------------
Total time for all tests: 5.6 seconds
    cpu time: 5.3 seconds
    cumulative wall time: 5.5 seconds
```



---

archive/issue_comments_166897.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nPlease apply #14323 (if you haven't) and try again.",
    "created_at": "2013-03-28T20:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166897",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:30" align="right">comment:30</div>

Please apply #14323 (if you haven't) and try again.



---

archive/issue_comments_166898.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\n#14323 fixes the doctest failures, but not ecl processes...",
    "created_at": "2013-03-28T20:41:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166898",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:31" align="right">comment:31</div>

#14323 fixes the doctest failures, but not ecl processes...



---

archive/issue_comments_166899.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nReplying to [@novoselt](#comment:31):\n> #14323 fixes the doctest failures, but not ecl processes...\n\nI'm now among the lucky few who get these greedy, immortal ECL processes:\n\nWith Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).\n\nTwo ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.",
    "created_at": "2013-03-30T23:40:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166899",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:32" align="right">comment:32</div>

Replying to [@novoselt](#comment:31):
> #14323 fixes the doctest failures, but not ecl processes...

I'm now among the lucky few who get these greedy, immortal ECL processes:

With Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).

Two ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.



---

archive/issue_comments_166900.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nWhat needs to be done here. [I asked a question earlier](#comment:24), but otherwise, are there issues with this?",
    "created_at": "2013-04-04T14:53:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166900",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:33" align="right">comment:33</div>

What needs to be done here. [I asked a question earlier](#comment:24), but otherwise, are there issues with this?



---

archive/issue_comments_166901.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nThat [question](#comment:24) is really a race condition between exiting one Sage cleaner and starting another. I'll think about it.",
    "created_at": "2013-04-04T15:21:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166901",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:34" align="right">comment:34</div>

That [question](#comment:24) is really a race condition between exiting one Sage cleaner and starting another. I'll think about it.



---

archive/issue_comments_166902.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [@nexttime](#comment:32):\n> Replying to [@novoselt](#comment:31):\n> > #14323 fixes the doctest failures, but not ecl processes...\n\n> \n> I'm now among the lucky few who get these greedy, immortal ECL processes:\n> \n> With Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).\n> \n> Two ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.\n\nSame on Ubuntu 10.04.4 x86, GCC 4.7.2, and `ptestlong`.  I also got an orphaned Maxima process (running at 100%) in the first run.  (Sage 5.9.beta2, no patches from here applied.)",
    "created_at": "2013-04-04T20:34:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166902",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [@nexttime](#comment:32):
> Replying to [@novoselt](#comment:31):
> > #14323 fixes the doctest failures, but not ecl processes...

> 
> I'm now among the lucky few who get these greedy, immortal ECL processes:
> 
> With Sage 5.9.beta2 (which includes #14323), GCC 4.8.0, on Ubuntu 10.04.4 x86_64, during `make` **testlong** (as opposed to `make ptestlong` -- others previously reported only the latter caused problems).
> 
> Two ECL processes show up while testing `sage/interfaces/lisp.py` (as I had guessed), quickly start eating up memory, and keep running even after the file has been tested without any errors.

Same on Ubuntu 10.04.4 x86, GCC 4.7.2, and `ptestlong`.  I also got an orphaned Maxima process (running at 100%) in the first run.  (Sage 5.9.beta2, no patches from here applied.)



---

archive/issue_comments_166903.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nSo I've continued experimenting with Sage 5.8 vs. 5.9.beta2 (same system, same compiler and flags), and it turns out that the rogue ECL processes are solely caused by the new doctesting framework, so we should probably open another ticket for that issue.  (I did the tests with the Sage cleaner \"disabled\" in both releases, too, with the same results: 5.8, with the old doctesting framework: No problems at all.  5.9.beta2: ECL orphans every time I run doctests from the Makefile, no problems when run from the command line, i.e., without using `make`.)\n\nMinimal receipt to reproduce the orphans here:\n\n```make\ntestlisp:\n        ./sage -t devel/sage/sage/interfaces/lisp.py\n```\nRunning `make testlisp`.\n\nThe (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a \"normal\" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.\n\n(Note that also ECL didn't change between 5.8 and 5.9.beta2.)\n\nSo fixing the Sage cleaner alone *may* alleviate the problem, but won't really solve it.",
    "created_at": "2013-04-06T18:06:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166903",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:36" align="right">comment:36</div>

So I've continued experimenting with Sage 5.8 vs. 5.9.beta2 (same system, same compiler and flags), and it turns out that the rogue ECL processes are solely caused by the new doctesting framework, so we should probably open another ticket for that issue.  (I did the tests with the Sage cleaner "disabled" in both releases, too, with the same results: 5.8, with the old doctesting framework: No problems at all.  5.9.beta2: ECL orphans every time I run doctests from the Makefile, no problems when run from the command line, i.e., without using `make`.)

Minimal receipt to reproduce the orphans here:

```make
testlisp:
        ./sage -t devel/sage/sage/interfaces/lisp.py
```
Running `make testlisp`.

The (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a "normal" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.

(Note that also ECL didn't change between 5.8 and 5.9.beta2.)

So fixing the Sage cleaner alone *may* alleviate the problem, but won't really solve it.



---

archive/issue_comments_166904.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [@nexttime](#comment:36):\n> [...]\n> Minimal receipt to reproduce the orphans here:\n> \n> ```make\n> testlisp:\n>         ./sage -t devel/sage/sage/interfaces/lisp.py\n> ```\n> Running `make testlisp`.\n> \n> The (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a \"normal\" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.\n\nDid a little more testing ...\n\nWith (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)\n\nStill, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.",
    "created_at": "2013-04-06T22:43:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166904",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [@nexttime](#comment:36):
> [...]
> Minimal receipt to reproduce the orphans here:
> 
> ```make
> testlisp:
>         ./sage -t devel/sage/sage/interfaces/lisp.py
> ```
> Running `make testlisp`.
> 
> The (un)setting of `MAKE`, using `make -j1`, `./sage -t` vs. `./sage -tp` etc. doesn't matter, nor does using `$(PIPE)` (or `spkg/bin/pipestatus`), or `tee`ing the output with a "normal" pipe;  it just works when running `./sage -t ...` from the command line, while I get the busy orphans as soon as I run the exact same command(s) from the Makefile.

Did a little more testing ...

With (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)

Still, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.



---

archive/issue_comments_166905.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nReplying to [@nexttime](#comment:37):\n> With (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)\n> \n> Still, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.\n\nOh, indeed at least Ubuntu 12.04.1 LTS still has (some?) GNU Make 3.81 ... m)",
    "created_at": "2013-04-06T22:49:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166905",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:38" align="right">comment:38</div>

Replying to [@nexttime](#comment:37):
> With (Ubuntu 10.04.4's) GNU Make 3.81, I do get the orphans, while I don't get them with (vanilla) GNU Make 3.82.  (I haven't found any particularly interesting change in 3.82's NEWS.)
> 
> Still, at least John Cremona reported getting the orphans on Ubuntu 12.04 as well, and I strongly doubt Precise still ships GNU Make 3.81 (released 2006, while 3.82 was released in 2010, although Ubuntu might [still] patch its version, haven't checked that).  And we currently don't require the latest version of GNU Make either.

Oh, indeed at least Ubuntu 12.04.1 LTS still has (some?) GNU Make 3.81 ... m)



---

archive/issue_comments_166906.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nThe ECL problem is fixed and needs review at #14426.",
    "created_at": "2013-04-08T12:04:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166906",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:39" align="right">comment:39</div>

The ECL problem is fixed and needs review at #14426.



---

archive/issue_comments_166907.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nHere is my view on this ticket:\n\n- `sage-cleaner` used to be completely broken.\n- this ticket mostly fixes it.\n- the only flaw I see is a [race condition](#comment:24), but that looks pretty rare. Fixing it can wait.\n- there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.\n\nSo I'm willing to give this a positive review. Any dissenting views?",
    "created_at": "2013-04-08T18:48:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166907",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:40" align="right">comment:40</div>

Here is my view on this ticket:

- `sage-cleaner` used to be completely broken.
- this ticket mostly fixes it.
- the only flaw I see is a [race condition](#comment:24), but that looks pretty rare. Fixing it can wait.
- there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.

So I'm willing to give this a positive review. Any dissenting views?



---

archive/issue_comments_166908.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [@jhpalmieri](#comment:40):\n> Here is my view on this ticket:\n> \n> - `sage-cleaner` used to be completely broken.\n\nI actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.\n\n> - this ticket mostly fixes it.\n> - the only flaw I see is a [race condition](#comment:24), but that looks pretty rare. Fixing it can wait.\n\nAgreed, although I haven't closely looked at that yet.  (It's pretty clear that there is a race condition, but I'm not sure how likely it is in practice.)\n\n> - there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.\n> \n> So I'm willing to give this a positive review. Any dissenting views?\n\nHmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken.",
    "created_at": "2013-04-08T19:08:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166908",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [@jhpalmieri](#comment:40):
> Here is my view on this ticket:
> 
> - `sage-cleaner` used to be completely broken.

I actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.

> - this ticket mostly fixes it.
> - the only flaw I see is a [race condition](#comment:24), but that looks pretty rare. Fixing it can wait.

Agreed, although I haven't closely looked at that yet.  (It's pretty clear that there is a race condition, but I'm not sure how likely it is in practice.)

> - there are undoubtedly other ways in which `sage-cleaner` could be fixed up, but they can wait.
> 
> So I'm willing to give this a positive review. Any dissenting views?

Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken.



---

archive/issue_comments_166909.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nReplying to [@nexttime](#comment:41):\n> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. \n\nOoops, of course regardless of #12426, but I meant #14426.",
    "created_at": "2013-04-08T19:12:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166909",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:42" align="right">comment:42</div>

Replying to [@nexttime](#comment:41):
> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. 

Ooops, of course regardless of #12426, but I meant #14426.



---

archive/issue_comments_166910.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nReplying to [@nexttime](#comment:41):\n> Replying to [@jhpalmieri](#comment:40):\n> > Here is my view on this ticket:\n> > \n> > - `sage-cleaner` used to be completely broken.\n\n> \n> I actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.\n\nI haven't seen problems with processes, but the subdirectories of `DOT_SAGE/temp/` have been polluted with many directories dating back to 5.8 at least, because sage-cleaner was looking in the wrong directory.\n\n> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. \n\nIn your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?",
    "created_at": "2013-04-08T20:00:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166910",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:43" align="right">comment:43</div>

Replying to [@nexttime](#comment:41):
> Replying to [@jhpalmieri](#comment:40):
> > Here is my view on this ticket:
> > 
> > - `sage-cleaner` used to be completely broken.

> 
> I actually didn't have problems with it recently (more precisely, for meanwhile a few years), until 5.9.x.

I haven't seen problems with processes, but the subdirectories of `DOT_SAGE/temp/` have been polluted with many directories dating back to 5.8 at least, because sage-cleaner was looking in the wrong directory.

> Hmmm, *in principle<sup>TM</sup>* the Sage cleaner (with the patches from here) should have killed the ECL processes, but Andrey reported it did not, so (regardless of #12426) something seems to be still broken. 

In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?



---

archive/issue_comments_166911.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nReplying to [@jhpalmieri](#comment:43):\n> Replying to [@nexttime](#comment:41):\n> In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?\n\nThat's a question to Andrey (just in case that wasn't clear).",
    "created_at": "2013-04-08T20:10:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166911",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:44" align="right">comment:44</div>

Replying to [@jhpalmieri](#comment:43):
> Replying to [@nexttime](#comment:41):
> In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?

That's a question to Andrey (just in case that wasn't clear).



---

archive/issue_comments_166912.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nReplying to [@nexttime](#comment:44):\n> Replying to [@jhpalmieri](#comment:43):\n> > Replying to [@nexttime](#comment:41):\n> > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?\n\n> \n> That's a question to Andrey (just in case that wasn't clear).\n\nIt was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.",
    "created_at": "2013-04-08T20:17:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166912",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:45" align="right">comment:45</div>

Replying to [@nexttime](#comment:44):
> Replying to [@jhpalmieri](#comment:43):
> > Replying to [@nexttime](#comment:41):
> > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?

> 
> That's a question to Andrey (just in case that wasn't clear).

It was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.



---

archive/issue_comments_166913.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nReplying to [@novoselt](#comment:45):\n> Replying to [@nexttime](#comment:44):\n> > Replying to [@jhpalmieri](#comment:43):\n> > > Replying to [@nexttime](#comment:41):\n> > > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?\n\n> > \n> > That's a question to Andrey (just in case that wasn't clear).\n\n> \n> It was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.\n\nThe ECL processes' PIDs should be in the `spawned_processes` text file, with the patches from here now located in the directory `sage.misc.SAGE_TMP` (usually some `$DOT_SAGE/temp/<hostname>-<pid>/...` or `$DOT_SAGE/temp/<hostname>/<pid>/`?).",
    "created_at": "2013-04-08T20:38:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166913",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:46" align="right">comment:46</div>

Replying to [@novoselt](#comment:45):
> Replying to [@nexttime](#comment:44):
> > Replying to [@jhpalmieri](#comment:43):
> > > Replying to [@nexttime](#comment:41):
> > > In your testing, could you tell whether the correct PID (for the runaway process) was written to the correct file? How did the runaway process escape the cleaner?

> > 
> > That's a question to Andrey (just in case that wasn't clear).

> 
> It was not ;-) I have no idea how to check it, but if you provide me with instructions on what files to look at, I'll be happy to do it. ECL processes appear consistently for me until #14426, so reproduction is trivial.

The ECL processes' PIDs should be in the `spawned_processes` text file, with the patches from here now located in the directory `sage.misc.SAGE_TMP` (usually some `$DOT_SAGE/temp/<hostname>-<pid>/...` or `$DOT_SAGE/temp/<hostname>/<pid>/`?).



---

archive/issue_comments_166914.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\n(Edited last comment.)",
    "created_at": "2013-04-08T20:40:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166914",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:47" align="right">comment:47</div>

(Edited last comment.)



---

archive/issue_comments_166915.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nLeif, I actually intended the question for you, because of the testing [you](#comment:36) [mentioned](#comment:37) [above](#comment:38), but I'm happy for answers from anyone.",
    "created_at": "2013-04-08T20:53:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166915",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:48" align="right">comment:48</div>

Leif, I actually intended the question for you, because of the testing [you](#comment:36) [mentioned](#comment:37) [above](#comment:38), but I'm happy for answers from anyone.



---

archive/issue_comments_166916.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nThird attempt:\n\n`spawned_processes` should be located in `$DOT_SAGE/temp/<hostname>/<pid of [parent] Sage process>/`.\n\nThe whole naming is (still) a mess, `sage.misc.misc.SAGE_TMP` is totally unrelated to the environment variable `SAGE_TMP`.",
    "created_at": "2013-04-08T20:55:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166916",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:49" align="right">comment:49</div>

Third attempt:

`spawned_processes` should be located in `$DOT_SAGE/temp/<hostname>/<pid of [parent] Sage process>/`.

The whole naming is (still) a mess, `sage.misc.misc.SAGE_TMP` is totally unrelated to the environment variable `SAGE_TMP`.



---

archive/issue_comments_166917.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nReplying to [@jhpalmieri](#comment:48):\n> Leif, I actually intended the question for you, because of the testing [you](#comment:36) [mentioned](#comment:37) [above](#comment:38), but I'm happy for answers from anyone.\n\nWell, I thought it was not because it didn't apply; as mentioned, I completely \"disabled\" the Sage cleaner to track down the ECL issue, as the new doctesting framework was causing it.  (The Sage cleaner might just have hidden it in previous releases.)",
    "created_at": "2013-04-08T21:01:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166917",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:50" align="right">comment:50</div>

Replying to [@jhpalmieri](#comment:48):
> Leif, I actually intended the question for you, because of the testing [you](#comment:36) [mentioned](#comment:37) [above](#comment:38), but I'm happy for answers from anyone.

Well, I thought it was not because it didn't apply; as mentioned, I completely "disabled" the Sage cleaner to track down the ECL issue, as the new doctesting framework was causing it.  (The Sage cleaner might just have hidden it in previous releases.)



---

archive/issue_comments_166918.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nOh, I didn't realize that you had disabled the creation of the spawned-processes file.\n\nBy the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.",
    "created_at": "2013-04-08T21:11:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166918",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:51" align="right">comment:51</div>

Oh, I didn't realize that you had disabled the creation of the spawned-processes file.

By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.



---

archive/issue_comments_166919.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nReplying to [@jhpalmieri](#comment:51):\n> Oh, I didn't realize that you had disabled the creation of the spawned-processes file.\n\nNope, I just replaced `local/bin/sage-cleaner` (to just `exit 0`).\n\n\n\n\n> By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.\n\nGood question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.",
    "created_at": "2013-04-08T21:22:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166919",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:52" align="right">comment:52</div>

Replying to [@jhpalmieri](#comment:51):
> Oh, I didn't realize that you had disabled the creation of the spawned-processes file.

Nope, I just replaced `local/bin/sage-cleaner` (to just `exit 0`).




> By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.

Good question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.



---

archive/issue_comments_166920.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@nexttime](#comment:52):\n> > By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.\n\n> \n> Good question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.\n\n(... and I thought `SAGE_TESTDIR` would default to it as well.)",
    "created_at": "2013-04-08T21:26:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166920",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@nexttime](#comment:52):
> > By the way, where is the environment variable `SAGE_TMP` used? I think we should only use `sage.misc.misc.SAGE_TMP` these days.

> 
> Good question -- no idea.  I *thought* it was more or less just overriding `TMPDIR` (and used as such), but I now see it is no longer(?) documented at all anyway.

(... and I thought `SAGE_TESTDIR` would default to it as well.)



---

archive/issue_comments_166921.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nIs `sage.misc.misc.SAGE_TMP` used for anything but the cleaner files?  (IMHO the name doesn't suggest it isn't, and a \"generic\" temporary directory certainly shouldn't by default be located below `$HOME`, i.e., `~/.sage/`.)\n\nThe whole cleaner stuff should IMHO be moved to some \"var\" directory, and the names used (including the Python / shell variable names) should reflect the use.",
    "created_at": "2013-04-08T21:42:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166921",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:54" align="right">comment:54</div>

Is `sage.misc.misc.SAGE_TMP` used for anything but the cleaner files?  (IMHO the name doesn't suggest it isn't, and a "generic" temporary directory certainly shouldn't by default be located below `$HOME`, i.e., `~/.sage/`.)

The whole cleaner stuff should IMHO be moved to some "var" directory, and the names used (including the Python / shell variable names) should reflect the use.



---

archive/issue_comments_166922.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nThis is probably not very useful, but:\n- I ran `make ptestlong` in sage-5.9.beta4 without any patches, got ecl processes in the end of tests and `.sage/temp/<host>` contained only two folders for a running notebook server (Can it ever be a problem if I am running multiple sages/servers under my account? I didn't notice any issues so far, so I assumed it is OK.)\n- Then I ran `make ptest` for some reason. I got ecls, no test errors, but there is now 441 folder left under `.sage/temp/<host>`. I tried grepping through them with PIDs of ecl processes, but it was useless as there were too many hits - looks like these folders were accumulated during testing and PIDs were reused multiple times.",
    "created_at": "2013-04-09T05:00:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166922",
    "user": "https://github.com/novoselt"
}
```

<div id="comment:55" align="right">comment:55</div>

This is probably not very useful, but:
- I ran `make ptestlong` in sage-5.9.beta4 without any patches, got ecl processes in the end of tests and `.sage/temp/<host>` contained only two folders for a running notebook server (Can it ever be a problem if I am running multiple sages/servers under my account? I didn't notice any issues so far, so I assumed it is OK.)
- Then I ran `make ptest` for some reason. I got ecls, no test errors, but there is now 441 folder left under `.sage/temp/<host>`. I tried grepping through them with PIDs of ecl processes, but it was useless as there were too many hits - looks like these folders were accumulated during testing and PIDs were reused multiple times.



---

archive/issue_comments_166923.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nThis ticket has nothing to do with runaway ecl, which is fixed in #14426.",
    "created_at": "2013-04-09T12:57:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166923",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:56" align="right">comment:56</div>

This ticket has nothing to do with runaway ecl, which is fixed in #14426.



---

archive/issue_comments_166924.json:
```json
{
    "body": "Changed reviewer from **John Palmieri, Leif Leonhardy** to **John Palmieri, Leif Leonhardy, Volker Braun**",
    "created_at": "2013-04-09T13:40:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166924",
    "user": "https://github.com/vbraun"
}
```

Changed reviewer from **John Palmieri, Leif Leonhardy** to **John Palmieri, Leif Leonhardy, Volker Braun**



---

archive/issue_events_197592.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-09T13:40:11Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197592"
}
```



---

archive/issue_events_197593.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-09T13:40:11Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197593"
}
```



---

archive/issue_comments_166925.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nI made #14431 for further work on the sage cleaner. But this is better than nothing.",
    "created_at": "2013-04-09T13:40:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166925",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:57" align="right">comment:57</div>

I made #14431 for further work on the sage cleaner. But this is better than nothing.



---

archive/issue_comments_166926.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,3 +3,4 @@\n **Apply**:\n 1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.\n 2. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n+3. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n``````\n",
    "created_at": "2013-04-09T14:02:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166926",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,3 +3,4 @@
 **Apply**:
 1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.
 2. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
+3. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.
``````




---

archive/issue_comments_166927.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nI just noticed that the `SAGE_TMP` variables are still not in sync if the hostname contains a hyphen (as mine does), and this prevents the sage cleaner from starting on my machine. Please review the trivial 14055_cleaner_hostname.patch.",
    "created_at": "2013-04-09T14:02:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166927",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:58" align="right">comment:58</div>

I just noticed that the `SAGE_TMP` variables are still not in sync if the hostname contains a hyphen (as mine does), and this prevents the sage cleaner from starting on my machine. Please review the trivial 14055_cleaner_hostname.patch.



---

archive/issue_events_197594.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-09T14:02:38Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197594"
}
```



---

archive/issue_events_197595.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-09T14:02:38Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197595"
}
```



---

archive/issue_events_197596.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-09T14:02:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197596"
}
```



---

archive/issue_events_197597.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-04-09T14:02:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197597"
}
```



---

archive/issue_comments_166928.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nVolker, I don't understand your patch. In sage.misc.misc, `HOSTNAME` is imported from sage.env, where its definition is\n\n```\n        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\\\','_')\n```\nWhat does `sage.env.HOSTNAME` return on your machine? What about `sage.misc.misc.SAGE_TMP`?",
    "created_at": "2013-04-09T18:51:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166928",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:60" align="right">comment:60</div>

Volker, I don't understand your patch. In sage.misc.misc, `HOSTNAME` is imported from sage.env, where its definition is

```
        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\','_')
```
What does `sage.env.HOSTNAME` return on your machine? What about `sage.misc.misc.SAGE_TMP`?



---

archive/issue_comments_166929.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nInteresting, I have on a virgin sage-5.9.beta4 install:\n\n```\nsage: sage.env.HOSTNAME\n'volker-desktop.stp.dias.ie'\nsage: sage.misc.misc.HOSTNAME\n'volker-desktop.stp.dias.ie'\nsage: sage.misc.misc.SAGE_TMP\nl'/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/17284'\n```\nFun ;-)",
    "created_at": "2013-04-09T19:44:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166929",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:61" align="right">comment:61</div>

Interesting, I have on a virgin sage-5.9.beta4 install:

```
sage: sage.env.HOSTNAME
'volker-desktop.stp.dias.ie'
sage: sage.misc.misc.HOSTNAME
'volker-desktop.stp.dias.ie'
sage: sage.misc.misc.SAGE_TMP
l'/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/17284'
```
Fun ;-)



---

archive/issue_comments_166930.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nAlso, underscore, slash, and backslash are not valid in hostnames. And dashes (especially without spaces) are totally harmless in file names. Why?? ;-)",
    "created_at": "2013-04-09T19:45:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166930",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:62" align="right">comment:62</div>

Also, underscore, slash, and backslash are not valid in hostnames. And dashes (especially without spaces) are totally harmless in file names. Why?? ;-)



---

archive/issue_comments_166931.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nOh there is this gem in `sage.env`:\n\n```\n# set any variables that are already in os.environ\nfor var in SAGE_ENV:\n    try:\n        exec(var + ' = os.environ[var]')\n    except KeyError:\n        pass\n```\nSo `HOSTNAME` is again the actual hostname, and you can't grep for it.",
    "created_at": "2013-04-09T19:52:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166931",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:63" align="right">comment:63</div>

Oh there is this gem in `sage.env`:

```
# set any variables that are already in os.environ
for var in SAGE_ENV:
    try:
        exec(var + ' = os.environ[var]')
    except KeyError:
        pass
```
So `HOSTNAME` is again the actual hostname, and you can't grep for it.



---

archive/issue_comments_166932.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nOn a few systems that I tried, `os.environ['HOSTNAME']` returns a KeyError, even though `echo $HOSTNAME` returns something valid from the command line.\n\nAnyway, I'm guessing that we replace hyphens to get potentially valid Python module names. This may be an artifact of the old doctesting code. Should we patch env.py?\n\n```diff\ndiff --git a/sage/env.py b/sage/env.py\n--- a/sage/env.py\n+++ b/sage/env.py\n@@ -30,7 +30,7 @@\n SAGE_ENV = {\n         # system info\n         'UNAME'            : os.uname()[0],\n-        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\\\','_'),\n+        'HOSTNAME'         : socket.gethostname()\n         'LOCAL_IDENTIFIER' : '$HOSTNAME.%s'%os.getpid(),\n \n         # bunch of sage directories and files\n```\nOr is that going to break things?",
    "created_at": "2013-04-09T20:33:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166932",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:64" align="right">comment:64</div>

On a few systems that I tried, `os.environ['HOSTNAME']` returns a KeyError, even though `echo $HOSTNAME` returns something valid from the command line.

Anyway, I'm guessing that we replace hyphens to get potentially valid Python module names. This may be an artifact of the old doctesting code. Should we patch env.py?

```diff
diff --git a/sage/env.py b/sage/env.py
--- a/sage/env.py
+++ b/sage/env.py
@@ -30,7 +30,7 @@
 SAGE_ENV = {
         # system info
         'UNAME'            : os.uname()[0],
-        'HOSTNAME'         : socket.gethostname().replace('-','_').replace('/','_').replace('\\','_'),
+        'HOSTNAME'         : socket.gethostname()
         'LOCAL_IDENTIFIER' : '$HOSTNAME.%s'%os.getpid(),
 
         # bunch of sage directories and files
```
Or is that going to break things?



---

archive/issue_comments_166933.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -2,5 +2,6 @@\n \n **Apply**:\n 1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.\n-2. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n-3. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n+2. [attachment: 14055_simplify_env.patch](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz) to the Sage library.\n+3. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n+4. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n``````\n",
    "created_at": "2013-04-09T20:38:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166933",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -2,5 +2,6 @@
 
 **Apply**:
 1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.
-2. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
-3. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.
+2. [attachment: 14055_simplify_env.patch](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz) to the Sage library.
+3. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
+4. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.
``````




---

archive/issue_comments_166934.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nI agree with John's suggestion. I used the opportunity to get rid of all the `eval()`s and potential infinite loop in `sage.env` ;-)",
    "created_at": "2013-04-09T20:41:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166934",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:66" align="right">comment:66</div>

I agree with John's suggestion. I used the opportunity to get rid of all the `eval()`s and potential infinite loop in `sage.env` ;-)



---

archive/issue_comments_166935.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nThis change might be safer than my last proposal:\n\n```diff\ndiff --git a/sage/env.py b/sage/env.py\n--- a/sage/env.py\n+++ b/sage/env.py\n@@ -58,7 +58,10 @@\n # set any variables that are already in os.environ\n for var in SAGE_ENV:\n     try:\n-        exec(var + ' = os.environ[var]')\n+        if var == 'HOSTNAME':\n+            exec(var + ' = os.environ[var].replace(\"-\",\"_\").replace(\"/\",\"_\").replace(\"\\\\\",\"_\")')\n+        else:\n+            exec(var + ' = os.environ[var]')\n     except KeyError:\n         pass\n \n```\nI'll look at your patch, too.",
    "created_at": "2013-04-09T20:44:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166935",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:67" align="right">comment:67</div>

This change might be safer than my last proposal:

```diff
diff --git a/sage/env.py b/sage/env.py
--- a/sage/env.py
+++ b/sage/env.py
@@ -58,7 +58,10 @@
 # set any variables that are already in os.environ
 for var in SAGE_ENV:
     try:
-        exec(var + ' = os.environ[var]')
+        if var == 'HOSTNAME':
+            exec(var + ' = os.environ[var].replace("-","_").replace("/","_").replace("\\","_")')
+        else:
+            exec(var + ' = os.environ[var]')
     except KeyError:
         pass
 
```
I'll look at your patch, too.



---

archive/issue_comments_166936.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nLine 113:\n\n```\n_add_variable_or_fallback('DOT_SAGE', \"/home/.sage\")\n```\ndoesn't look right: if `DOT_SAGE` has a space in it, it will remain unchanged in this situation. Perhaps `os.environ.pop('DOT_SAGE',None)` first?",
    "created_at": "2013-04-09T20:56:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166936",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:68" align="right">comment:68</div>

Line 113:

```
_add_variable_or_fallback('DOT_SAGE', "/home/.sage")
```
doesn't look right: if `DOT_SAGE` has a space in it, it will remain unchanged in this situation. Perhaps `os.environ.pop('DOT_SAGE',None)` first?



---

archive/issue_comments_166937.json:
```json
{
    "body": "Attachment: **[14055_simplify_env.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz)**\n\nUpdated patch",
    "created_at": "2013-04-09T21:30:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166937",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[14055_simplify_env.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz)**

Updated patch



---

archive/issue_comments_166938.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nThanks, fixed.\n\nI don't think we should muck with `$HOSTNAME`, if it exists. You can break Sage pretty badly by setting any of the supported environment variables to a weird value, so why should be special-case the hostname?",
    "created_at": "2013-04-09T21:34:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166938",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:69" align="right">comment:69</div>

Thanks, fixed.

I don't think we should muck with `$HOSTNAME`, if it exists. You can break Sage pretty badly by setting any of the supported environment variables to a weird value, so why should be special-case the hostname?



---

archive/issue_comments_166939.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nRight now we already special case the hostname, so the path of least resistance is to continue to do that. Your changes might be better, but they require more thought. I'll try to test them out, although I would appreciate other sets of eyes looking at them, too.",
    "created_at": "2013-04-09T22:25:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166939",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:70" align="right">comment:70</div>

Right now we already special case the hostname, so the path of least resistance is to continue to do that. Your changes might be better, but they require more thought. I'll try to test them out, although I would appreciate other sets of eyes looking at them, too.



---

archive/issue_comments_166940.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nVolker's patch seems to work for me.\n\nA slight problem with changing how Sage processes the hostname: for me, at least, the directory `DOT_SAGE/temp/HOSTNAME` is filled with old directories which were never properly cleaned up. On my machines, `'HOSTNAME'` is not a valid key in `os.environ`, so the hyphens have been replaced by underscores. If we change sage-cleaner (etc.) to not do the replacement, we will start to use a new HOSTNAME directory, so the old one won't get cleaned up.\n\nOn one hand, this is minor, and perhaps people should clean up their own `DOT_SAGE/temp` directories. On the other hand, the directory is polluted because of a bug in Sage, so maybe we should clean it up for them. So is it worth applying a patch like [my suggestion above](#comment:67) for Sage 5.9, and then in Sage 5.10, applying Volker's changes?\n\nI'm curious: why is `'HOSTNAME'` sometimes in `os.environ` and sometimes not?",
    "created_at": "2013-04-10T05:46:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166940",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:71" align="right">comment:71</div>

Volker's patch seems to work for me.

A slight problem with changing how Sage processes the hostname: for me, at least, the directory `DOT_SAGE/temp/HOSTNAME` is filled with old directories which were never properly cleaned up. On my machines, `'HOSTNAME'` is not a valid key in `os.environ`, so the hyphens have been replaced by underscores. If we change sage-cleaner (etc.) to not do the replacement, we will start to use a new HOSTNAME directory, so the old one won't get cleaned up.

On one hand, this is minor, and perhaps people should clean up their own `DOT_SAGE/temp` directories. On the other hand, the directory is polluted because of a bug in Sage, so maybe we should clean it up for them. So is it worth applying a patch like [my suggestion above](#comment:67) for Sage 5.9, and then in Sage 5.10, applying Volker's changes?

I'm curious: why is `'HOSTNAME'` sometimes in `os.environ` and sometimes not?



---

archive/issue_comments_166941.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nBash set HOSTNAME, so most people have it.\n\nHow about we make the sage-cleaner fuzzy match the hostname, ignoring hyphen/underscores. I'll add a patch soon.",
    "created_at": "2013-04-10T08:57:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166941",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:72" align="right">comment:72</div>

Bash set HOSTNAME, so most people have it.

How about we make the sage-cleaner fuzzy match the hostname, ignoring hyphen/underscores. I'll add a patch soon.



---

archive/issue_comments_166942.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nReplying to [@vbraun](#comment:72):\n> Bash set HOSTNAME, so most people have it.\n\nIt must be specific to bash because I don't see it in zsh here. Surprisingly it gets `HOST`, but not when I grep for it in `env`.\n\n```\n~\u00bb echo $HOST\nub2\n~\u00bb echo $SHELL\n/bin/zsh\n~\u00bb env | grep -i host\n~ [1] \u00bb echo $HOSTNAME\n\n~\u00bb \n```",
    "created_at": "2013-04-10T09:02:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166942",
    "user": "https://github.com/ppurka"
}
```

<div id="comment:73" align="right">comment:73</div>

Replying to [@vbraun](#comment:72):
> Bash set HOSTNAME, so most people have it.

It must be specific to bash because I don't see it in zsh here. Surprisingly it gets `HOST`, but not when I grep for it in `env`.

```
~» echo $HOST
ub2
~» echo $SHELL
/bin/zsh
~» env | grep -i host
~ [1] » echo $HOSTNAME

~» 
```



---

archive/issue_comments_166943.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nI've added a bit to `sage-cleaner` that will delete outdated temp directories.",
    "created_at": "2013-04-10T09:32:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166943",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:74" align="right">comment:74</div>

I've added a bit to `sage-cleaner` that will delete outdated temp directories.



---

archive/issue_comments_166944.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nReplying to [@vbraun](#comment:72):\n> Bash set HOSTNAME, so most people have it.\n\nI wonder if this is specific to Bash 4. I have version 3.2 (on OS X 10.8.3 and on boxen) and HOSTNAME is not set. `echo $HOSTNAME` returns the correct thing, but HOSTNAME is not listed by `export` or `env`.",
    "created_at": "2013-04-10T16:49:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166944",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:75" align="right">comment:75</div>

Replying to [@vbraun](#comment:72):
> Bash set HOSTNAME, so most people have it.

I wonder if this is specific to Bash 4. I have version 3.2 (on OS X 10.8.3 and on boxen) and HOSTNAME is not set. `echo $HOSTNAME` returns the correct thing, but HOSTNAME is not listed by `export` or `env`.



---

archive/issue_comments_166945.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nWhat about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?",
    "created_at": "2013-04-10T16:56:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166945",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:76" align="right">comment:76</div>

What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?



---

archive/issue_comments_166946.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nOn second thought, cleaning out the old temp/HOSTNAME directories might be a bad idea. If someone is running an old version of Sage (say, as a notebook server), and while it's running, they try out a new version, it would be bad to delete files and directories possibly in use by the old one.",
    "created_at": "2013-04-10T17:06:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166946",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:77" align="right">comment:77</div>

On second thought, cleaning out the old temp/HOSTNAME directories might be a bad idea. If someone is running an old version of Sage (say, as a notebook server), and while it's running, they try out a new version, it would be bad to delete files and directories possibly in use by the old one.



---

archive/issue_comments_166947.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nThere are only temporary files in there, so deleting them is not that much of an issue. Much worse is that pids get reused, the temp directory contains an old `spawned_processes`, and then on shutdown random old pids are SIGKILLed. \n\nBash sets HOSTNAME, but does not export it. The bash profile often exports HOSTNAME among other environment variables. Any further discussion on how and when bash sets HOSTNAME please on a separate ticket.",
    "created_at": "2013-04-10T17:26:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166947",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:78" align="right">comment:78</div>

There are only temporary files in there, so deleting them is not that much of an issue. Much worse is that pids get reused, the temp directory contains an old `spawned_processes`, and then on shutdown random old pids are SIGKILLed. 

Bash sets HOSTNAME, but does not export it. The bash profile often exports HOSTNAME among other environment variables. Any further discussion on how and when bash sets HOSTNAME please on a separate ticket.



---

archive/issue_comments_166948.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nReplying to [@jhpalmieri](#comment:76):\n> What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?\n\nThat feature request is already on #14431.",
    "created_at": "2013-04-10T17:28:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166948",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:79" align="right">comment:79</div>

Replying to [@jhpalmieri](#comment:76):
> What about defining `HOSTNAME` in the `sage-cleaner` script by using `from sage.env import HOSTNAME`?

That feature request is already on #14431.



---

archive/issue_comments_166949.json:
```json
{
    "body": "Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**",
    "created_at": "2013-04-12T19:24:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166949",
    "user": "https://github.com/jhpalmieri"
}
```

Changed author from **Jeroen Demeyer** to **Jeroen Demeyer, Volker Braun**



---

archive/issue_comments_166950.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nThese patches seem to be working for me on several different platforms. Anyone else have an opinion?",
    "created_at": "2013-04-12T19:24:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166950",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:80" align="right">comment:80</div>

These patches seem to be working for me on several different platforms. Anyone else have an opinion?



---

archive/issue_comments_166951.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nI take that back. On mark, I get sporadic failures with\n\n```\n./sage -tp devel/sage/doc/en/constructions/\n```\n(with 2 threads). I get one or both of\n\n```\nsage -t devel/sage/doc/en/constructions/linear_algebra.rst  # Killed due to bus error\nsage -t devel/sage/doc/en/constructions/polynomials.rst  # Killed due to bus error\n```\npretty frequently, especially if I wait a while before running the tests, to make sure there are no running instances of sage-cleaner.",
    "created_at": "2013-04-12T19:51:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166951",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:81" align="right">comment:81</div>

I take that back. On mark, I get sporadic failures with

```
./sage -tp devel/sage/doc/en/constructions/
```
(with 2 threads). I get one or both of

```
sage -t devel/sage/doc/en/constructions/linear_algebra.rst  # Killed due to bus error
sage -t devel/sage/doc/en/constructions/polynomials.rst  # Killed due to bus error
```
pretty frequently, especially if I wait a while before running the tests, to make sure there are no running instances of sage-cleaner.



---

archive/issue_comments_166952.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\nI've also seen similar problems on taurus. With taurus, and sometimes with mark, one part of the doctest failure for linear_algebra.rst says\n\n```\nage: var('a,b,c') ## line 416 ##\n(a, b, c)\nsage: eqn = [a+b*c==1, b-a*c==0, a+b==5] ## line 418 ##\nsage: s = solve(eqn, a,b,c); s ## line 419 ##\n\n;;; Unhandled lisp initialization error\n;;; Message:\nUNBOUND-VARIABLE\n;;; Arguments:\n\nInternal or unrecoverable error in:\n\nLisp initialization error.\n\n  [2: No such file or directory]\n```\nIs the sage-cleaner removing some directory too early?",
    "created_at": "2013-04-12T20:56:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166952",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:82" align="right">comment:82</div>

I've also seen similar problems on taurus. With taurus, and sometimes with mark, one part of the doctest failure for linear_algebra.rst says

```
age: var('a,b,c') ## line 416 ##
(a, b, c)
sage: eqn = [a+b*c==1, b-a*c==0, a+b==5] ## line 418 ##
sage: s = solve(eqn, a,b,c); s ## line 419 ##

;;; Unhandled lisp initialization error
;;; Message:
UNBOUND-VARIABLE
;;; Arguments:

Internal or unrecoverable error in:

Lisp initialization error.

  [2: No such file or directory]
```
Is the sage-cleaner removing some directory too early?



---

archive/issue_comments_166953.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nI don't see how the cleaner would cause the bus error (usually thats memory alignment or segfault).\n\nThe \"Lisp initialization error\" is #14426",
    "created_at": "2013-04-12T21:29:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166953",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:83" align="right">comment:83</div>

I don't see how the cleaner would cause the bus error (usually thats memory alignment or segfault).

The "Lisp initialization error" is #14426



---

archive/issue_comments_166954.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">comment:84</div>\n\nOn taurus, I have two copies of Sage: one vanilla 5.9.beta4, and one with the patches from here and (now) from #14426 applied: I built the ecl spkg from #14426, reinstalled maxima, ran `./sage -ba`\n\nWith the vanilla 5.9.beta4, `./sage -tp devel/sage/doc/en/constructions/` passed doctests 10 times in a row.\n\nOn the patched 5.9.beta4, the same command had failures 5 of the 10 times. I was seeing similar behavior before applying the patches from #14426.",
    "created_at": "2013-04-12T22:28:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166954",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:84" align="right">comment:84</div>

On taurus, I have two copies of Sage: one vanilla 5.9.beta4, and one with the patches from here and (now) from #14426 applied: I built the ecl spkg from #14426, reinstalled maxima, ran `./sage -ba`

With the vanilla 5.9.beta4, `./sage -tp devel/sage/doc/en/constructions/` passed doctests 10 times in a row.

On the patched 5.9.beta4, the same command had failures 5 of the 10 times. I was seeing similar behavior before applying the patches from #14426.



---

archive/issue_comments_166955.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nI ran `strace -ff -o /tmp/log/trace -s 128 sage -tp doc/en/constructions/linear_algebra.rst` on my desktop and there isn't much going on in the file system:\n\n```\n$ grep ^unlink *\ntrace.13793:unlink(\"/tmp/ffiHfdBLe\")                = 0\ntrace.13793:unlink(\"/tmp/QMFB1f\")                   = 0\ntrace.13793:unlink(\"/tmp/tmp7WBqmx\")                = 0\ntrace.13793:unlink(\"/dev/shm/sem.opP4VE\")           = 0\ntrace.13793:unlink(\"/dev/shm/sem.mp13793-0\")        = 0\ntrace.13793:unlink(\"/dev/shm/sem.yHmC64\")           = 0\ntrace.13793:unlink(\"/dev/shm/sem.mp13793-1\")        = 0\ntrace.13793:unlink(\"/dev/shm/sem.8cqchv\")           = 0\ntrace.13793:unlink(\"/dev/shm/sem.mp13793-2\")        = 0\ntrace.13793:unlink(\"/tmp/tmpfadSPrV\")               = 0\ntrace.13834:unlink(\"/home/vbraun/opt/sage-5.9.beta5/local/lib/sage-force-relocate.txt\") = -1 ENOENT (No such file or directory)\ntrace.13844:unlink(\"/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859/spawned_processes\") = 0\n\n$ grep ^rmdir *\ntrace.13793:rmdir(\"/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13793\") = 0\ntrace.13844:rmdir(\"/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859\") = 0\n\n$ grep ^rename *\ntrace.13793:rename(\"/tmp/tmp7WBqmx\", \"/home/vbraun/.sage/cache/_home_vbraun_opt_sage-5.9.beta5_devel_sage-main-lazy_import_cache.pickle\") = -1 EXDEV (Invalid cross-device link)\ntrace.13793:rename(\"/home/vbraun/.sage/tmpQCpKCj\", \"/home/vbraun/.sage/timings2.json\") = 0\n```\nThe only obvious race is #13826, though I don't think that could cause the lisp failure. All communication with Maxima goes through a pty.",
    "created_at": "2013-04-13T15:44:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166955",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:85" align="right">comment:85</div>

I ran `strace -ff -o /tmp/log/trace -s 128 sage -tp doc/en/constructions/linear_algebra.rst` on my desktop and there isn't much going on in the file system:

```
$ grep ^unlink *
trace.13793:unlink("/tmp/ffiHfdBLe")                = 0
trace.13793:unlink("/tmp/QMFB1f")                   = 0
trace.13793:unlink("/tmp/tmp7WBqmx")                = 0
trace.13793:unlink("/dev/shm/sem.opP4VE")           = 0
trace.13793:unlink("/dev/shm/sem.mp13793-0")        = 0
trace.13793:unlink("/dev/shm/sem.yHmC64")           = 0
trace.13793:unlink("/dev/shm/sem.mp13793-1")        = 0
trace.13793:unlink("/dev/shm/sem.8cqchv")           = 0
trace.13793:unlink("/dev/shm/sem.mp13793-2")        = 0
trace.13793:unlink("/tmp/tmpfadSPrV")               = 0
trace.13834:unlink("/home/vbraun/opt/sage-5.9.beta5/local/lib/sage-force-relocate.txt") = -1 ENOENT (No such file or directory)
trace.13844:unlink("/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859/spawned_processes") = 0

$ grep ^rmdir *
trace.13793:rmdir("/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13793") = 0
trace.13844:rmdir("/home/vbraun/.sage/temp/volker-desktop.stp.dias.ie/13859") = 0

$ grep ^rename *
trace.13793:rename("/tmp/tmp7WBqmx", "/home/vbraun/.sage/cache/_home_vbraun_opt_sage-5.9.beta5_devel_sage-main-lazy_import_cache.pickle") = -1 EXDEV (Invalid cross-device link)
trace.13793:rename("/home/vbraun/.sage/tmpQCpKCj", "/home/vbraun/.sage/timings2.json") = 0
```
The only obvious race is #13826, though I don't think that could cause the lisp failure. All communication with Maxima goes through a pty.



---

archive/issue_comments_166956.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nCan we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.",
    "created_at": "2013-04-25T15:10:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166956",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:86" align="right">comment:86</div>

Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.



---

archive/issue_comments_166957.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nReplying to [@vbraun](#comment:86):\n> Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.\n\nGo ahead... ;-)\n\nIt's not even a 5.9 blocker right now... (milestone 5.10!)",
    "created_at": "2013-04-25T15:30:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166957",
    "user": "https://github.com/nexttime"
}
```

<div id="comment:87" align="right">comment:87</div>

Replying to [@vbraun](#comment:86):
> Can we get this reviewed? Especially if you run the patchbot then you rather quickly generate directories for all pids and soon random processes are being killed.

Go ahead... ;-)

It's not even a 5.9 blocker right now... (milestone 5.10!)



---

archive/issue_comments_166958.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">comment:88</div>\n\nWell I'm obviously giving positive review to everything that I didn't write on this ticket. We should run it on the buildbot to see if it exposes any other bugs.",
    "created_at": "2013-04-25T16:28:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166958",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:88" align="right">comment:88</div>

Well I'm obviously giving positive review to everything that I didn't write on this ticket. We should run it on the buildbot to see if it exposes any other bugs.



---

archive/issue_events_197598.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2013-04-25T17:40:13Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197598"
}
```



---

archive/issue_events_197599.json:
```json
{
    "actor": "https://github.com/jhpalmieri",
    "created_at": "2013-04-25T17:40:13Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197599"
}
```



---

archive/issue_comments_166959.json:
```json
{
    "body": "<div id=\"comment:89\" align=\"right\">comment:89</div>\n\nWell, the code looks okay, and it is an improvement over what was there before. I don't understand the failures [I mentioned earlier](#comment:84), but let's give it a positive review so it gets merged and gets some wider testing.",
    "created_at": "2013-04-25T17:40:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166959",
    "user": "https://github.com/jhpalmieri"
}
```

<div id="comment:89" align="right">comment:89</div>

Well, the code looks okay, and it is an improvement over what was there before. I don't understand the failures [I mentioned earlier](#comment:84), but let's give it a positive review so it gets merged and gets some wider testing.



---

archive/issue_comments_166960.json:
```json
{
    "body": "<div id=\"comment:90\" align=\"right\">comment:90</div>\n\nCould you remove TAB characters from [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz)",
    "created_at": "2013-04-29T07:32:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166960",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:90" align="right">comment:90</div>

Could you remove TAB characters from [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz)



---

archive/issue_comments_166961.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-04-30T09:44:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166961",
    "user": "https://github.com/jdemeyer"
}
```

Updated patch



---

archive/issue_events_197600.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-30T09:45:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197600"
}
```



---

archive/issue_events_197601.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-04-30T09:45:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197601"
}
```



---

archive/issue_comments_166962.json:
```json
{
    "body": "Merged: **sage-5.10.beta1**",
    "created_at": "2013-04-30T09:45:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166962",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.10.beta1**



---

archive/issue_comments_166963.json:
```json
{
    "body": "<div id=\"comment:91\" align=\"right\">comment:91</div>\n\nAttachment: **[14055_cleaner_hostname.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz)**\n\nFixed trailing whitespace (including a TAB!)",
    "created_at": "2013-04-30T09:45:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166963",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:91" align="right">comment:91</div>

Attachment: **[14055_cleaner_hostname.patch.gz](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz)**

Fixed trailing whitespace (including a TAB!)



---

archive/issue_comments_166964.json:
```json
{
    "body": "Changed merged from **sage-5.10.beta1** to none",
    "created_at": "2013-04-30T11:23:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166964",
    "user": "https://github.com/jdemeyer"
}
```

Changed merged from **sage-5.10.beta1** to none



---

archive/issue_comments_166965.json:
```json
{
    "body": "<div id=\"comment:92\" align=\"right\">comment:92</div>\n\nI am still seeing the `linear_algebra.rst` doctest failures. I don't understand how this ticket could cause it, though.",
    "created_at": "2013-04-30T11:23:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166965",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:92" align="right">comment:92</div>

I am still seeing the `linear_algebra.rst` doctest failures. I don't understand how this ticket could cause it, though.



---

archive/issue_events_197602.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-05-02T14:00:29Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197602"
}
```



---

archive/issue_comments_166966.json:
```json
{
    "body": "<div id=\"comment:93\" align=\"right\">comment:93</div>\n\nI've been running repeated doctests and the only thing that I see on taurus is occasional (about 5% of doctests runs) failure with the maxima pty interface. The trouble always starts with the assertion failure where input != echo:\n\n```\nFile \"devel/sage/doc/en/constructions/plotting.rst\", line 52, in doc.en.constructions.plotting\nFailed example:\n    L = [(i/100.0, maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-300,300)]\nException raised:\n    Traceback (most recent call last):\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 466, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 825, in execute\n        exec compiled in globs\n      File \"<doctest doc.en.constructions.plotting[0]>\", line 1, in <module>\n        L = [(i/RealNumber('100.0'), maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-Integer(300),Integer(300))]\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py\", line 1208, in eval\n        for L in code.split('\\n') if L != ''])\n      File \"/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/maxima.py\", line 754, in _eval_line\n        assert line_echo.strip() == line.strip()\n    AssertionError\n```\nAnd that has nothing to do with this ticket...",
    "created_at": "2013-05-02T14:00:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166966",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:93" align="right">comment:93</div>

I've been running repeated doctests and the only thing that I see on taurus is occasional (about 5% of doctests runs) failure with the maxima pty interface. The trouble always starts with the assertion failure where input != echo:

```
File "devel/sage/doc/en/constructions/plotting.rst", line 52, in doc.en.constructions.plotting
Failed example:
    L = [(i/100.0, maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-300,300)]
Exception raised:
    Traceback (most recent call last):
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 466, in _run
        self.execute(example, compiled, test.globs)
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 825, in execute
        exec compiled in globs
      File "<doctest doc.en.constructions.plotting[0]>", line 1, in <module>
        L = [(i/RealNumber('100.0'), maxima.eval('jacobi_sn (%s/100.0,2.0)'%i))for i in range(-Integer(300),Integer(300))]
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/expect.py", line 1208, in eval
        for L in code.split('\n') if L != ''])
      File "/home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/python2.7/site-packages/sage/interfaces/maxima.py", line 754, in _eval_line
        assert line_echo.strip() == line.strip()
    AssertionError
```
And that has nothing to do with this ticket...



---

archive/issue_comments_166967.json:
```json
{
    "body": "<div id=\"comment:94\" align=\"right\">comment:94</div>\n\nFor the record, this is the comparison that fails:\n\n```\n        assert line_echo.strip() == line.strip(), 'mismatch:\\n' + line_echo + line\n    AssertionError: mismatch:\n    jacobi_sn (-228/100 .0,2.0);\n    jacobi_sn (-228/100.0,2.0);\n```",
    "created_at": "2013-05-02T14:22:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166967",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:94" align="right">comment:94</div>

For the record, this is the comparison that fails:

```
        assert line_echo.strip() == line.strip(), 'mismatch:\n' + line_echo + line
    AssertionError: mismatch:
    jacobi_sn (-228/100 .0,2.0);
    jacobi_sn (-228/100.0,2.0);
```



---

archive/issue_comments_166968.json:
```json
{
    "body": "Attachment: **[trac_14055_maxima_debug.patch.gz](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz)**\n\nInitial patch",
    "created_at": "2013-05-02T14:32:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166968",
    "user": "https://github.com/vbraun"
}
```

Attachment: **[trac_14055_maxima_debug.patch.gz](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz)**

Initial patch



---

archive/issue_events_197603.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-05-02T14:35:02Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197603"
}
```



---

archive/issue_events_197604.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2013-05-02T14:35:02Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197604"
}
```



---

archive/issue_comments_166969.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,5 +3,6 @@\n **Apply**:\n 1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.\n 2. [attachment: 14055_simplify_env.patch](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz) to the Sage library.\n-3. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n-4. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n+3. [attachment: trac_14055_maxima_debug.patch](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz) to the Sage library.\n+4. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n+5. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n``````\n",
    "created_at": "2013-05-02T14:35:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166969",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,5 +3,6 @@
 **Apply**:
 1. [attachment: 14055_cleaner_sagelib.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_sagelib.patch.gz) to the Sage library.
 2. [attachment: 14055_simplify_env.patch](https://github.com/sagemath/sage/files/ticket14055/14055_simplify_env.patch.gz) to the Sage library.
-3. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
-4. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.
+3. [attachment: trac_14055_maxima_debug.patch](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz) to the Sage library.
+4. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
+5. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.
``````




---

archive/issue_comments_166970.json:
```json
{
    "body": "<div id=\"comment:95\" align=\"right\">comment:95</div>\n\nI don't know why there are random spaces sprinkled in, but it certainly doesn't have anything to do with this ticket. I haven't found any other failures on taurus.",
    "created_at": "2013-05-02T14:35:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166970",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:95" align="right">comment:95</div>

I don't know why there are random spaces sprinkled in, but it certainly doesn't have anything to do with this ticket. I haven't found any other failures on taurus.



---

archive/issue_comments_166971.json:
```json
{
    "body": "<div id=\"comment:96\" align=\"right\">comment:96</div>\n\nVolker, I don't see how your patch would affect the error reported in [comment:82].",
    "created_at": "2013-05-02T15:05:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166971",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:96" align="right">comment:96</div>

Volker, I don't see how your patch would affect the error reported in [comment:82].



---

archive/issue_comments_166972.json:
```json
{
    "body": "<div id=\"comment:97\" align=\"right\">comment:97</div>\n\nWhat I'm saying is, I could not reproduce (on taurus) the error reported in [comment:82](#comment:82). It might be a miscompile or a transient hardware error as far as I can tell.",
    "created_at": "2013-05-02T15:23:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166972",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:97" align="right">comment:97</div>

What I'm saying is, I could not reproduce (on taurus) the error reported in [comment:82](#comment:82). It might be a miscompile or a transient hardware error as far as I can tell.



---

archive/issue_comments_166973.json:
```json
{
    "body": "<div id=\"comment:98\" align=\"right\">comment:98</div>\n\nSee also https://groups.google.com/d/msg/sage-release/07skjCnmRCI/Oyxm1EIquMEJ",
    "created_at": "2013-05-02T15:24:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166973",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:98" align="right">comment:98</div>

See also https://groups.google.com/d/msg/sage-release/07skjCnmRCI/Oyxm1EIquMEJ



---

archive/issue_comments_166974.json:
```json
{
    "body": "<div id=\"comment:99\" align=\"right\">comment:99</div>\n\nRunning with `nice -19` and background load seems to trigger it, I now get some maxima segfaults somewhat reliably. They look like a race in the multi-threaded ecl to me, for example the following failure:\n\n```\nsage: s = solve(eqn, a,b,c); s ## line 419 ##\n\n;;; Unhandled lisp initialization error\n;;; Message:\nunbound-variable\n;;; Arguments:\n\nInternal or unrecoverable error in:\n\nLisp initialization error.\n\n  [2: No such file or directory]\n\n;;; ECL C Backtrace\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_dump_c_backtrace+0x28) [0x7f01f330e1d8]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_internal_error+0x3f) [0x7f01f32f91af]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242f4) [0x7f01f32f92f4]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x125482) [0x7f01f32fa482]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_argument+0x1e) [0x7f01f32fa4ae]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(stream_dispatch_table+0x17) [0x7f01f32ece17]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_write_char+0x1b) [0x7f01f32ed6ab]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x13766b) [0x7f01f330c66b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_write_symbol+0x156) [0x7f01f330cbc6]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_write_ugly_object+0x26) [0x7f01f330bcc6]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242db) [0x7f01f32f92db]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1252d8) [0x7f01f32fa2d8]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_interpret+0x19cd) [0x7f01f32de67d]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x10e34f) [0x7f01f32e334f]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_eval_with_env+0x2eb) [0x7f01f32e4f0b]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_signal_simple_error+0x26d) [0x7f01f32a9e4d]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_nth_arg+0x109) [0x7f01f32f9cf9]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_sethash+0) [0x7f01f3326170]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x14df28) [0x7f01f3322f28]\n;;; /lib64/libpthread.so.0() [0x324440f500]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1503e0) [0x7f01f33253e0]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x15172c) [0x7f01f332672c]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_extend_hashtable+0x185) [0x7f01f3326335]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x151716) [0x7f01f3326716]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x11c4dc) [0x7f01f32f14dc]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x4e8) [0x7f01f32f7298]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(init_lib_LSP+0x4c9) [0x7f01f3218089]\n;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x399) [0x7f01f32f7149]\n```",
    "created_at": "2013-05-02T16:08:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166974",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:99" align="right">comment:99</div>

Running with `nice -19` and background load seems to trigger it, I now get some maxima segfaults somewhat reliably. They look like a race in the multi-threaded ecl to me, for example the following failure:

```
sage: s = solve(eqn, a,b,c); s ## line 419 ##

;;; Unhandled lisp initialization error
;;; Message:
unbound-variable
;;; Arguments:

Internal or unrecoverable error in:

Lisp initialization error.

  [2: No such file or directory]

;;; ECL C Backtrace
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_dump_c_backtrace+0x28) [0x7f01f330e1d8]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_internal_error+0x3f) [0x7f01f32f91af]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242f4) [0x7f01f32f92f4]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x125482) [0x7f01f32fa482]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_argument+0x1e) [0x7f01f32fa4ae]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(stream_dispatch_table+0x17) [0x7f01f32ece17]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_write_char+0x1b) [0x7f01f32ed6ab]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x13766b) [0x7f01f330c66b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_write_symbol+0x156) [0x7f01f330cbc6]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_write_ugly_object+0x26) [0x7f01f330bcc6]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1242db) [0x7f01f32f92db]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_funcall+0x70) [0x7f01f32dc3f0]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(cl_error+0xdb) [0x7f01f32fa13b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1252d8) [0x7f01f32fa2d8]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_interpret+0x19cd) [0x7f01f32de67d]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x10e34f) [0x7f01f32e334f]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_eval_with_env+0x2eb) [0x7f01f32e4f0b]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(si_signal_simple_error+0x26d) [0x7f01f32a9e4d]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(FEwrong_type_nth_arg+0x109) [0x7f01f32f9cf9]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(_ecl_sethash+0) [0x7f01f3326170]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x14df28) [0x7f01f3322f28]
;;; /lib64/libpthread.so.0() [0x324440f500]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x1503e0) [0x7f01f33253e0]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x15172c) [0x7f01f332672c]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_extend_hashtable+0x185) [0x7f01f3326335]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x151716) [0x7f01f3326716]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(+0x11c4dc) [0x7f01f32f14dc]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x4e8) [0x7f01f32f7298]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(init_lib_LSP+0x4c9) [0x7f01f3218089]
;;; /home/vbraun/opt/taurus/sage-5.10.beta1/local/lib/libecl.so.12.12(ecl_init_module+0x399) [0x7f01f32f7149]
```



---

archive/issue_comments_166975.json:
```json
{
    "body": "strace of failed ecl startup (from taurus)",
    "created_at": "2013-05-04T12:07:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166975",
    "user": "https://github.com/vbraun"
}
```

strace of failed ecl startup (from taurus)



---

archive/issue_comments_166976.json:
```json
{
    "body": "<div id=\"comment:0\" align=\"right\">comment:0</div>\n\nAttachment: **[log.10693.gz](https://github.com/sagemath/sage/files/ticket14055/log.10693.gz)**\n\nI've attached an strace from a failed ECL startup on taurus. It seems that during dlopen of ECL an unrelated thread (id 16046) happens to finish which causes a SIGCHLD. If the ECL signal handler is not turned off during init then that would explain things going south. Nils, since you wrote it maybe you have an opinion on that?",
    "created_at": "2013-05-04T12:30:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166976",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:0" align="right">comment:0</div>

Attachment: **[log.10693.gz](https://github.com/sagemath/sage/files/ticket14055/log.10693.gz)**

I've attached an strace from a failed ECL startup on taurus. It seems that during dlopen of ECL an unrelated thread (id 16046) happens to finish which causes a SIGCHLD. If the ECL signal handler is not turned off during init then that would explain things going south. Nils, since you wrote it maybe you have an opinion on that?



---

archive/issue_comments_166977.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">comment:1</div>\n\nThe last time I looked at it, ECL as a library with multithread support is rather fundamentally incompatible with the way we use it. As far as I know, if thread support is enabled then ECL expects one (dedicated?) thread to handle asynchronous signals and I think that thread may even be split off when there's otherwise only one thread running. I don't see how to consolidate that with our own signal management. The solution up to know has been to only use ECL in single threaded mode, which may mean building it without thread support. I know ECL has been moving towards multithreadedness. However, as an \"embeddable\" lisp there's a good argument they should also keep a strictly single-threaded version as an option and I hope they're continuing with that (perhaps sending a message that we really appreciate single threadedness might help).\n\nOur signal switching code has been a little behind the times for a while already. Some improvements were suggested here:\n\nhttp://comments.gmane.org/gmane.lisp.ecl.general/8211\n\nThat code might be outdated already as well.\n\nWhat is the hypothesis here, by the way? That an event triggered by sage-cleaner produces a signal meant for our own signal handler that happens to end up in with the ecl signal handler? If that's the problem I see no way around it. Then we just need to write our own signal handler to always be in control, keeping flags on whether some signals might have to be dispatched to ECL and do so for signals we deem appropriate for that. That's major surgery (I've actually been surprised we were able to avoid that for so long and I hope we can continue)\n\nI guess normally, ECL expects SIGCHLD to be ignored. We apparently set a different mask? Changing to ECL's signal mask would include ignoring a SIGCHLD if it happens to be in control when the signal arrives. Can we afford to? Do we already try to do that? In that case is the problem that the signal arrives in a small window where we've switched handlers but not masks? Then we should be a little more careful about the switch, i.e., perhaps disable signals during the switch completely.",
    "created_at": "2013-05-04T18:44:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166977",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:1" align="right">comment:1</div>

The last time I looked at it, ECL as a library with multithread support is rather fundamentally incompatible with the way we use it. As far as I know, if thread support is enabled then ECL expects one (dedicated?) thread to handle asynchronous signals and I think that thread may even be split off when there's otherwise only one thread running. I don't see how to consolidate that with our own signal management. The solution up to know has been to only use ECL in single threaded mode, which may mean building it without thread support. I know ECL has been moving towards multithreadedness. However, as an "embeddable" lisp there's a good argument they should also keep a strictly single-threaded version as an option and I hope they're continuing with that (perhaps sending a message that we really appreciate single threadedness might help).

Our signal switching code has been a little behind the times for a while already. Some improvements were suggested here:

http://comments.gmane.org/gmane.lisp.ecl.general/8211

That code might be outdated already as well.

What is the hypothesis here, by the way? That an event triggered by sage-cleaner produces a signal meant for our own signal handler that happens to end up in with the ecl signal handler? If that's the problem I see no way around it. Then we just need to write our own signal handler to always be in control, keeping flags on whether some signals might have to be dispatched to ECL and do so for signals we deem appropriate for that. That's major surgery (I've actually been surprised we were able to avoid that for so long and I hope we can continue)

I guess normally, ECL expects SIGCHLD to be ignored. We apparently set a different mask? Changing to ECL's signal mask would include ignoring a SIGCHLD if it happens to be in control when the signal arrives. Can we afford to? Do we already try to do that? In that case is the problem that the signal arrives in a small window where we've switched handlers but not masks? Then we should be a little more careful about the switch, i.e., perhaps disable signals during the switch completely.



---

archive/issue_comments_166978.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nFor the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. \n\nI don't think the sage-cleaner has anything to do with the problem. It just slightly changes timings so that we happen to trigger a rather unlikely race on taurus/skynet. It certainly should not send any signals except for term/kill.\n\nThe new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.",
    "created_at": "2013-05-04T20:08:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166978",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:2" align="right">comment:2</div>

For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. 

I don't think the sage-cleaner has anything to do with the problem. It just slightly changes timings so that we happen to trigger a rather unlikely race on taurus/skynet. It certainly should not send any signals except for term/kill.

The new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.



---

archive/issue_comments_166979.json:
```json
{
    "body": "<div id=\"comment:103\" align=\"right\">comment:103</div>\n\nReplying to [@vbraun](#comment:102):\n> For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. \n\nOK, good.\n\n> I don't think the sage-cleaner has anything to do with the problem.\n\nSo perhaps this should go on a different ticket then?\n\n> The new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.\n\nI took a quick look at [unixint.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixint.d) and it seems ECL does install a handler for SIGCHLD. Perhaps you're just unlucky that the SIGCHLD gets delivered at a very inopportune moment when ECL hasn't quite finished setting up its handlers? Or are we just sloppy in how we change handlers? The handler they use is defined in [unixsys.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixsys.d) as `si::wait-for-all-processes`.",
    "created_at": "2013-05-04T20:31:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166979",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:103" align="right">comment:103</div>

Replying to [@vbraun](#comment:102):
> For the record, we build ECL with `--disable-threads` so it shouldn't have any multithread support. It does link with pthreads, though perhaps boehmgc needs that. 

OK, good.

> I don't think the sage-cleaner has anything to do with the problem.

So perhaps this should go on a different ticket then?

> The new doctest framework seems to be the only thing that uses SIGCHLD in the Sage library.

I took a quick look at [unixint.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixint.d) and it seems ECL does install a handler for SIGCHLD. Perhaps you're just unlucky that the SIGCHLD gets delivered at a very inopportune moment when ECL hasn't quite finished setting up its handlers? Or are we just sloppy in how we change handlers? The handler they use is defined in [unixsys.d](http://sourceforge.net/p/ecls/ecl/ci/master/tree/src/c/unixsys.d) as `si::wait-for-all-processes`.



---

archive/issue_comments_166980.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nSwitching off ECL_OPT_TRAP_SIGCHLD seems to fix it (knock on wood). 50x testing linear_algebra.rst on taurus works with the new spkg (you need to recompile maxima after ecl).",
    "created_at": "2013-05-04T21:42:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166980",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:4" align="right">comment:4</div>

Switching off ECL_OPT_TRAP_SIGCHLD seems to fix it (knock on wood). 50x testing linear_algebra.rst on taurus works with the new spkg (you need to recompile maxima after ecl).



---

archive/issue_comments_166981.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -6,3 +6,5 @@\n 3. [attachment: trac_14055_maxima_debug.patch](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz) to the Sage library.\n 4. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.\n 5. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.\n+\n+Update ECL spkg with http://boxen.math.washington.edu/home/vbraun/spkg/ecl-12.12.1.p3.spkg\n``````\n",
    "created_at": "2013-05-04T21:42:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166981",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -6,3 +6,5 @@
 3. [attachment: trac_14055_maxima_debug.patch](https://github.com/sagemath/sage/files/ticket14055/trac_14055_maxima_debug.patch.gz) to the Sage library.
 4. [attachment: 14055_cleaner.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner.patch.gz) to `local/bin`.
 5. [attachment: 14055_cleaner_hostname.patch](https://github.com/sagemath/sage/files/ticket14055/14055_cleaner_hostname.patch.gz) to `local/bin`.
+
+Update ECL spkg with http://boxen.math.washington.edu/home/vbraun/spkg/ecl-12.12.1.p3.spkg
``````




---

archive/issue_comments_166982.json:
```json
{
    "body": "diff for review only: ecl-12.12.1.p2 -> ecl-12.12.1.p3",
    "created_at": "2013-05-04T21:45:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166982",
    "user": "https://github.com/vbraun"
}
```

diff for review only: ecl-12.12.1.p2 -> ecl-12.12.1.p3



---

archive/issue_comments_166983.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nAttachment: **[ecl-p3.diff.gz](https://github.com/sagemath/sage/files/ticket14055/ecl-p3.diff.gz)**\n\nVolker, if this works, it's a very nice piece of debugging. Testing right away...",
    "created_at": "2013-05-05T20:01:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166983",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:5" align="right">comment:5</div>

Attachment: **[ecl-p3.diff.gz](https://github.com/sagemath/sage/files/ticket14055/ecl-p3.diff.gz)**

Volker, if this works, it's a very nice piece of debugging. Testing right away...



---

archive/issue_events_197605.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-06T15:16:37Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197605"
}
```



---

archive/issue_events_197606.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-06T15:16:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197606"
}
```



---

archive/issue_comments_166984.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI ran 500 iterations for `linear_algebra.rst` and didn't get any failures. The \"random space in output\" presumably has also been caused by the SIGCHLD handler.",
    "created_at": "2013-05-06T16:43:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166984",
    "user": "https://github.com/vbraun"
}
```

<div id="comment:7" align="right">comment:7</div>

I ran 500 iterations for `linear_algebra.rst` and didn't get any failures. The "random space in output" presumably has also been caused by the SIGCHLD handler.



---

archive/issue_comments_166985.json:
```json
{
    "body": "Merged: **sage-5.10.beta2**",
    "created_at": "2013-05-08T07:43:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14055#issuecomment-166985",
    "user": "https://github.com/jdemeyer"
}
```

Merged: **sage-5.10.beta2**



---

archive/issue_events_197607.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-08T07:43:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197607"
}
```



---

archive/issue_events_197608.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-05-08T07:43:49Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14055",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14055#event-197608"
}
```
