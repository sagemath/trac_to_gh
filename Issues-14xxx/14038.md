# Issue 14038: Let libgap build a shared library on Cygwin

archive/issues_013834.json:
```json
{
    "body": "We need to pass -no-undefined to libtool, the proper place is in libgap_la_LDFLAGS, potentially  only on Cygwin and other Windows systems (have a look in GMP/MPIR/MPFR for examples), but should not hurt anyway elsewhere if added unconditionally.\n\n(By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)\n\n\nhttp://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg\n\nAssignee: tbd\n\nCC:  @kcrisman @dimpase @vbraun\n\nKeywords: cygwin spkg libgap\n\nReviewer: Jean-Pierre Flori, Dmitrii Pasechnik\n\nAuthor: Volker Braun, Jean-Pierre Flori\n\nMerged: sage-5.8.beta0\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14038\n\n",
    "closed_at": "2013-02-17T22:43:50Z",
    "created_at": "2013-01-29T22:50:11Z",
    "labels": [
        "component: packages: standard",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.8",
    "title": "Let libgap build a shared library on Cygwin",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14038",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```
We need to pass -no-undefined to libtool, the proper place is in libgap_la_LDFLAGS, potentially  only on Cygwin and other Windows systems (have a look in GMP/MPIR/MPFR for examples), but should not hurt anyway elsewhere if added unconditionally.

(By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)


http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg

Assignee: tbd

CC:  @kcrisman @dimpase @vbraun

Keywords: cygwin spkg libgap

Reviewer: Jean-Pierre Flori, Dmitrii Pasechnik

Author: Volker Braun, Jean-Pierre Flori

Merged: sage-5.8.beta0

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/14038





---

archive/issue_comments_214445.json:
```json
{
    "body": "<a id='comment:1'></a>And now MPIR defines __GNU_MP_RELEASE so the __GMP_MP_RELEASE hack is not needed anymore here or in gap spkg.",
    "created_at": "2013-01-29T23:06:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214445",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:1'></a>And now MPIR defines __GNU_MP_RELEASE so the __GMP_MP_RELEASE hack is not needed anymore here or in gap spkg.



---

archive/issue_comments_214446.json:
```json
{
    "body": "<a id='comment:2'></a>I made #14039 to keep track of what to change for the next GAP update.",
    "created_at": "2013-01-30T10:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214446",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:2'></a>I made #14039 to keep track of what to change for the next GAP update.



---

archive/issue_comments_214447.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-01-30T10:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214447",
    "user": "https://github.com/vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_214448.json:
```json
{
    "body": "<a id='comment:3'></a>I've made a new spkg that includes the `--no-undefined`. Please let me know if it fixes things.",
    "created_at": "2013-01-30T10:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214448",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:3'></a>I've made a new spkg that includes the `--no-undefined`. Please let me know if it fixes things.



---

archive/issue_comments_214449.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,6 @@\n We need to pass -no-undefined to libtool, the proper place is in libgap_la_LDFLAGS, potentially  only on Cygwin and other Windows systems (have a look in GMP/MPIR/MPFR for examples), but should not hurt anyway elsewhere if added unconditionally.\n \n (By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)\n+\n+\n+http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg\n``````\n",
    "created_at": "2013-01-30T10:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214449",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,6 @@
 We need to pass -no-undefined to libtool, the proper place is in libgap_la_LDFLAGS, potentially  only on Cygwin and other Windows systems (have a look in GMP/MPIR/MPFR for examples), but should not hurt anyway elsewhere if added unconditionally.
 
 (By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)
+
+
+http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg
``````




---

archive/issue_comments_214450.json:
```json
{
    "body": "Changing author from \"\" to \"Volker Braun\"",
    "created_at": "2013-01-30T10:49:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214450",
    "user": "https://github.com/vbraun"
}
```

Changing author from "" to "Volker Braun"



---

archive/issue_comments_214451.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-30T11:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214451",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_214452.json:
```json
{
    "body": "<a id='comment:4'></a>I've had a quick look at the spkg and it seems fine except there should be only one dash in front of no-undefined (not sure though putting two will break things).\n\nThe spkg-install cript looks cleaner.\nWould you mind replacing the last double brackets by simple ones?\nThe use of double brackets does not seem necerssary for the simple tests involved.\n\nA line for the version bump in SPKG.txt would be nice as well.\n\nIt should fix things on Cygwin (I crafted my own spkg yesterday and everything went fine, see CygwinPort).\nThe question should then rather be: Does it break things on other systems? (it should not.)",
    "created_at": "2013-01-30T11:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214452",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:4'></a>I've had a quick look at the spkg and it seems fine except there should be only one dash in front of no-undefined (not sure though putting two will break things).

The spkg-install cript looks cleaner.
Would you mind replacing the last double brackets by simple ones?
The use of double brackets does not seem necerssary for the simple tests involved.

A line for the version bump in SPKG.txt would be nice as well.

It should fix things on Cygwin (I crafted my own spkg yesterday and everything went fine, see CygwinPort).
The question should then rather be: Does it break things on other systems? (it should not.)



---

archive/issue_comments_214453.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Jean-Pierre Flori\"",
    "created_at": "2013-01-30T11:02:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214453",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing reviewer from "" to "Jean-Pierre Flori"



---

archive/issue_comments_214454.json:
```json
{
    "body": "<a id='comment:5'></a>Long-style is `--no-undefined` (two dashes), short is `-z`. ld is being nice and also accepts the mongrel `-no-undefined` but we shouldn't rely on that imho.\n\nI made the other cosmetic changes.\n\nIt doesn't break anything on Linux. After you review the spkg, the buildbot will catch anything that breaks on exotic platforms.",
    "created_at": "2013-01-30T11:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214454",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:5'></a>Long-style is `--no-undefined` (two dashes), short is `-z`. ld is being nice and also accepts the mongrel `-no-undefined` but we shouldn't rely on that imho.

I made the other cosmetic changes.

It doesn't break anything on Linux. After you review the spkg, the buildbot will catch anything that breaks on exotic platforms.



---

archive/issue_comments_214455.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-01-30T11:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214455",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_214456.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [vbraun](#comment%3A5):\n> Long-style is `--no-undefined` (two dashes), short is `-z`. ld is being nice and also accepts the mongrel `-no-undefined` but we shouldn't rely on that imho.\n\nIts not an ld flag its a libtool one and its definitely one dash.\nThe fact that libtool does not follow usual conventions is another problem.\n> \n> I made the other cosmetic changes.\n> \n> It doesn't break anything on Linux. After you review the spkg, the buildbot will catch anything that breaks on exotic platforms.",
    "created_at": "2013-01-30T12:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214456",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:7'></a>Replying to [vbraun](#comment%3A5):
> Long-style is `--no-undefined` (two dashes), short is `-z`. ld is being nice and also accepts the mongrel `-no-undefined` but we shouldn't rely on that imho.

Its not an ld flag its a libtool one and its definitely one dash.
The fact that libtool does not follow usual conventions is another problem.
> 
> I made the other cosmetic changes.
> 
> It doesn't break anything on Linux. After you review the spkg, the buildbot will catch anything that breaks on exotic platforms.



---

archive/issue_comments_214457.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-01-30T12:07:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214457",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_214458.json:
```json
{
    "body": "<a id='comment:8'></a>(And I seem to remember there should be a LIBTOOLFLAGS var or stg like that, but I don't think anyone uses is, not even sure libtool uses it itself...)",
    "created_at": "2013-01-30T12:08:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214458",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:8'></a>(And I seem to remember there should be a LIBTOOLFLAGS var or stg like that, but I don't think anyone uses is, not even sure libtool uses it itself...)



---

archive/issue_comments_214459.json:
```json
{
    "body": "<a id='comment:9'></a>Why do we even need `CXXFLAGS`? There is no C++ in GAP, isn't it?",
    "created_at": "2013-02-05T04:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214459",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>Why do we even need `CXXFLAGS`? There is no C++ in GAP, isn't it?



---

archive/issue_comments_214460.json:
```json
{
    "body": "<a id='comment:10'></a>Please see https://bitbucket.org/vbraun/libgap/pull-requests/1/cf-sage-trac-14038/diff\nfor updates on this",
    "created_at": "2013-02-05T08:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214460",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>Please see https://bitbucket.org/vbraun/libgap/pull-requests/1/cf-sage-trac-14038/diff
for updates on this



---

archive/issue_comments_214461.json:
```json
{
    "body": "<a id='comment:11'></a>Replying to [dimpase](#comment%3A9):\n> Why do we even need `CXXFLAGS`? There is no C++ in GAP, isn't it? \n\nDon't know but I feel you're right.\nId say its an artifact from the time where spkg-install files' headers were all formatted the same.",
    "created_at": "2013-02-05T09:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214461",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:11'></a>Replying to [dimpase](#comment%3A9):
> Why do we even need `CXXFLAGS`? There is no C++ in GAP, isn't it? 

Don't know but I feel you're right.
Id say its an artifact from the time where spkg-install files' headers were all formatted the same.



---

archive/issue_comments_214462.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [dimpase](#comment%3A10):\n> Please see https://bitbucket.org/vbraun/libgap/pull-requests/1/cf-sage-trac-14038/diff\n> for updates on this\n\n\nso we need a Python patch for this to work on OSX.\nhttp://hg.python.org/cpython/rev/864b9836dae6\nI've opened #14057 for this.",
    "created_at": "2013-02-05T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214462",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>Replying to [dimpase](#comment%3A10):
> Please see https://bitbucket.org/vbraun/libgap/pull-requests/1/cf-sage-trac-14038/diff
> for updates on this


so we need a Python patch for this to work on OSX.
http://hg.python.org/cpython/rev/864b9836dae6
I've opened #14057 for this.



---

archive/issue_comments_214463.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#14057\"",
    "created_at": "2013-02-05T09:45:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214463",
    "user": "https://github.com/dimpase"
}
```

Changing dependencies from "" to "#14057"



---

archive/issue_comments_214464.json:
```json
{
    "body": "<a id='comment:14'></a>Even after applying #14057 the modified libgap does not build on OSX 10.6.8.\nDoes it need more libtool magic? I get:\n\n```\nlibtool: link: gcc -dynamiclib  -o .libs/libgap.0.dylib  .libs/libgap_la-ariths.o .libs/libgap_la-c_random.o .libs/libgap_la-gmpints.o .libs/libgap_la-objccoll.o .libs/libgap_la-rational.o .libs/libgap_la-system.o .libs/libgap_la-blister.o .libs/libgap_la-c_type1.o .libs/libgap_la-gvars.o .libs/libgap_la-objcftl.o .libs/libgap_la-read.o .libs/libgap_la-tietze.o .libs/libgap_la-bool.o .libs/libgap_la-cyclotom.o .libs/libgap_la-integer.o .libs/libgap_la-objects.o .libs/libgap_la-records.o .libs/libgap_la-vars.o .libs/libgap_la-calls.o .libs/libgap_la-dt.o .libs/libgap_la-intfuncs.o .libs/libgap_la-objfgelm.o .libs/libgap_la-saveload.o .libs/libgap_la-vec8bit.o .libs/libgap_la-c_filt1.o .libs/libgap_la-dteval.o .libs/libgap_la-intrprtr.o .libs/libgap_la-objpcgel.o .libs/libgap_la-scanner.o .libs/libgap_la-vecffe.o .libs/libgap_la-c_meths1.o .libs/libgap_la-exprs.o .libs/libgap_la-iostream.o .libs/libgap_la-objscoll.o .libs/libgap_la-sctable.o .libs/libgap_la-vecgf2.o .libs/libgap_la-code.o .libs/libgap_la-finfield.o .libs/libgap_la-libgap.o .libs/libgap_la-opers.o .libs/libgap_la-set.o .libs/libgap_la-vector.o .libs/libgap_la-compiler.o .libs/libgap_la-funcs.o .libs/libgap_la-listfunc.o .libs/libgap_la-permutat.o .libs/libgap_la-stats.o .libs/libgap_la-weakptr.o .libs/libgap_la-compstat.o .libs/libgap_la-gap.o .libs/libgap_la-listoper.o .libs/libgap_la-plist.o .libs/libgap_la-streams.o .libs/libgap_la-c_oper1.o .libs/libgap_la-lists.o .libs/libgap_la-precord.o .libs/libgap_la-string.o .libs/libgap_la-costab.o .libs/libgap_la-gasman.o .libs/libgap_la-macfloat.o .libs/libgap_la-range.o .libs/libgap_la-sysfiles.o   -L/usr/local/src/sage/sage-5.6.beta2/local/lib /usr/local/src/sage/sage-5.6.beta2/local/lib/libgmp.dylib    -install_name  /usr/local/src/sage/sage-5.6.beta2/local/lib/libgap.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module\nUndefined symbols:\n  \"_environ\", referenced from:\n      _libgap_initialize in libgap_la-libgap.o\n      _libGAP_SyExecuteProcess in libgap_la-sysfiles.o\nld: symbol(s) not found\ncollect2: ld returned 1 exit status\nmake[2]: *** [libgap.la] Error 1\n```",
    "created_at": "2013-02-05T11:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214464",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>Even after applying #14057 the modified libgap does not build on OSX 10.6.8.
Does it need more libtool magic? I get:

```
libtool: link: gcc -dynamiclib  -o .libs/libgap.0.dylib  .libs/libgap_la-ariths.o .libs/libgap_la-c_random.o .libs/libgap_la-gmpints.o .libs/libgap_la-objccoll.o .libs/libgap_la-rational.o .libs/libgap_la-system.o .libs/libgap_la-blister.o .libs/libgap_la-c_type1.o .libs/libgap_la-gvars.o .libs/libgap_la-objcftl.o .libs/libgap_la-read.o .libs/libgap_la-tietze.o .libs/libgap_la-bool.o .libs/libgap_la-cyclotom.o .libs/libgap_la-integer.o .libs/libgap_la-objects.o .libs/libgap_la-records.o .libs/libgap_la-vars.o .libs/libgap_la-calls.o .libs/libgap_la-dt.o .libs/libgap_la-intfuncs.o .libs/libgap_la-objfgelm.o .libs/libgap_la-saveload.o .libs/libgap_la-vec8bit.o .libs/libgap_la-c_filt1.o .libs/libgap_la-dteval.o .libs/libgap_la-intrprtr.o .libs/libgap_la-objpcgel.o .libs/libgap_la-scanner.o .libs/libgap_la-vecffe.o .libs/libgap_la-c_meths1.o .libs/libgap_la-exprs.o .libs/libgap_la-iostream.o .libs/libgap_la-objscoll.o .libs/libgap_la-sctable.o .libs/libgap_la-vecgf2.o .libs/libgap_la-code.o .libs/libgap_la-finfield.o .libs/libgap_la-libgap.o .libs/libgap_la-opers.o .libs/libgap_la-set.o .libs/libgap_la-vector.o .libs/libgap_la-compiler.o .libs/libgap_la-funcs.o .libs/libgap_la-listfunc.o .libs/libgap_la-permutat.o .libs/libgap_la-stats.o .libs/libgap_la-weakptr.o .libs/libgap_la-compstat.o .libs/libgap_la-gap.o .libs/libgap_la-listoper.o .libs/libgap_la-plist.o .libs/libgap_la-streams.o .libs/libgap_la-c_oper1.o .libs/libgap_la-lists.o .libs/libgap_la-precord.o .libs/libgap_la-string.o .libs/libgap_la-costab.o .libs/libgap_la-gasman.o .libs/libgap_la-macfloat.o .libs/libgap_la-range.o .libs/libgap_la-sysfiles.o   -L/usr/local/src/sage/sage-5.6.beta2/local/lib /usr/local/src/sage/sage-5.6.beta2/local/lib/libgmp.dylib    -install_name  /usr/local/src/sage/sage-5.6.beta2/local/lib/libgap.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module
Undefined symbols:
  "_environ", referenced from:
      _libgap_initialize in libgap_la-libgap.o
      _libGAP_SyExecuteProcess in libgap_la-sysfiles.o
ld: symbol(s) not found
collect2: ld returned 1 exit status
make[2]: *** [libgap.la] Error 1
```



---

archive/issue_comments_214465.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [dimpase](#comment%3A14):\n> Even after applying #14057 the modified libgap does not build on OSX 10.6.8.\n> Does it need more libtool magic? \n\n\nSpecifying -no-undefined only for CYGWIN will fix this. I don't know how to do this properly, though. Any tips?",
    "created_at": "2013-02-05T12:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214465",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>Replying to [dimpase](#comment%3A14):
> Even after applying #14057 the modified libgap does not build on OSX 10.6.8.
> Does it need more libtool magic? 


Specifying -no-undefined only for CYGWIN will fix this. I don't know how to do this properly, though. Any tips?



---

archive/issue_comments_214466.json:
```json
{
    "body": "<a id='comment:16'></a>Yup Ill post a patch.\nFirst time I see -no-undefined break something. Nice!",
    "created_at": "2013-02-05T13:31:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214466",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:16'></a>Yup Ill post a patch.
First time I see -no-undefined break something. Nice!



---

archive/issue_comments_214467.json:
```json
{
    "body": "<a id='comment:17'></a>But without undefined do you get a shared library on OS X ?",
    "created_at": "2013-02-05T14:00:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214467",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:17'></a>But without undefined do you get a shared library on OS X ?



---

archive/issue_comments_214468.json:
```json
{
    "body": "<a id='comment:18'></a>And I don't really feel #14057 could fix anything here.\nIt provides a fix for Python and it does not seem to me that libgap links to Python anyway...\nBut I agree we would need a similar fix in libgap, that is properly define environ in libgap (src/libgap.c) and not assume it is available.",
    "created_at": "2013-02-05T14:09:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214468",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:18'></a>And I don't really feel #14057 could fix anything here.
It provides a fix for Python and it does not seem to me that libgap links to Python anyway...
But I agree we would need a similar fix in libgap, that is properly define environ in libgap (src/libgap.c) and not assume it is available.



---

archive/issue_comments_214469.json:
```json
{
    "body": "<a id='comment:19'></a>For example, similar fix here:\nhttps://bugzilla.samba.org/show_bug.cgi?id=5412",
    "created_at": "2013-02-05T14:11:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214469",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:19'></a>For example, similar fix here:
https://bugzilla.samba.org/show_bug.cgi?id=5412



---

archive/issue_comments_214470.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [jpflori](#comment%3A18):\n> And I don't really feel #14057 could fix anything here.\n> It provides a fix for Python and it does not seem to me that libgap links to Python anyway...\n\nyes, I agree. I'll remove it from the deps.\n\n> But I agree we would need a similar fix in libgap, that is properly define environ in libgap (src/libgap.c) and not assume it is available.\n\n\nI wonder if this is actually an OSX-specific  libgap bug, to use `-undefined dynamic_lookup` to get `environ`.\n(or maybe this part of the code is never used in libgap setting)\n\n[OSX docs](http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man7/environ.7.html) say that it's recommended to use `getenv()` etc, but that's GAPs design to use `environ` directly (and it's needed for `spawn()` etc there).  \nAnd `environ` is not available to shared libraries, according to [loc.cit.](http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man7/environ.7.html), and one should use `_NSGetEnviron()` routine from `<crt_externs.h>`. (So one could add this to `src/sysfiles.c` if needed.)",
    "created_at": "2013-02-05T14:27:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214470",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:20'></a>Replying to [jpflori](#comment%3A18):
> And I don't really feel #14057 could fix anything here.
> It provides a fix for Python and it does not seem to me that libgap links to Python anyway...

yes, I agree. I'll remove it from the deps.

> But I agree we would need a similar fix in libgap, that is properly define environ in libgap (src/libgap.c) and not assume it is available.


I wonder if this is actually an OSX-specific  libgap bug, to use `-undefined dynamic_lookup` to get `environ`.
(or maybe this part of the code is never used in libgap setting)

[OSX docs](http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man7/environ.7.html) say that it's recommended to use `getenv()` etc, but that's GAPs design to use `environ` directly (and it's needed for `spawn()` etc there).  
And `environ` is not available to shared libraries, according to [loc.cit.](http://developer.apple.com/library/mac/#documentation/Darwin/Reference/ManPages/man7/environ.7.html), and one should use `_NSGetEnviron()` routine from `<crt_externs.h>`. (So one could add this to `src/sysfiles.c` if needed.)



---

archive/issue_comments_214471.json:
```json
{
    "body": "Changing dependencies from \"#14057\" to \"\"",
    "created_at": "2013-02-05T14:28:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214471",
    "user": "https://github.com/dimpase"
}
```

Changing dependencies from "#14057" to ""



---

archive/issue_comments_214472.json:
```json
{
    "body": "<a id='comment:22'></a>Could you post a log of a succesful build of libgap on your OS X somewhere?\nAnd a failed one when no-undefined is passed to libtool?\nI'd be interested in seeing what happens.",
    "created_at": "2013-02-05T14:37:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214472",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:22'></a>Could you post a log of a succesful build of libgap on your OS X somewhere?
And a failed one when no-undefined is passed to libtool?
I'd be interested in seeing what happens.



---

archive/issue_comments_214473.json:
```json
{
    "body": "<a id='comment:23'></a>Whatever, I guess that passing -no-undefined to libtool just overrides its default behavior to pass -undefined dynamic_lookup to ld on OS X.\n\nSo we have two solutions:\n* only pass -no-undefined where it is really needed, that is on Cygwin,\n* use _NSGetEnviron() routine from <crt_externs.h> to define environ on OS X.",
    "created_at": "2013-02-05T14:41:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214473",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:23'></a>Whatever, I guess that passing -no-undefined to libtool just overrides its default behavior to pass -undefined dynamic_lookup to ld on OS X.

So we have two solutions:
* only pass -no-undefined where it is really needed, that is on Cygwin,
* use _NSGetEnviron() routine from <crt_externs.h> to define environ on OS X.



---

archive/issue_comments_214474.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [jpflori](#comment%3A23):\n> Whatever, I guess that passing -no-undefined to libtool just overrides its default behavior to pass -undefined dynamic_lookup to ld on OS X.\n\n>\nindeed.\n \n> So we have two solutions:\n> * only pass -no-undefined where it is really needed, that is on Cygwin,\n> * use _NSGetEnviron() routine from <crt_externs.h> to define environ on OS X.\n\n\nlet us try to see if the latter is needed. My understanding is that currently the corresponding part of GAP functionality (`ExecuteProcess()`) is not exposed,  and/or not implemented, in libGAP, and so it's not visible whether it is a bug to use -undefined dynamic_lookup to get (or not?) `environ` on OSX.\n\nOr, perhaps, Volker knows the answer already? Perhaps he's not going to use this part of the orginal GAP code in libGAP at all?",
    "created_at": "2013-02-05T14:51:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214474",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>Replying to [jpflori](#comment%3A23):
> Whatever, I guess that passing -no-undefined to libtool just overrides its default behavior to pass -undefined dynamic_lookup to ld on OS X.

>
indeed.
 
> So we have two solutions:
> * only pass -no-undefined where it is really needed, that is on Cygwin,
> * use _NSGetEnviron() routine from <crt_externs.h> to define environ on OS X.


let us try to see if the latter is needed. My understanding is that currently the corresponding part of GAP functionality (`ExecuteProcess()`) is not exposed,  and/or not implemented, in libGAP, and so it's not visible whether it is a bug to use -undefined dynamic_lookup to get (or not?) `environ` on OSX.

Or, perhaps, Volker knows the answer already? Perhaps he's not going to use this part of the orginal GAP code in libGAP at all?



---

archive/issue_comments_214475.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [dimpase](#comment%3A24):\n> Replying to [jpflori](#comment%3A23):\n> > Whatever, I guess that passing -no-undefined to libtool just overrides its default behavior to pass -undefined dynamic_lookup to ld on OS X.\n\n> >\n> indeed.\n>  \n> > So we have two solutions:\n> > * only pass -no-undefined where it is really needed, that is on Cygwin,\n> > * use _NSGetEnviron() routine from <crt_externs.h> to define environ on OS X.\n \n> \n> let us try to see if the latter is needed. My understanding is that currently the corresponding part of GAP functionality (`ExecuteProcess()`) is not exposed,  and/or not implemented, in libGAP, and so it's not visible whether it is a bug to use -undefined dynamic_lookup to get (or not?) `environ` on OSX.\n\n\n\nMy understanding from e.g. [this thread](http://www.mail-archive.com/bug-gnulib`@`gnu.org/msg09272.html) is that `extern char** environ` with `-no-undefined` for a shared library used with the OSX ld  and `_NSGetEnviron()` lead to equivalent results. \n\nSo it seems that to make this change non-OSX only, or Cygwin-only, is right. AFAIK, Volker is currently away, so you can have a go at it yourself if you have time.",
    "created_at": "2013-02-06T07:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214475",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>Replying to [dimpase](#comment%3A24):
> Replying to [jpflori](#comment%3A23):
> > Whatever, I guess that passing -no-undefined to libtool just overrides its default behavior to pass -undefined dynamic_lookup to ld on OS X.

> >
> indeed.
>  
> > So we have two solutions:
> > * only pass -no-undefined where it is really needed, that is on Cygwin,
> > * use _NSGetEnviron() routine from <crt_externs.h> to define environ on OS X.
 
> 
> let us try to see if the latter is needed. My understanding is that currently the corresponding part of GAP functionality (`ExecuteProcess()`) is not exposed,  and/or not implemented, in libGAP, and so it's not visible whether it is a bug to use -undefined dynamic_lookup to get (or not?) `environ` on OSX.



My understanding from e.g. [this thread](http://www.mail-archive.com/bug-gnulib`@`gnu.org/msg09272.html) is that `extern char** environ` with `-no-undefined` for a shared library used with the OSX ld  and `_NSGetEnviron()` lead to equivalent results. 

So it seems that to make this change non-OSX only, or Cygwin-only, is right. AFAIK, Volker is currently away, so you can have a go at it yourself if you have time.



---

archive/issue_comments_214476.json:
```json
{
    "body": "<a id='comment:26'></a>I don't really follow you here.\nFrom what you linked, it seems that using an extern environ won't work (unless we allow undefined vars at compile time and hope that at runtime something will have properly defined and exported environ and we can link to it, which I find bad practice), and that instead one should use _NSGetEnviron() (which is available and can be linked in at compile time).\n\nEven though only defining -no-undefined on Cygwin can only smoothen things, I don't think it would be a mistake to define it unconditionally, provided we correctly define environ in all situations.",
    "created_at": "2013-02-06T09:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214476",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:26'></a>I don't really follow you here.
From what you linked, it seems that using an extern environ won't work (unless we allow undefined vars at compile time and hope that at runtime something will have properly defined and exported environ and we can link to it, which I find bad practice), and that instead one should use _NSGetEnviron() (which is available and can be linked in at compile time).

Even though only defining -no-undefined on Cygwin can only smoothen things, I don't think it would be a mistake to define it unconditionally, provided we correctly define environ in all situations.



---

archive/issue_comments_214477.json:
```json
{
    "body": "<a id='comment:27'></a>Could you try the spkg at\nhttp://boxen.math.washington.edu/home/jpflori/libgap-4.5.7.p1.spkg\n?\n\nJust to see if using _NSGetEnviron is enough to solve our problem on OS X.",
    "created_at": "2013-02-06T09:43:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214477",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:27'></a>Could you try the spkg at
http://boxen.math.washington.edu/home/jpflori/libgap-4.5.7.p1.spkg
?

Just to see if using _NSGetEnviron is enough to solve our problem on OS X.



---

archive/issue_comments_214478.json:
```json
{
    "body": "<a id='comment:28'></a>Replying to [jpflori](#comment%3A26):\n> I don't really follow you here.\n> From what you linked, it seems that using an extern environ won't work (unless we allow undefined vars at compile time and hope that at runtime something will have properly defined and exported environ and we can link to it, which I find bad practice), \n\n\nWell, that seems to be the usual practice on OSX, to delay such resolutions to ld. If you read\nthe [last message](http://www.mail-archive.com/bug-gnulib`@`gnu.org/msg09281.html) in the tread I mentioned, that's exactly what it says. \n\nI just tried your new spkg, and you still have at least one place (in `src/src/sysfiles.c`, I guess) where environ is undefined:\n\n```\nlibtool: link: gcc -dynamiclib  -o .libs/libgap.0.dylib  .libs/libgap_la-ariths.o .libs/libgap_la-c_random.o .libs/libgap_la-gmpints.o .libs/libgap_la-objccoll.o .libs/libgap_la-rational.o .libs/libgap_la-system.o .libs/libgap_la-blister.o .libs/libgap_la-c_type1.o .libs/libgap_la-gvars.o .libs/libgap_la-objcftl.o .libs/libgap_la-read.o .libs/libgap_la-tietze.o .libs/libgap_la-bool.o .libs/libgap_la-cyclotom.o .libs/libgap_la-integer.o .libs/libgap_la-objects.o .libs/libgap_la-records.o .libs/libgap_la-vars.o .libs/libgap_la-calls.o .libs/libgap_la-dt.o .libs/libgap_la-intfuncs.o .libs/libgap_la-objfgelm.o .libs/libgap_la-saveload.o .libs/libgap_la-vec8bit.o .libs/libgap_la-c_filt1.o .libs/libgap_la-dteval.o .libs/libgap_la-intrprtr.o .libs/libgap_la-objpcgel.o .libs/libgap_la-scanner.o .libs/libgap_la-vecffe.o .libs/libgap_la-c_meths1.o .libs/libgap_la-exprs.o .libs/libgap_la-iostream.o .libs/libgap_la-objscoll.o .libs/libgap_la-sctable.o .libs/libgap_la-vecgf2.o .libs/libgap_la-code.o .libs/libgap_la-finfield.o .libs/libgap_la-libgap.o .libs/libgap_la-opers.o .libs/libgap_la-set.o .libs/libgap_la-vector.o .libs/libgap_la-compiler.o .libs/libgap_la-funcs.o .libs/libgap_la-listfunc.o .libs/libgap_la-permutat.o .libs/libgap_la-stats.o .libs/libgap_la-weakptr.o .libs/libgap_la-compstat.o .libs/libgap_la-gap.o .libs/libgap_la-listoper.o .libs/libgap_la-plist.o .libs/libgap_la-streams.o .libs/libgap_la-c_oper1.o .libs/libgap_la-lists.o .libs/libgap_la-precord.o .libs/libgap_la-string.o .libs/libgap_la-costab.o .libs/libgap_la-gasman.o .libs/libgap_la-macfloat.o .libs/libgap_la-range.o .libs/libgap_la-sysfiles.o   -L/usr/local/src/sage/sage-5.6.beta2/local/lib /usr/local/src/sage/sage-5.6.beta2/local/lib/libgmp.dylib    -install_name  /usr/local/src/sage/sage-5.6.beta2/local/lib/libgap.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module\n\nUndefined symbols:\n  \"_environ\", referenced from:\n      _libGAP_SyExecuteProcess in libgap_la-sysfiles.o\n```",
    "created_at": "2013-02-06T10:37:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214478",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>Replying to [jpflori](#comment%3A26):
> I don't really follow you here.
> From what you linked, it seems that using an extern environ won't work (unless we allow undefined vars at compile time and hope that at runtime something will have properly defined and exported environ and we can link to it, which I find bad practice), 


Well, that seems to be the usual practice on OSX, to delay such resolutions to ld. If you read
the [last message](http://www.mail-archive.com/bug-gnulib`@`gnu.org/msg09281.html) in the tread I mentioned, that's exactly what it says. 

I just tried your new spkg, and you still have at least one place (in `src/src/sysfiles.c`, I guess) where environ is undefined:

```
libtool: link: gcc -dynamiclib  -o .libs/libgap.0.dylib  .libs/libgap_la-ariths.o .libs/libgap_la-c_random.o .libs/libgap_la-gmpints.o .libs/libgap_la-objccoll.o .libs/libgap_la-rational.o .libs/libgap_la-system.o .libs/libgap_la-blister.o .libs/libgap_la-c_type1.o .libs/libgap_la-gvars.o .libs/libgap_la-objcftl.o .libs/libgap_la-read.o .libs/libgap_la-tietze.o .libs/libgap_la-bool.o .libs/libgap_la-cyclotom.o .libs/libgap_la-integer.o .libs/libgap_la-objects.o .libs/libgap_la-records.o .libs/libgap_la-vars.o .libs/libgap_la-calls.o .libs/libgap_la-dt.o .libs/libgap_la-intfuncs.o .libs/libgap_la-objfgelm.o .libs/libgap_la-saveload.o .libs/libgap_la-vec8bit.o .libs/libgap_la-c_filt1.o .libs/libgap_la-dteval.o .libs/libgap_la-intrprtr.o .libs/libgap_la-objpcgel.o .libs/libgap_la-scanner.o .libs/libgap_la-vecffe.o .libs/libgap_la-c_meths1.o .libs/libgap_la-exprs.o .libs/libgap_la-iostream.o .libs/libgap_la-objscoll.o .libs/libgap_la-sctable.o .libs/libgap_la-vecgf2.o .libs/libgap_la-code.o .libs/libgap_la-finfield.o .libs/libgap_la-libgap.o .libs/libgap_la-opers.o .libs/libgap_la-set.o .libs/libgap_la-vector.o .libs/libgap_la-compiler.o .libs/libgap_la-funcs.o .libs/libgap_la-listfunc.o .libs/libgap_la-permutat.o .libs/libgap_la-stats.o .libs/libgap_la-weakptr.o .libs/libgap_la-compstat.o .libs/libgap_la-gap.o .libs/libgap_la-listoper.o .libs/libgap_la-plist.o .libs/libgap_la-streams.o .libs/libgap_la-c_oper1.o .libs/libgap_la-lists.o .libs/libgap_la-precord.o .libs/libgap_la-string.o .libs/libgap_la-costab.o .libs/libgap_la-gasman.o .libs/libgap_la-macfloat.o .libs/libgap_la-range.o .libs/libgap_la-sysfiles.o   -L/usr/local/src/sage/sage-5.6.beta2/local/lib /usr/local/src/sage/sage-5.6.beta2/local/lib/libgmp.dylib    -install_name  /usr/local/src/sage/sage-5.6.beta2/local/lib/libgap.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module

Undefined symbols:
  "_environ", referenced from:
      _libGAP_SyExecuteProcess in libgap_la-sysfiles.o
```



---

archive/issue_comments_214479.json:
```json
{
    "body": "<a id='comment:29'></a>The spkg is updated (I've not commited anything as I don't want to deal with the external repository hell).\n\nAnd I still do not understand what you meant after reading all the thread.\nThe last message basically says that using _NSGetEnviron() worked, and in other messages its told that the solution used is not to remove no-undefined but to use _NSGetEnviron().\n\nBy ld do you mean run-time linking? because I don't think its ld that takes care of that.\nAnd passing -undefined dynamic_lookup won't let ld resolve anything at linking time.\nIt is just a promise that at runtime environ will be available somehow, which could perfectly not be the case if the proper libraries are not loaded.",
    "created_at": "2013-02-06T10:56:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214479",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:29'></a>The spkg is updated (I've not commited anything as I don't want to deal with the external repository hell).

And I still do not understand what you meant after reading all the thread.
The last message basically says that using _NSGetEnviron() worked, and in other messages its told that the solution used is not to remove no-undefined but to use _NSGetEnviron().

By ld do you mean run-time linking? because I don't think its ld that takes care of that.
And passing -undefined dynamic_lookup won't let ld resolve anything at linking time.
It is just a promise that at runtime environ will be available somehow, which could perfectly not be the case if the proper libraries are not loaded.



---

archive/issue_comments_214480.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [jpflori](#comment%3A29):\n> The spkg is updated (I've not commited anything as I don't want to deal with the external repository hell).\n\n\nOK, it builds and seemingly works.\n\n> \n> And I still do not understand what you meant after reading all the thread.\n> The last message basically says that using _NSGetEnviron() worked, and in other messages its told that the solution used is not to remove no-undefined but to use _NSGetEnviron().\n\n\nNo, I think it says that the library built with the -undefined dynamic_lookup option works.\n> \n> By ld do you mean run-time linking? because I don't think its ld that takes care of that.\n\n\nOK, here is the example:\n\n```\n$ cat enlib.c\nextern char** environ;\nchar *** environ_addr (void) { return &environ; }\n\n$ glibtool --mode=compile gcc -c enlib.c \nglibtool: compile:  gcc -c enlib.c  -fno-common -DPIC -o .libs/enlib.o\nglibtool: compile:  gcc -c enlib.c -o enlib.o >/dev/null 2>&1\n\n$ glibtool --mode=link gcc -o libenlib.la enlib.lo -rpath /tmp\nglibtool: link: rm -fr  .libs/libenlib.a .libs/libenlib.la\nglibtool: link: gcc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libenlib.0.dylib  .libs/enlib.o      -install_name  /tmp/libenlib.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module\nglibtool: link: dsymutil .libs/libenlib.0.dylib || :\nwarning: no debug symbols in executable (-arch x86_64)\nglibtool: link: (cd \".libs\" && rm -f \"libenlib.dylib\" && ln -s \"libenlib.0.dylib\" \"libenlib.dylib\")\nglibtool: link: (cd \".libs\" && rm -f \"libenlib.0.0.0.dylib\" && ln -s \"libenlib.0.dylib\" \"libenlib.0.0.0.dylib\")\nglibtool: link: ar cru .libs/libenlib.a  enlib.o\nglibtool: link: ranlib .libs/libenlib.a\nglibtool: link: ( cd \".libs\" && rm -f \"libenlib.la\" && ln -s \"../libenlib.la\" \"libenlib.la\" )\n\n$ cat en.c\n#include <stdio.h>\n#include <crt_externs.h>\n#define macenviron (*_NSGetEnviron())\nextern char *** environ_addr (void); /* comes from my enlib */\nint main()\n{\n  printf(\" from the shared lib:\\n  %s \\n\", **environ_addr());\n  printf(\" from macenviron :\\n  %s \\n\", *macenviron);\n}\n\n$ glibtool --mode=link gcc -o en en.c libenlib.la \nglibtool: link: gcc -o .libs/en en.c  ./.libs/libenlib.0.0.0.dylib\n\n$ ./en\n from the shared lib:\n  NNTPSERVER=news.gmane.org \n from macenviron :\n  NNTPSERVER=news.gmane.org \n```\n\nSo you see, it works with `-undefined dynamic_lookup` just fine. (printf(%s) isn't the rght way of parsing of environ, so the output is cut at the first \\n, I guess).",
    "created_at": "2013-02-06T12:37:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214480",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>Replying to [jpflori](#comment%3A29):
> The spkg is updated (I've not commited anything as I don't want to deal with the external repository hell).


OK, it builds and seemingly works.

> 
> And I still do not understand what you meant after reading all the thread.
> The last message basically says that using _NSGetEnviron() worked, and in other messages its told that the solution used is not to remove no-undefined but to use _NSGetEnviron().


No, I think it says that the library built with the -undefined dynamic_lookup option works.
> 
> By ld do you mean run-time linking? because I don't think its ld that takes care of that.


OK, here is the example:

```
$ cat enlib.c
extern char** environ;
char *** environ_addr (void) { return &environ; }

$ glibtool --mode=compile gcc -c enlib.c 
glibtool: compile:  gcc -c enlib.c  -fno-common -DPIC -o .libs/enlib.o
glibtool: compile:  gcc -c enlib.c -o enlib.o >/dev/null 2>&1

$ glibtool --mode=link gcc -o libenlib.la enlib.lo -rpath /tmp
glibtool: link: rm -fr  .libs/libenlib.a .libs/libenlib.la
glibtool: link: gcc -dynamiclib -Wl,-undefined -Wl,dynamic_lookup -o .libs/libenlib.0.dylib  .libs/enlib.o      -install_name  /tmp/libenlib.0.dylib -compatibility_version 1 -current_version 1.0 -Wl,-single_module
glibtool: link: dsymutil .libs/libenlib.0.dylib || :
warning: no debug symbols in executable (-arch x86_64)
glibtool: link: (cd ".libs" && rm -f "libenlib.dylib" && ln -s "libenlib.0.dylib" "libenlib.dylib")
glibtool: link: (cd ".libs" && rm -f "libenlib.0.0.0.dylib" && ln -s "libenlib.0.dylib" "libenlib.0.0.0.dylib")
glibtool: link: ar cru .libs/libenlib.a  enlib.o
glibtool: link: ranlib .libs/libenlib.a
glibtool: link: ( cd ".libs" && rm -f "libenlib.la" && ln -s "../libenlib.la" "libenlib.la" )

$ cat en.c
#include <stdio.h>
#include <crt_externs.h>
#define macenviron (*_NSGetEnviron())
extern char *** environ_addr (void); /* comes from my enlib */
int main()
{
  printf(" from the shared lib:\n  %s \n", **environ_addr());
  printf(" from macenviron :\n  %s \n", *macenviron);
}

$ glibtool --mode=link gcc -o en en.c libenlib.la 
glibtool: link: gcc -o .libs/en en.c  ./.libs/libenlib.0.0.0.dylib

$ ./en
 from the shared lib:
  NNTPSERVER=news.gmane.org 
 from macenviron :
  NNTPSERVER=news.gmane.org 
```

So you see, it works with `-undefined dynamic_lookup` just fine. (printf(%s) isn't the rght way of parsing of environ, so the output is cut at the first \n, I guess).



---

archive/issue_comments_214481.json:
```json
{
    "body": "Changing work_issues from \"\" to \"integrate changes upstream\"",
    "created_at": "2013-02-11T10:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214481",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing work_issues from "" to "integrate changes upstream"



---

archive/issue_comments_214482.json:
```json
{
    "body": "Changing author from \"Volker Braun\" to \"Volker Braun, Jean-Pierre Flori\"",
    "created_at": "2013-02-11T10:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214482",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing author from "Volker Braun" to "Volker Braun, Jean-Pierre Flori"



---

archive/issue_comments_214483.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,4 +3,4 @@\n (By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)\n \n \n-http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg\n+http://boxen.math.washington.edu/home/jpflori/libgap-4.5.7.p1.spkg\n``````\n",
    "created_at": "2013-02-11T10:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214483",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,4 +3,4 @@
 (By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)
 
 
-http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg
+http://boxen.math.washington.edu/home/jpflori/libgap-4.5.7.p1.spkg
``````




---

archive/issue_comments_214484.json:
```json
{
    "body": "<a id='comment:31'></a>Volker, would you mind integrating the changes from the last version I posted \"upstream\" and repackage a \"proper\" spkg?",
    "created_at": "2013-02-11T10:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214484",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:31'></a>Volker, would you mind integrating the changes from the last version I posted "upstream" and repackage a "proper" spkg?



---

archive/issue_comments_214485.json:
```json
{
    "body": "<a id='comment:32'></a>Done.\n\nhttps://bitbucket.org/vbraun/libgap/commits/4ff0ca203c552df03a621eecaf64f1b1f2c5d691",
    "created_at": "2013-02-11T11:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214485",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:32'></a>Done.

https://bitbucket.org/vbraun/libgap/commits/4ff0ca203c552df03a621eecaf64f1b1f2c5d691



---

archive/issue_comments_214486.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-02-11T11:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214486",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_214487.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -3,4 +3,4 @@\n (By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)\n \n \n-http://boxen.math.washington.edu/home/jpflori/libgap-4.5.7.p1.spkg\n+http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg\n``````\n",
    "created_at": "2013-02-11T11:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214487",
    "user": "https://github.com/vbraun"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -3,4 +3,4 @@
 (By the way the spkg-install script is terrible, does not use $MAKE, use [ ] and [This is the Trac macro * * that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros# -macro), sets CXXFLAGS but does not export it...)
 
 
-http://boxen.math.washington.edu/home/jpflori/libgap-4.5.7.p1.spkg
+http://www.stp.dias.ie/~vbraun/Sage/spkg/libgap-4.5.7.p1.spkg
``````




---

archive/issue_comments_214488.json:
```json
{
    "body": "<a id='comment:33'></a>Dima, could you give it a shot on Mac OS so that we we put it as positive review?\nAs far as I'm cocnerned, everything looks fine.",
    "created_at": "2013-02-11T13:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214488",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:33'></a>Dima, could you give it a shot on Mac OS so that we we put it as positive review?
As far as I'm cocnerned, everything looks fine.



---

archive/issue_comments_214489.json:
```json
{
    "body": "Changing work_issues from \"integrate changes upstream\" to \"\"",
    "created_at": "2013-02-11T13:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214489",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing work_issues from "integrate changes upstream" to ""



---

archive/issue_comments_214490.json:
```json
{
    "body": "Changing reviewer from \"Jean-Pierre Flori\" to \"Jean-Pierre Flori, Dmitrii Pasechnik\"",
    "created_at": "2013-02-11T13:11:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214490",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing reviewer from "Jean-Pierre Flori" to "Jean-Pierre Flori, Dmitrii Pasechnik"



---

archive/issue_comments_214491.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-02-11T13:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214491",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_214492.json:
```json
{
    "body": "<a id='comment:34'></a>good; works on OSX too, including the standalone test in sage/libs/gap/test/. Positive review.",
    "created_at": "2013-02-11T13:21:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214492",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>good; works on OSX too, including the standalone test in sage/libs/gap/test/. Positive review.



---

archive/issue_events_039478.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-12T07:20:50Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "milestone": "sage-5.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14038#event-39478"
}
```



---

archive/issue_comments_214493.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-02-17T22:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214493",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed



---

archive/issue_events_039479.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-02-17T22:43:50Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14038#event-39479"
}
```



---

archive/issue_comments_214494.json:
```json
{
    "body": "Changing merged from \"\" to \"sage-5.8.beta0\"",
    "created_at": "2013-02-17T22:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14038",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14038#issuecomment-214494",
    "user": "https://github.com/jdemeyer"
}
```

Changing merged from "" to "sage-5.8.beta0"
