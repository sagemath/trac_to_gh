# Issue 14489: _S_class_group_and_units is mathematically incorrect

archive/issues_014285.json:
```json
{
    "body": "The output of _S_class_group_and_units is incorrect, and hence the output of selmer_group as well, in some cases where S contains non-principal ideals. Here's an example:\n\n```\nsage: K.<a> = NumberField(x^3 - 381 * x + 127)\nsage: S = tuple(K.primes_above(13))\nsage: K.selmer_group(S, 2)\n[-7/13*a^2 - 140/13*a + 36/13,\n 14/13*a^2 + 267/13*a - 85/13,\n 7/13*a^2 + 127/13*a - 49/13,\n -1,\n 1/13*a^2 + 20/13*a - 7/13,\n 1/13*a^2 - 19/13*a + 6/13,\n 121,\n 10/13*a^2 + 44/13*a - 4555/13]\n```\n\nIt's fairly easy, using Sage, to see that the S-2-Selmer group of K is an 8-dimensional F_2-vector space. The list of length 8 that is returned is supposed to be a basis of this (or rather a set of representatives in K<sup>\u00d7</sup>). But the S-2-Selmer group is a subgroup of K<sup>\u00d7</sup> mod squares, so 121 is the zero vector and hence the output is not linearly independent. The problem lies in the following:\n\n```\nsage: K._S_class_group_and_units(S)\n([-7/13*a^2 - 140/13*a + 36/13,\n  14/13*a^2 + 267/13*a - 85/13,\n  7/13*a^2 + 127/13*a - 49/13,\n  -1,\n  1/13*a^2 + 20/13*a - 7/13,\n  1/13*a^2 - 19/13*a + 6/13],\n [(Fractional ideal (11, a - 2), 2, 121),\n  (Fractional ideal (19, 1/13*a^2 - 45/13*a - 332/13),\n   2,\n   10/13*a^2 + 44/13*a - 4555/13)])\n```\n\nThe 121 in there is supposed to be such that (11, a-2)<sup>2</sup> = (121). But (11, a-2)<sup>2</sup> is *not* principal (in fact, (11, a-2) is a generator of the cyclic subgroup of order 6). It is just in the subgroup of the class group generated by the primes in S.\n\nI'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).\n\nApply: [[attachment:trac_14489_doctests_32_64_bit.patch](https://github.com/sagemath/sage/files/ticket14489/189268b24bd9af6a1f04f12b40b72d80.patch](https://github.com/sagemath/sage/files/ticket14489/4a056cdce62d0060a70e0c0ccc7126f5.patch),)\n\n\n**Assignee:** @loefflerd\n\n**Keywords:** S-class group\n\n**Reviewer:** Peter Bruin\n\n**Author:** Robert Harron\n\n**Merged:** sage-5.11.rc0\n\nIssue created by migration from https://trac.sagemath.org/ticket/14489\n\n",
    "closed_at": "2013-07-31T12:54:55Z",
    "created_at": "2013-04-25T14:27:25Z",
    "labels": [
        "component: number fields",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-5.11",
    "title": "_S_class_group_and_units is mathematically incorrect",
    "type": "issue",
    "url": "https://github.com/sagemath/sage/issues/14489",
    "user": "https://github.com/rharron"
}
```
The output of _S_class_group_and_units is incorrect, and hence the output of selmer_group as well, in some cases where S contains non-principal ideals. Here's an example:

```
sage: K.<a> = NumberField(x^3 - 381 * x + 127)
sage: S = tuple(K.primes_above(13))
sage: K.selmer_group(S, 2)
[-7/13*a^2 - 140/13*a + 36/13,
 14/13*a^2 + 267/13*a - 85/13,
 7/13*a^2 + 127/13*a - 49/13,
 -1,
 1/13*a^2 + 20/13*a - 7/13,
 1/13*a^2 - 19/13*a + 6/13,
 121,
 10/13*a^2 + 44/13*a - 4555/13]
```

It's fairly easy, using Sage, to see that the S-2-Selmer group of K is an 8-dimensional F_2-vector space. The list of length 8 that is returned is supposed to be a basis of this (or rather a set of representatives in K<sup>×</sup>). But the S-2-Selmer group is a subgroup of K<sup>×</sup> mod squares, so 121 is the zero vector and hence the output is not linearly independent. The problem lies in the following:

```
sage: K._S_class_group_and_units(S)
([-7/13*a^2 - 140/13*a + 36/13,
  14/13*a^2 + 267/13*a - 85/13,
  7/13*a^2 + 127/13*a - 49/13,
  -1,
  1/13*a^2 + 20/13*a - 7/13,
  1/13*a^2 - 19/13*a + 6/13],
 [(Fractional ideal (11, a - 2), 2, 121),
  (Fractional ideal (19, 1/13*a^2 - 45/13*a - 332/13),
   2,
   10/13*a^2 + 44/13*a - 4555/13)])
```

The 121 in there is supposed to be such that (11, a-2)<sup>2</sup> = (121). But (11, a-2)<sup>2</sup> is *not* principal (in fact, (11, a-2) is a generator of the cyclic subgroup of order 6). It is just in the subgroup of the class group generated by the primes in S.

I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).

Apply: [[attachment:trac_14489_doctests_32_64_bit.patch](https://github.com/sagemath/sage/files/ticket14489/189268b24bd9af6a1f04f12b40b72d80.patch](https://github.com/sagemath/sage/files/ticket14489/4a056cdce62d0060a70e0c0ccc7126f5.patch),)


**Assignee:** @loefflerd

**Keywords:** S-class group

**Reviewer:** Peter Bruin

**Author:** Robert Harron

**Merged:** sage-5.11.rc0

Issue created by migration from https://trac.sagemath.org/ticket/14489





---

archive/issue_comments_177441.json:
```json
{
    "body": "**Author:** Robert Harron",
    "created_at": "2013-04-25T14:53:34Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177441",
    "user": "https://github.com/rharron"
}
```

**Author:** Robert Harron



---

archive/issue_events_125979.json:
```json
{
    "actor": "https://github.com/rharron",
    "created_at": "2013-04-25T14:53:34Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125979"
}
```



---

archive/issue_comments_177442.json:
```json
{
    "body": "<a id='comment:1'></a>\nNote: technically this depends on #14391, but that ticket has already been merged into 5.9beta4, so I haven't listed it.\n\nAlso, I doctested the number field module with this patch applied, but haven't done the full long doctesting. I'll do that overnight.",
    "created_at": "2013-04-25T14:53:34Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177442",
    "user": "https://github.com/rharron"
}
```

<a id='comment:1'></a>
Note: technically this depends on #14391, but that ticket has already been merged into 5.9beta4, so I haven't listed it.

Also, I doctested the number field module with this patch applied, but haven't done the full long doctesting. I'll do that overnight.



---

archive/issue_comments_177443.json:
```json
{
    "body": "<a id='comment:2'></a>\nSome things on the docstrings and code from looking at the patch file:\n\n- I think it would be better to put the import of `prod` and `Matrix` at the module level since they are imported at startup anyways. This will have a small, but noticable effect on the speed.\n- Could you add a doctest to check the output when `len(S) == 0` and/or `J.is_principle()` is true (if these tests aren't already present)?\n- Could you indent the block starting at line 3486 by 2 spaces (the first char should be in-line with the first non-whitespace character after the bullet/dash)?\n\nI can't do the mathematical review.\n\nThanks,\n\nTravis",
    "created_at": "2013-04-25T21:19:08Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177443",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
Some things on the docstrings and code from looking at the patch file:

- I think it would be better to put the import of `prod` and `Matrix` at the module level since they are imported at startup anyways. This will have a small, but noticable effect on the speed.
- Could you add a doctest to check the output when `len(S) == 0` and/or `J.is_principle()` is true (if these tests aren't already present)?
- Could you indent the block starting at line 3486 by 2 spaces (the first char should be in-line with the first non-whitespace character after the bullet/dash)?

I can't do the mathematical review.

Thanks,

Travis



---

archive/issue_comments_177444.json:
```json
{
    "body": "<a id='comment:3'></a>\nThanks, Travis, I'll try to get around to those changes tonight. One comment and one question:\n\n(1) Re the doctests: the first doctest (which was already there) is an example of the case len(S) == 0. The second doctest (which was already there) is when S contains only principal ideals and so the J you come across is necessarily already principal. Also, in the doctest I added, for the second ideal (namely (19, 1/13*a<sup>2</sup> - 45/13*a - 332/13)) the J you get is principal. So, your second point is already covered. Should I add comments to this effect in the docs?\n\n(2) Re import: So, I have no real idea when to import in the module and when to import in the function. Is there somewhere to read about that. I guess you're saying that in the case of the two functions at hand, these are imported by sage when you boot it and so really are already loaded and so I might as well import them at the module level?\n\nThanks!",
    "created_at": "2013-04-25T22:23:19Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177444",
    "user": "https://github.com/rharron"
}
```

<a id='comment:3'></a>
Thanks, Travis, I'll try to get around to those changes tonight. One comment and one question:

(1) Re the doctests: the first doctest (which was already there) is an example of the case len(S) == 0. The second doctest (which was already there) is when S contains only principal ideals and so the J you come across is necessarily already principal. Also, in the doctest I added, for the second ideal (namely (19, 1/13*a<sup>2</sup> - 45/13*a - 332/13)) the J you get is principal. So, your second point is already covered. Should I add comments to this effect in the docs?

(2) Re import: So, I have no real idea when to import in the module and when to import in the function. Is there somewhere to read about that. I guess you're saying that in the case of the two functions at hand, these are imported by sage when you boot it and so really are already loaded and so I might as well import them at the module level?

Thanks!



---

archive/issue_comments_177445.json:
```json
{
    "body": "<a id='comment:4'></a>\nHey Robert,\n\nReplying to [robharron](#comment%3A3):\n> (1) Re the doctests: the first doctest (which was already there) is an example of the case len(S) == 0. The second doctest (which was already there) is when S contains only principal ideals and so the J you come across is necessarily already principal. Also, in the doctest I added, for the second ideal (namely (19, 1/13*a<sup>2</sup> - 45/13*a - 332/13)) the J you get is principal. So, your second point is already covered. Should I add comments to this effect in the docs?\n\n\nNo, this is likely clear to those in the field.\n\n> (2) Re import: So, I have no real idea when to import in the module and when to import in the function. Is there somewhere to read about that.\n\n\nIt's a matter of when the module with the class/function is loaded into sage. If it's at the module level, it is imported when the module is imported (which is anytime any part of a module is imported [at startup, this is in an `all.py` file]). Thus there are two reasons not to import something at the module level:\n\n1. It is a very large import that is not happening otherwise and is typically not needed until called. These large imports causes sage to take longer to startup (ex. numpy is not imported at startup).\n\n2. It would cause a circular dependency, in which case sage will fail to start.\n\nI don't know of a specific place offhand to read on this...\n\n> I guess you're saying that in the case of the two functions at hand, these are imported by sage when you boot it and so really are already loaded and so I might as well import them at the module level?\n\n\nCorrect, this will make the function (marginally) faster each time it's called.\n\nBest,\n\nTravis",
    "created_at": "2013-04-26T12:50:47Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177445",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>
Hey Robert,

Replying to [robharron](#comment%3A3):
> (1) Re the doctests: the first doctest (which was already there) is an example of the case len(S) == 0. The second doctest (which was already there) is when S contains only principal ideals and so the J you come across is necessarily already principal. Also, in the doctest I added, for the second ideal (namely (19, 1/13*a<sup>2</sup> - 45/13*a - 332/13)) the J you get is principal. So, your second point is already covered. Should I add comments to this effect in the docs?


No, this is likely clear to those in the field.

> (2) Re import: So, I have no real idea when to import in the module and when to import in the function. Is there somewhere to read about that.


It's a matter of when the module with the class/function is loaded into sage. If it's at the module level, it is imported when the module is imported (which is anytime any part of a module is imported [at startup, this is in an `all.py` file]). Thus there are two reasons not to import something at the module level:

1. It is a very large import that is not happening otherwise and is typically not needed until called. These large imports causes sage to take longer to startup (ex. numpy is not imported at startup).

2. It would cause a circular dependency, in which case sage will fail to start.

I don't know of a specific place offhand to read on this...

> I guess you're saying that in the case of the two functions at hand, these are imported by sage when you boot it and so really are already loaded and so I might as well import them at the module level?


Correct, this will make the function (marginally) faster each time it's called.

Best,

Travis



---

archive/issue_comments_177446.json:
```json
{
    "body": "<a id='comment:5'></a>\n> 2. It would cause a circular dependency, in which case sage will fail to start.\n\n\nThat would explain why I was having some trouble. I was able to load prod at the module level, but whenever I put Matrix in sage wouldn't start.",
    "created_at": "2013-04-26T12:56:24Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177446",
    "user": "https://github.com/rharron"
}
```

<a id='comment:5'></a>
> 2. It would cause a circular dependency, in which case sage will fail to start.


That would explain why I was having some trouble. I was able to load prod at the module level, but whenever I put Matrix in sage wouldn't start.



---

archive/issue_comments_177447.json:
```json
{
    "body": "<a id='comment:6'></a>\nRunning the long tests, I got a doctest failure in polynomial_quotient_ring.py (since it has a function _S_class_group_and_units that uses the function I changed to compute such things for quotients of polynomial rings over number fields by not necessarily irreducible polynomials):\n\n\n```\n**********************************************************************\nFile \"/Users/rharron/sages/sage-5.8/devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py\", line 984:\n    sage: S.S_class_group([])\nExpected:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]\nGot:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, 1/16*xbar^3 - 5/16*xbar^2 + 31/16*xbar - 139/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]\n**********************************************************************\nFile \"/Users/rharron/sages/sage-5.8/devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py\", line 990:\n    sage: S.S_class_group([K.ideal(a)])\nExpected:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 2, -1/8*xbar^2 - 15/8)]\nGot:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 2, -1/16*a*xbar^3 + (-13/16*a + 1/8)*xbar^2 - 23/16*a*xbar - 299/16*a + 31/8)]\n**********************************************************************\n```\n\nIt is understandable that the output has changed given that it uses a my new version of the function for number fields. However(!) when I open sage and run the code in the doctest, I get the expected output of the doctest, not the new one. Why is the doctest giving a different result than running the same commands in sage?",
    "created_at": "2013-04-26T13:22:44Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177447",
    "user": "https://github.com/rharron"
}
```

<a id='comment:6'></a>
Running the long tests, I got a doctest failure in polynomial_quotient_ring.py (since it has a function _S_class_group_and_units that uses the function I changed to compute such things for quotients of polynomial rings over number fields by not necessarily irreducible polynomials):


```
**********************************************************************
File "/Users/rharron/sages/sage-5.8/devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py", line 984:
    sage: S.S_class_group([])
Expected:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]
Got:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, 1/16*xbar^3 - 5/16*xbar^2 + 31/16*xbar - 139/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]
**********************************************************************
File "/Users/rharron/sages/sage-5.8/devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py", line 990:
    sage: S.S_class_group([K.ideal(a)])
Expected:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 2, -1/8*xbar^2 - 15/8)]
Got:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 2, -1/16*a*xbar^3 + (-13/16*a + 1/8)*xbar^2 - 23/16*a*xbar - 299/16*a + 31/8)]
**********************************************************************
```

It is understandable that the output has changed given that it uses a my new version of the function for number fields. However(!) when I open sage and run the code in the doctest, I get the expected output of the doctest, not the new one. Why is the doctest giving a different result than running the same commands in sage?



---

archive/issue_comments_177448.json:
```json
{
    "body": "<a id='comment:7'></a>\nUgh, my comment was just swallowed by trac.\n\nTry again, but quicker: I figured out the problems.\n\nLine 984: Both answers are correct. At some point, my code returns -pr whereas the old code returns pr. The discrepancy between the doctest illustrates the subtlety in this: if I open sage and enter all the commands in the doctest for S_class_group in order, then I get the same answer the doctest got; whereas just entering the commands from line 981 to 984 gives the answer the doctest expected. Anyway, I'm just going to update the doctest. (Is there an issue with the difference between 32 and 64 bit, I'm on a 64 bit machine).\n\nLine 990: The expected answer is incorrect. The ideal in question when squared is not principal (in fact, the line 984 example says that the order is 6 not 2). So, I'll update the doctest with the new answer.",
    "created_at": "2013-04-26T16:39:35Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177448",
    "user": "https://github.com/rharron"
}
```

<a id='comment:7'></a>
Ugh, my comment was just swallowed by trac.

Try again, but quicker: I figured out the problems.

Line 984: Both answers are correct. At some point, my code returns -pr whereas the old code returns pr. The discrepancy between the doctest illustrates the subtlety in this: if I open sage and enter all the commands in the doctest for S_class_group in order, then I get the same answer the doctest got; whereas just entering the commands from line 981 to 984 gives the answer the doctest expected. Anyway, I'm just going to update the doctest. (Is there an issue with the difference between 32 and 64 bit, I'm on a 64 bit machine).

Line 990: The expected answer is incorrect. The ideal in question when squared is not principal (in fact, the line 984 example says that the order is 6 not 2). So, I'll update the doctest with the new answer.



---

archive/attachments_019557.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_14489_fix_S_class_group_and_units.patch",
    "asset_url": "tarball://root/attachments/ticket14489/trac_14489_fix_S_class_group_and_units.patch",
    "created_at": "2013-04-26T16:58:52Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch",
    "user": "https://github.com/rharron"
}
```



---

archive/issue_comments_177449.json:
```json
{
    "body": "<a id='comment:8'></a>\nAttachment [trac_14489_fix_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch) by @rharron created at 2013-04-26 16:58:52\n\nAlright, new patch uploaded.",
    "created_at": "2013-04-26T16:58:52Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177449",
    "user": "https://github.com/rharron"
}
```

<a id='comment:8'></a>
Attachment [trac_14489_fix_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch) by @rharron created at 2013-04-26 16:58:52

Alright, new patch uploaded.



---

archive/issue_comments_177450.json:
```json
{
    "body": "<a id='comment:9'></a>\nThe patch applies cleanly against 5.9 and passes long tests.",
    "created_at": "2013-05-07T16:06:10Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177450",
    "user": "https://github.com/rharron"
}
```

<a id='comment:9'></a>
The patch applies cleanly against 5.9 and passes long tests.



---

archive/issue_comments_177451.json:
```json
{
    "body": "<a id='comment:10'></a>\nHey Robert, one more comment about the doc, I think it might be better to use a LaTeX (single-letter) variable for the gen/order since they are used so much in an exponential form. Otherwise I'd suggest `\\mathrm{}` (but `\\text{}` is fine too, as long as it's used everywhere). Thanks.",
    "created_at": "2013-05-11T21:16:21Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177451",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>
Hey Robert, one more comment about the doc, I think it might be better to use a LaTeX (single-letter) variable for the gen/order since they are used so much in an exponential form. Otherwise I'd suggest `\mathrm{}` (but `\text{}` is fine too, as long as it's used everywhere). Thanks.



---

archive/issue_comments_177452.json:
```json
{
    "body": "**Reviewer:** Peter Bruin",
    "created_at": "2013-06-13T12:28:45Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177452",
    "user": "https://github.com/pjbruin"
}
```

**Reviewer:** Peter Bruin



---

archive/issue_comments_177453.json:
```json
{
    "body": "<a id='comment:12'></a>\nI would tend to give this a positive review.  The patch fixes the problem, I believe the code is correct, all tests pass, and the documentation builds correctly.  I have a few comments, though:\n\n1. The changes in the docstrings are not very clearly written.  The sentences are very long and contain awkward constructions (\"a fractional ideal representative of the S-class group generator whose order (in the S-class group) is order\"; \"principal generator\").\n\n2. The new docstring of _S_class_group_and_units in number_field.py suggests that to obtain a principal ideal, gen<sup>order</sup> can be multiplied by any fractional ideal J whose class is in the subgroup of the class group generated by ideals in S.  However, the condition is more strict: J must be in the subgroup of the *ideal group* generated by ideals in S.\n\n3. In general (not because of this patch), the code for computing Selmer groups is a bit convoluted.  Conceptually, the computation of the generators for principal ideals of the form gen<sup>order</sup> belongs in selmer_group, not _S_class_group_and_units.  In my opinion it would be more correct to return, as S-class group generators, pairs (gen, order) instead of triples (gen, order, pr), and leave the computation of the principal ideal generators to selmer_group.\n\nI made a patch on top of this one to address these issues.  An additional reviewer would probably be needed, but I think it should not be too hard to review.  The two patches together have a net effect of simplifying the Selmer group code somewhat.\n\nAlternatively, I could file a new ticket for the additional changes, if the second patch would delay closing this ticket too long.\n\nAny opinions about which option would be better?",
    "created_at": "2013-06-14T11:24:30Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177453",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:12'></a>
I would tend to give this a positive review.  The patch fixes the problem, I believe the code is correct, all tests pass, and the documentation builds correctly.  I have a few comments, though:

1. The changes in the docstrings are not very clearly written.  The sentences are very long and contain awkward constructions ("a fractional ideal representative of the S-class group generator whose order (in the S-class group) is order"; "principal generator").

2. The new docstring of _S_class_group_and_units in number_field.py suggests that to obtain a principal ideal, gen<sup>order</sup> can be multiplied by any fractional ideal J whose class is in the subgroup of the class group generated by ideals in S.  However, the condition is more strict: J must be in the subgroup of the *ideal group* generated by ideals in S.

3. In general (not because of this patch), the code for computing Selmer groups is a bit convoluted.  Conceptually, the computation of the generators for principal ideals of the form gen<sup>order</sup> belongs in selmer_group, not _S_class_group_and_units.  In my opinion it would be more correct to return, as S-class group generators, pairs (gen, order) instead of triples (gen, order, pr), and leave the computation of the principal ideal generators to selmer_group.

I made a patch on top of this one to address these issues.  An additional reviewer would probably be needed, but I think it should not be too hard to review.  The two patches together have a net effect of simplifying the Selmer group code somewhat.

Alternatively, I could file a new ticket for the additional changes, if the second patch would delay closing this ticket too long.

Any opinions about which option would be better?



---

archive/issue_comments_177454.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -33,3 +33,5 @@\n The 121 in there is supposed to be such that (11, a-2)<sup>2</sup> = (121). But (11, a-2)<sup>2</sup> is *not* principal (in fact, (11, a-2) is a generator of the cyclic subgroup of order 6). It is just in the subgroup of the class group generated by the primes in S.\n \n I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).\n+\n+Apply: trac_14489_fix_S_class_group_and_units.patch\n``````\n",
    "created_at": "2013-06-14T11:24:30Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177454",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -33,3 +33,5 @@
 The 121 in there is supposed to be such that (11, a-2)<sup>2</sup> = (121). But (11, a-2)<sup>2</sup> is *not* principal (in fact, (11, a-2) is a generator of the cyclic subgroup of order 6). It is just in the subgroup of the class group generated by the primes in S.
 
 I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).
+
+Apply: trac_14489_fix_S_class_group_and_units.patch
``````




---

archive/attachments_019558.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_14489_simplify_S_class_group_and_units.patch",
    "asset_url": "tarball://root/attachments/ticket14489/trac_14489_simplify_S_class_group_and_units.patch",
    "created_at": "2013-06-14T11:25:41Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket14489/trac_14489_simplify_S_class_group_and_units.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_177455.json:
```json
{
    "body": "Attachment [trac_14489_simplify_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_simplify_S_class_group_and_units.patch) by @pjbruin created at 2013-06-14 11:25:41\n\nsuggested enhancements; apply after trac_14489_fix_S_class_group_and_units.patch",
    "created_at": "2013-06-14T11:25:41Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177455",
    "user": "https://github.com/pjbruin"
}
```

Attachment [trac_14489_simplify_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_simplify_S_class_group_and_units.patch) by @pjbruin created at 2013-06-14 11:25:41

suggested enhancements; apply after trac_14489_fix_S_class_group_and_units.patch



---

archive/issue_comments_177456.json:
```json
{
    "body": "<a id='comment:13'></a>\nThanks for reviewing this, Peter. In instances where sage is silently returning a mathematically incorrect answer, I try to create a minimal patch that fixes the problem to speed up the review process and get the fix in quickly. So, I'd suggest that since you think the patch I've written works properly, then you should accept this ticket and open a new ticket (which would be an enhancement ticket rather than a defect ticket) to clean up the code. My rationale is that the patch I wrote only changed a couple dozen lines of code and is fairly simple and yet has taken almost 2 months to be reviewed, so who knows how long this new patch would take to review? Makes sense?\n\n(Also, note that the long sentences in the docstrings and the term \"principal generator\" were already present before my patch. My philosophy of minimal changes made me leave them in.)",
    "created_at": "2013-06-14T15:32:45Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177456",
    "user": "https://github.com/rharron"
}
```

<a id='comment:13'></a>
Thanks for reviewing this, Peter. In instances where sage is silently returning a mathematically incorrect answer, I try to create a minimal patch that fixes the problem to speed up the review process and get the fix in quickly. So, I'd suggest that since you think the patch I've written works properly, then you should accept this ticket and open a new ticket (which would be an enhancement ticket rather than a defect ticket) to clean up the code. My rationale is that the patch I wrote only changed a couple dozen lines of code and is fairly simple and yet has taken almost 2 months to be reviewed, so who knows how long this new patch would take to review? Makes sense?

(Also, note that the long sentences in the docstrings and the term "principal generator" were already present before my patch. My philosophy of minimal changes made me leave them in.)



---

archive/issue_events_125980.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-06-14T15:53:35Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "needs review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125980"
}
```



---

archive/issue_events_125981.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-06-14T15:53:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125981"
}
```



---

archive/issue_comments_177457.json:
```json
{
    "body": "<a id='comment:14'></a>\nOK, let's do it like that.",
    "created_at": "2013-06-14T15:53:35Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177457",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:14'></a>
OK, let's do it like that.



---

archive/issue_comments_177458.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -34,4 +34,4 @@\n \n I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).\n \n-Apply: trac_14489_fix_S_class_group_and_units.patch\n+Apply: [attachment:trac_14489_fix_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch)\n``````\n",
    "created_at": "2013-06-18T09:08:45Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177458",
    "user": "https://github.com/jdemeyer"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -34,4 +34,4 @@
 
 I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).
 
-Apply: trac_14489_fix_S_class_group_and_units.patch
+Apply: [attachment:trac_14489_fix_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch)
``````




---

archive/issue_comments_177459.json:
```json
{
    "body": "<a id='comment:16'></a>\nOn 32-bit systems:\n\n```\nsage -t devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py\n**********************************************************************\nFile \"devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py\", line 987, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_class_group\nFailed example:\n    S.S_class_group([])\nExpected:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, 1/16*xbar^3 - 5/16*xbar^2 + 31/16*xbar - 139/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]\nGot:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]\n**********************************************************************\nFile \"devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1063, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.class_group\nFailed example:\n    S.class_group()\nExpected:\n    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, -1/2*xbar + 3/2)]\nGot:\n    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, 1/2*xbar - 3/2)]\n**********************************************************************\n```",
    "created_at": "2013-06-18T14:51:28Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177459",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:16'></a>
On 32-bit systems:

```
sage -t devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py
**********************************************************************
File "devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py", line 987, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_class_group
Failed example:
    S.S_class_group([])
Expected:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, 1/16*xbar^3 - 5/16*xbar^2 + 31/16*xbar - 139/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]
Got:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]
**********************************************************************
File "devel/sage/sage/rings/polynomial/polynomial_quotient_ring.py", line 1063, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.class_group
Failed example:
    S.class_group()
Expected:
    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, -1/2*xbar + 3/2)]
Got:
    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, 1/2*xbar - 3/2)]
**********************************************************************
```



---

archive/issue_events_125982.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-18T14:51:28Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125982"
}
```



---

archive/issue_events_125983.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-06-18T14:51:28Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125983"
}
```



---

archive/issue_comments_177460.json:
```json
{
    "body": "<a id='comment:17'></a>\nI don't have access to a 32-bit machine on which to test this.  The expected output and the actual output differ only in the third element of each triple, and they differ by a unit (which is -1 in the second case; I haven't checked in the first case).  This is consistent with the fact that this element is a somewhat arbitrary generator of a principal ideal.  This doctest failure should go away when applying both this patch and #14746, which eliminates this third element, among other things.\n\nPerhaps the quickest fix would be to mark the output of these doctests as random in this patch and revert to non-random in the patch of #14746?",
    "created_at": "2013-06-18T15:42:33Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177460",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:17'></a>
I don't have access to a 32-bit machine on which to test this.  The expected output and the actual output differ only in the third element of each triple, and they differ by a unit (which is -1 in the second case; I haven't checked in the first case).  This is consistent with the fact that this element is a somewhat arbitrary generator of a principal ideal.  This doctest failure should go away when applying both this patch and #14746, which eliminates this third element, among other things.

Perhaps the quickest fix would be to mark the output of these doctests as random in this patch and revert to non-random in the patch of #14746?



---

archive/issue_comments_177461.json:
```json
{
    "body": "<a id='comment:18'></a>\nOr better: instead of `# random`, use `# 32-bit` and # `64-bit` as explained in [http://sagemath.org/doc/developer/conventions.html#further-conventions-for-automated-testing-of-examples](http://sagemath.org/doc/developer/conventions.html#further-conventions-for-automated-testing-of-examples)",
    "created_at": "2013-06-18T16:53:27Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177461",
    "user": "https://github.com/jdemeyer"
}
```

<a id='comment:18'></a>
Or better: instead of `# random`, use `# 32-bit` and # `64-bit` as explained in [http://sagemath.org/doc/developer/conventions.html#further-conventions-for-automated-testing-of-examples](http://sagemath.org/doc/developer/conventions.html#further-conventions-for-automated-testing-of-examples)



---

archive/issue_comments_177462.json:
```json
{
    "body": "correct results for doctests on 32-bit machines",
    "created_at": "2013-07-05T18:41:39Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177462",
    "user": "https://github.com/pjbruin"
}
```

correct results for doctests on 32-bit machines



---

archive/issue_events_125984.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-07-05T18:45:49Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "needs work",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125984"
}
```



---

archive/issue_events_125985.json:
```json
{
    "actor": "https://github.com/pjbruin",
    "created_at": "2013-07-05T18:45:49Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125985"
}
```



---

archive/attachments_019559.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "trac_14489_doctests_32_64_bit.patch",
    "asset_url": "tarball://root/attachments/ticket14489/trac_14489_doctests_32_64_bit.patch",
    "created_at": "2013-07-05T18:45:49Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "attachment",
    "url": "https://github.com/sagemath/sage/files/ticket14489/trac_14489_doctests_32_64_bit.patch",
    "user": "https://github.com/pjbruin"
}
```



---

archive/issue_comments_177463.json:
```json
{
    "body": "<a id='comment:19'></a>\nAttachment [trac_14489_doctests_32_64_bit.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_doctests_32_64_bit.patch) by @pjbruin created at 2013-07-05 18:45:49\n\nHopefully the fact that I submitted a simple patch to fix the 32-bit/64-bit doctest issue does not preclude me from giving a positive review again.",
    "created_at": "2013-07-05T18:45:49Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177463",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:19'></a>
Attachment [trac_14489_doctests_32_64_bit.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_doctests_32_64_bit.patch) by @pjbruin created at 2013-07-05 18:45:49

Hopefully the fact that I submitted a simple patch to fix the 32-bit/64-bit doctest issue does not preclude me from giving a positive review again.



---

archive/issue_comments_177464.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -34,4 +34,5 @@\n \n I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).\n \n-Apply: [attachment:trac_14489_fix_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch)\n+Apply: [[attachment:trac_14489_doctests_32_64_bit.patch](https://github.com/sagemath/sage/files/ticket14489/189268b24bd9af6a1f04f12b40b72d80.patch](https://github.com/sagemath/sage/files/ticket14489/4a056cdce62d0060a70e0c0ccc7126f5.patch),)\n+\n``````\n",
    "created_at": "2013-07-05T18:45:49Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177464",
    "user": "https://github.com/pjbruin"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -34,4 +34,5 @@
 
 I'll shortly upload a patch that fixes this (partially suggested to me by Zev Klagsbrun).
 
-Apply: [attachment:trac_14489_fix_S_class_group_and_units.patch](https://github.com/sagemath/sage/files/ticket14489/trac_14489_fix_S_class_group_and_units.patch)
+Apply: [[attachment:trac_14489_doctests_32_64_bit.patch](https://github.com/sagemath/sage/files/ticket14489/189268b24bd9af6a1f04f12b40b72d80.patch](https://github.com/sagemath/sage/files/ticket14489/4a056cdce62d0060a70e0c0ccc7126f5.patch),)
+
``````




---

archive/issue_comments_177465.json:
```json
{
    "body": "<a id='comment:20'></a>\nFor patchbot: \n\nApply trac_14489_fix_S_class_group_and_units.patch, trac_14489_doctests_32_64_bit.patch",
    "created_at": "2013-07-15T21:22:07Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177465",
    "user": "https://github.com/pjbruin"
}
```

<a id='comment:20'></a>
For patchbot: 

Apply trac_14489_fix_S_class_group_and_units.patch, trac_14489_doctests_32_64_bit.patch



---

archive/issue_comments_177466.json:
```json
{
    "body": "<a id='comment:21'></a>\nTest failure in my 32-bit VM:\n\n```\n[vbraun@localhost hg]$ sage -t sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed\nRunning doctests with ID 2013-07-18-21-23-12-2dbc373e.\nDoctesting 1 file.\nsage -t sage/rings/polynomial/polynomial_quotient_ring.py\n**********************************************************************\nFile \"sage/rings/polynomial/polynomial_quotient_ring.py\", line 987, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_class_group\nFailed example:\n    S.S_class_group([])\nExpected:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, 1/16*xbar^3 - 5/16*xbar^2 + 31/16*xbar - 139/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]\nGot:\n    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]\n**********************************************************************\nFile \"sage/rings/polynomial/polynomial_quotient_ring.py\", line 1063, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.class_group\nFailed example:\n    S.class_group()\nExpected:\n    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, -1/2*xbar + 3/2)]\nGot:\n    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, 1/2*xbar - 3/2)]\n**********************************************************************\n2 items had failures:\n   1 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_class_group\n   1 of  25 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.class_group\n    [357 tests, 2 failures, 6.25 s]\n----------------------------------------------------------------------\nsage -t sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed\n----------------------------------------------------------------------\nTotal time for all tests: 6.4 seconds\n    cpu time: 5.8 seconds\n    cumulative wall time: 6.2 seconds\n```",
    "created_at": "2013-07-19T01:48:09Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177466",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:21'></a>
Test failure in my 32-bit VM:

```
[vbraun@localhost hg]$ sage -t sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed
Running doctests with ID 2013-07-18-21-23-12-2dbc373e.
Doctesting 1 file.
sage -t sage/rings/polynomial/polynomial_quotient_ring.py
**********************************************************************
File "sage/rings/polynomial/polynomial_quotient_ring.py", line 987, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_class_group
Failed example:
    S.S_class_group([])
Expected:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, 1/16*xbar^3 - 5/16*xbar^2 + 31/16*xbar - 139/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]
Got:
    [((1/4*xbar^2 + 31/4, (-1/8*a + 1/8)*xbar^2 - 31/8*a + 31/8, 1/16*xbar^3 + 1/16*xbar^2 + 31/16*xbar + 31/16, -1/16*a*xbar^3 + (1/16*a + 1/8)*xbar^2 - 31/16*a*xbar + 31/16*a + 31/8), 6, -1/16*xbar^3 + 1/16*xbar^2 - 31/16*xbar + 47/16), ((-1/4*xbar^2 - 23/4, (1/8*a - 1/8)*xbar^2 + 23/8*a - 23/8, -1/16*xbar^3 - 1/16*xbar^2 - 23/16*xbar - 23/16, 1/16*a*xbar^3 + (-1/16*a - 1/8)*xbar^2 + 23/16*a*xbar - 23/16*a - 23/8), 6, 1/16*xbar^3 + 3/16*xbar^2 + 23/16*xbar + 85/16), ((-5/4*xbar^2 - 115/4, 5/4*a*xbar^2 + 115/4*a, -5/16*xbar^3 + 5/16*xbar^2 - 115/16*xbar + 115/16, 1/16*a*xbar^3 + 7/16*a*xbar^2 + 23/16*a*xbar + 161/16*a), 2, 5/16*xbar^3 + 37/16*xbar^2 + 115/16*xbar + 867/16)]
**********************************************************************
File "sage/rings/polynomial/polynomial_quotient_ring.py", line 1063, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.class_group
Failed example:
    S.class_group()
Expected:
    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, -1/2*xbar + 3/2)]
Got:
    [((2, -a + 1, 1/2*xbar + 1/2, -1/2*a*xbar + 1/2*a + 1), 6, 1/2*xbar - 3/2)]
**********************************************************************
2 items had failures:
   1 of  23 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_class_group
   1 of  25 in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.class_group
    [357 tests, 2 failures, 6.25 s]
----------------------------------------------------------------------
sage -t sage/rings/polynomial/polynomial_quotient_ring.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 6.4 seconds
    cpu time: 5.8 seconds
    cumulative wall time: 6.2 seconds
```



---

archive/issue_comments_177467.json:
```json
{
    "body": "<a id='comment:22'></a>\nThe doctest failure seems to be fixed in the follow-up #14746, however that introduces another 32-bit failure.",
    "created_at": "2013-07-19T01:50:56Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177467",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:22'></a>
The doctest failure seems to be fixed in the follow-up #14746, however that introduces another 32-bit failure.



---

archive/issue_comments_177468.json:
```json
{
    "body": "**Dependencies:** #14746",
    "created_at": "2013-07-19T01:51:45Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177468",
    "user": "https://github.com/vbraun"
}
```

**Dependencies:** #14746



---

archive/issue_comments_177469.json:
```json
{
    "body": "<a id='comment:24'></a>\nSorry, just noticed that I was one off in my patch queue. Never mind, all tests pass.",
    "created_at": "2013-07-19T01:58:44Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177469",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:24'></a>
Sorry, just noticed that I was one off in my patch queue. Never mind, all tests pass.



---

archive/issue_comments_177470.json:
```json
{
    "body": "**Changing dependencies** from \"#14746\" to \"\".",
    "created_at": "2013-07-19T01:58:44Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177470",
    "user": "https://github.com/vbraun"
}
```

**Changing dependencies** from "#14746" to "".



---

archive/issue_events_125986.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-31T12:54:55Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "label": "positive review",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125986"
}
```



---

archive/issue_events_125987.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-07-31T12:54:55Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14489#event-125987"
}
```



---

archive/issue_comments_177471.json:
```json
{
    "body": "**Merged:** sage-5.11.rc0",
    "created_at": "2013-07-31T12:54:55Z",
    "issue": "https://github.com/sagemath/sage/issues/14489",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14489#issuecomment-177471",
    "user": "https://github.com/jdemeyer"
}
```

**Merged:** sage-5.11.rc0
