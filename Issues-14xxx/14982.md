# Issue 14982: When a parent is equipped with an embedding, consider coercions that don't go through the embedding

archive/issues_014745.json:
```json
{
    "body": "`Parent.discover_coerce_map_from` used to always give priority to coercions that start with applying an embedding over those provided by `_coerce_map_from_`. This leads to coercion failures such as the following:\n\n```\nsage: K.<a> = NumberField(x^2+1/2, embedding=CC(0,1))\nsage: L = NumberField(x^2+2, 'b', embedding=1/a)     \nsage: R = PolynomialRing(L, 'x')                     \nsage: R.coerce_map_from(R.base_ring())               \n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-8-fb89bb074d92> in <module>()\n----> 1 R.coerce_map_from(R.base_ring())\n...\nAttributeError: 'NoneType' object has no attribute 'domain'\n```\n\nThis patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change. See the individual commit messages for details.\n\nCC:  @robertwb simonking jpflori\n\nKeywords: embedding\n\nBranch/Commit: [a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6](https://github.com/sagemath/sagetrac-mirror/commit/a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6)\n\nReviewer: Vincent Delecroix\n\nAuthor: Marc Mezzarobba, Vincent Delecroix\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/14982\n\n",
    "closed_at": "2015-05-02T19:28:34Z",
    "created_at": "2013-07-30T08:25:05Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "When a parent is equipped with an embedding, consider coercions that don't go through the embedding",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14982",
    "user": "https://github.com/mezzarobba"
}
```
`Parent.discover_coerce_map_from` used to always give priority to coercions that start with applying an embedding over those provided by `_coerce_map_from_`. This leads to coercion failures such as the following:

```
sage: K.<a> = NumberField(x^2+1/2, embedding=CC(0,1))
sage: L = NumberField(x^2+2, 'b', embedding=1/a)     
sage: R = PolynomialRing(L, 'x')                     
sage: R.coerce_map_from(R.base_ring())               
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-8-fb89bb074d92> in <module>()
----> 1 R.coerce_map_from(R.base_ring())
...
AttributeError: 'NoneType' object has no attribute 'domain'
```

This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change. See the individual commit messages for details.

CC:  @robertwb simonking jpflori

Keywords: embedding

Branch/Commit: [a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6](https://github.com/sagemath/sagetrac-mirror/commit/a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6)

Reviewer: Vincent Delecroix

Author: Marc Mezzarobba, Vincent Delecroix

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/14982





---

archive/issue_comments_240565.json:
```json
{
    "body": "<a id='comment:1'></a>\nApparently, the problem is more general stems from the policy of `Parent.discover_coerce_map_from` of always giving priority to coercions that start with applying an embedding over those provided by `_coerce_map_from_`.\n\nIn the special case of this ticket, a workaround would be to revert part of a3c5958b8e6983a3ef8466d0bd0b6ce09fd32d41 so that the `BaseringInjection` gets registered as early as possible:\n\n```\n--- a/src/sage/rings/polynomial/polynomial_ring.py\n+++ b/src/sage/rings/polynomial/polynomial_ring.py\n@@ -283,9 +283,11 @@ class PolynomialRing_general(sage.algebras.algebra.Algebra):\n         # since we want to use PolynomialBaseringInjection.\n         sage.algebras.algebra.Algebra.__init__(self, base_ring, names=name, normalize=True, category=category)\n         self.__generator = self._polynomial_class(self, [0,1], is_gen=True)\n+        base_inject = PolynomialBaseringInjection(base_ring, self)\n+        self._unset_coercions_used()\n         self._populate_coercion_lists_(\n-                #coerce_list = [base_inject],\n-                #convert_list = [list, base_inject],\n+                coerce_list = [base_inject],\n+                convert_list = [list, base_inject],\n                 convert_method_name = '_polynomial_')\n \n \n@@ -552,8 +554,8 @@ class PolynomialRing_general(sage.algebras.algebra.Algebra):\n         \"\"\"\n         # In the first place, handle the base ring\n         base_ring = self.base_ring()\n-        if P is base_ring:\n-            return PolynomialBaseringInjection(base_ring, self)\n+        #if P is base_ring:\n+        #    return PolynomialBaseringInjection(base_ring, self)\n         # handle constants that canonically coerce into self.base_ring()\n         # first, if possible\n         try:\n```\n\n(I didn't check whether this breaks anything else.)\n\nBut the same issue potentially affects anything constructed over a base ring with `coerce_embedding`. At best, a suboptimal coercion is found:\n\n```\nsage: M = MatrixSpace(L, 2, 2)\nsage: M.coerce_map_from(L)\nComposite map:\n  From: Number Field in b with defining polynomial x^2 + 2\n  To:   Full MatrixSpace of 2 by 2 dense matrices over Number Field in b with defining polynomial x^2 + 2\n  Defn:   Generic morphism:\n          From: Number Field in b with defining polynomial x^2 + 2\n          To:   Number Field in a with defining polynomial x^2 + 1/2\n          Defn: b -> -2*a\n        then\n          Call morphism:\n          From: Number Field in a with defining polynomial x^2 + 1/2\n          To:   Full MatrixSpace of 2 by 2 dense matrices over Number Field in b with defining polynomial x^2 + 2\nsage: PowerSeriesRing(L, 'x').coerce_map_from(L)\nComposite map:\n  From: Number Field in b with defining polynomial x^2 + 2\n  To:   Power Series Ring in x over Number Field in b with defining polynomial x^2 + 2\n  Defn:   Generic morphism:\n          From: Number Field in b with defining polynomial x^2 + 2\n          To:   Number Field in a with defining polynomial x^2 + 1/2\n          Defn: b -> -2*a\n        then\n          Conversion map:\n          From: Number Field in a with defining polynomial x^2 + 1/2\n          To:   Power Series Ring in x over Number Field in b with defining polynomial x^2 + 2\n```\n\nand at worst the construction itself fails (well, I'm assuming it's the same issue as above, but I didn't check in detail):\n\n```\nsage: L.extension(x^3+x+1, 'c')\n---------------------------------------------------------------------------\nAttributeError                            Traceback (most recent call last)\n<ipython-input-28-b42564719919> in <module>()\n----> 1 L.extension(x**Integer(3)+x+Integer(1), 'c')\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.pyc in extension(self, poly, name, names, check, embedding)\n   4173             raise TypeError, \"the variable name must be specified.\"\n   4174         from sage.rings.number_field.number_field_rel import NumberField_relative\n-> 4175         return NumberField_relative(self, poly, str(name), check=check, embedding=embedding)\n   4176 \n   4177     def factor(self, n):\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/number_field/number_field_rel.pyc in __init__(self, base, polynomial, name, latex_name, names, check, embedding)\n    301 \n    302         v[0] = self._gen_relative()\n--> 303         v = [self(x) for x in v]\n    304         self.__gens = tuple(v)\n    305         self._zero_element = self(0)\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8078)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.convert_map_from (sage/structure/parent.c:15826)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_convert_map_from (sage/structure/parent.c:15991)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14932)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14985)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent_old.so in sage.structure.parent_old.Parent._coerce_map_from_ (sage/structure/parent_old.c:6658)()\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/number_field/number_field_rel.pyc in _coerce_map_from_(self, R)\n   1031         mor = self.base_field().coerce_map_from(R)\n   1032         if mor is not None:\n-> 1033             return self.coerce_map_from(self.base_field()) * mor\n   1034 \n   1035     def _rnfeltreltoabs(self, element, check=False):\n\n/home/marc/co/sage/local/lib/python2.7/site-packages/sage/categories/map.so in sage.categories.map.Map.__mul__ (sage/categories/map.c:4796)()\n\nAttributeError: 'NoneType' object has no attribute 'domain'\n```",
    "created_at": "2013-08-08T16:40:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240565",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:1'></a>
Apparently, the problem is more general stems from the policy of `Parent.discover_coerce_map_from` of always giving priority to coercions that start with applying an embedding over those provided by `_coerce_map_from_`.

In the special case of this ticket, a workaround would be to revert part of a3c5958b8e6983a3ef8466d0bd0b6ce09fd32d41 so that the `BaseringInjection` gets registered as early as possible:

```
--- a/src/sage/rings/polynomial/polynomial_ring.py
+++ b/src/sage/rings/polynomial/polynomial_ring.py
@@ -283,9 +283,11 @@ class PolynomialRing_general(sage.algebras.algebra.Algebra):
         # since we want to use PolynomialBaseringInjection.
         sage.algebras.algebra.Algebra.__init__(self, base_ring, names=name, normalize=True, category=category)
         self.__generator = self._polynomial_class(self, [0,1], is_gen=True)
+        base_inject = PolynomialBaseringInjection(base_ring, self)
+        self._unset_coercions_used()
         self._populate_coercion_lists_(
-                #coerce_list = [base_inject],
-                #convert_list = [list, base_inject],
+                coerce_list = [base_inject],
+                convert_list = [list, base_inject],
                 convert_method_name = '_polynomial_')
 
 
@@ -552,8 +554,8 @@ class PolynomialRing_general(sage.algebras.algebra.Algebra):
         """
         # In the first place, handle the base ring
         base_ring = self.base_ring()
-        if P is base_ring:
-            return PolynomialBaseringInjection(base_ring, self)
+        #if P is base_ring:
+        #    return PolynomialBaseringInjection(base_ring, self)
         # handle constants that canonically coerce into self.base_ring()
         # first, if possible
         try:
```

(I didn't check whether this breaks anything else.)

But the same issue potentially affects anything constructed over a base ring with `coerce_embedding`. At best, a suboptimal coercion is found:

```
sage: M = MatrixSpace(L, 2, 2)
sage: M.coerce_map_from(L)
Composite map:
  From: Number Field in b with defining polynomial x^2 + 2
  To:   Full MatrixSpace of 2 by 2 dense matrices over Number Field in b with defining polynomial x^2 + 2
  Defn:   Generic morphism:
          From: Number Field in b with defining polynomial x^2 + 2
          To:   Number Field in a with defining polynomial x^2 + 1/2
          Defn: b -> -2*a
        then
          Call morphism:
          From: Number Field in a with defining polynomial x^2 + 1/2
          To:   Full MatrixSpace of 2 by 2 dense matrices over Number Field in b with defining polynomial x^2 + 2
sage: PowerSeriesRing(L, 'x').coerce_map_from(L)
Composite map:
  From: Number Field in b with defining polynomial x^2 + 2
  To:   Power Series Ring in x over Number Field in b with defining polynomial x^2 + 2
  Defn:   Generic morphism:
          From: Number Field in b with defining polynomial x^2 + 2
          To:   Number Field in a with defining polynomial x^2 + 1/2
          Defn: b -> -2*a
        then
          Conversion map:
          From: Number Field in a with defining polynomial x^2 + 1/2
          To:   Power Series Ring in x over Number Field in b with defining polynomial x^2 + 2
```

and at worst the construction itself fails (well, I'm assuming it's the same issue as above, but I didn't check in detail):

```
sage: L.extension(x^3+x+1, 'c')
---------------------------------------------------------------------------
AttributeError                            Traceback (most recent call last)
<ipython-input-28-b42564719919> in <module>()
----> 1 L.extension(x**Integer(3)+x+Integer(1), 'c')

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/number_field/number_field.pyc in extension(self, poly, name, names, check, embedding)
   4173             raise TypeError, "the variable name must be specified."
   4174         from sage.rings.number_field.number_field_rel import NumberField_relative
-> 4175         return NumberField_relative(self, poly, str(name), check=check, embedding=embedding)
   4176 
   4177     def factor(self, n):

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/number_field/number_field_rel.pyc in __init__(self, base, polynomial, name, latex_name, names, check, embedding)
    301 
    302         v[0] = self._gen_relative()
--> 303         v = [self(x) for x in v]
    304         self.__gens = tuple(v)
    305         self._zero_element = self(0)

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.__call__ (sage/structure/parent.c:8078)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.convert_map_from (sage/structure/parent.c:15826)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_convert_map_from (sage/structure/parent.c:15991)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14932)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14985)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent_old.so in sage.structure.parent_old.Parent._coerce_map_from_ (sage/structure/parent_old.c:6658)()

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/number_field/number_field_rel.pyc in _coerce_map_from_(self, R)
   1031         mor = self.base_field().coerce_map_from(R)
   1032         if mor is not None:
-> 1033             return self.coerce_map_from(self.base_field()) * mor
   1034 
   1035     def _rnfeltreltoabs(self, element, check=False):

/home/marc/co/sage/local/lib/python2.7/site-packages/sage/categories/map.so in sage.categories.map.Map.__mul__ (sage/categories/map.c:4796)()

AttributeError: 'NoneType' object has no attribute 'domain'
```



---

archive/issue_events_049401.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "rename": {
        "from": "Coercion from base ring fails for some polynomial rings over number fields with embeddings",
        "to": "Coercion from rings with coerce_embedding into constructions over those rings is broken"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49401"
}
```



---

archive/issue_comments_240566.json:
```json
{
    "body": "Changing keywords from \"\" to \"embedding\".",
    "created_at": "2013-08-27T09:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240566",
    "user": "https://github.com/mezzarobba"
}
```

Changing keywords from "" to "embedding".



---

archive/issue_comments_240567.json:
```json
{
    "body": "Changing author from \"\" to \"Marc Mezzarobba\"",
    "created_at": "2013-08-27T09:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240567",
    "user": "https://github.com/mezzarobba"
}
```

Changing author from "" to "Marc Mezzarobba"



---

archive/issue_comments_240568.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-27T09:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240568",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_240569.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mmezzarobba/coerce_embeddings\"",
    "created_at": "2013-08-27T09:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240569",
    "user": "https://github.com/mezzarobba"
}
```

Changing branch from "" to "u/mmezzarobba/coerce_embeddings"



---

archive/issue_comments_240570.json:
```json
{
    "body": "<a id='comment:3'></a>\nHere's an attempt to fix the problem with a small change to the coercion discovery algorithm. It does break a few things, but I'd argue it only does so by exposing weaknesses in existing code. The other patches in the series fix (or, in one case, work around) these weaknesses.\n\nSee the commit messages for details.\n\nWhat do the experts say?",
    "created_at": "2013-08-27T09:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240570",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:3'></a>
Here's an attempt to fix the problem with a small change to the coercion discovery algorithm. It does break a few things, but I'd argue it only does so by exposing weaknesses in existing code. The other patches in the series fix (or, in one case, work around) these weaknesses.

See the commit messages for details.

What do the experts say?



---

archive/issue_events_049402.json:
```json
{
    "actor": "https://github.com/mezzarobba",
    "created_at": "2013-08-27T09:17:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49402"
}
```



---

archive/issue_comments_240571.json:
```json
{
    "body": "<a id='comment:5'></a>\nReplying to [mmezzarobba](#comment%3A3):\n> Here's an attempt to fix the problem with a small change to the coercion discovery algorithm. It does break a few things, but I'd argue it only does so by exposing weaknesses in existing code. The other patches in the series fix (or, in one case, work around) these weaknesses.\n> \n> See the commit messages for details.\n> \n> What do the experts say?\n\n\nI couldn't tell, unless you give me a pointer to the new workfow. What do I need to do, when not a patch but a brunch (aaahm, branch...) is given?",
    "created_at": "2013-08-27T11:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240571",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:5'></a>
Replying to [mmezzarobba](#comment%3A3):
> Here's an attempt to fix the problem with a small change to the coercion discovery algorithm. It does break a few things, but I'd argue it only does so by exposing weaknesses in existing code. The other patches in the series fix (or, in one case, work around) these weaknesses.
> 
> See the commit messages for details.
> 
> What do the experts say?


I couldn't tell, unless you give me a pointer to the new workfow. What do I need to do, when not a patch but a brunch (aaahm, branch...) is given?



---

archive/issue_comments_240572.json:
```json
{
    "body": "<a id='comment:6'></a>\nReplying to [SimonKing](#comment%3A5):\n> I couldn't tell, unless you give me a pointer to the new workfow. What do I need to do, when not a patch but a brunch (aaahm, branch...) is given?\n\n\nFor example, when I look at the \"commits\" link, I see that there are three commits, and only one of them seems to refer to this ticket. So, what do I do with the other commits, review-wise? I see that there is a discussion on sage-git on the question what exactly is to be reviewed. Would I only review the last commit (since its commit message refers to this ticket)? Would I review all three commits (but then I would potentially also review dependencies that are reviewed elsewhere!)?",
    "created_at": "2013-08-27T11:17:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240572",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:6'></a>
Replying to [SimonKing](#comment%3A5):
> I couldn't tell, unless you give me a pointer to the new workfow. What do I need to do, when not a patch but a brunch (aaahm, branch...) is given?


For example, when I look at the "commits" link, I see that there are three commits, and only one of them seems to refer to this ticket. So, what do I do with the other commits, review-wise? I see that there is a discussion on sage-git on the question what exactly is to be reviewed. Would I only review the last commit (since its commit message refers to this ticket)? Would I review all three commits (but then I would potentially also review dependencies that are reviewed elsewhere!)?



---

archive/issue_comments_240573.json:
```json
{
    "body": "<a id='comment:7'></a>\nReplying to [SimonKing](#comment%3A6):\n> Replying to [SimonKing](#comment%3A5):\n> > I couldn't tell, unless you give me a pointer to the new workfow. What do I need to do, when not a patch but a brunch (aaahm, branch...) is given?\n\n\nIf you already have a git-based installation of sage (i.e. you once did something like `git clone https://github.com/sagemath/sage.git && git checkout -b origin/build_system && make build`) and a remote that refers to the trac server, you just need to fetch and checkout the branch `u/mmezzarobba/coerce_embeddings` from trac and review the three commits on top of `build_system` just like you would if they were patches you just applied.\n\nOtherwise, hmm, I guess it is easier to set up a git-based installation than to try to do the review with Mercurial... See\nhttp://sagemath.github.io/git-developer-guide/\n(or ask!) in case you need more information on how to do that.\n\nIf the branch was based off an old version of sage, I guess you might also want to check that it merges cleanly, but here it is already a descendant of the last beta.\n\n> For example, when I look at the \"commits\" link, I see that there are three commits, and only one of them seems to refer to this ticket. So, what do I do with the other commits, review-wise? I see that there is a discussion on sage-git on the question what exactly is to be reviewed. Would I only review the last commit (since its commit message refers to this ticket)? Would I review all three commits (but then I would potentially also review dependencies that are reviewed elsewhere!)?\n\n\nAll three commits need review, and none of them is part of any other ticket. I am not sure if/where the ticket number should go in the commit logs (perhaps it would make more sense to put it in the message associated to the *merge* commit?). The last commit of the branch is also the one that fixes the issue the ticket is about, so I put it here, but I can rewrite history to add it to the two other commits if you want.",
    "created_at": "2013-08-27T11:39:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240573",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
Replying to [SimonKing](#comment%3A6):
> Replying to [SimonKing](#comment%3A5):
> > I couldn't tell, unless you give me a pointer to the new workfow. What do I need to do, when not a patch but a brunch (aaahm, branch...) is given?


If you already have a git-based installation of sage (i.e. you once did something like `git clone https://github.com/sagemath/sage.git && git checkout -b origin/build_system && make build`) and a remote that refers to the trac server, you just need to fetch and checkout the branch `u/mmezzarobba/coerce_embeddings` from trac and review the three commits on top of `build_system` just like you would if they were patches you just applied.

Otherwise, hmm, I guess it is easier to set up a git-based installation than to try to do the review with Mercurial... See
http://sagemath.github.io/git-developer-guide/
(or ask!) in case you need more information on how to do that.

If the branch was based off an old version of sage, I guess you might also want to check that it merges cleanly, but here it is already a descendant of the last beta.

> For example, when I look at the "commits" link, I see that there are three commits, and only one of them seems to refer to this ticket. So, what do I do with the other commits, review-wise? I see that there is a discussion on sage-git on the question what exactly is to be reviewed. Would I only review the last commit (since its commit message refers to this ticket)? Would I review all three commits (but then I would potentially also review dependencies that are reviewed elsewhere!)?


All three commits need review, and none of them is part of any other ticket. I am not sure if/where the ticket number should go in the commit logs (perhaps it would make more sense to put it in the message associated to the *merge* commit?). The last commit of the branch is also the one that fixes the issue the ticket is about, so I put it here, but I can rewrite history to add it to the two other commits if you want.



---

archive/issue_comments_240574.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [mmezzarobba](#comment%3A7):\n> If you already have a git-based installation of sage (i.e. you once did something like `git clone https://github.com/sagemath/sage.git && git checkout -b origin/build_system && make build`)\n\n\nI have. But at least on one of my machines I get several doctest errors with the latest git version.\n\n> and a remote that refers to the trac server, \n\n\nI did store my ssh keys on trac. But \"having a remote\" sounds like I need to inform git about the existence of the trac server.\n\n> you just need to fetch and checkout the branch `u/mmezzarobba/coerce_embeddings` from trac\n\n\nI hope the meaning and how-to of \"fetch\" and \"checkout\" will be clear to me from the git-developer-guide.\n\n> http://sagemath.github.io/git-developer-guide/\n> (or ask!) in case you need more information on how to do that.\n\n\nI saw this (or an old version) before, which made me register my ssh keys, for example.\n\n> All three commits need review, and none of them is part of any other ticket. I am not sure if/where the ticket number should go in the commit logs (perhaps it would make more sense to put it in the message associated to the *merge* commit?). The last commit of the branch is also the one that fixes the issue the ticket is about, so I put it here, but I can rewrite history to add it to the two other commits if you want.\n\n\nNo idea about this. From the discussion on sage-git, it seems to me that the git branches can be totally orthogonal to what one used to do with patches. A branch may span over different tickets, and it is totally unclear *from the commits themselves* which of them belong to a ticket and which of them belong to a dependency. That's bad for reviewing. In the old model, one would talk about a list of patches *attached to the ticket*, which makes it crystal clear what ticket a patch belongs to.",
    "created_at": "2013-08-27T11:54:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240574",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:8'></a>
Replying to [mmezzarobba](#comment%3A7):
> If you already have a git-based installation of sage (i.e. you once did something like `git clone https://github.com/sagemath/sage.git && git checkout -b origin/build_system && make build`)


I have. But at least on one of my machines I get several doctest errors with the latest git version.

> and a remote that refers to the trac server, 


I did store my ssh keys on trac. But "having a remote" sounds like I need to inform git about the existence of the trac server.

> you just need to fetch and checkout the branch `u/mmezzarobba/coerce_embeddings` from trac


I hope the meaning and how-to of "fetch" and "checkout" will be clear to me from the git-developer-guide.

> http://sagemath.github.io/git-developer-guide/
> (or ask!) in case you need more information on how to do that.


I saw this (or an old version) before, which made me register my ssh keys, for example.

> All three commits need review, and none of them is part of any other ticket. I am not sure if/where the ticket number should go in the commit logs (perhaps it would make more sense to put it in the message associated to the *merge* commit?). The last commit of the branch is also the one that fixes the issue the ticket is about, so I put it here, but I can rewrite history to add it to the two other commits if you want.


No idea about this. From the discussion on sage-git, it seems to me that the git branches can be totally orthogonal to what one used to do with patches. A branch may span over different tickets, and it is totally unclear *from the commits themselves* which of them belong to a ticket and which of them belong to a dependency. That's bad for reviewing. In the old model, one would talk about a list of patches *attached to the ticket*, which makes it crystal clear what ticket a patch belongs to.



---

archive/issue_comments_240575.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [mmezzarobba](#comment%3A7):\n> Otherwise, hmm, I guess it is easier to set up a git-based installation than to try to do the review with Mercurial... See\n> http://sagemath.github.io/git-developer-guide/\n> (or ask!) in case you need more information on how to do that.\n\n\nIt fails totally, it seems.\n\nNamely, in my git install of sage (which I kept up to date by `git pull` followed by make), I tried\n\n```\nsimon@linux-sqwp:~/SAGE/GIT/sage> ./sage -dev create-ticket\nsage-run received unknown option: -dev \nusage: sage [options]\nTry 'sage -h' for more information.\n```\n`sage -dev create-ticket` is about the first example of using the development scripts in the development guide!",
    "created_at": "2013-08-27T12:02:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240575",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:9'></a>
Replying to [mmezzarobba](#comment%3A7):
> Otherwise, hmm, I guess it is easier to set up a git-based installation than to try to do the review with Mercurial... See
> http://sagemath.github.io/git-developer-guide/
> (or ask!) in case you need more information on how to do that.


It fails totally, it seems.

Namely, in my git install of sage (which I kept up to date by `git pull` followed by make), I tried

```
simon@linux-sqwp:~/SAGE/GIT/sage> ./sage -dev create-ticket
sage-run received unknown option: -dev 
usage: sage [options]
Try 'sage -h' for more information.
```
`sage -dev create-ticket` is about the first example of using the development scripts in the development guide!



---

archive/issue_comments_240576.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [SimonKing](#comment%3A9):\n> It fails totally, it seems.\n\n\nSorry, I always use git directly and didn't realize that de developer guide presented the custom devel scripts first.",
    "created_at": "2013-08-27T16:42:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240576",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:10'></a>
Replying to [SimonKing](#comment%3A9):
> It fails totally, it seems.


Sorry, I always use git directly and didn't realize that de developer guide presented the custom devel scripts first.



---

archive/issue_comments_240577.json:
```json
{
    "body": "<a id='comment:11'></a>\n(It looks like you got most of this sorted out, based on you posts on sage-git. I'm replying anyway just in case; please feel free to ask for more detail!)\n\nReplying to [SimonKing](#comment%3A8):\n> Replying to [mmezzarobba](#comment%3A7):\n> > If you already have a git-based installation of sage (i.e. you once did something like `git clone https://github.com/sagemath/sage.git && git checkout -b origin/build_system && make build`)\n\n> \n> I have. But at least on one of my machines I get several doctest errors with the latest git version.\n\n\nYes. These are rather minor issues that are handled elsewhere.\n\n> > and a remote that refers to the trac server, \n\n> \n> I did store my ssh keys on trac. But \"having a remote\" sounds like I need to inform git about the existence of the trac server.\n\n\nYes:\n\n```\ngit remote add trac ssh://git@trac.sagemath.org:2222/sage.git\n```\n\n(With this setup, `git fetch trac` will automatically download copies of all branches available on the trac server. This will likely mean hundreds of branches when everyone switches to git. They don't live in the same namespace as your local branches and don't pollute the output of most commands. But if you don't like that behaviour, you can use `-t` to limit the subset of branches to track.)\n\n> > you just need to fetch and checkout the branch `u/mmezzarobba/coerce_embeddings` from trac\n\n> \n> I hope the meaning and how-to of \"fetch\" and \"checkout\" will be clear to me from the git-developer-guide.\n\n\n* fetch = synchronize your local repository's view of the branches on trac (!= your local branches) with their remote state:\n\n```\ngit fetch trac\n```\n\n* checkout = get the contents of a given revision in the form of actual files in your working directory:\n\n```\ngit checkout -b my_local_review_branch -t trac/u/mmezzarobba/coerce_embeddings\n```\n\n* The last command also sets up a local branch for you to work on (e.g., to prepare a reviewer patch). If you only want to have a look at some remote branch, you can omit the `-b` and `-t` options. git will issue a scary warning about detached heads. That \"detached head state\" is when you don't have anywhere to commit your changes if you make any.\n\nIf you want to prepare a reviewer patch, you will need to:\n\n* Make your changes.\n\n* Commit them to your local review branch (`git commit -a` to commit everything).\n\n* (Repeat if there are several unrelated changes.)\n\n* Once you are happy with your local changes, push them somewhere on trac:\n\n```\ngit push trac my_local_review_branch:trac/u/SimonKing/coerce_embeddings\n```\n\n* Tell me about the new branch you created on trac, or just put its name in the Branch: field.\n\n> No idea about this. From the discussion on sage-git, it seems to me that the git branches can be totally orthogonal to what one used to do with patches. A branch may span over different tickets,\n\n\nA git branch is just a pointer to a commit (and thus implicitly to everything that precedes it history-wise). So in some sense it every branch spans the whole history of sage, but otherwise a branch cannot really span several tickets.\n\n(There are several other kinds of \"pointers to commits\" in git. Branches are pointers to commit that move up  automatically when new commits are added \"on\" them.)\n\n> and it is totally unclear *from the commits themselves* which of them belong to a ticket and which of them belong to a dependency. That's bad for reviewing. In the old model, one would talk about a list of patches *attached to the ticket*, which makes it crystal clear what ticket a patch belongs to.\n\n\nI agree, and that's why I started this thread...",
    "created_at": "2013-08-27T17:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240577",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:11'></a>
(It looks like you got most of this sorted out, based on you posts on sage-git. I'm replying anyway just in case; please feel free to ask for more detail!)

Replying to [SimonKing](#comment%3A8):
> Replying to [mmezzarobba](#comment%3A7):
> > If you already have a git-based installation of sage (i.e. you once did something like `git clone https://github.com/sagemath/sage.git && git checkout -b origin/build_system && make build`)

> 
> I have. But at least on one of my machines I get several doctest errors with the latest git version.


Yes. These are rather minor issues that are handled elsewhere.

> > and a remote that refers to the trac server, 

> 
> I did store my ssh keys on trac. But "having a remote" sounds like I need to inform git about the existence of the trac server.


Yes:

```
git remote add trac ssh://git@trac.sagemath.org:2222/sage.git
```

(With this setup, `git fetch trac` will automatically download copies of all branches available on the trac server. This will likely mean hundreds of branches when everyone switches to git. They don't live in the same namespace as your local branches and don't pollute the output of most commands. But if you don't like that behaviour, you can use `-t` to limit the subset of branches to track.)

> > you just need to fetch and checkout the branch `u/mmezzarobba/coerce_embeddings` from trac

> 
> I hope the meaning and how-to of "fetch" and "checkout" will be clear to me from the git-developer-guide.


* fetch = synchronize your local repository's view of the branches on trac (!= your local branches) with their remote state:

```
git fetch trac
```

* checkout = get the contents of a given revision in the form of actual files in your working directory:

```
git checkout -b my_local_review_branch -t trac/u/mmezzarobba/coerce_embeddings
```

* The last command also sets up a local branch for you to work on (e.g., to prepare a reviewer patch). If you only want to have a look at some remote branch, you can omit the `-b` and `-t` options. git will issue a scary warning about detached heads. That "detached head state" is when you don't have anywhere to commit your changes if you make any.

If you want to prepare a reviewer patch, you will need to:

* Make your changes.

* Commit them to your local review branch (`git commit -a` to commit everything).

* (Repeat if there are several unrelated changes.)

* Once you are happy with your local changes, push them somewhere on trac:

```
git push trac my_local_review_branch:trac/u/SimonKing/coerce_embeddings
```

* Tell me about the new branch you created on trac, or just put its name in the Branch: field.

> No idea about this. From the discussion on sage-git, it seems to me that the git branches can be totally orthogonal to what one used to do with patches. A branch may span over different tickets,


A git branch is just a pointer to a commit (and thus implicitly to everything that precedes it history-wise). So in some sense it every branch spans the whole history of sage, but otherwise a branch cannot really span several tickets.

(There are several other kinds of "pointers to commits" in git. Branches are pointers to commit that move up  automatically when new commits are added "on" them.)

> and it is totally unclear *from the commits themselves* which of them belong to a ticket and which of them belong to a dependency. That's bad for reviewing. In the old model, one would talk about a list of patches *attached to the ticket*, which makes it crystal clear what ticket a patch belongs to.


I agree, and that's why I started this thread...



---

archive/issue_comments_240578.json:
```json
{
    "body": "Changing commit from \"\" to \"0869e9aae81cc0174ca7151a724cc30489bb4bac\"",
    "created_at": "2013-10-30T10:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240578",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

Changing commit from "" to "0869e9aae81cc0174ca7151a724cc30489bb4bac"



---

archive/issue_comments_240579.json:
```json
{
    "body": "<a id='comment:12'></a>\nNew commits:\n|       |                                                                                  |\n|-------|----------------------------------------------------------------------------------|\n|0869e9a|14982: consider coercions of parents with embeddings that do not use the embedding|\n|cd982ae|Make coercions that go through lazy fields more robust|\n|110dd48|Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic|",
    "created_at": "2013-10-30T10:52:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240579",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:12'></a>
New commits:
|       |                                                                                  |
|-------|----------------------------------------------------------------------------------|
|0869e9a|14982: consider coercions of parents with embeddings that do not use the embedding|
|cd982ae|Make coercions that go through lazy fields more robust|
|110dd48|Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic|



---

archive/issue_comments_240580.json:
```json
{
    "body": "<a id='comment:13'></a>\nIs this branch compatible with #15303?",
    "created_at": "2013-10-30T11:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240580",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:13'></a>
Is this branch compatible with #15303?



---

archive/issue_comments_240581.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [SimonKing](#comment%3A13):\n> Is this branch compatible with #15303?\n\n\nThe issues do look related, but otherwise I have no idea: I stopped working on it weeks before the discussion on #15303 started, and I haven't have time to read that thread yet. I hope to be able to work on this some time next week.",
    "created_at": "2013-10-30T15:17:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240581",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:14'></a>
Replying to [SimonKing](#comment%3A13):
> Is this branch compatible with #15303?


The issues do look related, but otherwise I have no idea: I stopped working on it weeks before the discussion on #15303 started, and I haven't have time to read that thread yet. I hope to be able to work on this some time next week.



---

archive/issue_comments_240582.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [mmezzarobba](#comment%3A14):\n> Replying to [SimonKing](#comment%3A13):\n> > Is this branch compatible with #15303?\n\n> \n> The issues do look related, but otherwise I have no idea: I stopped working on it weeks before the discussion on #15303 started, and I haven't have time to read that thread yet. I hope to be able to work on this some time next week.\n\n\nI have tested that #15303 does not fix the bug from your ticket description. What I meant was: Are there merge conflicts?",
    "created_at": "2013-10-30T15:39:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240582",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:15'></a>
Replying to [mmezzarobba](#comment%3A14):
> Replying to [SimonKing](#comment%3A13):
> > Is this branch compatible with #15303?

> 
> The issues do look related, but otherwise I have no idea: I stopped working on it weeks before the discussion on #15303 started, and I haven't have time to read that thread yet. I hope to be able to work on this some time next week.


I have tested that #15303 does not fix the bug from your ticket description. What I meant was: Are there merge conflicts?



---

archive/issue_comments_240583.json:
```json
{
    "body": "Changing commit from \"0869e9aae81cc0174ca7151a724cc30489bb4bac\" to \"4cf3ca5d71b4a701e5ac19e413fc4b1ab50eb851\"",
    "created_at": "2013-11-27T22:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240583",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0869e9aae81cc0174ca7151a724cc30489bb4bac" to "4cf3ca5d71b4a701e5ac19e413fc4b1ab50eb851"



---

archive/issue_comments_240584.json:
```json
{
    "body": "<a id='comment:16'></a>\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n|                                                                                                         |                                                      |\n|---------------------------------------------------------------------------------------------------------|------------------------------------------------------|\n|[4cf3ca5](https://github.com/sagemath/sagetrac-mirror/commit/4cf3ca5)|Fix gross bug in Map.domains(), add missing docstrings|\n|[17832a0](https://github.com/sagemath/sagetrac-mirror/commit/17832a0)|Merge coercion transitivity fixes (#15303)|\n|[528a035](https://github.com/sagemath/sagetrac-mirror/commit/528a035)|Merge branch 'ticket/13394' into ticket/15303, to make weak caches safer|\n|[851cc95](https://github.com/sagemath/sagetrac-mirror/commit/851cc95)|Avoid some pointer casts in WeakValueDict callbacks|\n|[246518f](https://github.com/sagemath/sagetrac-mirror/commit/246518f)|Use <dict>'s internals in WeakValueDictionary and do not reinvent the bucket.|\n|[fab0ed4](https://github.com/sagemath/sagetrac-mirror/commit/fab0ed4)|Use WeakValueDict's iteration guard more consequently|\n|[e4adaeb](https://github.com/sagemath/sagetrac-mirror/commit/e4adaeb)|Implement copy and deepcopy for WeakValueDictionary|\n|[70a7b8a](https://github.com/sagemath/sagetrac-mirror/commit/70a7b8a)|Guard WeakValueDictionary against deletions during iteration|\n|[c3dba98](https://github.com/sagemath/sagetrac-mirror/commit/c3dba98)|Replace weakref.WeakValueDictionary by sage.misc.weak_dict.WeakValueDictionary|\n|[17b0236](https://github.com/sagemath/sagetrac-mirror/commit/17b0236)|Documentation for WeakValueDictionary|",
    "created_at": "2013-11-27T22:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240584",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:16'></a>
Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
|                                                                                                         |                                                      |
|---------------------------------------------------------------------------------------------------------|------------------------------------------------------|
|[4cf3ca5](https://github.com/sagemath/sagetrac-mirror/commit/4cf3ca5)|Fix gross bug in Map.domains(), add missing docstrings|
|[17832a0](https://github.com/sagemath/sagetrac-mirror/commit/17832a0)|Merge coercion transitivity fixes (#15303)|
|[528a035](https://github.com/sagemath/sagetrac-mirror/commit/528a035)|Merge branch 'ticket/13394' into ticket/15303, to make weak caches safer|
|[851cc95](https://github.com/sagemath/sagetrac-mirror/commit/851cc95)|Avoid some pointer casts in WeakValueDict callbacks|
|[246518f](https://github.com/sagemath/sagetrac-mirror/commit/246518f)|Use <dict>'s internals in WeakValueDictionary and do not reinvent the bucket.|
|[fab0ed4](https://github.com/sagemath/sagetrac-mirror/commit/fab0ed4)|Use WeakValueDict's iteration guard more consequently|
|[e4adaeb](https://github.com/sagemath/sagetrac-mirror/commit/e4adaeb)|Implement copy and deepcopy for WeakValueDictionary|
|[70a7b8a](https://github.com/sagemath/sagetrac-mirror/commit/70a7b8a)|Guard WeakValueDictionary against deletions during iteration|
|[c3dba98](https://github.com/sagemath/sagetrac-mirror/commit/c3dba98)|Replace weakref.WeakValueDictionary by sage.misc.weak_dict.WeakValueDictionary|
|[17b0236](https://github.com/sagemath/sagetrac-mirror/commit/17b0236)|Documentation for WeakValueDictionary|



---

archive/issue_comments_240585.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [SimonKing](#comment%3A15):\n> I have tested that #15303 does not fix the bug from your ticket description. What I meant was: Are there merge conflicts?\n\n\nSorry for the late reply. There were a few conflicts indeed. I did the merge, and the tests still pass, except that I'm getting a timeout with `sage/rings/number_field/number_field.py` and random segfaults with some other files.\n\nFor instance:\n\n```\n$ sage -t -a\n...\n----------------------------------------------------------------------\nsage -t src/sage/rings/number_field/number_field.py  # Time out\nsage -t src/sage/rings/number_field/number_field_element_quadratic.pyx  # Killed due to segmentation fault\nsage -t src/sage/groups/abelian_gps/values.py  # Killed due to segmentation fault\n----------------------------------------------------------------------\n```\n\nbut then:\n\n```\n$ sage -t src/sage/rings/number_field/number_field_element_quadratic.pyx\nRunning doctests with ID 2013-11-27-23-09-47-2b207575.\nDoctesting 1 file.\nsage -t src/sage/rings/number_field/number_field_element_quadratic.pyx\n    [420 tests, 7.97 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```\n\n\n```\n$ sage -t src/sage/groups/abelian_gps/values.py\nRunning doctests with ID 2013-11-27-23-10-03-7a10efd7.\nDoctesting 1 file.\nsage -t src/sage/groups/abelian_gps/values.py\n    [81 tests, 0.11 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\n```",
    "created_at": "2013-11-27T22:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240585",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:17'></a>
Replying to [SimonKing](#comment%3A15):
> I have tested that #15303 does not fix the bug from your ticket description. What I meant was: Are there merge conflicts?


Sorry for the late reply. There were a few conflicts indeed. I did the merge, and the tests still pass, except that I'm getting a timeout with `sage/rings/number_field/number_field.py` and random segfaults with some other files.

For instance:

```
$ sage -t -a
...
----------------------------------------------------------------------
sage -t src/sage/rings/number_field/number_field.py  # Time out
sage -t src/sage/rings/number_field/number_field_element_quadratic.pyx  # Killed due to segmentation fault
sage -t src/sage/groups/abelian_gps/values.py  # Killed due to segmentation fault
----------------------------------------------------------------------
```

but then:

```
$ sage -t src/sage/rings/number_field/number_field_element_quadratic.pyx
Running doctests with ID 2013-11-27-23-09-47-2b207575.
Doctesting 1 file.
sage -t src/sage/rings/number_field/number_field_element_quadratic.pyx
    [420 tests, 7.97 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```


```
$ sage -t src/sage/groups/abelian_gps/values.py
Running doctests with ID 2013-11-27-23-10-03-7a10efd7.
Doctesting 1 file.
sage -t src/sage/groups/abelian_gps/values.py
    [81 tests, 0.11 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
```



---

archive/issue_comments_240586.json:
```json
{
    "body": "<a id='comment:18'></a>\nReplying to [mmezzarobba](#comment%3A17):\n> random segfaults with some other files.\n\n\nIt looks like the crashes happen in `__pyx_pf_4sage_10categories_3map_3Map_6domain___get__`, called from sage/structure/parent.pyx:2536...",
    "created_at": "2013-11-28T08:16:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240586",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:18'></a>
Replying to [mmezzarobba](#comment%3A17):
> random segfaults with some other files.


It looks like the crashes happen in `__pyx_pf_4sage_10categories_3map_3Map_6domain___get__`, called from sage/structure/parent.pyx:2536...



---

archive/issue_comments_240587.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [mmezzarobba](#comment%3A18):\n> Replying to [mmezzarobba](#comment%3A17):\n> > random segfaults with some other files.\n\n> \n> It looks like the crashes happen in `__pyx_pf_4sage_10categories_3map_3Map_6domain___get__`, called from sage/structure/parent.pyx:2536...\n\n\nI tried again with a clean build, and I am unable to reproduce the crashes. I guess it was only a compilation problem...",
    "created_at": "2013-11-28T15:32:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240587",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:19'></a>
Replying to [mmezzarobba](#comment%3A18):
> Replying to [mmezzarobba](#comment%3A17):
> > random segfaults with some other files.

> 
> It looks like the crashes happen in `__pyx_pf_4sage_10categories_3map_3Map_6domain___get__`, called from sage/structure/parent.pyx:2536...


I tried again with a clean build, and I am unable to reproduce the crashes. I guess it was only a compilation problem...



---

archive/issue_events_049403.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.0",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49403"
}
```



---

archive/issue_events_049404.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2013-12-17T18:39:51Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49404"
}
```



---

archive/issue_comments_240588.json:
```json
{
    "body": "<a id='comment:21'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                         |                                                  |\n|---------------------------------------------------------------------------------------------------------|--------------------------------------------------|\n|[7e8d4aa](https://github.com/sagemath/sagetrac-mirror/commit/7e8d4aa)|`Merge coercion transitivity fixes (#15303) again`|\n|[858cd39](https://github.com/sagemath/sagetrac-mirror/commit/858cd39)|`typo`|\n|[12e8055](https://github.com/sagemath/sagetrac-mirror/commit/12e8055)|`Merge branch 'ticket/14711' into ticket/15303`|\n|[ee30c20](https://github.com/sagemath/sagetrac-mirror/commit/ee30c20)|`Address the \"check\" keyword of scheme morphisms by name, not position`|\n|[d68c5df](https://github.com/sagemath/sagetrac-mirror/commit/d68c5df)|`Minor fixes, that became needed since #14711 was not merged quickly enough`|\n|[c42b539](https://github.com/sagemath/sagetrac-mirror/commit/c42b539)|`Merge branch 'master' into ticket/14711`|\n|[2712c53](https://github.com/sagemath/sagetrac-mirror/commit/2712c53)|`Merge 'trac/master' into ticket/15303`|\n|[23f18f2](https://github.com/sagemath/sagetrac-mirror/commit/23f18f2)|`Merge branch 'master' into ticket/14711`|",
    "created_at": "2013-12-18T17:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240588",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:21'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                         |                                                  |
|---------------------------------------------------------------------------------------------------------|--------------------------------------------------|
|[7e8d4aa](https://github.com/sagemath/sagetrac-mirror/commit/7e8d4aa)|`Merge coercion transitivity fixes (#15303) again`|
|[858cd39](https://github.com/sagemath/sagetrac-mirror/commit/858cd39)|`typo`|
|[12e8055](https://github.com/sagemath/sagetrac-mirror/commit/12e8055)|`Merge branch 'ticket/14711' into ticket/15303`|
|[ee30c20](https://github.com/sagemath/sagetrac-mirror/commit/ee30c20)|`Address the "check" keyword of scheme morphisms by name, not position`|
|[d68c5df](https://github.com/sagemath/sagetrac-mirror/commit/d68c5df)|`Minor fixes, that became needed since #14711 was not merged quickly enough`|
|[c42b539](https://github.com/sagemath/sagetrac-mirror/commit/c42b539)|`Merge branch 'master' into ticket/14711`|
|[2712c53](https://github.com/sagemath/sagetrac-mirror/commit/2712c53)|`Merge 'trac/master' into ticket/15303`|
|[23f18f2](https://github.com/sagemath/sagetrac-mirror/commit/23f18f2)|`Merge branch 'master' into ticket/14711`|



---

archive/issue_comments_240589.json:
```json
{
    "body": "Changing commit from \"4cf3ca5d71b4a701e5ac19e413fc4b1ab50eb851\" to \"7e8d4aa5ad04fa2b6536508efefcf69776d6d160\"",
    "created_at": "2013-12-18T17:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240589",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4cf3ca5d71b4a701e5ac19e413fc4b1ab50eb851" to "7e8d4aa5ad04fa2b6536508efefcf69776d6d160"



---

archive/issue_comments_240590.json:
```json
{
    "body": "<a id='comment:22'></a>\n(git-)Rebased on top of 6.1.rc0, removed dependency on #15303.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|\n|[0faffde](https://github.com/sagemath/sagetrac-mirror/commit/0faffde6f7c72bb7a3f3f34b17bae97ef4039c59)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[bd4f772](https://github.com/sagemath/sagetrac-mirror/commit/bd4f772d2296b9071895eece52172318b96de677)|`Make coercions that go through lazy fields more robust`|\n|[2fcc473](https://github.com/sagemath/sagetrac-mirror/commit/2fcc47300d619cd8c0c96ab57686096993e64e5d)|`14982: consider coercions of parents with embeddings that do not use the embedding`|",
    "created_at": "2014-01-27T16:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240590",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:22'></a>
(git-)Rebased on top of 6.1.rc0, removed dependency on #15303.

---
New commits:
|                                                                                                                                          |                                                                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
|[0faffde](https://github.com/sagemath/sagetrac-mirror/commit/0faffde6f7c72bb7a3f3f34b17bae97ef4039c59)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[bd4f772](https://github.com/sagemath/sagetrac-mirror/commit/bd4f772d2296b9071895eece52172318b96de677)|`Make coercions that go through lazy fields more robust`|
|[2fcc473](https://github.com/sagemath/sagetrac-mirror/commit/2fcc47300d619cd8c0c96ab57686096993e64e5d)|`14982: consider coercions of parents with embeddings that do not use the embedding`|



---

archive/issue_comments_240591.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,4 @@\n+`Parent.discover_coerce_map_from` used to always give priority to coercions that start with applying an embedding over those provided by `_coerce_map_from_`. This leads to coercion failures such as the following:\n \n ```\n sage: K.<a> = NumberField(x^2+1/2, embedding=CC(0,1))\n@@ -8,29 +9,8 @@\n AttributeError                            Traceback (most recent call last)\n <ipython-input-8-fb89bb074d92> in <module>()\n ----> 1 R.coerce_map_from(R.base_ring())\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14807)()\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14932)()\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14985)()\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent_old.so in sage.structure.parent_old.Parent._coerce_map_from_ (sage/structure/parent_old.c:6658)()\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring.pyc in _coerce_map_from_(self, P)\n-    560             connecting = base_ring.coerce_map_from(P)\n-    561             if connecting is not None:\n---> 562                 return self.coerce_map_from(base_ring) * connecting\n-    563         except TypeError:\n-    564             pass\n-\n-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/categories/map.so in sage.categories.map.Map.__mul__ (sage/categories/map.c:4796)()\n-\n+...\n AttributeError: 'NoneType' object has no attribute 'domain'\n ```\n \n-Note that apparently P is K (not L) in the call to `_coerce_map_from_` at the end of the backtrace.\n+This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change.\n``````\n",
    "created_at": "2014-01-27T16:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240591",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,4 @@
+`Parent.discover_coerce_map_from` used to always give priority to coercions that start with applying an embedding over those provided by `_coerce_map_from_`. This leads to coercion failures such as the following:
 
 ```
 sage: K.<a> = NumberField(x^2+1/2, embedding=CC(0,1))
@@ -8,29 +9,8 @@
 AttributeError                            Traceback (most recent call last)
 <ipython-input-8-fb89bb074d92> in <module>()
 ----> 1 R.coerce_map_from(R.base_ring())
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14807)()
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14932)()
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.coerce_map_from (sage/structure/parent.c:14563)()
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent.so in sage.structure.parent.Parent.discover_coerce_map_from (sage/structure/parent.c:14985)()
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/structure/parent_old.so in sage.structure.parent_old.Parent._coerce_map_from_ (sage/structure/parent_old.c:6658)()
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/rings/polynomial/polynomial_ring.pyc in _coerce_map_from_(self, P)
-    560             connecting = base_ring.coerce_map_from(P)
-    561             if connecting is not None:
---> 562                 return self.coerce_map_from(base_ring) * connecting
-    563         except TypeError:
-    564             pass
-
-/home/marc/co/sage/local/lib/python2.7/site-packages/sage/categories/map.so in sage.categories.map.Map.__mul__ (sage/categories/map.c:4796)()
-
+...
 AttributeError: 'NoneType' object has no attribute 'domain'
 ```
 
-Note that apparently P is K (not L) in the call to `_coerce_map_from_` at the end of the backtrace.
+This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change.
``````




---

archive/issue_comments_240592.json:
```json
{
    "body": "Changing branch from \"u/mmezzarobba/coerce_embeddings\" to \"u/mmezzarobba/14982-coerce_embeddings\"",
    "created_at": "2014-01-27T16:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240592",
    "user": "https://github.com/mezzarobba"
}
```

Changing branch from "u/mmezzarobba/coerce_embeddings" to "u/mmezzarobba/14982-coerce_embeddings"



---

archive/issue_comments_240593.json:
```json
{
    "body": "Changing commit from \"7e8d4aa5ad04fa2b6536508efefcf69776d6d160\" to \"2fcc47300d619cd8c0c96ab57686096993e64e5d\"",
    "created_at": "2014-01-27T16:12:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240593",
    "user": "https://github.com/mezzarobba"
}
```

Changing commit from "7e8d4aa5ad04fa2b6536508efefcf69776d6d160" to "2fcc47300d619cd8c0c96ab57686096993e64e5d"



---

archive/issue_events_049405.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49405"
}
```



---

archive/issue_events_049406.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49406"
}
```



---

archive/issue_events_049407.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "rename": {
        "from": "Coercion from rings with coerce_embedding into constructions over those rings is broken",
        "to": "Consider coercions of embedded parents that do not use the embedding"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49407"
}
```



---

archive/issue_comments_240594.json:
```json
{
    "body": "Changing commit from \"2fcc47300d619cd8c0c96ab57686096993e64e5d\" to \"b7816788a46fe54990c1f80d89836dc8674b1f89\"",
    "created_at": "2014-04-16T15:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240594",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "2fcc47300d619cd8c0c96ab57686096993e64e5d" to "b7816788a46fe54990c1f80d89836dc8674b1f89"



---

archive/issue_comments_240595.json:
```json
{
    "body": "<a id='comment:25'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                                                                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|\n|[693dfc1](https://github.com/sagemath/sagetrac-mirror/commit/693dfc14777ca08f96cf7062137d0425697480ed)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[372553a](https://github.com/sagemath/sagetrac-mirror/commit/372553ac788694dfa53f156f43136f5f8a707f4a)|`Make coercions that go through lazy fields more robust`|\n|[b781678](https://github.com/sagemath/sagetrac-mirror/commit/b7816788a46fe54990c1f80d89836dc8674b1f89)|`14982: consider coercions of parents with embeddings that do not use the embedding`|",
    "created_at": "2014-04-16T15:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240595",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                                                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
|[693dfc1](https://github.com/sagemath/sagetrac-mirror/commit/693dfc14777ca08f96cf7062137d0425697480ed)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[372553a](https://github.com/sagemath/sagetrac-mirror/commit/372553ac788694dfa53f156f43136f5f8a707f4a)|`Make coercions that go through lazy fields more robust`|
|[b781678](https://github.com/sagemath/sagetrac-mirror/commit/b7816788a46fe54990c1f80d89836dc8674b1f89)|`14982: consider coercions of parents with embeddings that do not use the embedding`|



---

archive/issue_comments_240596.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [git](#comment%3A25):\n> Branch pushed to git repo; I updated commit sha1. This was a forced push.\n\n\nRebased. Tests pass.",
    "created_at": "2014-04-16T15:28:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240596",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:26'></a>
Replying to [git](#comment%3A25):
> Branch pushed to git repo; I updated commit sha1. This was a forced push.


Rebased. Tests pass.



---

archive/issue_events_049408.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49408"
}
```



---

archive/issue_events_049409.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49409"
}
```



---

archive/issue_events_049410.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49410"
}
```



---

archive/issue_events_049411.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "milestone": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49411"
}
```



---

archive/issue_comments_240597.json:
```json
{
    "body": "Changing commit from \"b7816788a46fe54990c1f80d89836dc8674b1f89\" to \"873e359f39632b76dc4179db73a355563fc33e07\"",
    "created_at": "2015-02-05T17:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240597",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b7816788a46fe54990c1f80d89836dc8674b1f89" to "873e359f39632b76dc4179db73a355563fc33e07"



---

archive/issue_comments_240598.json:
```json
{
    "body": "<a id='comment:29'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                                                                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|\n|[d73e507](https://github.com/sagemath/sagetrac-mirror/commit/d73e507fe6b0adaff018b6fa16d65e5f189929da)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[8318f0c](https://github.com/sagemath/sagetrac-mirror/commit/8318f0cee8441bd7b28982a1cb1c7b661b4e7cc6)|`Make coercions that go through lazy fields more robust`|\n|[873e359](https://github.com/sagemath/sagetrac-mirror/commit/873e359f39632b76dc4179db73a355563fc33e07)|`14982: consider coercions of parents with embeddings that do not use the embedding`|",
    "created_at": "2015-02-05T17:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240598",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:29'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                                                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
|[d73e507](https://github.com/sagemath/sagetrac-mirror/commit/d73e507fe6b0adaff018b6fa16d65e5f189929da)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[8318f0c](https://github.com/sagemath/sagetrac-mirror/commit/8318f0cee8441bd7b28982a1cb1c7b661b4e7cc6)|`Make coercions that go through lazy fields more robust`|
|[873e359](https://github.com/sagemath/sagetrac-mirror/commit/873e359f39632b76dc4179db73a355563fc33e07)|`14982: consider coercions of parents with embeddings that do not use the embedding`|



---

archive/issue_events_049412.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "rename": {
        "from": "Consider coercions of embedded parents that do not use the embedding",
        "to": "When a parent is equipped with an embedding, consider coercions that don't go through the embedding"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49412"
}
```



---

archive/issue_comments_240599.json:
```json
{
    "body": "<a id='comment:30'></a>\nRebased. (Tests are still running.)\n  \n---\nNew commits:\n|                                                                                                                                          |                                                                                                     |\n|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|\n|[d73e507](https://github.com/sagemath/sagetrac-mirror/commit/d73e507fe6b0adaff018b6fa16d65e5f189929da)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[8318f0c](https://github.com/sagemath/sagetrac-mirror/commit/8318f0cee8441bd7b28982a1cb1c7b661b4e7cc6)|`Make coercions that go through lazy fields more robust`|\n|[873e359](https://github.com/sagemath/sagetrac-mirror/commit/873e359f39632b76dc4179db73a355563fc33e07)|`14982: consider coercions of parents with embeddings that do not use the embedding`|",
    "created_at": "2015-02-05T17:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240599",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:30'></a>
Rebased. (Tests are still running.)
  
---
New commits:
|                                                                                                                                          |                                                                                                     |
|------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
|[d73e507](https://github.com/sagemath/sagetrac-mirror/commit/d73e507fe6b0adaff018b6fa16d65e5f189929da)|`Cleanup after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[8318f0c](https://github.com/sagemath/sagetrac-mirror/commit/8318f0cee8441bd7b28982a1cb1c7b661b4e7cc6)|`Make coercions that go through lazy fields more robust`|
|[873e359](https://github.com/sagemath/sagetrac-mirror/commit/873e359f39632b76dc4179db73a355563fc33e07)|`14982: consider coercions of parents with embeddings that do not use the embedding`|



---

archive/issue_comments_240600.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-02-05T17:35:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240600",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_240601.json:
```json
{
    "body": "<a id='comment:32'></a>\nNeeds work for what?",
    "created_at": "2015-02-26T13:21:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240601",
    "user": "https://trac.sagemath.org/admin/accounts/users/jpflori"
}
```

<a id='comment:32'></a>
Needs work for what?



---

archive/issue_comments_240602.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [jpflori](#comment%3A32):\n> Needs work for what?\n\n\nThere are new test failures with the rebase. I haven't had time to fix them yet...",
    "created_at": "2015-02-26T13:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240602",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:33'></a>
Replying to [jpflori](#comment%3A32):
> Needs work for what?


There are new test failures with the rebase. I haven't had time to fix them yet...



---

archive/issue_comments_240603.json:
```json
{
    "body": "Changing commit from \"873e359f39632b76dc4179db73a355563fc33e07\" to \"3cfa5436266dcab268c98ac9627ecbb47c11415b\"",
    "created_at": "2015-04-14T16:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240603",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "873e359f39632b76dc4179db73a355563fc33e07" to "3cfa5436266dcab268c98ac9627ecbb47c11415b"



---

archive/issue_comments_240604.json:
```json
{
    "body": "<a id='comment:34'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                                                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|\n|[3d7d823](https://github.com/sagemath/sagetrac-mirror/commit/3d7d82383472bf19beb16860d5454af3271b3081)|`#14982 Clean up after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[434c73d](https://github.com/sagemath/sagetrac-mirror/commit/434c73d0eaea158fe65f9c12c9eb6b81efe51db6)|`#14982 Make coercions that go through lazy fields more robust`|\n|[749ec1f](https://github.com/sagemath/sagetrac-mirror/commit/749ec1ff7bc390070b28c1aedca7b584c7a70e2f)|`#14982 Consider coercions of parents with embeddings that do not use the embedding`|\n|[3cfa543](https://github.com/sagemath/sagetrac-mirror/commit/3cfa5436266dcab268c98ac9627ecbb47c11415b)|`#14982 Workaround for q_binomial doctest`|",
    "created_at": "2015-04-14T16:15:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240604",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:34'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                                                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
|[3d7d823](https://github.com/sagemath/sagetrac-mirror/commit/3d7d82383472bf19beb16860d5454af3271b3081)|`#14982 Clean up after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[434c73d](https://github.com/sagemath/sagetrac-mirror/commit/434c73d0eaea158fe65f9c12c9eb6b81efe51db6)|`#14982 Make coercions that go through lazy fields more robust`|
|[749ec1f](https://github.com/sagemath/sagetrac-mirror/commit/749ec1ff7bc390070b28c1aedca7b584c7a70e2f)|`#14982 Consider coercions of parents with embeddings that do not use the embedding`|
|[3cfa543](https://github.com/sagemath/sagetrac-mirror/commit/3cfa5436266dcab268c98ac9627ecbb47c11415b)|`#14982 Workaround for q_binomial doctest`|



---

archive/issue_comments_240605.json:
```json
{
    "body": "<a id='comment:35'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|\n|[b40ed6c](https://github.com/sagemath/sagetrac-mirror/commit/b40ed6c6aafe4301a81213e6b581f89b4d6d2930)|`#14982 Robustify PolynomialRing_general._coerce_map_from_()`|",
    "created_at": "2015-04-14T16:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240605",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:35'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------|
|[b40ed6c](https://github.com/sagemath/sagetrac-mirror/commit/b40ed6c6aafe4301a81213e6b581f89b4d6d2930)|`#14982 Robustify PolynomialRing_general._coerce_map_from_()`|



---

archive/issue_comments_240606.json:
```json
{
    "body": "Changing commit from \"3cfa5436266dcab268c98ac9627ecbb47c11415b\" to \"b40ed6c6aafe4301a81213e6b581f89b4d6d2930\"",
    "created_at": "2015-04-14T16:37:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240606",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "3cfa5436266dcab268c98ac9627ecbb47c11415b" to "b40ed6c6aafe4301a81213e6b581f89b4d6d2930"



---

archive/issue_comments_240607.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-04-14T16:40:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240607",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_240608.json:
```json
{
    "body": "<a id='comment:37'></a>\n(I haven't had time to run all tests with the last commit yet, only those that failed before plus modules related to things that changed.)",
    "created_at": "2015-04-14T16:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240608",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:37'></a>
(I haven't had time to run all tests with the last commit yet, only those that failed before plus modules related to things that changed.)



---

archive/issue_comments_240609.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -13,4 +13,4 @@\n AttributeError: 'NoneType' object has no attribute 'domain'\n ```\n \n-This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change.\n+This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change. See the individual commit messages for details.\n``````\n",
    "created_at": "2015-04-14T16:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240609",
    "user": "https://github.com/mezzarobba"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -13,4 +13,4 @@
 AttributeError: 'NoneType' object has no attribute 'domain'
 ```
 
-This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change.
+This patch series modifies the coercion discovery algorithm to fix the issue, and fixes or works around a few weaknesses in existing code exposed by the change. See the individual commit messages for details.
``````




---

archive/issue_comments_240610.json:
```json
{
    "body": "<a id='comment:39'></a>\nAll tests pass.",
    "created_at": "2015-04-15T04:34:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240610",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:39'></a>
All tests pass.



---

archive/issue_comments_240611.json:
```json
{
    "body": "<a id='comment:40'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                                                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|\n|[ce4e0a8](https://github.com/sagemath/sagetrac-mirror/commit/ce4e0a883ad2da37a8546450e932100dc46666d1)|`#14982 Clean up after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[ce34b1e](https://github.com/sagemath/sagetrac-mirror/commit/ce34b1e6729ad6b205bd71ca12a29b1ff0a5b309)|`#14982 Make coercions that go through lazy fields more robust`|\n|[16df502](https://github.com/sagemath/sagetrac-mirror/commit/16df5028cbeb6c5ffdd1d4208fa1d0ad6d0c8f92)|`#14982 Consider coercions of parents with embeddings that do not use the embedding`|\n|[3f9b096](https://github.com/sagemath/sagetrac-mirror/commit/3f9b0965b511d8d203ca56b614fb89042f6e721b)|`#14982 Workaround for q_binomial doctest`|\n|[f32b52f](https://github.com/sagemath/sagetrac-mirror/commit/f32b52f4176684d57e4e6b83f80c2c553ffcc8eb)|`#14982 Robustify PolynomialRing_general._coerce_map_from_()`|",
    "created_at": "2015-04-18T10:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240611",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                                                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
|[ce4e0a8](https://github.com/sagemath/sagetrac-mirror/commit/ce4e0a883ad2da37a8546450e932100dc46666d1)|`#14982 Clean up after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[ce34b1e](https://github.com/sagemath/sagetrac-mirror/commit/ce34b1e6729ad6b205bd71ca12a29b1ff0a5b309)|`#14982 Make coercions that go through lazy fields more robust`|
|[16df502](https://github.com/sagemath/sagetrac-mirror/commit/16df5028cbeb6c5ffdd1d4208fa1d0ad6d0c8f92)|`#14982 Consider coercions of parents with embeddings that do not use the embedding`|
|[3f9b096](https://github.com/sagemath/sagetrac-mirror/commit/3f9b0965b511d8d203ca56b614fb89042f6e721b)|`#14982 Workaround for q_binomial doctest`|
|[f32b52f](https://github.com/sagemath/sagetrac-mirror/commit/f32b52f4176684d57e4e6b83f80c2c553ffcc8eb)|`#14982 Robustify PolynomialRing_general._coerce_map_from_()`|



---

archive/issue_comments_240612.json:
```json
{
    "body": "Changing commit from \"b40ed6c6aafe4301a81213e6b581f89b4d6d2930\" to \"f32b52f4176684d57e4e6b83f80c2c553ffcc8eb\"",
    "created_at": "2015-04-18T10:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240612",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b40ed6c6aafe4301a81213e6b581f89b4d6d2930" to "f32b52f4176684d57e4e6b83f80c2c553ffcc8eb"



---

archive/issue_comments_240613.json:
```json
{
    "body": "<a id='comment:41'></a>\nHello,\n\nI have a question related to number fields (in particular #18226 and #17830). I do want a direct coercion `number field -> RIF` based on the (future) `_mpfr_` method of elements. Right now, the route is long as the discoevery algorithm tells me that I need to do `number field -> RLF -> RIF` (and actually there is `QQbar` hidden in the middle). I guess that the proposition here would solve this issue! That would be fantastic.\n\nVincent",
    "created_at": "2015-04-18T11:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240613",
    "user": "https://github.com/videlec"
}
```

<a id='comment:41'></a>
Hello,

I have a question related to number fields (in particular #18226 and #17830). I do want a direct coercion `number field -> RIF` based on the (future) `_mpfr_` method of elements. Right now, the route is long as the discoevery algorithm tells me that I need to do `number field -> RLF -> RIF` (and actually there is `QQbar` hidden in the middle). I guess that the proposition here would solve this issue! That would be fantastic.

Vincent



---

archive/issue_comments_240614.json:
```json
{
    "body": "<a id='comment:42'></a>\nReplying to [vdelecroix](#comment%3A41):\n> I have a question related to number fields (in particular #18226 and #17830). I do want a direct coercion `number field -> RIF` based on the (future) `_mpfr_` method of elements. Right now, the route is long as the discoevery algorithm tells me that I need to do `number field -> RLF -> RIF` (and actually there is `QQbar` hidden in the middle). I guess that the proposition here would solve this issue! That would be fantastic.\n\n\nI don't know if the changes in this ticket would suffice to discover the right coercion path, but at least they make it *possible* to select a coercion path that doesn't use the embedding even when there is another path that uses it!",
    "created_at": "2015-04-18T17:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240614",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:42'></a>
Replying to [vdelecroix](#comment%3A41):
> I have a question related to number fields (in particular #18226 and #17830). I do want a direct coercion `number field -> RIF` based on the (future) `_mpfr_` method of elements. Right now, the route is long as the discoevery algorithm tells me that I need to do `number field -> RLF -> RIF` (and actually there is `QQbar` hidden in the middle). I guess that the proposition here would solve this issue! That would be fantastic.


I don't know if the changes in this ticket would suffice to discover the right coercion path, but at least they make it *possible* to select a coercion path that doesn't use the embedding even when there is another path that uses it!



---

archive/issue_comments_240615.json:
```json
{
    "body": "<a id='comment:43'></a>\nHello,\n\nIn this comment\n\n```\n+            # As a consequence, a value of __an_element with the wrong class\n+            # is cached during the call to has_coerce_map_from. We reset the\n+            # cache afterwards.\n```\nyou refer to `__an_element`. But you changed the attribute's name to `_cache_an_element`.\n\nThe hack for quadratic number field is horrible... At least could we replace\n\n```diff\ndiff --git a/src/sage/rings/number_field/number_field_element_quadratic.pyx b/src/sage/rings/number_field/number_field_element_quadratic.pyx\nindex 32e1acc..692bae1 100644\n--- a/src/sage/rings/number_field/number_field_element_quadratic.pyx\n+++ b/src/sage/rings/number_field/number_field_element_quadratic.pyx\n@@ -210,21 +210,8 @@ cdef class NumberFieldElement_quadratic(NumberFieldElement_absolute):\n             self._reduce_c_()\n \n         # set the attribute standard embedding which is used in the method\n-        # __cmp__\n-        try:\n-            self.standard_embedding = parent._standard_embedding\n-        except AttributeError:\n-            emb = parent.coerce_embedding()\n-            if emb is None:\n-                self.standard_embedding = True\n-                try:\n-                    parent._standard_embedding = True\n-                except AttributeError:\n-                    pass\n-            else:\n-                raise ValueError(\"A parent of NumberFieldElement_quadratic with \"\n-                                 \"a canonical embedding should have an attribute \"\n-                                 \"_standard_embedding (used for comparisons of elements)\")\n+        # __cmp__, sign, real, imag, floor, ceil, ...\n+        self.standard_embedding = parent._standard_embedding\n```\n\nVincent",
    "created_at": "2015-04-21T17:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240615",
    "user": "https://github.com/videlec"
}
```

<a id='comment:43'></a>
Hello,

In this comment

```
+            # As a consequence, a value of __an_element with the wrong class
+            # is cached during the call to has_coerce_map_from. We reset the
+            # cache afterwards.
```
you refer to `__an_element`. But you changed the attribute's name to `_cache_an_element`.

The hack for quadratic number field is horrible... At least could we replace

```diff
diff --git a/src/sage/rings/number_field/number_field_element_quadratic.pyx b/src/sage/rings/number_field/number_field_element_quadratic.pyx
index 32e1acc..692bae1 100644
--- a/src/sage/rings/number_field/number_field_element_quadratic.pyx
+++ b/src/sage/rings/number_field/number_field_element_quadratic.pyx
@@ -210,21 +210,8 @@ cdef class NumberFieldElement_quadratic(NumberFieldElement_absolute):
             self._reduce_c_()
 
         # set the attribute standard embedding which is used in the method
-        # __cmp__
-        try:
-            self.standard_embedding = parent._standard_embedding
-        except AttributeError:
-            emb = parent.coerce_embedding()
-            if emb is None:
-                self.standard_embedding = True
-                try:
-                    parent._standard_embedding = True
-                except AttributeError:
-                    pass
-            else:
-                raise ValueError("A parent of NumberFieldElement_quadratic with "
-                                 "a canonical embedding should have an attribute "
-                                 "_standard_embedding (used for comparisons of elements)")
+        # __cmp__, sign, real, imag, floor, ceil, ...
+        self.standard_embedding = parent._standard_embedding
```

Vincent



---

archive/issue_comments_240616.json:
```json
{
    "body": "<a id='comment:44'></a>\nReplying to [vdelecroix](#comment%3A43):\n> In this comment\n> \n> ```\n> +            # As a consequence, a value of __an_element with the wrong class\n> +            # is cached during the call to has_coerce_map_from. We reset the\n> +            # cache afterwards.\n> ```\n> you refer to `__an_element`. But you changed the attribute's name to `_cache_an_element`.\n\n\nThanks, fixed.\n\n> The hack for quadratic number field is horrible...\n\n\nYou are the one who introduced it, aren't you? `;-)` So I guess you understand what it is for better than I do. In any case I just tested the change you suggested (on top of my branch + the current master) and it doesn't seem to break anything.",
    "created_at": "2015-04-22T08:21:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240616",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:44'></a>
Replying to [vdelecroix](#comment%3A43):
> In this comment
> 
> ```
> +            # As a consequence, a value of __an_element with the wrong class
> +            # is cached during the call to has_coerce_map_from. We reset the
> +            # cache afterwards.
> ```
> you refer to `__an_element`. But you changed the attribute's name to `_cache_an_element`.


Thanks, fixed.

> The hack for quadratic number field is horrible...


You are the one who introduced it, aren't you? `;-)` So I guess you understand what it is for better than I do. In any case I just tested the change you suggested (on top of my branch + the current master) and it doesn't seem to break anything.



---

archive/issue_comments_240617.json:
```json
{
    "body": "Changing commit from \"f32b52f4176684d57e4e6b83f80c2c553ffcc8eb\" to \"4b55415e1dd476e6010fb82b174d5fa455f963bd\"",
    "created_at": "2015-04-22T08:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240617",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "f32b52f4176684d57e4e6b83f80c2c553ffcc8eb" to "4b55415e1dd476e6010fb82b174d5fa455f963bd"



---

archive/issue_comments_240618.json:
```json
{
    "body": "<a id='comment:45'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------|\n|[7baf9d6](https://github.com/sagemath/sagetrac-mirror/commit/7baf9d682508e6d6e1cac84fc0d5d3b1fe4fdf1b)|`#14982 fix comment`|\n|[4b55415](https://github.com/sagemath/sagetrac-mirror/commit/4b55415e1dd476e6010fb82b174d5fa455f963bd)|`#14982 simplify NFE_quadratic.__init__`|",
    "created_at": "2015-04-22T08:22:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240618",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:45'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                    |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------|
|[7baf9d6](https://github.com/sagemath/sagetrac-mirror/commit/7baf9d682508e6d6e1cac84fc0d5d3b1fe4fdf1b)|`#14982 fix comment`|
|[4b55415](https://github.com/sagemath/sagetrac-mirror/commit/4b55415e1dd476e6010fb82b174d5fa455f963bd)|`#14982 simplify NFE_quadratic.__init__`|



---

archive/issue_comments_240619.json:
```json
{
    "body": "<a id='comment:46'></a>\nReplying to [mmezzarobba](#comment%3A44):\n> Replying to [vdelecroix](#comment%3A43):\n\n\n> > The hack for quadratic number field is horrible...\n\n> \n> You are the one who introduced it, aren't you? `;-)` So I guess you understand what it is for better than I do. In any case I just tested the change you suggested (on top of my branch + the current master) and it doesn't seem to break anything.\n\n\nI am ;-(. Thanks for fixing it! I really do not like the loop here: coercion needs an element, but the elements need to know coercion... (certainly out of the scope of the ticket).\n\nI fixed the `q_binomial` issue (see the commit on top `public/14982`, WARNING: it is merged with 6.7.beta2). If you like it just cherry-pick it on top of your branch. Otherwise, I will open a new ticket. I actually found another bug:\n\n```\nsage: Sym = SymmetricFunctions(QQ)\nsage: s = Sym.schur()\nsage: 1 - s[2]\ns[] - s[2]\nsage: 1r - s[2]\nTraceback (most recent call last):\n...\nTypeError: unsupported operand type(s) for -: 'int' and\n'SymmetricFunctionAlgebra_schur_with_category.element_class'\n```\n\nVincent",
    "created_at": "2015-04-22T09:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240619",
    "user": "https://github.com/videlec"
}
```

<a id='comment:46'></a>
Replying to [mmezzarobba](#comment%3A44):
> Replying to [vdelecroix](#comment%3A43):


> > The hack for quadratic number field is horrible...

> 
> You are the one who introduced it, aren't you? `;-)` So I guess you understand what it is for better than I do. In any case I just tested the change you suggested (on top of my branch + the current master) and it doesn't seem to break anything.


I am ;-(. Thanks for fixing it! I really do not like the loop here: coercion needs an element, but the elements need to know coercion... (certainly out of the scope of the ticket).

I fixed the `q_binomial` issue (see the commit on top `public/14982`, WARNING: it is merged with 6.7.beta2). If you like it just cherry-pick it on top of your branch. Otherwise, I will open a new ticket. I actually found another bug:

```
sage: Sym = SymmetricFunctions(QQ)
sage: s = Sym.schur()
sage: 1 - s[2]
s[] - s[2]
sage: 1r - s[2]
Traceback (most recent call last):
...
TypeError: unsupported operand type(s) for -: 'int' and
'SymmetricFunctionAlgebra_schur_with_category.element_class'
```

Vincent



---

archive/issue_comments_240620.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [vdelecroix](#comment%3A46):\n> I am ;-(. Thanks for fixing it! I really do not like the loop here: coercion needs an element, but the elements need to know coercion... (certainly out of the scope of the ticket).\n\n\nIt used to be worse in the past. You want to multiply an element x of parent P with an element y of parent Q. During multiplication, a coercion relating P and Q is sought, which used to involve a call to `P.an_element()` and `Q.an_element()`. But for some parents, this was not implemented or (worse) itself relied on coercion.\n\nToday, the fact is used that one already has elements of P and Q in the situation above (namely x and y).\n\nSo, don't complain, as it could be worse `;-)`",
    "created_at": "2015-04-22T09:33:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240620",
    "user": "https://github.com/simon-king-jena"
}
```

<a id='comment:47'></a>
Replying to [vdelecroix](#comment%3A46):
> I am ;-(. Thanks for fixing it! I really do not like the loop here: coercion needs an element, but the elements need to know coercion... (certainly out of the scope of the ticket).


It used to be worse in the past. You want to multiply an element x of parent P with an element y of parent Q. During multiplication, a coercion relating P and Q is sought, which used to involve a call to `P.an_element()` and `Q.an_element()`. But for some parents, this was not implemented or (worse) itself relied on coercion.

Today, the fact is used that one already has elements of P and Q in the situation above (namely x and y).

So, don't complain, as it could be worse `;-)`



---

archive/issue_comments_240621.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [vdelecroix](#comment%3A46):\n> I fixed the `q_binomial` issue (see the commit on top `public/14982`, WARNING: it is merged with 6.7.beta2).\n\n\nThanks, your fix is much better than what I did (even though the particular issue would probably have been solved by the ticket about `I`). Just one question: why are you doing\n\n```\n    try:\n        zero = R.zero()\n    except AttributeError:\n        zero = R(0)\n    try:\n        one = R.one()\n    except AttributeError:\n        one = R(1)\n```\ninstead of just\n\n```\n    zero = R(0)\n    one = R(1)\n```\n(Are there cases where `R.zero()` would work but not `R(0)`? Or is it faster that way when `R` is a `Parent`, despite the `try`/`catch` block? And then, does speed matter?)\n\n> If you like it just cherry-pick it on top of your branch.\n\n\nI guess I will even rebase the whole thing and merge related commits when we're done talking about it.\n\n> I actually found another bug:\n> \n> ```\n> sage: Sym = SymmetricFunctions(QQ)\n> sage: s = Sym.schur()\n> sage: 1 - s[2]\n> s[] - s[2]\n> sage: 1r - s[2]\n> Traceback (most recent call last):\n> ...\n> TypeError: unsupported operand type(s) for -: 'int' and\n> 'SymmetricFunctionAlgebra_schur_with_category.element_class'\n> ```\n\n\nBut this example already didn't work before this ticket, did it?",
    "created_at": "2015-04-22T11:48:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240621",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:48'></a>
Replying to [vdelecroix](#comment%3A46):
> I fixed the `q_binomial` issue (see the commit on top `public/14982`, WARNING: it is merged with 6.7.beta2).


Thanks, your fix is much better than what I did (even though the particular issue would probably have been solved by the ticket about `I`). Just one question: why are you doing

```
    try:
        zero = R.zero()
    except AttributeError:
        zero = R(0)
    try:
        one = R.one()
    except AttributeError:
        one = R(1)
```
instead of just

```
    zero = R(0)
    one = R(1)
```
(Are there cases where `R.zero()` would work but not `R(0)`? Or is it faster that way when `R` is a `Parent`, despite the `try`/`catch` block? And then, does speed matter?)

> If you like it just cherry-pick it on top of your branch.


I guess I will even rebase the whole thing and merge related commits when we're done talking about it.

> I actually found another bug:
> 
> ```
> sage: Sym = SymmetricFunctions(QQ)
> sage: s = Sym.schur()
> sage: 1 - s[2]
> s[] - s[2]
> sage: 1r - s[2]
> Traceback (most recent call last):
> ...
> TypeError: unsupported operand type(s) for -: 'int' and
> 'SymmetricFunctionAlgebra_schur_with_category.element_class'
> ```


But this example already didn't work before this ticket, did it?



---

archive/issue_comments_240622.json:
```json
{
    "body": "<a id='comment:49'></a>\nReplying to [vdelecroix](#comment%3A46):\n> > > The hack for quadratic number field is horrible...\n\n> > \n> > You are the one who introduced it, aren't you? `;-)` So I guess you understand what it is for better than I do. In any case I just tested the change you suggested (on top of my branch + the current master) and it doesn't seem to break anything.\n\n> \n> I am ;-(. Thanks for fixing it!\n\n\nWell, I didn't really fix it: I just made it slightly less fragile...",
    "created_at": "2015-04-22T11:50:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240622",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:49'></a>
Replying to [vdelecroix](#comment%3A46):
> > > The hack for quadratic number field is horrible...

> > 
> > You are the one who introduced it, aren't you? `;-)` So I guess you understand what it is for better than I do. In any case I just tested the change you suggested (on top of my branch + the current master) and it doesn't seem to break anything.

> 
> I am ;-(. Thanks for fixing it!


Well, I didn't really fix it: I just made it slightly less fragile...



---

archive/issue_comments_240623.json:
```json
{
    "body": "<a id='comment:50'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                            |\n|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|\n|[ee261a3](https://github.com/sagemath/sagetrac-mirror/commit/ee261a37a06b53106c1640c7ef13b913f7cc2532)|`Trac 14982: fix q_binomial`|",
    "created_at": "2015-04-22T12:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240623",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:50'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                            |
|------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
|[ee261a3](https://github.com/sagemath/sagetrac-mirror/commit/ee261a37a06b53106c1640c7ef13b913f7cc2532)|`Trac 14982: fix q_binomial`|



---

archive/issue_comments_240624.json:
```json
{
    "body": "Changing commit from \"4b55415e1dd476e6010fb82b174d5fa455f963bd\" to \"ee261a37a06b53106c1640c7ef13b913f7cc2532\"",
    "created_at": "2015-04-22T12:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240624",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4b55415e1dd476e6010fb82b174d5fa455f963bd" to "ee261a37a06b53106c1640c7ef13b913f7cc2532"



---

archive/issue_comments_240625.json:
```json
{
    "body": "Changing author from \"Marc Mezzarobba\" to \"Marc Mezzarobba, Vincent Delecroix\"",
    "created_at": "2015-04-22T12:04:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240625",
    "user": "https://github.com/mezzarobba"
}
```

Changing author from "Marc Mezzarobba" to "Marc Mezzarobba, Vincent Delecroix"



---

archive/issue_comments_240626.json:
```json
{
    "body": "<a id='comment:52'></a>\nReplying to [mmezzarobba](#comment%3A48):\n> Replying to [vdelecroix](#comment%3A46):\n> > I fixed the `q_binomial` issue (see the commit on top `public/14982`, WARNING: it is merged with 6.7.beta2).\n\n> \n> Thanks, your fix is much better than what I did (even though the particular issue would probably have been solved by the ticket about `I`). Just one question: why are you doing\n> ...\n> instead of just\n>  ...\n> (Are there cases where `R.zero()` would work but not `R(0)`? Or is it faster that way when `R` is a `Parent`, despite the `try`/`catch` block? And then, does speed matter?)\n\n\nHere is an example:\n\n```\nsage: C = GF(5).cartesian_product(GF(5))\nsage: C(0)\nTraceback (most recent call last):\n...\nTypeError: 'sage.rings.integer.Integer' object is not iterable\nsage: C(1)\nTraceback (most recent call last):\n...\nTypeError: 'sage.rings.integer.Integer' object is not iterable\nsage: C.zero()\n(0, 0)\nsage: C.one()\n(1, 1)\n```\nBut I guess that it should work because there always is a canonical morphism `ZZ -> ring`. And here not\n\n```\nsage: C.has_coerce_map_from(ZZ)\nFalse\n```\nSo do not worry about this example. The version with `zero = R(0)` and `one = R(1)` is much simpler. And anyway it is completely broken\n\n```\nsage: cyclotomic_value(4, C.one())\nTraceback (most recent call last):\n...\nTypeError: unsupported operand parent(s) for '-':\n'The cartesian product of (Finite Field of size 5, Finite Field of size 5)'\nand '<type 'int'>'\nsage: q_binomial(4, 2, C.one())\nTraceback (most recent call last):\n..\nRuntimeError: maximum recursion depth exceeded while calling a Python object\n```\nActually, this last example with infinite recursion is related to coercions... so potentially there is something to dig further.\n\n> But this example already didn't work before this ticket, did it?\n\n\nNope. Completely unrelated. Actually, it is related in the sense that the was appearing in `prod(1 - q**i ...)`. And apparently it was the unique reason of this huge `try/except` block that is removed by my commit.\n\nVincent",
    "created_at": "2015-04-22T12:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240626",
    "user": "https://github.com/videlec"
}
```

<a id='comment:52'></a>
Replying to [mmezzarobba](#comment%3A48):
> Replying to [vdelecroix](#comment%3A46):
> > I fixed the `q_binomial` issue (see the commit on top `public/14982`, WARNING: it is merged with 6.7.beta2).

> 
> Thanks, your fix is much better than what I did (even though the particular issue would probably have been solved by the ticket about `I`). Just one question: why are you doing
> ...
> instead of just
>  ...
> (Are there cases where `R.zero()` would work but not `R(0)`? Or is it faster that way when `R` is a `Parent`, despite the `try`/`catch` block? And then, does speed matter?)


Here is an example:

```
sage: C = GF(5).cartesian_product(GF(5))
sage: C(0)
Traceback (most recent call last):
...
TypeError: 'sage.rings.integer.Integer' object is not iterable
sage: C(1)
Traceback (most recent call last):
...
TypeError: 'sage.rings.integer.Integer' object is not iterable
sage: C.zero()
(0, 0)
sage: C.one()
(1, 1)
```
But I guess that it should work because there always is a canonical morphism `ZZ -> ring`. And here not

```
sage: C.has_coerce_map_from(ZZ)
False
```
So do not worry about this example. The version with `zero = R(0)` and `one = R(1)` is much simpler. And anyway it is completely broken

```
sage: cyclotomic_value(4, C.one())
Traceback (most recent call last):
...
TypeError: unsupported operand parent(s) for '-':
'The cartesian product of (Finite Field of size 5, Finite Field of size 5)'
and '<type 'int'>'
sage: q_binomial(4, 2, C.one())
Traceback (most recent call last):
..
RuntimeError: maximum recursion depth exceeded while calling a Python object
```
Actually, this last example with infinite recursion is related to coercions... so potentially there is something to dig further.

> But this example already didn't work before this ticket, did it?


Nope. Completely unrelated. Actually, it is related in the sense that the was appearing in `prod(1 - q**i ...)`. And apparently it was the unique reason of this huge `try/except` block that is removed by my commit.

Vincent



---

archive/issue_comments_240627.json:
```json
{
    "body": "<a id='comment:53'></a>\nHaha\n\n```\nsage: one = C.one()\nsage: one - one\nTraceback (most recent call last):\n...\nRuntimeError: maximum recursion depth exceeded in __instancecheck__\n```\nsee #18275",
    "created_at": "2015-04-22T12:28:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240627",
    "user": "https://github.com/videlec"
}
```

<a id='comment:53'></a>
Haha

```
sage: one = C.one()
sage: one - one
Traceback (most recent call last):
...
RuntimeError: maximum recursion depth exceeded in __instancecheck__
```
see #18275



---

archive/issue_comments_240628.json:
```json
{
    "body": "Changing commit from \"ee261a37a06b53106c1640c7ef13b913f7cc2532\" to \"d99564520a5fd599c0fea62b86d0bdbfbd35c1a4\"",
    "created_at": "2015-04-22T13:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240628",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "ee261a37a06b53106c1640c7ef13b913f7cc2532" to "d99564520a5fd599c0fea62b86d0bdbfbd35c1a4"



---

archive/issue_comments_240629.json:
```json
{
    "body": "<a id='comment:54'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                          |                                                                                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|\n|[47b6a0e](https://github.com/sagemath/sagetrac-mirror/commit/47b6a0e84a2faa4eb7cf934b79eadc3a2ad9e6cf)|`#14982 Clean up after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|\n|[61c73bb](https://github.com/sagemath/sagetrac-mirror/commit/61c73bb1e313f39737c24d8ffa34aaa0d5634f49)|`#14982 Make coercions that go through lazy fields more robust`|\n|[0aa11af](https://github.com/sagemath/sagetrac-mirror/commit/0aa11af6392cc649b9030bb53843152ebc96b25e)|`#14982 fix q_binomial`|\n|[a3227dd](https://github.com/sagemath/sagetrac-mirror/commit/a3227dd071f7efc9822a66beb977607aee2f5ac5)|`#14982 Robustify PolynomialRing_general._coerce_map_from_()`|\n|[d995645](https://github.com/sagemath/sagetrac-mirror/commit/d99564520a5fd599c0fea62b86d0bdbfbd35c1a4)|`#14982 Consider coercions of parents with embeddings that do not use the embedding`|",
    "created_at": "2015-04-22T13:49:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240629",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:54'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                          |                                                                                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
|[47b6a0e](https://github.com/sagemath/sagetrac-mirror/commit/47b6a0e84a2faa4eb7cf934b79eadc3a2ad9e6cf)|`#14982 Clean up after querying the coercion system with a temporary element_class in NumberField_cyclotomic`|
|[61c73bb](https://github.com/sagemath/sagetrac-mirror/commit/61c73bb1e313f39737c24d8ffa34aaa0d5634f49)|`#14982 Make coercions that go through lazy fields more robust`|
|[0aa11af](https://github.com/sagemath/sagetrac-mirror/commit/0aa11af6392cc649b9030bb53843152ebc96b25e)|`#14982 fix q_binomial`|
|[a3227dd](https://github.com/sagemath/sagetrac-mirror/commit/a3227dd071f7efc9822a66beb977607aee2f5ac5)|`#14982 Robustify PolynomialRing_general._coerce_map_from_()`|
|[d995645](https://github.com/sagemath/sagetrac-mirror/commit/d99564520a5fd599c0fea62b86d0bdbfbd35c1a4)|`#14982 Consider coercions of parents with embeddings that do not use the embedding`|



---

archive/issue_comments_240630.json:
```json
{
    "body": "<a id='comment:55'></a>\nVincent, do your comments count as a review? (If so, you may want to check that I didn't do anything wrong with my last rebase.) Or are there still things to be checked/addressed?",
    "created_at": "2015-04-23T07:24:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240630",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:55'></a>
Vincent, do your comments count as a review? (If so, you may want to check that I didn't do anything wrong with my last rebase.) Or are there still things to be checked/addressed?



---

archive/issue_comments_240631.json:
```json
{
    "body": "<a id='comment:56'></a>\nHello,\n\nI am not sure I am the best person to do the complete review. But...\n\n1. Is this really the example you wanted to show `MatrixSpace(L, 2, 2).coerce_map_from(L)`. Wouldn't be better to test `MatrixSpace(K, 2, 2).coerce_map_from(L)`? Idem for the one with `PowerSeriesRing` that follows.\n\n2. With your modifications the following changes. Old version:\n\n```\nsage: C12.<zeta12> = CyclotomicField(12)\nsage: C4.<zeta4> = CyclotomicField(4, embedding=zeta12**3)\nsage: PowerSeriesRing(C12, 'x').coerce_map_from(C4)\nComposite map:\n  From: Cyclotomic Field of order 4 and degree 2\n  To:   Power Series Ring in x over Cyclotomic Field of order 12 and degree 4\n  Defn:   Generic morphism:\n          From: Cyclotomic Field of order 4 and degree 2\n          To:   Cyclotomic Field of order 12 and degree 4\n          Defn: zeta4 -> zeta12^3\n        then\n          Conversion map:\n          From: Cyclotomic Field of order 12 and degree 4\n          To:   Power Series Ring in x over Cyclotomic Field of order 12 and degree 4\n```\n  Versus new version:\n\n```\nsage: PowerSeriesRing(C12, 'x').coerce_map_from(C4)\nConversion map:\n  From: Cyclotomic Field of order 4 and degree 2\n  To:   Power Series Ring in x over Cyclotomic Field of order 12 and degree 4\nsage: timeit(\"mor(a)\", number=5000, repeat=6)\n5000 loops, best of 6: 120 \u00b5s per loop\n```\n  whereas for `PolynomialRing` the behavior is identical (similar to the \"old version\" above). Is it the kind of thing that you expected?\n\nVincent",
    "created_at": "2015-04-24T23:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240631",
    "user": "https://github.com/videlec"
}
```

<a id='comment:56'></a>
Hello,

I am not sure I am the best person to do the complete review. But...

1. Is this really the example you wanted to show `MatrixSpace(L, 2, 2).coerce_map_from(L)`. Wouldn't be better to test `MatrixSpace(K, 2, 2).coerce_map_from(L)`? Idem for the one with `PowerSeriesRing` that follows.

2. With your modifications the following changes. Old version:

```
sage: C12.<zeta12> = CyclotomicField(12)
sage: C4.<zeta4> = CyclotomicField(4, embedding=zeta12**3)
sage: PowerSeriesRing(C12, 'x').coerce_map_from(C4)
Composite map:
  From: Cyclotomic Field of order 4 and degree 2
  To:   Power Series Ring in x over Cyclotomic Field of order 12 and degree 4
  Defn:   Generic morphism:
          From: Cyclotomic Field of order 4 and degree 2
          To:   Cyclotomic Field of order 12 and degree 4
          Defn: zeta4 -> zeta12^3
        then
          Conversion map:
          From: Cyclotomic Field of order 12 and degree 4
          To:   Power Series Ring in x over Cyclotomic Field of order 12 and degree 4
```
  Versus new version:

```
sage: PowerSeriesRing(C12, 'x').coerce_map_from(C4)
Conversion map:
  From: Cyclotomic Field of order 4 and degree 2
  To:   Power Series Ring in x over Cyclotomic Field of order 12 and degree 4
sage: timeit("mor(a)", number=5000, repeat=6)
5000 loops, best of 6: 120 s per loop
```
  whereas for `PolynomialRing` the behavior is identical (similar to the "old version" above). Is it the kind of thing that you expected?

Vincent



---

archive/issue_comments_240632.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-04-24T23:14:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240632",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_240633.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2015-04-25T14:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240633",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_240634.json:
```json
{
    "body": "<a id='comment:58'></a>\nReplying to [vdelecroix](#comment%3A56):\n> 1. Is this really the example you wanted to show `MatrixSpace(L, 2, 2).coerce_map_from(L)`. Wouldn't be better to test `MatrixSpace(K, 2, 2).coerce_map_from(L)`? Idem for the one with `PowerSeriesRing` that follows.\n\n\nYes, I think it is, because I wanted to illustrate that the way coercions are discovered in the presence of an embedding makes it difficult to work with structures that have the \u201cembedded\u201d parent as a base ring, even if the parent into which it is embedded plays no role in the construction. But I wrote this comment more than 1\u00bd years ago, so I'm not sure I remember correctly!\n\n> 2. With your modifications the following changes.\n>    [...]\n>    whereas for `PolynomialRing` the behavior is identical (similar to the \"old version\" above). Is it the kind of thing that you expected?\n\n\nSorry, I'm not sure I understand the question. Let me try to answer it anyway: the goal of these patches is to make the coercion discovery algorithm *consider* paths that don't start with the embedding. These paths may or may not be selected depending on each particular case.\n\n> {{{\n> sage: timeit(\"mor(a)\", number=5000, repeat=6)\n> 5000 loops, best of 6: 120 \u00b5s per loop\n> }}}\n\n\nAre these lines a copy-paste error, or did you observe a speed regression with some coercions? (On my machine, applying the morphism returned by `PowerSeriesRing(C12, 'x').coerce_map_from(C4)` takes almost exactly as much time before and after my patches.)",
    "created_at": "2015-04-25T14:59:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240634",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:58'></a>
Replying to [vdelecroix](#comment%3A56):
> 1. Is this really the example you wanted to show `MatrixSpace(L, 2, 2).coerce_map_from(L)`. Wouldn't be better to test `MatrixSpace(K, 2, 2).coerce_map_from(L)`? Idem for the one with `PowerSeriesRing` that follows.


Yes, I think it is, because I wanted to illustrate that the way coercions are discovered in the presence of an embedding makes it difficult to work with structures that have the embedded parent as a base ring, even if the parent into which it is embedded plays no role in the construction. But I wrote this comment more than 1 years ago, so I'm not sure I remember correctly!

> 2. With your modifications the following changes.
>    [...]
>    whereas for `PolynomialRing` the behavior is identical (similar to the "old version" above). Is it the kind of thing that you expected?


Sorry, I'm not sure I understand the question. Let me try to answer it anyway: the goal of these patches is to make the coercion discovery algorithm *consider* paths that don't start with the embedding. These paths may or may not be selected depending on each particular case.

> {{{
> sage: timeit("mor(a)", number=5000, repeat=6)
> 5000 loops, best of 6: 120 s per loop
> }}}


Are these lines a copy-paste error, or did you observe a speed regression with some coercions? (On my machine, applying the morphism returned by `PowerSeriesRing(C12, 'x').coerce_map_from(C4)` takes almost exactly as much time before and after my patches.)



---

archive/issue_comments_240635.json:
```json
{
    "body": "<a id='comment:59'></a>\nReplying to [mmezzarobba](#comment%3A58):\n> Replying to [vdelecroix](#comment%3A56):\n> > {{{\n> > sage: timeit(\"mor(a)\", number=5000, repeat=6)\n> > 5000 loops, best of 6: 120 \u00b5s per loop\n> > }}}\n\n> \n> Are these lines a copy-paste error, or did you observe a speed regression with some coercions? (On my machine, applying the morphism returned by `PowerSeriesRing(C12, 'x').coerce_map_from(C4)` takes almost exactly as much time before and after my patches.)\n\n\nOops sorry. Yes, I observed a tiny regression speed of roughly 4% (120 \u00b5s vs 115 \u00b5s). Not very significant and that's the reason why I erased half of it.",
    "created_at": "2015-04-25T15:05:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240635",
    "user": "https://github.com/videlec"
}
```

<a id='comment:59'></a>
Replying to [mmezzarobba](#comment%3A58):
> Replying to [vdelecroix](#comment%3A56):
> > {{{
> > sage: timeit("mor(a)", number=5000, repeat=6)
> > 5000 loops, best of 6: 120 s per loop
> > }}}

> 
> Are these lines a copy-paste error, or did you observe a speed regression with some coercions? (On my machine, applying the morphism returned by `PowerSeriesRing(C12, 'x').coerce_map_from(C4)` takes almost exactly as much time before and after my patches.)


Oops sorry. Yes, I observed a tiny regression speed of roughly 4% (120 s vs 115 s). Not very significant and that's the reason why I erased half of it.



---

archive/issue_comments_240636.json:
```json
{
    "body": "<a id='comment:60'></a>\nSalut Marc,\n\nI am quite confused by the following\n\n```\nsage: K = QuadraticField(2)\nsage: RR.coerce_map_from(K)\nComposite map:\n  From: Number Field in a with defining polynomial x^2 - 2\n  To:   Real Field with 53 bits of precision\n  Defn:   Generic morphism:\n          From: Number Field in a with defining polynomial x^2 - 2\n          To:   Real Lazy Field\n          Defn: a -> 1.414213562373095?\n        then\n          Conversion via _mpfr_ method map:\n          From: Real Lazy Field\n          To:   Real Field with 53 bits of precision\n```\nBut elements of `K` do implement directly an `_mpfr_` method\n\n```\nsage: K.an_element()._mpfr_\n<built-in method _mpfr_ of sage.rings.number_field.number_field_element_quadratic.NumberFieldElement_quadratic object at 0x7f3e3d94ff68>\n```\nSo why the discovery does not choose this direct conversion map instead of going through the real lazy field? (note: this method `_mpfr_` is completely broken, but it does not change anything to the story)\n\nVincent",
    "created_at": "2015-05-02T11:05:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240636",
    "user": "https://github.com/videlec"
}
```

<a id='comment:60'></a>
Salut Marc,

I am quite confused by the following

```
sage: K = QuadraticField(2)
sage: RR.coerce_map_from(K)
Composite map:
  From: Number Field in a with defining polynomial x^2 - 2
  To:   Real Field with 53 bits of precision
  Defn:   Generic morphism:
          From: Number Field in a with defining polynomial x^2 - 2
          To:   Real Lazy Field
          Defn: a -> 1.414213562373095?
        then
          Conversion via _mpfr_ method map:
          From: Real Lazy Field
          To:   Real Field with 53 bits of precision
```
But elements of `K` do implement directly an `_mpfr_` method

```
sage: K.an_element()._mpfr_
<built-in method _mpfr_ of sage.rings.number_field.number_field_element_quadratic.NumberFieldElement_quadratic object at 0x7f3e3d94ff68>
```
So why the discovery does not choose this direct conversion map instead of going through the real lazy field? (note: this method `_mpfr_` is completely broken, but it does not change anything to the story)

Vincent



---

archive/issue_comments_240637.json:
```json
{
    "body": "<a id='comment:61'></a>\nSalut Vincent,\n\nReplying to [vdelecroix](#comment%3A60):\n> So why the discovery does not choose this direct conversion map instead of going through the real lazy field? (note: this method `_mpfr_` is completely broken, but it does not change anything to the story)\n\n\nI think the reason is that `RR` explicitly asks for coercions into it through `RLF` (see the very last line of `RealField_class._coerce_map_from_`. So the step of the coercion discovery algorithm that calls `_coerce_map_from_` (step\u00a02 with my patch) succeeds. The map it finds is of type `FormalCompositeMap`, so the next step (which would consider the coercions defined using `_populate_coercion_lists_`, including `_mpfr_`) is not even tried.\n\nAs far as I understand, this is the intended behavior from the point of view of the coercion discovery algorithm\u2014`_coerce_map_from_` \u201cknows better\u201d, do as it says. In any case the fact that the coercion from `K` to `RLF` is an embedding doesn't come into play. (But this ticket should make it possible to chose the coercion via `_mpfr_` by modifying `RealField_class._coerce_map_from_`, while this wouldn't work now due to the special treatment of embeddings.)",
    "created_at": "2015-05-02T11:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240637",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:61'></a>
Salut Vincent,

Replying to [vdelecroix](#comment%3A60):
> So why the discovery does not choose this direct conversion map instead of going through the real lazy field? (note: this method `_mpfr_` is completely broken, but it does not change anything to the story)


I think the reason is that `RR` explicitly asks for coercions into it through `RLF` (see the very last line of `RealField_class._coerce_map_from_`. So the step of the coercion discovery algorithm that calls `_coerce_map_from_` (step2 with my patch) succeeds. The map it finds is of type `FormalCompositeMap`, so the next step (which would consider the coercions defined using `_populate_coercion_lists_`, including `_mpfr_`) is not even tried.

As far as I understand, this is the intended behavior from the point of view of the coercion discovery algorithm`_coerce_map_from_` knows better, do as it says. In any case the fact that the coercion from `K` to `RLF` is an embedding doesn't come into play. (But this ticket should make it possible to chose the coercion via `_mpfr_` by modifying `RealField_class._coerce_map_from_`, while this wouldn't work now due to the special treatment of embeddings.)



---

archive/issue_comments_240638.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2015-05-02T12:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240638",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_240639.json:
```json
{
    "body": "<a id='comment:62'></a>\nFinal remark: I understand what you are doing with the newly defined method `domains` but I found the specifications rather unclear\n\n```\nYield the domain of self. In general, iterate over the domains of\nthe factors of a composite map.\n```\nCould you be more precise in the documentation and precise why is it here?\n\nVincent",
    "created_at": "2015-05-02T12:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240639",
    "user": "https://github.com/videlec"
}
```

<a id='comment:62'></a>
Final remark: I understand what you are doing with the newly defined method `domains` but I found the specifications rather unclear

```
Yield the domain of self. In general, iterate over the domains of
the factors of a composite map.
```
Could you be more precise in the documentation and precise why is it here?

Vincent



---

archive/issue_comments_240640.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2015-05-02T12:34:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240640",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_240641.json:
```json
{
    "body": "Changing commit from \"d99564520a5fd599c0fea62b86d0bdbfbd35c1a4\" to \"a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6\"",
    "created_at": "2015-05-02T13:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240641",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d99564520a5fd599c0fea62b86d0bdbfbd35c1a4" to "a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6"



---

archive/issue_comments_240642.json:
```json
{
    "body": "<a id='comment:63'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                          |                                             |\n|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|\n|[a0ac11b](https://github.com/sagemath/sagetrac-mirror/commit/a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6)|`#14982 Map.domains(): improve documentation`|",
    "created_at": "2015-05-02T13:13:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240642",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:63'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                          |                                             |
|------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------|
|[a0ac11b](https://github.com/sagemath/sagetrac-mirror/commit/a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6)|`#14982 Map.domains(): improve documentation`|



---

archive/issue_comments_240643.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-05-02T13:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240643",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_240644.json:
```json
{
    "body": "<a id='comment:64'></a>\nThanks again for your comments!\n\nReplying to [vdelecroix](#comment%3A62):\n> Final remark: I understand what you are doing with the newly defined method `domains` but I found the specifications rather unclear\n\n\nIs it better now?",
    "created_at": "2015-05-02T13:15:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240644",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:64'></a>
Thanks again for your comments!

Replying to [vdelecroix](#comment%3A62):
> Final remark: I understand what you are doing with the newly defined method `domains` but I found the specifications rather unclear


Is it better now?



---

archive/issue_comments_240645.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-05-02T13:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240645",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_240646.json:
```json
{
    "body": "<a id='comment:65'></a>\nYep. Good for me!",
    "created_at": "2015-05-02T13:24:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240646",
    "user": "https://github.com/videlec"
}
```

<a id='comment:65'></a>
Yep. Good for me!



---

archive/issue_comments_240647.json:
```json
{
    "body": "<a id='comment:66'></a>\nReplying to [vdelecroix](#comment%3A65):\n> Yep. Good for me!\n\n\nThanks a lot!",
    "created_at": "2015-05-02T13:27:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240647",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:66'></a>
Replying to [vdelecroix](#comment%3A65):
> Yep. Good for me!


Thanks a lot!



---

archive/issue_comments_240648.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-05-02T19:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240648",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_240649.json:
```json
{
    "body": "Changing branch from \"u/mmezzarobba/14982-coerce_embeddings\" to \"a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6\"",
    "created_at": "2015-05-02T19:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14982#issuecomment-240649",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/mmezzarobba/14982-coerce_embeddings" to "a0ac11b26f4ded7bbcbef5bb6a1f81ae8ed354f6"



---

archive/issue_events_049413.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-05-02T19:28:34Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/14982",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/14982#event-49413"
}
```
