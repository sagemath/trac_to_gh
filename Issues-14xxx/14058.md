# Issue 14058: Weakly reference binary operation codomains

archive/issues_013854.json:
```json
{
    "assignees": [
        "https://github.com/rlmill"
    ],
    "body": "R(1) + S(1) caches a strong reference to both R and S, which we'd like to avoid. \n\nSee discussion at https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ozhIHIwQ4WA\n\nCC:  @nbruin @simon-king-jena @jpflori\n\nBranch: **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)**\n\nReviewer: **Simon King, Fr\u00e9d\u00e9ric Chapoton, Jean-Pierre Flori, S\u00e9bastien Labb\u00e9**\n\nAuthor: **Robert Bradshaw, Nils Bruin**\n\nComponent: **memleak**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/14058_\n\n",
    "closed_at": "2015-09-13T22:12:27Z",
    "created_at": "2013-02-05T09:51:57Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/memleak",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-6.9",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Weakly reference binary operation codomains",
    "type": "issue",
    "updated_at": "2015-09-19T10:53:54Z",
    "url": "https://github.com/sagemath/sage/issues/14058",
    "user": "https://github.com/robertwb"
}
```
R(1) + S(1) caches a strong reference to both R and S, which we'd like to avoid. 

See discussion at https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ozhIHIwQ4WA

CC:  @nbruin @simon-king-jena @jpflori

Branch: **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)**

Reviewer: **Simon King, Frédéric Chapoton, Jean-Pierre Flori, Sébastien Labbé**

Author: **Robert Bradshaw, Nils Bruin**

Component: **memleak**

_Issue created by migration from https://trac.sagemath.org/ticket/14058_





---

archive/issue_events_197646.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2013-02-05T09:51:57Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197646"
}
```



---

archive/issue_events_197647.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2013-02-05T09:51:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/memleak",
    "label_color": "696969",
    "label_name": "memleak",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197647"
}
```



---

archive/issue_events_197648.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2013-02-05T09:51:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197648"
}
```



---

archive/issue_events_197649.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2013-02-05T09:51:57Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197649"
}
```



---

archive/issue_events_197650.json:
```json
{
    "actor": "https://github.com/rlmill",
    "created_at": "2013-02-05T09:51:57Z",
    "event": "assigned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "subject": "https://github.com/robertwb",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197650"
}
```



---

archive/issue_comments_167033.json:
```json
{
    "body": "Attachment: **[14058-weak-binop.patch.gz](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop.patch.gz)**",
    "created_at": "2013-02-05T09:57:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167033",
    "user": "https://github.com/robertwb"
}
```

Attachment: **[14058-weak-binop.patch.gz](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop.patch.gz)**



---

archive/issue_events_197651.json:
```json
{
    "actor": "https://github.com/robertwb",
    "created_at": "2013-02-05T10:00:37Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197651"
}
```



---

archive/issue_comments_167034.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">comment:2</div>\n\nIs it possible to add an example that shows that parents become collectable that previously weren't?",
    "created_at": "2013-02-05T10:49:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167034",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:2" align="right">comment:2</div>

Is it possible to add an example that shows that parents become collectable that previously weren't?



---

archive/issue_comments_167035.json:
```json
{
    "body": "Doctest proposal",
    "created_at": "2013-02-05T17:38:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167035",
    "user": "https://github.com/nbruin"
}
```

Doctest proposal



---

archive/issue_comments_167036.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nAttachment: **[trac_14058-doctest.patch.gz](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)**\n\nI like the idea. Can we get some data on speed regressions due to this? In principle the double lookup might be noticeable. I don't mean speed regressions due to parents getting deleted -- those are good to know but need other fixes. I mean when the parents are still around.\n\nAttached doctests may need #12313 to work, in which case this ticket should depend on that (because then that's necessary to get benefit from this ticket).",
    "created_at": "2013-02-05T17:42:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167036",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:3" align="right">comment:3</div>

Attachment: **[trac_14058-doctest.patch.gz](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)**

I like the idea. Can we get some data on speed regressions due to this? In principle the double lookup might be noticeable. I don't mean speed regressions due to parents getting deleted -- those are good to know but need other fixes. I mean when the parents are still around.

Attached doctests may need #12313 to work, in which case this ticket should depend on that (because then that's necessary to get benefit from this ticket).



---

archive/issue_comments_167037.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nSadly, the performance hit is quite noticeable.\n\n```\na=ZZ(1)\nb=QQ(1)\nc=ZZ['x'](1)\nd=b+c\n\ndef test(x,y):\n  for i in xrange(10^6):\n    _=x+y\n```\nWithin a run, timing `test` seems fairly consistent. However, between different compiles of the same code I'm observing fluctuations of up to `0.10s` in timings. Lucky/unlucky memory layout?\nAnyway, with patch:\n\n```\nsage: %time test(a,b)\nCPU times: user 2.15 s, sys: 0.00 s, total: 2.15 s\nWall time: 2.16 s\nsage: %time test(a,c)\nCPU times: user 2.25 s, sys: 0.00 s, total: 2.25 s\nWall time: 2.26 s\nsage: %time test(b,c)\nCPU times: user 16.83 s, sys: 0.00 s, total: 16.83 s\n```\nwithout patch\n\n```\nsage: %time test(a,b)\nCPU times: user 1.54 s, sys: 0.00 s, total: 1.54 s\nWall time: 1.55 s\nsage: %time test(a,c)\nCPU times: user 1.64 s, sys: 0.00 s, total: 1.64 s\nWall time: 1.64 s\nCPU times: user 15.68 s, sys: 0.00 s, total: 15.68 s\nWall time: 15.76 s\n```\nFor `test(a,a)`, `test(b,b)`, `test(c,c)` there doesn't seem to be a difference (luckily!)\n\nThe penalties seem to be about `0.6s`, `0.6s`, `1.2s`, which is rather consistent with 1,1,2 extra lookups.\n\nThis indicates to me it may be worth trying storing a weakref to the morphism instead, since that can probably be dereferenced faster than a coercion lookup on the codomain. Logically this should be equivalent. We're just storing a weakref to the object we're interested in rather than instructions where to go and lookup the object we want.\n\nCaveat:\n\nFor stored coercions of the type\n`(R,S, ...): (None,<map S->R>)`\nor\n`(R,S, ...): (<map R->S>,None)`\nthe codomain is part of the key, so deletion of the codomain (which is a prerequisite for the morphism being deleted and hence the weakref dying) implies removal of the weak key entry in `TripleDict`.\n\nHowever, for stored coercions of the type\n`(R,S,...): (<map R->C>,<map S->C>)`\nwe could have that `C` and the weakrefs to the morphisms die, but that would not trigger the removal from the `TripleDict`. So we could still encounter dead weakrefs (but much less than one would perhaps initially think!) It's not really much different from how [attachment: 14058-weak-binop.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop.patch.gz) handles dead weakrefs.\n\nMajor problem for immediately applying this idea:\n\n```\nsage: M=QQ.coerce_map_from(ZZ)\nsage: import weakref\nsage: weakref.ref(M)\nTypeError: cannot create weak reference to 'sage.rings.rational.Z_to_Q' object\n```",
    "created_at": "2013-02-05T19:54:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167037",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:4" align="right">comment:4</div>

Sadly, the performance hit is quite noticeable.

```
a=ZZ(1)
b=QQ(1)
c=ZZ['x'](1)
d=b+c

def test(x,y):
  for i in xrange(10^6):
    _=x+y
```
Within a run, timing `test` seems fairly consistent. However, between different compiles of the same code I'm observing fluctuations of up to `0.10s` in timings. Lucky/unlucky memory layout?
Anyway, with patch:

```
sage: %time test(a,b)
CPU times: user 2.15 s, sys: 0.00 s, total: 2.15 s
Wall time: 2.16 s
sage: %time test(a,c)
CPU times: user 2.25 s, sys: 0.00 s, total: 2.25 s
Wall time: 2.26 s
sage: %time test(b,c)
CPU times: user 16.83 s, sys: 0.00 s, total: 16.83 s
```
without patch

```
sage: %time test(a,b)
CPU times: user 1.54 s, sys: 0.00 s, total: 1.54 s
Wall time: 1.55 s
sage: %time test(a,c)
CPU times: user 1.64 s, sys: 0.00 s, total: 1.64 s
Wall time: 1.64 s
CPU times: user 15.68 s, sys: 0.00 s, total: 15.68 s
Wall time: 15.76 s
```
For `test(a,a)`, `test(b,b)`, `test(c,c)` there doesn't seem to be a difference (luckily!)

The penalties seem to be about `0.6s`, `0.6s`, `1.2s`, which is rather consistent with 1,1,2 extra lookups.

This indicates to me it may be worth trying storing a weakref to the morphism instead, since that can probably be dereferenced faster than a coercion lookup on the codomain. Logically this should be equivalent. We're just storing a weakref to the object we're interested in rather than instructions where to go and lookup the object we want.

Caveat:

For stored coercions of the type
`(R,S, ...): (None,<map S->R>)`
or
`(R,S, ...): (<map R->S>,None)`
the codomain is part of the key, so deletion of the codomain (which is a prerequisite for the morphism being deleted and hence the weakref dying) implies removal of the weak key entry in `TripleDict`.

However, for stored coercions of the type
`(R,S,...): (<map R->C>,<map S->C>)`
we could have that `C` and the weakrefs to the morphisms die, but that would not trigger the removal from the `TripleDict`. So we could still encounter dead weakrefs (but much less than one would perhaps initially think!) It's not really much different from how [attachment: 14058-weak-binop.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop.patch.gz) handles dead weakrefs.

Major problem for immediately applying this idea:

```
sage: M=QQ.coerce_map_from(ZZ)
sage: import weakref
sage: weakref.ref(M)
TypeError: cannot create weak reference to 'sage.rings.rational.Z_to_Q' object
```



---

archive/issue_comments_167038.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nYeah, I had exactly this same idea. I'll post an updated patch.",
    "created_at": "2013-02-05T20:02:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167038",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:5" align="right">comment:5</div>

Yeah, I had exactly this same idea. I'll post an updated patch.



---

archive/issue_comments_167039.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nAttachment: **[14058-weak-binop-morphisms.patch.gz](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)**\n\nApply 14058-weak-binop-morphisms.patch and trac_14058-doctest.patch",
    "created_at": "2013-02-05T20:25:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167039",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:6" align="right">comment:6</div>

Attachment: **[14058-weak-binop-morphisms.patch.gz](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)**

Apply 14058-weak-binop-morphisms.patch and trac_14058-doctest.patch



---

archive/issue_comments_167040.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nGreat! With this new patch I cannot distinguish the timing differences from the noise one normally gets already, so I'd think this is quite acceptable.",
    "created_at": "2013-02-05T21:16:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167040",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:7" align="right">comment:7</div>

Great! With this new patch I cannot distinguish the timing differences from the noise one normally gets already, so I'd think this is quite acceptable.



---

archive/issue_comments_167041.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\npatchbot seems unhappy about the doctest.Probably #12313 is indeed necessary to make parents reclaimable.",
    "created_at": "2013-02-05T22:12:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167041",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:8" align="right">comment:8</div>

patchbot seems unhappy about the doctest.Probably #12313 is indeed necessary to make parents reclaimable.



---

archive/issue_comments_167042.json:
```json
{
    "body": "Dependencies: **#12313**",
    "created_at": "2013-02-05T22:12:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167042",
    "user": "https://github.com/nbruin"
}
```

Dependencies: **#12313**



---

archive/issue_comments_167043.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nStating in the ticket description what patches are to apply. Admittedly I didn't test yet whether the doctest patch applies after Robert's new patch. But the test patch is needed, I think.\n\nApply 14058-weak-binop-morphisms.patch and trac_14058-doctest.patch trac_14058-doctest.patch",
    "created_at": "2013-02-06T07:26:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167043",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:9" align="right">comment:9</div>

Stating in the ticket description what patches are to apply. Admittedly I didn't test yet whether the doctest patch applies after Robert's new patch. But the test patch is needed, I think.

Apply 14058-weak-binop-morphisms.patch and trac_14058-doctest.patch trac_14058-doctest.patch



---

archive/issue_comments_167044.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,3 +1,8 @@\n R(1) + S(1) caches a strong reference to both R and S, which we'd like to avoid. \n \n See discussion at https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ozhIHIwQ4WA\n+\n+__APPLY__\n+\n+* [14058-weak-binop-morphisms.patch and trac_14058-doctest.patch]\n+* [trac_14058-doctest.patch]\n``````\n",
    "created_at": "2013-02-06T07:26:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167044",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,3 +1,8 @@
 R(1) + S(1) caches a strong reference to both R and S, which we'd like to avoid. 
 
 See discussion at https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ozhIHIwQ4WA
+
+__APPLY__
+
+* [14058-weak-binop-morphisms.patch and trac_14058-doctest.patch]
+* [trac_14058-doctest.patch]
``````




---

archive/issue_comments_167045.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,5 +4,5 @@\n \n __APPLY__\n \n-* [14058-weak-binop-morphisms.patch and trac_14058-doctest.patch]\n-* [trac_14058-doctest.patch]\n+* [and trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)\n+* [attachment: trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)\n``````\n",
    "created_at": "2013-02-06T07:26:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167045",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,5 +4,5 @@
 
 __APPLY__
 
-* [14058-weak-binop-morphisms.patch and trac_14058-doctest.patch]
-* [trac_14058-doctest.patch]
+* [and trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)
+* [attachment: trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)
``````




---

archive/issue_comments_167046.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nThe patches apply, and at least the new test passes. So, this together with #12313, does fix another leak.",
    "created_at": "2013-02-06T13:45:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167046",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:11" align="right">comment:11</div>

The patches apply, and at least the new test passes. So, this together with #12313, does fix another leak.



---

archive/issue_comments_167047.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -4,5 +4,5 @@\n \n __APPLY__\n \n-* [and trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)\n+* [attachment: 14058-weak-binop-morphisms.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)\n * [attachment: trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)\n``````\n",
    "created_at": "2013-02-06T13:50:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167047",
    "user": "https://github.com/simon-king-jena"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -4,5 +4,5 @@
 
 __APPLY__
 
-* [and trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)
+* [attachment: 14058-weak-binop-morphisms.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)
 * [attachment: trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)
``````




---

archive/issue_comments_167048.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nIn vanilla Sage, the coercion model stores (coercion) morphisms in its cache (which was a `TripleDict`, hence, with weak keys), and the only change introduced by your patch is to store weak references to the (coercion) morphism instead. Did I understand this correctly?\n\nIn vanilla Sage, the coercion model kept a strong reference to the morphism, which kept a strong reference to domain and codomain, which were thus not reclaimable, and so the item of the `TripleDict` has eternal life, in spite of the weak keys. Correct?\n\nWith the patch, the coercion model keeps a weak reference to the coercion morphism, hence, the strong reference from the morphism to domain and codomain doesn't matter, and thus the item of the `TripleDict` may disappear.\n\nBut how is the morphism kept alive? The coercion model only has a weak reference to it. Do I understand correctly that the morphism involved in the binary operation is, at the same time, stored in the coerce dict of its codomain? That's why it does not immediately die?\n\nIn other words, do I understand that the layout is as follows? We have parents A and B, and want to apply some binary operator, with a result in the parent C (C may coincide with either A or B). And we have maps r_A and r_B from A or B to C.\n\nBoth r_A and r_B are stored with a strong reference in a cache located in C, with weak keys A and B. At the same time, they are stored with a weak reference in the coercion model, again with weak keys A and B. r_A has strong references to C and to A, r_B has strong references to C and to B.\n\nWhat do we want? Do we want that keeping C alive makes A and B survive? Or do we want that keeping both A and B alive makes C survive?\n\nIf the user has a strong reference to C, then C has a strong reference to r_A and r_B (in its coerce cache), and r_A/r_B strongly refers to A/B. Hence, the existence of C keeps A and B alive. Since C is a complicated object, it is more likely to be mortal, hence, probably it is not much of a problem.\n\nIf the user has a strong reference to both A and B, then C keeps a strong reference to both r_A and r_B, and the coercion model keeps a weak reference to r_A and r_B. Moreover, r_A and r_B strongly refer to C.\n\nHowever, isn't it just a reference cycle between C and r_A/r_B? It would not prevent C from becoming collectable, right?\n\nI doubt that we want that. It is not desirable that, when adding elements of `ZZ['x']` and QQ, the ring `QQ['x']` is created repeatedly (OK, polynomial rings have a strong cache anyway. But you see what I mean).\n\nOr did I misunderstand something?",
    "created_at": "2013-02-06T14:47:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167048",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:13" align="right">comment:13</div>

In vanilla Sage, the coercion model stores (coercion) morphisms in its cache (which was a `TripleDict`, hence, with weak keys), and the only change introduced by your patch is to store weak references to the (coercion) morphism instead. Did I understand this correctly?

In vanilla Sage, the coercion model kept a strong reference to the morphism, which kept a strong reference to domain and codomain, which were thus not reclaimable, and so the item of the `TripleDict` has eternal life, in spite of the weak keys. Correct?

With the patch, the coercion model keeps a weak reference to the coercion morphism, hence, the strong reference from the morphism to domain and codomain doesn't matter, and thus the item of the `TripleDict` may disappear.

But how is the morphism kept alive? The coercion model only has a weak reference to it. Do I understand correctly that the morphism involved in the binary operation is, at the same time, stored in the coerce dict of its codomain? That's why it does not immediately die?

In other words, do I understand that the layout is as follows? We have parents A and B, and want to apply some binary operator, with a result in the parent C (C may coincide with either A or B). And we have maps r_A and r_B from A or B to C.

Both r_A and r_B are stored with a strong reference in a cache located in C, with weak keys A and B. At the same time, they are stored with a weak reference in the coercion model, again with weak keys A and B. r_A has strong references to C and to A, r_B has strong references to C and to B.

What do we want? Do we want that keeping C alive makes A and B survive? Or do we want that keeping both A and B alive makes C survive?

If the user has a strong reference to C, then C has a strong reference to r_A and r_B (in its coerce cache), and r_A/r_B strongly refers to A/B. Hence, the existence of C keeps A and B alive. Since C is a complicated object, it is more likely to be mortal, hence, probably it is not much of a problem.

If the user has a strong reference to both A and B, then C keeps a strong reference to both r_A and r_B, and the coercion model keeps a weak reference to r_A and r_B. Moreover, r_A and r_B strongly refer to C.

However, isn't it just a reference cycle between C and r_A/r_B? It would not prevent C from becoming collectable, right?

I doubt that we want that. It is not desirable that, when adding elements of `ZZ['x']` and QQ, the ring `QQ['x']` is created repeatedly (OK, polynomial rings have a strong cache anyway. But you see what I mean).

Or did I misunderstand something?



---

archive/issue_comments_167049.json:
```json
{
    "body": "An example that shows that the current patch needs work",
    "created_at": "2013-02-06T15:59:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167049",
    "user": "https://github.com/simon-king-jena"
}
```

An example that shows that the current patch needs work



---

archive/issue_comments_167050.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nAttachment: **[testcoercion.py.gz](https://github.com/sagemath/sage/files/ticket14058/testcoercion.py.gz)**\n\n> I doubt that we want that. It is not desirable that, when adding elements of `ZZ['x']` and QQ, the ring `QQ['x']` is created repeatedly (OK, polynomial rings have a strong cache anyway. But you see what I mean).\n\nIn my opinion, that is exactly what we want, or at least what we have to settle for. If a person wants to work efficiently with `QQ['x']` he should ensure his elements already live there. Adding elements with the same parents is orders of magnitude faster than relying on coercion. A step closer is ensure that your parent remains in memory. I suspect that usually that will be the case, because if a user creates elements somewhere regularly he probably\n\nIn this scenario:\n\n```\nP=[ZZ['x%d'%i] for i in [1..1000]]\nF=[GF(p) for p in prime_range(1000)]\nfor Zxi in P:\n    for k in F:\n        a=P.0\n        b=F(1)\n        c=a+b\n```\nIf we keep the `GF(p)[xi]` alive because at some point we constructed an element in it from parents that are still around, we've just created quadratic memory requirements where linear should be enough.\n\nI don't think that we can afford to assume that just because a user has combined two parents he/she will do so again in the future. We may be able to afford doing so if it happened *recently*, but that really is an optimisation, and currently I don't see a hook where we can do this efficiently.\n\nA limited length buffer that gets updated whenever a certain component sees a parent go by might work. In Coercion *discovery* perhaps? That's already slow and it would exactly protect these automatically generated parents. Logically it's hard to defend but it may be OK in practice.\n\nAnother possibility is just `UniqueRepresentation_c.__cinit__`. Only when we're making a lot of parents do we care about losing them again ...\n\nThe problem with artificially keeping transient elements alive for longer is that you'll defeat the heuristics for generational garbage collection (which Python does), and we depend rather heavily on that to get rid of cyclic garbage. Testing would be required to see if this is indeed a problem, and it will be very application-dependent.",
    "created_at": "2013-02-06T15:59:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167050",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:14" align="right">comment:14</div>

Attachment: **[testcoercion.py.gz](https://github.com/sagemath/sage/files/ticket14058/testcoercion.py.gz)**

> I doubt that we want that. It is not desirable that, when adding elements of `ZZ['x']` and QQ, the ring `QQ['x']` is created repeatedly (OK, polynomial rings have a strong cache anyway. But you see what I mean).

In my opinion, that is exactly what we want, or at least what we have to settle for. If a person wants to work efficiently with `QQ['x']` he should ensure his elements already live there. Adding elements with the same parents is orders of magnitude faster than relying on coercion. A step closer is ensure that your parent remains in memory. I suspect that usually that will be the case, because if a user creates elements somewhere regularly he probably

In this scenario:

```
P=[ZZ['x%d'%i] for i in [1..1000]]
F=[GF(p) for p in prime_range(1000)]
for Zxi in P:
    for k in F:
        a=P.0
        b=F(1)
        c=a+b
```
If we keep the `GF(p)[xi]` alive because at some point we constructed an element in it from parents that are still around, we've just created quadratic memory requirements where linear should be enough.

I don't think that we can afford to assume that just because a user has combined two parents he/she will do so again in the future. We may be able to afford doing so if it happened *recently*, but that really is an optimisation, and currently I don't see a hook where we can do this efficiently.

A limited length buffer that gets updated whenever a certain component sees a parent go by might work. In Coercion *discovery* perhaps? That's already slow and it would exactly protect these automatically generated parents. Logically it's hard to defend but it may be OK in practice.

Another possibility is just `UniqueRepresentation_c.__cinit__`. Only when we're making a lot of parents do we care about losing them again ...

The problem with artificially keeping transient elements alive for longer is that you'll defeat the heuristics for generational garbage collection (which Python does), and we depend rather heavily on that to get rid of cyclic garbage. Testing would be required to see if this is indeed a problem, and it will be very application-dependent.



---

archive/issue_comments_167051.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nBefore posting a reply to Nils' post, here is an example that the existence of A and B does not ensure the survival of the pushout of A and B. First, attach [attachment: testcoercion.py](https://github.com/sagemath/sage/files/ticket14058/testcoercion.py.gz) into a Sage session. Then:\n\n```\nsage: %attach /home/simon/SAGE/work/memleak/testcoercion.py\nsage: OA = A()\nsage: OB = B()\nsage: cm = sage.structure.element.get_coercion_model()\nsage: OC = cm.explain(OA,OB)\nCoercion on left operand via\n    Conversion map:\n      From: A\n      To:   C\nCoercion on right operand via\n    Conversion map:\n      From: B\n      To:   C\nArithmetic performed after coercions.\nResult lives in C\nsage: OC.is_coercion_cached(OA)\nTrue\nsage: OC.is_coercion_cached(OB)\nTrue\nsage: del OC\nsage: import gc\nsage: _ = gc.collect()\nsage: len([X for X in gc.get_objects() if isinstance(X,C)])\n0\nsage: xc = OA(1)*OB(1)\nsage: isinstance(xc.parent(),C)\nTrue\nsage: del xc\nsage: _ = gc.collect()\nsage: len([X for X in gc.get_objects() if isinstance(X,C)])\n0\n```\n\nI do believe that this is *not* desired behaviour.",
    "created_at": "2013-02-06T16:02:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167051",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:15" align="right">comment:15</div>

Before posting a reply to Nils' post, here is an example that the existence of A and B does not ensure the survival of the pushout of A and B. First, attach [attachment: testcoercion.py](https://github.com/sagemath/sage/files/ticket14058/testcoercion.py.gz) into a Sage session. Then:

```
sage: %attach /home/simon/SAGE/work/memleak/testcoercion.py
sage: OA = A()
sage: OB = B()
sage: cm = sage.structure.element.get_coercion_model()
sage: OC = cm.explain(OA,OB)
Coercion on left operand via
    Conversion map:
      From: A
      To:   C
Coercion on right operand via
    Conversion map:
      From: B
      To:   C
Arithmetic performed after coercions.
Result lives in C
sage: OC.is_coercion_cached(OA)
True
sage: OC.is_coercion_cached(OB)
True
sage: del OC
sage: import gc
sage: _ = gc.collect()
sage: len([X for X in gc.get_objects() if isinstance(X,C)])
0
sage: xc = OA(1)*OB(1)
sage: isinstance(xc.parent(),C)
True
sage: del xc
sage: _ = gc.collect()
sage: len([X for X in gc.get_objects() if isinstance(X,C)])
0
```

I do believe that this is *not* desired behaviour.



---

archive/issue_comments_167052.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nReplying to [@nbruin](#comment:14):\n> > I doubt that we want that. It is not desirable that, when adding elements of `ZZ['x']` and QQ, the ring `QQ['x']` is created repeatedly (OK, polynomial rings have a strong cache anyway. But you see what I mean).\n\n> \n> In my opinion, that is exactly what we want, or at least what we have to settle for. If a person wants to work efficiently with `QQ['x']` he should ensure his elements already live there.\n\nGranted. But it is a very typical usage to *not* explicitly convert everything into a common parent, but let the coercion model do the work. That is what the coercion model is for!\n\n>    I suspect that usually that will be the case, because if a user creates elements somewhere regularly he probably\n\nHowever, in the example that I posted above, note that multiplying `OA(1)*OB(1)` repeatedly will also create `C()` *repeatedly*, even though it is a `UniqueRepresentation` and hence (weakly, nowadays) cached!\n\nI think it is not acceptable that a multiple creation is triggered.\n\n>\n> In this scenario:\n>\n> ```\n> P=[ZZ['x%d'%i] for i in [1..1000]]\n> F=[GF(p) for p in prime_range(1000)]\n> for Zxi in P:\n>     for k in F:\n>         a=P.0\n>         b=F(1)\n>         c=a+b\n> ```\n> If we keep the `GF(p)[xi]` alive because at some point we constructed an element in it from parents that are still around, we've just created quadratic memory requirements where linear should be enough.\n\nIn your example, `GF(p)[xi]` is created exactly once, for each value of p and i. Clearly, in this situation it would not make sense to keep it alive, because it is never reused. However, I doubt that this is a typical use case.\n\n> A limited length buffer that gets updated whenever a certain component sees a parent go by might work. In Coercion *discovery* perhaps? That's already slow and it would exactly protect these automatically generated parents. Logically it's hard to defend but it may be OK in practice.\n> \n> Another possibility is just `UniqueRepresentation_c.__cinit__`. Only when we're making a lot of parents do we care about losing them again ...\n\nOK, but not all unique parent structures rely on it.",
    "created_at": "2013-02-06T16:13:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167052",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:16" align="right">comment:16</div>

Replying to [@nbruin](#comment:14):
> > I doubt that we want that. It is not desirable that, when adding elements of `ZZ['x']` and QQ, the ring `QQ['x']` is created repeatedly (OK, polynomial rings have a strong cache anyway. But you see what I mean).

> 
> In my opinion, that is exactly what we want, or at least what we have to settle for. If a person wants to work efficiently with `QQ['x']` he should ensure his elements already live there.

Granted. But it is a very typical usage to *not* explicitly convert everything into a common parent, but let the coercion model do the work. That is what the coercion model is for!

>    I suspect that usually that will be the case, because if a user creates elements somewhere regularly he probably

However, in the example that I posted above, note that multiplying `OA(1)*OB(1)` repeatedly will also create `C()` *repeatedly*, even though it is a `UniqueRepresentation` and hence (weakly, nowadays) cached!

I think it is not acceptable that a multiple creation is triggered.

>
> In this scenario:
>
> ```
> P=[ZZ['x%d'%i] for i in [1..1000]]
> F=[GF(p) for p in prime_range(1000)]
> for Zxi in P:
>     for k in F:
>         a=P.0
>         b=F(1)
>         c=a+b
> ```
> If we keep the `GF(p)[xi]` alive because at some point we constructed an element in it from parents that are still around, we've just created quadratic memory requirements where linear should be enough.

In your example, `GF(p)[xi]` is created exactly once, for each value of p and i. Clearly, in this situation it would not make sense to keep it alive, because it is never reused. However, I doubt that this is a typical use case.

> A limited length buffer that gets updated whenever a certain component sees a parent go by might work. In Coercion *discovery* perhaps? That's already slow and it would exactly protect these automatically generated parents. Logically it's hard to defend but it may be OK in practice.
> 
> Another possibility is just `UniqueRepresentation_c.__cinit__`. Only when we're making a lot of parents do we care about losing them again ...

OK, but not all unique parent structures rely on it.



---

archive/issue_comments_167053.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [@simon-king-jena](#comment:16):\n> I think it is not acceptable that a multiple creation is triggered.\n\n...\nWhy not? Should the user expect that doing something a second time is faster than the first, without taking special precautions?\n\n> In your example, `GF(p)[xi]` is created exactly once, for each value of p and i. Clearly, in this situation it would not make sense to keep it alive, because it is never reused. However, I doubt that this is a typical use case.\n\nBut how do you tell the difference? Against too little caching there is a simple defense: keep a reference yourself. Against too much caching there is nothing you can do. You just run out of memory because data structures outside your control blow up.\n\nWe clearly have too much caching presently, in some cases by design. I think we first need a design that's fairly clean and for which we can reliably reason there's not \"too much\" caching (changing the order of memory requirement is definitely \"too much\" for me). Next step is tweaking it, possibly with MRU queues (which in that case should really be investigated for interfering with efficient GC, which is based on \"objects either live very short or very long\", so artificially creating objects with a medium lifespan is bad)",
    "created_at": "2013-02-06T16:33:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167053",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [@simon-king-jena](#comment:16):
> I think it is not acceptable that a multiple creation is triggered.

...
Why not? Should the user expect that doing something a second time is faster than the first, without taking special precautions?

> In your example, `GF(p)[xi]` is created exactly once, for each value of p and i. Clearly, in this situation it would not make sense to keep it alive, because it is never reused. However, I doubt that this is a typical use case.

But how do you tell the difference? Against too little caching there is a simple defense: keep a reference yourself. Against too much caching there is nothing you can do. You just run out of memory because data structures outside your control blow up.

We clearly have too much caching presently, in some cases by design. I think we first need a design that's fairly clean and for which we can reliably reason there's not "too much" caching (changing the order of memory requirement is definitely "too much" for me). Next step is tweaking it, possibly with MRU queues (which in that case should really be investigated for interfering with efficient GC, which is based on "objects either live very short or very long", so artificially creating objects with a medium lifespan is bad)



---

archive/issue_comments_167054.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nBy the way, it seems that the \"insufficient\" caching (not enough to keep C() alive) has no influence on performance, at least not if computations are done in a close cycle:\n\n```\nsage: %attach /home/simon/SAGE/work/memleak/testcoercion.py\nsage: OA = A()\nsage: OB = B()\nsage: a = OA(1)\nsage: b = OB(1)\nsage: def test(x,y):\n....:     for _ in xrange(2*10^5):\n....:         z = x*y\n....:         \nsage: %time test(a,a)\nCPU times: user 4.49 s, sys: 0.00 s, total: 4.49 s\nWall time: 4.49 s\nsage: %time test(a,b)\nCPU times: user 8.99 s, sys: 0.11 s, total: 9.11 s\nWall time: 9.13 s\nsage: c = a*b\nsage: print c.parent()\nC\nsage: %time test(a,b)\nCPU times: user 8.85 s, sys: 0.03 s, total: 8.88 s\nWall time: 8.89 s\n```\n\nIn the first run of test(a,b), there is the possibility that `parent(a*b)` becomes created repeatedly, as I have demonstrated above. In the second run, `parent(a*b)` is kept alive, by keeping a pointer to the result of `a*b`. There is no significant difference in performance. Of course, we also see that multiplication within one parent is faster.\n\nIs there a way to get the patchbots report significant regressions in some examples? Because I am sure that some parts of Sage (schemes and combinat are typical candidates) rely on a strong coercion cache.",
    "created_at": "2013-02-06T17:10:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167054",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:18" align="right">comment:18</div>

By the way, it seems that the "insufficient" caching (not enough to keep C() alive) has no influence on performance, at least not if computations are done in a close cycle:

```
sage: %attach /home/simon/SAGE/work/memleak/testcoercion.py
sage: OA = A()
sage: OB = B()
sage: a = OA(1)
sage: b = OB(1)
sage: def test(x,y):
....:     for _ in xrange(2*10^5):
....:         z = x*y
....:         
sage: %time test(a,a)
CPU times: user 4.49 s, sys: 0.00 s, total: 4.49 s
Wall time: 4.49 s
sage: %time test(a,b)
CPU times: user 8.99 s, sys: 0.11 s, total: 9.11 s
Wall time: 9.13 s
sage: c = a*b
sage: print c.parent()
C
sage: %time test(a,b)
CPU times: user 8.85 s, sys: 0.03 s, total: 8.88 s
Wall time: 8.89 s
```

In the first run of test(a,b), there is the possibility that `parent(a*b)` becomes created repeatedly, as I have demonstrated above. In the second run, `parent(a*b)` is kept alive, by keeping a pointer to the result of `a*b`. There is no significant difference in performance. Of course, we also see that multiplication within one parent is faster.

Is there a way to get the patchbots report significant regressions in some examples? Because I am sure that some parts of Sage (schemes and combinat are typical candidates) rely on a strong coercion cache.



---

archive/issue_comments_167055.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nReplying to [@simon-king-jena](#comment:18):\n> By the way, it seems that the \"insufficient\" caching (not enough to keep C() alive) has no influence on performance, at least not if computations are done in a close cycle:\n\nAh right, because `C._coerce_from_hash[A]._codomain is C`, there's a cycle involving C so instead of getting deleted eagerly by Python's refcounting, it's only done with (relatively infrequent) GCs. So it even comes with a trick to improve this free \"caching\": Increase the interval for garbage collection. See `gc.get_threshold` and `gc.set_threshold`. By tweaking those numbers you can probably manipulate the running times in these examples.\n\n**NOTE:** Doesn't `timeit` turn garbage collection off? So that may be a misleading tool for investigating performance for these things.",
    "created_at": "2013-02-06T17:45:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167055",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:19" align="right">comment:19</div>

Replying to [@simon-king-jena](#comment:18):
> By the way, it seems that the "insufficient" caching (not enough to keep C() alive) has no influence on performance, at least not if computations are done in a close cycle:

Ah right, because `C._coerce_from_hash[A]._codomain is C`, there's a cycle involving C so instead of getting deleted eagerly by Python's refcounting, it's only done with (relatively infrequent) GCs. So it even comes with a trick to improve this free "caching": Increase the interval for garbage collection. See `gc.get_threshold` and `gc.set_threshold`. By tweaking those numbers you can probably manipulate the running times in these examples.

**NOTE:** Doesn't `timeit` turn garbage collection off? So that may be a misleading tool for investigating performance for these things.



---

archive/issue_comments_167056.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nI think it makes sense to ask [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/7FCHou9nkIg) whether it is better to fix this leak or not.\n\nI believe that keeping A and B alive should prevent C from garbage collection. In contrast, keeping C alive should *not* prevent A and B from garbage collection. Currently, it is the other way around. Perhaps we should try to think through whether having a weak reference to the domain of coercion or conversion maps would work.",
    "created_at": "2013-02-06T19:01:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167056",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:20" align="right">comment:20</div>

I think it makes sense to ask [sage-devel](https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/7FCHou9nkIg) whether it is better to fix this leak or not.

I believe that keeping A and B alive should prevent C from garbage collection. In contrast, keeping C alive should *not* prevent A and B from garbage collection. Currently, it is the other way around. Perhaps we should try to think through whether having a weak reference to the domain of coercion or conversion maps would work.



---

archive/issue_comments_167057.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\n+1 to taking this discussion to sage-devel.\n\nPatchbot: apply 14058-weak-binop-morphisms.patch trac_14058-doctest.patch",
    "created_at": "2013-02-06T19:57:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167057",
    "user": "https://github.com/robertwb"
}
```

<div id="comment:21" align="right">comment:21</div>

+1 to taking this discussion to sage-devel.

Patchbot: apply 14058-weak-binop-morphisms.patch trac_14058-doctest.patch



---

archive/issue_comments_167058.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nThe patchbot only reports one error, namely\n\n```\nFile \"/home/patchbot/sage-5.7.beta3/devel/sage-14058/sage/rings/number_field/number_field_ideal.py\", line 118:\n    sage: convert_to_idealprimedec_form(K, P)\nException raised:\n    Traceback (most recent call last):\n      File \"/home/patchbot/sage-5.7.beta3/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/patchbot/sage-5.7.beta3/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/patchbot/sage-5.7.beta3/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_2[5]>\", line 1, in <module>\n        convert_to_idealprimedec_form(K, P)###line 118:\n    sage: convert_to_idealprimedec_form(K, P)\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py\", line 124, in convert_to_idealprimedec_form\n        K_bnf = gp(field.pari_bnf())\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py\", line 201, in __call__\n        return self._coerce_from_special_method(x)\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py\", line 227, in _coerce_from_special_method\n        return (x.__getattribute__(s))(self)\n      File \"sage_object.pyx\", line 485, in sage.structure.sage_object.SageObject._gp_ (sage/structure/sage_object.c:4804)\n      File \"sage_object.pyx\", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/gp.py\", line 511, in set\n        raise TypeError, \"Error executing code in GP:\\nCODE:\\n\\t%s\\nPARI/GP ERROR:\\n%s\"%(cmd, out)\n    TypeError: Error executing code in GP:\n    CODE:\n    \tsage[14]=[[;], matrix(0,7), [;], Mat([0.E-38 + 3.52184386028273*I, 0.E-37 + 3.70366245659542*I, 0.E-37 + 2.91167081258838*I, 0.E-38 + 3.14159265358979*I, 0.E-38 + 9.04452675407645*I, 0.E-37 + 8.86270815776375*I, 0.E-37 + 9.65469980177079*I]), [[7, [-1, 2]~, 1, 1, [3, -2; 2, 1]], [13, [-5, 2]~, 1, 1, [-6, -2; 2, -8]], [19, [-3, 2]~, 1, 1, [5, -2; 2, 3]], [3, [1, 2]~, 2, 1, [1, 1; -1, 2]], [7, [3, 2]~, 1, 1, [-1, -2; 2, -3]], [13, [7, 2]~, 1, 1, [-5, -2; 2, -7]], [19, [5, 2]~, 1, 1, [-3, -2; 2, -5]]], 0, [y^2 + 3, [0, 1], -3, 2, [Mat([1, -0.500000000000000 - 0.866025403784439*I]), [1, -1.36602540378444; 1, 0.366025403784439], [1, -1; 1, 0], [2, -1; -1, -1], [3, 2; 0, 1], [1, -1; -1, -2], [3, [2, -1; 1, 1]]], [0.E-38 - 1.73205080756888*I], [1, 1/2*y - 1/2], [1, 1; 0, 2], [1, 0, 0, -1; 0, 1, 1, -1]], [[1, [], []], 1, 1, [6, -1/2*y + 1/2], []], [[;], [], []], [0, []]];\n    PARI/GP ERROR:\n      ***   at top-level: sage[14]=[[;],matrix(0,7\n      ***                     ^--------------------\n      ***   _[_]: not a vector.\n  ***   Warning: precision too low for generators, not given.\n```\nThat's obscure to me. What does it mean?",
    "created_at": "2013-02-07T12:21:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167058",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:22" align="right">comment:22</div>

The patchbot only reports one error, namely

```
File "/home/patchbot/sage-5.7.beta3/devel/sage-14058/sage/rings/number_field/number_field_ideal.py", line 118:
    sage: convert_to_idealprimedec_form(K, P)
Exception raised:
    Traceback (most recent call last):
      File "/home/patchbot/sage-5.7.beta3/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/patchbot/sage-5.7.beta3/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/patchbot/sage-5.7.beta3/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_2[5]>", line 1, in <module>
        convert_to_idealprimedec_form(K, P)###line 118:
    sage: convert_to_idealprimedec_form(K, P)
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/rings/number_field/number_field_ideal.py", line 124, in convert_to_idealprimedec_form
        K_bnf = gp(field.pari_bnf())
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py", line 201, in __call__
        return self._coerce_from_special_method(x)
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py", line 227, in _coerce_from_special_method
        return (x.__getattribute__(s))(self)
      File "sage_object.pyx", line 485, in sage.structure.sage_object.SageObject._gp_ (sage/structure/sage_object.c:4804)
      File "sage_object.pyx", line 450, in sage.structure.sage_object.SageObject._interface_ (sage/structure/sage_object.c:4144)
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/patchbot/sage-5.7.beta3/local/lib/python/site-packages/sage/interfaces/gp.py", line 511, in set
        raise TypeError, "Error executing code in GP:\nCODE:\n\t%s\nPARI/GP ERROR:\n%s"%(cmd, out)
    TypeError: Error executing code in GP:
    CODE:
    	sage[14]=[[;], matrix(0,7), [;], Mat([0.E-38 + 3.52184386028273*I, 0.E-37 + 3.70366245659542*I, 0.E-37 + 2.91167081258838*I, 0.E-38 + 3.14159265358979*I, 0.E-38 + 9.04452675407645*I, 0.E-37 + 8.86270815776375*I, 0.E-37 + 9.65469980177079*I]), [[7, [-1, 2]~, 1, 1, [3, -2; 2, 1]], [13, [-5, 2]~, 1, 1, [-6, -2; 2, -8]], [19, [-3, 2]~, 1, 1, [5, -2; 2, 3]], [3, [1, 2]~, 2, 1, [1, 1; -1, 2]], [7, [3, 2]~, 1, 1, [-1, -2; 2, -3]], [13, [7, 2]~, 1, 1, [-5, -2; 2, -7]], [19, [5, 2]~, 1, 1, [-3, -2; 2, -5]]], 0, [y^2 + 3, [0, 1], -3, 2, [Mat([1, -0.500000000000000 - 0.866025403784439*I]), [1, -1.36602540378444; 1, 0.366025403784439], [1, -1; 1, 0], [2, -1; -1, -1], [3, 2; 0, 1], [1, -1; -1, -2], [3, [2, -1; 1, 1]]], [0.E-38 - 1.73205080756888*I], [1, 1/2*y - 1/2], [1, 1; 0, 2], [1, 0, 0, -1; 0, 1, 1, -1]], [[1, [], []], 1, 1, [6, -1/2*y + 1/2], []], [[;], [], []], [0, []]];
    PARI/GP ERROR:
      ***   at top-level: sage[14]=[[;],matrix(0,7
      ***                     ^--------------------
      ***   _[_]: not a vector.
  ***   Warning: precision too low for generators, not given.
```
That's obscure to me. What does it mean?



---

archive/issue_comments_167059.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nUnfortunately, I get\n\n```\nsage -t  \"devel/sage-main/sage/rings/number_field/number_field_ideal.py\"\n         [21.9 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 22.0 seconds\n```\n\nSo, what happened here?\n\nIn any case, I think the example of collectable pushout should be included in the documentation, combined with a warning to keep a pointer to the pushout (or avoid cross-parent arithmetic altogether), if speed matters.\n\nI could write that. But to what location? Logically, it belongs to sage.structure.coerce, but nobody would read that. It might better be in a more general tutorial. What do you suggest?",
    "created_at": "2013-02-07T12:26:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167059",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:23" align="right">comment:23</div>

Unfortunately, I get

```
sage -t  "devel/sage-main/sage/rings/number_field/number_field_ideal.py"
         [21.9 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 22.0 seconds
```

So, what happened here?

In any case, I think the example of collectable pushout should be included in the documentation, combined with a warning to keep a pointer to the pushout (or avoid cross-parent arithmetic altogether), if speed matters.

I could write that. But to what location? Logically, it belongs to sage.structure.coerce, but nobody would read that. It might better be in a more general tutorial. What do you suggest?



---

archive/issue_comments_167060.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nI did make ptest with a highly patched debug version of sage-5.7.beta2. Hence, I have the dependencies of #13864 and additionally #9107, #12951, #13916. #12313, #14058 and #13370 applied.\n\nIn the parallel test, I got two timeouts, namely in devel/sage/doc/en/bordeaux_2008/birds_other.rst and devel/sage/sage/interfaces/maxima.py. Running the former individually is long, but fine:\n\n```\nsage -t -force_lib \"devel/sage/doc/en/bordeaux_2008/birds_other.rst\"\n         [339.8 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 339.9 seconds\n```\n\nHowever, the maxima test is suspicious. I ran it twice individually. The first time I got an evil error:\n\n```\nsage -t -force_lib \"devel/sage/sage/interfaces/maxima.py\"   \n**********************************************************************\nFile \"/home/simon/SAGE/debug/sage-5.7.beta2/devel/sage/sage/interfaces/maxima.py\", line 355:\n    sage: T.tlimit('n','inf')\nException raised:\n    Traceback (most recent call last):\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/ncadoctest.py\", line 1231, in run_one_test\n        self.run_one_example(test, example, filename, compileflags)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/sagedoctest.py\", line 38, in run_one_example\n        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/ncadoctest.py\", line 1172, in run_one_example\n        compileflags, 1) in test.globs\n      File \"<doctest __main__.example_0[77]>\", line 1, in <module>\n        T.tlimit('n','inf')###line 355:\n    sage: T.tlimit('n','inf')\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py\", line 588, in __call__\n        return self._obj.parent().function_call(self._name, [self._obj] + list(args), kwds)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py\", line 489, in function_call\n        return self.new(s)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py\", line 264, in new\n        return self(code)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py\", line 199, in __call__\n        return cls(self, x, name=name)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/maxima.py\", line 1153, in __init__\n        ExpectElement.__init__(self, parent, value, is_name=False, name=None)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/expect.py\", line 1280, in __init__\n        self._name = parent._create(value, name=name)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py\", line 389, in _create\n        self.set(name, value)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/maxima.py\", line 998, in set\n        self._eval_line(cmd)\n      File \"/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/maxima.py\", line 754, in _eval_line\n        assert line_echo.strip() == line.strip()\n    AssertionError\n**********************************************************************\n1 items had failures:\n   1 of  97 in __main__.example_0\n***Test Failed*** 1 failures.\nFor whitespace errors, see the file /home/simon/.sage//tmp/maxima_30383.py\n         [13.7 s]\n \n----------------------------------------------------------------------\nThe following tests failed:\n\n\n        sage -t -force_lib \"devel/sage/sage/interfaces/maxima.py\"\nTotal time for all tests: 13.8 seconds\n```\nand the second time I got\n\n```\nsage -t -force_lib \"devel/sage/sage/interfaces/maxima.py\"   \n         [12.6 s]\n \n----------------------------------------------------------------------\nAll tests passed!\nTotal time for all tests: 12.6 seconds\n```\n\nIs the error something we should worry about? Or is that likely to be the effect of a neutrino hitting my laptop?",
    "created_at": "2013-02-07T19:14:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167060",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:24" align="right">comment:24</div>

I did make ptest with a highly patched debug version of sage-5.7.beta2. Hence, I have the dependencies of #13864 and additionally #9107, #12951, #13916. #12313, #14058 and #13370 applied.

In the parallel test, I got two timeouts, namely in devel/sage/doc/en/bordeaux_2008/birds_other.rst and devel/sage/sage/interfaces/maxima.py. Running the former individually is long, but fine:

```
sage -t -force_lib "devel/sage/doc/en/bordeaux_2008/birds_other.rst"
         [339.8 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 339.9 seconds
```

However, the maxima test is suspicious. I ran it twice individually. The first time I got an evil error:

```
sage -t -force_lib "devel/sage/sage/interfaces/maxima.py"   
**********************************************************************
File "/home/simon/SAGE/debug/sage-5.7.beta2/devel/sage/sage/interfaces/maxima.py", line 355:
    sage: T.tlimit('n','inf')
Exception raised:
    Traceback (most recent call last):
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_0[77]>", line 1, in <module>
        T.tlimit('n','inf')###line 355:
    sage: T.tlimit('n','inf')
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py", line 588, in __call__
        return self._obj.parent().function_call(self._name, [self._obj] + list(args), kwds)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py", line 489, in function_call
        return self.new(s)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py", line 264, in new
        return self(code)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py", line 199, in __call__
        return cls(self, x, name=name)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/maxima.py", line 1153, in __init__
        ExpectElement.__init__(self, parent, value, is_name=False, name=None)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/expect.py", line 1280, in __init__
        self._name = parent._create(value, name=name)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/interface.py", line 389, in _create
        self.set(name, value)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/maxima.py", line 998, in set
        self._eval_line(cmd)
      File "/home/simon/SAGE/debug/sage-5.7.beta2/local/lib/python/site-packages/sage/interfaces/maxima.py", line 754, in _eval_line
        assert line_echo.strip() == line.strip()
    AssertionError
**********************************************************************
1 items had failures:
   1 of  97 in __main__.example_0
***Test Failed*** 1 failures.
For whitespace errors, see the file /home/simon/.sage//tmp/maxima_30383.py
         [13.7 s]
 
----------------------------------------------------------------------
The following tests failed:


        sage -t -force_lib "devel/sage/sage/interfaces/maxima.py"
Total time for all tests: 13.8 seconds
```
and the second time I got

```
sage -t -force_lib "devel/sage/sage/interfaces/maxima.py"   
         [12.6 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 12.6 seconds
```

Is the error something we should worry about? Or is that likely to be the effect of a neutrino hitting my laptop?



---

archive/issue_comments_167061.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nAt #14159, I am providing a version of `MonoDict` and `TripleDict` that optionally allows to store the values by weak references. Provided that the performance is OK, Nils Bruin suggests to consider to use this here, hence, make #14159 a dependency. What do you think?",
    "created_at": "2013-02-26T19:45:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167061",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:25" align="right">comment:25</div>

At #14159, I am providing a version of `MonoDict` and `TripleDict` that optionally allows to store the values by weak references. Provided that the performance is OK, Nils Bruin suggests to consider to use this here, hence, make #14159 a dependency. What do you think?



---

archive/issue_events_197652.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-5.11",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197652"
}
```



---

archive/issue_events_197653.json:
```json
{
    "actor": "https://github.com/jdemeyer",
    "created_at": "2013-08-13T15:35:53Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-5.12",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197653"
}
```



---

archive/issue_comments_167062.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\nNote to myself: Work on this ticket...",
    "created_at": "2013-08-15T07:23:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167062",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:27" align="right">comment:27</div>

Note to myself: Work on this ticket...



---

archive/issue_comments_167063.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\nLost track again.\n\nI tried to import the patches and turn them into git branches. It mostly worked, but I had to resolve some conflicts with the second patch.\n\nWould it be OK to change this hg-ticket into a git-ticket?",
    "created_at": "2013-11-16T23:44:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167063",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:28" align="right">comment:28</div>

Lost track again.

I tried to import the patches and turn them into git branches. It mostly worked, but I had to resolve some conflicts with the second patch.

Would it be OK to change this hg-ticket into a git-ticket?



---

archive/issue_events_197654.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-11-17T14:45:39Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197654"
}
```



---

archive/issue_events_197655.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2013-11-17T14:45:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197655"
}
```



---

archive/issue_comments_167064.json:
```json
{
    "body": "Work Issues: **Fix doctests; decide between hg and git**",
    "created_at": "2013-11-17T14:45:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167064",
    "user": "https://github.com/simon-king-jena"
}
```

Work Issues: **Fix doctests; decide between hg and git**



---

archive/issue_comments_167065.json:
```json
{
    "body": "Reviewer: **Simon King**",
    "created_at": "2013-11-17T14:45:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167065",
    "user": "https://github.com/simon-king-jena"
}
```

Reviewer: **Simon King**



---

archive/issue_comments_167066.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nWhile I had to resolve conflicts when importing the two patches into the git master branch, the patches do apply to sage-5.12.beta5, and the patchbot reports the same on sage-5.13.beta2. So, perhaps it is OK to keep this a mercurial ticket.\n\nHowever, with the gitification of the patches, I find (similar to the patchbot)\n\n```\nsage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/rings/polynomial/plural.pyx  # 17 doctests failed\nsage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/libs/singular/function.pyx  # 1 doctest failed\n```\nThe patchbot additionally finds\n\n```\nsage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/algebras/free_algebra.py  # 1 doctest failed\nsage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/structure/coerce.pyx  # 1 doctest failed\n```\nSo, this requires some work.",
    "created_at": "2013-11-17T14:45:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167066",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:29" align="right">comment:29</div>

While I had to resolve conflicts when importing the two patches into the git master branch, the patches do apply to sage-5.12.beta5, and the patchbot reports the same on sage-5.13.beta2. So, perhaps it is OK to keep this a mercurial ticket.

However, with the gitification of the patches, I find (similar to the patchbot)

```
sage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/rings/polynomial/plural.pyx  # 17 doctests failed
sage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/libs/singular/function.pyx  # 1 doctest failed
```
The patchbot additionally finds

```
sage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/algebras/free_algebra.py  # 1 doctest failed
sage -t --long /mnt/storage2TB/patchbot/Sage/sage-5.13.beta2/devel/sage/sage/structure/coerce.pyx  # 1 doctest failed
```
So, this requires some work.



---

archive/issue_events_197656.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.1",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197656"
}
```



---

archive/issue_events_197657.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197657"
}
```



---

archive/issue_events_197658.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197658"
}
```



---

archive/issue_events_197659.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-05-06T15:20:58Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197659"
}
```



---

archive/issue_events_197660.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.3",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197660"
}
```



---

archive/issue_events_197661.json:
```json
{
    "actor": "https://github.com/sagetrac-vbraun-spam",
    "created_at": "2014-08-10T16:51:03Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197661"
}
```



---

archive/issue_comments_167067.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nI plan to create a branch for it. Probably it will fix #18905.",
    "created_at": "2015-07-16T19:55:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167067",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:33" align="right">comment:33</div>

I plan to create a branch for it. Probably it will fix #18905.



---

archive/issue_comments_167068.json:
```json
{
    "body": "Branch: **[u/SimonKing/weakly_reference_binary_operation_codomains](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/weakly_reference_binary_operation_codomains)**",
    "created_at": "2015-07-16T22:39:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167068",
    "user": "https://github.com/simon-king-jena"
}
```

Branch: **[u/SimonKing/weakly_reference_binary_operation_codomains](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/weakly_reference_binary_operation_codomains)**



---

archive/issue_comments_167069.json:
```json
{
    "body": "Changed work issues from **Fix doctests; decide between hg and git** to **Fix doctests**",
    "created_at": "2015-07-16T22:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167069",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Fix doctests; decide between hg and git** to **Fix doctests**



---

archive/issue_comments_167070.json:
```json
{
    "body": "Commit: **[b9141ee](https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e)**",
    "created_at": "2015-07-16T22:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167070",
    "user": "https://github.com/simon-king-jena"
}
```

Commit: **[b9141ee](https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e)**



---

archive/issue_comments_167071.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nHere is a branch. The merge was not trivial, so, hopefully I did it well.\n\nNext, we have to see if the \"old problem\" (i.e., [attachment: testcoercion.py)](https://github.com/sagemath/sage/files/ticket14058/cb62393e06df786a5680c72687c6167c.gz) is still problematic, and of course there may be doctest failures.\n\nAt least, the issue from [comment:20](#comment:20) is solved: We do have weak references to the domain of coercion maps now.\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ac68d9b2d7624d32dc885f42bbd83d372fa8da5f\">ac68d9b</a></td><td><code>Remove strong references to parents used in binary operations in the coercion model.</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e153d0813221d3681030fbf24bbbc283d3717162\">e153d08</a></td><td><code>#14058: Add doctest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e\">b9141ee</a></td><td><code>Merge branch 'ticket/14058' into develop</code></td></tr></table>\n",
    "created_at": "2015-07-16T22:46:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167071",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:35" align="right">comment:35</div>

Here is a branch. The merge was not trivial, so, hopefully I did it well.

Next, we have to see if the "old problem" (i.e., [attachment: testcoercion.py)](https://github.com/sagemath/sage/files/ticket14058/cb62393e06df786a5680c72687c6167c.gz) is still problematic, and of course there may be doctest failures.

At least, the issue from [comment:20](#comment:20) is solved: We do have weak references to the domain of coercion maps now.

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ac68d9b2d7624d32dc885f42bbd83d372fa8da5f">ac68d9b</a></td><td><code>Remove strong references to parents used in binary operations in the coercion model.</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e153d0813221d3681030fbf24bbbc283d3717162">e153d08</a></td><td><code>#14058: Add doctest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e">b9141ee</a></td><td><code>Merge branch 'ticket/14058' into develop</code></td></tr></table>




---

archive/issue_comments_167072.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\n\n```\nsage -t src/sage/algebras/commutative_dga.py  # 3 doctests failed\nsage -t src/sage/algebras/free_algebra.py  # 1 doctest failed\nsage -t src/sage/rings/polynomial/plural.pyx  # 17 doctests failed\nsage -t src/sage/dev/sagedev.py  # 2 doctests failed\nsage -t src/sage/structure/coerce.pyx  # 2 doctests failed\nsage -t src/sage/libs/singular/function.pyx  # 2 doctests failed\n```\nNot bad (and the sagedev error very likely is because I have rerere enabled, hence, it is unrelated anyway).",
    "created_at": "2015-07-17T07:43:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167072",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:36" align="right">comment:36</div>


```
sage -t src/sage/algebras/commutative_dga.py  # 3 doctests failed
sage -t src/sage/algebras/free_algebra.py  # 1 doctest failed
sage -t src/sage/rings/polynomial/plural.pyx  # 17 doctests failed
sage -t src/sage/dev/sagedev.py  # 2 doctests failed
sage -t src/sage/structure/coerce.pyx  # 2 doctests failed
sage -t src/sage/libs/singular/function.pyx  # 2 doctests failed
```
Not bad (and the sagedev error very likely is because I have rerere enabled, hence, it is unrelated anyway).



---

archive/issue_comments_167073.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nDetails:\n\n```\nsage -t src/sage/libs/singular/function.pyx\n**********************************************************************\nFile \"src/sage/libs/singular/function.pyx\", line 413, in sage.libs.singular.function.is_singular_poly_wrapper\nFailed example:\n    H.<x,y,z> = A.g_algebra({z*x:x*z+2*x, z*y:y*z-2*y})\nExpected nothing\nGot:\n    Exception KeyError: (The ring pointer 0x7f7c7470c8d0,) in 'sage.libs.singular.ring.singular_ring_delete' ignored\n**********************************************************************\nFile \"src/sage/libs/singular/function.pyx\", line 1250, in sage.libs.singular.function.SingularFunction.__call__\nFailed example:\n    I = Ideal(I.groebner_basis())\nExpected nothing\nGot:\n    Exception KeyError: (The ring pointer 0x7f7c7470ca40,) in 'sage.libs.singular.ring.singular_ring_delete' ignored\n**********************************************************************\n```\n--> It seems that the cache became too weak. All errors in `sage -t src/sage/rings/polynomial/plural.pyx` and `sage -t src/sage/algebras/commutative_dga.py` are of that form.\n\n```\nsage -t src/sage/structure/coerce.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 418, in sage.structure.coerce.CoercionModel_cache_maps.get_cache\nFailed example:\n    print copy(left_morphism_ref())\nException raised:\n    Traceback (most recent call last):\n      File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.structure.coerce.CoercionModel_cache_maps.get_cache[4]>\", line 1, in <module>\n        print copy(left_morphism_ref())\n    NameError: name 'left_morphism_ref' is not defined\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 422, in sage.structure.coerce.CoercionModel_cache_maps.get_cache\nFailed example:\n    print right_morphism_ref\nException raised:\n    Traceback (most recent call last):\n      File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 496, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 858, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.structure.coerce.CoercionModel_cache_maps.get_cache[5]>\", line 1, in <module>\n        print right_morphism_ref\n    NameError: name 'right_morphism_ref' is not defined\n**********************************************************************\n```\n--> I got something wrong in my merge.\n\nSo, we actually just have two errors.",
    "created_at": "2015-07-17T08:06:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167073",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:37" align="right">comment:37</div>

Details:

```
sage -t src/sage/libs/singular/function.pyx
**********************************************************************
File "src/sage/libs/singular/function.pyx", line 413, in sage.libs.singular.function.is_singular_poly_wrapper
Failed example:
    H.<x,y,z> = A.g_algebra({z*x:x*z+2*x, z*y:y*z-2*y})
Expected nothing
Got:
    Exception KeyError: (The ring pointer 0x7f7c7470c8d0,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
**********************************************************************
File "src/sage/libs/singular/function.pyx", line 1250, in sage.libs.singular.function.SingularFunction.__call__
Failed example:
    I = Ideal(I.groebner_basis())
Expected nothing
Got:
    Exception KeyError: (The ring pointer 0x7f7c7470ca40,) in 'sage.libs.singular.ring.singular_ring_delete' ignored
**********************************************************************
```
--> It seems that the cache became too weak. All errors in `sage -t src/sage/rings/polynomial/plural.pyx` and `sage -t src/sage/algebras/commutative_dga.py` are of that form.

```
sage -t src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 418, in sage.structure.coerce.CoercionModel_cache_maps.get_cache
Failed example:
    print copy(left_morphism_ref())
Exception raised:
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.coerce.CoercionModel_cache_maps.get_cache[4]>", line 1, in <module>
        print copy(left_morphism_ref())
    NameError: name 'left_morphism_ref' is not defined
**********************************************************************
File "src/sage/structure/coerce.pyx", line 422, in sage.structure.coerce.CoercionModel_cache_maps.get_cache
Failed example:
    print right_morphism_ref
Exception raised:
    Traceback (most recent call last):
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 496, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/king/Sage/git/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 858, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.coerce.CoercionModel_cache_maps.get_cache[5]>", line 1, in <module>
        print right_morphism_ref
    NameError: name 'right_morphism_ref' is not defined
**********************************************************************
```
--> I got something wrong in my merge.

So, we actually just have two errors.



---

archive/issue_comments_167074.json:
```json
{
    "body": "Changed commit from **[b9141ee](https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e)** to **[90ed181](https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916)**",
    "created_at": "2015-07-17T15:29:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167074",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b9141ee](https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e)** to **[90ed181](https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916)**



---

archive/issue_comments_167075.json:
```json
{
    "body": "<div id=\"comment:38\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916\">90ed181</a></td><td><code>Trivial fix for a coercion doctest</code></td></tr></table>\n",
    "created_at": "2015-07-17T15:29:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167075",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:38"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916">90ed181</a></td><td><code>Trivial fix for a coercion doctest</code></td></tr></table>




---

archive/issue_comments_167076.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\n#13447 is probably related. Perhaps (if we can finish the work here) #13447 can eventually be closed as a duplicate.",
    "created_at": "2015-07-17T21:46:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167076",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:39" align="right">comment:39</div>

#13447 is probably related. Perhaps (if we can finish the work here) #13447 can eventually be closed as a duplicate.



---

archive/issue_comments_167077.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nIn the following example\n\n```\n            sage: import gc\n            sage: from sage.rings.polynomial.plural import NCPolynomialRing_plural\n            sage: from sage.algebras.free_algebra import FreeAlgebra\n            sage: A1.<x,y,z> = FreeAlgebra(QQ, 3)\n            sage: R1 = A1.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))\n            sage: A2.<x,y,z> = FreeAlgebra(GF(5), 3)\n            sage: R2 = A2.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))\n            sage: A3.<x,y,z> = FreeAlgebra(GF(11), 3)\n            sage: R3 = A3.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))\n            sage: A4.<x,y,z> = FreeAlgebra(GF(13), 3)\n            sage: R4 = A4.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))\n            sage: _ = gc.collect()\n            sage: foo = R1.gen(0)\n            sage: del foo\n            sage: del R1\n            sage: _ = gc.collect()\n            sage: del R2\n            sage: _ = gc.collect()\n            sage: del R3\n            sage: _ = gc.collect()\n```\nthe reference counting goes wrong after each `gc.collect()`.",
    "created_at": "2015-07-17T21:52:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167077",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:40" align="right">comment:40</div>

In the following example

```
            sage: import gc
            sage: from sage.rings.polynomial.plural import NCPolynomialRing_plural
            sage: from sage.algebras.free_algebra import FreeAlgebra
            sage: A1.<x,y,z> = FreeAlgebra(QQ, 3)
            sage: R1 = A1.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))
            sage: A2.<x,y,z> = FreeAlgebra(GF(5), 3)
            sage: R2 = A2.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))
            sage: A3.<x,y,z> = FreeAlgebra(GF(11), 3)
            sage: R3 = A3.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))
            sage: A4.<x,y,z> = FreeAlgebra(GF(13), 3)
            sage: R4 = A4.g_algebra({y*x:x*y-z, z*x:x*z+2*x, z*y:y*z-2*y}, order=TermOrder('degrevlex', 2))
            sage: _ = gc.collect()
            sage: foo = R1.gen(0)
            sage: del foo
            sage: del R1
            sage: _ = gc.collect()
            sage: del R2
            sage: _ = gc.collect()
            sage: del R3
            sage: _ = gc.collect()
```
the reference counting goes wrong after each `gc.collect()`.



---

archive/issue_comments_167078.json:
```json
{
    "body": "Changed commit from **[90ed181](https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916)** to **[64b572c](https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58)**",
    "created_at": "2015-07-17T22:38:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167078",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[90ed181](https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916)** to **[64b572c](https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58)**



---

archive/issue_comments_167079.json:
```json
{
    "body": "<div id=\"comment:41\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58\">64b572c</a></td><td><code>refcount libsingular rings used in plural</code></td></tr></table>\n",
    "created_at": "2015-07-17T22:38:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167079",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:41"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58">64b572c</a></td><td><code>refcount libsingular rings used in plural</code></td></tr></table>




---

archive/issue_comments_167080.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nGot it! When a non-commutative ring is created, it was forgotten to put the underlying libsingular ring into Sage's refcounting system. Should be fixed now. I'll see if #13447 is fixed now, too.",
    "created_at": "2015-07-17T22:40:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167080",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:42" align="right">comment:42</div>

Got it! When a non-commutative ring is created, it was forgotten to put the underlying libsingular ring into Sage's refcounting system. Should be fixed now. I'll see if #13447 is fixed now, too.



---

archive/issue_comments_167081.json:
```json
{
    "body": "Changed work issues from **Fix doctests** to none",
    "created_at": "2015-07-17T22:50:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167081",
    "user": "https://github.com/simon-king-jena"
}
```

Changed work issues from **Fix doctests** to none



---

archive/issue_comments_167082.json:
```json
{
    "body": "Changed author from **Robert Bradshaw** to **Robert Bradshaw, Nils Bruin**",
    "created_at": "2015-07-17T22:50:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167082",
    "user": "https://github.com/simon-king-jena"
}
```

Changed author from **Robert Bradshaw** to **Robert Bradshaw, Nils Bruin**



---

archive/issue_events_197662.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-07-17T22:50:36Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197662"
}
```



---

archive/issue_events_197663.json:
```json
{
    "actor": "https://github.com/simon-king-jena",
    "created_at": "2015-07-17T22:50:36Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197663"
}
```



---

archive/issue_comments_167083.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nSigh. #13447 is not fixed, as the following example shows.\n\n```\nsage: import gc\nsage: _ = gc.collect()\nsage: from sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular\nsage: from sage.libs.singular.groebner_strategy import GroebnerStrategy\nsage: n = len([x for x in gc.get_objects() if isinstance(x,MPolynomialRing_libsingular)])\nsage: P = MPolynomialRing_libsingular(GF(541), 2, ('x', 'y'), TermOrder('degrevlex', 2))\nsage: strat = GroebnerStrategy(Ideal([P.gen(0) + P.gen(1)]))\nsage: del strat\nsage: del P\nsage: _ = gc.collect()\nsage: n == len([x for x in gc.get_objects() if isinstance(x,MPolynomialRing_libsingular)])\nFalse\n```\n\nI'd suggest to proceed as follows. Provided that all tests pass, I can review Robert's and Nils' patches, someone else reviews my additions (which are the merging and the latest commit), and then we make this a dependency for #13447.",
    "created_at": "2015-07-17T22:50:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167083",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:43" align="right">comment:43</div>

Sigh. #13447 is not fixed, as the following example shows.

```
sage: import gc
sage: _ = gc.collect()
sage: from sage.rings.polynomial.multi_polynomial_libsingular import MPolynomialRing_libsingular
sage: from sage.libs.singular.groebner_strategy import GroebnerStrategy
sage: n = len([x for x in gc.get_objects() if isinstance(x,MPolynomialRing_libsingular)])
sage: P = MPolynomialRing_libsingular(GF(541), 2, ('x', 'y'), TermOrder('degrevlex', 2))
sage: strat = GroebnerStrategy(Ideal([P.gen(0) + P.gen(1)]))
sage: del strat
sage: del P
sage: _ = gc.collect()
sage: n == len([x for x in gc.get_objects() if isinstance(x,MPolynomialRing_libsingular)])
False
```

I'd suggest to proceed as follows. Provided that all tests pass, I can review Robert's and Nils' patches, someone else reviews my additions (which are the merging and the latest commit), and then we make this a dependency for #13447.



---

archive/issue_comments_167084.json:
```json
{
    "body": "Changed commit from **[64b572c](https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58)** to **[9793dbc](https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d)**",
    "created_at": "2015-07-18T06:18:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167084",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[64b572c](https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58)** to **[9793dbc](https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d)**



---

archive/issue_comments_167085.json:
```json
{
    "body": "<div id=\"comment:44\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d\">9793dbc</a></td><td><code>Make one test more stable</code></td></tr></table>\n",
    "created_at": "2015-07-18T06:18:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167085",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:44"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d">9793dbc</a></td><td><code>Make one test more stable</code></td></tr></table>




---

archive/issue_comments_167086.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\nSometimes, the following test in sage/categories/fields.py has failed:\n\n```\n            sage: import gc\n            sage: _ = gc.collect()\n            sage: n = len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)])\n            sage: for i in prime_range(100):\n            ....:     R = ZZ.quotient(i)\n            ....:     t = R in Fields()\n            sage: _ = gc.collect()\n            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n\n            1\n```\nThe reason for the failure: Sometimes the last line gave 0, not 1. It is not totally clear to me why the different results occurred. But in fact 0 is better than 1 here (one additional ring got collected). So, I hope my change is OK.",
    "created_at": "2015-07-18T06:26:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167086",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:45" align="right">comment:45</div>

Sometimes, the following test in sage/categories/fields.py has failed:

```
            sage: import gc
            sage: _ = gc.collect()
            sage: n = len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)])
            sage: for i in prime_range(100):
            ....:     R = ZZ.quotient(i)
            ....:     t = R in Fields()
            sage: _ = gc.collect()
            sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n
            1
```
The reason for the failure: Sometimes the last line gave 0, not 1. It is not totally clear to me why the different results occurred. But in fact 0 is better than 1 here (one additional ring got collected). So, I hope my change is OK.



---

archive/issue_comments_167087.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nI am giving a positive review to Robert's code and Nils' doctest. I consider my contribution too small to make me author, but I think my changes need a review.",
    "created_at": "2015-07-18T06:45:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167087",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:46" align="right">comment:46</div>

I am giving a positive review to Robert's code and Nils' doctest. I consider my contribution too small to make me author, but I think my changes need a review.



---

archive/issue_comments_167088.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nReplying to [@simon-king-jena](#comment:45):\n> Sometimes, the following test in sage/categories/fields.py has failed:\n> \n> ```\n>             sage: import gc\n>             sage: _ = gc.collect()\n>             sage: n = len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)])\n>             sage: for i in prime_range(100):\n>             ....:     R = ZZ.quotient(i)\n>             ....:     t = R in Fields()\n>             sage: _ = gc.collect()\n>             sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n\n>             1\n> ```\n> The reason for the failure: Sometimes the last line gave 0, not 1. It is not totally clear to me why the different results occurred. But in fact 0 is better than 1 here (one additional ring got collected).\n\nShouldn't the result always be 1 given that `R` refers to `Zmod(97)` after the loop (unless there is a surviving reference from a `Zmod(97)` created in some earlier test)?  What happens if you do `del R` before the last `gc.collect()`?",
    "created_at": "2015-07-20T14:40:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167088",
    "user": "https://github.com/pjbruin"
}
```

<div id="comment:47" align="right">comment:47</div>

Replying to [@simon-king-jena](#comment:45):
> Sometimes, the following test in sage/categories/fields.py has failed:
> 
> ```
>             sage: import gc
>             sage: _ = gc.collect()
>             sage: n = len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)])
>             sage: for i in prime_range(100):
>             ....:     R = ZZ.quotient(i)
>             ....:     t = R in Fields()
>             sage: _ = gc.collect()
>             sage: len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n
>             1
> ```
> The reason for the failure: Sometimes the last line gave 0, not 1. It is not totally clear to me why the different results occurred. But in fact 0 is better than 1 here (one additional ring got collected).

Shouldn't the result always be 1 given that `R` refers to `Zmod(97)` after the loop (unless there is a surviving reference from a `Zmod(97)` created in some earlier test)?  What happens if you do `del R` before the last `gc.collect()`?



---

archive/issue_comments_167089.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nReplying to [@pjbruin](#comment:47):\n> Shouldn't the result always be 1 given that `R` refers to `Zmod(97)` after the loop (unless there is a surviving reference from a `Zmod(97)` created in some earlier test)?\n\nExactly. And what's strange: It isn't reproducible. Sometimes I get 1, sometimes I get 0. And I always get 1 when I run it on the command line.\n\n>    What happens if you do `del R` before the last `gc.collect()`?\n\nNo idea.",
    "created_at": "2015-07-20T14:56:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167089",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:48" align="right">comment:48</div>

Replying to [@pjbruin](#comment:47):
> Shouldn't the result always be 1 given that `R` refers to `Zmod(97)` after the loop (unless there is a surviving reference from a `Zmod(97)` created in some earlier test)?

Exactly. And what's strange: It isn't reproducible. Sometimes I get 1, sometimes I get 0. And I always get 1 when I run it on the command line.

>    What happens if you do `del R` before the last `gc.collect()`?

No idea.



---

archive/issue_comments_167090.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nTo be precise: I saw this problem precisely once. When I run the previous test about 20 times, it always passes.",
    "created_at": "2015-07-20T15:02:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167090",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:49" align="right">comment:49</div>

To be precise: I saw this problem precisely once. When I run the previous test about 20 times, it always passes.



---

archive/issue_comments_167091.json:
```json
{
    "body": "<div id=\"comment:50\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f\">2c04029</a></td><td><code>make a test against a memory leak clearer/more stable</code></td></tr></table>\n",
    "created_at": "2015-07-21T13:18:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167091",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:50"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f">2c04029</a></td><td><code>make a test against a memory leak clearer/more stable</code></td></tr></table>




---

archive/issue_comments_167092.json:
```json
{
    "body": "Changed commit from **[9793dbc](https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d)** to **[2c04029](https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f)**",
    "created_at": "2015-07-21T13:18:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167092",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[9793dbc](https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d)** to **[2c04029](https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f)**



---

archive/issue_comments_167093.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nHopefully the new version of the test is reliable.",
    "created_at": "2015-07-21T13:19:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167093",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:51" align="right">comment:51</div>

Hopefully the new version of the test is reliable.



---

archive/issue_events_197664.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-04T07:37:21Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197664"
}
```



---

archive/issue_events_197665.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-04T07:37:21Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197665"
}
```



---

archive/issue_comments_167094.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nexcerpt from patchbot report:\n\n```\n+inside file:  b/src/sage/structure/coerce.pyx\n+@@ -1265,33 +1287,74 @@ cdef class CoercionModel_cache_maps(CoercionModel):\n++                    raise RuntimeError, \"BUG in coercion model: coerce_map_from must return a Map\"\n++                    raise RuntimeError, \"BUG in coercion model: coerce_map_from must return a Map\"\n+Old-style raise statement inserted on 2 non-empty lines\n```",
    "created_at": "2015-08-04T07:37:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167094",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:52" align="right">comment:52</div>

excerpt from patchbot report:

```
+inside file:  b/src/sage/structure/coerce.pyx
+@@ -1265,33 +1287,74 @@ cdef class CoercionModel_cache_maps(CoercionModel):
++                    raise RuntimeError, "BUG in coercion model: coerce_map_from must return a Map"
++                    raise RuntimeError, "BUG in coercion model: coerce_map_from must return a Map"
+Old-style raise statement inserted on 2 non-empty lines
```



---

archive/issue_comments_167095.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nReplying to [@fchapoton](#comment:52):\n> excerpt from patchbot report:\n> \n> ```\n> +inside file:  b/src/sage/structure/coerce.pyx\n> +@@ -1265,33 +1287,74 @@ cdef class CoercionModel_cache_maps(CoercionModel):\n> ++                    raise RuntimeError, \"BUG in coercion model: coerce_map_from must return a Map\"\n> ++                    raise RuntimeError, \"BUG in coercion model: coerce_map_from must return a Map\"\n> +Old-style raise statement inserted on 2 non-empty lines\n> ```\n\nActually this was not inserted, but moved. Would it be possible for you to change this to new-style raise statement by a reviewer commit?",
    "created_at": "2015-08-04T07:59:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167095",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:53" align="right">comment:53</div>

Replying to [@fchapoton](#comment:52):
> excerpt from patchbot report:
> 
> ```
> +inside file:  b/src/sage/structure/coerce.pyx
> +@@ -1265,33 +1287,74 @@ cdef class CoercionModel_cache_maps(CoercionModel):
> ++                    raise RuntimeError, "BUG in coercion model: coerce_map_from must return a Map"
> ++                    raise RuntimeError, "BUG in coercion model: coerce_map_from must return a Map"
> +Old-style raise statement inserted on 2 non-empty lines
> ```

Actually this was not inserted, but moved. Would it be possible for you to change this to new-style raise statement by a reviewer commit?



---

archive/issue_comments_167096.json:
```json
{
    "body": "Changed commit from **[2c04029](https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f)** to **[8713960](https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2)**",
    "created_at": "2015-08-04T08:57:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167096",
    "user": "https://github.com/fchapoton"
}
```

Changed commit from **[2c04029](https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f)** to **[8713960](https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2)**



---

archive/issue_comments_167097.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\ndone. I also did it for some of the other raise in the same file.\n  \n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e976b797736452bc9fc07e85c0fc1ffcd5d07e88\">e976b79</a></td><td><code>Merge branch 'u/SimonKing/weakly_reference_binary_operation_codomains' into 6.9.b0</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2\">8713960</a></td><td><code>trac #14058 convert some raise statements into py3 syntax</code></td></tr></table>\n",
    "created_at": "2015-08-04T08:57:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167097",
    "user": "https://github.com/fchapoton"
}
```

<div id="comment:54" align="right">comment:54</div>

done. I also did it for some of the other raise in the same file.
  
---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e976b797736452bc9fc07e85c0fc1ffcd5d07e88">e976b79</a></td><td><code>Merge branch 'u/SimonKing/weakly_reference_binary_operation_codomains' into 6.9.b0</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2">8713960</a></td><td><code>trac #14058 convert some raise statements into py3 syntax</code></td></tr></table>




---

archive/issue_comments_167098.json:
```json
{
    "body": "Changed branch from **[u/SimonKing/weakly_reference_binary_operation_codomains](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/weakly_reference_binary_operation_codomains)** to **[public/ticket/14058](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/14058)**",
    "created_at": "2015-08-04T08:57:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167098",
    "user": "https://github.com/fchapoton"
}
```

Changed branch from **[u/SimonKing/weakly_reference_binary_operation_codomains](https://github.com/sagemath/sagetrac-mirror/tree/u/SimonKing/weakly_reference_binary_operation_codomains)** to **[public/ticket/14058](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/14058)**



---

archive/issue_events_197666.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-04T08:58:07Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197666"
}
```



---

archive/issue_events_197667.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-04T08:58:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197667"
}
```



---

archive/issue_comments_167099.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [@simon-king-jena](#comment:46):\n> I am giving a positive review to Robert's code and Nils' doctest. I consider my contribution too small to make me author, but I think my changes need a review.\n\nCould someone please finish the review? The patchbot thinks the branch is fine.",
    "created_at": "2015-08-06T14:06:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167099",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [@simon-king-jena](#comment:46):
> I am giving a positive review to Robert's code and Nils' doctest. I consider my contribution too small to make me author, but I think my changes need a review.

Could someone please finish the review? The patchbot thinks the branch is fine.



---

archive/issue_events_197668.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2015-08-06T14:11:50Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197668"
}
```



---

archive/issue_events_197669.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2015-08-06T14:11:50Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197669"
}
```



---

archive/issue_comments_167100.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,3 @@\n R(1) + S(1) caches a strong reference to both R and S, which we'd like to avoid. \n \n See discussion at https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ozhIHIwQ4WA\n-\n-__APPLY__\n-\n-* [attachment: 14058-weak-binop-morphisms.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)\n-* [attachment: trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)\n``````\n",
    "created_at": "2015-08-06T14:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167100",
    "user": "https://github.com/jpflori"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,3 @@
 R(1) + S(1) caches a strong reference to both R and S, which we'd like to avoid. 
 
 See discussion at https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/ozhIHIwQ4WA
-
-__APPLY__
-
-* [attachment: 14058-weak-binop-morphisms.patch](https://github.com/sagemath/sage/files/ticket14058/14058-weak-binop-morphisms.patch.gz)
-* [attachment: trac_14058-doctest.patch](https://github.com/sagemath/sage/files/ticket14058/trac_14058-doctest.patch.gz)
``````




---

archive/issue_comments_167101.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nYour change is small and makes sense.",
    "created_at": "2015-08-06T14:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167101",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:57" align="right">comment:57</div>

Your change is small and makes sense.



---

archive/issue_comments_167102.json:
```json
{
    "body": "Changed reviewer from **Simon King** to **Simon King, Fr\u00e9d\u00e9ric Chapoton, Jean-Pierre Flori**",
    "created_at": "2015-08-06T14:11:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167102",
    "user": "https://github.com/jpflori"
}
```

Changed reviewer from **Simon King** to **Simon King, Frédéric Chapoton, Jean-Pierre Flori**



---

archive/issue_events_197670.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-08-10T09:56:54Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197670"
}
```



---

archive/issue_events_197671.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-08-10T09:56:54Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197671"
}
```



---

archive/issue_comments_167103.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nFrom the patchbot\n\n```\nsage -t --long src/sage/structure/coerce.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 1307, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps\nFailed example:\n    print N2-N0\nExpected:\n    0\nGot:\n    -1\n```\nIs it what we should get?",
    "created_at": "2015-08-10T09:56:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167103",
    "user": "https://github.com/videlec"
}
```

<div id="comment:58" align="right">comment:58</div>

From the patchbot

```
sage -t --long src/sage/structure/coerce.pyx
**********************************************************************
File "src/sage/structure/coerce.pyx", line 1307, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps
Failed example:
    print N2-N0
Expected:
    0
Got:
    -1
```
Is it what we should get?



---

archive/issue_comments_167104.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nReplying to [@videlec](#comment:58):\n> From the patchbot\n> ...\n\nwrong ticket... should be #18905. Sorry for the noise.",
    "created_at": "2015-08-10T09:58:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167104",
    "user": "https://github.com/videlec"
}
```

<div id="comment:59" align="right">comment:59</div>

Replying to [@videlec](#comment:58):
> From the patchbot
> ...

wrong ticket... should be #18905. Sorry for the noise.



---

archive/issue_events_197672.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-08-10T09:58:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197672"
}
```



---

archive/issue_events_197673.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-08-10T09:58:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197673"
}
```



---

archive/issue_comments_167105.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\nReplying to [@videlec](#comment:59):\n> Replying to [@videlec](#comment:58):\n> > From the patchbot\n> > ...\n\n> \n> wrong ticket... should be #18905. Sorry for the noise.\n\nThe patchbot HERE does report this problem. So, what do you mean that it \"should be #18905\"?",
    "created_at": "2015-08-10T11:53:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167105",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:60" align="right">comment:60</div>

Replying to [@videlec](#comment:59):
> Replying to [@videlec](#comment:58):
> > From the patchbot
> > ...

> 
> wrong ticket... should be #18905. Sorry for the noise.

The patchbot HERE does report this problem. So, what do you mean that it "should be #18905"?



---

archive/issue_events_197674.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-08-10T11:55:17Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197674"
}
```



---

archive/issue_events_197675.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2015-08-10T11:55:17Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197675"
}
```



---

archive/issue_comments_167106.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nRight! I confused myself.",
    "created_at": "2015-08-10T11:55:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167106",
    "user": "https://github.com/videlec"
}
```

<div id="comment:61" align="right">comment:61</div>

Right! I confused myself.



---

archive/issue_comments_167107.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nThe failing doctest is reproducible after applying this branch onto `6.9.beta1`.",
    "created_at": "2015-08-10T12:08:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167107",
    "user": "https://github.com/videlec"
}
```

<div id="comment:62" align="right">comment:62</div>

The failing doctest is reproducible after applying this branch onto `6.9.beta1`.



---

archive/issue_comments_167108.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nOn sage-6.9.beta1, I get:\n\n```\n$ sage nbruin.sage\nTime: CPU 7.95 s, Wall: 7.95 s\nTime: CPU 7.68 s, Wall: 7.68 s\nTime: CPU 76.76 s, Wall: 76.94 s\n```\n\nOn sage-6.9.beta1 + #14058, I get a very good improvement:\n\n```\n$ sage nbruin.sage\nTime: CPU 2.48 s, Wall: 2.48 s\nTime: CPU 2.07 s, Wall: 2.07 s\nTime: CPU 32.38 s, Wall: 32.42 s\n```\n\nNote: I originally thought it [was a regression in sage](https://groups.google.com/d/msg/sage-devel/n7_21tCO4zI/cuCAlO01DwAJ) since I was getting this earlier this morning with sage-6.8 + #14058. But thanksfully, it seems to be a improvement obtained from this ticket.\n\nThe file `nbruin.sage` is from [comment 4](https://github.com/sagemath/sage/issues/14058#comment:4):\n\n```\n $ cat nbruin.sage\na=ZZ(1)\nb=QQ(1)\nc=ZZ['x'](1)\nd=b+c\n\ndef test(x,y):\n  for i in xrange(10^6):\n    _=x+y\n\ntime test(a,b)\ntime test(a,c)\ntime test(b,c)\n```",
    "created_at": "2015-08-11T18:43:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167108",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:63" align="right">comment:63</div>

On sage-6.9.beta1, I get:

```
$ sage nbruin.sage
Time: CPU 7.95 s, Wall: 7.95 s
Time: CPU 7.68 s, Wall: 7.68 s
Time: CPU 76.76 s, Wall: 76.94 s
```

On sage-6.9.beta1 + #14058, I get a very good improvement:

```
$ sage nbruin.sage
Time: CPU 2.48 s, Wall: 2.48 s
Time: CPU 2.07 s, Wall: 2.07 s
Time: CPU 32.38 s, Wall: 32.42 s
```

Note: I originally thought it [was a regression in sage](https://groups.google.com/d/msg/sage-devel/n7_21tCO4zI/cuCAlO01DwAJ) since I was getting this earlier this morning with sage-6.8 + #14058. But thanksfully, it seems to be a improvement obtained from this ticket.

The file `nbruin.sage` is from [comment 4](https://github.com/sagemath/sage/issues/14058#comment:4):

```
 $ cat nbruin.sage
a=ZZ(1)
b=QQ(1)
c=ZZ['x'](1)
d=b+c

def test(x,y):
  for i in xrange(10^6):
    _=x+y

time test(a,b)
time test(a,c)
time test(b,c)
```



---

archive/issue_comments_167109.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nI also get improvements on tests above of Simon King at [comments 18](https://github.com/sagemath/sage/issues/14058#comment:18).\n\nWith sage-6.9.beta1:\n\n```\n$ sage testcoercion.sage\nTime: CPU 1.69 s, Wall: 1.69 s\nTime: CPU 4.05 s, Wall: 4.05 s\nC\nTime: CPU 4.03 s, Wall: 4.03 s\n```\n\nWith sage-6.9.beta1 + this ticket:\n\n```\n$ sage testcoercion.sage\nTime: CPU 0.34 s, Wall: 0.34 s\nTime: CPU 0.85 s, Wall: 0.85 s\nC\nTime: CPU 0.86 s, Wall: 0.86 s\n```\n\n(My file testcoercion.sage contains testcoercion.py + the lines at comment 18.)",
    "created_at": "2015-08-11T19:01:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167109",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:64" align="right">comment:64</div>

I also get improvements on tests above of Simon King at [comments 18](https://github.com/sagemath/sage/issues/14058#comment:18).

With sage-6.9.beta1:

```
$ sage testcoercion.sage
Time: CPU 1.69 s, Wall: 1.69 s
Time: CPU 4.05 s, Wall: 4.05 s
C
Time: CPU 4.03 s, Wall: 4.03 s
```

With sage-6.9.beta1 + this ticket:

```
$ sage testcoercion.sage
Time: CPU 0.34 s, Wall: 0.34 s
Time: CPU 0.85 s, Wall: 0.85 s
C
Time: CPU 0.86 s, Wall: 0.86 s
```

(My file testcoercion.sage contains testcoercion.py + the lines at comment 18.)



---

archive/issue_comments_167110.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nWith sage-6.9.beta1 + this ticket, I get `All tests passed` when I do\n\n```\n./sage -t --long src/sage/structure/coerce.pyx\n```\n\nbut I get the problem when I test after the build\n\n```\n./sage -bt --long src/sage/structure/coerce.pyx\n```\n\nwhich gives the error:\n\n```\n**********************************************************************\nFile \"src/sage/structure/coerce.pyx\", line 1307, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps\nFailed example:\n    print N2-N0\nExpected:\n    0\nGot:\n    -1\n**********************************************************************\n```\n\nI have never seen such a behavior.",
    "created_at": "2015-08-12T09:30:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167110",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:65" align="right">comment:65</div>

With sage-6.9.beta1 + this ticket, I get `All tests passed` when I do

```
./sage -t --long src/sage/structure/coerce.pyx
```

but I get the problem when I test after the build

```
./sage -bt --long src/sage/structure/coerce.pyx
```

which gives the error:

```
**********************************************************************
File "src/sage/structure/coerce.pyx", line 1307, in sage.structure.coerce.CoercionModel_cache_maps.coercion_maps
Failed example:
    print N2-N0
Expected:
    0
Got:
    -1
**********************************************************************
```

I have never seen such a behavior.



---

archive/issue_comments_167111.json:
```json
{
    "body": "Changed commit from **[8713960](https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2)** to **[b73d537](https://github.com/sagemath/sagetrac-mirror/commit/b73d5372cd889d8b5e72e0ac56a781ba4dde9761)**",
    "created_at": "2015-08-12T11:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167111",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[8713960](https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2)** to **[b73d537](https://github.com/sagemath/sagetrac-mirror/commit/b73d5372cd889d8b5e72e0ac56a781ba4dde9761)**



---

archive/issue_comments_167112.json:
```json
{
    "body": "<div id=\"comment:66\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c136ebd10a5ec7d45c7855a2e2ea66b3a23ce65e\">c136ebd</a></td><td><code>Merge #14058 into 6.9.beta1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b73d5372cd889d8b5e72e0ac56a781ba4dde9761\">b73d537</a></td><td><code>Trac #14058: fix broken doctest</code></td></tr></table>\n",
    "created_at": "2015-08-12T11:08:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167112",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:66"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c136ebd10a5ec7d45c7855a2e2ea66b3a23ce65e">c136ebd</a></td><td><code>Merge #14058 into 6.9.beta1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b73d5372cd889d8b5e72e0ac56a781ba4dde9761">b73d537</a></td><td><code>Trac #14058: fix broken doctest</code></td></tr></table>




---

archive/issue_comments_167113.json:
```json
{
    "body": "<div id=\"comment:67\"></div>\n\nBranch pushed to git repo; I updated commit sha1. Last 10 new commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e153d0813221d3681030fbf24bbbc283d3717162\">e153d08</a></td><td><code>#14058: Add doctest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e\">b9141ee</a></td><td><code>Merge branch 'ticket/14058' into develop</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916\">90ed181</a></td><td><code>Trivial fix for a coercion doctest</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58\">64b572c</a></td><td><code>refcount libsingular rings used in plural</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d\">9793dbc</a></td><td><code>Make one test more stable</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f\">2c04029</a></td><td><code>make a test against a memory leak clearer/more stable</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e976b797736452bc9fc07e85c0fc1ffcd5d07e88\">e976b79</a></td><td><code>Merge branch 'u/SimonKing/weakly_reference_binary_operation_codomains' into 6.9.b0</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2\">8713960</a></td><td><code>trac #14058 convert some raise statements into py3 syntax</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c136ebd10a5ec7d45c7855a2e2ea66b3a23ce65e\">c136ebd</a></td><td><code>Merge #14058 into 6.9.beta1</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d\">13cb2a7</a></td><td><code>Trac #14058: fix broken doctest</code></td></tr></table>\n",
    "created_at": "2015-08-12T11:41:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167113",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:67"></div>

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e153d0813221d3681030fbf24bbbc283d3717162">e153d08</a></td><td><code>#14058: Add doctest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/b9141eef1042c8b8fb1179b30844d5bdb737b96e">b9141ee</a></td><td><code>Merge branch 'ticket/14058' into develop</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/90ed181ae9df152e99a652636a7e9dc29b466916">90ed181</a></td><td><code>Trivial fix for a coercion doctest</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/64b572ccf6403be0c617d0e39de4b1e6cd5dbc58">64b572c</a></td><td><code>refcount libsingular rings used in plural</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9793dbc9bc64bfdce43ff1e626453816c302696d">9793dbc</a></td><td><code>Make one test more stable</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/2c04029f9a194bd87befa0cd99016e2f267a836f">2c04029</a></td><td><code>make a test against a memory leak clearer/more stable</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e976b797736452bc9fc07e85c0fc1ffcd5d07e88">e976b79</a></td><td><code>Merge branch 'u/SimonKing/weakly_reference_binary_operation_codomains' into 6.9.b0</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/8713960717f916d459e0b6a0dcef391dc992d9b2">8713960</a></td><td><code>trac #14058 convert some raise statements into py3 syntax</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c136ebd10a5ec7d45c7855a2e2ea66b3a23ce65e">c136ebd</a></td><td><code>Merge #14058 into 6.9.beta1</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d">13cb2a7</a></td><td><code>Trac #14058: fix broken doctest</code></td></tr></table>




---

archive/issue_comments_167114.json:
```json
{
    "body": "Changed commit from **[b73d537](https://github.com/sagemath/sagetrac-mirror/commit/b73d5372cd889d8b5e72e0ac56a781ba4dde9761)** to **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)**",
    "created_at": "2015-08-12T11:41:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167114",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[b73d537](https://github.com/sagemath/sagetrac-mirror/commit/b73d5372cd889d8b5e72e0ac56a781ba4dde9761)** to **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)**



---

archive/issue_comments_167115.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nIn other doctests in the same file, `GF(3)`, `GF(7)` and `GF(41)` are also created. While there are references to `GF(7)` and `GF(41)`, no variable references to `GF(3)` which is available for gargage collection. If `GF(3)` gets garbage collected before the offending doctest, then everything is fine, the doctest pass. But it can also be garbage collected in the call to `gc.collect()` in the doctest. If this is the case, then `N0` was also counting `GF(3)` which explains why `N2-N0` can be negative.\n\nOne way to fix this is to call `gc.collect()` before creating `N0`.\n\n(my first fix was using sets of ids... sorry for the noise).",
    "created_at": "2015-08-12T11:46:22Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167115",
    "user": "https://github.com/seblabbe"
}
```

<div id="comment:68" align="right">comment:68</div>

In other doctests in the same file, `GF(3)`, `GF(7)` and `GF(41)` are also created. While there are references to `GF(7)` and `GF(41)`, no variable references to `GF(3)` which is available for gargage collection. If `GF(3)` gets garbage collected before the offending doctest, then everything is fine, the doctest pass. But it can also be garbage collected in the call to `gc.collect()` in the doctest. If this is the case, then `N0` was also counting `GF(3)` which explains why `N2-N0` can be negative.

One way to fix this is to call `gc.collect()` before creating `N0`.

(my first fix was using sets of ids... sorry for the noise).



---

archive/issue_comments_167116.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nReplying to [@seblabbe](#comment:68):\n> One way to fix this is to call `gc.collect()` before creating `N0`.\n\nI agree, that's the way to fix it.",
    "created_at": "2015-08-12T12:08:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167116",
    "user": "https://github.com/simon-king-jena"
}
```

<div id="comment:69" align="right">comment:69</div>

Replying to [@seblabbe](#comment:68):
> One way to fix this is to call `gc.collect()` before creating `N0`.

I agree, that's the way to fix it.



---

archive/issue_events_197676.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2015-08-12T12:16:19Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20work",
    "label_color": "ffff00",
    "label_name": "needs work",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197676"
}
```



---

archive/issue_events_197677.json:
```json
{
    "actor": "https://github.com/seblabbe",
    "created_at": "2015-08-12T12:16:19Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197677"
}
```



---

archive/issue_comments_167117.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nI assume Simon's comment gives positive review here as this was the only thing to fix.",
    "created_at": "2015-08-13T09:31:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167117",
    "user": "https://github.com/jpflori"
}
```

<div id="comment:71" align="right">comment:71</div>

I assume Simon's comment gives positive review here as this was the only thing to fix.



---

archive/issue_events_197678.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2015-08-13T09:31:47Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197678"
}
```



---

archive/issue_events_197679.json:
```json
{
    "actor": "https://github.com/jpflori",
    "created_at": "2015-08-13T09:31:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197679"
}
```



---

archive/issue_comments_167118.json:
```json
{
    "body": "Changed reviewer from **Simon King, Fr\u00e9d\u00e9ric Chapoton, Jean-Pierre Flori** to **Simon King, Fr\u00e9d\u00e9ric Chapoton, Jean-Pierre Flori, S\u00e9bastien Labb\u00e9**",
    "created_at": "2015-08-13T09:32:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167118",
    "user": "https://github.com/jpflori"
}
```

Changed reviewer from **Simon King, Frédéric Chapoton, Jean-Pierre Flori** to **Simon King, Frédéric Chapoton, Jean-Pierre Flori, Sébastien Labbé**



---

archive/issue_events_197680.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-14T06:57:02Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.4",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197680"
}
```



---

archive/issue_events_197681.json:
```json
{
    "actor": "https://github.com/fchapoton",
    "created_at": "2015-08-14T06:57:02Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "milestone_number": null,
    "milestone_title": "sage-6.9",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197681"
}
```



---

archive/issue_comments_167119.json:
```json
{
    "body": "Changed dependencies from **#12313** to none",
    "created_at": "2015-09-12T09:56:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167119",
    "user": "https://github.com/vbraun"
}
```

Changed dependencies from **#12313** to none



---

archive/issue_comments_167120.json:
```json
{
    "body": "Changed branch from **[public/ticket/14058](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/14058)** to **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)**",
    "created_at": "2015-09-13T22:12:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167120",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[public/ticket/14058](https://github.com/sagemath/sagetrac-mirror/tree/public/ticket/14058)** to **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)**



---

archive/issue_events_197682.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-09-13T22:12:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197682"
}
```



---

archive/issue_events_197683.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "a7da2fb9c6cedb9b4cf05ef4a86d898b7a5dbcdb",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2015-09-13T22:12:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/14058#event-197683"
}
```



---

archive/issue_comments_167121.json:
```json
{
    "body": "Changed commit from **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)** to none",
    "created_at": "2015-09-17T19:59:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167121",
    "user": "https://github.com/jdemeyer"
}
```

Changed commit from **[13cb2a7](https://github.com/sagemath/sagetrac-mirror/commit/13cb2a78983efb8f4edb00d6d10f8fc7da62e80d)** to none



---

archive/issue_comments_167122.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nOn arando:\n\n```\n\nsage -t --long src/sage/categories/fields.py\n**********************************************************************\nFile \"src/sage/categories/fields.py\", line 104, in sage.categories.fields.Fields.__contains__\nFailed example:\n    len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n\nExpected:\n    0\nGot:\n    -1\n**********************************************************************\n```",
    "created_at": "2015-09-17T19:59:56Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167122",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:76" align="right">comment:76</div>

On arando:

```

sage -t --long src/sage/categories/fields.py
**********************************************************************
File "src/sage/categories/fields.py", line 104, in sage.categories.fields.Fields.__contains__
Failed example:
    len([X for X in gc.get_objects() if isinstance(X, sage.rings.finite_rings.integer_mod_ring.IntegerModRing_generic)]) - n
Expected:
    0
Got:
    -1
**********************************************************************
```



---

archive/issue_comments_167123.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nSee #19244",
    "created_at": "2015-09-19T10:53:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/14058",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/14058#issuecomment-167123",
    "user": "https://github.com/jdemeyer"
}
```

<div id="comment:77" align="right">comment:77</div>

See #19244
