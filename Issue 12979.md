# Issue 12979: fix pickling of Matrix_modn_dense_double on Solaris (Mark)

archive/issues_012979.json:
```json
{
    "body": "Assignee: was\n\nCC:  vbraun jdemeyer drkirkby jpflori leif\n\nOn mark/skynet pickling a `Matrix_modn_dense_double` results in a bus error as reported at #12841.\n\nIssue created by migration from https://trac.sagemath.org/ticket/13151\n\n",
    "created_at": "2012-06-22T09:47:57Z",
    "labels": [
        "pickling",
        "major",
        "bug"
    ],
    "title": "fix pickling of Matrix_modn_dense_double on Solaris (Mark)",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12979",
    "user": "malb"
}
```
Assignee: was

CC:  vbraun jdemeyer drkirkby jpflori leif

On mark/skynet pickling a `Matrix_modn_dense_double` results in a bus error as reported at #12841.

Issue created by migration from https://trac.sagemath.org/ticket/13151





---

archive/issue_comments_156906.json:
```json
{
    "body": "Volker reported at #12841:\n\n> The output of PyString_FromStringAndSize is 4 but not 8-byte aligned. By faking it\n> {{{\n>            um = <mod_int*>((<char *>s)+4)\n> }}}\n> I avoided the crash.",
    "created_at": "2012-06-22T09:49:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156906",
    "user": "malb"
}
```

Volker reported at #12841:

> The output of PyString_FromStringAndSize is 4 but not 8-byte aligned. By faking it
> {{{
>            um = <mod_int*>((<char *>s)+4)
> }}}
> I avoided the crash.



---

archive/issue_comments_156907.json:
```json
{
    "body": "I tried `gcc -munaligned-doubles` but that didn't help.\n\nThe problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.",
    "created_at": "2012-06-22T10:27:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156907",
    "user": "vbraun"
}
```

I tried `gcc -munaligned-doubles` but that didn't help.

The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.



---

archive/issue_comments_156908.json:
```json
{
    "body": "I've built 32-bit Sage on OpenIndiana and it works fine, for the record.",
    "created_at": "2012-06-22T11:58:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156908",
    "user": "vbraun"
}
```

I've built 32-bit Sage on OpenIndiana and it works fine, for the record.



---

archive/issue_comments_156909.json:
```json
{
    "body": "Replying to [comment:3 vbraun]:\n> I've built 32-bit Sage on OpenIndiana and it works fine, for the record.\nOn SPARC hardware?",
    "created_at": "2012-06-22T12:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156909",
    "user": "jdemeyer"
}
```

Replying to [comment:3 vbraun]:
> I've built 32-bit Sage on OpenIndiana and it works fine, for the record.
On SPARC hardware?



---

archive/issue_comments_156910.json:
```json
{
    "body": "Replying to [comment:4 jdemeyer]:\n> On SPARC hardware?\n\nVery funny. OI doesn't even support SPARC ;-)",
    "created_at": "2012-06-22T12:09:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156910",
    "user": "vbraun"
}
```

Replying to [comment:4 jdemeyer]:
> On SPARC hardware?

Very funny. OI doesn't even support SPARC ;-)



---

archive/issue_comments_156911.json:
```json
{
    "body": "Replying to [comment:5 vbraun]:\n> Replying to [comment:4 jdemeyer]:\n> > On SPARC hardware?\n> \n> Very funny. OI doesn't even support SPARC ;-)\nI didn't know that, but anyway it makes your comment irrelevant.  It is more of a hardware-related issue than a software-related issue.",
    "created_at": "2012-06-22T12:14:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156911",
    "user": "jdemeyer"
}
```

Replying to [comment:5 vbraun]:
> Replying to [comment:4 jdemeyer]:
> > On SPARC hardware?
> 
> Very funny. OI doesn't even support SPARC ;-)
I didn't know that, but anyway it makes your comment irrelevant.  It is more of a hardware-related issue than a software-related issue.



---

archive/issue_comments_156912.json:
```json
{
    "body": "eplying to [comment:2 vbraun]:\n> I tried `gcc -munaligned-doubles` but that didn't help.\n> \n> The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.\nThat's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.\n\nThe obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.",
    "created_at": "2012-06-22T12:14:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156912",
    "user": "jdemeyer"
}
```

eplying to [comment:2 vbraun]:
> I tried `gcc -munaligned-doubles` but that didn't help.
> 
> The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.
That's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.

The obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.



---

archive/issue_comments_156913.json:
```json
{
    "body": "Some more testing reveals that a) malloc on SPARC is in fact 8-byte aligned (as specified by the C99 standard), and b) the **output of `PyString_FromStringAndSize` is never 8-byte aligned,** not on SPARC 32-bit, OI 32-bit, Linux 64-bit:\n\n```\nsage: cython(\"\"\"\n....: def f():\n....:         cdef char* buf\n....:     s = PyString_FromStringAndSize(NULL, 1*8)\n....:     buf = <char*>s\n....:     return <int>buf\n....: \"\"\")\nsage: \nsage: set([ f() % 8 for i in range(100) ])\nset([4])\n```\n",
    "created_at": "2012-06-22T13:24:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156913",
    "user": "vbraun"
}
```

Some more testing reveals that a) malloc on SPARC is in fact 8-byte aligned (as specified by the C99 standard), and b) the **output of `PyString_FromStringAndSize` is never 8-byte aligned,** not on SPARC 32-bit, OI 32-bit, Linux 64-bit:

```
sage: cython("""
....: def f():
....:         cdef char* buf
....:     s = PyString_FromStringAndSize(NULL, 1*8)
....:     buf = <char*>s
....:     return <int>buf
....: """)
sage: 
sage: set([ f() % 8 for i in range(100) ])
set([4])
```




---

archive/issue_comments_156914.json:
```json
{
    "body": "For debugging purposes it might be useful to know that you can turn off the misalignment support and trigger bus errors on x86 processors:\n\n```c\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <inttypes.h>\n\n/* Run as (on x86 processors):\n * $ gcc -o test test.c && ./test\n * Bus error (core dumped)\n */\n\n\nint main(void)\n{\n  __asm__(\"pushf\\n\"\n\t  \"orl $0x40000, (%rsp)\\n\"\n\t  \"popf\");\n \n    char *ptr = malloc(20);\n    ptr += 4;\n\n    uint64_t *uint64_ptr = (uint64_t*)ptr;\n    (*uint64_ptr) = (uint64_t)1;\n\n    return 0;\n}\n```\n",
    "created_at": "2012-06-22T14:00:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156914",
    "user": "vbraun"
}
```

For debugging purposes it might be useful to know that you can turn off the misalignment support and trigger bus errors on x86 processors:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <inttypes.h>

/* Run as (on x86 processors):
 * $ gcc -o test test.c && ./test
 * Bus error (core dumped)
 */


int main(void)
{
  __asm__("pushf\n"
	  "orl $0x40000, (%rsp)\n"
	  "popf");
 
    char *ptr = malloc(20);
    ptr += 4;

    uint64_t *uint64_ptr = (uint64_t*)ptr;
    (*uint64_ptr) = (uint64_t)1;

    return 0;
}
```




---

archive/issue_comments_156915.json:
```json
{
    "body": "Changing assignee from was to drkirkby.",
    "created_at": "2012-06-22T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156915",
    "user": "jdemeyer"
}
```

Changing assignee from was to drkirkby.



---

archive/issue_comments_156916.json:
```json
{
    "body": "Changing keywords from \"\" to \"SPARC\".",
    "created_at": "2012-06-22T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156916",
    "user": "jdemeyer"
}
```

Changing keywords from "" to "SPARC".



---

archive/issue_comments_156917.json:
```json
{
    "body": "Changing component from pickling to porting.",
    "created_at": "2012-06-22T15:02:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156917",
    "user": "jdemeyer"
}
```

Changing component from pickling to porting.



---

archive/issue_comments_156918.json:
```json
{
    "body": "I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, but not with the sage-5.1.beta3 build. Both shipped with mercurial-1.8.4. Perhaps our gcc spkg is at fault? The working build used `/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld`\n\n```\n-bash-3.00$ ./sage -hg qpush\n/home/vbraun/opt/mark/sage-5.1.beta3/spkg/bin/sage: line 641: 21670 Bus Error               (core dumped) \"$SAGE_LOCAL/bin/hg\" \"$@\"\n-bash-3.00$ pstack core\ncore 'core' of 21670:   python /home/vbraun/opt/mark/sage-5.1.beta3/local/bin/hg qpush\n fea40f14 parse_dirstate (3be794, fea417c0, 3bec40, 3bec51, ff223ebc, 2b37d0) + b8\n ff203388 PyCFunction_Call (3725a8, 390170, 0, e9850, 0, fea40e5c) + e0\n ff270f1c PyEval_EvalFrameEx (3be5f0, 0, 38c8a0, 22bc60, 209e0, 390170) + 6030\n ff271738 PyEval_EvalFrameEx (3be490, 0, 3be5f4, 33bb05, 209e0, 209e0) + 684c\n ff271738 PyEval_EvalFrameEx (3b53c8, 0, 3be494, 123b40, 209e0, 209e0) + 684c\n ff272acc PyEval_EvalCodeEx (1291d0, 3b53d4, 3b53c8, 24be4c, 3, 0) + 924\n ff1ea2b0 function_call (13de70, 24be40, 0, 17e4f8, 13de70, 1813a4) + 8c\n ff1be5c8 PyObject_Call (13de70, 24be40, 0, ff337c78, ff1ea224, 24be30) + 60\n ff1bedc8 PyObject_CallFunctionObjArgs (13de70, 3426f0, ffbfce14, ffbfce14, 0, 24be40) + d4\n ff205ea8 _PyObject_GenericGetAttrWithDict (0, 1c69c0, 2a8d20, 3426f0, ff223ebc, 2b37d0) + d0\n ff2052c4 PyObject_GetAttr (2b37d0, 1c69c0, ffffffff, ef088, ef088, 2b37d0) + 64\n ff26cbd0 PyEval_EvalFrameEx (3bc888, 0, 33fe50, 33bdad, 209e0, 3bc9d0) + 1ce4\n ff272acc PyEval_EvalCodeEx (339c38, 3bc890, 3bc888, 355c44, 2, 0) + 924\n ff1ea2b0 function_call (33df30, 355c38, 0, c, 33df30, 24be40) + 8c\n[...]\n ff297134 PyRun_FileExFlags (feef31f4, ffbff48b, 16ec00, 52660, 52660, 11fa88) + 7c\n ff297d18 PyRun_SimpleFileExFlags (ffbff4b8, ffbff48b, 1, ffbff294, ff2eac90, feef31f4) + d4\n ff2ac8f4 Py_Main  (1, ffbff2fc, ff33a55c, 0, feef31f4, 0) + c38\n 0001055c _start   (0, 0, 0, 0, 0, 0) + 5c\n```\n",
    "created_at": "2012-06-22T18:16:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156918",
    "user": "vbraun"
}
```

I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, but not with the sage-5.1.beta3 build. Both shipped with mercurial-1.8.4. Perhaps our gcc spkg is at fault? The working build used `/usr/local/gcc-4.5.1/sparc-SunOS-ultrasparc3-sun-as-ld`

```
-bash-3.00$ ./sage -hg qpush
/home/vbraun/opt/mark/sage-5.1.beta3/spkg/bin/sage: line 641: 21670 Bus Error               (core dumped) "$SAGE_LOCAL/bin/hg" "$@"
-bash-3.00$ pstack core
core 'core' of 21670:   python /home/vbraun/opt/mark/sage-5.1.beta3/local/bin/hg qpush
 fea40f14 parse_dirstate (3be794, fea417c0, 3bec40, 3bec51, ff223ebc, 2b37d0) + b8
 ff203388 PyCFunction_Call (3725a8, 390170, 0, e9850, 0, fea40e5c) + e0
 ff270f1c PyEval_EvalFrameEx (3be5f0, 0, 38c8a0, 22bc60, 209e0, 390170) + 6030
 ff271738 PyEval_EvalFrameEx (3be490, 0, 3be5f4, 33bb05, 209e0, 209e0) + 684c
 ff271738 PyEval_EvalFrameEx (3b53c8, 0, 3be494, 123b40, 209e0, 209e0) + 684c
 ff272acc PyEval_EvalCodeEx (1291d0, 3b53d4, 3b53c8, 24be4c, 3, 0) + 924
 ff1ea2b0 function_call (13de70, 24be40, 0, 17e4f8, 13de70, 1813a4) + 8c
 ff1be5c8 PyObject_Call (13de70, 24be40, 0, ff337c78, ff1ea224, 24be30) + 60
 ff1bedc8 PyObject_CallFunctionObjArgs (13de70, 3426f0, ffbfce14, ffbfce14, 0, 24be40) + d4
 ff205ea8 _PyObject_GenericGetAttrWithDict (0, 1c69c0, 2a8d20, 3426f0, ff223ebc, 2b37d0) + d0
 ff2052c4 PyObject_GetAttr (2b37d0, 1c69c0, ffffffff, ef088, ef088, 2b37d0) + 64
 ff26cbd0 PyEval_EvalFrameEx (3bc888, 0, 33fe50, 33bdad, 209e0, 3bc9d0) + 1ce4
 ff272acc PyEval_EvalCodeEx (339c38, 3bc890, 3bc888, 355c44, 2, 0) + 924
 ff1ea2b0 function_call (33df30, 355c38, 0, c, 33df30, 24be40) + 8c
[...]
 ff297134 PyRun_FileExFlags (feef31f4, ffbff48b, 16ec00, 52660, 52660, 11fa88) + 7c
 ff297d18 PyRun_SimpleFileExFlags (ffbff4b8, ffbff48b, 1, ffbff294, ff2eac90, feef31f4) + d4
 ff2ac8f4 Py_Main  (1, ffbff2fc, ff33a55c, 0, feef31f4, 0) + c38
 0001055c _start   (0, 0, 0, 0, 0, 0) + 5c
```




---

archive/issue_comments_156919.json:
```json
{
    "body": "I can confirm the `hg` problem, but don't feel like investigating that now.\n\nYou could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).",
    "created_at": "2012-06-22T21:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156919",
    "user": "jdemeyer"
}
```

I can confirm the `hg` problem, but don't feel like investigating that now.

You could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).



---

archive/issue_comments_156920.json:
```json
{
    "body": "Back to the pickling issue, why do cast double to uint64_t at all? Since we clearly don't care about endianness, why not just memcpy the bare data?",
    "created_at": "2012-06-22T23:24:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156920",
    "user": "vbraun"
}
```

Back to the pickling issue, why do cast double to uint64_t at all? Since we clearly don't care about endianness, why not just memcpy the bare data?



---

archive/issue_comments_156921.json:
```json
{
    "body": "When we load a pickle from machine A on machine B and they have different endianness, then we care about fixing that.",
    "created_at": "2012-06-23T10:17:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156921",
    "user": "malb"
}
```

When we load a pickle from machine A on machine B and they have different endianness, then we care about fixing that.



---

archive/issue_comments_156922.json:
```json
{
    "body": "Changing keywords from \"SPARC\" to \"Solaris SPARC\".",
    "created_at": "2012-09-03T07:49:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156922",
    "user": "jdemeyer"
}
```

Changing keywords from "SPARC" to "Solaris SPARC".



---

archive/issue_comments_156923.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> I can confirm the `hg` problem, but don't feel like investigating that now.\n> \n> You could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).\n\nI built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage. I get the same problem, so it is not some bug related to the particular gcc in Sage. \n\nIs Skynet's SPARC machine running? If not, and someone wants to look at this, they can use my SPARC. I don't keep it on 24/7, but now I am writing some code to control a vector network analyzer, so the machine will be on for a week or two. \n\nDave",
    "created_at": "2012-09-03T17:40:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156923",
    "user": "drkirkby"
}
```

Replying to [comment:12 jdemeyer]:
> I can confirm the `hg` problem, but don't feel like investigating that now.
> 
> You could try building the current Sage with that `gcc` version instead of using the GCC spkg (note that we currently only support the Sun linker on Solaris, but that's okay).

I built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage. I get the same problem, so it is not some bug related to the particular gcc in Sage. 

Is Skynet's SPARC machine running? If not, and someone wants to look at this, they can use my SPARC. I don't keep it on 24/7, but now I am writing some code to control a vector network analyzer, so the machine will be on for a week or two. 

Dave



---

archive/issue_comments_156924.json:
```json
{
    "body": "Replying to [comment:16 drkirkby]:\n> Is Skynet's SPARC machine running?\nYes, it is.",
    "created_at": "2012-09-04T07:10:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156924",
    "user": "jdemeyer"
}
```

Replying to [comment:16 drkirkby]:
> Is Skynet's SPARC machine running?
Yes, it is.



---

archive/issue_comments_156925.json:
```json
{
    "body": "Replying to [comment:16 drkirkby]:\n> I built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage.\nWhich assembler/linker is that using?",
    "created_at": "2012-09-04T07:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156925",
    "user": "jdemeyer"
}
```

Replying to [comment:16 drkirkby]:
> I built Sage sage-5.3.rc0 on a Sun Blade 2000 (2 x UltraSPARC III 1200 MHz CPUs, 8 GB RAM) using gcc 4.5.0, which was on my system, and so I did **not** use the gcc packaged with Sage.
Which assembler/linker is that using?



---

archive/issue_comments_156926.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]\n\nDoesn't really surprise me... ;-)\n\n(I've tested it with GCC 4.5.1 and 4.6.1.)",
    "created_at": "2013-04-01T14:00:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156926",
    "user": "leif"
}
```

Replying to [comment:11 vbraun]:
> I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]

Doesn't really surprise me... ;-)

(I've tested it with GCC 4.5.1 and 4.6.1.)



---

archive/issue_comments_156927.json:
```json
{
    "body": "Replying to [comment:21 leif]:\n> Replying to [comment:11 vbraun]:\n> > I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]\n> \n> Doesn't really surprise me... ;-)\n> \n> (I've tested it with GCC 4.5.1 and 4.6.1.)\nOn my 5.9.beta3 setup (with Sage's GCC), ./sage -hg seems fine as well.",
    "created_at": "2013-04-03T13:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156927",
    "user": "jpflori"
}
```

Replying to [comment:21 leif]:
> Replying to [comment:11 vbraun]:
> > I noticed another oddity: `sage -hg` works with my sage-4.7.2.alpha3 build, [...]
> 
> Doesn't really surprise me... ;-)
> 
> (I've tested it with GCC 4.5.1 and 4.6.1.)
On my 5.9.beta3 setup (with Sage's GCC), ./sage -hg seems fine as well.



---

archive/issue_comments_156928.json:
```json
{
    "body": "Replying to [comment:7 jdemeyer]:\n> eplying to [comment:2 vbraun]:\n> > I tried `gcc -munaligned-doubles` but that didn't help.\n> > \n> > The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.\n> That's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.\n> \n> The obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.\nSo should we go with that solution?",
    "created_at": "2013-04-03T14:10:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156928",
    "user": "jpflori"
}
```

Replying to [comment:7 jdemeyer]:
> eplying to [comment:2 vbraun]:
> > I tried `gcc -munaligned-doubles` but that didn't help.
> > 
> > The problem seems to be that malloc on 32-bit SPARC solaris generally returns 4-byte aligned buffers.
> That's not necessarily the case.  The string `<char*>s` isn't directly generated from a `malloc`, instead it is the result of a `PyString_AsString()` call.  That isn't guaranteed to be 8-bytes aligned.
> 
> The obvious solution is to allocate a buffer ourselves, fill that and pass the result to `PyString_FromStringAndSize(buf, size)`. This will cause an extra `memcpy()` but that might be unavoidable.
So should we go with that solution?



---

archive/issue_comments_156929.json:
```json
{
    "body": "Not that we really care if matrix unpickling is a little slower...",
    "created_at": "2013-04-03T14:11:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156929",
    "user": "jpflori"
}
```

Not that we really care if matrix unpickling is a little slower...



---

archive/issue_comments_156930.json:
```json
{
    "body": "OK, you write the patch or me (just asking to avoid duplicating effort).\n\nIt would be really cool if we could have full SPARC suppport in sage-5.9, and maybe even full Cygwin support also.",
    "created_at": "2013-04-04T07:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156930",
    "user": "jdemeyer"
}
```

OK, you write the patch or me (just asking to avoid duplicating effort).

It would be really cool if we could have full SPARC suppport in sage-5.9, and maybe even full Cygwin support also.



---

archive/issue_comments_156931.json:
```json
{
    "body": "I won't have time before late tonight, so please go ahead and I'll review it later if that suits you.",
    "created_at": "2013-04-04T07:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156931",
    "user": "jpflori"
}
```

I won't have time before late tonight, so please go ahead and I'll review it later if that suits you.



---

archive/issue_comments_156932.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-04-08T14:59:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156932",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_156933.json:
```json
{
    "body": "Changing component from porting to porting: Solaris.",
    "created_at": "2013-04-09T10:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156933",
    "user": "jdemeyer"
}
```

Changing component from porting to porting: Solaris.



---

archive/issue_comments_156934.json:
```json
{
    "body": "See #14429 for another SPARC-related ticket. When applying #13151 and #14429, there should be no more doctest failures on Solaris SPARC, i.e. Solaris SPARC would become fully supported with these two tickets.",
    "created_at": "2013-04-09T10:28:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156934",
    "user": "jdemeyer"
}
```

See #14429 for another SPARC-related ticket. When applying #13151 and #14429, there should be no more doctest failures on Solaris SPARC, i.e. Solaris SPARC would become fully supported with these two tickets.



---

archive/issue_comments_156935.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-04-10T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156935",
    "user": "jpflori"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_156936.json:
```json
{
    "body": "This works fine and the patch looks ok, implementing the solution which was suggested here.",
    "created_at": "2013-04-10T08:52:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156936",
    "user": "jpflori"
}
```

This works fine and the patch looks ok, implementing the solution which was suggested here.



---

archive/issue_comments_156937.json:
```json
{
    "body": "Attachment [13151_alignment.patch](tarball://root/attachments/some-uuid/ticket13151/13151_alignment.patch) by jdemeyer created at 2013-04-10 10:23:42",
    "created_at": "2013-04-10T10:23:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156937",
    "user": "jdemeyer"
}
```

Attachment [13151_alignment.patch](tarball://root/attachments/some-uuid/ticket13151/13151_alignment.patch) by jdemeyer created at 2013-04-10 10:23:42



---

archive/issue_comments_156938.json:
```json
{
    "body": "I fixed a small mistake: the `sig_on()` should be *outside* the `try/finally` statement. I assume that the positive review still stands.",
    "created_at": "2013-04-10T10:24:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156938",
    "user": "jdemeyer"
}
```

I fixed a small mistake: the `sig_on()` should be *outside* the `try/finally` statement. I assume that the positive review still stands.



---

archive/issue_comments_156939.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-04-11T07:35:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12979",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12979#issuecomment-156939",
    "user": "jdemeyer"
}
```

Resolution: fixed
