# Issue 17858: Use build/deps for auto-generating files

Issue created by migration from https://trac.sagemath.org/ticket/18095

Original creator: jdemeyer

Original creation time: 2015-03-31 14:32:31

CC:  vdelecroix fbissey

The auto-generating of `src/sage/ext/interpreters/*` and `src/sage/libs/pari/auto*.pxi` should be done with a `Makefile` which has proper dependency checking.


---

Comment by jdemeyer created at 2015-03-31 14:32:41

Changing keywords from "" to "sd66".


---

Comment by git created at 2015-03-31 16:16:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-04-01 14:16:25

Changing status from new to needs_review.


---

Comment by mmezzarobba created at 2015-04-08 14:25:35

Am I correct to understand that you removed the ability to do `sage-build -b`(or `sage -b -b`, if I read the source correctly, though I don't know if this version ever was intended to work) in order to perform a more aggressive rebuild? I have nothing against removing it, but this ”feature“ was mentioned on sage-support, so perhaps its removal should be a bit more explicit.

Also, perhaps the calls to `build_sage "$`@`"` in `sage/bin/sage` should be changed to just `build_sage` (and the corresponding `shift`s removed when they serve no other purpose) for clarity.

(I only had a quick look at the changes and did not even test them.)


---

Comment by mmezzarobba created at 2015-04-08 14:42:38

Another minor point: why did you leave an empty `.gitignore` in `src/sage_setup`?


---

Comment by jdemeyer created at 2015-04-08 14:53:02

Replying to [comment:8 mmezzarobba]:
> Am I correct to understand that you removed the ability to do `sage-build -b`(or `sage -b -b`, if I read the source correctly, though I don't know if this version ever was intended to work) in order to perform a more aggressive rebuild?
Yes, I did that. However, this is no longer needed since `./sage -ba` already does that (and this is the documented version and this still works).

> this ”feature“ was mentioned on sage-support
Do you have a link?

> Also, perhaps the calls to `build_sage "$`@`"` in `sage/bin/sage` should be changed to just `build_sage` (and the corresponding `shift`s removed when they serve no other purpose) for clarity.
If you prefer, that can be done.


---

Comment by mmezzarobba created at 2015-04-08 14:54:03

Shouldn't the `sage` make target depend on `csage`? Or is

```
all:
        $(MAKE) csage
        $(MAKE) sage
```

a workaround because the way `csage` is built makes it hard to set up the dependency without rebuilding `csage` every time? If that's the case, perhaps add a comment to that effect.


---

Comment by mmezzarobba created at 2015-04-08 14:59:00

Replying to [comment:10 jdemeyer]:
> Yes, I did that. However, this is no longer needed since `./sage -ba` already does that (and this is the documented version and this still works).

Sure. I was just suggesting to mention the change in the commit messages or ticket description.

> > this ”feature“ was mentioned on sage-support
> Do you have a link?

http://osdir.com/ml/sage-support/2010-01/msg00521.html

> > Also, perhaps the calls to `build_sage "$`@`"` in `sage/bin/sage` should be changed to just `build_sage` (and the corresponding `shift`s removed when they serve no other purpose) for clarity.
> If you prefer, that can be done.

I think it is worth doing, but it's up to you.


---

Comment by jdemeyer created at 2015-04-08 14:59:20

Replying to [comment:11 mmezzarobba]:
> Shouldn't the `sage` make target depend on `csage`?
There is already some logic in `build/deps` such that when running `make`, then `csage` is built before `sage`.

> {{{
> all:
>         $(MAKE) csage
>         $(MAKE) sage
> }}}
> a workaround because the way `csage` is built makes it hard to set up the dependency without rebuilding `csage` every time?
I wouldn't call it a "workaround", it's more a separation of concerns. The default target `all` builds both, so there is no dependency issue either.

In any case: I would like to remove `csage` completely (see #17854), so this issue will disappear anyway.


---

Comment by mmezzarobba created at 2015-04-08 15:01:11

Replying to [comment:13 jdemeyer]:
> Replying to [comment:11 mmezzarobba]:
> > Shouldn't the `sage` make target depend on `csage`?
> There is already some logic in `build/deps` such that when running `make`, then `csage` is built before `sage`.
> 
> > {{{
> > all:
> >         $(MAKE) csage
> >         $(MAKE) sage
> > }}}
> > a workaround because the way `csage` is built makes it hard to set up the dependency without rebuilding `csage` every time?
> I wouldn't call it a "workaround", it's more a separation of concerns. The default target `all` builds both, so there is no dependency issue either.

I was wondering because you didn't just write `all: csage sage`.

> In any case: I would like to remove `csage` completely (see #17854), so this issue will disappear anyway.

Ok, fine with me.


---

Comment by jdemeyer created at 2015-04-08 15:01:41

Replying to [comment:12 mmezzarobba]:
> > > this ”feature“ was mentioned on sage-support
I see, a post from 2010. In any case, the ability to run `src/bin/sage-build` will be removed simply because `sage-build` is removed. But this was never meant to be used directly by users, so I don't think that's an issue.


---

Comment by jdemeyer created at 2015-04-08 15:02:49

Replying to [comment:14 mmezzarobba]:
> I was wondering because you didn't just write `all: csage sage`.
Because that might build `csage` and `sage` in parallel.

When `make all` is done, I do want `csage` and `sage` to be built in this order.


---

Comment by mmezzarobba created at 2015-04-08 15:06:02

Replying to [comment:16 jdemeyer]:
> Replying to [comment:14 mmezzarobba]:
> > I was wondering because you didn't just write `all: csage sage`.
> Because that might build `csage` and `sage` in parallel.
> 
> When `make all` is done, I do want `csage` and `sage` to be built in this order.

Well, yes, that's precisely what I found strange: that you want them to be built in a particular order but not one to depend on the other.

Anyway, if `csage` is about to disappear, let's not waste time with that. `:-)`


---

Comment by git created at 2015-04-08 15:16:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2015-04-08 15:46:11

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2015-04-08 17:40:47

Hmm, I missed something, sorry:

```
$ make -j4 build    
cd build && \
"../build/pipestatus" \
        "env SAGE_PARALLEL_SPKG_BUILD='' ./install all 2>&1" \
        "tee -a ../logs/install.log"
Nothing to (re)build / all up-to-date.
./sage -b
make[1]: warning: jobserver unavailable: using -j1.  Add '+' to parent make rule.
```

It may well be that the warning is benign and the build is still done in parallel, I'm not sure. But in any case the suggested change

```
diff --git a/Makefile b/Makefile
index 2e8ef6e..f307043 100644
--- a/Makefile
+++ b/Makefile
@@ -20,7 +20,7 @@ build: logs configure
        "../$(PIPE)" \
                "env SAGE_PARALLEL_SPKG_BUILD='$(SAGE_PARALLEL_SPKG_BUILD)' ./install all 2>&1" \
                "tee -a ../logs/install.log"
-       ./sage -b
+       +./sage -b
 
 # Preemptively download all standard upstream source tarballs.
 download:
```

makes the warning disappear.


---

Comment by mmezzarobba created at 2015-04-08 17:40:47

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-04-08 19:44:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-04-08 19:44:57

Changing status from needs_work to positive_review.


---

Comment by jdemeyer created at 2015-04-08 19:46:58

Replying to [comment:21 mmezzarobba]:
> It may well be that the warning is benign and the build is still done in parallel
The build is unfortunately _never_ done in parallel (since `./sage -b` uses `scons`, `cython` and `distutils`, which are not aware of `make` arguments). That's why you're supposed to do `MAKE="make -j4" make` in Sage, the environment variable can easily be read by Sage.


---

Comment by fbissey created at 2015-04-08 19:56:59

In any case if you have a concern that csage and sage could be built in parallel you should make csage a dependency of sage (made need to add a `phony` for that to work since `csage` is not a file).


---

Comment by vbraun created at 2015-04-14 19:44:28

Resolution: fixed
