# Issue 20033: some doctests are influenced by the contents of init.sage

Issue created by migration from Trac.

Original creator: mmezzarobba

Original creation time: 2016-03-23 20:36:55

“test shells” created using `sage.repl.interpreter.get_test_shell()` load `~/.sage/init.sage`, making the doctests that use `get_test_shell()` fragile.


```
$ echo "x = 'x'" > ~/.sage/init.sage
$ ./sage -t src/sage/repl/ipython_extension.py
[...]
sage -t src/sage/repl/ipython_extension.py  # 2 doctests failed
```



---

Comment by dkrenn created at 2017-02-06 07:01:54

Failing doctests of 7.6.beta2 because sage.init is loaded and contains `%colors Linux`:

```
sage -t --long src/sage/interfaces/expect.py  # 1 doctest failed
sage -t --long src/sage/repl/interpreter.py  # 3 doctests failed
sage -t --long src/sage/repl/interface_magic.py  # 3 doctests failed
sage -t --long src/sage/repl/ipython_tests.py  # 4 doctests failed
```



---

Comment by dkrenn created at 2017-02-06 07:01:54

Changing type from PLEASE CHANGE to defect.


---

Comment by dkrenn created at 2017-02-06 07:01:54

Changing priority from major to critical.


---

Comment by fbissey created at 2017-02-06 08:10:37

In a general manner I think doctests should be run with `DOT_SAGE=$temp` where `$temp` is a temporary directory in `/tmp` or `/var/tmp` , preferably created with `mktemp` or similar process. There may be a couple of tests for which that would cause problem, but overall it would be much more robust.


---

Comment by jdemeyer created at 2017-02-06 08:35:57

Replying to [comment:2 fbissey]:
> In a general manner I think doctests should be run with `DOT_SAGE=$temp` where `$temp` is a temporary directory in `/tmp` or `/var/tmp` , preferably created with `mktemp` or similar process. There may be a couple of tests for which that would cause problem, but overall it would be much more robust.

Even better, why not `HOME=$tempdir`?


---

Comment by fbissey created at 2017-02-06 08:39:42

That certainly would achieve it too. As far as I know `$HOME` is only involved in the determination of `DOT_SAGE` but there could be other stuff (dot directories not inside .sage by default for example), so that's extra safe.


---

Comment by vbraun created at 2017-06-17 21:13:00

New commits:


---

Comment by vbraun created at 2017-06-17 21:13:00

Changing status from new to needs_review.


---

Comment by fbissey created at 2017-06-17 22:50:44

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2017-06-17 22:50:44

Not the solution I was thinking of but that will solve the problem at hand.


---

Comment by vbraun created at 2017-06-22 07:24:53

Resolution: fixed
