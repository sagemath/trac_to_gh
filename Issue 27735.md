# Issue 27735: py3: fix last doctest in cpython folder

Issue created by migration from https://trac.sagemath.org/ticket/27972

Original creator: chapoton

Original creation time: 2019-06-12 08:00:20

CC:  jhpalmieri tscrim

using hash() as suggest in #27886


---

Comment by chapoton created at 2019-06-12 08:02:31

New commits:


---

Comment by chapoton created at 2019-06-12 08:02:43

Changing status from new to needs_review.


---

Comment by chapoton created at 2019-06-12 08:02:43

an easy one


---

Comment by vklein created at 2019-06-12 08:20:53

Changing status from needs_review to positive_review.


---

Comment by vklein created at 2019-06-12 08:20:53

Looks good to me.


---

Comment by embray created at 2019-06-12 08:22:08

Was literally in the process of saying the same just now :)


---

Comment by embray created at 2019-06-12 08:23:26

Oops!


---

Comment by vklein created at 2019-06-12 09:17:56

Let's be fair.


---

Comment by jdemeyer created at 2019-06-12 09:28:02

There is nothing wrong with the Sage code, it should work. It would be better to just apply the upstream fix https://github.com/cython/cython/commit/28251032f86c266065e4976080230481b1a1bb29 instead.


---

Comment by jdemeyer created at 2019-06-12 09:28:02

Changing status from positive_review to needs_info.


---

Comment by chapoton created at 2019-06-12 12:11:39

Better maybe, but not for the goal of having all tests pass soon in python3.

Jeroen, will you be able to provide your alternative solution as a branch ? You seem to have less activity on trac, so I guess you have more urgent matters to handle.

Otherwise, maybe this could be done in another ticket ?


---

Comment by jdemeyer created at 2019-06-12 12:16:31

Replying to [comment:8 chapoton]:
> Jeroen, will you be able to provide your alternative solution as a branch ?

Should I add it to #27886? It should take little effort.


---

Comment by chapoton created at 2019-06-12 12:17:47

Yes, please. And hopefully someone will review that ticket...


---

Comment by jdemeyer created at 2019-06-12 12:18:04

Replying to [comment:8 chapoton]:
> You seem to have less activity on trac, so I guess you have more urgent matters to handle.

Not really "more urgent matters" but more "other matters".

In case you are wondering what I have been doing recently: https://docs.python.org/3.8/whatsnew/3.8.html#vectorcall-a-fast-calling-protocol-for-cpython


---

Comment by embray created at 2019-06-12 13:05:26

There is a very simple workaround here, that makes logical sense for the tests (passing an object through `hash()` necessarily returns whatever the acceptable type for a hash is).  Let's just fix this without having to rely yet again on patching cython or whatever.


---

Comment by jdemeyer created at 2019-06-12 13:08:05

I already added the patch to #27886.


---

Comment by jhpalmieri created at 2019-06-12 15:10:33

I feel like the changes here make sense independently of the Cython patch: I believe that

```
sage: D = {1230981308409180310928308123: ZZ} # random large integer
sage: test_del_dictitem_by_exact_value(D, ZZ, 1230981308409180310928308123)
```

will fail, while

```
sage: D = {1230981308409180310928308123: ZZ}
sage: test_del_dictitem_by_exact_value(D, ZZ, hash(1230981308409180310928308123))
```

will work.

I don't object to testing whether small integers are equal to their hash values, but that  is tested in `integer.pyx`. After the changes here, the doctest still tests the appropriate function, and they also indicate how to use the function:

```
sage: D = {'a': ZZ}
sage: test_del_dictitem_by_exact_value(D, ZZ, hash('a'))
```



---

Comment by jdemeyer created at 2019-06-12 15:13:46

Replying to [comment:14 jhpalmieri]:
> I don't object to testing whether small integers are equal to their hash values, but that  is tested in `integer.pyx`.

True, but unrelated to this ticket. That's not what this doctest is testing.


---

Comment by jhpalmieri created at 2019-06-12 16:03:49

Are you agreeing with me or disagreeing? I can't tell.

What is the doctest supposed to be testing?


---

Comment by jdemeyer created at 2019-06-13 07:02:49

Replying to [comment:16 jhpalmieri]:
> What is the doctest supposed to be testing?

That nothing happens if you give the _wrong_ hash value. So basically the test relies on `hash(1) != 2`.


---

Comment by jhpalmieri created at 2019-06-13 18:00:15

The second doctest relies on `hash(1) == 1`. Well, it doesn't rely on it, but if `hash(1) != 1`, then I think it is not testing what is intended.

And of course both rely on Sage Integers being valid hash values, which is what is fixed by the patch you posted to #27886.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by chapoton created at 2019-07-07 07:14:10

should we close this one as invalid ?


---

Comment by jhpalmieri created at 2019-07-08 18:54:44

Because of #28112?


---

Comment by chapoton created at 2019-07-09 19:08:42

rather because of the cython upgrade in #27886, which fixes these doctests in py3


---

Comment by vklein created at 2019-07-10 07:09:58

Replying to [comment:20 chapoton]:
> should we close this one as invalid ?

Sure. All cpython's module tests pass with 8.9.beta1/py3.


---

Comment by vklein created at 2019-07-10 07:10:15

Changing status from needs_info to positive_review.


---

Comment by chapoton created at 2019-07-13 10:21:32

Resolution: wontfix
