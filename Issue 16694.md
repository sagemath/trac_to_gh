# Issue 16694: Elliptic curve point counting over F_q using new PARI

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2014-09-04 12:54:32

CC:  pbruin cremona kedlaya jpflori defeo

The new version of PARI (#15767) supports point counting over `F_q` instead of `F_p`. We should use this new functionality in Sage!


---

Comment by jdemeyer created at 2014-09-04 14:05:52

Never mind the timings, PARI does its own caching now...


---

Comment by jdemeyer created at 2014-09-08 14:18:00

New commits:


---

Comment by git created at 2014-09-08 21:39:06

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-08 22:03:25

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-09 12:28:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2014-09-09 13:55:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-12-11 15:00:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2015-12-11 15:29:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2015-12-11 15:33:25

Changing status from new to needs_review.


---

Comment by cremona created at 2015-12-11 15:59:47

Thanks for your work on this.  First two few small points:

1. In the documentation for ellcard(), we need to say that when self is defined over Q and p is a prime of bad reduction then the number returned is the size of the group of nonsingular points on the reduction (i.e. p-1, p+1 or p depending).  I wondered about this, did some experiments, and then verified with the pari documentation.

2. Why is ellorder() removed?

I think someone other than me should review this.  There is a vast amount of code written by me being removed here, which is hard.  Without going into the details of the pari implementation I would not want to agree to removing the special code for j=0 and j=1728 in characteristics 2 and 3.  We had to do quite a lot of mathematics to get this right, which was not in the literature, and even the examples here are quite instructive.

Secondly, the old code was careful to only ever do counting over the field generated over the prime field by the j-invariant.  From there is is quite easy to get the cardinality of any twist over any extension.  Do you know that pari does that too?  Try taking a curve over a small field, base-changing to an extension, applying  a random twist, and then asking for the cardinality.  With my code it swould take no longer than on the original.  Is that still true?

I thought we had a convention for situations like this, that a Sage-only implementation could be kept and used if some parameter 'algorithm' was set?  The parameter could be 'pari' by default.


---

Comment by jdemeyer created at 2015-12-11 16:07:47

> There is a vast amount of code written by me being removed here, which is hard.

For the record, I totally understand that. I had the same feeling when the PARI people implemented splitting field for polynomials over QQ which completely outperformed my implementation.

However, I consider it a "fact of life" that old code has to make place for new and better code.

> I thought we had a convention for situations like this, that a Sage-only implementation could be kept and used if some parameter 'algorithm' was set? The parameter could be 'pari' by default.

I'm not really sure if that's a convention. Honestly, I don't really see the point of keeping the old code. I did keep all old doctests, which I think is important.


---

Comment by cremona created at 2015-12-11 16:46:19

Replying to [comment:24 jdemeyer]:
> > There is a vast amount of code written by me being removed here, which is hard.
> 
> For the record, I totally understand that. I had the same feeling when the PARI people implemented splitting field for polynomials over QQ which completely outperformed my implementation.

I'm glad you know how this feels.  Does Sage use the pari splitting field implementation now?

> 
> However, I consider it a "fact of life" that old code has to make place for new and better code.

Of course!   There may be some benefit in keeping an independent implementation though, in case of bugs being found later.

> 
> > I thought we had a convention for situations like this, that a Sage-only implementation could be kept and used if some parameter 'algorithm' was set? The parameter could be 'pari' by default.
> 
> I'm not really sure if that's a convention. Honestly, I don't really see the point of keeping the old code. I did keep all old doctests, which I think is important.

Agreed -- and looking more closely I see that you did move the tests for the special cases j=0, 1728 and not *re*move them.  Thanks.

I will ask the pari-devs about the other points.


---

Comment by jdemeyer created at 2015-12-11 19:39:46

Replying to [comment:25 cremona]:
> I'm glad you know how this feels.  Does Sage use the pari splitting field implementation now?
No, it doesn't. PARI only works with irreducible polynomials and I'm not sure if PARI works in the relative case (where the base field is a number field). My implementation is more general.


---

Comment by jdemeyer created at 2015-12-11 19:54:08

Replying to [comment:25 cremona]:
> looking more closely

`git` tip: do you know about the `--patience` option?

The default diff algorithm in `git` tries to minimize the number of changes. But this isn't really what you want, since it might match a random empty line from the old code with an unrelated empty line from the new code. With the `--patience` option, `git` uses a different algorithm which doesn't suffer from this: even though the `diff` will be larger, logical blocks will be kept together.


---

Comment by kedlaya created at 2016-08-18 01:51:32

Merged with current develop branch (7.4beta0). 
----
New commits:


---

Comment by kedlaya created at 2016-08-18 03:12:50

I'm not sure I did this merge correctly. If not, we can switch back to jdemeyer's branch.


---

Comment by jdemeyer created at 2016-08-18 08:51:20

I think it's better to look at #16949 first anyway.


---

Comment by jdemeyer created at 2016-08-18 09:20:27

And in any case, adding 4499 lines to `src/sage/libs/pari/gen.pyx` cannot be right...


---

Comment by jdemeyer created at 2016-08-18 09:20:27

Changing status from needs_review to needs_work.


---

Comment by git created at 2016-08-18 14:28:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2016-08-18 14:30:08

Replying to [comment:23 cremona]:
> Secondly, the old code was careful to only ever do counting over the field generated over the prime field by the j-invariant.  From there is is quite easy to get the cardinality of any twist over any extension.  Do you know that pari does that too?  Try taking a curve over a small field, base-changing to an extension, applying  a random twist, and then asking for the cardinality.  With my code it swould take no longer than on the original.  Is that still true?

This still has to be checked.


---

Comment by jdemeyer created at 2016-08-18 14:38:57

Replying to [comment:25 cremona]:
> I will ask the pari-devs about the other points.

John, did you do this? I don't find anything on the PARI mailing lists.


---

Comment by cremona created at 2016-08-18 19:34:08

Replying to [comment:37 jdemeyer]:
> Replying to [comment:25 cremona]:
> > I will ask the pari-devs about the other points.
> 
> John, did you do this? I don't find anything on the PARI mailing lists.

I emailed Bill and Karim, CC-ing you, and this was their reply (last December):

On Fri, Dec 11, 2015 at 04:58:38PM +0000, John Cremona wrote:
> Dear Karim and Bill,
>
> 1.  I put a lot of effort into the cases j=0 and j=1728, which in
> characteristics 2 and 3 (when they are the same case!) required
> considerable care.  For example, for p=2 the number of isomorphism
> classes is either 3 or 7 depending on the parity of the degree over
> F_2, i.e. that is the number of twists, so the idea is to determine
> which of the 3 or 7 cases you are in and apply the appropriate
> formula.  What does pari do in these cases?

For p=3, this is the function F3xq_ellcardj().
The curve and its twists become identical in some degree-6 extension
of the base field so we can identify the twist by using Kummer theory.
The formula is not straightforward, but optimal for efficiency.

For p=2, I never finished to compute the equivalent formula
(I think one need a degree 24 extension).
So instead we use random points to discriminate between the possible
candidates given by Deuring. This is done in F2xq_ellcard().

I wrote about one-sixth of the formula. If you know about the complete
formula in this case, please tell me!

> 2. If the j-invariant is defined over a much smaller field than the
> field of definition of the curve, then what I do (or Sage does) is to
> point-count on some curve with that j, over the field generated over
> the prime field by j;  use the standard formula to get the point-count
> of that curve over the original field of definition; and then decide
> on whether a final quadratic twist is needed.  Does your code do that?

We do not always do it, because computing minimal polynomial was
quite slow. Quite recently we have added faster methods to compute the
minimal polynomial so we can revisit this point.

Practical example with this would be welcome.

Cheers,
Bill.


---

Comment by jpflori created at 2016-11-17 15:18:13

I also sort of feel it might be useful to keep the old Sage point counting code (exhaustive/bsgs/special j's), modify the _pari version and keep the wrapper dealing with field of definition and special j's.

With this sort of code it is always better to be able to double check results btw two independent implementations.


---

Comment by cremona created at 2016-11-17 15:47:30

Thanks for saying that, as it sounds better not coming from me.  I put a lot of work into that, knowing quite well that it was no good for cryptographically large cases.


---

Comment by roed created at 2017-07-17 17:42:06

Changing keywords from "" to "sd87".


---

Comment by jpflori created at 2017-07-17 19:41:40

From what I see in PARI/GP code, all special cases are now specially treated:
* p=2: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=blob;f=src/basemath/F2xqE.c;h=ea2ad6eb00c5d1f7c03046c454a2fb67aa61eb9e;hb=HEAD#l805 and commit http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=blobdiff;f=src/basemath/F2xqE.c;h=3c183ebcd1bec9545fa489fb2f0303961b2d99b2;hp=a057f8c51201c23f7a7c54390c8f9e6c66c1387c;hb=b2648cdaec00f184010132847748c4dbfa90dfba;hpb=0135506024b4d42f388f68d7b74f41217dd93719
* p=3: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=blob;f=src/basemath/FlxqE.c;h=e91d28ccb66f4c24ffc165f84e667d2f76598741;hb=HEAD#l1576 and commit http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=commit;h=3f93b26f2bdc7188bc59e11b033e2d067274ba14
* p>3: http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=blob;f=src/basemath/FlxqE.c;h=e91d28ccb66f4c24ffc165f84e667d2f76598741;hb=HEAD#l1605 and http://pari.math.u-bordeaux.fr/cgi-bin/gitweb.cgi?p=pari.git;a=blob;f=src/basemath/FpE.c;h=d1574d410a08b9ede9e68b8275afc00d1a18873e;hb=HEAD#l1946


---

Comment by jpflori created at 2017-07-17 19:42:48

I would still suggest we keep John's code even though it's not used by default.
It could still be used to double check PARI/GP results in doctests.


---

Comment by jpflori created at 2017-07-17 19:45:04

Same about Sage's naive and BSGS code.


---

Comment by jpflori created at 2017-07-17 19:45:32

And PARI/GP does not use the "minpoly/field of definition" trick as far as I know.


---

Comment by cremona created at 2018-04-13 08:53:25

Can this ticket be finished off?


---

Comment by jdemeyer created at 2018-04-14 09:01:36

The only remaining questions are:

1. What to do with the old code (mostly written by John Cremona I think).

2. Do we need to implement the "smaller field of definition of the `j`-invariant" trick? As far as I can tell, this is the only optimization which is in the Sage code but not in PARI/GP.


---

Comment by roed created at 2018-04-14 17:04:42

Replying to [comment:48 jdemeyer]:
> The only remaining questions are:
> 
> 1. What to do with the old code (mostly written by John Cremona I think).
> 
> 2. Do we need to implement the "smaller field of definition of the `j`-invariant" trick? As far as I can tell, this is the only optimization which is in the Sage code but not in PARI/GP.

I agree with jpflori that keeping the old code as something to compare with if bugs arise is a good idea.  This also means that we can check to see if the j-invariant is in a subfield of the base field when selecting the algorithm.


---

Comment by jdemeyer created at 2018-04-18 10:05:14

I'm inclined to move all the old code to a new file, say `src/sage/schemes/elliptic_curves/ell_finite_field_cardinality.py` because then it becomes easier to differentiate between the old and the new code.


---

Comment by git created at 2018-04-18 12:15:46

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-04-19 15:33:55

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-04-19 16:07:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-04-19 16:08:11

Changing status from needs_work to needs_review.


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by jdemeyer created at 2018-08-07 14:23:46

If anybody cares about this ticket, let me know. Then I'll rebase this.


---

Comment by cremona created at 2018-08-07 14:27:20

I care -- and will review.


---

Comment by jdemeyer created at 2018-08-07 14:40:19

Even if not strictly required, it might be safest to base this on PARI 2.11 (#25567).


---

Comment by jdemeyer created at 2018-08-07 14:40:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2018-11-13 13:36:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-11-13 13:37:25

Changing status from needs_work to needs_review.


---

Comment by roed created at 2018-11-14 06:48:43

Looks good to me!


---

Comment by roed created at 2018-11-14 06:48:43

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-11-15 22:57:15

Resolution: fixed
