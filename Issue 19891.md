# Issue 19891: QEPCAD crashes after a few calls

archive/issues_019891.json:
```json
{
    "body": "CC:  @mkoeppe @dimpase @rwst tmonteil @jdemeyer\n\nKeywords: QEPCAD, pexpect\n\nUse qepcad to simplify formulas. It works fine on the following simple input.\n\n```\nsage: x, y = var('x,y')\nsage: ellipse = 3*x^2 + 2*x*y + y^2 - x + y - 7\nsage: circle = x^2 + y^2 - 3\nsage: qe = qepcad([ellipse < 0, circle < 0])\nsage: qe\ny^2 + 2 x y + y + 3 x^2 - x - 7 < 0 /\\ y^2 + x^2 - 3 < 0\n```\n\nHowever, calling qepcad a few times causes a crash.\n\n```\nsage: qe = qepcad([ellipse < 0, circle < 0])\nsage: for i in range(200):\n....:     qe = qepcad([ellipse < 0, circle < 0])\nOSError: [Errno 35] Resource temporarily unavailable\n```\n\nOne gets the following similar error if `interact=True` option is used.\n\n```\nRuntimeError: unable to start QEPCAD because the command \n'env qe=/Users/yzh/sage/local qepcad' failed: \nPexpect: pty.fork() failed: [Errno 35] Resource temporarily unavailable\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/20128\n\n",
    "created_at": "2016-02-27T09:09:40Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "QEPCAD crashes after a few calls",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/19891",
    "user": "@yuan-zhou"
}
```
CC:  @mkoeppe @dimpase @rwst tmonteil @jdemeyer

Keywords: QEPCAD, pexpect

Use qepcad to simplify formulas. It works fine on the following simple input.

```
sage: x, y = var('x,y')
sage: ellipse = 3*x^2 + 2*x*y + y^2 - x + y - 7
sage: circle = x^2 + y^2 - 3
sage: qe = qepcad([ellipse < 0, circle < 0])
sage: qe
y^2 + 2 x y + y + 3 x^2 - x - 7 < 0 /\ y^2 + x^2 - 3 < 0
```

However, calling qepcad a few times causes a crash.

```
sage: qe = qepcad([ellipse < 0, circle < 0])
sage: for i in range(200):
....:     qe = qepcad([ellipse < 0, circle < 0])
OSError: [Errno 35] Resource temporarily unavailable
```

One gets the following similar error if `interact=True` option is used.

```
RuntimeError: unable to start QEPCAD because the command 
'env qe=/Users/yzh/sage/local qepcad' failed: 
Pexpect: pty.fork() failed: [Errno 35] Resource temporarily unavailable
```


Issue created by migration from https://trac.sagemath.org/ticket/20128





---

archive/issue_comments_273516.json:
```json
{
    "body": "Do you know whether this tries to start 200 instances of `qepcad`?",
    "created_at": "2016-02-27T09:22:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273516",
    "user": "@dimpase"
}
```

Do you know whether this tries to start 200 instances of `qepcad`?



---

archive/issue_comments_273517.json:
```json
{
    "body": "Sorry, I don't know. How can I find out?\nReplying to [comment:1 dimpase]:\n> Do you know whether this tries to start 200 instances of `qepcad`?",
    "created_at": "2016-03-02T23:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273517",
    "user": "@yuan-zhou"
}
```

Sorry, I don't know. How can I find out?
Replying to [comment:1 dimpase]:
> Do you know whether this tries to start 200 instances of `qepcad`?



---

archive/issue_comments_273518.json:
```json
{
    "body": "What OS do you have this error on? This loop completes on Linux Ubunty 14.10 every time I try (even if I change the range to 2000).\n\nIf I start this loop and watch at the same time the output of `top` I see a lot of python and qepcad processes start. It's not as synchronous as you might think, for some reason; I don't know if it is a bug, I will ask on sage-devel.",
    "created_at": "2016-03-03T09:21:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273518",
    "user": "@dimpase"
}
```

What OS do you have this error on? This loop completes on Linux Ubunty 14.10 every time I try (even if I change the range to 2000).

If I start this loop and watch at the same time the output of `top` I see a lot of python and qepcad processes start. It's not as synchronous as you might think, for some reason; I don't know if it is a bug, I will ask on sage-devel.



---

archive/issue_comments_273519.json:
```json
{
    "body": "I see the same behaviour as Dima: no error, but lots of zombie python and qepcad processes (they get killed when I close the sage session)",
    "created_at": "2016-03-03T10:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273519",
    "user": "@miguelmarco"
}
```

I see the same behaviour as Dima: no error, but lots of zombie python and qepcad processes (they get killed when I close the sage session)



---

archive/issue_comments_273520.json:
```json
{
    "body": "I'm using Mac OS Yosemite Version 10.10.4. Actually I had this error when I tried to run `qepcad` on a series of different inputs in a program. Each time after running a while, Sage (and any other running terminals) crashed with OSError. I give the example in the ticket that uses a loop of 200 same instances for simplicity.",
    "created_at": "2016-03-03T19:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273520",
    "user": "@yuan-zhou"
}
```

I'm using Mac OS Yosemite Version 10.10.4. Actually I had this error when I tried to run `qepcad` on a series of different inputs in a program. Each time after running a while, Sage (and any other running terminals) crashed with OSError. I give the example in the ticket that uses a loop of 200 same instances for simplicity.



---

archive/issue_comments_273521.json:
```json
{
    "body": "this might be a general flackiness of pexpect on OSX. Perhaps for your task it's better to communicate with qepcad via files...",
    "created_at": "2016-03-05T20:18:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273521",
    "user": "@dimpase"
}
```

this might be a general flackiness of pexpect on OSX. Perhaps for your task it's better to communicate with qepcad via files...



---

archive/issue_comments_273522.json:
```json
{
    "body": "It starts 200 instances of `qepcad` and 200 instances of `sage-cleaner`.",
    "created_at": "2016-03-08T08:17:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273522",
    "user": "@mkoeppe"
}
```

It starts 200 instances of `qepcad` and 200 instances of `sage-cleaner`.



---

archive/issue_comments_273523.json:
```json
{
    "body": "Replying to [comment:7 mkoeppe]:\n> It starts 200 instances of `qepcad` and 200 instances of `sage-cleaner`.\n\nnot sure about the latter, but it looks it's by design that the interface is meant to solve one formula in qepcad and quit.This is very much different from e.g. pexpect interface to GAP or Maxima.",
    "created_at": "2016-03-08T09:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273523",
    "user": "@dimpase"
}
```

Replying to [comment:7 mkoeppe]:
> It starts 200 instances of `qepcad` and 200 instances of `sage-cleaner`.

not sure about the latter, but it looks it's by design that the interface is meant to solve one formula in qepcad and quit.This is very much different from e.g. pexpect interface to GAP or Maxima.



---

archive/issue_comments_273524.json:
```json
{
    "body": "Jeroen, \nI wonder if you could have a quick look at the way qepcad interface (ab)uses pexpect; somehow it looks as if pexpect sessions are kept active for no good reason, after the work is done.",
    "created_at": "2016-03-08T10:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273524",
    "user": "@dimpase"
}
```

Jeroen, 
I wonder if you could have a quick look at the way qepcad interface (ab)uses pexpect; somehow it looks as if pexpect sessions are kept active for no good reason, after the work is done.



---

archive/issue_comments_273525.json:
```json
{
    "body": "probably one has to add an explicit call to kill the pexpect interface afer each `qe.quit()` or `qe.finish()`, I only don't know how.",
    "created_at": "2016-03-08T10:37:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273525",
    "user": "@dimpase"
}
```

probably one has to add an explicit call to kill the pexpect interface afer each `qe.quit()` or `qe.finish()`, I only don't know how.



---

archive/issue_comments_273526.json:
```json
{
    "body": "Changing component from interfaces to packages: standard.",
    "created_at": "2016-03-08T12:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273526",
    "user": "@jdemeyer"
}
```

Changing component from interfaces to packages: standard.



---

archive/issue_comments_273527.json:
```json
{
    "body": "Changing keywords from \"QEPCAD, pexpect\" to \"pexpect\".",
    "created_at": "2016-03-08T12:54:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273527",
    "user": "@jdemeyer"
}
```

Changing keywords from "QEPCAD, pexpect" to "pexpect".



---

archive/issue_comments_273528.json:
```json
{
    "body": "Changing component from packages: standard to interfaces: optional.",
    "created_at": "2016-03-08T13:12:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273528",
    "user": "@jdemeyer"
}
```

Changing component from packages: standard to interfaces: optional.



---

archive/issue_comments_273529.json:
```json
{
    "body": "I found two bugs: one in QEPCAD (this ticket) and one in pexpect (see #20178). Fixing any of these two should solve the initially reported problem.",
    "created_at": "2016-03-08T13:13:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273529",
    "user": "@jdemeyer"
}
```

I found two bugs: one in QEPCAD (this ticket) and one in pexpect (see #20178). Fixing any of these two should solve the initially reported problem.



---

archive/issue_comments_273530.json:
```json
{
    "body": "ping?",
    "created_at": "2016-03-25T10:12:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273530",
    "user": "@dimpase"
}
```

ping?



---

archive/issue_comments_273531.json:
```json
{
    "body": "I haven't investigated further, but if you want to help: construct a minimal testcase (not using qepcad, just `pexpect`) which exhibits the problem.",
    "created_at": "2016-03-25T10:15:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273531",
    "user": "@jdemeyer"
}
```

I haven't investigated further, but if you want to help: construct a minimal testcase (not using qepcad, just `pexpect`) which exhibits the problem.



---

archive/issue_comments_273532.json:
```json
{
    "body": "My point is: `pexpect` can be improved (#20178), but for some reason this problem only exhibits itself with qepcad. I don't understand that last part and I don't like fixing bugs that I don't fully understand.",
    "created_at": "2016-03-25T10:17:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273532",
    "user": "@jdemeyer"
}
```

My point is: `pexpect` can be improved (#20178), but for some reason this problem only exhibits itself with qepcad. I don't understand that last part and I don't like fixing bugs that I don't fully understand.



---

archive/issue_comments_273533.json:
```json
{
    "body": "Given that #20178 will involve a patch to upstream `pexpect`, it's especially important to give a simple failing example.",
    "created_at": "2016-03-25T10:18:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273533",
    "user": "@jdemeyer"
}
```

Given that #20178 will involve a patch to upstream `pexpect`, it's especially important to give a simple failing example.



---

archive/issue_comments_273534.json:
```json
{
    "body": "What is the bug in QEPCAD you found?\n\nI have no experience debugging pexpect interfaces; are there some debugging flags one can turn on, any log files that can be made?",
    "created_at": "2016-03-25T11:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273534",
    "user": "@dimpase"
}
```

What is the bug in QEPCAD you found?

I have no experience debugging pexpect interfaces; are there some debugging flags one can turn on, any log files that can be made?



---

archive/issue_comments_273535.json:
```json
{
    "body": "Replying to [comment:19 dimpase]:\n> What is the bug in QEPCAD you found?\n\nI'm not sure anymore that there is a bug, but there is something which makes the QEPCAD interface \"special\" since other interfaces do not have this bug. It's just all very unclear to me.",
    "created_at": "2016-03-25T13:25:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/19891",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/19891#issuecomment-273535",
    "user": "@jdemeyer"
}
```

Replying to [comment:19 dimpase]:
> What is the bug in QEPCAD you found?

I'm not sure anymore that there is a bug, but there is something which makes the QEPCAD interface "special" since other interfaces do not have this bug. It's just all very unclear to me.
