# Issue 19891: QEPCAD crashes after a few calls

Issue created by migration from https://trac.sagemath.org/ticket/20128

Original creator: yzh

Original creation time: 2016-02-27 09:09:40

CC:  mkoeppe dimpase rws tmonteil jdemeyer

Keywords: QEPCAD, pexpect

Use qepcad to simplify formulas. It works fine on the following simple input.

```
sage: x, y = var('x,y')
sage: ellipse = 3*x^2 + 2*x*y + y^2 - x + y - 7
sage: circle = x^2 + y^2 - 3
sage: qe = qepcad([ellipse < 0, circle < 0])
sage: qe
y^2 + 2 x y + y + 3 x^2 - x - 7 < 0 /\ y^2 + x^2 - 3 < 0
```

However, calling qepcad a few times causes a crash.

```
sage: qe = qepcad([ellipse < 0, circle < 0])
sage: for i in range(200):
....:     qe = qepcad([ellipse < 0, circle < 0])
OSError: [Errno 35] Resource temporarily unavailable
```

One gets the following similar error if `interact=True` option is used.

```
RuntimeError: unable to start QEPCAD because the command 
'env qe=/Users/yzh/sage/local qepcad' failed: 
Pexpect: pty.fork() failed: [Errno 35] Resource temporarily unavailable
```



---

Comment by dimpase created at 2016-02-27 09:22:00

Do you know whether this tries to start 200 instances of `qepcad`?


---

Comment by yzh created at 2016-03-02 23:33:41

Sorry, I don't know. How can I find out?
Replying to [comment:1 dimpase]:
> Do you know whether this tries to start 200 instances of `qepcad`?


---

Comment by dimpase created at 2016-03-03 09:21:07

What OS do you have this error on? This loop completes on Linux Ubunty 14.10 every time I try (even if I change the range to 2000).

If I start this loop and watch at the same time the output of `top` I see a lot of python and qepcad processes start. It's not as synchronous as you might think, for some reason; I don't know if it is a bug, I will ask on sage-devel.


---

Comment by mmarco created at 2016-03-03 10:03:54

I see the same behaviour as Dima: no error, but lots of zombie python and qepcad processes (they get killed when I close the sage session)


---

Comment by yzh created at 2016-03-03 19:34:56

I'm using Mac OS Yosemite Version 10.10.4. Actually I had this error when I tried to run `qepcad` on a series of different inputs in a program. Each time after running a while, Sage (and any other running terminals) crashed with OSError. I give the example in the ticket that uses a loop of 200 same instances for simplicity.


---

Comment by dimpase created at 2016-03-05 20:18:26

this might be a general flackiness of pexpect on OSX. Perhaps for your task it's better to communicate with qepcad via files...


---

Comment by mkoeppe created at 2016-03-08 08:17:18

It starts 200 instances of `qepcad` and 200 instances of `sage-cleaner`.


---

Comment by dimpase created at 2016-03-08 09:03:05

Replying to [comment:7 mkoeppe]:
> It starts 200 instances of `qepcad` and 200 instances of `sage-cleaner`.

not sure about the latter, but it looks it's by design that the interface is meant to solve one formula in qepcad and quit.This is very much different from e.g. pexpect interface to GAP or Maxima.


---

Comment by dimpase created at 2016-03-08 10:23:26

Jeroen, 
I wonder if you could have a quick look at the way qepcad interface (ab)uses pexpect; somehow it looks as if pexpect sessions are kept active for no good reason, after the work is done.


---

Comment by dimpase created at 2016-03-08 10:37:56

probably one has to add an explicit call to kill the pexpect interface afer each `qe.quit()` or `qe.finish()`, I only don't know how.


---

Comment by jdemeyer created at 2016-03-08 12:54:53

Changing component from interfaces to packages: standard.


---

Comment by jdemeyer created at 2016-03-08 12:54:53

Changing keywords from "QEPCAD, pexpect" to "pexpect".


---

Comment by jdemeyer created at 2016-03-08 13:12:50

Changing component from packages: standard to interfaces: optional.


---

Comment by jdemeyer created at 2016-03-08 13:13:50

I found two bugs: one in QEPCAD (this ticket) and one in pexpect (see #20178). Fixing any of these two should solve the initially reported problem.


---

Comment by dimpase created at 2016-03-25 10:12:43

ping?


---

Comment by jdemeyer created at 2016-03-25 10:15:43

I haven't investigated further, but if you want to help: construct a minimal testcase (not using qepcad, just `pexpect`) which exhibits the problem.


---

Comment by jdemeyer created at 2016-03-25 10:17:34

My point is: `pexpect` can be improved (#20178), but for some reason this problem only exhibits itself with qepcad. I don't understand that last part and I don't like fixing bugs that I don't fully understand.


---

Comment by jdemeyer created at 2016-03-25 10:18:37

Given that #20178 will involve a patch to upstream `pexpect`, it's especially important to give a simple failing example.


---

Comment by dimpase created at 2016-03-25 11:00:28

What is the bug in QEPCAD you found?

I have no experience debugging pexpect interfaces; are there some debugging flags one can turn on, any log files that can be made?


---

Comment by jdemeyer created at 2016-03-25 13:25:15

Replying to [comment:19 dimpase]:
> What is the bug in QEPCAD you found?

I'm not sure anymore that there is a bug, but there is something which makes the QEPCAD interface "special" since other interfaces do not have this bug. It's just all very unclear to me.
