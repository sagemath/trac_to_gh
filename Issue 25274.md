# Issue 25274: Can we get rid of the Matrix_gfpn_dense(filename) constructor?

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2018-06-05 14:49:07

CC:  simonking

The class `Matrix_gfpn_dense` has a special constructor to create a matrix from a filename. This is a very special case because it is the only case where the first argument is _not_ the parent (the matrix space). Because of this special case, some optimizations that I plan to do in #25505 become harder.

So can we instead require that the first argument when constructing a matrix is always the parent? We can still allow creating a `Matrix_gfpn_dense` from a filename using a classmethod like `Matrix_gfpn_dense.from_filename()`.

This is phrased as a question because I could work around this issue if needed. However, if this filename constructor can be removed, that would make things simpler.


---

Comment by SimonKing created at 2018-06-05 18:44:13

Replying to [ticket:25511 jdemeyer]:
> So can we instead require that the first argument when constructing a matrix is always the parent? We can still allow creating a `Matrix_gfpn_dense` from a filename using a classmethod like `Matrix_gfpn_dense.from_filename()`.

Basically the only reason is history: When I created p_group_cohomology-1.0 and the wrapper for MeatAxe used to be part of the spkg rather than the Sage library, I needed to be able to read matrices from a file created with one of the MeatAxe executables --- and I thought the easiest way is to provide the file to `__init__`. But any other way would be fine, too. And I agree that it would be a lot cleaner to not special case !Matrix_gfpn_dense.
 
> This is phrased as a question because I could work around this issue if needed. However, if this filename constructor can be removed, that would make things simpler.

I would need to change a couple of places in p_group_cohomology (dunno how many places), but that would certainly be doable.


---

Comment by SimonKing created at 2018-06-06 09:52:43

Replying to [ticket:25511 jdemeyer]:
> 1. The class `Matrix_gfpn_dense` has a special (and undocumented!) 

I have an example for it in the doctests, but admittedly in the beginning of the docstring of `__init__` it isn't mentioned.

> 2. Add a new function `new_from_meataxe` to create a new `Matrix_gfpn_dense` from a meataxe `Matrix_t*` and use it where applicable.

That'd certainly be useful. IIRC I have such functions in my cohomology code, but certainly they'd belong here.
 
> 3. Remove `self._cache = {}` and `self._is_immutable = False` where possible because those shouldn't be needed.

Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?


---

Comment by jdemeyer created at 2018-06-06 10:13:52

Replying to [comment:7 SimonKing]:
> Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?

No, it is initialized to `None` which is sufficient.


---

Comment by SimonKing created at 2018-06-06 10:15:36

Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 SimonKing]:
> > Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?
> 
> No, it is initialized to `None` which is sufficient.

Is it? I thought at some point I got an error when I failed to initialise it to an empty dict. But maybe I'm misremembering.


---

Comment by jdemeyer created at 2018-06-06 10:20:24

It is really important to support this:

```
            sage: M = Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)   # optional: meataxe
            sage: N = copy(M)
```


I would prefer to raise an exception when copying an uninitialized matrix.


---

Comment by jdemeyer created at 2018-06-06 10:49:47

New commits:


---

Comment by jdemeyer created at 2018-06-06 10:49:47

Changing status from new to needs_review.


---

Comment by SimonKing created at 2018-06-06 10:58:10

Replying to [comment:11 jdemeyer]:
> It is really important to support this:
> {{{
>             sage: M = Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)   # optional: meataxe
>             sage: N = copy(M)
> }}}
> 
> I would prefer to raise an exception when copying an uninitialized matrix.

It's a corner case, I thought.


---

Comment by SimonKing created at 2018-06-06 11:04:52

The code looks like a good simplification. But probably it won't compile (didn't check, though): Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.


---

Comment by jdemeyer created at 2018-06-06 11:45:28

Conflicts with #25476.


---

Comment by jdemeyer created at 2018-06-06 11:45:28

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2018-06-06 11:45:53

Replying to [comment:16 SimonKing]:
> Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.

Cython can deal with that: it infers the type.


---

Comment by SimonKing created at 2018-06-06 11:48:42

Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 SimonKing]:
> > Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.
> 
> Cython can deal with that: it infers the type.

Seriously? Is that a recent addition? Because in the past I have often seen compiler errors when assigning a C pointer to something that isn't declared as such.


---

Comment by git created at 2018-06-06 11:50:08

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-06 11:51:25

Also conflicts with #25079.


---

Comment by jdemeyer created at 2018-06-06 11:55:26

Replying to [comment:19 SimonKing]:
> Seriously? Is that a recent addition?

It's not recent, Cython has supported that for a long time.

> Because in the past I have often seen compiler errors when assigning a C pointer to something that isn't declared as such.

Curious, maybe there was a different problem.


---

Comment by git created at 2018-06-06 12:13:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-06-06 12:13:45

Changing status from needs_work to needs_review.


---

Comment by git created at 2018-06-06 12:22:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-06 12:42:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-06-07 13:36:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2018-06-08 09:42:28

LGTM. Simon, if you have objects, feel free to revert.


---

Comment by tscrim created at 2018-06-08 09:42:28

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2018-06-08 09:53:52

No objections.

*Edit:* I did look at the changeset introduced here, and it looks good to me. So, if all tests pass and Travis thinks it is good, then I not only have no objections but I support the positive review.

This ticket is the only dependency for #18514. So, I guess I can resume work there.


---

Comment by vbraun created at 2018-06-11 16:31:10

Resolution: fixed
