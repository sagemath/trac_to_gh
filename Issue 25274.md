# Issue 25274: Can we get rid of the Matrix_gfpn_dense(filename) constructor?

archive/issues_025274.json:
```json
{
    "body": "CC:  simonking\n\nThe class `Matrix_gfpn_dense` has a special constructor to create a matrix from a filename. This is a very special case because it is the only case where the first argument is *not* the parent (the matrix space). Because of this special case, some optimizations that I plan to do in #25505 become harder.\n\nSo can we instead require that the first argument when constructing a matrix is always the parent? We can still allow creating a `Matrix_gfpn_dense` from a filename using a classmethod like `Matrix_gfpn_dense.from_filename()`.\n\nThis is phrased as a question because I could work around this issue if needed. However, if this filename constructor can be removed, that would make things simpler.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25511\n\n",
    "created_at": "2018-06-05T14:49:07Z",
    "labels": [
        "linear algebra",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Can we get rid of the Matrix_gfpn_dense(filename) constructor?",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25274",
    "user": "jdemeyer"
}
```
CC:  simonking

The class `Matrix_gfpn_dense` has a special constructor to create a matrix from a filename. This is a very special case because it is the only case where the first argument is *not* the parent (the matrix space). Because of this special case, some optimizations that I plan to do in #25505 become harder.

So can we instead require that the first argument when constructing a matrix is always the parent? We can still allow creating a `Matrix_gfpn_dense` from a filename using a classmethod like `Matrix_gfpn_dense.from_filename()`.

This is phrased as a question because I could work around this issue if needed. However, if this filename constructor can be removed, that would make things simpler.

Issue created by migration from https://trac.sagemath.org/ticket/25511





---

archive/issue_comments_356301.json:
```json
{
    "body": "Replying to [ticket:25511 jdemeyer]:\n> So can we instead require that the first argument when constructing a matrix is always the parent? We can still allow creating a `Matrix_gfpn_dense` from a filename using a classmethod like `Matrix_gfpn_dense.from_filename()`.\n\nBasically the only reason is history: When I created p_group_cohomology-1.0 and the wrapper for MeatAxe used to be part of the spkg rather than the Sage library, I needed to be able to read matrices from a file created with one of the MeatAxe executables --- and I thought the easiest way is to provide the file to `__init__`. But any other way would be fine, too. And I agree that it would be a lot cleaner to not special case !Matrix_gfpn_dense.\n \n> This is phrased as a question because I could work around this issue if needed. However, if this filename constructor can be removed, that would make things simpler.\n\nI would need to change a couple of places in p_group_cohomology (dunno how many places), but that would certainly be doable.",
    "created_at": "2018-06-05T18:44:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356301",
    "user": "SimonKing"
}
```

Replying to [ticket:25511 jdemeyer]:
> So can we instead require that the first argument when constructing a matrix is always the parent? We can still allow creating a `Matrix_gfpn_dense` from a filename using a classmethod like `Matrix_gfpn_dense.from_filename()`.

Basically the only reason is history: When I created p_group_cohomology-1.0 and the wrapper for MeatAxe used to be part of the spkg rather than the Sage library, I needed to be able to read matrices from a file created with one of the MeatAxe executables --- and I thought the easiest way is to provide the file to `__init__`. But any other way would be fine, too. And I agree that it would be a lot cleaner to not special case !Matrix_gfpn_dense.
 
> This is phrased as a question because I could work around this issue if needed. However, if this filename constructor can be removed, that would make things simpler.

I would need to change a couple of places in p_group_cohomology (dunno how many places), but that would certainly be doable.



---

archive/issue_comments_356302.json:
```json
{
    "body": "Replying to [ticket:25511 jdemeyer]:\n> 1. The class `Matrix_gfpn_dense` has a special (and undocumented!) \n\nI have an example for it in the doctests, but admittedly in the beginning of the docstring of `__init__` it isn't mentioned.\n\n> 2. Add a new function `new_from_meataxe` to create a new `Matrix_gfpn_dense` from a meataxe `Matrix_t*` and use it where applicable.\n\nThat'd certainly be useful. IIRC I have such functions in my cohomology code, but certainly they'd belong here.\n \n> 3. Remove `self._cache = {}` and `self._is_immutable = False` where possible because those shouldn't be needed.\n\nWhy? Because Cython would automatically initialise a cdef dict attribute to an empty dict?",
    "created_at": "2018-06-06T09:52:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356302",
    "user": "SimonKing"
}
```

Replying to [ticket:25511 jdemeyer]:
> 1. The class `Matrix_gfpn_dense` has a special (and undocumented!) 

I have an example for it in the doctests, but admittedly in the beginning of the docstring of `__init__` it isn't mentioned.

> 2. Add a new function `new_from_meataxe` to create a new `Matrix_gfpn_dense` from a meataxe `Matrix_t*` and use it where applicable.

That'd certainly be useful. IIRC I have such functions in my cohomology code, but certainly they'd belong here.
 
> 3. Remove `self._cache = {}` and `self._is_immutable = False` where possible because those shouldn't be needed.

Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?



---

archive/issue_comments_356303.json:
```json
{
    "body": "Replying to [comment:7 SimonKing]:\n> Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?\n\nNo, it is initialized to `None` which is sufficient.",
    "created_at": "2018-06-06T10:13:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356303",
    "user": "jdemeyer"
}
```

Replying to [comment:7 SimonKing]:
> Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?

No, it is initialized to `None` which is sufficient.



---

archive/issue_comments_356304.json:
```json
{
    "body": "Replying to [comment:9 jdemeyer]:\n> Replying to [comment:7 SimonKing]:\n> > Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?\n> \n> No, it is initialized to `None` which is sufficient.\n\nIs it? I thought at some point I got an error when I failed to initialise it to an empty dict. But maybe I'm misremembering.",
    "created_at": "2018-06-06T10:15:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356304",
    "user": "SimonKing"
}
```

Replying to [comment:9 jdemeyer]:
> Replying to [comment:7 SimonKing]:
> > Why? Because Cython would automatically initialise a cdef dict attribute to an empty dict?
> 
> No, it is initialized to `None` which is sufficient.

Is it? I thought at some point I got an error when I failed to initialise it to an empty dict. But maybe I'm misremembering.



---

archive/issue_comments_356305.json:
```json
{
    "body": "It is really important to support this:\n\n```\n            sage: M = Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)   # optional: meataxe\n            sage: N = copy(M)\n```\n\n\nI would prefer to raise an exception when copying an uninitialized matrix.",
    "created_at": "2018-06-06T10:20:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356305",
    "user": "jdemeyer"
}
```

It is really important to support this:

```
            sage: M = Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)   # optional: meataxe
            sage: N = copy(M)
```


I would prefer to raise an exception when copying an uninitialized matrix.



---

archive/issue_comments_356306.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-06-06T10:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356306",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_356307.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-06-06T10:49:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356307",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_356308.json:
```json
{
    "body": "Replying to [comment:11 jdemeyer]:\n> It is really important to support this:\n> {{{\n>             sage: M = Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)   # optional: meataxe\n>             sage: N = copy(M)\n> }}}\n> \n> I would prefer to raise an exception when copying an uninitialized matrix.\n\nIt's a corner case, I thought.",
    "created_at": "2018-06-06T10:58:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356308",
    "user": "SimonKing"
}
```

Replying to [comment:11 jdemeyer]:
> It is really important to support this:
> {{{
>             sage: M = Matrix_gfpn_dense.__new__(Matrix_gfpn_dense)   # optional: meataxe
>             sage: N = copy(M)
> }}}
> 
> I would prefer to raise an exception when copying an uninitialized matrix.

It's a corner case, I thought.



---

archive/issue_comments_356309.json:
```json
{
    "body": "The code looks like a good simplification. But probably it won't compile (didn't check, though): Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.",
    "created_at": "2018-06-06T11:04:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356309",
    "user": "SimonKing"
}
```

The code looks like a good simplification. But probably it won't compile (didn't check, though): Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.



---

archive/issue_comments_356310.json:
```json
{
    "body": "Conflicts with #25476.",
    "created_at": "2018-06-06T11:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356310",
    "user": "jdemeyer"
}
```

Conflicts with #25476.



---

archive/issue_comments_356311.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-06T11:45:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356311",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_356312.json:
```json
{
    "body": "Replying to [comment:16 SimonKing]:\n> Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.\n\nCython can deal with that: it infers the type.",
    "created_at": "2018-06-06T11:45:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356312",
    "user": "jdemeyer"
}
```

Replying to [comment:16 SimonKing]:
> Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.

Cython can deal with that: it infers the type.



---

archive/issue_comments_356313.json:
```json
{
    "body": "Replying to [comment:18 jdemeyer]:\n> Replying to [comment:16 SimonKing]:\n> > Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.\n> \n> Cython can deal with that: it infers the type.\n\nSeriously? Is that a recent addition? Because in the past I have often seen compiler errors when assigning a C pointer to something that isn't declared as such.",
    "created_at": "2018-06-06T11:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356313",
    "user": "SimonKing"
}
```

Replying to [comment:18 jdemeyer]:
> Replying to [comment:16 SimonKing]:
> > Often you use a variable `mat` without cdef'ing it --- so, you cannot assign a `Matrix_t*` to it.
> 
> Cython can deal with that: it infers the type.

Seriously? Is that a recent addition? Because in the past I have often seen compiler errors when assigning a C pointer to something that isn't declared as such.



---

archive/issue_comments_356314.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-06T11:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356314",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356315.json:
```json
{
    "body": "Also conflicts with #25079.",
    "created_at": "2018-06-06T11:51:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356315",
    "user": "jdemeyer"
}
```

Also conflicts with #25079.



---

archive/issue_comments_356316.json:
```json
{
    "body": "Replying to [comment:19 SimonKing]:\n> Seriously? Is that a recent addition?\n\nIt's not recent, Cython has supported that for a long time.\n\n> Because in the past I have often seen compiler errors when assigning a C pointer to something that isn't declared as such.\n\nCurious, maybe there was a different problem.",
    "created_at": "2018-06-06T11:55:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356316",
    "user": "jdemeyer"
}
```

Replying to [comment:19 SimonKing]:
> Seriously? Is that a recent addition?

It's not recent, Cython has supported that for a long time.

> Because in the past I have often seen compiler errors when assigning a C pointer to something that isn't declared as such.

Curious, maybe there was a different problem.



---

archive/issue_comments_356317.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-06T12:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356317",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356318.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-06T12:13:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356318",
    "user": "jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_356319.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-06T12:22:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356319",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356320.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-06T12:42:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356320",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_356321.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-07T13:36:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356321",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_356322.json:
```json
{
    "body": "LGTM. Simon, if you have objects, feel free to revert.",
    "created_at": "2018-06-08T09:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356322",
    "user": "tscrim"
}
```

LGTM. Simon, if you have objects, feel free to revert.



---

archive/issue_comments_356323.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-08T09:42:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356323",
    "user": "tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_356324.json:
```json
{
    "body": "No objections.\n\n**Edit:** I did look at the changeset introduced here, and it looks good to me. So, if all tests pass and Travis thinks it is good, then I not only have no objections but I support the positive review.\n\nThis ticket is the only dependency for #18514. So, I guess I can resume work there.",
    "created_at": "2018-06-08T09:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356324",
    "user": "SimonKing"
}
```

No objections.

**Edit:** I did look at the changeset introduced here, and it looks good to me. So, if all tests pass and Travis thinks it is good, then I not only have no objections but I support the positive review.

This ticket is the only dependency for #18514. So, I guess I can resume work there.



---

archive/issue_comments_356325.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-06-11T16:31:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25274",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25274#issuecomment-356325",
    "user": "vbraun"
}
```

Resolution: fixed
