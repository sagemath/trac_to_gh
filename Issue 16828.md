# Issue 16828: use Maxima's trigrat() in symbolic simplify

archive/issues_016828.json:
```json
{
    "body": "Keywords: maxima, simplification, trigonometric\n\nThe ask page\nhttp://ask.sagemath.org/question/11365/simplify-trigonometric-expression/\nshowed that trigrat() is not used. What a waste. \n\nIssue created by migration from https://trac.sagemath.org/ticket/17065\n\n",
    "created_at": "2014-09-29T08:50:53Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "use Maxima's trigrat() in symbolic simplify",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16828",
    "user": "@rwst"
}
```
Keywords: maxima, simplification, trigonometric

The ask page
http://ask.sagemath.org/question/11365/simplify-trigonometric-expression/
showed that trigrat() is not used. What a waste. 

Issue created by migration from https://trac.sagemath.org/ticket/17065





---

archive/issue_comments_222803.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-09-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222803",
    "user": "@rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_222804.json:
```json
{
    "body": "Please review.\n----\nNew commits:",
    "created_at": "2014-09-30T13:50:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222804",
    "user": "@rwst"
}
```

Please review.
----
New commits:



---

archive/issue_comments_222805.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-30T17:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222805",
    "user": "@nbruin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_222806.json:
```json
{
    "body": "Quite some doctest failures on the buildbot. Some of them are probably not due this particular change, but others most probably are. A few are simply *better* answers now (that's just a matter of changing the expected output), but there are also some that are much *worse*. So the change is not uniformly an improvement.\n\nratsimp claims \"canonical form\", so that's definitely attractive. However, do we know if its rewrites always apply across the whole domain? We'd have to document if it deviates.",
    "created_at": "2014-09-30T17:54:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222806",
    "user": "@nbruin"
}
```

Quite some doctest failures on the buildbot. Some of them are probably not due this particular change, but others most probably are. A few are simply *better* answers now (that's just a matter of changing the expected output), but there are also some that are much *worse*. So the change is not uniformly an improvement.

ratsimp claims "canonical form", so that's definitely attractive. However, do we know if its rewrites always apply across the whole domain? We'd have to document if it deviates.



---

archive/issue_comments_222807.json:
```json
{
    "body": "Since setting \"needs_work\" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.",
    "created_at": "2014-10-02T09:29:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222807",
    "user": "@rwst"
}
```

Since setting "needs_work" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.



---

archive/issue_comments_222808.json:
```json
{
    "body": "This can even lead to disaster, I think:\n\n```\nsage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\nsage: F.maxima_methods().trigrat()\nsqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n2*I*sin(2/5*pi) + 1\n```\n\nI really am not interested in seeing `I` turn up in such a simplification, regardless of the \"correct\" answer.",
    "created_at": "2014-10-02T16:02:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222808",
    "user": "@kcrisman"
}
```

This can even lead to disaster, I think:

```
sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
sage: F.maxima_methods().trigrat()
sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
2*I*sin(2/5*pi) + 1
```

I really am not interested in seeing `I` turn up in such a simplification, regardless of the "correct" answer.



---

archive/issue_comments_222809.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-10-03T15:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222809",
    "user": "@nbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_222810.json:
```json
{
    "body": "Replying to [comment:4 rws]:\n> Since setting \"needs_work\" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.\n\nOh, that's silly. I'm setting it back to \"needs review\" to make the report visible for now. Hopefully we can have this fixed.",
    "created_at": "2014-10-03T15:02:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222810",
    "user": "@nbruin"
}
```

Replying to [comment:4 rws]:
> Since setting "needs_work" makes the buildbot link disappear, and I'm too stupid to find the results otherwise (I tried), I cannot sort this out without help, sorry.

Oh, that's silly. I'm setting it back to "needs review" to make the report visible for now. Hopefully we can have this fixed.



---

archive/issue_comments_222811.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-10-03T16:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222811",
    "user": "@rwst"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_222812.json:
```json
{
    "body": "Thanks, the link is now here: http://build.sagedev.org/trac/builders/trac_builder/builds/1046\nso the ticket can be set to the right status.",
    "created_at": "2014-10-03T16:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222812",
    "user": "@rwst"
}
```

Thanks, the link is now here: http://build.sagedev.org/trac/builders/trac_builder/builds/1046
so the ticket can be set to the right status.



---

archive/issue_comments_222813.json:
```json
{
    "body": "Replying to [comment:5 kcrisman]:\n> This can even lead to disaster, I think:\n> {{{\n> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\n> sage: F.maxima_methods().trigrat()\n> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n> 2*I*sin(2/5*pi) + 1\n> }}}\n> I really am not interested in seeing `I` turn up in such a simplification, regardless of the \"correct\" answer.\nWhile this one could be resolved by adding a `trigreduce` to the queue:\n\n```\nsage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\nsage: F.maxima_methods().trigrat()\nsqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n2*I*sin(2/5*pi) + 1\nsage: _.maxima_methods().trigreduce()\nsqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1\n```\n\nI cannot see how to fix the doctest failure:\n\n```\nFile \"src/doc/de/thematische_anleitungen/sage_gymnasium.rst\", line 394, in doc.de.thematische_anleitungen.sage_gymnasium\nFailed example:\n    (sin(x + y)/(log(x) + log(y))).simplify_full()\nExpected:\n    (cos(y)*sin(x) + cos(x)*sin(y))/log(x*y)\nGot:\n    ((-I*arctan2(0, x) - I*arctan2(0, y))*sin(x + y) + log(abs(x)*abs(y))*sin(x + y))/(arctan2(0, x)^2 + 2*arctan2(0, x)*arctan2(0, y) + arctan2(0, y)^2 + log(abs(x))^2 + 2*log(abs(x))*log(abs(y)) + log(abs(y))^2)\n```\n\nthe minimal case being\n\n```\nsage: log(x).maxima_methods().trigrat()\nI*arctan2(0, x) + log(abs(x))\n```\n",
    "created_at": "2014-10-04T13:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222813",
    "user": "@rwst"
}
```

Replying to [comment:5 kcrisman]:
> This can even lead to disaster, I think:
> {{{
> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
> sage: F.maxima_methods().trigrat()
> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
> 2*I*sin(2/5*pi) + 1
> }}}
> I really am not interested in seeing `I` turn up in such a simplification, regardless of the "correct" answer.
While this one could be resolved by adding a `trigreduce` to the queue:

```
sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
sage: F.maxima_methods().trigrat()
sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
2*I*sin(2/5*pi) + 1
sage: _.maxima_methods().trigreduce()
sqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1
```

I cannot see how to fix the doctest failure:

```
File "src/doc/de/thematische_anleitungen/sage_gymnasium.rst", line 394, in doc.de.thematische_anleitungen.sage_gymnasium
Failed example:
    (sin(x + y)/(log(x) + log(y))).simplify_full()
Expected:
    (cos(y)*sin(x) + cos(x)*sin(y))/log(x*y)
Got:
    ((-I*arctan2(0, x) - I*arctan2(0, y))*sin(x + y) + log(abs(x)*abs(y))*sin(x + y))/(arctan2(0, x)^2 + 2*arctan2(0, x)*arctan2(0, y) + arctan2(0, y)^2 + log(abs(x))^2 + 2*log(abs(x))*log(abs(y)) + log(abs(y))^2)
```

the minimal case being

```
sage: log(x).maxima_methods().trigrat()
I*arctan2(0, x) + log(abs(x))
```




---

archive/issue_comments_222814.json:
```json
{
    "body": "On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:\n\n```\nsage: sin(1/8*pi)*sin(3/8*pi)*sin(5/8*pi)*sin(7/8*pi)\nsin(7/8*pi)*sin(5/8*pi)*sin(3/8*pi)*sin(1/8*pi)\nsage: _.maxima_methods().trigreduce()\nTypeError                                 Traceback (most recent call last)\n/home/ralf/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __init__(self, parent, value, is_name, name)\n    624                 self._name = parent._create(value, name=name)\n    625             except (TypeError, RuntimeError, ValueError) as x:\n--> 626                 raise TypeError(x)\n    627 \n    628     def _latex_(self):\n\nTypeError: ECL says: Unrecognised output from sp1sintcos.\n```\n",
    "created_at": "2014-10-04T13:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222814",
    "user": "@rwst"
}
```

On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:

```
sage: sin(1/8*pi)*sin(3/8*pi)*sin(5/8*pi)*sin(7/8*pi)
sin(7/8*pi)*sin(5/8*pi)*sin(3/8*pi)*sin(1/8*pi)
sage: _.maxima_methods().trigreduce()
TypeError                                 Traceback (most recent call last)
/home/ralf/sage/local/lib/python2.7/site-packages/sage/interfaces/interface.pyc in __init__(self, parent, value, is_name, name)
    624                 self._name = parent._create(value, name=name)
    625             except (TypeError, RuntimeError, ValueError) as x:
--> 626                 raise TypeError(x)
    627 
    628     def _latex_(self):

TypeError: ECL says: Unrecognised output from sp1sintcos.
```




---

archive/issue_comments_222815.json:
```json
{
    "body": "Replying to [comment:9 rws]:\n> On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:\n> [...]\nYes, I noticed that one too. I have confirmed that the same problem arises in Maxima 5.34.1 on SBCL, so it's probably a maxima problem. This is now:\n[https://sourceforge.net/p/maxima/bugs/2818/](https://sourceforge.net/p/maxima/bugs/2818/)",
    "created_at": "2014-10-05T18:52:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222815",
    "user": "@nbruin"
}
```

Replying to [comment:9 rws]:
> On the other hand, replacing `trigrat` with `trigsimp/trigexpand/trigreduce` will fail in this case:
> [...]
Yes, I noticed that one too. I have confirmed that the same problem arises in Maxima 5.34.1 on SBCL, so it's probably a maxima problem. This is now:
[https://sourceforge.net/p/maxima/bugs/2818/](https://sourceforge.net/p/maxima/bugs/2818/)



---

archive/issue_comments_222816.json:
```json
{
    "body": "While some of the mentioned problems have been fixed in recent Maxima, this no longer works:\n> {{{\n> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)\n> sage: F.maxima_methods().trigrat()\n> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +\n> 2*I*sin(2/5*pi) + 1\n> sage: _.maxima_methods().trigreduce()\n> sqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1\n> }}}",
    "created_at": "2015-02-11T15:28:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16828",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16828#issuecomment-222816",
    "user": "@rwst"
}
```

While some of the mentioned problems have been fixed in recent Maxima, this no longer works:
> {{{
> sage: F = (4*cos(9*pi/180)^2 - 3)*(4*cos(27*pi/180)^2 - 3)
> sage: F.maxima_methods().trigrat()
> sqrt(5) + 2*cos(7/10*pi) - 2*cos(1/10*pi) - 2*I*sin(3/5*pi) +
> 2*I*sin(2/5*pi) + 1
> sage: _.maxima_methods().trigreduce()
> sqrt(5) - 2*cos(3/10*pi) - 2*cos(1/10*pi) + 1
> }}}
