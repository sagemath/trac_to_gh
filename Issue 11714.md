# Issue 11714: fix scipy so it builds on OS X Lion

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-09-30 21:56:03

Assignee: tbd

CC:  leif mhansen

Keywords: scipy spkg upgrade update lion darwin 11

As the summary says. The new spkg applies the patches [from this commit to the scipy github repo](https://github.com/scipy/scipy/commit/effa6f68f8ada57b79864852b609ff06d2527306).


---

Comment by jhpalmieri created at 2011-09-30 21:57:08

patch for scipy pkg, for review only


---

Comment by jhpalmieri created at 2011-09-30 21:58:02

Changing status from new to needs_review.


---

Attachment


---

Comment by leif created at 2011-09-30 23:15:09

They should really fix the hundreds of warnings...

Builds on Solaris (SPARC), with GCC 4.5.1 (on mark2) at least.


---

Comment by mhansen created at 2011-11-01 19:34:25

Changing status from needs_review to positive_review.


---

Comment by mhansen created at 2011-11-01 19:34:25

These were the changes I had to make before.  Builds on Lion for me.


---

Comment by leif created at 2011-11-01 21:02:50

Changing status from positive_review to needs_work.


---

Comment by leif created at 2011-11-01 21:02:50

Minor thing (another copy-paste accident):

The changelog entries should have `===` (instead of `==`):

```diff
diff --git a/SPKG.txt b/SPKG.txt
--- a/SPKG.txt
+++ b/SPKG.txt
`@``@` -26,20 +26,24 `@``@`
  * Python, which in Sage has numerous dependencies
  * Numpy
  * Fortran
+ * GNU patch
 
 == Special Update/Build Instructions ==
- * None
+ * Make sure the patches still apply.
+   The ones added in the scipy-0.9.p0 spkg (#11886) were all taken from
+   (unstable) upstream, so can presumably be removed once we upgrade to
+   a new stable version.
 
 == Changelog ==
 
-== scipy-0.9.p0 (John Palmieri, 30 Sept 2011) ==
+=== scipy-0.9.p0 (John Palmieri, 30 Sept 2011) ===
  * #11886: get scipy to build on OS X 10.7 Lion, using the patches from
    https://github.com/scipy/scipy/commit/effa6f68f8ada57b79864852b609ff06d2527306
 
-== scipy-0.9 (F. Bissey; 16 March 2011) ===
+=== scipy-0.9 (F. Bissey; 16 March 2011) ===
  * updated the source to 0.9.0. No patches needed.
 
-== scipy-0.8 (S. Reiterer, F. Bissey, D. Kirkby, J. H. Palmieri; 14 October 2010) ===
+=== scipy-0.8 (S. Reiterer, F. Bissey, D. Kirkby, J. H. Palmieri; 14 October 2010) ===
  * #9808 Upgrade to scipy 0.8.
  * Deleted outdated patches
  * spkg install changed by F. Bissey, because g95 makes trouble on OS X.
```


(The merger script is btw. likely to reject the spkg otherwise.)




`spkg-install` isn't executable.

GNU patch should be added to the dependencies.  (See diff above).


```sh
if [ $? -ne 0 ]; then
    echo "Error patching setup.py"
    exit 1
fi
```

should get removed, since no patch gets applied to `setup.py`.

There are a few typos in the comments, and `spkg-install` lacks the usual sanity check.


```diff
diff --git a/spkg-install b/spkg-install
--- a/spkg-install
+++ b/spkg-install
`@``@` -1,10 +1,18 `@``@`
 #!/usr/bin/env bash
-# These flags confuse numpy's distutils.   In particular,
+
+if [ -z "$SAGE_LOCAL" ]; then
+    echo >&2 "Error: SAGE_LOCAL undefined - exiting..."
+    echo >&2 "Maybe run 'sage -sh'?"
+    exit 1
+fi
+
+# These flags confuse numpy's distutils.  In particular,
 # if they are set empty bad things happen.
+unset CFLAGS CXXFLAGS SHAREDFLAGS
+echo "Note: CFLAGS, CXXFLAGS and SHAREDFLAGS are taken from distutils,"
+echo "      so their current settings are ignored."
 
-unset CFLAGS CXXFLAGS SHAREDFLAGS
-
-if [ `uname` = "Darwin" ]; then
+if [ "$UNAME" = "Darwin" ]; then
     unset ATLAS
     unset BLAS
     unset LAPACK
`@``@` -23,43 +31,38 `@``@`
 export F90="$SAGE_LOCAL/bin/sage_fortran"
 export F95="$SAGE_LOCAL/bin/sage_fortran"
 
-
-# This avoid problems on some systems -- until we officially
-# support umfpack (which we will likely do, since cvxopt
-# I think includes it).
-#   http://projects.scipy.org/pipermail/scipy-user/2006-July/008661.html
-# (Currently swig gets invoked by scipy when building the umfpack interace,
+# This avoids problems on some systems -- until we officially
+# support umfpack (which we will likely do, since cvxopt I think includes it):
+UMFPACK="None"; export UMFPACK
+# See http://projects.scipy.org/pipermail/scipy-user/2006-July/008661.html
+# (Currently SWIG gets invoked by scipy when building the umfpack interface,
 # which is bad.)
 
-UMFPACK="None"; export UMFPACK
+
+# Remove previous installation (if any):
 rm -rf "$SAGE_LOCAL"/lib/python/site-packages/scipy
 
 cd src/
 
+# Apply patches (if any):
 for patch in ../patches/*.patch; do
     patch -p1 <"$patch"
     if [ $? -ne 0 ]; then
-        echo >&2 "Error applying '$patch'"
+        echo >&2 "Error applying '$patch'."
         exit 1
     fi
 done
 
+# Build:
+python setup.py build
 if [ $? -ne 0 ]; then
-    echo "Error patching setup.py"
-    exit 1
-fi 
-
-# Build 
-python setup.py build 
-if [ $? -ne 0 ]; then
-    echo "Error building scipy."
+    echo >&2 "Error building scipy."
     exit 1
 fi
 
-# Intall
-python setup.py install 
+# Install:
+python setup.py install
 if [ $? -ne 0 ]; then
-    echo "Error installing scipy."
+    echo >&2 "Error installing scipy."
     exit 1
 fi
-
```

(Take whatever you like, or I could upload an updated spkg.)

I'm not sure whether we should only remove an old installation upon a successful build, after `python setup.py build`, but before running `python setup.py install`.


---

Comment by leif created at 2011-11-01 21:15:57

FWIW, there are so many changes, I've made a p1:

 http://sage.math.washington.edu/home/leif/Sage/spkgs/scipy-0.9.p1.spkg


---

Comment by leif created at 2011-11-01 21:15:57

Changing status from needs_work to needs_review.


---

Comment by leif created at 2011-11-01 21:19:25

Diff between John's p0 and my p1. For reference / review.


---

Comment by jhpalmieri created at 2011-11-01 21:22:11

Changing status from needs_review to positive_review.


---

Attachment

Looks good to me.  The only change I might consider in addition is this:

```diff
diff --git a/SPKG.txt b/SPKG.txt
--- a/SPKG.txt
+++ b/SPKG.txt
`@``@` -33,6 +33,11 `@``@` BSD terms. See http://www.scipy.org/Lice
    The ones added in the scipy-0.9.p0 spkg (#11886) were all taken from
    (unstable) upstream, so can presumably be removed once we upgrade to
    a new stable version.
+ * To do: in spkg-install, should we only remove the previous
+   installation after successfully building the new one?  That is, is
+   it safe to move 'rm -rf "$SAGE_LOCAL"/lib/python/site-packages/scipy' 
+   so it is between 'python setup.py build' and 'python setup.py
+   install'?
 
 == Changelog ==
 
```



---

Comment by leif created at 2011-11-01 21:22:55

I've attached a diff with my changes w.r.t. John's spkg.


---

Comment by jdemeyer created at 2011-11-03 16:14:43

Milestone sage-4.7.3 deleted


---

Comment by jhpalmieri created at 2011-11-05 03:44:29

By the way, this builds and doctests pass on a variety of platforms.


---

Comment by jdemeyer created at 2011-11-07 10:12:25

Resolution: fixed
