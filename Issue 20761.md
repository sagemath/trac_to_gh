# Issue 20761: convert a few cmp to richcmp in some pyx files

Issue created by migration from https://trac.sagemath.org/ticket/20998

Original creator: chapoton

Original creation time: 2016-07-11 12:08:13

CC:  tscrim jmantysalo jdemeyer embray

The first is the current blocking point in py3 compilation.


---

Comment by chapoton created at 2016-07-11 12:09:00

New commits:


---

Comment by chapoton created at 2016-07-11 12:09:00

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-07-11 20:39:41

Changing status from needs_review to needs_work.


---

Comment by vdelecroix created at 2016-07-11 20:39:41

`_cmp_` (one underscore) and `__richcmp__` (two underscores) do not have the same semantic. In your code it seems that you assume that `self` and `other` have the same type and parent... which might not be the case.


---

Comment by vdelecroix created at 2016-07-11 20:43:45

And instead of all this repeated noise you can use `rich_to_bool` from `sage/structure/sage_object.pxd`.


---

Comment by jdemeyer created at 2016-07-11 23:43:02

This is wrong:

```
def __richcmp__(FreeAlgebraElement_letterplace self, other, int op):
```


You should not assume that `self` is of type `FreeAlgebraElement_letterplace`, see also [comment:3].


---

Comment by jdemeyer created at 2016-07-11 23:44:29

And this is not at all a blocking point with Python 3. There is nothing wrong with implementing `_cmp_`, the Sage coercion model should handle it just fine, even for rich comparisons.


---

Comment by chapoton created at 2016-07-12 06:20:18

Sorry, but the line with the command `cmp` in the file `src/sage/algebras/letterplace/free_algebra_element_letterplace.pyx`
is really the place where the py3 compilation currently stops.

Maybe the description should be restored ?


---

Comment by chapoton created at 2016-07-12 07:38:44

Replying to [comment:4 vdelecroix]:
> And instead of all this repeated noise you can use `rich_to_bool` from `sage/structure/sage_object.pxd`.

I do not understand how I could use that and at the same time get rid of using `cmp`.


---

Comment by jdemeyer created at 2016-07-12 08:35:57

First of all, the following are 4 different independent things:

1. Getting rid of `cmp=` arguments to `sort()` for example.

2. Getting rid of the `cmp()` function.

3. Getting rid of `__cmp__` methods.

4. Getting rid of `_cmp_` methods.

The last is not needed because `__richcmp__` will call `_cmp_` if needed.

For the first 3, I really prefer to consider them as different issues and fix them in the order listed above.


---

Comment by jdemeyer created at 2016-07-13 19:20:37

Replying to [comment:7 chapoton]:
> Maybe the description should be restored ?

Feel free to add a clearer description than the original one.


---

Comment by chapoton created at 2016-07-13 19:25:40

sorry, but I am a bit perplexed here. My initial aim was to try to make more pyx files compile correctly. My idea was that one should get rid of using cmp(a, b).

But I feel I do not understand enough the cmp mechanisms to do so properly.

Do you have useful concrete suggestions ? For example

```
git grep -P -c "cmp\(type" *.pyx
```

return something like 25 instances. What to do with them ?


---

Comment by jdemeyer created at 2016-07-13 19:30:23

Replying to [comment:11 chapoton]:
> Do you have useful concrete suggestions ? For example
> {{{
> git grep -P -c "cmp\(type" *.pyx
> }}}
> return something like 25 instances. What to do with them ?
It depends where you find those `cmp(typeA, typeB)`. If it's within a `def __cmp__` method, then that should be cleaned up anyway. If it's somewhere else, I guess the code should be refactored to not compare types (why would you do that anyway?).


---

Comment by jdemeyer created at 2016-07-13 19:32:08

Replying to [comment:11 chapoton]:
> My idea was that one should get rid of using cmp(a, b).

A very good aim! But that's not what your patch is doing. Which makes me confused about the actual purpose of this ticket.


---

Comment by jdemeyer created at 2016-07-13 19:34:44

By the way, we could consider keeping `cmp()`. Even if it doesn't exist in Python 3, we could still implement it in Sage.


---

Comment by jdemeyer created at 2016-07-13 19:35:43

I guess we need to discuss on sage-devel strategies to deal with comparisons. I guess this is the most difficult part of the Python 3 conversion.


---

Comment by chapoton created at 2016-07-13 19:37:33

Indeed, this seems to be tricky. Maybe unicode versus bytes will also be painful.


---

Comment by git created at 2016-07-28 11:21:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-28 13:40:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-28 13:53:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-07-28 18:41:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2016-07-28 19:19:46

I am still waiting for a description of which problem this ticket is addressing.


---

Comment by chapoton created at 2016-07-28 19:25:05

Here is a tentative description. Note that I am now waiting for patchbot's results before setting to needs_review.


---

Comment by chapoton created at 2016-07-28 20:31:12

Changing status from needs_work to needs_info.


---

Comment by chapoton created at 2016-07-28 20:31:12

please tell me what you think..


---

Comment by jdemeyer created at 2016-07-29 07:39:12

Changing status from needs_info to needs_work.


---

Comment by jdemeyer created at 2016-07-29 07:39:12

1. *free_algebra_element_letterplace.pyx*, *semigroups_cython.pyx* and *map.pyx*:

`__richcmp__` bypasses the coercion model which is usually not what you want for `Element` classes. The rule of thumb is that any comparison/arithmetic of Sage `Element`s should use the coercion model unless there is a reason not to. Maybe for `FormalCompositeMap`, there is not much point in using the coercion model. But `FreeAlgebraElement_letterplace` and `LeftZeroSemigroupElement` really are elements where coercion looks useful.

The `_cmp_` and `_richcmp_` methods come from the coercion model, so you are guaranteed equal parents, which likely implies that both arguments are instances of `FreeAlgebraElement_letterplace`, `LeftZeroSemigroupElement` or `FormalCompositeMap`. In that case, you can just drop the type comparison.

2. The function *richcmp_shortcut*:

This should be removed and replaced by the standard Python function `PyObject_RichCompare`. For an example on how to use it, see `src/sage/structure/coerce.pyx`.


---

Comment by git created at 2016-07-29 09:21:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-07-29 09:25:10

Thanks.

I have tried to make changes for your point 2.

I am not quite sure to understand your point 1. Do you suggest that in these 3 files I should replace double-underscored `__richcmp__` methods by single-underscored `_richcmp_` methods, and at the same time remove the check for type equality ?


---

Comment by jdemeyer created at 2016-07-29 10:33:57

Replying to [comment:26 chapoton]:
> Thanks.
> 
> I have tried to make changes for your point 2.

Looks good.

> Do you suggest that in these 3 files I should replace double-underscored `__richcmp__` methods by single-underscored `_richcmp_` methods, and at the same time remove the check for type equality ?

Hard to tell in general because one really needs to understand what the various classes do and which kind of objects you would like to compare. For `FreeAlgebraElement_letterplace` and `LeftZeroSemigroupElement`, the answer to your question is probably "YES", for `FormalCompositeMap` it might be "NO".


---

Comment by git created at 2016-07-31 16:28:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-02 08:14:20

It seems that using `_richcmp_` in `FreeAlgebraElement_letterplace` and `LeftZeroSemigroupElement` breaks many doctests.


---

Comment by jdemeyer created at 2016-08-02 11:24:33

Maybe this is the problem:

```
[sagelib-7.3.rc0] warning: sage/categories/examples/semigroups_cython.pyx:89:4: Overriding cdef method with def method.
[sagelib-7.3.rc0] warning: sage/algebras/letterplace/free_algebra_element_letterplace.pyx:455:4: Overriding cdef method with def method.
```



---

Comment by chapoton created at 2016-08-02 11:56:47

and what would be the cure ?


---

Comment by git created at 2016-08-02 16:20:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-02 18:40:52

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-08-02 18:40:52

bot is green


---

Comment by jdemeyer created at 2016-08-03 06:14:45

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-08-03 06:14:45

Why did you remove

```
        if type(self) != type(other):
            return NotImplemented
```

That's very important to avoid segmentation faults. You should keep that and change `!=` to `is not`.


---

Comment by chapoton created at 2016-08-03 06:17:35

Replying to [comment:34 jdemeyer]:
> Why did you remove
> {{{
>         if type(self) != type(other):
>             return NotImplemented
> }}}
> That's very important to avoid segmentation faults. You should keep that and change `!=` to `is not`.

which file are you talking about, please ? only the map one ?


---

Comment by git created at 2016-08-03 08:12:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-03 08:13:03

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-08-03 08:13:03

is this what you suggested ?


---

Comment by jdemeyer created at 2016-08-03 10:39:40

I think you should add a doctest where you compare a map to something silly, like `None` and the integer `2`.


---

Comment by jdemeyer created at 2016-08-03 10:44:52

To elaborate, in `map.pyx`, you are _not_ using the coercion model. So we should add a test that something sensible happens when comparing a map with something else. If you use `_richcmp_` (single underscores), that's not an issue since the coercion model handles that.


---

Comment by git created at 2016-08-03 12:42:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-08-03 12:48:02

I am not sure we really understand each other. Anyway. I have launched my patchbot on the latest branch. Let us wait for the results.


---

Comment by jdemeyer created at 2016-08-03 12:58:32

I am misunderstanding you since I didn't notice that you changed `def __richcmp__` to `cpdef _richcmp_` in this commit:

|                                                                                                                                           |                                      |
|-------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------|
|[8479374](https://git.sagemath.org/sage.git/commit/?id=84793748dfca6d396d7dfe08ba71a440b05ad66f)|`trac 20998 using cpdef for _richcmp_`|
I thought that you only changed `def _richcmp_` to `cpdef _richcmp_` which would have been the right thing to do.


---

Comment by chapoton created at 2016-08-03 18:36:24

ok, bot is green. Is the current state of affairs ok for you ?


---

Comment by jdemeyer created at 2016-08-04 07:31:27

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-08-04 08:00:14

I am planning some changes to the implementation of comparisons (#21163). In order to avoid conflicts, it would be good to not make further changes to `__cmp__` in other tickets.


---

Comment by chapoton created at 2016-08-04 08:01:27

Replying to [comment:45 jdemeyer]:
> I am planning some changes to the implementation of comparisons (#21163). In order to avoid conflicts, it would be good to not make further changes to `__cmp__` in other tickets.

ok, message received


---

Comment by jdemeyer created at 2016-08-04 10:54:16

I just realized that, for #21163 to work, I need to get rid of most `__cmp__` methods. So that is going to be some work...


---

Comment by jdemeyer created at 2016-08-04 11:35:39

Replying to [comment:47 jdemeyer]:
> I just realized that, for #21163 to work, I need to get rid of most `__cmp__` methods. So that is going to be some work...

Actually, never mind. I found a quick fix for #21163.


---

Comment by jdemeyer created at 2016-08-05 12:07:55

#21163 turned out to be quite easy, so you can freely work on `__cmp__` tickets now. There are more than 300 instances of `def __cmp__`, so this is going to be some work...


---

Comment by vbraun created at 2016-08-07 20:01:18

Resolution: fixed
