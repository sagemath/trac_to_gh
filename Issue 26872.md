# Issue 26872: libffi tries to install to ${prefix}/lib64 on some Linuxes

Issue created by migration from https://trac.sagemath.org/ticket/27109

Original creator: embray

Original creation time: 2019-01-24 13:19:36

CC:  strogdon chapoton jdemeyer

The problem is it unconditionally appends the output of GCC's `-print-multi-os-directory` flag to the install location, whereas when installing in `$SAGE_LOCAL` we just always want `$SAGE_LOCAL/lib`.

This is already [fixed upstream](https://github.com/libffi/libffi/commit/877ea9bf9ac2c98cb858c12f5a6aeeec13cf978f#diff-67e997bcfdac55191033d57a16d1408a) (quite some time ago in fact) so we just need to include that patch.

I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.

In the meantime it may also work to install your distro's libffi-devel package and re-run Sage's `./configure`.


---

Comment by embray created at 2019-01-24 13:20:04

Just in case you have anything to add.


---

Comment by jdemeyer created at 2019-01-24 13:43:25

Replying to [ticket:27109 embray]:
> I'm actually not sure why we're using such an old version.  Maybe just because it's the version that used to be vendored with CPython.

No, it's because there hasn't been a release of libffi since 2014! There is a "libffi 3.3 Release Candidate 0" though: https://github.com/libffi/libffi/releases


---

Comment by jdemeyer created at 2019-01-24 14:22:17

I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?


---

Comment by git created at 2019-01-24 14:51:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-24 14:52:09

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-01-24 14:52:09

A very simple (but admittedly ugly) fix.


---

Comment by strogdon created at 2019-01-24 16:21:33

Replying to [comment:7 jdemeyer]:
> A very simple (but admittedly ugly) fix.
Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?


---

Comment by embray created at 2019-01-24 17:12:54

Replying to [comment:3 jdemeyer]:
> I'm not sure how to proceed here... using that 3.3rc0 in Sage doesn't sound right, so maybe just try to find a simple work-around in the build script?

I was just going to add the patch from upstream (and update `spkg-install` to configure with `--disable-multi-os-directory`.  I was going to do it earlier but I had something else come up.


---

Comment by embray created at 2019-01-24 17:16:03

Replying to [comment:8 strogdon]:
> Replying to [comment:7 jdemeyer]:
> > A very simple (but admittedly ugly) fix.
> Is there potentially something else that is at issue? Sage tries to build `libffi` on my Gentoo box where it fails. I have had `libffi-3.2.1` installed on the Gentoo box for over a year. I do not really need to install `libffi` under Sage. So something did not find my installed `libffi` and tries to install it under Sage. Is a `./configure` necessary? Shouldn't it have been run when typing `make`?

As I mentioned in the description you need _libffi-devel_ or whatever the equivalent is on Gentoo.  Frédéric reported that this worked.

Perhaps we could also add that to the list of build dependencies in the installation instructions.  It's not strictly necessary of course, but if the goal is to get people to build fewer dependencies in Sage then we might as well inform them of what system packages they can use (perhaps as an optional addendum).


---

Comment by strogdon created at 2019-01-24 17:18:26

I believe the `configure` step is not correct. In `config.log` on Gentoo

```
configure:9080: g++ -o conftest -g -O2  -I/usr/include -I/usr/include  -Wl,-O1 -Wl,--as-needed -L/usr/lib -L/usr/lib conftest.cpp -lffi  -lz -lm  >&5
configure:9080: $? = 0
configure:9097: result: -lffi
configure:9110: checking ffi.h usability
configure:9110: g++ -c -g -O2  -I/usr/include -I/usr/include  conftest.cpp >&5
conftest.cpp:58:10: fatal error: ffi.h: No such file or directory
 #include <ffi.h>
          ^~~~~~~
compilation terminated.
```

So the headers cannot be found even though they are installed, but in sort of an `odd` location.


---

Comment by strogdon created at 2019-01-24 17:24:25

On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.


---

Comment by embray created at 2019-01-24 17:26:27

Just using the patch from upstream seems towork (with the necessary changes applied to `configure` as well).

I'm not sure if we really need to bump the package-version.txt either since the package will have never installed successfully in the first place for anyone affected by this.
----
New commits:


---

Comment by strogdon created at 2019-01-24 17:40:52

Replying to [comment:12 strogdon]:
> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.
So even after running `./configure` I see

```
configure: === checking whether to install the libffi SPKG ===
checking for library containing ffi_call... -lffi
checking ffi.h usability... no
checking ffi.h presence... no
checking for ffi.h... no
checking ffi/ffi.h usability... no
checking ffi/ffi.h presence... no
checking for ffi/ffi.h... no
```

Since the headers are in a `non-standard` location they are not found. This `non-standard` location is where the `libffi` package installs the headers by default.


---

Comment by git created at 2019-01-24 17:58:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2019-01-24 17:58:49

Replying to [comment:12 strogdon]:
> On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.

I just pushed an update that might help with that.


---

Comment by embray created at 2019-01-24 18:09:29

FWIW Python (which is AFAIK the main package for which we install libffi as a dependency (and even then we're not using it yet since Python<3.7 has a vendored copy)) also uses pkg-config, where available, to get the libffi CFLAGS, so this gel nicely with Python in this respect.


---

Comment by strogdon created at 2019-01-24 18:11:54

Replying to [comment:16 embray]:
> Replying to [comment:12 strogdon]:
> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.
> 
> I just pushed an update that might help with that.
OK, let me give that a try. Curiously, on Gentoo even though install of the `libffi` libraries failed, the headers were installed (under local/lib/libffi-3.2.1/include) as well as `local/lib/pkgconfig/libffi.pc`?


---

Comment by strogdon created at 2019-01-24 18:39:12

Replying to [comment:16 embray]:
> Replying to [comment:12 strogdon]:
> > On Gentoo the `libffi` headers are installed under `/usr/lib/libffi-3.2.1/include/`.
> 
> I just pushed an update that might help with that.
This appears to do the trick here. Now from `config.log`

```
pkg_cv_LIBFFI_CFLAGS=-I/usr/lib64/libffi-3.2.1/include
pkg_cv_LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'
```

and

```
LIBFFI_CFLAGS='-I/usr/lib64/libffi-3.2.1/include'
LIBFFI_LIBS='-L/usr/lib64/../lib64 -lffi'
```



---

Comment by cnassau created at 2019-01-25 09:34:52

I'm seeing current build failures related to libffi on "OpenSuse Leap 15.0":

```
[libffi-3.2.1] Copying package files from temporary location /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst to /waste/jenkins/local
[libffi-3.2.1] cp: cannot overwrite non-directory '/waste/jenkins/local/./lib64' with directory '/waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64'
```

Here the "/waste/jenkins/local/./lib64" is a symbolic link to "lib", so I do not really understand the error message:

```
jenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/var/tmp/sage/build/libffi-3.2.1/inst/waste/jenkins/local/./lib64
total 116
-rw-r--r-- 1 jenkins jenkins 60312 Jan 25 03:23 libffi.a
-rwxr-xr-x 1 jenkins jenkins   956 Jan 25 03:23 libffi.la
lrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so -> libffi.so.6.0.4
lrwxrwxrwx 1 jenkins jenkins    15 Jan 25 03:23 libffi.so.6 -> libffi.so.6.0.4
-rwxr-xr-x 1 jenkins jenkins 46568 Jan 25 03:23 libffi.so.6.0.4
jenkins@jehova:/waste/jenkins> ll /waste/jenkins/local/./lib64
lrwxrwxrwx 1 jenkins jenkins 3 Jan 24 22:48 /waste/jenkins/local/./lib64 -> lib
```



---

Comment by jdemeyer created at 2019-01-25 09:40:03

I don't like how this ticket is turning from "fix this one specific libffi install issue blocking installation of Sage" to "let's fix everything related to ffi in Sage".

Can we please focus on the first issue only and keep the rest for other tickets?


---

Comment by jdemeyer created at 2019-01-25 09:43:39

I split this ticket in two, see #27114 for further fixes.


---

Comment by jdemeyer created at 2019-01-25 09:45:49

Changing status from needs_review to positive_review.


---

Comment by embray created at 2019-01-25 10:51:07

I think splitting it seems a bit pointless to me, but since you did it already then that's fine.


---

Comment by jdemeyer created at 2019-01-27 10:05:59

I was hoping for this ticket to be merged in 8.7.beta1, but unfortunately that hasn't happened.


---

Comment by vbraun created at 2019-01-27 10:54:48

Resolution: fixed
