# Issue 18034: Stanley hook content formula

archive/issues_018034.json:
```json
{
    "body": "CC:  sage-combinat\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/18271\n\n",
    "created_at": "2015-04-21T17:15:05Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.7",
    "title": "Stanley hook content formula",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/18034",
    "user": "https://github.com/deinst"
}
```
CC:  sage-combinat



Issue created by migration from https://trac.sagemath.org/ticket/18271





---

archive/issue_comments_242474.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2015-04-21T17:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242474",
    "user": "https://github.com/deinst"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_242475.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to combinatorics.",
    "created_at": "2015-04-21T17:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242475",
    "user": "https://github.com/deinst"
}
```

Changing component from PLEASE CHANGE to combinatorics.



---

archive/issue_comments_242476.json:
```json
{
    "body": "Set assignee to @deinst.",
    "created_at": "2015-04-21T17:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242476",
    "user": "https://github.com/deinst"
}
```

Set assignee to @deinst.



---

archive/issue_comments_242477.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2015-04-21T17:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242477",
    "user": "https://github.com/deinst"
}
```

Changing priority from major to minor.



---

archive/issue_comments_242478.json:
```json
{
    "body": "New commits:",
    "created_at": "2015-04-23T15:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242478",
    "user": "https://github.com/deinst"
}
```

New commits:



---

archive/issue_comments_242479.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-04-23T15:53:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242479",
    "user": "https://github.com/deinst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_242480.json:
```json
{
    "body": "This definitely sounds like a good idea. Could you do some timings with `%timeit` on small/large partitions with small/large `max_part`? It might also be faster to do the fraction division at each step to get cancellations sooner. Also, I think it is a good idea to have both implementations (accessible via an `algorithm` keyword with the default being the hook formula) as they are different algorithms and can be used as cross-checks in tests.\n\nIt's slightly worrisome that we're abusing `Composition` here, but that's a side note.",
    "created_at": "2015-04-23T16:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242480",
    "user": "https://github.com/tscrim"
}
```

This definitely sounds like a good idea. Could you do some timings with `%timeit` on small/large partitions with small/large `max_part`? It might also be faster to do the fraction division at each step to get cancellations sooner. Also, I think it is a good idea to have both implementations (accessible via an `algorithm` keyword with the default being the hook formula) as they are different algorithms and can be used as cross-checks in tests.

It's slightly worrisome that we're abusing `Composition` here, but that's a side note.



---

archive/issue_comments_242481.json:
```json
{
    "body": "I'll implement both algorithms.\nI'll get some timings. \nHow do I force the fraction divisions to be done in Q?  I've run into the situation where sometimes the division is truncating (like python default) and sometimes creates rational numbers.  These different behaviors can occur for apparently identical calls. (see the abandoned commit)\n\nI'll also spell Corollary correctly.",
    "created_at": "2015-04-23T17:10:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242481",
    "user": "https://github.com/deinst"
}
```

I'll implement both algorithms.
I'll get some timings. 
How do I force the fraction divisions to be done in Q?  I've run into the situation where sometimes the division is truncating (like python default) and sometimes creates rational numbers.  These different behaviors can occur for apparently identical calls. (see the abandoned commit)

I'll also spell Corollary correctly.



---

archive/issue_comments_242482.json:
```json
{
    "body": "You could try something like this:\n\n```python\nres = Integer(1)\nfor i,l in enumerate(self.shape):\n    for j in range(l):\n        res *= Integer(self.max_entry + j -i) / (l + conj[j] - i - j - 1)\nreturn res\n```\n\n(which becomes something else to compare timings with), where the division is as Sage integers, which becomes rational numbers instead of doing python `int` division (which is `//` or floor division). Translating your first commit, you could do:\n\n```python\nfrom sage.combinat.partition import Partitions\nnumber = prod(Integer(self.max_entry + self.shape.content(*c)) / self.shape.hook_length(*c)\n              for c in self.shape.cells())\n```\n\n(although the hook length should return a Sage integer and there shouldn't be a problem...).",
    "created_at": "2015-04-23T17:23:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242482",
    "user": "https://github.com/tscrim"
}
```

You could try something like this:

```python
res = Integer(1)
for i,l in enumerate(self.shape):
    for j in range(l):
        res *= Integer(self.max_entry + j -i) / (l + conj[j] - i - j - 1)
return res
```

(which becomes something else to compare timings with), where the division is as Sage integers, which becomes rational numbers instead of doing python `int` division (which is `//` or floor division). Translating your first commit, you could do:

```python
from sage.combinat.partition import Partitions
number = prod(Integer(self.max_entry + self.shape.content(*c)) / self.shape.hook_length(*c)
              for c in self.shape.cells())
```

(although the hook length should return a Sage integer and there shouldn't be a problem...).



---

archive/issue_comments_242483.json:
```json
{
    "body": "Thanks.\nThe reason I abandoned that first commit was that  it was running into exactly that problem.\nSometimes SemistandardTableaux([2,1,1,1], max_entry=5).cardinality() would return 24 (correct) and sometimes it would return 12 (incorrect).",
    "created_at": "2015-04-23T17:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242483",
    "user": "https://github.com/deinst"
}
```

Thanks.
The reason I abandoned that first commit was that  it was running into exactly that problem.
Sometimes SemistandardTableaux([2,1,1,1], max_entry=5).cardinality() would return 24 (correct) and sometimes it would return 12 (incorrect).



---

archive/issue_comments_242484.json:
```json
{
    "body": "Some timings.\nAlgorithms)\nsum:  This is the current algorithm that sums over the weights\nhook: (default) This is the implementation that computes the hook_lengths and contents directly and sums the numerator and denominator separately.\nhook2:  This lets the Partition object compute the hook lengths and the contents of the cells and does the summation in QQ\nhook3: This is the same as hook, but does the summation in QQ .\n\nsage: t1 = SemistandardTableaux([2,1,1,1], max_entry=5)\nsage: t2 = SemistandardTableaux([4,3,2,1], max_entry=12)\nsage: timeit(\"t1.cardinality(algorithm='sum')\")\n125 loops, best of 3: 5.31 ms per loop\nsage: timeit(\"t1.cardinality()\")\n625 loops, best of 3: 41.8 \u00b5s per loop\nsage: timeit(\"t1.cardinality(algorithm='hook2')\")\n625 loops, best of 3: 198 \u00b5s per loop\nsage: timeit(\"t1.cardinality(algorithm='hook3')\")\n625 loops, best of 3: 66.2 \u00b5s per loop\nsage: timeit(\"t2.cardinality(algorithm='sum')\")\n5 loops, best of 3: 33.4 s per loop\nsage: timeit(\"t2.cardinality()\")\n625 loops, best of 3: 52.7 \u00b5s per loop\nsage: timeit(\"t2.cardinality(algorithm='hook2')\")\n625 loops, best of 3: 409 \u00b5s per loop\nsage: timeit(\"t2.cardinality(algorithm='hook3')\")\n625 loops, best of 3: 74.8 \u00b5s per loop\n\n\nIt appears that summing the numerator and denominator separately is the fastest way to do things, at least for reasonable size problems.  It also appears that the hook length formula is already two orders of magnitude faster than what we have now for small problems.\n\nAlthough letting the partition object compute the hook lengths and contents leads to marginally clearer code, it is noticeably slower, and the direct computation is not very complicated, I think that it is best to go with the marginally more complicated code.",
    "created_at": "2015-04-23T20:40:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242484",
    "user": "https://github.com/deinst"
}
```

Some timings.
Algorithms)
sum:  This is the current algorithm that sums over the weights
hook: (default) This is the implementation that computes the hook_lengths and contents directly and sums the numerator and denominator separately.
hook2:  This lets the Partition object compute the hook lengths and the contents of the cells and does the summation in QQ
hook3: This is the same as hook, but does the summation in QQ .

sage: t1 = SemistandardTableaux([2,1,1,1], max_entry=5)
sage: t2 = SemistandardTableaux([4,3,2,1], max_entry=12)
sage: timeit("t1.cardinality(algorithm='sum')")
125 loops, best of 3: 5.31 ms per loop
sage: timeit("t1.cardinality()")
625 loops, best of 3: 41.8 µs per loop
sage: timeit("t1.cardinality(algorithm='hook2')")
625 loops, best of 3: 198 µs per loop
sage: timeit("t1.cardinality(algorithm='hook3')")
625 loops, best of 3: 66.2 µs per loop
sage: timeit("t2.cardinality(algorithm='sum')")
5 loops, best of 3: 33.4 s per loop
sage: timeit("t2.cardinality()")
625 loops, best of 3: 52.7 µs per loop
sage: timeit("t2.cardinality(algorithm='hook2')")
625 loops, best of 3: 409 µs per loop
sage: timeit("t2.cardinality(algorithm='hook3')")
625 loops, best of 3: 74.8 µs per loop


It appears that summing the numerator and denominator separately is the fastest way to do things, at least for reasonable size problems.  It also appears that the hook length formula is already two orders of magnitude faster than what we have now for small problems.

Although letting the partition object compute the hook lengths and contents leads to marginally clearer code, it is noticeably slower, and the direct computation is not very complicated, I think that it is best to go with the marginally more complicated code.



---

archive/issue_comments_242485.json:
```json
{
    "body": "So then go with the fastest as the default then as it seems like there's not a lot of cancellations. I'd still prefer to have the breakdown by weight as a separate algorithm though.",
    "created_at": "2015-04-23T20:54:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242485",
    "user": "https://github.com/tscrim"
}
```

So then go with the fastest as the default then as it seems like there's not a lot of cancellations. I'd still prefer to have the breakdown by weight as a separate algorithm though.



---

archive/issue_comments_242486.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-23T22:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242486",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242487.json:
```json
{
    "body": "Thank you. I also made some reviewer tweaks, so if you're happy with my changes, then you can set a positive review.\n----\nNew commits:",
    "created_at": "2015-04-25T07:01:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242487",
    "user": "https://github.com/tscrim"
}
```

Thank you. I also made some reviewer tweaks, so if you're happy with my changes, then you can set a positive review.
----
New commits:



---

archive/issue_comments_242488.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-04-25T07:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242488",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_242489.json:
```json
{
    "body": "Looks great to me.\n\nSemistandardTableaux_size needs a similar (more trivial) enhancement.  Should I stick it here, or open a new ticket.",
    "created_at": "2015-04-25T17:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242489",
    "user": "https://github.com/deinst"
}
```

Looks great to me.

SemistandardTableaux_size needs a similar (more trivial) enhancement.  Should I stick it here, or open a new ticket.



---

archive/issue_comments_242490.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-04-25T17:03:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242490",
    "user": "https://github.com/deinst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_242491.json:
```json
{
    "body": "On a new ticket is best.",
    "created_at": "2015-04-25T17:29:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242491",
    "user": "https://github.com/tscrim"
}
```

On a new ticket is best.



---

archive/issue_comments_242492.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-04-26T02:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/18034",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/18034#issuecomment-242492",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
