# Issue 20777: make: docbuilding should depend on jmol

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2016-07-13 18:09:45

See https://groups.google.com/d/msg/sage-devel/SlpXXtK_Cy0/QynwDq2gAAAJ and https://groups.google.com/d/msg/sage-release/jQmE2nsnbDI/u32jH0vOAQAJ.


---

Comment by jhpalmieri created at 2016-07-13 18:12:07

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2016-07-13 18:12:07

New commits:


---

Comment by jdemeyer created at 2016-07-13 18:17:56

Changing priority from critical to blocker.


---

Comment by vbraun created at 2016-07-13 18:34:07

If we make plots then we run arbitrary Sage code. So all runtime dependencies are docbuild dependencies, no? And if not then somebody just hasn't make a sufficiently complicated plot yet. What I'm proposing thus is to just use a dependency like

```
doc-html: all-build
```



---

Comment by dimpase created at 2016-07-13 18:54:40

indeed, trouble probably started few months ago when people did few tickets putting nicer pictures into the docs.


---

Comment by jdemeyer created at 2016-07-13 18:57:36

Replying to [comment:4 vbraun]:
> If we make plots then we run arbitrary Sage code. So all runtime dependencies are docbuild dependencies, no? And if not then somebody just hasn't make a sufficiently complicated plot yet. What I'm proposing thus is to just use a dependency like
> {{{
> doc-html: all-build
> }}}

This used to be the case a while ago, but it makes the parallel build less efficient. For example, currently R can be built in parallel with the docs. With your proposal, parallel builds would take more time. I'm not saying that this is a huge problem, just pointing it out.


---

Comment by jhpalmieri created at 2016-07-13 19:00:55

We could add `sagelib` to the docbuilding dependencies.


---

Comment by vbraun created at 2016-07-13 20:49:48

Replying to [comment:6 jdemeyer]:
> This used to be the case a while ago, but it makes the parallel build less efficient. For example, currently R can be built in parallel with the docs

Yes, until somebody adds an R plot to the docs. Then suddenly you get hard-to-debug parallel build failures.


---

Comment by jhpalmieri created at 2016-07-13 20:57:30

Replying to [comment:7 jhpalmieri]:
> We could add `sagelib` to the docbuilding dependencies.

Sorry, it's already there. Never mind.


---

Comment by dimpase created at 2016-07-13 21:39:55

Replying to [comment:6 jdemeyer]:
> Replying to [comment:4 vbraun]:
> > If we make plots then we run arbitrary Sage code. So all runtime dependencies are docbuild dependencies, no? And if not then somebody just hasn't make a sufficiently complicated plot yet. What I'm proposing thus is to just use a dependency like
> > {{{
> > doc-html: all-build
> > }}}
> 
> This used to be the case a while ago, but it makes the parallel build less efficient. For example, currently R can be built in parallel with the docs. 

but this is only true as long as there is no doctest using R somewhere you do not expect it to be used.



With your proposal, parallel builds would take more time. I'm not saying that this is a huge problem, just pointing it out.


---

Comment by jdemeyer created at 2016-07-14 09:07:05

Replying to [comment:8 vbraun]:
> Then suddenly you get hard-to-debug parallel build failures. 

You could easily add a buildbot testing `make distclean; make doc`.


---

Comment by jdemeyer created at 2016-07-14 13:01:46

Sorry, but this issue `worksforme`. What is the exact issue that we're trying to solve here? The ticket description should be more explicit.


---

Comment by jdemeyer created at 2016-07-14 13:01:46

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2016-07-14 13:33:46

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2016-07-14 13:59:13

That's not very explicit. What _exactly_ is the problem since I cannot reproduce it?


---

Comment by jdemeyer created at 2016-07-14 13:59:13

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2016-07-14 14:02:32

Also: it's not a problem if _doctests_ use jmol, this is only about _docbuilding_.


---

Comment by dimpase created at 2016-07-14 14:10:27

I don't think that the fact that not everybody can reproduce this (race conditions are not easy in this sense) should postpone this ticket.


---

Comment by dimpase created at 2016-07-14 14:10:27

Changing status from needs_info to positive_review.


---

Comment by jhpalmieri created at 2016-07-14 15:10:20

The issue is that some plots in the documentation require jmol, so if jmol happens not to be built early enough, docbuilding can fail. I just saw this yesterday on a fresh copy of 7.3.beta7, and there are other reports in sage-devel and sage-release.


---

Comment by jdemeyer created at 2016-07-14 15:22:41

Replying to [comment:17 jhpalmieri]:
> The issue is that some plots in the documentation require jmol, so if jmol happens not to be built early enough, docbuilding can fail.

I understand that, but nobody has been explicit about _which_ plot is the one which is supposed to fail without jmol. And again, I cannot reproduce the problem: for me, the doc builds *without* jmol.

I really don't like to add a "fix" for a problem when it's not at all clear what the problem is and whether the "fix" fixes it.

I feel that the problem is more subtle and we're missing something here...


---

Comment by jdemeyer created at 2016-07-14 15:22:41

Changing status from positive_review to needs_info.


---

Comment by jhpalmieri created at 2016-07-14 20:15:06

It fails for me. Here's what I did: I started with a fresh tarball, ran `make jmol` and then deleted `local/bin/jmol` and `local/share/jmol/`. Then I ran `make`. Docbuilding now fails every time, with the error as in the attached log file (extracted from `dochtml.log`).


---

Attachment


---

Comment by strogdon created at 2016-07-14 21:23:27

There are numerous `.txt` files under `.sage/temp/...` that probably contain something like

```
Error: Unable to access jarfile $SAGE_ROOT/local/share/jmol/JmolData.jar
```

which is to be expected. I wonder what is in these `.txt` files for those that get failures when `jmol` is installed.


---

Comment by vbraun created at 2016-07-14 22:36:17

I did a `make distclean && make doc-html` of plain 7.3.beta7 and it failed as expected with 

```
[dochtml] [plot3d   ] RuntimeError: Jmol failed to create file '/home/vbraun/.sage/temp/volker-desktop/31502/dir_EhlRBl/preview.png', see '/home/vbraun/.sage/temp/volker-desktop/31502/tmp_tX4EGj.txt' for details
```

I'm pretty sure thats 100% reproducable, though takes a long time.


---

Comment by jdemeyer created at 2016-07-15 07:26:31

Replying to [comment:21 vbraun]:
> I'm pretty sure thats 100% reproducable

I'm pretty sure thats not the case.


---

Comment by jdemeyer created at 2016-07-15 07:28:18

I agree with strogdon, it would be good to see also the `.txt` files that the error messages refer to.


---

Comment by vbraun created at 2016-07-15 07:39:13

The txt files are auto-deleted by the sage cleaner. In any case I can tell you whats wrong, jmol is not a dependency of `make doc-html` so it is not built:

```
$ ./sage -sh -c jmol
/bin/bash: jmol: command not found
```



---

Comment by jhpalmieri created at 2016-07-15 15:29:15

Those `.txt` files say:

```
Error: Unable to access jarfile /Users/palmieri/Desktop/Sage_stuff/sage_builds/clean/sage-7.3.beta7/local/share/jmol/JmolData.jar
```



---

Comment by jdemeyer created at 2016-07-15 15:55:16

Further analysis points to this `if` switch in `src/sage/plot/plot3d/base.pyx` in the `_rich_repr_jmol()` function:

```
        if not jdata.is_jvm_available():
            # We can only use JMol to generate preview if a jvm is installed
            from sage.repl.rich_output.output_graphics import OutputImagePng
            tachyon = self._rich_repr_tachyon(OutputImagePng, **opts)
            tachyon.png.save_as(preview_png)
        else:
            # Java needs absolute paths
            # On cygwin, they should be native ones
            scene_native = scene_zip
            import sys
            if sys.platform == 'cygwin':
                from subprocess import check_output, STDOUT
                scene_native = check_output(['cygpath', '-w', scene_native],
                                            stderr=STDOUT).rstrip()
            script = *set defaultdirectory "{0}"\nscript SCRIPT\n*.format(scene_native)
            jdata.export_image(targetfile=preview_png, datafile=script,
                               image_type="PNG",
                               figsize=opts['figsize'][0])
```


So the problem only occurs if Java is installed.

But this leaves the question: if Tachyon works, why not always use Tachyon to produce the plots?


---

Comment by jdemeyer created at 2016-07-15 15:59:00

To anybody which does have a working Java: does the interactive JMol applet actually work in the generated documentation? If not, there is no point in using JMol for those plots.


---

Comment by vbraun created at 2016-07-15 16:26:17

We use jmol (and java) to build the png preview of the plot server-side. This is then displayed by the notebook until the 3-d plot is activated by clicking on it. The actual in-browser animation is via jsmol (javascript).


---

Comment by dimpase created at 2016-07-16 09:30:46

Changing status from needs_info to positive_review.


---

Comment by dimpase created at 2016-07-16 09:30:46

besides, the quality of plots produced by Tachyon is not as good as with jmol...


---

Comment by dimpase created at 2016-07-16 09:43:11

tachyon output


---

Attachment

jmol output (smoother, no artefacts...)


---

Comment by vbraun created at 2016-07-17 08:41:52

Resolution: fixed
