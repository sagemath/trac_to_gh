# Issue 33110: Enforce MathJax for every page of Sage documentation

Issue created by migration from https://trac.sagemath.org/ticket/33347

Original creator: klee

Original creation time: 2022-02-15 05:27:49

HTML pages of our documentation that contain maths only in TOC trees do not render maths by MathJax because Sphinx does not include MathJax javascript files as the Sphinx MathJax extension does not recognize maths in TOC trees and to save loading time. See for instance,

  https://doc.sagemath.org/html/en/reference/schemes/index.html

There could be several solutions in the order of preference:

1. Fix in the upstream Sphinx MathJax extension. A relevant discussion is

  https://github.com/sphinx-doc/sphinx/issues/10192

2. Add dummy :math:... to every inflicted pages to enable MathJax.

3. Enable MathJax by brute force by adding line
  {{{#!python
  html_js_files = ['MathJax.js?config=TeX-AMS_HTML-full', 
  'mathjax_sage.js']
  }}} 
  for `conf` files. But this results in duplicate MathJax inclusion 
  in the generated html file.

A good solution would be implemented in this ticket.


---

Comment by jhpalmieri created at 2022-02-15 05:34:54

I don't know much about html. What is the disadvantage to duplicate MathJax inclusion in html files?


---

Comment by jhpalmieri created at 2022-02-15 05:36:48

We could also adopt a style that strongly discourages math from titles, and we could replace (for example) ``p`-adic` by `<em>p</em>-adic`. Html can handle boldface, italics, subscripts, and superscripts, and that probably covers almost all of our math usage in tables of contents.


---

Comment by klee created at 2022-02-15 05:44:44

Replying to [comment:2 jhpalmieri]:
> I don't know much about html. What is the disadvantage to duplicate MathJax inclusion in html files?

Perhaps the same disadvantage of running a program twice, aside aesthetic reason.


---

Comment by klee created at 2022-02-15 05:51:09

Replying to [comment:3 jhpalmieri]:
> We could also adopt a style that strongly discourages math from titles, and we could replace (for example) ``p`-adic` by `<em>p</em>-adic`. Html can handle boldface, italics, subscripts, and superscripts, and that probably covers almost all of our math usage in tables of contents.

Doc files are in reStructuredText format. HTML tags do not work in rst files, as I understand.

If Sphinx people do not help, then we may go for the option (2) somehow.


---

Comment by jhpalmieri created at 2022-02-15 05:53:19

Replying to [comment:4 klee]:
> Replying to [comment:2 jhpalmieri]:
> > I don't know much about html. What is the disadvantage to duplicate MathJax inclusion in html files?
> 
> Perhaps the same disadvantage of running a program twice, aside aesthetic reason.

The web page https://developer.yahoo.com/performance/rules.html claims that duplicate inclusion of javascript files hurts performance.


---

Comment by jhpalmieri created at 2022-02-15 05:54:27

Replying to [comment:5 klee]:
> Replying to [comment:3 jhpalmieri]:
> > We could also adopt a style that strongly discourages math from titles, and we could replace (for example) ``p`-adic` by `<em>p</em>-adic`. Html can handle boldface, italics, subscripts, and superscripts, and that probably covers almost all of our math usage in tables of contents.
> 
> Doc files are in reStructuredText format.

No kidding.

> HTML tags do not work in rst files, as I understand.

rst can also do bold, italics, superscripts, and subscripts.


---

Comment by klee created at 2022-02-15 06:04:24

Replying to [comment:7 jhpalmieri]:
> > HTML tags do not work in rst files, as I understand.
> 
> rst can also do bold, italics, superscripts, and subscripts.

Okay, then.


---

Comment by jhpalmieri created at 2022-03-04 02:39:26

How would you like to proceed? Should we start converting math in module titles to bold, italics, etc.?


---

Comment by klee created at 2022-03-04 04:46:43

Replying to [comment:9 jhpalmieri]:
> How would you like to proceed? Should we start converting math in module titles to bold, italics, etc.?

I would like to go for the option 1 or 2. If Sphinx people do not provide an official way to enforce MathJax inclusion, then we may investigate unofficial ways (such as tweaking Shinx's `MathDomain` somehow, where `has_equation` test is defined). If we fail, then a simplest (but a bit ugly) solution is the option 2 (adding dummy math nodes).

I really don't like the option 4, which would make our documentation include maths in an alternative format.

Anyway I am busy now for my main work. Let me get back to this ticket later.


---

Comment by klee created at 2022-03-04 12:05:00

For the option 2, this dummy works pretty well:

```diff
--- a/src/doc/en/reference/finite_rings/index.rst
+++ b/src/doc/en/reference/finite_rings/index.rst
@@ -1,5 +1,8 @@
 Finite Rings
-====================================
+============
+
+.. math::
+   :nowrap:
 
 Finite Rings
 ------------
```


Getting maths back by adding this bit of ugly thing seems worth it.


---

Comment by jhpalmieri created at 2022-03-04 22:27:28

This single change works, since `footer.txt` is imported into the various index files:

```diff
diff --git a/src/doc/en/reference/footer.txt b/src/doc/en/reference/footer.txt
index fa7bc30eea..e9b5166be4 100644
--- a/src/doc/en/reference/footer.txt
+++ b/src/doc/en/reference/footer.txt
@@ -1,6 +1,9 @@
 Indices and Tables
 ==================
 
+.. math::
+   :nowrap:
+
 * `Index <../genindex.html>`_
 * `Module Index <../py-modindex.html>`_
 * `Search Page <../search.html>`_
```



---

Comment by jhpalmieri created at 2022-03-04 22:30:40

I can push a branch with that change (+ some minor fixes for the TOC entries for the p-adics page) if you want.


---

Comment by klee created at 2022-03-05 03:38:04

Replying to [comment:13 jhpalmieri]:
> I can push a branch with that change (+ some minor fixes for the TOC entries for the p-adics page) if you want.

Please go ahead. Thank you.


---

Comment by klee created at 2022-03-05 03:43:51

Moreover we may need to add somewhere in the developer manual a remark about the purpose of the added lines to prevent anyone from deleting the seemingly useless lines.


---

Comment by klee created at 2022-03-05 03:45:57

Replying to [comment:12 jhpalmieri]:
> This single change works, since `footer.txt` is imported into the various index files.

Good idea!


---

Comment by jhpalmieri created at 2022-03-05 17:00:03

Okay, here is a branch. Before this, about half of the p-adic TOC entries used ``p`-adic` and the rest used `p-adic` (no math mode); now they all use the former.
----
New commits:


---

Comment by jhpalmieri created at 2022-03-05 17:00:38

Changing status from new to needs_review.


---

Comment by klee created at 2022-03-06 03:30:54

As in

https://en.wikipedia.org/wiki/P-adic_analysis

p-adic seems in a better style than p-Adic in titles. If you agree, I can upload a commit to apply this style to p-adics.


---

Comment by slelievre created at 2022-03-06 13:08:58

Replying to [comment:20 klee]:
> As in
> 
> https://en.wikipedia.org/wiki/P-adic_analysis
> 
> p-adic seems in a better style than p-Adic in titles.

+1.

Good main title "p-adic analysis" there,
subsection title "P-adic quantum mechanics" needs work:

- https://en.wikipedia.org/wiki/P-adic_analysis#P-adic_quantum_mechanics

though the main title "p-adic_quantum_mechanics"
at the dedicated page for it is good:

- https://en.wikipedia.org/wiki/P-adic_quantum_mechanics


---

Comment by klee created at 2022-03-06 14:41:13

New commits:


---

Comment by klee created at 2022-03-06 14:46:41

I am positive on the branch. But let me do the final check on the built documentation.


---

Comment by git created at 2022-03-06 18:34:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-03-06 18:34:59

One easy-to-fix doctest failure, otherwise looks good to me.

For a future ticket: if we can think of a way to solve it, changing the html title of the web page to not use math would be nice. As it is, the title bar in my browser says `Ring \(\ZZ/n\ZZ\) of integers modulo \(n\) — Finite Rings`. Is there a handy way to autoconvert the title?


---

Comment by klee created at 2022-03-07 01:14:29

Replying to [comment:25 jhpalmieri]:
> For a future ticket: if we can think of a way to solve it, changing the html title of the web page to not use math would be nice. As it is, the title bar in my browser says `Ring \(\ZZ/n\ZZ\) of integers modulo \(n\) — Finite Rings`. Is there a handy way to autoconvert the title?

Simply removing `\(`, `\)` pairs, backslashes, (and `$` perhaps) would be enough. This could be done on the fly by javascript...


---

Comment by klee created at 2022-03-07 07:08:54

Morally greenbot.


---

Comment by klee created at 2022-03-07 07:08:54

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-03-07 07:55:19

Replying to [comment:26 klee]:
> Simply removing `\(`, `\)` pairs, backslashes, (and `$` perhaps) would be enough. This could be done on the fly by javascript...

Done in #33475.


---

Comment by vbraun created at 2022-03-09 23:38:04

Resolution: fixed
