# Issue 27804: MR22: Docker python3

Issue created by migration from https://trac.sagemath.org/ticket/28041

Original creator: galois

Original creation time: 2019-06-21 15:35:56

CC:  saraedum zerline roed

Samuel LeliÃ¨vre ([`@`slel](https://gitlab.com/slel)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/22:
----

```markdown
Update .gitlab-ci.yml, Makefile, docker/Dockerfile, docker/build-docker.sh for Python 3.
```









---

Comment by slelievre created at 2019-06-21 16:37:37

Changing component from PLEASE CHANGE to distribution.


---

Comment by slelievre created at 2019-06-21 16:37:37

Changing type from PLEASE CHANGE to enhancement.


---

Comment by slelievre created at 2019-06-21 16:37:37

Changing keywords from "" to "docker, py3, gitlab-ci".


---

Comment by slelievre created at 2019-06-21 16:38:37

Still need to make the changes to the `docker/*.sh` shell scripts.


---

Comment by slelievre created at 2019-06-21 17:51:44

Changing status from needs_review to needs_work.


---

Comment by slelievre created at 2019-06-21 17:51:44

Changing keywords from "docker, py3, gitlab-ci" to "docker, py3, gitlab-ci, days101".


---

Comment by embray created at 2019-07-03 13:10:12

I'm trying to get this working, but the build is stalling out at:


```
Step 61/80 : RUN sudo $SAGE_ROOT/sage --nodotsage -c "install_scripts('/usr/bin')"
 ---> Running in d4ce02ca02d6
Forcing sage-location, probably because a new package was installed.
Cleaning up, do not interrupt this.
Done cleaning.
Traceback (most recent call last):
  File "/home/sage/sage/src/bin/sage-eval", line 4, in <module>
    from sage.all import *
ImportError: No module named sage.all
The command '/bin/sh -c sudo $SAGE_ROOT/sage --nodotsage -c "install_scripts('/usr/bin')"' returned a non-zero code: 1
```


The problem is that `SAGE_PYTHON_VERSION` is not being set properly when running `$SAGE_ROOT/sage`.

This is because there are _two_ copies of `sage-env-config`, where `SAGE_PYTHON_VERSION` is defined:  One under `$SAGE_ROOT/src/bin` and one other `$SAGE_ROOT/local/bin`.  This is normal when doing Sage development, and I believe, if it exists, it's the one under `src/bin` that will be used by default when developing/building.

The problem in this case is that although the one in `local/bin` correctly has `SAGE_PYTHON_VERSION=3`, the one in `src/bin` still has `SAGE_PYTHON_VERSION=2` for some reason.

I wonder if this is a remnant from an earlier build stage that was cached, but not properly updated for some reason (I thought that different `--build-arg` flags would avoid use incompatible cached images built with different `--build-arg`s, but it's possible that that arg isn't being included in the build early enough.


---

Comment by embray created at 2019-07-03 13:29:16

The problem seems to start here:


```
Step 56/80 : RUN make micro_release
 ---> Using cache
 ---> 2fc1a353e2ac
```


When running `make micro_release`, `./configure` gets re-run, but without any flags we passed it previously.  So it doesn't preserve our `--with-python=3` from earlier.


---

Comment by embray created at 2019-07-03 13:29:53

(CC Odile who was interested in having a working Python 3 Docker image)


---

Comment by saraedum created at 2019-07-03 13:34:04

Sorry for this. We had already figured the broken `./configure` when `micro_release` is run. I thought that Samuel had pushed a fix for this here already.


---

Comment by saraedum created at 2019-07-03 13:35:29

Isn't the preservation of `config` good enough for this? (See the changeset here.)


---

Comment by embray created at 2019-07-03 13:37:23

I was just about to say: I think the preservation of `config.status` is good enough in fact.


---

Comment by embray created at 2019-07-03 13:38:45

Specifically, one of the prereqs of `micro_release` is the `bdist-clean` target, which in turn calls `$(MAKE) misc-clean` which deletes `config.status`, forcing `configure` to be re-run.


---

Comment by saraedum created at 2019-07-03 13:45:30

What the `bdist-clean`? Is this a automake target? Otherwise is it reasonable that the build system's config is visible after running it?


---

Comment by embray created at 2019-07-03 13:47:39

Not sure, but I think just swapping `sagelib-clean` and `bdist-clean` in the prereqs for `micro_release` should suffice.  It's fragile, but I think it will work.  Testing now.


---

Comment by embray created at 2019-07-03 13:51:37

Replying to [comment:11 saraedum]:
> What the `bdist-clean`? Is this a automake target? Otherwise is it reasonable that the build system's config is visible after running it?

No, this is just a pseudo-target in Sage's top-level Makefile.  I have no idea why specifically it's named that.  It's also used by the `fast-rebuild-clean` target.  It just calls `clean` (which is in `build/make/Makefile` for some reason), and then `misc-clean`.

All `clean` does apparently is:


```
clean:
    @echo "Deleting package build directories..."
    rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"
```


which is certainly worth doing.  But maybe this needs to be detangled a bit...


---

Comment by slelievre created at 2019-07-03 14:40:18

The following files in `docker/` probably still need changes:

- `build-docker.sh`
- `pull-gitlab.sh`
- `push-dockerhub.sh`
- `push-gitlab.sh`
- `setup-make-parallelity.sh`
- `test-dev.sh`
- `update-env.sh`


---

Comment by embray created at 2019-07-04 12:40:40

Yes, most likely.  One I just get the docker build working locally I will try adding all the other relevant updates.

It would be nice for starters to get _a_ Python 3 image on Docker Hub, even if I have to push it manually, then get future ones building automatically.


---

Comment by saraedum created at 2019-07-04 16:45:59

I think that once your Dockerfile goes through, you just need to add your branch to `build-from-clean`, pull your image from the [GitLab](GitLab) registry and push it to Docker Hub.


---

Comment by embray created at 2019-07-09 16:21:58

For Odile's use I went ahead and pushed a prototype of this up to Dockerhub: sagemath/sagemath-dev-py3:alpha

Unfortunately it still has a bug.  The `sage-entrypoint` still tries to run `make build` (understandably) which results in re-configuring (needlessly) and breaking things.

A workaround for now is to set the PREREQ_OPTIONS variable which is used by Sage's top-level Makefile when it runs configure.  So you can set this when running the container like:


```
docker run -ti --rm -e PREREQ_OPTIONS='--with-python=3' sagemath/sagemath-dev-py3:alpha
```


Next up, I think we should modify the Docker build to at least keep config.status so that this doesn't keep happening.


---

Comment by embray created at 2019-07-11 14:59:28

Apparently I was not able to successfully upload the Docker image to hub.docker.com because (AFAICT) of [this issue](https://github.com/moby/moby/issues/33558#issuecomment-510479853).

But I was able to upload it to our image registry on gitlab.com.   So try:


```
docker run -ti --rm -e PREREQ_OPTIONS='--with-python=3' registry.gitlab.com/sagemath/dev/sage/sagemath-dev-py3:alpha
```


You can also use this image as a base for another Docker image by doing something like:


```
FROM registry.gitlab.com/sagemath/dev/sage/sagemath-dev-py3:alpha
ENV PREREQ_OPTIONS='--with-python=3'
...
```


That is, you would ensure `PREREQ_OPTIONS` is set as an environment variable in the new image, by default.

This is not ideal and should be fixed, but it's a start anyways...


---

Comment by git created at 2019-08-19 19:09:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-19 19:37:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-19 20:36:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-19 20:43:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-08-20 01:03:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-20 01:16:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-20 01:46:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-20 02:05:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-08-20 03:18:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-08-20 03:22:51

Changing status from needs_work to needs_review.


---

Comment by saraedum created at 2019-08-20 03:23:14

See #28367 for the related README update.


---

Comment by saraedum created at 2019-08-20 04:06:17

We pushed initial docker `-py3` images to the Docker Hub.


---

Comment by git created at 2019-08-20 04:09:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-08-20 04:15:02

New commits:


---

Comment by saraedum created at 2019-08-20 04:15:02

Changing status from needs_review to needs_work.


---

Comment by saraedum created at 2019-08-20 23:58:00

Changing status from needs_work to needs_review.


---

Comment by embray created at 2019-08-21 10:50:08

When this is for sure ready can we squash some of these commits?


---

Comment by embray created at 2019-08-21 11:01:50

Just out of curiosity, is there a specific meaning to having a section in `.gitlab-ci.yml` that begins with a `.`, as in `.py3`?  Does that just emphasize that it's not a real build stage (rather a "mix-in" for multiple build stages)?  Or is that a syntax specifically recognized by the file format?

If I understand correctly, this is now keeping `config.status` in the image.  But what if someone runs `sage -i <some_optional_package>` in one of these py3 images?  In other words, if a user (or dockerfile author) does something that still results in `./configure` being re-run, will this keep the `--with-python=3` setting?

I fear not, since we still haven't fully resolved #27373 (which related to system package settings specifically, but more broadly to retaining the values of flags passed to `./configure`).  The larger problem of course being that we have "runtime" features like `sage -i` that depend on running `./configure` at all...


---

Comment by saraedum created at 2019-08-21 14:31:55

Replying to [comment:36 embray]:
> When this is for sure ready can we squash some of these commits?

Feel free to squash.


---

Comment by saraedum created at 2019-08-21 14:33:52

Replying to [comment:37 embray]:
> Just out of curiosity, is there a specific meaning to having a section in `.gitlab-ci.yml` that begins with a `.`, as in `.py3`?  Does that just emphasize that it's not a real build stage (rather a "mix-in" for multiple build stages)?  Or is that a syntax specifically recognized by the file format?

Without out the `.` it would be a build job. As a default as port of the `test` stage I believe.

> If I understand correctly, this is now keeping `config.status` in the image.  But what if someone runs `sage -i <some_optional_package>` in one of these py3 images?  In other words, if a user (or dockerfile author) does something that still results in `./configure` being re-run, will this keep the `--with-python=3` setting?

Does `sage -i` run `configure` when `config.status` is present?

> I fear not, since we still haven't fully resolved #27373 (which related to system package settings specifically, but more broadly to retaining the values of flags passed to `./configure`).  The larger problem of course being that we have "runtime" features like `sage -i` that depend on running `./configure` at all...

I don't think making `--with-python=3` persistent is within the scope of this ticket. But it's certainly a problem that we should be aware of.


---

Comment by git created at 2019-09-06 02:34:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-06 03:09:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-13 08:48:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-13 08:51:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-09-13 09:02:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-09-13 09:04:54

the docker images should be available on binder shortly: https://gitlab.com/sagemath/dev/trac/pipelines/81996545


---

Comment by git created at 2019-09-13 09:35:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-09-13 09:38:01

I started a full `build-from-clean` here: https://gitlab.com/sagemath/dev/trac/pipelines/82005383


---

Comment by git created at 2019-09-13 09:40:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by saraedum created at 2019-09-13 15:44:27

The Python 2 and Python 3 images seem to be functional. (At least they work in Binder.)


---

Comment by roed created at 2019-09-13 22:36:21

Looks good to me.  Both Python 2 and Python 3 built fine.


---

Comment by roed created at 2019-09-13 22:36:21

Changing status from needs_review to positive_review.


---

Comment by saraedum created at 2019-09-16 08:54:42

Changing status from positive_review to needs_work.


---

Comment by saraedum created at 2019-09-16 08:54:42

Not sure if this comes from the changes here, but there's a `MAKEFLAGS=w -j -l7.8 --jobserver-fds=3,4 V=1` in the output. Let me try to see who put the `w` there.


---

Comment by saraedum created at 2019-09-16 08:58:04

Ok. That's how it's supposed to work https://lists.gnu.org/archive/html/help-make/2016-03/msg00009.html.


---

Comment by saraedum created at 2019-09-16 08:58:04

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2019-09-30 08:12:27

moving milestone to 9.0 (after release of 8.9)


---

Comment by vbraun created at 2019-10-03 17:58:09

Resolution: fixed
