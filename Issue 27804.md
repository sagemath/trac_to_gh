# Issue 27804: MR22: Docker python3

archive/issues_027804.json:
```json
{
    "body": "CC:  @saraedum zerline @roed314\n\nSamuel Leli\u00e8vre ([`@`slel](https://gitlab.com/slel)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/22:\n----\n\n```markdown\nUpdate .gitlab-ci.yml, Makefile, docker/Dockerfile, docker/build-docker.sh for Python 3.\n```\n\n\n\n\n\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28041\n\n",
    "created_at": "2019-06-21T15:35:56Z",
    "labels": [
        "component: please change"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.0",
    "title": "MR22: Docker python3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27804",
    "user": "https://trac.sagemath.org/admin/accounts/users/galois"
}
```
CC:  @saraedum zerline @roed314

Samuel LeliÃ¨vre ([`@`slel](https://gitlab.com/slel)) opened a merge request at https://gitlab.com/sagemath/sage/merge_requests/22:
----

```markdown
Update .gitlab-ci.yml, Makefile, docker/Dockerfile, docker/build-docker.sh for Python 3.
```








Issue created by migration from https://trac.sagemath.org/ticket/28041





---

archive/issue_comments_392276.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to distribution.",
    "created_at": "2019-06-21T16:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392276",
    "user": "https://github.com/slel"
}
```

Changing component from PLEASE CHANGE to distribution.



---

archive/issue_comments_392277.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2019-06-21T16:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392277",
    "user": "https://github.com/slel"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_392278.json:
```json
{
    "body": "Changing keywords from \"\" to \"docker, py3, gitlab-ci\".",
    "created_at": "2019-06-21T16:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392278",
    "user": "https://github.com/slel"
}
```

Changing keywords from "" to "docker, py3, gitlab-ci".



---

archive/issue_comments_392279.json:
```json
{
    "body": "Still need to make the changes to the `docker/*.sh` shell scripts.",
    "created_at": "2019-06-21T16:38:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392279",
    "user": "https://github.com/slel"
}
```

Still need to make the changes to the `docker/*.sh` shell scripts.



---

archive/issue_comments_392280.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-06-21T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392280",
    "user": "https://github.com/slel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_392281.json:
```json
{
    "body": "Changing keywords from \"docker, py3, gitlab-ci\" to \"docker, py3, gitlab-ci, days101\".",
    "created_at": "2019-06-21T17:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392281",
    "user": "https://github.com/slel"
}
```

Changing keywords from "docker, py3, gitlab-ci" to "docker, py3, gitlab-ci, days101".



---

archive/issue_comments_392282.json:
```json
{
    "body": "I'm trying to get this working, but the build is stalling out at:\n\n\n```\nStep 61/80 : RUN sudo $SAGE_ROOT/sage --nodotsage -c \"install_scripts('/usr/bin')\"\n ---> Running in d4ce02ca02d6\nForcing sage-location, probably because a new package was installed.\nCleaning up, do not interrupt this.\nDone cleaning.\nTraceback (most recent call last):\n  File \"/home/sage/sage/src/bin/sage-eval\", line 4, in <module>\n    from sage.all import *\nImportError: No module named sage.all\nThe command '/bin/sh -c sudo $SAGE_ROOT/sage --nodotsage -c \"install_scripts('/usr/bin')\"' returned a non-zero code: 1\n```\n\n\nThe problem is that `SAGE_PYTHON_VERSION` is not being set properly when running `$SAGE_ROOT/sage`.\n\nThis is because there are *two* copies of `sage-env-config`, where `SAGE_PYTHON_VERSION` is defined:  One under `$SAGE_ROOT/src/bin` and one other `$SAGE_ROOT/local/bin`.  This is normal when doing Sage development, and I believe, if it exists, it's the one under `src/bin` that will be used by default when developing/building.\n\nThe problem in this case is that although the one in `local/bin` correctly has `SAGE_PYTHON_VERSION=3`, the one in `src/bin` still has `SAGE_PYTHON_VERSION=2` for some reason.\n\nI wonder if this is a remnant from an earlier build stage that was cached, but not properly updated for some reason (I thought that different `--build-arg` flags would avoid use incompatible cached images built with different `--build-arg`s, but it's possible that that arg isn't being included in the build early enough.",
    "created_at": "2019-07-03T13:10:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392282",
    "user": "https://github.com/embray"
}
```

I'm trying to get this working, but the build is stalling out at:


```
Step 61/80 : RUN sudo $SAGE_ROOT/sage --nodotsage -c "install_scripts('/usr/bin')"
 ---> Running in d4ce02ca02d6
Forcing sage-location, probably because a new package was installed.
Cleaning up, do not interrupt this.
Done cleaning.
Traceback (most recent call last):
  File "/home/sage/sage/src/bin/sage-eval", line 4, in <module>
    from sage.all import *
ImportError: No module named sage.all
The command '/bin/sh -c sudo $SAGE_ROOT/sage --nodotsage -c "install_scripts('/usr/bin')"' returned a non-zero code: 1
```


The problem is that `SAGE_PYTHON_VERSION` is not being set properly when running `$SAGE_ROOT/sage`.

This is because there are *two* copies of `sage-env-config`, where `SAGE_PYTHON_VERSION` is defined:  One under `$SAGE_ROOT/src/bin` and one other `$SAGE_ROOT/local/bin`.  This is normal when doing Sage development, and I believe, if it exists, it's the one under `src/bin` that will be used by default when developing/building.

The problem in this case is that although the one in `local/bin` correctly has `SAGE_PYTHON_VERSION=3`, the one in `src/bin` still has `SAGE_PYTHON_VERSION=2` for some reason.

I wonder if this is a remnant from an earlier build stage that was cached, but not properly updated for some reason (I thought that different `--build-arg` flags would avoid use incompatible cached images built with different `--build-arg`s, but it's possible that that arg isn't being included in the build early enough.



---

archive/issue_comments_392283.json:
```json
{
    "body": "The problem seems to start here:\n\n\n```\nStep 56/80 : RUN make micro_release\n ---> Using cache\n ---> 2fc1a353e2ac\n```\n\n\nWhen running `make micro_release`, `./configure` gets re-run, but without any flags we passed it previously.  So it doesn't preserve our `--with-python=3` from earlier.",
    "created_at": "2019-07-03T13:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392283",
    "user": "https://github.com/embray"
}
```

The problem seems to start here:


```
Step 56/80 : RUN make micro_release
 ---> Using cache
 ---> 2fc1a353e2ac
```


When running `make micro_release`, `./configure` gets re-run, but without any flags we passed it previously.  So it doesn't preserve our `--with-python=3` from earlier.



---

archive/issue_comments_392284.json:
```json
{
    "body": "(CC Odile who was interested in having a working Python 3 Docker image)",
    "created_at": "2019-07-03T13:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392284",
    "user": "https://github.com/embray"
}
```

(CC Odile who was interested in having a working Python 3 Docker image)



---

archive/issue_comments_392285.json:
```json
{
    "body": "Sorry for this. We had already figured the broken `./configure` when `micro_release` is run. I thought that Samuel had pushed a fix for this here already.",
    "created_at": "2019-07-03T13:34:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392285",
    "user": "https://github.com/saraedum"
}
```

Sorry for this. We had already figured the broken `./configure` when `micro_release` is run. I thought that Samuel had pushed a fix for this here already.



---

archive/issue_comments_392286.json:
```json
{
    "body": "Isn't the preservation of `config` good enough for this? (See the changeset here.)",
    "created_at": "2019-07-03T13:35:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392286",
    "user": "https://github.com/saraedum"
}
```

Isn't the preservation of `config` good enough for this? (See the changeset here.)



---

archive/issue_comments_392287.json:
```json
{
    "body": "I was just about to say: I think the preservation of `config.status` is good enough in fact.",
    "created_at": "2019-07-03T13:37:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392287",
    "user": "https://github.com/embray"
}
```

I was just about to say: I think the preservation of `config.status` is good enough in fact.



---

archive/issue_comments_392288.json:
```json
{
    "body": "Specifically, one of the prereqs of `micro_release` is the `bdist-clean` target, which in turn calls `$(MAKE) misc-clean` which deletes `config.status`, forcing `configure` to be re-run.",
    "created_at": "2019-07-03T13:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392288",
    "user": "https://github.com/embray"
}
```

Specifically, one of the prereqs of `micro_release` is the `bdist-clean` target, which in turn calls `$(MAKE) misc-clean` which deletes `config.status`, forcing `configure` to be re-run.



---

archive/issue_comments_392289.json:
```json
{
    "body": "What the `bdist-clean`? Is this a automake target? Otherwise is it reasonable that the build system's config is visible after running it?",
    "created_at": "2019-07-03T13:45:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392289",
    "user": "https://github.com/saraedum"
}
```

What the `bdist-clean`? Is this a automake target? Otherwise is it reasonable that the build system's config is visible after running it?



---

archive/issue_comments_392290.json:
```json
{
    "body": "Not sure, but I think just swapping `sagelib-clean` and `bdist-clean` in the prereqs for `micro_release` should suffice.  It's fragile, but I think it will work.  Testing now.",
    "created_at": "2019-07-03T13:47:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392290",
    "user": "https://github.com/embray"
}
```

Not sure, but I think just swapping `sagelib-clean` and `bdist-clean` in the prereqs for `micro_release` should suffice.  It's fragile, but I think it will work.  Testing now.



---

archive/issue_comments_392291.json:
```json
{
    "body": "Replying to [comment:11 saraedum]:\n> What the `bdist-clean`? Is this a automake target? Otherwise is it reasonable that the build system's config is visible after running it?\n\nNo, this is just a pseudo-target in Sage's top-level Makefile.  I have no idea why specifically it's named that.  It's also used by the `fast-rebuild-clean` target.  It just calls `clean` (which is in `build/make/Makefile` for some reason), and then `misc-clean`.\n\nAll `clean` does apparently is:\n\n\n```\nclean:\n    @echo \"Deleting package build directories...\"\n    rm -rf \"$(SAGE_LOCAL)/var/tmp/sage/build\"\n```\n\n\nwhich is certainly worth doing.  But maybe this needs to be detangled a bit...",
    "created_at": "2019-07-03T13:51:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392291",
    "user": "https://github.com/embray"
}
```

Replying to [comment:11 saraedum]:
> What the `bdist-clean`? Is this a automake target? Otherwise is it reasonable that the build system's config is visible after running it?

No, this is just a pseudo-target in Sage's top-level Makefile.  I have no idea why specifically it's named that.  It's also used by the `fast-rebuild-clean` target.  It just calls `clean` (which is in `build/make/Makefile` for some reason), and then `misc-clean`.

All `clean` does apparently is:


```
clean:
    @echo "Deleting package build directories..."
    rm -rf "$(SAGE_LOCAL)/var/tmp/sage/build"
```


which is certainly worth doing.  But maybe this needs to be detangled a bit...



---

archive/issue_comments_392292.json:
```json
{
    "body": "The following files in `docker/` probably still need changes:\n\n- `build-docker.sh`\n- `pull-gitlab.sh`\n- `push-dockerhub.sh`\n- `push-gitlab.sh`\n- `setup-make-parallelity.sh`\n- `test-dev.sh`\n- `update-env.sh`",
    "created_at": "2019-07-03T14:40:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392292",
    "user": "https://github.com/slel"
}
```

The following files in `docker/` probably still need changes:

- `build-docker.sh`
- `pull-gitlab.sh`
- `push-dockerhub.sh`
- `push-gitlab.sh`
- `setup-make-parallelity.sh`
- `test-dev.sh`
- `update-env.sh`



---

archive/issue_comments_392293.json:
```json
{
    "body": "Yes, most likely.  One I just get the docker build working locally I will try adding all the other relevant updates.\n\nIt would be nice for starters to get *a* Python 3 image on Docker Hub, even if I have to push it manually, then get future ones building automatically.",
    "created_at": "2019-07-04T12:40:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392293",
    "user": "https://github.com/embray"
}
```

Yes, most likely.  One I just get the docker build working locally I will try adding all the other relevant updates.

It would be nice for starters to get *a* Python 3 image on Docker Hub, even if I have to push it manually, then get future ones building automatically.



---

archive/issue_comments_392294.json:
```json
{
    "body": "I think that once your Dockerfile goes through, you just need to add your branch to `build-from-clean`, pull your image from the [GitLab](GitLab) registry and push it to Docker Hub.",
    "created_at": "2019-07-04T16:45:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392294",
    "user": "https://github.com/saraedum"
}
```

I think that once your Dockerfile goes through, you just need to add your branch to `build-from-clean`, pull your image from the [GitLab](GitLab) registry and push it to Docker Hub.



---

archive/issue_comments_392295.json:
```json
{
    "body": "For Odile's use I went ahead and pushed a prototype of this up to Dockerhub: sagemath/sagemath-dev-py3:alpha\n\nUnfortunately it still has a bug.  The `sage-entrypoint` still tries to run `make build` (understandably) which results in re-configuring (needlessly) and breaking things.\n\nA workaround for now is to set the PREREQ_OPTIONS variable which is used by Sage's top-level Makefile when it runs configure.  So you can set this when running the container like:\n\n\n```\ndocker run -ti --rm -e PREREQ_OPTIONS='--with-python=3' sagemath/sagemath-dev-py3:alpha\n```\n\n\nNext up, I think we should modify the Docker build to at least keep config.status so that this doesn't keep happening.",
    "created_at": "2019-07-09T16:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392295",
    "user": "https://github.com/embray"
}
```

For Odile's use I went ahead and pushed a prototype of this up to Dockerhub: sagemath/sagemath-dev-py3:alpha

Unfortunately it still has a bug.  The `sage-entrypoint` still tries to run `make build` (understandably) which results in re-configuring (needlessly) and breaking things.

A workaround for now is to set the PREREQ_OPTIONS variable which is used by Sage's top-level Makefile when it runs configure.  So you can set this when running the container like:


```
docker run -ti --rm -e PREREQ_OPTIONS='--with-python=3' sagemath/sagemath-dev-py3:alpha
```


Next up, I think we should modify the Docker build to at least keep config.status so that this doesn't keep happening.



---

archive/issue_comments_392296.json:
```json
{
    "body": "Apparently I was not able to successfully upload the Docker image to hub.docker.com because (AFAICT) of [this issue](https://github.com/moby/moby/issues/33558#issuecomment-510479853).\n\nBut I was able to upload it to our image registry on gitlab.com.   So try:\n\n\n```\ndocker run -ti --rm -e PREREQ_OPTIONS='--with-python=3' registry.gitlab.com/sagemath/dev/sage/sagemath-dev-py3:alpha\n```\n\n\nYou can also use this image as a base for another Docker image by doing something like:\n\n\n```\nFROM registry.gitlab.com/sagemath/dev/sage/sagemath-dev-py3:alpha\nENV PREREQ_OPTIONS='--with-python=3'\n...\n```\n\n\nThat is, you would ensure `PREREQ_OPTIONS` is set as an environment variable in the new image, by default.\n\nThis is not ideal and should be fixed, but it's a start anyways...",
    "created_at": "2019-07-11T14:59:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392296",
    "user": "https://github.com/embray"
}
```

Apparently I was not able to successfully upload the Docker image to hub.docker.com because (AFAICT) of [this issue](https://github.com/moby/moby/issues/33558#issuecomment-510479853).

But I was able to upload it to our image registry on gitlab.com.   So try:


```
docker run -ti --rm -e PREREQ_OPTIONS='--with-python=3' registry.gitlab.com/sagemath/dev/sage/sagemath-dev-py3:alpha
```


You can also use this image as a base for another Docker image by doing something like:


```
FROM registry.gitlab.com/sagemath/dev/sage/sagemath-dev-py3:alpha
ENV PREREQ_OPTIONS='--with-python=3'
...
```


That is, you would ensure `PREREQ_OPTIONS` is set as an environment variable in the new image, by default.

This is not ideal and should be fixed, but it's a start anyways...



---

archive/issue_comments_392297.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-19T19:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392297",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392298.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-19T19:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392298",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392299.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-19T20:36:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392299",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392300.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-19T20:43:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392300",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_392301.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-20T01:03:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392301",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392302.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-20T01:16:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392302",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392303.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-20T01:46:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392303",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392304.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-20T02:05:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392304",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392305.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-20T03:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392305",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392306.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-20T03:22:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392306",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_392307.json:
```json
{
    "body": "See #28367 for the related README update.",
    "created_at": "2019-08-20T03:23:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392307",
    "user": "https://github.com/saraedum"
}
```

See #28367 for the related README update.



---

archive/issue_comments_392308.json:
```json
{
    "body": "We pushed initial docker `-py3` images to the Docker Hub.",
    "created_at": "2019-08-20T04:06:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392308",
    "user": "https://github.com/saraedum"
}
```

We pushed initial docker `-py3` images to the Docker Hub.



---

archive/issue_comments_392309.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-08-20T04:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392309",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392310.json:
```json
{
    "body": "New commits:",
    "created_at": "2019-08-20T04:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392310",
    "user": "https://github.com/saraedum"
}
```

New commits:



---

archive/issue_comments_392311.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-20T04:15:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392311",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_392312.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-20T23:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392312",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_392313.json:
```json
{
    "body": "When this is for sure ready can we squash some of these commits?",
    "created_at": "2019-08-21T10:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392313",
    "user": "https://github.com/embray"
}
```

When this is for sure ready can we squash some of these commits?



---

archive/issue_comments_392314.json:
```json
{
    "body": "Just out of curiosity, is there a specific meaning to having a section in `.gitlab-ci.yml` that begins with a `.`, as in `.py3`?  Does that just emphasize that it's not a real build stage (rather a \"mix-in\" for multiple build stages)?  Or is that a syntax specifically recognized by the file format?\n\nIf I understand correctly, this is now keeping `config.status` in the image.  But what if someone runs `sage -i <some_optional_package>` in one of these py3 images?  In other words, if a user (or dockerfile author) does something that still results in `./configure` being re-run, will this keep the `--with-python=3` setting?\n\nI fear not, since we still haven't fully resolved #27373 (which related to system package settings specifically, but more broadly to retaining the values of flags passed to `./configure`).  The larger problem of course being that we have \"runtime\" features like `sage -i` that depend on running `./configure` at all...",
    "created_at": "2019-08-21T11:01:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392314",
    "user": "https://github.com/embray"
}
```

Just out of curiosity, is there a specific meaning to having a section in `.gitlab-ci.yml` that begins with a `.`, as in `.py3`?  Does that just emphasize that it's not a real build stage (rather a "mix-in" for multiple build stages)?  Or is that a syntax specifically recognized by the file format?

If I understand correctly, this is now keeping `config.status` in the image.  But what if someone runs `sage -i <some_optional_package>` in one of these py3 images?  In other words, if a user (or dockerfile author) does something that still results in `./configure` being re-run, will this keep the `--with-python=3` setting?

I fear not, since we still haven't fully resolved #27373 (which related to system package settings specifically, but more broadly to retaining the values of flags passed to `./configure`).  The larger problem of course being that we have "runtime" features like `sage -i` that depend on running `./configure` at all...



---

archive/issue_comments_392315.json:
```json
{
    "body": "Replying to [comment:36 embray]:\n> When this is for sure ready can we squash some of these commits?\n\nFeel free to squash.",
    "created_at": "2019-08-21T14:31:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392315",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:36 embray]:
> When this is for sure ready can we squash some of these commits?

Feel free to squash.



---

archive/issue_comments_392316.json:
```json
{
    "body": "Replying to [comment:37 embray]:\n> Just out of curiosity, is there a specific meaning to having a section in `.gitlab-ci.yml` that begins with a `.`, as in `.py3`?  Does that just emphasize that it's not a real build stage (rather a \"mix-in\" for multiple build stages)?  Or is that a syntax specifically recognized by the file format?\n\nWithout out the `.` it would be a build job. As a default as port of the `test` stage I believe.\n\n> If I understand correctly, this is now keeping `config.status` in the image.  But what if someone runs `sage -i <some_optional_package>` in one of these py3 images?  In other words, if a user (or dockerfile author) does something that still results in `./configure` being re-run, will this keep the `--with-python=3` setting?\n\nDoes `sage -i` run `configure` when `config.status` is present?\n\n> I fear not, since we still haven't fully resolved #27373 (which related to system package settings specifically, but more broadly to retaining the values of flags passed to `./configure`).  The larger problem of course being that we have \"runtime\" features like `sage -i` that depend on running `./configure` at all...\n\nI don't think making `--with-python=3` persistent is within the scope of this ticket. But it's certainly a problem that we should be aware of.",
    "created_at": "2019-08-21T14:33:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392316",
    "user": "https://github.com/saraedum"
}
```

Replying to [comment:37 embray]:
> Just out of curiosity, is there a specific meaning to having a section in `.gitlab-ci.yml` that begins with a `.`, as in `.py3`?  Does that just emphasize that it's not a real build stage (rather a "mix-in" for multiple build stages)?  Or is that a syntax specifically recognized by the file format?

Without out the `.` it would be a build job. As a default as port of the `test` stage I believe.

> If I understand correctly, this is now keeping `config.status` in the image.  But what if someone runs `sage -i <some_optional_package>` in one of these py3 images?  In other words, if a user (or dockerfile author) does something that still results in `./configure` being re-run, will this keep the `--with-python=3` setting?

Does `sage -i` run `configure` when `config.status` is present?

> I fear not, since we still haven't fully resolved #27373 (which related to system package settings specifically, but more broadly to retaining the values of flags passed to `./configure`).  The larger problem of course being that we have "runtime" features like `sage -i` that depend on running `./configure` at all...

I don't think making `--with-python=3` persistent is within the scope of this ticket. But it's certainly a problem that we should be aware of.



---

archive/issue_comments_392317.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-06T02:34:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392317",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392318.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-06T03:09:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392318",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392319.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-13T08:48:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392319",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392320.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-09-13T08:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392320",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_392321.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-13T09:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392321",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392322.json:
```json
{
    "body": "the docker images should be available on binder shortly: https://gitlab.com/sagemath/dev/trac/pipelines/81996545",
    "created_at": "2019-09-13T09:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392322",
    "user": "https://github.com/saraedum"
}
```

the docker images should be available on binder shortly: https://gitlab.com/sagemath/dev/trac/pipelines/81996545



---

archive/issue_comments_392323.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-13T09:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392323",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392324.json:
```json
{
    "body": "I started a full `build-from-clean` here: https://gitlab.com/sagemath/dev/trac/pipelines/82005383",
    "created_at": "2019-09-13T09:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392324",
    "user": "https://github.com/saraedum"
}
```

I started a full `build-from-clean` here: https://gitlab.com/sagemath/dev/trac/pipelines/82005383



---

archive/issue_comments_392325.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-09-13T09:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392325",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_392326.json:
```json
{
    "body": "The Python 2 and Python 3 images seem to be functional. (At least they work in Binder.)",
    "created_at": "2019-09-13T15:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392326",
    "user": "https://github.com/saraedum"
}
```

The Python 2 and Python 3 images seem to be functional. (At least they work in Binder.)



---

archive/issue_comments_392327.json:
```json
{
    "body": "Looks good to me.  Both Python 2 and Python 3 built fine.",
    "created_at": "2019-09-13T22:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392327",
    "user": "https://github.com/roed314"
}
```

Looks good to me.  Both Python 2 and Python 3 built fine.



---

archive/issue_comments_392328.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-09-13T22:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392328",
    "user": "https://github.com/roed314"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_392329.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-09-16T08:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392329",
    "user": "https://github.com/saraedum"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_392330.json:
```json
{
    "body": "Not sure if this comes from the changes here, but there's a `MAKEFLAGS=w -j -l7.8 --jobserver-fds=3,4 V=1` in the output. Let me try to see who put the `w` there.",
    "created_at": "2019-09-16T08:54:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392330",
    "user": "https://github.com/saraedum"
}
```

Not sure if this comes from the changes here, but there's a `MAKEFLAGS=w -j -l7.8 --jobserver-fds=3,4 V=1` in the output. Let me try to see who put the `w` there.



---

archive/issue_comments_392331.json:
```json
{
    "body": "Ok. That's how it's supposed to work https://lists.gnu.org/archive/html/help-make/2016-03/msg00009.html.",
    "created_at": "2019-09-16T08:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392331",
    "user": "https://github.com/saraedum"
}
```

Ok. That's how it's supposed to work https://lists.gnu.org/archive/html/help-make/2016-03/msg00009.html.



---

archive/issue_comments_392332.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2019-09-16T08:58:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392332",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_392333.json:
```json
{
    "body": "moving milestone to 9.0 (after release of 8.9)",
    "created_at": "2019-09-30T08:12:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392333",
    "user": "https://github.com/fchapoton"
}
```

moving milestone to 9.0 (after release of 8.9)



---

archive/issue_comments_392334.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-10-03T17:58:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27804#issuecomment-392334",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
