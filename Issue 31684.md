# Issue 31684: The knotinfo db should use the StaticFile feature, not PythonModule

archive/issues_031684.json:
```json
{
    "body": "CC:  soehms tscrim arojas\n\nTicket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.\n\nIn #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have detected whether the database file was present.\n\nThe problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed there are consequences as sage will try to create files in system location.\nSee https://github.com/cschwan/sage-on-gentoo/issues/639 for example.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31921\n\n",
    "created_at": "2021-06-07T03:55:18Z",
    "labels": [
        "packages: optional",
        "blocker",
        "bug"
    ],
    "title": "The knotinfo db should use the StaticFile feature, not PythonModule",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31684",
    "user": "fbissey"
}
```
CC:  soehms tscrim arojas

Ticket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.

In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have detected whether the database file was present.

The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed there are consequences as sage will try to create files in system location.
See https://github.com/cschwan/sage-on-gentoo/issues/639 for example.

Issue created by migration from https://trac.sagemath.org/ticket/31921





---

archive/issue_comments_452608.json:
```json
{
    "body": "Attach branch with patch currently tested in sage-on-gentoo. That allows documentation to be built, I am currently running doctests. The next test would be to make sure it behaves properly with the knotinfo package installed.\n----\nNew commits:",
    "created_at": "2021-06-07T04:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452608",
    "user": "fbissey"
}
```

Attach branch with patch currently tested in sage-on-gentoo. That allows documentation to be built, I am currently running doctests. The next test would be to make sure it behaves properly with the knotinfo package installed.
----
New commits:



---

archive/issue_comments_452609.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-06-07T04:05:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452609",
    "user": "fbissey"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_452610.json:
```json
{
    "body": "This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.\n\nJust change:\n\n```\n #!diff\n- PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)\n+ PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')\n```\n\n\nand set `self._sobj_path` to something like `database_knotinfo.__file__`",
    "created_at": "2021-06-07T04:19:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452610",
    "user": "mkoeppe"
}
```

This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.

Just change:

```
 #!diff
- PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)
+ PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')
```


and set `self._sobj_path` to something like `database_knotinfo.__file__`



---

archive/issue_comments_452611.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.\n> \n> Just change:\n> {{{ #!diff\n> - PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)\n> + PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')\n> }}}\n> \n\nI understand, the wrong python module was looked up. Of course you cannot know that without installing the package or reading the ticket very, very, carefully.\n\nI will put up a corrected branch later today.",
    "created_at": "2021-06-07T04:32:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452611",
    "user": "fbissey"
}
```

Replying to [comment:3 mkoeppe]:
> This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.
> 
> Just change:
> {{{ #!diff
> - PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)
> + PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')
> }}}
> 

I understand, the wrong python module was looked up. Of course you cannot know that without installing the package or reading the ticket very, very, carefully.

I will put up a corrected branch later today.



---

archive/issue_comments_452612.json:
```json
{
    "body": "Replying to [comment:3 mkoeppe]:\n> and set `self._sobj_path` to something like `database_knotinfo.__file__`\n\nPython detail, do you need to import `database_knotinfo` before being able to query that path?",
    "created_at": "2021-06-07T04:37:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452612",
    "user": "fbissey"
}
```

Replying to [comment:3 mkoeppe]:
> and set `self._sobj_path` to something like `database_knotinfo.__file__`

Python detail, do you need to import `database_knotinfo` before being able to query that path?



---

archive/issue_comments_452613.json:
```json
{
    "body": "yes, it needs to be imported",
    "created_at": "2021-06-07T05:00:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452613",
    "user": "mkoeppe"
}
```

yes, it needs to be imported



---

archive/issue_comments_452614.json:
```json
{
    "body": "Hum, I have to package this to make sure I understand, but it looks to me that the current location of `_sobj_path` and what you suggest to do with `.__file__` will be a quite different location. One should go under `site-packages` while the other will be under `share`.",
    "created_at": "2021-06-07T05:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452614",
    "user": "fbissey"
}
```

Hum, I have to package this to make sure I understand, but it looks to me that the current location of `_sobj_path` and what you suggest to do with `.__file__` will be a quite different location. One should go under `site-packages` while the other will be under `share`.



---

archive/issue_comments_452615.json:
```json
{
    "body": "OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)",
    "created_at": "2021-06-07T05:26:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452615",
    "user": "mkoeppe"
}
```

OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)



---

archive/issue_comments_452616.json:
```json
{
    "body": "Replying to [comment:8 mkoeppe]:\n> OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)\n\nUnder `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.",
    "created_at": "2021-06-07T06:09:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452616",
    "user": "fbissey"
}
```

Replying to [comment:8 mkoeppe]:
> OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)

Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.



---

archive/issue_comments_452617.json:
```json
{
    "body": "Replying to [comment:9 fbissey]:\n> Replying to [comment:8 mkoeppe]:\n> > OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)\n> \n> Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.\n\nThere are more files, so that should be a separate folder.\n\nSorry for causing this trouble. I already had `SAGE_DB` (`.sage/db`) in mind instead of `SAGE_SHARE` when I did the last change in #30352. But since everything worked fine for me I let it as is.\n\nI can do the tests but maybe not today!",
    "created_at": "2021-06-07T06:50:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452617",
    "user": "soehms"
}
```

Replying to [comment:9 fbissey]:
> Replying to [comment:8 mkoeppe]:
> > OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)
> 
> Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.

There are more files, so that should be a separate folder.

Sorry for causing this trouble. I already had `SAGE_DB` (`.sage/db`) in mind instead of `SAGE_SHARE` when I did the last change in #30352. But since everything worked fine for me I let it as is.

I can do the tests but maybe not today!



---

archive/issue_comments_452618.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-07T07:18:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452618",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452619.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-06-07T07:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452619",
    "user": "fbissey"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_452620.json:
```json
{
    "body": "I am now understanding my confusion in full. All the other databases test for `StaticFile` and there was a file defined there in a \"system location\".\n\nI'll add that since it is a user location, it doesn't really belongs to `feature`. Ideally, it would be defined in the package `database_knotinfo` itself. Let's find a location in sage for it for now, but we should keep it in mind next time the package is upgraded.",
    "created_at": "2021-06-07T07:22:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452620",
    "user": "fbissey"
}
```

I am now understanding my confusion in full. All the other databases test for `StaticFile` and there was a file defined there in a "system location".

I'll add that since it is a user location, it doesn't really belongs to `feature`. Ideally, it would be defined in the package `database_knotinfo` itself. Let's find a location in sage for it for now, but we should keep it in mind next time the package is upgraded.



---

archive/issue_comments_452621.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-06-07T07:29:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452621",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_452622.json:
```json
{
    "body": "Need to rewrite the description but it should be a testable state now.",
    "created_at": "2021-06-07T07:30:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452622",
    "user": "fbissey"
}
```

Need to rewrite the description but it should be a testable state now.



---

archive/issue_comments_452623.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-06-07T08:47:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452623",
    "user": "fbissey"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_452624.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-06-07T16:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452624",
    "user": "soehms"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_452625.json:
```json
{
    "body": "The patch looks good to me!\n\nAnother question: It seems that we have a new feature within our doctests, right now, which produces the following failure (independent on this branch):\n\n\n```bash\nsage -t --random-seed=0 src/sage/databases/knotinfo_db.py\n    [90 tests, 0.06 s]\n----------------------------------------------------------------------\nAll tests passed!\n----------------------------------------------------------------------\nTotal time for all tests: 0.2 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.1 seconds\n================================================================================================================================== test session starts ===================================================================================================================================\nplatform linux -- Python 3.9.2, pytest-6.2.4, py-1.10.0, pluggy-0.13.1\nrootdir: /home/sebastian/devel/sage/src, configfile: tox.ini\ncollected 0 items / 1 error\n\n========================================================================================================================================= ERRORS =========================================================================================================================================\n_____________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _____________________________________________________________________________________________________________________\nsrc/sage/databases/knotinfo_db.py:330: in <module>\n    class KnotInfoDataBase(SageObject, UniqueRepresentation):\nsage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2327)\n    ???\nE   KeyError: 'knotinfo_db'\n================================================================================================================================ short test summary info =================================================================================================================================\nERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n==================================================================================================================================== 1 error in 0.73s ====================================================================================================================================\n```\n\n\nWhat is the reason for this? How can I fix it? Any hints are welcome!",
    "created_at": "2021-06-07T16:56:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452625",
    "user": "soehms"
}
```

The patch looks good to me!

Another question: It seems that we have a new feature within our doctests, right now, which produces the following failure (independent on this branch):


```bash
sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
    [90 tests, 0.06 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.2 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.1 seconds
================================================================================================================================== test session starts ===================================================================================================================================
platform linux -- Python 3.9.2, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage/src, configfile: tox.ini
collected 0 items / 1 error

========================================================================================================================================= ERRORS =========================================================================================================================================
_____________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _____________________________________________________________________________________________________________________
src/sage/databases/knotinfo_db.py:330: in <module>
    class KnotInfoDataBase(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2327)
    ???
E   KeyError: 'knotinfo_db'
================================================================================================================================ short test summary info =================================================================================================================================
ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================================================== 1 error in 0.73s ====================================================================================================================================
```


What is the reason for this? How can I fix it? Any hints are welcome!



---

archive/issue_comments_452626.json:
```json
{
    "body": "I also see this error after installing `pytest`.",
    "created_at": "2021-06-07T17:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452626",
    "user": "mkoeppe"
}
```

I also see this error after installing `pytest`.



---

archive/issue_comments_452627.json:
```json
{
    "body": "This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)",
    "created_at": "2021-06-07T18:08:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452627",
    "user": "mkoeppe"
}
```

This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)



---

archive/issue_comments_452628.json:
```json
{
    "body": "Replying to [comment:20 mkoeppe]:\n> This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)\n\nMany Thanks!",
    "created_at": "2021-06-07T22:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452628",
    "user": "soehms"
}
```

Replying to [comment:20 mkoeppe]:
> This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)

Many Thanks!



---

archive/issue_comments_452629.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-06-19T20:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452629",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_452630.json:
```json
{
    "body": "There is another piece of code that should be adapted to the change of file-cache location. I've opened ticket #32099 for that!",
    "created_at": "2021-07-02T16:37:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31684",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31684#issuecomment-452630",
    "user": "soehms"
}
```

There is another piece of code that should be adapted to the change of file-cache location. I've opened ticket #32099 for that!
