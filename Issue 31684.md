# Issue 31684: The knotinfo db should use the StaticFile feature, not PythonModule

Issue created by migration from https://trac.sagemath.org/ticket/31921

Original creator: fbissey

Original creation time: 2021-06-07 03:55:18

CC:  soehms tscrim arojas

Ticket #30352 included a new optional database and its interface in sage. As all new optional package of this kind, whether to use it or not is detected at runtime by the feature framework.

In #30352 presence was implemented by looking if the sage interface python module is installed. Which is always true since this interface is shipped in the standard sagelib. Instead it should have detected whether the database file was present.

The problem is not clearly visible in vanilla sage as there are no direct consequence for a private user installation. But for system installation or distro installation which are sandboxed there are consequences as sage will try to create files in system location.
See https://github.com/cschwan/sage-on-gentoo/issues/639 for example.


---

Comment by fbissey created at 2021-06-07 04:05:59

Attach branch with patch currently tested in sage-on-gentoo. That allows documentation to be built, I am currently running doctests. The next test would be to make sure it behaves properly with the knotinfo package installed.
----
New commits:


---

Comment by fbissey created at 2021-06-07 04:05:59

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-06-07 04:19:25

This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.

Just change:

```
 #!diff
- PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)
+ PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')
```


and set `self._sobj_path` to something like `database_knotinfo.__file__`


---

Comment by fbissey created at 2021-06-07 04:32:14

Replying to [comment:3 mkoeppe]:
> This is not the right fix. The database is provided by a Python package so it should be looked up via import machinery.
> 
> Just change:
> {{{ #!diff
> - PythonModule.__init__(self, 'sage.knots.knotinfo', spkg='database_knotinfo',)
> + PythonModule.__init__(self, 'database_knotinfo', spkg='database_knotinfo')
> }}}
> 

I understand, the wrong python module was looked up. Of course you cannot know that without installing the package or reading the ticket very, very, carefully.

I will put up a corrected branch later today.


---

Comment by fbissey created at 2021-06-07 04:37:52

Replying to [comment:3 mkoeppe]:
> and set `self._sobj_path` to something like `database_knotinfo.__file__`

Python detail, do you need to import `database_knotinfo` before being able to query that path?


---

Comment by mkoeppe created at 2021-06-07 05:00:59

yes, it needs to be imported


---

Comment by fbissey created at 2021-06-07 05:07:38

Hum, I have to package this to make sure I understand, but it looks to me that the current location of `_sobj_path` and what you suggest to do with `.__file__` will be a quite different location. One should go under `site-packages` while the other will be under `share`.


---

Comment by mkoeppe created at 2021-06-07 05:26:04

OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)


---

Comment by fbissey created at 2021-06-07 06:09:39

Replying to [comment:8 mkoeppe]:
> OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)

Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.


---

Comment by soehms created at 2021-06-07 06:50:56

Replying to [comment:9 fbissey]:
> Replying to [comment:8 mkoeppe]:
> > OK, the `_sobj_path` is actually something else. It is a location of a cache that is created from the csv files distributed in the Python package. It's probably best to move this to a different location that is writable by users (somewhere in ~/.sage?)
> 
> Under `~/.sage` should be the default for that kind of things yes. Should we put it in its own subfolder? I don't think it is necessary, as there seems to be only one object.

There are more files, so that should be a separate folder.

Sorry for causing this trouble. I already had `SAGE_DB` (`.sage/db`) in mind instead of `SAGE_SHARE` when I did the last change in #30352. But since everything worked fine for me I let it as is.

I can do the tests but maybe not today!


---

Comment by git created at 2021-06-07 07:18:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2021-06-07 07:22:48

Changing status from needs_review to needs_work.


---

Comment by fbissey created at 2021-06-07 07:22:48

I am now understanding my confusion in full. All the other databases test for `StaticFile` and there was a file defined there in a "system location".

I'll add that since it is a user location, it doesn't really belongs to `feature`. Ideally, it would be defined in the package `database_knotinfo` itself. Let's find a location in sage for it for now, but we should keep it in mind next time the package is upgraded.


---

Comment by git created at 2021-06-07 07:29:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2021-06-07 07:30:01

Need to rewrite the description but it should be a testable state now.


---

Comment by fbissey created at 2021-06-07 08:47:24

Changing status from needs_work to needs_review.


---

Comment by soehms created at 2021-06-07 16:56:06

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2021-06-07 16:56:06

The patch looks good to me!

Another question: It seems that we have a new feature within our doctests, right now, which produces the following failure (independent on this branch):


```bash
sage -t --random-seed=0 src/sage/databases/knotinfo_db.py
    [90 tests, 0.06 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 0.2 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.1 seconds
================================================================================================================================== test session starts ===================================================================================================================================
platform linux -- Python 3.9.2, pytest-6.2.4, py-1.10.0, pluggy-0.13.1
rootdir: /home/sebastian/devel/sage/src, configfile: tox.ini
collected 0 items / 1 error

========================================================================================================================================= ERRORS =========================================================================================================================================
_____________________________________________________________________________________________________________________ ERROR collecting sage/databases/knotinfo_db.py _____________________________________________________________________________________________________________________
src/sage/databases/knotinfo_db.py:330: in <module>
    class KnotInfoDataBase(SageObject, UniqueRepresentation):
sage/misc/nested_class.pyx:318: in sage.misc.nested_class.NestedClassMetaclass.__init__ (build/cythonized/sage/misc/nested_class.c:2327)
    ???
E   KeyError: 'knotinfo_db'
================================================================================================================================ short test summary info =================================================================================================================================
ERROR src/sage/databases/knotinfo_db.py - KeyError: 'knotinfo_db'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
==================================================================================================================================== 1 error in 0.73s ====================================================================================================================================
```


What is the reason for this? How can I fix it? Any hints are welcome!


---

Comment by mkoeppe created at 2021-06-07 17:49:55

I also see this error after installing `pytest`.


---

Comment by mkoeppe created at 2021-06-07 18:08:50

This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)


---

Comment by soehms created at 2021-06-07 22:07:47

Replying to [comment:20 mkoeppe]:
> This defect is not specific to `knotinfo_db`; we will address it in #31924 (sage -t: Do not run pytest on individual files)

Many Thanks!


---

Comment by vbraun created at 2021-06-19 20:58:49

Resolution: fixed


---

Comment by soehms created at 2021-07-02 16:37:37

There is another piece of code that should be adapted to the change of file-cache location. I've opened ticket #32099 for that!
