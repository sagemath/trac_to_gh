# Issue 10182: long doctests wrongly tagged "# long" instead of "#long time"

Issue created by migration from Trac.

Original creator: cremona

Original creation time: 2010-10-28 13:29:22

Assignee: mvngu

Keywords: doctest long tag

In several places, long doctests are incorrectly tagged "# long" instead of "# long time", thus mistakenly preventing them from being omitted when "-long" is not included on the command line.

On of these is at #10182.  The rest are:

```
combinat/sf/sfa.py:            sage: a.itensor(a) #long
graphs/graph_generators.py:            sage: G.show() # long
graphs/graph.py:            sage: K5_minor =
g.minor(graphs.CompleteGraph(5))                    # long
graphs/graph.py:            sage: K33_minor =
g.minor(graphs.CompleteBipartiteGraph(3,3))        # long
lfunctions/sympow.py:            sage: sympow.analytic_rank(EllipticCurve([0, 0, 1, -79, 342]))  # long
lfunctions/sympow.py:            sage:
sympow.analytic_rank(EllipticCurve([1, 1, 0, -2582, 48720]))  # long
lfunctions/sympow.py:            sage:
sympow.analytic_rank(EllipticCurve([0, 0, 0, -10012, 346900]))  # long
lfunctions/lcalc.py:            sage: lcalc.zeros(4)
       # long
lfunctions/lcalc.py:            sage: lcalc.zeros(5, L='--tau')
       # long
lfunctions/lcalc.py:            sage: lcalc.zeros(3,
EllipticCurve('37a'))     # long
modules/fg_pid/fgp_module.py:        sage: set_random_seed(s); v =
[fgp.test_morphism_0(4) for _ in range(50)]    # long
plot/plot.py:            sage: sum([plot(z*sin(x), 0, 10).plot3d(z)
for z in range(6)]) #long
plot/plot.py:            sage: p.show(gridlines=( [-3,-2.75,..,3],
xrange(-1,5,2) )) #long
rings/qqbar.py:            sage: a.exactify(); a #long
schemes/elliptic_curves/heegner.py:        sage:
kolyvagin_reduction_data(E,3)              # long
schemes/elliptic_curves/ell_rational_field.py:            sage: E =
EllipticCurve([1, -1, 0, -751055859, -7922219731979])     # long (0.6
seconds)
schemes/elliptic_curves/ell_rational_field.py:            sage:
EllipticCurve('681b').three_selmer_rank(algorithm='Heuristic')   #
long (10 seconds); optional - magma
schemes/elliptic_curves/lseries_ell.py:            sage:
E.lseries().zeros_in_interval(6, 10, 0.1)      # long
schemes/elliptic_curves/lseries_ell.py:            sage:
E.lseries().twist_zeros(3, -4, -3)         # long
schemes/generic/fano_toric_variety.py:    sage: p4318 =
ReflexivePolytope(3, 4318)  # long
schemes/generic/fano_toric_variety.py:    sage: FTV =
CPRFanoToricVariety(Delta_polar=p4318)  # long
schemes/generic/fano_toric_variety.py:    sage:
FTV.anticanonical_hypersurface()  # long
```

(This list is not guaranteed to be complete, and may contain lines which are fine).


---

Attachment


---

Comment by damek created at 2010-11-07 00:26:01

Changing status from new to needs_review.


---

Comment by benjaminfjones created at 2010-11-07 22:27:14

The patch here looks good, similar to trac #10182. I tested the timings before and after, log files are attached (didn't know if this is appropriate here or not, but figured I'd include them anyway). There was an error testing schemes/elliptic_curves/ell_rational_field.py with "sage -t" which doesn't occur with "sage -t --long" that I'm puzzled about. Here is the error:


```
sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
  ***   Warning: new stack size = 1003360 (0.957 Mbytes).
**********************************************************************
File "/Users/jonesbe/sage/sage-4.6/devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py", line 1447:
    sage: E.simon_two_descent ()
Expected:
    (1, 1, [])
Got:
    (3, 3, [(1 : 0 : 1), (0 : 2 : 1), (2 : -1 : 1)])
**********************************************************************
1 items had failures:
   1 of  31 in __main__.example_28
***Test Failed*** 1 failures.
For whitespace errors, see the file /Users/jonesbe/.sage//tmp/.doctest_ell_rational_field.py
	 [39.4 s]
```


The test in question is:

```
sage: E = EllipticCurve([1, -1, 0, -751055859, -7922219731979])     # long time (0.6 seconds)
sage: set_random_seed(0)
sage: E.simon_two_descent ()
```


When I run these commands in an interactive sage session I get the "expected" answer:

```
sage: E = EllipticCurve([1, -1, 0, -751055859, -7922219731979])     # long time (0.6 seconds)
sage: set_random_seed(0)
sage: E.simon_two_descent ()
(1, 1, [])
```


but when the test gets done as part of "sage -t" the result is different (see above). When the test is done with "sage -t --long" there is no deviation from the expected answer. 

Looks to me like what's going on is that with "sage -t" the line tagged "# long time" is not executed, so the calculation 

```
sage: set_random_seed(0)
sage: E.simon_two_descent ()
```


applies to the previously defined Elliptic curve (on line 1435) where the following test is performed:

```
sage: E = EllipticCurve('5077a1')
sage: set_random_seed(0)
sage: E.simon_two_descent()
(3, 3, [(1 : 0 : 1), (0 : 2 : 1), (2 : -1 : 1)])
```

The output here is what sage is complaining is not equal to the expected output in the present test.

So... I guess the whole three line block lines 1445 - 1447 should be tagged "# long time".

Other than this problem, the patch produces expected timing differences.


---

Attachment

Timing log (before patch)


---

Attachment

Timing log (after patch)


---

Comment by benjaminfjones created at 2010-11-07 22:32:46

I've attached an additional patch to fix the problem appearing in my last comment. Now the "sage -t" test and "sage -t --long" tests for schemes/elliptic_curves/ell_rational_field.py both succeed:


```
sage -t  "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
	 [40.5 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 40.5 seconds

sage -t --long "devel/sage/sage/schemes/elliptic_curves/ell_rational_field.py"
	 [157.6 s]
 
----------------------------------------------------------------------
All tests passed!
Total time for all tests: 157.6 seconds
```



---

Comment by benjaminfjones created at 2010-11-07 22:34:02

added neccesary "# long time" tags to lines 1446-1447 of schemes/elliptic_curves/ell_rational_field.py


---

Attachment

Benjamin,  Your analysis is entirely correct!

I don't have time right now to re-review the patch, but I'm sure it is fine now.

Damek,  you should try to work out how you did not detect this problem (which was certainly not your fault).  It's important to do full testing before asking for a review!


---

Comment by mvngu created at 2010-11-27 14:45:39

Changing status from needs_review to positive_review.


---

Comment by mvngu created at 2010-11-27 14:45:39

Both patches look good to me. See the ticket description for instructions on which tickets to apply and in which order.


---

Comment by jdemeyer created at 2010-12-02 16:09:50

Resolution: fixed
