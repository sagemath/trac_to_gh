# Issue 31242: Do not use pynac's poly_mul_expand function until it has been debugged

Issue created by migration from https://trac.sagemath.org/ticket/31479

Original creator: @DaveWitteMorris

Original creation time: 2021-03-10 07:04:03

CC:  egourgoulhon @mjungmath

Keywords: pynac, expand

Pynac's `poly_mul_expand` function silently produces wrong results when expanding certain sums. This ticket eliminates its use by pynac's `ex::expand` method, and therefore provides a (temporary) fix for the problems reported in #31077 and #31411.

This is part of metaticket #31478.

Use of the `poly_mul_expand` function can be re-enabled after the bugs have been fixed.


---

Comment by @DaveWitteMorris created at 2021-03-10 07:10:19

Changing status from new to needs_review.


---

Comment by @DaveWitteMorris created at 2021-03-10 07:10:19

New commits:


---

Comment by mkoeppe created at 2021-03-10 18:48:26

Patchbot indicates doctest failures:

```
sage -t --long --warn-long 68.0 --random-seed=0 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4846, in sage.symbolic.expression.Expression.expand
Failed example:
    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
Expected:
    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36
Got:
    -124*d^3 + 468*d^2 - 372*d + 36
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4854, in sage.symbolic.expression.Expression.expand
Failed example:
    bool((A * B).expand() == (A * B.expand()).expand())
Expected:
    True
Got:
    False
**********************************************************************
```



---

Comment by mkoeppe created at 2021-03-10 18:48:26

Changing status from needs_review to needs_work.


---

Comment by @DaveWitteMorris created at 2021-03-10 19:11:40

The doctests that failed are the new ones that are added by this ticket.  They will fail without the pynac patch that is on this ticket, but will pass if the patch is applied.

I am pretty sure that the patchbot did not apply the patch to pynac. Is there something I should do to make the patchbot apply the patch?


---

Comment by @DaveWitteMorris created at 2021-03-13 17:36:50

Doctesting this ticket on MacOS 10.15.7 with 

```
sage -f pynac
make
sage -t -p 4 --all --long
```

resulted in `All tests passed!`. I also tested on Ubuntu 20.04 (CoCalc) and got no failures that I would attribute to this ticket. So I think we can consider the badge to be green, even though the patchbots aren't testing the pynac patch.


---

Comment by @DaveWitteMorris created at 2021-03-13 17:36:50

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2021-03-23 23:52:26

Changing status from needs_review to needs_work.


---

Comment by vbraun created at 2021-03-23 23:52:26

The patch level in build/pkgs/pynac/package-version.txt needs to be incremented so the build system knows that pynac must be rebuilt...


---

Comment by @DaveWitteMorris created at 2021-03-24 01:51:21

Changing status from needs_work to needs_review.


---

Comment by @DaveWitteMorris created at 2021-03-24 01:51:21

Thanks!  I incremented the patch number (and rebased on beta9), so I hope the patchbots will start chiming in.
----
New commits:


---

Comment by vbraun created at 2021-03-24 22:44:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-03-28 08:38:26

On 32-bit

```
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4882, in sage.symbolic.expression.Expression.expand
Failed example:
    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
Expected:
    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36
Got:
    d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36
**********************************************************************
1 item had failures:
   1 of  43 in sage.symbolic.expression.Expression.expand
    [2937 tests, 1 failure, 38.78 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2021-03-28 08:38:26

Changing status from positive_review to needs_work.


---

Comment by @DaveWitteMorris created at 2021-03-29 21:53:51

The answer is correct modulo `2^32`, so it seems clear that this is an integer overflow error. But pynac is not supposed to make that type of error, so I don't know what is going on. It may not be difficult to locate the bug on a machine that reproduces the error, but I don't have one right now.

I propose to mark the 32-bit version of this doctest `# known bug` and open a new (critical) ticket to fix the overflow error.


---

Comment by mkoeppe created at 2021-03-30 00:55:45

Volker, given that you seem to be the only one who has access to a 32-bit machine, perhaps you can help locating this bug?


---

Comment by git created at 2021-03-31 03:50:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @DaveWitteMorris created at 2021-03-31 03:52:20

Changing status from needs_work to needs_review.


---

Comment by @DaveWitteMorris created at 2021-03-31 03:52:20

I opened #31585 for the integer overflow error.


---

Comment by mkoeppe created at 2021-04-05 16:58:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-05 16:58:43

Short of new information regarding the 32-bit status (is the failure introduced by this ticket? or just not fixed by this ticket?), I'm marking this as positive review, as it is certainly an improvement. (Volker, note, if you consider 32 bit support important, let's please merge #31541 too in this release too.)


---

Comment by vbraun created at 2021-04-05 23:16:47

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-04-05 23:16:47

Merge conflict


---

Comment by git created at 2021-04-05 23:22:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-05 23:23:06

Changing status from needs_work to positive_review.


---

Comment by git created at 2021-04-09 06:03:41

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-04-09 06:03:41

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2021-04-09 06:03:54

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-04-10 11:01:18

Circular dependency


---

Comment by vbraun created at 2021-04-10 11:01:18

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-04-10 16:19:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-04-10 16:19:57

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-04-10 16:24:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-04-10 16:25:12

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-04-10 16:25:12

Sorry for messing this up.


---

Comment by vbraun created at 2021-04-12 21:48:44

Resolution: fixed
