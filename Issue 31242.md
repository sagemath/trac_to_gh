# Issue 31242: Do not use pynac's poly_mul_expand function until it has been debugged

archive/issues_031242.json:
```json
{
    "body": "CC:  @egourgoulhon @mjungmath\n\nKeywords: pynac, expand\n\nPynac's `poly_mul_expand` function silently produces wrong results when expanding certain sums. This ticket eliminates its use by pynac's `ex::expand` method, and therefore provides a (temporary) fix for the problems reported in #31077 and #31411.\n\nThis is part of metaticket #31478.\n\nUse of the `poly_mul_expand` function can be re-enabled after the bugs have been fixed.\n\nIssue created by migration from https://trac.sagemath.org/ticket/31479\n\n",
    "created_at": "2021-03-10T07:04:03Z",
    "labels": [
        "component: symbolics",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.3",
    "title": "Do not use pynac's poly_mul_expand function until it has been debugged",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31242",
    "user": "https://github.com/DaveWitteMorris"
}
```
CC:  @egourgoulhon @mjungmath

Keywords: pynac, expand

Pynac's `poly_mul_expand` function silently produces wrong results when expanding certain sums. This ticket eliminates its use by pynac's `ex::expand` method, and therefore provides a (temporary) fix for the problems reported in #31077 and #31411.

This is part of metaticket #31478.

Use of the `poly_mul_expand` function can be re-enabled after the bugs have been fixed.

Issue created by migration from https://trac.sagemath.org/ticket/31479





---

archive/issue_comments_446010.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-03-10T07:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446010",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_446011.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-03-10T07:10:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446011",
    "user": "https://github.com/DaveWitteMorris"
}
```

New commits:



---

archive/issue_comments_446012.json:
```json
{
    "body": "Patchbot indicates doctest failures:\n\n```\nsage -t --long --warn-long 68.0 --random-seed=0 src/sage/symbolic/expression.pyx\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 4846, in sage.symbolic.expression.Expression.expand\nFailed example:\n    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)\nExpected:\n    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36\nGot:\n    -124*d^3 + 468*d^2 - 372*d + 36\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 4854, in sage.symbolic.expression.Expression.expand\nFailed example:\n    bool((A * B).expand() == (A * B.expand()).expand())\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n```\n",
    "created_at": "2021-03-10T18:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446012",
    "user": "https://github.com/mkoeppe"
}
```

Patchbot indicates doctest failures:

```
sage -t --long --warn-long 68.0 --random-seed=0 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4846, in sage.symbolic.expression.Expression.expand
Failed example:
    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
Expected:
    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36
Got:
    -124*d^3 + 468*d^2 - 372*d + 36
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4854, in sage.symbolic.expression.Expression.expand
Failed example:
    bool((A * B).expand() == (A * B.expand()).expand())
Expected:
    True
Got:
    False
**********************************************************************
```




---

archive/issue_comments_446013.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-10T18:48:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446013",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_446014.json:
```json
{
    "body": "The doctests that failed are the new ones that are added by this ticket.  They will fail without the pynac patch that is on this ticket, but will pass if the patch is applied.\n\nI am pretty sure that the patchbot did not apply the patch to pynac. Is there something I should do to make the patchbot apply the patch?",
    "created_at": "2021-03-10T19:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446014",
    "user": "https://github.com/DaveWitteMorris"
}
```

The doctests that failed are the new ones that are added by this ticket.  They will fail without the pynac patch that is on this ticket, but will pass if the patch is applied.

I am pretty sure that the patchbot did not apply the patch to pynac. Is there something I should do to make the patchbot apply the patch?



---

archive/issue_comments_446015.json:
```json
{
    "body": "Doctesting this ticket on MacOS 10.15.7 with \n\n```\nsage -f pynac\nmake\nsage -t -p 4 --all --long\n```\n\nresulted in `All tests passed!`. I also tested on Ubuntu 20.04 (CoCalc) and got no failures that I would attribute to this ticket. So I think we can consider the badge to be green, even though the patchbots aren't testing the pynac patch.",
    "created_at": "2021-03-13T17:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446015",
    "user": "https://github.com/DaveWitteMorris"
}
```

Doctesting this ticket on MacOS 10.15.7 with 

```
sage -f pynac
make
sage -t -p 4 --all --long
```

resulted in `All tests passed!`. I also tested on Ubuntu 20.04 (CoCalc) and got no failures that I would attribute to this ticket. So I think we can consider the badge to be green, even though the patchbots aren't testing the pynac patch.



---

archive/issue_comments_446016.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-13T17:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446016",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_446017.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-03-23T23:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446017",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_446018.json:
```json
{
    "body": "The patch level in build/pkgs/pynac/package-version.txt needs to be incremented so the build system knows that pynac must be rebuilt...",
    "created_at": "2021-03-23T23:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446018",
    "user": "https://github.com/vbraun"
}
```

The patch level in build/pkgs/pynac/package-version.txt needs to be incremented so the build system knows that pynac must be rebuilt...



---

archive/issue_comments_446019.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-24T01:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446019",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_446020.json:
```json
{
    "body": "Thanks!  I incremented the patch number (and rebased on beta9), so I hope the patchbots will start chiming in.\n----\nNew commits:",
    "created_at": "2021-03-24T01:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446020",
    "user": "https://github.com/DaveWitteMorris"
}
```

Thanks!  I incremented the patch number (and rebased on beta9), so I hope the patchbots will start chiming in.
----
New commits:



---

archive/issue_comments_446021.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-03-24T22:44:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446021",
    "user": "https://github.com/vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_446022.json:
```json
{
    "body": "On 32-bit\n\n```\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 4882, in sage.symbolic.expression.Expression.expand\nFailed example:\n    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)\nExpected:\n    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36\nGot:\n    d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36\n**********************************************************************\n1 item had failures:\n   1 of  43 in sage.symbolic.expression.Expression.expand\n    [2937 tests, 1 failure, 38.78 s]\n----------------------------------------------------------------------\nsage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed\n----------------------------------------------------------------------\n```\n",
    "created_at": "2021-03-28T08:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446022",
    "user": "https://github.com/vbraun"
}
```

On 32-bit

```
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 4882, in sage.symbolic.expression.Expression.expand
Failed example:
    ((a + b + c)^30 * (3*b + d - 5/d)^3).expand().subs(a=0,b=2,c=-1)
Expected:
    d^3 + 18*d^2 + 93*d - 465/d + 450/d^2 - 125/d^3 + 36
Got:
    d^3 + 18*d^2 + 1739461754973*d - 8697308774865/d + 450/d^2 - 125/d^3 + 36
**********************************************************************
1 item had failures:
   1 of  43 in sage.symbolic.expression.Expression.expand
    [2937 tests, 1 failure, 38.78 s]
----------------------------------------------------------------------
sage -t --long --random-seed=0 src/sage/symbolic/expression.pyx  # 1 doctest failed
----------------------------------------------------------------------
```




---

archive/issue_comments_446023.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-03-28T08:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446023",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_446024.json:
```json
{
    "body": "The answer is correct modulo `2^32`, so it seems clear that this is an integer overflow error. But pynac is not supposed to make that type of error, so I don't know what is going on. It may not be difficult to locate the bug on a machine that reproduces the error, but I don't have one right now.\n\nI propose to mark the 32-bit version of this doctest `# known bug` and open a new (critical) ticket to fix the overflow error.",
    "created_at": "2021-03-29T21:53:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446024",
    "user": "https://github.com/DaveWitteMorris"
}
```

The answer is correct modulo `2^32`, so it seems clear that this is an integer overflow error. But pynac is not supposed to make that type of error, so I don't know what is going on. It may not be difficult to locate the bug on a machine that reproduces the error, but I don't have one right now.

I propose to mark the 32-bit version of this doctest `# known bug` and open a new (critical) ticket to fix the overflow error.



---

archive/issue_comments_446025.json:
```json
{
    "body": "Volker, given that you seem to be the only one who has access to a 32-bit machine, perhaps you can help locating this bug?",
    "created_at": "2021-03-30T00:55:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446025",
    "user": "https://github.com/mkoeppe"
}
```

Volker, given that you seem to be the only one who has access to a 32-bit machine, perhaps you can help locating this bug?



---

archive/issue_comments_446026.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-03-31T03:50:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446026",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446027.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-03-31T03:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446027",
    "user": "https://github.com/DaveWitteMorris"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_446028.json:
```json
{
    "body": "I opened #31585 for the integer overflow error.",
    "created_at": "2021-03-31T03:52:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446028",
    "user": "https://github.com/DaveWitteMorris"
}
```

I opened #31585 for the integer overflow error.



---

archive/issue_comments_446029.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-05T16:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446029",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_446030.json:
```json
{
    "body": "Short of new information regarding the 32-bit status (is the failure introduced by this ticket? or just not fixed by this ticket?), I'm marking this as positive review, as it is certainly an improvement. (Volker, note, if you consider 32 bit support important, let's please merge #31541 too in this release too.)",
    "created_at": "2021-04-05T16:58:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446030",
    "user": "https://github.com/mkoeppe"
}
```

Short of new information regarding the 32-bit status (is the failure introduced by this ticket? or just not fixed by this ticket?), I'm marking this as positive review, as it is certainly an improvement. (Volker, note, if you consider 32 bit support important, let's please merge #31541 too in this release too.)



---

archive/issue_comments_446031.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-05T23:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446031",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_446032.json:
```json
{
    "body": "Merge conflict",
    "created_at": "2021-04-05T23:16:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446032",
    "user": "https://github.com/vbraun"
}
```

Merge conflict



---

archive/issue_comments_446033.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-05T23:22:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446033",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446034.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2021-04-05T23:23:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446034",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_446035.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2021-04-09T06:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446035",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_446036.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2021-04-09T06:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446036",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_446037.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-09T06:03:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446037",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_446038.json:
```json
{
    "body": "Circular dependency",
    "created_at": "2021-04-10T11:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446038",
    "user": "https://github.com/vbraun"
}
```

Circular dependency



---

archive/issue_comments_446039.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2021-04-10T11:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446039",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_446040.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2021-04-10T16:19:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446040",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_446041.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-10T16:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446041",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_446042.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-10T16:24:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446042",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_446043.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-10T16:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446043",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_446044.json:
```json
{
    "body": "Sorry for messing this up.",
    "created_at": "2021-04-10T16:25:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446044",
    "user": "https://github.com/mkoeppe"
}
```

Sorry for messing this up.



---

archive/issue_comments_446045.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-04-12T21:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31242#issuecomment-446045",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_028584.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2021-04-12T21:48:44Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/31242",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/31242#event-28584"
}
```
