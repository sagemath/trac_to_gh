# Issue 18160: upgrade Python to 2.7.9

Issue created by migration from https://trac.sagemath.org/ticket/18397

Original creator: dimpase

Original creation time: 2015-05-10 17:26:50

2.7.9 is out for a while already, and it fixes a number of bugs and backports stuff from 3.*.


---

Comment by leif created at 2015-05-10 18:04:40

There's 2.7.10rc0 already...


---

Comment by dimpase created at 2015-05-10 18:48:09

We must now remove our patch for Include/node.h, as it has been applied upstream. The rest of our patches apply (some with fizz).


---

Comment by dimpase created at 2015-05-10 18:49:10

Replying to [comment:1 leif]:
> There's 2.7.10rc0 already...

2.7.10.rc1 is on its way, cf https://hg.python.org/cpython/rev/80ccce248ba2


---

Comment by leif created at 2015-05-10 19:33:20

Yep.  Then wait for 2.7.10?


---

Comment by dimpase created at 2015-05-10 19:57:18

Replying to [comment:5 leif]:
> Yep.  Then wait for 2.7.10?

well, after removing the node.h patch, the whole thing builds and `make ptest` passes on Linux. So it does not look hard.


---

Comment by leif created at 2015-05-10 20:00:04

Linux that is... ;-)

With the SSL changes, `$SOMEONE` should check the notebook stuff...  (I don't use it at all.)


---

Comment by dimpase created at 2015-05-10 20:20:24

New commits:


---

Comment by fbissey created at 2015-05-10 21:02:47

For the record, sage-on-gentoo has been on python 2.7.9 from at least the 27th of December 2014. I haven't heard a report of negative impact on anything. And I don't remember having to do anything special. I have a vague memory of a schedule for the release of 2.7.10 in June but I cannot find it again.


---

Comment by vbraun created at 2015-05-11 01:26:25

ready for review?


---

Comment by dimpase created at 2015-05-11 08:14:02

Replying to [comment:11 vbraun]:
> ready for review?

I have to look at the remaining patches, if all are still needed, and rebase ones that apply with fizz.
(Is the latter necessary?)


---

Comment by leif created at 2015-05-11 08:21:40

Fuzz isn't nice.  One should look at the files after patching, then just rebasing the patches in case the context changes are really harmless.


---

Comment by leif created at 2015-05-11 08:51:11

If that's too tedious, I think we could simply wait for 2.7.10, in order to not have to do it twice, who knows.


---

Comment by git created at 2015-05-11 09:26:55

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by dimpase created at 2015-05-11 09:28:36

oops, I only meant to add http://git.sagemath.org/sage.git/commit/?id=f87043cf6a893b305e5208a89986047ad95015cd

So I only need http://git.sagemath.org/sage.git/commit/?h=f87043cf6a893b305e5208a89986047ad95015cd&id=e302b1332b67660f2c51c11369983eeeb5e9af8b
and the latter.


---

Comment by leif created at 2015-05-11 09:30:42

Yeees...

Reset hard and push with force again?


---

Comment by git created at 2015-05-11 10:01:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by dimpase created at 2015-05-11 10:03:33

OK, clean patch now.


---

Comment by dimpase created at 2015-05-11 10:03:33

Changing status from new to needs_review.


---

Comment by dimpase created at 2015-05-11 12:15:30

On OSX I cannot install pyopenssl (it does work on Linux though), it ends with some weird error:

```
   sage --pip install pyopenssl
...
    building '_Cryptography_cffi_2a871178xb3816a41' extension
    gcc -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -I/usr/local/src/sage/sage/local/include/python2.7 -c src/cryptography/hazmat/bindings/__pycache__/_Cryptography_cffi_2a871178xb3816a41.c -o build/temp.macosx-10.9-x86_64-2.7/src/cryptography/hazmat/bindings/__pycache__/_Cryptography_cffi_2a871178xb3816a41.o
    In file included from /System/Library/Frameworks/Security.framework/Headers/SecDigestTransform.h:28:0,
                     from src/cryptography/hazmat/bindings/__pycache__/_Cryptography_cffi_2a871178xb3816a41.c:236:
    /System/Library/Frameworks/Security.framework/Headers/SecTransform.h:579:15: error: expected identifier or '(' before '^' token
     typedef void (^SecMessageBlock)(CFTypeRef message, CFErrorRef error, 
                   ^
    /System/Library/Frameworks/Security.framework/Headers/SecTransform.h:612:8: error: unknown type name 'SecMessageBlock'
            SecMessageBlock deliveryBlock) 
            ^
    error: command 'gcc' failed with exit status 1
    
    ----------------------------------------
    Command "/usr/local/src/sage/sage/local/bin/python -c "import setuptools, tokenize;__file__='/private/var/folders/v8/mh06bfhd4j18mgftw8818gxw0000gp/T/pip-build-sVMlYI/cryptography/setup.py';exec(compile(getattr(tokenize, 'open', open)(__file__).read().replace('\r\n', '\n'), __file__, 'exec'))" install --record /var/folders/v8/mh06bfhd4j18mgftw8818gxw0000gp/T/pip-iZFMxa-record/install-record.txt --single-version-externally-managed --compile" failed with error code 1 in /private/var/folders/v8/mh06bfhd4j18mgftw8818gxw0000gp/T/pip-build-sVMlYI/cryptography
```


perhaps with 2.7.9 pyopenssl is obsolete? e.g. google finds: https://github.com/basho/riak-python-client/pull/397 

```
Avoid dependency on pyOpenSSL when using Python 2.7.9

Many enhancements of the Python 3 ssl module have been backported to Python 2.7.9.
In particular, the class SSLContext() is available and could be used instead of relying 
on the pyOpenSSL module. 
```



---

Comment by leif created at 2015-05-11 12:22:03

Objective C again, isn't it?


---

Comment by vbraun created at 2015-05-11 12:46:36

Yup, just another bug in Apple's toolchain headers...


---

Comment by dimpase created at 2015-05-11 13:18:19

Replying to [comment:22 vbraun]:
> Yup, just another bug in Apple's toolchain headers...

actually it is known to pyopenssl people : https://github.com/pyca/pyopenssl/issues/204


---

Comment by leif created at 2015-05-11 15:23:56

But it's probably caused by misconfiguration through Python / setuptools / pip / distutils...

Does the log show anything unusual?

Does for example our old PyOpenSSL build with the same Python?


---

Comment by dimpase created at 2015-05-11 15:35:24

Replying to [comment:24 leif]:
> But it's probably caused by misconfiguration through Python / setuptools / pip / distutils...
> 
> Does the log show anything unusual?

log shows a bunch of modules that were not needed before.
 
> 
> Does for example our old PyOpenSSL build with the same Python?

Old one? What one?
well, I don't even know if pyopenssl builds on OSX with Python 2.7.8 in Sage.

PyOpenSSL people tell me to file a bug here:
https://github.com/pyca/cryptography/issues
(i.e. for https://cryptography.io)
I'll see if it works if I try to install it separately.


---

Comment by dimpase created at 2015-05-11 18:01:34

Opened https://github.com/pyca/cryptography/issues/1924

On the other hand, this is only needed for `notebook(secure=True)` which is probably not an issue on OSX, as people don't run servers on OSX nowadays. 

Porting sagenb to python's SSL does not look easy, as it means porting Twisted (which is still not supporting Python 3, and relies on pyopenssl).


---

Comment by dimpase created at 2015-05-11 18:11:51

Replying to [comment:26 dimpase]:
> Opened https://github.com/pyca/cryptography/issues/1924

already [confirmed](https://github.com/pyca/cryptography/issues/1924#issuecomment-100998999) that we are out of luck here.


---

Comment by leif created at 2015-05-11 19:00:23

Replying to [comment:25 dimpase]:
> > Does for example our old PyOpenSSL build with the same Python?
> 
> Old one? What one?

The "deleted" one, still on the mirrors.  (Also with `sage -i ...` rather than `pip`.)

> well, I don't even know if pyopenssl builds on OSX with Python 2.7.8 in Sage.

Well, that was my question.  If it didn't build before, then it's no regression.

I was also wondering whether anybody needs/uses PyOpenSSL/a (secure) notebook server on MacOS X at all.  (I recall long time ago somebody was trying to run a server under MacOS X, but gave up IIRC.)


---

Comment by dimpase created at 2015-05-12 08:18:14

indeed, pyopenssl not building on OSX is not a regression - it's the same with Python 2.7.8.

Any other packages that might use ssl? Otherwise it seems good to go.


---

Comment by dimpase created at 2015-05-12 13:56:27

Replying to [comment:28 leif]:
> Replying to [comment:25 dimpase]:
> > > Does for example our old PyOpenSSL build with the same Python?
> > 
> > Old one? What one?
> 
> The "deleted" one, still on the mirrors.  (Also with `sage -i ...` rather than `pip`.)
> 
> > well, I don't even know if pyopenssl builds on OSX with Python 2.7.8 in Sage.
> 
> Well, that was my question.  If it didn't build before, then it's no regression.
> 
> I was also wondering whether anybody needs/uses PyOpenSSL/a (secure) notebook server on MacOS X at all.  (I recall long time ago somebody was trying to run a server under MacOS X, but gave up IIRC.)

probably https://groups.google.com/d/msg/sage-support/ERrL6r-u6Hc/RdlocmPuGTAJ ?

It looks like it never worked on recent OSX, as `notebook.setup()` calls certtools, which on OSX is a completely different beast from Linux's one. 

While I am at it, https://github.com/pyca/cryptography/issues/1924#issuecomment-101266143 tells of a workaround on how to install
the thing on OSX - and indeed it works, thus I was able to install pyopenssl on OSX. But the above `notebook.setup()`  problem is still there, for sure, i.e. notebook(secure=True) still does not run. This is for another ticket.


---

Comment by leif created at 2015-05-12 14:24:23

Replying to [comment:30 dimpase]:
> Replying to [comment:28 leif]:
> > (I recall long time ago somebody was trying to run a server under MacOS X, but gave up IIRC.)
> 
> probably https://groups.google.com/d/msg/sage-support/ERrL6r-u6Hc/RdlocmPuGTAJ ?

No, much older.


> It looks like it never worked on recent OSX, as `notebook.setup()` calls certtools, which on OSX is a completely different beast from Linux's one. 
> 
> While I am at it, https://github.com/pyca/cryptography/issues/1924#issuecomment-101266143 tells of a workaround on how to install
> the thing on OSX - and indeed it works, thus I was able to install pyopenssl on OSX.

Fine.  So you found a solution to something we didn't want to fix... ;-)

(Ok, we don't fix it here.  And after all, it's rather up to Apple.)


> But the above `notebook.setup()`  problem is still there, for sure, i.e. notebook(secure=True) still does not run. This is for another ticket.

Well, that's an "upstream" sagenb problem.  Probably open an issue there.


---

Comment by kcrisman created at 2015-05-12 14:27:47

See https://github.com/sagemath/sagenb/issues/341 which Dima opened for that.


---

Comment by dimpase created at 2015-05-15 10:59:06

Any issues still to be resolved here?


---

Comment by vbraun created at 2015-05-15 11:24:08

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-05-15 11:24:08

please fill in your name


---

Comment by vbraun created at 2015-05-18 21:11:54

Resolution: fixed
