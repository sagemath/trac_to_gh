# Issue 15394: Random failures in sandpiles.py

archive/issues_015394.json:
```json
{
    "body": "As reported on https://groups.google.com/d/msg/sage-devel/ymsEq_f9MNU/0x6vympN2c0J\n\n```\n File \"src/sage/sandpiles/sandpile.py\", line 4684, in sage.sandpiles.sandpile.complete_sandpile\nFailed example:\n    K.betti(verbose=False)\n...\n      File \"multi_polynomial_libsingular.pyx\", line 912, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomialRing_libsingular.__call__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:7912)\n    TypeError: Could not find a mapping of the passed element to this ring.\n---\n(same place but different error:)\n      File \"multi_polynomial_libsingular.pyx\", line 807, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomialRing_libsingular.__call__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:6207)\n      File \"/usr/local/sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1245, in __repr__\n        elif self.type() == 'matrix':\n      File \"/usr/local/sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/singular.py\", line 1976, in type\n        return m.group(1)\n    AttributeError: 'NoneType' object has no attribute 'group'\n```\n\nThis is because the singular pexpect interface has subtle bugs. The easy fix is to rewrite it with disabled terminal echo.\n\nIssue created by migration from https://trac.sagemath.org/ticket/15631\n\n",
    "created_at": "2014-01-04T22:07:11Z",
    "labels": [
        "interfaces",
        "major",
        "bug"
    ],
    "title": "Random failures in sandpiles.py",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15394",
    "user": "vbraun"
}
```
As reported on https://groups.google.com/d/msg/sage-devel/ymsEq_f9MNU/0x6vympN2c0J

```
 File "src/sage/sandpiles/sandpile.py", line 4684, in sage.sandpiles.sandpile.complete_sandpile
Failed example:
    K.betti(verbose=False)
...
      File "multi_polynomial_libsingular.pyx", line 912, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomialRing_libsingular.__call__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:7912)
    TypeError: Could not find a mapping of the passed element to this ring.
---
(same place but different error:)
      File "multi_polynomial_libsingular.pyx", line 807, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomialRing_libsingular.__call__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:6207)
      File "/usr/local/sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1245, in __repr__
        elif self.type() == 'matrix':
      File "/usr/local/sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1976, in type
        return m.group(1)
    AttributeError: 'NoneType' object has no attribute 'group'
```

This is because the singular pexpect interface has subtle bugs. The easy fix is to rewrite it with disabled terminal echo.

Issue created by migration from https://trac.sagemath.org/ticket/15631





---

archive/issue_comments_198653.json:
```json
{
    "body": "Annoyingly, the pexpect stuff in Sage is built around terminal echo: everything up to the first return is presumed echo and ignored. So I had to revert to a hack...\n \n----\nLast 10 new commits:",
    "created_at": "2014-01-04T22:57:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198653",
    "user": "vbraun"
}
```

Annoyingly, the pexpect stuff in Sage is built around terminal echo: everything up to the first return is presumed echo and ignored. So I had to revert to a hack...
 
----
Last 10 new commits:



---

archive/issue_comments_198654.json:
```json
{
    "body": "Its even worse, it seems one can't work around this without overriding `_eval_line`. Which is a mess...",
    "created_at": "2014-01-05T00:39:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198654",
    "user": "vbraun"
}
```

Its even worse, it seems one can't work around this without overriding `_eval_line`. Which is a mess...



---

archive/issue_comments_198655.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-01-05T00:59:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198655",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_198656.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-05T01:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198656",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_198657.json:
```json
{
    "body": "Now all tests pass for me (at least once, please try in loop)",
    "created_at": "2014-01-05T01:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198657",
    "user": "vbraun"
}
```

Now all tests pass for me (at least once, please try in loop)



---

archive/issue_comments_198658.json:
```json
{
    "body": "Patch looks good and I haven't observed the problem any more. The patchbot doesn't see real problems. You can browse through the various plugin complaints yourself.\n\nQuestion: as far as pexpect interface goes, singular is pretty vanilla if I'm not mistaken. That makes me think that whatever approach you have taken to make no-echo work with singular might apply more generally. Would it be doable to include the new way of handling \"noecho\" in our pexpect wrapper and select it with another flag to be set on startup? Then the code could be reused for other interfaces too.",
    "created_at": "2014-01-05T08:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198658",
    "user": "nbruin"
}
```

Patch looks good and I haven't observed the problem any more. The patchbot doesn't see real problems. You can browse through the various plugin complaints yourself.

Question: as far as pexpect interface goes, singular is pretty vanilla if I'm not mistaken. That makes me think that whatever approach you have taken to make no-echo work with singular might apply more generally. Would it be doable to include the new way of handling "noecho" in our pexpect wrapper and select it with another flag to be set on startup? Then the code could be reused for other interfaces too.



---

archive/issue_comments_198659.json:
```json
{
    "body": "I've added a `terminal_echo=<bool>` optional keyword argument to `Expect`, this saves some code but makes the `_eval_line` method even more ugly.... oh well.\n----\nNew commits:",
    "created_at": "2014-01-05T20:56:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198659",
    "user": "vbraun"
}
```

I've added a `terminal_echo=<bool>` optional keyword argument to `Expect`, this saves some code but makes the `_eval_line` method even more ugly.... oh well.
----
New commits:



---

archive/issue_comments_198660.json:
```json
{
    "body": "Nils, are you still reviewing this ticket?",
    "created_at": "2014-02-11T14:46:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198660",
    "user": "vbraun"
}
```

Nils, are you still reviewing this ticket?



---

archive/issue_comments_198661.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-09T15:33:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198661",
    "user": "rws"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_198662.json:
```json
{
    "body": "This also affects some patchbot doctesting, e.g.\nhttp://patchbot.sagemath.org/ticket/16199/",
    "created_at": "2014-05-10T13:43:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198662",
    "user": "rws"
}
```

This also affects some patchbot doctesting, e.g.
http://patchbot.sagemath.org/ticket/16199/



---

archive/issue_comments_198663.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-05-11T13:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198663",
    "user": "rws"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_198664.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-05-11T13:47:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198664",
    "user": "rws"
}
```

New commits:



---

archive/issue_comments_198665.json:
```json
{
    "body": "Ticket was already reviewed. Patchbot is happy also with current version.",
    "created_at": "2014-05-21T06:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198665",
    "user": "rws"
}
```

Ticket was already reviewed. Patchbot is happy also with current version.



---

archive/issue_comments_198666.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-21T06:35:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198666",
    "user": "rws"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_198667.json:
```json
{
    "body": "Hope you don't mind me setting the name.",
    "created_at": "2014-05-21T06:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198667",
    "user": "rws"
}
```

Hope you don't mind me setting the name.



---

archive/issue_comments_198668.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-21T15:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198668",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_198669.json:
```json
{
    "body": "Changing keywords from \"\" to \"pexpect echo singular\".",
    "created_at": "2014-06-09T22:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198669",
    "user": "leif"
}
```

Changing keywords from "" to "pexpect echo singular".



---

archive/issue_comments_198670.json:
```json
{
    "body": "It would have been nice if you mentioned pexpect in the ticket's title...",
    "created_at": "2014-06-09T22:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198670",
    "user": "leif"
}
```

It would have been nice if you mentioned pexpect in the ticket's title...



---

archive/issue_comments_198671.json:
```json
{
    "body": "What's the precise motivation for\n\n```\n                    if out == '':   # match bug with echo\n                        out = line\n```\n\n\nThis is breaking a fix for #10476.",
    "created_at": "2015-02-03T12:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198671",
    "user": "jdemeyer"
}
```

What's the precise motivation for

```
                    if out == '':   # match bug with echo
                        out = line
```


This is breaking a fix for #10476.



---

archive/issue_comments_198672.json:
```json
{
    "body": "Follow-up: #17719",
    "created_at": "2015-02-03T13:01:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198672",
    "user": "jdemeyer"
}
```

Follow-up: #17719



---

archive/issue_comments_198673.json:
```json
{
    "body": "Don't remember, though clearly must have been because something further down is unhappy with an empty string.",
    "created_at": "2015-02-03T14:11:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15394",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15394#issuecomment-198673",
    "user": "vbraun"
}
```

Don't remember, though clearly must have been because something further down is unhappy with an empty string.
