# Issue 15394: Random failures in sandpiles.py

Issue created by migration from https://trac.sagemath.org/ticket/15631

Original creator: vbraun

Original creation time: 2014-01-04 22:07:11

As reported on https://groups.google.com/d/msg/sage-devel/ymsEq_f9MNU/0x6vympN2c0J

```
 File "src/sage/sandpiles/sandpile.py", line 4684, in sage.sandpiles.sandpile.complete_sandpile
Failed example:
    K.betti(verbose=False)
...
      File "multi_polynomial_libsingular.pyx", line 912, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomialRing_libsingular.__call__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:7912)
    TypeError: Could not find a mapping of the passed element to this ring.
---
(same place but different error:)
      File "multi_polynomial_libsingular.pyx", line 807, in sage.rings.polynomial.multi_polynomial_libsingular.MPolynomialRing_libsingular.__call__ (sage/rings/polynomial/multi_polynomial_libsingular.cpp:6207)
      File "/usr/local/sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1245, in __repr__
        elif self.type() == 'matrix':
      File "/usr/local/sage/sage-dev/local/lib/python2.7/site-packages/sage/interfaces/singular.py", line 1976, in type
        return m.group(1)
    AttributeError: 'NoneType' object has no attribute 'group'
```

This is because the singular pexpect interface has subtle bugs. The easy fix is to rewrite it with disabled terminal echo.


---

Comment by vbraun created at 2014-01-04 22:57:18

Annoyingly, the pexpect stuff in Sage is built around terminal echo: everything up to the first return is presumed echo and ignored. So I had to revert to a hack...
 
----
Last 10 new commits:


---

Comment by vbraun created at 2014-01-05 00:39:23

Its even worse, it seems one can't work around this without overriding `_eval_line`. Which is a mess...


---

Comment by git created at 2014-01-05 00:59:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-01-05 01:00:02

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-01-05 01:00:02

Now all tests pass for me (at least once, please try in loop)


---

Comment by nbruin created at 2014-01-05 08:18:00

Patch looks good and I haven't observed the problem any more. The patchbot doesn't see real problems. You can browse through the various plugin complaints yourself.

Question: as far as pexpect interface goes, singular is pretty vanilla if I'm not mistaken. That makes me think that whatever approach you have taken to make no-echo work with singular might apply more generally. Would it be doable to include the new way of handling "noecho" in our pexpect wrapper and select it with another flag to be set on startup? Then the code could be reused for other interfaces too.


---

Comment by vbraun created at 2014-01-05 20:56:37

I've added a `terminal_echo=<bool>` optional keyword argument to `Expect`, this saves some code but makes the `_eval_line` method even more ugly.... oh well.
----
New commits:


---

Comment by vbraun created at 2014-02-11 14:46:43

Nils, are you still reviewing this ticket?


---

Comment by rws created at 2014-05-09 15:33:23

Changing status from needs_review to needs_work.


---

Comment by rws created at 2014-05-10 13:43:06

This also affects some patchbot doctesting, e.g.
http://patchbot.sagemath.org/ticket/16199/


---

Comment by rws created at 2014-05-11 13:47:07

Changing status from needs_work to needs_review.


---

Comment by rws created at 2014-05-11 13:47:07

New commits:


---

Comment by rws created at 2014-05-21 06:35:54

Ticket was already reviewed. Patchbot is happy also with current version.


---

Comment by rws created at 2014-05-21 06:35:54

Changing status from needs_review to positive_review.


---

Comment by rws created at 2014-05-21 06:42:48

Hope you don't mind me setting the name.


---

Comment by vbraun created at 2014-05-21 15:33:31

Resolution: fixed


---

Comment by leif created at 2014-06-09 22:56:30

Changing keywords from "" to "pexpect echo singular".


---

Comment by leif created at 2014-06-09 22:56:30

It would have been nice if you mentioned pexpect in the ticket's title...


---

Comment by jdemeyer created at 2015-02-03 12:53:53

What's the precise motivation for

```
                    if out == '':   # match bug with echo
                        out = line
```


This is breaking a fix for #10476.


---

Comment by jdemeyer created at 2015-02-03 13:01:30

Follow-up: #17719


---

Comment by vbraun created at 2015-02-03 14:11:00

Don't remember, though clearly must have been because something further down is unhappy with an empty string.
