# Issue 14759: Improve support for Jacobi elliptic functions

archive/issues_014759.json:
```json
{
    "body": "CC:  @burcin @kcrisman @benjaminfjones @fredrik-johansson\n\nCurrently, all evaluation (numeric and symbolic) of the Jacobi elliptic functions is done through Maxima. No derivatives or arbitrary-precision numeric evaluation are defined. Worse still, the Maxima numerical evaluation is wrong for some of the inverse Jacobi functions; see https://sourceforge.net/p/maxima/bugs/2615/.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14996\n\n",
    "created_at": "2013-08-03T04:09:33Z",
    "labels": [
        "symbolics",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Improve support for Jacobi elliptic functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14759",
    "user": "@eviatarbach"
}
```
CC:  @burcin @kcrisman @benjaminfjones @fredrik-johansson

Currently, all evaluation (numeric and symbolic) of the Jacobi elliptic functions is done through Maxima. No derivatives or arbitrary-precision numeric evaluation are defined. Worse still, the Maxima numerical evaluation is wrong for some of the inverse Jacobi functions; see https://sourceforge.net/p/maxima/bugs/2615/.

Issue created by migration from https://trac.sagemath.org/ticket/14996





---

archive/issue_comments_188221.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-08-03T04:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188221",
    "user": "@eviatarbach"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_188222.json:
```json
{
    "body": "Attachment [trac14996.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996.patch) by @eviatarbach created at 2013-08-03 04:15:13\n\nThe patch rewrites the Jacobi functions as standard symbolic functions. I wrote a new numerical routine for the inverse Jacobi functions, since it didn't seem to be available elsewhere. I've also added the Jacobi amplitude function.",
    "created_at": "2013-08-03T04:15:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188222",
    "user": "@eviatarbach"
}
```

Attachment [trac14996.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996.patch) by @eviatarbach created at 2013-08-03 04:15:13

The patch rewrites the Jacobi functions as standard symbolic functions. I wrote a new numerical routine for the inverse Jacobi functions, since it didn't seem to be available elsewhere. I've also added the Jacobi amplitude function.



---

archive/issue_comments_188223.json:
```json
{
    "body": "I hope you don't mind me CC'ing you.\n\nIn this patch I add the functions `inverse_jacobi_f` and `jacobi_amplitude_f` which use mpmath. Do you think these could be added to a future version? I know I'm not smart about increasing the context precision for successive computations but it seems to work.",
    "created_at": "2013-08-04T06:29:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188223",
    "user": "@eviatarbach"
}
```

I hope you don't mind me CC'ing you.

In this patch I add the functions `inverse_jacobi_f` and `jacobi_amplitude_f` which use mpmath. Do you think these could be added to a future version? I know I'm not smart about increasing the context precision for successive computations but it seems to work.



---

archive/issue_comments_188224.json:
```json
{
    "body": "Sure, they could be added to a future version. I never even tried to implement them because it seemed like too much work to figure out all the case distinctions and writing test code for branch cuts. You seem to restrict the code to real arguments, which makes things easier and probably makes a good enough start.",
    "created_at": "2013-08-04T10:42:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188224",
    "user": "@fredrik-johansson"
}
```

Sure, they could be added to a future version. I never even tried to implement them because it seemed like too much work to figure out all the case distinctions and writing test code for branch cuts. You seem to restrict the code to real arguments, which makes things easier and probably makes a good enough start.



---

archive/issue_comments_188225.json:
```json
{
    "body": "Ah, good. Should I submit a pull request on [GitHub](GitHub) or something?\n\nThe reason I used real numbers for the inverse Jacobi is because it was a pain to get continuity otherwise. For the amplitude function, it's defined in the DLMF for real numbers (http://dlmf.nist.gov/22.16).",
    "created_at": "2013-08-05T00:40:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188225",
    "user": "@eviatarbach"
}
```

Ah, good. Should I submit a pull request on [GitHub](GitHub) or something?

The reason I used real numbers for the inverse Jacobi is because it was a pain to get continuity otherwise. For the amplitude function, it's defined in the DLMF for real numbers (http://dlmf.nist.gov/22.16).



---

archive/issue_comments_188226.json:
```json
{
    "body": "Sure, you're very welcome to supply a patch if you have time.\n\nBetter put this code in Sage now though, and then perhaps replace it with calls to mpmath in the future (can't guarantee when the next release of mpmath will happen, regrettably).",
    "created_at": "2013-08-07T21:11:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188226",
    "user": "@fredrik-johansson"
}
```

Sure, you're very welcome to supply a patch if you have time.

Better put this code in Sage now though, and then perhaps replace it with calls to mpmath in the future (can't guarantee when the next release of mpmath will happen, regrettably).



---

archive/issue_comments_188227.json:
```json
{
    "body": "Thanks, I will do so when I have time.\n\nNew patch fixes two bugs.",
    "created_at": "2013-08-14T04:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188227",
    "user": "@eviatarbach"
}
```

Thanks, I will do so when I have time.

New patch fixes two bugs.



---

archive/issue_comments_188228.json:
```json
{
    "body": "Attachment [trac14996_2.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996_2.patch) by @eviatarbach created at 2013-08-14 04:03:20",
    "created_at": "2013-08-14T04:03:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188228",
    "user": "@eviatarbach"
}
```

Attachment [trac14996_2.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996_2.patch) by @eviatarbach created at 2013-08-14 04:03:20



---

archive/issue_comments_188229.json:
```json
{
    "body": "New patch rebases to Sage 5.11, gets coverage to 100%, adds tons of new tests, and makes all Python `int`s in simplifications and derivatives Sage integers.\n\nPlease don't be worried about the length of the patch, much of it derives from identities and tests. Since there are 12 Jacobi elliptic functions and all their inverses, this adds up to a lot.\n\nPatchbot apply trac14996_3.patch",
    "created_at": "2013-09-02T22:47:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188229",
    "user": "@eviatarbach"
}
```

New patch rebases to Sage 5.11, gets coverage to 100%, adds tons of new tests, and makes all Python `int`s in simplifications and derivatives Sage integers.

Please don't be worried about the length of the patch, much of it derives from identities and tests. Since there are 12 Jacobi elliptic functions and all their inverses, this adds up to a lot.

Patchbot apply trac14996_3.patch



---

archive/issue_comments_188230.json:
```json
{
    "body": "Attachment [trac14996_3.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996_3.patch) by mjd created at 2013-09-03 09:30:28\n\nI did some tests, and the doctest for plot/line.py failed (it tries to plot a Jacobi elliptic function at line 413 and this goes awry in trying to convert a complex number which is very close into a real number to a real number).\n\nA small issue is that perhaps `jacobi` should complain if one passes to it as the first argument a string which is not of the form 'pq' with p, q one of s, c, n, d.  Moreover, if the argument is 'pp' then it could perhaps use the convention used in the documentation and return 1?\n\nI'm new to sage, apologies for the inanity of my comments.",
    "created_at": "2013-09-03T09:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188230",
    "user": "mjd"
}
```

Attachment [trac14996_3.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996_3.patch) by mjd created at 2013-09-03 09:30:28

I did some tests, and the doctest for plot/line.py failed (it tries to plot a Jacobi elliptic function at line 413 and this goes awry in trying to convert a complex number which is very close into a real number to a real number).

A small issue is that perhaps `jacobi` should complain if one passes to it as the first argument a string which is not of the form 'pq' with p, q one of s, c, n, d.  Moreover, if the argument is 'pp' then it could perhaps use the convention used in the documentation and return 1?

I'm new to sage, apologies for the inanity of my comments.



---

archive/issue_comments_188231.json:
```json
{
    "body": "No, they're not inane at all! Thanks for the comments, they bring up important issues to fix.\n\nYou're right about the doctest and the need to raise an error; the `Jacobi` class raises an error but I forgot to add it for the `jacobi` function. Fix coming up shortly.\n\nAs for the `pp=1` convention, it could be done but I don't see how it would be useful. In all sources I've seen they're called the \"12 Jacobi functions\". Also, it might give users the impression that Sage is actually calculating the ratios of the functions and simplifying. To remain consistent with the other functions we would also have to add the aliases `jacobi_nn`, `jacobi_ss`, etc., which amounts to just adding four constants that equal 1 to the global namespace.",
    "created_at": "2013-09-04T04:15:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188231",
    "user": "@eviatarbach"
}
```

No, they're not inane at all! Thanks for the comments, they bring up important issues to fix.

You're right about the doctest and the need to raise an error; the `Jacobi` class raises an error but I forgot to add it for the `jacobi` function. Fix coming up shortly.

As for the `pp=1` convention, it could be done but I don't see how it would be useful. In all sources I've seen they're called the "12 Jacobi functions". Also, it might give users the impression that Sage is actually calculating the ratios of the functions and simplifying. To remain consistent with the other functions we would also have to add the aliases `jacobi_nn`, `jacobi_ss`, etc., which amounts to just adding four constants that equal 1 to the global namespace.



---

archive/issue_comments_188232.json:
```json
{
    "body": "New patch fixes doctests, adds errors when an invalid Jacobi function name is given, and updates LaTeX conversions to follow the convention of using | as the parameter delimiter.\n\nPatchbot apply trac14996_4.patch",
    "created_at": "2013-09-05T01:44:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188232",
    "user": "@eviatarbach"
}
```

New patch fixes doctests, adds errors when an invalid Jacobi function name is given, and updates LaTeX conversions to follow the convention of using | as the parameter delimiter.

Patchbot apply trac14996_4.patch



---

archive/issue_comments_188233.json:
```json
{
    "body": "Attachment [trac14996_4.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996_4.patch) by @eviatarbach created at 2013-09-05 01:44:39",
    "created_at": "2013-09-05T01:44:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188233",
    "user": "@eviatarbach"
}
```

Attachment [trac14996_4.patch](tarball://root/attachments/some-uuid/ticket14996/trac14996_4.patch) by @eviatarbach created at 2013-09-05 01:44:39



---

archive/issue_comments_188234.json:
```json
{
    "body": "I think this is fine. It tests --long OK in functions/ and builds all docs. The docs look good too. The branch is on top of 6.2.beta2.\n\nAuthor copied from patch header.\n----\nNew commits:",
    "created_at": "2014-02-22T16:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188234",
    "user": "@rwst"
}
```

I think this is fine. It tests --long OK in functions/ and builds all docs. The docs look good too. The branch is on top of 6.2.beta2.

Author copied from patch header.
----
New commits:



---

archive/issue_comments_188235.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-02-22T16:08:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188235",
    "user": "@rwst"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_188236.json:
```json
{
    "body": "Fails with \n\n```\nsage -t src/sage/functions/jacobi.py\n**********************************************************************\nFile \"src/sage/functions/jacobi.py\", line 210, in sage.functions.jacobi.Jacobi._eval_\nFailed example:\n    almosteq(n(jacobi_nd(8, 0, hold=True)), n(jacobi_nd(8, 0)))\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.functions.jacobi.Jacobi._eval_[1]>\", line 1, in <module>\n        almosteq(n(jacobi_nd(Integer(8), Integer(0), hold=True)), n(jacobi_nd(Integer(8), Integer(0))))\n      File \"/home/release/Sage/local/lib/python2.7/site-packages/sage/misc/functional.py\", line 1413, in numerical_approx\n        return x._numerical_approx(prec, algorithm=algorithm)\n      File \"expression.pyx\", line 4704, in sage.symbolic.expression.Expression._numerical_approx (sage/symbolic/expression.cpp:23432)\n      File \"expression.pyx\", line 1036, in sage.symbolic.expression.Expression._convert (sage/symbolic/expression.cpp:7216)\n    TypeError: _evalf_() got an unexpected keyword argument 'algorithm'\n```\n\nPossibly due to the pynac update which I merged first #15198",
    "created_at": "2014-03-04T19:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188236",
    "user": "@vbraun"
}
```

Fails with 

```
sage -t src/sage/functions/jacobi.py
**********************************************************************
File "src/sage/functions/jacobi.py", line 210, in sage.functions.jacobi.Jacobi._eval_
Failed example:
    almosteq(n(jacobi_nd(8, 0, hold=True)), n(jacobi_nd(8, 0)))
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.functions.jacobi.Jacobi._eval_[1]>", line 1, in <module>
        almosteq(n(jacobi_nd(Integer(8), Integer(0), hold=True)), n(jacobi_nd(Integer(8), Integer(0))))
      File "/home/release/Sage/local/lib/python2.7/site-packages/sage/misc/functional.py", line 1413, in numerical_approx
        return x._numerical_approx(prec, algorithm=algorithm)
      File "expression.pyx", line 4704, in sage.symbolic.expression.Expression._numerical_approx (sage/symbolic/expression.cpp:23432)
      File "expression.pyx", line 1036, in sage.symbolic.expression.Expression._convert (sage/symbolic/expression.cpp:7216)
    TypeError: _evalf_() got an unexpected keyword argument 'algorithm'
```

Possibly due to the pynac update which I merged first #15198



---

archive/issue_comments_188237.json:
```json
{
    "body": "Presumably due to the simultaneously-merged and related #14778, but same difference - I am sure Eviatar can update for this very easily.",
    "created_at": "2014-03-04T20:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188237",
    "user": "@kcrisman"
}
```

Presumably due to the simultaneously-merged and related #14778, but same difference - I am sure Eviatar can update for this very easily.



---

archive/issue_comments_188238.json:
```json
{
    "body": "I've fixed the failing doctests and doc did not build, so I fixed that as well. I also did some formatting cleanup of the doc (while I was reading it over trying to find the docbuild issues).\n----\nNew commits:",
    "created_at": "2014-04-10T16:30:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188238",
    "user": "@tscrim"
}
```

I've fixed the failing doctests and doc did not build, so I fixed that as well. I also did some formatting cleanup of the doc (while I was reading it over trying to find the docbuild issues).
----
New commits:



---

archive/issue_comments_188239.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-05-06T23:03:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14759",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14759#issuecomment-188239",
    "user": "@vbraun"
}
```

Resolution: fixed
