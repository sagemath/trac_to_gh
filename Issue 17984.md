# Issue 17984: x / 2 doesn't work for x generator of free Q-algebra

Issue created by migration from Trac.

Original creator: darij

Original creation time: 2015-04-16 15:00:48

CC:  tscrim simonking nthiery robertwb vdelecroix

Keywords: coercion, sd67,


```
sage: R.<x> = FreeAlgebra(QQ)
sage: x/2
---------------------------------------------------------------------------
RuntimeError                              Traceback (most recent call last)
<ipython-input-2-749cf4ad628f> in <module>()
----> 1 x/Integer(2)

/home/skraeling/sage/src/sage/structure/element.pyx in sage.structure.element.RingElement.__div__ (build/cythonized/sage/structure/element.c:18393)()
   1955                 return (<RingElement>self)._div_(<RingElement>right)
   1956         global coercion_model
-> 1957         return coercion_model.bin_op(self, right, div)
   1958 
   1959     cpdef RingElement _div_(self, RingElement right):

/home/skraeling/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.bin_op (build/cythonized/sage/structure/coerce.c:7628)()
    849             if xp is yp:
    850                 return op(x,y)
--> 851             action = self.get_action(xp, yp, op, x, y)
    852             if action is not None:
    853                 return (<Action>action)._call_(x, y)

/home/skraeling/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.get_action (build/cythonized/sage/structure/coerce.c:13309)()
   1334             pass
   1335         action = self.discover_action(R, S, op, r, s)
-> 1336         action = self.verify_action(action, R, S, op)
   1337         self._action_maps.set(R, S, op, action)
   1338         return action

/home/skraeling/sage/src/sage/structure/coerce.pyx in sage.structure.coerce.CoercionModel_cache_maps.verify_action (build/cythonized/sage/structure/coerce.c:14389)()
   1386 
   1387             if action.left_domain() is not R or action.right_domain() is not S:
-> 1388                 raise RuntimeError, """There is a BUG in the coercion model:
   1389                 Action found for R %s S does not have the correct domains
   1390                 R = %s

RuntimeError: There is a BUG in the coercion model:
                Action found for R <built-in function div> S does not have the correct domains
                R = Free Algebra on 1 generators (x,) over Rational Field
                S = Integer Ring
                (should be Free Algebra on 1 generators (x,) over Rational Field, Rational Field)
                action = Right inverse action by Rational Field on Free Algebra on 1 generators (x,) over Rational Field (<type 'sage.categories.action.InverseAction'>)
```



---

Comment by SimonKing created at 2015-04-16 15:06:55


```
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.5.beta4, Release Date: 2014-12-21                   │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: R.<x> = FreeAlgebra(QQ)
sage: x/2
1/2*x
```

What is the problem?

EDIT: I mean, what version are you using?


---

Comment by darij created at 2015-04-16 15:08:24

I am using 6.7.beta1.


---

Comment by tscrim created at 2015-04-16 15:11:13

This fails is 6.6.rc2 as well.


---

Comment by tscrim created at 2015-04-16 15:20:43

The only changes since 6.6.beta4 in `src/structure` are in parent from #17981 and in `element.pyx`:

```diff
-include "sage/ext/stdsage.pxi"
 include "sage/ext/python.pxi"
 include "coerce.pxi"
+from sage.ext.stdsage cimport *
```

I'd be very surprised if the change I made in #17981 broke this.

EDIT - Oh, thats 6.5.beta4...


---

Comment by SimonKing created at 2015-04-16 15:24:18

Note that in the error message it says:

```
RuntimeError: There is a BUG in the coercion model:
                Action found for R <built-in function div> S does not have the correct domains
                R = Free Algebra on 1 generators (x,) over Rational Field
                S = Integer Ring
                (should be Free Algebra on 1 generators (x,) over Rational Field, Rational Field)
```

Hence, for a change we do not have the problem of non-unique unique parents or parents that have prematurely been garbage collected, but we have a genuinely wrong domain. The coercion model expects rational field but gets integer ring.


---

Comment by tscrim created at 2015-04-16 15:24:45

Okay, so from 6.5.beta4, the only non-trivial changes to `coerce_action.pyx` are in using `isinstance` instead of `PY_TYPE_CHECK` and adding an `__invert__` method to `ModuleAction`.


---

Comment by tscrim created at 2015-04-16 15:32:17

I'd guess this came from the changes of #17740 from looking at the diff.


---

Comment by tscrim created at 2015-04-16 16:11:24

Okay, #17740 is the culprit. What happens is it doesn't add the coercion from `ZZ -> QQ` which was originally in this line:

```
action = PrecomposedAction(action, None, K._internal_coerce_map_from(S))
```

----
New commits:


---

Comment by tscrim created at 2015-04-16 16:11:24

Changing status from new to needs_review.


---

Comment by git created at 2015-04-16 16:27:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-04-16 16:32:32

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-04-16 16:32:32

Nicolas looked over the code on my computer and gave it an okay.


---

Comment by nthiery created at 2015-04-16 19:19:09

Changing status from positive_review to needs_review.


---

Comment by nthiery created at 2015-04-16 19:21:32

Sorry, I misexpressed myself: this looks good to me, but I would not mind having a quick double check by the authors of #17740.


---

Comment by vdelecroix created at 2015-04-16 19:31:19

Hello,

In the doc I would not write `Bug :trac:`18221``. It looks like there is a problem, but your are actually checking that there is none. Beyond this trivial comment, I am sorry that we broke that in #17740. And the fix looks like the good one to me.

Vincent


---

Comment by git created at 2015-04-16 20:09:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-04-16 20:10:26

I had just copied the message added in #17740, so I changed that docstring too.


---

Comment by darij created at 2015-04-16 21:37:06

Is this pos_rev then?


---

Comment by vdelecroix created at 2015-04-16 21:46:02

ok for me at least


---

Comment by nthiery created at 2015-04-16 22:05:44

Changing status from needs_review to positive_review.


---

Comment by nthiery created at 2015-04-16 22:06:20

Assuming all tests pass, that's good to go!


---

Comment by vbraun created at 2015-04-19 01:52:03

Resolution: fixed
