# Issue 10395: Side-effect of EllipticCurve.torsion_group: Destroying uniqueness of parents

archive/issues_010395.json:
```json
{
    "body": "Assignee: cremona\n\nKeywords: torsion_group, uniqueness of parents, coerce map\n\nWe have\n\n```\nsage: K.<i>=NumberField(x^2 + 1)\nsage: R = ZZ.extension(x**2+1,'i')\nsage: f1 = K.coerce_map_from(R)\nsage: f1.domain() is R\nTrue\nsage: E = EllipticCurve(K,[0,0,0,1,0])\nsage: E.torsion_subgroup()\nTorsion Subgroup isomorphic to Z/2 + Z/2 associated to the Elliptic Curve defined by y^2 = x^3 + x over Number Field in i with defining polynomial x^2 + 1\nsage: R = ZZ.extension(x**2+1,'i')\nsage: f2 = K.coerce_map_from(R)\nsage: f2.domain() is R\nFalse\nsage: f2.domain() == R\nTrue\n```\n\n\nHence, on the one hand, computing the torsion group destroys uniqueness of parents, and moreover, it makes the coerce map from an order to its ambient field have a domain that is not the same that is requested.\n\nIssue created by migration from https://trac.sagemath.org/ticket/10448\n\n",
    "created_at": "2010-12-09T13:44:32Z",
    "labels": [
        "elliptic curves",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.3",
    "title": "Side-effect of EllipticCurve.torsion_group: Destroying uniqueness of parents",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/10395",
    "user": "SimonKing"
}
```
Assignee: cremona

Keywords: torsion_group, uniqueness of parents, coerce map

We have

```
sage: K.<i>=NumberField(x^2 + 1)
sage: R = ZZ.extension(x**2+1,'i')
sage: f1 = K.coerce_map_from(R)
sage: f1.domain() is R
True
sage: E = EllipticCurve(K,[0,0,0,1,0])
sage: E.torsion_subgroup()
Torsion Subgroup isomorphic to Z/2 + Z/2 associated to the Elliptic Curve defined by y^2 = x^3 + x over Number Field in i with defining polynomial x^2 + 1
sage: R = ZZ.extension(x**2+1,'i')
sage: f2 = K.coerce_map_from(R)
sage: f2.domain() is R
False
sage: f2.domain() == R
True
```


Hence, on the one hand, computing the torsion group destroys uniqueness of parents, and moreover, it makes the coerce map from an order to its ambient field have a domain that is not the same that is requested.

Issue created by migration from https://trac.sagemath.org/ticket/10448





---

archive/issue_comments_106974.json:
```json
{
    "body": "Changing component from elliptic curves to number fields.",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106974",
    "user": "SimonKing"
}
```

Changing component from elliptic curves to number fields.



---

archive/issue_comments_106975.json:
```json
{
    "body": "Changing assignee from cremona to davidloeffler.",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106975",
    "user": "SimonKing"
}
```

Changing assignee from cremona to davidloeffler.



---

archive/issue_comments_106976.json:
```json
{
    "body": "Changing priority from critical to major.",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106976",
    "user": "SimonKing"
}
```

Changing priority from critical to major.



---

archive/issue_comments_106977.json:
```json
{
    "body": "Changing keywords from \"torsion_group, uniqueness of parents, coerce map\" to \"uniqueness of parents\".",
    "created_at": "2010-12-09T13:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106977",
    "user": "SimonKing"
}
```

Changing keywords from "torsion_group, uniqueness of parents, coerce map" to "uniqueness of parents".



---

archive/issue_comments_106978.json:
```json
{
    "body": "Sorry for changing the original ticket completely: When I created it, I thought it was a side effect of torsion_subgroup. But in fact, the lacking uniqueness is an independent problem.",
    "created_at": "2010-12-09T13:54:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106978",
    "user": "SimonKing"
}
```

Sorry for changing the original ticket completely: When I created it, I thought it was a side effect of torsion_subgroup. But in fact, the lacking uniqueness is an independent problem.



---

archive/issue_comments_106979.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2010-12-09T14:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106979",
    "user": "SimonKing"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_106980.json:
```json
{
    "body": "Apparently it suffices to decorate the `order` method of number fields so that it is cached. I added a doctest. I did not do `sage -testall` yet, but I'll do now, and I think I can mark it as \"ready for review\".",
    "created_at": "2010-12-09T14:07:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106980",
    "user": "SimonKing"
}
```

Apparently it suffices to decorate the `order` method of number fields so that it is cached. I added a doctest. I did not do `sage -testall` yet, but I'll do now, and I think I can mark it as "ready for review".



---

archive/issue_comments_106981.json:
```json
{
    "body": "It needs work: There is some code in heegner.py which calls `.order(...)` with a list, not a tuple. Hence, the ``@`cached_method` decorator complains.\n\nI'll change it and post a new patch as soon as all tests pass.",
    "created_at": "2010-12-09T16:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106981",
    "user": "SimonKing"
}
```

It needs work: There is some code in heegner.py which calls `.order(...)` with a list, not a tuple. Hence, the ``@`cached_method` decorator complains.

I'll change it and post a new patch as soon as all tests pass.



---

archive/issue_comments_106982.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-12-09T16:43:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106982",
    "user": "SimonKing"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_106983.json:
```json
{
    "body": "The updated patch ensures that the new cached `order()` method is called with tuples, not lists. `sage -tp 4` passes for me. Ready for review!",
    "created_at": "2010-12-09T18:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106983",
    "user": "SimonKing"
}
```

The updated patch ensures that the new cached `order()` method is called with tuples, not lists. `sage -tp 4` passes for me. Ready for review!



---

archive/issue_comments_106984.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-12-09T18:26:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106984",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_106985.json:
```json
{
    "body": "I don't like this: it's something of a convention in Sage that functions creating an object given some generators tend to take lists, and forcing \"order\" to take only tuples breaks that, which is confusing for the user. I'd be much happier if this was implemented differently so `order` could take a list (e.g. by tuplifying its arguments and calling a second internal method, `_order_from_cache` or suchlike, which used the ``@`cached_method` machinery).\n\nOthers may disagree, so I'm leaving this at \"needs_review\".",
    "created_at": "2010-12-16T13:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106985",
    "user": "davidloeffler"
}
```

I don't like this: it's something of a convention in Sage that functions creating an object given some generators tend to take lists, and forcing "order" to take only tuples breaks that, which is confusing for the user. I'd be much happier if this was implemented differently so `order` could take a list (e.g. by tuplifying its arguments and calling a second internal method, `_order_from_cache` or suchlike, which used the ``@`cached_method` machinery).

Others may disagree, so I'm leaving this at "needs_review".



---

archive/issue_comments_106986.json:
```json
{
    "body": "That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) \n\nMuch better to just convert gens to a tuple in the called function.",
    "created_at": "2010-12-16T16:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106986",
    "user": "robertwb"
}
```

That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) 

Much better to just convert gens to a tuple in the called function.



---

archive/issue_comments_106987.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2010-12-16T16:57:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106987",
    "user": "robertwb"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_106988.json:
```json
{
    "body": "Attachment [10448_unique_orders_in_numberfields.patch](tarball://root/attachments/some-uuid/ticket10448/10448_unique_orders_in_numberfields.patch) by SimonKing created at 2010-12-16 20:50:53\n\nMake orders in number fields unique",
    "created_at": "2010-12-16T20:50:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106988",
    "user": "SimonKing"
}
```

Attachment [10448_unique_orders_in_numberfields.patch](tarball://root/attachments/some-uuid/ticket10448/10448_unique_orders_in_numberfields.patch) by SimonKing created at 2010-12-16 20:50:53

Make orders in number fields unique



---

archive/issue_comments_106989.json:
```json
{
    "body": "Dear David, dear Robert\n\nReplying to [comment:7 robertwb]:\n> That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) \n> \n> Much better to just convert gens to a tuple in the called function. \n\nThere is a convenient way: Everything is based on the function `sage.rings.number_field.order.absolute_order_from_module_generators`. This function is not supposed to be called directly, if I understand correctly. Hence, it won't hurt to change the expected input of that function (or of `sage.rings.number_field.order.absolute_order_from_ring_generators`).\n\nMy solution is:\n* Prepend `sage.rings.number_field.order.absolute_order_from_module_generators` with ``@`cached_function`.\n* The generators must form a tuple, so, the internals of some methods need to be adapted.\n* In addition to the tuple of generators, I suggest that the field is passed as an argument as well.\n\nThe last point is for preventing coercion trouble: If there is a coercion from number field K to number field L and if only the tuple of generators would be cached, then orders in K would be identic to orders in L. Therefore, the field *must* be included in the cache data.\n\nAnyway. I reverted part of the doctests, so that we have tests where `K.order(...)` is called with a single element, with a list of elements, or with a tuple of elements. And of course we have a new test for the cache. Ready for review, I guess.",
    "created_at": "2010-12-16T21:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106989",
    "user": "SimonKing"
}
```

Dear David, dear Robert

Replying to [comment:7 robertwb]:
> That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) 
> 
> Much better to just convert gens to a tuple in the called function. 

There is a convenient way: Everything is based on the function `sage.rings.number_field.order.absolute_order_from_module_generators`. This function is not supposed to be called directly, if I understand correctly. Hence, it won't hurt to change the expected input of that function (or of `sage.rings.number_field.order.absolute_order_from_ring_generators`).

My solution is:
* Prepend `sage.rings.number_field.order.absolute_order_from_module_generators` with ``@`cached_function`.
* The generators must form a tuple, so, the internals of some methods need to be adapted.
* In addition to the tuple of generators, I suggest that the field is passed as an argument as well.

The last point is for preventing coercion trouble: If there is a coercion from number field K to number field L and if only the tuple of generators would be cached, then orders in K would be identic to orders in L. Therefore, the field *must* be included in the cache data.

Anyway. I reverted part of the doctests, so that we have tests where `K.order(...)` is called with a single element, with a list of elements, or with a tuple of elements. And of course we have a new test for the cache. Ready for review, I guess.



---

archive/issue_comments_106990.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2010-12-16T21:01:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106990",
    "user": "SimonKing"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_106991.json:
```json
{
    "body": "I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.  What you've implemented is certainly better than the status quo though, and I'd be up for giving it a positive review; I just wanted to bring up the `UniqueFactory` approach in case you felt motivated to do it.  :-)",
    "created_at": "2010-12-22T10:47:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106991",
    "user": "roed"
}
```

I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.  What you've implemented is certainly better than the status quo though, and I'd be up for giving it a positive review; I just wanted to bring up the `UniqueFactory` approach in case you felt motivated to do it.  :-)



---

archive/issue_comments_106992.json:
```json
{
    "body": "Replying to [comment:9 roed]:\n> I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.\n\nThat would indeed be nice, but I currently don't have the time resources to implement it.",
    "created_at": "2011-01-18T06:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106992",
    "user": "SimonKing"
}
```

Replying to [comment:9 roed]:
> I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.

That would indeed be nice, but I currently don't have the time resources to implement it.



---

archive/issue_comments_106993.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-01-20T11:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106993",
    "user": "davidloeffler"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_106994.json:
```json
{
    "body": "There is a risk of this breaking garbage collection of number fields. \n\nThe number field code is quite carefully written so that number fields are globally unique, but only weak references to them are cached, so the uniqueness doesn't mean they hang around in memory longer than they should. The patch here would have the disadvantage that as soon as one created any order in a number field, the order (and hence also its parent number field) would hang around for the rest of the Sage session, as an entry in the cache of `absolute_order_from_module_generators`. \n\n(Using `UniqueFactory` wouldn't solve this; it would cache weak references so that orders could still be garbage collected, but these weakrefs would be stored in a cache whose *keys* included the number field, so the number field still couldn't be garbage collected.)\n\nThe best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using ``@`cached_method` as usual. Then the second method's cache is then an attribute of the number field, and hence (a) there is no need to include the number field in the arguments, and (b) the number field and the orders can be garbage collected without problems. (This is what I suggested 5 weeks ago.)\n\nOn the other hand, this is all a bit theoretical, because of the issue at ticket #715: it's basically impossible to get rid of *any* parent object created in a Sage session, because the coercion model caches stuff all over the place. But I think we shouldn't compound the problem further here.",
    "created_at": "2011-01-20T11:27:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106994",
    "user": "davidloeffler"
}
```

There is a risk of this breaking garbage collection of number fields. 

The number field code is quite carefully written so that number fields are globally unique, but only weak references to them are cached, so the uniqueness doesn't mean they hang around in memory longer than they should. The patch here would have the disadvantage that as soon as one created any order in a number field, the order (and hence also its parent number field) would hang around for the rest of the Sage session, as an entry in the cache of `absolute_order_from_module_generators`. 

(Using `UniqueFactory` wouldn't solve this; it would cache weak references so that orders could still be garbage collected, but these weakrefs would be stored in a cache whose *keys* included the number field, so the number field still couldn't be garbage collected.)

The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using ``@`cached_method` as usual. Then the second method's cache is then an attribute of the number field, and hence (a) there is no need to include the number field in the arguments, and (b) the number field and the orders can be garbage collected without problems. (This is what I suggested 5 weeks ago.)

On the other hand, this is all a bit theoretical, because of the issue at ticket #715: it's basically impossible to get rid of *any* parent object created in a Sage session, because the coercion model caches stuff all over the place. But I think we shouldn't compound the problem further here.



---

archive/issue_comments_106995.json:
```json
{
    "body": "Hi David,\n\nCurrently I try to produce a patch according to your suggestions. However:\n\nReplying to [comment:11 davidloeffler]:\n> There is a risk of this breaking garbage collection of number fields. \n> \n> The number field code is quite carefully written so that number fields are globally unique...\n\nThat's not true.\n\n```\nsage: K.<z7> = QuadraticField(7)\nsage: K is loads(dumps(K))\nFalse\n```\n\n\n> The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using ``@`cached_method` as usual.\n\nDoing so, there is indeed uniqueness of orders, and that should also be useful for pickling. However, number fields are not unique parents, and so orders can only be unique in their number fields, but not globally.",
    "created_at": "2011-03-25T14:53:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106995",
    "user": "SimonKing"
}
```

Hi David,

Currently I try to produce a patch according to your suggestions. However:

Replying to [comment:11 davidloeffler]:
> There is a risk of this breaking garbage collection of number fields. 
> 
> The number field code is quite carefully written so that number fields are globally unique...

That's not true.

```
sage: K.<z7> = QuadraticField(7)
sage: K is loads(dumps(K))
False
```


> The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using ``@`cached_method` as usual.

Doing so, there is indeed uniqueness of orders, and that should also be useful for pickling. However, number fields are not unique parents, and so orders can only be unique in their number fields, but not globally.



---

archive/issue_comments_106996.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-04-03T07:01:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106996",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_106997.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-04-03T07:03:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106997",
    "user": "saraedum"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_106998.json:
```json
{
    "body": "Looks good to me and passes all tests.  The \"work issues: breaks garbage collection\" isn't relevant anymore, is it?  And what about the \"Authors\" field?",
    "created_at": "2014-05-20T17:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106998",
    "user": "pbruin"
}
```

Looks good to me and passes all tests.  The "work issues: breaks garbage collection" isn't relevant anymore, is it?  And what about the "Authors" field?



---

archive/issue_comments_106999.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-05-29T23:06:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-106999",
    "user": "pbruin"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_107000.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-06-02T12:54:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/10395",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/10395#issuecomment-107000",
    "user": "vbraun"
}
```

Resolution: fixed
