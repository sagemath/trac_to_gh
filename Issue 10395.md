# Issue 10395: Side-effect of EllipticCurve.torsion_group: Destroying uniqueness of parents

Issue created by migration from https://trac.sagemath.org/ticket/10448

Original creator: SimonKing

Original creation time: 2010-12-09 13:44:32

Assignee: cremona

Keywords: torsion_group, uniqueness of parents, coerce map

We have

```
sage: K.<i>=NumberField(x^2 + 1)
sage: R = ZZ.extension(x**2+1,'i')
sage: f1 = K.coerce_map_from(R)
sage: f1.domain() is R
True
sage: E = EllipticCurve(K,[0,0,0,1,0])
sage: E.torsion_subgroup()
Torsion Subgroup isomorphic to Z/2 + Z/2 associated to the Elliptic Curve defined by y^2 = x^3 + x over Number Field in i with defining polynomial x^2 + 1
sage: R = ZZ.extension(x**2+1,'i')
sage: f2 = K.coerce_map_from(R)
sage: f2.domain() is R
False
sage: f2.domain() == R
True
```


Hence, on the one hand, computing the torsion group destroys uniqueness of parents, and moreover, it makes the coerce map from an order to its ambient field have a domain that is not the same that is requested.


---

Comment by SimonKing created at 2010-12-09 13:53:26

Changing component from elliptic curves to number fields.


---

Comment by SimonKing created at 2010-12-09 13:53:26

Changing assignee from cremona to davidloeffler.


---

Comment by SimonKing created at 2010-12-09 13:53:26

Changing priority from critical to major.


---

Comment by SimonKing created at 2010-12-09 13:53:26

Changing keywords from "torsion_group, uniqueness of parents, coerce map" to "uniqueness of parents".


---

Comment by SimonKing created at 2010-12-09 13:54:31

Sorry for changing the original ticket completely: When I created it, I thought it was a side effect of torsion_subgroup. But in fact, the lacking uniqueness is an independent problem.


---

Comment by SimonKing created at 2010-12-09 14:07:08

Changing status from new to needs_review.


---

Comment by SimonKing created at 2010-12-09 14:07:08

Apparently it suffices to decorate the `order` method of number fields so that it is cached. I added a doctest. I did not do `sage -testall` yet, but I'll do now, and I think I can mark it as "ready for review".


---

Comment by SimonKing created at 2010-12-09 16:43:35

It needs work: There is some code in heegner.py which calls `.order(...)` with a list, not a tuple. Hence, the ``@`cached_method` decorator complains.

I'll change it and post a new patch as soon as all tests pass.


---

Comment by SimonKing created at 2010-12-09 16:43:35

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2010-12-09 18:26:55

The updated patch ensures that the new cached `order()` method is called with tuples, not lists. `sage -tp 4` passes for me. Ready for review!


---

Comment by SimonKing created at 2010-12-09 18:26:55

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2010-12-16 13:28:27

I don't like this: it's something of a convention in Sage that functions creating an object given some generators tend to take lists, and forcing "order" to take only tuples breaks that, which is confusing for the user. I'd be much happier if this was implemented differently so `order` could take a list (e.g. by tuplifying its arguments and calling a second internal method, `_order_from_cache` or suchlike, which used the ``@`cached_method` machinery).

Others may disagree, so I'm leaving this at "needs_review".


---

Comment by robertwb created at 2010-12-16 16:57:37

That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) 

Much better to just convert gens to a tuple in the called function.


---

Comment by robertwb created at 2010-12-16 16:57:37

Changing status from needs_review to needs_work.


---

Attachment

Make orders in number fields unique


---

Comment by SimonKing created at 2010-12-16 21:01:49

Dear David, dear Robert

Replying to [comment:7 robertwb]:
> That was exactly my first thought as well, we should not require the list of generators to be a tuple. (As well as breaking convention, this will break people's existing code.) 
> 
> Much better to just convert gens to a tuple in the called function. 

There is a convenient way: Everything is based on the function `sage.rings.number_field.order.absolute_order_from_module_generators`. This function is not supposed to be called directly, if I understand correctly. Hence, it won't hurt to change the expected input of that function (or of `sage.rings.number_field.order.absolute_order_from_ring_generators`).

My solution is:
 * Prepend `sage.rings.number_field.order.absolute_order_from_module_generators` with ``@`cached_function`.
 * The generators must form a tuple, so, the internals of some methods need to be adapted.
 * In addition to the tuple of generators, I suggest that the field is passed as an argument as well.

The last point is for preventing coercion trouble: If there is a coercion from number field K to number field L and if only the tuple of generators would be cached, then orders in K would be identic to orders in L. Therefore, the field _must_ be included in the cache data.

Anyway. I reverted part of the doctests, so that we have tests where `K.order(...)` is called with a single element, with a list of elements, or with a tuple of elements. And of course we have a new test for the cache. Ready for review, I guess.


---

Comment by SimonKing created at 2010-12-16 21:01:49

Changing status from needs_work to needs_review.


---

Comment by roed created at 2010-12-22 10:47:47

I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.  What you've implemented is certainly better than the status quo though, and I'd be up for giving it a positive review; I just wanted to bring up the `UniqueFactory` approach in case you felt motivated to do it.  :-)


---

Comment by SimonKing created at 2011-01-18 06:58:07

Replying to [comment:9 roed]:
> I somewhat prefer using `sage.structure.factory.UniqueFactory` rather than `cached_function` for object creation.  The benefits are that you get better handling of duplicate keys, pickling and unpickling via the factory.

That would indeed be nice, but I currently don't have the time resources to implement it.


---

Comment by davidloeffler created at 2011-01-20 11:27:00

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2011-01-20 11:27:00

There is a risk of this breaking garbage collection of number fields. 

The number field code is quite carefully written so that number fields are globally unique, but only weak references to them are cached, so the uniqueness doesn't mean they hang around in memory longer than they should. The patch here would have the disadvantage that as soon as one created any order in a number field, the order (and hence also its parent number field) would hang around for the rest of the Sage session, as an entry in the cache of `absolute_order_from_module_generators`. 

(Using `UniqueFactory` wouldn't solve this; it would cache weak references so that orders could still be garbage collected, but these weakrefs would be stored in a cache whose *keys* included the number field, so the number field still couldn't be garbage collected.)

The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using ``@`cached_method` as usual. Then the second method's cache is then an attribute of the number field, and hence (a) there is no need to include the number field in the arguments, and (b) the number field and the orders can be garbage collected without problems. (This is what I suggested 5 weeks ago.)

On the other hand, this is all a bit theoretical, because of the issue at ticket #715: it's basically impossible to get rid of *any* parent object created in a Sage session, because the coercion model caches stuff all over the place. But I think we shouldn't compound the problem further here.


---

Comment by SimonKing created at 2011-03-25 14:53:26

Hi David,

Currently I try to produce a patch according to your suggestions. However:

Replying to [comment:11 davidloeffler]:
> There is a risk of this breaking garbage collection of number fields. 
> 
> The number field code is quite carefully written so that number fields are globally unique...

That's not true.

```
sage: K.<z7> = QuadraticField(7)
sage: K is loads(dumps(K))
False
```


> The best solution I can think of would be to store orders in a cache which was itself an attribute of the parent number field. This could be implemented by making `order` tuplify its arguments and then call a second *method* `_order_from_cache`, implemented using ``@`cached_method` as usual.

Doing so, there is indeed uniqueness of orders, and that should also be useful for pickling. However, number fields are not unique parents, and so orders can only be unique in their number fields, but not globally.


---

Comment by git created at 2014-04-03 07:01:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by saraedum created at 2014-04-03 07:03:32

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2014-05-20 17:53:20

Looks good to me and passes all tests.  The "work issues: breaks garbage collection" isn't relevant anymore, is it?  And what about the "Authors" field?


---

Comment by pbruin created at 2014-05-29 23:06:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-06-02 12:54:46

Resolution: fixed
