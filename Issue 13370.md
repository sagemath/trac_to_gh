# Issue 13370: sage-spkg: check much earlier whether package is already installed

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-10-06 09:55:18

Assignee: GeorgSWeber




---

Comment by jdemeyer created at 2012-10-06 10:27:21

Changing status from new to needs_review.


---

Attachment


---

Comment by jhpalmieri created at 2012-10-08 17:28:34

What should be the behavior of `sage --info mpir` in a binary distribution? I think that with this patch, the mpir spkg will be downloaded and SPKG.txt will be extracted. This is not very efficient. Either the command should exit with an appropriate error message, or we should just download [SPKG.txt](http://sagemath.org/packages/standard/mpir-2.4.0.p6.txt). I think it should be enough to change the URL to end with ".txt" instead of ".spkg".

When looking for the spkg in cases 2a or 3, why not look in spkg/installed instead of spkg/standard and spkg/optional?

```diff
diff --git a/spkg/bin/sage-spkg b/spkg/bin/sage-spkg
--- a/spkg/bin/sage-spkg
+++ b/spkg/bin/sage-spkg
`@``@` -224,15 +224,14 `@``@` if [ -f "$PKG_SRC" ]; then
     fi
 elif [ -z "$PKG_HAS_PATH" ]; then
     # If PKG_SRC is not an existing file and doesn't contain a slash,
-    # we are in case 2a or 3.  Try to find a package in spkg/standard
-    # or spkg/optional (or other possible directories under spkg).
+    # we are in case 2a or 3.  Try to find a receipt in spkg/installed.
     cd "$SAGE_PACKAGES"
-    for spkg in `ls -1t */${PKG_NAME}.spkg */${PKG_NAME}-*.spkg 2>/dev/null`; do
+    for spkg in `ls -1t installed/${PKG_NAME} installed/${PKG_NAME}-* 2>/dev/null`; do
         if [ -f "$spkg" ]; then
             # Found a good package
-            echo "Found package $PKG_NAME in spkg/$spkg"
+            echo "Found receipt for package $PKG_NAME in spkg/$spkg"
             PKG_SRC="`pwd`/$spkg"
-            PKG_NAME=`basename "$spkg" | sed 's/\.spkg$//'`
+            PKG_NAME=`basename "$spkg"`
             break
         fi
     done
```

The script could actually terminate at this point, if `$FORCE -eq 0` etc.


---

Comment by jhpalmieri created at 2012-10-08 17:30:56

(I should say, why not check spkg/installed _in addition to_ spkg/standard and spkg/optional?)


---

Comment by jhpalmieri created at 2012-10-08 18:02:28

Here's a proposed patch to be applied on top of yours.


---

Attachment


---

Comment by jhpalmieri created at 2012-10-08 18:04:31

I tested this with `sage --info gcc`, `sage --info chomp` (not having downloaded chomp yet), and `sage --info junk`. It seems to behave okay.


---

Comment by jhpalmieri created at 2012-10-08 18:09:47

When getting the info on-line, the "`| cat`" in `sage-download-file "$PKG_URL" | cat` should not be necessary, but without it, the file is dumped to standard output in the middle of some brackets printed by sage-download-file. Should I instead do `sage-download-file "$PKG_URL" 2> /dev/null`? I don't want to lose important error messages.


---

Comment by jdemeyer created at 2012-10-08 20:52:29

Replying to [comment:5 jhpalmieri]:
> When looking for the spkg in cases 2a or 3, why not look in spkg/installed instead of spkg/standard and spkg/optional?
Mainly, I simply didn't want to change the functionality of

```
./sage -f foo
```


It's hard to tell which behaviour would be the most expected when doing

```
./sage -i mpir
```

in the case that mpir is already installed, but no local mpir package exists in `spkg/`.  Should it re-install the installed version or should it download the latest online version?

If you look in `installed/`, then

```
./sage -i mpir
```

is going to fail in a lot more cases (it needs to download the exact version, which might not be found).  So maybe I prefer to increase the chances of success, even if a different version might be installed.  That means, don't consider `installed/`.

In any case, `./sage -i` and `./sage -f` should be consistent, the version cannot depend on whether `-f` was given.


---

Comment by jdemeyer created at 2012-10-09 08:04:28

Replying to [comment:9 jhpalmieri]:
> When getting the info on-line, the "`| cat`" in `sage-download-file "$PKG_URL" | cat` should not be necessary, but without it, the file is dumped to standard output in the middle of some brackets printed by sage-download-file. Should I instead do `sage-download-file "$PKG_URL" 2> /dev/null`? I don't want to lose important error messages.

The `| cat` is a silly hack which just happens to work because of I/O buffers.  I would redirect `2>/dev/null`.  For `./sage --info`, I don't want to rely anyway on the existence of those `.txt` files.  In case downloading the txt file fails (and we don't see the error message), simply fall back to the old method of downloading the spkg and extracting `SPKG.txt`.


---

Comment by jdemeyer created at 2012-10-23 07:25:30

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2012-10-23 07:25:30

needs work, but no priority since sage-5.4 should be done first.


---

Comment by jdemeyer created at 2012-11-06 21:08:52

Changing status from needs_work to needs_review.


---

Attachment


---

Comment by jdemeyer created at 2012-11-06 21:10:18

John, I removed the part of your patch which checks `installed` and simplified the downloading of the .txt file for `sage --info`.  Needs review.


---

Comment by jhpalmieri created at 2012-11-07 20:49:37

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-11-07 20:49:37

Okay, this looks okay to me.


---

Comment by jhpalmieri created at 2012-11-07 20:56:48

By the way, running `sage --info gcc` is faster on my machine if the spkg is _not_ present: downloading the `SPKG.txt` file is quicker than untarring to extract the single file (about half a second vs. seven seconds). This is from my office at the university where I have a good internet connection, of course.

If we thought that lots of people were using `sage --info ...`, we should look for ways to speed up this operation. My guess is that it's not used very much, though, so we shouldn't worry about it.


---

Comment by jdemeyer created at 2012-11-12 21:57:23

Resolution: fixed
