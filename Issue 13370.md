# Issue 13370: sage-spkg: check much earlier whether package is already installed

archive/issues_013370.json:
```json
{
    "body": "Assignee: GeorgSWeber\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/13574\n\n",
    "created_at": "2012-10-06T09:55:18Z",
    "labels": [
        "component: build"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.5",
    "title": "sage-spkg: check much earlier whether package is already installed",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/13370",
    "user": "https://github.com/jdemeyer"
}
```
Assignee: GeorgSWeber



Issue created by migration from https://trac.sagemath.org/ticket/13574





---

archive/issue_comments_164066.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-10-06T10:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164066",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_164067.json:
```json
{
    "body": "Attachment [13574_spkg_already_installed.patch](tarball://root/attachments/some-uuid/ticket13574/13574_spkg_already_installed.patch) by @jdemeyer created at 2012-10-06 10:27:21",
    "created_at": "2012-10-06T10:27:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164067",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13574_spkg_already_installed.patch](tarball://root/attachments/some-uuid/ticket13574/13574_spkg_already_installed.patch) by @jdemeyer created at 2012-10-06 10:27:21



---

archive/issue_comments_164068.json:
```json
{
    "body": "What should be the behavior of `sage --info mpir` in a binary distribution? I think that with this patch, the mpir spkg will be downloaded and SPKG.txt will be extracted. This is not very efficient. Either the command should exit with an appropriate error message, or we should just download [SPKG.txt](http://sagemath.org/packages/standard/mpir-2.4.0.p6.txt). I think it should be enough to change the URL to end with \".txt\" instead of \".spkg\".\n\nWhen looking for the spkg in cases 2a or 3, why not look in spkg/installed instead of spkg/standard and spkg/optional?\n\n```diff\ndiff --git a/spkg/bin/sage-spkg b/spkg/bin/sage-spkg\n--- a/spkg/bin/sage-spkg\n+++ b/spkg/bin/sage-spkg\n@@ -224,15 +224,14 @@ if [ -f \"$PKG_SRC\" ]; then\n     fi\n elif [ -z \"$PKG_HAS_PATH\" ]; then\n     # If PKG_SRC is not an existing file and doesn't contain a slash,\n-    # we are in case 2a or 3.  Try to find a package in spkg/standard\n-    # or spkg/optional (or other possible directories under spkg).\n+    # we are in case 2a or 3.  Try to find a receipt in spkg/installed.\n     cd \"$SAGE_PACKAGES\"\n-    for spkg in `ls -1t */${PKG_NAME}.spkg */${PKG_NAME}-*.spkg 2>/dev/null`; do\n+    for spkg in `ls -1t installed/${PKG_NAME} installed/${PKG_NAME}-* 2>/dev/null`; do\n         if [ -f \"$spkg\" ]; then\n             # Found a good package\n-            echo \"Found package $PKG_NAME in spkg/$spkg\"\n+            echo \"Found receipt for package $PKG_NAME in spkg/$spkg\"\n             PKG_SRC=\"`pwd`/$spkg\"\n-            PKG_NAME=`basename \"$spkg\" | sed 's/\\.spkg$//'`\n+            PKG_NAME=`basename \"$spkg\"`\n             break\n         fi\n     done\n```\n\nThe script could actually terminate at this point, if `$FORCE -eq 0` etc.",
    "created_at": "2012-10-08T17:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164068",
    "user": "https://github.com/jhpalmieri"
}
```

What should be the behavior of `sage --info mpir` in a binary distribution? I think that with this patch, the mpir spkg will be downloaded and SPKG.txt will be extracted. This is not very efficient. Either the command should exit with an appropriate error message, or we should just download [SPKG.txt](http://sagemath.org/packages/standard/mpir-2.4.0.p6.txt). I think it should be enough to change the URL to end with ".txt" instead of ".spkg".

When looking for the spkg in cases 2a or 3, why not look in spkg/installed instead of spkg/standard and spkg/optional?

```diff
diff --git a/spkg/bin/sage-spkg b/spkg/bin/sage-spkg
--- a/spkg/bin/sage-spkg
+++ b/spkg/bin/sage-spkg
@@ -224,15 +224,14 @@ if [ -f "$PKG_SRC" ]; then
     fi
 elif [ -z "$PKG_HAS_PATH" ]; then
     # If PKG_SRC is not an existing file and doesn't contain a slash,
-    # we are in case 2a or 3.  Try to find a package in spkg/standard
-    # or spkg/optional (or other possible directories under spkg).
+    # we are in case 2a or 3.  Try to find a receipt in spkg/installed.
     cd "$SAGE_PACKAGES"
-    for spkg in `ls -1t */${PKG_NAME}.spkg */${PKG_NAME}-*.spkg 2>/dev/null`; do
+    for spkg in `ls -1t installed/${PKG_NAME} installed/${PKG_NAME}-* 2>/dev/null`; do
         if [ -f "$spkg" ]; then
             # Found a good package
-            echo "Found package $PKG_NAME in spkg/$spkg"
+            echo "Found receipt for package $PKG_NAME in spkg/$spkg"
             PKG_SRC="`pwd`/$spkg"
-            PKG_NAME=`basename "$spkg" | sed 's/\.spkg$//'`
+            PKG_NAME=`basename "$spkg"`
             break
         fi
     done
```

The script could actually terminate at this point, if `$FORCE -eq 0` etc.



---

archive/issue_comments_164069.json:
```json
{
    "body": "(I should say, why not check spkg/installed *in addition to* spkg/standard and spkg/optional?)",
    "created_at": "2012-10-08T17:30:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164069",
    "user": "https://github.com/jhpalmieri"
}
```

(I should say, why not check spkg/installed *in addition to* spkg/standard and spkg/optional?)



---

archive/issue_comments_164070.json:
```json
{
    "body": "Here's a proposed patch to be applied on top of yours.",
    "created_at": "2012-10-08T18:02:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164070",
    "user": "https://github.com/jhpalmieri"
}
```

Here's a proposed patch to be applied on top of yours.



---

archive/issue_comments_164071.json:
```json
{
    "body": "Attachment [trac_13574-part2.patch](tarball://root/attachments/some-uuid/ticket13574/trac_13574-part2.patch) by @jhpalmieri created at 2012-10-08 18:02:50",
    "created_at": "2012-10-08T18:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164071",
    "user": "https://github.com/jhpalmieri"
}
```

Attachment [trac_13574-part2.patch](tarball://root/attachments/some-uuid/ticket13574/trac_13574-part2.patch) by @jhpalmieri created at 2012-10-08 18:02:50



---

archive/issue_comments_164072.json:
```json
{
    "body": "I tested this with `sage --info gcc`, `sage --info chomp` (not having downloaded chomp yet), and `sage --info junk`. It seems to behave okay.",
    "created_at": "2012-10-08T18:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164072",
    "user": "https://github.com/jhpalmieri"
}
```

I tested this with `sage --info gcc`, `sage --info chomp` (not having downloaded chomp yet), and `sage --info junk`. It seems to behave okay.



---

archive/issue_comments_164073.json:
```json
{
    "body": "When getting the info on-line, the \"`| cat`\" in `sage-download-file \"$PKG_URL\" | cat` should not be necessary, but without it, the file is dumped to standard output in the middle of some brackets printed by sage-download-file. Should I instead do `sage-download-file \"$PKG_URL\" 2> /dev/null`? I don't want to lose important error messages.",
    "created_at": "2012-10-08T18:09:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164073",
    "user": "https://github.com/jhpalmieri"
}
```

When getting the info on-line, the "`| cat`" in `sage-download-file "$PKG_URL" | cat` should not be necessary, but without it, the file is dumped to standard output in the middle of some brackets printed by sage-download-file. Should I instead do `sage-download-file "$PKG_URL" 2> /dev/null`? I don't want to lose important error messages.



---

archive/issue_comments_164074.json:
```json
{
    "body": "Replying to [comment:5 jhpalmieri]:\n> When looking for the spkg in cases 2a or 3, why not look in spkg/installed instead of spkg/standard and spkg/optional?\nMainly, I simply didn't want to change the functionality of\n\n```\n./sage -f foo\n```\n\n\nIt's hard to tell which behaviour would be the most expected when doing\n\n```\n./sage -i mpir\n```\n\nin the case that mpir is already installed, but no local mpir package exists in `spkg/`.  Should it re-install the installed version or should it download the latest online version?\n\nIf you look in `installed/`, then\n\n```\n./sage -i mpir\n```\n\nis going to fail in a lot more cases (it needs to download the exact version, which might not be found).  So maybe I prefer to increase the chances of success, even if a different version might be installed.  That means, don't consider `installed/`.\n\nIn any case, `./sage -i` and `./sage -f` should be consistent, the version cannot depend on whether `-f` was given.",
    "created_at": "2012-10-08T20:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164074",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:5 jhpalmieri]:
> When looking for the spkg in cases 2a or 3, why not look in spkg/installed instead of spkg/standard and spkg/optional?
Mainly, I simply didn't want to change the functionality of

```
./sage -f foo
```


It's hard to tell which behaviour would be the most expected when doing

```
./sage -i mpir
```

in the case that mpir is already installed, but no local mpir package exists in `spkg/`.  Should it re-install the installed version or should it download the latest online version?

If you look in `installed/`, then

```
./sage -i mpir
```

is going to fail in a lot more cases (it needs to download the exact version, which might not be found).  So maybe I prefer to increase the chances of success, even if a different version might be installed.  That means, don't consider `installed/`.

In any case, `./sage -i` and `./sage -f` should be consistent, the version cannot depend on whether `-f` was given.



---

archive/issue_comments_164075.json:
```json
{
    "body": "Replying to [comment:9 jhpalmieri]:\n> When getting the info on-line, the \"`| cat`\" in `sage-download-file \"$PKG_URL\" | cat` should not be necessary, but without it, the file is dumped to standard output in the middle of some brackets printed by sage-download-file. Should I instead do `sage-download-file \"$PKG_URL\" 2> /dev/null`? I don't want to lose important error messages.\n\nThe `| cat` is a silly hack which just happens to work because of I/O buffers.  I would redirect `2>/dev/null`.  For `./sage --info`, I don't want to rely anyway on the existence of those `.txt` files.  In case downloading the txt file fails (and we don't see the error message), simply fall back to the old method of downloading the spkg and extracting `SPKG.txt`.",
    "created_at": "2012-10-09T08:04:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164075",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 jhpalmieri]:
> When getting the info on-line, the "`| cat`" in `sage-download-file "$PKG_URL" | cat` should not be necessary, but without it, the file is dumped to standard output in the middle of some brackets printed by sage-download-file. Should I instead do `sage-download-file "$PKG_URL" 2> /dev/null`? I don't want to lose important error messages.

The `| cat` is a silly hack which just happens to work because of I/O buffers.  I would redirect `2>/dev/null`.  For `./sage --info`, I don't want to rely anyway on the existence of those `.txt` files.  In case downloading the txt file fails (and we don't see the error message), simply fall back to the old method of downloading the spkg and extracting `SPKG.txt`.



---

archive/issue_comments_164076.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2012-10-23T07:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164076",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_164077.json:
```json
{
    "body": "needs work, but no priority since sage-5.4 should be done first.",
    "created_at": "2012-10-23T07:25:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164077",
    "user": "https://github.com/jdemeyer"
}
```

needs work, but no priority since sage-5.4 should be done first.



---

archive/issue_comments_164078.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2012-11-06T21:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164078",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_164079.json:
```json
{
    "body": "Attachment [13574_part2.patch](tarball://root/attachments/some-uuid/ticket13574/13574_part2.patch) by @jdemeyer created at 2012-11-06 21:08:52",
    "created_at": "2012-11-06T21:08:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164079",
    "user": "https://github.com/jdemeyer"
}
```

Attachment [13574_part2.patch](tarball://root/attachments/some-uuid/ticket13574/13574_part2.patch) by @jdemeyer created at 2012-11-06 21:08:52



---

archive/issue_comments_164080.json:
```json
{
    "body": "John, I removed the part of your patch which checks `installed` and simplified the downloading of the .txt file for `sage --info`.  Needs review.",
    "created_at": "2012-11-06T21:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164080",
    "user": "https://github.com/jdemeyer"
}
```

John, I removed the part of your patch which checks `installed` and simplified the downloading of the .txt file for `sage --info`.  Needs review.



---

archive/issue_comments_164081.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-11-07T20:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164081",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_164082.json:
```json
{
    "body": "Okay, this looks okay to me.",
    "created_at": "2012-11-07T20:49:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164082",
    "user": "https://github.com/jhpalmieri"
}
```

Okay, this looks okay to me.



---

archive/issue_comments_164083.json:
```json
{
    "body": "By the way, running `sage --info gcc` is faster on my machine if the spkg is *not* present: downloading the `SPKG.txt` file is quicker than untarring to extract the single file (about half a second vs. seven seconds). This is from my office at the university where I have a good internet connection, of course.\n\nIf we thought that lots of people were using `sage --info ...`, we should look for ways to speed up this operation. My guess is that it's not used very much, though, so we shouldn't worry about it.",
    "created_at": "2012-11-07T20:56:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164083",
    "user": "https://github.com/jhpalmieri"
}
```

By the way, running `sage --info gcc` is faster on my machine if the spkg is *not* present: downloading the `SPKG.txt` file is quicker than untarring to extract the single file (about half a second vs. seven seconds). This is from my office at the university where I have a good internet connection, of course.

If we thought that lots of people were using `sage --info ...`, we should look for ways to speed up this operation. My guess is that it's not used very much, though, so we shouldn't worry about it.



---

archive/issue_events_013254.json:
```json
{
    "actor": "@jdemeyer",
    "created_at": "2012-11-12T21:57:23Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/13370#event-13254"
}
```



---

archive/issue_comments_164084.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-11-12T21:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/13370",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/13370#issuecomment-164084",
    "user": "https://github.com/jdemeyer"
}
```

Resolution: fixed
