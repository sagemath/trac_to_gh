# Issue 33694: Deprecate sage.misc.viewer

Issue created by migration from https://trac.sagemath.org/ticket/33931

Original creator: jhpalmieri

Original creation time: 2022-05-29 00:49:15

CC:  slabbe

As part of #32957, let's deprecate `sage.misc.viewer` in favor of the Python library `webbrowser`.


---

Comment by jhpalmieri created at 2022-05-29 00:53:00

I tested this by running these commands in Sage from the command line and in the notebook:

```
C = graphs.CubeGraph(8)
C.plot(vertex_labels=False, vertex_size=0, graph_border=True).show()

view(4)
view(4, viewer='pdf')

from sage.misc.latex_standalone import Standalone
s = Standalone('hello world')
s.pdf()
s.png()
s.svg()  # fails on my machine: missing feature

browse_sage_doc._open('reference')
browse_sage_doc(identity_matrix)
```

I did this with the develop branch, with this branch, and with a more radical branch in which I completely deleted `sage.misc.viewer` and its entry in the reference manual. It looked like the same behavior in all of these cases. This was all on OS X, I encourage more testing on more platforms.
----
New commits:


---

Comment by jhpalmieri created at 2022-05-29 00:53:00

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2022-06-13 21:12:35

This is not working on an Ubuntu virtual machine. It tries to open every png and pdf in a web browser and produces a message like `File not found. Firefox can't find the file at //tmp/....`. Not sure why there are two slashes, but the file is there with the right name and the right contents.


---

Comment by git created at 2022-06-13 21:49:28

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-06-13 21:50:39

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2022-06-13 21:50:39

With these changes (trying PIL first, then a browser as a backup), some images work for me on Ubuntu, but PDF files still fail with the same error message. Suggestions?


---

Comment by slabbe created at 2022-06-23 10:15:32

Replying to [comment:2 jhpalmieri]:
> I tested this by running these commands in Sage from the command line and in the notebook:
> {{{
> C = graphs.CubeGraph(8)
> C.plot(vertex_labels=False, vertex_size=0, graph_border=True).show()
> 
> view(4)
> view(4, viewer='pdf')
> 
> from sage.misc.latex_standalone import Standalone
> s = Standalone('hello world')
> s.pdf()
> s.png()
> s.svg()  # fails on my machine: missing feature
> 
> browse_sage_doc._open('reference')
> browse_sage_doc(identity_matrix)
> }}}
> I did this with the develop branch, with this branch, and with a more radical branch in which I completely deleted `sage.misc.viewer` and its entry in the reference manual. It looked like the same behavior in all of these cases. This was all on OS X, I encourage more testing on more platforms.

On Ubuntu 20.04, all of the above work. The behavior of `s.pdf()`, `s.png()` and `s.svg()` changed as it now open in the browser at url like `file:////tmp/tmp0jvfbjec/tikz_u5t2ot7z.pdf`. It is fine with me.

Positive review from my side.


---

Comment by git created at 2022-08-17 22:55:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-08-17 22:55:22

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-08-17 22:55:22

Rebased to 9.7.beta8, ready for review.


---

Comment by slabbe created at 2022-08-24 18:11:21

Replying to [comment:5 jhpalmieri]:
> With these changes (trying PIL first, then a browser as a backup), some images work for me on Ubuntu, but PDF files still fail with the same error message. Suggestions?

Default webbrowser do not open pdf files. Maybe this is why?


---

Comment by jhpalmieri created at 2022-08-24 18:29:18

Replying to [comment:10 slabbe]:
> Replying to [comment:5 jhpalmieri]:
> > With these changes (trying PIL first, then a browser as a backup), some images work for me on Ubuntu, but PDF files still fail with the same error message. Suggestions?
> 
> Default webbrowser do not open pdf files. Maybe this is why?

What, are we still living in the 90s?


---

Comment by jhpalmieri created at 2022-08-24 18:32:56

Maybe we need to keep some of the old functionality for opening pdfs, or reimplement it using `Features`.


---

Comment by slabbe created at 2022-08-24 18:35:26

Replying to [comment:7 slabbe]:
> On Ubuntu 20.04, all of the above work. The behavior of `s.pdf()`, `s.png()` and `s.svg()` changed as it now open in the browser at url like `file:////tmp/tmp0jvfbjec/tikz_u5t2ot7z.pdf`. It is fine with me.
> Positive review from my side.

Looking at this ticket again, I don't think I am confident anymore to give a positive review. Deprecating `viewer` in favor of webbrowser changes a behavior in sage that exists since 15 years. In particular, on my Ubuntu, viewer is an equivalent for the more general `xdg-open`:


```
sage: from sage.misc.viewer import viewer
sage: viewer('pdf')
'xdg-open'
```


Also, the current state which exists for years allows the user to specify its preferated viewer:


```
sage: from sage.misc.viewer import viewer, _viewer_prefs
sage: viewer.pdf_viewer('evince')
sage: _viewer_prefs
{'pdf_viewer': 'evince'}
```


So, the current branch might be a step backward for many long time users which have old written code. Personnaly, I am afraid the current change will break something on a platform I am not familiar with like Windows or OS X, which I can't test.

Finally, is the motivation for the current branch only to get rid of `have_program`? If so, I would suggest to create a feature for `xdg-open` and use webbrowser in the lines where `firefox`, etc. is involved.


---

Comment by jhpalmieri created at 2022-08-24 18:39:09

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2022-08-24 21:30:07

(The motivation came from the brief discussion at #32957#comment:14.)


---

Comment by slabbe created at 2022-08-25 10:36:37

Replying to [comment:15 jhpalmieri]:
> (The motivation came from the brief discussion at #32957#comment:14.)

Ok, I remember now. Maybe we can start by replacing occurences of `have_program` by some usage of `webbrowser`.

Also, in the documentation of [webbrowser.open](https://docs.python.org/3/library/webbrowser.html#webbrowser.open), I see:

_"Note that on some platforms, trying to open a filename using this function, may work and start the operating systemâ€™s associated program. However, this is neither supported nor portable."_

However, I don't know if this comment refers to `r'file:///path/to/file'` or only `r'path/to/file'`.


---

Comment by git created at 2022-09-07 22:54:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2022-09-07 22:56:40

Here is a new version. This deprecates `viewer.py` and introduces `image_viewer.py`. A few differences between these: `image_viewer.py` only deals with images: web browsing is done through Python's `webbrowser` module. Also, `image_viewer.py` uses `Features` to detect the presence of `xdg-open` and similar.


---

Comment by jhpalmieri created at 2022-09-07 22:56:40

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2022-09-07 23:03:04

Questions and comments:

- I don't know a good way to test whether `open` (for example) is functional. While `xdg-open` and `cygstart` are pretty specific names, I can imagine someone installing an executable called `open` on their linux box which doesn't do anything what we expect here. If I actually call `open` to try to open a file, then if successful, it will start an app and open up a window, and that does not seem ideal. Right now there is no `is_functional` test for these new features.

- the change in `latex.py`

```diff
diff --git a/src/sage/misc/latex.py b/src/sage/misc/latex.py
index 3ec3a3e..5d9ebdb 100644
--- a/src/sage/misc/latex.py
+++ b/src/sage/misc/latex.py
@@ -1859,7 +1859,7 @@ def view(objects, title='Sage', debug=False, sep='', tiny=False,
         sage: with NamedTemporaryFile(mode="w+t", suffix=".tex") as f:  # optional - latex latex_package_tkz_graph
         ....:     _ = f.write(_latex_file_(g))
         ....:     f.flush()
-        ....:     _run_latex_(file, engine="pdflatex")
+        ....:     _run_latex_(f.name, engine="pdflatex")
         'pdf'
```

 is just fixing a bug: `file` is not defined, whereas `f.name` is the name of the temporary file being used in `with ... as f:`. I guess no one runs doctests using `latex` as an optional flag?


---

Comment by jhpalmieri created at 2022-09-07 23:04:26

I don't see a way to edit my comments. The first item in the previous comment perhaps should have ended with a question: suggestions for what to do?


---

Comment by git created at 2022-09-27 21:27:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-09-27 21:27:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2022-09-30 11:56:26

The current branch has a conflict with 9.8.beta1.


---

Comment by slabbe created at 2022-09-30 11:56:26

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-09-30 17:57:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2022-09-30 17:57:42

Merge conflict fixed.


---

Comment by jhpalmieri created at 2022-09-30 17:57:42

Changing status from needs_work to needs_review.
