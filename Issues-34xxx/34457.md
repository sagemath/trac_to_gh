# Issue 34457: #34062 may have introduce new problems with Mathematica handling of locals and some native functions

archive/issues_034220.json:
```json
{
    "body": "#34602 considerably enhanced the use of many Mathematica functions unknown to Sage :\n\n```\nsage: foo = mathematica(\"Hypergeometric2F1[a, b, c, d]\") ; foo\nHypergeometric2F1[a, b, c, d]\nsage: bar = foo.sage() ; bar\nHypergeometric2F1(a, b, c, d)\n```\n\nA new symbolic function was created on the fly, which can be substituted afterwards :\n\n```\nsage: bar.operator()\nHypergeometric2F1\nsage: bar.operator().parent()\n<class 'sage.symbolic.function_factory.function_factory.<locals>.NewSymbolicFunction'>\nsage: bar.substitute_function(bar.operator(), lambda *args:hypergeometric(args[:2], args[2:3], args[3]))\nhypergeometric((a, b), (c,), d)\n```\n\nor on the fly :\n\n```\nsage: foo.sage(locals={(\"Hypergeometric2F1\", 4): lambda a, b, c, d:hypergeometric([a, b], [c], d)})\nhypergeometric((a, b), (c,), d)\n```\n\nor\n\n```\nsage: foo.sage(locals={(\"Hypergeometric2F1\", 4): lambda *args:hypergeometric(args[:2], args[2:3], args[3])})\nhypergeometric((a, b), (c,), d)\n```\n\nNote that the docsting of the `._sage_` method doesn't specify much the composition of `locals`...\n\nBut there are snags : given \n\n```\nsage: gee = mathematica.Gamma(a) ; gee\nGamma[a]\n```\n\nnothing works as expected :\n\n```\nsage: gee.sage()\n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)\n    912 try:\n--> 913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n\nFile /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)\n   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()\n   2578                                           if _is_function(v)})\n-> 2579 return parse_func(s)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()\n    574 \n--> 575     cpdef parse_sequence(self, s):\n    576         \"\"\"\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()\n    590 cdef Tokenizer tokens = Tokenizer(s)\n--> 591 all = self.p_sequence(tokens)\n    592 if tokens.next() != EOS:\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()\n    663 else:\n--> 664     obj = self.p_eqn(tokens)\n    665 PyList_Append(all, obj)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()\n    753 \"\"\"\n--> 754 lhs = self.p_expr(tokens)\n    755 cdef int op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()\n    793 cdef int op\n--> 794 operand1 = self.p_term(tokens)\n    795 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()\n    827 cdef int op\n--> 828 operand1 = self.p_factor(tokens)\n    829 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()\n    870 tokens.backtrack()\n--> 871 return self.p_power(tokens)\n    872 \n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()\n    898 \"\"\"\n--> 899 operand1 = self.p_atom(tokens)\n    900 cdef int token = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()\n    957         self.parse_error(tokens, \"Bad function call\")\n--> 958     return func(*args, **kwds)\n    959 else:\n\nFile /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)\n    716 r\"\"\"\n    717 EXAMPLES::\n    718 \n   (...)\n    724     gamma(4/3) - gamma(4/3, 1)\n    725 \"\"\"\n--> 726 assert len(args) == 3\n    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])\n\nAssertionError: \n\nDuring handling of the above exception, another exception occurred:\n\nNotImplementedError                       Traceback (most recent call last)\nInput In [581], in <cell line: 1>()\n----> 1 gee.sage()\n\nFile /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)\n   1088 def sage(self, *args, **kwds):\n   1089     \"\"\"\n   1090     Attempt to return a Sage version of this object.\n   1091 \n   (...)\n   1105         [0 0]\n   1106     \"\"\"\n-> 1107     return self._sage_(*args, **kwds)\n\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)\n    913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n--> 916     raise NotImplementedError(\"Unable to parse Mathematica \\\n    917         output: %s\" % res)\n\nNotImplementedError: Unable to parse Mathematica                 output: Gamma(a)\n```\n\nThis shouldn't happen : `gamma` and it's Mathematica translation `Gamma` have been known to Sage at least since Rome foundation (732 BC)...\n\nNeither\n\n```\nsage: gee.sage(locals={\"Gamma\": gamma}) # Old style locals\n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)\n    912 try:\n--> 913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n\nFile /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)\n   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()\n   2578                                           if _is_function(v)})\n-> 2579 return parse_func(s)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()\n    574 \n--> 575     cpdef parse_sequence(self, s):\n    576         \"\"\"\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()\n    590 cdef Tokenizer tokens = Tokenizer(s)\n--> 591 all = self.p_sequence(tokens)\n    592 if tokens.next() != EOS:\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()\n    663 else:\n--> 664     obj = self.p_eqn(tokens)\n    665 PyList_Append(all, obj)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()\n    753 \"\"\"\n--> 754 lhs = self.p_expr(tokens)\n    755 cdef int op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()\n    793 cdef int op\n--> 794 operand1 = self.p_term(tokens)\n    795 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()\n    827 cdef int op\n--> 828 operand1 = self.p_factor(tokens)\n    829 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()\n    870 tokens.backtrack()\n--> 871 return self.p_power(tokens)\n    872 \n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()\n    898 \"\"\"\n--> 899 operand1 = self.p_atom(tokens)\n    900 cdef int token = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()\n    957         self.parse_error(tokens, \"Bad function call\")\n--> 958     return func(*args, **kwds)\n    959 else:\n\nFile /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)\n    716 r\"\"\"\n    717 EXAMPLES::\n    718 \n   (...)\n    724     gamma(4/3) - gamma(4/3, 1)\n    725 \"\"\"\n--> 726 assert len(args) == 3\n    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])\n\nAssertionError: \n\nDuring handling of the above exception, another exception occurred:\n\nNotImplementedError                       Traceback (most recent call last)\nInput In [585], in <cell line: 1>()\n----> 1 gee.sage(locals={\"Gamma\": gamma}) # Old style locals\n\nFile /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)\n   1088 def sage(self, *args, **kwds):\n   1089     \"\"\"\n   1090     Attempt to return a Sage version of this object.\n   1091 \n   (...)\n   1105         [0 0]\n   1106     \"\"\"\n-> 1107     return self._sage_(*args, **kwds)\n\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)\n    913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n--> 916     raise NotImplementedError(\"Unable to parse Mathematica \\\n    917         output: %s\" % res)\n\nNotImplementedError: Unable to parse Mathematica                 output: Gamma(a)\n```\n\nNor :\n\n```\nsage: gee.sage(locals={(\"Gamma\", 1): gamma}) # New style locals\n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)\n    912 try:\n--> 913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n\nFile /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)\n   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()\n   2578                                           if _is_function(v)})\n-> 2579 return parse_func(s)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()\n    574 \n--> 575     cpdef parse_sequence(self, s):\n    576         \"\"\"\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()\n    590 cdef Tokenizer tokens = Tokenizer(s)\n--> 591 all = self.p_sequence(tokens)\n    592 if tokens.next() != EOS:\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()\n    663 else:\n--> 664     obj = self.p_eqn(tokens)\n    665 PyList_Append(all, obj)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()\n    753 \"\"\"\n--> 754 lhs = self.p_expr(tokens)\n    755 cdef int op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()\n    793 cdef int op\n--> 794 operand1 = self.p_term(tokens)\n    795 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()\n    827 cdef int op\n--> 828 operand1 = self.p_factor(tokens)\n    829 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()\n    870 tokens.backtrack()\n--> 871 return self.p_power(tokens)\n    872 \n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()\n    898 \"\"\"\n--> 899 operand1 = self.p_atom(tokens)\n    900 cdef int token = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()\n    957         self.parse_error(tokens, \"Bad function call\")\n--> 958     return func(*args, **kwds)\n    959 else:\n\nFile /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)\n    716 r\"\"\"\n    717 EXAMPLES::\n    718 \n   (...)\n    724     gamma(4/3) - gamma(4/3, 1)\n    725 \"\"\"\n--> 726 assert len(args) == 3\n    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])\n\nAssertionError: \n\nDuring handling of the above exception, another exception occurred:\n\nNotImplementedError                       Traceback (most recent call last)\nInput In [587], in <cell line: 1>()\n----> 1 gee.sage(locals={(\"Gamma\", Integer(1)): gamma}) # New style locals\n\nFile /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)\n   1088 def sage(self, *args, **kwds):\n   1089     \"\"\"\n   1090     Attempt to return a Sage version of this object.\n   1091 \n   (...)\n   1105         [0 0]\n   1106     \"\"\"\n-> 1107     return self._sage_(*args, **kwds)\n\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)\n    913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n--> 916     raise NotImplementedError(\"Unable to parse Mathematica \\\n    917         output: %s\" % res)\n\nNotImplementedError: Unable to parse Mathematica                 output: Gamma(a)\n```\n\nwork.\n\nPriority set to `critical` since Sage stopped previously-known results.\n\n**CC:**  @fchapoton\n\n**Keywords:** mathematica symbol_table interface gamma\n\n**Branch:** [public/mathica_fixtry](https://github.com/sagemath/sagetrac-mirror/tree/public/mathica_fixtry)\n\n**Commit:** [29b0cee93fe6000150ac818c21e5c7ca367da6db](https://github.com/sagemath/sagetrac-mirror/commit/29b0cee93fe6000150ac818c21e5c7ca367da6db)\n\n**Status:** new\n\nIssue created by migration from https://trac.sagemath.org/ticket/34457\n\n",
    "created_at": "2022-08-30T13:44:27Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "#34062 may have introduce new problems with Mathematica handling of locals and some native functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34457",
    "user": "https://github.com/EmmanuelCharpentier"
}
```
#34602 considerably enhanced the use of many Mathematica functions unknown to Sage :

```
sage: foo = mathematica("Hypergeometric2F1[a, b, c, d]") ; foo
Hypergeometric2F1[a, b, c, d]
sage: bar = foo.sage() ; bar
Hypergeometric2F1(a, b, c, d)
```

A new symbolic function was created on the fly, which can be substituted afterwards :

```
sage: bar.operator()
Hypergeometric2F1
sage: bar.operator().parent()
<class 'sage.symbolic.function_factory.function_factory.<locals>.NewSymbolicFunction'>
sage: bar.substitute_function(bar.operator(), lambda *args:hypergeometric(args[:2], args[2:3], args[3]))
hypergeometric((a, b), (c,), d)
```

or on the fly :

```
sage: foo.sage(locals={("Hypergeometric2F1", 4): lambda a, b, c, d:hypergeometric([a, b], [c], d)})
hypergeometric((a, b), (c,), d)
```

or

```
sage: foo.sage(locals={("Hypergeometric2F1", 4): lambda *args:hypergeometric(args[:2], args[2:3], args[3])})
hypergeometric((a, b), (c,), d)
```

Note that the docsting of the `._sage_` method doesn't specify much the composition of `locals`...

But there are snags : given 

```
sage: gee = mathematica.Gamma(a) ; gee
Gamma[a]
```

nothing works as expected :

```
sage: gee.sage()
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
File /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)
    912 try:
--> 913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:

File /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)
   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()
   2578                                           if _is_function(v)})
-> 2579 return parse_func(s)

File /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()
    574 
--> 575     cpdef parse_sequence(self, s):
    576         """

File /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()
    590 cdef Tokenizer tokens = Tokenizer(s)
--> 591 all = self.p_sequence(tokens)
    592 if tokens.next() != EOS:

File /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()
    663 else:
--> 664     obj = self.p_eqn(tokens)
    665 PyList_Append(all, obj)

File /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()
    753 """
--> 754 lhs = self.p_expr(tokens)
    755 cdef int op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()
    793 cdef int op
--> 794 operand1 = self.p_term(tokens)
    795 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()
    827 cdef int op
--> 828 operand1 = self.p_factor(tokens)
    829 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()
    870 tokens.backtrack()
--> 871 return self.p_power(tokens)
    872 

File /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()
    898 """
--> 899 operand1 = self.p_atom(tokens)
    900 cdef int token = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()
    957         self.parse_error(tokens, "Bad function call")
--> 958     return func(*args, **kwds)
    959 else:

File /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)
    716 r"""
    717 EXAMPLES::
    718 
   (...)
    724     gamma(4/3) - gamma(4/3, 1)
    725 """
--> 726 assert len(args) == 3
    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])

AssertionError: 

During handling of the above exception, another exception occurred:

NotImplementedError                       Traceback (most recent call last)
Input In [581], in <cell line: 1>()
----> 1 gee.sage()

File /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)
   1088 def sage(self, *args, **kwds):
   1089     """
   1090     Attempt to return a Sage version of this object.
   1091 
   (...)
   1105         [0 0]
   1106     """
-> 1107     return self._sage_(*args, **kwds)

File /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)
    913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:
--> 916     raise NotImplementedError("Unable to parse Mathematica \
    917         output: %s" % res)

NotImplementedError: Unable to parse Mathematica                 output: Gamma(a)
```

This shouldn't happen : `gamma` and it's Mathematica translation `Gamma` have been known to Sage at least since Rome foundation (732 BC)...

Neither

```
sage: gee.sage(locals={"Gamma": gamma}) # Old style locals
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
File /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)
    912 try:
--> 913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:

File /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)
   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()
   2578                                           if _is_function(v)})
-> 2579 return parse_func(s)

File /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()
    574 
--> 575     cpdef parse_sequence(self, s):
    576         """

File /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()
    590 cdef Tokenizer tokens = Tokenizer(s)
--> 591 all = self.p_sequence(tokens)
    592 if tokens.next() != EOS:

File /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()
    663 else:
--> 664     obj = self.p_eqn(tokens)
    665 PyList_Append(all, obj)

File /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()
    753 """
--> 754 lhs = self.p_expr(tokens)
    755 cdef int op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()
    793 cdef int op
--> 794 operand1 = self.p_term(tokens)
    795 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()
    827 cdef int op
--> 828 operand1 = self.p_factor(tokens)
    829 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()
    870 tokens.backtrack()
--> 871 return self.p_power(tokens)
    872 

File /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()
    898 """
--> 899 operand1 = self.p_atom(tokens)
    900 cdef int token = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()
    957         self.parse_error(tokens, "Bad function call")
--> 958     return func(*args, **kwds)
    959 else:

File /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)
    716 r"""
    717 EXAMPLES::
    718 
   (...)
    724     gamma(4/3) - gamma(4/3, 1)
    725 """
--> 726 assert len(args) == 3
    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])

AssertionError: 

During handling of the above exception, another exception occurred:

NotImplementedError                       Traceback (most recent call last)
Input In [585], in <cell line: 1>()
----> 1 gee.sage(locals={"Gamma": gamma}) # Old style locals

File /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)
   1088 def sage(self, *args, **kwds):
   1089     """
   1090     Attempt to return a Sage version of this object.
   1091 
   (...)
   1105         [0 0]
   1106     """
-> 1107     return self._sage_(*args, **kwds)

File /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)
    913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:
--> 916     raise NotImplementedError("Unable to parse Mathematica \
    917         output: %s" % res)

NotImplementedError: Unable to parse Mathematica                 output: Gamma(a)
```

Nor :

```
sage: gee.sage(locals={("Gamma", 1): gamma}) # New style locals
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
File /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)
    912 try:
--> 913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:

File /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)
   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()
   2578                                           if _is_function(v)})
-> 2579 return parse_func(s)

File /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()
    574 
--> 575     cpdef parse_sequence(self, s):
    576         """

File /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()
    590 cdef Tokenizer tokens = Tokenizer(s)
--> 591 all = self.p_sequence(tokens)
    592 if tokens.next() != EOS:

File /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()
    663 else:
--> 664     obj = self.p_eqn(tokens)
    665 PyList_Append(all, obj)

File /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()
    753 """
--> 754 lhs = self.p_expr(tokens)
    755 cdef int op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()
    793 cdef int op
--> 794 operand1 = self.p_term(tokens)
    795 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()
    827 cdef int op
--> 828 operand1 = self.p_factor(tokens)
    829 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()
    870 tokens.backtrack()
--> 871 return self.p_power(tokens)
    872 

File /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()
    898 """
--> 899 operand1 = self.p_atom(tokens)
    900 cdef int token = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()
    957         self.parse_error(tokens, "Bad function call")
--> 958     return func(*args, **kwds)
    959 else:

File /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)
    716 r"""
    717 EXAMPLES::
    718 
   (...)
    724     gamma(4/3) - gamma(4/3, 1)
    725 """
--> 726 assert len(args) == 3
    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])

AssertionError: 

During handling of the above exception, another exception occurred:

NotImplementedError                       Traceback (most recent call last)
Input In [587], in <cell line: 1>()
----> 1 gee.sage(locals={("Gamma", Integer(1)): gamma}) # New style locals

File /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)
   1088 def sage(self, *args, **kwds):
   1089     """
   1090     Attempt to return a Sage version of this object.
   1091 
   (...)
   1105         [0 0]
   1106     """
-> 1107     return self._sage_(*args, **kwds)

File /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)
    913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:
--> 916     raise NotImplementedError("Unable to parse Mathematica \
    917         output: %s" % res)

NotImplementedError: Unable to parse Mathematica                 output: Gamma(a)
```

work.

Priority set to `critical` since Sage stopped previously-known results.

**CC:**  @fchapoton

**Keywords:** mathematica symbol_table interface gamma

**Branch:** [public/mathica_fixtry](https://github.com/sagemath/sagetrac-mirror/tree/public/mathica_fixtry)

**Commit:** [29b0cee93fe6000150ac818c21e5c7ca367da6db](https://github.com/sagemath/sagetrac-mirror/commit/29b0cee93fe6000150ac818c21e5c7ca367da6db)

**Status:** new

Issue created by migration from https://trac.sagemath.org/ticket/34457





---

archive/issue_comments_685844.json:
```json
{
    "body": "**Changing keywords** from \"mathematica symbol_table interface\" to \"mathematica symbol_table interface gamma\".",
    "created_at": "2022-08-30T15:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685844",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

**Changing keywords** from "mathematica symbol_table interface" to "mathematica symbol_table interface gamma".



---

archive/issue_comments_685845.json:
```json
{
    "body": "<a id='comment:1'></a>\nIn all failures reported above, the error is triggered on the `assert len(args) == 3` error. This my be an error specific to `gamma`.\n\nSome specific, systematic testing may be in order...",
    "created_at": "2022-08-30T15:28:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685845",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:1'></a>
In all failures reported above, the error is triggered on the `assert len(args) == 3` error. This my be an error specific to `gamma`.

Some specific, systematic testing may be in order...



---

archive/issue_comments_685846.json:
```json
{
    "body": "<a id='comment:2'></a>\nJe peux pas faire grand chose sans avoir acces a **m....ca**\n\nVoici une branche avec une tentative \u00e0 l'aveugle.\n\nNot critical, as this concerns an optional interface.\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/29b0cee93fe6000150ac818c21e5c7ca367da6db\">29b0cee</a></td><td><code>mathematica interface</code></td></tr></table>\n",
    "created_at": "2022-08-30T15:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685846",
    "user": "https://github.com/fchapoton"
}
```

<a id='comment:2'></a>
Je peux pas faire grand chose sans avoir acces a **m....ca**

Voici une branche avec une tentative à l'aveugle.

Not critical, as this concerns an optional interface.

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/29b0cee93fe6000150ac818c21e5c7ca367da6db">29b0cee</a></td><td><code>mathematica interface</code></td></tr></table>




---

archive/issue_comments_685847.json:
```json
{
    "body": "**Commit:** [29b0cee93fe6000150ac818c21e5c7ca367da6db](https://github.com/sagemath/sagetrac-mirror/commit/29b0cee93fe6000150ac818c21e5c7ca367da6db)",
    "created_at": "2022-08-30T15:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685847",
    "user": "https://github.com/fchapoton"
}
```

**Commit:** [29b0cee93fe6000150ac818c21e5c7ca367da6db](https://github.com/sagemath/sagetrac-mirror/commit/29b0cee93fe6000150ac818c21e5c7ca367da6db)



---

archive/issue_comments_685848.json:
```json
{
    "body": "**Branch:** [public/mathica_fixtry](https://github.com/sagemath/sagetrac-mirror/tree/public/mathica_fixtry)",
    "created_at": "2022-08-30T15:46:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685848",
    "user": "https://github.com/fchapoton"
}
```

**Branch:** [public/mathica_fixtry](https://github.com/sagemath/sagetrac-mirror/tree/public/mathica_fixtry)



---

archive/issue_comments_685849.json:
```json
{
    "body": "<a id='comment:3'></a>\nReplying to [chapoton](#comment%3A2):\n> Je peux pas faire grand chose sans avoir acces a **m....ca**\n\n\nSelon `print(mathematica._install_hints())` :\n\n  (1) You might have to buy Mathematica (https://www.wolfram.com/), **or\n  install a currently (Feb 2022) free for personal use Wolfram Engine\n  (https://www.wolfram.com/engine/).**\n\nJ'ai test\u00e9 (installation secondaire de Sage dans une machine virtuelle tournant \"Doze, n\u00e9cessaire dans les mines de sel administratives...). \u00c7\u00e0 marche, et \u00e7\u00e0 semble remarquablement peu intrusif.\n\n \n> Voici une branche avec une tentative \u00e0 l'aveugle.\n\n\nJe regarde \u00e7\u00e0 d'ici 2 heures...\n\n> Not critical, as this concerns an optional interface.\n\n\nHmmm... `mathematica.py` fait partie du corps de Sage (pas m\u00eame un module standard), et interface \u00e0 un logiciel (trop) connu et d\u00e9sormais gratis (mais loin d'\u00eatre libre...) ==> risque de devenir une part *de facto* standard d'une installation \"par d\u00e9faut\".",
    "created_at": "2022-08-30T16:20:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685849",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:3'></a>
Replying to [chapoton](#comment%3A2):
> Je peux pas faire grand chose sans avoir acces a **m....ca**


Selon `print(mathematica._install_hints())` :

  (1) You might have to buy Mathematica (https://www.wolfram.com/), **or
  install a currently (Feb 2022) free for personal use Wolfram Engine
  (https://www.wolfram.com/engine/).**

J'ai testé (installation secondaire de Sage dans une machine virtuelle tournant "Doze, nécessaire dans les mines de sel administratives...). Çà marche, et çà semble remarquablement peu intrusif.

 
> Voici une branche avec une tentative à l'aveugle.


Je regarde çà d'ici 2 heures...

> Not critical, as this concerns an optional interface.


Hmmm... `mathematica.py` fait partie du corps de Sage (pas même un module standard), et interface à un logiciel (trop) connu et désormais gratis (mais loin d'être libre...) ==> risque de devenir une part *de facto* standard d'une installation "par défaut".



---

archive/issue_comments_685850.json:
```json
{
    "body": "<a id='comment:4'></a>\nReplying to [chapoton](#comment%3A2):\n> Je peux pas faire grand chose sans avoir acces a **m....ca**\n> \n> Voici une branche avec une tentative \u00e0 l'aveugle.\n\n\nNope. On top of 9.7.beta0 :\n\n```\nsage: mathematica.Gamma(x).sage()\n---------------------------------------------------------------------------\nAssertionError                            Traceback (most recent call last)\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)\n    912 try:\n--> 913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n\nFile /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)\n   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()\n   2578                                           if _is_function(v)})\n-> 2579 return parse_func(s)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()\n    574 \n--> 575     cpdef parse_sequence(self, s):\n    576         \"\"\"\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()\n    590 cdef Tokenizer tokens = Tokenizer(s)\n--> 591 all = self.p_sequence(tokens)\n    592 if tokens.next() != EOS:\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()\n    663 else:\n--> 664     obj = self.p_eqn(tokens)\n    665 PyList_Append(all, obj)\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()\n    753 \"\"\"\n--> 754 lhs = self.p_expr(tokens)\n    755 cdef int op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()\n    793 cdef int op\n--> 794 operand1 = self.p_term(tokens)\n    795 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()\n    827 cdef int op\n--> 828 operand1 = self.p_factor(tokens)\n    829 op = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()\n    870 tokens.backtrack()\n--> 871 return self.p_power(tokens)\n    872 \n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()\n    898 \"\"\"\n--> 899 operand1 = self.p_atom(tokens)\n    900 cdef int token = tokens.next()\n\nFile /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()\n    957         self.parse_error(tokens, \"Bad function call\")\n--> 958     return func(*args, **kwds)\n    959 else:\n\nFile /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)\n    716 r\"\"\"\n    717 EXAMPLES::\n    718 \n   (...)\n    724     gamma(4/3) - gamma(4/3, 1)\n    725 \"\"\"\n--> 726 assert len(args) == 3\n    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])\n\nAssertionError: \n\nDuring handling of the above exception, another exception occurred:\n\nNotImplementedError                       Traceback (most recent call last)\nInput In [5], in <cell line: 1>()\n----> 1 mathematica.Gamma(x).sage()\n\nFile /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)\n   1088 def sage(self, *args, **kwds):\n   1089     \"\"\"\n   1090     Attempt to return a Sage version of this object.\n   1091 \n   (...)\n   1105         [0 0]\n   1106     \"\"\"\n-> 1107     return self._sage_(*args, **kwds)\n\nFile /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)\n    913     return symbolic_expression_from_string(res, lsymbols,\n    914         accept_sequence=True)\n    915 except Exception:\n--> 916     raise NotImplementedError(\"Unable to parse Mathematica \\\n    917         output: %s\" % res)\n\nNotImplementedError: Unable to parse Mathematica                 output: Gamma(x)\n\n```\n\nAgain, the initial stumble is in `_mathematica_gamma3`...\n\nSame results (not shown) with :\n- `mathematica.Gamma(x).sage(locals={(\"Gamma\", 1):lambda u:gamma(u)})`\n- `mathematica.Gamma(x).sage(locals={\"Gamma\":gamma})`\n- `mathematica.Gamma(x).sage(locals={\"Gamma\":lambda *args:gamma(*args)})`\n\nOn the other hand :\n\n```\nsage: mathematica.Sqrt(x).sage()\nsqrt(x)\nsage: type(mathematica.Sqrt(x).sage().operator())\n<class 'builtin_function_or_method'>\nsage: mathematica.Sin(x).sage()\nsin(x)\nsage: type(mathematica.Sin(x).sage().operator())\n<class 'sage.functions.trig.Function_sin'>\n```\n\nThis looks more and more as a `gamma`-specific problem. Any ideas for a systematic, exhaustive test set ?",
    "created_at": "2022-08-31T15:49:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34457#issuecomment-685850",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

<a id='comment:4'></a>
Replying to [chapoton](#comment%3A2):
> Je peux pas faire grand chose sans avoir acces a **m....ca**
> 
> Voici une branche avec une tentative à l'aveugle.


Nope. On top of 9.7.beta0 :

```
sage: mathematica.Gamma(x).sage()
---------------------------------------------------------------------------
AssertionError                            Traceback (most recent call last)
File /usr/local/sage-9/src/sage/interfaces/mathematica.py:913, in MathematicaElement._sage_(self, locals)
    912 try:
--> 913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:

File /usr/local/sage-9/src/sage/calculus/calculus.py:2579, in symbolic_expression_from_string(s, syms, accept_sequence, parser)
   2577 parser._callable_constructor().set_names({k[0]: v for k, v in syms.items()
   2578                                           if _is_function(v)})
-> 2579 return parse_func(s)

File /usr/local/sage-9/src/sage/misc/parser.pyx:575, in sage.misc.parser.Parser.parse_sequence()
    574 
--> 575     cpdef parse_sequence(self, s):
    576         """

File /usr/local/sage-9/src/sage/misc/parser.pyx:591, in sage.misc.parser.Parser.parse_sequence()
    590 cdef Tokenizer tokens = Tokenizer(s)
--> 591 all = self.p_sequence(tokens)
    592 if tokens.next() != EOS:

File /usr/local/sage-9/src/sage/misc/parser.pyx:664, in sage.misc.parser.Parser.p_sequence()
    663 else:
--> 664     obj = self.p_eqn(tokens)
    665 PyList_Append(all, obj)

File /usr/local/sage-9/src/sage/misc/parser.pyx:754, in sage.misc.parser.Parser.p_eqn()
    753 """
--> 754 lhs = self.p_expr(tokens)
    755 cdef int op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:794, in sage.misc.parser.Parser.p_expr()
    793 cdef int op
--> 794 operand1 = self.p_term(tokens)
    795 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:828, in sage.misc.parser.Parser.p_term()
    827 cdef int op
--> 828 operand1 = self.p_factor(tokens)
    829 op = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:871, in sage.misc.parser.Parser.p_factor()
    870 tokens.backtrack()
--> 871 return self.p_power(tokens)
    872 

File /usr/local/sage-9/src/sage/misc/parser.pyx:899, in sage.misc.parser.Parser.p_power()
    898 """
--> 899 operand1 = self.p_atom(tokens)
    900 cdef int token = tokens.next()

File /usr/local/sage-9/src/sage/misc/parser.pyx:958, in sage.misc.parser.Parser.p_atom()
    957         self.parse_error(tokens, "Bad function call")
--> 958     return func(*args, **kwds)
    959 else:

File /usr/local/sage-9/src/sage/functions/gamma.py:726, in _mathematica_gamma3(*args)
    716 r"""
    717 EXAMPLES::
    718 
   (...)
    724     gamma(4/3) - gamma(4/3, 1)
    725 """
--> 726 assert len(args) == 3
    727 return gamma_inc(args[0], args[1]) - gamma_inc(args[0], args[2])

AssertionError: 

During handling of the above exception, another exception occurred:

NotImplementedError                       Traceback (most recent call last)
Input In [5], in <cell line: 1>()
----> 1 mathematica.Gamma(x).sage()

File /usr/local/sage-9/src/sage/interfaces/interface.py:1107, in InterfaceElement.sage(self, *args, **kwds)
   1088 def sage(self, *args, **kwds):
   1089     """
   1090     Attempt to return a Sage version of this object.
   1091 
   (...)
   1105         [0 0]
   1106     """
-> 1107     return self._sage_(*args, **kwds)

File /usr/local/sage-9/src/sage/interfaces/mathematica.py:916, in MathematicaElement._sage_(self, locals)
    913     return symbolic_expression_from_string(res, lsymbols,
    914         accept_sequence=True)
    915 except Exception:
--> 916     raise NotImplementedError("Unable to parse Mathematica \
    917         output: %s" % res)

NotImplementedError: Unable to parse Mathematica                 output: Gamma(x)

```

Again, the initial stumble is in `_mathematica_gamma3`...

Same results (not shown) with :
- `mathematica.Gamma(x).sage(locals={("Gamma", 1):lambda u:gamma(u)})`
- `mathematica.Gamma(x).sage(locals={"Gamma":gamma})`
- `mathematica.Gamma(x).sage(locals={"Gamma":lambda *args:gamma(*args)})`

On the other hand :

```
sage: mathematica.Sqrt(x).sage()
sqrt(x)
sage: type(mathematica.Sqrt(x).sage().operator())
<class 'builtin_function_or_method'>
sage: mathematica.Sin(x).sage()
sin(x)
sage: type(mathematica.Sin(x).sage().operator())
<class 'sage.functions.trig.Function_sin'>
```

This looks more and more as a `gamma`-specific problem. Any ideas for a systematic, exhaustive test set ?



---

archive/issue_events_100864.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/34457",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34457#event-100864"
}
```
