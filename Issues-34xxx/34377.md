# Issue 34377: Improvements to ImageSet

archive/issues_034140.json:
```json
{
    "body": "(split out from #34340)\n\nWe equip `ImageSet` with an `_element_constructor_` and hence, with a membership test. (This needs a map with inverse.)\n\nWe also add a new parameter value `is_injective='check'`.\n\nCC:  @tscrim\n\nBranch/Commit: 6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed\n\nReviewer: Travis Scrimshaw\n\nAuthor: Matthias Koeppe\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34377\n\n",
    "closed_at": "2022-08-30T19:05:12Z",
    "created_at": "2022-08-16T21:30:07Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Improvements to ImageSet",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34377",
    "user": "https://github.com/mkoeppe"
}
```
(split out from #34340)

We equip `ImageSet` with an `_element_constructor_` and hence, with a membership test. (This needs a map with inverse.)

We also add a new parameter value `is_injective='check'`.

CC:  @tscrim

Branch/Commit: 6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed

Reviewer: Travis Scrimshaw

Author: Matthias Koeppe

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34377





---

archive/issue_comments_483744.json:
```json
{
    "body": "<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-16T21:37:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483744",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:2'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483745.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-16T21:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483745",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_483746.json:
```json
{
    "body": "<a id='comment:4'></a>I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise). Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\nThere is also an infinite recursion that seems to be happening:\n\n```\nsrc/sage/categories/sets_cat.py  # 1 doctest failed\n```\n\nAlso, calling `len(list(self))` might run for forever if `self` is infinite. I think `list(self)` also does a `__len__` check too. This is also probably related to the infinite recursion above.",
    "created_at": "2022-08-17T01:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483746",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:4'></a>I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise). Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

There is also an infinite recursion that seems to be happening:

```
src/sage/categories/sets_cat.py  # 1 doctest failed
```

Also, calling `len(list(self))` might run for forever if `self` is infinite. I think `list(self)` also does a `__len__` check too. This is also probably related to the infinite recursion above.



---

archive/issue_comments_483747.json:
```json
{
    "body": "<a id='comment:5'></a>Replying to [comment:4 tscrim]:\n> I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise).\n\n\nYes, I think that's a good idea\n\n> Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\n\nMapping back is necessary to get an element that is in the correct parent.\nThe comparison is just a safety check there.",
    "created_at": "2022-08-17T01:44:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483747",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Replying to [comment:4 tscrim]:
> I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise).


Yes, I think that's a good idea

> Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.


Mapping back is necessary to get an element that is in the correct parent.
The comparison is just a safety check there.



---

archive/issue_comments_483748.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 mkoeppe]:\n> Replying to [comment:4 tscrim]:\n> > Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\n> \n> Mapping back is necessary to get an element that is in the correct parent.\n> The comparison is just a safety check there.\n\n\nCouldn't we just do `self.codomain()(x)` for this?",
    "created_at": "2022-08-17T01:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483748",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:6'></a>Replying to [comment:5 mkoeppe]:
> Replying to [comment:4 tscrim]:
> > Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

> 
> Mapping back is necessary to get an element that is in the correct parent.
> The comparison is just a safety check there.


Couldn't we just do `self.codomain()(x)` for this?



---

archive/issue_comments_483749.json:
```json
{
    "body": "<a id='comment:7'></a>If it's an honest `Map`, yes, but this is supposed to work also for `PoorManMap`",
    "created_at": "2022-08-17T01:48:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483749",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>If it's an honest `Map`, yes, but this is supposed to work also for `PoorManMap`



---

archive/issue_comments_483750.json:
```json
{
    "body": "<a id='comment:8'></a>Ah, right. Thanks.",
    "created_at": "2022-08-17T01:48:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483750",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:8'></a>Ah, right. Thanks.



---

archive/issue_comments_483751.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-17T02:44:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483751",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483752.json:
```json
{
    "body": "<a id='comment:10'></a>Bots are green now",
    "created_at": "2022-08-17T15:11:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483752",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Bots are green now



---

archive/issue_comments_483753.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-08-17T15:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_483754.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-20T05:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483754",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_483755.json:
```json
{
    "body": "<a id='comment:12'></a>LGTM.",
    "created_at": "2022-08-20T05:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483755",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>LGTM.



---

archive/issue_comments_483756.json:
```json
{
    "body": "<a id='comment:13'></a>Thanks.",
    "created_at": "2022-08-20T05:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483756",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Thanks.



---

archive/issue_events_089444.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-08-30T19:05:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34377#event-89444"
}
```



---

archive/issue_comments_483757.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-30T19:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34377#issuecomment-483757",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
