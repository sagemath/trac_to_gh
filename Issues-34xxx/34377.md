# Issue 34377: Improvements to ImageSet

archive/issues_034140.json:
```json
{
    "assignees": [],
    "body": "(split out from #34340)\n\nWe equip `ImageSet` with an `_element_constructor_` and hence, with a membership test. (This needs a map with inverse.)\n\nWe also add a new parameter value `is_injective='check'`.\n\nCC:  @tscrim\n\nBranch/Commit: **[`6aeab7d`](https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed)**\n\nReviewer: **Travis Scrimshaw**\n\nAuthor: **Matthias Koeppe**\n\nComponent: **combinatorics**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34377_\n\n",
    "closed_at": "2022-08-30T19:05:12Z",
    "created_at": "2022-08-16T21:30:07Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.7",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Improvements to ImageSet",
    "type": "issue",
    "updated_at": "2022-08-30T19:05:12Z",
    "url": "https://github.com/sagemath/sage/issues/34377",
    "user": "https://github.com/mkoeppe"
}
```
(split out from #34340)

We equip `ImageSet` with an `_element_constructor_` and hence, with a membership test. (This needs a map with inverse.)

We also add a new parameter value `is_injective='check'`.

CC:  @tscrim

Branch/Commit: **[`6aeab7d`](https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed)**

Reviewer: **Travis Scrimshaw**

Author: **Matthias Koeppe**

Component: **combinatorics**

_Issue created by migration from https://trac.sagemath.org/ticket/34377_





---

archive/issue_events_471963.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-16T21:30:07Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471963"
}
```



---

archive/issue_events_471964.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-16T21:30:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20combinatorics",
    "label_color": "0000ff",
    "label_name": "c: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471964"
}
```



---

archive/issue_events_471965.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-16T21:30:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471965"
}
```



---

archive/issue_events_471966.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-16T21:30:07Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "696969",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471966"
}
```



---

archive/issue_comments_555059.json:
```json
{
    "body": "Branch: **[u/mkoeppe/improvements_to_imageset](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improvements_to_imageset)**",
    "created_at": "2022-08-16T21:33:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555059",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/improvements_to_imageset](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improvements_to_imageset)**



---

archive/issue_comments_555060.json:
```json
{
    "body": "Commit: **[`52f6ca6`](https://github.com/sagemath/sagetrac-mirror/commit/52f6ca6ca8ed4655442bf24d8918d7b721a900d1)**",
    "created_at": "2022-08-16T21:37:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555060",
    "user": "https://github.com/sagetrac-git"
}
```

Commit: **[`52f6ca6`](https://github.com/sagemath/sagetrac-mirror/commit/52f6ca6ca8ed4655442bf24d8918d7b721a900d1)**



---

archive/issue_comments_555061.json:
```json
{
    "body": "<div id=\"comment:2\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/52f6ca6ca8ed4655442bf24d8918d7b721a900d1\"><code>52f6ca6</code></a></td><td><code>src/sage/sets/image_set.py: Improve example</code></td></tr></table>\n",
    "created_at": "2022-08-16T21:37:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555061",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:2"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/52f6ca6ca8ed4655442bf24d8918d7b721a900d1"><code>52f6ca6</code></a></td><td><code>src/sage/sets/image_set.py: Improve example</code></td></tr></table>




---

archive/issue_comments_555062.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,2 +1,5 @@\n (split out from #34340)\n \n+We equip `ImageSet` with an `_element_constructor_` and hence, with a membership test. (This needs a map with inverse.)\n+\n+We also add a new parameter value `is_injective='check'`.\n``````\n",
    "created_at": "2022-08-16T21:41:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555062",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,2 +1,5 @@
 (split out from #34340)
 
+We equip `ImageSet` with an `_element_constructor_` and hence, with a membership test. (This needs a map with inverse.)
+
+We also add a new parameter value `is_injective='check'`.
``````




---

archive/issue_events_471967.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-08-16T21:41:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471967"
}
```



---

archive/issue_comments_555063.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nI think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise). Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\nThere is also an infinite recursion that seems to be happening:\n\n```\nsrc/sage/categories/sets_cat.py  # 1 doctest failed\n```\n\nAlso, calling `len(list(self))` might run for forever if `self` is infinite. I think `list(self)` also does a `__len__` check too. This is also probably related to the infinite recursion above.",
    "created_at": "2022-08-17T01:38:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555063",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:4" align="right">comment:4</div>

I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise). Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

There is also an infinite recursion that seems to be happening:

```
src/sage/categories/sets_cat.py  # 1 doctest failed
```

Also, calling `len(list(self))` might run for forever if `self` is infinite. I think `list(self)` also does a `__len__` check too. This is also probably related to the infinite recursion above.



---

archive/issue_comments_555064.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nReplying to [@tscrim](#comment:4):\n> I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise).\n\nYes, I think that's a good idea\n\n> Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\nMapping back is necessary to get an element that is in the correct parent.\nThe comparison is just a safety check there.",
    "created_at": "2022-08-17T01:44:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555064",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:5" align="right">comment:5</div>

Replying to [@tscrim](#comment:4):
> I think you should `try`-`except` the call to `self._inverse(x)` as that could fail in many different ways (with the actual error getting lost in the noise).

Yes, I think that's a good idea

> Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

Mapping back is necessary to get an element that is in the correct parent.
The comparison is just a safety check there.



---

archive/issue_comments_555065.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nReplying to [@mkoeppe](#comment:5):\n> Replying to [@tscrim](#comment:4):\n> > Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.\n\n> \n> Mapping back is necessary to get an element that is in the correct parent.\n> The comparison is just a safety check there.\n\nCouldn't we just do `self.codomain()(x)` for this?",
    "created_at": "2022-08-17T01:46:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555065",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:6" align="right">comment:6</div>

Replying to [@mkoeppe](#comment:5):
> Replying to [@tscrim](#comment:4):
> > Subsequently, I am not sure of the utility of verifying that it is an inverse versus trusting the user did give an honest inverse.

> 
> Mapping back is necessary to get an element that is in the correct parent.
> The comparison is just a safety check there.

Couldn't we just do `self.codomain()(x)` for this?



---

archive/issue_comments_555066.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nIf it's an honest `Map`, yes, but this is supposed to work also for `PoorManMap`",
    "created_at": "2022-08-17T01:48:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555066",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:7" align="right">comment:7</div>

If it's an honest `Map`, yes, but this is supposed to work also for `PoorManMap`



---

archive/issue_comments_555067.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAh, right. Thanks.",
    "created_at": "2022-08-17T01:48:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555067",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:8" align="right">comment:8</div>

Ah, right. Thanks.



---

archive/issue_comments_555068.json:
```json
{
    "body": "<div id=\"comment:9\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/9e8d0234ce66ca99ad7350a9b9d8bab093923319\"><code>9e8d023</code></a></td><td><code>ImageSubobject.cardinality: Handle infinite cardinalities explicitly</code></td></tr></table>\n",
    "created_at": "2022-08-17T02:44:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555068",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:9"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/9e8d0234ce66ca99ad7350a9b9d8bab093923319"><code>9e8d023</code></a></td><td><code>ImageSubobject.cardinality: Handle infinite cardinalities explicitly</code></td></tr></table>




---

archive/issue_comments_555069.json:
```json
{
    "body": "Changed commit from **[`52f6ca6`](https://github.com/sagemath/sagetrac-mirror/commit/52f6ca6ca8ed4655442bf24d8918d7b721a900d1)** to **[`9e8d023`](https://github.com/sagemath/sagetrac-mirror/commit/9e8d0234ce66ca99ad7350a9b9d8bab093923319)**",
    "created_at": "2022-08-17T02:44:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555069",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`52f6ca6`](https://github.com/sagemath/sagetrac-mirror/commit/52f6ca6ca8ed4655442bf24d8918d7b721a900d1)** to **[`9e8d023`](https://github.com/sagemath/sagetrac-mirror/commit/9e8d0234ce66ca99ad7350a9b9d8bab093923319)**



---

archive/issue_comments_555070.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nBots are green now",
    "created_at": "2022-08-17T15:11:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555070",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">comment:10</div>

Bots are green now



---

archive/issue_comments_555071.json:
```json
{
    "body": "<div id=\"comment:11\"></div>\n\nBranch pushed to git repo; I updated commit sha1. New commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed\"><code>6aeab7d</code></a></td><td><code>src/sage/sets/image_set.py: Clarify is_injective=False</code></td></tr></table>\n",
    "created_at": "2022-08-17T15:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555071",
    "user": "https://github.com/sagetrac-git"
}
```

<div id="comment:11"></div>

Branch pushed to git repo; I updated commit sha1. New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed"><code>6aeab7d</code></a></td><td><code>src/sage/sets/image_set.py: Clarify is_injective=False</code></td></tr></table>




---

archive/issue_comments_555072.json:
```json
{
    "body": "Changed commit from **[`9e8d023`](https://github.com/sagemath/sagetrac-mirror/commit/9e8d0234ce66ca99ad7350a9b9d8bab093923319)** to **[`6aeab7d`](https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed)**",
    "created_at": "2022-08-17T15:42:48Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555072",
    "user": "https://github.com/sagetrac-git"
}
```

Changed commit from **[`9e8d023`](https://github.com/sagemath/sagetrac-mirror/commit/9e8d0234ce66ca99ad7350a9b9d8bab093923319)** to **[`6aeab7d`](https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed)**



---

archive/issue_events_471968.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2022-08-20T05:38:58Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471968"
}
```



---

archive/issue_events_471969.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2022-08-20T05:38:58Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471969"
}
```



---

archive/issue_comments_555073.json:
```json
{
    "body": "Reviewer: **Travis Scrimshaw**",
    "created_at": "2022-08-20T05:38:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555073",
    "user": "https://github.com/tscrim"
}
```

Reviewer: **Travis Scrimshaw**



---

archive/issue_comments_555074.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nLGTM.",
    "created_at": "2022-08-20T05:38:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555074",
    "user": "https://github.com/tscrim"
}
```

<div id="comment:12" align="right">comment:12</div>

LGTM.



---

archive/issue_comments_555075.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nThanks.",
    "created_at": "2022-08-20T05:42:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555075",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:13" align="right">comment:13</div>

Thanks.



---

archive/issue_events_471970.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-08-30T19:05:12Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471970"
}
```



---

archive/issue_events_471971.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "9c80ec3d62543273db20b24ee066bd54915e8708",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-08-30T19:05:12Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34377#event-471971"
}
```



---

archive/issue_comments_555076.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/improvements_to_imageset](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improvements_to_imageset)** to **[`6aeab7d`](https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed)**",
    "created_at": "2022-08-30T19:05:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34377",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34377#issuecomment-555076",
    "user": "https://github.com/vbraun"
}
```

Changed branch from **[u/mkoeppe/improvements_to_imageset](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/improvements_to_imageset)** to **[`6aeab7d`](https://github.com/sagemath/sagetrac-mirror/commit/6aeab7d2b6f5cf61be7f969039c3e3a1d93997ed)**
