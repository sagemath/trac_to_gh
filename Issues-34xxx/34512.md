# Issue 34512: compute list CRT via tree

archive/issues_034275.json:
```json
{
    "body": "Currently, `CRT_list()` works by *folding* the input from one side. In typical cases of interest, it is much more efficient to use a binary-tree structure instead. (This is similar to how `prod()` is implemented.)\n\nExample:\n\n```sage\nsage: ms = list(primes(10^5))\nsage: xs = [randrange(m) for m in ms]\nsage: %timeit CRT_list(xs, ms)\n```\n\nSage 9.7.rc0:\n\n```\n7.42 s \u00b1 20 ms per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nThis branch:\n\n```\n86.5 ms \u00b1 169 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\nSimilar speedups can be observed for polynomials; example (a length\u20111024 inverse DFT):\n\n```\nsage: F = GF(65537)\nsage: a = F(1111)\nsage: assert a.multiplicative_order() == 1024\nsage: R.<x> = F[]\nsage: ms = [x - a^i for i in range(1024)]\nsage: zs = [R(F.random_element()) for _ in ms]\nsage: %timeit CRT_list(zs, ms)\n```\n\nSage 9.7.rc0:\n\n```\n347 ms \u00b1 863 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 1 loop each)\n```\n\nThis branch:\n\n```\n29.3 ms \u00b1 37.1 \u00b5s per loop (mean \u00b1 std. dev. of 7 runs, 10 loops each)\n```\n\nReviewer: Kwankyu Lee\n\nAuthor: Lorenz Panny\n\nBranch: 5f3a23fc0b7d07d0eb928f4d9c612d3376ee83e2\n\nCommit: 5f3a23fc0b7d07d0eb928f4d9c612d3376ee83e2\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34512\n\n",
    "closed_at": "2022-09-27T22:27:20Z",
    "created_at": "2022-09-09T09:08:03Z",
    "labels": [
        "component: algebra",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "compute list CRT via tree",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34512",
    "user": "https://github.com/yyyyx4"
}
```
Currently, `CRT_list()` works by *folding* the input from one side. In typical cases of interest, it is much more efficient to use a binary-tree structure instead. (This is similar to how `prod()` is implemented.)

Example:

```sage
sage: ms = list(primes(10^5))
sage: xs = [randrange(m) for m in ms]
sage: %timeit CRT_list(xs, ms)
```

Sage 9.7.rc0:

```
7.42 s ± 20 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

This branch:

```
86.5 ms ± 169 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

Similar speedups can be observed for polynomials; example (a length‑1024 inverse DFT):

```
sage: F = GF(65537)
sage: a = F(1111)
sage: assert a.multiplicative_order() == 1024
sage: R.<x> = F[]
sage: ms = [x - a^i for i in range(1024)]
sage: zs = [R(F.random_element()) for _ in ms]
sage: %timeit CRT_list(zs, ms)
```

Sage 9.7.rc0:

```
347 ms ± 863 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
```

This branch:

```
29.3 ms ± 37.1 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
```

Reviewer: Kwankyu Lee

Author: Lorenz Panny

Branch: 5f3a23fc0b7d07d0eb928f4d9c612d3376ee83e2

Commit: 5f3a23fc0b7d07d0eb928f4d9c612d3376ee83e2

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34512





---

archive/issue_comments_485461.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-09T09:08:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485461",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_485462.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-11T07:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485462",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_485463.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-12T02:02:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485463",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485464.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-12T02:07:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485464",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_485465.json:
```json
{
    "body": "<a id='comment:5'></a>test, please ignore",
    "created_at": "2022-09-13T08:53:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485465",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>test, please ignore



---

archive/issue_comments_485466.json:
```json
{
    "body": "<a id='comment:6'></a>I simplified(?) the code\n\n```diff\n--- a/src/sage/arith/misc.py\n+++ b/src/sage/arith/misc.py\n@@ -3302,13 +3302,14 @@ def CRT_list(v, moduli):\n     if len(v) == 1:\n         return moduli[0].parent()(v[0])\n     from sage.arith.functions import lcm\n-    v = [CRT(v[i], v[i+1], moduli[i], moduli[i+1]) for i in range(0, len(v)-1, 2)] + v[len(v)//2*2:]\n-    moduli = [lcm(moduli[i], moduli[i+1]) for i in range(0, len(moduli)-1, 2)] + moduli[len(moduli)//2*2:]\n     while len(v) > 1:\n-        for i in range(0, len(v)-1, 2):\n-            v[i] = CRT(v[i], v[i+1], moduli[i], moduli[i+1])\n-            moduli[i] = lcm(moduli[i], moduli[i+1])\n-        v, moduli = v[::2], moduli[::2]\n+        vs = [CRT(v[i], v[i + 1], moduli[i], moduli[i + 1]) for i in range(0, len(v) - 1, 2)]\n+        ms = [lcm(moduli[i], moduli[i + 1]) for i in range(0, len(v) - 1, 2)]\n+        if len(v) % 2:\n+            vs.append(v[-1])\n+            ms.append(moduli[-1])\n+        v = vs\n+        moduli = ms\n     return v[0] % moduli[0]\n```\nThis is slightly slower than your code but easier to read. What do you think?",
    "created_at": "2022-09-13T12:54:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485466",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:6'></a>I simplified(?) the code

```diff
--- a/src/sage/arith/misc.py
+++ b/src/sage/arith/misc.py
@@ -3302,13 +3302,14 @@ def CRT_list(v, moduli):
     if len(v) == 1:
         return moduli[0].parent()(v[0])
     from sage.arith.functions import lcm
-    v = [CRT(v[i], v[i+1], moduli[i], moduli[i+1]) for i in range(0, len(v)-1, 2)] + v[len(v)//2*2:]
-    moduli = [lcm(moduli[i], moduli[i+1]) for i in range(0, len(moduli)-1, 2)] + moduli[len(moduli)//2*2:]
     while len(v) > 1:
-        for i in range(0, len(v)-1, 2):
-            v[i] = CRT(v[i], v[i+1], moduli[i], moduli[i+1])
-            moduli[i] = lcm(moduli[i], moduli[i+1])
-        v, moduli = v[::2], moduli[::2]
+        vs = [CRT(v[i], v[i + 1], moduli[i], moduli[i + 1]) for i in range(0, len(v) - 1, 2)]
+        ms = [lcm(moduli[i], moduli[i + 1]) for i in range(0, len(v) - 1, 2)]
+        if len(v) % 2:
+            vs.append(v[-1])
+            ms.append(moduli[-1])
+        v = vs
+        moduli = ms
     return v[0] % moduli[0]
```
This is slightly slower than your code but easier to read. What do you think?



---

archive/issue_comments_485467.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-13T16:16:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485467",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485468.json:
```json
{
    "body": "<a id='comment:8'></a>Thanks! I continued tweaking it and ended up with this. It seems to be just as fast as my first version.",
    "created_at": "2022-09-13T16:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485468",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:8'></a>Thanks! I continued tweaking it and ended up with this. It seems to be just as fast as my first version.



---

archive/issue_comments_485469.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-14T04:20:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485469",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485470.json:
```json
{
    "body": "<a id='comment:10'></a>Thanks. Looks nice. \n\nI moved the implementation comment to the code block. Other than that, I am positive.",
    "created_at": "2022-09-14T04:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485470",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:10'></a>Thanks. Looks nice. 

I moved the implementation comment to the code block. Other than that, I am positive.



---

archive/issue_comments_485471.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-14T04:24:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485471",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_485472.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-09-21T20:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485472",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_485473.json:
```json
{
    "body": "<a id='comment:11'></a>\n```\nsage -t --warn-long 46.9 --random-seed=47449161950200526044278063017024899534 src/sage/rings/polynomial/polynomial_quotient_ring.py\n**********************************************************************\nFile \"src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1643, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units\nFailed example:\n    [u for u, o in L.S_units([]) if o is Infinity]\nException raised:\n    Traceback (most recent call last):\n      File \"/home/release/Sage/src/sage/doctest/forker.py\", line 695, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/release/Sage/src/sage/doctest/forker.py\", line 1093, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units[11]>\", line 1, in <module>\n        [u for u, o in L.S_units([]) if o is Infinity]\n      File \"/home/release/Sage/src/sage/rings/polynomial/polynomial_quotient_ring.py\", line 1687, in S_units\n        poly_unit = self(sage.arith.all.crt(prod_unit, moduli))\n      File \"/home/release/Sage/src/sage/arith/misc.py\", line 3203, in crt\n        return CRT_list(a, b)\n      File \"/home/release/Sage/src/sage/arith/misc.py\", line 3320, in CRT_list\n        return values[0] % moduli[0]\n      File \"sage/rings/polynomial/polynomial_element.pyx\", line 2882, in sage.rings.polynomial.polynomial_element.Polynomial.__mod__\n        _, R = self.quo_rem(other)\n      File \"sage/structure/element.pyx\", line 4500, in sage.structure.element.coerce_binop.new_method\n        a, b = coercion_model.canonical_coercion(self, other)\n      File \"sage/structure/coerce.pyx\", line 1393, in sage.structure.coerce.CoercionModel.canonical_coercion\n        raise TypeError(\"no common canonical parent for objects with parents: '%s' and '%s'\"%(xp, yp))\n    TypeError: no common canonical parent for objects with parents: 'Univariate Polynomial Ring in x over Number Field in a with defining polynomial x^2 + 3 with a = 1.732050807568878?*I' and 'Univariate Polynomial Ring in y over Number Field in a with defining polynomial x^2 + 3 with a = 1.732050807568878?*I'\n```\nand others",
    "created_at": "2022-09-21T20:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485473",
    "user": "https://github.com/vbraun"
}
```

<a id='comment:11'></a>
```
sage -t --warn-long 46.9 --random-seed=47449161950200526044278063017024899534 src/sage/rings/polynomial/polynomial_quotient_ring.py
**********************************************************************
File "src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1643, in sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units
Failed example:
    [u for u, o in L.S_units([]) if o is Infinity]
Exception raised:
    Traceback (most recent call last):
      File "/home/release/Sage/src/sage/doctest/forker.py", line 695, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/release/Sage/src/sage/doctest/forker.py", line 1093, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.rings.polynomial.polynomial_quotient_ring.PolynomialQuotientRing_generic.S_units[11]>", line 1, in <module>
        [u for u, o in L.S_units([]) if o is Infinity]
      File "/home/release/Sage/src/sage/rings/polynomial/polynomial_quotient_ring.py", line 1687, in S_units
        poly_unit = self(sage.arith.all.crt(prod_unit, moduli))
      File "/home/release/Sage/src/sage/arith/misc.py", line 3203, in crt
        return CRT_list(a, b)
      File "/home/release/Sage/src/sage/arith/misc.py", line 3320, in CRT_list
        return values[0] % moduli[0]
      File "sage/rings/polynomial/polynomial_element.pyx", line 2882, in sage.rings.polynomial.polynomial_element.Polynomial.__mod__
        _, R = self.quo_rem(other)
      File "sage/structure/element.pyx", line 4500, in sage.structure.element.coerce_binop.new_method
        a, b = coercion_model.canonical_coercion(self, other)
      File "sage/structure/coerce.pyx", line 1393, in sage.structure.coerce.CoercionModel.canonical_coercion
        raise TypeError("no common canonical parent for objects with parents: '%s' and '%s'"%(xp, yp))
    TypeError: no common canonical parent for objects with parents: 'Univariate Polynomial Ring in x over Number Field in a with defining polynomial x^2 + 3 with a = 1.732050807568878?*I' and 'Univariate Polynomial Ring in y over Number Field in a with defining polynomial x^2 + 3 with a = 1.732050807568878?*I'
```
and others



---

archive/issue_comments_485474.json:
```json
{
    "body": "<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-22T02:32:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485474",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:12'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485475.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-22T02:33:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485475",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_485476.json:
```json
{
    "body": "<a id='comment:14'></a>Passed BUILD&TEST.",
    "created_at": "2022-09-22T13:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485476",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:14'></a>Passed BUILD&TEST.



---

archive/issue_comments_485477.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-22T13:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485477",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_485478.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2022-09-22T13:34:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485478",
    "user": "https://github.com/kwankyu"
}
```

Changing priority from major to minor.



---

archive/issue_comments_485479.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-27T22:27:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34512#issuecomment-485479",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_089613.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-09-27T22:27:20Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34512",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34512#event-89613"
}
```
