# Issue 34350: speed up powers of lazy Taylor series

archive/issues_034113.json:
```json
{
    "body": "As remarked inticket: ticket:32324#comment:105#comment:32324, the computation of the square root of a lazy series is very slow.\n\nKeywords: LazyPowerSeries\n\nBranch/Commit: b23792105a2fbb3d8e7d529774f91eaa3831ac84\n\nReviewer: Martin Pepin\n\nAuthor: Travis Scrimshaw\n\nDependencies: #32324\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34350\n\n",
    "closed_at": "2022-09-25T16:34:17Z",
    "created_at": "2022-08-12T13:36:10Z",
    "labels": [
        "component: combinatorics"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "speed up powers of lazy Taylor series",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34350",
    "user": "https://github.com/mantepse"
}
```
As remarked inticket: ticket:32324#comment:105#comment:32324, the computation of the square root of a lazy series is very slow.

Keywords: LazyPowerSeries

Branch/Commit: b23792105a2fbb3d8e7d529774f91eaa3831ac84

Reviewer: Martin Pepin

Author: Travis Scrimshaw

Dependencies: #32324

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34350





---

archive/issue_comments_683669.json:
```json
{
    "body": "<a id='comment:1'></a>\nUsing a the na\u00efve version using the Taylor series speeds things up considerably:\n\n```\nsage: L.<z> = LazyLaurentSeriesRing(QQ)\nsage: f = sqrt(1 + z)\nsage: %time f[200]\nCPU times: user 254 ms, sys: 4.21 ms, total: 258 ms\nWall time: 258 ms\n```\nversus before\n\n```\nsage: %time f[200]\nCPU times: user 2.39 s, sys: 1.83 ms, total: 2.4 s\nWall time: 2.4 s\n```\n\nAnother example:\n\n```\nsage: q = ZZ['q'].fraction_field().gen()\nsage: L.<z> = LazyLaurentSeriesRing(q.parent())\nsage: f = (1 - z)^q\nsage: f\n1 - q*z + ((q^2 - q)/2)*z^2 + ((-q^3 + 3*q^2 - 2*q)/6)*z^3 + ((q^4 - 6*q^3 + 11*q^2 - 6*q)/24)*z^4 + ((-q^5 + 10*q^4 - 35*q^3 + 50*q^2 - 24*q)/120)*z^5 + ((q^6 - 15*q^5 + 85*q^4 - 225*q^3 + 274*q^2 - 120*q)/720)*z^6 + O(z^7)\nsage: %time f[200]\nCPU times: user 439 ms, sys: 0 ns, total: 439 ms\nWall time: 439 ms\n```\nversus before\n\n```\nsage: %time c = f[200]\nCPU times: user 10.3 s, sys: 9.75 ms, total: 10.3 s\nWall time: 10.3 s\n```\n\n---\nLast 10 new commits:\n|                                                                                                                                          |                                                                    |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|\n|[9d6579b](https://github.com/sagemath/sagetrac-mirror/commit/9d6579ba5e4545140d9d74b3cb9f70f232109872)|`improve documentation, move zero, one, characteristic, etc. to ABC`|\n|[feba6b8](https://github.com/sagemath/sagetrac-mirror/commit/feba6b8997b7d11a11f252b1ee957e68cfdf1bc5)|`Working more on __call__ for LazySymFunc.`|\n|[3f3e0f2](https://github.com/sagemath/sagetrac-mirror/commit/3f3e0f2048c702daa48cde9edea574458abcf8f0)|`Merge branch 'public/rings/lazy_talyor_series-32324' of https://github.com/sagemath/sagetrac-mirror into public/rings/lazy_talyor_series-32324`|\n|[6727228](https://github.com/sagemath/sagetrac-mirror/commit/67272285ace598162cbd1de50fa4f1c9fe74b0dd)|`Merge branch 'public/rings/lazy_talyor_series-32324' of trac.sagemath.org:sage into t/32324/public/rings/lazy_talyor_series-32324`|\n|[028796d](https://github.com/sagemath/sagetrac-mirror/commit/028796d47eedb24a730258ae18e89b95bda24639)|`Fixing numerous issues with __call__ and expanding its functionality. Moving plethysm to a Stream_plethysm.`|\n|[9fb155f](https://github.com/sagemath/sagetrac-mirror/commit/9fb155f4502d54f0ea8dc2b15745804b000d694a)|`Removing unused code from previous version.`|\n|[7f9dbb1](https://github.com/sagemath/sagetrac-mirror/commit/7f9dbb186459922ba90b5a9326ebf6b5dcaa1ba8)|`Some last doc fixes and tweaks.`|\n|[4e03fee](https://github.com/sagemath/sagetrac-mirror/commit/4e03fee27f1ebff2741eb57fb0de4d7d80043636)|`remove unused local variable`|\n|[e780472](https://github.com/sagemath/sagetrac-mirror/commit/e78047258774176c6e8271e29c9b5825cc12aa11)|`Addressing the linter complaint.`|\n|[465fe7c](https://github.com/sagemath/sagetrac-mirror/commit/465fe7c78fbfcfbf7431234514591ab95360a6f0)|`Speeding up powers of lazy series by using a different algorithm.`|",
    "created_at": "2022-08-15T02:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683669",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:1'></a>
Using a the na√Øve version using the Taylor series speeds things up considerably:

```
sage: L.<z> = LazyLaurentSeriesRing(QQ)
sage: f = sqrt(1 + z)
sage: %time f[200]
CPU times: user 254 ms, sys: 4.21 ms, total: 258 ms
Wall time: 258 ms
```
versus before

```
sage: %time f[200]
CPU times: user 2.39 s, sys: 1.83 ms, total: 2.4 s
Wall time: 2.4 s
```

Another example:

```
sage: q = ZZ['q'].fraction_field().gen()
sage: L.<z> = LazyLaurentSeriesRing(q.parent())
sage: f = (1 - z)^q
sage: f
1 - q*z + ((q^2 - q)/2)*z^2 + ((-q^3 + 3*q^2 - 2*q)/6)*z^3 + ((q^4 - 6*q^3 + 11*q^2 - 6*q)/24)*z^4 + ((-q^5 + 10*q^4 - 35*q^3 + 50*q^2 - 24*q)/120)*z^5 + ((q^6 - 15*q^5 + 85*q^4 - 225*q^3 + 274*q^2 - 120*q)/720)*z^6 + O(z^7)
sage: %time f[200]
CPU times: user 439 ms, sys: 0 ns, total: 439 ms
Wall time: 439 ms
```
versus before

```
sage: %time c = f[200]
CPU times: user 10.3 s, sys: 9.75 ms, total: 10.3 s
Wall time: 10.3 s
```

---
Last 10 new commits:
|                                                                                                                                          |                                                                    |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------|
|[9d6579b](https://github.com/sagemath/sagetrac-mirror/commit/9d6579ba5e4545140d9d74b3cb9f70f232109872)|`improve documentation, move zero, one, characteristic, etc. to ABC`|
|[feba6b8](https://github.com/sagemath/sagetrac-mirror/commit/feba6b8997b7d11a11f252b1ee957e68cfdf1bc5)|`Working more on __call__ for LazySymFunc.`|
|[3f3e0f2](https://github.com/sagemath/sagetrac-mirror/commit/3f3e0f2048c702daa48cde9edea574458abcf8f0)|`Merge branch 'public/rings/lazy_talyor_series-32324' of https://github.com/sagemath/sagetrac-mirror into public/rings/lazy_talyor_series-32324`|
|[6727228](https://github.com/sagemath/sagetrac-mirror/commit/67272285ace598162cbd1de50fa4f1c9fe74b0dd)|`Merge branch 'public/rings/lazy_talyor_series-32324' of trac.sagemath.org:sage into t/32324/public/rings/lazy_talyor_series-32324`|
|[028796d](https://github.com/sagemath/sagetrac-mirror/commit/028796d47eedb24a730258ae18e89b95bda24639)|`Fixing numerous issues with __call__ and expanding its functionality. Moving plethysm to a Stream_plethysm.`|
|[9fb155f](https://github.com/sagemath/sagetrac-mirror/commit/9fb155f4502d54f0ea8dc2b15745804b000d694a)|`Removing unused code from previous version.`|
|[7f9dbb1](https://github.com/sagemath/sagetrac-mirror/commit/7f9dbb186459922ba90b5a9326ebf6b5dcaa1ba8)|`Some last doc fixes and tweaks.`|
|[4e03fee](https://github.com/sagemath/sagetrac-mirror/commit/4e03fee27f1ebff2741eb57fb0de4d7d80043636)|`remove unused local variable`|
|[e780472](https://github.com/sagemath/sagetrac-mirror/commit/e78047258774176c6e8271e29c9b5825cc12aa11)|`Addressing the linter complaint.`|
|[465fe7c](https://github.com/sagemath/sagetrac-mirror/commit/465fe7c78fbfcfbf7431234514591ab95360a6f0)|`Speeding up powers of lazy series by using a different algorithm.`|



---

archive/issue_comments_683670.json:
```json
{
    "body": "Changing author from \"\" to \"Travis Scrimshaw\"",
    "created_at": "2022-08-15T02:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683670",
    "user": "https://github.com/tscrim"
}
```

Changing author from "" to "Travis Scrimshaw"



---

archive/issue_comments_683671.json:
```json
{
    "body": "Changing commit from \"\" to \"465fe7c78fbfcfbf7431234514591ab95360a6f0\"",
    "created_at": "2022-08-15T02:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683671",
    "user": "https://github.com/tscrim"
}
```

Changing commit from "" to "465fe7c78fbfcfbf7431234514591ab95360a6f0"



---

archive/issue_comments_683672.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-08-15T02:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683672",
    "user": "https://github.com/tscrim"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_683673.json:
```json
{
    "body": "Changing branch from \"\" to \"public/rings/speedup_powers_lazy_series-34350\"",
    "created_at": "2022-08-15T02:18:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683673",
    "user": "https://github.com/tscrim"
}
```

Changing branch from "" to "public/rings/speedup_powers_lazy_series-34350"



---

archive/issue_comments_683674.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#32324\"",
    "created_at": "2022-08-15T02:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683674",
    "user": "https://github.com/tscrim"
}
```

Changing dependencies from "" to "#32324"



---

archive/issue_comments_683675.json:
```json
{
    "body": "<a id='comment:2'></a>\nI based this off #32324 since that is positively reviewed, although I can remove this if necessary.",
    "created_at": "2022-08-15T02:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683675",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:2'></a>
I based this off #32324 since that is positively reviewed, although I can remove this if necessary.



---

archive/issue_events_100699.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34350#event-100699"
}
```



---

archive/issue_comments_683676.json:
```json
{
    "body": "Changing branch from \"public/rings/speedup_powers_lazy_series-34350\" to \"u/MartinPepin/34350\"",
    "created_at": "2022-09-21T14:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683676",
    "user": "https://github.com/Kerl13"
}
```

Changing branch from "public/rings/speedup_powers_lazy_series-34350" to "u/MartinPepin/34350"



---

archive/issue_comments_683677.json:
```json
{
    "body": "Changing reviewer from \"\" to \"MartinPepin\"",
    "created_at": "2022-09-21T14:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683677",
    "user": "https://github.com/Kerl13"
}
```

Changing reviewer from "" to "MartinPepin"



---

archive/issue_comments_683678.json:
```json
{
    "body": "Changing commit from \"465fe7c78fbfcfbf7431234514591ab95360a6f0\" to \"d4450fb31c4d7331cafbad27bf45c4c3697df679\"",
    "created_at": "2022-09-21T14:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683678",
    "user": "https://github.com/Kerl13"
}
```

Changing commit from "465fe7c78fbfcfbf7431234514591ab95360a6f0" to "d4450fb31c4d7331cafbad27bf45c4c3697df679"



---

archive/issue_comments_683679.json:
```json
{
    "body": "<a id='comment:4'></a>\nI reproduced the time difference, that's indeed huge!\n\nI also took the opportunity to update the docstring for `__pow__` with your examples. Before that it was only documenting integer powers. Once you have reviewed this change I think it's good to go.\n\n---\nNew commits:\n|                                                                                                                                          |                                                                   |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|\n|[7b55ef5](https://github.com/sagemath/sagetrac-mirror/commit/7b55ef58e4f2c274165b5a8e277149f83705b52c)|`Speeding up powers of lazy series by using a different algorithm.`|\n|[d4450fb](https://github.com/sagemath/sagetrac-mirror/commit/d4450fb31c4d7331cafbad27bf45c4c3697df679)|`Update lazy_series' __pow__ docstring`|",
    "created_at": "2022-09-21T14:58:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683679",
    "user": "https://github.com/Kerl13"
}
```

<a id='comment:4'></a>
I reproduced the time difference, that's indeed huge!

I also took the opportunity to update the docstring for `__pow__` with your examples. Before that it was only documenting integer powers. Once you have reviewed this change I think it's good to go.

---
New commits:
|                                                                                                                                          |                                                                   |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------|
|[7b55ef5](https://github.com/sagemath/sagetrac-mirror/commit/7b55ef58e4f2c274165b5a8e277149f83705b52c)|`Speeding up powers of lazy series by using a different algorithm.`|
|[d4450fb](https://github.com/sagemath/sagetrac-mirror/commit/d4450fb31c4d7331cafbad27bf45c4c3697df679)|`Update lazy_series' __pow__ docstring`|



---

archive/issue_comments_683680.json:
```json
{
    "body": "Changing reviewer from \"MartinPepin\" to \"Martin Pepin\"",
    "created_at": "2022-09-22T03:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683680",
    "user": "https://github.com/tscrim"
}
```

Changing reviewer from "MartinPepin" to "Martin Pepin"



---

archive/issue_comments_683681.json:
```json
{
    "body": "<a id='comment:5'></a>\nHi Martin P. Thanks for the review. Can you quickly do two minor little tweaks to follow our docstring conventions:\n\n```diff\n-        - ``n`` -- the power to which to raise the series. This may be an\n-          integer, a rational number, an element of the base ring, or an other\n-          series.\n+        - ``n`` -- the power to which to raise the series; this may be a\n+          rational number, an element of the base ring, or another series\n```\n\n```diff\n             sage: f\n-            1 - q*z + ((q^2 - q)/2)*z^2 + ((-q^3 + 3*q^2 - 2*q)/6)*z^3 + ((q^4 - 6*q^3 + 11*q^2 - 6*q)/24)*z^4 + ((-q^5 + 10*q^4 - 35*q^3 + 50*q^2 - 24*q)/120)*z^5 + ((q^6 - 15*q^5 + 85*q^4 - 225*q^3 + 274*q^2 - 120*q)/720)*z^6 + O(z^7)\n+            1 - q*z + ((q^2 - q)/2)*z^2 + ((-q^3 + 3*q^2 - 2*q)/6)*z^3\n+             + ((q^4 - 6*q^3 + 11*q^2 - 6*q)/24)*z^4\n+             + ((-q^5 + 10*q^4 - 35*q^3 + 50*q^2 - 24*q)/120)*z^5\n+             + ((q^6 - 15*q^5 + 85*q^4 - 225*q^3 + 274*q^2 - 120*q)/720)*z^6\n+             + O(z^7)\n         \"\"\"\n```\nOnce you do those, you can set a positive review.",
    "created_at": "2022-09-22T03:56:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683681",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>
Hi Martin P. Thanks for the review. Can you quickly do two minor little tweaks to follow our docstring conventions:

```diff
-        - ``n`` -- the power to which to raise the series. This may be an
-          integer, a rational number, an element of the base ring, or an other
-          series.
+        - ``n`` -- the power to which to raise the series; this may be a
+          rational number, an element of the base ring, or another series
```

```diff
             sage: f
-            1 - q*z + ((q^2 - q)/2)*z^2 + ((-q^3 + 3*q^2 - 2*q)/6)*z^3 + ((q^4 - 6*q^3 + 11*q^2 - 6*q)/24)*z^4 + ((-q^5 + 10*q^4 - 35*q^3 + 50*q^2 - 24*q)/120)*z^5 + ((q^6 - 15*q^5 + 85*q^4 - 225*q^3 + 274*q^2 - 120*q)/720)*z^6 + O(z^7)
+            1 - q*z + ((q^2 - q)/2)*z^2 + ((-q^3 + 3*q^2 - 2*q)/6)*z^3
+             + ((q^4 - 6*q^3 + 11*q^2 - 6*q)/24)*z^4
+             + ((-q^5 + 10*q^4 - 35*q^3 + 50*q^2 - 24*q)/120)*z^5
+             + ((q^6 - 15*q^5 + 85*q^4 - 225*q^3 + 274*q^2 - 120*q)/720)*z^6
+             + O(z^7)
         """
```
Once you do those, you can set a positive review.



---

archive/issue_comments_683682.json:
```json
{
    "body": "<a id='comment:6'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                           |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|\n|[b237921](https://github.com/sagemath/sagetrac-mirror/commit/b23792105a2fbb3d8e7d529774f91eaa3831ac84)|`Formatting issues / docstring conventions`|",
    "created_at": "2022-09-22T07:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683682",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                           |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|
|[b237921](https://github.com/sagemath/sagetrac-mirror/commit/b23792105a2fbb3d8e7d529774f91eaa3831ac84)|`Formatting issues / docstring conventions`|



---

archive/issue_comments_683683.json:
```json
{
    "body": "Changing commit from \"d4450fb31c4d7331cafbad27bf45c4c3697df679\" to \"b23792105a2fbb3d8e7d529774f91eaa3831ac84\"",
    "created_at": "2022-09-22T07:36:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683683",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d4450fb31c4d7331cafbad27bf45c4c3697df679" to "b23792105a2fbb3d8e7d529774f91eaa3831ac84"



---

archive/issue_comments_683684.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-22T07:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683684",
    "user": "https://github.com/Kerl13"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_683685.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-25T16:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683685",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_683686.json:
```json
{
    "body": "Changing branch from \"u/MartinPepin/34350\" to \"b23792105a2fbb3d8e7d529774f91eaa3831ac84\"",
    "created_at": "2022-09-25T16:34:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34350#issuecomment-683686",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/MartinPepin/34350" to "b23792105a2fbb3d8e7d529774f91eaa3831ac84"



---

archive/issue_events_100700.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-09-25T16:34:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34350",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34350#event-100700"
}
```
