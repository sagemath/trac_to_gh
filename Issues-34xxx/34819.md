# Issue 34819: Numerical separators behave inconsistently

archive/issues_034582.json:
```json
{
    "body": "PEP 515 numerical separators (such as 1_000_000, as introduced in #28490) behave inconsistently, ignoring everything after the first separator upon conversion to a different precision.\n\nReproduction:\n\n```\n    sage: z = 1_0000.000000000000000000000000000000000000\n    sage: z # works as expected without the conversion\n    10000.000000000000000000000000000000000000\n    sage: RR(z)\n    1.00000000000000\n```\n\nSageMath version 9.5, Release Date: 2022-01-30, Using Python 3.10.6, OS: Ubuntu 22.04.1\n\nAlso reproduces on Sage 9.7\n\nAssignee: @io4\n\nBranch/Commit: [7aac17573027833982f6c5fe64ab66959cea4ccb](https://github.com/sagemath/sagetrac-mirror/commit/7aac17573027833982f6c5fe64ab66959cea4ccb)\n\nReviewer: Marc Mezzarobba\n\nAuthor: Lucas Fiegl\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34819\n\n",
    "closed_at": "2022-12-14T22:12:10Z",
    "created_at": "2022-12-03T00:08:36Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Numerical separators behave inconsistently",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34819",
    "user": "https://github.com/io4"
}
```
PEP 515 numerical separators (such as 1_000_000, as introduced in #28490) behave inconsistently, ignoring everything after the first separator upon conversion to a different precision.

Reproduction:

```
    sage: z = 1_0000.000000000000000000000000000000000000
    sage: z # works as expected without the conversion
    10000.000000000000000000000000000000000000
    sage: RR(z)
    1.00000000000000
```

SageMath version 9.5, Release Date: 2022-01-30, Using Python 3.10.6, OS: Ubuntu 22.04.1

Also reproduces on Sage 9.7

Assignee: @io4

Branch/Commit: [7aac17573027833982f6c5fe64ab66959cea4ccb](https://github.com/sagemath/sagetrac-mirror/commit/7aac17573027833982f6c5fe64ab66959cea4ccb)

Reviewer: Marc Mezzarobba

Author: Lucas Fiegl

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34819





---

archive/issue_comments_691397.json:
```json
{
    "body": "<a id='comment:1'></a>\nI suspect the incorrect value arises here (lines 1461-1465) in `src/sage/rings/real_mpfr.pyx`:\n\n```\nif isinstance(x, RealLiteral):\n    s = (<RealLiteral>x).literal\n    base = (<RealLiteral>x).base\n    if mpfr_set_str(self.value, str_to_bytes(s), base, parent.rnd):\n        self._set(s, base)\n```\nThe [documentation of `mpfr_strtofr`](https://machinecognitis.github.io/Math.Mpfr.Native/html/31cf29bb-b672-5829-a62d-f91e9547eb0c.htm) says \"The subject sequence is defined as the longest initial subsequence of the input string, starting with the first non-whitespace character, that is of the expected form.\" That could explain why everything after the first underscore is ignored.\n\nSeveral lines later in the same method, I see:\n\n```\ns = str(x).replace(' ','').replace('_', '')\n```\nMaybe we could solve the problem by applying this replacement in the `__init__` method, which is defined later (lines 5669-5685) in the same file:\n\n```\ndef __init__(self, RealField_class parent, x=0, int base=10):\n        <snip docstring>\n    RealNumber.__init__(self, parent, x, base)\n    if isinstance(x, str):\n        self.base = base\n        self.literal = x\n```\nI.e., perhaps we should strip the underscores (and spaces?) before assigning to `self.literal`.",
    "created_at": "2022-12-03T00:28:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691397",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'></a>
I suspect the incorrect value arises here (lines 1461-1465) in `src/sage/rings/real_mpfr.pyx`:

```
if isinstance(x, RealLiteral):
    s = (<RealLiteral>x).literal
    base = (<RealLiteral>x).base
    if mpfr_set_str(self.value, str_to_bytes(s), base, parent.rnd):
        self._set(s, base)
```
The [documentation of `mpfr_strtofr`](https://machinecognitis.github.io/Math.Mpfr.Native/html/31cf29bb-b672-5829-a62d-f91e9547eb0c.htm) says "The subject sequence is defined as the longest initial subsequence of the input string, starting with the first non-whitespace character, that is of the expected form." That could explain why everything after the first underscore is ignored.

Several lines later in the same method, I see:

```
s = str(x).replace(' ','').replace('_', '')
```
Maybe we could solve the problem by applying this replacement in the `__init__` method, which is defined later (lines 5669-5685) in the same file:

```
def __init__(self, RealField_class parent, x=0, int base=10):
        <snip docstring>
    RealNumber.__init__(self, parent, x, base)
    if isinstance(x, str):
        self.base = base
        self.literal = x
```
I.e., perhaps we should strip the underscores (and spaces?) before assigning to `self.literal`.



---

archive/issue_comments_691398.json:
```json
{
    "body": "Set assignee to @io4.",
    "created_at": "2022-12-03T06:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691398",
    "user": "https://github.com/io4"
}
```

Set assignee to @io4.



---

archive/issue_comments_691399.json:
```json
{
    "body": "<a id='comment:2'></a>\nSeems that the purpose of stripping spaces is to faciliate comparation with \"NaN+NaN*I\" (whose default stringification contains spaces) so that shouldn't be needed.\n\nRemoving underscores before setting self.literal does fix the issue.",
    "created_at": "2022-12-03T06:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691399",
    "user": "https://github.com/io4"
}
```

<a id='comment:2'></a>
Seems that the purpose of stripping spaces is to faciliate comparation with "NaN+NaN*I" (whose default stringification contains spaces) so that shouldn't be needed.

Removing underscores before setting self.literal does fix the issue.



---

archive/issue_comments_691400.json:
```json
{
    "body": "Changing branch from \"\" to \"u/gh-io4/numerical_separators_behave_inconsistently\"",
    "created_at": "2022-12-03T06:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691400",
    "user": "https://github.com/io4"
}
```

Changing branch from "" to "u/gh-io4/numerical_separators_behave_inconsistently"



---

archive/issue_comments_691401.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-12-03T06:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691401",
    "user": "https://github.com/io4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_691402.json:
```json
{
    "body": "<a id='comment:4'></a>\nNew commits:\n|                                                                                                                                          |                                                                          |\n|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|\n|[7aac175](https://github.com/sagemath/sagetrac-mirror/commit/7aac17573027833982f6c5fe64ab66959cea4ccb)|`Remove numerical separators from RealLiterals to avoid conversion issues`|",
    "created_at": "2022-12-03T06:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691402",
    "user": "https://github.com/io4"
}
```

<a id='comment:4'></a>
New commits:
|                                                                                                                                          |                                                                          |
|------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------|
|[7aac175](https://github.com/sagemath/sagetrac-mirror/commit/7aac17573027833982f6c5fe64ab66959cea4ccb)|`Remove numerical separators from RealLiterals to avoid conversion issues`|



---

archive/issue_comments_691403.json:
```json
{
    "body": "Changing commit from \"\" to \"7aac17573027833982f6c5fe64ab66959cea4ccb\"",
    "created_at": "2022-12-03T06:33:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691403",
    "user": "https://github.com/io4"
}
```

Changing commit from "" to "7aac17573027833982f6c5fe64ab66959cea4ccb"



---

archive/issue_comments_691404.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-07T17:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691404",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_691405.json:
```json
{
    "body": "Changing author from \"\" to \"Lucas Fiegl\"",
    "created_at": "2022-12-07T17:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691405",
    "user": "https://github.com/mezzarobba"
}
```

Changing author from "" to "Lucas Fiegl"



---

archive/issue_comments_691406.json:
```json
{
    "body": "<a id='comment:5'></a>\nlgtm, thanks for the fix!",
    "created_at": "2022-12-07T17:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691406",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:5'></a>
lgtm, thanks for the fix!



---

archive/issue_comments_691407.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Marc Mezzarobba\"",
    "created_at": "2022-12-07T17:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691407",
    "user": "https://github.com/mezzarobba"
}
```

Changing reviewer from "" to "Marc Mezzarobba"



---

archive/issue_events_101224.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-12-14T22:12:10Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34819#event-101224"
}
```



---

archive/issue_comments_691408.json:
```json
{
    "body": "Changing branch from \"u/gh-io4/numerical_separators_behave_inconsistently\" to \"7aac17573027833982f6c5fe64ab66959cea4ccb\"",
    "created_at": "2022-12-14T22:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691408",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/gh-io4/numerical_separators_behave_inconsistently" to "7aac17573027833982f6c5fe64ab66959cea4ccb"



---

archive/issue_comments_691409.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-12-14T22:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34819",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34819#issuecomment-691409",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
