# Issue 34547: Interfaces: use more lazy imports, restore top-level functions maxima_console etc.

archive/issues_034310.json:
```json
{
    "body": "Various files in `sage/interfaces/` have this pattern:\n\n```\nclass Octave(...):\n    ....\n\noctave = Octave()\n```\nWhen combined with `from .octave import Octave, octave` in `sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34547\n\n",
    "created_at": "2022-09-16T22:38:07Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Interfaces: use more lazy imports, restore top-level functions maxima_console etc.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34547",
    "user": "https://github.com/jhpalmieri"
}
```
Various files in `sage/interfaces/` have this pattern:

```
class Octave(...):
    ....

octave = Octave()
```
When combined with `from .octave import Octave, octave` in `sage/interfaces/all.py`, this means that an instance of `Octave` is created when Sage starts up. I think we should avoid this with lazy imports.


Issue created by migration from https://trac.sagemath.org/ticket/34547





---

archive/issue_comments_486001.json:
```json
{
    "body": "+1",
    "created_at": "2022-09-16T22:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486001",
    "user": "https://github.com/mkoeppe"
}
```

+1



---

archive/issue_comments_486002.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-09-17T05:18:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486002",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_486003.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-17T05:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486003",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_486004.json:
```json
{
    "body": "Here is a first attempt. I'll mark it as ready for review, but I am certainly open to changes. If I made changes for the imports for `magma` and `polymake`, I got problems with pickling, so I have left those as they were before.",
    "created_at": "2022-09-17T05:21:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486004",
    "user": "https://github.com/jhpalmieri"
}
```

Here is a first attempt. I'll mark it as ready for review, but I am certainly open to changes. If I made changes for the imports for `magma` and `polymake`, I got problems with pickling, so I have left those as they were before.



---

archive/issue_comments_486005.json:
```json
{
    "body": "Regarding the change\n\n```\n-interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \\\n-              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \\\n-              'mathematica', 'mwrank', 'octave', 'r', \\\n-              'singular', 'sage0', 'sage']\n```\nDo we need to deprecate this before just removing it? I don't know what purpose it was supposed to serve, except perhaps it is the remnants of some old code that once looped through it.",
    "created_at": "2022-09-17T18:38:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486005",
    "user": "https://github.com/jhpalmieri"
}
```

Regarding the change

```
-interfaces = ['gap', 'gap3', 'giac', 'gp', 'mathematica', 'gnuplot', \
-              'kash', 'magma', 'macaulay2', 'maple', 'maxima', \
-              'mathematica', 'mwrank', 'octave', 'r', \
-              'singular', 'sage0', 'sage']
```
Do we need to deprecate this before just removing it? I don't know what purpose it was supposed to serve, except perhaps it is the remnants of some old code that once looped through it.



---

archive/issue_comments_486006.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-09-17T18:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486006",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_486007.json:
```json
{
    "body": "Where do the \".all\" namespaces actually get used and for what? Are they just to trigger initialization of modules? Or do people use them to access symbols too? They certainly be *importing* symbols from them. Especially with lazy imports, that leads to undesirable side-effects (see e.g. #16522):\n\n```\nsage: type(maxima_calculus)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: type(sage.calculus.calculus.maxima)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: sage.calculus.calculus.maxima is maxima_calculus  # they are the same object\nTrue\nsage: maxima_calculus(1)\n1\nsage: type(maxima_calculus)\n<class 'sage.misc.lazy_import.LazyImport'>\nsage: type(sage.calculus.calculus.maxima)\n<class 'sage.interfaces.maxima_lib.MaximaLib'>\n```\nSo as you can see, we end up with a `LazyImport` object bound in two places. Calling it removes one of the shims but not the other (it can't! it doesn't have a reference to the relevant namespace!).\nThis object rebinding is only tried upon the first resolution of the lazy object, but it does mean that the shim in the wrong location stays in place (and these shims are not perfect replacements for their objects)\n\nThe delayed instantiation of interfaces is laudable but, as you can see, can introduce new problems. What *does* work is lazy importing the object *where you need it*, but I'm not so sure we need these objects at the 'all' level. Certainly the `from <...>.all import *` done in `sage.all` propagates this problem. The tool `clean_namespace` at [the branch at #16522](https://git.sagemath.org/sage.git/commit/?id=419e8cbcea8ddc94ea5740625656d1a9ec09b6ee) can clean it up after import ...",
    "created_at": "2022-09-18T01:51:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486007",
    "user": "https://github.com/nbruin"
}
```

Where do the ".all" namespaces actually get used and for what? Are they just to trigger initialization of modules? Or do people use them to access symbols too? They certainly be *importing* symbols from them. Especially with lazy imports, that leads to undesirable side-effects (see e.g. #16522):

```
sage: type(maxima_calculus)
<class 'sage.misc.lazy_import.LazyImport'>
sage: type(sage.calculus.calculus.maxima)
<class 'sage.misc.lazy_import.LazyImport'>
sage: sage.calculus.calculus.maxima is maxima_calculus  # they are the same object
True
sage: maxima_calculus(1)
1
sage: type(maxima_calculus)
<class 'sage.misc.lazy_import.LazyImport'>
sage: type(sage.calculus.calculus.maxima)
<class 'sage.interfaces.maxima_lib.MaximaLib'>
```
So as you can see, we end up with a `LazyImport` object bound in two places. Calling it removes one of the shims but not the other (it can't! it doesn't have a reference to the relevant namespace!).
This object rebinding is only tried upon the first resolution of the lazy object, but it does mean that the shim in the wrong location stays in place (and these shims are not perfect replacements for their objects)

The delayed instantiation of interfaces is laudable but, as you can see, can introduce new problems. What *does* work is lazy importing the object *where you need it*, but I'm not so sure we need these objects at the 'all' level. Certainly the `from <...>.all import *` done in `sage.all` propagates this problem. The tool `clean_namespace` at [the branch at #16522](https://git.sagemath.org/sage.git/commit/?id=419e8cbcea8ddc94ea5740625656d1a9ec09b6ee) can clean it up after import ...



---

archive/issue_comments_486008.json:
```json
{
    "body": "Replying to [comment:8 Nils Bruin]:\n> Where do the \".all\" namespaces actually get used and for what? Are they just to trigger initialization of modules? \n\n\n`sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.",
    "created_at": "2022-09-18T04:01:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486008",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:8 Nils Bruin]:
> Where do the ".all" namespaces actually get used and for what? Are they just to trigger initialization of modules? 


`sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.



---

archive/issue_comments_486009.json:
```json
{
    "body": "Right now, `git grep \"from.*interfaces.all.*import\" src/sage` only reveals the import in `sage.all`. There are a few matches for `git grep \"import.*interfaces.all\" src/sage`.",
    "created_at": "2022-09-18T05:40:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486009",
    "user": "https://github.com/jhpalmieri"
}
```

Right now, `git grep "from.*interfaces.all.*import" src/sage` only reveals the import in `sage.all`. There are a few matches for `git grep "import.*interfaces.all" src/sage`.



---

archive/issue_comments_486010.json:
```json
{
    "body": "Maybe we need to keep the one in `src/sage/repl/interface_magic.py`?",
    "created_at": "2022-09-18T05:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486010",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe we need to keep the one in `src/sage/repl/interface_magic.py`?



---

archive/issue_comments_486011.json:
```json
{
    "body": "Replying to [comment:9 Matthias K\u00f6ppe]:\n> Replying to [comment:8 Nils Bruin]:\n> > Where do the \".all\" namespaces actually get used and for what? Are they just to trigger initialization of modules? \n\n> \n> `sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.\n\n\nAh, OK, so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to build the global namespace piecemeal and recreate appropriate `LazyImport` objects rather than just referencing them, or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.\n\nOne reason to ensure `LazyImport` shims don't stay lying around, especially at top level, is that documentation is only partially transparently reported. Compare:\n\n```\nsage: sage.calculus.calculus.maxima? # reports doc but with wrong type, signature, and source file\nsage: sage.calculus.calculus.maxima? # second time is OK\n```\n\nversus\n\n```\nsage: maxima_calculus? # never gets type, signature, and source file right\n```\n\nNote:\n\n```\nsage: maxima_calculus?? # finds source but is still missing type and signature\n```",
    "created_at": "2022-09-18T17:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486011",
    "user": "https://github.com/nbruin"
}
```

Replying to [comment:9 Matthias Köppe]:
> Replying to [comment:8 Nils Bruin]:
> > Where do the ".all" namespaces actually get used and for what? Are they just to trigger initialization of modules? 

> 
> `sage.interfaces` is a namespace package, so we're getting rid of imports from `sage.interfaces.all` within the Sage library, see #34201. When this is done, all that will remain is the reimport into `sage.all`, to fill the interactive top level as the only purpose.


Ah, OK, so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to build the global namespace piecemeal and recreate appropriate `LazyImport` objects rather than just referencing them, or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.

One reason to ensure `LazyImport` shims don't stay lying around, especially at top level, is that documentation is only partially transparently reported. Compare:

```
sage: sage.calculus.calculus.maxima? # reports doc but with wrong type, signature, and source file
sage: sage.calculus.calculus.maxima? # second time is OK
```

versus

```
sage: maxima_calculus? # never gets type, signature, and source file right
```

Note:

```
sage: maxima_calculus?? # finds source but is still missing type and signature
```



---

archive/issue_comments_486012.json:
```json
{
    "body": "Replying to [comment:12 Nils Bruin]:\n> so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to [...] or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.\n\n\nThanks for the pointer to #16522. I haven't looked at the details, but this sounds promising.",
    "created_at": "2022-09-18T18:15:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486012",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:12 Nils Bruin]:
> so our current infrastructure actually guarantees that `LazyImport`s in `sage.all` end up broken in the toplevel. Possible fixes would be to [...] or just do the copy and then clean them up with something like `clean_namespace` (see #16522). The latter is much easier to implement. It looks like cleaning `sage.all` and the toplevel namespace upon construction would give us a lot of benefit for relatively low effort.


Thanks for the pointer to #16522. I haven't looked at the details, but this sounds promising.



---

archive/issue_comments_486013.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-18T20:10:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486013",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486014.json:
```json
{
    "body": "Is this branch okay, or do we need to do something to accommodate #16522?",
    "created_at": "2022-12-03T22:07:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486014",
    "user": "https://github.com/jhpalmieri"
}
```

Is this branch okay, or do we need to do something to accommodate #16522?



---

archive/issue_comments_486015.json:
```json
{
    "body": "Are these changes:\n\n```\n--- a/src/sage/interfaces/axiom.py\n+++ b/src/sage/interfaces/axiom.py\n@@ -490,7 +490,7 @@ class Axiom(PanAxiom):\n         \"\"\"\n         EXAMPLES::\n \n-            sage: axiom.__reduce__()\n+            sage: Axiom().__reduce__()\n             (<function reduce_load_Axiom at 0x...>, ())\n```\nneeded because of #16522?",
    "created_at": "2022-12-05T19:06:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486015",
    "user": "https://github.com/mkoeppe"
}
```

Are these changes:

```
--- a/src/sage/interfaces/axiom.py
+++ b/src/sage/interfaces/axiom.py
@@ -490,7 +490,7 @@ class Axiom(PanAxiom):
         """
         EXAMPLES::
 
-            sage: axiom.__reduce__()
+            sage: Axiom().__reduce__()
             (<function reduce_load_Axiom at 0x...>, ())
```
needed because of #16522?



---

archive/issue_comments_486016.json:
```json
{
    "body": "I see the following with this branch:\n\n```\nsage: axiom.__reduce__\n<built-in method __reduce__ of sage.misc.lazy_import.LazyImport object at 0x19a6991c0>\nsage: Axiom().__reduce__\n<bound method Axiom.__reduce__ of Axiom>\nsage: axiom.__reduce__()\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\nCell In [7], line 1\n----> 1 axiom.__reduce__()\n\nFile /usr/local/Cellar/python@3.10/3.10.8/Frameworks/Python.framework/Versions/3.10/lib/python3.10/copyreg.py:76, in _reduce_ex(self, proto)\n     74 else:\n     75     if base is cls:\n---> 76         raise TypeError(f\"cannot pickle {cls.__name__!r} object\")\n     77     state = base(self)\n     78 args = (cls, base, state)\n\nTypeError: cannot pickle 'LazyImport' object\nsage: Axiom().__reduce__()\n(<function reduce_load_Axiom at 0x19d557c70>, ())\n```\nI don't understand why this change is necessary.",
    "created_at": "2022-12-05T20:36:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486016",
    "user": "https://github.com/jhpalmieri"
}
```

I see the following with this branch:

```
sage: axiom.__reduce__
<built-in method __reduce__ of sage.misc.lazy_import.LazyImport object at 0x19a6991c0>
sage: Axiom().__reduce__
<bound method Axiom.__reduce__ of Axiom>
sage: axiom.__reduce__()
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
Cell In [7], line 1
----> 1 axiom.__reduce__()

File /usr/local/Cellar/python@3.10/3.10.8/Frameworks/Python.framework/Versions/3.10/lib/python3.10/copyreg.py:76, in _reduce_ex(self, proto)
     74 else:
     75     if base is cls:
---> 76         raise TypeError(f"cannot pickle {cls.__name__!r} object")
     77     state = base(self)
     78 args = (cls, base, state)

TypeError: cannot pickle 'LazyImport' object
sage: Axiom().__reduce__()
(<function reduce_load_Axiom at 0x19d557c70>, ())
```
I don't understand why this change is necessary.



---

archive/issue_comments_486017.json:
```json
{
    "body": "Maybe it is #16522.",
    "created_at": "2022-12-05T20:37:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486017",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe it is #16522.



---

archive/issue_comments_486018.json:
```json
{
    "body": "Yes, I think this should be solved via #16522 instead of working around it in the doctests",
    "created_at": "2022-12-05T21:01:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486018",
    "user": "https://github.com/mkoeppe"
}
```

Yes, I think this should be solved via #16522 instead of working around it in the doctests



---

archive/issue_comments_486019.json:
```json
{
    "body": "I don't think #16522 will prevent this problem: I don't think special methods like `__reduce__`, which are present of `LazyImport` objects, trigger resolution. According to [https://docs.python.org/3/reference/datamodel.html#object.__getattr__](https://docs.python.org/3/reference/datamodel.html#object.__getattr__), the `__getattr__` method, which is the one `LazyImport` uses, only gets invoked when normal attribute lookup fails.\n\nThis is why most slot methods are separately wrapped to trigger resolution, because these would never fail.",
    "created_at": "2022-12-05T22:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486019",
    "user": "https://github.com/nbruin"
}
```

I don't think #16522 will prevent this problem: I don't think special methods like `__reduce__`, which are present of `LazyImport` objects, trigger resolution. According to [https://docs.python.org/3/reference/datamodel.html#object.__getattr__](https://docs.python.org/3/reference/datamodel.html#object.__getattr__), the `__getattr__` method, which is the one `LazyImport` uses, only gets invoked when normal attribute lookup fails.

This is why most slot methods are separately wrapped to trigger resolution, because these would never fail.



---

archive/issue_comments_486020.json:
```json
{
    "body": "The `__reduce__` doctests look pretty artificial. Would there be more meaningful ones that we could use as replacements?",
    "created_at": "2022-12-05T22:55:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486020",
    "user": "https://github.com/jhpalmieri"
}
```

The `__reduce__` doctests look pretty artificial. Would there be more meaningful ones that we could use as replacements?



---

archive/issue_comments_486021.json:
```json
{
    "body": "By the way, an alternate approach to this ticket would be to remove the top-level imports of some of these packages altogether: make users explicitly import them when needed. Potentially affected packages, all from `src/interfaces`:\n- axiom\n- ecm\n- 4ti2\n- fricas\n- frobby\n- gap3\n- genus2reduction\n- gfan\n- giac (pexpect interface)\n- gnuplot\n- kash\n- lie\n- lisp\n- macaulay2\n- magma (not currently changed by this ticket)\n- magma_free\n- maple\n- mathematica\n- mathics\n- matlab\n- mupad\n- mwrank\n- octave\n- polymake (not currently changed by this ticket)\n- povray\n- psage\n- qepcad\n- qsieve\n- r\n- read_data\n- scilab\n- tachyon\nThese do not have to be treated all the same, of course.",
    "created_at": "2022-12-12T18:54:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486021",
    "user": "https://github.com/jhpalmieri"
}
```

By the way, an alternate approach to this ticket would be to remove the top-level imports of some of these packages altogether: make users explicitly import them when needed. Potentially affected packages, all from `src/interfaces`:
- axiom
- ecm
- 4ti2
- fricas
- frobby
- gap3
- genus2reduction
- gfan
- giac (pexpect interface)
- gnuplot
- kash
- lie
- lisp
- macaulay2
- magma (not currently changed by this ticket)
- magma_free
- maple
- mathematica
- mathics
- matlab
- mupad
- mwrank
- octave
- polymake (not currently changed by this ticket)
- povray
- psage
- qepcad
- qsieve
- r
- read_data
- scilab
- tachyon
These do not have to be treated all the same, of course.



---

archive/issue_comments_486022.json:
```json
{
    "body": "Replying to [comment:20 Nils Bruin]:\n> I don't think #16522 will prevent this problem\n\n\nYou are right.",
    "created_at": "2022-12-18T20:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486022",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:20 Nils Bruin]:
> I don't think #16522 will prevent this problem


You are right.



---

archive/issue_comments_486023.json:
```json
{
    "body": "LGTM.",
    "created_at": "2022-12-18T20:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486023",
    "user": "https://github.com/mkoeppe"
}
```

LGTM.



---

archive/issue_comments_486024.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-18T20:54:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486024",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_486025.json:
```json
{
    "body": "But maybe we should also take care of these ones in the same ticket:\n\n```\n        from .axiom import axiom_console\n        from .fricas import fricas_console\n        from .gap import gap_console\n...\n```",
    "created_at": "2022-12-18T20:58:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486025",
    "user": "https://github.com/mkoeppe"
}
```

But maybe we should also take care of these ones in the same ticket:

```
        from .axiom import axiom_console
        from .fricas import fricas_console
        from .gap import gap_console
...
```



---

archive/issue_comments_486026.json:
```json
{
    "body": "Can you explain when those imports are triggered? I see this with vanilla Sage:\n\n```\nsage: from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager\nsage: _get_display_manager().is_in_terminal()\nTrue\nsage: axiom_console()\n---------------------------------------------------------------------------\nNameError                                 Traceback (most recent call last)\nCell In [5], line 1\n----> 1 axiom_console()\n\nNameError: name 'axiom_console' is not defined\nsage: gap_console()\n---------------------------------------------------------------------------\nNameError                                 Traceback (most recent call last)\nCell In [7], line 1\n----> 1 gap_console()\n\nNameError: name 'gap_console' is not defined\n```",
    "created_at": "2022-12-19T02:37:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486026",
    "user": "https://github.com/jhpalmieri"
}
```

Can you explain when those imports are triggered? I see this with vanilla Sage:

```
sage: from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager
sage: _get_display_manager().is_in_terminal()
True
sage: axiom_console()
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Cell In [5], line 1
----> 1 axiom_console()

NameError: name 'axiom_console' is not defined
sage: gap_console()
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Cell In [7], line 1
----> 1 gap_console()

NameError: name 'gap_console' is not defined
```



---

archive/issue_comments_486027.json:
```json
{
    "body": "They are supposed to be defined in terminal sessions. But they are missing already in 9.8.beta5",
    "created_at": "2022-12-19T06:55:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486027",
    "user": "https://github.com/mkoeppe"
}
```

They are supposed to be defined in terminal sessions. But they are missing already in 9.8.beta5



---

archive/issue_comments_486028.json:
```json
{
    "body": "At the time of importing the module, _get_display_manager() returns \"The Sage display manager using the simple backend simple\".",
    "created_at": "2022-12-19T07:03:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486028",
    "user": "https://github.com/mkoeppe"
}
```

At the time of importing the module, _get_display_manager() returns "The Sage display manager using the simple backend simple".



---

archive/issue_comments_486029.json:
```json
{
    "body": "Not sure what change broke this; perhaps a recent upgrade ipython.\n\nI think we can just unconditionally lazy_import these functions",
    "created_at": "2022-12-19T07:19:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486029",
    "user": "https://github.com/mkoeppe"
}
```

Not sure what change broke this; perhaps a recent upgrade ipython.

I think we can just unconditionally lazy_import these functions



---

archive/issue_comments_486030.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:",
    "created_at": "2022-12-19T17:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486030",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:



---

archive/issue_comments_486031.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2022-12-19T17:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486031",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_486032.json:
```json
{
    "body": "Here is a branch that lazily imports all of these. The other option would be just to delete them.",
    "created_at": "2022-12-19T18:02:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486032",
    "user": "https://github.com/jhpalmieri"
}
```

Here is a branch that lazily imports all of these. The other option would be just to delete them.



---

archive/issue_comments_486033.json:
```json
{
    "body": "This is still conditionalizing these imports. I think we should just remove the test `if _get_display_manager().is_in_terminal()` and always lazy_import these bindings",
    "created_at": "2022-12-19T22:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486033",
    "user": "https://github.com/mkoeppe"
}
```

This is still conditionalizing these imports. I think we should just remove the test `if _get_display_manager().is_in_terminal()` and always lazy_import these bindings



---

archive/issue_comments_486034.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-20T00:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486034",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486035.json:
```json
{
    "body": "Let's try this.",
    "created_at": "2022-12-20T01:11:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486035",
    "user": "https://github.com/jhpalmieri"
}
```

Let's try this.



---

archive/issue_comments_486036.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-20T02:25:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486036",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_486037.json:
```json
{
    "body": "Thank you. The right place for these `*_console` imports is perhaps in `sage.all_cmdline`, but I can't get that to work.",
    "created_at": "2022-12-20T05:42:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486037",
    "user": "https://github.com/jhpalmieri"
}
```

Thank you. The right place for these `*_console` imports is perhaps in `sage.all_cmdline`, but I can't get that to work.



---

archive/issue_comments_486038.json:
```json
{
    "body": "No, it works. Should I make that change?",
    "created_at": "2022-12-20T05:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486038",
    "user": "https://github.com/jhpalmieri"
}
```

No, it works. Should I make that change?



---

archive/issue_comments_486039.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2022-12-20T05:44:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486039",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_486040.json:
```json
{
    "body": "(Commands like `gap_console` do not work in the Jupyter notebook.)",
    "created_at": "2022-12-20T05:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486040",
    "user": "https://github.com/jhpalmieri"
}
```

(Commands like `gap_console` do not work in the Jupyter notebook.)



---

archive/issue_comments_486041.json:
```json
{
    "body": "You may recall that lazy_import of non-function objects can lead to very unexpected outcomes. It may be the case that with these _console objects this is less problematic, because people will likely not be interested in its id or its hash (or its identity in general), but I think you need to have a good reason to use it anyway. Would much be lost if these _console objects were *not* available from `interfaces`?\n\nBy the way, note that the creation of the `Octave()` instance does *not* involve creating the process. That only happens once there's actually interaction with it. So it may well be that the cost of creating these console objects is actually pretty low. There may still be an argument to not create them by default, but I suspect the real reason for that is closer to a reason for not having these default instances in the first place.",
    "created_at": "2022-12-20T06:26:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486041",
    "user": "https://github.com/nbruin"
}
```

You may recall that lazy_import of non-function objects can lead to very unexpected outcomes. It may be the case that with these _console objects this is less problematic, because people will likely not be interested in its id or its hash (or its identity in general), but I think you need to have a good reason to use it anyway. Would much be lost if these _console objects were *not* available from `interfaces`?

By the way, note that the creation of the `Octave()` instance does *not* involve creating the process. That only happens once there's actually interaction with it. So it may well be that the cost of creating these console objects is actually pretty low. There may still be an argument to not create them by default, but I suspect the real reason for that is closer to a reason for not having these default instances in the first place.



---

archive/issue_comments_486042.json:
```json
{
    "body": "Maybe I\u2019m misunderstanding, but aren\u2019t these `console` objects actually functions? So it should be okay to lazily import them. (I didn\u2019t check all of them, but all of the ones I checked are functions.)",
    "created_at": "2022-12-20T07:15:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486042",
    "user": "https://github.com/jhpalmieri"
}
```

Maybe I’m misunderstanding, but aren’t these `console` objects actually functions? So it should be okay to lazily import them. (I didn’t check all of them, but all of the ones I checked are functions.)



---

archive/issue_comments_486043.json:
```json
{
    "body": "Apologies, indeed, the \"*_console\" objects are just functions that, in the terminal, just starts a fresh process; as far as I can see simply as a \"subshell\": it just executes \"os.system(cmd)\". I think it's very rare current usage of sage would use that and it's easily replicated by other means, so I'd expect the \"*_console\" routines can just go.\n\nIn fact, as it stands, they are not available in my global namespace! So somehow:\n\n```\ntry:\n    from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager\nexcept ImportError:\n    pass\nelse:\n    if _get_display_manager().is_in_terminal():\n        [BLOCK]\n```\nmust have led to not executing [BLOCK], even though on the IPython command line `is_in_terminal` does return true and the import succeeds as well. Perhaps during initialization one of these things works differently?\n\nMy concern was for the interface objects themselves (the \"magma\" and \"octave\" instances): those are not just functions. They're actually instances of a quite complicated class. \nThey're obviously written to be quite light-weight (only initializing the expect interface if they're called) so you may want to do some timings to see if making them lazy actually saves anything measurable.",
    "created_at": "2022-12-20T19:30:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486043",
    "user": "https://github.com/nbruin"
}
```

Apologies, indeed, the "*_console" objects are just functions that, in the terminal, just starts a fresh process; as far as I can see simply as a "subshell": it just executes "os.system(cmd)". I think it's very rare current usage of sage would use that and it's easily replicated by other means, so I'd expect the "*_console" routines can just go.

In fact, as it stands, they are not available in my global namespace! So somehow:

```
try:
    from sage.repl.rich_output.display_manager import get_display_manager as _get_display_manager
except ImportError:
    pass
else:
    if _get_display_manager().is_in_terminal():
        [BLOCK]
```
must have led to not executing [BLOCK], even though on the IPython command line `is_in_terminal` does return true and the import succeeds as well. Perhaps during initialization one of these things works differently?

My concern was for the interface objects themselves (the "magma" and "octave" instances): those are not just functions. They're actually instances of a quite complicated class. 
They're obviously written to be quite light-weight (only initializing the expect interface if they're called) so you may want to do some timings to see if making them lazy actually saves anything measurable.



---

archive/issue_comments_486044.json:
```json
{
    "body": "Replying to [comment:36 John Palmieri]:\n> The right place for these `*_console` imports is perhaps in `sage.all_cmdline`\n\n\nI think that's a good solution. \n\nI don't think we need to be concerned about use of these functions in user code that would try to import them from sage.interfaces.all.",
    "created_at": "2022-12-20T20:11:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486044",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:36 John Palmieri]:
> The right place for these `*_console` imports is perhaps in `sage.all_cmdline`


I think that's a good solution. 

I don't think we need to be concerned about use of these functions in user code that would try to import them from sage.interfaces.all.



---

archive/issue_comments_486045.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-12-20T20:46:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486045",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_486046.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2022-12-20T20:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486046",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_486047.json:
```json
{
    "body": "I have not been able to do any meaningful timings. I tried running `sage --startuptime` multiple times, and at first I saw faster times with the changes on this ticket, but as I repeated the timings, the differences seemed to go away (and `sage --startuptime` reported slightly longer times the more I ran it).",
    "created_at": "2022-12-20T20:50:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486047",
    "user": "https://github.com/jhpalmieri"
}
```

I have not been able to do any meaningful timings. I tried running `sage --startuptime` multiple times, and at first I saw faster times with the changes on this ticket, but as I repeated the timings, the differences seemed to go away (and `sage --startuptime` reported slightly longer times the more I ran it).



---

archive/issue_comments_486048.json:
```json
{
    "body": "I also wouldn't object to just removing the top-level imports for the `*_console` functions. I don't remember seeing any complaints about their being broken.",
    "created_at": "2022-12-20T21:30:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486048",
    "user": "https://github.com/jhpalmieri"
}
```

I also wouldn't object to just removing the top-level imports for the `*_console` functions. I don't remember seeing any complaints about their being broken.



---

archive/issue_comments_486049.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-20T22:08:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486049",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_486050.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2022-12-21T19:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486050",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_486051.json:
```json
{
    "body": "Build & Test shows failures:\n\n```\nFile \"sage/misc/session.pyx\", line 12, in sage.misc.session\nFailed example:\n    show_identifiers()\nExpected:\n    ['w']\nGot:\n    ['axiom_console',\n     'fricas_console',\n     'gap3_console',\n     'gap_console',\n     'giac_console',\n     'gnuplot_console',\n     'gp_console',\n     'kash_console',\n     'lie_console',\n     'macaulay2_console',\n     'magma_console',\n     'maple_console',\n     'mathematica_console',\n     'mathics_console',\n     'matlab_console',\n     'maxima_console',\n     'mupad_console',\n     'mwrank_console',\n     'octave_console',\n     'pkg',\n     'qepcad_console',\n     'r_console',\n     'sage0_console',\n     'singular_console',\n     'w']\n```",
    "created_at": "2022-12-21T19:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486051",
    "user": "https://github.com/mkoeppe"
}
```

Build & Test shows failures:

```
File "sage/misc/session.pyx", line 12, in sage.misc.session
Failed example:
    show_identifiers()
Expected:
    ['w']
Got:
    ['axiom_console',
     'fricas_console',
     'gap3_console',
     'gap_console',
     'giac_console',
     'gnuplot_console',
     'gp_console',
     'kash_console',
     'lie_console',
     'macaulay2_console',
     'magma_console',
     'maple_console',
     'mathematica_console',
     'mathics_console',
     'matlab_console',
     'maxima_console',
     'mupad_console',
     'mwrank_console',
     'octave_console',
     'pkg',
     'qepcad_console',
     'r_console',
     'sage0_console',
     'singular_console',
     'w']
```



---

archive/issue_comments_486052.json:
```json
{
    "body": "One of the failures can be avoided by deleting the loop variable `pkg` at the end. For the others, should we change the doctests?",
    "created_at": "2022-12-21T21:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486052",
    "user": "https://github.com/jhpalmieri"
}
```

One of the failures can be avoided by deleting the loop variable `pkg` at the end. For the others, should we change the doctests?



---

archive/issue_comments_486053.json:
```json
{
    "body": "Oh, I see, we can just move `sage.misc.session.init()` after the lazy imports.",
    "created_at": "2022-12-21T21:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486053",
    "user": "https://github.com/jhpalmieri"
}
```

Oh, I see, we can just move `sage.misc.session.init()` after the lazy imports.



---

archive/issue_comments_486054.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-12-21T23:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486054",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_486055.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-12-22T01:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486055",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_486056.json:
```json
{
    "body": "This works for me.",
    "created_at": "2022-12-22T01:02:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486056",
    "user": "https://github.com/jhpalmieri"
}
```

This works for me.



---

archive/issue_comments_486057.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-22T03:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34547#issuecomment-486057",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.
