# Issue 34117: Segfault for prime_pi on macOS

archive/issues_033880.json:
```json
{
    "assignees": [],
    "body": "With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.\n\n```\nsage: prime_pi(16000)                                                           \n1862\nsage: prime_pi(15000)                                                           \nUnhandled SIGSEGV: A segmentation fault occurred.\n```\n\nOriginally found from\n\n```\nsage: K = CyclotomicField(5)\nsage: A = matrix(K, [[1, 2], [3, 4]])\nsage: A.charpoly()\n[...]\nUnhandled SIGSEGV: A segmentation fault occurred.\n```\nThis problem seems specific to `CyclotomicFields` and does not occur for `QuadraticFields` or even `NumberFields` that are obviously isomorphic to a `CyclotomicField`. There is specialized code in the cyclotomic case, in `sage.matrix.matrix_cyclo_dense.pyx:_charpoly_multimodular`:\n\n```\nsage: K = CyclotomicField(5)\nsage: A = matrix(K, [[1, 2], [3, 4]])\nsage: A._charpoly_multimodular()\n[...]\nUnhandled SIGSEGV: A segmentation fault occurred.\n```\n\n\nThis problem does not occur with Sage 9.6 on Linux, but does manifest in Sage 9.5 on macOS.\n\n\n\nSee also [https://github.com/3-manifolds/Sage_macOS/issues/43](https://github.com/3-manifolds/Sage_macOS/issues/43).\n\nCC:  @culler @dimpase\n\nReviewer: **Dima Pasechnik**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34117_\n\n",
    "closed_at": "2022-07-14T13:43:27Z",
    "created_at": "2022-07-05T20:50:25Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/bug",
        "https://github.com/sagemath/sage/labels/component%3A%20number%20fields",
        "https://github.com/sagemath/sage/labels/invalid"
    ],
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "Segfault for prime_pi on macOS",
    "type": "issue",
    "updated_at": "2022-07-14T13:43:27Z",
    "url": "https://github.com/sagemath/sage/issues/34117",
    "user": "https://github.com/NathanDunfield"
}
```
With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.

```
sage: prime_pi(16000)                                                           
1862
sage: prime_pi(15000)                                                           
Unhandled SIGSEGV: A segmentation fault occurred.
```

Originally found from

```
sage: K = CyclotomicField(5)
sage: A = matrix(K, [[1, 2], [3, 4]])
sage: A.charpoly()
[...]
Unhandled SIGSEGV: A segmentation fault occurred.
```
This problem seems specific to `CyclotomicFields` and does not occur for `QuadraticFields` or even `NumberFields` that are obviously isomorphic to a `CyclotomicField`. There is specialized code in the cyclotomic case, in `sage.matrix.matrix_cyclo_dense.pyx:_charpoly_multimodular`:

```
sage: K = CyclotomicField(5)
sage: A = matrix(K, [[1, 2], [3, 4]])
sage: A._charpoly_multimodular()
[...]
Unhandled SIGSEGV: A segmentation fault occurred.
```


This problem does not occur with Sage 9.6 on Linux, but does manifest in Sage 9.5 on macOS.



See also [https://github.com/3-manifolds/Sage_macOS/issues/43](https://github.com/3-manifolds/Sage_macOS/issues/43).

CC:  @culler @dimpase

Reviewer: **Dima Pasechnik**

_Issue created by migration from https://trac.sagemath.org/ticket/34117_





---

archive/issue_events_448639.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2022-07-05T20:50:25Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448639"
}
```



---

archive/issue_events_448640.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2022-07-05T20:50:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20number%20fields",
    "label_color": "0000ff",
    "label_name": "component: number fields",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448640"
}
```



---

archive/issue_events_448641.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2022-07-05T20:50:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448641"
}
```



---

archive/issue_events_448642.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2022-07-05T20:50:25Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448642"
}
```



---

archive/issue_comments_553918.json:
```json
{
    "body": "<div id=\"comment:1\" align=\"right\">Comment 1</div>\n\nFWIW, I am not getting a crash with 9.7b3 on macOS 11.5.2. The answer `x^2 - 5*x - 2` is returned almost immediately.",
    "created_at": "2022-07-05T21:06:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553918",
    "user": "https://github.com/DaveWitteMorris"
}
```

<div id="comment:1" align="right">Comment 1</div>

FWIW, I am not getting a crash with 9.7b3 on macOS 11.5.2. The answer `x^2 - 5*x - 2` is returned almost immediately.



---

archive/issue_comments_553919.json:
```json
{
    "body": "<div id=\"comment:2\" align=\"right\">Comment 2</div>\n\nUnfortunately, with my x86_64 build of Sage 9.7.beta3 on macOS, which uses no Homebrew or other external libraries, I am seeing the same crash as with 9.6.  And since cysignals prevents generation of a crash log I do not currently know where the crash occurs.",
    "created_at": "2022-07-07T03:57:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553919",
    "user": "https://github.com/culler"
}
```

<div id="comment:2" align="right">Comment 2</div>

Unfortunately, with my x86_64 build of Sage 9.7.beta3 on macOS, which uses no Homebrew or other external libraries, I am seeing the same crash as with 9.6.  And since cysignals prevents generation of a crash log I do not currently know where the crash occurs.



---

archive/issue_comments_553920.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">Comment 3</div>\n\nThis crash occurs in primecount.  A stack trace is shown below.\n\nIndeed, on both Sage 9.6 and 9.7.beta3 the following command produces a segfault:\n\n```\nsage: prime_pi(5)\n```\n\n(EDITED) Also, passing a large value to prime_pi does not produce a segfault, as one might guess from the fact that the crash occurs in pi_cache\"\n\n\n```\nsage: prime_pi(1000000)\n78498\n```\n\nAccording to the \"Counting Primes\" documentation page:\\\\\n  Dima Pasechnik (2021): removed buggy cython code, replaced it with calls to\\\\\n  primecount/primecountpy spkg\n\nIn order to obtain the stack trace below I patched cysignals to make it not catch the SIG_SEGV signal.  While I agree with all of the invective in the cysignals code about how Apple screwed things up by requiring extra permissions to use a debugger, I do not agree with the way cysignals handled this screw-up.  While it is not possible for sage to run gdb to generate a stack trace after a segfualt, if the segfault is processed by Apple's handler, instead of cysignals' no-op handler, at least a crash dump is logged (sometimes).  An unreliable crash dump is a huge improvement over an immediate exit with no information.  So I think cysignals should stop handling SIG_SEGV on macOS.\n\n```\n0   libprimecount.7.1.dylib       \t0x000000015b841550 primecount::pi_cache(long long, bool) + 0\n1   primecount.cpython-310-darwin.so\t0x000000015b801ab5 0x15b7fc000 + 23221\n2   primecount.cpython-310-darwin.so\t0x000000015b801510 0x15b7fc000 + 21776\n3   multi_modular.cpython-310-darwin.so\t0x000000015b0ad097 0x15b0a4000 + 37015\n4   multi_modular.cpython-310-darwin.so\t0x000000015b0aee6b 0x15b0a4000 + 44651\n5   libpython3.10.dylib           \t0x000000010d9f26d4 0x10d950000 + 665300\n6   matrix_integer_dense.cpython-310-darwin.so\t0x000000015abe3b47 0x15abe0000 + 15175\n7   matrix_integer_dense.cpython-310-darwin.so\t0x000000015abe5986 0x15abe0000 + 22918\n8   matrix_cyclo_dense.cpython-310-darwin.so\t0x000000015cf5c4d0 0x15cf34000 + 165072\n9   libpython3.10.dylib           \t0x000000010d9dce1a 0x10d950000 + 577050\n10  matrix_cyclo_dense.cpython-310-darwin.so\t0x000000015cf50a62 0x15cf34000 + 117346\n\n```",
    "created_at": "2022-07-07T14:16:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553920",
    "user": "https://github.com/culler"
}
```

<div id="comment:3" align="right">Comment 3</div>

This crash occurs in primecount.  A stack trace is shown below.

Indeed, on both Sage 9.6 and 9.7.beta3 the following command produces a segfault:

```
sage: prime_pi(5)
```

(EDITED) Also, passing a large value to prime_pi does not produce a segfault, as one might guess from the fact that the crash occurs in pi_cache"


```
sage: prime_pi(1000000)
78498
```

According to the "Counting Primes" documentation page:\\
  Dima Pasechnik (2021): removed buggy cython code, replaced it with calls to\\
  primecount/primecountpy spkg

In order to obtain the stack trace below I patched cysignals to make it not catch the SIG_SEGV signal.  While I agree with all of the invective in the cysignals code about how Apple screwed things up by requiring extra permissions to use a debugger, I do not agree with the way cysignals handled this screw-up.  While it is not possible for sage to run gdb to generate a stack trace after a segfualt, if the segfault is processed by Apple's handler, instead of cysignals' no-op handler, at least a crash dump is logged (sometimes).  An unreliable crash dump is a huge improvement over an immediate exit with no information.  So I think cysignals should stop handling SIG_SEGV on macOS.

```
0   libprimecount.7.1.dylib       	0x000000015b841550 primecount::pi_cache(long long, bool) + 0
1   primecount.cpython-310-darwin.so	0x000000015b801ab5 0x15b7fc000 + 23221
2   primecount.cpython-310-darwin.so	0x000000015b801510 0x15b7fc000 + 21776
3   multi_modular.cpython-310-darwin.so	0x000000015b0ad097 0x15b0a4000 + 37015
4   multi_modular.cpython-310-darwin.so	0x000000015b0aee6b 0x15b0a4000 + 44651
5   libpython3.10.dylib           	0x000000010d9f26d4 0x10d950000 + 665300
6   matrix_integer_dense.cpython-310-darwin.so	0x000000015abe3b47 0x15abe0000 + 15175
7   matrix_integer_dense.cpython-310-darwin.so	0x000000015abe5986 0x15abe0000 + 22918
8   matrix_cyclo_dense.cpython-310-darwin.so	0x000000015cf5c4d0 0x15cf34000 + 165072
9   libpython3.10.dylib           	0x000000010d9dce1a 0x10d950000 + 577050
10  matrix_cyclo_dense.cpython-310-darwin.so	0x000000015cf50a62 0x15cf34000 + 117346

```



---

archive/issue_events_448643.json:
```json
{
    "actor": "https://github.com/NathanDunfield",
    "created_at": "2022-07-07T15:43:19Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "title_is": "Segfault for prime_pi on macOS",
    "title_was": "Segfault for char polys of matrices over cyclotomic fields on macOS",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448643"
}
```



---

archive/issue_comments_553921.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n-With Sage 9.6 on macOS 11.6.5, I get:\n+With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.\n+\n+```\n+sage: prime_pi(16000)                                                           \n+1862\n+sage: prime_pi(15000)                                                           \n+Unhandled SIGSEGV: A segmentation fault occurred.\n+```\n+\n+Originally found from\n \n ```\n sage: K = CyclotomicField(5)\n``````\n",
    "created_at": "2022-07-07T15:43:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553921",
    "user": "https://github.com/NathanDunfield"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
-With Sage 9.6 on macOS 11.6.5, I get:
+With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.
+
+```
+sage: prime_pi(16000)                                                           
+1862
+sage: prime_pi(15000)                                                           
+Unhandled SIGSEGV: A segmentation fault occurred.
+```
+
+Originally found from
 
 ```
 sage: K = CyclotomicField(5)
``````




---

archive/issue_comments_553922.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">Comment 5</div>\n\nIn `PiTable.cpp` the static table PiTable::pi_t is a\n\n```\n/// Compressed PrimePi(x) lookup table for x < 64 * 240.\n```\n\nI note that 64*240 = 15360 lies between 15000 and 16000.  So it would appear that any lookup into that table produces a segfault.\n\nI also notice that the signature of py_cache allows passing negative indices into the table.\n\n```\nint64_t pi_cache(int64_t x, bool print = is_print());\n```\n\nOf course passing a negative value would produce a segfault regardless of the signature.\nHowever I notice that any negative value, even one with large absolute value like -1000000, produces a segfault.  So that suggests that all negative values are used directly as indices into the pi_cache table without checking the sign.  That seems unwise.",
    "created_at": "2022-07-07T16:37:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553922",
    "user": "https://github.com/culler"
}
```

<div id="comment:5" align="right">Comment 5</div>

In `PiTable.cpp` the static table PiTable::pi_t is a

```
/// Compressed PrimePi(x) lookup table for x < 64 * 240.
```

I note that 64*240 = 15360 lies between 15000 and 16000.  So it would appear that any lookup into that table produces a segfault.

I also notice that the signature of py_cache allows passing negative indices into the table.

```
int64_t pi_cache(int64_t x, bool print = is_print());
```

Of course passing a negative value would produce a segfault regardless of the signature.
However I notice that any negative value, even one with large absolute value like -1000000, produces a segfault.  So that suggests that all negative values are used directly as indices into the pi_cache table without checking the sign.  That seems unwise.



---

archive/issue_comments_553923.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">Comment 6</div>\n\nThere is a question, when prime_pi(x) is called with x <= 0, whether it should raise a `ValueError` or return 0. The answer depends on whether you think that negative prime integers exist. And that depends on whether you think that the integers should be treated differently from other principle ideal domains.  For a definitive answer to that question, see\nhttps://primes.utm.edu/notes/faq/negative_primes.html\n\nMy opinion is that it should return 0 and that the docstring should be modified to read:\n\n```\nThe prime counting function, which counts the number of positive primes less\nthan or equal to a given value.\n```",
    "created_at": "2022-07-07T17:07:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553923",
    "user": "https://github.com/culler"
}
```

<div id="comment:6" align="right">Comment 6</div>

There is a question, when prime_pi(x) is called with x <= 0, whether it should raise a `ValueError` or return 0. The answer depends on whether you think that negative prime integers exist. And that depends on whether you think that the integers should be treated differently from other principle ideal domains.  For a definitive answer to that question, see
https://primes.utm.edu/notes/faq/negative_primes.html

My opinion is that it should return 0 and that the docstring should be modified to read:

```
The prime counting function, which counts the number of positive primes less
than or equal to a given value.
```



---

archive/issue_comments_553924.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">Comment 7</div>\n\nWhat version of primecount? (it can come from Homebrew or Conda, or built from source)\n\nAnd what C++/Xcode version?",
    "created_at": "2022-07-07T17:30:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553924",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:7" align="right">Comment 7</div>

What version of primecount? (it can come from Homebrew or Conda, or built from source)

And what C++/Xcode version?



---

archive/issue_comments_553925.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">Comment 8</div>\n\nCan you reproduce this with a standalone primecount executable?",
    "created_at": "2022-07-07T17:32:36Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553925",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:8" align="right">Comment 8</div>

Can you reproduce this with a standalone primecount executable?



---

archive/issue_comments_553926.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">Comment 9</div>\n\nif so, please do the upstream bug report",
    "created_at": "2022-07-07T17:33:42Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553926",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">Comment 9</div>

if so, please do the upstream bug report



---

archive/issue_comments_553927.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">Comment 10</div>\n\nI can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG",
    "created_at": "2022-07-07T18:17:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553927",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:10" align="right">Comment 10</div>

I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG



---

archive/issue_comments_553928.json:
```json
{
    "body": "Branch: **[u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)**",
    "created_at": "2022-07-07T19:01:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553928",
    "user": "https://github.com/mkoeppe"
}
```

Branch: **[u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)**



---

archive/issue_comments_553929.json:
```json
{
    "body": "Commit: **[6dea0a1](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)**",
    "created_at": "2022-07-07T19:01:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553929",
    "user": "https://github.com/mkoeppe"
}
```

Commit: **[6dea0a1](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)**



---

archive/issue_comments_553930.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">Comment 12</div>\n\nAnyway, here's an update to the most recent primesieve/primecount versions\n\n---\nNew commits:\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb48b63cb59e162058d46eb490149c37a86c12f5\">fb48b63</a></td><td><code>build/pkgs/primesieve: Update to 8.0</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c78d53b14c5bad682b272d442c2f9003d40e445f\">c78d53b</a></td><td><code>build/pkgs/primecount: Update to 7.4</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/670477064c809de277dd8f3678f76b6f123d2cf6\">6704770</a></td><td><code>build/pkgs/primecount/patches/sieve_version.patch: Remove</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e4f0d6bed7831c6718a2d4c34e2bcf70cbbed804\">e4f0d6b</a></td><td><code>build/pkgs/primecount/spkg-install.in: Use CMAKE_NO_SYSTEM_FROM_IMPORTED=ON</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de\">6dea0a1</a></td><td><code>build/pkgs/primesieve/spkg-configure.m4: Require >= 8.0</code></td></tr></table>\n",
    "created_at": "2022-07-07T19:01:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553930",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:12" align="right">Comment 12</div>

Anyway, here's an update to the most recent primesieve/primecount versions

---
New commits:
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb48b63cb59e162058d46eb490149c37a86c12f5">fb48b63</a></td><td><code>build/pkgs/primesieve: Update to 8.0</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c78d53b14c5bad682b272d442c2f9003d40e445f">c78d53b</a></td><td><code>build/pkgs/primecount: Update to 7.4</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/670477064c809de277dd8f3678f76b6f123d2cf6">6704770</a></td><td><code>build/pkgs/primecount/patches/sieve_version.patch: Remove</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e4f0d6bed7831c6718a2d4c34e2bcf70cbbed804">e4f0d6b</a></td><td><code>build/pkgs/primecount/spkg-install.in: Use CMAKE_NO_SYSTEM_FROM_IMPORTED=ON</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de">6dea0a1</a></td><td><code>build/pkgs/primesieve/spkg-configure.m4: Require >= 8.0</code></td></tr></table>




---

archive/issue_comments_553931.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">Comment 13</div>\n\nReplying to [@dimpase](#comment%3A7):\n> What version of primecount? (it can come from Homebrew or Conda, or built from source)\n\nAs I said, the build for the Sage_macOS binary distribution is very careful to use NO external libraries whatsoever.  Both primecount and primesieve and everything else, including gfortran, is built from source as provided in the Sage repository.\n\n```\nsage % cat build/pkgs/primecount/package-version.txt \n7.1\n```\n\n```\nsage % cat build/pkgs/primesieve/package-version.txt\n7.6\n```\n\n\n> \n> And what C++/Xcode version?\n\n\n```\n% xcodebuild -version \nXcode 13.2.1\nBuild version 13C100\n\n```\n\n```\n% gcc --version\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1\nApple clang version 13.0.0 (clang-1300.0.29.30)\nTarget: x86_64-apple-darwin20.6.0\nThread model: posix\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\n\n```",
    "created_at": "2022-07-07T19:21:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553931",
    "user": "https://github.com/culler"
}
```

<div id="comment:13" align="right">Comment 13</div>

Replying to [@dimpase](#comment%3A7):
> What version of primecount? (it can come from Homebrew or Conda, or built from source)

As I said, the build for the Sage_macOS binary distribution is very careful to use NO external libraries whatsoever.  Both primecount and primesieve and everything else, including gfortran, is built from source as provided in the Sage repository.

```
sage % cat build/pkgs/primecount/package-version.txt 
7.1
```

```
sage % cat build/pkgs/primesieve/package-version.txt
7.6
```


> 
> And what C++/Xcode version?


```
% xcodebuild -version 
Xcode 13.2.1
Build version 13C100

```

```
% gcc --version
Configured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
Apple clang version 13.0.0 (clang-1300.0.29.30)
Target: x86_64-apple-darwin20.6.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin

```



---

archive/issue_comments_553932.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">Comment 14</div>\n\nReplying to [@dimpase](#comment%3A8):\n> Can you reproduce this with a standalone primecount executable? \n\nNo. The standalone version works fine for me.  I used the current latest release, though, which is primecount 7.4 and primesieve 8.0.",
    "created_at": "2022-07-07T19:23:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553932",
    "user": "https://github.com/culler"
}
```

<div id="comment:14" align="right">Comment 14</div>

Replying to [@dimpase](#comment%3A8):
> Can you reproduce this with a standalone primecount executable? 

No. The standalone version works fine for me.  I used the current latest release, though, which is primecount 7.4 and primesieve 8.0.



---

archive/issue_comments_553933.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">Comment 15</div>\n\nReplying to [@mkoeppe](#comment%3A10):\n> I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG\n\nAre you using any Homebrew libraries for your build?",
    "created_at": "2022-07-07T19:27:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553933",
    "user": "https://github.com/culler"
}
```

<div id="comment:15" align="right">Comment 15</div>

Replying to [@mkoeppe](#comment%3A10):
> I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG

Are you using any Homebrew libraries for your build?



---

archive/issue_comments_553934.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">Comment 16</div>\n\nReplying to [@culler](#comment%3A15):\n> Replying to [@mkoeppe](#comment%3A10):\n> > I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG\n\n> \n> Are you using any Homebrew libraries for your build?\n\nYes, but primecount/primesieve have no dependencies",
    "created_at": "2022-07-07T19:28:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553934",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">Comment 16</div>

Replying to [@culler](#comment%3A15):
> Replying to [@mkoeppe](#comment%3A10):
> > I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG

> 
> Are you using any Homebrew libraries for your build?

Yes, but primecount/primesieve have no dependencies



---

archive/issue_comments_553935.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">Comment 17</div>\n\nReplying to [@mkoeppe](#comment%3A16):\n> > Are you using any Homebrew libraries for your build?\n\n> \n> Yes, but primecount/primesieve have no dependencies \n\nThey do link against `libc++`, so conceivably that could be a homebrew version rather than the system one.  With Marc's build, I see:\n\n```\n$ otool -L libprimecount.dylib\nlibprimecount.dylib:\n\t@rpath/libprimecount.7.1.dylib (compatibility version 7.0.0, current version 7.1.0)\n\t@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)\n\t/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1200.3.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)\n```",
    "created_at": "2022-07-07T22:13:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553935",
    "user": "https://github.com/NathanDunfield"
}
```

<div id="comment:17" align="right">Comment 17</div>

Replying to [@mkoeppe](#comment%3A16):
> > Are you using any Homebrew libraries for your build?

> 
> Yes, but primecount/primesieve have no dependencies 

They do link against `libc++`, so conceivably that could be a homebrew version rather than the system one.  With Marc's build, I see:

```
$ otool -L libprimecount.dylib
libprimecount.dylib:
	@rpath/libprimecount.7.1.dylib (compatibility version 7.0.0, current version 7.1.0)
	@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1200.3.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)
```



---

archive/issue_comments_553936.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">Comment 18</div>\n\nHomebrew doesn't secretly switch out the toolchain. The output on my system looks similar (but I seem to have a newer version of Xcode)\n\n```\notool -L local/lib/libprimecount.dylib                                                                                    git:t/34115/tox_yml__refactor_using_reusable_workflows\nlocal/lib/libprimecount.dylib:\n\t@rpath/libprimecount.7.dylib (compatibility version 7.0.0, current version 7.1.0)\n\t@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)\n\t/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1300.23.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)\n```",
    "created_at": "2022-07-07T22:24:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553936",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">Comment 18</div>

Homebrew doesn't secretly switch out the toolchain. The output on my system looks similar (but I seem to have a newer version of Xcode)

```
otool -L local/lib/libprimecount.dylib                                                                                    git:t/34115/tox_yml__refactor_using_reusable_workflows
local/lib/libprimecount.dylib:
	@rpath/libprimecount.7.dylib (compatibility version 7.0.0, current version 7.1.0)
	@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1300.23.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)
```



---

archive/issue_comments_553937.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">Comment 19</div>\n\nReplying to [@mkoeppe](#comment%3A18):\n> Homebrew doesn't secretly switch out the toolchain. \n\nJust in case, it has its own llvm/clang toolchain, which can be used, cf. #32207",
    "created_at": "2022-07-08T08:33:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553937",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:19" align="right">Comment 19</div>

Replying to [@mkoeppe](#comment%3A18):
> Homebrew doesn't secretly switch out the toolchain. 

Just in case, it has its own llvm/clang toolchain, which can be used, cf. #32207



---

archive/issue_comments_553938.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2022-07-08T09:38:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553938",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_comments_553939.json:
```json
{
    "body": "Author: **Matthias Koeppe**",
    "created_at": "2022-07-08T09:38:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553939",
    "user": "https://github.com/dimpase"
}
```

Author: **Matthias Koeppe**



---

archive/issue_events_448644.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T09:38:46Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448644"
}
```



---

archive/issue_comments_553940.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">Comment 21</div>\n\nThe branch is good - whether it fixes the issue reported, is not known to me, but I think this should be merged anyway.",
    "created_at": "2022-07-08T09:59:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553940",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:21" align="right">Comment 21</div>

The branch is good - whether it fixes the issue reported, is not known to me, but I think this should be merged anyway.



---

archive/issue_events_448645.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T09:59:44Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "7fff00",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448645"
}
```



---

archive/issue_events_448646.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T09:59:44Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448646"
}
```



---

archive/issue_comments_553941.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">Comment 22</div>\n\nThanks for your help Dima and Matthias.  I have now located the problem and it is a bug in part of the build process for the macOS binary app.  The app has to rewrite load paths in all of the binary files in Sage in order to make them relocatable.  The primecount libraries and executables have an unusual load path setup, which is not recognized by my current rewriting script.  Being unable to load a shared library should not be reported as a segfault, but in this case it is.",
    "created_at": "2022-07-08T10:26:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553941",
    "user": "https://github.com/culler"
}
```

<div id="comment:22" align="right">Comment 22</div>

Thanks for your help Dima and Matthias.  I have now located the problem and it is a bug in part of the build process for the macOS binary app.  The app has to rewrite load paths in all of the binary files in Sage in order to make them relocatable.  The primecount libraries and executables have an unusual load path setup, which is not recognized by my current rewriting script.  Being unable to load a shared library should not be reported as a segfault, but in this case it is.



---

archive/issue_events_448647.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-08T17:53:15Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448647"
}
```



---

archive/issue_events_448648.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-07-08T17:53:15Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448648"
}
```



---

archive/issue_comments_553942.json:
```json
{
    "body": "Changed author from **Matthias Koeppe** to none",
    "created_at": "2022-07-08T17:53:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553942",
    "user": "https://github.com/mkoeppe"
}
```

Changed author from **Matthias Koeppe** to none



---

archive/issue_comments_553943.json:
```json
{
    "body": "Changed branch from **[u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)** to none",
    "created_at": "2022-07-08T17:53:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553943",
    "user": "https://github.com/mkoeppe"
}
```

Changed branch from **[u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)** to none



---

archive/issue_comments_553944.json:
```json
{
    "body": "Changed commit from **[6dea0a1](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)** to none",
    "created_at": "2022-07-08T17:53:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553944",
    "user": "https://github.com/mkoeppe"
}
```

Changed commit from **[6dea0a1](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)** to none



---

archive/issue_comments_553945.json:
```json
{
    "body": "Changed reviewer from **Dima Pasechnik** to none",
    "created_at": "2022-07-08T17:53:15Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553945",
    "user": "https://github.com/mkoeppe"
}
```

Changed reviewer from **Dima Pasechnik** to none



---

archive/issue_comments_553946.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">Comment 24</div>\n\nI've moved the upgrade to #34132.",
    "created_at": "2022-07-08T17:53:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553946",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:24" align="right">Comment 24</div>

I've moved the upgrade to #34132.



---

archive/issue_comments_553947.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">Comment 25</div>\n\nI understand it's otherwise no problem",
    "created_at": "2022-07-08T18:39:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553947",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:25" align="right">Comment 25</div>

I understand it's otherwise no problem



---

archive/issue_events_448649.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T18:39:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/needs%20info",
    "label_color": "ffff00",
    "label_name": "needs info",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448649"
}
```



---

archive/issue_events_448650.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T18:39:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448650"
}
```



---

archive/issue_events_448651.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T18:39:06Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448651"
}
```



---

archive/issue_events_448652.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T18:39:06Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/p3%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448652"
}
```



---

archive/issue_events_448653.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T18:39:06Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/invalid",
    "label_color": "a6a6a6",
    "label_name": "invalid",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448653"
}
```



---

archive/issue_comments_553948.json:
```json
{
    "body": "Reviewer: **Dima Pasechnik**",
    "created_at": "2022-07-08T18:39:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34117#issuecomment-553948",
    "user": "https://github.com/dimpase"
}
```

Reviewer: **Dima Pasechnik**



---

archive/issue_events_448654.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2022-07-14T13:43:27Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "dfffc0",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448654"
}
```



---

archive/issue_events_448655.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2022-07-14T13:43:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/34117",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34117#event-448655"
}
```
