# Issue 34117: Segfault for prime_pi on macOS

archive/issues_033880.json:
```json
{
    "body": "With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.\n\n```\nsage: prime_pi(16000)                                                           \n1862\nsage: prime_pi(15000)                                                           \nUnhandled SIGSEGV: A segmentation fault occurred.\n```\n\nOriginally found from\n\n```\nsage: K = CyclotomicField(5)\nsage: A = matrix(K, [[1, 2], [3, 4]])\nsage: A.charpoly()\n[...]\nUnhandled SIGSEGV: A segmentation fault occurred.\n```\nThis problem seems specific to `CyclotomicFields` and does not occur for `QuadraticFields` or even `NumberFields` that are obviously isomorphic to a `CyclotomicField`. There is specialized code in the cyclotomic case, in `sage.matrix.matrix_cyclo_dense.pyx:_charpoly_multimodular`:\n\n```\nsage: K = CyclotomicField(5)\nsage: A = matrix(K, [[1, 2], [3, 4]])\nsage: A._charpoly_multimodular()\n[...]\nUnhandled SIGSEGV: A segmentation fault occurred.\n```\n\n\nThis problem does not occur with Sage 9.6 on Linux, but does manifest in Sage 9.5 on macOS.\n\n\n\nSee also [https://github.com/3-manifolds/Sage_macOS/issues/43](https://github.com/3-manifolds/Sage_macOS/issues/43).\n\n**CC:**  @culler @dimpase\n\n**Reviewer:** Dima Pasechnik\n\n**Resolution:** invalid\n\nIssue created by migration from https://trac.sagemath.org/ticket/34117\n\n",
    "closed_at": "2022-07-14T13:43:27Z",
    "created_at": "2022-07-05T20:50:25Z",
    "labels": [
        "component: number fields",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Segfault for prime_pi on macOS",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34117",
    "user": "https://github.com/NathanDunfield"
}
```
With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.

```
sage: prime_pi(16000)                                                           
1862
sage: prime_pi(15000)                                                           
Unhandled SIGSEGV: A segmentation fault occurred.
```

Originally found from

```
sage: K = CyclotomicField(5)
sage: A = matrix(K, [[1, 2], [3, 4]])
sage: A.charpoly()
[...]
Unhandled SIGSEGV: A segmentation fault occurred.
```
This problem seems specific to `CyclotomicFields` and does not occur for `QuadraticFields` or even `NumberFields` that are obviously isomorphic to a `CyclotomicField`. There is specialized code in the cyclotomic case, in `sage.matrix.matrix_cyclo_dense.pyx:_charpoly_multimodular`:

```
sage: K = CyclotomicField(5)
sage: A = matrix(K, [[1, 2], [3, 4]])
sage: A._charpoly_multimodular()
[...]
Unhandled SIGSEGV: A segmentation fault occurred.
```


This problem does not occur with Sage 9.6 on Linux, but does manifest in Sage 9.5 on macOS.



See also [https://github.com/3-manifolds/Sage_macOS/issues/43](https://github.com/3-manifolds/Sage_macOS/issues/43).

**CC:**  @culler @dimpase

**Reviewer:** Dima Pasechnik

**Resolution:** invalid

Issue created by migration from https://trac.sagemath.org/ticket/34117





---

archive/issue_comments_679198.json:
```json
{
    "body": "<a id='comment:1'></a>\nFWIW, I am not getting a crash with 9.7b3 on macOS 11.5.2. The answer `x^2 - 5*x - 2` is returned almost immediately.",
    "created_at": "2022-07-05T21:06:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679198",
    "user": "https://github.com/DaveWitteMorris"
}
```

<a id='comment:1'></a>
FWIW, I am not getting a crash with 9.7b3 on macOS 11.5.2. The answer `x^2 - 5*x - 2` is returned almost immediately.



---

archive/issue_comments_679199.json:
```json
{
    "body": "<a id='comment:2'></a>\nUnfortunately, with my x86_64 build of Sage 9.7.beta3 on macOS, which uses no Homebrew or other external libraries, I am seeing the same crash as with 9.6.  And since cysignals prevents generation of a crash log I do not currently know where the crash occurs.",
    "created_at": "2022-07-07T03:57:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679199",
    "user": "https://github.com/culler"
}
```

<a id='comment:2'></a>
Unfortunately, with my x86_64 build of Sage 9.7.beta3 on macOS, which uses no Homebrew or other external libraries, I am seeing the same crash as with 9.6.  And since cysignals prevents generation of a crash log I do not currently know where the crash occurs.



---

archive/issue_comments_679200.json:
```json
{
    "body": "<a id='comment:3'></a>\nThis crash occurs in primecount.  A stack trace is shown below.\n\nIndeed, on both Sage 9.6 and 9.7.beta3 the following command produces a segfault:\n\n```\nsage: prime_pi(5)\n```\n\n(EDITED) Also, passing a large value to prime_pi does not produce a segfault, as one might guess from the fact that the crash occurs in pi_cache\"\n\n\n```\nsage: prime_pi(1000000)\n78498\n```\n\nAccording to the \"Counting Primes\" documentation page:\\\\\n  Dima Pasechnik (2021): removed buggy cython code, replaced it with calls to\\\\\n  primecount/primecountpy spkg\n\nIn order to obtain the stack trace below I patched cysignals to make it not catch the SIG_SEGV signal.  While I agree with all of the invective in the cysignals code about how Apple screwed things up by requiring extra permissions to use a debugger, I do not agree with the way cysignals handled this screw-up.  While it is not possible for sage to run gdb to generate a stack trace after a segfualt, if the segfault is processed by Apple's handler, instead of cysignals' no-op handler, at least a crash dump is logged (sometimes).  An unreliable crash dump is a huge improvement over an immediate exit with no information.  So I think cysignals should stop handling SIG_SEGV on macOS.\n\n```\n0   libprimecount.7.1.dylib       \t0x000000015b841550 primecount::pi_cache(long long, bool) + 0\n1   primecount.cpython-310-darwin.so\t0x000000015b801ab5 0x15b7fc000 + 23221\n2   primecount.cpython-310-darwin.so\t0x000000015b801510 0x15b7fc000 + 21776\n3   multi_modular.cpython-310-darwin.so\t0x000000015b0ad097 0x15b0a4000 + 37015\n4   multi_modular.cpython-310-darwin.so\t0x000000015b0aee6b 0x15b0a4000 + 44651\n5   libpython3.10.dylib           \t0x000000010d9f26d4 0x10d950000 + 665300\n6   matrix_integer_dense.cpython-310-darwin.so\t0x000000015abe3b47 0x15abe0000 + 15175\n7   matrix_integer_dense.cpython-310-darwin.so\t0x000000015abe5986 0x15abe0000 + 22918\n8   matrix_cyclo_dense.cpython-310-darwin.so\t0x000000015cf5c4d0 0x15cf34000 + 165072\n9   libpython3.10.dylib           \t0x000000010d9dce1a 0x10d950000 + 577050\n10  matrix_cyclo_dense.cpython-310-darwin.so\t0x000000015cf50a62 0x15cf34000 + 117346\n\n```",
    "created_at": "2022-07-07T14:16:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679200",
    "user": "https://github.com/culler"
}
```

<a id='comment:3'></a>
This crash occurs in primecount.  A stack trace is shown below.

Indeed, on both Sage 9.6 and 9.7.beta3 the following command produces a segfault:

```
sage: prime_pi(5)
```

(EDITED) Also, passing a large value to prime_pi does not produce a segfault, as one might guess from the fact that the crash occurs in pi_cache"


```
sage: prime_pi(1000000)
78498
```

According to the "Counting Primes" documentation page:\\
  Dima Pasechnik (2021): removed buggy cython code, replaced it with calls to\\
  primecount/primecountpy spkg

In order to obtain the stack trace below I patched cysignals to make it not catch the SIG_SEGV signal.  While I agree with all of the invective in the cysignals code about how Apple screwed things up by requiring extra permissions to use a debugger, I do not agree with the way cysignals handled this screw-up.  While it is not possible for sage to run gdb to generate a stack trace after a segfualt, if the segfault is processed by Apple's handler, instead of cysignals' no-op handler, at least a crash dump is logged (sometimes).  An unreliable crash dump is a huge improvement over an immediate exit with no information.  So I think cysignals should stop handling SIG_SEGV on macOS.

```
0   libprimecount.7.1.dylib       	0x000000015b841550 primecount::pi_cache(long long, bool) + 0
1   primecount.cpython-310-darwin.so	0x000000015b801ab5 0x15b7fc000 + 23221
2   primecount.cpython-310-darwin.so	0x000000015b801510 0x15b7fc000 + 21776
3   multi_modular.cpython-310-darwin.so	0x000000015b0ad097 0x15b0a4000 + 37015
4   multi_modular.cpython-310-darwin.so	0x000000015b0aee6b 0x15b0a4000 + 44651
5   libpython3.10.dylib           	0x000000010d9f26d4 0x10d950000 + 665300
6   matrix_integer_dense.cpython-310-darwin.so	0x000000015abe3b47 0x15abe0000 + 15175
7   matrix_integer_dense.cpython-310-darwin.so	0x000000015abe5986 0x15abe0000 + 22918
8   matrix_cyclo_dense.cpython-310-darwin.so	0x000000015cf5c4d0 0x15cf34000 + 165072
9   libpython3.10.dylib           	0x000000010d9dce1a 0x10d950000 + 577050
10  matrix_cyclo_dense.cpython-310-darwin.so	0x000000015cf50a62 0x15cf34000 + 117346

```



---

archive/issue_events_100343.json:
```json
{
    "event": "renamed",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "rename": {
        "from": "Segfault for char polys of matrices over cyclotomic fields on macOS",
        "to": "Segfault for prime_pi on macOS"
    },
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34117#event-100343"
}
```



---

archive/issue_comments_679201.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1,4 +1,13 @@\n-With Sage 9.6 on macOS 11.6.5, I get:\n+With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.\n+\n+```\n+sage: prime_pi(16000)                                                           \n+1862\n+sage: prime_pi(15000)                                                           \n+Unhandled SIGSEGV: A segmentation fault occurred.\n+```\n+\n+Originally found from\n \n ```\n sage: K = CyclotomicField(5)\n``````\n",
    "created_at": "2022-07-07T15:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679201",
    "user": "https://github.com/NathanDunfield"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1,4 +1,13 @@
-With Sage 9.6 on macOS 11.6.5, I get:
+With Sage 9.6 on macOS 11.6.5, as well as 9.7.beta3, calling `prime_pi` with inputs less than about 15,000 produces a SIGSEGV, e.g.
+
+```
+sage: prime_pi(16000)                                                           
+1862
+sage: prime_pi(15000)                                                           
+Unhandled SIGSEGV: A segmentation fault occurred.
+```
+
+Originally found from
 
 ```
 sage: K = CyclotomicField(5)
``````




---

archive/issue_comments_679202.json:
```json
{
    "body": "<a id='comment:5'></a>\nIn `PiTable.cpp` the static table PiTable::pi_t is a\n\n```\n/// Compressed PrimePi(x) lookup table for x < 64 * 240.\n```\n\nI note that 64*240 = 15360 lies between 15000 and 16000.  So it would appear that any lookup into that table produces a segfault.\n\nI also notice that the signature of py_cache allows passing negative indices into the table.\n\n```\nint64_t pi_cache(int64_t x, bool print = is_print());\n```\n\nOf course passing a negative value would produce a segfault regardless of the signature.\nHowever I notice that any negative value, even one with large absolute value like -1000000, produces a segfault.  So that suggests that all negative values are used directly as indices into the pi_cache table without checking the sign.  That seems unwise.",
    "created_at": "2022-07-07T16:37:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679202",
    "user": "https://github.com/culler"
}
```

<a id='comment:5'></a>
In `PiTable.cpp` the static table PiTable::pi_t is a

```
/// Compressed PrimePi(x) lookup table for x < 64 * 240.
```

I note that 64*240 = 15360 lies between 15000 and 16000.  So it would appear that any lookup into that table produces a segfault.

I also notice that the signature of py_cache allows passing negative indices into the table.

```
int64_t pi_cache(int64_t x, bool print = is_print());
```

Of course passing a negative value would produce a segfault regardless of the signature.
However I notice that any negative value, even one with large absolute value like -1000000, produces a segfault.  So that suggests that all negative values are used directly as indices into the pi_cache table without checking the sign.  That seems unwise.



---

archive/issue_comments_679203.json:
```json
{
    "body": "<a id='comment:6'></a>\nThere is a question, when prime_pi(x) is called with x <= 0, whether it should raise a `ValueError` or return 0. The answer depends on whether you think that negative prime integers exist. And that depends on whether you think that the integers should be treated differently from other principle ideal domains.  For a definitive answer to that question, see\nhttps://primes.utm.edu/notes/faq/negative_primes.html\n\nMy opinion is that it should return 0 and that the docstring should be modified to read:\n\n```\nThe prime counting function, which counts the number of positive primes less\nthan or equal to a given value.\n```",
    "created_at": "2022-07-07T17:07:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679203",
    "user": "https://github.com/culler"
}
```

<a id='comment:6'></a>
There is a question, when prime_pi(x) is called with x <= 0, whether it should raise a `ValueError` or return 0. The answer depends on whether you think that negative prime integers exist. And that depends on whether you think that the integers should be treated differently from other principle ideal domains.  For a definitive answer to that question, see
https://primes.utm.edu/notes/faq/negative_primes.html

My opinion is that it should return 0 and that the docstring should be modified to read:

```
The prime counting function, which counts the number of positive primes less
than or equal to a given value.
```



---

archive/issue_comments_679204.json:
```json
{
    "body": "<a id='comment:7'></a>\nWhat version of primecount? (it can come from Homebrew or Conda, or built from source)\n\nAnd what C++/Xcode version?",
    "created_at": "2022-07-07T17:30:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679204",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>
What version of primecount? (it can come from Homebrew or Conda, or built from source)

And what C++/Xcode version?



---

archive/issue_comments_679205.json:
```json
{
    "body": "<a id='comment:8'></a>\nCan you reproduce this with a standalone primecount executable?",
    "created_at": "2022-07-07T17:32:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679205",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:8'></a>
Can you reproduce this with a standalone primecount executable?



---

archive/issue_comments_679206.json:
```json
{
    "body": "<a id='comment:9'></a>\nif so, please do the upstream bug report",
    "created_at": "2022-07-07T17:33:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679206",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
if so, please do the upstream bug report



---

archive/issue_comments_679207.json:
```json
{
    "body": "<a id='comment:10'></a>\nI can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG",
    "created_at": "2022-07-07T18:17:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679207",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>
I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG



---

archive/issue_comments_679208.json:
```json
{
    "body": "**Branch:** [u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)",
    "created_at": "2022-07-07T19:01:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679208",
    "user": "https://github.com/mkoeppe"
}
```

**Branch:** [u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)



---

archive/issue_comments_679209.json:
```json
{
    "body": "**Commit:** [6dea0a178d75db702107100c36afddbfa28584de](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)",
    "created_at": "2022-07-07T19:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679209",
    "user": "https://github.com/mkoeppe"
}
```

**Commit:** [6dea0a178d75db702107100c36afddbfa28584de](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)



---

archive/issue_comments_679210.json:
```json
{
    "body": "<a id='comment:12'></a>\nAnyway, here's an update to the most recent primesieve/primecount versions\n\n---\n**New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb48b63cb59e162058d46eb490149c37a86c12f5\">fb48b63</a></td><td><code>build/pkgs/primesieve: Update to 8.0</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/c78d53b14c5bad682b272d442c2f9003d40e445f\">c78d53b</a></td><td><code>build/pkgs/primecount: Update to 7.4</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/670477064c809de277dd8f3678f76b6f123d2cf6\">6704770</a></td><td><code>build/pkgs/primecount/patches/sieve_version.patch: Remove</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e4f0d6bed7831c6718a2d4c34e2bcf70cbbed804\">e4f0d6b</a></td><td><code>build/pkgs/primecount/spkg-install.in: Use CMAKE_NO_SYSTEM_FROM_IMPORTED=ON</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de\">6dea0a1</a></td><td><code>build/pkgs/primesieve/spkg-configure.m4: Require >= 8.0</code></td></tr></table>\n",
    "created_at": "2022-07-07T19:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679210",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>
Anyway, here's an update to the most recent primesieve/primecount versions

---
**New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb48b63cb59e162058d46eb490149c37a86c12f5">fb48b63</a></td><td><code>build/pkgs/primesieve: Update to 8.0</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/c78d53b14c5bad682b272d442c2f9003d40e445f">c78d53b</a></td><td><code>build/pkgs/primecount: Update to 7.4</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/670477064c809de277dd8f3678f76b6f123d2cf6">6704770</a></td><td><code>build/pkgs/primecount/patches/sieve_version.patch: Remove</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e4f0d6bed7831c6718a2d4c34e2bcf70cbbed804">e4f0d6b</a></td><td><code>build/pkgs/primecount/spkg-install.in: Use CMAKE_NO_SYSTEM_FROM_IMPORTED=ON</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de">6dea0a1</a></td><td><code>build/pkgs/primesieve/spkg-configure.m4: Require >= 8.0</code></td></tr></table>




---

archive/issue_comments_679211.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [dimpase](#comment%3A7):\n> What version of primecount? (it can come from Homebrew or Conda, or built from source)\n\n\nAs I said, the build for the Sage_macOS binary distribution is very careful to use NO external libraries whatsoever.  Both primecount and primesieve and everything else, including gfortran, is built from source as provided in the Sage repository.\n\n```\nsage % cat build/pkgs/primecount/package-version.txt \n7.1\n```\n\n```\nsage % cat build/pkgs/primesieve/package-version.txt\n7.6\n```\n\n\n> \n> And what C++/Xcode version?\n\n\n\n```\n% xcodebuild -version \nXcode 13.2.1\nBuild version 13C100\n\n```\n\n```\n% gcc --version\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1\nApple clang version 13.0.0 (clang-1300.0.29.30)\nTarget: x86_64-apple-darwin20.6.0\nThread model: posix\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\n\n```",
    "created_at": "2022-07-07T19:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679211",
    "user": "https://github.com/culler"
}
```

<a id='comment:13'></a>
Replying to [dimpase](#comment%3A7):
> What version of primecount? (it can come from Homebrew or Conda, or built from source)


As I said, the build for the Sage_macOS binary distribution is very careful to use NO external libraries whatsoever.  Both primecount and primesieve and everything else, including gfortran, is built from source as provided in the Sage repository.

```
sage % cat build/pkgs/primecount/package-version.txt 
7.1
```

```
sage % cat build/pkgs/primesieve/package-version.txt
7.6
```


> 
> And what C++/Xcode version?



```
% xcodebuild -version 
Xcode 13.2.1
Build version 13C100

```

```
% gcc --version
Configured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/c++/4.2.1
Apple clang version 13.0.0 (clang-1300.0.29.30)
Target: x86_64-apple-darwin20.6.0
Thread model: posix
InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin

```



---

archive/issue_comments_679212.json:
```json
{
    "body": "<a id='comment:14'></a>\nReplying to [dimpase](#comment%3A8):\n> Can you reproduce this with a standalone primecount executable? \n\n\nNo. The standalone version works fine for me.  I used the current latest release, though, which is primecount 7.4 and primesieve 8.0.",
    "created_at": "2022-07-07T19:23:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679212",
    "user": "https://github.com/culler"
}
```

<a id='comment:14'></a>
Replying to [dimpase](#comment%3A8):
> Can you reproduce this with a standalone primecount executable? 


No. The standalone version works fine for me.  I used the current latest release, though, which is primecount 7.4 and primesieve 8.0.



---

archive/issue_comments_679213.json:
```json
{
    "body": "<a id='comment:15'></a>\nReplying to [mkoeppe](#comment%3A10):\n> I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG\n\n\nAre you using any Homebrew libraries for your build?",
    "created_at": "2022-07-07T19:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679213",
    "user": "https://github.com/culler"
}
```

<a id='comment:15'></a>
Replying to [mkoeppe](#comment%3A10):
> I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG


Are you using any Homebrew libraries for your build?



---

archive/issue_comments_679214.json:
```json
{
    "body": "<a id='comment:16'></a>\nReplying to [culler](#comment%3A15):\n> Replying to [mkoeppe](#comment%3A10):\n> > I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG\n\n> \n> Are you using any Homebrew libraries for your build?\n\n\nYes, but primecount/primesieve have no dependencies",
    "created_at": "2022-07-07T19:28:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679214",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
Replying to [culler](#comment%3A15):
> Replying to [mkoeppe](#comment%3A10):
> > I can't reproduce it either on macOS 12.4 (Intel) with primesieve and primecount from SPKG

> 
> Are you using any Homebrew libraries for your build?


Yes, but primecount/primesieve have no dependencies



---

archive/issue_comments_679215.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [mkoeppe](#comment%3A16):\n> > Are you using any Homebrew libraries for your build?\n\n> \n> Yes, but primecount/primesieve have no dependencies \n\n\nThey do link against `libc++`, so conceivably that could be a homebrew version rather than the system one.  With Marc's build, I see:\n\n```\n$ otool -L libprimecount.dylib\nlibprimecount.dylib:\n\t@rpath/libprimecount.7.1.dylib (compatibility version 7.0.0, current version 7.1.0)\n\t@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)\n\t/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1200.3.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)\n```",
    "created_at": "2022-07-07T22:13:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679215",
    "user": "https://github.com/NathanDunfield"
}
```

<a id='comment:17'></a>
Replying to [mkoeppe](#comment%3A16):
> > Are you using any Homebrew libraries for your build?

> 
> Yes, but primecount/primesieve have no dependencies 


They do link against `libc++`, so conceivably that could be a homebrew version rather than the system one.  With Marc's build, I see:

```
$ otool -L libprimecount.dylib
libprimecount.dylib:
	@rpath/libprimecount.7.1.dylib (compatibility version 7.0.0, current version 7.1.0)
	@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1200.3.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.0.0)
```



---

archive/issue_comments_679216.json:
```json
{
    "body": "<a id='comment:18'></a>\nHomebrew doesn't secretly switch out the toolchain. The output on my system looks similar (but I seem to have a newer version of Xcode)\n\n```\notool -L local/lib/libprimecount.dylib                                                                                    git:t/34115/tox_yml__refactor_using_reusable_workflows\nlocal/lib/libprimecount.dylib:\n\t@rpath/libprimecount.7.dylib (compatibility version 7.0.0, current version 7.1.0)\n\t@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)\n\t/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1300.23.0)\n\t/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)\n```",
    "created_at": "2022-07-07T22:24:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679216",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Homebrew doesn't secretly switch out the toolchain. The output on my system looks similar (but I seem to have a newer version of Xcode)

```
otool -L local/lib/libprimecount.dylib                                                                                    git:t/34115/tox_yml__refactor_using_reusable_workflows
local/lib/libprimecount.dylib:
	@rpath/libprimecount.7.dylib (compatibility version 7.0.0, current version 7.1.0)
	@rpath/libprimesieve.9.dylib (compatibility version 9.0.0, current version 9.6.0)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 1300.23.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.100.3)
```



---

archive/issue_comments_679217.json:
```json
{
    "body": "<a id='comment:19'></a>\nReplying to [mkoeppe](#comment%3A18):\n> Homebrew doesn't secretly switch out the toolchain. \n\nJust in case, it has its own llvm/clang toolchain, which can be used, cf. #32207",
    "created_at": "2022-07-08T08:33:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679217",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
Replying to [mkoeppe](#comment%3A18):
> Homebrew doesn't secretly switch out the toolchain. 

Just in case, it has its own llvm/clang toolchain, which can be used, cf. #32207



---

archive/issue_comments_679218.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2022-07-08T09:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679218",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_comments_679219.json:
```json
{
    "body": "**Author:** Matthias Koeppe",
    "created_at": "2022-07-08T09:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679219",
    "user": "https://github.com/dimpase"
}
```

**Author:** Matthias Koeppe



---

archive/issue_comments_679220.json:
```json
{
    "body": "**Changing status** from new to needs_review.",
    "created_at": "2022-07-08T09:38:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679220",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from new to needs_review.



---

archive/issue_comments_679221.json:
```json
{
    "body": "<a id='comment:21'></a>\nThe branch is good - whether it fixes the issue reported, is not known to me, but I think this should be merged anyway.",
    "created_at": "2022-07-08T09:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679221",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:21'></a>
The branch is good - whether it fixes the issue reported, is not known to me, but I think this should be merged anyway.



---

archive/issue_comments_679222.json:
```json
{
    "body": "**Changing status** from needs_review to positive_review.",
    "created_at": "2022-07-08T09:59:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679222",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_review to positive_review.



---

archive/issue_comments_679223.json:
```json
{
    "body": "<a id='comment:22'></a>\nThanks for your help Dima and Matthias.  I have now located the problem and it is a bug in part of the build process for the macOS binary app.  The app has to rewrite load paths in all of the binary files in Sage in order to make them relocatable.  The primecount libraries and executables have an unusual load path setup, which is not recognized by my current rewriting script.  Being unable to load a shared library should not be reported as a segfault, but in this case it is.",
    "created_at": "2022-07-08T10:26:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679223",
    "user": "https://github.com/culler"
}
```

<a id='comment:22'></a>
Thanks for your help Dima and Matthias.  I have now located the problem and it is a bug in part of the build process for the macOS binary app.  The app has to rewrite load paths in all of the binary files in Sage in order to make them relocatable.  The primecount libraries and executables have an unusual load path setup, which is not recognized by my current rewriting script.  Being unable to load a shared library should not be reported as a segfault, but in this case it is.



---

archive/issue_comments_679224.json:
```json
{
    "body": "**Changing status** from positive_review to needs_info.",
    "created_at": "2022-07-08T17:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679224",
    "user": "https://github.com/mkoeppe"
}
```

**Changing status** from positive_review to needs_info.



---

archive/issue_comments_679225.json:
```json
{
    "body": "**Changing author** from \"Matthias Koeppe\" to \"\".",
    "created_at": "2022-07-08T17:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679225",
    "user": "https://github.com/mkoeppe"
}
```

**Changing author** from "Matthias Koeppe" to "".



---

archive/issue_comments_679226.json:
```json
{
    "body": "**Changing branch** from \"[u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)\" to \"\".",
    "created_at": "2022-07-08T17:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679226",
    "user": "https://github.com/mkoeppe"
}
```

**Changing branch** from "[u/mkoeppe/segfault_for_prime_pi_on_macos](https://github.com/sagemath/sagetrac-mirror/tree/u/mkoeppe/segfault_for_prime_pi_on_macos)" to "".



---

archive/issue_comments_679227.json:
```json
{
    "body": "**Changing commit** from \"[6dea0a178d75db702107100c36afddbfa28584de](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)\" to \"\".",
    "created_at": "2022-07-08T17:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679227",
    "user": "https://github.com/mkoeppe"
}
```

**Changing commit** from "[6dea0a178d75db702107100c36afddbfa28584de](https://github.com/sagemath/sagetrac-mirror/commit/6dea0a178d75db702107100c36afddbfa28584de)" to "".



---

archive/issue_comments_679228.json:
```json
{
    "body": "**Changing reviewer** from \"Dima Pasechnik\" to \"\".",
    "created_at": "2022-07-08T17:53:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679228",
    "user": "https://github.com/mkoeppe"
}
```

**Changing reviewer** from "Dima Pasechnik" to "".



---

archive/issue_comments_679229.json:
```json
{
    "body": "<a id='comment:24'></a>\nI've moved the upgrade to #34132.",
    "created_at": "2022-07-08T17:53:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679229",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>
I've moved the upgrade to #34132.



---

archive/issue_comments_679230.json:
```json
{
    "body": "<a id='comment:25'></a>\nI understand it's otherwise no problem",
    "created_at": "2022-07-08T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679230",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:25'></a>
I understand it's otherwise no problem



---

archive/issue_comments_679231.json:
```json
{
    "body": "**Changing status** from needs_info to positive_review.",
    "created_at": "2022-07-08T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679231",
    "user": "https://github.com/dimpase"
}
```

**Changing status** from needs_info to positive_review.



---

archive/issue_events_100344.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2022-07-08T18:39:06Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "milestone": "sage-duplicate/invalid/wontfix",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34117#event-100344"
}
```



---

archive/issue_comments_679232.json:
```json
{
    "body": "**Reviewer:** Dima Pasechnik",
    "created_at": "2022-07-08T18:39:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679232",
    "user": "https://github.com/dimpase"
}
```

**Reviewer:** Dima Pasechnik



---

archive/issue_comments_679233.json:
```json
{
    "body": "**Resolution:** invalid",
    "created_at": "2022-07-14T13:43:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34117#issuecomment-679233",
    "user": "https://github.com/slel"
}
```

**Resolution:** invalid



---

archive/issue_events_100345.json:
```json
{
    "actor": "https://github.com/slel",
    "created_at": "2022-07-14T13:43:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34117",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34117#event-100345"
}
```
