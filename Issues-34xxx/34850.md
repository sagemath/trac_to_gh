# Issue 34850: sage is slowing down cypari2 a lot

archive/issues_034613.json:
```json
{
    "body": "{{{ #!python\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:          \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom sage.ext.memory import init_memory_functions\ninit_memory_functions()\n\"\"\"\nprint(\"with sage custom GMP allocation functions:\",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nimport sage.all\n\"\"\"\nprint(\"with the whole sagemath library lodaded:  \",\n      timeit.timeit(prog, setup=setup, number=3))\n}}}\ngives\n\n```\n$ python pari_timing.py \npython environment with cypari2:           4.871978694998688\nwith sage custom GMP allocation functions: 4.941096214999561\nwith the whole sagemath library lodaded:   7.39602135700261\n```\n\nSee also\n- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)\n- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)\n\n**CC:**  @edgarcosta @mkoeppe @JohnCremona @fredrik-johansson\n\n**Status:** new\n\nIssue created by migration from https://trac.sagemath.org/ticket/34850\n\n",
    "created_at": "2022-12-14T20:10:39Z",
    "labels": [
        "component: performance",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "sage is slowing down cypari2 a lot",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34850",
    "user": "https://github.com/videlec"
}
```
{{{ #!python
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:          ",
      timeit.timeit(prog, number=3))

setup="""
from sage.ext.memory import init_memory_functions
init_memory_functions()
"""
print("with sage custom GMP allocation functions:",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
import sage.all
"""
print("with the whole sagemath library lodaded:  ",
      timeit.timeit(prog, setup=setup, number=3))
}}}
gives

```
$ python pari_timing.py 
python environment with cypari2:           4.871978694998688
with sage custom GMP allocation functions: 4.941096214999561
with the whole sagemath library lodaded:   7.39602135700261
```

See also
- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)
- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)

**CC:**  @edgarcosta @mkoeppe @JohnCremona @fredrik-johansson

**Status:** new

Issue created by migration from https://trac.sagemath.org/ticket/34850





---

archive/issue_comments_661169.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -4,10 +4,10 @@\n prog=\"\"\"\n from cypari2 import Pari\n pari = Pari(size={size})\n-pari({cmd})\n+pari(\"{cmd}\")\n \"\"\"\n \n-prog = prog.format(size=2**24, cmd=\"\\\"quadclassunit(1 - 2^100)\\\"\")\n+prog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n \n print(\"python environment with cypari2:          \",\n       timeit.timeit(prog, number=3))\n``````\n",
    "created_at": "2022-12-14T20:11:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661169",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -4,10 +4,10 @@
 prog="""
 from cypari2 import Pari
 pari = Pari(size={size})
-pari({cmd})
+pari("{cmd}")
 """
 
-prog = prog.format(size=2**24, cmd="\"quadclassunit(1 - 2^100)\"")
+prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")
 
 print("python environment with cypari2:          ",
       timeit.timeit(prog, number=3))
``````




---

archive/issue_comments_661170.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -33,3 +33,7 @@\n with sage custom GMP allocation functions: 4.941096214999561\n with the whole sagemath library lodaded:   7.39602135700261\n ```\n+\n+See also\n+- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)\n+- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)\n``````\n",
    "created_at": "2022-12-14T20:25:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661170",
    "user": "https://github.com/videlec"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -33,3 +33,7 @@
 with sage custom GMP allocation functions: 4.941096214999561
 with the whole sagemath library lodaded:   7.39602135700261
 ```
+
+See also
+- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)
+- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)
``````




---

archive/issue_comments_661171.json:
```json
{
    "body": "<a id='comment:3'></a>\nCould it be just a different memory layout as soon as `sage.all` is imported, causing the memory consumption of the process to increase about 6-fold ?",
    "created_at": "2022-12-15T00:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661171",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
Could it be just a different memory layout as soon as `sage.all` is imported, causing the memory consumption of the process to increase about 6-fold ?



---

archive/issue_comments_661172.json:
```json
{
    "body": "<a id='comment:5'></a>\nFWIW, I don't see the issue on my system:\n\n```\npython environment with cypari2:           3.9759535739940475\nwith sage custom GMP allocation functions: 4.250082928003394\nwith the whole sagemath library lodaded:   3.8536450660030823\n```\n(edit: I previously posted a version where I was running the test code under sage, not ipython, but the results above are with ipython)",
    "created_at": "2022-12-15T10:22:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661172",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:5'></a>
FWIW, I don't see the issue on my system:

```
python environment with cypari2:           3.9759535739940475
with sage custom GMP allocation functions: 4.250082928003394
with the whole sagemath library lodaded:   3.8536450660030823
```
(edit: I previously posted a version where I was running the test code under sage, not ipython, but the results above are with ipython)



---

archive/issue_comments_661173.json:
```json
{
    "body": "<a id='comment:6'></a>\nThanks Marc for running the test. What is your configuration? eg what is the system and does sage use system pari?",
    "created_at": "2022-12-15T10:26:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661173",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>
Thanks Marc for running the test. What is your configuration? eg what is the system and does sage use system pari?



---

archive/issue_comments_661174.json:
```json
{
    "body": "<a id='comment:7'></a>\nI was going to add more details after doit `sage -f pari`\u2014which is still running at the moment. But the example above is already using sage's pari (I also have a systemwide pari, but it is a different version). This is on Debian sid with an Intel cpu. Note that I am using Python 3.11 via #33842.",
    "created_at": "2022-12-15T10:33:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661174",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:7'></a>
I was going to add more details after doit `sage -f pari`—which is still running at the moment. But the example above is already using sage's pari (I also have a systemwide pari, but it is a different version). This is on Debian sid with an Intel cpu. Note that I am using Python 3.11 via #33842.



---

archive/issue_comments_661175.json:
```json
{
    "body": "<a id='comment:8'></a>\non ubuntu 22.04.01 LTS:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.8.beta5, Release Date: 2022-12-11               \u2502\n\u2502 Using Python 3.10.6. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: import timeit\n....: \n....: prog=\"\"\"\n....: from cypari2 import Pari\n....: pari = Pari(size={size})\n....: pari(\"{cmd}\")\n....: \"\"\"\n....: \n....: prog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n....: \n....: print(\"python environment with cypari2:          \",\n....:       timeit.timeit(prog, number=3))\n....: \n....: setup=\"\"\"\n....: from sage.ext.memory import init_memory_functions\n....: init_memory_functions()\n....: \"\"\"\n....: print(\"with sage custom GMP allocation functions:\",\n....:       timeit.timeit(prog, setup=setup, number=3))\n....: \n....: setup=\"\"\"\n....: import sage.all\n....: \"\"\"\n....: print(\"with the whole sagemath library lodaded:  \",\n....:       timeit.timeit(prog, setup=setup, number=3))\npython environment with cypari2:           5.757997545006219\nwith sage custom GMP allocation functions: 5.887209259002702\nwith the whole sagemath library lodaded:   5.1330207900027744\n```",
    "created_at": "2022-12-15T11:30:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661175",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:8'></a>
on ubuntu 22.04.01 LTS:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.8.beta5, Release Date: 2022-12-11               │
│ Using Python 3.10.6. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import timeit
....: 
....: prog="""
....: from cypari2 import Pari
....: pari = Pari(size={size})
....: pari("{cmd}")
....: """
....: 
....: prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")
....: 
....: print("python environment with cypari2:          ",
....:       timeit.timeit(prog, number=3))
....: 
....: setup="""
....: from sage.ext.memory import init_memory_functions
....: init_memory_functions()
....: """
....: print("with sage custom GMP allocation functions:",
....:       timeit.timeit(prog, setup=setup, number=3))
....: 
....: setup="""
....: import sage.all
....: """
....: print("with the whole sagemath library lodaded:  ",
....:       timeit.timeit(prog, setup=setup, number=3))
python environment with cypari2:           5.757997545006219
with sage custom GMP allocation functions: 5.887209259002702
with the whole sagemath library lodaded:   5.1330207900027744
```



---

archive/issue_comments_661176.json:
```json
{
    "body": "<a id='comment:9'></a>\nIf you replace\n\n```\n    import sage.all\n```\nwith\n\n```\n    import sympy\n```\nyou'll get the same slowdown. Bingo! Sympy probably changes FPU status, it seems, according to\n`build/pkgs/sympow/email-exchange.txt`",
    "created_at": "2022-12-15T12:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661176",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:9'></a>
If you replace

```
    import sage.all
```
with

```
    import sympy
```
you'll get the same slowdown. Bingo! Sympy probably changes FPU status, it seems, according to
`build/pkgs/sympow/email-exchange.txt`



---

archive/issue_comments_661177.json:
```json
{
    "body": "<a id='comment:10'></a>\nReplying to [Dima Pasechnik](#comment%3A9):\n> Sympy probably changes FPU status, it seems, according to\n> `build/pkgs/sympow/email-exchange.txt`\n\n\nDid you accidentally look in `sympow/` instead of `sympy/`, or do you mean sympow also has something to do with it?\n\nI (obviously) don't see any slowdown here with `import sympy` either, even after reinstalling sympy with `sage -f`.",
    "created_at": "2022-12-15T12:35:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661177",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:10'></a>
Replying to [Dima Pasechnik](#comment%3A9):
> Sympy probably changes FPU status, it seems, according to
> `build/pkgs/sympow/email-exchange.txt`


Did you accidentally look in `sympow/` instead of `sympy/`, or do you mean sympow also has something to do with it?

I (obviously) don't see any slowdown here with `import sympy` either, even after reinstalling sympy with `sage -f`.



---

archive/issue_comments_661178.json:
```json
{
    "body": "<a id='comment:11'></a>\nYou know that the greatest discoveries are made by accident ;-) \n\nIndeed, I went looking for FPU in sage source repo, and found that `sympow` thing, which got swapped to `sympy` in my brain... Anyhow, for me `sympy` causes the same slowdown:\n\n```\n$ ./sage --python p.py\npython environment with cypari2:           4.7912631159997545\nwith sage custom GMP allocation functions: 4.886824406014057\nwith sympy loaded:   6.885674357006792\n$ cat p.py\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:          \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom sage.ext.memory import init_memory_functions\ninit_memory_functions()\n\"\"\"\nprint(\"with sage custom GMP allocation functions:\",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nimport sympy\n\"\"\"\nprint(\"with sympy loaded:  \",\n      timeit.timeit(prog, setup=setup, number=3))\n```",
    "created_at": "2022-12-15T12:49:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661178",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>
You know that the greatest discoveries are made by accident ;-) 

Indeed, I went looking for FPU in sage source repo, and found that `sympow` thing, which got swapped to `sympy` in my brain... Anyhow, for me `sympy` causes the same slowdown:

```
$ ./sage --python p.py
python environment with cypari2:           4.7912631159997545
with sage custom GMP allocation functions: 4.886824406014057
with sympy loaded:   6.885674357006792
$ cat p.py
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:          ",
      timeit.timeit(prog, number=3))

setup="""
from sage.ext.memory import init_memory_functions
init_memory_functions()
"""
print("with sage custom GMP allocation functions:",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
import sympy
"""
print("with sympy loaded:  ",
      timeit.timeit(prog, setup=setup, number=3))
```



---

archive/issue_comments_661179.json:
```json
{
    "body": "<a id='comment:12'></a>\nI see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.\n\nI see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)",
    "created_at": "2022-12-15T13:06:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661179",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:12'></a>
I see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.

I see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)



---

archive/issue_comments_661180.json:
```json
{
    "body": "<a id='comment:13'></a>\nReplying to [Dima Pasechnik](#comment%3A12):\n> I see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.\n> \n> I see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)\n\n\nInteresting.\n- on system sage on archlinux : no difference between no setup and `import sympy`\n- on the compiled sage : same slowdown with `import sympy` and `import sage.all`",
    "created_at": "2022-12-15T15:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661180",
    "user": "https://github.com/videlec"
}
```

<a id='comment:13'></a>
Replying to [Dima Pasechnik](#comment%3A12):
> I see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.
> 
> I see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)


Interesting.
- on system sage on archlinux : no difference between no setup and `import sympy`
- on the compiled sage : same slowdown with `import sympy` and `import sage.all`



---

archive/issue_comments_661181.json:
```json
{
    "body": "<a id='comment:14'></a>\nnarrowing it down further, with taking all of Sage out:\n\n```python\n# p1.py\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:         \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nimport sympy\n\"\"\"\nprint(\"with sympy loaded:                       \",\n      timeit.timeit(prog, setup=setup, number=3))\n```\n\nOn Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`\n\n* \"naked\" system python,  pip-installed `cypari2` and `sympy` - no time difference\n* venv'ed system python,  pip-installed `cypari2` and `sympy` - no time difference\n* Sage's-venv wrapped system python, Sage-installed `cypari` and `sympy` - `sympy` produces a slowdown.  \n\nSo this is down to interaction between python, sympy, and cypari2 (and Sage's venv?)",
    "created_at": "2022-12-15T16:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661181",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>
narrowing it down further, with taking all of Sage out:

```python
# p1.py
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:         ",
      timeit.timeit(prog, number=3))

setup="""
import sympy
"""
print("with sympy loaded:                       ",
      timeit.timeit(prog, setup=setup, number=3))
```

On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`

* "naked" system python,  pip-installed `cypari2` and `sympy` - no time difference
* venv'ed system python,  pip-installed `cypari2` and `sympy` - no time difference
* Sage's-venv wrapped system python, Sage-installed `cypari` and `sympy` - `sympy` produces a slowdown.  

So this is down to interaction between python, sympy, and cypari2 (and Sage's venv?)



---

archive/issue_comments_661182.json:
```json
{
    "body": "<a id='comment:15'></a>\nMatthias, there is something funny in Sage's venv, causing such a slowdown on Linux.",
    "created_at": "2022-12-15T17:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661182",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>
Matthias, there is something funny in Sage's venv, causing such a slowdown on Linux.



---

archive/issue_comments_661183.json:
```json
{
    "body": "<a id='comment:16'></a>\nTo narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.",
    "created_at": "2022-12-15T17:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661183",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>
To narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.



---

archive/issue_comments_661184.json:
```json
{
    "body": "<a id='comment:17'></a>\nReplying to [Matthias K\u00f6ppe](#comment%3A16):\n> To narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.\n\n\nThis way, no difference in timing, so the wheels themselves are OK.",
    "created_at": "2022-12-15T20:53:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661184",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>
Replying to [Matthias Köppe](#comment%3A16):
> To narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.


This way, no difference in timing, so the wheels themselves are OK.



---

archive/issue_comments_661185.json:
```json
{
    "body": "<a id='comment:18'></a>\nNext you could check whether it makes a difference to run the separate venv inside or outside of the sage environment set up by `sage -sh`.",
    "created_at": "2022-12-15T21:15:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661185",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>
Next you could check whether it makes a difference to run the separate venv inside or outside of the sage environment set up by `sage -sh`.



---

archive/issue_comments_661186.json:
```json
{
    "body": "<a id='comment:19'></a>\nif I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,\nactivate `swheels`, and try doing things there, `pip` does not look too healthy:\n\n```\n(swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge\nAn error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')\n```\n\nregardless, `pip install` works there, and I can run the test - again, no difference in time.\nSo, somehow, putting Sage's python into venv cures this time discrepancy.\n\n```\n(swheels) (sage-sh) dima@hilbert:swheels$ python p.py\npython environment with cypari2:          5.116253892017994\nwith sympy loaded:                        5.216335576027632\n(swheels) (sage-sh) dima@hilbert:swheels$ deactivate \n(sage-sh) dima@hilbert:swheels$ which python\n/mnt/opt/Sage/sage-dev/local/var/lib/sage/venv-python3.10/bin/python\n(sage-sh) dima@hilbert:swheels$ python p.py \npython environment with cypari2:          5.446458007965703\nwith sympy loaded:                        8.667378643993288\n```",
    "created_at": "2022-12-15T22:02:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661186",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:19'></a>
if I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,
activate `swheels`, and try doing things there, `pip` does not look too healthy:

```
(swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge
An error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')
```

regardless, `pip install` works there, and I can run the test - again, no difference in time.
So, somehow, putting Sage's python into venv cures this time discrepancy.

```
(swheels) (sage-sh) dima@hilbert:swheels$ python p.py
python environment with cypari2:          5.116253892017994
with sympy loaded:                        5.216335576027632
(swheels) (sage-sh) dima@hilbert:swheels$ deactivate 
(sage-sh) dima@hilbert:swheels$ which python
/mnt/opt/Sage/sage-dev/local/var/lib/sage/venv-python3.10/bin/python
(sage-sh) dima@hilbert:swheels$ python p.py 
python environment with cypari2:          5.446458007965703
with sympy loaded:                        8.667378643993288
```



---

archive/issue_comments_661187.json:
```json
{
    "body": "<a id='comment:20'></a>\nReplying to [Dima Pasechnik](#comment%3A19):\n> if I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,\n> activate `swheels`, and try doing things there, `pip` does not look too healthy:\n> \n> ```\n> (swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge\n> An error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')\n> ```\n\n\nIndeed. I've opened #34853 for this unrelated issue.",
    "created_at": "2022-12-15T22:05:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661187",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>
Replying to [Dima Pasechnik](#comment%3A19):
> if I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,
> activate `swheels`, and try doing things there, `pip` does not look too healthy:
> 
> ```
> (swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge
> An error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')
> ```


Indeed. I've opened #34853 for this unrelated issue.



---

archive/issue_comments_661188.json:
```json
{
    "body": "<a id='comment:21'></a>\nI'd suggest to look whether mpmath is somehow involved, see #25445",
    "created_at": "2022-12-15T22:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661188",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>
I'd suggest to look whether mpmath is somehow involved, see #25445



---

archive/issue_comments_661189.json:
```json
{
    "body": "<a id='comment:22'></a>\nReplying to [Matthias K\u00f6ppe](#comment%3A21):\n> I'd suggest to look whether mpmath is somehow involved, see #25445\n\n\nIn case, it's exactly the same wheels, `mpmath` included, that are involved here. As to #25445, indeed, `import mpmath` has the same side effect on performance as `import sympy`.\n\nSo we can now test instead the following:\n\n```python\n# p1.py\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:         \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nimport mpmath\n\"\"\"\nprint(\"with mpmath loaded:                       \",\n      timeit.timeit(prog, setup=setup, number=3))\n```",
    "created_at": "2022-12-15T22:20:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661189",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>
Replying to [Matthias Köppe](#comment%3A21):
> I'd suggest to look whether mpmath is somehow involved, see #25445


In case, it's exactly the same wheels, `mpmath` included, that are involved here. As to #25445, indeed, `import mpmath` has the same side effect on performance as `import sympy`.

So we can now test instead the following:

```python
# p1.py
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:         ",
      timeit.timeit(prog, number=3))

setup="""
import mpmath
"""
print("with mpmath loaded:                       ",
      timeit.timeit(prog, setup=setup, number=3))
```



---

archive/issue_comments_661190.json:
```json
{
    "body": "<a id='comment:23'></a>\nTry if the various `MPMATH_...` environment variables (https://github.com/mpmath/mpmath/blob/master/mpmath/libmp/backend.py#L66) have an effect",
    "created_at": "2022-12-15T22:26:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661190",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>
Try if the various `MPMATH_...` environment variables (https://github.com/mpmath/mpmath/blob/master/mpmath/libmp/backend.py#L66) have an effect



---

archive/issue_comments_661191.json:
```json
{
    "body": "<a id='comment:24'></a>\nOops, we're back to `import sage.all` here, as your link points few lines below at\n\n```python\nif ('MPMATH_NOSAGE' not in os.environ and 'SAGE_ROOT' in os.environ or\n        'MPMATH_SAGE' in os.environ):\n    try:\n        import sage.all\n        import sage.libs.mpmath.utils as _sage_utils\n        sage = sage.all\n        sage_utils = _sage_utils\n        BACKEND = 'sage'\n        MPZ = sage.Integer\n    except:\n        pass\n```\nand skipping it indeed cures the discrepancy.\n\n```\n(sage-sh) dima@hilbert:swheels$ MPMATH_NOSAGE=yes python p.py\npython environment with cypari2:          5.126071550010238\nwith sympy loaded:                        5.132636028982233\n(sage-sh) dima@hilbert:swheels$ python p.py\npython environment with cypari2:          5.0600332279573195\nwith sympy loaded:                        8.450407178024761\n```\n\nsorry for the bogus lead :-)\n\nThe question is now - can we import less than `sage.all` pieces?",
    "created_at": "2022-12-15T22:42:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661191",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:24'></a>
Oops, we're back to `import sage.all` here, as your link points few lines below at

```python
if ('MPMATH_NOSAGE' not in os.environ and 'SAGE_ROOT' in os.environ or
        'MPMATH_SAGE' in os.environ):
    try:
        import sage.all
        import sage.libs.mpmath.utils as _sage_utils
        sage = sage.all
        sage_utils = _sage_utils
        BACKEND = 'sage'
        MPZ = sage.Integer
    except:
        pass
```
and skipping it indeed cures the discrepancy.

```
(sage-sh) dima@hilbert:swheels$ MPMATH_NOSAGE=yes python p.py
python environment with cypari2:          5.126071550010238
with sympy loaded:                        5.132636028982233
(sage-sh) dima@hilbert:swheels$ python p.py
python environment with cypari2:          5.0600332279573195
with sympy loaded:                        8.450407178024761
```

sorry for the bogus lead :-)

The question is now - can we import less than `sage.all` pieces?



---

archive/issue_comments_661192.json:
```json
{
    "body": "<a id='comment:25'></a>\nCan you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?",
    "created_at": "2022-12-15T23:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661192",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>
Can you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?



---

archive/issue_comments_661193.json:
```json
{
    "body": "<a id='comment:26'></a>\nReplying to [Matthias K\u00f6ppe](#comment%3A25):\n> Can you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?\n\n\nSuccess with `sage.libs.eclib.mat` or `sage.libs.eclib.homspace` - they are still a serious chunk of `sage.all`, about 40%, by some measure, but not all of it:\n\n```\n$ ./sage --python\n>>> import sys\n>>> import sage.libs.eclib.mat\n>>> len(sys.modules.keys())\n673\n>>> \n```\nvs\n\n```\n$ ./sage --python\nPython 3.10.8 (main, Nov 29 2022, 20:55:11) [GCC 12.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sys\n>>> len(sys.modules.keys())\n74\n>>> import sage.all\n>>> len(sys.modules.keys())\n1712\n```\n\nfor `sage.libs.eclib.homspace` one has `674` keys\n(but these for `sage.libs.eclib.mat` are a subset of these, so we can go with the latter)",
    "created_at": "2022-12-15T23:43:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661193",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>
Replying to [Matthias Köppe](#comment%3A25):
> Can you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?


Success with `sage.libs.eclib.mat` or `sage.libs.eclib.homspace` - they are still a serious chunk of `sage.all`, about 40%, by some measure, but not all of it:

```
$ ./sage --python
>>> import sys
>>> import sage.libs.eclib.mat
>>> len(sys.modules.keys())
673
>>> 
```
vs

```
$ ./sage --python
Python 3.10.8 (main, Nov 29 2022, 20:55:11) [GCC 12.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> len(sys.modules.keys())
74
>>> import sage.all
>>> len(sys.modules.keys())
1712
```

for `sage.libs.eclib.homspace` one has `674` keys
(but these for `sage.libs.eclib.mat` are a subset of these, so we can go with the latter)



---

archive/issue_comments_661194.json:
```json
{
    "body": "<a id='comment:27'></a>\n\n```\n>>> import sage.libs.eclib.mwrank\n>>> len(sys.modules.keys())\n346\n```\nand `import sage.libs.eclib.mwrank` does not reproduce. so we're down to ~330 modules to check  :-)",
    "created_at": "2022-12-15T23:52:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661194",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>

```
>>> import sage.libs.eclib.mwrank
>>> len(sys.modules.keys())
346
```
and `import sage.libs.eclib.mwrank` does not reproduce. so we're down to ~330 modules to check  :-)



---

archive/issue_comments_661195.json:
```json
{
    "body": "<a id='comment:28'></a>\n`eclib` certainly uses `libpari`, so it potentially could be that loading it changes some `pari` defaults.\nBut I don't know anything about this.\nMaybe John C. can comment...",
    "created_at": "2022-12-16T00:04:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661195",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>
`eclib` certainly uses `libpari`, so it potentially could be that loading it changes some `pari` defaults.
But I don't know anything about this.
Maybe John C. can comment...



---

archive/issue_comments_661196.json:
```json
{
    "body": "<a id='comment:29'></a>\nYes, eclib calls some functions in libpari and so must make sure that libpari has been initialised.  This is done in the eclib function `eclib_pari_init` which detects whether it has already been initialised (by testing the value of pari variable \"avma\") and if necessary calls `pari_init()`.  The first parameter  to `pari_init` is taken from the environment variable `PARI_SIZE` and defaults to (currently) `10^8` if that variable is not set or has a value which cannot be converted to a long int.\n\nThe function `eclib_pari_init()` need never be called by users (and is not called by Sage) as it is called automatically when needed by one of two other functions which themseves use pari functions.  I would expect that whenever Sage calls an eclib function which results in eclib's `eclib_pari_init` to be called, it will find that libpari has already been initialised (so avma will be nonzero) and then do nothing.  But my expectation could be wrong in some situations?\n\nSee https://github.com/JohnCremona/eclib/blob/master/libsrc/parifact.cc",
    "created_at": "2022-12-16T08:52:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661196",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:29'></a>
Yes, eclib calls some functions in libpari and so must make sure that libpari has been initialised.  This is done in the eclib function `eclib_pari_init` which detects whether it has already been initialised (by testing the value of pari variable "avma") and if necessary calls `pari_init()`.  The first parameter  to `pari_init` is taken from the environment variable `PARI_SIZE` and defaults to (currently) `10^8` if that variable is not set or has a value which cannot be converted to a long int.

The function `eclib_pari_init()` need never be called by users (and is not called by Sage) as it is called automatically when needed by one of two other functions which themseves use pari functions.  I would expect that whenever Sage calls an eclib function which results in eclib's `eclib_pari_init` to be called, it will find that libpari has already been initialised (so avma will be nonzero) and then do nothing.  But my expectation could be wrong in some situations?

See https://github.com/JohnCremona/eclib/blob/master/libsrc/parifact.cc



---

archive/issue_comments_661197.json:
```json
{
    "body": "<a id='comment:30'></a>\nOK, `avma` is a global Pari variable. Declared in `pari/paristio.h` as \n\n`extern THREAD pari_sp avma;`\n\nPotentially every Sage module depending on Pari might want to check it and run Pari initialisation if it decided to, or perhaps even unconditionally, without checking. I don't know how it plays up in the presence of multithreading, either.\n\nSuspects: `lcalc`, `giac`...\n\nBy the way, also `import src.sage.libs.pari.convert_sage` triggers the slowdown.",
    "created_at": "2022-12-16T10:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661197",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>
OK, `avma` is a global Pari variable. Declared in `pari/paristio.h` as 

`extern THREAD pari_sp avma;`

Potentially every Sage module depending on Pari might want to check it and run Pari initialisation if it decided to, or perhaps even unconditionally, without checking. I don't know how it plays up in the presence of multithreading, either.

Suspects: `lcalc`, `giac`...

By the way, also `import src.sage.libs.pari.convert_sage` triggers the slowdown.



---

archive/issue_comments_661198.json:
```json
{
    "body": "<a id='comment:31'></a>\n`import sage.rings.integer` is another reproducer, with \"only\" 346 sub-imports\n\nlcalc and giac are OK.",
    "created_at": "2022-12-16T14:14:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661198",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>
`import sage.rings.integer` is another reproducer, with "only" 346 sub-imports

lcalc and giac are OK.



---

archive/issue_comments_661199.json:
```json
{
    "body": "<a id='comment:32'></a>\nHave you tried running both versions under `perf top` or `perf record` to see where the time goes?",
    "created_at": "2022-12-16T14:34:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661199",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:32'></a>
Have you tried running both versions under `perf top` or `perf record` to see where the time goes?



---

archive/issue_comments_661200.json:
```json
{
    "body": "<a id='comment:33'></a>\nReplying to [Marc Mezzarobba](#comment%3A32):\n> Have you tried running both versions under `perf top` or `perf record` to see where the time goes?\n\n\nI tried cProfile,  mentioned it on sage-devel.\nNothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.",
    "created_at": "2022-12-16T15:22:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661200",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:33'></a>
Replying to [Marc Mezzarobba](#comment%3A32):
> Have you tried running both versions under `perf top` or `perf record` to see where the time goes?


I tried cProfile,  mentioned it on sage-devel.
Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.



---

archive/issue_comments_661201.json:
```json
{
    "body": "<a id='comment:34'></a>\nReplying to [Dima Pasechnik](#comment%3A31):\n> `import sage.rings.integer` is another reproducer, with \"only\" 346 sub-imports\n\nit is reproducer on Fedora 34, but not on Gentoo. So that's getting even more bizarre.\n> \n> lcalc and giac are OK.\n\non the other hand, they both unconditionally initialise Pari by calling `pari_init_options`.\nIn view of `avma` being a thread-local global variable, I'm not sure about what's going on there, but perhaps we still should patch them as follows:\n\n```diff\n--- a/src/lcalc/Lcommandline.cc\n+++ b/src/lcalc/Lcommandline.cc\n@@ -31,6 +31,9 @@ Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.\n #include \"config.h\"\n #include \"Lcommandline.h\"\n #include \"cmdline.h\"\n+#if HAVE_LIBPARI\n+#include <pari/pari.h>\n+#endif\n \n void pari_err_recover_nop(long errnum) {return;}\n \n@@ -482,10 +485,11 @@ int main (int argc, char *argv[])\n \n \n             t2=.5; //t2=.5 because of the GAMMA(s+1/2)\n-\n+            if (!avma) {\n             pari_init_opts(400000000,2,INIT_DFTm); // the last option is to prevent\n             //pari from giving its interrupt signal when its elliptic curve a_p\n             //algorithm is called and interrupted with ctrl-c.\n+            }\n \n             coeff = new Double[3];\n             //compute the conductor which is copied to coeff[1]\n```\nand for giac:\n\n```diff\ndiff --git a/src/pari.cc b/src/pari.cc\nindex 76ce8e1..bdf1073 100644\n--- a/src/pari.cc\n+++ b/src/pari.cc\n@@ -97,8 +97,10 @@ namespace giac {\n   static void call_pari_init()\n   {\n     // do not initialize INIT_JMP so that PARI error do not exit\n-    pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);\n-    paristack_setsize(pari_mem_size, (1<<30));\n+    if (!avma) {\n+       pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);\n+       paristack_setsize(pari_mem_size, (1<<30));\n+    }\n     // initialize variable ordering x,y,z\n     gp_read_str(\"[x,y,z,t]\");\n   }\n```",
    "created_at": "2022-12-16T16:44:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661201",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>
Replying to [Dima Pasechnik](#comment%3A31):
> `import sage.rings.integer` is another reproducer, with "only" 346 sub-imports

it is reproducer on Fedora 34, but not on Gentoo. So that's getting even more bizarre.
> 
> lcalc and giac are OK.

on the other hand, they both unconditionally initialise Pari by calling `pari_init_options`.
In view of `avma` being a thread-local global variable, I'm not sure about what's going on there, but perhaps we still should patch them as follows:

```diff
--- a/src/lcalc/Lcommandline.cc
+++ b/src/lcalc/Lcommandline.cc
@@ -31,6 +31,9 @@ Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 #include "config.h"
 #include "Lcommandline.h"
 #include "cmdline.h"
+#if HAVE_LIBPARI
+#include <pari/pari.h>
+#endif
 
 void pari_err_recover_nop(long errnum) {return;}
 
@@ -482,10 +485,11 @@ int main (int argc, char *argv[])
 
 
             t2=.5; //t2=.5 because of the GAMMA(s+1/2)
-
+            if (!avma) {
             pari_init_opts(400000000,2,INIT_DFTm); // the last option is to prevent
             //pari from giving its interrupt signal when its elliptic curve a_p
             //algorithm is called and interrupted with ctrl-c.
+            }
 
             coeff = new Double[3];
             //compute the conductor which is copied to coeff[1]
```
and for giac:

```diff
diff --git a/src/pari.cc b/src/pari.cc
index 76ce8e1..bdf1073 100644
--- a/src/pari.cc
+++ b/src/pari.cc
@@ -97,8 +97,10 @@ namespace giac {
   static void call_pari_init()
   {
     // do not initialize INIT_JMP so that PARI error do not exit
-    pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);
-    paristack_setsize(pari_mem_size, (1<<30));
+    if (!avma) {
+       pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);
+       paristack_setsize(pari_mem_size, (1<<30));
+    }
     // initialize variable ordering x,y,z
     gp_read_str("[x,y,z,t]");
   }
```



---

archive/issue_comments_661202.json:
```json
{
    "body": "<a id='comment:35'></a>\nReplying to [Dima Pasechnik](#comment%3A33):\n> Replying to [Marc Mezzarobba](#comment%3A32):\n> > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?\n\n> \n> I tried cProfile,  mentioned it on sage-devel.\n> Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.\n\n\nI'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.",
    "created_at": "2022-12-16T16:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661202",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:35'></a>
Replying to [Dima Pasechnik](#comment%3A33):
> Replying to [Marc Mezzarobba](#comment%3A32):
> > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?

> 
> I tried cProfile,  mentioned it on sage-devel.
> Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.


I'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.



---

archive/issue_comments_661203.json:
```json
{
    "body": "<a id='comment:36'></a>\nReplying to [Marc Mezzarobba](#comment%3A35):\n> Replying to [Dima Pasechnik](#comment%3A33):\n> > Replying to [Marc Mezzarobba](#comment%3A32):\n> > > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?\n\n> > \n> > I tried cProfile,  mentioned it on sage-devel.\n> > Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.\n\n> \n> I'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.\n\n\nI don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...",
    "created_at": "2022-12-16T18:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661203",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>
Replying to [Marc Mezzarobba](#comment%3A35):
> Replying to [Dima Pasechnik](#comment%3A33):
> > Replying to [Marc Mezzarobba](#comment%3A32):
> > > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?

> > 
> > I tried cProfile,  mentioned it on sage-devel.
> > Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.

> 
> I'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.


I don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...



---

archive/issue_comments_661204.json:
```json
{
    "body": "<a id='comment:37'></a>\nReplying to [Dima Pasechnik](#comment%3A36):\n> I don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...\n\n\nJust run\n\n```\nperf record -- sage -python3 pari_timing.py\n```\nand then\n\n```\nperf report\n```",
    "created_at": "2022-12-17T08:51:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661204",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:37'></a>
Replying to [Dima Pasechnik](#comment%3A36):
> I don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...


Just run

```
perf record -- sage -python3 pari_timing.py
```
and then

```
perf report
```



---

archive/issue_comments_661205.json:
```json
{
    "body": "<a id='comment:38'></a>\nAlso, after upgrading my system and going back to python 3.10, I do see the slowdown. I'll check what happens on the 3.11 branch with the same system packages -- but this looks like it will require a full rebuild, so it may take some time.",
    "created_at": "2022-12-17T09:28:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661205",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:38'></a>
Also, after upgrading my system and going back to python 3.10, I do see the slowdown. I'll check what happens on the 3.11 branch with the same system packages -- but this looks like it will require a full rebuild, so it may take some time.



---

archive/issue_comments_661206.json:
```json
{
    "body": "<a id='comment:39'></a>\nThe slowdown is still there after a full rebuild with python\u00a03.11.",
    "created_at": "2022-12-17T13:44:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661206",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:39'></a>
The slowdown is still there after a full rebuild with python 3.11.



---

archive/issue_comments_661207.json:
```json
{
    "body": "<a id='comment:40'></a>\nReplying to [Dima Pasechnik](#comment%3A14):\n\n> On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`\n\n\nYou wrote \u201csystem-wide `pari 2.15.1`\u201d, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?",
    "created_at": "2022-12-17T13:47:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661207",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:40'></a>
Replying to [Dima Pasechnik](#comment%3A14):

> On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`


You wrote “system-wide `pari 2.15.1`”, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?



---

archive/issue_comments_661208.json:
```json
{
    "body": "<a id='comment:41'></a>\nReplying to [Marc Mezzarobba](#comment%3A40):\n> Replying to [Dima Pasechnik](#comment%3A14):\n> \n> > On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`\n\n> \n> You wrote \u201csystem-wide `pari 2.15.1`\u201d, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?\n\n\nI am on #34537 (update to Pari 2.15.1) in Gentoo.\nSo there is an evidence that in this case you need to import more than `sage.rings.integer` to see a slowdown.",
    "created_at": "2022-12-17T14:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661208",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:41'></a>
Replying to [Marc Mezzarobba](#comment%3A40):
> Replying to [Dima Pasechnik](#comment%3A14):
> 
> > On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`

> 
> You wrote “system-wide `pari 2.15.1`”, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?


I am on #34537 (update to Pari 2.15.1) in Gentoo.
So there is an evidence that in this case you need to import more than `sage.rings.integer` to see a slowdown.



---

archive/issue_comments_661209.json:
```json
{
    "body": "<a id='comment:42'></a>\nSo I am now able to reproduce the issue. Comparing the profiles, the main difference seems to be a huge amount of time spent in the dynamic linker, more precisely in `_dl_check_map_versions()` (presumably called by `dlopen()`) and in `update_get_addr()`. Regarding the latter, the relevant code seems to be (`glibc/elf/dl-tls.c`):\n\n```\nvoid *\n__tls_get_addr (GET_ADDR_ARGS)\n{\n  dtv_t *dtv = THREAD_DTV ();\n\n  /* Update is needed if dtv[0].counter < the generation of the accessed\n     module.  The global generation counter is used here as it is easier\n     to check.  Synchronization for the relaxed MO access is guaranteed\n     by user code, see CONCURRENCY NOTES in _dl_update_slotinfo.  */\n  size_t gen = atomic_load_relaxed (&GL(dl_tls_generation));\n  if (__glibc_unlikely (dtv[0].counter != gen))\n    return update_get_addr (GET_ADDR_PARAM);   // <----------\n\n  void *p = dtv[GET_ADDR_MODULE].pointer.val;\n\n  if (__glibc_unlikely (p == TLS_DTV_UNALLOCATED))\n    return tls_get_addr_tail (GET_ADDR_PARAM, dtv, NULL);\n\n  return (char *) p + GET_ADDR_OFFSET;\n}\n```\nAfaict the slow path is never taken when running cypari under plain Python, while it is taken all the time when parts of Sage are loaded.  But I don't know what to make of all that... (There is some information on TLS that looks like it might be relevant at https://chao-tic.github.io/blog/2018/12/25/tls)",
    "created_at": "2022-12-17T16:58:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661209",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:42'></a>
So I am now able to reproduce the issue. Comparing the profiles, the main difference seems to be a huge amount of time spent in the dynamic linker, more precisely in `_dl_check_map_versions()` (presumably called by `dlopen()`) and in `update_get_addr()`. Regarding the latter, the relevant code seems to be (`glibc/elf/dl-tls.c`):

```
void *
__tls_get_addr (GET_ADDR_ARGS)
{
  dtv_t *dtv = THREAD_DTV ();

  /* Update is needed if dtv[0].counter < the generation of the accessed
     module.  The global generation counter is used here as it is easier
     to check.  Synchronization for the relaxed MO access is guaranteed
     by user code, see CONCURRENCY NOTES in _dl_update_slotinfo.  */
  size_t gen = atomic_load_relaxed (&GL(dl_tls_generation));
  if (__glibc_unlikely (dtv[0].counter != gen))
    return update_get_addr (GET_ADDR_PARAM);   // <----------

  void *p = dtv[GET_ADDR_MODULE].pointer.val;

  if (__glibc_unlikely (p == TLS_DTV_UNALLOCATED))
    return tls_get_addr_tail (GET_ADDR_PARAM, dtv, NULL);

  return (char *) p + GET_ADDR_OFFSET;
}
```
Afaict the slow path is never taken when running cypari under plain Python, while it is taken all the time when parts of Sage are loaded.  But I don't know what to make of all that... (There is some information on TLS that looks like it might be relevant at https://chao-tic.github.io/blog/2018/12/25/tls)



---

archive/issue_comments_661210.json:
```json
{
    "body": "<a id='comment:43'></a>\nI don't think your profiling makes much sense this way, as you are not excluding time taken by  `import`, right? \nYou can mitigate this by increasing `number=` to 30 or 50 - then you won't see linker kicking in too much. \n\nOr I misunderstand, and you say that the linker is called by Pari?",
    "created_at": "2022-12-17T18:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661210",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:43'></a>
I don't think your profiling makes much sense this way, as you are not excluding time taken by  `import`, right? 
You can mitigate this by increasing `number=` to 30 or 50 - then you won't see linker kicking in too much. 

Or I misunderstand, and you say that the linker is called by Pari?



---

archive/issue_comments_661211.json:
```json
{
    "body": "<a id='comment:44'></a>\nWhen trying \"python3 with cypari\" and \"python3 with sympy imported\" with `number=50` the effect is much more pronounced than with `number=3` and it seems it's still stuff in the linker that explains the difference in the profile. `perf diff perf_python3.data perf_sympy.data` yields:\n\n```\n              +23.90%  ld-linux-x86-64.so.2                                        [.] _dl_update_slotinfo\n    30.30%    -12.38%  libpari-gmp-tls.so.2.13.4                                   [.] 0x000000000009fc74\n              +10.87%  ld-linux-x86-64.so.2                                        [.] update_get_addr\n    10.31%     -4.60%  libpari-gmp-tls.so.2.13.4                                   [.] addii_sign\n               +4.40%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr_slow\n     6.54%     -2.55%  libpari-gmp-tls.so.2.13.4                                   [.] xxgcduu\n    11.61%     -2.51%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr\n     4.62%     -2.07%  libpari-gmp-tls.so.2.13.4                                   [.] shifti\n     3.24%     -1.45%  libpari-gmp-tls.so.2.13.4                                   [.] muliispec\n     3.11%     -1.16%  libpari-gmp-tls.so.2.13.4                                   [.] dvmdii\n     2.43%     -1.08%  libpari-gmp-tls.so.2.13.4                                   [.] mulii\n     2.09%     -1.01%  libgmp.so.10.4.1                                            [.] __gmpn_divrem_2\n     1.91%     -0.88%  libpari-gmp-tls.so.2.13.4                                   [.] muluu\n     1.75%     -0.84%  libgmp.so.10.4.1                                            [.] __gmpn_addmul_1_x86_64\n     1.70%     -0.62%  libpari-gmp-tls.so.2.13.4                                   [.] abscmpii\n     1.24%     -0.59%  libgmp.so.10.4.1                                            [.] __gmpn_invert_limb\n     1.46%     -0.58%  libgmp.so.10.4.1                                            [.] __gmpn_tdiv_qr\n\n```\nwhere, as far as I can see, `__tls_get_addr_slow` doesn't show up at all for `python3`. So as far as I can see, some switch gets thrown that forces the linker to look up a symbol again and again, in a slower way. I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here.",
    "created_at": "2022-12-17T21:51:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661211",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:44'></a>
When trying "python3 with cypari" and "python3 with sympy imported" with `number=50` the effect is much more pronounced than with `number=3` and it seems it's still stuff in the linker that explains the difference in the profile. `perf diff perf_python3.data perf_sympy.data` yields:

```
              +23.90%  ld-linux-x86-64.so.2                                        [.] _dl_update_slotinfo
    30.30%    -12.38%  libpari-gmp-tls.so.2.13.4                                   [.] 0x000000000009fc74
              +10.87%  ld-linux-x86-64.so.2                                        [.] update_get_addr
    10.31%     -4.60%  libpari-gmp-tls.so.2.13.4                                   [.] addii_sign
               +4.40%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr_slow
     6.54%     -2.55%  libpari-gmp-tls.so.2.13.4                                   [.] xxgcduu
    11.61%     -2.51%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr
     4.62%     -2.07%  libpari-gmp-tls.so.2.13.4                                   [.] shifti
     3.24%     -1.45%  libpari-gmp-tls.so.2.13.4                                   [.] muliispec
     3.11%     -1.16%  libpari-gmp-tls.so.2.13.4                                   [.] dvmdii
     2.43%     -1.08%  libpari-gmp-tls.so.2.13.4                                   [.] mulii
     2.09%     -1.01%  libgmp.so.10.4.1                                            [.] __gmpn_divrem_2
     1.91%     -0.88%  libpari-gmp-tls.so.2.13.4                                   [.] muluu
     1.75%     -0.84%  libgmp.so.10.4.1                                            [.] __gmpn_addmul_1_x86_64
     1.70%     -0.62%  libpari-gmp-tls.so.2.13.4                                   [.] abscmpii
     1.24%     -0.59%  libgmp.so.10.4.1                                            [.] __gmpn_invert_limb
     1.46%     -0.58%  libgmp.so.10.4.1                                            [.] __gmpn_tdiv_qr

```
where, as far as I can see, `__tls_get_addr_slow` doesn't show up at all for `python3`. So as far as I can see, some switch gets thrown that forces the linker to look up a symbol again and again, in a slower way. I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here.



---

archive/issue_comments_661212.json:
```json
{
    "body": "<a id='comment:45'></a>\n> I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here. \n\n\nIndeed, this very, very weird. I've never heard about such cases. But it seems we are now debugging a rather eigenzinnig, pardon my Dutch, Pari's use of threads?",
    "created_at": "2022-12-17T22:08:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661212",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:45'></a>
> I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here. 


Indeed, this very, very weird. I've never heard about such cases. But it seems we are now debugging a rather eigenzinnig, pardon my Dutch, Pari's use of threads?



---

archive/issue_comments_661213.json:
```json
{
    "body": "<a id='comment:46'></a>\nI'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? Note that mpfr, which is used by mpmath, also makes use of gmp, so that could be another source of conflicts. Plus: mpmath has some sage-specific backend stuff, so importing a sage-aware mpmath could have different effects than one that isn't.\n\nOne hypothesis would be that the gmp library gets linked twice: once by python and once by libpari, and perhaps under different threading conditions; leading to an error in initialization of the thread-local storage of libgmp; causing a slow symbol resolution in libgmp every time ...\n\nI did not see a slowdown with `import gmpy2`, so it's something `mpmath` does. It may well be something in `sage.libs.mpmath.ext_main`, which a sage-aware mpmath imports.\n\nIn fact, [ext_libmp.pyx:11](https://github.com/sagemath/sage/blob/bb7ee856390710fc17caf02615de16f5adc66cf2/src/sage/libs/mpmath/ext_libmp.pyx#L11) indicates that sage-aware `mpmath` would call some initialization that has to do with gmp at import-time. So if libpari messes with threads afterwards and links gmp, there may be some room for things to go sideways.",
    "created_at": "2022-12-17T22:22:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661213",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:46'></a>
I'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? Note that mpfr, which is used by mpmath, also makes use of gmp, so that could be another source of conflicts. Plus: mpmath has some sage-specific backend stuff, so importing a sage-aware mpmath could have different effects than one that isn't.

One hypothesis would be that the gmp library gets linked twice: once by python and once by libpari, and perhaps under different threading conditions; leading to an error in initialization of the thread-local storage of libgmp; causing a slow symbol resolution in libgmp every time ...

I did not see a slowdown with `import gmpy2`, so it's something `mpmath` does. It may well be something in `sage.libs.mpmath.ext_main`, which a sage-aware mpmath imports.

In fact, [ext_libmp.pyx:11](https://github.com/sagemath/sage/blob/bb7ee856390710fc17caf02615de16f5adc66cf2/src/sage/libs/mpmath/ext_libmp.pyx#L11) indicates that sage-aware `mpmath` would call some initialization that has to do with gmp at import-time. So if libpari messes with threads afterwards and links gmp, there may be some room for things to go sideways.



---

archive/issue_comments_661214.json:
```json
{
    "body": "<a id='comment:47'></a>\nReplying to [Nils Bruin](#comment%3A46):\n> I'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? \n\n\nSage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.\nBut yes, there is quite a bit of dodgy things going on in `mpmath`.",
    "created_at": "2022-12-17T23:36:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661214",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:47'></a>
Replying to [Nils Bruin](#comment%3A46):
> I'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? 


Sage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.
But yes, there is quite a bit of dodgy things going on in `mpmath`.



---

archive/issue_comments_661215.json:
```json
{
    "body": "<a id='comment:48'></a>\nReplying to [Dima Pasechnik](#comment%3A47):\n> Sage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.\n> But yes, there is quite a bit of dodgy things going on in `mpmath`.\n\n\nApologies for replicating that already-established knowledge. Following up on [comment:23](#comment%3A23): when using the correct syntax to set `MPMATH_NOSAGE=1`, the import of `mpmath` has no adverse effect. So it's something else in `sage.all` that causes the problem (edited in response to [comment:49](#comment%3A49)).",
    "created_at": "2022-12-17T23:54:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661215",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:48'></a>
Replying to [Dima Pasechnik](#comment%3A47):
> Sage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.
> But yes, there is quite a bit of dodgy things going on in `mpmath`.


Apologies for replicating that already-established knowledge. Following up on [comment:23](#comment%3A23): when using the correct syntax to set `MPMATH_NOSAGE=1`, the import of `mpmath` has no adverse effect. So it's something else in `sage.all` that causes the problem (edited in response to [comment:49](#comment%3A49)).



---

archive/issue_comments_661216.json:
```json
{
    "body": "<a id='comment:49'></a>\nReplying to [Nils Bruin](#comment%3A48):\n> Following up on [comment:23](#comment%3A23): as far as I can see, `MPMATH_NOSAGE, MPMATH_NOGMPY` have no influence on the result.\n\n\nAre you sure?\n\n```\n(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py\npython environment with cypari2:           3.799615835014265\nwith mpmath loaded:   6.606633314979263\n(sage-sh) marc@tramontane:tmp$ export MPMATH_NOSAGE=1\n(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py\npython environment with cypari2:           3.996781985013513\nwith mpmath loaded:   4.207063634006772\n```",
    "created_at": "2022-12-18T09:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661216",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:49'></a>
Replying to [Nils Bruin](#comment%3A48):
> Following up on [comment:23](#comment%3A23): as far as I can see, `MPMATH_NOSAGE, MPMATH_NOGMPY` have no influence on the result.


Are you sure?

```
(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py
python environment with cypari2:           3.799615835014265
with mpmath loaded:   6.606633314979263
(sage-sh) marc@tramontane:tmp$ export MPMATH_NOSAGE=1
(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py
python environment with cypari2:           3.996781985013513
with mpmath loaded:   4.207063634006772
```



---

archive/issue_comments_661217.json:
```json
{
    "body": "<a id='comment:50'></a>\nto quote GCC people on the topic `__tls_get_addr`\nhttps://gcc.gnu.org/bugzilla/show_bug.cgi?id=81501#c6\n\n```\nWe recently upgraded our toolchain from GCC9 to GCC11, and we're seeing __tls_get_addr\ntake up to 10% of total runtime under some workloads, where it was 1-2% before.\n```\n\nindeed, this means that if `__tls_get_addr` gets slowed down, the same code might suddenly get visibly slower.",
    "created_at": "2022-12-18T11:21:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661217",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:50'></a>
to quote GCC people on the topic `__tls_get_addr`
https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81501#c6

```
We recently upgraded our toolchain from GCC9 to GCC11, and we're seeing __tls_get_addr
take up to 10% of total runtime under some workloads, where it was 1-2% before.
```

indeed, this means that if `__tls_get_addr` gets slowed down, the same code might suddenly get visibly slower.



---

archive/issue_comments_661218.json:
```json
{
    "body": "<a id='comment:51'></a>\nThe story of `__tls_get_addr_slow` in glibc (https://github.com/lattera/glibc/blob/master/sysdeps/x86_64/tls_get_addr.S) starts from\nhttps://gcc.gnu.org/bugzilla/show_bug.cgi?id=58066\n\nbut I can't make much sense of it. Something to do with misaligned stack.",
    "created_at": "2022-12-18T12:14:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661218",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:51'></a>
The story of `__tls_get_addr_slow` in glibc (https://github.com/lattera/glibc/blob/master/sysdeps/x86_64/tls_get_addr.S) starts from
https://gcc.gnu.org/bugzilla/show_bug.cgi?id=58066

but I can't make much sense of it. Something to do with misaligned stack.



---

archive/issue_comments_661219.json:
```json
{
    "body": "<a id='comment:52'></a>\nBill suggested to try PARI without thread support (`Configure --mt=single`).",
    "created_at": "2022-12-18T13:17:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661219",
    "user": "https://github.com/videlec"
}
```

<a id='comment:52'></a>
Bill suggested to try PARI without thread support (`Configure --mt=single`).



---

archive/issue_comments_661220.json:
```json
{
    "body": "<a id='comment:53'></a>\nPossibly relevant:\nhttps://sourceware.org/bugzilla/show_bug.cgi?id=19924",
    "created_at": "2022-12-18T13:40:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661220",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:53'></a>
Possibly relevant:
https://sourceware.org/bugzilla/show_bug.cgi?id=19924



---

archive/issue_comments_661221.json:
```json
{
    "body": "<a id='comment:54'></a>\nReplying to [Marc Mezzarobba](#comment%3A53):\n> Possibly relevant:\n> https://sourceware.org/bugzilla/show_bug.cgi?id=19924\n\n\n\n```\nwe have noticed a performance degradation of TLS access in shared libraries. If another shared library that uses TLS is loaded via dlopen, __tls_get_addr takes significant more time. Once that shared library accesses it's TLS, the performance normalizes.\n```\n\nSo it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:\n\n```\nsetup=\"\"\"\nimport sage.all\n_ = libgap(1)\n_ = giac(1)\n... etc\n\"\"\"\n```\nthen the test itself should run faster. (But I can't work on this now)",
    "created_at": "2022-12-18T14:15:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661221",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:54'></a>
Replying to [Marc Mezzarobba](#comment%3A53):
> Possibly relevant:
> https://sourceware.org/bugzilla/show_bug.cgi?id=19924



```
we have noticed a performance degradation of TLS access in shared libraries. If another shared library that uses TLS is loaded via dlopen, __tls_get_addr takes significant more time. Once that shared library accesses it's TLS, the performance normalizes.
```

So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:

```
setup="""
import sage.all
_ = libgap(1)
_ = giac(1)
... etc
"""
```
then the test itself should run faster. (But I can't work on this now)



---

archive/issue_comments_661222.json:
```json
{
    "body": "<a id='comment:55'></a>\nReplying to [Vincent Delecroix](#comment%3A52):\n> Bill suggested to try PARI without thread support (`Configure --mt=single`).\n\n\nthis is incompatible with giac, IIRC",
    "created_at": "2022-12-18T14:17:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661222",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:55'></a>
Replying to [Vincent Delecroix](#comment%3A52):
> Bill suggested to try PARI without thread support (`Configure --mt=single`).


this is incompatible with giac, IIRC



---

archive/issue_comments_661223.json:
```json
{
    "body": "<a id='comment:56'></a>\nReplying to [Dima Pasechnik](#comment%3A54):\n> So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:\n\n\nDoesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?",
    "created_at": "2022-12-18T14:28:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661223",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:56'></a>
Replying to [Dima Pasechnik](#comment%3A54):
> So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:


Doesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?



---

archive/issue_comments_661224.json:
```json
{
    "body": "<a id='comment:57'></a>\nReplying to [Marc Mezzarobba](#comment%3A56):\n> Replying to [Dima Pasechnik](#comment%3A54):\n> > So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:\n\n> \n> Doesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?\n\n\ncertainly not all of them matter (e.g. we know that importing sage.libs.eclib.mwrank is OK, but\nsage.libs.eclib.mat is not)",
    "created_at": "2022-12-18T14:34:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661224",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:57'></a>
Replying to [Marc Mezzarobba](#comment%3A56):
> Replying to [Dima Pasechnik](#comment%3A54):
> > So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:

> 
> Doesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?


certainly not all of them matter (e.g. we know that importing sage.libs.eclib.mwrank is OK, but
sage.libs.eclib.mat is not)



---

archive/issue_comments_661225.json:
```json
{
    "body": "<a id='comment:58'></a>\nSome more details on where the slowdown appears to be happening, in case this gives someone an idea. If we look at the context where `__tls_get_addr` is running in the version with sage loaded, we get (children are callers; percentages are cycle counts for callchains with a given callee):\n\n```\n-   21,83%    21,83%  python3  ld-linux-x86-64.so.2\n   - 78,46% _dl_update_slotinfo (inlined)\n      - 65,84% update_get_addr (inlined)\n         - __tls_get_addr (inlined)\n            + 66,50% new_chunk (inlined)\n            + 27,93% set_avma (inlined)\n            + 2,41% dvmdii (inlined)\n            + 1,57% addmulii_lg3 (inlined)\n        3,91% 0x3\n        3,36% 0x1\n        2,25% 0x4\n        2,23% 0x2\n        0,73% 0xfffffffffffffffe\n        0,60% 0x1f\n        0,52% 0x17\n   - 21,52% update_get_addr (inlined)\n      - 37,56% __tls_get_addr (inlined)\n         + 59,76% new_chunk (inlined)\n         + 34,12% set_avma (inlined)\n         + 2,43% dvmdii (inlined)\n         + 1,26% addmulii_lg3 (inlined)\n         + 0,66% qficomp0 (inlined)\n        8,31% 0x3\n        6,80% 0x2\n        3,53% 0x4\n        1,51% 0xffffffffffffffff\n        1,14% 0x1\n        1,10% 0x1f\n        1,02% 0xfffffffffffffffe\n        0,97% 0x17\n```\nSo basically the callers are low-level pari functions that access things like `avma` and `pari_stack`.",
    "created_at": "2022-12-18T14:37:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661225",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:58'></a>
Some more details on where the slowdown appears to be happening, in case this gives someone an idea. If we look at the context where `__tls_get_addr` is running in the version with sage loaded, we get (children are callers; percentages are cycle counts for callchains with a given callee):

```
-   21,83%    21,83%  python3  ld-linux-x86-64.so.2
   - 78,46% _dl_update_slotinfo (inlined)
      - 65,84% update_get_addr (inlined)
         - __tls_get_addr (inlined)
            + 66,50% new_chunk (inlined)
            + 27,93% set_avma (inlined)
            + 2,41% dvmdii (inlined)
            + 1,57% addmulii_lg3 (inlined)
        3,91% 0x3
        3,36% 0x1
        2,25% 0x4
        2,23% 0x2
        0,73% 0xfffffffffffffffe
        0,60% 0x1f
        0,52% 0x17
   - 21,52% update_get_addr (inlined)
      - 37,56% __tls_get_addr (inlined)
         + 59,76% new_chunk (inlined)
         + 34,12% set_avma (inlined)
         + 2,43% dvmdii (inlined)
         + 1,26% addmulii_lg3 (inlined)
         + 0,66% qficomp0 (inlined)
        8,31% 0x3
        6,80% 0x2
        3,53% 0x4
        1,51% 0xffffffffffffffff
        1,14% 0x1
        1,10% 0x1f
        1,02% 0xfffffffffffffffe
        0,97% 0x17
```
So basically the callers are low-level pari functions that access things like `avma` and `pari_stack`.



---

archive/issue_comments_661226.json:
```json
{
    "body": "<a id='comment:59'></a>\nReplying to [Dima Pasechnik](#comment%3A57):\n> we know that importing sage.libs.eclib.mwrank is OK, but\n> sage.libs.eclib.mat is not\n\n\nAbove you said that they both reproduce the slowdown, and that's also what I observe. Looks like importing `sage.libs.eclib.mwrank` causes 69 `dlopen`s... (I'm counting lines containig `direct_opencount` in the output of `LD_DEBUG=files`; not surt if that's right.)",
    "created_at": "2022-12-18T15:04:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661226",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:59'></a>
Replying to [Dima Pasechnik](#comment%3A57):
> we know that importing sage.libs.eclib.mwrank is OK, but
> sage.libs.eclib.mat is not


Above you said that they both reproduce the slowdown, and that's also what I observe. Looks like importing `sage.libs.eclib.mwrank` causes 69 `dlopen`s... (I'm counting lines containig `direct_opencount` in the output of `LD_DEBUG=files`; not surt if that's right.)



---

archive/issue_comments_661227.json:
```json
{
    "body": "<a id='comment:60'></a>\na missing 'not' in [comment:27](#comment%3A27) - edited now.\n\nhowever, this is all so volatile, no surprise it it is different for you.\n\nI wonder if a fix is possible within Python importing machinery",
    "created_at": "2022-12-18T15:58:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661227",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:60'></a>
a missing 'not' in [comment:27](#comment%3A27) - edited now.

however, this is all so volatile, no surprise it it is different for you.

I wonder if a fix is possible within Python importing machinery



---

archive/issue_comments_661228.json:
```json
{
    "body": "<a id='comment:61'></a>\nI can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:\n\n```\npython environment with cypari2:           4.8728421429987065\nwith sage custom GMP allocation functions: 4.884550739021506\nwith mpmath loaded:   4.292751049972139\nwith sympy loaded:   4.475166625983547\nwith sage.libs.eclib.mwrank loaded:   4.776536963006947\nwith sage.rings.integer loaded:   4.415787325997371\nwith the whole sagemath library loaded:   7.537986656010617\n```\nThis is all with system pari 2.15.1 and system sagemath 9.7.",
    "created_at": "2022-12-18T20:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661228",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:61'></a>
I can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:

```
python environment with cypari2:           4.8728421429987065
with sage custom GMP allocation functions: 4.884550739021506
with mpmath loaded:   4.292751049972139
with sympy loaded:   4.475166625983547
with sage.libs.eclib.mwrank loaded:   4.776536963006947
with sage.rings.integer loaded:   4.415787325997371
with the whole sagemath library loaded:   7.537986656010617
```
This is all with system pari 2.15.1 and system sagemath 9.7.



---

archive/issue_comments_661229.json:
```json
{
    "body": "<a id='comment:62'></a>\nReplying to [Gonzalo Tornar\u00eda](#comment%3A61):\n> I can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:\n> \n> ```\n> python environment with cypari2:           4.8728421429987065\n> with sage custom GMP allocation functions: 4.884550739021506\n> with mpmath loaded:   4.292751049972139\n> with sympy loaded:   4.475166625983547\n> with sage.libs.eclib.mwrank loaded:   4.776536963006947\n> with sage.rings.integer loaded:   4.415787325997371\n> with the whole sagemath library loaded:   7.537986656010617\n> ```\n> This is all with system pari 2.15.1 and system sagemath 9.7.\n\n\nhow about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)",
    "created_at": "2022-12-18T20:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661229",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:62'></a>
Replying to [Gonzalo Tornaría](#comment%3A61):
> I can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:
> 
> ```
> python environment with cypari2:           4.8728421429987065
> with sage custom GMP allocation functions: 4.884550739021506
> with mpmath loaded:   4.292751049972139
> with sympy loaded:   4.475166625983547
> with sage.libs.eclib.mwrank loaded:   4.776536963006947
> with sage.rings.integer loaded:   4.415787325997371
> with the whole sagemath library loaded:   7.537986656010617
> ```
> This is all with system pari 2.15.1 and system sagemath 9.7.


how about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)



---

archive/issue_comments_661230.json:
```json
{
    "body": "<a id='comment:63'></a>\nReplying to [Dima Pasechnik](#comment%3A62):\n> how about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)\n\n\nYes, and it tracks down to one of these:\n- `sage.rings.finite_rings.finite_field_constructor`\n- `sage.rings.finite_rings.finite_field_givaro`\n- `sage.rings.finite_rings.element_givaro`",
    "created_at": "2022-12-18T20:50:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661230",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:63'></a>
Replying to [Dima Pasechnik](#comment%3A62):
> how about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)


Yes, and it tracks down to one of these:
- `sage.rings.finite_rings.finite_field_constructor`
- `sage.rings.finite_rings.finite_field_givaro`
- `sage.rings.finite_rings.element_givaro`



---

archive/issue_comments_661231.json:
```json
{
    "body": "<a id='comment:64'></a>\nThis seems to depend on the order the shared libraries are loaded. In this case, loading `-larb` earlier seems to avoid the slowdown. Here's a hack to do it:\n\n- Using the original file from the ticket description:\n\n```\n$ python pari_timing.py \npython environment with cypari2:           4.7771418140036985\nwith sage custom GMP allocation functions: 4.94545228901552\nwith the whole sagemath library lodaded:   7.068615118972957\n```\n\n- With \"the hack\":\n\n```\n$ python pari_timing-stub.py \npython environment with cypari2:           5.000043574022129\nwith sage custom GMP allocation functions: 4.970149756001774\nwith the whole sagemath library lodaded:   4.352886867010966\n```\n- It all amounts to load a trivial stub module before loading sage.all:\n\n```\n$ diff -u pari_timing.py pari_timing-stub.py \n--- pari_timing.py\t2022-12-18 19:00:03.984366341 -0300\n+++ pari_timing-stub.py\t2022-12-18 19:00:18.996184656 -0300\n@@ -19,6 +19,7 @@\n       timeit.timeit(prog, setup=setup, number=3))\n \n setup=\"\"\"\n+import stub\n import sage.all\n \"\"\"\n print(\"with the whole sagemath library lodaded:  \",\n```\n- The stub does nothing, but it is linked with `-larb`:\n\n```\n$ cat stub.c \n#include <Python.h>\n\nstruct PyModuleDef stub = {\n\tPyModuleDef_HEAD_INIT,\n\t\"stub\", NULL, -1, NULL\n};\n\nPyMODINIT_FUNC\nPyInit_stub(void)\n{\n\treturn PyModule_Create(&stub);\n}\n$ cc -I/usr/include/python3.11 stub.c -fPIC -larb -shared -o stub.so\n```",
    "created_at": "2022-12-18T23:33:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661231",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:64'></a>
This seems to depend on the order the shared libraries are loaded. In this case, loading `-larb` earlier seems to avoid the slowdown. Here's a hack to do it:

- Using the original file from the ticket description:

```
$ python pari_timing.py 
python environment with cypari2:           4.7771418140036985
with sage custom GMP allocation functions: 4.94545228901552
with the whole sagemath library lodaded:   7.068615118972957
```

- With "the hack":

```
$ python pari_timing-stub.py 
python environment with cypari2:           5.000043574022129
with sage custom GMP allocation functions: 4.970149756001774
with the whole sagemath library lodaded:   4.352886867010966
```
- It all amounts to load a trivial stub module before loading sage.all:

```
$ diff -u pari_timing.py pari_timing-stub.py 
--- pari_timing.py	2022-12-18 19:00:03.984366341 -0300
+++ pari_timing-stub.py	2022-12-18 19:00:18.996184656 -0300
@@ -19,6 +19,7 @@
       timeit.timeit(prog, setup=setup, number=3))
 
 setup="""
+import stub
 import sage.all
 """
 print("with the whole sagemath library lodaded:  ",
```
- The stub does nothing, but it is linked with `-larb`:

```
$ cat stub.c 
#include <Python.h>

struct PyModuleDef stub = {
	PyModuleDef_HEAD_INIT,
	"stub", NULL, -1, NULL
};

PyMODINIT_FUNC
PyInit_stub(void)
{
	return PyModule_Create(&stub);
}
$ cc -I/usr/include/python3.11 stub.c -fPIC -larb -shared -o stub.so
```



---

archive/issue_comments_661232.json:
```json
{
    "body": "<a id='comment:65'></a>\nVoil\u00e0:\n\n```\n$ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py \npython environment with cypari2:           4.7483764729695395\nwith sage custom GMP allocation functions: 4.830055630998686\nwith the whole sagemath library lodaded:   4.3143665379611775\n$ git diff\ndiff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\nindex a6090039db2..a2e379d4a42 100644\n--- a/src/sage/rings/all.py\n+++ b/src/sage/rings/all.py\n@@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod\n from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod\n Integers = IntegerModRing\n \n+# this must come early (see #34850)\n+# at least before finite_rings, number_field, polynomial, ...\n+from sage.rings.real_arb import RealBallField, RBF\n+\n # Finite fields\n from .finite_rings.all import *\n \n@@ -103,8 +107,6 @@ from .real_double import RealDoubleField, RDF, RealDoubleElement\n \n from .real_lazy import RealLazyField, RLF, ComplexLazyField, CLF\n \n-from sage.rings.real_arb import RealBallField, RBF\n-\n # Polynomial Rings and Polynomial Quotient Rings\n from .polynomial.all import *\n \n```",
    "created_at": "2022-12-18T23:38:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661232",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:65'></a>
Voilà:

```
$ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py 
python environment with cypari2:           4.7483764729695395
with sage custom GMP allocation functions: 4.830055630998686
with the whole sagemath library lodaded:   4.3143665379611775
$ git diff
diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
index a6090039db2..a2e379d4a42 100644
--- a/src/sage/rings/all.py
+++ b/src/sage/rings/all.py
@@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod
 from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod
 Integers = IntegerModRing
 
+# this must come early (see #34850)
+# at least before finite_rings, number_field, polynomial, ...
+from sage.rings.real_arb import RealBallField, RBF
+
 # Finite fields
 from .finite_rings.all import *
 
@@ -103,8 +107,6 @@ from .real_double import RealDoubleField, RDF, RealDoubleElement
 
 from .real_lazy import RealLazyField, RLF, ComplexLazyField, CLF
 
-from sage.rings.real_arb import RealBallField, RBF
-
 # Polynomial Rings and Polynomial Quotient Rings
 from .polynomial.all import *
 
```



---

archive/issue_comments_661233.json:
```json
{
    "body": "<a id='comment:66'></a>\nCool! It definitely seems to solve the problem. However, it doesn't really explain what was going wrong here. And that means this solution may be a bit fragile, since you're just triggering something that happens to have the right (unknown) side-effect.\n\nIn particular, it's pretty clear that the problem here is coming from libpari, and libpari does not depend on arb, nor does arb depend on libpari. So I'd think it's a common dependence. If we look at those:\n\n```\n$ ldd /lib64/libpari.so\n\tlinux-vdso.so.1 (0x00007ffc513f0000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fe3cd400000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fe3ce256000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fe3ce15d000)\n\tlibgmp.so.10 => /lib64/libgmp.so.10 (0x00007fe3ce0b8000)\n\tlibgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fe3ce098000)\n$ ldd /lib64/libarb.so\n\tlinux-vdso.so.1 (0x00007ffce20ab000)\n\tlibflint.so.17 => /lib64/libflint.so.17 (0x00007f1b6c600000)\n\tlibmpfr.so.6 => /lib64/libmpfr.so.6 (0x00007f1b6d18c000)\n\tlibgmp.so.10 => /lib64/libgmp.so.10 (0x00007f1b6c55b000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f1b6c47d000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f1b6c200000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f1b6d25a000)\n\tlibflexiblas.so.3 => /lib64/libflexiblas.so.3 (0x00007f1b6be00000)\n\tlibntl.so.44 => /lib64/libntl.so.44 (0x00007f1b6ba00000)\n\tlibstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007f1b6b600000)\n\tlibgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f1b6d16a000)\n\tlibgfortran.so.5 => /lib64/libgfortran.so.5 (0x00007f1b6b200000)\n\tlibquadmath.so.0 => /lib64/libquadmath.so.0 (0x00007f1b6d122000)\n\tlibgf2x.so.3 => /lib64/libgf2x.so.3 (0x00007f1b6d111000)\n```\nso perhaps you can already get the desired effect by linking to libgmp?",
    "created_at": "2022-12-19T01:49:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661233",
    "user": "https://github.com/nbruin"
}
```

<a id='comment:66'></a>
Cool! It definitely seems to solve the problem. However, it doesn't really explain what was going wrong here. And that means this solution may be a bit fragile, since you're just triggering something that happens to have the right (unknown) side-effect.

In particular, it's pretty clear that the problem here is coming from libpari, and libpari does not depend on arb, nor does arb depend on libpari. So I'd think it's a common dependence. If we look at those:

```
$ ldd /lib64/libpari.so
	linux-vdso.so.1 (0x00007ffc513f0000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fe3cd400000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fe3ce256000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fe3ce15d000)
	libgmp.so.10 => /lib64/libgmp.so.10 (0x00007fe3ce0b8000)
	libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fe3ce098000)
$ ldd /lib64/libarb.so
	linux-vdso.so.1 (0x00007ffce20ab000)
	libflint.so.17 => /lib64/libflint.so.17 (0x00007f1b6c600000)
	libmpfr.so.6 => /lib64/libmpfr.so.6 (0x00007f1b6d18c000)
	libgmp.so.10 => /lib64/libgmp.so.10 (0x00007f1b6c55b000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f1b6c47d000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f1b6c200000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f1b6d25a000)
	libflexiblas.so.3 => /lib64/libflexiblas.so.3 (0x00007f1b6be00000)
	libntl.so.44 => /lib64/libntl.so.44 (0x00007f1b6ba00000)
	libstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007f1b6b600000)
	libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f1b6d16a000)
	libgfortran.so.5 => /lib64/libgfortran.so.5 (0x00007f1b6b200000)
	libquadmath.so.0 => /lib64/libquadmath.so.0 (0x00007f1b6d122000)
	libgf2x.so.3 => /lib64/libgf2x.so.3 (0x00007f1b6d111000)
```
so perhaps you can already get the desired effect by linking to libgmp?



---

archive/issue_comments_661234.json:
```json
{
    "body": "<a id='comment:67'></a>\nHere's a way to reproduce independent of sage and without compiled modules (other than using `ctypes` to dlopen libraries):\n\n```\n$ python pari_timing3.py \npython environment with cypari2:  4.842002137971576\nwith -lmpfi:                      8.262313047016505\nwith -larb:                       4.4230794320465066\n```\n\nHere's `pari_timing3.py`:\n\n```python\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2: \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfi.so')\n\"\"\"\nprint(\"with -lmpfi:                     \",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\n\"\"\"\nprint(\"with -larb:                      \",\n      timeit.timeit(prog, setup=setup, number=3))\n```\n\nFirst guess: `-lmpfi` is doing something weird at load time. Then `-larb` is fixing it. For some reason, whatever `-larb` is doing doesn't work if it's done too late (as in `import sage.all` without my patch). Loading `-larb` first prevents `-lmpfr` from doing any wrong as you can see reverting the order in this script.",
    "created_at": "2022-12-19T02:05:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661234",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:67'></a>
Here's a way to reproduce independent of sage and without compiled modules (other than using `ctypes` to dlopen libraries):

```
$ python pari_timing3.py 
python environment with cypari2:  4.842002137971576
with -lmpfi:                      8.262313047016505
with -larb:                       4.4230794320465066
```

Here's `pari_timing3.py`:

```python
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2: ",
      timeit.timeit(prog, number=3))

setup="""
from ctypes import cdll
cdll.LoadLibrary('libmpfi.so')
"""
print("with -lmpfi:                     ",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
"""
print("with -larb:                      ",
      timeit.timeit(prog, setup=setup, number=3))
```

First guess: `-lmpfi` is doing something weird at load time. Then `-larb` is fixing it. For some reason, whatever `-larb` is doing doesn't work if it's done too late (as in `import sage.all` without my patch). Loading `-larb` first prevents `-lmpfr` from doing any wrong as you can see reverting the order in this script.



---

archive/issue_comments_661235.json:
```json
{
    "body": "<a id='comment:68'></a>\nChanging `-lmpfi` for `-lmpfr` gives the same result.\n\nSince `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.\n\nThis still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.",
    "created_at": "2022-12-19T02:17:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661235",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:68'></a>
Changing `-lmpfi` for `-lmpfr` gives the same result.

Since `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.

This still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.



---

archive/issue_comments_661236.json:
```json
{
    "body": "<a id='comment:69'></a>\nIt seems to me that `timeit` is not run in an independent process. Namely if you **start** with `setup=\"import sage.all\"` then everything get slow. Do anyone knows of a solution to run these in independent processes?",
    "created_at": "2022-12-19T07:53:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661236",
    "user": "https://github.com/videlec"
}
```

<a id='comment:69'></a>
It seems to me that `timeit` is not run in an independent process. Namely if you **start** with `setup="import sage.all"` then everything get slow. Do anyone knows of a solution to run these in independent processes?



---

archive/attachments_021654.json:
```json
{
    "asset_content_type": "application/octet-stream",
    "asset_name": "pari_timing.py",
    "asset_url": "tarball://root/attachments/some-uuid/ticket34850/pari_timing.py",
    "created_at": "2022-12-19T09:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "attachment",
    "url": "https://github.com/assets/some-id/some-uuid.py",
    "user": "https://github.com/videlec"
}
```



---

archive/issue_comments_661237.json:
```json
{
    "body": "",
    "created_at": "2022-12-19T09:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661237",
    "user": "https://github.com/videlec"
}
```





---

archive/issue_comments_661238.json:
```json
{
    "body": "<a id='comment:70'></a>\nIn [pari_timing.py](https://trac.sagemath.org/raw-attachment/ticket/34850/pari_timing.py) the timeit is now run in independent process. I only see a slowdown for `import sage.all`\n\n```\nsetup 0\nimport sage.all\n9.015203488990664\n--------------------------------------------------\nsetup 1\n5.769485066004563\n--------------------------------------------------\nsetup 2\nimport sympy\n5.582505510014016\n--------------------------------------------------\nsetup 3\nfrom ctypes import cdll\ncdll.LoadLibrary('libgmp.so')\n5.503667832992505\n--------------------------------------------------\nsetup 4\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\n5.5995761190133635\n--------------------------------------------------\nsetup 5\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfr.so')\n5.045454590988811\n--------------------------------------------------\nsetup 6\nfrom ctypes import cdll\ncdll.LoadLibrary('libgiac.so')\n5.5255847749940585\n--------------------------------------------------\nfast_runs: [1, 2, 3, 4, 5, 6]\nslow_runs: [0]\n```",
    "created_at": "2022-12-19T09:49:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661238",
    "user": "https://github.com/videlec"
}
```

<a id='comment:70'></a>
In [pari_timing.py](https://trac.sagemath.org/raw-attachment/ticket/34850/pari_timing.py) the timeit is now run in independent process. I only see a slowdown for `import sage.all`

```
setup 0
import sage.all
9.015203488990664
--------------------------------------------------
setup 1
5.769485066004563
--------------------------------------------------
setup 2
import sympy
5.582505510014016
--------------------------------------------------
setup 3
from ctypes import cdll
cdll.LoadLibrary('libgmp.so')
5.503667832992505
--------------------------------------------------
setup 4
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
5.5995761190133635
--------------------------------------------------
setup 5
from ctypes import cdll
cdll.LoadLibrary('libmpfr.so')
5.045454590988811
--------------------------------------------------
setup 6
from ctypes import cdll
cdll.LoadLibrary('libgiac.so')
5.5255847749940585
--------------------------------------------------
fast_runs: [1, 2, 3, 4, 5, 6]
slow_runs: [0]
```



---

archive/issue_comments_661239.json:
```json
{
    "body": "<a id='comment:71'></a>\nAre you telling mpmath (imported from sympy) to not import sage.all? Cause that's what it does by default, and I get `slow_runs: [0,2]` (cf. [comment:24](#comment%3A24))",
    "created_at": "2022-12-19T11:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661239",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:71'></a>
Are you telling mpmath (imported from sympy) to not import sage.all? Cause that's what it does by default, and I get `slow_runs: [0,2]` (cf. [comment:24](#comment%3A24))



---

archive/issue_comments_661240.json:
```json
{
    "body": "<a id='comment:72'></a>\nStill, I can confirm Gonzalo's discovery that `arb` may be used to cure the slowness: modifying `setup 0` so that it's loaded first makes setup 0 fast:\n\n```\nsetup 0\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\nimport sage.all\n4.591498055000557\n--------------------------------------------------\nsetup 1\n4.60094984099851\n...\n```\n\nThat is, I changed the test file part as follows:\n\n```\n...\n# build different setups\nsetups = []\nlib=\"arb\"\nsetup = \"from ctypes import cdll\\n\"\nsetup += \"cdll.LoadLibrary('lib{}.so')\\n\".format(lib)\nsetup += \"import sage.all\"\nsetups.append(setup)\nsetups.append(\"\")\nsetups.append(\"import sympy\")\n...\n```",
    "created_at": "2022-12-19T11:29:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661240",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:72'></a>
Still, I can confirm Gonzalo's discovery that `arb` may be used to cure the slowness: modifying `setup 0` so that it's loaded first makes setup 0 fast:

```
setup 0
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
import sage.all
4.591498055000557
--------------------------------------------------
setup 1
4.60094984099851
...
```

That is, I changed the test file part as follows:

```
...
# build different setups
setups = []
lib="arb"
setup = "from ctypes import cdll\n"
setup += "cdll.LoadLibrary('lib{}.so')\n".format(lib)
setup += "import sage.all"
setups.append(setup)
setups.append("")
setups.append("import sympy")
...
```



---

archive/issue_comments_661241.json:
```json
{
    "body": "<a id='comment:73'></a>\nAnother interesting observation - if I build giac with the patch in [comment:34](#comment%3A34) then \n\n```\nsetup 6\nfrom ctypes import cdll\ncdll.LoadLibrary('libgiac.so')\n```\ngets as slow as `setup 0` (with `sage.all`).\n\nI think it's Pari messing up things for everything else, no? Also, I don't know why Pari has to be called in `cysignals`, and nothing else - why such a royal treatment?",
    "created_at": "2022-12-19T11:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661241",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:73'></a>
Another interesting observation - if I build giac with the patch in [comment:34](#comment%3A34) then 

```
setup 6
from ctypes import cdll
cdll.LoadLibrary('libgiac.so')
```
gets as slow as `setup 0` (with `sage.all`).

I think it's Pari messing up things for everything else, no? Also, I don't know why Pari has to be called in `cysignals`, and nothing else - why such a royal treatment?



---

archive/issue_comments_661242.json:
```json
{
    "body": "<a id='comment:74'></a>\nSo if arb knows what to do, it would be worth asking Fredrik J perhaps",
    "created_at": "2022-12-19T11:46:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661242",
    "user": "https://github.com/JohnCremona"
}
```

<a id='comment:74'></a>
So if arb knows what to do, it would be worth asking Fredrik J perhaps



---

archive/issue_comments_661243.json:
```json
{
    "body": "<a id='comment:75'></a>\nOh yeah, I was just going to invite Fredrik to look at this mess...",
    "created_at": "2022-12-19T11:55:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661243",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:75'></a>
Oh yeah, I was just going to invite Fredrik to look at this mess...



---

archive/issue_comments_661244.json:
```json
{
    "body": "<a id='comment:76'></a>\nReplying to [Gonzalo Tornar\u00eda](#comment%3A65):\n> Voil\u00e0:\n> \n> ```\n> $ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py \n> python environment with cypari2:           4.7483764729695395\n> with sage custom GMP allocation functions: 4.830055630998686\n> with the whole sagemath library lodaded:   4.3143665379611775\n> $ git diff\n> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\n> ...\n> ```\n\n\ndoes not work for me - while \n\n```\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\nimport sage.all\n```\n\ndoes work. So it's even crazier than we think it is.",
    "created_at": "2022-12-19T11:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661244",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:76'></a>
Replying to [Gonzalo Tornaría](#comment%3A65):
> Voilà:
> 
> ```
> $ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py 
> python environment with cypari2:           4.7483764729695395
> with sage custom GMP allocation functions: 4.830055630998686
> with the whole sagemath library lodaded:   4.3143665379611775
> $ git diff
> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
> ...
> ```


does not work for me - while 

```
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
import sage.all
```

does work. So it's even crazier than we think it is.



---

archive/issue_comments_661245.json:
```json
{
    "body": "<a id='comment:77'></a>\nFredrik, we'd really appreciate your input on the magical action of `arb` on `sage.all` we are observing here...",
    "created_at": "2022-12-19T12:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661245",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:77'></a>
Fredrik, we'd really appreciate your input on the magical action of `arb` on `sage.all` we are observing here...



---

archive/issue_comments_661246.json:
```json
{
    "body": "<a id='comment:78'></a>\nI have absolutely no idea what is going on.\n\nArb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.",
    "created_at": "2022-12-19T12:43:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661246",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:78'></a>
I have absolutely no idea what is going on.

Arb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.



---

archive/issue_comments_661247.json:
```json
{
    "body": "<a id='comment:79'></a>\nReplying to [Gonzalo Tornar\u00eda](#comment%3A68):\n> Changing `-lmpfi` for `-lmpfr` gives the same result.\n> \n> Since `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.\n\n\nSo far (if I understand you correctly) it's not inconsistent with a link to https://sourceware.org/bugzilla/show_bug.cgi?id=19924. If loading an object that uses TLS slows down TLS accesses for previously loaded ones until the newly loaded object accesses TLS(!), the magic arb is doing may just be accessing, or causing mpfr to access, a thread-local variable... That's very speculative though.\n\n> This still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.\n\n\nIt may be interesting to compare the actual loading order of pari, mpfr, and arb (using LD_DEBUG=files) depending at what point arb is imported.",
    "created_at": "2022-12-19T12:52:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661247",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:79'></a>
Replying to [Gonzalo Tornaría](#comment%3A68):
> Changing `-lmpfi` for `-lmpfr` gives the same result.
> 
> Since `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.


So far (if I understand you correctly) it's not inconsistent with a link to https://sourceware.org/bugzilla/show_bug.cgi?id=19924. If loading an object that uses TLS slows down TLS accesses for previously loaded ones until the newly loaded object accesses TLS(!), the magic arb is doing may just be accessing, or causing mpfr to access, a thread-local variable... That's very speculative though.

> This still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.


It may be interesting to compare the actual loading order of pari, mpfr, and arb (using LD_DEBUG=files) depending at what point arb is imported.



---

archive/issue_comments_661248.json:
```json
{
    "body": "<a id='comment:80'></a>\nReplying to [Gonzalo Tornar\u00eda](#comment%3A65):\n> Voil\u00e0:\n> \n> ```\n> [...]\n> $ git diff\n> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\n> index a6090039db2..a2e379d4a42 100644\n> --- a/src/sage/rings/all.py\n> +++ b/src/sage/rings/all.py\n> @@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod\n>  from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod\n>  Integers = IntegerModRing\n>  \n> +# this must come early (see #34850)\n> +# at least before finite_rings, number_field, polynomial, ...\n> +from sage.rings.real_arb import RealBallField, RBF\n> +\n>  # Finite fields\n>  from .finite_rings.all import *\n> [...]\n> ```\n\n\nDoesn't seem to work here...",
    "created_at": "2022-12-19T13:08:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661248",
    "user": "https://github.com/mezzarobba"
}
```

<a id='comment:80'></a>
Replying to [Gonzalo Tornaría](#comment%3A65):
> Voilà:
> 
> ```
> [...]
> $ git diff
> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
> index a6090039db2..a2e379d4a42 100644
> --- a/src/sage/rings/all.py
> +++ b/src/sage/rings/all.py
> @@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod
>  from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod
>  Integers = IntegerModRing
>  
> +# this must come early (see #34850)
> +# at least before finite_rings, number_field, polynomial, ...
> +from sage.rings.real_arb import RealBallField, RBF
> +
>  # Finite fields
>  from .finite_rings.all import *
> [...]
> ```


Doesn't seem to work here...



---

archive/issue_comments_661249.json:
```json
{
    "body": "<a id='comment:81'></a>\nOf course, the problem is loading pari + mpfr *in that order*:\n\n```\nsetup 0\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfr.so')\n\n4.866691738017835\n--------------------------------------------------\nsetup 1\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n\n7.862922856991645\n--------------------------------------------------\nsetup 2\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libpari.so')\n\n4.771596382022835\n--------------------------------------------------\nfast_runs: [0, 2]\nslow_runs: [1]\n```",
    "created_at": "2022-12-19T13:23:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661249",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:81'></a>
Of course, the problem is loading pari + mpfr *in that order*:

```
setup 0

from ctypes import cdll
cdll.LoadLibrary('libmpfr.so')

4.866691738017835
--------------------------------------------------
setup 1

from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')

7.862922856991645
--------------------------------------------------
setup 2

from ctypes import cdll
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libpari.so')

4.771596382022835
--------------------------------------------------
fast_runs: [0, 2]
slow_runs: [1]
```



---

archive/issue_comments_661250.json:
```json
{
    "body": "<a id='comment:82'></a>\nIndeed. And adding `arb` afterwards makes it fast again\n\n```\nsetup 0\n5.139136525016511\n--------------------------------------------------\nsetup 1\nimport sage.all\n8.28667692601448\n--------------------------------------------------\nsetup 2\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n8.265609099005815\n--------------------------------------------------\nsetup 3\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libarb.so')\n4.878138452011626\n--------------------------------------------------\nfast_runs: [0, 3]\nslow_runs: [1, 2]\n```",
    "created_at": "2022-12-19T13:39:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661250",
    "user": "https://github.com/videlec"
}
```

<a id='comment:82'></a>
Indeed. And adding `arb` afterwards makes it fast again

```
setup 0
5.139136525016511
--------------------------------------------------
setup 1
import sage.all
8.28667692601448
--------------------------------------------------
setup 2
from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
8.265609099005815
--------------------------------------------------
setup 3
from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libarb.so')
4.878138452011626
--------------------------------------------------
fast_runs: [0, 3]
slow_runs: [1, 2]
```



---

archive/issue_comments_661251.json:
```json
{
    "body": "<a id='comment:83'></a>\nBTW, it is `libflint.so` that \"fixes\" it (libarb loads libflint):\n\n```\nsetup 0\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libflint.so')\n\n4.84125757496804\n--------------------------------------------------\nsetup 1\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n\n7.785827331012115\n```",
    "created_at": "2022-12-19T13:39:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661251",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:83'></a>
BTW, it is `libflint.so` that "fixes" it (libarb loads libflint):

```
setup 0

from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libflint.so')

4.84125757496804
--------------------------------------------------
setup 1

from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')

7.785827331012115
```



---

archive/issue_comments_661252.json:
```json
{
    "body": "<a id='comment:84'></a>\nSomething else: running the same test using musl libc (instead of glibc), shows no slowdown at all.",
    "created_at": "2022-12-19T13:55:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661252",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:84'></a>
Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.



---

archive/issue_comments_661253.json:
```json
{
    "body": "<a id='comment:85'></a>\nReplying to [Gonzalo Tornar\u00eda](#comment%3A84):\n> Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.\n\n\nThis is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.\n\nDoes Sage as a whole work on `musl` `libc`?",
    "created_at": "2022-12-19T14:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661253",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:85'></a>
Replying to [Gonzalo Tornaría](#comment%3A84):
> Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.


This is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.

Does Sage as a whole work on `musl` `libc`?



---

archive/issue_comments_661254.json:
```json
{
    "body": "<a id='comment:86'></a>\nReplying to [Fredrik Johansson](#comment%3A78):\n> I have absolutely no idea what is going on.\n> \n> Arb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.\n\n\nthere is a Dutch proverb \"doe maar gewoon, dan doet je al gek genoeg\" (\"doing things a normal way is already crazy enough\")\n\nCould you describe briefly what you do with TLS? How does it play together with initialising (or not) GMP?",
    "created_at": "2022-12-19T14:17:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661254",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:86'></a>
Replying to [Fredrik Johansson](#comment%3A78):
> I have absolutely no idea what is going on.
> 
> Arb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.


there is a Dutch proverb "doe maar gewoon, dan doet je al gek genoeg" ("doing things a normal way is already crazy enough")

Could you describe briefly what you do with TLS? How does it play together with initialising (or not) GMP?



---

archive/issue_comments_661255.json:
```json
{
    "body": "<a id='comment:87'></a>\nTLS is used for thread-local caches in MPFR and Arb for things like the value of pi. There are some caches in FLINT too, including the fmpz cache.\n\nI don't think there is any TLS in GMP. The only mutable state in GMP AFAIK is the set of memory allocation functions.",
    "created_at": "2022-12-19T15:23:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661255",
    "user": "https://github.com/fredrik-johansson"
}
```

<a id='comment:87'></a>
TLS is used for thread-local caches in MPFR and Arb for things like the value of pi. There are some caches in FLINT too, including the fmpz cache.

I don't think there is any TLS in GMP. The only mutable state in GMP AFAIK is the set of memory allocation functions.



---

archive/issue_comments_661256.json:
```json
{
    "body": "<a id='comment:88'></a>\nReplying to [Dima Pasechnik](#comment%3A85):\n> Replying to [Gonzalo Tornar\u00eda](#comment%3A84):\n> > Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.\n\n> \n> This is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.\n> \n> Does Sage as a whole work on `musl` `libc`?\n\n\nWorks fine, all doctest pass, etc. This is using sage-the-library and all system packages, it may be that we use some patches for system packages that are not in the packages in sage-the-distro.",
    "created_at": "2022-12-19T21:21:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34850#issuecomment-661256",
    "user": "https://github.com/tornaria"
}
```

<a id='comment:88'></a>
Replying to [Dima Pasechnik](#comment%3A85):
> Replying to [Gonzalo Tornaría](#comment%3A84):
> > Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.

> 
> This is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.
> 
> Does Sage as a whole work on `musl` `libc`?


Works fine, all doctest pass, etc. This is using sage-the-library and all system packages, it may be that we use some patches for system packages that are not in the packages in sage-the-distro.
