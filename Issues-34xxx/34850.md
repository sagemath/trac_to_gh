# Issue 34850: sage-loaded libraries are slowing down cypari2 a lot (on x86_64 glibc)

archive/issues_034613.json:
```json
{
    "assignees": [],
    "body": "<div id=\"comment:0\"></div>\n\n\n```python\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:          \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom sage.ext.memory import init_memory_functions\ninit_memory_functions()\n\"\"\"\nprint(\"with sage custom GMP allocation functions:\",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nimport sage.all\n\"\"\"\nprint(\"with the whole sagemath library lodaded:  \",\n      timeit.timeit(prog, setup=setup, number=3))\n```\ngives\n\n```\n$ python pari_timing.py \npython environment with cypari2:           4.871978694998688\nwith sage custom GMP allocation functions: 4.941096214999561\nwith the whole sagemath library lodaded:   7.39602135700261\n```\n\nSee also\n- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)\n- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)\n\nCC:  @edgarcosta @mkoeppe @JohnCremona @fredrik-johansson @zimmermann6\n\nComponent: **performance**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34850_\n\n",
    "created_at": "2022-12-14T20:10:39Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/performance",
        "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "sage-loaded libraries are slowing down cypari2 a lot (on x86_64 glibc)",
    "type": "issue",
    "updated_at": "2023-01-07T19:44:47Z",
    "url": "https://github.com/sagemath/sage/issues/34850",
    "user": "https://github.com/videlec"
}
```
<div id="comment:0"></div>


```python
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:          ",
      timeit.timeit(prog, number=3))

setup="""
from sage.ext.memory import init_memory_functions
init_memory_functions()
"""
print("with sage custom GMP allocation functions:",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
import sage.all
"""
print("with the whole sagemath library lodaded:  ",
      timeit.timeit(prog, setup=setup, number=3))
```
gives

```
$ python pari_timing.py 
python environment with cypari2:           4.871978694998688
with sage custom GMP allocation functions: 4.941096214999561
with the whole sagemath library lodaded:   7.39602135700261
```

See also
- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)
- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)

CC:  @edgarcosta @mkoeppe @JohnCremona @fredrik-johansson @zimmermann6

Component: **performance**

_Issue created by migration from https://trac.sagemath.org/ticket/34850_





---

archive/issue_events_470850.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2022-12-14T20:10:39Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34850#event-470850"
}
```



---

archive/issue_events_470851.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2022-12-14T20:10:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "label": "https://github.com/sagemath/sage/labels/performance",
    "label_color": "696969",
    "label_name": "performance",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34850#event-470851"
}
```



---

archive/issue_events_470852.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2022-12-14T20:10:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "label": "https://github.com/sagemath/sage/labels/p%3A%20critical%20/%202",
    "label_color": "ff7700",
    "label_name": "p: critical / 2",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34850#event-470852"
}
```



---

archive/issue_events_470853.json:
```json
{
    "actor": "https://github.com/videlec",
    "created_at": "2022-12-14T20:10:39Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34850#event-470853"
}
```



---

archive/issue_comments_561554.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -5,10 +5,10 @@\n prog=\"\"\"\n from cypari2 import Pari\n pari = Pari(size={size})\n-pari({cmd})\n+pari(\"{cmd}\")\n \"\"\"\n \n-prog = prog.format(size=2**24, cmd=\"\\\"quadclassunit(1 - 2^100)\\\"\")\n+prog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n \n print(\"python environment with cypari2:          \",\n       timeit.timeit(prog, number=3))\n``````\n",
    "created_at": "2022-12-14T20:11:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561554",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -5,10 +5,10 @@
 prog="""
 from cypari2 import Pari
 pari = Pari(size={size})
-pari({cmd})
+pari("{cmd}")
 """
 
-prog = prog.format(size=2**24, cmd="\"quadclassunit(1 - 2^100)\"")
+prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")
 
 print("python environment with cypari2:          ",
       timeit.timeit(prog, number=3))
``````




---

archive/issue_comments_561555.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -34,3 +34,7 @@\n with sage custom GMP allocation functions: 4.941096214999561\n with the whole sagemath library lodaded:   7.39602135700261\n ```\n+\n+See also\n+- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)\n+- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)\n``````\n",
    "created_at": "2022-12-14T20:25:41Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561555",
    "user": "https://github.com/videlec"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -34,3 +34,7 @@
 with sage custom GMP allocation functions: 4.941096214999561
 with the whole sagemath library lodaded:   7.39602135700261
 ```
+
+See also
+- [this sage-devel thread](https://groups.google.com/g/sage-devel/c/eAXPdguK_Aw)
+- a similar problem with pari_jupyter [pari-jupyter/#27](https://github.com/sagemath/pari-jupyter/issues/27)
``````




---

archive/issue_comments_561556.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nCould it be just a different memory layout as soon as `sage.all` is imported, causing the memory consumption of the process to increase about 6-fold ?",
    "created_at": "2022-12-15T00:09:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561556",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:3" align="right">comment:3</div>

Could it be just a different memory layout as soon as `sage.all` is imported, causing the memory consumption of the process to increase about 6-fold ?



---

archive/issue_comments_561557.json:
```json
{
    "body": "<div id=\"comment:5\" align=\"right\">comment:5</div>\n\nFWIW, I don't see the issue on my system:\n\n```\npython environment with cypari2:           3.9759535739940475\nwith sage custom GMP allocation functions: 4.250082928003394\nwith the whole sagemath library lodaded:   3.8536450660030823\n```\n(edit: I previously posted a version where I was running the test code under sage, not ipython, but the results above are with ipython)",
    "created_at": "2022-12-15T10:22:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561557",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:5" align="right">comment:5</div>

FWIW, I don't see the issue on my system:

```
python environment with cypari2:           3.9759535739940475
with sage custom GMP allocation functions: 4.250082928003394
with the whole sagemath library lodaded:   3.8536450660030823
```
(edit: I previously posted a version where I was running the test code under sage, not ipython, but the results above are with ipython)



---

archive/issue_comments_561558.json:
```json
{
    "body": "<div id=\"comment:6\" align=\"right\">comment:6</div>\n\nThanks Marc for running the test. What is your configuration? eg what is the system and does sage use system pari?",
    "created_at": "2022-12-15T10:26:05Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561558",
    "user": "https://github.com/videlec"
}
```

<div id="comment:6" align="right">comment:6</div>

Thanks Marc for running the test. What is your configuration? eg what is the system and does sage use system pari?



---

archive/issue_comments_561559.json:
```json
{
    "body": "<div id=\"comment:7\" align=\"right\">comment:7</div>\n\nI was going to add more details after doit `sage -f pari`\u2014which is still running at the moment. But the example above is already using sage's pari (I also have a systemwide pari, but it is a different version). This is on Debian sid with an Intel cpu. Note that I am using Python 3.11 via #33842.",
    "created_at": "2022-12-15T10:33:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561559",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:7" align="right">comment:7</div>

I was going to add more details after doit `sage -f pari`—which is still running at the moment. But the example above is already using sage's pari (I also have a systemwide pari, but it is a different version). This is on Debian sid with an Intel cpu. Note that I am using Python 3.11 via #33842.



---

archive/issue_comments_561560.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\non ubuntu 22.04.01 LTS:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.8.beta5, Release Date: 2022-12-11               \u2502\n\u2502 Using Python 3.10.6. Type \"help()\" for help.                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: import timeit\n....: \n....: prog=\"\"\"\n....: from cypari2 import Pari\n....: pari = Pari(size={size})\n....: pari(\"{cmd}\")\n....: \"\"\"\n....: \n....: prog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n....: \n....: print(\"python environment with cypari2:          \",\n....:       timeit.timeit(prog, number=3))\n....: \n....: setup=\"\"\"\n....: from sage.ext.memory import init_memory_functions\n....: init_memory_functions()\n....: \"\"\"\n....: print(\"with sage custom GMP allocation functions:\",\n....:       timeit.timeit(prog, setup=setup, number=3))\n....: \n....: setup=\"\"\"\n....: import sage.all\n....: \"\"\"\n....: print(\"with the whole sagemath library lodaded:  \",\n....:       timeit.timeit(prog, setup=setup, number=3))\npython environment with cypari2:           5.757997545006219\nwith sage custom GMP allocation functions: 5.887209259002702\nwith the whole sagemath library lodaded:   5.1330207900027744\n```",
    "created_at": "2022-12-15T11:30:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561560",
    "user": "https://github.com/mantepse"
}
```

<div id="comment:8" align="right">comment:8</div>

on ubuntu 22.04.01 LTS:

```
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.8.beta5, Release Date: 2022-12-11               │
│ Using Python 3.10.6. Type "help()" for help.                       │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: import timeit
....: 
....: prog="""
....: from cypari2 import Pari
....: pari = Pari(size={size})
....: pari("{cmd}")
....: """
....: 
....: prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")
....: 
....: print("python environment with cypari2:          ",
....:       timeit.timeit(prog, number=3))
....: 
....: setup="""
....: from sage.ext.memory import init_memory_functions
....: init_memory_functions()
....: """
....: print("with sage custom GMP allocation functions:",
....:       timeit.timeit(prog, setup=setup, number=3))
....: 
....: setup="""
....: import sage.all
....: """
....: print("with the whole sagemath library lodaded:  ",
....:       timeit.timeit(prog, setup=setup, number=3))
python environment with cypari2:           5.757997545006219
with sage custom GMP allocation functions: 5.887209259002702
with the whole sagemath library lodaded:   5.1330207900027744
```



---

archive/issue_comments_561561.json:
```json
{
    "body": "<div id=\"comment:9\" align=\"right\">comment:9</div>\n\nIf you replace\n\n```\n    import sage.all\n```\nwith\n\n```\n    import sympy\n```\nyou'll get the same slowdown. Bingo! Sympy probably changes FPU status, it seems, according to\n`build/pkgs/sympow/email-exchange.txt`",
    "created_at": "2022-12-15T12:01:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561561",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:9" align="right">comment:9</div>

If you replace

```
    import sage.all
```
with

```
    import sympy
```
you'll get the same slowdown. Bingo! Sympy probably changes FPU status, it seems, according to
`build/pkgs/sympow/email-exchange.txt`



---

archive/issue_comments_561562.json:
```json
{
    "body": "<div id=\"comment:10\" align=\"right\">comment:10</div>\n\nReplying to [Dima Pasechnik](#comment%3A9):\n> Sympy probably changes FPU status, it seems, according to\n> `build/pkgs/sympow/email-exchange.txt`\n\nDid you accidentally look in `sympow/` instead of `sympy/`, or do you mean sympow also has something to do with it?\n\nI (obviously) don't see any slowdown here with `import sympy` either, even after reinstalling sympy with `sage -f`.",
    "created_at": "2022-12-15T12:35:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561562",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:10" align="right">comment:10</div>

Replying to [Dima Pasechnik](#comment%3A9):
> Sympy probably changes FPU status, it seems, according to
> `build/pkgs/sympow/email-exchange.txt`

Did you accidentally look in `sympow/` instead of `sympy/`, or do you mean sympow also has something to do with it?

I (obviously) don't see any slowdown here with `import sympy` either, even after reinstalling sympy with `sage -f`.



---

archive/issue_comments_561563.json:
```json
{
    "body": "<div id=\"comment:11\" align=\"right\">comment:11</div>\n\nYou know that the greatest discoveries are made by accident ;-) \n\nIndeed, I went looking for FPU in sage source repo, and found that `sympow` thing, which got swapped to `sympy` in my brain... Anyhow, for me `sympy` causes the same slowdown:\n\n```\n$ ./sage --python p.py\npython environment with cypari2:           4.7912631159997545\nwith sage custom GMP allocation functions: 4.886824406014057\nwith sympy loaded:   6.885674357006792\n$ cat p.py\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:          \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom sage.ext.memory import init_memory_functions\ninit_memory_functions()\n\"\"\"\nprint(\"with sage custom GMP allocation functions:\",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nimport sympy\n\"\"\"\nprint(\"with sympy loaded:  \",\n      timeit.timeit(prog, setup=setup, number=3))\n```",
    "created_at": "2022-12-15T12:49:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561563",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:11" align="right">comment:11</div>

You know that the greatest discoveries are made by accident ;-) 

Indeed, I went looking for FPU in sage source repo, and found that `sympow` thing, which got swapped to `sympy` in my brain... Anyhow, for me `sympy` causes the same slowdown:

```
$ ./sage --python p.py
python environment with cypari2:           4.7912631159997545
with sage custom GMP allocation functions: 4.886824406014057
with sympy loaded:   6.885674357006792
$ cat p.py
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:          ",
      timeit.timeit(prog, number=3))

setup="""
from sage.ext.memory import init_memory_functions
init_memory_functions()
"""
print("with sage custom GMP allocation functions:",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
import sympy
"""
print("with sympy loaded:  ",
      timeit.timeit(prog, setup=setup, number=3))
```



---

archive/issue_comments_561564.json:
```json
{
    "body": "<div id=\"comment:12\" align=\"right\">comment:12</div>\n\nI see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.\n\nI see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)",
    "created_at": "2022-12-15T13:06:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561564",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:12" align="right">comment:12</div>

I see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.

I see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)



---

archive/issue_comments_561565.json:
```json
{
    "body": "<div id=\"comment:13\" align=\"right\">comment:13</div>\n\nReplying to [Dima Pasechnik](#comment%3A12):\n> I see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.\n> \n> I see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)\n\nInteresting.\n- on system sage on archlinux : no difference between no setup and `import sympy`\n- on the compiled sage : same slowdown with `import sympy` and `import sage.all`",
    "created_at": "2022-12-15T15:15:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561565",
    "user": "https://github.com/videlec"
}
```

<div id="comment:13" align="right">comment:13</div>

Replying to [Dima Pasechnik](#comment%3A12):
> I see this `sympy` difference on the latest Sage beta on 3 boxes: Fedora 34 with a newish CPU, and on Gentoo with a much older CPU, and on Debian Bullseye (stable) with an even older and slower CPU.
> 
> I see a bit of a **speedup**, by about 15%,  with either `sage.all` or `sympy` imported on macOS 13 (x86_64, as well as arm64, aka M1)

Interesting.
- on system sage on archlinux : no difference between no setup and `import sympy`
- on the compiled sage : same slowdown with `import sympy` and `import sage.all`



---

archive/issue_comments_561566.json:
```json
{
    "body": "<div id=\"comment:14\" align=\"right\">comment:14</div>\n\nnarrowing it down further, with taking all of Sage out:\n\n```python\n# p1.py\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:         \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nimport sympy\n\"\"\"\nprint(\"with sympy loaded:                       \",\n      timeit.timeit(prog, setup=setup, number=3))\n```\n\nOn Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`\n\n* \"naked\" system python,  pip-installed `cypari2` and `sympy` - no time difference\n* venv'ed system python,  pip-installed `cypari2` and `sympy` - no time difference\n* Sage's-venv wrapped system python, Sage-installed `cypari` and `sympy` - `sympy` produces a slowdown.  \n\nSo this is down to interaction between python, sympy, and cypari2 (and Sage's venv?)",
    "created_at": "2022-12-15T16:56:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561566",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:14" align="right">comment:14</div>

narrowing it down further, with taking all of Sage out:

```python
# p1.py
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:         ",
      timeit.timeit(prog, number=3))

setup="""
import sympy
"""
print("with sympy loaded:                       ",
      timeit.timeit(prog, setup=setup, number=3))
```

On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`

* "naked" system python,  pip-installed `cypari2` and `sympy` - no time difference
* venv'ed system python,  pip-installed `cypari2` and `sympy` - no time difference
* Sage's-venv wrapped system python, Sage-installed `cypari` and `sympy` - `sympy` produces a slowdown.  

So this is down to interaction between python, sympy, and cypari2 (and Sage's venv?)



---

archive/issue_comments_561567.json:
```json
{
    "body": "<div id=\"comment:15\" align=\"right\">comment:15</div>\n\nMatthias, there is something funny in Sage's venv, causing such a slowdown on Linux.",
    "created_at": "2022-12-15T17:04:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561567",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:15" align="right">comment:15</div>

Matthias, there is something funny in Sage's venv, causing such a slowdown on Linux.



---

archive/issue_comments_561568.json:
```json
{
    "body": "<div id=\"comment:16\" align=\"right\">comment:16</div>\n\nTo narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.",
    "created_at": "2022-12-15T17:48:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561568",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:16" align="right">comment:16</div>

To narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.



---

archive/issue_comments_561569.json:
```json
{
    "body": "<div id=\"comment:17\" align=\"right\">comment:17</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A16):\n> To narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.\n\nThis way, no difference in timing, so the wheels themselves are OK.",
    "created_at": "2022-12-15T20:53:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561569",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:17" align="right">comment:17</div>

Replying to [Matthias Köppe](#comment%3A16):
> To narrow it down further, you can try installing the Sage-built wheels (from venv/var/lib/sage/wheels/) in a separate venv. Specifically, take cypari2 from the sage wheel rather than from pypi.

This way, no difference in timing, so the wheels themselves are OK.



---

archive/issue_comments_561570.json:
```json
{
    "body": "<div id=\"comment:18\" align=\"right\">comment:18</div>\n\nNext you could check whether it makes a difference to run the separate venv inside or outside of the sage environment set up by `sage -sh`.",
    "created_at": "2022-12-15T21:15:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561570",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:18" align="right">comment:18</div>

Next you could check whether it makes a difference to run the separate venv inside or outside of the sage environment set up by `sage -sh`.



---

archive/issue_comments_561571.json:
```json
{
    "body": "<div id=\"comment:19\" align=\"right\">comment:19</div>\n\nif I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,\nactivate `swheels`, and try doing things there, `pip` does not look too healthy:\n\n```\n(swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge\nAn error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')\n```\n\nregardless, `pip install` works there, and I can run the test - again, no difference in time.\nSo, somehow, putting Sage's python into venv cures this time discrepancy.\n\n```\n(swheels) (sage-sh) dima@hilbert:swheels$ python p.py\npython environment with cypari2:          5.116253892017994\nwith sympy loaded:                        5.216335576027632\n(swheels) (sage-sh) dima@hilbert:swheels$ deactivate \n(sage-sh) dima@hilbert:swheels$ which python\n/mnt/opt/Sage/sage-dev/local/var/lib/sage/venv-python3.10/bin/python\n(sage-sh) dima@hilbert:swheels$ python p.py \npython environment with cypari2:          5.446458007965703\nwith sympy loaded:                        8.667378643993288\n```",
    "created_at": "2022-12-15T22:02:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561571",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:19" align="right">comment:19</div>

if I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,
activate `swheels`, and try doing things there, `pip` does not look too healthy:

```
(swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge
An error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')
```

regardless, `pip install` works there, and I can run the test - again, no difference in time.
So, somehow, putting Sage's python into venv cures this time discrepancy.

```
(swheels) (sage-sh) dima@hilbert:swheels$ python p.py
python environment with cypari2:          5.116253892017994
with sympy loaded:                        5.216335576027632
(swheels) (sage-sh) dima@hilbert:swheels$ deactivate 
(sage-sh) dima@hilbert:swheels$ which python
/mnt/opt/Sage/sage-dev/local/var/lib/sage/venv-python3.10/bin/python
(sage-sh) dima@hilbert:swheels$ python p.py 
python environment with cypari2:          5.446458007965703
with sympy loaded:                        8.667378643993288
```



---

archive/issue_comments_561572.json:
```json
{
    "body": "<div id=\"comment:20\" align=\"right\">comment:20</div>\n\nReplying to [Dima Pasechnik](#comment%3A19):\n> if I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,\n> activate `swheels`, and try doing things there, `pip` does not look too healthy:\n> \n> ```\n> (swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge\n> An error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')\n> ```\n\nIndeed. I've opened #34853 for this unrelated issue.",
    "created_at": "2022-12-15T22:05:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561572",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:20" align="right">comment:20</div>

Replying to [Dima Pasechnik](#comment%3A19):
> if I start `sage -sh`, cd somewhere outside Sage directory, run `python -m venv swheels`,
> activate `swheels`, and try doing things there, `pip` does not look too healthy:
> 
> ```
> (swheels) (sage-sh) dima@hilbert:swheels$ pip cache purge
> An error occurred during configuration: option format: invalid choice: 'columns' (choose from 'human', 'abspath')
> ```

Indeed. I've opened #34853 for this unrelated issue.



---

archive/issue_comments_561573.json:
```json
{
    "body": "<div id=\"comment:21\" align=\"right\">comment:21</div>\n\nI'd suggest to look whether mpmath is somehow involved, see #25445",
    "created_at": "2022-12-15T22:07:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561573",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:21" align="right">comment:21</div>

I'd suggest to look whether mpmath is somehow involved, see #25445



---

archive/issue_comments_561574.json:
```json
{
    "body": "<div id=\"comment:22\" align=\"right\">comment:22</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A21):\n> I'd suggest to look whether mpmath is somehow involved, see #25445\n\nIn case, it's exactly the same wheels, `mpmath` included, that are involved here. As to #25445, indeed, `import mpmath` has the same side effect on performance as `import sympy`.\n\nSo we can now test instead the following:\n\n```python\n# p1.py\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2:         \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nimport mpmath\n\"\"\"\nprint(\"with mpmath loaded:                       \",\n      timeit.timeit(prog, setup=setup, number=3))\n```",
    "created_at": "2022-12-15T22:20:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561574",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:22" align="right">comment:22</div>

Replying to [Matthias Köppe](#comment%3A21):
> I'd suggest to look whether mpmath is somehow involved, see #25445

In case, it's exactly the same wheels, `mpmath` included, that are involved here. As to #25445, indeed, `import mpmath` has the same side effect on performance as `import sympy`.

So we can now test instead the following:

```python
# p1.py
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2:         ",
      timeit.timeit(prog, number=3))

setup="""
import mpmath
"""
print("with mpmath loaded:                       ",
      timeit.timeit(prog, setup=setup, number=3))
```



---

archive/issue_comments_561575.json:
```json
{
    "body": "<div id=\"comment:23\" align=\"right\">comment:23</div>\n\nTry if the various `MPMATH_...` environment variables (https://github.com/mpmath/mpmath/blob/master/mpmath/libmp/backend.py#L66) have an effect",
    "created_at": "2022-12-15T22:26:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561575",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:23" align="right">comment:23</div>

Try if the various `MPMATH_...` environment variables (https://github.com/mpmath/mpmath/blob/master/mpmath/libmp/backend.py#L66) have an effect



---

archive/issue_comments_561576.json:
```json
{
    "body": "<div id=\"comment:24\" align=\"right\">comment:24</div>\n\nOops, we're back to `import sage.all` here, as your link points few lines below at\n\n```python\nif ('MPMATH_NOSAGE' not in os.environ and 'SAGE_ROOT' in os.environ or\n        'MPMATH_SAGE' in os.environ):\n    try:\n        import sage.all\n        import sage.libs.mpmath.utils as _sage_utils\n        sage = sage.all\n        sage_utils = _sage_utils\n        BACKEND = 'sage'\n        MPZ = sage.Integer\n    except:\n        pass\n```\nand skipping it indeed cures the discrepancy.\n\n```\n(sage-sh) dima@hilbert:swheels$ MPMATH_NOSAGE=yes python p.py\npython environment with cypari2:          5.126071550010238\nwith sympy loaded:                        5.132636028982233\n(sage-sh) dima@hilbert:swheels$ python p.py\npython environment with cypari2:          5.0600332279573195\nwith sympy loaded:                        8.450407178024761\n```\n\nsorry for the bogus lead :-)\n\nThe question is now - can we import less than `sage.all` pieces?",
    "created_at": "2022-12-15T22:42:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561576",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:24" align="right">comment:24</div>

Oops, we're back to `import sage.all` here, as your link points few lines below at

```python
if ('MPMATH_NOSAGE' not in os.environ and 'SAGE_ROOT' in os.environ or
        'MPMATH_SAGE' in os.environ):
    try:
        import sage.all
        import sage.libs.mpmath.utils as _sage_utils
        sage = sage.all
        sage_utils = _sage_utils
        BACKEND = 'sage'
        MPZ = sage.Integer
    except:
        pass
```
and skipping it indeed cures the discrepancy.

```
(sage-sh) dima@hilbert:swheels$ MPMATH_NOSAGE=yes python p.py
python environment with cypari2:          5.126071550010238
with sympy loaded:                        5.132636028982233
(sage-sh) dima@hilbert:swheels$ python p.py
python environment with cypari2:          5.0600332279573195
with sympy loaded:                        8.450407178024761
```

sorry for the bogus lead :-)

The question is now - can we import less than `sage.all` pieces?



---

archive/issue_comments_561577.json:
```json
{
    "body": "<div id=\"comment:25\" align=\"right\">comment:25</div>\n\nCan you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?",
    "created_at": "2022-12-15T23:08:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561577",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:25" align="right">comment:25</div>

Can you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?



---

archive/issue_comments_561578.json:
```json
{
    "body": "<div id=\"comment:26\" align=\"right\">comment:26</div>\n\nReplying to [Matthias K\u00f6ppe](#comment%3A25):\n> Can you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?\n\nSuccess with `sage.libs.eclib.mat` or `sage.libs.eclib.homspace` - they are still a serious chunk of `sage.all`, about 40%, by some measure, but not all of it:\n\n```\n$ ./sage --python\n>>> import sys\n>>> import sage.libs.eclib.mat\n>>> len(sys.modules.keys())\n673\n>>> \n```\nvs\n\n```\n$ ./sage --python\nPython 3.10.8 (main, Nov 29 2022, 20:55:11) [GCC 12.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import sys\n>>> len(sys.modules.keys())\n74\n>>> import sage.all\n>>> len(sys.modules.keys())\n1712\n```\n\nfor `sage.libs.eclib.homspace` one has `674` keys\n(but these for `sage.libs.eclib.mat` are a subset of these, so we can go with the latter)",
    "created_at": "2022-12-15T23:43:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561578",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:26" align="right">comment:26</div>

Replying to [Matthias Köppe](#comment%3A25):
> Can you reproduce it if you replace `import mpmath` by `import sage.libs.pari.all` or `import.sage.cpython.all` etc?

Success with `sage.libs.eclib.mat` or `sage.libs.eclib.homspace` - they are still a serious chunk of `sage.all`, about 40%, by some measure, but not all of it:

```
$ ./sage --python
>>> import sys
>>> import sage.libs.eclib.mat
>>> len(sys.modules.keys())
673
>>> 
```
vs

```
$ ./sage --python
Python 3.10.8 (main, Nov 29 2022, 20:55:11) [GCC 12.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import sys
>>> len(sys.modules.keys())
74
>>> import sage.all
>>> len(sys.modules.keys())
1712
```

for `sage.libs.eclib.homspace` one has `674` keys
(but these for `sage.libs.eclib.mat` are a subset of these, so we can go with the latter)



---

archive/issue_comments_561579.json:
```json
{
    "body": "<div id=\"comment:27\" align=\"right\">comment:27</div>\n\n\n```\n>>> import sage.libs.eclib.mwrank\n>>> len(sys.modules.keys())\n346\n```\nand `import sage.libs.eclib.mwrank` does not reproduce. so we're down to ~330 modules to check  :-)",
    "created_at": "2022-12-15T23:52:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561579",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:27" align="right">comment:27</div>


```
>>> import sage.libs.eclib.mwrank
>>> len(sys.modules.keys())
346
```
and `import sage.libs.eclib.mwrank` does not reproduce. so we're down to ~330 modules to check  :-)



---

archive/issue_comments_561580.json:
```json
{
    "body": "<div id=\"comment:28\" align=\"right\">comment:28</div>\n\n`eclib` certainly uses `libpari`, so it potentially could be that loading it changes some `pari` defaults.\nBut I don't know anything about this.\nMaybe John C. can comment...",
    "created_at": "2022-12-16T00:04:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561580",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:28" align="right">comment:28</div>

`eclib` certainly uses `libpari`, so it potentially could be that loading it changes some `pari` defaults.
But I don't know anything about this.
Maybe John C. can comment...



---

archive/issue_comments_561581.json:
```json
{
    "body": "<div id=\"comment:29\" align=\"right\">comment:29</div>\n\nYes, eclib calls some functions in libpari and so must make sure that libpari has been initialised.  This is done in the eclib function `eclib_pari_init` which detects whether it has already been initialised (by testing the value of pari variable \"avma\") and if necessary calls `pari_init()`.  The first parameter  to `pari_init` is taken from the environment variable `PARI_SIZE` and defaults to (currently) `10^8` if that variable is not set or has a value which cannot be converted to a long int.\n\nThe function `eclib_pari_init()` need never be called by users (and is not called by Sage) as it is called automatically when needed by one of two other functions which themseves use pari functions.  I would expect that whenever Sage calls an eclib function which results in eclib's `eclib_pari_init` to be called, it will find that libpari has already been initialised (so avma will be nonzero) and then do nothing.  But my expectation could be wrong in some situations?\n\nSee https://github.com/JohnCremona/eclib/blob/master/libsrc/parifact.cc",
    "created_at": "2022-12-16T08:52:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561581",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:29" align="right">comment:29</div>

Yes, eclib calls some functions in libpari and so must make sure that libpari has been initialised.  This is done in the eclib function `eclib_pari_init` which detects whether it has already been initialised (by testing the value of pari variable "avma") and if necessary calls `pari_init()`.  The first parameter  to `pari_init` is taken from the environment variable `PARI_SIZE` and defaults to (currently) `10^8` if that variable is not set or has a value which cannot be converted to a long int.

The function `eclib_pari_init()` need never be called by users (and is not called by Sage) as it is called automatically when needed by one of two other functions which themseves use pari functions.  I would expect that whenever Sage calls an eclib function which results in eclib's `eclib_pari_init` to be called, it will find that libpari has already been initialised (so avma will be nonzero) and then do nothing.  But my expectation could be wrong in some situations?

See https://github.com/JohnCremona/eclib/blob/master/libsrc/parifact.cc



---

archive/issue_comments_561582.json:
```json
{
    "body": "<div id=\"comment:30\" align=\"right\">comment:30</div>\n\nOK, `avma` is a global Pari variable. Declared in `pari/paristio.h` as \n\n`extern THREAD pari_sp avma;`\n\nPotentially every Sage module depending on Pari might want to check it and run Pari initialisation if it decided to, or perhaps even unconditionally, without checking. I don't know how it plays up in the presence of multithreading, either.\n\nSuspects: `lcalc`, `giac`...\n\nBy the way, also `import src.sage.libs.pari.convert_sage` triggers the slowdown.",
    "created_at": "2022-12-16T10:43:19Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561582",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:30" align="right">comment:30</div>

OK, `avma` is a global Pari variable. Declared in `pari/paristio.h` as 

`extern THREAD pari_sp avma;`

Potentially every Sage module depending on Pari might want to check it and run Pari initialisation if it decided to, or perhaps even unconditionally, without checking. I don't know how it plays up in the presence of multithreading, either.

Suspects: `lcalc`, `giac`...

By the way, also `import src.sage.libs.pari.convert_sage` triggers the slowdown.



---

archive/issue_comments_561583.json:
```json
{
    "body": "<div id=\"comment:31\" align=\"right\">comment:31</div>\n\n`import sage.rings.integer` is another reproducer, with \"only\" 346 sub-imports\n\nlcalc and giac are OK.",
    "created_at": "2022-12-16T14:14:03Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561583",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:31" align="right">comment:31</div>

`import sage.rings.integer` is another reproducer, with "only" 346 sub-imports

lcalc and giac are OK.



---

archive/issue_comments_561584.json:
```json
{
    "body": "<div id=\"comment:32\" align=\"right\">comment:32</div>\n\nHave you tried running both versions under `perf top` or `perf record` to see where the time goes?",
    "created_at": "2022-12-16T14:34:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561584",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:32" align="right">comment:32</div>

Have you tried running both versions under `perf top` or `perf record` to see where the time goes?



---

archive/issue_comments_561585.json:
```json
{
    "body": "<div id=\"comment:33\" align=\"right\">comment:33</div>\n\nReplying to [Marc Mezzarobba](#comment%3A32):\n> Have you tried running both versions under `perf top` or `perf record` to see where the time goes?\n\nI tried cProfile,  mentioned it on sage-devel.\nNothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.",
    "created_at": "2022-12-16T15:22:58Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561585",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:33" align="right">comment:33</div>

Replying to [Marc Mezzarobba](#comment%3A32):
> Have you tried running both versions under `perf top` or `perf record` to see where the time goes?

I tried cProfile,  mentioned it on sage-devel.
Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.



---

archive/issue_comments_561586.json:
```json
{
    "body": "<div id=\"comment:34\" align=\"right\">comment:34</div>\n\nReplying to [Dima Pasechnik](#comment%3A31):\n> `import sage.rings.integer` is another reproducer, with \"only\" 346 sub-imports\n\nit is reproducer on Fedora 34, but not on Gentoo. So that's getting even more bizarre.\n> \n> lcalc and giac are OK.\n\non the other hand, they both unconditionally initialise Pari by calling `pari_init_options`.\nIn view of `avma` being a thread-local global variable, I'm not sure about what's going on there, but perhaps we still should patch them as follows:\n\n```diff\n--- a/src/lcalc/Lcommandline.cc\n+++ b/src/lcalc/Lcommandline.cc\n@@ -31,6 +31,9 @@ Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.\n #include \"config.h\"\n #include \"Lcommandline.h\"\n #include \"cmdline.h\"\n+#if HAVE_LIBPARI\n+#include <pari/pari.h>\n+#endif\n \n void pari_err_recover_nop(long errnum) {return;}\n \n@@ -482,10 +485,11 @@ int main (int argc, char *argv[])\n \n \n             t2=.5; //t2=.5 because of the GAMMA(s+1/2)\n-\n+            if (!avma) {\n             pari_init_opts(400000000,2,INIT_DFTm); // the last option is to prevent\n             //pari from giving its interrupt signal when its elliptic curve a_p\n             //algorithm is called and interrupted with ctrl-c.\n+            }\n \n             coeff = new Double[3];\n             //compute the conductor which is copied to coeff[1]\n```\nand for giac:\n\n```diff\ndiff --git a/src/pari.cc b/src/pari.cc\nindex 76ce8e1..bdf1073 100644\n--- a/src/pari.cc\n+++ b/src/pari.cc\n@@ -97,8 +97,10 @@ namespace giac {\n   static void call_pari_init()\n   {\n     // do not initialize INIT_JMP so that PARI error do not exit\n-    pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);\n-    paristack_setsize(pari_mem_size, (1<<30));\n+    if (!avma) {\n+       pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);\n+       paristack_setsize(pari_mem_size, (1<<30));\n+    }\n     // initialize variable ordering x,y,z\n     gp_read_str(\"[x,y,z,t]\");\n   }\n```",
    "created_at": "2022-12-16T16:44:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561586",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:34" align="right">comment:34</div>

Replying to [Dima Pasechnik](#comment%3A31):
> `import sage.rings.integer` is another reproducer, with "only" 346 sub-imports

it is reproducer on Fedora 34, but not on Gentoo. So that's getting even more bizarre.
> 
> lcalc and giac are OK.

on the other hand, they both unconditionally initialise Pari by calling `pari_init_options`.
In view of `avma` being a thread-local global variable, I'm not sure about what's going on there, but perhaps we still should patch them as follows:

```diff
--- a/src/lcalc/Lcommandline.cc
+++ b/src/lcalc/Lcommandline.cc
@@ -31,6 +31,9 @@ Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 #include "config.h"
 #include "Lcommandline.h"
 #include "cmdline.h"
+#if HAVE_LIBPARI
+#include <pari/pari.h>
+#endif
 
 void pari_err_recover_nop(long errnum) {return;}
 
@@ -482,10 +485,11 @@ int main (int argc, char *argv[])
 
 
             t2=.5; //t2=.5 because of the GAMMA(s+1/2)
-
+            if (!avma) {
             pari_init_opts(400000000,2,INIT_DFTm); // the last option is to prevent
             //pari from giving its interrupt signal when its elliptic curve a_p
             //algorithm is called and interrupted with ctrl-c.
+            }
 
             coeff = new Double[3];
             //compute the conductor which is copied to coeff[1]
```
and for giac:

```diff
diff --git a/src/pari.cc b/src/pari.cc
index 76ce8e1..bdf1073 100644
--- a/src/pari.cc
+++ b/src/pari.cc
@@ -97,8 +97,10 @@ namespace giac {
   static void call_pari_init()
   {
     // do not initialize INIT_JMP so that PARI error do not exit
-    pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);
-    paristack_setsize(pari_mem_size, (1<<30));
+    if (!avma) {
+       pari_init_opts(pari_mem_size,pari_maxprime,INIT_SIGm | INIT_DFTm);
+       paristack_setsize(pari_mem_size, (1<<30));
+    }
     // initialize variable ordering x,y,z
     gp_read_str("[x,y,z,t]");
   }
```



---

archive/issue_comments_561587.json:
```json
{
    "body": "<div id=\"comment:35\" align=\"right\">comment:35</div>\n\nReplying to [Dima Pasechnik](#comment%3A33):\n> Replying to [Marc Mezzarobba](#comment%3A32):\n> > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?\n> \n> \n> I tried cProfile,  mentioned it on sage-devel.\n> Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.\n\nI'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.",
    "created_at": "2022-12-16T16:56:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561587",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:35" align="right">comment:35</div>

Replying to [Dima Pasechnik](#comment%3A33):
> Replying to [Marc Mezzarobba](#comment%3A32):
> > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?
> 
> 
> I tried cProfile,  mentioned it on sage-devel.
> Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.

I'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.



---

archive/issue_comments_561588.json:
```json
{
    "body": "<div id=\"comment:36\" align=\"right\">comment:36</div>\n\nReplying to [Marc Mezzarobba](#comment%3A35):\n> Replying to [Dima Pasechnik](#comment%3A33):\n> > Replying to [Marc Mezzarobba](#comment%3A32):\n> > > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?\n> > \n> > \n> > I tried cProfile,  mentioned it on sage-devel.\n> > Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.\n> \n> \n> I'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.\n\nI don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...",
    "created_at": "2022-12-16T18:28:40Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561588",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:36" align="right">comment:36</div>

Replying to [Marc Mezzarobba](#comment%3A35):
> Replying to [Dima Pasechnik](#comment%3A33):
> > Replying to [Marc Mezzarobba](#comment%3A32):
> > > Have you tried running both versions under `perf top` or `perf record` to see where the time goes?
> > 
> > 
> > I tried cProfile,  mentioned it on sage-devel.
> > Nothing to see, it's a slowdown of Pari itself that happens. You are welcome to take over.
> 
> 
> I'm happy to help if I can, but at the moment I don't understand how to reproduce the slowdown. I was suggesting perf because I thought a systemwide profiler may help understand what is changing.

I don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...



---

archive/issue_comments_561589.json:
```json
{
    "body": "<div id=\"comment:37\" align=\"right\">comment:37</div>\n\nReplying to [Dima Pasechnik](#comment%3A36):\n> I don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...\n\nJust run\n\n```\nperf record -- sage -python3 pari_timing.py\n```\nand then\n\n```\nperf report\n```",
    "created_at": "2022-12-17T08:51:30Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561589",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:37" align="right">comment:37</div>

Replying to [Dima Pasechnik](#comment%3A36):
> I don't know (or can't recall :-)) how to use `perf`. I imagine one would need a special build of `libpari`, and some magical commands to run...

Just run

```
perf record -- sage -python3 pari_timing.py
```
and then

```
perf report
```



---

archive/issue_comments_561590.json:
```json
{
    "body": "<div id=\"comment:38\" align=\"right\">comment:38</div>\n\nAlso, after upgrading my system and going back to python 3.10, I do see the slowdown. I'll check what happens on the 3.11 branch with the same system packages -- but this looks like it will require a full rebuild, so it may take some time.",
    "created_at": "2022-12-17T09:28:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561590",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:38" align="right">comment:38</div>

Also, after upgrading my system and going back to python 3.10, I do see the slowdown. I'll check what happens on the 3.11 branch with the same system packages -- but this looks like it will require a full rebuild, so it may take some time.



---

archive/issue_comments_561591.json:
```json
{
    "body": "<div id=\"comment:39\" align=\"right\">comment:39</div>\n\nThe slowdown is still there after a full rebuild with python\u00a03.11.",
    "created_at": "2022-12-17T13:44:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561591",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:39" align="right">comment:39</div>

The slowdown is still there after a full rebuild with python 3.11.



---

archive/issue_comments_561592.json:
```json
{
    "body": "<div id=\"comment:40\" align=\"right\">comment:40</div>\n\nReplying to [Dima Pasechnik](#comment%3A14):\n\n> On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`\n\nYou wrote \u201csystem-wide `pari 2.15.1`\u201d, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?",
    "created_at": "2022-12-17T13:47:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561592",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:40" align="right">comment:40</div>

Replying to [Dima Pasechnik](#comment%3A14):

> On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`

You wrote “system-wide `pari 2.15.1`”, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?



---

archive/issue_comments_561593.json:
```json
{
    "body": "<div id=\"comment:41\" align=\"right\">comment:41</div>\n\nReplying to [Marc Mezzarobba](#comment%3A40):\n> Replying to [Dima Pasechnik](#comment%3A14):\n> \n> > On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`\n> \n> \n> You wrote \u201csystem-wide `pari 2.15.1`\u201d, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?\n\nI am on https://github.com/sagemath/sage/issues/34537 (update to Pari 2.15.1) in Gentoo.\nSo there is an evidence that in this case you need to import more than `sage.rings.integer` to see a slowdown.",
    "created_at": "2022-12-17T14:04:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561593",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:41" align="right">comment:41</div>

Replying to [Marc Mezzarobba](#comment%3A40):
> Replying to [Dima Pasechnik](#comment%3A14):
> 
> > On Gentoo with system `python3.10.8`, system-wide `pari 2.15.1`, running this `p1.py`
> 
> 
> You wrote “system-wide `pari 2.15.1`”, but if I understand the `spkg-configure` right, pari 2.15.* is not allowed by sage's configure. Could it be that your tests are not all using the same version of pari?

I am on https://github.com/sagemath/sage/issues/34537 (update to Pari 2.15.1) in Gentoo.
So there is an evidence that in this case you need to import more than `sage.rings.integer` to see a slowdown.



---

archive/issue_comments_561594.json:
```json
{
    "body": "<div id=\"comment:42\" align=\"right\">comment:42</div>\n\nSo I am now able to reproduce the issue. Comparing the profiles, the main difference seems to be a huge amount of time spent in the dynamic linker, more precisely in `_dl_check_map_versions()` (presumably called by `dlopen()`) and in `update_get_addr()`. Regarding the latter, the relevant code seems to be (`glibc/elf/dl-tls.c`):\n\n```\nvoid *\n__tls_get_addr (GET_ADDR_ARGS)\n{\n  dtv_t *dtv = THREAD_DTV ();\n\n  /* Update is needed if dtv[0].counter < the generation of the accessed\n     module.  The global generation counter is used here as it is easier\n     to check.  Synchronization for the relaxed MO access is guaranteed\n     by user code, see CONCURRENCY NOTES in _dl_update_slotinfo.  */\n  size_t gen = atomic_load_relaxed (&GL(dl_tls_generation));\n  if (__glibc_unlikely (dtv[0].counter != gen))\n    return update_get_addr (GET_ADDR_PARAM);   // <----------\n\n  void *p = dtv[GET_ADDR_MODULE].pointer.val;\n\n  if (__glibc_unlikely (p == TLS_DTV_UNALLOCATED))\n    return tls_get_addr_tail (GET_ADDR_PARAM, dtv, NULL);\n\n  return (char *) p + GET_ADDR_OFFSET;\n}\n```\nAfaict the slow path is never taken when running cypari under plain Python, while it is taken all the time when parts of Sage are loaded.  But I don't know what to make of all that... (There is some information on TLS that looks like it might be relevant at https://chao-tic.github.io/blog/2018/12/25/tls)",
    "created_at": "2022-12-17T16:58:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561594",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:42" align="right">comment:42</div>

So I am now able to reproduce the issue. Comparing the profiles, the main difference seems to be a huge amount of time spent in the dynamic linker, more precisely in `_dl_check_map_versions()` (presumably called by `dlopen()`) and in `update_get_addr()`. Regarding the latter, the relevant code seems to be (`glibc/elf/dl-tls.c`):

```
void *
__tls_get_addr (GET_ADDR_ARGS)
{
  dtv_t *dtv = THREAD_DTV ();

  /* Update is needed if dtv[0].counter < the generation of the accessed
     module.  The global generation counter is used here as it is easier
     to check.  Synchronization for the relaxed MO access is guaranteed
     by user code, see CONCURRENCY NOTES in _dl_update_slotinfo.  */
  size_t gen = atomic_load_relaxed (&GL(dl_tls_generation));
  if (__glibc_unlikely (dtv[0].counter != gen))
    return update_get_addr (GET_ADDR_PARAM);   // <----------

  void *p = dtv[GET_ADDR_MODULE].pointer.val;

  if (__glibc_unlikely (p == TLS_DTV_UNALLOCATED))
    return tls_get_addr_tail (GET_ADDR_PARAM, dtv, NULL);

  return (char *) p + GET_ADDR_OFFSET;
}
```
Afaict the slow path is never taken when running cypari under plain Python, while it is taken all the time when parts of Sage are loaded.  But I don't know what to make of all that... (There is some information on TLS that looks like it might be relevant at https://chao-tic.github.io/blog/2018/12/25/tls)



---

archive/issue_comments_561595.json:
```json
{
    "body": "<div id=\"comment:43\" align=\"right\">comment:43</div>\n\nI don't think your profiling makes much sense this way, as you are not excluding time taken by  `import`, right? \nYou can mitigate this by increasing `number=` to 30 or 50 - then you won't see linker kicking in too much. \n\nOr I misunderstand, and you say that the linker is called by Pari?",
    "created_at": "2022-12-17T18:20:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561595",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:43" align="right">comment:43</div>

I don't think your profiling makes much sense this way, as you are not excluding time taken by  `import`, right? 
You can mitigate this by increasing `number=` to 30 or 50 - then you won't see linker kicking in too much. 

Or I misunderstand, and you say that the linker is called by Pari?



---

archive/issue_comments_561596.json:
```json
{
    "body": "<div id=\"comment:44\" align=\"right\">comment:44</div>\n\nWhen trying \"python3 with cypari\" and \"python3 with sympy imported\" with `number=50` the effect is much more pronounced than with `number=3` and it seems it's still stuff in the linker that explains the difference in the profile. `perf diff perf_python3.data perf_sympy.data` yields:\n\n```\n              +23.90%  ld-linux-x86-64.so.2                                        [.] _dl_update_slotinfo\n    30.30%    -12.38%  libpari-gmp-tls.so.2.13.4                                   [.] 0x000000000009fc74\n              +10.87%  ld-linux-x86-64.so.2                                        [.] update_get_addr\n    10.31%     -4.60%  libpari-gmp-tls.so.2.13.4                                   [.] addii_sign\n               +4.40%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr_slow\n     6.54%     -2.55%  libpari-gmp-tls.so.2.13.4                                   [.] xxgcduu\n    11.61%     -2.51%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr\n     4.62%     -2.07%  libpari-gmp-tls.so.2.13.4                                   [.] shifti\n     3.24%     -1.45%  libpari-gmp-tls.so.2.13.4                                   [.] muliispec\n     3.11%     -1.16%  libpari-gmp-tls.so.2.13.4                                   [.] dvmdii\n     2.43%     -1.08%  libpari-gmp-tls.so.2.13.4                                   [.] mulii\n     2.09%     -1.01%  libgmp.so.10.4.1                                            [.] __gmpn_divrem_2\n     1.91%     -0.88%  libpari-gmp-tls.so.2.13.4                                   [.] muluu\n     1.75%     -0.84%  libgmp.so.10.4.1                                            [.] __gmpn_addmul_1_x86_64\n     1.70%     -0.62%  libpari-gmp-tls.so.2.13.4                                   [.] abscmpii\n     1.24%     -0.59%  libgmp.so.10.4.1                                            [.] __gmpn_invert_limb\n     1.46%     -0.58%  libgmp.so.10.4.1                                            [.] __gmpn_tdiv_qr\n\n```\nwhere, as far as I can see, `__tls_get_addr_slow` doesn't show up at all for `python3`. So as far as I can see, some switch gets thrown that forces the linker to look up a symbol again and again, in a slower way. I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here.",
    "created_at": "2022-12-17T21:51:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561596",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:44" align="right">comment:44</div>

When trying "python3 with cypari" and "python3 with sympy imported" with `number=50` the effect is much more pronounced than with `number=3` and it seems it's still stuff in the linker that explains the difference in the profile. `perf diff perf_python3.data perf_sympy.data` yields:

```
              +23.90%  ld-linux-x86-64.so.2                                        [.] _dl_update_slotinfo
    30.30%    -12.38%  libpari-gmp-tls.so.2.13.4                                   [.] 0x000000000009fc74
              +10.87%  ld-linux-x86-64.so.2                                        [.] update_get_addr
    10.31%     -4.60%  libpari-gmp-tls.so.2.13.4                                   [.] addii_sign
               +4.40%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr_slow
     6.54%     -2.55%  libpari-gmp-tls.so.2.13.4                                   [.] xxgcduu
    11.61%     -2.51%  ld-linux-x86-64.so.2                                        [.] __tls_get_addr
     4.62%     -2.07%  libpari-gmp-tls.so.2.13.4                                   [.] shifti
     3.24%     -1.45%  libpari-gmp-tls.so.2.13.4                                   [.] muliispec
     3.11%     -1.16%  libpari-gmp-tls.so.2.13.4                                   [.] dvmdii
     2.43%     -1.08%  libpari-gmp-tls.so.2.13.4                                   [.] mulii
     2.09%     -1.01%  libgmp.so.10.4.1                                            [.] __gmpn_divrem_2
     1.91%     -0.88%  libpari-gmp-tls.so.2.13.4                                   [.] muluu
     1.75%     -0.84%  libgmp.so.10.4.1                                            [.] __gmpn_addmul_1_x86_64
     1.70%     -0.62%  libpari-gmp-tls.so.2.13.4                                   [.] abscmpii
     1.24%     -0.59%  libgmp.so.10.4.1                                            [.] __gmpn_invert_limb
     1.46%     -0.58%  libgmp.so.10.4.1                                            [.] __gmpn_tdiv_qr

```
where, as far as I can see, `__tls_get_addr_slow` doesn't show up at all for `python3`. So as far as I can see, some switch gets thrown that forces the linker to look up a symbol again and again, in a slower way. I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here.



---

archive/issue_comments_561597.json:
```json
{
    "body": "<div id=\"comment:45\" align=\"right\">comment:45</div>\n\n> I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here. \n\nIndeed, this very, very weird. I've never heard about such cases. But it seems we are now debugging a rather eigenzinnig, pardon my Dutch, Pari's use of threads?",
    "created_at": "2022-12-17T22:08:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561597",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:45" align="right">comment:45</div>

> I would have expected dynamic linking to happen once in a run, and then getting out of the way. That doesn't seem to be happening here. 

Indeed, this very, very weird. I've never heard about such cases. But it seems we are now debugging a rather eigenzinnig, pardon my Dutch, Pari's use of threads?



---

archive/issue_comments_561598.json:
```json
{
    "body": "<div id=\"comment:46\" align=\"right\">comment:46</div>\n\nI'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? Note that mpfr, which is used by mpmath, also makes use of gmp, so that could be another source of conflicts. Plus: mpmath has some sage-specific backend stuff, so importing a sage-aware mpmath could have different effects than one that isn't.\n\nOne hypothesis would be that the gmp library gets linked twice: once by python and once by libpari, and perhaps under different threading conditions; leading to an error in initialization of the thread-local storage of libgmp; causing a slow symbol resolution in libgmp every time ...\n\nI did not see a slowdown with `import gmpy2`, so it's something `mpmath` does. It may well be something in `sage.libs.mpmath.ext_main`, which a sage-aware mpmath imports.\n\nIn fact, [ext_libmp.pyx:11](https://github.com/sagemath/sage/blob/bb7ee856390710fc17caf02615de16f5adc66cf2/src/sage/libs/mpmath/ext_libmp.pyx#L11) indicates that sage-aware `mpmath` would call some initialization that has to do with gmp at import-time. So if libpari messes with threads afterwards and links gmp, there may be some room for things to go sideways.",
    "created_at": "2022-12-17T22:22:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561598",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:46" align="right">comment:46</div>

I'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? Note that mpfr, which is used by mpmath, also makes use of gmp, so that could be another source of conflicts. Plus: mpmath has some sage-specific backend stuff, so importing a sage-aware mpmath could have different effects than one that isn't.

One hypothesis would be that the gmp library gets linked twice: once by python and once by libpari, and perhaps under different threading conditions; leading to an error in initialization of the thread-local storage of libgmp; causing a slow symbol resolution in libgmp every time ...

I did not see a slowdown with `import gmpy2`, so it's something `mpmath` does. It may well be something in `sage.libs.mpmath.ext_main`, which a sage-aware mpmath imports.

In fact, [ext_libmp.pyx:11](https://github.com/sagemath/sage/blob/bb7ee856390710fc17caf02615de16f5adc66cf2/src/sage/libs/mpmath/ext_libmp.pyx#L11) indicates that sage-aware `mpmath` would call some initialization that has to do with gmp at import-time. So if libpari messes with threads afterwards and links gmp, there may be some room for things to go sideways.



---

archive/issue_comments_561599.json:
```json
{
    "body": "<div id=\"comment:47\" align=\"right\">comment:47</div>\n\nReplying to [Nils Bruin](#comment%3A46):\n> I'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? \n\nSage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.\nBut yes, there is quite a bit of dodgy things going on in `mpmath`.",
    "created_at": "2022-12-17T23:36:24Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561599",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:47" align="right">comment:47</div>

Replying to [Nils Bruin](#comment%3A46):
> I'm also seeing the slow-down with just `import mpmath` (which is also something `sympy` does). So perhaps it's something mpmath does with its configuration of gmp? 

Sage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.
But yes, there is quite a bit of dodgy things going on in `mpmath`.



---

archive/issue_comments_561600.json:
```json
{
    "body": "<div id=\"comment:48\" align=\"right\">comment:48</div>\n\nReplying to [Dima Pasechnik](#comment%3A47):\n> Sage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.\n> But yes, there is quite a bit of dodgy things going on in `mpmath`.\n\nApologies for replicating that already-established knowledge. Following up on [comment:23](#comment%3A23): when using the correct syntax to set `MPMATH_NOSAGE=1`, the import of `mpmath` has no adverse effect. So it's something else in `sage.all` that causes the problem (edited in response to [comment:49](#comment%3A49)).",
    "created_at": "2022-12-17T23:54:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561600",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:48" align="right">comment:48</div>

Replying to [Dima Pasechnik](#comment%3A47):
> Sage-aware mpmath imports `sage.all` (see [comment:24](#comment%3A24)), so in this sense it's a moot point.
> But yes, there is quite a bit of dodgy things going on in `mpmath`.

Apologies for replicating that already-established knowledge. Following up on [comment:23](#comment%3A23): when using the correct syntax to set `MPMATH_NOSAGE=1`, the import of `mpmath` has no adverse effect. So it's something else in `sage.all` that causes the problem (edited in response to [comment:49](#comment%3A49)).



---

archive/issue_comments_561601.json:
```json
{
    "body": "<div id=\"comment:49\" align=\"right\">comment:49</div>\n\nReplying to [Nils Bruin](#comment%3A48):\n> Following up on [comment:23](#comment%3A23): as far as I can see, `MPMATH_NOSAGE, MPMATH_NOGMPY` have no influence on the result.\n\nAre you sure?\n\n```\n(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py\npython environment with cypari2:           3.799615835014265\nwith mpmath loaded:   6.606633314979263\n(sage-sh) marc@tramontane:tmp$ export MPMATH_NOSAGE=1\n(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py\npython environment with cypari2:           3.996781985013513\nwith mpmath loaded:   4.207063634006772\n```",
    "created_at": "2022-12-18T09:04:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561601",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:49" align="right">comment:49</div>

Replying to [Nils Bruin](#comment%3A48):
> Following up on [comment:23](#comment%3A23): as far as I can see, `MPMATH_NOSAGE, MPMATH_NOGMPY` have no influence on the result.

Are you sure?

```
(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py
python environment with cypari2:           3.799615835014265
with mpmath loaded:   6.606633314979263
(sage-sh) marc@tramontane:tmp$ export MPMATH_NOSAGE=1
(sage-sh) marc@tramontane:tmp$ python3 pari_timing.py
python environment with cypari2:           3.996781985013513
with mpmath loaded:   4.207063634006772
```



---

archive/issue_comments_561602.json:
```json
{
    "body": "<div id=\"comment:50\" align=\"right\">comment:50</div>\n\nto quote GCC people on the topic `__tls_get_addr`\nhttps://gcc.gnu.org/bugzilla/show_bug.cgi?id=81501#c6\n\n```\nWe recently upgraded our toolchain from GCC9 to GCC11, and we're seeing __tls_get_addr\ntake up to 10% of total runtime under some workloads, where it was 1-2% before.\n```\n\nindeed, this means that if `__tls_get_addr` gets slowed down, the same code might suddenly get visibly slower.",
    "created_at": "2022-12-18T11:21:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561602",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:50" align="right">comment:50</div>

to quote GCC people on the topic `__tls_get_addr`
https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81501#c6

```
We recently upgraded our toolchain from GCC9 to GCC11, and we're seeing __tls_get_addr
take up to 10% of total runtime under some workloads, where it was 1-2% before.
```

indeed, this means that if `__tls_get_addr` gets slowed down, the same code might suddenly get visibly slower.



---

archive/issue_comments_561603.json:
```json
{
    "body": "<div id=\"comment:51\" align=\"right\">comment:51</div>\n\nThe story of `__tls_get_addr_slow` in glibc (https://github.com/lattera/glibc/blob/master/sysdeps/x86_64/tls_get_addr.S) starts from\nhttps://gcc.gnu.org/bugzilla/show_bug.cgi?id=58066\n\nbut I can't make much sense of it. Something to do with misaligned stack.",
    "created_at": "2022-12-18T12:14:12Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561603",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:51" align="right">comment:51</div>

The story of `__tls_get_addr_slow` in glibc (https://github.com/lattera/glibc/blob/master/sysdeps/x86_64/tls_get_addr.S) starts from
https://gcc.gnu.org/bugzilla/show_bug.cgi?id=58066

but I can't make much sense of it. Something to do with misaligned stack.



---

archive/issue_comments_561604.json:
```json
{
    "body": "<div id=\"comment:52\" align=\"right\">comment:52</div>\n\nBill suggested to try PARI without thread support (`Configure --mt=single`).",
    "created_at": "2022-12-18T13:17:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561604",
    "user": "https://github.com/videlec"
}
```

<div id="comment:52" align="right">comment:52</div>

Bill suggested to try PARI without thread support (`Configure --mt=single`).



---

archive/issue_comments_561605.json:
```json
{
    "body": "<div id=\"comment:53\" align=\"right\">comment:53</div>\n\nPossibly relevant:\nhttps://sourceware.org/bugzilla/show_bug.cgi?id=19924",
    "created_at": "2022-12-18T13:40:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561605",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:53" align="right">comment:53</div>

Possibly relevant:
https://sourceware.org/bugzilla/show_bug.cgi?id=19924



---

archive/issue_comments_561606.json:
```json
{
    "body": "<div id=\"comment:54\" align=\"right\">comment:54</div>\n\nReplying to [Marc Mezzarobba](#comment%3A53):\n> Possibly relevant:\n> https://sourceware.org/bugzilla/show_bug.cgi?id=19924\n\n```\nwe have noticed a performance degradation of TLS access in shared libraries. If another shared library that uses TLS is loaded via dlopen, __tls_get_addr takes significant more time. Once that shared library accesses it's TLS, the performance normalizes.\n```\n\nSo it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:\n\n```\nsetup=\"\"\"\nimport sage.all\n_ = libgap(1)\n_ = giac(1)\n... etc\n\"\"\"\n```\nthen the test itself should run faster. (But I can't work on this now)",
    "created_at": "2022-12-18T14:15:04Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561606",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:54" align="right">comment:54</div>

Replying to [Marc Mezzarobba](#comment%3A53):
> Possibly relevant:
> https://sourceware.org/bugzilla/show_bug.cgi?id=19924

```
we have noticed a performance degradation of TLS access in shared libraries. If another shared library that uses TLS is loaded via dlopen, __tls_get_addr takes significant more time. Once that shared library accesses it's TLS, the performance normalizes.
```

So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:

```
setup="""
import sage.all
_ = libgap(1)
_ = giac(1)
... etc
"""
```
then the test itself should run faster. (But I can't work on this now)



---

archive/issue_comments_561607.json:
```json
{
    "body": "<div id=\"comment:55\" align=\"right\">comment:55</div>\n\nReplying to [Vincent Delecroix](#comment%3A52):\n> Bill suggested to try PARI without thread support (`Configure --mt=single`).\n\nthis is incompatible with giac, IIRC",
    "created_at": "2022-12-18T14:17:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561607",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:55" align="right">comment:55</div>

Replying to [Vincent Delecroix](#comment%3A52):
> Bill suggested to try PARI without thread support (`Configure --mt=single`).

this is incompatible with giac, IIRC



---

archive/issue_comments_561608.json:
```json
{
    "body": "<div id=\"comment:56\" align=\"right\">comment:56</div>\n\nReplying to [Dima Pasechnik](#comment%3A54):\n> So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:\n\nDoesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?",
    "created_at": "2022-12-18T14:28:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561608",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:56" align="right">comment:56</div>

Replying to [Dima Pasechnik](#comment%3A54):
> So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:

Doesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?



---

archive/issue_comments_561609.json:
```json
{
    "body": "<div id=\"comment:57\" align=\"right\">comment:57</div>\n\nReplying to [Marc Mezzarobba](#comment%3A56):\n> Replying to [Dima Pasechnik](#comment%3A54):\n> > So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:\n> \n> \n> Doesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?\n\ncertainly not all of them matter (e.g. we know that importing sage.libs.eclib.mwrank is OK, but\nsage.libs.eclib.mat is not)",
    "created_at": "2022-12-18T14:34:28Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561609",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:57" align="right">comment:57</div>

Replying to [Marc Mezzarobba](#comment%3A56):
> Replying to [Dima Pasechnik](#comment%3A54):
> > So it seems that if in the test setup we do touch TLS vars of all the dlopen'd libraries:
> 
> 
> Doesn't that mean every cython module in Sage?... Or maybe not, because they don't use TLS?

certainly not all of them matter (e.g. we know that importing sage.libs.eclib.mwrank is OK, but
sage.libs.eclib.mat is not)



---

archive/issue_comments_561610.json:
```json
{
    "body": "<div id=\"comment:58\" align=\"right\">comment:58</div>\n\nSome more details on where the slowdown appears to be happening, in case this gives someone an idea. If we look at the context where `__tls_get_addr` is running in the version with sage loaded, we get (children are callers; percentages are cycle counts for callchains with a given callee):\n\n```\n-   21,83%    21,83%  python3  ld-linux-x86-64.so.2\n   - 78,46% _dl_update_slotinfo (inlined)\n      - 65,84% update_get_addr (inlined)\n         - __tls_get_addr (inlined)\n            + 66,50% new_chunk (inlined)\n            + 27,93% set_avma (inlined)\n            + 2,41% dvmdii (inlined)\n            + 1,57% addmulii_lg3 (inlined)\n        3,91% 0x3\n        3,36% 0x1\n        2,25% 0x4\n        2,23% 0x2\n        0,73% 0xfffffffffffffffe\n        0,60% 0x1f\n        0,52% 0x17\n   - 21,52% update_get_addr (inlined)\n      - 37,56% __tls_get_addr (inlined)\n         + 59,76% new_chunk (inlined)\n         + 34,12% set_avma (inlined)\n         + 2,43% dvmdii (inlined)\n         + 1,26% addmulii_lg3 (inlined)\n         + 0,66% qficomp0 (inlined)\n        8,31% 0x3\n        6,80% 0x2\n        3,53% 0x4\n        1,51% 0xffffffffffffffff\n        1,14% 0x1\n        1,10% 0x1f\n        1,02% 0xfffffffffffffffe\n        0,97% 0x17\n```\nSo basically the callers are low-level pari functions that access things like `avma` and `pari_stack`.",
    "created_at": "2022-12-18T14:37:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561610",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:58" align="right">comment:58</div>

Some more details on where the slowdown appears to be happening, in case this gives someone an idea. If we look at the context where `__tls_get_addr` is running in the version with sage loaded, we get (children are callers; percentages are cycle counts for callchains with a given callee):

```
-   21,83%    21,83%  python3  ld-linux-x86-64.so.2
   - 78,46% _dl_update_slotinfo (inlined)
      - 65,84% update_get_addr (inlined)
         - __tls_get_addr (inlined)
            + 66,50% new_chunk (inlined)
            + 27,93% set_avma (inlined)
            + 2,41% dvmdii (inlined)
            + 1,57% addmulii_lg3 (inlined)
        3,91% 0x3
        3,36% 0x1
        2,25% 0x4
        2,23% 0x2
        0,73% 0xfffffffffffffffe
        0,60% 0x1f
        0,52% 0x17
   - 21,52% update_get_addr (inlined)
      - 37,56% __tls_get_addr (inlined)
         + 59,76% new_chunk (inlined)
         + 34,12% set_avma (inlined)
         + 2,43% dvmdii (inlined)
         + 1,26% addmulii_lg3 (inlined)
         + 0,66% qficomp0 (inlined)
        8,31% 0x3
        6,80% 0x2
        3,53% 0x4
        1,51% 0xffffffffffffffff
        1,14% 0x1
        1,10% 0x1f
        1,02% 0xfffffffffffffffe
        0,97% 0x17
```
So basically the callers are low-level pari functions that access things like `avma` and `pari_stack`.



---

archive/issue_comments_561611.json:
```json
{
    "body": "<div id=\"comment:59\" align=\"right\">comment:59</div>\n\nReplying to [Dima Pasechnik](#comment%3A57):\n> we know that importing sage.libs.eclib.mwrank is OK, but\n> sage.libs.eclib.mat is not\n\nAbove you said that they both reproduce the slowdown, and that's also what I observe. Looks like importing `sage.libs.eclib.mwrank` causes 69 `dlopen`s... (I'm counting lines containig `direct_opencount` in the output of `LD_DEBUG=files`; not surt if that's right.)",
    "created_at": "2022-12-18T15:04:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561611",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:59" align="right">comment:59</div>

Replying to [Dima Pasechnik](#comment%3A57):
> we know that importing sage.libs.eclib.mwrank is OK, but
> sage.libs.eclib.mat is not

Above you said that they both reproduce the slowdown, and that's also what I observe. Looks like importing `sage.libs.eclib.mwrank` causes 69 `dlopen`s... (I'm counting lines containig `direct_opencount` in the output of `LD_DEBUG=files`; not surt if that's right.)



---

archive/issue_comments_561612.json:
```json
{
    "body": "<div id=\"comment:60\" align=\"right\">comment:60</div>\n\na missing 'not' in [comment:27](#comment%3A27) - edited now.\n\nhowever, this is all so volatile, no surprise it it is different for you.\n\nI wonder if a fix is possible within Python importing machinery",
    "created_at": "2022-12-18T15:58:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561612",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:60" align="right">comment:60</div>

a missing 'not' in [comment:27](#comment%3A27) - edited now.

however, this is all so volatile, no surprise it it is different for you.

I wonder if a fix is possible within Python importing machinery



---

archive/issue_comments_561613.json:
```json
{
    "body": "<div id=\"comment:61\" align=\"right\">comment:61</div>\n\nI can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:\n\n```\npython environment with cypari2:           4.8728421429987065\nwith sage custom GMP allocation functions: 4.884550739021506\nwith mpmath loaded:   4.292751049972139\nwith sympy loaded:   4.475166625983547\nwith sage.libs.eclib.mwrank loaded:   4.776536963006947\nwith sage.rings.integer loaded:   4.415787325997371\nwith the whole sagemath library loaded:   7.537986656010617\n```\nThis is all with system pari 2.15.1 and system sagemath 9.7.",
    "created_at": "2022-12-18T20:19:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561613",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:61" align="right">comment:61</div>

I can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:

```
python environment with cypari2:           4.8728421429987065
with sage custom GMP allocation functions: 4.884550739021506
with mpmath loaded:   4.292751049972139
with sympy loaded:   4.475166625983547
with sage.libs.eclib.mwrank loaded:   4.776536963006947
with sage.rings.integer loaded:   4.415787325997371
with the whole sagemath library loaded:   7.537986656010617
```
This is all with system pari 2.15.1 and system sagemath 9.7.



---

archive/issue_comments_561614.json:
```json
{
    "body": "<div id=\"comment:62\" align=\"right\">comment:62</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A61):\n> I can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:\n> \n> ```\n> python environment with cypari2:           4.8728421429987065\n> with sage custom GMP allocation functions: 4.884550739021506\n> with mpmath loaded:   4.292751049972139\n> with sympy loaded:   4.475166625983547\n> with sage.libs.eclib.mwrank loaded:   4.776536963006947\n> with sage.rings.integer loaded:   4.415787325997371\n> with the whole sagemath library loaded:   7.537986656010617\n> ```\n> This is all with system pari 2.15.1 and system sagemath 9.7.\n\nhow about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)",
    "created_at": "2022-12-18T20:31:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561614",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:62" align="right">comment:62</div>

Replying to [Gonzalo Tornaría](#comment%3A61):
> I can reproduce the slowdown with `sage.all` loaded, but NOT with `mpmath`, `sympy`, `sage.libs.eclib.mwrank` nor `sage.rings.integer`:
> 
> ```
> python environment with cypari2:           4.8728421429987065
> with sage custom GMP allocation functions: 4.884550739021506
> with mpmath loaded:   4.292751049972139
> with sympy loaded:   4.475166625983547
> with sage.libs.eclib.mwrank loaded:   4.776536963006947
> with sage.rings.integer loaded:   4.415787325997371
> with the whole sagemath library loaded:   7.537986656010617
> ```
> This is all with system pari 2.15.1 and system sagemath 9.7.

how about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)



---

archive/issue_comments_561615.json:
```json
{
    "body": "<div id=\"comment:63\" align=\"right\">comment:63</div>\n\nReplying to [Dima Pasechnik](#comment%3A62):\n> how about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)\n\nYes, and it tracks down to one of these:\n- `sage.rings.finite_rings.finite_field_constructor`\n- `sage.rings.finite_rings.finite_field_givaro`\n- `sage.rings.finite_rings.element_givaro`",
    "created_at": "2022-12-18T20:50:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561615",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:63" align="right">comment:63</div>

Replying to [Dima Pasechnik](#comment%3A62):
> how about `sage.libs.eclib.mat` ? (I never succeeded with `sage.libs.eclib.mwrank`)

Yes, and it tracks down to one of these:
- `sage.rings.finite_rings.finite_field_constructor`
- `sage.rings.finite_rings.finite_field_givaro`
- `sage.rings.finite_rings.element_givaro`



---

archive/issue_comments_561616.json:
```json
{
    "body": "<div id=\"comment:64\" align=\"right\">comment:64</div>\n\nThis seems to depend on the order the shared libraries are loaded. In this case, loading `-larb` earlier seems to avoid the slowdown. Here's a hack to do it:\n\n- Using the original file from the ticket description:\n\n```\n$ python pari_timing.py \npython environment with cypari2:           4.7771418140036985\nwith sage custom GMP allocation functions: 4.94545228901552\nwith the whole sagemath library lodaded:   7.068615118972957\n```\n\n- With \"the hack\":\n\n```\n$ python pari_timing-stub.py \npython environment with cypari2:           5.000043574022129\nwith sage custom GMP allocation functions: 4.970149756001774\nwith the whole sagemath library lodaded:   4.352886867010966\n```\n- It all amounts to load a trivial stub module before loading sage.all:\n\n```\n$ diff -u pari_timing.py pari_timing-stub.py \n--- pari_timing.py\t2022-12-18 19:00:03.984366341 -0300\n+++ pari_timing-stub.py\t2022-12-18 19:00:18.996184656 -0300\n@@ -19,6 +19,7 @@\n       timeit.timeit(prog, setup=setup, number=3))\n \n setup=\"\"\"\n+import stub\n import sage.all\n \"\"\"\n print(\"with the whole sagemath library lodaded:  \",\n```\n- The stub does nothing, but it is linked with `-larb`:\n\n```\n$ cat stub.c \n#include <Python.h>\n\nstruct PyModuleDef stub = {\n\tPyModuleDef_HEAD_INIT,\n\t\"stub\", NULL, -1, NULL\n};\n\nPyMODINIT_FUNC\nPyInit_stub(void)\n{\n\treturn PyModule_Create(&stub);\n}\n$ cc -I/usr/include/python3.11 stub.c -fPIC -larb -shared -o stub.so\n```",
    "created_at": "2022-12-18T23:33:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561616",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:64" align="right">comment:64</div>

This seems to depend on the order the shared libraries are loaded. In this case, loading `-larb` earlier seems to avoid the slowdown. Here's a hack to do it:

- Using the original file from the ticket description:

```
$ python pari_timing.py 
python environment with cypari2:           4.7771418140036985
with sage custom GMP allocation functions: 4.94545228901552
with the whole sagemath library lodaded:   7.068615118972957
```

- With "the hack":

```
$ python pari_timing-stub.py 
python environment with cypari2:           5.000043574022129
with sage custom GMP allocation functions: 4.970149756001774
with the whole sagemath library lodaded:   4.352886867010966
```
- It all amounts to load a trivial stub module before loading sage.all:

```
$ diff -u pari_timing.py pari_timing-stub.py 
--- pari_timing.py	2022-12-18 19:00:03.984366341 -0300
+++ pari_timing-stub.py	2022-12-18 19:00:18.996184656 -0300
@@ -19,6 +19,7 @@
       timeit.timeit(prog, setup=setup, number=3))
 
 setup="""
+import stub
 import sage.all
 """
 print("with the whole sagemath library lodaded:  ",
```
- The stub does nothing, but it is linked with `-larb`:

```
$ cat stub.c 
#include <Python.h>

struct PyModuleDef stub = {
	PyModuleDef_HEAD_INIT,
	"stub", NULL, -1, NULL
};

PyMODINIT_FUNC
PyInit_stub(void)
{
	return PyModule_Create(&stub);
}
$ cc -I/usr/include/python3.11 stub.c -fPIC -larb -shared -o stub.so
```



---

archive/issue_comments_561617.json:
```json
{
    "body": "<div id=\"comment:65\" align=\"right\">comment:65</div>\n\nVoil\u00e0:\n\n```\n$ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py \npython environment with cypari2:           4.7483764729695395\nwith sage custom GMP allocation functions: 4.830055630998686\nwith the whole sagemath library lodaded:   4.3143665379611775\n$ git diff\ndiff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\nindex a6090039db2..a2e379d4a42 100644\n--- a/src/sage/rings/all.py\n+++ b/src/sage/rings/all.py\n@@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod\n from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod\n Integers = IntegerModRing\n \n+# this must come early (see #34850)\n+# at least before finite_rings, number_field, polynomial, ...\n+from sage.rings.real_arb import RealBallField, RBF\n+\n # Finite fields\n from .finite_rings.all import *\n \n@@ -103,8 +107,6 @@ from .real_double import RealDoubleField, RDF, RealDoubleElement\n \n from .real_lazy import RealLazyField, RLF, ComplexLazyField, CLF\n \n-from sage.rings.real_arb import RealBallField, RBF\n-\n # Polynomial Rings and Polynomial Quotient Rings\n from .polynomial.all import *\n \n```",
    "created_at": "2022-12-18T23:38:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561617",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:65" align="right">comment:65</div>

Voilà:

```
$ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py 
python environment with cypari2:           4.7483764729695395
with sage custom GMP allocation functions: 4.830055630998686
with the whole sagemath library lodaded:   4.3143665379611775
$ git diff
diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
index a6090039db2..a2e379d4a42 100644
--- a/src/sage/rings/all.py
+++ b/src/sage/rings/all.py
@@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod
 from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod
 Integers = IntegerModRing
 
+# this must come early (see #34850)
+# at least before finite_rings, number_field, polynomial, ...
+from sage.rings.real_arb import RealBallField, RBF
+
 # Finite fields
 from .finite_rings.all import *
 
@@ -103,8 +107,6 @@ from .real_double import RealDoubleField, RDF, RealDoubleElement
 
 from .real_lazy import RealLazyField, RLF, ComplexLazyField, CLF
 
-from sage.rings.real_arb import RealBallField, RBF
-
 # Polynomial Rings and Polynomial Quotient Rings
 from .polynomial.all import *
 
```



---

archive/issue_comments_561618.json:
```json
{
    "body": "<div id=\"comment:66\" align=\"right\">comment:66</div>\n\nCool! It definitely seems to solve the problem. However, it doesn't really explain what was going wrong here. And that means this solution may be a bit fragile, since you're just triggering something that happens to have the right (unknown) side-effect.\n\nIn particular, it's pretty clear that the problem here is coming from libpari, and libpari does not depend on arb, nor does arb depend on libpari. So I'd think it's a common dependence. If we look at those:\n\n```\n$ ldd /lib64/libpari.so\n\tlinux-vdso.so.1 (0x00007ffc513f0000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fe3cd400000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007fe3ce256000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fe3ce15d000)\n\tlibgmp.so.10 => /lib64/libgmp.so.10 (0x00007fe3ce0b8000)\n\tlibgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fe3ce098000)\n$ ldd /lib64/libarb.so\n\tlinux-vdso.so.1 (0x00007ffce20ab000)\n\tlibflint.so.17 => /lib64/libflint.so.17 (0x00007f1b6c600000)\n\tlibmpfr.so.6 => /lib64/libmpfr.so.6 (0x00007f1b6d18c000)\n\tlibgmp.so.10 => /lib64/libgmp.so.10 (0x00007f1b6c55b000)\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007f1b6c47d000)\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007f1b6c200000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007f1b6d25a000)\n\tlibflexiblas.so.3 => /lib64/libflexiblas.so.3 (0x00007f1b6be00000)\n\tlibntl.so.44 => /lib64/libntl.so.44 (0x00007f1b6ba00000)\n\tlibstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007f1b6b600000)\n\tlibgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f1b6d16a000)\n\tlibgfortran.so.5 => /lib64/libgfortran.so.5 (0x00007f1b6b200000)\n\tlibquadmath.so.0 => /lib64/libquadmath.so.0 (0x00007f1b6d122000)\n\tlibgf2x.so.3 => /lib64/libgf2x.so.3 (0x00007f1b6d111000)\n```\nso perhaps you can already get the desired effect by linking to libgmp?",
    "created_at": "2022-12-19T01:49:55Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561618",
    "user": "https://github.com/nbruin"
}
```

<div id="comment:66" align="right">comment:66</div>

Cool! It definitely seems to solve the problem. However, it doesn't really explain what was going wrong here. And that means this solution may be a bit fragile, since you're just triggering something that happens to have the right (unknown) side-effect.

In particular, it's pretty clear that the problem here is coming from libpari, and libpari does not depend on arb, nor does arb depend on libpari. So I'd think it's a common dependence. If we look at those:

```
$ ldd /lib64/libpari.so
	linux-vdso.so.1 (0x00007ffc513f0000)
	libc.so.6 => /lib64/libc.so.6 (0x00007fe3cd400000)
	/lib64/ld-linux-x86-64.so.2 (0x00007fe3ce256000)
	libm.so.6 => /lib64/libm.so.6 (0x00007fe3ce15d000)
	libgmp.so.10 => /lib64/libgmp.so.10 (0x00007fe3ce0b8000)
	libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fe3ce098000)
$ ldd /lib64/libarb.so
	linux-vdso.so.1 (0x00007ffce20ab000)
	libflint.so.17 => /lib64/libflint.so.17 (0x00007f1b6c600000)
	libmpfr.so.6 => /lib64/libmpfr.so.6 (0x00007f1b6d18c000)
	libgmp.so.10 => /lib64/libgmp.so.10 (0x00007f1b6c55b000)
	libm.so.6 => /lib64/libm.so.6 (0x00007f1b6c47d000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f1b6c200000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f1b6d25a000)
	libflexiblas.so.3 => /lib64/libflexiblas.so.3 (0x00007f1b6be00000)
	libntl.so.44 => /lib64/libntl.so.44 (0x00007f1b6ba00000)
	libstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007f1b6b600000)
	libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f1b6d16a000)
	libgfortran.so.5 => /lib64/libgfortran.so.5 (0x00007f1b6b200000)
	libquadmath.so.0 => /lib64/libquadmath.so.0 (0x00007f1b6d122000)
	libgf2x.so.3 => /lib64/libgf2x.so.3 (0x00007f1b6d111000)
```
so perhaps you can already get the desired effect by linking to libgmp?



---

archive/issue_comments_561619.json:
```json
{
    "body": "<div id=\"comment:67\" align=\"right\">comment:67</div>\n\nHere's a way to reproduce independent of sage and without compiled modules (other than using `ctypes` to dlopen libraries):\n\n```\n$ python pari_timing3.py \npython environment with cypari2:  4.842002137971576\nwith -lmpfi:                      8.262313047016505\nwith -larb:                       4.4230794320465066\n```\n\nHere's `pari_timing3.py`:\n\n```python\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2: \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfi.so')\n\"\"\"\nprint(\"with -lmpfi:                     \",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\n\"\"\"\nprint(\"with -larb:                      \",\n      timeit.timeit(prog, setup=setup, number=3))\n```\n\nFirst guess: `-lmpfi` is doing something weird at load time. Then `-larb` is fixing it. For some reason, whatever `-larb` is doing doesn't work if it's done too late (as in `import sage.all` without my patch). Loading `-larb` first prevents `-lmpfr` from doing any wrong as you can see reverting the order in this script.",
    "created_at": "2022-12-19T02:05:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561619",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:67" align="right">comment:67</div>

Here's a way to reproduce independent of sage and without compiled modules (other than using `ctypes` to dlopen libraries):

```
$ python pari_timing3.py 
python environment with cypari2:  4.842002137971576
with -lmpfi:                      8.262313047016505
with -larb:                       4.4230794320465066
```

Here's `pari_timing3.py`:

```python
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2: ",
      timeit.timeit(prog, number=3))

setup="""
from ctypes import cdll
cdll.LoadLibrary('libmpfi.so')
"""
print("with -lmpfi:                     ",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
"""
print("with -larb:                      ",
      timeit.timeit(prog, setup=setup, number=3))
```

First guess: `-lmpfi` is doing something weird at load time. Then `-larb` is fixing it. For some reason, whatever `-larb` is doing doesn't work if it's done too late (as in `import sage.all` without my patch). Loading `-larb` first prevents `-lmpfr` from doing any wrong as you can see reverting the order in this script.



---

archive/issue_comments_561620.json:
```json
{
    "body": "<div id=\"comment:68\" align=\"right\">comment:68</div>\n\nChanging `-lmpfi` for `-lmpfr` gives the same result.\n\nSince `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.\n\nThis still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.",
    "created_at": "2022-12-19T02:17:21Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561620",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:68" align="right">comment:68</div>

Changing `-lmpfi` for `-lmpfr` gives the same result.

Since `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.

This still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.



---

archive/issue_comments_561621.json:
```json
{
    "body": "<div id=\"comment:69\" align=\"right\">comment:69</div>\n\nIt seems to me that `timeit` is not run in an independent process. Namely if you **start** with `setup=\"import sage.all\"` then everything get slow. Do anyone knows of a solution to run these in independent processes?",
    "created_at": "2022-12-19T07:53:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561621",
    "user": "https://github.com/videlec"
}
```

<div id="comment:69" align="right">comment:69</div>

It seems to me that `timeit` is not run in an independent process. Namely if you **start** with `setup="import sage.all"` then everything get slow. Do anyone knows of a solution to run these in independent processes?



---

archive/issue_comments_561622.json:
```json
{
    "body": "<div id=\"comment:70\" align=\"right\">comment:70</div>\n\nAttachment: **[pari_timing.py.gz](https://github.com/sagemath/sage/files/ticket34850/pari_timing.py.gz)**\n\nIn [pari_timing.py](https://github.com/sagemath/sage/files/ticket34850/pari_timing.py.gz) the timeit is now run in independent process. I only see a slowdown for `import sage.all`\n\n```\nsetup 0\nimport sage.all\n9.015203488990664\n--------------------------------------------------\nsetup 1\n5.769485066004563\n--------------------------------------------------\nsetup 2\nimport sympy\n5.582505510014016\n--------------------------------------------------\nsetup 3\nfrom ctypes import cdll\ncdll.LoadLibrary('libgmp.so')\n5.503667832992505\n--------------------------------------------------\nsetup 4\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\n5.5995761190133635\n--------------------------------------------------\nsetup 5\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfr.so')\n5.045454590988811\n--------------------------------------------------\nsetup 6\nfrom ctypes import cdll\ncdll.LoadLibrary('libgiac.so')\n5.5255847749940585\n--------------------------------------------------\nfast_runs: [1, 2, 3, 4, 5, 6]\nslow_runs: [0]\n```",
    "created_at": "2022-12-19T09:49:20Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561622",
    "user": "https://github.com/videlec"
}
```

<div id="comment:70" align="right">comment:70</div>

Attachment: **[pari_timing.py.gz](https://github.com/sagemath/sage/files/ticket34850/pari_timing.py.gz)**

In [pari_timing.py](https://github.com/sagemath/sage/files/ticket34850/pari_timing.py.gz) the timeit is now run in independent process. I only see a slowdown for `import sage.all`

```
setup 0
import sage.all
9.015203488990664
--------------------------------------------------
setup 1
5.769485066004563
--------------------------------------------------
setup 2
import sympy
5.582505510014016
--------------------------------------------------
setup 3
from ctypes import cdll
cdll.LoadLibrary('libgmp.so')
5.503667832992505
--------------------------------------------------
setup 4
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
5.5995761190133635
--------------------------------------------------
setup 5
from ctypes import cdll
cdll.LoadLibrary('libmpfr.so')
5.045454590988811
--------------------------------------------------
setup 6
from ctypes import cdll
cdll.LoadLibrary('libgiac.so')
5.5255847749940585
--------------------------------------------------
fast_runs: [1, 2, 3, 4, 5, 6]
slow_runs: [0]
```



---

archive/issue_comments_561623.json:
```json
{
    "body": "<div id=\"comment:71\" align=\"right\">comment:71</div>\n\nAre you telling mpmath (imported from sympy) to not import sage.all? Cause that's what it does by default, and I get `slow_runs: [0,2]` (cf. [comment:24](#comment%3A24))",
    "created_at": "2022-12-19T11:12:14Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561623",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:71" align="right">comment:71</div>

Are you telling mpmath (imported from sympy) to not import sage.all? Cause that's what it does by default, and I get `slow_runs: [0,2]` (cf. [comment:24](#comment%3A24))



---

archive/issue_comments_561624.json:
```json
{
    "body": "<div id=\"comment:72\" align=\"right\">comment:72</div>\n\nStill, I can confirm Gonzalo's discovery that `arb` may be used to cure the slowness: modifying `setup 0` so that it's loaded first makes setup 0 fast:\n\n```\nsetup 0\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\nimport sage.all\n4.591498055000557\n--------------------------------------------------\nsetup 1\n4.60094984099851\n...\n```\n\nThat is, I changed the test file part as follows:\n\n```\n...\n# build different setups\nsetups = []\nlib=\"arb\"\nsetup = \"from ctypes import cdll\\n\"\nsetup += \"cdll.LoadLibrary('lib{}.so')\\n\".format(lib)\nsetup += \"import sage.all\"\nsetups.append(setup)\nsetups.append(\"\")\nsetups.append(\"import sympy\")\n...\n```",
    "created_at": "2022-12-19T11:29:34Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561624",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:72" align="right">comment:72</div>

Still, I can confirm Gonzalo's discovery that `arb` may be used to cure the slowness: modifying `setup 0` so that it's loaded first makes setup 0 fast:

```
setup 0
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
import sage.all
4.591498055000557
--------------------------------------------------
setup 1
4.60094984099851
...
```

That is, I changed the test file part as follows:

```
...
# build different setups
setups = []
lib="arb"
setup = "from ctypes import cdll\n"
setup += "cdll.LoadLibrary('lib{}.so')\n".format(lib)
setup += "import sage.all"
setups.append(setup)
setups.append("")
setups.append("import sympy")
...
```



---

archive/issue_comments_561625.json:
```json
{
    "body": "<div id=\"comment:73\" align=\"right\">comment:73</div>\n\nAnother interesting observation - if I build giac with the patch in [comment:34](#comment%3A34) then \n\n```\nsetup 6\nfrom ctypes import cdll\ncdll.LoadLibrary('libgiac.so')\n```\ngets as slow as `setup 0` (with `sage.all`).\n\nI think it's Pari messing up things for everything else, no? Also, I don't know why Pari has to be called in `cysignals`, and nothing else - why such a royal treatment?",
    "created_at": "2022-12-19T11:45:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561625",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:73" align="right">comment:73</div>

Another interesting observation - if I build giac with the patch in [comment:34](#comment%3A34) then 

```
setup 6
from ctypes import cdll
cdll.LoadLibrary('libgiac.so')
```
gets as slow as `setup 0` (with `sage.all`).

I think it's Pari messing up things for everything else, no? Also, I don't know why Pari has to be called in `cysignals`, and nothing else - why such a royal treatment?



---

archive/issue_comments_561626.json:
```json
{
    "body": "<div id=\"comment:74\" align=\"right\">comment:74</div>\n\nSo if arb knows what to do, it would be worth asking Fredrik J perhaps",
    "created_at": "2022-12-19T11:46:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561626",
    "user": "https://github.com/JohnCremona"
}
```

<div id="comment:74" align="right">comment:74</div>

So if arb knows what to do, it would be worth asking Fredrik J perhaps



---

archive/issue_comments_561627.json:
```json
{
    "body": "<div id=\"comment:75\" align=\"right\">comment:75</div>\n\nOh yeah, I was just going to invite Fredrik to look at this mess...",
    "created_at": "2022-12-19T11:55:17Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561627",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:75" align="right">comment:75</div>

Oh yeah, I was just going to invite Fredrik to look at this mess...



---

archive/issue_comments_561628.json:
```json
{
    "body": "<div id=\"comment:76\" align=\"right\">comment:76</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A65):\n> Voil\u00e0:\n> \n> ```\n> $ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py \n> python environment with cypari2:           4.7483764729695395\n> with sage custom GMP allocation functions: 4.830055630998686\n> with the whole sagemath library lodaded:   4.3143665379611775\n> $ git diff\n> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\n> ...\n> ```\n\ndoes not work for me - while \n\n```\nfrom ctypes import cdll\ncdll.LoadLibrary('libarb.so')\nimport sage.all\n```\n\ndoes work. So it's even crazier than we think it is.",
    "created_at": "2022-12-19T11:59:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561628",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:76" align="right">comment:76</div>

Replying to [Gonzalo Tornaría](#comment%3A65):
> Voilà:
> 
> ```
> $ PYTHONPATH=pkgs/sagemath-standard/build/lib.linux-x86_64-cpython-311 python pari_timing.py 
> python environment with cypari2:           4.7483764729695395
> with sage custom GMP allocation functions: 4.830055630998686
> with the whole sagemath library lodaded:   4.3143665379611775
> $ git diff
> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
> ...
> ```

does not work for me - while 

```
from ctypes import cdll
cdll.LoadLibrary('libarb.so')
import sage.all
```

does work. So it's even crazier than we think it is.



---

archive/issue_comments_561629.json:
```json
{
    "body": "<div id=\"comment:77\" align=\"right\">comment:77</div>\n\nFredrik, we'd really appreciate your input on the magical action of `arb` on `sage.all` we are observing here...",
    "created_at": "2022-12-19T12:04:33Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561629",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:77" align="right">comment:77</div>

Fredrik, we'd really appreciate your input on the magical action of `arb` on `sage.all` we are observing here...



---

archive/issue_comments_561630.json:
```json
{
    "body": "<div id=\"comment:78\" align=\"right\">comment:78</div>\n\nI have absolutely no idea what is going on.\n\nArb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.",
    "created_at": "2022-12-19T12:43:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561630",
    "user": "https://github.com/fredrik-johansson"
}
```

<div id="comment:78" align="right">comment:78</div>

I have absolutely no idea what is going on.

Arb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.



---

archive/issue_comments_561631.json:
```json
{
    "body": "<div id=\"comment:79\" align=\"right\">comment:79</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A68):\n> Changing `-lmpfi` for `-lmpfr` gives the same result.\n> \n> Since `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.\n\nSo far (if I understand you correctly) it's not inconsistent with a link to https://sourceware.org/bugzilla/show_bug.cgi?id=19924. If loading an object that uses TLS slows down TLS accesses for previously loaded ones until the newly loaded object accesses TLS(!), the magic arb is doing may just be accessing, or causing mpfr to access, a thread-local variable... That's very speculative though.\n\n> This still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.\n\nIt may be interesting to compare the actual loading order of pari, mpfr, and arb (using LD_DEBUG=files) depending at what point arb is imported.",
    "created_at": "2022-12-19T12:52:06Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561631",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:79" align="right">comment:79</div>

Replying to [Gonzalo Tornaría](#comment%3A68):
> Changing `-lmpfi` for `-lmpfr` gives the same result.
> 
> Since `-larb` loads `-lmpfr` this explains why loading `-larb` early fixes the problem: since `-lmpfr` is already loaded, it won't be loaded later so it can no longer do any harm.

So far (if I understand you correctly) it's not inconsistent with a link to https://sourceware.org/bugzilla/show_bug.cgi?id=19924. If loading an object that uses TLS slows down TLS accesses for previously loaded ones until the newly loaded object accesses TLS(!), the magic arb is doing may just be accessing, or causing mpfr to access, a thread-local variable... That's very speculative though.

> This still doesn't explain why loading arb too late in `sage.rings.all` won't fix the issue.

It may be interesting to compare the actual loading order of pari, mpfr, and arb (using LD_DEBUG=files) depending at what point arb is imported.



---

archive/issue_comments_561632.json:
```json
{
    "body": "<div id=\"comment:80\" align=\"right\">comment:80</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A65):\n> Voil\u00e0:\n> \n> ```\n> [...]\n> $ git diff\n> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py\n> index a6090039db2..a2e379d4a42 100644\n> --- a/src/sage/rings/all.py\n> +++ b/src/sage/rings/all.py\n> @@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod\n>  from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod\n>  Integers = IntegerModRing\n>  \n> +# this must come early (see #34850)\n> +# at least before finite_rings, number_field, polynomial, ...\n> +from sage.rings.real_arb import RealBallField, RBF\n> +\n>  # Finite fields\n>  from .finite_rings.all import *\n> [...]\n> ```\n\nDoesn't seem to work here...",
    "created_at": "2022-12-19T13:08:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561632",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:80" align="right">comment:80</div>

Replying to [Gonzalo Tornaría](#comment%3A65):
> Voilà:
> 
> ```
> [...]
> $ git diff
> diff --git a/src/sage/rings/all.py b/src/sage/rings/all.py
> index a6090039db2..a2e379d4a42 100644
> --- a/src/sage/rings/all.py
> +++ b/src/sage/rings/all.py
> @@ -72,6 +72,10 @@ from sage.rings.finite_rings.integer_mod_ring import IntegerModRing, Zmod
>  from sage.rings.finite_rings.integer_mod import IntegerMod, Mod, mod
>  Integers = IntegerModRing
>  
> +# this must come early (see #34850)
> +# at least before finite_rings, number_field, polynomial, ...
> +from sage.rings.real_arb import RealBallField, RBF
> +
>  # Finite fields
>  from .finite_rings.all import *
> [...]
> ```

Doesn't seem to work here...



---

archive/issue_comments_561633.json:
```json
{
    "body": "<div id=\"comment:81\" align=\"right\">comment:81</div>\n\nOf course, the problem is loading pari + mpfr *in that order*:\n\n```\nsetup 0\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfr.so')\n\n4.866691738017835\n--------------------------------------------------\nsetup 1\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n\n7.862922856991645\n--------------------------------------------------\nsetup 2\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libpari.so')\n\n4.771596382022835\n--------------------------------------------------\nfast_runs: [0, 2]\nslow_runs: [1]\n```",
    "created_at": "2022-12-19T13:23:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561633",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:81" align="right">comment:81</div>

Of course, the problem is loading pari + mpfr *in that order*:

```
setup 0

from ctypes import cdll
cdll.LoadLibrary('libmpfr.so')

4.866691738017835
--------------------------------------------------
setup 1

from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')

7.862922856991645
--------------------------------------------------
setup 2

from ctypes import cdll
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libpari.so')

4.771596382022835
--------------------------------------------------
fast_runs: [0, 2]
slow_runs: [1]
```



---

archive/issue_comments_561634.json:
```json
{
    "body": "<div id=\"comment:82\" align=\"right\">comment:82</div>\n\nIndeed. And adding `arb` afterwards makes it fast again\n\n```\nsetup 0\n5.139136525016511\n--------------------------------------------------\nsetup 1\nimport sage.all\n8.28667692601448\n--------------------------------------------------\nsetup 2\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n8.265609099005815\n--------------------------------------------------\nsetup 3\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libarb.so')\n4.878138452011626\n--------------------------------------------------\nfast_runs: [0, 3]\nslow_runs: [1, 2]\n```",
    "created_at": "2022-12-19T13:39:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561634",
    "user": "https://github.com/videlec"
}
```

<div id="comment:82" align="right">comment:82</div>

Indeed. And adding `arb` afterwards makes it fast again

```
setup 0
5.139136525016511
--------------------------------------------------
setup 1
import sage.all
8.28667692601448
--------------------------------------------------
setup 2
from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
8.265609099005815
--------------------------------------------------
setup 3
from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libarb.so')
4.878138452011626
--------------------------------------------------
fast_runs: [0, 3]
slow_runs: [1, 2]
```



---

archive/issue_comments_561635.json:
```json
{
    "body": "<div id=\"comment:83\" align=\"right\">comment:83</div>\n\nBTW, it is `libflint.so` that \"fixes\" it (libarb loads libflint):\n\n```\nsetup 0\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libflint.so')\n\n4.84125757496804\n--------------------------------------------------\nsetup 1\n\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n\n7.785827331012115\n```",
    "created_at": "2022-12-19T13:39:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561635",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:83" align="right">comment:83</div>

BTW, it is `libflint.so` that "fixes" it (libarb loads libflint):

```
setup 0

from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libflint.so')

4.84125757496804
--------------------------------------------------
setup 1

from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')

7.785827331012115
```



---

archive/issue_comments_561636.json:
```json
{
    "body": "<div id=\"comment:84\" align=\"right\">comment:84</div>\n\nSomething else: running the same test using musl libc (instead of glibc), shows no slowdown at all.",
    "created_at": "2022-12-19T13:55:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561636",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:84" align="right">comment:84</div>

Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.



---

archive/issue_comments_561637.json:
```json
{
    "body": "<div id=\"comment:85\" align=\"right\">comment:85</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A84):\n> Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.\n\nThis is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.\n\nDoes Sage as a whole work on `musl` `libc`?",
    "created_at": "2022-12-19T14:12:10Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561637",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:85" align="right">comment:85</div>

Replying to [Gonzalo Tornaría](#comment%3A84):
> Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.

This is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.

Does Sage as a whole work on `musl` `libc`?



---

archive/issue_comments_561638.json:
```json
{
    "body": "<div id=\"comment:86\" align=\"right\">comment:86</div>\n\nReplying to [Fredrik Johansson](#comment%3A78):\n> I have absolutely no idea what is going on.\n> \n> Arb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.\n\nthere is a Dutch proverb \"doe maar gewoon, dan doet je al gek genoeg\" (\"doing things a normal way is already crazy enough\")\n\nCould you describe briefly what you do with TLS? How does it play together with initialising (or not) GMP?",
    "created_at": "2022-12-19T14:17:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561638",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:86" align="right">comment:86</div>

Replying to [Fredrik Johansson](#comment%3A78):
> I have absolutely no idea what is going on.
> 
> Arb does use TLS but does nothing weird with it, AFAIK. Nor does it do anything weird with GMP.

there is a Dutch proverb "doe maar gewoon, dan doet je al gek genoeg" ("doing things a normal way is already crazy enough")

Could you describe briefly what you do with TLS? How does it play together with initialising (or not) GMP?



---

archive/issue_comments_561639.json:
```json
{
    "body": "<div id=\"comment:87\" align=\"right\">comment:87</div>\n\nTLS is used for thread-local caches in MPFR and Arb for things like the value of pi. There are some caches in FLINT too, including the fmpz cache.\n\nI don't think there is any TLS in GMP. The only mutable state in GMP AFAIK is the set of memory allocation functions.",
    "created_at": "2022-12-19T15:23:32Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561639",
    "user": "https://github.com/fredrik-johansson"
}
```

<div id="comment:87" align="right">comment:87</div>

TLS is used for thread-local caches in MPFR and Arb for things like the value of pi. There are some caches in FLINT too, including the fmpz cache.

I don't think there is any TLS in GMP. The only mutable state in GMP AFAIK is the set of memory allocation functions.



---

archive/issue_comments_561640.json:
```json
{
    "body": "<div id=\"comment:88\" align=\"right\">comment:88</div>\n\nReplying to [Dima Pasechnik](#comment%3A85):\n> Replying to [Gonzalo Tornar\u00eda](#comment%3A84):\n> > Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.\n> \n> \n> This is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.\n> \n> Does Sage as a whole work on `musl` `libc`?\n\nWorks fine, all doctest pass, etc. This is using sage-the-library and all system packages, it may be that we use some patches for system packages that are not in the packages in sage-the-distro.",
    "created_at": "2022-12-19T21:21:38Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561640",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:88" align="right">comment:88</div>

Replying to [Dima Pasechnik](#comment%3A85):
> Replying to [Gonzalo Tornaría](#comment%3A84):
> > Something else: running the same test using musl libc (instead of glibc), shows no slowdown at all.
> 
> 
> This is not a big surprise, as the whole `__tls_get_addr_slow` business appears to be `glibc`-specific.
> 
> Does Sage as a whole work on `musl` `libc`?

Works fine, all doctest pass, etc. This is using sage-the-library and all system packages, it may be that we use some patches for system packages that are not in the packages in sage-the-distro.



---

archive/issue_comments_561641.json:
```json
{
    "body": "<div id=\"comment:89\" align=\"right\">comment:89</div>\n\nPaul, it appears that on x86_64 (gcc/gclib) loading `libmpfr` after loading `libpari` slows the latter down, due to slower `__tls_get_addr` calls being used in this case.\n\nAny idea why this could happen? Bill Allombert suggests that `mpfr` ought to initialise some TLS vars at startup.",
    "created_at": "2023-01-05T10:22:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561641",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:89" align="right">comment:89</div>

Paul, it appears that on x86_64 (gcc/gclib) loading `libmpfr` after loading `libpari` slows the latter down, due to slower `__tls_get_addr` calls being used in this case.

Any idea why this could happen? Bill Allombert suggests that `mpfr` ought to initialise some TLS vars at startup.



---

archive/issue_comments_561642.json:
```json
{
    "body": "<div id=\"comment:90\" align=\"right\">comment:90</div>\n\nI thought that trac was obsolete and we should not switch to github?\n\nAnyway, can you isolate a small example of the issue?",
    "created_at": "2023-01-05T10:45:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561642",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:90" align="right">comment:90</div>

I thought that trac was obsolete and we should not switch to github?

Anyway, can you isolate a small example of the issue?



---

archive/issue_comments_561643.json:
```json
{
    "body": "<div id=\"comment:91\" align=\"right\">comment:91</div>\n\n> Anyway, can you isolate a small example of the issue?\n\nI mean, independent from Sage.",
    "created_at": "2023-01-05T10:49:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561643",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:91" align="right">comment:91</div>

> Anyway, can you isolate a small example of the issue?

I mean, independent from Sage.



---

archive/issue_comments_561644.json:
```json
{
    "body": "<div id=\"comment:92\" align=\"right\">comment:92</div>\n\nReplying to [Paul Zimmermann](#comment%3A90):\n> I thought that trac was obsolete and we should not switch to github?\n\nshould happen this month (fingers crossed - it's a nontrivial task to import tickets etc properly)\n\n> \n> Anyway, can you isolate a small example of the issue?\n\nIt is independent of Sage already.\nIt needs python3+Cython+cysignals+cypari2 (a python/cython wrapper for pari/gp)\nwhich you can install using `pip`.\n\nAssume your python3 already has `pip` module, you have `libpari`, `libmpfr` (and optionally `libflint` - to see \"partial cure effect\") \ninstalled systemwide, you can do\n\n```\n$ python3 -m pip install Cython -U --user\n$ python3 -m pip install cysignals -U --user\n$ python3 -m pip install cypari2 -U --user\n```\nto install `cypari2`. \nThen create the file `pari_timing.py`\n\n```python\nimport timeit\n\nprog=\"\"\"\nfrom cypari2 import Pari\npari = Pari(size={size})\npari(\"{cmd}\")\n\"\"\"\n\nprog = prog.format(size=2**24, cmd=\"quadclassunit(1 - 2^100)\")\n\nprint(\"python environment with cypari2: \",\n      timeit.timeit(prog, number=3))\n\nsetup=\"\"\"\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\n\"\"\"\nprint(\"with -lmpfr:                     \",\n      timeit.timeit(prog, setup=setup, number=3))\n\nsetup=\"\"\"\nfrom ctypes import cdll\ncdll.LoadLibrary('libpari.so')\ncdll.LoadLibrary('libmpfr.so')\ncdll.LoadLibrary('libflint.so')\n\"\"\"\nprint(\"with -mpfr and -lflint:          \",\n      timeit.timeit(prog, setup=setup, number=3))\n```\nand run\n\n```\n$ python3 pari_timing.py # your mileage may vary a bit \npython environment with cypari2:  4.627849955999409\nwith -lmpfr:                      8.170923099998618\nwith -mpfr and -lflint:           6.97339798700159\n```\n\n\nSurely with a bit more work one can do the same timings in plain C - would you need it?",
    "created_at": "2023-01-05T11:23:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561644",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:92" align="right">comment:92</div>

Replying to [Paul Zimmermann](#comment%3A90):
> I thought that trac was obsolete and we should not switch to github?

should happen this month (fingers crossed - it's a nontrivial task to import tickets etc properly)

> 
> Anyway, can you isolate a small example of the issue?

It is independent of Sage already.
It needs python3+Cython+cysignals+cypari2 (a python/cython wrapper for pari/gp)
which you can install using `pip`.

Assume your python3 already has `pip` module, you have `libpari`, `libmpfr` (and optionally `libflint` - to see "partial cure effect") 
installed systemwide, you can do

```
$ python3 -m pip install Cython -U --user
$ python3 -m pip install cysignals -U --user
$ python3 -m pip install cypari2 -U --user
```
to install `cypari2`. 
Then create the file `pari_timing.py`

```python
import timeit

prog="""
from cypari2 import Pari
pari = Pari(size={size})
pari("{cmd}")
"""

prog = prog.format(size=2**24, cmd="quadclassunit(1 - 2^100)")

print("python environment with cypari2: ",
      timeit.timeit(prog, number=3))

setup="""
from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
"""
print("with -lmpfr:                     ",
      timeit.timeit(prog, setup=setup, number=3))

setup="""
from ctypes import cdll
cdll.LoadLibrary('libpari.so')
cdll.LoadLibrary('libmpfr.so')
cdll.LoadLibrary('libflint.so')
"""
print("with -mpfr and -lflint:          ",
      timeit.timeit(prog, setup=setup, number=3))
```
and run

```
$ python3 pari_timing.py # your mileage may vary a bit 
python environment with cypari2:  4.627849955999409
with -lmpfr:                      8.170923099998618
with -mpfr and -lflint:           6.97339798700159
```


Surely with a bit more work one can do the same timings in plain C - would you need it?



---

archive/issue_events_470854.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2023-01-05T11:23:11Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "title_is": "sage-loaded libraries are slowing down cypari2 a lot",
    "title_was": "sage is slowing down cypari2 a lot",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34850#event-470854"
}
```



---

archive/issue_events_470855.json:
```json
{
    "actor": "https://github.com/dimpase",
    "created_at": "2023-01-05T11:24:05Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "title_is": "sage-loaded libraries are slowing down cypari2 a lot (on x86_64 glibc)",
    "title_was": "sage-loaded libraries are slowing down cypari2 a lot",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34850#event-470855"
}
```



---

archive/issue_comments_561645.json:
```json
{
    "body": "<div id=\"comment:94\" align=\"right\">comment:94</div>\n\nReplying to [Dima Pasechnik](#comment%3A89):\n> Paul, it appears that on x86_64 (gcc/gclib) loading `libmpfr` after loading `libpari` slows the latter down, due to slower `__tls_get_addr` calls being used in this case.\n> \n> Any idea why this could happen? Bill Allombert suggests that `mpfr` ought to initialise some TLS vars at startup.\n\nAccording to the C standard, thread-local variables are initialized when the associated thread is started. So I don't see what we could do in MPFR, in particular without knowing what is going on exactly. This seems to be a thread implementation issue.",
    "created_at": "2023-01-05T12:30:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561645",
    "user": "https://github.com/vinc17fr"
}
```

<div id="comment:94" align="right">comment:94</div>

Replying to [Dima Pasechnik](#comment%3A89):
> Paul, it appears that on x86_64 (gcc/gclib) loading `libmpfr` after loading `libpari` slows the latter down, due to slower `__tls_get_addr` calls being used in this case.
> 
> Any idea why this could happen? Bill Allombert suggests that `mpfr` ought to initialise some TLS vars at startup.

According to the C standard, thread-local variables are initialized when the associated thread is started. So I don't see what we could do in MPFR, in particular without knowing what is going on exactly. This seems to be a thread implementation issue.



---

archive/issue_comments_561646.json:
```json
{
    "body": "<div id=\"comment:95\" align=\"right\">comment:95</div>\n\nI suggest rebuilding libmpfr.so with `--disable-thread-safe --disable-shared-cache` to see if the problem persists.",
    "created_at": "2023-01-05T13:00:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561646",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:95" align="right">comment:95</div>

I suggest rebuilding libmpfr.so with `--disable-thread-safe --disable-shared-cache` to see if the problem persists.



---

archive/issue_comments_561647.json:
```json
{
    "body": "<div id=\"comment:96\" align=\"right\">comment:96</div>\n\nHi Vincent,\n\nReplying to [Vincent Lef\u00e8vre](#comment%3A94):\n> According to the C standard, thread-local variables are initialized when the associated thread is started. So I don't see what we could do in MPFR, in particular without knowing what is going on exactly. This seems to be a thread implementation issue.\n\nIt seems to be a glibc issue to some extent at least\u2014comment:84 above reports that it does not happen with musl.\n\nOne theory (neither verified nor disproved as far as I can tell, but maybe other people who have looked into it know better) is that it is in fact the issue reported at\n\nhttps://sourceware.org/bugzilla/show_bug.cgi?id=19924\n\nIn any case, it appears that loading new libraries (specifically, FLINT) after MPFR makes pari work at normal speed again. Regardless where the issue really comes from, this suggests that there is at least a workaround that MPFR could implement.",
    "created_at": "2023-01-05T13:26:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561647",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:96" align="right">comment:96</div>

Hi Vincent,

Replying to [Vincent Lefèvre](#comment%3A94):
> According to the C standard, thread-local variables are initialized when the associated thread is started. So I don't see what we could do in MPFR, in particular without knowing what is going on exactly. This seems to be a thread implementation issue.

It seems to be a glibc issue to some extent at least—comment:84 above reports that it does not happen with musl.

One theory (neither verified nor disproved as far as I can tell, but maybe other people who have looked into it know better) is that it is in fact the issue reported at

https://sourceware.org/bugzilla/show_bug.cgi?id=19924

In any case, it appears that loading new libraries (specifically, FLINT) after MPFR makes pari work at normal speed again. Regardless where the issue really comes from, this suggests that there is at least a workaround that MPFR could implement.



---

archive/issue_comments_561648.json:
```json
{
    "body": "<div id=\"comment:97\" align=\"right\">comment:97</div>\n\nUpdate:\n- loading libmpfr slows down pari\n- loading libmpfr then libgomp -> NO slowdown\n- loading libgomp then libmpfr -> slowdown\nThe reason arb or flint work is because they force loading of libgomp. In fact:\n- loading libgomp then libmpfr then libflint/libarb -> slowdown\n\n```\n$ cat pari_time.c\n#include <pari/pari.h>\n#include <stdio.h>\n#include <time.h>\n#include <dlfcn.h>\n\n\ndouble run()\n{\n    clock_t t = clock();\n    GEN D = subui(1,powuu(2,100));\n    GEN ans = quadclassunit0(D, 0, NULL, 38);\n    t = clock() - t;\n    return ((double)t)/((double)CLOCKS_PER_SEC);\n}\n\n\nvoid main(int argc, char *argv[])\n{\n    while(--argc) {\n        char * name = *++argv;\n        void * h = dlopen(name, RTLD_LAZY);\n        printf(\"dlopen(\\\"%s\\\", RTLD_LAZY): %s\\n\", name, h?\"ok\":\"fail\");\n    }\n\n    pari_init(1<<24, 0);\n\n    printf(\"elapsed: %f\\n\", run());\n}\n\n$ cc pari_time.c -lpari -o pari_time\n\n$ ./pari_time\nelapsed: 1.011542\n\n$ ./pari_time libmpfr.so.6\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.641292\n\n$ ./pari_time libmpfr.so.6 libgomp.so.1\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\nelapsed: 1.010561\n\n$ ./pari_time libgomp.so.1 libmpfr.so.6\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.641471\n\n$ ./pari_time libgomp.so.1 libmpfr.so.6 libflint.so.17\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\ndlopen(\"libflint.so.17\", RTLD_LAZY): ok\nelapsed: 1.643121\n\n$ ./pari_time libgomp.so.1 libmpfr.so.6 libarb.so.2\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\ndlopen(\"libarb.so.2\", RTLD_LAZY): ok\nelapsed: 1.652814\n```\n\nIndeed on musl libc there is no slowdown at all:\n\n```\n$ ls /lib/ld-*\n/lib/ld-musl-x86_64.so.1\n$ ./pari_time \nelapsed: 0.995930\n$ ./pari_time libmpfr.so.6\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.001000\n```",
    "created_at": "2023-01-05T14:13:00Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561648",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:97" align="right">comment:97</div>

Update:
- loading libmpfr slows down pari
- loading libmpfr then libgomp -> NO slowdown
- loading libgomp then libmpfr -> slowdown
The reason arb or flint work is because they force loading of libgomp. In fact:
- loading libgomp then libmpfr then libflint/libarb -> slowdown

```
$ cat pari_time.c
#include <pari/pari.h>
#include <stdio.h>
#include <time.h>
#include <dlfcn.h>


double run()
{
    clock_t t = clock();
    GEN D = subui(1,powuu(2,100));
    GEN ans = quadclassunit0(D, 0, NULL, 38);
    t = clock() - t;
    return ((double)t)/((double)CLOCKS_PER_SEC);
}


void main(int argc, char *argv[])
{
    while(--argc) {
        char * name = *++argv;
        void * h = dlopen(name, RTLD_LAZY);
        printf("dlopen(\"%s\", RTLD_LAZY): %s\n", name, h?"ok":"fail");
    }

    pari_init(1<<24, 0);

    printf("elapsed: %f\n", run());
}

$ cc pari_time.c -lpari -o pari_time

$ ./pari_time
elapsed: 1.011542

$ ./pari_time libmpfr.so.6
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.641292

$ ./pari_time libmpfr.so.6 libgomp.so.1
dlopen("libmpfr.so.6", RTLD_LAZY): ok
dlopen("libgomp.so.1", RTLD_LAZY): ok
elapsed: 1.010561

$ ./pari_time libgomp.so.1 libmpfr.so.6
dlopen("libgomp.so.1", RTLD_LAZY): ok
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.641471

$ ./pari_time libgomp.so.1 libmpfr.so.6 libflint.so.17
dlopen("libgomp.so.1", RTLD_LAZY): ok
dlopen("libmpfr.so.6", RTLD_LAZY): ok
dlopen("libflint.so.17", RTLD_LAZY): ok
elapsed: 1.643121

$ ./pari_time libgomp.so.1 libmpfr.so.6 libarb.so.2
dlopen("libgomp.so.1", RTLD_LAZY): ok
dlopen("libmpfr.so.6", RTLD_LAZY): ok
dlopen("libarb.so.2", RTLD_LAZY): ok
elapsed: 1.652814
```

Indeed on musl libc there is no slowdown at all:

```
$ ls /lib/ld-*
/lib/ld-musl-x86_64.so.1
$ ./pari_time 
elapsed: 0.995930
$ ./pari_time libmpfr.so.6
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.001000
```



---

archive/issue_comments_561649.json:
```json
{
    "body": "<div id=\"comment:98\" align=\"right\">comment:98</div>\n\nBTW, in the last comment there is a C program independent of python. Only needs pari and mpfr to reproduce.",
    "created_at": "2023-01-05T14:17:25Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561649",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:98" align="right">comment:98</div>

BTW, in the last comment there is a C program independent of python. Only needs pari and mpfr to reproduce.



---

archive/issue_comments_561650.json:
```json
{
    "body": "<div id=\"comment:99\" align=\"right\">comment:99</div>\n\nReplying to [Paul Zimmermann](#comment%3A95):\n> I suggest rebuilding libmpfr.so with `--disable-thread-safe --disable-shared-cache` to see if the problem persists.\n\nI tried that, no luck.",
    "created_at": "2023-01-05T14:31:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561650",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:99" align="right">comment:99</div>

Replying to [Paul Zimmermann](#comment%3A95):
> I suggest rebuilding libmpfr.so with `--disable-thread-safe --disable-shared-cache` to see if the problem persists.

I tried that, no luck.



---

archive/issue_comments_561651.json:
```json
{
    "body": "<div id=\"comment:100\" align=\"right\">comment:100</div>\n\nthank you Gonzalo for the small program. I can reproduce what you get:\n\n```\nzimmerma@coriandre:/tmp$ ./pari_time libgomp.so.1 libmpfr.so.6\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 3.753101\nzimmerma@coriandre:/tmp$ ./pari_time libmpfr.so.6 libgomp.so.1\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\nelapsed: 2.322264\n```\nHowever since with musl there is no slowdown, this is most probably a glibc issue as indicated in comment [comment:96]. Can someone try the corresponding glibc patch?",
    "created_at": "2023-01-05T14:42:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561651",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:100" align="right">comment:100</div>

thank you Gonzalo for the small program. I can reproduce what you get:

```
zimmerma@coriandre:/tmp$ ./pari_time libgomp.so.1 libmpfr.so.6
dlopen("libgomp.so.1", RTLD_LAZY): ok
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 3.753101
zimmerma@coriandre:/tmp$ ./pari_time libmpfr.so.6 libgomp.so.1
dlopen("libmpfr.so.6", RTLD_LAZY): ok
dlopen("libgomp.so.1", RTLD_LAZY): ok
elapsed: 2.322264
```
However since with musl there is no slowdown, this is most probably a glibc issue as indicated in comment [comment:96]. Can someone try the corresponding glibc patch?



---

archive/issue_comments_561652.json:
```json
{
    "body": "<div id=\"comment:101\" align=\"right\">comment:101</div>\n\nIndeed:\n\n```\n$ /lib/ld-linux-x86-64.so.2 ./pari_time libmpfr.so.6\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.640606\n\n$ masterdir/builddir/glibc-2.36/build/elf/ld-linux-x86-64.so.2 tmp/pari_time libmpfr.so.6\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.018676\n```\n\nI applied the last patch in that ticket (https://sourceware.org/bugzilla/attachment.cgi?id=13457).\n\nIssue remains, since you can't go patching glibc, if there is a workaround...",
    "created_at": "2023-01-05T15:47:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561652",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:101" align="right">comment:101</div>

Indeed:

```
$ /lib/ld-linux-x86-64.so.2 ./pari_time libmpfr.so.6
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.640606

$ masterdir/builddir/glibc-2.36/build/elf/ld-linux-x86-64.so.2 tmp/pari_time libmpfr.so.6
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.018676
```

I applied the last patch in that ticket (https://sourceware.org/bugzilla/attachment.cgi?id=13457).

Issue remains, since you can't go patching glibc, if there is a workaround...



---

archive/issue_comments_561653.json:
```json
{
    "body": "<div id=\"comment:102\" align=\"right\">comment:102</div>\n\nby the way, which glibc version do you have on your system? If not 2.36, can you check the issue still appears with 2.36 (without the patch)?\n\nIf so, I suggest sending a mail with your small C program on the glibc-alpha list.\nMaybe it will motivate the glibc developers to apply this patch.",
    "created_at": "2023-01-05T16:00:26Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561653",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:102" align="right">comment:102</div>

by the way, which glibc version do you have on your system? If not 2.36, can you check the issue still appears with 2.36 (without the patch)?

If so, I suggest sending a mail with your small C program on the glibc-alpha list.
Maybe it will motivate the glibc developers to apply this patch.



---

archive/issue_comments_561654.json:
```json
{
    "body": "<div id=\"comment:103\" align=\"right\">comment:103</div>\n\nI guess the glibc patch got lost because it was not sent at the proper place. I have put a comment on the bugzilla page.",
    "created_at": "2023-01-05T16:12:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561654",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:103" align="right">comment:103</div>

I guess the glibc patch got lost because it was not sent at the proper place. I have put a comment on the bugzilla page.



---

archive/issue_comments_561655.json:
```json
{
    "body": "<div id=\"comment:104\" align=\"right\">comment:104</div>\n\nI can confirm that the workaround provided in https://sourceware.org/bugzilla/show_bug.cgi?id=19924\n(load a library with TLS, and access a TLS variable there)\nalso works here, so it's really the same bug.",
    "created_at": "2023-01-05T16:27:57Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561655",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:104" align="right">comment:104</div>

I can confirm that the workaround provided in https://sourceware.org/bugzilla/show_bug.cgi?id=19924
(load a library with TLS, and access a TLS variable there)
also works here, so it's really the same bug.



---

archive/issue_comments_561656.json:
```json
{
    "body": "<div id=\"comment:105\" align=\"right\">comment:105</div>\n\nThat's my experiment:\n\n`git clone https://git.sr.ht/~dimpase/tls_workaround`\n\nand hit `make`. (we need to create a dummy dynamic library with TLS, etc, so it's a bit of setup)",
    "created_at": "2023-01-05T17:09:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561656",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:105" align="right">comment:105</div>

That's my experiment:

`git clone https://git.sr.ht/~dimpase/tls_workaround`

and hit `make`. (we need to create a dummy dynamic library with TLS, etc, so it's a bit of setup)



---

archive/issue_comments_561657.json:
```json
{
    "body": "<div id=\"comment:106\" align=\"right\">comment:106</div>\n\nwith the following simple change in `pari_time.c`, there is no more issue:\n\n```\n$ diff pari_time.c.orig pari_time.c\n4a5\n> #include <mpfr.h>\n8a10\n>     mpfr_exp_t e = mpfr_get_emin ();\n```\nHowever you might have to do the same for any library that has TLS variables.",
    "created_at": "2023-01-06T06:35:27Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561657",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:106" align="right">comment:106</div>

with the following simple change in `pari_time.c`, there is no more issue:

```
$ diff pari_time.c.orig pari_time.c
4a5
> #include <mpfr.h>
8a10
>     mpfr_exp_t e = mpfr_get_emin ();
```
However you might have to do the same for any library that has TLS variables.



---

archive/issue_comments_561658.json:
```json
{
    "body": "<div id=\"comment:107\" align=\"right\">comment:107</div>\n\nReplying to [Paul Zimmermann](#comment%3A103):\n> I guess the glibc patch got lost because it was not sent at the proper place. I have put a comment on the bugzilla page.\n\nIt has been sent to libc-alpha too:\nhttps://patchwork.ozlabs.org/project/glibc/patch/b116855de71098ef7dd2875dd3237f8f3ecc12c2.1618301209.git.szabolcs.nagy@arm.com/",
    "created_at": "2023-01-06T09:20:01Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561658",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:107" align="right">comment:107</div>

Replying to [Paul Zimmermann](#comment%3A103):
> I guess the glibc patch got lost because it was not sent at the proper place. I have put a comment on the bugzilla page.

It has been sent to libc-alpha too:
https://patchwork.ozlabs.org/project/glibc/patch/b116855de71098ef7dd2875dd3237f8f3ecc12c2.1618301209.git.szabolcs.nagy@arm.com/



---

archive/issue_comments_561659.json:
```json
{
    "body": "<div id=\"comment:108\" align=\"right\">comment:108</div>\n\n> It has been sent to libc-alpha too: [...]\n\nright, I will ask Szabolcs if he can post a new version as requested.",
    "created_at": "2023-01-06T10:01:54Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561659",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:108" align="right">comment:108</div>

> It has been sent to libc-alpha too: [...]

right, I will ask Szabolcs if he can post a new version as requested.



---

archive/issue_comments_561660.json:
```json
{
    "body": "<div id=\"comment:109\" align=\"right\">comment:109</div>\n\nHi Marc,\n\nReplying to [Marc Mezzarobba](#comment%3A96):\n> In any case, it appears that loading new libraries (specifically, FLINT) after MPFR makes pari work at normal speed again. Regardless where the issue really comes from, this suggests that there is at least a workaround that MPFR could implement.\n\nI don't see what workaround MPFR could implement. If I understand correctly, there are 2 things to avoid the bug: either change the order of the library loading, but this is something that can be done only at the application or user level, or access an MPFR thread-local variable, but I don't think that this is possible at library load time on the MPFR side, i.e. this is also something that can be done only at the application level (see Paul's suggestion, consisting in calling `mpfr_get_emin()`).",
    "created_at": "2023-01-06T10:11:31Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561660",
    "user": "https://github.com/vinc17fr"
}
```

<div id="comment:109" align="right">comment:109</div>

Hi Marc,

Replying to [Marc Mezzarobba](#comment%3A96):
> In any case, it appears that loading new libraries (specifically, FLINT) after MPFR makes pari work at normal speed again. Regardless where the issue really comes from, this suggests that there is at least a workaround that MPFR could implement.

I don't see what workaround MPFR could implement. If I understand correctly, there are 2 things to avoid the bug: either change the order of the library loading, but this is something that can be done only at the application or user level, or access an MPFR thread-local variable, but I don't think that this is possible at library load time on the MPFR side, i.e. this is also something that can be done only at the application level (see Paul's suggestion, consisting in calling `mpfr_get_emin()`).



---

archive/issue_comments_561661.json:
```json
{
    "body": "<div id=\"comment:110\" align=\"right\">comment:110</div>\n\nReplying to [Paul Zimmermann](#comment%3A106):\n> with the following simple change in `pari_time.c`, there is no more issue:\n> \n> ```\n> $ diff pari_time.c.orig pari_time.c\n> 4a5\n> > #include <mpfr.h>\n> 8a10\n> >     mpfr_exp_t e = mpfr_get_emin ();\n> ```\n> However you might have to do the same for any library that has TLS variables.\n\nalternatively, and certainly easier w.r.t. software complexity (vendors of libraries don't have to do anything), before starting any computations, one can dlopen a dummy library\n\n```c\n__thread int dummy_tls_for_lib = 23;\n\nvoid dummy_access()\n{\n    dummy_tls_for_lib++;\n}\n```\nand access a TLS variable, as in https://git.sr.ht/~dimpase/tls_workaround/tree/main/item/p.c#L34\n\n```c\n      void* handle = dlopen(\"./libdummy.so\", RTLD_NOW);\n      void (*dummy_access)(void);\n      *(void**)(&dummy_access) = dlsym(handle, \"dummy_access\");\n      dummy_access();\n```",
    "created_at": "2023-01-06T10:15:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561661",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:110" align="right">comment:110</div>

Replying to [Paul Zimmermann](#comment%3A106):
> with the following simple change in `pari_time.c`, there is no more issue:
> 
> ```
> $ diff pari_time.c.orig pari_time.c
> 4a5
> > #include <mpfr.h>
> 8a10
> >     mpfr_exp_t e = mpfr_get_emin ();
> ```
> However you might have to do the same for any library that has TLS variables.

alternatively, and certainly easier w.r.t. software complexity (vendors of libraries don't have to do anything), before starting any computations, one can dlopen a dummy library

```c
__thread int dummy_tls_for_lib = 23;

void dummy_access()
{
    dummy_tls_for_lib++;
}
```
and access a TLS variable, as in https://git.sr.ht/~dimpase/tls_workaround/tree/main/item/p.c#L34

```c
      void* handle = dlopen("./libdummy.so", RTLD_NOW);
      void (*dummy_access)(void);
      *(void**)(&dummy_access) = dlsym(handle, "dummy_access");
      dummy_access();
```



---

archive/issue_comments_561662.json:
```json
{
    "body": "<div id=\"comment:111\" align=\"right\">comment:111</div>\n\nReplying to [Paul Zimmermann](#comment%3A108):\n> > It has been sent to libc-alpha too: [...]\n> \n> \n> right, I will ask Szabolcs if he can post a new version as requested.\n\nfrankly speaking, it looks as if glibc is stalling on this bug since, like, forever...\nI also don't get what Carlos asks from Szabolcs (1.5 YEARS after the submission of the patches) - it doesn't look as if anything in that patch series was touched.",
    "created_at": "2023-01-06T12:08:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561662",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:111" align="right">comment:111</div>

Replying to [Paul Zimmermann](#comment%3A108):
> > It has been sent to libc-alpha too: [...]
> 
> 
> right, I will ask Szabolcs if he can post a new version as requested.

frankly speaking, it looks as if glibc is stalling on this bug since, like, forever...
I also don't get what Carlos asks from Szabolcs (1.5 YEARS after the submission of the patches) - it doesn't look as if anything in that patch series was touched.



---

archive/issue_comments_561663.json:
```json
{
    "body": "<div id=\"comment:112\" align=\"right\">comment:112</div>\n\nReplying to [Vincent Lef\u00e8vre](#comment%3A109):\n> I don't think that this is possible at library load time on the MPFR side, i.e. this is also something that can be done only at the application level\n\nOkay, I assumed to could be done at load time, but you definitely know better :-)",
    "created_at": "2023-01-06T12:31:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561663",
    "user": "https://github.com/mezzarobba"
}
```

<div id="comment:112" align="right">comment:112</div>

Replying to [Vincent Lefèvre](#comment%3A109):
> I don't think that this is possible at library load time on the MPFR side, i.e. this is also something that can be done only at the application level

Okay, I assumed to could be done at load time, but you definitely know better :-)



---

archive/issue_comments_561664.json:
```json
{
    "body": "<div id=\"comment:113\" align=\"right\">comment:113</div>\n\nReplying to [Paul Zimmermann](#comment%3A106):\n> with the following simple change in `pari_time.c`, there is no more issue:\n> \n> ```\n> $ diff pari_time.c.orig pari_time.c\n> 4a5\n> > #include <mpfr.h>\n> 8a10\n> >     mpfr_exp_t e = mpfr_get_emin ();\n> ```\n> However you might have to do the same for any library that has TLS variables.\n\nLinking with `-lmpfr` certainly fixes the issue, no need to change the program, and the order is unimportant:\n\n```\n$ cc pari_time.c -lpari -o pari_time && ./pari_time libmpfr.so\ndlopen(\"libmpfr.so\", RTLD_LAZY): ok\nelapsed: 1.650579\n$ cc pari_time.c -lpari -lmpfr -o pari_time && ./pari_time libmpfr.so\ndlopen(\"libmpfr.so\", RTLD_LAZY): ok\nelapsed: 1.016185\n$ cc pari_time.c -lmpfr -lpari -o pari_time && ./pari_time libmpfr.so\ndlopen(\"libmpfr.so\", RTLD_LAZY): ok\nelapsed: 1.015236\n```\n\nHere the `dlopen()` call is a nop since libmpfr has already been loaded before the program started.",
    "created_at": "2023-01-06T13:17:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561664",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:113" align="right">comment:113</div>

Replying to [Paul Zimmermann](#comment%3A106):
> with the following simple change in `pari_time.c`, there is no more issue:
> 
> ```
> $ diff pari_time.c.orig pari_time.c
> 4a5
> > #include <mpfr.h>
> 8a10
> >     mpfr_exp_t e = mpfr_get_emin ();
> ```
> However you might have to do the same for any library that has TLS variables.

Linking with `-lmpfr` certainly fixes the issue, no need to change the program, and the order is unimportant:

```
$ cc pari_time.c -lpari -o pari_time && ./pari_time libmpfr.so
dlopen("libmpfr.so", RTLD_LAZY): ok
elapsed: 1.650579
$ cc pari_time.c -lpari -lmpfr -o pari_time && ./pari_time libmpfr.so
dlopen("libmpfr.so", RTLD_LAZY): ok
elapsed: 1.016185
$ cc pari_time.c -lmpfr -lpari -o pari_time && ./pari_time libmpfr.so
dlopen("libmpfr.so", RTLD_LAZY): ok
elapsed: 1.015236
```

Here the `dlopen()` call is a nop since libmpfr has already been loaded before the program started.



---

archive/issue_comments_561665.json:
```json
{
    "body": "<div id=\"comment:114\" align=\"right\">comment:114</div>\n\nReplying to [Vincent Lef\u00e8vre](#comment%3A109):\n> Hi Marc,\n> \n> Replying to [Marc Mezzarobba](#comment%3A96):\n> > In any case, it appears that loading new libraries (specifically, FLINT) after MPFR makes pari work at normal speed again. Regardless where the issue really comes from, this suggests that there is at least a workaround that MPFR could implement.\n> \n> \n> I don't see what workaround MPFR could implement. If I understand correctly, there are 2 things to avoid the bug: either change the order of the library loading, but this is something that can be done only at the application or user level, or access an MPFR thread-local variable, but I don't think that this is possible at library load time on the MPFR side, i.e. this is also something that can be done only at the application level (see Paul's suggestion, consisting in calling `mpfr_get_emin()`).\n\n\nJust for fun I rebuilt mpfr-4.1.1 with the following silly patch and voil\u00e0, the issue goes away:\n\n```diff\n--- a/src/exceptions.c\t2022-01-06 12:27:38.000000000 -0300\n+++ b/src/exceptions.c\t2023-01-06 10:32:49.845632284 -0300\n@@ -34,6 +34,12 @@\n   return __gmpfr_emin;\n }\n \n+static void __attribute__ ((constructor))\n+__dummy_access_tls (void)\n+{\n+\t__gmpfr_emin = MPFR_EMIN_DEFAULT;\n+}\n+\n #undef mpfr_set_emin\n \n int\n```",
    "created_at": "2023-01-06T13:59:35Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561665",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:114" align="right">comment:114</div>

Replying to [Vincent Lefèvre](#comment%3A109):
> Hi Marc,
> 
> Replying to [Marc Mezzarobba](#comment%3A96):
> > In any case, it appears that loading new libraries (specifically, FLINT) after MPFR makes pari work at normal speed again. Regardless where the issue really comes from, this suggests that there is at least a workaround that MPFR could implement.
> 
> 
> I don't see what workaround MPFR could implement. If I understand correctly, there are 2 things to avoid the bug: either change the order of the library loading, but this is something that can be done only at the application or user level, or access an MPFR thread-local variable, but I don't think that this is possible at library load time on the MPFR side, i.e. this is also something that can be done only at the application level (see Paul's suggestion, consisting in calling `mpfr_get_emin()`).


Just for fun I rebuilt mpfr-4.1.1 with the following silly patch and voilà, the issue goes away:

```diff
--- a/src/exceptions.c	2022-01-06 12:27:38.000000000 -0300
+++ b/src/exceptions.c	2023-01-06 10:32:49.845632284 -0300
@@ -34,6 +34,12 @@
   return __gmpfr_emin;
 }
 
+static void __attribute__ ((constructor))
+__dummy_access_tls (void)
+{
+	__gmpfr_emin = MPFR_EMIN_DEFAULT;
+}
+
 #undef mpfr_set_emin
 
 int
```



---

archive/issue_comments_561666.json:
```json
{
    "body": "<div id=\"comment:115\" align=\"right\">comment:115</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A114):\n> Just for fun I rebuilt mpfr-4.1.1 with the following silly patch and voil\u00e0, the issue goes away:\n> \n> ```diff\n> --- a/src/exceptions.c\t2022-01-06 12:27:38.000000000 -0300\n> +++ b/src/exceptions.c\t2023-01-06 10:32:49.845632284 -0300\n> @@ -34,6 +34,12 @@\n>    return __gmpfr_emin;\n>  }\n>  \n> +static void __attribute__ ((constructor))\n> +__dummy_access_tls (void)\n> +{\n> +\t__gmpfr_emin = MPFR_EMIN_DEFAULT;\n> +}\n> +\n>  #undef mpfr_set_emin\n>  \n>  int\n> ```\n\nBut note that `__attribute__ ((constructor))` is a GNU extension.",
    "created_at": "2023-01-06T14:24:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561666",
    "user": "https://github.com/vinc17fr"
}
```

<div id="comment:115" align="right">comment:115</div>

Replying to [Gonzalo Tornaría](#comment%3A114):
> Just for fun I rebuilt mpfr-4.1.1 with the following silly patch and voilà, the issue goes away:
> 
> ```diff
> --- a/src/exceptions.c	2022-01-06 12:27:38.000000000 -0300
> +++ b/src/exceptions.c	2023-01-06 10:32:49.845632284 -0300
> @@ -34,6 +34,12 @@
>    return __gmpfr_emin;
>  }
>  
> +static void __attribute__ ((constructor))
> +__dummy_access_tls (void)
> +{
> +	__gmpfr_emin = MPFR_EMIN_DEFAULT;
> +}
> +
>  #undef mpfr_set_emin
>  
>  int
> ```

But note that `__attribute__ ((constructor))` is a GNU extension.



---

archive/issue_comments_561667.json:
```json
{
    "body": "<div id=\"comment:116\" align=\"right\">comment:116</div>\n\nReplying to [Vincent Lef\u00e8vre](#comment%3A115):\n> But note that `__attribute__ ((constructor))` is a GNU extension.\n\nFortunately, the bug is also a GNU extension.\n\nJust guard the whole thing inside MPFR_HAVE_CONSTRUCTOR_ATTR and some GLIBC defined macro.",
    "created_at": "2023-01-06T14:37:29Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561667",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:116" align="right">comment:116</div>

Replying to [Vincent Lefèvre](#comment%3A115):
> But note that `__attribute__ ((constructor))` is a GNU extension.

Fortunately, the bug is also a GNU extension.

Just guard the whole thing inside MPFR_HAVE_CONSTRUCTOR_ATTR and some GLIBC defined macro.



---

archive/issue_comments_561668.json:
```json
{
    "body": "<div id=\"comment:117\" align=\"right\">comment:117</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A116):\n\n> Fortunately, the bug is also a GNU extension.\n\nGNU inaction, rather... Time for another `eglibc` fork?\n\n> \n> Just guard the whole thing inside MPFR_HAVE_CONSTRUCTOR_ATTR and some GLIBC defined macro.\n\nand it's `x86_64` - only, too, right?",
    "created_at": "2023-01-06T15:32:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561668",
    "user": "https://github.com/dimpase"
}
```

<div id="comment:117" align="right">comment:117</div>

Replying to [Gonzalo Tornaría](#comment%3A116):

> Fortunately, the bug is also a GNU extension.

GNU inaction, rather... Time for another `eglibc` fork?

> 
> Just guard the whole thing inside MPFR_HAVE_CONSTRUCTOR_ATTR and some GLIBC defined macro.

and it's `x86_64` - only, too, right?



---

archive/issue_comments_561669.json:
```json
{
    "body": "<div id=\"comment:118\" align=\"right\">comment:118</div>\n\nReplying to [Gonzalo Tornar\u00eda](#comment%3A116):\n> Replying to [Vincent Lef\u00e8vre](#comment%3A115):\n> > But note that `__attribute__ ((constructor))` is a GNU extension.\n> \n> Fortunately, the bug is also a GNU extension.\n\nThings are more complex. Such GNU extensions at compiler level are available on various systems, and it is not clear that they are working correctly on other systems. In theory, this should have no effect on such systems, but it is not impossible to trigger a bug yielding an incorrect behavior. In particular, this feature is probably used very little at library load time. So I'm wondering whether it has been fully tested on various systems. Enabling such a workaround via a configure option should be safer.",
    "created_at": "2023-01-06T15:50:43Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561669",
    "user": "https://github.com/vinc17fr"
}
```

<div id="comment:118" align="right">comment:118</div>

Replying to [Gonzalo Tornaría](#comment%3A116):
> Replying to [Vincent Lefèvre](#comment%3A115):
> > But note that `__attribute__ ((constructor))` is a GNU extension.
> 
> Fortunately, the bug is also a GNU extension.

Things are more complex. Such GNU extensions at compiler level are available on various systems, and it is not clear that they are working correctly on other systems. In theory, this should have no effect on such systems, but it is not impossible to trigger a bug yielding an incorrect behavior. In particular, this feature is probably used very little at library load time. So I'm wondering whether it has been fully tested on various systems. Enabling such a workaround via a configure option should be safer.



---

archive/issue_comments_561670.json:
```json
{
    "body": "<div id=\"comment:119\" align=\"right\">comment:119</div>\n\nanyway, the issue is clearly on the glibc side, and it is not a good idea to try to workaround any compiler/library issue on the mpfr side. But of course Sage developers can patch their mpfr version if they like.",
    "created_at": "2023-01-06T17:47:45Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561670",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:119" align="right">comment:119</div>

anyway, the issue is clearly on the glibc side, and it is not a good idea to try to workaround any compiler/library issue on the mpfr side. But of course Sage developers can patch their mpfr version if they like.



---

archive/issue_comments_561671.json:
```json
{
    "body": "<div id=\"comment:120\" align=\"right\">comment:120</div>\n\na new version of the patch: https://patchwork.ozlabs.org/project/glibc/patch/20221019111439.63501-1-szabolcs.nagy@arm.com/\n\nand the corresponding discussion:\n\nhttps://sourceware.org/pipermail/libc-alpha/2023-January/144533.html\n\n\nIf someone out there wants this to be included in glibc 2.37 (which will be released in February), feel free to review the patch on the libc-alpha list.",
    "created_at": "2023-01-06T17:52:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561671",
    "user": "https://github.com/zimmermann6"
}
```

<div id="comment:120" align="right">comment:120</div>

a new version of the patch: https://patchwork.ozlabs.org/project/glibc/patch/20221019111439.63501-1-szabolcs.nagy@arm.com/

and the corresponding discussion:

https://sourceware.org/pipermail/libc-alpha/2023-January/144533.html


If someone out there wants this to be included in glibc 2.37 (which will be released in February), feel free to review the patch on the libc-alpha list.



---

archive/issue_comments_561672.json:
```json
{
    "body": "<div id=\"comment:121\" align=\"right\">comment:121</div>\n\nThanks Paul. I tried the v3 version of the patch that was posted yesterday (https://sourceware.org/pipermail/libc-alpha/2023-January/144535.html).\n\nIt does fix the slowdown:\n\n```\n$ cat pari_time.c \n#include <stdio.h>\n#include <time.h>\n#include <dlfcn.h>\n\n#include <pari/pari.h>\n\nvoid run()\n{\n    clock_t t = clock();\n    setrand(stoi(1)); /* make it deterministic */\n    GEN D = subui(1,powuu(2,100));\n    GEN ans = quadclassunit0(D, 0, NULL, 38);\n    printf(\"elapsed: %.3f\\n\", (double)(clock()-t)/CLOCKS_PER_SEC);\n}\n\n\nint main(int argc, char *argv[])\n{\n    pari_init(1<<24, 0);\n    run();\n\n    while(--argc) {\n        char * name = *++argv;\n        void * h = dlopen(name, RTLD_LAZY);\n        printf(\"dlopen(\\\"%s\\\", RTLD_LAZY): %s\\n\", name, h ? \"ok\" : \"fail\");\n        run();\n    }\n}\n\n$ cc pari_time.c -lpari -o pari_time\n\n$ ./pari_time libmpfr.so.6 libgomp.so.1\nelapsed: 1.291\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.977\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\nelapsed: 1.253\n\n$ glibc/build/elf/ld.so ./pari_time libmpfr.so.6 libgomp.so.1\nelapsed: 1.263\ndlopen(\"libmpfr.so.6\", RTLD_LAZY): ok\nelapsed: 1.238\ndlopen(\"libgomp.so.1\", RTLD_LAZY): ok\nelapsed: 1.229\n```",
    "created_at": "2023-01-07T19:44:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34850",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34850#issuecomment-561672",
    "user": "https://github.com/tornaria"
}
```

<div id="comment:121" align="right">comment:121</div>

Thanks Paul. I tried the v3 version of the patch that was posted yesterday (https://sourceware.org/pipermail/libc-alpha/2023-January/144535.html).

It does fix the slowdown:

```
$ cat pari_time.c 
#include <stdio.h>
#include <time.h>
#include <dlfcn.h>

#include <pari/pari.h>

void run()
{
    clock_t t = clock();
    setrand(stoi(1)); /* make it deterministic */
    GEN D = subui(1,powuu(2,100));
    GEN ans = quadclassunit0(D, 0, NULL, 38);
    printf("elapsed: %.3f\n", (double)(clock()-t)/CLOCKS_PER_SEC);
}


int main(int argc, char *argv[])
{
    pari_init(1<<24, 0);
    run();

    while(--argc) {
        char * name = *++argv;
        void * h = dlopen(name, RTLD_LAZY);
        printf("dlopen(\"%s\", RTLD_LAZY): %s\n", name, h ? "ok" : "fail");
        run();
    }
}

$ cc pari_time.c -lpari -o pari_time

$ ./pari_time libmpfr.so.6 libgomp.so.1
elapsed: 1.291
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.977
dlopen("libgomp.so.1", RTLD_LAZY): ok
elapsed: 1.253

$ glibc/build/elf/ld.so ./pari_time libmpfr.so.6 libgomp.so.1
elapsed: 1.263
dlopen("libmpfr.so.6", RTLD_LAZY): ok
elapsed: 1.238
dlopen("libgomp.so.1", RTLD_LAZY): ok
elapsed: 1.229
```
