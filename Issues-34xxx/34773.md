# Issue 34773: Dual algorithm for Face iterator of Unbounded Combinatorial Polyhedron

archive/issues_034536.json:
```json
{
    "body": "CC:  @mkoeppe\n\n**Request**\n\nThe dual algorithm for face iterator is not available for unbounded polyhedron. See the following small example:\n\n```python\nC = Polyhedron(eqns=[[0, 0, -1, 1]], ieqs=[[0,1,0,0],[0,0,1,0],[0,0,0,1]]).combinatorial_polyhedron()\nit = C.face_generator(algorithm='dual')\nnext(it)\nit.ignore_supfaces()\n```\n\n`ValueError: dual algorithm only available for bounded polyhedra`\n\nHowever, in the document https://doc.sagemath.org/html/en/reference/discrete_geometry/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.html\n\nIt states \"It also works on unbounded polyhedra, as those satisfy the diamond property, except for intervals including the empty face. A (slightly generalized) description of the algorithm can be found in [KS2019].\"\n\n**Approach**\n\nThe combinatorial polyhedron and the face iterator suffer from some design problems. While the equations have been removed from the combinatorial structure, the same has not been done with the linear subspace.\n\n- We make the underlying structure always a polytope. This will simplify the algorithm a lot. The convention will be:\n  - Equations and linear subspace are treated manually independently of the combinatorial structure. (This is already the case for equations).\n  - The far facet will be added as the last facet.\n  - Vertices and rays can be told apart by containment in the far facet.\n\n**Consequences**\n\n- For a polytope we just proceed as before.\n- By marking the far facet as visited, we visit all faces of the polyhedron for the non-dual algorithm starting with the facets.\n- We sort the generators to first visit the supfaces of the vertices. Then we just stop. This way we visit all faces with the dual algorithm.\n\n**Bonus**\n\nThe definitions of simple and simplicial make sense for unbounded polyhedra as well and the simpliciations of the algorithm therefor work as well.\n\nSuddenly we also have an algorithm to visit the bounded faces of a polyhedron:\n- We ignore all supfaces of all rays. Then we visit all bounded faces with the dual algorithm.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34773\n\n",
    "created_at": "2022-11-22T18:07:44Z",
    "labels": [
        "component: geometry"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Dual algorithm for Face iterator of Unbounded Combinatorial Polyhedron",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34773",
    "user": "https://github.com/xuluze"
}
```
CC:  @mkoeppe

**Request**

The dual algorithm for face iterator is not available for unbounded polyhedron. See the following small example:

```python
C = Polyhedron(eqns=[[0, 0, -1, 1]], ieqs=[[0,1,0,0],[0,0,1,0],[0,0,0,1]]).combinatorial_polyhedron()
it = C.face_generator(algorithm='dual')
next(it)
it.ignore_supfaces()
```

`ValueError: dual algorithm only available for bounded polyhedra`

However, in the document https://doc.sagemath.org/html/en/reference/discrete_geometry/sage/geometry/polyhedron/combinatorial_polyhedron/face_iterator.html

It states "It also works on unbounded polyhedra, as those satisfy the diamond property, except for intervals including the empty face. A (slightly generalized) description of the algorithm can be found in [KS2019]."

**Approach**

The combinatorial polyhedron and the face iterator suffer from some design problems. While the equations have been removed from the combinatorial structure, the same has not been done with the linear subspace.

- We make the underlying structure always a polytope. This will simplify the algorithm a lot. The convention will be:
  - Equations and linear subspace are treated manually independently of the combinatorial structure. (This is already the case for equations).
  - The far facet will be added as the last facet.
  - Vertices and rays can be told apart by containment in the far facet.

**Consequences**

- For a polytope we just proceed as before.
- By marking the far facet as visited, we visit all faces of the polyhedron for the non-dual algorithm starting with the facets.
- We sort the generators to first visit the supfaces of the vertices. Then we just stop. This way we visit all faces with the dual algorithm.

**Bonus**

The definitions of simple and simplicial make sense for unbounded polyhedra as well and the simpliciations of the algorithm therefor work as well.

Suddenly we also have an algorithm to visit the bounded faces of a polyhedron:
- We ignore all supfaces of all rays. Then we visit all bounded faces with the dual algorithm.


Issue created by migration from https://trac.sagemath.org/ticket/34773





---

archive/issue_comments_488174.json:
```json
{
    "body": "`@`gh-kliem Would this be easy to implement?",
    "created_at": "2022-11-22T18:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488174",
    "user": "https://github.com/mkoeppe"
}
```

`@`gh-kliem Would this be easy to implement?



---

archive/issue_comments_488175.json:
```json
{
    "body": "I don't think it is very hard. How urgent is it? Or is it just to have it.\n\nIt is just that I messed this up in the beginning, as I didn't know any better.\n\nThe real work might be to clean up along the way. Some stuff is just way too complicated and might be a huge pain to maintain (and is already very difficult to compensate for everyone not directly involved, maybe even everyone except me).",
    "created_at": "2022-11-27T10:06:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488175",
    "user": "https://github.com/kliem"
}
```

I don't think it is very hard. How urgent is it? Or is it just to have it.

It is just that I messed this up in the beginning, as I didn't know any better.

The real work might be to clean up along the way. Some stuff is just way too complicated and might be a huge pain to maintain (and is already very difficult to compensate for everyone not directly involved, maybe even everyone except me).



---

archive/issue_comments_488176.json:
```json
{
    "body": "In our case, we can try to get around it by adding a hyperplane to make the cone bounded, and be careful to identify the original faces when handling with the face iterator. But it would be nice to have the dual algorithm apply to our unbounded case directly to make the code cleaner.",
    "created_at": "2022-11-28T04:35:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488176",
    "user": "https://github.com/xuluze"
}
```

In our case, we can try to get around it by adding a hyperplane to make the cone bounded, and be careful to identify the original faces when handling with the face iterator. But it would be nice to have the dual algorithm apply to our unbounded case directly to make the code cleaner.



---

archive/issue_comments_488177.json:
```json
{
    "body": "Something like:\n\n```\nsage: P = Polyhedron(rays=[[1,0,0], [0,1,0], [0,1,1]])\nsage: C = P.combinatorial_polyhedron()\nsage: facets = C.facets()\nsage: far_face = P.rays()\nsage: new_facets = facets + (far_face,)\nsage: C1 = CombinatorialPolyhedron(new_facets)\nsage: it = C1.face_iter(algorithm='dual')\nsage: faces = [i for i in it if any(v.is_vertex() for v in i.ambient_Vrepresentation())]\n```\n\nshould work as a workaround.",
    "created_at": "2022-11-28T19:33:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488177",
    "user": "https://github.com/kliem"
}
```

Something like:

```
sage: P = Polyhedron(rays=[[1,0,0], [0,1,0], [0,1,1]])
sage: C = P.combinatorial_polyhedron()
sage: facets = C.facets()
sage: far_face = P.rays()
sage: new_facets = facets + (far_face,)
sage: C1 = CombinatorialPolyhedron(new_facets)
sage: it = C1.face_iter(algorithm='dual')
sage: faces = [i for i in it if any(v.is_vertex() for v in i.ambient_Vrepresentation())]
```

should work as a workaround.



---

archive/issue_comments_488178.json:
```json
{
    "body": "Thank you very much! Yes, it works.",
    "created_at": "2022-12-01T18:26:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488178",
    "user": "https://github.com/xuluze"
}
```

Thank you very much! Yes, it works.



---

archive/issue_comments_488179.json:
```json
{
    "body": "> Suddenly we also have an algorithm to visit the bounded faces of a polyhedron:\n\n\nGreat - that will also be useful for computing regular subdivisions",
    "created_at": "2022-12-09T19:17:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488179",
    "user": "https://github.com/mkoeppe"
}
```

> Suddenly we also have an algorithm to visit the bounded faces of a polyhedron:


Great - that will also be useful for computing regular subdivisions



---

archive/issue_comments_488180.json:
```json
{
    "body": "Unfortunatly, I had to remove some nonsense. the bounded faces starting from the facets are a bit annoying and I don't know a shortcut to visiting all faces and filtering.\n\nStarting from the vertices there is a shortcut I think. At least the implementation is easy. If there are few vertices and many many rays, the assymtotics are a bit annoying: # bounded faces * # generators * # vertices * # facets.\n\nIf the generators are in general position that is much nicer: # bounded faces * # vertices * max(# vertices, # facets).\n\n(Subject to stupid mistakes I made because I'm tired.)\n\nEdit: The generators need to be in general position.",
    "created_at": "2022-12-09T20:48:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488180",
    "user": "https://github.com/kliem"
}
```

Unfortunatly, I had to remove some nonsense. the bounded faces starting from the facets are a bit annoying and I don't know a shortcut to visiting all faces and filtering.

Starting from the vertices there is a shortcut I think. At least the implementation is easy. If there are few vertices and many many rays, the assymtotics are a bit annoying: # bounded faces * # generators * # vertices * # facets.

If the generators are in general position that is much nicer: # bounded faces * # vertices * max(# vertices, # facets).

(Subject to stupid mistakes I made because I'm tired.)

Edit: The generators need to be in general position.



---

archive/issue_comments_488181.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-12-10T15:30:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488181",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_488182.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-12-10T20:06:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488182",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_488183.json:
```json
{
    "body": "There is actually one thing one needs to pay attention to:\n\nA far face is not always a far facet:\n\nE.g. `Polyhedron(vertices=[[1, 0], [0, 1]], rays=[This is the Trac macro *1, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 1-macro))` is unbounded, but does not have a far facet.\n\nBut `Polyhedron(vertices=[[1, 0], [0, 1]], rays=[[1, 0], [0, 1]])` has a far facet.",
    "created_at": "2022-12-11T15:46:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34773#issuecomment-488183",
    "user": "https://github.com/kliem"
}
```

There is actually one thing one needs to pay attention to:

A far face is not always a far facet:

E.g. `Polyhedron(vertices=[[1, 0], [0, 1]], rays=[This is the Trac macro *1, 1* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#1, 1-macro))` is unbounded, but does not have a far facet.

But `Polyhedron(vertices=[[1, 0], [0, 1]], rays=[[1, 0], [0, 1]])` has a far facet.
