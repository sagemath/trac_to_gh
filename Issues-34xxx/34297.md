# Issue 34297: GAP interface hangs waiting for prompt on aarch64

archive/issues_034060.json:
```json
{
    "assignees": [],
    "body": "Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`, but I think GAP is the culprit.\n\nFrom Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:\n\n```\nTraceback (most recent call first):\n  <built-in method select of module object at remote 0xfffff6d672e0>\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/utils.py\", line 143, in select_ignore_interrupts\n    return select.select(iwtd, owtd, ewtd, timeout)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py\", line 450, in select\n    return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py\", line 500, in read_nonblocking\n    if (timeout != 0) and select(timeout):\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/expect.py\", line 169, in expect_loop\n    incoming = spawn.read_nonblocking(spawn.maxread, timeout)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/spawnbase.py\", line 372, in expect_list\n    return exp.expect_loop(timeout)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 524, in _execute_line\n    x = E.expect_list(self._compiled_full_pattern)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 658, in _eval_line\n    (normal, error) = self._execute_line(line, wait_for_prompt=wait_for_prompt,\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py\", line 1387, in <listcomp>\n    return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py\", line 1387, in eval\n    return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 498, in eval\n    result = Expect.eval(self, input_line, **kwds)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py\", line 1832, in <listcomp>\n    v = [eval(gap.eval(\"w[\"+str(i)+\"]\")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py\", line 1832, in weight_distribution\n    v = [eval(gap.eval(\"w[\"+str(i)+\"]\")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form\n  <built-in method _instance_call of sage.misc.cachefunc.CachedMethodCaller object at remote 0xffff9085d640>\n  File \"<doctest sage.coding.golay_code.GolayCode.weight_distribution[9]>\", line 1, in <module>\n  <built-in method exec of module object at remote 0xfffff76f0590>\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1101, in compile_and_execute\n    exec(compiled, globs)\n```\nGAP, on the other hand, is happily executing `syFgets` and waiting for more input. Pexpect logs from good and bad runs don't seem to differ much, other than the missing `@i` at the end. I tried unsuccessfully to fix this. Here are some observations:\n\n1) A comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) says that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, but adding the blocks seems to make no difference.\n\n2) It seems really unlikely, but maybe Singular and GAP both have a bug. I check and both program's seem to handle SIGTERM in a signal-unsafe way because they use stdio. Speaking of which, GAP's `echoandcheck` function, used for printing `@i`, never retries the `write` syscall regardless of whether `errno` is `EINTR` or `EAGAIN` (but, again, retrying the write this does not help).\n\n3) I don't know if Sage shares the pty fd between different threads, but Pexpect documentation warns that any interaction with the pty must be done from the thread it was spawned (https://pexpect.readthedocs.io/en/stable/commonissues.html#threads).\n\nWhat makes this super annoying is that everything works fine under `strace -ff`. Perhaps this is not surprising, since every sign points to a race condition and/or a signal handling problem somewhere, but it makes debugging almost impossible to me.\n\nAs an aside: I am 99% sure I ran the testsuite on an aarch64 Oracle Cloud machine back in December/January and everything was working fine, but I tried reverting everything I could to old versions and the bug still shows up now (in August). In particular, I used an old version of Nixpkgs and Nix, which means that everything that runs as a non-superuser is exactly the same as it was back in December/January. I also tried an old kernel version, but I didn't try reverting systemd.\n\nComponent: **interfaces**\n\n_Issue created by migration from https://trac.sagemath.org/ticket/34297_\n\n",
    "created_at": "2022-08-07T02:03:16Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
        "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
        "https://github.com/sagemath/sage/labels/bug"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "GAP interface hangs waiting for prompt on aarch64",
    "type": "issue",
    "updated_at": "2022-09-23T23:21:21Z",
    "url": "https://github.com/sagemath/sage/issues/34297",
    "user": "https://github.com/collares"
}
```
Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`, but I think GAP is the culprit.

From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:

```
Traceback (most recent call first):
  <built-in method select of module object at remote 0xfffff6d672e0>
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/utils.py", line 143, in select_ignore_interrupts
    return select.select(iwtd, owtd, ewtd, timeout)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py", line 450, in select
    return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py", line 500, in read_nonblocking
    if (timeout != 0) and select(timeout):
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/expect.py", line 169, in expect_loop
    incoming = spawn.read_nonblocking(spawn.maxread, timeout)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/spawnbase.py", line 372, in expect_list
    return exp.expect_loop(timeout)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 524, in _execute_line
    x = E.expect_list(self._compiled_full_pattern)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 658, in _eval_line
    (normal, error) = self._execute_line(line, wait_for_prompt=wait_for_prompt,
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py", line 1387, in <listcomp>
    return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py", line 1387, in eval
    return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 498, in eval
    result = Expect.eval(self, input_line, **kwds)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py", line 1832, in <listcomp>
    v = [eval(gap.eval("w["+str(i)+"]")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py", line 1832, in weight_distribution
    v = [eval(gap.eval("w["+str(i)+"]")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form
  <built-in method _instance_call of sage.misc.cachefunc.CachedMethodCaller object at remote 0xffff9085d640>
  File "<doctest sage.coding.golay_code.GolayCode.weight_distribution[9]>", line 1, in <module>
  <built-in method exec of module object at remote 0xfffff76f0590>
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py", line 1101, in compile_and_execute
    exec(compiled, globs)
```
GAP, on the other hand, is happily executing `syFgets` and waiting for more input. Pexpect logs from good and bad runs don't seem to differ much, other than the missing `@i` at the end. I tried unsuccessfully to fix this. Here are some observations:

1) A comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) says that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, but adding the blocks seems to make no difference.

2) It seems really unlikely, but maybe Singular and GAP both have a bug. I check and both program's seem to handle SIGTERM in a signal-unsafe way because they use stdio. Speaking of which, GAP's `echoandcheck` function, used for printing `@i`, never retries the `write` syscall regardless of whether `errno` is `EINTR` or `EAGAIN` (but, again, retrying the write this does not help).

3) I don't know if Sage shares the pty fd between different threads, but Pexpect documentation warns that any interaction with the pty must be done from the thread it was spawned (https://pexpect.readthedocs.io/en/stable/commonissues.html#threads).

What makes this super annoying is that everything works fine under `strace -ff`. Perhaps this is not surprising, since every sign points to a race condition and/or a signal handling problem somewhere, but it makes debugging almost impossible to me.

As an aside: I am 99% sure I ran the testsuite on an aarch64 Oracle Cloud machine back in December/January and everything was working fine, but I tried reverting everything I could to old versions and the bug still shows up now (in August). In particular, I used an old version of Nixpkgs and Nix, which means that everything that runs as a non-superuser is exactly the same as it was back in December/January. I also tried an old kernel version, but I didn't try reverting systemd.

Component: **interfaces**

_Issue created by migration from https://trac.sagemath.org/ticket/34297_





---

archive/issue_events_468887.json:
```json
{
    "actor": "https://github.com/collares",
    "created_at": "2022-08-07T02:03:16Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468887"
}
```



---

archive/issue_events_468888.json:
```json
{
    "actor": "https://github.com/collares",
    "created_at": "2022-08-07T02:03:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "label": "https://github.com/sagemath/sage/labels/c%3A%20interfaces",
    "label_color": "0000ff",
    "label_name": "c: interfaces",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468888"
}
```



---

archive/issue_events_468889.json:
```json
{
    "actor": "https://github.com/collares",
    "created_at": "2022-08-07T02:03:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "label": "https://github.com/sagemath/sage/labels/p%3A%203%20%E2%80%93%20major",
    "label_color": "ffbb00",
    "label_name": "p: 3 \u2013 major",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468889"
}
```



---

archive/issue_events_468890.json:
```json
{
    "actor": "https://github.com/collares",
    "created_at": "2022-08-07T02:03:16Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "label": "https://github.com/sagemath/sage/labels/bug",
    "label_color": "d73a4a",
    "label_name": "bug",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468890"
}
```



---

archive/issue_comments_553967.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-Recently, the Sage testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).\n+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).\n \n Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.\n \n``````\n",
    "created_at": "2022-08-07T02:03:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553967",
    "user": "https://github.com/collares"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-Recently, the Sage testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).
+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).
 
 Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.
 
``````




---

archive/issue_comments_553968.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,7 +1,42 @@\n-Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).\n+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process, while a child process with a different pid was waiting for input). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).\n \n Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.\n \n-Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then I can boot up a machine on Oracle Cloud and get stack traces from the real-world hang; unfortunately I didn't save them the first time, but they had the same characteristics as above: [this `expect_list` call in gap.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524) caused pexpect to run [a select call with timeout=None](https://github.com/pexpect/pexpect/blob/2be6c4d1aa2b9b522636342c2fd54b73c058060d/pexpect/pty_spawn.py#L500)). I would also be happy to apply further patches to get extra debugging output.\n+Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then unfortunately all I can provide is the Python stack trace from a real-world hang, obtained with `python-gdb.py`:\n+\n+```\n+Traceback (most recent call first):\n+  <built-in method select of module object at remote 0xfffff6d672e0>\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/utils.py\", line 143, in select_ignore_interrupts\n+    return select.select(iwtd, owtd, ewtd, timeout)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py\", line 450, in select\n+    return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py\", line 500, in read_nonblocking\n+    if (timeout != 0) and select(timeout):\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/expect.py\", line 169, in expect_loop\n+    incoming = spawn.read_nonblocking(spawn.maxread, timeout)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/spawnbase.py\", line 372, in expect_list\n+    return exp.expect_loop(timeout)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 524, in _execute_line\n+    x = E.expect_list(self._compiled_full_pattern)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 658, in _eval_line\n+    (normal, error) = self._execute_line(line, wait_for_prompt=wait_for_prompt,\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py\", line 1387, in <listcomp>\n+    return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py\", line 1387, in eval\n+    return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 498, in eval\n+    result = Expect.eval(self, input_line, **kwds)\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py\", line 1832, in <listcomp>\n+    v = [eval(gap.eval(\"w[\"+str(i)+\"]\")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py\", line 1832, in weight_distribution\n+    v = [eval(gap.eval(\"w[\"+str(i)+\"]\")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form\n+  <built-in method _instance_call of sage.misc.cachefunc.CachedMethodCaller object at remote 0xffff9085d640>\n+  File \"<doctest sage.coding.golay_code.GolayCode.weight_distribution[9]>\", line 1, in <module>\n+  <built-in method exec of module object at remote 0xfffff76f0590>\n+  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1101, in compile_and_execute\n+    exec(compiled, globs)\n+```\n+The real-world stack trace has the same characteristics from the one I obtained locally after applying the hacky patch. I would also be happy to apply further patches to get extra debugging output if it helps.\n \n This was reproduced both with ptyprocess 0.5.1 and 0.7.0, by the way.\n``````\n",
    "created_at": "2022-08-07T02:25:53Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553968",
    "user": "https://github.com/collares"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,7 +1,42 @@
-Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).
+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process, while a child process with a different pid was waiting for input). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).
 
 Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.
 
-Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then I can boot up a machine on Oracle Cloud and get stack traces from the real-world hang; unfortunately I didn't save them the first time, but they had the same characteristics as above: [this `expect_list` call in gap.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524) caused pexpect to run [a select call with timeout=None](https://github.com/pexpect/pexpect/blob/2be6c4d1aa2b9b522636342c2fd54b73c058060d/pexpect/pty_spawn.py#L500)). I would also be happy to apply further patches to get extra debugging output.
+Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then unfortunately all I can provide is the Python stack trace from a real-world hang, obtained with `python-gdb.py`:
+
+```
+Traceback (most recent call first):
+  <built-in method select of module object at remote 0xfffff6d672e0>
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/utils.py", line 143, in select_ignore_interrupts
+    return select.select(iwtd, owtd, ewtd, timeout)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py", line 450, in select
+    return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py", line 500, in read_nonblocking
+    if (timeout != 0) and select(timeout):
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/expect.py", line 169, in expect_loop
+    incoming = spawn.read_nonblocking(spawn.maxread, timeout)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/spawnbase.py", line 372, in expect_list
+    return exp.expect_loop(timeout)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 524, in _execute_line
+    x = E.expect_list(self._compiled_full_pattern)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 658, in _eval_line
+    (normal, error) = self._execute_line(line, wait_for_prompt=wait_for_prompt,
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py", line 1387, in <listcomp>
+    return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py", line 1387, in eval
+    return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 498, in eval
+    result = Expect.eval(self, input_line, **kwds)
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py", line 1832, in <listcomp>
+    v = [eval(gap.eval("w["+str(i)+"]")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py", line 1832, in weight_distribution
+    v = [eval(gap.eval("w["+str(i)+"]")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form
+  <built-in method _instance_call of sage.misc.cachefunc.CachedMethodCaller object at remote 0xffff9085d640>
+  File "<doctest sage.coding.golay_code.GolayCode.weight_distribution[9]>", line 1, in <module>
+  <built-in method exec of module object at remote 0xfffff76f0590>
+  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py", line 1101, in compile_and_execute
+    exec(compiled, globs)
+```
+The real-world stack trace has the same characteristics from the one I obtained locally after applying the hacky patch. I would also be happy to apply further patches to get extra debugging output if it helps.
 
 This was reproduced both with ptyprocess 0.5.1 and 0.7.0, by the way.
``````




---

archive/issue_comments_553969.json:
```json
{
    "body": "<div id=\"comment:3\" align=\"right\">comment:3</div>\n\nDoes the output of the gap process give any insights? For example by using `sage.interfaces.gap.gap = Gap(logfile=\"LOG\")`",
    "created_at": "2022-08-07T03:18:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553969",
    "user": "https://github.com/mkoeppe"
}
```

<div id="comment:3" align="right">comment:3</div>

Does the output of the gap process give any insights? For example by using `sage.interfaces.gap.gap = Gap(logfile="LOG")`



---

archive/issue_comments_553970.json:
```json
{
    "body": "<div id=\"comment:4\" align=\"right\">comment:4</div>\n\nAn old version of the description had some invalid information. I've since edited it to fix the problems.",
    "created_at": "2022-08-07T15:54:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553970",
    "user": "https://github.com/collares"
}
```

<div id="comment:4" align="right">comment:4</div>

An old version of the description had some invalid information. I've since edited it to fix the problems.



---

archive/issue_comments_553971.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process, while a child process with a different pid was waiting for input). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).\n \n-Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.\n+Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/06c635a86e622323a63ea65bc681526055d112e0/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.\n \n Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then unfortunately all I can provide is the Python stack trace from a real-world hang, obtained with `python-gdb.py`:\n \n``````\n",
    "created_at": "2022-08-07T15:54:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553971",
    "user": "https://github.com/collares"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
 Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process, while a child process with a different pid was waiting for input). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).
 
-Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/8af8cb3eef1de2af881694de7a1575b5f3449b45/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.
+Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/06c635a86e622323a63ea65bc681526055d112e0/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.
 
 Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then unfortunately all I can provide is the Python stack trace from a real-world hang, obtained with `python-gdb.py`:
 
``````




---

archive/issue_events_468891.json:
```json
{
    "actor": "https://github.com/collares",
    "created_at": "2022-08-09T22:34:11Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "title_is": "GAP and Singular interfaces hang waiting for prompt on aarch64",
    "title_was": "GAP interface hangs waiting for prompt",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468891"
}
```



---

archive/issue_comments_553972.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,8 +1,6 @@\n-Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process, while a child process with a different pid was waiting for input). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).\n+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`.\n \n-Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/06c635a86e622323a63ea65bc681526055d112e0/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.\n-\n-Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then unfortunately all I can provide is the Python stack trace from a real-world hang, obtained with `python-gdb.py`:\n+I will describe a GAP failure, since I investigated that a bit more. From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:\n \n ```\n Traceback (most recent call first):\n@@ -37,6 +35,14 @@\n   File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1101, in compile_and_execute\n     exec(compiled, globs)\n ```\n-The real-world stack trace has the same characteristics from the one I obtained locally after applying the hacky patch. I would also be happy to apply further patches to get extra debugging output if it helps.\n+GAP, on the other hand, is happily executing `syFgets` and waiting for more input. Pexpect logs from good and bad runs don't seem to differ much, other than the missing `@i` at the end. I tried unsuccessfully to fix this. Here are some observations:\n \n-This was reproduced both with ptyprocess 0.5.1 and 0.7.0, by the way.\n+1) A comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) says that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, but adding the blocks seems to make no difference.\n+\n+2) It seems really unlikely, but maybe Singular and GAP both have a bug. I check and both program's seem to handle SIGTERM in a signal-unsafe way because they use stdio. Speaking of which, GAP's `echoandcheck` function, used for printing `@i`, never retries the `write` syscall regardless of whether `errno` is `EINTR` or `EAGAIN` (but, again, retrying the write this does not help).\n+\n+3) I don't know if Sage shares the pty fd between different threads, but Pexpect documentation warns that any interaction with the pty must be done from the thread it was spawned (https://pexpect.readthedocs.io/en/stable/commonissues.html#threads).\n+\n+What makes this super annoying is that everything works fine under `strace -ff`. Perhaps this is not surprising, since every sign points to a race condition and/or a signal handling problem somewhere, but it makes debugging almost impossible to me.\n+\n+As an aside: I am 99% sure I ran the testsuite on an aarch64 Oracle Cloud machine back in December/January and everything was working fine, but I tried reverting everything I could to old versions and the bug still shows up now (in August). In particular, I used an old version of Nixpkgs and Nix, which means that everything that runs as a non-superuser is exactly the same as it was back in December/January. I also tried an old kernel version, but I didn't try reverting systemd.\n``````\n",
    "created_at": "2022-08-09T22:34:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553972",
    "user": "https://github.com/collares"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,8 +1,6 @@
-Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. Almost all of the stuck test runners were waiting for `gap` (moreover, every time Python was waiting on a non-`gap` program, such as `Singular`, the `pid` property on the `SageSpawn` object didn't match any running process, while a child process with a different pid was waiting for input). Unfortunately, although I could reproduce this every time on an Oracle Cloud aarch64 machine, I was initially unable to reproduce the issue locally (but see below).
+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`.
 
-Reading the source code a bit, I found a comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) saying that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, so I decided, as an experiment, to add `with gc_disabled():` blocks around communication code in `interfaces/gap.py` in the most ham-fisted way I could ([here is the hacky patch I used](https://github.com/collares/nixpkgs/blob/06c635a86e622323a63ea65bc681526055d112e0/pkgs/applications/science/math/sage/patches/disable-gc-gap.patch)). To my surprise, this made every test that uses gap hang indefinitely at [this line](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/gap.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n524), even on my x86_64 computer.
-
-Hopefully the post-patch behavior is not a red herring and counts as a way to reproduce the problem. With the patch applied, running the full testsuite with 8 threads (on an 8-core machine) and waiting a few minutes is enough to reach a state where all doctest runners are waiting on `gap`. If the patch does turn out to be useless, then unfortunately all I can provide is the Python stack trace from a real-world hang, obtained with `python-gdb.py`:
+I will describe a GAP failure, since I investigated that a bit more. From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:
 
 ```
 Traceback (most recent call first):
@@ -37,6 +35,14 @@
   File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py", line 1101, in compile_and_execute
     exec(compiled, globs)
 ```
-The real-world stack trace has the same characteristics from the one I obtained locally after applying the hacky patch. I would also be happy to apply further patches to get extra debugging output if it helps.
+GAP, on the other hand, is happily executing `syFgets` and waiting for more input. Pexpect logs from good and bad runs don't seem to differ much, other than the missing `@i` at the end. I tried unsuccessfully to fix this. Here are some observations:
 
-This was reproduced both with ptyprocess 0.5.1 and 0.7.0, by the way.
+1) A comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/develop/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) says that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, but adding the blocks seems to make no difference.
+
+2) It seems really unlikely, but maybe Singular and GAP both have a bug. I check and both program's seem to handle SIGTERM in a signal-unsafe way because they use stdio. Speaking of which, GAP's `echoandcheck` function, used for printing `@i`, never retries the `write` syscall regardless of whether `errno` is `EINTR` or `EAGAIN` (but, again, retrying the write this does not help).
+
+3) I don't know if Sage shares the pty fd between different threads, but Pexpect documentation warns that any interaction with the pty must be done from the thread it was spawned (https://pexpect.readthedocs.io/en/stable/commonissues.html#threads).
+
+What makes this super annoying is that everything works fine under `strace -ff`. Perhaps this is not surprising, since every sign points to a race condition and/or a signal handling problem somewhere, but it makes debugging almost impossible to me.
+
+As an aside: I am 99% sure I ran the testsuite on an aarch64 Oracle Cloud machine back in December/January and everything was working fine, but I tried reverting everything I could to old versions and the bug still shows up now (in August). In particular, I used an old version of Nixpkgs and Nix, which means that everything that runs as a non-superuser is exactly the same as it was back in December/January. I also tried an old kernel version, but I didn't try reverting systemd.
``````




---

archive/issue_events_468892.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "demilestoned",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "milestone_number": null,
    "milestone_title": "sage-9.7",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468892"
}
```



---

archive/issue_events_468893.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468893"
}
```



---

archive/issue_comments_553973.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,6 +1,6 @@\n-Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`.\n+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`, but I think GAP is the culprit.\n \n-I will describe a GAP failure, since I investigated that a bit more. From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:\n+From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:\n \n ```\n Traceback (most recent call first):\n``````\n",
    "created_at": "2022-09-23T16:05:50Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553973",
    "user": "https://github.com/collares"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,6 +1,6 @@
-Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`.
+Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`, but I think GAP is the culprit.
 
-I will describe a GAP failure, since I investigated that a bit more. From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:
+From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent `@i`. Therefore, it blocks with the following stack trace:
 
 ```
 Traceback (most recent call first):
``````




---

archive/issue_events_468894.json:
```json
{
    "actor": "https://github.com/collares",
    "created_at": "2022-09-23T16:05:50Z",
    "event": "renamed",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "title_is": "GAP interface hangs waiting for prompt on aarch64",
    "title_was": "GAP and Singular interfaces hang waiting for prompt on aarch64",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34297#event-468894"
}
```



---

archive/issue_comments_553974.json:
```json
{
    "body": "<div id=\"comment:8\" align=\"right\">comment:8</div>\n\nAfter updating to GAP 4.12 and applying the patch in #34391, this no longer happens on Nix's aarch64 builders. For some weird reason, this still happens on an Oracle Cloud free tier box, but I don't know how to debug that (and, given that it might be some interaction with Oracle's cloud monitoring tools, I don't really care).",
    "created_at": "2022-09-23T16:09:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34297#issuecomment-553974",
    "user": "https://github.com/collares"
}
```

<div id="comment:8" align="right">comment:8</div>

After updating to GAP 4.12 and applying the patch in #34391, this no longer happens on Nix's aarch64 builders. For some weird reason, this still happens on an Oracle Cloud free tier box, but I don't know how to debug that (and, given that it might be some interaction with Oracle's cloud monitoring tools, I don't really care).
