# Issue 34297: GAP interface hangs waiting for prompt on aarch64

archive/issues_034060.json:
```json
{
    "body": "Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`, but I think GAP is the culprit.\n\nFrom Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent ``@`i`. Therefore, it blocks with the following stack trace:\n\n```\nTraceback (most recent call first):\n  <built-in method select of module object at remote 0xfffff6d672e0>\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/utils.py\", line 143, in select_ignore_interrupts\n    return select.select(iwtd, owtd, ewtd, timeout)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py\", line 450, in select\n    return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py\", line 500, in read_nonblocking\n    if (timeout != 0) and select(timeout):\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/expect.py\", line 169, in expect_loop\n    incoming = spawn.read_nonblocking(spawn.maxread, timeout)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/spawnbase.py\", line 372, in expect_list\n    return exp.expect_loop(timeout)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 524, in _execute_line\n    x = E.expect_list(self._compiled_full_pattern)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 658, in _eval_line\n    (normal, error) = self._execute_line(line, wait_for_prompt=wait_for_prompt,\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py\", line 1387, in <listcomp>\n    return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py\", line 1387, in eval\n    return '\\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py\", line 498, in eval\n    result = Expect.eval(self, input_line, **kwds)\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py\", line 1832, in <listcomp>\n    v = [eval(gap.eval(\"w[\"+str(i)+\"]\")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py\", line 1832, in weight_distribution\n    v = [eval(gap.eval(\"w[\"+str(i)+\"]\")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form\n  <built-in method _instance_call of sage.misc.cachefunc.CachedMethodCaller object at remote 0xffff9085d640>\n  File \"<doctest sage.coding.golay_code.GolayCode.weight_distribution[9]>\", line 1, in <module>\n  <built-in method exec of module object at remote 0xfffff76f0590>\n  File \"/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py\", line 1101, in compile_and_execute\n    exec(compiled, globs)\n```\nGAP, on the other hand, is happily executing `syFgets` and waiting for more input. Pexpect logs from good and bad runs don't seem to differ much, other than the missing ``@`i` at the end. I tried unsuccessfully to fix this. Here are some observations:\n\n1) A comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) says that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, but adding the blocks seems to make no difference.\n\n2) It seems really unlikely, but maybe Singular and GAP both have a bug. I check and both program's seem to handle SIGTERM in a signal-unsafe way because they use stdio. Speaking of which, GAP's `echoandcheck` function, used for printing ``@`i`, never retries the `write` syscall regardless of whether `errno` is `EINTR` or `EAGAIN` (but, again, retrying the write this does not help).\n\n3) I don't know if Sage shares the pty fd between different threads, but Pexpect documentation warns that any interaction with the pty must be done from the thread it was spawned (https://pexpect.readthedocs.io/en/stable/commonissues.html#threads).\n\nWhat makes this super annoying is that everything works fine under `strace -ff`. Perhaps this is not surprising, since every sign points to a race condition and/or a signal handling problem somewhere, but it makes debugging almost impossible to me.\n\nAs an aside: I am 99% sure I ran the testsuite on an aarch64 Oracle Cloud machine back in December/January and everything was working fine, but I tried reverting everything I could to old versions and the bug still shows up now (in August). In particular, I used an old version of Nixpkgs and Nix, which means that everything that runs as a non-superuser is exactly the same as it was back in December/January. I also tried an old kernel version, but I didn't try reverting systemd.\n\nStatus: new\n\nIssue created by migration from https://trac.sagemath.org/ticket/34297\n\n",
    "created_at": "2022-08-07T02:03:16Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "GAP interface hangs waiting for prompt on aarch64",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34297",
    "user": "https://github.com/collares"
}
```
Recently, the Sage 9.6 testsuite started timing out on the NixOS aarch64 builder for no discernible reason. I was able to reproduce this on an Oracle Cloud aarch64 machine. Investigation revealed that many tests were stuck on a `select()` syscall waiting for an external program's prompt. All of the stuck test runners were waiting for `gap` or `Singular`, but I think GAP is the culprit.

From Sage's point of view (obtained by setting `SAGE_PEXPECT_LOG` to `yes`), the last characters GAP sent were `gap> `, with no subsequent ``@`i`. Therefore, it blocks with the following stack trace:

```
Traceback (most recent call first):
  <built-in method select of module object at remote 0xfffff6d672e0>
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/utils.py", line 143, in select_ignore_interrupts
    return select.select(iwtd, owtd, ewtd, timeout)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py", line 450, in select
    return select_ignore_interrupts([self.child_fd], [], [], timeout)[0]
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/pty_spawn.py", line 500, in read_nonblocking
    if (timeout != 0) and select(timeout):
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/expect.py", line 169, in expect_loop
    incoming = spawn.read_nonblocking(spawn.maxread, timeout)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/pexpect/spawnbase.py", line 372, in expect_list
    return exp.expect_loop(timeout)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 524, in _execute_line
    x = E.expect_list(self._compiled_full_pattern)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 658, in _eval_line
    (normal, error) = self._execute_line(line, wait_for_prompt=wait_for_prompt,
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py", line 1387, in <listcomp>
    return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/expect.py", line 1387, in eval
    return '\n'.join([self._eval_line(L, allow_use_file=allow_use_file, **kwds)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/interfaces/gap.py", line 498, in eval
    result = Expect.eval(self, input_line, **kwds)
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py", line 1832, in <listcomp>
    v = [eval(gap.eval("w["+str(i)+"]")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/coding/linear_code.py", line 1832, in weight_distribution
    v = [eval(gap.eval("w["+str(i)+"]")) for i in range(1,self.length()+2)] # because GAP returns vectors in compressed form
  <built-in method _instance_call of sage.misc.cachefunc.CachedMethodCaller object at remote 0xffff9085d640>
  File "<doctest sage.coding.golay_code.GolayCode.weight_distribution[9]>", line 1, in <module>
  <built-in method exec of module object at remote 0xfffff76f0590>
  File "/nix/store/3yyxzz1qx231x2f1dzxmk8lqfanapzl5-python3-3.10.5-env/lib/python3.10/site-packages/sage/doctest/forker.py", line 1101, in compile_and_execute
    exec(compiled, globs)
```
GAP, on the other hand, is happily executing `syFgets` and waiting for more input. Pexpect logs from good and bad runs don't seem to differ much, other than the missing ``@`i` at the end. I tried unsuccessfully to fix this. Here are some observations:

1) A comment on [src/sage/interfaces/expect.py](https://github.com/sagemath/sagetrac-mirror/blob/master/src/sage/interfaces/expect.py?h=9.6&id=bf6aeb906d0b7cfb12b5dab90f4f096a6192ff43#n71) says that code that sends data and waits for a result should temporarily disable the garbage collector by using a `with gc_disabled():` block. The `gap` interface didn't seem to be doing this, but adding the blocks seems to make no difference.

2) It seems really unlikely, but maybe Singular and GAP both have a bug. I check and both program's seem to handle SIGTERM in a signal-unsafe way because they use stdio. Speaking of which, GAP's `echoandcheck` function, used for printing ``@`i`, never retries the `write` syscall regardless of whether `errno` is `EINTR` or `EAGAIN` (but, again, retrying the write this does not help).

3) I don't know if Sage shares the pty fd between different threads, but Pexpect documentation warns that any interaction with the pty must be done from the thread it was spawned (https://pexpect.readthedocs.io/en/stable/commonissues.html#threads).

What makes this super annoying is that everything works fine under `strace -ff`. Perhaps this is not surprising, since every sign points to a race condition and/or a signal handling problem somewhere, but it makes debugging almost impossible to me.

As an aside: I am 99% sure I ran the testsuite on an aarch64 Oracle Cloud machine back in December/January and everything was working fine, but I tried reverting everything I could to old versions and the bug still shows up now (in August). In particular, I used an old version of Nixpkgs and Nix, which means that everything that runs as a non-superuser is exactly the same as it was back in December/January. I also tried an old kernel version, but I didn't try reverting systemd.

Status: new

Issue created by migration from https://trac.sagemath.org/ticket/34297





---

archive/issue_comments_482757.json:
```json
{
    "body": "<a id='comment:3'></a>Does the output of the gap process give any insights? For example by using `sage.interfaces.gap.gap = Gap(logfile=\"LOG\")`",
    "created_at": "2022-08-07T03:18:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34297#issuecomment-482757",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:3'></a>Does the output of the gap process give any insights? For example by using `sage.interfaces.gap.gap = Gap(logfile="LOG")`



---

archive/issue_comments_482758.json:
```json
{
    "body": "<a id='comment:4'></a>An old version of the description had some invalid information. I've since edited it to fix the problems.",
    "created_at": "2022-08-07T15:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34297#issuecomment-482758",
    "user": "https://github.com/collares"
}
```

<a id='comment:4'></a>An old version of the description had some invalid information. I've since edited it to fix the problems.



---

archive/issue_events_089347.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/34297",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34297#event-89347"
}
```



---

archive/issue_comments_482759.json:
```json
{
    "body": "<a id='comment:8'></a>After updating to GAP 4.12 and applying the patch in #34391, this no longer happens on Nix's aarch64 builders. For some weird reason, this still happens on an Oracle Cloud free tier box, but I don't know how to debug that (and, given that it might be some interaction with Oracle's cloud monitoring tools, I don't really care).",
    "created_at": "2022-09-23T16:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34297",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34297#issuecomment-482759",
    "user": "https://github.com/collares"
}
```

<a id='comment:8'></a>After updating to GAP 4.12 and applying the patch in #34391, this no longer happens on Nix's aarch64 builders. For some weird reason, this still happens on an Oracle Cloud free tier box, but I don't know how to debug that (and, given that it might be some interaction with Oracle's cloud monitoring tools, I don't really care).
