# Issue 34636: make sparsity a decision of the user

archive/issues_034399.json:
```json
{
    "assignees": [],
    "body": "The decision whether a Stream_XXX class uses a dense or a sparse cache should not depend on the input streams.\n\nFor example, for `Stream_add` it is actually irrelevant whether the input streams left and right are dense or sparse.\n\nFor `Stream_zero` and `Stream_exact`, a separate cache never makes sense.\n\nThis also makes the need to implement a conversion between sparse and dense less important.\n\nDepends on #34552\n\nDepends on #34653\n\n**CC:**  @tscrim @fchapoton\n\n**Keywords:** LazyPowerSeries\n\n**Branch/Commit:** [de424bd78aab5b7e151316644ad460b39261734f](https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f)\n\n**Reviewer:** Travis Scrimshaw\n\n**Author:** Martin Rubey\n\nIssue created by migration from https://trac.sagemath.org/ticket/34636\n\n",
    "closed_at": "2022-11-07T20:26:18Z",
    "created_at": "2022-10-07T16:24:34Z",
    "labels": [
        "https://github.com/sagemath/sage/labels/component%3A%20combinatorics",
        "https://github.com/sagemath/sage/labels/enhancement"
    ],
    "milestone": "https://github.com/sagemath/sage/milestones/sage-9.8",
    "reactions": [],
    "repository": "https://github.com/sagemath/sage",
    "title": "make sparsity a decision of the user",
    "type": "issue",
    "updated_at": "2022-11-07T20:26:18Z",
    "url": "https://github.com/sagemath/sage/issues/34636",
    "user": "https://github.com/mantepse"
}
```
The decision whether a Stream_XXX class uses a dense or a sparse cache should not depend on the input streams.

For example, for `Stream_add` it is actually irrelevant whether the input streams left and right are dense or sparse.

For `Stream_zero` and `Stream_exact`, a separate cache never makes sense.

This also makes the need to implement a conversion between sparse and dense less important.

Depends on #34552

Depends on #34653

**CC:**  @tscrim @fchapoton

**Keywords:** LazyPowerSeries

**Branch/Commit:** [de424bd78aab5b7e151316644ad460b39261734f](https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f)

**Reviewer:** Travis Scrimshaw

**Author:** Martin Rubey

Issue created by migration from https://trac.sagemath.org/ticket/34636





---

archive/issue_events_416301.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2022-10-07T16:24:34Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "milestone_number": null,
    "milestone_title": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416301"
}
```



---

archive/issue_comments_561738.json:
```json
{
    "body": "**Branch:** [u/mantepse/make_sparsity_a_decision_of_the_user](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_sparsity_a_decision_of_the_user)",
    "created_at": "2022-10-07T16:26:49Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561738",
    "user": "https://github.com/mantepse"
}
```

**Branch:** [u/mantepse/make_sparsity_a_decision_of_the_user](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_sparsity_a_decision_of_the_user)



---

archive/issue_events_416302.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2022-10-07T16:35:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "label": "https://github.com/sagemath/sage/labels/component%3A%20combinatorics",
    "label_color": "08517b",
    "label_name": "component: combinatorics",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416302"
}
```



---

archive/issue_comments_561739.json:
```json
{
    "body": "**Changing keywords** from \"\" to \"LazyPowerSeries\".",
    "created_at": "2022-10-07T16:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561739",
    "user": "https://github.com/mantepse"
}
```

**Changing keywords** from "" to "LazyPowerSeries".



---

archive/issue_comments_561740.json:
```json
{
    "body": "**Author:** Martin Rubey",
    "created_at": "2022-10-07T16:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561740",
    "user": "https://github.com/mantepse"
}
```

**Author:** Martin Rubey



---

archive/issue_comments_561741.json:
```json
{
    "body": "**Description changed:**\n``````diff\n--- \n+++ \n@@ -1 +1,7 @@\n+The decision whether a Stream_XXX class uses a dense or a sparse cache should not depend on the input streams.\n \n+For example, for `Stream_add` it is actually irrelevant whether the input streams left and right are dense or sparse.\n+\n+For `Stream_zero` and `Stream_exact`, a separate cache never makes sense.\n+\n+This also makes the need to implement a conversion between sparse and dense less important.\n``````\n",
    "created_at": "2022-10-07T16:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561741",
    "user": "https://github.com/mantepse"
}
```

**Description changed:**
``````diff
--- 
+++ 
@@ -1 +1,7 @@
+The decision whether a Stream_XXX class uses a dense or a sparse cache should not depend on the input streams.
 
+For example, for `Stream_add` it is actually irrelevant whether the input streams left and right are dense or sparse.
+
+For `Stream_zero` and `Stream_exact`, a separate cache never makes sense.
+
+This also makes the need to implement a conversion between sparse and dense less important.
``````




---

archive/issue_events_416303.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2022-10-07T16:35:47Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "label": "https://github.com/sagemath/sage/labels/enhancement",
    "label_color": "008080",
    "label_name": "enhancement",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416303"
}
```



---

archive/issue_comments_561742.json:
```json
{
    "body": "**Commit:** [bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782](https://github.com/sagemath/sagetrac-mirror/commit/bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782)",
    "created_at": "2022-10-07T16:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561742",
    "user": "https://github.com/mantepse"
}
```

**Commit:** [bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782](https://github.com/sagemath/sagetrac-mirror/commit/bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782)



---

archive/issue_comments_561743.json:
```json
{
    "body": "<a id='comment:2'></a>\n**Last 10 new commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/41ca99b7bfee0c11c4ece0bffa0b9230a7b4f67b\">41ca99b</a></td><td><code>Merge branch 'u/mantepse/replace_lazy_power_series-32367' of trac.sagemath.org:sage into t/34470/categories_lazy_series-34470</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/fb3a5cdb6745cb78983f6bf5fc88bef93f21040a\">fb3a5cd</a></td><td><code>Merge branch 'u/mantepse/categories_lazy_series-34470' of trac.sagemath.org:sage into t/34552/lazy_series_test_suite-34552</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/855d2bf04aaebfc1696e34664b48521bffd6a79f\">855d2bf</a></td><td><code>remove unused variable</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/75c275cf989059c02bf5bd11ad7ed0ba76b3ca5f\">75c275c</a></td><td><code>add documentation and doctests for _approximate_order</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/539324204ae876de4292c469eed336d8b6ee0f4a\">5393242</a></td><td><code>fixes for pycodestyle and pyflakes</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/67dff95676c5e40b6311785db4db3e53347b11c5\">67dff95</a></td><td><code>Merge branch 'develop' of trac.sagemath.org:sage into t/32367/replace_lazy_power_series-32367</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/4fc981b458f8d628684decf221618911ace06333\">4fc981b</a></td><td><code>fix for pyflakes and blocks</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/56cef070ebee69841f1ead61344557d10d0b56a0\">56cef07</a></td><td><code>Merge branch 'u/mantepse/replace_lazy_power_series-32367' of trac.sagemath.org:sage into t/34470/categories_lazy_series-34470</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/3e84c90c8c9c3d74c8dd2b6b328029d74144b7bc\">3e84c90</a></td><td><code>Merge branch 'u/mantepse/categories_lazy_series-34470' of trac.sagemath.org:sage into t/34552/lazy_series_test_suite-34552</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782\">bd3e3eb</a></td><td><code>make sparsity a decision of the user</code></td></tr></table>\n",
    "created_at": "2022-10-07T16:35:47Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561743",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:2'></a>
**Last 10 new commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/41ca99b7bfee0c11c4ece0bffa0b9230a7b4f67b">41ca99b</a></td><td><code>Merge branch 'u/mantepse/replace_lazy_power_series-32367' of trac.sagemath.org:sage into t/34470/categories_lazy_series-34470</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/fb3a5cdb6745cb78983f6bf5fc88bef93f21040a">fb3a5cd</a></td><td><code>Merge branch 'u/mantepse/categories_lazy_series-34470' of trac.sagemath.org:sage into t/34552/lazy_series_test_suite-34552</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/855d2bf04aaebfc1696e34664b48521bffd6a79f">855d2bf</a></td><td><code>remove unused variable</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/75c275cf989059c02bf5bd11ad7ed0ba76b3ca5f">75c275c</a></td><td><code>add documentation and doctests for _approximate_order</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/539324204ae876de4292c469eed336d8b6ee0f4a">5393242</a></td><td><code>fixes for pycodestyle and pyflakes</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/67dff95676c5e40b6311785db4db3e53347b11c5">67dff95</a></td><td><code>Merge branch 'develop' of trac.sagemath.org:sage into t/32367/replace_lazy_power_series-32367</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/4fc981b458f8d628684decf221618911ace06333">4fc981b</a></td><td><code>fix for pyflakes and blocks</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/56cef070ebee69841f1ead61344557d10d0b56a0">56cef07</a></td><td><code>Merge branch 'u/mantepse/replace_lazy_power_series-32367' of trac.sagemath.org:sage into t/34470/categories_lazy_series-34470</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/3e84c90c8c9c3d74c8dd2b6b328029d74144b7bc">3e84c90</a></td><td><code>Merge branch 'u/mantepse/categories_lazy_series-34470' of trac.sagemath.org:sage into t/34552/lazy_series_test_suite-34552</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782">bd3e3eb</a></td><td><code>make sparsity a decision of the user</code></td></tr></table>




---

archive/issue_comments_561744.json:
```json
{
    "body": "**Dependencies:** #34552",
    "created_at": "2022-10-09T17:54:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561744",
    "user": "https://github.com/mantepse"
}
```

**Dependencies:** #34552



---

archive/issue_comments_561745.json:
```json
{
    "body": "<a id='comment:4'></a>\nA sparse representation does not make sense also for `Cauchy_invert`: `get_coefficient` accesses all previously computed values.",
    "created_at": "2022-10-11T08:54:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561745",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:4'></a>
A sparse representation does not make sense also for `Cauchy_invert`: `get_coefficient` accesses all previously computed values.



---

archive/issue_comments_561746.json:
```json
{
    "body": "**Changing commit** from \"[bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782](https://github.com/sagemath/sagetrac-mirror/commit/bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782)\" to \"[814aa7cd53e8ca569ddfd87ba1cfa498c564531d](https://github.com/sagemath/sagetrac-mirror/commit/814aa7cd53e8ca569ddfd87ba1cfa498c564531d)\".",
    "created_at": "2022-10-11T10:11:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561746",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782](https://github.com/sagemath/sagetrac-mirror/commit/bd3e3ebf0d7b707b9b03ab42ee7e7c71a28df782)" to "[814aa7cd53e8ca569ddfd87ba1cfa498c564531d](https://github.com/sagemath/sagetrac-mirror/commit/814aa7cd53e8ca569ddfd87ba1cfa498c564531d)".



---

archive/issue_comments_561747.json:
```json
{
    "body": "<a id='comment:5'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/814aa7cd53e8ca569ddfd87ba1cfa498c564531d\">814aa7c</a></td><td><code>remove Stream_cauchy_invert.get_coefficient, make sparse a mandatory argument, move _is_sparse an attribute of Stream_inexact</code></td></tr></table>\n",
    "created_at": "2022-10-11T10:11:37Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561747",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:5'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/814aa7cd53e8ca569ddfd87ba1cfa498c564531d">814aa7c</a></td><td><code>remove Stream_cauchy_invert.get_coefficient, make sparse a mandatory argument, move _is_sparse an attribute of Stream_inexact</code></td></tr></table>




---

archive/issue_comments_561748.json:
```json
{
    "body": "<a id='comment:6'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/7043d1cf5d937c3f947634c088e8bdc2c13e4d9f\">7043d1c</a></td><td><code>remove redundant `__init__` methods, remove finished TODOs</code></td></tr></table>\n",
    "created_at": "2022-10-11T13:57:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561748",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:6'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/7043d1cf5d937c3f947634c088e8bdc2c13e4d9f">7043d1c</a></td><td><code>remove redundant `__init__` methods, remove finished TODOs</code></td></tr></table>




---

archive/issue_comments_561749.json:
```json
{
    "body": "**Changing commit** from \"[814aa7cd53e8ca569ddfd87ba1cfa498c564531d](https://github.com/sagemath/sagetrac-mirror/commit/814aa7cd53e8ca569ddfd87ba1cfa498c564531d)\" to \"[7043d1cf5d937c3f947634c088e8bdc2c13e4d9f](https://github.com/sagemath/sagetrac-mirror/commit/7043d1cf5d937c3f947634c088e8bdc2c13e4d9f)\".",
    "created_at": "2022-10-11T13:57:09Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561749",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[814aa7cd53e8ca569ddfd87ba1cfa498c564531d](https://github.com/sagemath/sagetrac-mirror/commit/814aa7cd53e8ca569ddfd87ba1cfa498c564531d)" to "[7043d1cf5d937c3f947634c088e8bdc2c13e4d9f](https://github.com/sagemath/sagetrac-mirror/commit/7043d1cf5d937c3f947634c088e8bdc2c13e4d9f)".



---

archive/issue_events_416304.json:
```json
{
    "actor": "https://github.com/mantepse",
    "created_at": "2022-10-11T13:59:35Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416304"
}
```



---

archive/issue_comments_561750.json:
```json
{
    "body": "<a id='comment:8'></a>\nFrom #34611: it may make sense to make `Stream_uninitialized` always dense, and doctest that the following then works:\n\n```\nsage: L.<z> = LazyPowerSeriesRing(ZZ); C = L.undefined(); C.define(1 + z*C^2)\nsage: C[500]\n```\n\nAnother question: it may make sense to make `Stream_XXX` always sparse, if the computation of `s[n]` *obviously* does not benefit from the values of `s[n-1], s[n-2], ...`.  This is the case, for example, with `Stream_add`.\n\nThe benefit of a dense representation of `Stream_add` may be in storage and access: if we have a sparse representation and have to compute most values, the list representation uses (much) less memory, and access will be faster. For example, storing the first 600 values of a stream of integers as a list uses no more memory than storing 200 values in a dict.  Lookup in a list of about 1000 elements seems to take about 60%-70% of the time lookup in a dictionary takes.\n\nIn cases when we apply a very simple function to each coefficient, as in `Stream_neg`, we may not want to create a separate cache at all.  For `Stream_map_coefficients`, we currently only apply very costly functions.",
    "created_at": "2022-10-12T06:51:23Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561750",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:8'></a>
From #34611: it may make sense to make `Stream_uninitialized` always dense, and doctest that the following then works:

```
sage: L.<z> = LazyPowerSeriesRing(ZZ); C = L.undefined(); C.define(1 + z*C^2)
sage: C[500]
```

Another question: it may make sense to make `Stream_XXX` always sparse, if the computation of `s[n]` *obviously* does not benefit from the values of `s[n-1], s[n-2], ...`.  This is the case, for example, with `Stream_add`.

The benefit of a dense representation of `Stream_add` may be in storage and access: if we have a sparse representation and have to compute most values, the list representation uses (much) less memory, and access will be faster. For example, storing the first 600 values of a stream of integers as a list uses no more memory than storing 200 values in a dict.  Lookup in a list of about 1000 elements seems to take about 60%-70% of the time lookup in a dictionary takes.

In cases when we apply a very simple function to each coefficient, as in `Stream_neg`, we may not want to create a separate cache at all.  For `Stream_map_coefficients`, we currently only apply very costly functions.



---

archive/issue_comments_561751.json:
```json
{
    "body": "<a id='comment:9'></a>\nI am wondering how much we even want the sparsity in the streams. We want it for the exact series in some cases (sparse versus dense for the (Laurent) polynomial ring), but it seems more like extra weight we are carrying around for the streams, which should instead simply be as dense or sparse as is most effective for them. Or maybe just for multiplication, which might be the only one that could matter? Do you remember if in any place we take advantage of the dense or sparse implementation currently?",
    "created_at": "2022-10-12T08:53:13Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561751",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:9'></a>
I am wondering how much we even want the sparsity in the streams. We want it for the exact series in some cases (sparse versus dense for the (Laurent) polynomial ring), but it seems more like extra weight we are carrying around for the streams, which should instead simply be as dense or sparse as is most effective for them. Or maybe just for multiplication, which might be the only one that could matter? Do you remember if in any place we take advantage of the dense or sparse implementation currently?



---

archive/issue_comments_561752.json:
```json
{
    "body": "<a id='comment:10'></a>\nI don't think we can decide for the user.  For multiplication it makes a big difference, whether you are only interested in `(f*g)[10000]` or in `(f*g)[:10000]`.  The former may be relevant, if you want to compute a few random coefficients, e.g., to quickly see how much they grow.  But I admit that I do not know any serious application.\n\nExact series are neither sparse nor dense in the sense of `Stream`, they implement their own (mixed) cache: an index and a list for the initial coefficients, and an index and a constant for the rest.\n\nI am not completely sure whether I understand your question.  I think that `Stream_mul`, `Stream_cauchy_compose` and the like should have sparse and dense versions. `Stream_uninitialized` probably only a dense version, `Stream_add`, `Stream_sub`, etc. possibly only a sparse version.\n\nThe only two reasons for `Stream_add` etc. to have a dense version is, if the speedup in access and the memory overhead matter.  There is no additional code.  So I guess it is better to keep the option.  We currently only use subtraction, implicitly in `LazySymmetricFunction.revert`:\n\n```\n        g = P.undefined(valuation=1)\n        g.define(b_inv * (X - (self - b * X)(g)))\n```\nI am guessing (but I am not sure) that it makes sense to use either only the sparse versions or only the dense versions of the operations here.",
    "created_at": "2022-10-12T09:29:39Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561752",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:10'></a>
I don't think we can decide for the user.  For multiplication it makes a big difference, whether you are only interested in `(f*g)[10000]` or in `(f*g)[:10000]`.  The former may be relevant, if you want to compute a few random coefficients, e.g., to quickly see how much they grow.  But I admit that I do not know any serious application.

Exact series are neither sparse nor dense in the sense of `Stream`, they implement their own (mixed) cache: an index and a list for the initial coefficients, and an index and a constant for the rest.

I am not completely sure whether I understand your question.  I think that `Stream_mul`, `Stream_cauchy_compose` and the like should have sparse and dense versions. `Stream_uninitialized` probably only a dense version, `Stream_add`, `Stream_sub`, etc. possibly only a sparse version.

The only two reasons for `Stream_add` etc. to have a dense version is, if the speedup in access and the memory overhead matter.  There is no additional code.  So I guess it is better to keep the option.  We currently only use subtraction, implicitly in `LazySymmetricFunction.revert`:

```
        g = P.undefined(valuation=1)
        g.define(b_inv * (X - (self - b * X)(g)))
```
I am guessing (but I am not sure) that it makes sense to use either only the sparse versions or only the dense versions of the operations here.



---

archive/issue_comments_561753.json:
```json
{
    "body": "<a id='comment:11'></a>\nYou\u2019re right; for multiplication, we should have both a sparse and dense version.\n\nAh, right, we don\u2019t store the polynomials themselves in the `Stream_exact`, although there can be uses for passing the sparsity to that. I don\u2019t remember if we implement both types of exact storage. Perhaps we should, in case someone wants to create x<sup>10000</sup>.\n\nI am mostly wondering how much we should drop within the streams to carry around the `_sparse` parameter altogether. The multiplication will likely be split into 2 classes (with not being too lazy with the dense multiplication); the rest, except possibly the exact, are all naturally either dense (e.g., inverse) or sparse (e.g., addition).\n\nI will have to look at the code we currently have more closely I think to get a more clear picture. I don\u2019t remember some of the details regarding this. Perhaps you already have a clear picture about this though.",
    "created_at": "2022-10-12T14:04:59Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561753",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:11'></a>
You’re right; for multiplication, we should have both a sparse and dense version.

Ah, right, we don’t store the polynomials themselves in the `Stream_exact`, although there can be uses for passing the sparsity to that. I don’t remember if we implement both types of exact storage. Perhaps we should, in case someone wants to create x<sup>10000</sup>.

I am mostly wondering how much we should drop within the streams to carry around the `_sparse` parameter altogether. The multiplication will likely be split into 2 classes (with not being too lazy with the dense multiplication); the rest, except possibly the exact, are all naturally either dense (e.g., inverse) or sparse (e.g., addition).

I will have to look at the code we currently have more closely I think to get a more clear picture. I don’t remember some of the details regarding this. Perhaps you already have a clear picture about this though.



---

archive/issue_comments_561754.json:
```json
{
    "body": "<a id='comment:12'></a>\nCreating z<sup>10000</sup> is not a problem:\n\n```\nsage: L.<z> = LazyPowerSeriesRing(ZZ)\nsage: f = z^100000\nsage: f._coeff_stream.__dict__\n{'_constant': 0,\n '_degree': 100001,\n '_initial_coefficients': (1,),\n '_true_order': True,\n '_approximate_order': 100000}\n```\nhowever, z<sup>100000</sup>-1 is:\n\n```\nsage: f = z^10 - 1\nsage: f._coeff_stream.__dict__\n{'_constant': 0,\n '_degree': 11,\n '_initial_coefficients': (-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),\n '_true_order': True,\n '_approximate_order': 0}\n```\n\nCuriously, it takes a very long time to create, all of which is spent in the polynomial exponentiation - this is, because the underlying polynomial ring, for some reason is always dense:\n\n```python\nclass LazyLaurentSeriesRing(LazySeriesRing):\n    def __init__(self, base_ring, names, sparse=True, category=None):\n        self._sparse = sparse\n        # We always use the dense because our CS_exact is implemented densely\n        self._laurent_poly_ring = LaurentPolynomialRing(base_ring, names)\n        self._internal_poly_ring = self._laurent_poly_ring\n```\n\nThere are actually two easy improvements:\n\n* a sparse version, so we can create 1 + x<sup>100000000</sup>\n* I think that the polynomial ring should be dense or sparse depending on our input\n\nand, orthogonal to this,\n\n* a lazy version of `Stream_exact`, with coefficients provided by a function, might also help with the problem of computing large powers or large compositions of exact series.\n\nI can imagine that having only sparse addition is bad.  I can try to create an example if you want.\n\nWhat I'd be interested in is some help with van der Hoeven's algorithm in #34616.",
    "created_at": "2022-10-12T14:36:44Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561754",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:12'></a>
Creating z<sup>10000</sup> is not a problem:

```
sage: L.<z> = LazyPowerSeriesRing(ZZ)
sage: f = z^100000
sage: f._coeff_stream.__dict__
{'_constant': 0,
 '_degree': 100001,
 '_initial_coefficients': (1,),
 '_true_order': True,
 '_approximate_order': 100000}
```
however, z<sup>100000</sup>-1 is:

```
sage: f = z^10 - 1
sage: f._coeff_stream.__dict__
{'_constant': 0,
 '_degree': 11,
 '_initial_coefficients': (-1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1),
 '_true_order': True,
 '_approximate_order': 0}
```

Curiously, it takes a very long time to create, all of which is spent in the polynomial exponentiation - this is, because the underlying polynomial ring, for some reason is always dense:

```python
class LazyLaurentSeriesRing(LazySeriesRing):
    def __init__(self, base_ring, names, sparse=True, category=None):
        self._sparse = sparse
        # We always use the dense because our CS_exact is implemented densely
        self._laurent_poly_ring = LaurentPolynomialRing(base_ring, names)
        self._internal_poly_ring = self._laurent_poly_ring
```

There are actually two easy improvements:

* a sparse version, so we can create 1 + x<sup>100000000</sup>
* I think that the polynomial ring should be dense or sparse depending on our input

and, orthogonal to this,

* a lazy version of `Stream_exact`, with coefficients provided by a function, might also help with the problem of computing large powers or large compositions of exact series.

I can imagine that having only sparse addition is bad.  I can try to create an example if you want.

What I'd be interested in is some help with van der Hoeven's algorithm in #34616.



---

archive/issue_comments_561755.json:
```json
{
    "body": "<a id='comment:13'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/e6c4cae0902abbdef92b68badad66c8833021eb3\">e6c4cae</a></td><td><code>make Stream_uninitialized always dense to avoid maximal recursion error</code></td></tr></table>\n",
    "created_at": "2022-10-12T14:43:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561755",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:13'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/e6c4cae0902abbdef92b68badad66c8833021eb3">e6c4cae</a></td><td><code>make Stream_uninitialized always dense to avoid maximal recursion error</code></td></tr></table>




---

archive/issue_comments_561756.json:
```json
{
    "body": "**Changing commit** from \"[7043d1cf5d937c3f947634c088e8bdc2c13e4d9f](https://github.com/sagemath/sagetrac-mirror/commit/7043d1cf5d937c3f947634c088e8bdc2c13e4d9f)\" to \"[e6c4cae0902abbdef92b68badad66c8833021eb3](https://github.com/sagemath/sagetrac-mirror/commit/e6c4cae0902abbdef92b68badad66c8833021eb3)\".",
    "created_at": "2022-10-12T14:43:08Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561756",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[7043d1cf5d937c3f947634c088e8bdc2c13e4d9f](https://github.com/sagemath/sagetrac-mirror/commit/7043d1cf5d937c3f947634c088e8bdc2c13e4d9f)" to "[e6c4cae0902abbdef92b68badad66c8833021eb3](https://github.com/sagemath/sagetrac-mirror/commit/e6c4cae0902abbdef92b68badad66c8833021eb3)".



---

archive/issue_comments_561757.json:
```json
{
    "body": "**Changing commit** from \"[e6c4cae0902abbdef92b68badad66c8833021eb3](https://github.com/sagemath/sagetrac-mirror/commit/e6c4cae0902abbdef92b68badad66c8833021eb3)\" to \"[de424bd78aab5b7e151316644ad460b39261734f](https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f)\".",
    "created_at": "2022-10-13T06:50:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561757",
    "user": "https://github.com/sagetrac-git"
}
```

**Changing commit** from "[e6c4cae0902abbdef92b68badad66c8833021eb3](https://github.com/sagemath/sagetrac-mirror/commit/e6c4cae0902abbdef92b68badad66c8833021eb3)" to "[de424bd78aab5b7e151316644ad460b39261734f](https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f)".



---

archive/issue_comments_561758.json:
```json
{
    "body": "<a id='comment:14'></a>\n**Branch pushed to git repo; I updated commit sha1.** **New commits:**\n<table><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/957738684943d639805ed2c727da7e3ccdc6d5f1\">9577386</a></td><td><code>implement Polynomial_generic_sparse.__floordiv__</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/ec1eebddfd5f8f95e2b8a0efc26cc4179d86390b\">ec1eebd</a></td><td><code>Merge branch 'u/mantepse/__floordiv___for_sparse_polynomials' of trac.sagemath.org:sage into t/34636/make_sparsity_a_decision_of_the_user</code></td></tr><tr><td><a href=\"https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f\">de424bd</a></td><td><code>make internal rings sparse or dense if the lazy series ring is sparse or dense</code></td></tr></table>\n",
    "created_at": "2022-10-13T06:50:51Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561758",
    "user": "https://github.com/sagetrac-git"
}
```

<a id='comment:14'></a>
**Branch pushed to git repo; I updated commit sha1.** **New commits:**
<table><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/957738684943d639805ed2c727da7e3ccdc6d5f1">9577386</a></td><td><code>implement Polynomial_generic_sparse.__floordiv__</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/ec1eebddfd5f8f95e2b8a0efc26cc4179d86390b">ec1eebd</a></td><td><code>Merge branch 'u/mantepse/__floordiv___for_sparse_polynomials' of trac.sagemath.org:sage into t/34636/make_sparsity_a_decision_of_the_user</code></td></tr><tr><td><a href="https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f">de424bd</a></td><td><code>make internal rings sparse or dense if the lazy series ring is sparse or dense</code></td></tr></table>




---

archive/issue_comments_561759.json:
```json
{
    "body": "<a id='comment:15'></a>\nI made the internal polynomial rings sparse or dense according to the lazy series ring, although this really is of very little consequence.\n\nEssentially, creating z<sup>100000</sup> is now fast in the sparse case, and some computations for exact series (powers, compositions) are now carried out with sparse polynomials.  I did not check, however, whether this makes sense.  We actually do not use the polynomial rings so much, not even for multiplication.\n\nA completely sparse version of `Stream_exact` should be easy, I think - in the non-lazy setting we would simply have a dictionary of non-zero coefficients.",
    "created_at": "2022-10-13T07:04:02Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561759",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:15'></a>
I made the internal polynomial rings sparse or dense according to the lazy series ring, although this really is of very little consequence.

Essentially, creating z<sup>100000</sup> is now fast in the sparse case, and some computations for exact series (powers, compositions) are now carried out with sparse polynomials.  I did not check, however, whether this makes sense.  We actually do not use the polynomial rings so much, not even for multiplication.

A completely sparse version of `Stream_exact` should be easy, I think - in the non-lazy setting we would simply have a dictionary of non-zero coefficients.



---

archive/issue_comments_561760.json:
```json
{
    "body": "<a id='comment:16'></a>\nAlthough having a sparse version of `Stream_exact` should be easy, taking advantage of it may be much more work, because currently we always compute a *list* of initial coefficients in `lazy_ring.py`.\n\nI very much doubt that it is worth the effort right now.",
    "created_at": "2022-10-13T07:08:07Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561760",
    "user": "https://github.com/mantepse"
}
```

<a id='comment:16'></a>
Although having a sparse version of `Stream_exact` should be easy, taking advantage of it may be much more work, because currently we always compute a *list* of initial coefficients in `lazy_ring.py`.

I very much doubt that it is worth the effort right now.



---

archive/issue_comments_561761.json:
```json
{
    "body": "<a id='comment:17'></a>\nThe dense Laurent polynomials might be a bit better at creating z<sup>10000</sup> than the usual polynomials as they factor out the valuation portion.\n\nIt might not be so prudent to spend time implementing a sparse version of `Stream_exact` right now actually. There will be some additional changes needed throughout the code (this might indicate that we need to refactor so the stream can handle more things in its construction method). There are plenty of other things that we can do to improve the speed and efficiency that are likely to be more useful to people.",
    "created_at": "2022-10-14T01:38:11Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561761",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:17'></a>
The dense Laurent polynomials might be a bit better at creating z<sup>10000</sup> than the usual polynomials as they factor out the valuation portion.

It might not be so prudent to spend time implementing a sparse version of `Stream_exact` right now actually. There will be some additional changes needed throughout the code (this might indicate that we need to refactor so the stream can handle more things in its construction method). There are plenty of other things that we can do to improve the speed and efficiency that are likely to be more useful to people.



---

archive/issue_comments_561762.json:
```json
{
    "body": "**Changing dependencies** from \"#34552\" to \"#34552, #34653\".",
    "created_at": "2022-10-17T10:17:46Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561762",
    "user": "https://github.com/mantepse"
}
```

**Changing dependencies** from "#34552" to "#34552, #34653".



---

archive/issue_comments_561763.json:
```json
{
    "body": "<a id='comment:19'></a>\nLet us move along. This is definitely an improvement, and we can do further work on subsequent tickets.",
    "created_at": "2022-10-28T07:13:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561763",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>
Let us move along. This is definitely an improvement, and we can do further work on subsequent tickets.



---

archive/issue_events_416305.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2022-10-28T07:13:52Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "label": "https://github.com/sagemath/sage/labels/needs%20review",
    "label_color": "008080",
    "label_name": "needs review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416305"
}
```



---

archive/issue_events_416306.json:
```json
{
    "actor": "https://github.com/tscrim",
    "created_at": "2022-10-28T07:13:52Z",
    "event": "labeled",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416306"
}
```



---

archive/issue_comments_561764.json:
```json
{
    "body": "**Reviewer:** Travis Scrimshaw",
    "created_at": "2022-10-28T07:13:52Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561764",
    "user": "https://github.com/tscrim"
}
```

**Reviewer:** Travis Scrimshaw



---

archive/issue_events_416307.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-11-07T20:26:18Z",
    "event": "unlabeled",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "label": "https://github.com/sagemath/sage/labels/positive%20review",
    "label_color": "008080",
    "label_name": "positive review",
    "label_text_color": "ffffff",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416307"
}
```



---

archive/issue_events_416308.json:
```json
{
    "actor": "https://github.com/vbraun",
    "commit_id": "ab0944d9eaf489d3facc42d642fdec0434f8d805",
    "commit_repository": "https://github.com/sagemath/sage",
    "created_at": "2022-11-07T20:26:18Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sage/issues/34636#event-416308"
}
```



---

archive/issue_comments_561765.json:
```json
{
    "body": "**Changing branch** from \"[u/mantepse/make_sparsity_a_decision_of_the_user](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_sparsity_a_decision_of_the_user)\" to \"[de424bd78aab5b7e151316644ad460b39261734f](https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f)\".",
    "created_at": "2022-11-07T20:26:18Z",
    "formatter": "markdown",
    "issue": "https://github.com/sagemath/sage/issues/34636",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sage/issues/34636#issuecomment-561765",
    "user": "https://github.com/vbraun"
}
```

**Changing branch** from "[u/mantepse/make_sparsity_a_decision_of_the_user](https://github.com/sagemath/sagetrac-mirror/tree/u/mantepse/make_sparsity_a_decision_of_the_user)" to "[de424bd78aab5b7e151316644ad460b39261734f](https://github.com/sagemath/sagetrac-mirror/commit/de424bd78aab5b7e151316644ad460b39261734f)".
