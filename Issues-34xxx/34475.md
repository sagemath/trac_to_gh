# Issue 34475: Generalize SubspaceFunctor to CombinatorialFreeModule

archive/issues_034238.json:
```json
{
    "body": "It currently uses:\n\n```\n    def _apply_functor(self, ambient):\n        return ambient.span_of_basis(self.basis)\n```\nThe method `span_of_basis` is only defined for the free modules of `sage.modules`. We generalize it to `CombinatorialFreeModule` (and all `ModulesWithBasis`).\n\nFollow up: Handle the case of tensor modules of a `FiniteRankFreeModule`: only detect whether the given basis is one of the submodules with prescribed symmetries from #30229; in all other cases, we raise `NotImplementedError`.\n\n\nCC:  @tscrim @egourgoulhon simonking\n\nAuthor: Matthias Koeppe\n\nBranch: u/mkoeppe/generalize_subspacefunctor_to_combinatorialfreemodule_and_finiterankfreemodule\n\nCommit: 1ed6b44d3f227c5e8dea7c05ee3dbed3e23ee0de\n\nIssue created by migration from https://trac.sagemath.org/ticket/34475\n\n",
    "created_at": "2022-09-01T17:26:27Z",
    "labels": [
        "component: linear algebra"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Generalize SubspaceFunctor to CombinatorialFreeModule",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34475",
    "user": "https://github.com/mkoeppe"
}
```
It currently uses:

```
    def _apply_functor(self, ambient):
        return ambient.span_of_basis(self.basis)
```
The method `span_of_basis` is only defined for the free modules of `sage.modules`. We generalize it to `CombinatorialFreeModule` (and all `ModulesWithBasis`).

Follow up: Handle the case of tensor modules of a `FiniteRankFreeModule`: only detect whether the given basis is one of the submodules with prescribed symmetries from #30229; in all other cases, we raise `NotImplementedError`.


CC:  @tscrim @egourgoulhon simonking

Author: Matthias Koeppe

Branch: u/mkoeppe/generalize_subspacefunctor_to_combinatorialfreemodule_and_finiterankfreemodule

Commit: 1ed6b44d3f227c5e8dea7c05ee3dbed3e23ee0de

Issue created by migration from https://trac.sagemath.org/ticket/34475





---

archive/issue_comments_485066.json:
```json
{
    "body": "<a id='comment:2'></a>This is complicated by the special treatment of dense integer free modules in `span_of_basis` (vaguely related: #29315)",
    "created_at": "2022-09-01T18:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485066",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>This is complicated by the special treatment of dense integer free modules in `span_of_basis` (vaguely related: #29315)



---

archive/issue_comments_485067.json:
```json
{
    "body": "<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-01T19:10:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485067",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485068.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-01T21:57:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485068",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485069.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-01T22:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485069",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_485070.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-02T02:33:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485070",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485071.json:
```json
{
    "body": "<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-02T02:34:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485071",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485072.json:
```json
{
    "body": "<a id='comment:12'></a>I am somewhat hesitant to have the construction be defined at the category level because it is such a universal method (mainly, construction as a what?; cf. gens()). For the tensor products, that carries functorial properties that subspaces do not do. Typically we add structure to submodules. In other words, it is common to have (mathematically) a specific algebra defined as a submodule of linear transformations (the classical Lie algebras are important examples). Of course, that is not how we have generally implemented them in Sage, but it wouldn\u2019t be wrong to, say, have the Lie algebra sl<sub>n</sub> of traceless `n x n` matrices be in the join category `LieAlgebras(R) & Modules(R).Subobjects()` (although this would lead to other conflicts with their relationship with their universal enveloping algebra and considering them as a Lie subalgebra of that (under the commutator bracket)). So the test suite would fail unless the user provides a `constructor` method.\n\nFor tensor/Cartesian products, they are almost always built from more fundamental objects as inputs that funnels into a few classes. In particular, one can easily identify what class should be used to make, e.g., tensor products. So I feel the trade off is in favor of doing it at the category level. This is in contrast to here, where we cannot have any such distinguished class.",
    "created_at": "2022-09-04T23:59:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485072",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:12'></a>I am somewhat hesitant to have the construction be defined at the category level because it is such a universal method (mainly, construction as a what?; cf. gens()). For the tensor products, that carries functorial properties that subspaces do not do. Typically we add structure to submodules. In other words, it is common to have (mathematically) a specific algebra defined as a submodule of linear transformations (the classical Lie algebras are important examples). Of course, that is not how we have generally implemented them in Sage, but it wouldnâ€™t be wrong to, say, have the Lie algebra sl<sub>n</sub> of traceless `n x n` matrices be in the join category `LieAlgebras(R) & Modules(R).Subobjects()` (although this would lead to other conflicts with their relationship with their universal enveloping algebra and considering them as a Lie subalgebra of that (under the commutator bracket)). So the test suite would fail unless the user provides a `constructor` method.

For tensor/Cartesian products, they are almost always built from more fundamental objects as inputs that funnels into a few classes. In particular, one can easily identify what class should be used to make, e.g., tensor products. So I feel the trade off is in favor of doing it at the category level. This is in contrast to here, where we cannot have any such distinguished class.



---

archive/issue_comments_485073.json:
```json
{
    "body": "<a id='comment:13'></a>Does this concern go away if I move this method to `sage.modules.with_basis.subquotient.SubmoduleWithBasis`?",
    "created_at": "2022-09-05T00:04:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485073",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:13'></a>Does this concern go away if I move this method to `sage.modules.with_basis.subquotient.SubmoduleWithBasis`?



---

archive/issue_comments_485074.json:
```json
{
    "body": "<a id='comment:14'></a>Yes, it does. If it is done there, then it is a specific class with a specific implementation. Things at the category level should (generally) be implementation agnostic.",
    "created_at": "2022-09-05T00:26:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485074",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:14'></a>Yes, it does. If it is done there, then it is a specific class with a specific implementation. Things at the category level should (generally) be implementation agnostic.



---

archive/issue_comments_485075.json:
```json
{
    "body": "<a id='comment:15'></a>... except that the category does invoke that class in its `submodule` method.",
    "created_at": "2022-09-05T00:30:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485075",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:15'></a>... except that the category does invoke that class in its `submodule` method.



---

archive/issue_comments_485076.json:
```json
{
    "body": "<a id='comment:16'></a>It is a generic implementation and it is the best attempt at doing something without making it an ``@`abstract_method(optional=True)`. The `SubmoduleWithBasis` should, in principle, work with anything in the category. Unfortunately I don\u2019t think we are quite at that reality yet.",
    "created_at": "2022-09-05T00:48:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485076",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>It is a generic implementation and it is the best attempt at doing something without making it an ``@`abstract_method(optional=True)`. The `SubmoduleWithBasis` should, in principle, work with anything in the category. Unfortunately I donâ€™t think we are quite at that reality yet.



---

archive/issue_comments_485077.json:
```json
{
    "body": "<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-05T01:03:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485077",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:17'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485078.json:
```json
{
    "body": "<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-09-05T01:28:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485078",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:18'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_485079.json:
```json
{
    "body": "<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-05T01:39:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485079",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:19'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485080.json:
```json
{
    "body": "<a id='comment:20'></a>Is there a way to shorten \"Category of subobjects of modules with basis over Integer Ring\" to \"Category of submodules with basis over Integer Ring\"?",
    "created_at": "2022-09-05T01:42:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485080",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Is there a way to shorten "Category of subobjects of modules with basis over Integer Ring" to "Category of submodules with basis over Integer Ring"?



---

archive/issue_comments_485081.json:
```json
{
    "body": "<a id='comment:21'></a>There a few failures of `_test_construction` tests.\nAt least one of them is a case where the equality of a `UniqueRepresentation` is too strict:\n\n```\nsage: from sage.modules.with_basis.subquotient import SubmoduleWithBasis\nsage: X = CombinatorialFreeModule(QQ, range(3), prefix=\"x\"); x = X.basis()\nsage: ybas = (x[0]-x[1], x[1]-x[2])\nsage: Y = SubmoduleWithBasis(ybas, [0, 1, 2], X)\nsage: Y.print_options(prefix='y')\nsage: F, B = Y.construction()\nsage: Y2 = F(B)\nsage: Y2\nFree module generated by {0, 1} over Rational Field\nsage: Y\nFree module generated by {0, 1} over Rational Field\nsage: Y2.basis()\nFinite family {0: B[0], 1: B[1]}\nsage: Y.basis()\nFinite family {0: y[0], 1: y[1]}\nsage: Y == Y2\nFalse\nsage: Y.is_submodule(Y2)\nTrue\nsage: Y2.is_submodule(Y)\nTrue\n```",
    "created_at": "2022-09-05T01:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485081",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>There a few failures of `_test_construction` tests.
At least one of them is a case where the equality of a `UniqueRepresentation` is too strict:

```
sage: from sage.modules.with_basis.subquotient import SubmoduleWithBasis
sage: X = CombinatorialFreeModule(QQ, range(3), prefix="x"); x = X.basis()
sage: ybas = (x[0]-x[1], x[1]-x[2])
sage: Y = SubmoduleWithBasis(ybas, [0, 1, 2], X)
sage: Y.print_options(prefix='y')
sage: F, B = Y.construction()
sage: Y2 = F(B)
sage: Y2
Free module generated by {0, 1} over Rational Field
sage: Y
Free module generated by {0, 1} over Rational Field
sage: Y2.basis()
Finite family {0: B[0], 1: B[1]}
sage: Y.basis()
Finite family {0: y[0], 1: y[1]}
sage: Y == Y2
False
sage: Y.is_submodule(Y2)
True
sage: Y2.is_submodule(Y)
True
```



---

archive/issue_comments_485082.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-05T01:59:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485082",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_485083.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-05T03:15:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485083",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_485084.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:20 Matthias K\u00f6ppe]:\n> Is there a way to shorten \"Category of subobjects of modules with basis over Integer Ring\" to \"Category of submodules with basis over Integer Ring\"?\n\n\nNot generically, but you can override the name of the category. You could obviously write a `_repr_()`, but I forget offhand if there is some other way to just set the short name of the category (I believe there is though).",
    "created_at": "2022-09-05T13:51:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485084",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:24'></a>Replying to [comment:20 Matthias KÃ¶ppe]:
> Is there a way to shorten "Category of subobjects of modules with basis over Integer Ring" to "Category of submodules with basis over Integer Ring"?


Not generically, but you can override the name of the category. You could obviously write a `_repr_()`, but I forget offhand if there is some other way to just set the short name of the category (I believe there is though).



---

archive/issue_comments_485085.json:
```json
{
    "body": "<a id='comment:25'></a>Replying to [comment:21 Matthias K\u00f6ppe]:\n> There a few failures of `_test_construction` tests.\n> At least one of them is a case where the equality of a `UniqueRepresentation` is too strict:\n\n\nThis suggests to me that the functor construction is not preserving enough properties.\n\nFurthermore `==` does not have to mean mathematical equality either (what if we chose different indexing sets for the submodules?). Dealing with equal-but-not-identical parents can offer up another set of painful and subtle issues with equality and coercion. Plus we aren\u2019t able to utilize things cached with the submodule if we compute it a second time.\n\nThere are trade offs with any way we decide to implement them, but it is not fair to call it too strict.",
    "created_at": "2022-09-05T14:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485085",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:25'></a>Replying to [comment:21 Matthias KÃ¶ppe]:
> There a few failures of `_test_construction` tests.
> At least one of them is a case where the equality of a `UniqueRepresentation` is too strict:


This suggests to me that the functor construction is not preserving enough properties.

Furthermore `==` does not have to mean mathematical equality either (what if we chose different indexing sets for the submodules?). Dealing with equal-but-not-identical parents can offer up another set of painful and subtle issues with equality and coercion. Plus we arenâ€™t able to utilize things cached with the submodule if we compute it a second time.

There are trade offs with any way we decide to implement them, but it is not fair to call it too strict.



---

archive/issue_comments_485086.json:
```json
{
    "body": "<a id='comment:26'></a>Replying to [comment:25 Travis Scrimshaw]:\n> it is not fair to call it too strict.\n\n\nTo be clear, I'm not criticizing `UniqueRepresentation` for its moral stance ;)",
    "created_at": "2022-09-05T14:37:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485086",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Replying to [comment:25 Travis Scrimshaw]:
> it is not fair to call it too strict.


To be clear, I'm not criticizing `UniqueRepresentation` for its moral stance ;)



---

archive/issue_comments_485087.json:
```json
{
    "body": "<a id='comment:27'></a>Of course, but I am still wondering what would be a reasonable way to define `==`. Right now it is doing it the most conservative way, so things like the prefix and indexing set distinguish subspaces. However, unlike for a general module, the fact that it is a submodule means there is a canonical way to represent elements (as elements of the ambient space with its distinguished basis). I am still vary wary of effects of coercion (including coercions between the equal subspaces) with equal-but-not-identical, but that might take actually changing things to see what happens. It does make sense to downgrade the subspaces to a `CachedRepresentation`.\n\nActually, perhaps we can get a best of both worlds. We just need to extend the submodule class to somehow handle multiple indexing sets and just inform the users that the prefix is unique. In general, I expect this to a infrequently used feature, but it would be good to support the different indexing sets.",
    "created_at": "2022-09-06T02:48:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485087",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:27'></a>Of course, but I am still wondering what would be a reasonable way to define `==`. Right now it is doing it the most conservative way, so things like the prefix and indexing set distinguish subspaces. However, unlike for a general module, the fact that it is a submodule means there is a canonical way to represent elements (as elements of the ambient space with its distinguished basis). I am still vary wary of effects of coercion (including coercions between the equal subspaces) with equal-but-not-identical, but that might take actually changing things to see what happens. It does make sense to downgrade the subspaces to a `CachedRepresentation`.

Actually, perhaps we can get a best of both worlds. We just need to extend the submodule class to somehow handle multiple indexing sets and just inform the users that the prefix is unique. In general, I expect this to a infrequently used feature, but it would be good to support the different indexing sets.



---

archive/issue_comments_485088.json:
```json
{
    "body": "<a id='comment:28'></a>Either way, I still think the construction functor needs to better reconstruct the object too.",
    "created_at": "2022-09-06T02:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34475#issuecomment-485088",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:28'></a>Either way, I still think the construction functor needs to better reconstruct the object too.



---

archive/issue_events_089578.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2022-09-19T18:58:47Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/34475",
    "milestone": "sage-9.8",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34475#event-89578"
}
```
