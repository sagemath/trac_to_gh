# Issue 34509: Make IndexedFreeModuleElement compatible with collections.abc, change method support to return a SupportView

archive/issues_034272.json:
```json
{
    "body": "This is the element class of a `CombinatorialFreeModule`.\n\nIts implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, \n\n```\nsage: F = CombinatorialFreeModule(QQ, ['a','b','c'])\nsage: B = F.basis()\nsage: f = B['a'] + 3*B['c']; f\nsage: import collections.abc\nsage: isinstance(f, collections.abc.Collection)\nTrue\n```\nbut `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.\n\nTo improve interoperability, we propose to make the following changes: \n- Deprecate the `__contains__` method (currently testing whether a given index is in the support). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. \n- As a replacement for this functionality, revise the method `support` to return an instance of a new class `SupportView`, which provides a fast `__contains__` method, instead of a list.\n\n\n(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n\nPart of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n\nCC:  @fchapoton @tscrim @mwageringel @nthiery @anneschilling\n\nBranch/Commit: 2fe3b981c7ebf07dfe8992d5f591b3bb73841ede\n\nReviewer: Travis Scrimshaw\n\nAuthor: Matthias Koeppe\n\nDependencies: #34505\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34509\n\n",
    "closed_at": "2022-09-22T22:35:05Z",
    "created_at": "2022-09-08T20:01:38Z",
    "labels": [
        "component: linear algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Make IndexedFreeModuleElement compatible with collections.abc, change method support to return a SupportView",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34509",
    "user": "https://github.com/mkoeppe"
}
```
This is the element class of a `CombinatorialFreeModule`.

Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, 

```
sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
sage: B = F.basis()
sage: f = B['a'] + 3*B['c']; f
sage: import collections.abc
sage: isinstance(f, collections.abc.Collection)
True
```
but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.

To improve interoperability, we propose to make the following changes: 
- Deprecate the `__contains__` method (currently testing whether a given index is in the support). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. 
- As a replacement for this functionality, revise the method `support` to return an instance of a new class `SupportView`, which provides a fast `__contains__` method, instead of a list.


(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)

Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.

CC:  @fchapoton @tscrim @mwageringel @nthiery @anneschilling

Branch/Commit: 2fe3b981c7ebf07dfe8992d5f591b3bb73841ede

Reviewer: Travis Scrimshaw

Author: Matthias Koeppe

Dependencies: #34505

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34509





---

archive/issue_comments_519161.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,10 +1,13 @@\n+This is the element class of a `CombinatorialFreeModule`.\n+\n Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.\n \n To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):\n - Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)\n - Add methods `keys`, `items`, `values` with the semantics familiar from `dict`.\n \n-(In #24815, it was proposed to make it a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-08T20:03:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519161",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,10 +1,13 @@
+This is the element class of a `CombinatorialFreeModule`.
+
 Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.
 
 To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):
 - Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)
 - Add methods `keys`, `items`, `values` with the semantics familiar from `dict`.
 
-(In #24815, it was proposed to make it a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
 
 Comment: 1
 
```




---

archive/issue_comments_519162.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,12 @@\n+This is the element class of a `CombinatorialFreeModule`.\n+\n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.\n+\n+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):\n+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)\n+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If ``self`` is a submodule, they refer to the ambient module.\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n \n \n Comment: 1\n```\n",
    "created_at": "2022-09-08T20:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519162",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,12 @@
+This is the element class of a `CombinatorialFreeModule`.
+
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.
+
+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):
+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)
+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If ``self`` is a submodule, they refer to the ambient module.
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
 
 
 Comment: 1
```




---

archive/issue_comments_519163.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,3 +1,12 @@\n+This is the element class of a `CombinatorialFreeModule`.\n+\n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.\n+\n+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):\n+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)\n+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If `self` is a submodule, they refer to the ambient module (see #34455).\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n \n \n Comment: 1\n```\n",
    "created_at": "2022-09-08T20:56:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519163",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,3 +1,12 @@
+This is the element class of a `CombinatorialFreeModule`.
+
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.
+
+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):
+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)
+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If `self` is a submodule, they refer to the ambient module (see #34455).
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
 
 
 Comment: 1
```




---

archive/issue_comments_519164.json:
```json
{
    "body": "<a id='comment:5'></a>I am against this change. They are vectors and only on their backend are implemented as a `dict`, but they are not dictionaries, nor mappings. Likewise, I strongly oppose changing them to iterating over keys. This brings their implementation further from the other free module vectors. The reason we iterate over both is because there is no natural way to order the basis so the sequence of coefficients occurs in a particular order (which will unfortunately be a source of incompatibility). Hence, most of the time when iterating we want to use both the support index and the coefficient. Being vectors, they don\u2019t have `keys` and `values`, but `support` and `coefficients`. Nor do they have a reasonable notion of containment.\n\nContrast this to the \u201cusual\u201d free modules, where they have a natural compatibility with `sequence` as elements in R<sup>n</sup>, which are also how we think of finite sequences.",
    "created_at": "2022-09-08T23:39:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519164",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:5'></a>I am against this change. They are vectors and only on their backend are implemented as a `dict`, but they are not dictionaries, nor mappings. Likewise, I strongly oppose changing them to iterating over keys. This brings their implementation further from the other free module vectors. The reason we iterate over both is because there is no natural way to order the basis so the sequence of coefficients occurs in a particular order (which will unfortunately be a source of incompatibility). Hence, most of the time when iterating we want to use both the support index and the coefficient. Being vectors, they don’t have `keys` and `values`, but `support` and `coefficients`. Nor do they have a reasonable notion of containment.

Contrast this to the “usual” free modules, where they have a natural compatibility with `sequence` as elements in R<sup>n</sup>, which are also how we think of finite sequences.



---

archive/issue_comments_519165.json:
```json
{
    "body": "<a id='comment:6'></a>Replying to [comment:5 Travis Scrimshaw]:\n> Being vectors, they don\u2019t have `keys` and `values`, but `support` and `coefficients`. Nor do they have a reasonable notion of containment.\n\n\nIt does define `__contains__` currently; no change to that is proposed.\n\n```\n    def __contains__(self, x):\n        \"\"\"\n        Returns whether or not a combinatorial object x indexing a basis\n        element is in the support of self.\n    ...\n```",
    "created_at": "2022-09-08T23:48:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519165",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>Replying to [comment:5 Travis Scrimshaw]:
> Being vectors, they don’t have `keys` and `values`, but `support` and `coefficients`. Nor do they have a reasonable notion of containment.


It does define `__contains__` currently; no change to that is proposed.

```
    def __contains__(self, x):
        """
        Returns whether or not a combinatorial object x indexing a basis
        element is in the support of self.
    ...
```



---

archive/issue_comments_519166.json:
```json
{
    "body": "<a id='comment:7'></a>Replying to [comment:5 Travis Scrimshaw]:\n> I strongly oppose changing them to iterating over keys. This brings their implementation further from the other free module vectors.\n\n\nThis makes no sense.",
    "created_at": "2022-09-08T23:50:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519166",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:7'></a>Replying to [comment:5 Travis Scrimshaw]:
> I strongly oppose changing them to iterating over keys. This brings their implementation further from the other free module vectors.


This makes no sense.



---

archive/issue_comments_519167.json:
```json
{
    "body": "<a id='comment:8'></a>Replying to [comment:5 Travis Scrimshaw]:\n> most of the time when iterating we want to use both the support index and the coefficient.\n\n\nYes, and there are two interpretations of this when the parent is a submodule.\n\n- one is `monomial_coefficients`, which refers to the basis of the submodule\n- one is the proposed new `items`, which will refer to the ambient. (This will be compatible with sparse vectors in `sage.modules`.)",
    "created_at": "2022-09-08T23:55:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519167",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:8'></a>Replying to [comment:5 Travis Scrimshaw]:
> most of the time when iterating we want to use both the support index and the coefficient.


Yes, and there are two interpretations of this when the parent is a submodule.

- one is `monomial_coefficients`, which refers to the basis of the submodule
- one is the proposed new `items`, which will refer to the ambient. (This will be compatible with sparse vectors in `sage.modules`.)



---

archive/issue_comments_519168.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,14 @@\n+This is the element class of a `CombinatorialFreeModule`.\n \n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.\n+\n+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):\n+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)\n+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If `self` is a submodule, they refer to the ambient module (see #34455).\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-08T23:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519168",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,14 @@
+This is the element class of a `CombinatorialFreeModule`.
 
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols.
+
+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):
+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)
+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If `self` is a submodule, they refer to the ambient module (see #34455).
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.
 
 Comment: 1
 
```




---

archive/issue_comments_519169.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:7 Matthias K\u00f6ppe]:\n> Replying to [comment:5 Travis Scrimshaw]:\n> > I strongly oppose changing them to iterating over keys. This brings their implementation further from the other free module vectors.\n\n> \n> This makes no sense.\n\n\nWe want the two implementations to have the same API as much as possible. R<sup>n</sup> vectors iterate over coefficients, but iterating over keys/supports here would be the exact opposite of that behavior.",
    "created_at": "2022-09-08T23:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519169",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:10'></a>Replying to [comment:7 Matthias Köppe]:
> Replying to [comment:5 Travis Scrimshaw]:
> > I strongly oppose changing them to iterating over keys. This brings their implementation further from the other free module vectors.

> 
> This makes no sense.


We want the two implementations to have the same API as much as possible. R<sup>n</sup> vectors iterate over coefficients, but iterating over keys/supports here would be the exact opposite of that behavior.



---

archive/issue_comments_519170.json:
```json
{
    "body": "<a id='comment:11'></a>Yes, it makes no sense to say that returning `(key,value)` pairs is closer to being the \"same API\" as returning `value`s.",
    "created_at": "2022-09-09T00:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519170",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:11'></a>Yes, it makes no sense to say that returning `(key,value)` pairs is closer to being the "same API" as returning `value`s.



---

archive/issue_comments_519171.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+This is the element class of a `CombinatorialFreeModule`.\n \n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, \n+\n+```\n+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])\n+sage: B = F.basis()\n+sage: f = B['a'] + 3*B['c']; f\n+sage: import collections.abc\n+sage: isinstance(f, collections.abc.Collection)\n+True\n+```\n+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.\n+\n+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):\n+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)\n+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If `self` is a submodule, they refer to the ambient module (see #34455).\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-09T00:15:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519171",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,24 @@
+This is the element class of a `CombinatorialFreeModule`.
 
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, 
+
+```
+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
+sage: B = F.basis()
+sage: f = B['a'] + 3*B['c']; f
+sage: import collections.abc
+sage: isinstance(f, collections.abc.Collection)
+True
+```
+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.
+
+To improve interoperability, we propose to make changes to make it a [collections.abc.Mapping](https://docs.python.org/3/library/collections.abc.html#collections.abc.Mapping) (= supporting the operations of a `dict` but without mutability):
+- Because a `Mapping` is a `Collection`, we change the `__iter__` method from yielding (key, value) items to yielding keys only. (Thus it will be compatible with the existing `__contains__` method which check for the presence of a key)
+- Add methods `keys`, `items`, `values` with the semantics familiar from `dict`. If `self` is a submodule, they refer to the ambient module (see #34455).
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.
 
 Comment: 1
 
```




---

archive/issue_comments_519172.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:11 Matthias K\u00f6ppe]:\n> Yes, it makes no sense to say that returning `(key,value)` pairs is closer to being the \"same API\" as returning `value`s.\n\n\nSo actually returning the coefficient as part of the iterator instead of saying you should access it by a completely different method is exactly the same by your logic. You wouldn\u2019t agree that it is a much smaller change to have R<sup>n</sup> vector iterators change to return the pairs?",
    "created_at": "2022-09-09T01:34:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519172",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:13'></a>Replying to [comment:11 Matthias Köppe]:
> Yes, it makes no sense to say that returning `(key,value)` pairs is closer to being the "same API" as returning `value`s.


So actually returning the coefficient as part of the iterator instead of saying you should access it by a completely different method is exactly the same by your logic. You wouldn’t agree that it is a much smaller change to have R<sup>n</sup> vector iterators change to return the pairs?



---

archive/issue_comments_519173.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 Travis Scrimshaw]:\n> change to have R<sup>n</sup> vector iterators change to return the pairs?\n\n\nThat would be a really bad change for dense vectors, which clearly want to be a `collections.abc.Sequence`",
    "created_at": "2022-09-09T01:38:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519173",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:14'></a>Replying to [comment:13 Travis Scrimshaw]:
> change to have R<sup>n</sup> vector iterators change to return the pairs?


That would be a really bad change for dense vectors, which clearly want to be a `collections.abc.Sequence`



---

archive/issue_comments_519174.json:
```json
{
    "body": "<a id='comment:15'></a>Replying to [comment:8 Matthias K\u00f6ppe]:\n> Replying to [comment:5 Travis Scrimshaw]:\n> > most of the time when iterating we want to use both the support index and the coefficient.\n\n> \n> Yes, and there are two interpretations of this when the parent is a submodule.\n> \n> - one is `monomial_coefficients`, which refers to the basis of the submodule\n> - one is the proposed new `items`, which will refer to the ambient. (This will be compatible with sparse vectors in `sage.modules`.)\n\n\nUnfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything. I would rather all vectors follow what CFM vectors do from a more abstract mathematical point of view, but we have to make trade-offs. This one is here very clear-cut.\n\nAlso, it isn\u2019t just limited to sparse vectors, right?",
    "created_at": "2022-09-09T01:39:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519174",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:15'></a>Replying to [comment:8 Matthias Köppe]:
> Replying to [comment:5 Travis Scrimshaw]:
> > most of the time when iterating we want to use both the support index and the coefficient.

> 
> Yes, and there are two interpretations of this when the parent is a submodule.
> 
> - one is `monomial_coefficients`, which refers to the basis of the submodule
> - one is the proposed new `items`, which will refer to the ambient. (This will be compatible with sparse vectors in `sage.modules`.)


Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything. I would rather all vectors follow what CFM vectors do from a more abstract mathematical point of view, but we have to make trade-offs. This one is here very clear-cut.

Also, it isn’t just limited to sparse vectors, right?



---

archive/issue_comments_519175.json:
```json
{
    "body": "<a id='comment:16'></a>Replying to [comment:14 Matthias K\u00f6ppe]:\n> Replying to [comment:13 Travis Scrimshaw]:\n> > change to have R<sup>n</sup> vector iterators change to return the pairs?\n\n> \n> That would be a really bad change for dense vectors, which clearly want to be a `collections.abc.Sequence`\n\n\nI am not saying we should change it (see comment:15), but if we did, it would be smaller.",
    "created_at": "2022-09-09T01:39:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519175",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:16'></a>Replying to [comment:14 Matthias Köppe]:
> Replying to [comment:13 Travis Scrimshaw]:
> > change to have R<sup>n</sup> vector iterators change to return the pairs?

> 
> That would be a really bad change for dense vectors, which clearly want to be a `collections.abc.Sequence`


I am not saying we should change it (see comment:15), but if we did, it would be smaller.



---

archive/issue_comments_519176.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 Travis Scrimshaw]:\n> Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything.\n\n\nYou'll have to be more concrete than that. There's nothing in the proposed change that has anything to do with performance.",
    "created_at": "2022-09-09T01:43:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519176",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Replying to [comment:15 Travis Scrimshaw]:
> Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything.


You'll have to be more concrete than that. There's nothing in the proposed change that has anything to do with performance.



---

archive/issue_comments_519177.json:
```json
{
    "body": "<a id='comment:18'></a>I do see lots of uses of the idiom `... for (i, c) in self` in `sage.combinat`.\n\nSo maybe an easier change would be to get rid of the `__contains__` method (with deprecation, of course) to resolve this incompatibility. Then only uses of `if i in self` would have to be changed to `if i in self.support()`",
    "created_at": "2022-09-09T03:24:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519177",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:18'></a>I do see lots of uses of the idiom `... for (i, c) in self` in `sage.combinat`.

So maybe an easier change would be to get rid of the `__contains__` method (with deprecation, of course) to resolve this incompatibility. Then only uses of `if i in self` would have to be changed to `if i in self.support()`



---

archive/issue_comments_519178.json:
```json
{
    "body": "<a id='comment:19'></a>Replying to [comment:17 Matthias K\u00f6ppe]:\n> Replying to [comment:15 Travis Scrimshaw]:\n> > Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything.\n\n> \n> You'll have to be more concrete than that. There's nothing in the proposed change that has anything to do with performance.\n\n\nIf we change the iterator for R<sup>n</sup> modules to make it compatible with what `IndexedFreeModuleElement` does, then this would lead to slow downs because the R<sup>n</sup> module elements are fairly likely to be used in time-critical code sections (where extra indirections can matter).",
    "created_at": "2022-09-09T03:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519178",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:19'></a>Replying to [comment:17 Matthias Köppe]:
> Replying to [comment:15 Travis Scrimshaw]:
> > Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything.

> 
> You'll have to be more concrete than that. There's nothing in the proposed change that has anything to do with performance.


If we change the iterator for R<sup>n</sup> modules to make it compatible with what `IndexedFreeModuleElement` does, then this would lead to slow downs because the R<sup>n</sup> module elements are fairly likely to be used in time-critical code sections (where extra indirections can matter).



---

archive/issue_comments_519179.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 Matthias K\u00f6ppe]:\n> I do see lots of uses of the idiom `... for (i, c) in self` in `sage.combinat`.\n> \n> So maybe an easier change would be to get rid of the `__contains__` method (with deprecation, of course) to resolve this incompatibility. Then only uses of `if i in self` would have to be changed to `if i in self.support()`\n\n\n+1 on this basically. I doubt anyone is using the support containment check where speed really matters, but that is my only slight hesitancy because that change would make it much slower (via the additional temporary object from `support()`). Perhaps a `self.index_in_support(i)` method instead?",
    "created_at": "2022-09-09T03:30:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519179",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:20'></a>Replying to [comment:18 Matthias Köppe]:
> I do see lots of uses of the idiom `... for (i, c) in self` in `sage.combinat`.
> 
> So maybe an easier change would be to get rid of the `__contains__` method (with deprecation, of course) to resolve this incompatibility. Then only uses of `if i in self` would have to be changed to `if i in self.support()`


+1 on this basically. I doubt anyone is using the support containment check where speed really matters, but that is my only slight hesitancy because that change would make it much slower (via the additional temporary object from `support()`). Perhaps a `self.index_in_support(i)` method instead?



---

archive/issue_comments_519180.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:19 Travis Scrimshaw]:\n> Replying to [comment:17 Matthias K\u00f6ppe]:\n> > Replying to [comment:15 Travis Scrimshaw]:\n> > > Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything.\n\n> > \n> > You'll have to be more concrete than that. There's nothing in the proposed change that has anything to do with performance.\n\n> \n> If we change the iterator for R<sup>n</sup> modules to make it compatible with what `IndexedFreeModuleElement` does\n\n\nOK, yes, that's just one of several reasons why this change would be bad. It's not being proposed here.",
    "created_at": "2022-09-09T04:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519180",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>Replying to [comment:19 Travis Scrimshaw]:
> Replying to [comment:17 Matthias Köppe]:
> > Replying to [comment:15 Travis Scrimshaw]:
> > > Unfortunately because of different implementation goals (mainly the speed that is needed for the R<sup>n</sup> modules), we cannot enforce compatibility for everything.

> > 
> > You'll have to be more concrete than that. There's nothing in the proposed change that has anything to do with performance.

> 
> If we change the iterator for R<sup>n</sup> modules to make it compatible with what `IndexedFreeModuleElement` does


OK, yes, that's just one of several reasons why this change would be bad. It's not being proposed here.



---

archive/issue_comments_519181.json:
```json
{
    "body": "<a id='comment:22'></a>Replying to [comment:20 Travis Scrimshaw]:\n> Replying to [comment:18 Matthias K\u00f6ppe]:\n> > I do see lots of uses of the idiom `... for (i, c) in self` in `sage.combinat`.\n> > \n> > So maybe an easier change would be to get rid of the `__contains__` method (with deprecation, of course) to resolve this incompatibility. Then only uses of `if i in self` would have to be changed to `if i in self.support()`\n\n> \n> +1 on this basically. I doubt anyone is using the support containment check where speed really matters, but that is my only slight hesitancy because that change would make it much slower (via the additional temporary object from `support()`). Perhaps a `self.index_in_support(i)` method instead?\n\n\nYes, of course the current implementation of `support()` is bad. It's another Python2-ish leftover of returning lists all the time.",
    "created_at": "2022-09-09T04:28:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519181",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:22'></a>Replying to [comment:20 Travis Scrimshaw]:
> Replying to [comment:18 Matthias Köppe]:
> > I do see lots of uses of the idiom `... for (i, c) in self` in `sage.combinat`.
> > 
> > So maybe an easier change would be to get rid of the `__contains__` method (with deprecation, of course) to resolve this incompatibility. Then only uses of `if i in self` would have to be changed to `if i in self.support()`

> 
> +1 on this basically. I doubt anyone is using the support containment check where speed really matters, but that is my only slight hesitancy because that change would make it much slower (via the additional temporary object from `support()`). Perhaps a `self.index_in_support(i)` method instead?


Yes, of course the current implementation of `support()` is bad. It's another Python2-ish leftover of returning lists all the time.



---

archive/issue_comments_519182.json:
```json
{
    "body": "<a id='comment:23'></a>By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros",
    "created_at": "2022-09-09T04:31:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519182",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:23'></a>By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros



---

archive/issue_comments_519183.json:
```json
{
    "body": "<a id='comment:24'></a>If there's no zero value in `_monomial_coefficients`, then `support` can just return the `_monomial_coefficients.keys()` view.",
    "created_at": "2022-09-09T04:32:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519183",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>If there's no zero value in `_monomial_coefficients`, then `support` can just return the `_monomial_coefficients.keys()` view.



---

archive/issue_comments_519184.json:
```json
{
    "body": "<a id='comment:25'></a>Either way instead of inventing a new name such as `index_in_support`, we should just have `support` return a suitable object with a `__contains__` method.",
    "created_at": "2022-09-09T04:37:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519184",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:25'></a>Either way instead of inventing a new name such as `index_in_support`, we should just have `support` return a suitable object with a `__contains__` method.



---

archive/issue_comments_519185.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,24 @@\n+This is the element class of a `CombinatorialFreeModule`.\n \n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, \n+\n+```\n+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])\n+sage: B = F.basis()\n+sage: f = B['a'] + 3*B['c']; f\n+sage: import collections.abc\n+sage: isinstance(f, collections.abc.Collection)\n+True\n+```\n+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.\n+\n+To improve interoperability, we propose to make the following changes: \n+- Deprecate the `__contains__` method (currently testing whether a given index is in the suppport). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. \n+- Add a method `items`, with the same semantics as for sparse vectors from `sage.modules`, and matrices and tensor components after #29619. If `self` is a submodule, they refer to the ambient module (see #34455).\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-10T05:41:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519185",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,24 @@
+This is the element class of a `CombinatorialFreeModule`.
 
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, 
+
+```
+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
+sage: B = F.basis()
+sage: f = B['a'] + 3*B['c']; f
+sage: import collections.abc
+sage: isinstance(f, collections.abc.Collection)
+True
+```
+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.
+
+To improve interoperability, we propose to make the following changes: 
+- Deprecate the `__contains__` method (currently testing whether a given index is in the suppport). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. 
+- Add a method `items`, with the same semantics as for sparse vectors from `sage.modules`, and matrices and tensor components after #29619. If `self` is a submodule, they refer to the ambient module (see #34455).
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.
 
 Comment: 1
 
```




---

archive/issue_comments_519186.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,25 @@\n+This is the element class of a `CombinatorialFreeModule`.\n \n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, \n+\n+```\n+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])\n+sage: B = F.basis()\n+sage: f = B['a'] + 3*B['c']; f\n+sage: import collections.abc\n+sage: isinstance(f, collections.abc.Collection)\n+True\n+```\n+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.\n+\n+To improve interoperability, we propose to make the following changes: \n+- Deprecate the `__contains__` method (currently testing whether a given index is in the suppport). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. \n+- As a replacement for this functionality, revise the method `support` to return an object with a fast `__contains__` method instead of a list.\n+- Add a method `items`, with the same semantics as for sparse vectors from `sage.modules`, and matrices and tensor components after #29619. If `self` is a submodule, they refer to the ambient module (see #34455).\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-10T05:43:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519186",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,25 @@
+This is the element class of a `CombinatorialFreeModule`.
 
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, 
+
+```
+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
+sage: B = F.basis()
+sage: f = B['a'] + 3*B['c']; f
+sage: import collections.abc
+sage: isinstance(f, collections.abc.Collection)
+True
+```
+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.
+
+To improve interoperability, we propose to make the following changes: 
+- Deprecate the `__contains__` method (currently testing whether a given index is in the suppport). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. 
+- As a replacement for this functionality, revise the method `support` to return an object with a fast `__contains__` method instead of a list.
+- Add a method `items`, with the same semantics as for sparse vectors from `sage.modules`, and matrices and tensor components after #29619. If `self` is a submodule, they refer to the ambient module (see #34455).
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.
 
 Comment: 1
 
```




---

archive/issue_comments_519187.json:
```json
{
    "body": "<a id='comment:28'></a>I've updated the ticket description to reflect this revised plan",
    "created_at": "2022-09-10T05:43:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519187",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:28'></a>I've updated the ticket description to reflect this revised plan



---

archive/issue_comments_519188.json:
```json
{
    "body": "<a id='comment:30'></a>New commits:",
    "created_at": "2022-09-10T22:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519188",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>New commits:



---

archive/issue_comments_519189.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,25 @@\n+This is the element class of a `CombinatorialFreeModule`.\n \n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, \n+\n+```\n+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])\n+sage: B = F.basis()\n+sage: f = B['a'] + 3*B['c']; f\n+sage: import collections.abc\n+sage: isinstance(f, collections.abc.Collection)\n+True\n+```\n+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.\n+\n+To improve interoperability, we propose to make the following changes: \n+- Deprecate the `__contains__` method (currently testing whether a given index is in the support). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. \n+- As a replacement for this functionality, revise the method `support` to return an instance of a new class `SupportView`, which provides a fast `__contains__` method, instead of a list.\n+- Add a method `items`, with the same semantics as for sparse vectors from `sage.modules`, and matrices and tensor components after #29619. If `self` is a submodule, they refer to the ambient module (see #34455).\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-10T22:37:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519189",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,25 @@
+This is the element class of a `CombinatorialFreeModule`.
 
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, 
+
+```
+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
+sage: B = F.basis()
+sage: f = B['a'] + 3*B['c']; f
+sage: import collections.abc
+sage: isinstance(f, collections.abc.Collection)
+True
+```
+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.
+
+To improve interoperability, we propose to make the following changes: 
+- Deprecate the `__contains__` method (currently testing whether a given index is in the support). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. 
+- As a replacement for this functionality, revise the method `support` to return an instance of a new class `SupportView`, which provides a fast `__contains__` method, instead of a list.
+- Add a method `items`, with the same semantics as for sparse vectors from `sage.modules`, and matrices and tensor components after #29619. If `self` is a submodule, they refer to the ambient module (see #34455).
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.
 
 Comment: 1
 
```




---

archive/issue_comments_519190.json:
```json
{
    "body": "<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-10T22:44:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519190",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:31'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519191.json:
```json
{
    "body": "<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-10T22:55:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519191",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:32'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519192.json:
```json
{
    "body": "<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-10T23:14:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519192",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:33'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519193.json:
```json
{
    "body": "Description changed:\n```diff\n--- \n+++ \n@@ -1,4 +1,25 @@\n+This is the element class of a `CombinatorialFreeModule`.\n \n+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, \n+\n+```\n+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])\n+sage: B = F.basis()\n+sage: f = B['a'] + 3*B['c']; f\n+sage: import collections.abc\n+sage: isinstance(f, collections.abc.Collection)\n+True\n+```\n+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.\n+\n+To improve interoperability, we propose to make the following changes: \n+- Deprecate the `__contains__` method (currently testing whether a given index is in the support). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. \n+- As a replacement for this functionality, revise the method `support` to return an instance of a new class `SupportView`, which provides a fast `__contains__` method, instead of a list.\n+\n+\n+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)\n+\n+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.\n \n Comment: 1\n \n```\n",
    "created_at": "2022-09-10T23:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519193",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
```diff
--- 
+++ 
@@ -1,4 +1,25 @@
+This is the element class of a `CombinatorialFreeModule`.
 
+Its implementation of `__iter__`, `__contains__`, `__len__` are not compatible with anything in the [collections.abc](https://docs.python.org/3/library/collections.abc.html) protocols. Specifically, 
+
+```
+sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
+sage: B = F.basis()
+sage: f = B['a'] + 3*B['c']; f
+sage: import collections.abc
+sage: isinstance(f, collections.abc.Collection)
+True
+```
+but `__iter__`ating over this collection gives objects that are not `__contain__`ed in it.
+
+To improve interoperability, we propose to make the following changes: 
+- Deprecate the `__contains__` method (currently testing whether a given index is in the support). After its removal, the class would no longer be considered by Python to be a subclass of `collections.abc.Collection`, but merely a `Sized` `Iterable`. 
+- As a replacement for this functionality, revise the method `support` to return an instance of a new class `SupportView`, which provides a fast `__contains__` method, instead of a list.
+
+
+(Similarly, in #24815, it was proposed to make the elements of free modules from `sage.modules` a [collections.abc.Sequence](https://docs.python.org/3/library/collections.abc.html#collections.abc.Sequence).)
+
+Part of Meta-ticket #30309: Unify free module elements API: methods dict, monomial_coefficients, etc.
 
 Comment: 1
 
```




---

archive/issue_comments_519194.json:
```json
{
    "body": "<a id='comment:36'></a>The proposed method `items` will be added in #34511",
    "created_at": "2022-09-10T23:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519194",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:36'></a>The proposed method `items` will be added in #34511



---

archive/issue_comments_519195.json:
```json
{
    "body": "<a id='comment:37'></a>Replying to [comment:23 Matthias K\u00f6ppe]:\n> By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros\n\n\nWe have somewhat allowed for the possibility that it can hold zero coefficients, but we almost always in practice just remove them. We probably should just enforce this. This would make the `support()` call much cheaper, although checking containment could still be slow as it might be `list`-like checking rather than `set`-like. Anyways, I doubt it is used in much time critical code, but it is still good to keep similar performance in mind.",
    "created_at": "2022-09-10T23:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519195",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:37'></a>Replying to [comment:23 Matthias Köppe]:
> By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros


We have somewhat allowed for the possibility that it can hold zero coefficients, but we almost always in practice just remove them. We probably should just enforce this. This would make the `support()` call much cheaper, although checking containment could still be slow as it might be `list`-like checking rather than `set`-like. Anyways, I doubt it is used in much time critical code, but it is still good to keep similar performance in mind.



---

archive/issue_comments_519196.json:
```json
{
    "body": "<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-10T23:41:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519196",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:38'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519197.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-10T23:57:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519197",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519198.json:
```json
{
    "body": "<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T00:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519198",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:40'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519199.json:
```json
{
    "body": "<a id='comment:41'></a>Replying to [comment:37 Travis Scrimshaw]:\n> Replying to [comment:23 Matthias K\u00f6ppe]:\n> > By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros\n\n> \n> We have somewhat allowed for the possibility that it can hold zero coefficients, but we almost always in practice just remove them. We probably should just enforce this. This would make the `support()` call much cheaper\n\n\nOn the level of `CombinatorialFreeModule`, not the category, right? We can do that in a follow-up ticket. (The tensor modules don't enforce the sparsity, I think.)",
    "created_at": "2022-09-11T00:07:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519199",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>Replying to [comment:37 Travis Scrimshaw]:
> Replying to [comment:23 Matthias Köppe]:
> > By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros

> 
> We have somewhat allowed for the possibility that it can hold zero coefficients, but we almost always in practice just remove them. We probably should just enforce this. This would make the `support()` call much cheaper


On the level of `CombinatorialFreeModule`, not the category, right? We can do that in a follow-up ticket. (The tensor modules don't enforce the sparsity, I think.)



---

archive/issue_comments_519200.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-11T00:08:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519200",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_519201.json:
```json
{
    "body": "<a id='comment:43'></a>This could of course be rewritten to avoid forming all these lists, but I don't know if it's worth it. Question for the author\n\n```\nindex aa96f2b..e065b7e 100644\n--- a/src/sage/categories/loop_crystals.py\n+++ b/src/sage/categories/loop_crystals.py\n@@ -456,7 +456,7 @@ class KirillovReshetikhinCrystals(Category_singleton):\n             bsharp = None\n             for b in self:\n                 phi = b.Phi()\n-                if phi.support() == [0] and phi[0] < ell:\n+                if list(phi.support()) == [0] and phi[0] < ell:\n                     bsharp = b\n```",
    "created_at": "2022-09-11T00:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519201",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:43'></a>This could of course be rewritten to avoid forming all these lists, but I don't know if it's worth it. Question for the author

```
index aa96f2b..e065b7e 100644
--- a/src/sage/categories/loop_crystals.py
+++ b/src/sage/categories/loop_crystals.py
@@ -456,7 +456,7 @@ class KirillovReshetikhinCrystals(Category_singleton):
             bsharp = None
             for b in self:
                 phi = b.Phi()
-                if phi.support() == [0] and phi[0] < ell:
+                if list(phi.support()) == [0] and phi[0] < ell:
                     bsharp = b
```



---

archive/issue_comments_519202.json:
```json
{
    "body": "<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T00:12:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519202",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:44'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519203.json:
```json
{
    "body": "<a id='comment:45'></a>Replying to [comment:41 Matthias K\u00f6ppe]:\n> Replying to [comment:37 Travis Scrimshaw]:\n> > Replying to [comment:23 Matthias K\u00f6ppe]:\n> > > By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros\n\n> > \n> > We have somewhat allowed for the possibility that it can hold zero coefficients, but we almost always in practice just remove them. We probably should just enforce this. This would make the `support()` call much cheaper\n\n> \n> On the level of `CombinatorialFreeModule`, not the category, right? We can do that in a follow-up ticket. (The tensor modules don't enforce the sparsity, I think.)\n\n\nI was thinking more for any `Parent` that uses the element class, but basically, yes.",
    "created_at": "2022-09-11T00:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519203",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:45'></a>Replying to [comment:41 Matthias Köppe]:
> Replying to [comment:37 Travis Scrimshaw]:
> > Replying to [comment:23 Matthias Köppe]:
> > > By the way, can `_monomial_coefficients` really contain keys that have a zero value? I looked briefly and it seemed that for example arithmetic would always remove the zeros

> > 
> > We have somewhat allowed for the possibility that it can hold zero coefficients, but we almost always in practice just remove them. We probably should just enforce this. This would make the `support()` call much cheaper

> 
> On the level of `CombinatorialFreeModule`, not the category, right? We can do that in a follow-up ticket. (The tensor modules don't enforce the sparsity, I think.)


I was thinking more for any `Parent` that uses the element class, but basically, yes.



---

archive/issue_comments_519204.json:
```json
{
    "body": "<a id='comment:46'></a>Sure, yes, that's what I meant.",
    "created_at": "2022-09-11T00:35:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519204",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:46'></a>Sure, yes, that's what I meant.



---

archive/issue_comments_519205.json:
```json
{
    "body": "<a id='comment:47'></a>Replying to [comment:43 Matthias K\u00f6ppe]:\n> This could of course be rewritten to avoid forming all these lists, but I don't know if it's worth it. Question for the author\n> \n> ```\n> index aa96f2b..e065b7e 100644\n> --- a/src/sage/categories/loop_crystals.py\n> +++ b/src/sage/categories/loop_crystals.py\n> @@ -456,7 +456,7 @@ class KirillovReshetikhinCrystals(Category_singleton):\n>              bsharp = None\n>              for b in self:\n>                  phi = b.Phi()\n> -                if phi.support() == [0] and phi[0] < ell:\n> +                if list(phi.support()) == [0] and phi[0] < ell:\n>                      bsharp = b\n> ```\n\n\nI don\u2019t think it is necessarily worth it as it won\u2019t be run in tight loops. Although it would just become `if len(phi.support()) == 1 and 0 in phi.support() and phi[0] < ell:` I guess.",
    "created_at": "2022-09-11T00:37:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519205",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:47'></a>Replying to [comment:43 Matthias Köppe]:
> This could of course be rewritten to avoid forming all these lists, but I don't know if it's worth it. Question for the author
> 
> ```
> index aa96f2b..e065b7e 100644
> --- a/src/sage/categories/loop_crystals.py
> +++ b/src/sage/categories/loop_crystals.py
> @@ -456,7 +456,7 @@ class KirillovReshetikhinCrystals(Category_singleton):
>              bsharp = None
>              for b in self:
>                  phi = b.Phi()
> -                if phi.support() == [0] and phi[0] < ell:
> +                if list(phi.support()) == [0] and phi[0] < ell:
>                      bsharp = b
> ```


I don’t think it is necessarily worth it as it won’t be run in tight loops. Although it would just become `if len(phi.support()) == 1 and 0 in phi.support() and phi[0] < ell:` I guess.



---

archive/issue_comments_519206.json:
```json
{
    "body": "<a id='comment:48'></a>I guess one other option would be the `SupportView` to support comparisons with lists (and/or tuple)?",
    "created_at": "2022-09-11T00:38:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519206",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:48'></a>I guess one other option would be the `SupportView` to support comparisons with lists (and/or tuple)?



---

archive/issue_comments_519207.json:
```json
{
    "body": "<a id='comment:49'></a>Well, using `len(phi.support())` wouldn't be much better because `len` has to iterate through the whole thing. \nFaster would be to do \n\n```\n  i = iter(phi)\n  next(i)\n  try: next(i) except ...\n```",
    "created_at": "2022-09-11T00:38:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519207",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:49'></a>Well, using `len(phi.support())` wouldn't be much better because `len` has to iterate through the whole thing. 
Faster would be to do 

```
  i = iter(phi)
  next(i)
  try: next(i) except ...
```



---

archive/issue_comments_519208.json:
```json
{
    "body": "<a id='comment:50'></a>Replying to [comment:48 Travis Scrimshaw]:\n> I guess one other option would be the `SupportView` to support comparisons with lists (and/or tuple)?\n\n\nWell, I think that's problematic because we don't even have `[1, 2] == (1, 2)`",
    "created_at": "2022-09-11T00:39:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519208",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:50'></a>Replying to [comment:48 Travis Scrimshaw]:
> I guess one other option would be the `SupportView` to support comparisons with lists (and/or tuple)?


Well, I think that's problematic because we don't even have `[1, 2] == (1, 2)`



---

archive/issue_comments_519209.json:
```json
{
    "body": "<a id='comment:51'></a>Replying to [comment:49 Matthias K\u00f6ppe]:\n> Well, using `len(phi.support())` wouldn't be much better because `len` has to iterate through the whole thing. \n> Faster would be to do \n> \n> ```\n>   i = iter(phi)\n>   next(i)\n>   try: next(i) except ...\n> ```\n\n\nTrue, and that is complicated in an `if` statement.",
    "created_at": "2022-09-11T00:40:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519209",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:51'></a>Replying to [comment:49 Matthias Köppe]:
> Well, using `len(phi.support())` wouldn't be much better because `len` has to iterate through the whole thing. 
> Faster would be to do 
> 
> ```
>   i = iter(phi)
>   next(i)
>   try: next(i) except ...
> ```


True, and that is complicated in an `if` statement.



---

archive/issue_comments_519210.json:
```json
{
    "body": "<a id='comment:52'></a>Clear use case for https://more-itertools.readthedocs.io/en/stable/api.html#more_itertools.take",
    "created_at": "2022-09-11T00:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519210",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:52'></a>Clear use case for https://more-itertools.readthedocs.io/en/stable/api.html#more_itertools.take



---

archive/issue_comments_519211.json:
```json
{
    "body": "<a id='comment:53'></a>or https://more-itertools.readthedocs.io/en/stable/api.html#more_itertools.strictly_n",
    "created_at": "2022-09-11T00:42:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519211",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:53'></a>or https://more-itertools.readthedocs.io/en/stable/api.html#more_itertools.strictly_n



---

archive/issue_comments_519212.json:
```json
{
    "body": "<a id='comment:54'></a>or https://more-itertools.readthedocs.io/en/stable/api.html#more_itertools.only",
    "created_at": "2022-09-11T00:42:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519212",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:54'></a>or https://more-itertools.readthedocs.io/en/stable/api.html#more_itertools.only



---

archive/issue_comments_519213.json:
```json
{
    "body": "<a id='comment:55'></a>Replying to [comment:50 Matthias K\u00f6ppe]:\n> Replying to [comment:48 Travis Scrimshaw]:\n> > I guess one other option would be the `SupportView` to support comparisons with lists (and/or tuple)?\n\n> \n> Well, I think that's problematic because we don't even have `[1, 2] == (1, 2)`\n\n\nTransitivity of `==` is indeed good to have. Well, maybe just comparisons with a list then? Or at least temporarily with a deprecation?",
    "created_at": "2022-09-11T00:42:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519213",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:55'></a>Replying to [comment:50 Matthias Köppe]:
> Replying to [comment:48 Travis Scrimshaw]:
> > I guess one other option would be the `SupportView` to support comparisons with lists (and/or tuple)?

> 
> Well, I think that's problematic because we don't even have `[1, 2] == (1, 2)`


Transitivity of `==` is indeed good to have. Well, maybe just comparisons with a list then? Or at least temporarily with a deprecation?



---

archive/issue_comments_519214.json:
```json
{
    "body": "<a id='comment:56'></a>That would be doable but I think it's overkill.\n\nI think the license to break functions like this, from the Python 2 to 3 transition, is not expired yet",
    "created_at": "2022-09-11T00:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519214",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:56'></a>That would be doable but I think it's overkill.

I think the license to break functions like this, from the Python 2 to 3 transition, is not expired yet



---

archive/issue_comments_519215.json:
```json
{
    "body": "<a id='comment:57'></a>This is a little different as it was the support of a vector, not the keys of a `dict`.",
    "created_at": "2022-09-11T00:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519215",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:57'></a>This is a little different as it was the support of a vector, not the keys of a `dict`.



---

archive/issue_comments_519216.json:
```json
{
    "body": "<a id='comment:58'></a>I'm referring to the general change in the Python library from explicit lists as return values to iterators",
    "created_at": "2022-09-11T00:50:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519216",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:58'></a>I'm referring to the general change in the Python library from explicit lists as return values to iterators



---

archive/issue_comments_519217.json:
```json
{
    "body": "<a id='comment:59'></a>I think that would need a more general policy agreement discussed on sage-devel (as much as I would like to freely do this to a number of functions).",
    "created_at": "2022-09-11T00:53:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519217",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:59'></a>I think that would need a more general policy agreement discussed on sage-devel (as much as I would like to freely do this to a number of functions).



---

archive/issue_comments_519218.json:
```json
{
    "body": "<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T00:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519218",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:60'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519219.json:
```json
{
    "body": "<a id='comment:61'></a>OK, OK, I'll write an `__eq__` method with deprecation",
    "created_at": "2022-09-11T00:56:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519219",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:61'></a>OK, OK, I'll write an `__eq__` method with deprecation



---

archive/issue_comments_519220.json:
```json
{
    "body": "<a id='comment:62'></a>Thank you. (So many things that return lists in `combinat` that would be better as iterators\u2026)",
    "created_at": "2022-09-11T01:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519220",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:62'></a>Thank you. (So many things that return lists in `combinat` that would be better as iterators…)



---

archive/issue_comments_519221.json:
```json
{
    "body": "<a id='comment:63'></a>Ha, this does catch a few places that do such comparisons",
    "created_at": "2022-09-11T01:05:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519221",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:63'></a>Ha, this does catch a few places that do such comparisons



---

archive/issue_comments_519222.json:
```json
{
    "body": "<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T01:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519222",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:64'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519223.json:
```json
{
    "body": "<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T01:08:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519223",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:65'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519224.json:
```json
{
    "body": "<a id='comment:66'></a>ok, done",
    "created_at": "2022-09-11T01:08:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519224",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:66'></a>ok, done



---

archive/issue_comments_519225.json:
```json
{
    "body": "<a id='comment:67'></a>Should we also do comparisons with different `SupportView` objects, following python?\n\n```\nsage: d = {1:1, 2:2}\nsage: dp = {1:-1, 2:-2}\nsage: d.keys() == dp.keys()\nTrue\n```\nSorry if this was something you were planning to support and hadn\u2019t gotten to that stage yet.",
    "created_at": "2022-09-11T01:41:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519225",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:67'></a>Should we also do comparisons with different `SupportView` objects, following python?

```
sage: d = {1:1, 2:2}
sage: dp = {1:-1, 2:-2}
sage: d.keys() == dp.keys()
True
```
Sorry if this was something you were planning to support and hadn’t gotten to that stage yet.



---

archive/issue_comments_519226.json:
```json
{
    "body": "<a id='comment:68'></a>Replying to [comment:66 Matthias K\u00f6ppe]:\n> ok, done\n\n\nThank you.",
    "created_at": "2022-09-11T01:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519226",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:68'></a>Replying to [comment:66 Matthias Köppe]:
> ok, done


Thank you.



---

archive/issue_comments_519227.json:
```json
{
    "body": "<a id='comment:69'></a>Replying to [comment:67 Travis Scrimshaw]:\n> Should we also do comparisons with different `SupportView` objects, following python?\n> \n> ```\n> sage: d = {1:1, 2:2}\n> sage: dp = {1:-1, 2:-2}\n> sage: d.keys() == dp.keys()\n> True\n> ```\n> Sorry if this was something you were planning to support and hadn\u2019t gotten to that stage yet.\n\n\nI'm unsure about this, and I think I would defer it to a follow-up ticket.\n\nIt could get full `collections.abc.Set` semantics actually, including `<=` as subset test etc. But that's a bit more work",
    "created_at": "2022-09-11T01:46:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519227",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:69'></a>Replying to [comment:67 Travis Scrimshaw]:
> Should we also do comparisons with different `SupportView` objects, following python?
> 
> ```
> sage: d = {1:1, 2:2}
> sage: dp = {1:-1, 2:-2}
> sage: d.keys() == dp.keys()
> True
> ```
> Sorry if this was something you were planning to support and hadn’t gotten to that stage yet.


I'm unsure about this, and I think I would defer it to a follow-up ticket.

It could get full `collections.abc.Set` semantics actually, including `<=` as subset test etc. But that's a bit more work



---

archive/issue_comments_519228.json:
```json
{
    "body": "<a id='comment:70'></a>In view of #29218, I would also move `__iter__` from `IndexedFreeModuleElement` to the category, next to `__len__`. Together they merely provide a default implementation of the `Sized` `Iterable` protocols. (Dense modules necessarily override both.)\n\nThe `length` method, on the other hand, is full specified and would be changed to not go through `__len__`.",
    "created_at": "2022-09-11T02:07:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519228",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:70'></a>In view of #29218, I would also move `__iter__` from `IndexedFreeModuleElement` to the category, next to `__len__`. Together they merely provide a default implementation of the `Sized` `Iterable` protocols. (Dense modules necessarily override both.)

The `length` method, on the other hand, is full specified and would be changed to not go through `__len__`.



---

archive/issue_comments_519229.json:
```json
{
    "body": "<a id='comment:71'></a>But that will go to #29218.",
    "created_at": "2022-09-11T02:38:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519229",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:71'></a>But that will go to #29218.



---

archive/issue_comments_519230.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-11T04:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519230",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_519231.json:
```json
{
    "body": "<a id='comment:72'></a>\n```\nsage -t --random-seed=124699541928353137721504742146487601068 doc/en/thematic_tutorials/lie/weyl_character_ring.rst  # 3 doctests failed\nsage -t --random-seed=124699541928353137721504742146487601068 sage/algebras/quantum_groups/fock_space.py  # 80 doctests failed\nsage -t --random-seed=124699541928353137721504742146487601068 sage/graphs/generators/random.py  # 1 doctest failed\nsage -t --random-seed=124699541928353137721504742146487601068 sage/modules/tutorial_free_modules.py  # 1 doctest failed\n```",
    "created_at": "2022-09-11T04:10:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519231",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:72'></a>
```
sage -t --random-seed=124699541928353137721504742146487601068 doc/en/thematic_tutorials/lie/weyl_character_ring.rst  # 3 doctests failed
sage -t --random-seed=124699541928353137721504742146487601068 sage/algebras/quantum_groups/fock_space.py  # 80 doctests failed
sage -t --random-seed=124699541928353137721504742146487601068 sage/graphs/generators/random.py  # 1 doctest failed
sage -t --random-seed=124699541928353137721504742146487601068 sage/modules/tutorial_free_modules.py  # 1 doctest failed
```



---

archive/issue_comments_519232.json:
```json
{
    "body": "<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T04:13:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519232",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:73'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519233.json:
```json
{
    "body": "<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-11T04:17:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519233",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:74'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_519234.json:
```json
{
    "body": "<a id='comment:75'></a>The failure in `sage/graphs/generators/random.py` is an unrelated random failure, I've added it to #32544.",
    "created_at": "2022-09-11T04:20:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519234",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:75'></a>The failure in `sage/graphs/generators/random.py` is an unrelated random failure, I've added it to #32544.



---

archive/issue_comments_519235.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-11T04:23:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519235",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_519236.json:
```json
{
    "body": "<a id='comment:77'></a>All morally green, ready for review\n\n(The Build&Test failure is another well-known random failure, in `sage/schemes/toric/sheaf/klyachko.py`, and Lint failures are known and unrelated.)",
    "created_at": "2022-09-11T17:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519236",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:77'></a>All morally green, ready for review

(The Build&Test failure is another well-known random failure, in `sage/schemes/toric/sheaf/klyachko.py`, and Lint failures are known and unrelated.)



---

archive/issue_comments_519237.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-09-20T07:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519237",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_519238.json:
```json
{
    "body": "<a id='comment:78'></a>Sorry, lost track of this. LGTM.",
    "created_at": "2022-09-20T07:57:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519238",
    "user": "https://github.com/tscrim"
}
```

<a id='comment:78'></a>Sorry, lost track of this. LGTM.



---

archive/issue_comments_519239.json:
```json
{
    "body": "<a id='comment:79'></a>Thank you!",
    "created_at": "2022-09-20T16:29:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519239",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:79'></a>Thank you!



---

archive/issue_comments_519240.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-09-22T22:35:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34509#issuecomment-519240",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_089611.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-09-22T22:35:05Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34509",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34509#event-89611"
}
```
