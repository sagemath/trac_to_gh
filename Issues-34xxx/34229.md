# Issue 34229: use PARI's qfbredsl2() for binary quadratic forms

archive/issues_033992.json:
```json
{
    "body": "Currently, Sage cannot compute the transformation matrix when reducing *definite* binary quadratic forms:\n\n```sage\nsage: BinaryQF([1,2,3]).reduced_form(transformation=True)\n# ...\nNotImplementedError: reduction of definite binary quadratic forms with transformation=True is not implemented\n```\n\nWe can use PARI's `qfbredsl2()` to make this work.\n\nBranch/Commit: c2c91dbfccf0ae2af957aa2e6167755072f0bc8d\n\nReviewer: Vincent Delecroix\n\nAuthor: Lorenz Panny\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34229\n\n",
    "closed_at": "2022-08-04T22:46:57Z",
    "created_at": "2022-07-27T03:03:09Z",
    "labels": [
        "component: quadratic forms"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "use PARI's qfbredsl2() for binary quadratic forms",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34229",
    "user": "https://github.com/yyyyx4"
}
```
Currently, Sage cannot compute the transformation matrix when reducing *definite* binary quadratic forms:

```sage
sage: BinaryQF([1,2,3]).reduced_form(transformation=True)
# ...
NotImplementedError: reduction of definite binary quadratic forms with transformation=True is not implemented
```

We can use PARI's `qfbredsl2()` to make this work.

Branch/Commit: c2c91dbfccf0ae2af957aa2e6167755072f0bc8d

Reviewer: Vincent Delecroix

Author: Lorenz Panny

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34229





---

archive/issue_comments_681865.json:
```json
{
    "body": "<a id='comment:1'></a>\nBranch pushed to git repo; I updated commit sha1. This was a forced push. New commits:\n|                                                                                                                                           |                        |\n|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|\n|[1bc1c1e](https://git.sagemath.org/sage.git/commit/?id=1bc1c1ef217c521fc2d743d99c3b3a12ebc5ebc8)|`use PARI's qfbredsl2()`|\n|[e540a90](https://git.sagemath.org/sage.git/commit/?id=e540a90860538d5a91f5e36f22fbddfa4a270d44)|`add test for trac #34229`|",
    "created_at": "2022-07-27T03:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681865",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:1'></a>
Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
|                                                                                                                                           |                        |
|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------|
|[1bc1c1e](https://git.sagemath.org/sage.git/commit/?id=1bc1c1ef217c521fc2d743d99c3b3a12ebc5ebc8)|`use PARI's qfbredsl2()`|
|[e540a90](https://git.sagemath.org/sage.git/commit/?id=e540a90860538d5a91f5e36f22fbddfa4a270d44)|`add test for trac #34229`|



---

archive/issue_comments_681866.json:
```json
{
    "body": "Changing commit from \"e2e2d4b78f3656c40916c3472ad4281241506292\" to \"e540a90860538d5a91f5e36f22fbddfa4a270d44\"",
    "created_at": "2022-07-27T03:06:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681866",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e2e2d4b78f3656c40916c3472ad4281241506292" to "e540a90860538d5a91f5e36f22fbddfa4a270d44"



---

archive/issue_comments_681867.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-27T03:06:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681867",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_681868.json:
```json
{
    "body": "Changing commit from \"e540a90860538d5a91f5e36f22fbddfa4a270d44\" to \"7a058f3026c872a20d704ccfb65b53aa491a15f8\"",
    "created_at": "2022-07-27T08:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681868",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e540a90860538d5a91f5e36f22fbddfa4a270d44" to "7a058f3026c872a20d704ccfb65b53aa491a15f8"



---

archive/issue_comments_681869.json:
```json
{
    "body": "<a id='comment:3'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                                                                     |\n|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|\n|[0eb89f0](https://git.sagemath.org/sage.git/commit/?id=0eb89f05670174070d0c20e0ebeebee8e0494435)|`PARI doesn't support negative definite forms; emulate using positive definite forms`|\n|[e1e17f3](https://git.sagemath.org/sage.git/commit/?id=e1e17f3b61c2a5f05c32126cd5067218ef2200e4)|`code style tweaks`|\n|[271746f](https://git.sagemath.org/sage.git/commit/?id=271746fa94e14e27a4e12d2e5a0925f91aa49e83)|`doc tweaks`|\n|[7a058f3](https://git.sagemath.org/sage.git/commit/?id=7a058f3026c872a20d704ccfb65b53aa491a15f8)|`slightly more effective caching`|",
    "created_at": "2022-07-27T08:29:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681869",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                                                                     |
|-------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------|
|[0eb89f0](https://git.sagemath.org/sage.git/commit/?id=0eb89f05670174070d0c20e0ebeebee8e0494435)|`PARI doesn't support negative definite forms; emulate using positive definite forms`|
|[e1e17f3](https://git.sagemath.org/sage.git/commit/?id=e1e17f3b61c2a5f05c32126cd5067218ef2200e4)|`code style tweaks`|
|[271746f](https://git.sagemath.org/sage.git/commit/?id=271746fa94e14e27a4e12d2e5a0925f91aa49e83)|`doc tweaks`|
|[7a058f3](https://git.sagemath.org/sage.git/commit/?id=7a058f3026c872a20d704ccfb65b53aa491a15f8)|`slightly more effective caching`|



---

archive/issue_comments_681870.json:
```json
{
    "body": "Changing commit from \"7a058f3026c872a20d704ccfb65b53aa491a15f8\" to \"cc19834e8d9fdddc3091a0bb7d848b0b5645d8f9\"",
    "created_at": "2022-07-27T08:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681870",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "7a058f3026c872a20d704ccfb65b53aa491a15f8" to "cc19834e8d9fdddc3091a0bb7d848b0b5645d8f9"



---

archive/issue_comments_681871.json:
```json
{
    "body": "<a id='comment:4'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                            |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|\n|[cc19834](https://git.sagemath.org/sage.git/commit/?id=cc19834e8d9fdddc3091a0bb7d848b0b5645d8f9)|`some more minor doc tweaks`|",
    "created_at": "2022-07-27T08:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681871",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:4'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                            |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
|[cc19834](https://git.sagemath.org/sage.git/commit/?id=cc19834e8d9fdddc3091a0bb7d848b0b5645d8f9)|`some more minor doc tweaks`|



---

archive/issue_comments_681872.json:
```json
{
    "body": "<a id='comment:5'></a>\nThe patchbot failure seems unrelated.",
    "created_at": "2022-07-28T04:56:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681872",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:5'></a>
The patchbot failure seems unrelated.



---

archive/issue_comments_681873.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Vincent Delecroix\"",
    "created_at": "2022-08-01T07:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681873",
    "user": "https://github.com/videlec"
}
```

Changing reviewer from "" to "Vincent Delecroix"



---

archive/issue_comments_681874.json:
```json
{
    "body": "<a id='comment:6'></a>\nI don't understand why `content` becomes a cached method here. If `discriminant` is already one, dividing it by 4 should be costless. Could you provide timing to justify this change?\n\nInstead of `self.content() == 1` I would rather use `self.content().is_one()`.\n\nTo my mind, all changes similar to\n\n```diff\n-        Return if ``self`` is identically zero.\n+        Determine if ``self`` is identically zero.\n```\nmakes the specification less precise. The word \"determines\" does not describe the output of the function.",
    "created_at": "2022-08-01T07:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681874",
    "user": "https://github.com/videlec"
}
```

<a id='comment:6'></a>
I don't understand why `content` becomes a cached method here. If `discriminant` is already one, dividing it by 4 should be costless. Could you provide timing to justify this change?

Instead of `self.content() == 1` I would rather use `self.content().is_one()`.

To my mind, all changes similar to

```diff
-        Return if ``self`` is identically zero.
+        Determine if ``self`` is identically zero.
```
makes the specification less precise. The word "determines" does not describe the output of the function.



---

archive/issue_comments_681875.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-08-01T07:56:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681875",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_681876.json:
```json
{
    "body": "<a id='comment:7'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                              |\n|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|\n|[0eea79e](https://git.sagemath.org/sage.git/commit/?id=0eea79e5dbff4653c26018c82a06f121d2c21c20)|`use is_...() methods for comparing to 0 or 1`|",
    "created_at": "2022-08-01T08:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681876",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                              |
|-------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------|
|[0eea79e](https://git.sagemath.org/sage.git/commit/?id=0eea79e5dbff4653c26018c82a06f121d2c21c20)|`use is_...() methods for comparing to 0 or 1`|



---

archive/issue_comments_681877.json:
```json
{
    "body": "Changing commit from \"cc19834e8d9fdddc3091a0bb7d848b0b5645d8f9\" to \"0eea79e5dbff4653c26018c82a06f121d2c21c20\"",
    "created_at": "2022-08-01T08:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681877",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "cc19834e8d9fdddc3091a0bb7d848b0b5645d8f9" to "0eea79e5dbff4653c26018c82a06f121d2c21c20"



---

archive/issue_comments_681878.json:
```json
{
    "body": "<a id='comment:8'></a>\nReplying to [vdelecroix](#comment%3A6):\n> I don't understand why `content` becomes a cached method here. If `discriminant` is already one, dividing it by 4 should be costless. Could you provide timing to justify this change?\n\n\nI think the diff you're looking at is cut in an unfortunate place\u2009\u2014\u2009the content isn't the discriminant divided by four! The reasoning behind the changes to caching (commit `7a058f3026c`) is:\n\n- Replace `gcd([a,b,c])` by `.content()` in `.is_primitive()` because that's what it is.\n- Move the ``@`cached_method` up from `.is_primitive()` to `.content()` because it's more general and `.is_one()` is cheap.\n- Remove ``@`cached_method` from `.is_zero()` because `.content()` is now cached and `.is_zero()` is cheap.\n\n> To my mind, all changes similar to\n> \n> ```diff\n> -        Return if ``self`` is identically zero.\n> +        Determine if ``self`` is identically zero.\n> ```\n> makes the specification less precise. The word \"determines\" does not describe the output of the function.\n\n\nMy problem with \"return if X\" was that it can be read as `if X then return [a thing?] else [catch fire?]`. But I don't really care; surely noone will be confused by either phrasing.",
    "created_at": "2022-08-01T08:25:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681878",
    "user": "https://github.com/yyyyx4"
}
```

<a id='comment:8'></a>
Replying to [vdelecroix](#comment%3A6):
> I don't understand why `content` becomes a cached method here. If `discriminant` is already one, dividing it by 4 should be costless. Could you provide timing to justify this change?


I think the diff you're looking at is cut in an unfortunate place — the content isn't the discriminant divided by four! The reasoning behind the changes to caching (commit `7a058f3026c`) is:

- Replace `gcd([a,b,c])` by `.content()` in `.is_primitive()` because that's what it is.
- Move the ``@`cached_method` up from `.is_primitive()` to `.content()` because it's more general and `.is_one()` is cheap.
- Remove ``@`cached_method` from `.is_zero()` because `.content()` is now cached and `.is_zero()` is cheap.

> To my mind, all changes similar to
> 
> ```diff
> -        Return if ``self`` is identically zero.
> +        Determine if ``self`` is identically zero.
> ```
> makes the specification less precise. The word "determines" does not describe the output of the function.


My problem with "return if X" was that it can be read as `if X then return [a thing?] else [catch fire?]`. But I don't really care; surely noone will be confused by either phrasing.



---

archive/issue_comments_681879.json:
```json
{
    "body": "<a id='comment:9'></a>\nReplying to [lorenz](#comment%3A8):\n> Replying to [vdelecroix](#comment%3A6):\n> > I don't understand why `content` becomes a cached method here. If `discriminant` is already one, dividing it by 4 should be costless. Could you provide timing to justify this change?\n\n> \n> I think the diff you're looking at is cut in an unfortunate place\u2009\u2014\u2009the content isn't the discriminant divided by four! The reasoning behind the changes to caching (commit `7a058f3026c`) is:\n> \n> - Replace `gcd([a,b,c])` by `.content()` in `.is_primitive()` because that's what it is.\n> - Move the ``@`cached_method` up from `.is_primitive()` to `.content()` because it's more general and `.is_one()` is cheap.\n> - Remove ``@`cached_method` from `.is_zero()` because `.content()` is now cached and `.is_zero()` is cheap.\n> \n\n\nOh I see. Thanks for the explanation. I should have looked more carefully at the final code rather than the diff.\n\n> > To my mind, all changes similar to\n> > \n> > ```diff\n> > -        Return if ``self`` is identically zero.\n> > +        Determine if ``self`` is identically zero.\n> > ```\n> > makes the specification less precise. The word \"determines\" does not describe the output of the function.\n\n> \n> My problem with \"return if X\" was that it can be read as `if X then return [a thing?] else [catch fire?]`. But I don't really care; surely noone will be confused by either phrasing.\n\n\nI agree that the initial sentence was not perfect either. In most places we can read `Return whether ``self`` is identically zero.` which I like better.",
    "created_at": "2022-08-01T08:41:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681879",
    "user": "https://github.com/videlec"
}
```

<a id='comment:9'></a>
Replying to [lorenz](#comment%3A8):
> Replying to [vdelecroix](#comment%3A6):
> > I don't understand why `content` becomes a cached method here. If `discriminant` is already one, dividing it by 4 should be costless. Could you provide timing to justify this change?

> 
> I think the diff you're looking at is cut in an unfortunate place — the content isn't the discriminant divided by four! The reasoning behind the changes to caching (commit `7a058f3026c`) is:
> 
> - Replace `gcd([a,b,c])` by `.content()` in `.is_primitive()` because that's what it is.
> - Move the ``@`cached_method` up from `.is_primitive()` to `.content()` because it's more general and `.is_one()` is cheap.
> - Remove ``@`cached_method` from `.is_zero()` because `.content()` is now cached and `.is_zero()` is cheap.
> 


Oh I see. Thanks for the explanation. I should have looked more carefully at the final code rather than the diff.

> > To my mind, all changes similar to
> > 
> > ```diff
> > -        Return if ``self`` is identically zero.
> > +        Determine if ``self`` is identically zero.
> > ```
> > makes the specification less precise. The word "determines" does not describe the output of the function.

> 
> My problem with "return if X" was that it can be read as `if X then return [a thing?] else [catch fire?]`. But I don't really care; surely noone will be confused by either phrasing.


I agree that the initial sentence was not perfect either. In most places we can read `Return whether ``self`` is identically zero.` which I like better.



---

archive/issue_comments_681880.json:
```json
{
    "body": "<a id='comment:10'></a>\nBranch pushed to git repo; I updated commit sha1. New commits:\n|                                                                                                                                           |                                 |\n|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|\n|[c2c91db](https://git.sagemath.org/sage.git/commit/?id=c2c91dbfccf0ae2af957aa2e6167755072f0bc8d)|`rephrase per reviewer's request`|",
    "created_at": "2022-08-01T08:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681880",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:10'></a>
Branch pushed to git repo; I updated commit sha1. New commits:
|                                                                                                                                           |                                 |
|-------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------|
|[c2c91db](https://git.sagemath.org/sage.git/commit/?id=c2c91dbfccf0ae2af957aa2e6167755072f0bc8d)|`rephrase per reviewer's request`|



---

archive/issue_comments_681881.json:
```json
{
    "body": "Changing commit from \"0eea79e5dbff4653c26018c82a06f121d2c21c20\" to \"c2c91dbfccf0ae2af957aa2e6167755072f0bc8d\"",
    "created_at": "2022-08-01T08:56:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681881",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "0eea79e5dbff4653c26018c82a06f121d2c21c20" to "c2c91dbfccf0ae2af957aa2e6167755072f0bc8d"



---

archive/issue_comments_681882.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-08-01T08:57:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681882",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_681883.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-08-01T11:56:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681883",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_089269.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-08-04T22:46:57Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34229#event-89269"
}
```



---

archive/issue_comments_681884.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-04T22:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681884",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_681885.json:
```json
{
    "body": "Changing branch from \"public/use_pari_qfbredsl2\" to \"c2c91dbfccf0ae2af957aa2e6167755072f0bc8d\"",
    "created_at": "2022-08-04T22:46:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34229",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34229#issuecomment-681885",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "public/use_pari_qfbredsl2" to "c2c91dbfccf0ae2af957aa2e6167755072f0bc8d"
