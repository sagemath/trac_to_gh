# Issue 34591: Refactor subs() of multivariate polynomials for readability and efficiency

archive/issues_034354.json:
```json
{
    "body": "CC:  @videlec @yyyyx4\n\nThis bug\n\n```\nsage: R = Integers(8)\nsage: RXY.<X,Y> = R[]\nsage: F = X^3*Y\nsage: F.subs({X:1})\nY\nsage: F.subs({X:2})  # should be 0!\nY\n```\nis fixed by #34417. However while fixing the bug, it was noticed that the code of `.subs()` is so convoluted that the code is hard to read and inefficient.\n\nSo in this ticket, we refactor the code. The modified code is shorter, simpler, and seems slightly faster. \n\nMoreover the patch also fixes the original bug without #34417 (upstream patch)!\n\nBefore the patch:\n\n```sage\nsage: R = Integers(8)\nsage: RXY.<X,Y> = R[]\nsage: F = X^3*Y\nsage: F.subs({X:2})\nY\nsage: timeit('F.subs({X:2})')\n125 loops, best of 3: 3.41 ms per loop\nsage: timeit('F.subs({X:2})')\n125 loops, best of 3: 3.39 ms per loop\nsage: timeit('F.subs({X:2})')\n125 loops, best of 3: 3.41 ms per loop\nsage: timeit('F.subs({X:2})')\n125 loops, best of 3: 3.46 ms per loop\nsage: timeit('F.subs({X:2})')\n125 loops, best of 3: 3.38 ms per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.26 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.36 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.65 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.21 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.09 \u03bcs per loop\n```\nAfter the patch \n\n```sage\nsage: R = Integers(8)\nsage: RXY.<X,Y> = R[]\nsage: F = X^3*Y\nsage: F.subs({X:2})\n0\nsage: timeit('F.subs({X:2})')\n625 loops, best of 3: 8.11 \u03bcs per loop\nsage: timeit('F.subs({X:2})')\n625 loops, best of 3: 8.8 \u03bcs per loop\nsage: timeit('F.subs({X:2})')\n625 loops, best of 3: 8.63 \u03bcs per loop\nsage: timeit('F.subs({X:2})')\n625 loops, best of 3: 8.52 \u03bcs per loop\nsage: timeit('F.subs({X:2})')\n625 loops, best of 3: 8.63 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.18 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 7.99 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.25 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.2 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.6 \u03bcs per loop\nsage: timeit('F.subs({X:1})')\n625 loops, best of 3: 8.38 \u03bcs per loop\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34591\n\n",
    "created_at": "2022-09-27T14:00:55Z",
    "labels": [
        "component: basic arithmetic",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Refactor subs() of multivariate polynomials for readability and efficiency",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34591",
    "user": "https://github.com/kwankyu"
}
```
CC:  @videlec @yyyyx4

This bug

```
sage: R = Integers(8)
sage: RXY.<X,Y> = R[]
sage: F = X^3*Y
sage: F.subs({X:1})
Y
sage: F.subs({X:2})  # should be 0!
Y
```
is fixed by #34417. However while fixing the bug, it was noticed that the code of `.subs()` is so convoluted that the code is hard to read and inefficient.

So in this ticket, we refactor the code. The modified code is shorter, simpler, and seems slightly faster. 

Moreover the patch also fixes the original bug without #34417 (upstream patch)!

Before the patch:

```sage
sage: R = Integers(8)
sage: RXY.<X,Y> = R[]
sage: F = X^3*Y
sage: F.subs({X:2})
Y
sage: timeit('F.subs({X:2})')
125 loops, best of 3: 3.41 ms per loop
sage: timeit('F.subs({X:2})')
125 loops, best of 3: 3.39 ms per loop
sage: timeit('F.subs({X:2})')
125 loops, best of 3: 3.41 ms per loop
sage: timeit('F.subs({X:2})')
125 loops, best of 3: 3.46 ms per loop
sage: timeit('F.subs({X:2})')
125 loops, best of 3: 3.38 ms per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.26 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.36 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.65 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.21 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.09 μs per loop
```
After the patch 

```sage
sage: R = Integers(8)
sage: RXY.<X,Y> = R[]
sage: F = X^3*Y
sage: F.subs({X:2})
0
sage: timeit('F.subs({X:2})')
625 loops, best of 3: 8.11 μs per loop
sage: timeit('F.subs({X:2})')
625 loops, best of 3: 8.8 μs per loop
sage: timeit('F.subs({X:2})')
625 loops, best of 3: 8.63 μs per loop
sage: timeit('F.subs({X:2})')
625 loops, best of 3: 8.52 μs per loop
sage: timeit('F.subs({X:2})')
625 loops, best of 3: 8.63 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.18 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 7.99 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.25 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.2 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.6 μs per loop
sage: timeit('F.subs({X:1})')
625 loops, best of 3: 8.38 μs per loop
```



Issue created by migration from https://trac.sagemath.org/ticket/34591





---

archive/issue_comments_486532.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to basic arithmetic.",
    "created_at": "2022-09-27T14:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486532",
    "user": "https://github.com/kwankyu"
}
```

Changing component from PLEASE CHANGE to basic arithmetic.



---

archive/issue_comments_486533.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to defect.",
    "created_at": "2022-09-27T14:01:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486533",
    "user": "https://github.com/kwankyu"
}
```

Changing type from PLEASE CHANGE to defect.



---

archive/issue_comments_486534.json:
```json
{
    "body": "This bug is related with these lines\n\n```diff\ndiff --git a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\nindex 2109c516a1..35a011174a 100644\n--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx\n@@ -3556,7 +3556,7 @@ cdef class MPolynomial_libsingular(MPolynomial):\n \n                 if _p == NULL:\n                     # polynomial becomes 0 after some substitution\n-                    try_symbolic = 1\n+                    try_symbolic = 1  # Why?\n                     break\n \n         cdef dict gd\n```\n\nAt line 3557, the substituted polynomial becomes 0 correctly. But then it goes on \"try_symbolic\". Why?\n\nThese lines were introduced in #17785.",
    "created_at": "2022-09-27T14:10:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486534",
    "user": "https://github.com/kwankyu"
}
```

This bug is related with these lines

```diff
diff --git a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
index 2109c516a1..35a011174a 100644
--- a/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
+++ b/src/sage/rings/polynomial/multi_polynomial_libsingular.pyx
@@ -3556,7 +3556,7 @@ cdef class MPolynomial_libsingular(MPolynomial):
 
                 if _p == NULL:
                     # polynomial becomes 0 after some substitution
-                    try_symbolic = 1
+                    try_symbolic = 1  # Why?
                     break
 
         cdef dict gd
```

At line 3557, the substituted polynomial becomes 0 correctly. But then it goes on "try_symbolic". Why?

These lines were introduced in #17785.



---

archive/issue_comments_486535.json:
```json
{
    "body": "I think this is a duplicate of #34417.",
    "created_at": "2022-09-27T23:06:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486535",
    "user": "https://github.com/DaveWitteMorris"
}
```

I think this is a duplicate of #34417.



---

archive/issue_comments_486536.json:
```json
{
    "body": "Replying to [comment:6 Dave Morris]:\n> I think this is a duplicate of #34417.\n\n\nYes. But as I analyzed the bug, there is no problem with Singular. So I suggest to close #34417 as a duplicate, and let us focus on fixing the problem in comment:3.",
    "created_at": "2022-09-27T23:17:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486536",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:6 Dave Morris]:
> I think this is a duplicate of #34417.


Yes. But as I analyzed the bug, there is no problem with Singular. So I suggest to close #34417 as a duplicate, and let us focus on fixing the problem in comment:3.



---

archive/issue_comments_486537.json:
```json
{
    "body": "I don't know why you say there is no problem with singular. As pointed out in ticket:34417#comment:1, the problem seems to arise in `singular_polynomial_call`.  \n\nI don't think the line in comment:3 is actually the bug (but I may be wrong). My understanding is that it is just setting a flag to say that something has gone wrong, so singular should be used to do the substitution. But it seems that singular gives the wrong answer (or the interface makes a mistake). It may be possible to solve this particular bug report by avoiding the call to singular, but it does seem to have uncovered a problem with singular (or its interface).",
    "created_at": "2022-09-27T23:41:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486537",
    "user": "https://github.com/DaveWitteMorris"
}
```

I don't know why you say there is no problem with singular. As pointed out in ticket:34417#comment:1, the problem seems to arise in `singular_polynomial_call`.  

I don't think the line in comment:3 is actually the bug (but I may be wrong). My understanding is that it is just setting a flag to say that something has gone wrong, so singular should be used to do the substitution. But it seems that singular gives the wrong answer (or the interface makes a mistake). It may be possible to solve this particular bug report by avoiding the call to singular, but it does seem to have uncovered a problem with singular (or its interface).



---

archive/issue_comments_486538.json:
```json
{
    "body": "Replying to [comment:8 Dave Morris]:\n> I don't know why you say there is no problem with singular. As pointed out in ticket:34417#comment:1, the problem seems to arise in `singular_polynomial_call`.  \n\n\nYou are right.\n\nBut there still seems to be a different issue with `.subs()`. I am investigating.",
    "created_at": "2022-09-28T22:13:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486538",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:8 Dave Morris]:
> I don't know why you say there is no problem with singular. As pointed out in ticket:34417#comment:1, the problem seems to arise in `singular_polynomial_call`.  


You are right.

But there still seems to be a different issue with `.subs()`. I am investigating.



---

archive/issue_comments_486539.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2022-09-29T07:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486539",
    "user": "https://github.com/kwankyu"
}
```

Changing priority from major to minor.



---

archive/issue_comments_486540.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-09-29T07:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486540",
    "user": "https://github.com/kwankyu"
}
```

New commits:



---

archive/issue_comments_486541.json:
```json
{
    "body": "Changing type from defect to enhancement.",
    "created_at": "2022-09-29T07:24:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486541",
    "user": "https://github.com/kwankyu"
}
```

Changing type from defect to enhancement.



---

archive/issue_comments_486542.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-29T07:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34591",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34591#issuecomment-486542",
    "user": "https://github.com/kwankyu"
}
```

Changing status from new to needs_review.
