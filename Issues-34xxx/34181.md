# Issue 34181: Clean pkgs/sagemath-standard/build/scripts-*

archive/issues_033944.json:
```json
{
    "body": "As reported in https://groups.google.com/g/sage-release/c/FezzF5Q7Wt4/m/TJG8jQyAAQAJ, scripts with old shebang lines may leak into new venvs.\n\nIn the reported case, this happened in a build `--without-system-python3` on updating from Python 3.10.3 to 3.10.5, but this could also happen when `--with-sage-venv=/SOME/GIVEN/PATH` is used.\n\n\nCC:  @culler @jhpalmieri\n\nBranch/Commit: afa19d04757750cf251ebaefa41e26e0dd6da551\n\nReviewer: John Palmieri, Matthias Koeppe\n\nAuthor: Matthias Koeppe, John Palmieri\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34181\n\n",
    "closed_at": "2022-08-04T22:46:59Z",
    "created_at": "2022-07-14T14:51:16Z",
    "labels": [
        "component: build",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.7",
    "title": "Clean pkgs/sagemath-standard/build/scripts-*",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34181",
    "user": "https://github.com/mkoeppe"
}
```
As reported in https://groups.google.com/g/sage-release/c/FezzF5Q7Wt4/m/TJG8jQyAAQAJ, scripts with old shebang lines may leak into new venvs.

In the reported case, this happened in a build `--without-system-python3` on updating from Python 3.10.3 to 3.10.5, but this could also happen when `--with-sage-venv=/SOME/GIVEN/PATH` is used.


CC:  @culler @jhpalmieri

Branch/Commit: afa19d04757750cf251ebaefa41e26e0dd6da551

Reviewer: John Palmieri, Matthias Koeppe

Author: Matthias Koeppe, John Palmieri

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34181





---

archive/issue_comments_680950.json:
```json
{
    "body": "<a id='comment:1'></a>An easy way to fix it is to just delete the cache `pkgs/sagemath-standard/build/scripts*` at the beginning of `build/pkgs/sagelib/spkg-install`. Regenerating the scripts probably does not have a noticeable performance penalty",
    "created_at": "2022-07-14T15:00:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680950",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:1'></a>An easy way to fix it is to just delete the cache `pkgs/sagemath-standard/build/scripts*` at the beginning of `build/pkgs/sagelib/spkg-install`. Regenerating the scripts probably does not have a noticeable performance penalty



---

archive/issue_comments_680951.json:
```json
{
    "body": "<a id='comment:2'></a>I think this is the same as https://github.com/pypa/setuptools/issues/847",
    "created_at": "2022-07-14T15:09:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680951",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:2'></a>I think this is the same as https://github.com/pypa/setuptools/issues/847



---

archive/issue_comments_680952.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe\"",
    "created_at": "2022-07-14T15:53:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680952",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe"



---

archive/issue_comments_680953.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched\"",
    "created_at": "2022-07-14T15:55:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680953",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched"



---

archive/issue_comments_680954.json:
```json
{
    "body": "<a id='comment:5'></a>Marc, I think this fixes the issue\n\n---\nNew commits:",
    "created_at": "2022-07-14T15:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680954",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:5'></a>Marc, I think this fixes the issue

---
New commits:



---

archive/issue_comments_680955.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-07-14T15:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680955",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_680956.json:
```json
{
    "body": "Changing commit from \"\" to \"b1d49708b1e95e6279c2ff3a316cb228b77e47ff\"",
    "created_at": "2022-07-14T15:55:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680956",
    "user": "https://github.com/mkoeppe"
}
```

Changing commit from "" to "b1d49708b1e95e6279c2ff3a316cb228b77e47ff"



---

archive/issue_comments_680957.json:
```json
{
    "body": "<a id='comment:6'></a>By the way, in your case the issue was provoked because `configure --without-system-python3 --with-sage-venv` chooses a venv directory that's keyed to the full version number (`.../venv-python3.10.5`), whereas the setuptools build cache is keyed only to major and minor version (`scripts-3.10`).",
    "created_at": "2022-07-14T16:06:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680957",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:6'></a>By the way, in your case the issue was provoked because `configure --without-system-python3 --with-sage-venv` chooses a venv directory that's keyed to the full version number (`.../venv-python3.10.5`), whereas the setuptools build cache is keyed only to major and minor version (`scripts-3.10`).



---

archive/issue_comments_680958.json:
```json
{
    "body": "<a id='comment:7'></a>Thanks!\n\nI am not explicitly using the --with-sage-venv option but it is evidently on by default.\n\nIt will not be so easy to recreate my previous directory state.  I will try to test somehow, though.",
    "created_at": "2022-07-14T16:26:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680958",
    "user": "https://github.com/culler"
}
```

<a id='comment:7'></a>Thanks!

I am not explicitly using the --with-sage-venv option but it is evidently on by default.

It will not be so easy to recreate my previous directory state.  I will try to test somehow, though.



---

archive/issue_comments_680959.json:
```json
{
    "body": "<a id='comment:9'></a>I just did `./configure --enable-editable && make`, and there is no directory `$SAGE_SRC/build/scripts-*`: `build` only contains `lib.macosx-12-x86_64-cpython-39`. Is that a problem?",
    "created_at": "2022-07-25T04:59:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680959",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:9'></a>I just did `./configure --enable-editable && make`, and there is no directory `$SAGE_SRC/build/scripts-*`: `build` only contains `lib.macosx-12-x86_64-cpython-39`. Is that a problem?



---

archive/issue_comments_680960.json:
```json
{
    "body": "<a id='comment:10'></a>Not a problem, the `rm -rf` will not give an error",
    "created_at": "2022-07-25T05:01:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680960",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:10'></a>Not a problem, the `rm -rf` will not give an error



---

archive/issue_comments_680961.json:
```json
{
    "body": "<a id='comment:11'></a>I understand that, but the command won't remove any files. It seems like this is hard to reproduce, but if some of the old scripts are causing problems, this won't have any effect in the editable case. If that's the case, the following would give a clearer picture of what's happening:\n\n```diff\ndiff --git a/build/pkgs/sagelib/spkg-install b/build/pkgs/sagelib/spkg-install\nindex c21c506f17..3178741aa2 100755\n--- a/build/pkgs/sagelib/spkg-install\n+++ b/build/pkgs/sagelib/spkg-install\n@@ -3,6 +3,8 @@ if [ \"$SAGE_EDITABLE\" = yes ]; then\n     cd \"$SAGE_SRC\"\n else\n     cd src\n+    # Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.\n+    rm -rf build/scripts-*\n fi\n ## All sagelib-building is done by setup.py.\n ## This is so that sagelib can be installed by standard Python procedures,\n@@ -37,9 +39,6 @@ export SAGE_SHARE=/doesnotexist\n # spec, which includes setting a symlink to the installed documentation.\n # export SAGE_DOC=/doesnotexist\n \n-# Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.\n-rm -rf build/scripts-*\n-\n SITEPACKAGESDIR=$(python3 -c 'import sysconfig; print(sysconfig.get_paths()[\"purelib\"])')\n if [ \"$SAGE_EDITABLE\" = yes ]; then\n     # In an incremental build, we may need to uninstall old versions installed by distutils\n```\nMaybe even add a comment in the \"if\" part about it not being a problem with editable builds, if that is indeed the case.",
    "created_at": "2022-07-25T05:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680961",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:11'></a>I understand that, but the command won't remove any files. It seems like this is hard to reproduce, but if some of the old scripts are causing problems, this won't have any effect in the editable case. If that's the case, the following would give a clearer picture of what's happening:

```diff
diff --git a/build/pkgs/sagelib/spkg-install b/build/pkgs/sagelib/spkg-install
index c21c506f17..3178741aa2 100755
--- a/build/pkgs/sagelib/spkg-install
+++ b/build/pkgs/sagelib/spkg-install
@@ -3,6 +3,8 @@ if [ "$SAGE_EDITABLE" = yes ]; then
     cd "$SAGE_SRC"
 else
     cd src
+    # Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.
+    rm -rf build/scripts-*
 fi
 ## All sagelib-building is done by setup.py.
 ## This is so that sagelib can be installed by standard Python procedures,
@@ -37,9 +39,6 @@ export SAGE_SHARE=/doesnotexist
 # spec, which includes setting a symlink to the installed documentation.
 # export SAGE_DOC=/doesnotexist
 
-# Trac #34181: Do not allow scripts with shebang lines from old venvs leak into new venvs.
-rm -rf build/scripts-*
-
 SITEPACKAGESDIR=$(python3 -c 'import sysconfig; print(sysconfig.get_paths()["purelib"])')
 if [ "$SAGE_EDITABLE" = yes ]; then
     # In an incremental build, we may need to uninstall old versions installed by distutils
```
Maybe even add a comment in the "if" part about it not being a problem with editable builds, if that is indeed the case.



---

archive/issue_comments_680962.json:
```json
{
    "body": "<a id='comment:12'></a>OK if you want to push this change to the ticket",
    "created_at": "2022-07-25T05:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680962",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:12'></a>OK if you want to push this change to the ticket



---

archive/issue_comments_680963.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched\" to \"u/jhpalmieri/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched\"",
    "created_at": "2022-07-25T05:29:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680963",
    "user": "https://github.com/jhpalmieri"
}
```

Changing branch from "u/mkoeppe/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched" to "u/jhpalmieri/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched"



---

archive/issue_comments_680964.json:
```json
{
    "body": "Changing commit from \"b1d49708b1e95e6279c2ff3a316cb228b77e47ff\" to \"afa19d04757750cf251ebaefa41e26e0dd6da551\"",
    "created_at": "2022-07-25T05:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680964",
    "user": "https://github.com/jhpalmieri"
}
```

Changing commit from "b1d49708b1e95e6279c2ff3a316cb228b77e47ff" to "afa19d04757750cf251ebaefa41e26e0dd6da551"



---

archive/issue_comments_680965.json:
```json
{
    "body": "<a id='comment:14'></a>Okay, done.\n\n---\nNew commits:",
    "created_at": "2022-07-25T05:29:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680965",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:14'></a>Okay, done.

---
New commits:



---

archive/issue_comments_680966.json:
```json
{
    "body": "Changing author from \"Matthias Koeppe\" to \"Matthias Koeppe, John Palmieri\"",
    "created_at": "2022-07-25T05:37:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680966",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "Matthias Koeppe" to "Matthias Koeppe, John Palmieri"



---

archive/issue_comments_680967.json:
```json
{
    "body": "<a id='comment:16'></a>LGTM",
    "created_at": "2022-07-25T21:33:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680967",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>LGTM



---

archive/issue_comments_680968.json:
```json
{
    "body": "Changing reviewer from \"\" to \"..., Matthias Koeppe\"",
    "created_at": "2022-07-25T21:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680968",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "..., Matthias Koeppe"



---

archive/issue_comments_680969.json:
```json
{
    "body": "<a id='comment:18'></a>`@`culler: what do you think? I'm happy with it.",
    "created_at": "2022-07-25T22:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680969",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:18'></a>`@`culler: what do you think? I'm happy with it.



---

archive/issue_comments_680970.json:
```json
{
    "body": "Changing reviewer from \"..., Matthias Koeppe\" to \"John Palmieri, Matthias Koeppe\"",
    "created_at": "2022-07-25T22:13:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680970",
    "user": "https://github.com/jhpalmieri"
}
```

Changing reviewer from "..., Matthias Koeppe" to "John Palmieri, Matthias Koeppe"



---

archive/issue_comments_680971.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-07-29T17:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680971",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_680972.json:
```json
{
    "body": "<a id='comment:19'></a>Let's move ahead with this.",
    "created_at": "2022-07-29T17:21:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680972",
    "user": "https://github.com/jhpalmieri"
}
```

<a id='comment:19'></a>Let's move ahead with this.



---

archive/issue_comments_680973.json:
```json
{
    "body": "<a id='comment:20'></a>Thanks!",
    "created_at": "2022-07-29T17:26:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680973",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Thanks!



---

archive/issue_comments_680974.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-08-04T22:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680974",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_089207.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-08-04T22:46:59Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34181#event-89207"
}
```



---

archive/issue_comments_680975.json:
```json
{
    "body": "Changing branch from \"u/jhpalmieri/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched\" to \"afa19d04757750cf251ebaefa41e26e0dd6da551\"",
    "created_at": "2022-08-04T22:46:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34181",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34181#issuecomment-680975",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/jhpalmieri/clean_pkgs_sagemath_standard_scripts___when_venvs_are_switched" to "afa19d04757750cf251ebaefa41e26e0dd6da551"
