# Issue 34701: libgap: Fix GC crashes on aarch64

archive/issues_034464.json:
```json
{
    "body": "A refactor in #27946 introduced \"unprotected\" (not surrounded by `GAP_Enter`/`GAP_Leave`) `GAP_ValueGlobalVariable` calls. I believe this might be a GC hazard, because after updating to GAP 4.12.1 I started seeing aarch64 crashes on NixOS infrastructure such as:\n\n```\n#0  0x0000fffff79740e8 in wait4 ()\n#1  0x0000fffff5dc6b78 in print_enhanced_backtrace ()\n#2  0x0000fffff5dc8190 in sigdie ()\n#3  0x0000fffff5dcb1c0 in cysigs_signal_handler ()\n#4  0x0000fffff7ffb7cc in __kernel_rt_sigreturn ()\n#5  0x0000ffff99a0bf28 in ConvString ()\n#6  0x0000000000000000 in ?? ()\n#7  0x0000000000000000 in ?? ()\n#8  0x0000000000000000 in ?? ()\n#9  0x0000ffff99989930 in Pr ()\n#10 0x0000ffff9998aa18 in CloseOutput ()\n#11 0x0000ffff99884828 in capture_stdout () at /build/sage-src-9.7/pkgs/sagemath-standard/sage/libs/gap/element.pyx:154\n...\n```\nI also see cases where `capture_stdout` throws errors such as `sage.libs.gap.util.GAPError: Error, Length: <list> must be a list (not the integer 255)` and then crashes. Both types of errors are fixed by this ticket.\n\nNote that I am nesting `GAP_Enter`/`GAP_Leave` calls because I didn't remove the preexisting calls inside `capture_stdout`. That's because I feared removing the innermost calls might create a new footgun (and I believe nested `GAP_Enter`/`GAP_Leave` calls are explicitly supported), but removing them should cause no problem. Removing them might even be preferable for performance reasons, I don't know.\n\nThis ticket's branch is based on #34391.\n\n(Edit: I previously thought that holding onto a `char*` past the `GAP_Enter`/`GAP_Leave` blocks, as is done in GapElement's `__str__` and `_repr_` methods, could also cause GC hazards. It doesn't seem to be a problem in practice, though, and I am not qualified to tell if it's a problem in theory.)\n\nCC:  @embray @videlec\n\nBranch: u/gh-collares/gap-gc\n\nStatus: new\n\nDependencies: #34391\n\nCommit: 90acc7f1c13a80b8aa673469a2668feb9cd4207f\n\nIssue created by migration from https://trac.sagemath.org/ticket/34701\n\n",
    "created_at": "2022-10-28T22:23:45Z",
    "labels": [
        "component: interfaces",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "libgap: Fix GC crashes on aarch64",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34701",
    "user": "https://github.com/collares"
}
```
A refactor in #27946 introduced "unprotected" (not surrounded by `GAP_Enter`/`GAP_Leave`) `GAP_ValueGlobalVariable` calls. I believe this might be a GC hazard, because after updating to GAP 4.12.1 I started seeing aarch64 crashes on NixOS infrastructure such as:

```
#0  0x0000fffff79740e8 in wait4 ()
#1  0x0000fffff5dc6b78 in print_enhanced_backtrace ()
#2  0x0000fffff5dc8190 in sigdie ()
#3  0x0000fffff5dcb1c0 in cysigs_signal_handler ()
#4  0x0000fffff7ffb7cc in __kernel_rt_sigreturn ()
#5  0x0000ffff99a0bf28 in ConvString ()
#6  0x0000000000000000 in ?? ()
#7  0x0000000000000000 in ?? ()
#8  0x0000000000000000 in ?? ()
#9  0x0000ffff99989930 in Pr ()
#10 0x0000ffff9998aa18 in CloseOutput ()
#11 0x0000ffff99884828 in capture_stdout () at /build/sage-src-9.7/pkgs/sagemath-standard/sage/libs/gap/element.pyx:154
...
```
I also see cases where `capture_stdout` throws errors such as `sage.libs.gap.util.GAPError: Error, Length: <list> must be a list (not the integer 255)` and then crashes. Both types of errors are fixed by this ticket.

Note that I am nesting `GAP_Enter`/`GAP_Leave` calls because I didn't remove the preexisting calls inside `capture_stdout`. That's because I feared removing the innermost calls might create a new footgun (and I believe nested `GAP_Enter`/`GAP_Leave` calls are explicitly supported), but removing them should cause no problem. Removing them might even be preferable for performance reasons, I don't know.

This ticket's branch is based on #34391.

(Edit: I previously thought that holding onto a `char*` past the `GAP_Enter`/`GAP_Leave` blocks, as is done in GapElement's `__str__` and `_repr_` methods, could also cause GC hazards. It doesn't seem to be a problem in practice, though, and I am not qualified to tell if it's a problem in theory.)

CC:  @embray @videlec

Branch: u/gh-collares/gap-gc

Status: new

Dependencies: #34391

Commit: 90acc7f1c13a80b8aa673469a2668feb9cd4207f

Issue created by migration from https://trac.sagemath.org/ticket/34701





---

archive/issue_comments_487538.json:
```json
{
    "body": "<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-10-29T00:20:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34701",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34701#issuecomment-487538",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:3'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
