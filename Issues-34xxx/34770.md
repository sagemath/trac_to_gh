# Issue 34770: fix coercion from libgap's finite fields, use libgap in sage/rings/finite_rings

archive/issues_034533.json:
```json
{
    "body": "implement coercion from libgap's finite fields, to fix e.g.\n\n```\nsage: F=GF(25)\nsage: F(libgap.Z(25)^3)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n...\nTypeError: unable to coerce <class 'sage.libs.gap.element.GapElement_FiniteField'>\n```\n\nWith the ticket branch, this works:\n\n```\nsage: F=GF(25)\nsage: F(libgap.Z(25)^3)\n4*z2 + 3\n```\n\n---\n\nAs well, we switch to use libgap instead of pexpect GAP - internally\nin the affected files. This is a part of #26902\n\nCC:  @nbruin @mkoeppe @kwankyu\n\nBranch/Commit: 6e5ea791a3d846cfd70d9b361f168f6c2fa66a2b\n\nReviewer: Matthias Koeppe\n\nAuthor: Dima Pasechnik\n\nResolution: fixed\n\nIssue created by migration from https://trac.sagemath.org/ticket/34770\n\n",
    "closed_at": "2022-12-14T22:12:21Z",
    "created_at": "2022-11-21T23:46:54Z",
    "labels": [
        "component: number theory",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "fix coercion from libgap's finite fields, use libgap in sage/rings/finite_rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34770",
    "user": "https://github.com/dimpase"
}
```
implement coercion from libgap's finite fields, to fix e.g.

```
sage: F=GF(25)
sage: F(libgap.Z(25)^3)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
...
TypeError: unable to coerce <class 'sage.libs.gap.element.GapElement_FiniteField'>
```

With the ticket branch, this works:

```
sage: F=GF(25)
sage: F(libgap.Z(25)^3)
4*z2 + 3
```

---

As well, we switch to use libgap instead of pexpect GAP - internally
in the affected files. This is a part of #26902

CC:  @nbruin @mkoeppe @kwankyu

Branch/Commit: 6e5ea791a3d846cfd70d9b361f168f6c2fa66a2b

Reviewer: Matthias Koeppe

Author: Dima Pasechnik

Resolution: fixed

Issue created by migration from https://trac.sagemath.org/ticket/34770





---

archive/issue_comments_691351.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -12,8 +12,8 @@\n With the ticket branch, this works:\n \n ```\n-sage: sage: F=GF(25)\n-sage: sage: F(libgap.Z(25)^3)\n+sage: F=GF(25)\n+sage: F(libgap.Z(25)^3)\n 4*z2 + 3\n ```\n \n``````\n",
    "created_at": "2022-11-21T23:55:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691351",
    "user": "https://github.com/dimpase"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -12,8 +12,8 @@
 With the ticket branch, this works:
 
 ```
-sage: sage: F=GF(25)
-sage: sage: F(libgap.Z(25)^3)
+sage: F=GF(25)
+sage: F(libgap.Z(25)^3)
 4*z2 + 3
 ```
 
``````




---

archive/issue_comments_691352.json:
```json
{
    "body": "Changing commit from \"\" to \"02bd544c5a0a348b2a448a9eb9f1cc7f7ae3fda0\"",
    "created_at": "2022-11-21T23:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691352",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "" to "02bd544c5a0a348b2a448a9eb9f1cc7f7ae3fda0"



---

archive/issue_comments_691353.json:
```json
{
    "body": "<a id='comment:2'></a>New commits:",
    "created_at": "2022-11-21T23:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691353",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:2'></a>New commits:



---

archive/issue_comments_691354.json:
```json
{
    "body": "Changing branch from \"\" to \"u/dimpase/rings/FFEs_to_accept_libgap\"",
    "created_at": "2022-11-21T23:56:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691354",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "" to "u/dimpase/rings/FFEs_to_accept_libgap"



---

archive/issue_comments_691355.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-21T23:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691355",
    "user": "https://github.com/dimpase"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_691356.json:
```json
{
    "body": "<a id='comment:4'></a>I've left intact the ability to accept pexpect GAP data to be converted in Sage finite field elements - this means I need a test for this type.\nI'm using an import statement \n\n```\nfrom sage.interfaces.gap import is_GapElement\n```\nand a call to `is_GapElement()`.\nIs there a way to avoid this call? I can also put the import into the `try` block and\nset `is_GapElement()` to always return `False` in case of import exception.",
    "created_at": "2022-11-22T09:56:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691356",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:4'></a>I've left intact the ability to accept pexpect GAP data to be converted in Sage finite field elements - this means I need a test for this type.
I'm using an import statement 

```
from sage.interfaces.gap import is_GapElement
```
and a call to `is_GapElement()`.
Is there a way to avoid this call? I can also put the import into the `try` block and
set `is_GapElement()` to always return `False` in case of import exception.



---

archive/issue_comments_691357.json:
```json
{
    "body": "<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-11-22T09:58:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691357",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:5'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_691358.json:
```json
{
    "body": "Changing commit from \"02bd544c5a0a348b2a448a9eb9f1cc7f7ae3fda0\" to \"21e38a73fa41698d02ec4c00597e35b5dbd0eda6\"",
    "created_at": "2022-11-22T09:58:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691358",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "02bd544c5a0a348b2a448a9eb9f1cc7f7ae3fda0" to "21e38a73fa41698d02ec4c00597e35b5dbd0eda6"



---

archive/issue_comments_691359.json:
```json
{
    "body": "Changing commit from \"21e38a73fa41698d02ec4c00597e35b5dbd0eda6\" to \"d4bde80f350975b30e5795aa5ffc7333f5c80911\"",
    "created_at": "2022-11-22T10:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691359",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "21e38a73fa41698d02ec4c00597e35b5dbd0eda6" to "d4bde80f350975b30e5795aa5ffc7333f5c80911"



---

archive/issue_comments_691360.json:
```json
{
    "body": "<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-22T10:07:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691360",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:6'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691361.json:
```json
{
    "body": "<a id='comment:7'></a>I can also resort to not calling `is_GapElement()`, and rely on exceptions - this would need a bit more rearranging of if/else. \n\nHowever, there are still explicit tests like `sage: S(gap('Z(25)^3'))`, and there is a discrepancy between `libgap` and (pexpect) `gap` in the way they treat such inputs:\n\n```\nsage: gap('Z(25)^3')\nZ(5^2)^3\nsage: gap.eval('Z(25)^3')\n'Z(5^2)^3'\nsage: libgap.eval('Z(25)^3')\nZ(5^2)^3\nsage: libgap('Z(25)^3')\n\"Z(25)^3\"\n```\n\nSo these tests will have to go as soon as `gap` is set to `libgap`.",
    "created_at": "2022-11-22T10:14:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691361",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:7'></a>I can also resort to not calling `is_GapElement()`, and rely on exceptions - this would need a bit more rearranging of if/else. 

However, there are still explicit tests like `sage: S(gap('Z(25)^3'))`, and there is a discrepancy between `libgap` and (pexpect) `gap` in the way they treat such inputs:

```
sage: gap('Z(25)^3')
Z(5^2)^3
sage: gap.eval('Z(25)^3')
'Z(5^2)^3'
sage: libgap.eval('Z(25)^3')
Z(5^2)^3
sage: libgap('Z(25)^3')
"Z(25)^3"
```

So these tests will have to go as soon as `gap` is set to `libgap`.



---

archive/issue_comments_691362.json:
```json
{
    "body": "<a id='comment:9'></a>I am not familiar with libgap and less with GAP...\n\nThis `gfq_gap_to_sage(e, self.parent)` runs faster than `libgap(e).sage(ring=self.parent)` with me. Then why do you replace the former with the latter? Removing pexpect gap is the primary objective?",
    "created_at": "2022-11-24T03:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691362",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:9'></a>I am not familiar with libgap and less with GAP...

This `gfq_gap_to_sage(e, self.parent)` runs faster than `libgap(e).sage(ring=self.parent)` with me. Then why do you replace the former with the latter? Removing pexpect gap is the primary objective?



---

archive/issue_comments_691363.json:
```json
{
    "body": "<a id='comment:10'></a>Replying to [comment:9 Kwankyu Lee]:\n \n> This `gfq_gap_to_sage(e, self.parent)` runs faster than `libgap(e).sage(ring=self.parent)` with me. \n\n\nLoading `libgap` takes time. After it's loaded, it should actually be faster to use\nit.\n\nIn this particular case, you only need `libgap(e)` on `e` coming from pexpect `gap`.\nSo there is an extra conversion involved, and we are getting rid of  pexpect `gap`\nanyway, so after this is done these conversions (to Sage types) will be much faster\n(they are just `e.sage(ring=self.parent)`)\n\nOne should not use pexpect `gap`, it should be deprecated. Do you want this to happen on this ticket?",
    "created_at": "2022-11-24T11:16:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691363",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:10'></a>Replying to [comment:9 Kwankyu Lee]:
 
> This `gfq_gap_to_sage(e, self.parent)` runs faster than `libgap(e).sage(ring=self.parent)` with me. 


Loading `libgap` takes time. After it's loaded, it should actually be faster to use
it.

In this particular case, you only need `libgap(e)` on `e` coming from pexpect `gap`.
So there is an extra conversion involved, and we are getting rid of  pexpect `gap`
anyway, so after this is done these conversions (to Sage types) will be much faster
(they are just `e.sage(ring=self.parent)`)

One should not use pexpect `gap`, it should be deprecated. Do you want this to happen on this ticket?



---

archive/issue_comments_691364.json:
```json
{
    "body": "<a id='comment:11'></a>the only \"real\" use of `gfq_gap_to_sage` is in sage/coding - and this is eliminated in #34771, along with the use of pexpect GAP.\n\nThus the only possible speed regression can appear in user code, while using pexpect GAP.",
    "created_at": "2022-11-24T17:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691364",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:11'></a>the only "real" use of `gfq_gap_to_sage` is in sage/coding - and this is eliminated in #34771, along with the use of pexpect GAP.

Thus the only possible speed regression can appear in user code, while using pexpect GAP.



---

archive/issue_comments_691365.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,4 @@\n-implement coersion from libgap's finite fields, to fix e.g.\n+implement coercion from libgap's finite fields, to fix e.g.\n \n ```\n sage: F=GF(25)\n``````\n",
    "created_at": "2022-11-25T00:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691365",
    "user": "https://github.com/kwankyu"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,4 @@
-implement coersion from libgap's finite fields, to fix e.g.
+implement coercion from libgap's finite fields, to fix e.g.
 
 ```
 sage: F=GF(25)
``````




---

archive/issue_comments_691366.json:
```json
{
    "body": "<a id='comment:12'></a>Replying to [comment:4 Dima Pasechnik]:\n> I'm using an import statement \n> \n> ```\n> from sage.interfaces.gap import is_GapElement\n> ```\n> and a call to `is_GapElement()`.\n> Is there a way to avoid this call? I can also put the import into the `try` block and\n> set `is_GapElement()` to always return `False` in case of import exception.\n\n\nWhy is there a possibility of import exception?\n\nThe definition of `is_GapElement()` is `isinstance(x, GapElement)`. This lets you avoid the call. But perhaps I simply don't understand your intention or context...",
    "created_at": "2022-11-25T00:37:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691366",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:12'></a>Replying to [comment:4 Dima Pasechnik]:
> I'm using an import statement 
> 
> ```
> from sage.interfaces.gap import is_GapElement
> ```
> and a call to `is_GapElement()`.
> Is there a way to avoid this call? I can also put the import into the `try` block and
> set `is_GapElement()` to always return `False` in case of import exception.


Why is there a possibility of import exception?

The definition of `is_GapElement()` is `isinstance(x, GapElement)`. This lets you avoid the call. But perhaps I simply don't understand your intention or context...



---

archive/issue_comments_691367.json:
```json
{
    "body": "<a id='comment:13'></a>Replying to [comment:12 Kwankyu Lee]:\n\n> The definition of `is_GapElement()` is `isinstance(x, GapElement)`. This lets you avoid the call.\n\n\nGreat, this will simplify things a bit. It didn't cross my mind that `is_GapElement()`\nis that simple.",
    "created_at": "2022-11-25T00:42:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691367",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:13'></a>Replying to [comment:12 Kwankyu Lee]:

> The definition of `is_GapElement()` is `isinstance(x, GapElement)`. This lets you avoid the call.


Great, this will simplify things a bit. It didn't cross my mind that `is_GapElement()`
is that simple.



---

archive/issue_comments_691368.json:
```json
{
    "body": "<a id='comment:14'></a>Replying to [comment:13 Dima Pasechnik]:\n> Replying to [comment:12 Kwankyu Lee]:\n> \n> > The definition of `is_GapElement()` is `isinstance(x, GapElement)`. This lets you avoid the call.\n\n> \n> Great, this will simplify things a bit. It didn't cross my mind that `is_GapElement()`\n> is that simple.\n> \n\nwell, not really, as one still need to import `GapElement` (Cython won't even compile without it)",
    "created_at": "2022-11-25T16:12:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691368",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>Replying to [comment:13 Dima Pasechnik]:
> Replying to [comment:12 Kwankyu Lee]:
> 
> > The definition of `is_GapElement()` is `isinstance(x, GapElement)`. This lets you avoid the call.

> 
> Great, this will simplify things a bit. It didn't cross my mind that `is_GapElement()`
> is that simple.
> 

well, not really, as one still need to import `GapElement` (Cython won't even compile without it)



---

archive/issue_comments_691369.json:
```json
{
    "body": "<a id='comment:15'></a>Do you want to avoid importing from `sage.interfaces.gap`? Why?",
    "created_at": "2022-11-28T03:47:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691369",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:15'></a>Do you want to avoid importing from `sage.interfaces.gap`? Why?



---

archive/issue_comments_691370.json:
```json
{
    "body": "<a id='comment:16'></a>If this is for modularization purposes in which an import may fail: I am using this idiom for such isinstance tests:\n\n```\ntry:\n    from sage.interfaces.gap import GapElement\nexcept ImportError:\n    GapElement = ()\n\n... isinstance(x, GapElement)\n```",
    "created_at": "2022-11-28T04:16:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691370",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:16'></a>If this is for modularization purposes in which an import may fail: I am using this idiom for such isinstance tests:

```
try:
    from sage.interfaces.gap import GapElement
except ImportError:
    GapElement = ()

... isinstance(x, GapElement)
```



---

archive/issue_comments_691371.json:
```json
{
    "body": "<a id='comment:17'></a>Replying to [comment:15 Kwankyu Lee]:\n> Do you want to avoid importing from `sage.interfaces.gap`? Why? \n\n\nas a preparation for deprecation and removal. We really don't need\na pexpect interface to GAP.",
    "created_at": "2022-11-28T13:12:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691371",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:17'></a>Replying to [comment:15 Kwankyu Lee]:
> Do you want to avoid importing from `sage.interfaces.gap`? Why? 


as a preparation for deprecation and removal. We really don't need
a pexpect interface to GAP.



---

archive/issue_comments_691372.json:
```json
{
    "body": "<a id='comment:18'></a>Replying to [comment:16 Matthias K\u00f6ppe]:\n> If this is for modularization purposes in which an import may fail: I am using this idiom for such isinstance tests:\n\n\nIt's for coming deprecation and removal, seems to do the job here, too.",
    "created_at": "2022-11-28T14:37:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691372",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:18'></a>Replying to [comment:16 Matthias Köppe]:
> If this is for modularization purposes in which an import may fail: I am using this idiom for such isinstance tests:


It's for coming deprecation and removal, seems to do the job here, too.



---

archive/issue_comments_691373.json:
```json
{
    "body": "<a id='comment:19'></a>Another approach: #34804 Deprecate `sage.interfaces` `is_...Element` functions",
    "created_at": "2022-11-28T18:56:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691373",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:19'></a>Another approach: #34804 Deprecate `sage.interfaces` `is_...Element` functions



---

archive/issue_comments_691374.json:
```json
{
    "body": "<a id='comment:20'></a>Replying to [comment:18 Dima Pasechnik]:\n> Replying to [comment:16 Matthias K\u00f6ppe]:\n> > If this is for modularization purposes in which an import may fail: I am using this idiom for such isinstance tests:\n\n> \n> It's for coming deprecation and removal, seems to do the job here, too.\n\n\nFor deprecation it will not work so well because modules such as `sage.interfaces.gap` create an instance of the interface class at load time, which would trigger the deprecation warning already.",
    "created_at": "2022-11-28T19:16:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691374",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:20'></a>Replying to [comment:18 Dima Pasechnik]:
> Replying to [comment:16 Matthias Köppe]:
> > If this is for modularization purposes in which an import may fail: I am using this idiom for such isinstance tests:

> 
> It's for coming deprecation and removal, seems to do the job here, too.


For deprecation it will not work so well because modules such as `sage.interfaces.gap` create an instance of the interface class at load time, which would trigger the deprecation warning already.



---

archive/issue_comments_691375.json:
```json
{
    "body": "<a id='comment:21'></a>Replying to [comment:17 Dima Pasechnik]:\n> Replying to [comment:15 Kwankyu Lee]:\n> > Do you want to avoid importing from `sage.interfaces.gap`? Why? \n\n> \n> as a preparation for deprecation and removal. We really don't need\n> a pexpect interface to GAP.\n\n\nOkay. So this ticket is not removing pexpect GAP, but just drying it out(not sure if this phrase conveys the meaning). This seems to force you to write clumsy code. \n\nHow about adding only deprecation warnings without touching actual pexpect GAP code in this ticket, and then remove all of it in another ticket after deprecation period?",
    "created_at": "2022-11-29T01:08:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691375",
    "user": "https://github.com/kwankyu"
}
```

<a id='comment:21'></a>Replying to [comment:17 Dima Pasechnik]:
> Replying to [comment:15 Kwankyu Lee]:
> > Do you want to avoid importing from `sage.interfaces.gap`? Why? 

> 
> as a preparation for deprecation and removal. We really don't need
> a pexpect interface to GAP.


Okay. So this ticket is not removing pexpect GAP, but just drying it out(not sure if this phrase conveys the meaning). This seems to force you to write clumsy code. 

How about adding only deprecation warnings without touching actual pexpect GAP code in this ticket, and then remove all of it in another ticket after deprecation period?



---

archive/issue_comments_691376.json:
```json
{
    "body": "<a id='comment:22'></a>By the way, there is also an interesting import hell issue I encountered here: \nI'm changing here 4 files\n\n```\nsrc/sage/rings/finite_rings/element_givaro.pyx\nsrc/sage/rings/finite_rings/element_ntl_gf2e.pyx\nsrc/sage/rings/finite_rings/element_pari_ffelt.pyx\nsrc/sage/rings/finite_rings/integer_mod_ring.py\n```\nOf them, the first 3 are very similar. However, I cannot do top-level\n`from sage.libs.gap.element import GapElement_FiniteField` in each of them, only in  `element_ntl_gf2e.pyx` it does not\nlead to an obscure runtime error (`Cannot import RDF`) from libgap.",
    "created_at": "2022-11-29T09:13:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691376",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:22'></a>By the way, there is also an interesting import hell issue I encountered here: 
I'm changing here 4 files

```
src/sage/rings/finite_rings/element_givaro.pyx
src/sage/rings/finite_rings/element_ntl_gf2e.pyx
src/sage/rings/finite_rings/element_pari_ffelt.pyx
src/sage/rings/finite_rings/integer_mod_ring.py
```
Of them, the first 3 are very similar. However, I cannot do top-level
`from sage.libs.gap.element import GapElement_FiniteField` in each of them, only in  `element_ntl_gf2e.pyx` it does not
lead to an obscure runtime error (`Cannot import RDF`) from libgap.



---

archive/issue_comments_691377.json:
```json
{
    "body": "<a id='comment:23'></a>Replying to [comment:19 Matthias K\u00f6ppe]:\n> Another approach: #34804 Deprecate `sage.interfaces` `is_...Element` functions\n\n\nOK, this is interesting. So this would mean unconditionally importing `GapElement` from \n`sage.interfaces.abs`, right? I'm only not completely sure I understand what should be in the latter, as examples such as in `src/sage/rings/abc.pyx` look like dark magic to me.",
    "created_at": "2022-11-29T15:57:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691377",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:23'></a>Replying to [comment:19 Matthias Köppe]:
> Another approach: #34804 Deprecate `sage.interfaces` `is_...Element` functions


OK, this is interesting. So this would mean unconditionally importing `GapElement` from 
`sage.interfaces.abs`, right? I'm only not completely sure I understand what should be in the latter, as examples such as in `src/sage/rings/abc.pyx` look like dark magic to me.



---

archive/issue_comments_691378.json:
```json
{
    "body": "<a id='comment:24'></a>Replying to [comment:23 Dima Pasechnik]:\n> Replying to [comment:19 Matthias K\u00f6ppe]:\n> > Another approach: #34804 Deprecate `sage.interfaces` `is_...Element` functions\n\n> \n> OK, this is interesting. So this would mean unconditionally importing `GapElement` from \n> `sage.interfaces.abs`, right? \n\n\nYes.\n\n> I'm only not completely sure I understand what should be in the latter, as examples such as in `src/sage/rings/abc.pyx` look like dark magic to me.\n\n\nI've pushed a barebones version to #34804. `src/sage/rings/abc.pyx` is longer, but it's just decoration",
    "created_at": "2022-11-29T18:13:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691378",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:24'></a>Replying to [comment:23 Dima Pasechnik]:
> Replying to [comment:19 Matthias Köppe]:
> > Another approach: #34804 Deprecate `sage.interfaces` `is_...Element` functions

> 
> OK, this is interesting. So this would mean unconditionally importing `GapElement` from 
> `sage.interfaces.abs`, right? 


Yes.

> I'm only not completely sure I understand what should be in the latter, as examples such as in `src/sage/rings/abc.pyx` look like dark magic to me.


I've pushed a barebones version to #34804. `src/sage/rings/abc.pyx` is longer, but it's just decoration



---

archive/issue_comments_691379.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-29T21:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691379",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691380.json:
```json
{
    "body": "Changing commit from \"d4bde80f350975b30e5795aa5ffc7333f5c80911\" to \"1c4a69fdfee7ccf9aebb40bbc29b4453852cacb1\"",
    "created_at": "2022-11-29T21:21:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691380",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "d4bde80f350975b30e5795aa5ffc7333f5c80911" to "1c4a69fdfee7ccf9aebb40bbc29b4453852cacb1"



---

archive/issue_comments_691381.json:
```json
{
    "body": "<a id='comment:26'></a>OK, how about this? The branch of #34804 should be based on this one.",
    "created_at": "2022-11-29T21:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691381",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:26'></a>OK, how about this? The branch of #34804 should be based on this one.



---

archive/issue_comments_691382.json:
```json
{
    "body": "<a id='comment:27'></a>Yes, looking good.",
    "created_at": "2022-11-29T21:42:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691382",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:27'></a>Yes, looking good.



---

archive/issue_comments_691383.json:
```json
{
    "body": "<a id='comment:28'></a>review?",
    "created_at": "2022-11-30T07:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691383",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>review?



---

archive/issue_comments_691384.json:
```json
{
    "body": "<a id='comment:29'></a>In this change:\n\n```\n--- a/src/sage/rings/finite_rings/element_ntl_gf2e.pyx\n+++ b/src/sage/rings/finite_rings/element_ntl_gf2e.pyx\n@@ -56,6 +54,11 @@ from .finite_field_ntl_gf2e import FiniteField_ntl_gf2e\n \n from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n \n+from sage.libs.gap.element import GapElement_FiniteField\n+\n```\nit would be good to use the `try except ... ()` so that there is no hard load-time dependency on libgap.",
    "created_at": "2022-11-30T17:32:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691384",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:29'></a>In this change:

```
--- a/src/sage/rings/finite_rings/element_ntl_gf2e.pyx
+++ b/src/sage/rings/finite_rings/element_ntl_gf2e.pyx
@@ -56,6 +54,11 @@ from .finite_field_ntl_gf2e import FiniteField_ntl_gf2e
 
 from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
 
+from sage.libs.gap.element import GapElement_FiniteField
+
```
it would be good to use the `try except ... ()` so that there is no hard load-time dependency on libgap.



---

archive/issue_comments_691385.json:
```json
{
    "body": "<a id='comment:30'></a>Replying to [comment:29 Matthias K\u00f6ppe]:\n> In this change:\n> \n> ```\n> --- a/src/sage/rings/finite_rings/element_ntl_gf2e.pyx\n> +++ b/src/sage/rings/finite_rings/element_ntl_gf2e.pyx\n> @@ -56,6 +54,11 @@ from .finite_field_ntl_gf2e import FiniteField_ntl_gf2e\n>  \n>  from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing\n>  \n> +from sage.libs.gap.element import GapElement_FiniteField\n> +\n> ```\n> it would be good to use the `try except ... ()` so that there is no hard load-time dependency on libgap.\n\n\nthere are more importings of `GapElement_FiniteField` in this patch, i suppose you'd like to deal with them all.\n\nWhy don't we instead go the way we went with `GapElement` here, by adding `sage.libs.abc`, etc?",
    "created_at": "2022-12-01T23:27:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691385",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:30'></a>Replying to [comment:29 Matthias Köppe]:
> In this change:
> 
> ```
> --- a/src/sage/rings/finite_rings/element_ntl_gf2e.pyx
> +++ b/src/sage/rings/finite_rings/element_ntl_gf2e.pyx
> @@ -56,6 +54,11 @@ from .finite_field_ntl_gf2e import FiniteField_ntl_gf2e
>  
>  from sage.rings.polynomial.polynomial_ring_constructor import PolynomialRing
>  
> +from sage.libs.gap.element import GapElement_FiniteField
> +
> ```
> it would be good to use the `try except ... ()` so that there is no hard load-time dependency on libgap.


there are more importings of `GapElement_FiniteField` in this patch, i suppose you'd like to deal with them all.

Why don't we instead go the way we went with `GapElement` here, by adding `sage.libs.abc`, etc?



---

archive/issue_comments_691386.json:
```json
{
    "body": "<a id='comment:31'></a>Replying to [comment:30 Dima Pasechnik]:\n> Why don't we instead go the way we went with `GapElement` here, by adding `sage.libs.abc`, etc?\n\n\nThat's also fine",
    "created_at": "2022-12-01T23:34:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691386",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:31'></a>Replying to [comment:30 Dima Pasechnik]:
> Why don't we instead go the way we went with `GapElement` here, by adding `sage.libs.abc`, etc?


That's also fine



---

archive/issue_comments_691387.json:
```json
{
    "body": "<a id='comment:32'></a>Replying to [comment:31 Matthias K\u00f6ppe]:\n> Replying to [comment:30 Dima Pasechnik]:\n> > Why don't we instead go the way we went with `GapElement` here, by adding `sage.libs.abc`, etc?\n\n> \n> That's also fine\n\n\nCan we do `sage.libs.abc` as a part of #32414, on a separate ticket?\nAfter all, the current ticket is a part of #26902, which is not modularisation.",
    "created_at": "2022-12-02T09:50:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691387",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:32'></a>Replying to [comment:31 Matthias Köppe]:
> Replying to [comment:30 Dima Pasechnik]:
> > Why don't we instead go the way we went with `GapElement` here, by adding `sage.libs.abc`, etc?

> 
> That's also fine


Can we do `sage.libs.abc` as a part of #32414, on a separate ticket?
After all, the current ticket is a part of #26902, which is not modularisation.



---

archive/issue_comments_691388.json:
```json
{
    "body": "<a id='comment:33'></a>It's kind of why I suggested to use `try except ... ()` in comment:30.",
    "created_at": "2022-12-02T17:34:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691388",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:33'></a>It's kind of why I suggested to use `try except ... ()` in comment:30.



---

archive/issue_comments_691389.json:
```json
{
    "body": "<a id='comment:34'></a>Replying to [comment:33 Matthias K\u00f6ppe]:\n> It's kind of why I suggested to use `try except ... ()` in comment:30.\n\n\nbut we are not doing modularisation of libgap module here. that's why I don't want to `try:` here.",
    "created_at": "2022-12-02T18:25:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691389",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:34'></a>Replying to [comment:33 Matthias Köppe]:
> It's kind of why I suggested to use `try except ... ()` in comment:30.


but we are not doing modularisation of libgap module here. that's why I don't want to `try:` here.



---

archive/issue_comments_691390.json:
```json
{
    "body": "<a id='comment:35'></a>The ticket is introducing a modularization regression by inserting this new module-level import.",
    "created_at": "2022-12-02T18:27:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691390",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:35'></a>The ticket is introducing a modularization regression by inserting this new module-level import.



---

archive/issue_comments_691391.json:
```json
{
    "body": "<a id='comment:36'></a>Replying to [comment:35 Matthias K\u00f6ppe]:\n> The ticket is introducing a modularization regression by inserting this new module-level import.\n\n\nit replaces one modularization regression with another.\n\nThere are about 180 `from sage.libs.gap...` in Sage, I suppose none of them in `try... except block`. It's begging for a separate ticket, which is best attended to once we've replaced all pexpect GAP with libgap.",
    "created_at": "2022-12-02T19:10:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691391",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:36'></a>Replying to [comment:35 Matthias Köppe]:
> The ticket is introducing a modularization regression by inserting this new module-level import.


it replaces one modularization regression with another.

There are about 180 `from sage.libs.gap...` in Sage, I suppose none of them in `try... except block`. It's begging for a separate ticket, which is best attended to once we've replaced all pexpect GAP with libgap.



---

archive/issue_comments_691392.json:
```json
{
    "body": "<a id='comment:37'></a>There are no unprotected module-level imports from `sage.libs.gap` in sage.rings. Please don't introduce one, that's all I'm asking.",
    "created_at": "2022-12-02T20:28:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691392",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:37'></a>There are no unprotected module-level imports from `sage.libs.gap` in sage.rings. Please don't introduce one, that's all I'm asking.



---

archive/issue_comments_691393.json:
```json
{
    "body": "<a id='comment:38'></a>Replying to [comment:37 Matthias K\u00f6ppe]:\n> There are no unprotected module-level imports from `sage.libs.gap` in sage.rings. Please don't introduce one, that's all I'm asking.\n\n\nDo you mean it's OK for you to have imports in functions, say?\nE.g. in `src/sage/rings/number_field/number_field.py` there is\n`def _libgap_(self)` where `libgap` is unconditionally imported.",
    "created_at": "2022-12-02T23:30:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691393",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:38'></a>Replying to [comment:37 Matthias Köppe]:
> There are no unprotected module-level imports from `sage.libs.gap` in sage.rings. Please don't introduce one, that's all I'm asking.


Do you mean it's OK for you to have imports in functions, say?
E.g. in `src/sage/rings/number_field/number_field.py` there is
`def _libgap_(self)` where `libgap` is unconditionally imported.



---

archive/issue_comments_691394.json:
```json
{
    "body": "Changing commit from \"1c4a69fdfee7ccf9aebb40bbc29b4453852cacb1\" to \"6e5ea791a3d846cfd70d9b361f168f6c2fa66a2b\"",
    "created_at": "2022-12-03T00:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691394",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "1c4a69fdfee7ccf9aebb40bbc29b4453852cacb1" to "6e5ea791a3d846cfd70d9b361f168f6c2fa66a2b"



---

archive/issue_comments_691395.json:
```json
{
    "body": "<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-03T00:11:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691395",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:39'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691396.json:
```json
{
    "body": "<a id='comment:40'></a>Yes, that's https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies bullet point 2 \"Replace module-level imports by method-level imports.\"",
    "created_at": "2022-12-03T00:34:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691396",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:40'></a>Yes, that's https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies bullet point 2 "Replace module-level imports by method-level imports."



---

archive/issue_comments_691397.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Matthias Koeppe\"",
    "created_at": "2022-12-03T04:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691397",
    "user": "https://github.com/mkoeppe"
}
```

Changing reviewer from "" to "Matthias Koeppe"



---

archive/issue_comments_691398.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-03T04:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691398",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_691399.json:
```json
{
    "body": "<a id='comment:41'></a>LGTM, thanks.",
    "created_at": "2022-12-03T04:25:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691399",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:41'></a>LGTM, thanks.



---

archive/issue_comments_691400.json:
```json
{
    "body": "Changing branch from \"u/dimpase/rings/FFEs_to_accept_libgap\" to \"6e5ea791a3d846cfd70d9b361f168f6c2fa66a2b\"",
    "created_at": "2022-12-14T22:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691400",
    "user": "https://github.com/vbraun"
}
```

Changing branch from "u/dimpase/rings/FFEs_to_accept_libgap" to "6e5ea791a3d846cfd70d9b361f168f6c2fa66a2b"



---

archive/issue_events_089811.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-12-14T22:12:21Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34770#event-89811"
}
```



---

archive/issue_comments_691401.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-12-14T22:12:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34770",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34770#issuecomment-691401",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
