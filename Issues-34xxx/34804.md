# Issue 34804: Deprecate sage.interfaces is_...Element functions

archive/issues_034567.json:
```json
{
    "body": "Introducing a module `sage.interfaces.abc` with abstract base classes for `isinstance` testing (see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies)\n\nPart of #32414\n\nCC:  @dimpase @kwankyu\n\nReviewer: Dima Pasechnik\n\nAuthor: Matthias Koeppe, Dima Pasechnik\n\nBranch: u/mkoeppe/deprecate_sage_interfaces_is____element_functions\n\nStatus: positive_review\n\nDependencies: #34770, #34823\n\nCommit: b9eac04c741264d2731d6d0b83b43a7fdeef98a3\n\nIssue created by migration from https://trac.sagemath.org/ticket/34804\n\n",
    "created_at": "2022-11-28T18:56:02Z",
    "labels": [
        "component: refactoring"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Deprecate sage.interfaces is_...Element functions",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34804",
    "user": "https://github.com/mkoeppe"
}
```
Introducing a module `sage.interfaces.abc` with abstract base classes for `isinstance` testing (see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies)

Part of #32414

CC:  @dimpase @kwankyu

Reviewer: Dima Pasechnik

Author: Matthias Koeppe, Dima Pasechnik

Branch: u/mkoeppe/deprecate_sage_interfaces_is____element_functions

Status: positive_review

Dependencies: #34770, #34823

Commit: b9eac04c741264d2731d6d0b83b43a7fdeef98a3

Issue created by migration from https://trac.sagemath.org/ticket/34804





---

archive/issue_comments_691760.json:
```json
{
    "body": "Description changed:\n``````diff\n--- \n+++ \n@@ -1,4 +1,6 @@\n Introducing a module `sage.interfaces.abc` with abstract base classes for `isinstance` testing (see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies)\n+\n+Part of #32414\n \n Comment: 1\n \n``````\n",
    "created_at": "2022-11-28T19:00:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691760",
    "user": "https://github.com/mkoeppe"
}
```

Description changed:
``````diff
--- 
+++ 
@@ -1,4 +1,6 @@
 Introducing a module `sage.interfaces.abc` with abstract base classes for `isinstance` testing (see https://doc.sagemath.org/html/en/developer/packaging_sage_library.html#module-level-runtime-dependencies)
+
+Part of #32414
 
 Comment: 1
 
``````




---

archive/issue_comments_691761.json:
```json
{
    "body": "Changing branch from \"\" to \"u/mkoeppe/deprecate_sage_interfaces_is____element_functions\"",
    "created_at": "2022-11-29T18:11:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691761",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "" to "u/mkoeppe/deprecate_sage_interfaces_is____element_functions"



---

archive/issue_comments_691762.json:
```json
{
    "body": "Changing commit from \"\" to \"60318787933917af6759d86f02859d302b4cd559\"",
    "created_at": "2022-11-29T20:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691762",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "" to "60318787933917af6759d86f02859d302b4cd559"



---

archive/issue_comments_691763.json:
```json
{
    "body": "<a id='comment:3'></a>\n```diff\n--- a/src/sage/interfaces/gap.py\n+++ b/src/sage/interfaces/gap.py\n@@ -211,6 +211,9 @@ import platform\n import string\n import warnings\n \n+import sage.rings.abc\n+\n+\n WORKSPACE = gap_workspace_file()\n \n first_try = True\n@@ -1524,7 +1527,7 @@ def gap_reset_workspace(max_workspace_size=None, verbose=False):\n \n \n @instancedoc\n-class GapElement(GapElement_generic):\n+class GapElement(GapElement_generic, sage.rings.abc.GapElement):\n     def __getitem__(self, n):\n         \"\"\"\n         EXAMPLES::\n```\n\nthis is weird - do you mean `sage.interfaces...` there, not `sage.rings...` ?\n\n---\nNew commits:",
    "created_at": "2022-11-29T20:46:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691763",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:3'></a>
```diff
--- a/src/sage/interfaces/gap.py
+++ b/src/sage/interfaces/gap.py
@@ -211,6 +211,9 @@ import platform
 import string
 import warnings
 
+import sage.rings.abc
+
+
 WORKSPACE = gap_workspace_file()
 
 first_try = True
@@ -1524,7 +1527,7 @@ def gap_reset_workspace(max_workspace_size=None, verbose=False):
 
 
 @instancedoc
-class GapElement(GapElement_generic):
+class GapElement(GapElement_generic, sage.rings.abc.GapElement):
     def __getitem__(self, n):
         """
         EXAMPLES::
```

this is weird - do you mean `sage.interfaces...` there, not `sage.rings...` ?

---
New commits:



---

archive/issue_comments_691764.json:
```json
{
    "body": "<a id='comment:4'></a>Yes, sorry, it should be `sage.interfaces...` of course",
    "created_at": "2022-11-29T20:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691764",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:4'></a>Yes, sorry, it should be `sage.interfaces...` of course



---

archive/issue_comments_691765.json:
```json
{
    "body": "<a id='comment:5'></a>I took (corrected) pieces of this branch to #34770. So this ought to be based on the branch there.",
    "created_at": "2022-11-29T21:26:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691765",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:5'></a>I took (corrected) pieces of this branch to #34770. So this ought to be based on the branch there.



---

archive/issue_comments_691766.json:
```json
{
    "body": "Changing work_issues from \"\" to \"rebase on #34770\"",
    "created_at": "2022-11-29T22:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691766",
    "user": "https://github.com/mkoeppe"
}
```

Changing work_issues from "" to "rebase on #34770"



---

archive/issue_comments_691767.json:
```json
{
    "body": "Changing dependencies from \"\" to \"#34770\"",
    "created_at": "2022-11-29T22:04:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691767",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "" to "#34770"



---

archive/issue_comments_691768.json:
```json
{
    "body": "Changing commit from \"60318787933917af6759d86f02859d302b4cd559\" to \"8572f1576a544ac533507cbfe09811d47943b518\"",
    "created_at": "2022-12-04T21:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691768",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "60318787933917af6759d86f02859d302b4cd559" to "8572f1576a544ac533507cbfe09811d47943b518"



---

archive/issue_comments_691769.json:
```json
{
    "body": "<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2022-12-04T21:59:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691769",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:7'></a>Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_691770.json:
```json
{
    "body": "Changing dependencies from \"#34770\" to \"#34770, #34823\"",
    "created_at": "2022-12-04T22:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691770",
    "user": "https://github.com/mkoeppe"
}
```

Changing dependencies from "#34770" to "#34770, #34823"



---

archive/issue_comments_691771.json:
```json
{
    "body": "Changing work_issues from \"rebase on #34770\" to \"\"",
    "created_at": "2022-12-04T22:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691771",
    "user": "https://github.com/mkoeppe"
}
```

Changing work_issues from "rebase on #34770" to ""



---

archive/issue_comments_691772.json:
```json
{
    "body": "Changing commit from \"8572f1576a544ac533507cbfe09811d47943b518\" to \"27c8788aaea7e9e8fd3d4540ce4e56b5242d884f\"",
    "created_at": "2022-12-04T22:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691772",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "8572f1576a544ac533507cbfe09811d47943b518" to "27c8788aaea7e9e8fd3d4540ce4e56b5242d884f"



---

archive/issue_comments_691773.json:
```json
{
    "body": "<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-04T22:10:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691773",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:9'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691774.json:
```json
{
    "body": "Changing author from \"\" to \"Matthias Koeppe, ...\"",
    "created_at": "2022-12-04T22:13:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691774",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "" to "Matthias Koeppe, ..."



---

archive/issue_comments_691775.json:
```json
{
    "body": "<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-04T22:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691775",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:11'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691776.json:
```json
{
    "body": "Changing commit from \"27c8788aaea7e9e8fd3d4540ce4e56b5242d884f\" to \"106a85b699eb16eb328451fa23c2dee133362a26\"",
    "created_at": "2022-12-04T22:45:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691776",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "27c8788aaea7e9e8fd3d4540ce4e56b5242d884f" to "106a85b699eb16eb328451fa23c2dee133362a26"



---

archive/issue_comments_691777.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-12-04T22:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691777",
    "user": "https://github.com/mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_691778.json:
```json
{
    "body": "Changing author from \"Matthias Koeppe, ...\" to \"Matthias Koeppe\"",
    "created_at": "2022-12-04T22:48:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691778",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "Matthias Koeppe, ..." to "Matthias Koeppe"



---

archive/issue_comments_691779.json:
```json
{
    "body": "<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-04T23:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691779",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:13'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691780.json:
```json
{
    "body": "Changing commit from \"106a85b699eb16eb328451fa23c2dee133362a26\" to \"2604174d0ad2a7825d356ce8c219033cbf96eb96\"",
    "created_at": "2022-12-04T23:40:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691780",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "106a85b699eb16eb328451fa23c2dee133362a26" to "2604174d0ad2a7825d356ce8c219033cbf96eb96"



---

archive/issue_comments_691781.json:
```json
{
    "body": "<a id='comment:14'></a>New commits:",
    "created_at": "2022-12-05T09:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691781",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:14'></a>New commits:



---

archive/issue_comments_691782.json:
```json
{
    "body": "Changing branch from \"u/mkoeppe/deprecate_sage_interfaces_is____element_functions\" to \"u/dimpase/deprecate_sage_interfaces_is____element_functions\"",
    "created_at": "2022-12-05T09:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691782",
    "user": "https://github.com/dimpase"
}
```

Changing branch from "u/mkoeppe/deprecate_sage_interfaces_is____element_functions" to "u/dimpase/deprecate_sage_interfaces_is____element_functions"



---

archive/issue_comments_691783.json:
```json
{
    "body": "Changing commit from \"2604174d0ad2a7825d356ce8c219033cbf96eb96\" to \"b4d5d5b94f175a8171abe0bc0cc5c3e6fe69df2f\"",
    "created_at": "2022-12-05T09:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691783",
    "user": "https://github.com/dimpase"
}
```

Changing commit from "2604174d0ad2a7825d356ce8c219033cbf96eb96" to "b4d5d5b94f175a8171abe0bc0cc5c3e6fe69df2f"



---

archive/issue_comments_691784.json:
```json
{
    "body": "Changing reviewer from \"\" to \"Dima Pasechnik\"",
    "created_at": "2022-12-05T09:47:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691784",
    "user": "https://github.com/dimpase"
}
```

Changing reviewer from "" to "Dima Pasechnik"



---

archive/issue_comments_691785.json:
```json
{
    "body": "<a id='comment:15'></a>we have still only a fraction done:\n\n```\nAxiom            ?\nExpect           ?\nFriCAS           ?\nGap              done\nGp               done\nInterface        ?\nKash             ?\nLiE              ?\nLisp             ?\nMacaulay2        done\nMagma            ?\nMaxima           ?\nMaximaLib        ?\nR                ?\nSingular         done\n```",
    "created_at": "2022-12-05T10:44:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691785",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:15'></a>we have still only a fraction done:

```
Axiom            ?
Expect           ?
FriCAS           ?
Gap              done
Gp               done
Interface        ?
Kash             ?
LiE              ?
Lisp             ?
Macaulay2        done
Magma            ?
Maxima           ?
MaximaLib        ?
R                ?
Singular         done
```



---

archive/issue_comments_691786.json:
```json
{
    "body": "<a id='comment:16'></a>How about an implementation with a decorator:\n\n```python\nr\"\"\"\nAbstract base classes for interface elements\n\"\"\"\ndef _add_doc():\n    def wrapped(c):\n        c.__doc__ = \"\\n Abstract base class for :class:`~sage.interfaces.gap.\" + c.__name__\n        c.__doc__ += \"\"\"\n    \n  This class is defined for the purpose of ``isinstance`` tests.  It should not be\n  instantiated.\n\n  EXAMPLES:\n\n  By design, there is a unique direct subclass::\n\n  \"\"\"\n        c.__doc__ += \"    sage: len(sage.interfaces.abc.\"+c.__name__+\".__subclasses__()) <= 1\\n      True\"\n        return c\n    return wrapped\n\n\n@_add_doc()\nclass GapElement: pass\n\n\n@_add_doc()\nclass GpElement: pass\n\n...\n```\n\nNeedless to say, docstrings etc work as they should this way. Decorator overhead - very small, if at all, IMHO.",
    "created_at": "2022-12-05T12:24:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691786",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:16'></a>How about an implementation with a decorator:

```python
r"""
Abstract base classes for interface elements
"""
def _add_doc():
    def wrapped(c):
        c.__doc__ = "\n Abstract base class for :class:`~sage.interfaces.gap." + c.__name__
        c.__doc__ += """
    
  This class is defined for the purpose of ``isinstance`` tests.  It should not be
  instantiated.

  EXAMPLES:

  By design, there is a unique direct subclass::

  """
        c.__doc__ += "    sage: len(sage.interfaces.abc."+c.__name__+".__subclasses__()) <= 1\n      True"
        return c
    return wrapped


@_add_doc()
class GapElement: pass


@_add_doc()
class GpElement: pass

...
```

Needless to say, docstrings etc work as they should this way. Decorator overhead - very small, if at all, IMHO.



---

archive/issue_comments_691787.json:
```json
{
    "body": "<a id='comment:17'></a>Doctests are discovered by parsing files; they cannot be supplied by decorators.",
    "created_at": "2022-12-05T17:33:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691787",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:17'></a>Doctests are discovered by parsing files; they cannot be supplied by decorators.



---

archive/issue_comments_691788.json:
```json
{
    "body": "Changing author from \"Matthias Koeppe\" to \"Matthias Koeppe, Dima Pasechnik\"",
    "created_at": "2022-12-05T17:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691788",
    "user": "https://github.com/mkoeppe"
}
```

Changing author from "Matthias Koeppe" to "Matthias Koeppe, Dima Pasechnik"



---

archive/issue_comments_691789.json:
```json
{
    "body": "Changing branch from \"u/dimpase/deprecate_sage_interfaces_is____element_functions\" to \"u/mkoeppe/deprecate_sage_interfaces_is____element_functions\"",
    "created_at": "2022-12-05T17:45:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691789",
    "user": "https://github.com/mkoeppe"
}
```

Changing branch from "u/dimpase/deprecate_sage_interfaces_is____element_functions" to "u/mkoeppe/deprecate_sage_interfaces_is____element_functions"



---

archive/issue_comments_691790.json:
```json
{
    "body": "<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-05T17:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691790",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:20'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691791.json:
```json
{
    "body": "Changing commit from \"b4d5d5b94f175a8171abe0bc0cc5c3e6fe69df2f\" to \"31128eedbd44371856f5062e0a46cd3de5852a7d\"",
    "created_at": "2022-12-05T17:51:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691791",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "b4d5d5b94f175a8171abe0bc0cc5c3e6fe69df2f" to "31128eedbd44371856f5062e0a46cd3de5852a7d"



---

archive/issue_comments_691792.json:
```json
{
    "body": "<a id='comment:21'></a>The remaining is_... functions are not used anywhere",
    "created_at": "2022-12-05T17:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691792",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:21'></a>The remaining is_... functions are not used anywhere



---

archive/issue_comments_691793.json:
```json
{
    "body": "<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-05T18:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691793",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:22'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691794.json:
```json
{
    "body": "Changing commit from \"31128eedbd44371856f5062e0a46cd3de5852a7d\" to \"56b8bf6829e797a03f95bb0e4bca44fc81484376\"",
    "created_at": "2022-12-05T18:01:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691794",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "31128eedbd44371856f5062e0a46cd3de5852a7d" to "56b8bf6829e797a03f95bb0e4bca44fc81484376"



---

archive/issue_comments_691795.json:
```json
{
    "body": "Changing commit from \"56b8bf6829e797a03f95bb0e4bca44fc81484376\" to \"4cd6a826dc7207ac7d5dcdb11ddf9776ada4e5dd\"",
    "created_at": "2022-12-05T18:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691795",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "56b8bf6829e797a03f95bb0e4bca44fc81484376" to "4cd6a826dc7207ac7d5dcdb11ddf9776ada4e5dd"



---

archive/issue_comments_691796.json:
```json
{
    "body": "<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-05T18:04:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691796",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:23'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691797.json:
```json
{
    "body": "<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-05T18:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691797",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:24'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691798.json:
```json
{
    "body": "Changing commit from \"4cd6a826dc7207ac7d5dcdb11ddf9776ada4e5dd\" to \"e957fc9292401d99e4b1cf0a5636c3599a0f436a\"",
    "created_at": "2022-12-05T18:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691798",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "4cd6a826dc7207ac7d5dcdb11ddf9776ada4e5dd" to "e957fc9292401d99e4b1cf0a5636c3599a0f436a"



---

archive/issue_comments_691799.json:
```json
{
    "body": "<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-12-05T18:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691799",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

<a id='comment:25'></a>Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_691800.json:
```json
{
    "body": "Changing commit from \"e957fc9292401d99e4b1cf0a5636c3599a0f436a\" to \"b9eac04c741264d2731d6d0b83b43a7fdeef98a3\"",
    "created_at": "2022-12-05T18:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691800",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Changing commit from "e957fc9292401d99e4b1cf0a5636c3599a0f436a" to "b9eac04c741264d2731d6d0b83b43a7fdeef98a3"



---

archive/issue_comments_691801.json:
```json
{
    "body": "<a id='comment:26'></a>Green checks, ready for review",
    "created_at": "2022-12-05T22:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691801",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:26'></a>Green checks, ready for review



---

archive/issue_comments_691802.json:
```json
{
    "body": "<a id='comment:27'></a>Replying to [comment:17 Matthias K\u00f6ppe]:\n> Doctests are discovered by parsing files; they cannot be supplied by decorators.\n\n\nYes, they can. In fact, very easy to amend and doctest the docstring of a function:\n\n```\n$ cat d.py \ndef docstr(f):\n    \"\"\"\n    amends the docstring\n    \"\"\"\n    f.__doc__ += \"\"\"\n    >>> tst(1)\n    42\n    \"\"\"\n    return f\n\n@docstr\ndef tst(x):\n    '''adds 1 to x\n    >>> tst(0)\n    1\n    >>> tst(42)\n    42 \n    '''\n    return x+1\n\nif __name__ == '__main__':\n    import doctest\n    doctest.testmod()\n$\n$ python3 d.py \n**********************************************************************\nFile \"/tmp/d.py\", line 16, in __main__.tst\nFailed example:\n    tst(42)\nExpected:\n    42 \nGot:\n    43\n**********************************************************************\nFile \"/tmp/d.py\", line 19, in __main__.tst\nFailed example:\n    tst(1)\nExpected:\n    42\nGot:\n    2\n**********************************************************************\n1 items had failures:\n   2 of   3 in __main__.tst\n```\n\nSee, the original `tst()` had 2 doctests, one was added by ``@`docstr` - and 3 were tested.\nSo it's perfectly doable for functions.\n\nAs a sanity check:\n\n```\n$ ipython3 \nPython 3.9.2 (default, Feb 28 2021, 17:03:44) \nType 'copyright', 'credits' or 'license' for more information\nIPython 7.20.0 -- An enhanced Interactive Python. Type '?' for help.\n\nIn [1]: from d import  *\n\nIn [2]: tst?\nDocstring:\nadds 1 to x\n>>> tst(0)\n1\n>>> tst(42)\n42 \n\n>>> tst(1)\n42\nFile:      /tmp/d.py\nType:      function\n```\n\n---\n\nAs we see, doctests are run on `__doc__` attributes of functions, not by scraping the text of the file.",
    "created_at": "2022-12-06T09:41:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691802",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:27'></a>Replying to [comment:17 Matthias KÃ¶ppe]:
> Doctests are discovered by parsing files; they cannot be supplied by decorators.


Yes, they can. In fact, very easy to amend and doctest the docstring of a function:

```
$ cat d.py 
def docstr(f):
    """
    amends the docstring
    """
    f.__doc__ += """
    >>> tst(1)
    42
    """
    return f

@docstr
def tst(x):
    '''adds 1 to x
    >>> tst(0)
    1
    >>> tst(42)
    42 
    '''
    return x+1

if __name__ == '__main__':
    import doctest
    doctest.testmod()
$
$ python3 d.py 
**********************************************************************
File "/tmp/d.py", line 16, in __main__.tst
Failed example:
    tst(42)
Expected:
    42 
Got:
    43
**********************************************************************
File "/tmp/d.py", line 19, in __main__.tst
Failed example:
    tst(1)
Expected:
    42
Got:
    2
**********************************************************************
1 items had failures:
   2 of   3 in __main__.tst
```

See, the original `tst()` had 2 doctests, one was added by ``@`docstr` - and 3 were tested.
So it's perfectly doable for functions.

As a sanity check:

```
$ ipython3 
Python 3.9.2 (default, Feb 28 2021, 17:03:44) 
Type 'copyright', 'credits' or 'license' for more information
IPython 7.20.0 -- An enhanced Interactive Python. Type '?' for help.

In [1]: from d import  *

In [2]: tst?
Docstring:
adds 1 to x
>>> tst(0)
1
>>> tst(42)
42 

>>> tst(1)
42
File:      /tmp/d.py
Type:      function
```

---

As we see, doctests are run on `__doc__` attributes of functions, not by scraping the text of the file.



---

archive/issue_comments_691803.json:
```json
{
    "body": "<a id='comment:28'></a>And it works, in vanilla Python 3.9, with classes too:\n\n```python\ndef docstr(f):\n    \"\"\"\n    amends the docstring\n    \"\"\"\n    f.__doc__ += \"\"\"\n    >>> len(tst.__subclasses__()) > 0\n    True\n    \"\"\"\n    return f\n\n@docstr\nclass tst:\n    '''testing\n    >>> len(tst.__subclasses__()) <= 1\n    True\n    '''\n    pass\n\nif __name__ == '__main__':\n    import doctest\n    doctest.testmod()\n```\nand so we see 2 doctests being run, one from the class body, one added by the decorator.\n\n```\n$ python3 c.py \n**********************************************************************\nFile \"/tmp/c.py\", line 17, in __main__.tst\nFailed example:\n    len(tst.__subclasses__()) > 0\nExpected:\n    True\nGot:\n    False\n**********************************************************************\n1 items had failures:\n   1 of   2 in __main__.tst\n***Test Failed*** 1 failures.\n```\n(You can easily modify this so that the class has empty `__doc__`, then one can create it in the decorator, so it's all sane here in vanilla Python).\n\n\nI can only conclude that Sage's doctest system is borked at this point,and somehow\ndoes a non-vanilla thing. \nIndeed,  `sage -t c.py` does not see the doctests added by the decorator.",
    "created_at": "2022-12-06T10:12:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691803",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:28'></a>And it works, in vanilla Python 3.9, with classes too:

```python
def docstr(f):
    """
    amends the docstring
    """
    f.__doc__ += """
    >>> len(tst.__subclasses__()) > 0
    True
    """
    return f

@docstr
class tst:
    '''testing
    >>> len(tst.__subclasses__()) <= 1
    True
    '''
    pass

if __name__ == '__main__':
    import doctest
    doctest.testmod()
```
and so we see 2 doctests being run, one from the class body, one added by the decorator.

```
$ python3 c.py 
**********************************************************************
File "/tmp/c.py", line 17, in __main__.tst
Failed example:
    len(tst.__subclasses__()) > 0
Expected:
    True
Got:
    False
**********************************************************************
1 items had failures:
   1 of   2 in __main__.tst
***Test Failed*** 1 failures.
```
(You can easily modify this so that the class has empty `__doc__`, then one can create it in the decorator, so it's all sane here in vanilla Python).


I can only conclude that Sage's doctest system is borked at this point,and somehow
does a non-vanilla thing. 
Indeed,  `sage -t c.py` does not see the doctests added by the decorator.



---

archive/issue_comments_691804.json:
```json
{
    "body": "<a id='comment:29'></a>I've opened #34828 to fix the doctest issue in comment:28",
    "created_at": "2022-12-06T11:20:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691804",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:29'></a>I've opened #34828 to fix the doctest issue in comment:28



---

archive/issue_comments_691805.json:
```json
{
    "body": "<a id='comment:30'></a>Let's not wait for that to be fixed",
    "created_at": "2022-12-06T18:48:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691805",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:30'></a>Let's not wait for that to be fixed



---

archive/issue_comments_691806.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-06T21:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691806",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_691807.json:
```json
{
    "body": "<a id='comment:31'></a>lgtm",
    "created_at": "2022-12-06T21:20:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691807",
    "user": "https://github.com/dimpase"
}
```

<a id='comment:31'></a>lgtm



---

archive/issue_comments_691808.json:
```json
{
    "body": "<a id='comment:32'></a>Thank you!",
    "created_at": "2022-12-06T21:22:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34804",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34804#issuecomment-691808",
    "user": "https://github.com/mkoeppe"
}
```

<a id='comment:32'></a>Thank you!
