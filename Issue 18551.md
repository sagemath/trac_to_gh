# Issue 18551: Reorganize /build

Issue created by migration from https://trac.sagemath.org/ticket/18788

Original creator: vbraun

Original creation time: 2015-06-25 20:15:38

CC:  jdemeyer

Proposal: Make /build the root for the `sage_bootstrap` Python module
* /build/sage_bootstrap/...
* /build/bin/sage-package
* /build/setup.py
* /build/tox.ini

Keep the current package metadata at 
* /build/pkgs/...

Move the makefile stuff to
* /build/make/Makefile
* /build/make/deps
* /build/make/install
* /build/make/...


---

Comment by vbraun created at 2015-06-27 23:03:05

Changing type from PLEASE CHANGE to enhancement.


---

Comment by vbraun created at 2015-06-27 23:03:05

Note to self: this will require an updated confball
----
New commits:


---

Comment by vbraun created at 2015-06-27 23:03:05

Changing component from PLEASE CHANGE to build.


---

Comment by jdemeyer created at 2015-06-28 08:05:43

FYI: this conflicts heavily with #18710.


---

Comment by git created at 2015-06-28 09:09:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-28 09:23:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-06-28 09:40:14

IMHO the pipestatus and install scripts are just a symptom of the makefile hack. They should be removed when we switch to a sane build system, so they shouldn't be in build/bin


---

Comment by git created at 2015-06-28 13:55:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2015-06-28 13:57:02

The last commit fixes the doctest failure introduced in #18710 (but only triggered after build from scratch):

```
sage -t --warn-long 27.4 src/sage/misc/package.py
**********************************************************************
File "src/sage/misc/package.py", line 193, in sage.misc.package.is_package_installed
Failed example:
    is_package_installed('sage')
Expected:
    True
Got:
    False
**********************************************************************
1 item had failures:
   1 of   4 in sage.misc.package.is_package_installed
    [15 tests, 1 failure, 0.08 s]
```



---

Comment by vbraun created at 2015-06-28 13:57:22

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2015-06-28 19:08:10

Replying to [comment:7 vbraun]:
> IMHO the pipestatus and install scripts are just a symptom of the makefile hack. They should be removed when we switch to a sane build system, so they shouldn't be in build/bin

For the record: I don't think makefiles are a hack. The current system surely is far from perfect, but it actually does work pretty well.


---

Comment by jdemeyer created at 2015-06-28 19:10:09

Replying to [comment:10 vbraun]:
> The last commit fixes the doctest failure introduced in #18710 (but only triggered after build from scratch):
> {{{
> sage -t --warn-long 27.4 src/sage/misc/package.py
> **********************************************************************
> File "src/sage/misc/package.py", line 193, in sage.misc.package.is_package_installed
> Failed example:
>     is_package_installed('sage')
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> 1 item had failures:
>    1 of   4 in sage.misc.package.is_package_installed
>     [15 tests, 1 failure, 0.08 s]
> }}}

I don't think this commit should be on this ticket, but on a separate blocker ticket with just this one commit.

Also: don't you test building from scratch when closing a ticket?


---

Comment by jdemeyer created at 2015-06-28 19:15:26

In case I haven't made it sufficiently clear on #18748: I am still against the fact that you first create `src/sage_bootstrap/sage_bootstrap` on #18748 and then immediately move it to `build/sage_bootstrap` on this ticket. This is just making things needlessly complicated.


---

Comment by vbraun created at 2015-06-28 19:25:12

Well we just saw that the current system can't do reliable incremental builds, I think that this is pretty bad. That was ok 20 years ago but today this is hardly state of the art.

For the record, I'm only doing incremental builds for each ticket on the buildbot. In addition, there is a weekly full build.

You can review both tickets at the same time if the location of `sage_bootstrap` irks you.


---

Comment by jdemeyer created at 2015-06-29 06:02:38

Replying to [comment:15 vbraun]:
> Well we just saw that the current system can't do reliable incremental builds
What do you refer to?


---

Comment by jdemeyer created at 2015-06-29 06:07:01

Replying to [comment:13 jdemeyer]:
> I don't think this commit should be on this ticket, but on a separate blocker ticket with just this one commit.
See #18806 instead.


---

Comment by vbraun created at 2015-06-29 08:17:10

Replying to [comment:16 jdemeyer]:
> Replying to [comment:15 vbraun]:
> > Well we just saw that the current system can't do reliable incremental builds
> What do you refer to?

I refer to #18710 working fine on incremental builds but breaking full builds. By definition, that means our build system cannot reliably do incremental builds. Really, the build system has one job to do and it failed at it. Essentially, improper handling of build artifacts. Thats ok if you have a small library, but it hurts when a full rebuild takes an hour, and it makes truly large-scale software projects impossible (e.g. google built blaze/bazel when they hit that wall with makefiles).


---

Comment by jdemeyer created at 2015-06-29 09:42:18

Replying to [comment:18 vbraun]:
> I refer to #18710 working fine on incremental builds but breaking full builds.
So the fact that one ticket changing the build system breaks it proves that it's not reliable?

What do you want, a build system that is impossible to break when changing it?


---

Comment by vbraun created at 2015-06-29 09:50:01

Yes. There are various open/free implementations that do precisely that, so why shouldn't we?


---

Comment by git created at 2015-07-04 09:36:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-07-14 08:09:47

Squashed on top of #18748 for easier reviewing.
----
New commits:


---

Comment by git created at 2015-07-14 08:44:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-07-14 09:05:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2015-07-14 09:09:12

This looks okay to me now, what remains is testing.


---

Comment by jdemeyer created at 2015-07-14 13:23:03

Seems to work...

I give positive_review to your commit, somebody needs to review mine.


---

Comment by vbraun created at 2015-07-14 17:25:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-15 08:59:07

Resolution: fixed


---

Comment by vbraun created at 2015-07-15 09:17:58

wrong path in sage-sdist


---

Comment by vbraun created at 2015-07-15 09:17:58

Changing status from closed to new.


---

Comment by vbraun created at 2015-07-15 09:17:58

Resolution changed from fixed to 


---

Comment by vbraun created at 2015-07-15 09:22:42

Changing status from new to needs_review.


---

Comment by vbraun created at 2015-07-15 09:22:42

New commits:


---

Comment by jdemeyer created at 2015-07-15 19:40:01

The `sage-sdist` fix is obviously ok.

But I'm confused with the git history, did you just completely forget about my branch? If that was a mistake, I give positive review to your last commit cherry-picked onto my branch.


---

Comment by git created at 2015-07-15 19:54:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by vbraun created at 2015-07-15 19:55:01

thanks, forgot to pull...


---

Comment by vbraun created at 2015-07-15 19:55:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-07-15 20:07:55

Resolution: fixed
