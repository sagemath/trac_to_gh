# Issue 13285: Some refactoring of sage-bdist

Issue created by migration from https://trac.sagemath.org/ticket/13457

Original creator: jdemeyer

Original creation time: 2012-09-13 06:43:59

Assignee: leif




---

Comment by jdemeyer created at 2012-09-13 06:54:40

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2012-09-13 22:17:04

If you feel like doing a little more:

```diff
diff --git a/sage-bdist b/sage-bdist
--- a/sage-bdist
+++ b/sage-bdist
@@ -32,10 +32,8 @@ TARGET=sage-"$SAGE_VERSION"-`uname -m`-`
 TARGET=`echo $TARGET | sed 's/ //g'`   # Remove spaces
 TMP="$CUR/tmp/$TARGET"
 
-mkdir -p "$CUR/tmp"
-
 rm -rf "$TMP"
-mkdir "$TMP"
+mkdir -p "$TMP"
 
 # copy sage root repo over:
 cd "$SAGE_ROOT"
@@ -72,15 +70,14 @@ if [ -d devel/sage ]; then
     ln -sf ../../../../devel/sage/build/sage .
 fi
 
+cd "$SAGE_ROOT"
+
 if [ -d devel/sagenb ]; then
     echo "Copying Sage Notebook"
     cp $CP_OPT -L devel/sagenb "$TMP/devel/sagenb-main"
     ln -s sagenb-main "$TMP/devel/sagenb"
 fi
 
-
-cd "$SAGE_ROOT"
-
 if [ -d "$PKGDIR" ]; then
    echo "Making empty spkg's"
    cd "$PKGDIR"
```

The last two changes are actually crucial: you need a `cd "$SAGE_ROOT"` before line 75 because otherwise, the working directory is wrong and the `if [ -d devel/sagenb ]` block doesn't execute.

I'll try to keep looking at this.


---

Comment by jdemeyer created at 2012-09-13 22:31:41

Fixed.

Note that the main motivation for this ticket is as prerequisite of #13123.


---

Comment by jhpalmieri created at 2012-09-14 01:15:00

The new patch looks identical to the old patch.


---

Comment by jdemeyer created at 2012-09-14 06:53:38

I accidentally made the fixes to the wrong patch.  I'm working on too many tickets at the same time...


---

Comment by jdemeyer created at 2012-09-14 06:59:16

Fixed (for real this time).


---

Comment by jhpalmieri created at 2012-09-15 05:48:38

When I run this on OpenSolaris, I see lots of warning messages like

```
Copying files over to tmp directory
cp: Failed to set acl entries on /export/home/palmieri/testing/sage-5.3.beta2/tmp/sage-5.3.X-i86pc-SunOS//local/include/csage
cp: Failed to set acl entries on /export/home/palmieri/testing/sage-5.3.beta2/tmp/sage-5.3.X-i86pc-SunOS//local/lib/libreadline.so
```

As far as I can tell, the only consequence of this is that the various symbolic links in local/lib end up with new modification times. If I'm right, we can ignore the warnings. The resulting binary seems to work just fine. What do you think?

Also, the verbose flag in `tar zcvf ...` is unneeded, in my opinion, although I guess it's nice to see some indication of progress while the tar.gz file is being created.


---

Attachment

I haven't looked at the OpenSolaris issues, but in any case it's not a regression of this ticket.

Agree on removing the `tar v` flag, new patch needs review.


---

Comment by jhpalmieri created at 2012-09-17 02:45:23

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2012-09-17 02:45:23

Okay, good.


---

Comment by jdemeyer created at 2012-09-18 06:40:42

Resolution: fixed
