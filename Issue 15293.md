# Issue 15293: Add support for python 3.3+

Issue created by migration from Trac.

Original creator: ohanar

Original creation time: 2013-12-17 02:41:38

In order to support python 3.3, the following needs to be fixed:

1. #15510 - upgrade to a newer version of setuptools
1. #15511 - upgrade to a newer version of rpy2
1. #15512 - upgrade to a newer version of sympy


---

Comment by tscrim created at 2013-12-26 16:08:00

Changing status from new to needs_review.


---

Comment by tscrim created at 2013-12-26 16:08:00

It looks like everything is done. Now we just need to switch Sage to python 3...


---

Comment by ohanar created at 2013-12-26 21:29:59

Changing status from needs_review to needs_work.


---

Comment by ohanar created at 2013-12-26 21:29:59

Sorry, I should have put a note that I haven't listed all issues (since I haven't even encountered all the issues yet).


---

Comment by jason created at 2014-04-25 16:56:40

Python 3.4 is out now...

(really just commenting to subscribe to updates)


---

Comment by aapitzsch created at 2014-11-16 10:53:05

Changing keywords from "" to "python3".


---

Comment by fbissey created at 2015-01-09 01:57:08

We had to abandon the idea of using distutils for libcsage at least as is. We could certainly use getting rid of scons for it. Do we know if there is anyone currently active for polybori? My understanding is that Alexander Dreyer has gone to the industry and no one has really taken over polybori.


---

Comment by ohanar created at 2015-01-09 02:10:17

Replying to [comment:31 fbissey]:
> We had to abandon the idea of using distutils for libcsage at least as is.
There was also a autotools approach at #15594, which I think could be returned to (it was closed as won't fix in favor of distutils).


> We could certainly use getting rid of scons for it. Do we know if there is anyone currently active for polybori? My understanding is that Alexander Dreyer has gone to the industry and no one has really taken over polybori.

I don't really know the situation, from an outsiders perspective, it certainly looks as if the project is dead. I don't really know how best to deal with it.


---

Comment by fbissey created at 2015-01-09 02:23:06

Yes we closed the autotools ticket when we decided to go distutils. And then we found that distutils couldn't be used that way. So we should try to revive that.

Someone should try to contact Alexander or Michael Brickenstein to see if they will make any new releases. As I see it the first problem will be to remove scons as the build system for polybori. Autotools+distutils feels like the right option for it. Then we could work out the python3 migration. Removing polybori would be interesting too but I think it is ingrained deep in sage.


---

Comment by ohanar created at 2015-01-09 02:31:48

Replying to [comment:33 fbissey]:
> Someone should try to contact Alexander or Michael Brickenstein to see if they will make any new releases. As I see it the first problem will be to remove scons as the build system for polybori. Autotools+distutils feels like the right option for it. Then we could work out the python3 migration. Removing polybori would be interesting too but I think it is ingrained deep in sage.

I don't think it is too deeply integrated into sage, it seems like it is mainly used for boolean polynomial rings (which themselves don't seem to be very widely used in the sage library). If it is easier to make a version of sage compatible with python 3 which doesn't have polybori, than it is to bring polybori up to speed, I would definitely vote for the former (especially if it is significantly easier, which I suspect might be the case ... but I could be completely wrong). In either case, I would keep polybori around for the python 2 version of sage.


---

Comment by fbissey created at 2015-05-05 23:38:30

Something for which there is no ticket yet but shouldn't be forgotten. pynac is python2.7 only last time I checked. `ginac/numeric.cpp` needs a significant overhaul to move to python3, some of which I think I could do but some other like the rich cmp I wouldn't.


---

Comment by kcrisman created at 2015-05-06 01:01:25

> Something for which there is no ticket yet but shouldn't be forgotten. pynac is python2.7 only last time I checked. `ginac/numeric.cpp` needs a significant overhaul to move to python3, some of which I think I could do but some other like the rich cmp I wouldn't.

rws, you've been doing great work recently with a lot of the nitty-gritty stuff in Pynac - any ideas?  We could at least open a ticket if this is not too impossible.


---

Comment by ohanar created at 2015-05-06 01:54:14

I was looking at porting pynac to python 3 a few weeks ago, and it doesn't look too bad (even the rich comp stuff, but I could always be wrong). I was either going to work on this or see if I can't figure something to do with polybori and python 3 during Sage Days 64.25.


---

Comment by rws created at 2015-05-06 06:23:28

I'm only starting now to get into Pynac's Python interface. I also have no idea which changes are necessary because of Python 3. So, if you cannot give me at least a lead by opening a detailed Pynac ticket then don't expect rapid progress there.


---

Comment by fbissey created at 2015-05-06 12:05:19

OK so I opened a pynac issue at https://github.com/pynac/pynac/issues/42 and I'll start making pull requests for what I can fix as I go along.


---

Comment by rws created at 2015-05-07 13:42:22

The pynac issue is now fixed in pynac master, pending a full Py3 doctest of Sage.


---

Comment by fbissey created at 2015-05-08 00:18:34

Pending insulation of polybori or making it python3.4 compatible and modest hacking (in pynac and libcsage) I should be able to make a version of sage-on-gentoo that will install sage for both python 2.7 and 3.4 and test things further. I see polybori as the biggest hurdle, finishing the integration of libcsage would help too but polybori is really the biggest problem as far as I can see.


---

Comment by vbraun created at 2015-05-09 10:04:24

There is some progress on scons to move to python 3 (http://thread.gmane.org/gmane.comp.programming.tools.scons.devel/12929). Still, I think thats the least of the problems. If scons doesn't get support in time we can just build Python 2 + Python 3 and use python2 for scons at build time.


---

Comment by fbissey created at 2015-05-09 10:24:20

Replying to [comment:44 vbraun]:
> There is some progress on scons to move to python 3 (http://thread.gmane.org/gmane.comp.programming.tools.scons.devel/12929). Still, I think thats the least of the problems. If scons doesn't get support in time we can just build Python 2 + Python 3 and use python2 for scons at build time.

I agree in principle but scons is potentially not the only problem in polybori.


---

Comment by fbissey created at 2015-05-09 10:34:47

First attempt to get `scons` to install `polybori` as a python 3.4 thing failed. `SConstruct` is relying on the version of python running `scons` as being the version you should use I think. That leads to a number of odd behavior and misdetections very fast.


---

Comment by ohanar created at 2015-05-18 08:02:28

fyi, I started working on an autotools based build system for polybori at https://github.com/ohanar/PolyBoRi/tree/autotools. I'll probably work on it a bit more next weekend during SD 64.25, but the important bits (the c++ libraries) are currently working with only a couple of hacks. What remains (for sage at least) is just a little cleanup and throwing in the bit of the python bindings we use. I've created #18437 for future discussion of polybori and python 3.


---

Comment by jdemeyer created at 2015-06-06 09:18:06

Does now every standard package except polybori support Python 3?


---

Comment by fbissey created at 2015-06-06 09:23:41

I think so. The current `pexpect` would be the other problematic one but the current has been patched to use `six` to support python 3 if we don't upgrade it to 3.3 + patch (#10295).


---

Comment by aapitzsch created at 2015-06-06 10:15:45

Replying to [comment:49 jdemeyer]:
> Does now every standard package except polybori support Python 3?
The Sphinx release notes for [1.3b1](http://sphinx-doc.org/changes.html#release-1-3b1-released-oct-10-2014) mention `Add support for Python 3.4.` So I assume this version is not supported by the Sphinx 1.2.2 which is currently shipped with Sage. #18497


---

Comment by fbissey created at 2015-06-06 10:24:05

Replying to [comment:51 aapitzsch]:
> Replying to [comment:49 jdemeyer]:
> > Does now every standard package except polybori support Python 3?
> The Sphinx release notes for [1.3b1](http://sphinx-doc.org/changes.html#release-1-3b1-released-oct-10-2014) mention `Add support for Python 3.4.` So I assume this version is not supported by the Sphinx 1.2.2 which is currently shipped with Sage. #18497

That's odd, Gentoo permits you to build and install sphinx 1.2.2 against python 3.4 without any patch. It is a stable version so I'll assume that it passes its test suite at least with python 3.4. But going to 1.3.1 would be good anyway.


---

Comment by ohanar created at 2015-06-07 01:16:45

Replying to [comment:49 jdemeyer]:
> Does now every standard package except polybori support Python 3?

Pynac doesn't really support Python 3 (it builds against Python 3, but it is almost certainly broken, since it can only really be tested when sage can be built against Python 3).


---

Comment by jdemeyer created at 2016-05-02 13:38:46

Changing component from packages: standard to python3.


---

Comment by embray created at 2018-02-23 13:17:38

Changed ticket title since we're now targeting Python 3.6 at a minimum (though most of the Python 3 work could probably go back to older Python 3's since everything is still compatible with Python 2.7).

I guess we can leave this open as there are still 2 meta-tickets associated with it that are open...


---

Comment by embray created at 2018-07-26 16:17:10

I recently ran the doctests on my python3 branch (which contains many fixes not in develop yet, though I've yet to incorporate all the existing open tickets for python3 which might lead to more improvements).  I got roughly 540 failing modules.

Out of curiosity I thought I'd try a little experiment and ran the test log through the following:


```
$ sort logs/ptest.log | uniq -c | sort -nr
```


This just gives the text that appears most frequently in the test output.  Obviously the top examples are generic things like "6461     Traceback (most recent call last):"

But beyond that there are some interesting things that might help prioritize things to fix (and maybe some of these are already fixed in open tickets).  The top 20 error messages this brings up (excluding `NameError`s) are:

* `470     TypeError: unhashable type: 'NCPolynomialIdeal'`
* `360     TypeError: unhashable type: 'HyperellipticCurve_g2_rational_field_with_category'`
* `229     TypeError: expected bytes, str found`
* `196     TypeError: object of type 'map' has no len()`
* `176     TypeError: 'dict_values' object does not support indexing`
* `176     AttributeError: attribute '__dict__' of 'type' objects is not writable` (this one I know is #24786, so I'm going to try merging that into my python3 branch and see what that helps)
* `122     TypeError: '>' not supported between instances of 'float' and 'NoneType'`
* `115     TypeError: unhashable type: 'HyperellipticCurve_padic_field_with_category'`
* `104     AttributeError: 'list' object has no attribute 'items'`
* `94     TypeError: sequence item 0: expected str instance, bytes found`
* `90     TypeError: unhashable type: 'ChowGroup_class_with_category'`
* `72     TypeError: <class 'sage.schemes.hyperelliptic_curves.hyperelliptic_g2_rational_field.HyperellipticCurve_g2_rational_field_with_category'> is not hashable and does not implement _cache_key()`
* `58     ValueError: Polyomino must be non empty`
* `58     TypeError: 'dict_keys' object is not subscriptable`
* `46     KeyError: ((<class 'sage.algebras.lie_algebras.classical_lie_algebra.LieAlgebraChevalleyBasis'>, Rational Field, ['A', 2]), ())`
* `45     TypeError: must be str, not bytes`
* `44     AttributeError: 'function' object has no attribute '__func__'`
* `44     AttributeError: 'dict' object has no attribute 'iteritems'`
* `40     KeyError: ((0, False), ())`
* `39     IndexError: tuple index out of range`

Of course, from this experiment there's often no easy way to see what the context is to these errors, an some of them might just occur hundreds of times in one module and not have a wide-reaching effect.  But it's worth looking into.  Grepping the test log for individual error messages helps give a better idea of where they might come from.


---

Comment by embray created at 2018-07-30 11:31:15

Another potentially interesting heuristic, though I haven't tested how effective this is yet is something like:


```
$ grep 'doctest.*failed' logs/ptest.log | sort -k 5 -nr | head -20
```


showing me the modules with the most failures.

On my latest python3 branch (which has all the currently open python3 tickets merged in, as well as some other fixes) I have:


```
sage -t src/sage/misc/explain_pickle.py  # 71 doctests failed
sage -t src/sage/calculus/riemann.pyx  # 67 doctests failed
sage -t src/sage/libs/lcalc/lcalc_Lfunction.pyx  # 58 doctests failed
sage -t src/sage/combinat/free_dendriform_algebra.py  # 50 doctests failed
sage -t src/sage/combinat/words/finite_word.py  # 47 doctests failed
sage -t src/doc/en/thematic_tutorials/sandpile.rst  # 45 doctests failed
sage -t src/sage/matrix/compute_J_ideal.py  # 44 doctests failed
sage -t src/sage/graphs/generic_graph.py  # 41 doctests failed
sage -t src/sage/schemes/riemann_surfaces/riemann_surface.py  # 36 doctests failed
sage -t src/sage/sandpiles/sandpile.py  # 34 doctests failed
sage -t src/sage/combinat/hillman_grassl.py  # 34 doctests failed
sage -t src/sage/combinat/cluster_algebra_quiver/quiver.py  # 33 doctests failed
sage -t src/sage/combinat/finite_state_machine.py  # 32 doctests failed
sage -t src/sage/rings/polynomial/real_roots.pyx  # 29 doctests failed
sage -t src/sage/coding/source_coding/huffman.py  # 26 doctests failed
sage -t src/sage/combinat/diagram_algebras.py  # 25 doctests failed
sage -t src/sage/matroids/matroid.pyx  # 23 doctests failed
sage -t src/sage/combinat/rigged_configurations/kr_tableaux.py  # 23 doctests failed
sage -t src/sage/combinat/cluster_algebra_quiver/cluster_seed.py  # 22 doctests failed
sage -t src/sage/graphs/graph.py  # 20 doctests failed
```


With the exception of "explain_pickle" which is kind of a special case (and one I'm not sure what to do with), my guess is that modules with many failing tests indicate something that is deeply broken enough which, if fixed, might have far reaching consequences both within that module itself, and other modules that depend on it. 

Of course this isn't always going to be the case--sometimes the failures might be very localized.  But this gives some idea of where the most effort is needed.


---

Comment by embray created at 2018-07-30 12:44:02

Well, based on the example above, I found _one_ one-line bug in `sage.calculus.riemann` (#25974) which fixed all the tests in that module, as well as 7 other modules.  Still very anecdotal, but at least one good result from that heuristic.


---

Comment by fbissey created at 2018-11-06 21:48:34

In sage-on-gentoo I get in the following trouble a lot with python3

```
      File "sage/libs/gap/util.pyx", line 199, in sage.libs.gap.util.initialize (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4452)
        s = str_to_bytes(gap_root(), FS_ENCODING, "surrogateescape")
      File "sage/libs/gap/util.pyx", line 171, in sage.libs.gap.util.gap_root (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python3_6/build/cythonized/sage/libs/gap/util.c:4232)
        gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]
    TypeError: 'filter' object is not subscriptable
```

But I am guessing that it is not seen in vanilla sage because I apply the following patch

```diff
diff --git a/sage/libs/gap/util.pyx b/sage/libs/gap/util.pyx
index 97703ff..48dc617 100644
--- a/sage/libs/gap/util.pyx
+++ b/sage/libs/gap/util.pyx
`@``@` -23,7 +23,7 `@``@` from .element cimport *
 from sage.cpython.string import FS_ENCODING
 from sage.cpython.string cimport str_to_bytes, char_to_str
 from sage.interfaces.gap_workspace import prepare_workspace_dir
-from sage.env import SAGE_LOCAL, GAP_ROOT_DIR
+from sage.env import SAGE_LOCAL
 
 
 ############################################################################
`@``@` -167,9 +167,6 `@``@` def gap_root():
         '/home/vbraun/opt/sage-5.3.rc0/local/gap/latest'
     """
     import os.path
-    if os.path.exists(GAP_ROOT_DIR):
-        return GAP_ROOT_DIR
-    print('The gap-4.5.5.spkg (or later) seems to be not installed!')
     gap_sh = open(os.path.join(SAGE_LOCAL, 'bin', 'gap')).read().splitlines()
     gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]
     gapdir = gapdir.split('"')[1]
```

vanilla never shows the problem because it uses `GAP_ROOT_DIR`, which I find an hindrance as it presuppose a way of installing `gap`, the alternate code that comes after works well enough - at least with python2. But obviously not with python3.

Any suggestions on fixing this?


---

Comment by chapoton created at 2018-11-07 19:09:48

replace

```
gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]
```

by

```
gapdir = next(dir for dir in gap_sh if dir.strip().startswith('GAP_DIR'))
```

? Please make a ticket.


---

Comment by fbissey created at 2018-11-07 19:57:00

OK will try that and create a ticket when I can. This has escaped detection so far because it is not doctested.


---

Comment by embray created at 2018-11-08 13:48:42

Replying to [comment:66 fbissey]:
> OK will try that and create a ticket when I can. This has escaped detection so far because it is not doctested.

Perhaps it should be?


---

Comment by fbissey created at 2018-11-08 19:56:47

Replying to [comment:67 embray]:
> Replying to [comment:66 fbissey]:
> > OK will try that and create a ticket when I can. This has escaped detection so far because it is not doctested.
> 
> Perhaps it should be?

Definitely.


---

Comment by fbissey created at 2018-11-08 20:04:06

Replying to [comment:65 chapoton]:
> replace
> {{{
> gapdir = filter(lambda dir:dir.strip().startswith('GAP_DIR'), gap_sh)[0]
> }}}
> by
> {{{
> gapdir = next(dir for dir in gap_sh if dir.strip().startswith('GAP_DIR'))
> }}}
> ? Please make a ticket.

That works, but to be complete, it will also need some doctest. It is now #26665.


---

Comment by dimpase created at 2019-01-10 06:58:48

Shouldn't this ticket maintain a branch of with all the positively reviewed py3-related tickets?


---

Comment by embray created at 2019-01-10 15:46:19

That might be useful: I do something like that manually anyways.


---

Comment by dimpase created at 2019-10-16 14:00:27

What are we going to do with animation support on Python 3?
It seems it is broken - the only (non-console, not sure about console though) possibility seems to be via jupyter+j(s)mol, and this
has not moved far: https://github.com/jupyter/notebook/issues/1872

See also the recent where people complain about broken animation on 8.9.
https://groups.google.com/d/msg/sage-devel/OepzKdldklU/uf2eRVWuDAAJ


---

Comment by jhpalmieri created at 2019-10-16 17:13:29

Dima, can you provide more details? For the second paragraph, the sage-devel thread gives an example of something which doesn't work in the legacy Sage notebook (their example starts with the command `notebook()`). So that's not a Python 3 problem. It also doesn't seem to be discussing animation, but maybe I'm missing something. The problem in the first paragraph is about the Jupyter notebook, and I see the same problem with both Python 2 and Python 3.


---

Comment by dimpase created at 2019-10-16 18:27:37

yes, the sage-devel thread discusses mostly sagenb, but the question is how to do the job in jupyter instead, and this appears to be a blocker, as this is a serious regression.

Disclaimer: I do not know how to do animations in Sage. If someone who knows looked into this, it would be great.


---

Comment by jhpalmieri created at 2019-10-16 19:04:49

Okay, it still feels like a Jupyter and/or JMol/threejs issue rather than a Python 3 issue.


---

Comment by dimpase created at 2019-10-16 20:05:24

it is a Python 3 issue, as one does not have sagenb there, while sagenb (at least before Sage 8.9) was able to do animations.


---

Comment by kcrisman created at 2019-11-07 14:08:31

Regarding the animation issue, see my tests on the sage-devel thread just now.  It does somehow seem to be an integration between sagenb and new j(s)mol thing.  As for "how to do animations", all they meant was "make a 3d graphic, and then try to make it movable by clicking the little circle in jmol", not using an actual animation command.  I'd encourage a few others to try using `viewer='jmol'` in Jupyter in the 9.0 series to see what happens.


---

Comment by mkoeppe created at 2020-04-12 00:51:26

Is anything left to be done here or can the ticket be closed?


---

Comment by dimpase created at 2020-09-15 11:58:07

see #30053 for a blocker for 3.x, for x<7.


---

Comment by mkoeppe created at 2020-09-15 15:22:29

Let's close this metaticket to signal the completion of the Python 3 transition.


---

Comment by mkoeppe created at 2020-09-15 15:22:29

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-09-15 16:25:06

ok, done


---

Comment by dimpase created at 2020-09-15 16:25:06

Changing status from needs_review to positive_review.


---

Comment by slelievre created at 2020-10-11 17:17:23

Resolution: fixed
