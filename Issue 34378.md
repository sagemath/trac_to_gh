# Issue 34378: Fix build with sphinx 5.2

Issue created by migration from https://trac.sagemath.org/ticket/34615

Original creator: arojas

Original creation time: 2022-09-29 19:24:08

CC:  fbissey




---

Comment by git created at 2022-09-29 19:29:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-29 19:31:11

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2022-09-29 19:31:11

Changing component from PLEASE CHANGE to build.


---

Comment by arojas created at 2022-09-29 19:31:11

Changing status from new to needs_review.


---

Comment by fbissey created at 2022-09-29 19:47:50

I haven't been pushed to 5.2 yet, so I haven't seen it. Although I could have had reports. This is quite different from the previous fix we pushed. Was it supposed to be implicit in older version of sphinx.


---

Comment by arojas created at 2022-09-29 19:58:16

No, this is a new attribute in 5.2. That's why I was surprised this still works with older sphinx

https://github.com/sphinx-doc/sphinx/commit/7da60f23539bd5d1a79bdbcf67cd5164311182b7


---

Comment by arojas created at 2022-09-29 20:03:09

Changing status from needs_review to needs_work.


---

Comment by arojas created at 2022-09-29 20:03:09

Ah, no. It does throw errors with older sphinx, although docs still seem to build fine.


---

Comment by fbissey created at 2022-09-29 20:05:12

I suggest we take the opportunity to upgrade sphinx in sage itself then. I didn't do it for 5.1 and that may have been lazy on my part :)


---

Comment by git created at 2022-09-29 21:00:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-09-29 21:15:48

I am busy this morning but if you don't do more, I'll look at the sphinx contribution packages that may need updating or- be added to sage.


---

Comment by arojas created at 2022-09-30 06:00:23

Everything builds fine and docs look OK


---

Comment by arojas created at 2022-09-30 06:00:23

Changing status from needs_work to needs_review.


---

Comment by fbissey created at 2022-10-05 09:25:18

After looking more closely, only sphinxcontrib_websupport would need a version bump.


---

Comment by fbissey created at 2022-10-05 09:59:31

New commits:


---

Comment by klee created at 2022-10-07 13:42:11

On macos, with the ticket branch merged to the develop branch, I encountered

```
[sagemath_doc_html-none]     raise DistributionNotFound(req, requirers)
[sagemath_doc_html-none] pkg_resources.DistributionNotFound: The 'imagesize>=1.3'
 distribution was not found and is required by sphinx
```



---

Comment by klee created at 2022-10-07 13:47:05

Upgrading to `imagesize-1.4.1` the latest gets it rolling.


---

Comment by klee created at 2022-10-07 20:28:05

Replying to [comment:14 Kwankyu Lee]:
> Upgrading to `imagesize-1.4.1` the latest gets it rolling.

It ended up successfully, and the built documents look good.


---

Comment by fbissey created at 2022-10-09 21:48:19

You are right, the version of imagesize was way to low in sage (1.2). Updating now.


---

Comment by git created at 2022-10-09 21:58:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2022-10-09 22:00:33

Updated imagesize and pushed sphinx to 5.2.3.


---

Comment by klee created at 2022-10-10 02:09:19

Thanks.

It works well and looks good to me.


---

Comment by klee created at 2022-10-10 02:09:19

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-10-16 22:15:42

Resolution: fixed


---

Comment by klee created at 2022-10-24 06:18:54

This upgrade seems to have introduced an unpleasant change of doc appearance. Compare

https://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/index.html

with

https://doc.sagemath.org/html/en/reference/curves/index.html

See all the second-level headings. Those weren't before.


---

Comment by klee created at 2022-10-25 01:31:05

I suspect that the upgrade does not work well with sage's custom `autodoc`.


---

Comment by fbissey created at 2022-10-25 01:34:06

Possibly, it is hardly news that we should get rid of it as quickly as we can. I wanted to ask whether you had an idea why there are subsection for say "plane conics" but not "curves"? When I tried to post yesterday, trac was in maintenance :(


---

Comment by klee created at 2022-10-25 02:32:12

Replying to [comment:24 François Bissey]:
> Possibly, it is hardly news that we should get rid of it as quickly as we can. 

I agree! But that seems a formidable task (unless we just leave the consequential "broken doc" at it is).

> I wanted to ask whether you had an idea why there are subsection for say "plane conics" but not "curves"?

It is because of the `maxdepth: 2`. See 

```
Plane conics
============

.. toctree::
   :maxdepth: 2 
```

Hence it is normal. The real problem seems that definitions doc is regarded as content headings. I don't know if this is a feature of the upgraded sphinx or a problem of `sage_autodoc`...


---

Comment by klee created at 2022-10-25 04:00:20

A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)


---

Comment by klee created at 2022-10-25 08:43:21

Replying to [comment:26 Kwankyu Lee]:
> A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)

This certainly does not solve all problems. See the "Contents" on the right

https://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/sage/schemes/plane_conics/constructor.html


---

Comment by fbissey created at 2022-10-25 08:52:05

I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.

Of course, if it is inconsistent with other pages, we have a problem.


---

Comment by klee created at 2022-10-31 04:57:22

Replying to [comment:28 François Bissey]:
> I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.

Object definitions in TOC is a new standard feature of the upgraded Sphinx. But this changes our doc in an unintended way. This is fixed now in #34706. Needs review.
