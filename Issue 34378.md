# Issue 34378: Fix build with sphinx 5.2

archive/issues_034378.json:
```json
{
    "body": "CC:  @kiwifb\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34615\n\n",
    "created_at": "2022-09-29T19:24:08Z",
    "labels": [],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Fix build with sphinx 5.2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34378",
    "user": "https://github.com/antonio-rojas"
}
```
CC:  @kiwifb



Issue created by migration from https://trac.sagemath.org/ticket/34615





---

archive/issue_comments_486704.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-29T19:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486704",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486705.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2022-09-29T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486705",
    "user": "https://github.com/antonio-rojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_486706.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2022-09-29T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486706",
    "user": "https://github.com/antonio-rojas"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_486707.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-29T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486707",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_486708.json:
```json
{
    "body": "I haven't been pushed to 5.2 yet, so I haven't seen it. Although I could have had reports. This is quite different from the previous fix we pushed. Was it supposed to be implicit in older version of sphinx.",
    "created_at": "2022-09-29T19:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486708",
    "user": "https://github.com/kiwifb"
}
```

I haven't been pushed to 5.2 yet, so I haven't seen it. Although I could have had reports. This is quite different from the previous fix we pushed. Was it supposed to be implicit in older version of sphinx.



---

archive/issue_comments_486709.json:
```json
{
    "body": "No, this is a new attribute in 5.2. That's why I was surprised this still works with older sphinx\n\nhttps://github.com/sphinx-doc/sphinx/commit/7da60f23539bd5d1a79bdbcf67cd5164311182b7",
    "created_at": "2022-09-29T19:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486709",
    "user": "https://github.com/antonio-rojas"
}
```

No, this is a new attribute in 5.2. That's why I was surprised this still works with older sphinx

https://github.com/sphinx-doc/sphinx/commit/7da60f23539bd5d1a79bdbcf67cd5164311182b7



---

archive/issue_comments_486710.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-29T20:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486710",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_486711.json:
```json
{
    "body": "Ah, no. It does throw errors with older sphinx, although docs still seem to build fine.",
    "created_at": "2022-09-29T20:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486711",
    "user": "https://github.com/antonio-rojas"
}
```

Ah, no. It does throw errors with older sphinx, although docs still seem to build fine.



---

archive/issue_comments_486712.json:
```json
{
    "body": "I suggest we take the opportunity to upgrade sphinx in sage itself then. I didn't do it for 5.1 and that may have been lazy on my part :)",
    "created_at": "2022-09-29T20:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486712",
    "user": "https://github.com/kiwifb"
}
```

I suggest we take the opportunity to upgrade sphinx in sage itself then. I didn't do it for 5.1 and that may have been lazy on my part :)



---

archive/issue_comments_486713.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-29T21:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486713",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486714.json:
```json
{
    "body": "I am busy this morning but if you don't do more, I'll look at the sphinx contribution packages that may need updating or- be added to sage.",
    "created_at": "2022-09-29T21:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486714",
    "user": "https://github.com/kiwifb"
}
```

I am busy this morning but if you don't do more, I'll look at the sphinx contribution packages that may need updating or- be added to sage.



---

archive/issue_comments_486715.json:
```json
{
    "body": "Everything builds fine and docs look OK",
    "created_at": "2022-09-30T06:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486715",
    "user": "https://github.com/antonio-rojas"
}
```

Everything builds fine and docs look OK



---

archive/issue_comments_486716.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-30T06:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486716",
    "user": "https://github.com/antonio-rojas"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_486717.json:
```json
{
    "body": "After looking more closely, only sphinxcontrib_websupport would need a version bump.",
    "created_at": "2022-10-05T09:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486717",
    "user": "https://github.com/kiwifb"
}
```

After looking more closely, only sphinxcontrib_websupport would need a version bump.



---

archive/issue_comments_486718.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-10-05T09:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486718",
    "user": "https://github.com/kiwifb"
}
```

New commits:



---

archive/issue_comments_486719.json:
```json
{
    "body": "On macos, with the ticket branch merged to the develop branch, I encountered\n\n```\n[sagemath_doc_html-none]     raise DistributionNotFound(req, requirers)\n[sagemath_doc_html-none] pkg_resources.DistributionNotFound: The 'imagesize>=1.3'\n distribution was not found and is required by sphinx\n```",
    "created_at": "2022-10-07T13:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486719",
    "user": "https://github.com/kwankyu"
}
```

On macos, with the ticket branch merged to the develop branch, I encountered

```
[sagemath_doc_html-none]     raise DistributionNotFound(req, requirers)
[sagemath_doc_html-none] pkg_resources.DistributionNotFound: The 'imagesize>=1.3'
 distribution was not found and is required by sphinx
```



---

archive/issue_comments_486720.json:
```json
{
    "body": "Upgrading to `imagesize-1.4.1` the latest gets it rolling.",
    "created_at": "2022-10-07T13:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486720",
    "user": "https://github.com/kwankyu"
}
```

Upgrading to `imagesize-1.4.1` the latest gets it rolling.



---

archive/issue_comments_486721.json:
```json
{
    "body": "Replying to [comment:14 Kwankyu Lee]:\n> Upgrading to `imagesize-1.4.1` the latest gets it rolling.\n\n\nIt ended up successfully, and the built documents look good.",
    "created_at": "2022-10-07T20:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486721",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:14 Kwankyu Lee]:
> Upgrading to `imagesize-1.4.1` the latest gets it rolling.


It ended up successfully, and the built documents look good.



---

archive/issue_comments_486722.json:
```json
{
    "body": "You are right, the version of imagesize was way to low in sage (1.2). Updating now.",
    "created_at": "2022-10-09T21:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486722",
    "user": "https://github.com/kiwifb"
}
```

You are right, the version of imagesize was way to low in sage (1.2). Updating now.



---

archive/issue_comments_486723.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-09T21:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486723",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_486724.json:
```json
{
    "body": "Updated imagesize and pushed sphinx to 5.2.3.",
    "created_at": "2022-10-09T22:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486724",
    "user": "https://github.com/kiwifb"
}
```

Updated imagesize and pushed sphinx to 5.2.3.



---

archive/issue_comments_486725.json:
```json
{
    "body": "Thanks.\n\nIt works well and looks good to me.",
    "created_at": "2022-10-10T02:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486725",
    "user": "https://github.com/kwankyu"
}
```

Thanks.

It works well and looks good to me.



---

archive/issue_comments_486726.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-10-10T02:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486726",
    "user": "https://github.com/kwankyu"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_089687.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2022-10-16T22:15:42Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/34378#event-89687"
}
```



---

archive/issue_comments_486727.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-10-16T22:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486727",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_486728.json:
```json
{
    "body": "This upgrade seems to have introduced an unpleasant change of doc appearance. Compare\n\nhttps://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/index.html\n\nwith\n\nhttps://doc.sagemath.org/html/en/reference/curves/index.html\n\nSee all the second-level headings. Those weren't before.",
    "created_at": "2022-10-24T06:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486728",
    "user": "https://github.com/kwankyu"
}
```

This upgrade seems to have introduced an unpleasant change of doc appearance. Compare

https://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/index.html

with

https://doc.sagemath.org/html/en/reference/curves/index.html

See all the second-level headings. Those weren't before.



---

archive/issue_comments_486729.json:
```json
{
    "body": "I suspect that the upgrade does not work well with sage's custom `autodoc`.",
    "created_at": "2022-10-25T01:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486729",
    "user": "https://github.com/kwankyu"
}
```

I suspect that the upgrade does not work well with sage's custom `autodoc`.



---

archive/issue_comments_486730.json:
```json
{
    "body": "Possibly, it is hardly news that we should get rid of it as quickly as we can. I wanted to ask whether you had an idea why there are subsection for say \"plane conics\" but not \"curves\"? When I tried to post yesterday, trac was in maintenance :(",
    "created_at": "2022-10-25T01:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486730",
    "user": "https://github.com/kiwifb"
}
```

Possibly, it is hardly news that we should get rid of it as quickly as we can. I wanted to ask whether you had an idea why there are subsection for say "plane conics" but not "curves"? When I tried to post yesterday, trac was in maintenance :(



---

archive/issue_comments_486731.json:
```json
{
    "body": "Replying to [comment:24 Fran\u00e7ois Bissey]:\n> Possibly, it is hardly news that we should get rid of it as quickly as we can. \n\n\nI agree! But that seems a formidable task (unless we just leave the consequential \"broken doc\" at it is).\n\n> I wanted to ask whether you had an idea why there are subsection for say \"plane conics\" but not \"curves\"?\n\n\nIt is because of the `maxdepth: 2`. See \n\n```\nPlane conics\n============\n\n.. toctree::\n   :maxdepth: 2 \n```\nHence it is normal. The real problem seems that definitions doc is regarded as content headings. I don't know if this is a feature of the upgraded sphinx or a problem of `sage_autodoc`...",
    "created_at": "2022-10-25T02:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486731",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:24 François Bissey]:
> Possibly, it is hardly news that we should get rid of it as quickly as we can. 


I agree! But that seems a formidable task (unless we just leave the consequential "broken doc" at it is).

> I wanted to ask whether you had an idea why there are subsection for say "plane conics" but not "curves"?


It is because of the `maxdepth: 2`. See 

```
Plane conics
============

.. toctree::
   :maxdepth: 2 
```
Hence it is normal. The real problem seems that definitions doc is regarded as content headings. I don't know if this is a feature of the upgraded sphinx or a problem of `sage_autodoc`...



---

archive/issue_comments_486732.json:
```json
{
    "body": "A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)",
    "created_at": "2022-10-25T04:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486732",
    "user": "https://github.com/kwankyu"
}
```

A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)



---

archive/issue_comments_486733.json:
```json
{
    "body": "Replying to [comment:26 Kwankyu Lee]:\n> A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)\n\n\nThis certainly does not solve all problems. See the \"Contents\" on the right\n\nhttps://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/sage/schemes/plane_conics/constructor.html",
    "created_at": "2022-10-25T08:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486733",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:26 Kwankyu Lee]:
> A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)


This certainly does not solve all problems. See the "Contents" on the right

https://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/sage/schemes/plane_conics/constructor.html



---

archive/issue_comments_486734.json:
```json
{
    "body": "I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.\n\nOf course, if it is inconsistent with other pages, we have a problem.",
    "created_at": "2022-10-25T08:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486734",
    "user": "https://github.com/kiwifb"
}
```

I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.

Of course, if it is inconsistent with other pages, we have a problem.



---

archive/issue_comments_486735.json:
```json
{
    "body": "Replying to [comment:28 Fran\u00e7ois Bissey]:\n> I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.\n\n\nObject definitions in TOC is a new standard feature of the upgraded Sphinx. But this changes our doc in an unintended way. This is fixed now in #34706. Needs review.",
    "created_at": "2022-10-31T04:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-486735",
    "user": "https://github.com/kwankyu"
}
```

Replying to [comment:28 François Bissey]:
> I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.


Object definitions in TOC is a new standard feature of the upgraded Sphinx. But this changes our doc in an unintended way. This is fixed now in #34706. Needs review.
