# Issue 34378: Fix build with sphinx 5.2

archive/issues_034378.json:
```json
{
    "body": "CC:  fbissey\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/34615\n\n",
    "created_at": "2022-09-29T19:24:08Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Fix build with sphinx 5.2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34378",
    "user": "arojas"
}
```
CC:  fbissey



Issue created by migration from https://trac.sagemath.org/ticket/34615





---

archive/issue_comments_487303.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-29T19:29:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487303",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487304.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2022-09-29T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487304",
    "user": "arojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_487305.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to build.",
    "created_at": "2022-09-29T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487305",
    "user": "arojas"
}
```

Changing component from PLEASE CHANGE to build.



---

archive/issue_comments_487306.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-09-29T19:31:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487306",
    "user": "arojas"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_487307.json:
```json
{
    "body": "I haven't been pushed to 5.2 yet, so I haven't seen it. Although I could have had reports. This is quite different from the previous fix we pushed. Was it supposed to be implicit in older version of sphinx.",
    "created_at": "2022-09-29T19:47:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487307",
    "user": "fbissey"
}
```

I haven't been pushed to 5.2 yet, so I haven't seen it. Although I could have had reports. This is quite different from the previous fix we pushed. Was it supposed to be implicit in older version of sphinx.



---

archive/issue_comments_487308.json:
```json
{
    "body": "No, this is a new attribute in 5.2. That's why I was surprised this still works with older sphinx\n\nhttps://github.com/sphinx-doc/sphinx/commit/7da60f23539bd5d1a79bdbcf67cd5164311182b7",
    "created_at": "2022-09-29T19:58:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487308",
    "user": "arojas"
}
```

No, this is a new attribute in 5.2. That's why I was surprised this still works with older sphinx

https://github.com/sphinx-doc/sphinx/commit/7da60f23539bd5d1a79bdbcf67cd5164311182b7



---

archive/issue_comments_487309.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2022-09-29T20:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487309",
    "user": "arojas"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_487310.json:
```json
{
    "body": "Ah, no. It does throw errors with older sphinx, although docs still seem to build fine.",
    "created_at": "2022-09-29T20:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487310",
    "user": "arojas"
}
```

Ah, no. It does throw errors with older sphinx, although docs still seem to build fine.



---

archive/issue_comments_487311.json:
```json
{
    "body": "I suggest we take the opportunity to upgrade sphinx in sage itself then. I didn't do it for 5.1 and that may have been lazy on my part :)",
    "created_at": "2022-09-29T20:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487311",
    "user": "fbissey"
}
```

I suggest we take the opportunity to upgrade sphinx in sage itself then. I didn't do it for 5.1 and that may have been lazy on my part :)



---

archive/issue_comments_487312.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-09-29T21:00:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487312",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487313.json:
```json
{
    "body": "I am busy this morning but if you don't do more, I'll look at the sphinx contribution packages that may need updating or- be added to sage.",
    "created_at": "2022-09-29T21:15:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487313",
    "user": "fbissey"
}
```

I am busy this morning but if you don't do more, I'll look at the sphinx contribution packages that may need updating or- be added to sage.



---

archive/issue_comments_487314.json:
```json
{
    "body": "Everything builds fine and docs look OK",
    "created_at": "2022-09-30T06:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487314",
    "user": "arojas"
}
```

Everything builds fine and docs look OK



---

archive/issue_comments_487315.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-09-30T06:00:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487315",
    "user": "arojas"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_487316.json:
```json
{
    "body": "After looking more closely, only sphinxcontrib_websupport would need a version bump.",
    "created_at": "2022-10-05T09:25:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487316",
    "user": "fbissey"
}
```

After looking more closely, only sphinxcontrib_websupport would need a version bump.



---

archive/issue_comments_487317.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-10-05T09:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487317",
    "user": "fbissey"
}
```

New commits:



---

archive/issue_comments_487318.json:
```json
{
    "body": "On macos, with the ticket branch merged to the develop branch, I encountered\n\n```\n[sagemath_doc_html-none]     raise DistributionNotFound(req, requirers)\n[sagemath_doc_html-none] pkg_resources.DistributionNotFound: The 'imagesize>=1.3'\n distribution was not found and is required by sphinx\n```\n",
    "created_at": "2022-10-07T13:42:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487318",
    "user": "klee"
}
```

On macos, with the ticket branch merged to the develop branch, I encountered

```
[sagemath_doc_html-none]     raise DistributionNotFound(req, requirers)
[sagemath_doc_html-none] pkg_resources.DistributionNotFound: The 'imagesize>=1.3'
 distribution was not found and is required by sphinx
```




---

archive/issue_comments_487319.json:
```json
{
    "body": "Upgrading to `imagesize-1.4.1` the latest gets it rolling.",
    "created_at": "2022-10-07T13:47:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487319",
    "user": "klee"
}
```

Upgrading to `imagesize-1.4.1` the latest gets it rolling.



---

archive/issue_comments_487320.json:
```json
{
    "body": "Replying to [comment:14 Kwankyu Lee]:\n> Upgrading to `imagesize-1.4.1` the latest gets it rolling.\n\nIt ended up successfully, and the built documents look good.",
    "created_at": "2022-10-07T20:28:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487320",
    "user": "klee"
}
```

Replying to [comment:14 Kwankyu Lee]:
> Upgrading to `imagesize-1.4.1` the latest gets it rolling.

It ended up successfully, and the built documents look good.



---

archive/issue_comments_487321.json:
```json
{
    "body": "You are right, the version of imagesize was way to low in sage (1.2). Updating now.",
    "created_at": "2022-10-09T21:48:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487321",
    "user": "fbissey"
}
```

You are right, the version of imagesize was way to low in sage (1.2). Updating now.



---

archive/issue_comments_487322.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-10-09T21:58:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487322",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_487323.json:
```json
{
    "body": "Updated imagesize and pushed sphinx to 5.2.3.",
    "created_at": "2022-10-09T22:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487323",
    "user": "fbissey"
}
```

Updated imagesize and pushed sphinx to 5.2.3.



---

archive/issue_comments_487324.json:
```json
{
    "body": "Thanks.\n\nIt works well and looks good to me.",
    "created_at": "2022-10-10T02:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487324",
    "user": "klee"
}
```

Thanks.

It works well and looks good to me.



---

archive/issue_comments_487325.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-10-10T02:09:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487325",
    "user": "klee"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_487326.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-10-16T22:15:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487326",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_487327.json:
```json
{
    "body": "This upgrade seems to have introduced an unpleasant change of doc appearance. Compare\n\nhttps://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/index.html\n\nwith\n\nhttps://doc.sagemath.org/html/en/reference/curves/index.html\n\nSee all the second-level headings. Those weren't before.",
    "created_at": "2022-10-24T06:18:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487327",
    "user": "klee"
}
```

This upgrade seems to have introduced an unpleasant change of doc appearance. Compare

https://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/index.html

with

https://doc.sagemath.org/html/en/reference/curves/index.html

See all the second-level headings. Those weren't before.



---

archive/issue_comments_487328.json:
```json
{
    "body": "I suspect that the upgrade does not work well with sage's custom `autodoc`.",
    "created_at": "2022-10-25T01:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487328",
    "user": "klee"
}
```

I suspect that the upgrade does not work well with sage's custom `autodoc`.



---

archive/issue_comments_487329.json:
```json
{
    "body": "Possibly, it is hardly news that we should get rid of it as quickly as we can. I wanted to ask whether you had an idea why there are subsection for say \"plane conics\" but not \"curves\"? When I tried to post yesterday, trac was in maintenance :(",
    "created_at": "2022-10-25T01:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487329",
    "user": "fbissey"
}
```

Possibly, it is hardly news that we should get rid of it as quickly as we can. I wanted to ask whether you had an idea why there are subsection for say "plane conics" but not "curves"? When I tried to post yesterday, trac was in maintenance :(



---

archive/issue_comments_487330.json:
```json
{
    "body": "Replying to [comment:24 Fran\u00e7ois Bissey]:\n> Possibly, it is hardly news that we should get rid of it as quickly as we can. \n\nI agree! But that seems a formidable task (unless we just leave the consequential \"broken doc\" at it is).\n\n> I wanted to ask whether you had an idea why there are subsection for say \"plane conics\" but not \"curves\"?\n\nIt is because of the `maxdepth: 2`. See \n\n```\nPlane conics\n============\n\n.. toctree::\n   :maxdepth: 2 \n```\n\nHence it is normal. The real problem seems that definitions doc is regarded as content headings. I don't know if this is a feature of the upgraded sphinx or a problem of `sage_autodoc`...",
    "created_at": "2022-10-25T02:32:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487330",
    "user": "klee"
}
```

Replying to [comment:24 François Bissey]:
> Possibly, it is hardly news that we should get rid of it as quickly as we can. 

I agree! But that seems a formidable task (unless we just leave the consequential "broken doc" at it is).

> I wanted to ask whether you had an idea why there are subsection for say "plane conics" but not "curves"?

It is because of the `maxdepth: 2`. See 

```
Plane conics
============

.. toctree::
   :maxdepth: 2 
```

Hence it is normal. The real problem seems that definitions doc is regarded as content headings. I don't know if this is a feature of the upgraded sphinx or a problem of `sage_autodoc`...



---

archive/issue_comments_487331.json:
```json
{
    "body": "A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)",
    "created_at": "2022-10-25T04:00:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487331",
    "user": "klee"
}
```

A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)



---

archive/issue_comments_487332.json:
```json
{
    "body": "Replying to [comment:26 Kwankyu Lee]:\n> A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)\n\nThis certainly does not solve all problems. See the \"Contents\" on the right\n\nhttps://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/sage/schemes/plane_conics/constructor.html",
    "created_at": "2022-10-25T08:43:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487332",
    "user": "klee"
}
```

Replying to [comment:26 Kwankyu Lee]:
> A simple and laborious solution would be to change all affected `maxdepth: 2` to `maxdepth: 1`. This seems also a correct solution. Then we can avoid touching `sage_autodoc` :)

This certainly does not solve all problems. See the "Contents" on the right

https://8f8af65e54d3a9962cfab40f15dc23f4e955b43f--sagemath-tobias.netlify.app/reference/curves/sage/schemes/plane_conics/constructor.html



---

archive/issue_comments_487333.json:
```json
{
    "body": "I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.\n\nOf course, if it is inconsistent with other pages, we have a problem.",
    "created_at": "2022-10-25T08:52:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487333",
    "user": "fbissey"
}
```

I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.

Of course, if it is inconsistent with other pages, we have a problem.



---

archive/issue_comments_487334.json:
```json
{
    "body": "Replying to [comment:28 Fran\u00e7ois Bissey]:\n> I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.\n\nObject definitions in TOC is a new standard feature of the upgraded Sphinx. But this changes our doc in an unintended way. This is fixed now in #34706. Needs review.",
    "created_at": "2022-10-31T04:57:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34378",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34378#issuecomment-487334",
    "user": "klee"
}
```

Replying to [comment:28 François Bissey]:
> I don't think that's bad. It is on a static right space while the content is just in a middle frame. This really looks like a standard template. One I have seen in other places.

Object definitions in TOC is a new standard feature of the upgraded Sphinx. But this changes our doc in an unintended way. This is fixed now in #34706. Needs review.
