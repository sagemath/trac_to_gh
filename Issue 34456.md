# Issue 34456: Further support for matplotlib 3.6

Issue created by migration from https://trac.sagemath.org/ticket/34693

Original creator: fbissey

Original creation time: 2022-10-24 21:58:36

CC:  tornaria

#34668 was focusing on making doctests pass but did not test docbuilding.

The following plot in `src/sage/plot/plot.py`

```
    .. PLOT::

        g = plot(2*x+1,(x,0,5),ticks=[[0,1,e,pi,sqrt(20)],2],tick_formatter="latex")
        sphinx_plot(g)
```

is causing the building of the documentation to fail horribly.

```
[plotting ]  from /home/portage/sci-mathematics/sage-doc-9999/work/sage-doc-9999/src/doc/en/reference/plotting/sage/plot/plot.rst:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1378, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, "for_layout_only": True})
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
[plotting ] During handling of the above exception, another exception occurred:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1378, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, "for_layout_only": True})
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axes/_base.py", line 4428, in get_tightbbox
[plotting ]     ba = martist._get_tightbbox_for_layout_only(axis, renderer)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1380, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **kwargs)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
[plotting ] During handling of the above exception, another exception occurred:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1378, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, "for_layout_only": True})
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
[plotting ] During handling of the above exception, another exception occurred:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/sphinxext/plot_directive.py", line 515, in _run_code
[plotting ]     exec(code, ns)
[plotting ]   File "<string>", line 2, in <module>
[plotting ]   File "<string>", line 37, in sphinx_plot
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/figure.py", line 3448, in tight_layout
[plotting ]     engine.execute(self)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/layout_engine.py", line 180, in execute
[plotting ]     kwargs = get_tight_layout_figure(
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/_tight_layout.py", line 305, in get_tight_layout_figure
[plotting ]     kwargs = _auto_adjust_subplotpars(fig, renderer,
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/_tight_layout.py", line 82, in _auto_adjust_subplotpars
[plotting ]     bb += [martist._get_tightbbox_for_layout_only(ax, renderer)]
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1380, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **kwargs)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axes/_base.py", line 4428, in get_tightbbox
[plotting ]     ba = martist._get_tightbbox_for_layout_only(axis, renderer)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1380, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **kwargs)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
```

Tests of this plot were disabled in #34668 and now we need to remove the plot. The whole example needs to be replaced by something that works.


---

Comment by fbissey created at 2022-10-24 22:03:48

Currently making sure that this it the only change required and providing support to sage-on-gentoo users already using matplotlib 3.6.x before pushing a branch here.


---

Comment by fbissey created at 2022-10-25 01:28:45

The attached branch will let you build the doc with matplotlib 3.6.
----
New commits:


---

Comment by fbissey created at 2022-10-25 01:30:42

Not sure how I got to attach the wrong branch. Thankfully, I noticed.
----
New commits:


---

Comment by mkoeppe created at 2022-11-27 02:36:03

Is this ready for review?


---

Comment by fbissey created at 2022-11-27 02:45:56

Changing status from new to needs_review.


---

Comment by fbissey created at 2022-11-27 02:45:56

Yes, it is ready.Our consensus at #34668 is that the point of this particular example is unclear. So, removing it does not seem to be a big deal.


---

Comment by mkoeppe created at 2022-11-27 05:04:54

I'm hitting the same error (`ufunc 'isfinite' not supported`) also in some of my own plotting code.


---

Comment by mkoeppe created at 2022-11-27 05:07:21

Possibly related: #29210 scipy.optimize.newton does not accept Sage input anymore


---

Comment by fbissey created at 2022-11-27 05:11:44

Yes, I am now wondering if it is an issue that matplotlib (and scipy) may need to adapt to new stuff in numpy. But we cannot leave the plot in, since it breaks building the doc.


---

Comment by klee created at 2022-11-28 02:31:48

Replying to [comment:5 François Bissey]:
> Yes, it is ready. Our consensus at #34668 is that the point of this particular example is unclear. 

It is clear. We can use symbolic values as tick marks. It is a useful feature. I may use it (though I never did :)

> So, removing it does not seem to be a big deal.

Removing a feature to upgrade a package is a big deal.

I investigated the real cause of the failure. Fortunately I found it. It is a kind of bug in matplotlib 3.6. I reported it to upstream:

https://github.com/matplotlib/matplotlib/issues/24557

Let's see how they react before we proceed.


---

Comment by klee created at 2022-11-29 01:27:33

In the upstream discussion https://github.com/matplotlib/matplotlib/issues/24557#issuecomment-1329891836, they suggested to make our symbolic objects behave more `float`-like: 

> Can you add `isfinite` support to `Expression` (or a `ConstExpression` which may or may not already exist)? It seems to me that being able to ask if an expression is finite is something you should be able to ask.

or numpy-array-like:

> Is it possible for sagemath to provide a `.__array__ `method to convert to numpy arrays? 

I will investigate the former possibility. We have

```python
sage: a = sqrt(2)
sage: a.is_infinity()
False
}}} 
but I don't know how to "add `isfinite` support" to satisfy numpy...


---

Comment by klee created at 2022-11-29 05:53:52


```
sage: np.isfinite(2)
True
```

So Sage integers are numbers from the perspective of numpy. How does it do it?


---

Comment by klee created at 2022-11-29 05:55:44

BTW, 

```
sage: np.can_cast(type(2), float, 'safe')
False
```

Strange...


---

Comment by mkoeppe created at 2022-11-29 06:00:02

I don't know if that's the mechanism why it works, but our `Integer`s are registered with the numbers ABC - https://docs.python.org/3/library/numbers.html


---

Comment by klee created at 2022-11-29 07:51:08

Replying to [comment:13 Matthias Köppe]:
> I don't know if that's the mechanism why it works, but our `Integer`s are registered with the numbers ABC - https://docs.python.org/3/library/numbers.html

I tried that, but doesn't work. Not sure I missed something...


---

Comment by klee created at 2022-11-29 08:27:01

Voilà, I found it. It is

https://numpy.org/doc/stable/reference/arrays.interface.html


---

Comment by klee created at 2022-11-29 19:49:06

and https://numpy.org/doc/stable/reference/arrays.dtypes.html

Then

```python
class Symbolic(object):
    __array_interface__ = {'typestr': 'f'} 
    
    def __init__(self, a, b):
        self.num = a
        self.den = b
        
    def __str__(self):
        return '{}/{}'.format(self.num, self.den)
        
    def __float__(self):
        return float(self.num / self.den)
    
import matplotlib.pyplot as plt
import numpy as np
import sympy as sym
from matplotlib.ticker import FixedLocator, NullLocator, FuncFormatter

# make data
x = np.linspace(0, 3, 100)
y = 2 * x + 1

# plot
fig, ax = plt.subplots()

ax.plot(x, y, linewidth=2.0)

a = Symbolic(1,2)

ax.xaxis.set_major_locator(FixedLocator([a, 1, 2, 3]))
ax.xaxis.set_minor_locator(NullLocator())
ax.xaxis.set_major_formatter(FuncFormatter(lambda x, pos: str(x)))

plt.show()
```

works. Moreover

```python
>>> a = Symbolic(2,3)
>>> np.isfinite(a)
True
>>> np.array(a)
array(0.6666667, dtype=float32)
```

Hence so we now know how to make `Expression` float-like (from the perspective of numpy).

To implement this mechanism for `Expression` may require major restructuring, since  the scope of `Expression` is much more broad beyond constant expression. As suggested in the upstream discussion, we may need `ConstantExpression` that would hold only constant values, and make that float-like or complex-like. I feel this would be a grand work out of my capacity though. Symbolic expression experts may do it. But the first question is if this work is worth to do. If so, this would need a separate ticket.


---

Comment by mkoeppe created at 2022-11-29 19:54:02

Does `__array_interface__` have to be a class constant, or could it be a `lazy_attribute`?


---

Comment by klee created at 2022-11-29 20:01:58

It can be `lazy_attributes` or `property`.

But I realized a major problem. By the mechanism, `Symbolic` is simply converted to floats, and you see `0.5` in the plot instead of `1/2`. So this defeats the original purpose! Now it seems to me that we cannot retain the feature (supporting symbolic ticks)...


---

Comment by klee created at 2022-11-29 21:41:52

Replying to [comment:18 Kwankyu Lee]:
> By the mechanism, `Symbolic` is simply converted to floats, and you see `0.5` in the plot instead of `1/2`. So this defeats the original purpose! Now it seems to me that we cannot retain the feature (supporting symbolic ticks)...

The rescue is to use matplotlib's `FixedFormatter` to provide strings for the tick values separately. This would amount to reimplementing sage's `tick_formatter="latex"`.

Anyway, implementing this together with `ConstantExpression` seems a daunting task apart from the "worth to do" question.

I don't know how frequently the symbolic tick mark feature is used by sage users. If no one uses it :) then perhaps we may turn off this feature while we upgrade matplotlib to 3.6.


---

Comment by fbissey created at 2022-11-29 21:53:57

OK. So, it is currently broken and will take some time and efforts to put it right, if there is a will.

In the meantime, the branch removes just a plot showcasing the capability because it breaks building the documentation in sage-on-distros which already have matplotlib 3.6.x available.
Should we comment the plotting code and add reference to a ticket with work in progress or just remove it until things are ready?


---

Comment by klee created at 2022-11-29 22:03:56

How about just commenting them out mentioning this ticket?

But no one uses it? I really don't know. How about posting on sage-devel to prevent some one later to complain that his/her code doesn't work anymore...


---

Comment by mkoeppe created at 2022-11-29 22:06:18

I definitely use this feature (comment:6); -1 on removing the test


---

Comment by klee created at 2022-11-30 04:41:53

Replying to [comment:22 Matthias Köppe]:
> I definitely use this feature (comment:6); -1 on removing the test

+1. 

Meanwhile I learned enough matplotlib to make up a simple fix for this ticket.


---

Comment by klee created at 2022-11-30 04:51:33

New commits:


---

Comment by git created at 2022-11-30 12:40:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-11-30 23:26:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-12-01 02:43:49

I can confirm that this also fixes the issue in my plotting code. Thanks a lot for working on it!


---

Comment by mkoeppe created at 2022-12-01 02:43:49

Changing status from needs_review to positive_review.


---

Comment by klee created at 2022-12-01 03:44:48

Thanks. I also checked the branch with #34796 that upgrades matplotlib to 3.6. It works well.


---

Comment by vbraun created at 2022-12-11 11:11:50

Resolution: fixed
