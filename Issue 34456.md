# Issue 34456: Further support for matplotlib 3.6

archive/issues_034456.json:
```json
{
    "body": "CC:  @tornaria\n\n#34668 was focusing on making doctests pass but did not test docbuilding.\n\nThe following plot in `src/sage/plot/plot.py`\n\n```\n    .. PLOT::\n\n        g = plot(2*x+1,(x,0,5),ticks=[[0,1,e,pi,sqrt(20)],2],tick_formatter=\"latex\")\n        sphinx_plot(g)\n```\n\nis causing the building of the documentation to fail horribly.\n\n```\n[plotting ]  from /home/portage/sci-mathematics/sage-doc-9999/work/sage-doc-9999/src/doc/en/reference/plotting/sage/plot/plot.rst:\n[plotting ] Traceback (most recent call last):\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/artist.py\", line 1378, in _get_tightbbox_for_layout_only\n[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, \"for_layout_only\": True})\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1251, in get_tightbbox\n[plotting ]     ticks_to_draw = self._update_ticks()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1198, in _update_ticks\n[plotting ]     minor_locs = self.get_minorticklocs()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1431, in get_minorticklocs\n[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],\n[plotting ]   File \"<__array_function__ internals>\", line 180, in isclose\n[plotting ]   File \"/usr/lib/python3.10/site-packages/numpy/core/numeric.py\", line 2373, in isclose\n[plotting ]     yfin = isfinite(y)\n[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''\n[plotting ] During handling of the above exception, another exception occurred:\n[plotting ] Traceback (most recent call last):\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/artist.py\", line 1378, in _get_tightbbox_for_layout_only\n[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, \"for_layout_only\": True})\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axes/_base.py\", line 4428, in get_tightbbox\n[plotting ]     ba = martist._get_tightbbox_for_layout_only(axis, renderer)\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/artist.py\", line 1380, in _get_tightbbox_for_layout_only\n[plotting ]     return obj.get_tightbbox(*args, **kwargs)\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1251, in get_tightbbox\n[plotting ]     ticks_to_draw = self._update_ticks()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1198, in _update_ticks\n[plotting ]     minor_locs = self.get_minorticklocs()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1431, in get_minorticklocs\n[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],\n[plotting ]   File \"<__array_function__ internals>\", line 180, in isclose\n[plotting ]   File \"/usr/lib/python3.10/site-packages/numpy/core/numeric.py\", line 2373, in isclose\n[plotting ]     yfin = isfinite(y)\n[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''\n[plotting ] During handling of the above exception, another exception occurred:\n[plotting ] Traceback (most recent call last):\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/artist.py\", line 1378, in _get_tightbbox_for_layout_only\n[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, \"for_layout_only\": True})\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1251, in get_tightbbox\n[plotting ]     ticks_to_draw = self._update_ticks()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1198, in _update_ticks\n[plotting ]     minor_locs = self.get_minorticklocs()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1431, in get_minorticklocs\n[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],\n[plotting ]   File \"<__array_function__ internals>\", line 180, in isclose\n[plotting ]   File \"/usr/lib/python3.10/site-packages/numpy/core/numeric.py\", line 2373, in isclose\n[plotting ]     yfin = isfinite(y)\n[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''\n[plotting ] During handling of the above exception, another exception occurred:\n[plotting ] Traceback (most recent call last):\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/sphinxext/plot_directive.py\", line 515, in _run_code\n[plotting ]     exec(code, ns)\n[plotting ]   File \"<string>\", line 2, in <module>\n[plotting ]   File \"<string>\", line 37, in sphinx_plot\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/figure.py\", line 3448, in tight_layout\n[plotting ]     engine.execute(self)\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/layout_engine.py\", line 180, in execute\n[plotting ]     kwargs = get_tight_layout_figure(\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/_tight_layout.py\", line 305, in get_tight_layout_figure\n[plotting ]     kwargs = _auto_adjust_subplotpars(fig, renderer,\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/_tight_layout.py\", line 82, in _auto_adjust_subplotpars\n[plotting ]     bb += [martist._get_tightbbox_for_layout_only(ax, renderer)]\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/artist.py\", line 1380, in _get_tightbbox_for_layout_only\n[plotting ]     return obj.get_tightbbox(*args, **kwargs)\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axes/_base.py\", line 4428, in get_tightbbox\n[plotting ]     ba = martist._get_tightbbox_for_layout_only(axis, renderer)\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/artist.py\", line 1380, in _get_tightbbox_for_layout_only\n[plotting ]     return obj.get_tightbbox(*args, **kwargs)\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1251, in get_tightbbox\n[plotting ]     ticks_to_draw = self._update_ticks()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1198, in _update_ticks\n[plotting ]     minor_locs = self.get_minorticklocs()\n[plotting ]   File \"/usr/lib/python3.10/site-packages/matplotlib/axis.py\", line 1431, in get_minorticklocs\n[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],\n[plotting ]   File \"<__array_function__ internals>\", line 180, in isclose\n[plotting ]   File \"/usr/lib/python3.10/site-packages/numpy/core/numeric.py\", line 2373, in isclose\n[plotting ]     yfin = isfinite(y)\n[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''\n```\n\nTests of this plot were disabled in #34668 and now we need to remove the plot. The whole example needs to be replaced by something that works.\n\nIssue created by migration from https://trac.sagemath.org/ticket/34693\n\n",
    "created_at": "2022-10-24T21:58:36Z",
    "labels": [
        "documentation",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Further support for matplotlib 3.6",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/34456",
    "user": "@kiwifb"
}
```
CC:  @tornaria

#34668 was focusing on making doctests pass but did not test docbuilding.

The following plot in `src/sage/plot/plot.py`

```
    .. PLOT::

        g = plot(2*x+1,(x,0,5),ticks=[[0,1,e,pi,sqrt(20)],2],tick_formatter="latex")
        sphinx_plot(g)
```

is causing the building of the documentation to fail horribly.

```
[plotting ]  from /home/portage/sci-mathematics/sage-doc-9999/work/sage-doc-9999/src/doc/en/reference/plotting/sage/plot/plot.rst:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1378, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, "for_layout_only": True})
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
[plotting ] During handling of the above exception, another exception occurred:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1378, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, "for_layout_only": True})
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axes/_base.py", line 4428, in get_tightbbox
[plotting ]     ba = martist._get_tightbbox_for_layout_only(axis, renderer)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1380, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **kwargs)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
[plotting ] During handling of the above exception, another exception occurred:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1378, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **{**kwargs, "for_layout_only": True})
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
[plotting ] During handling of the above exception, another exception occurred:
[plotting ] Traceback (most recent call last):
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/sphinxext/plot_directive.py", line 515, in _run_code
[plotting ]     exec(code, ns)
[plotting ]   File "<string>", line 2, in <module>
[plotting ]   File "<string>", line 37, in sphinx_plot
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/figure.py", line 3448, in tight_layout
[plotting ]     engine.execute(self)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/layout_engine.py", line 180, in execute
[plotting ]     kwargs = get_tight_layout_figure(
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/_tight_layout.py", line 305, in get_tight_layout_figure
[plotting ]     kwargs = _auto_adjust_subplotpars(fig, renderer,
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/_tight_layout.py", line 82, in _auto_adjust_subplotpars
[plotting ]     bb += [martist._get_tightbbox_for_layout_only(ax, renderer)]
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1380, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **kwargs)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axes/_base.py", line 4428, in get_tightbbox
[plotting ]     ba = martist._get_tightbbox_for_layout_only(axis, renderer)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/artist.py", line 1380, in _get_tightbbox_for_layout_only
[plotting ]     return obj.get_tightbbox(*args, **kwargs)
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1251, in get_tightbbox
[plotting ]     ticks_to_draw = self._update_ticks()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1198, in _update_ticks
[plotting ]     minor_locs = self.get_minorticklocs()
[plotting ]   File "/usr/lib/python3.10/site-packages/matplotlib/axis.py", line 1431, in get_minorticklocs
[plotting ]     mask = np.isclose(tr_minor_locs[:, None], tr_major_locs[None, :],
[plotting ]   File "<__array_function__ internals>", line 180, in isclose
[plotting ]   File "/usr/lib/python3.10/site-packages/numpy/core/numeric.py", line 2373, in isclose
[plotting ]     yfin = isfinite(y)
[plotting ] TypeError: ufunc 'isfinite' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
```

Tests of this plot were disabled in #34668 and now we need to remove the plot. The whole example needs to be replaced by something that works.

Issue created by migration from https://trac.sagemath.org/ticket/34693





---

archive/issue_comments_488055.json:
```json
{
    "body": "Currently making sure that this it the only change required and providing support to sage-on-gentoo users already using matplotlib 3.6.x before pushing a branch here.",
    "created_at": "2022-10-24T22:03:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488055",
    "user": "@kiwifb"
}
```

Currently making sure that this it the only change required and providing support to sage-on-gentoo users already using matplotlib 3.6.x before pushing a branch here.



---

archive/issue_comments_488056.json:
```json
{
    "body": "The attached branch will let you build the doc with matplotlib 3.6.\n----\nNew commits:",
    "created_at": "2022-10-25T01:28:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488056",
    "user": "@kiwifb"
}
```

The attached branch will let you build the doc with matplotlib 3.6.
----
New commits:



---

archive/issue_comments_488057.json:
```json
{
    "body": "Not sure how I got to attach the wrong branch. Thankfully, I noticed.\n----\nNew commits:",
    "created_at": "2022-10-25T01:30:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488057",
    "user": "@kiwifb"
}
```

Not sure how I got to attach the wrong branch. Thankfully, I noticed.
----
New commits:



---

archive/issue_comments_488058.json:
```json
{
    "body": "Is this ready for review?",
    "created_at": "2022-11-27T02:36:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488058",
    "user": "@mkoeppe"
}
```

Is this ready for review?



---

archive/issue_comments_488059.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-11-27T02:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488059",
    "user": "@kiwifb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_488060.json:
```json
{
    "body": "Yes, it is ready.Our consensus at #34668 is that the point of this particular example is unclear. So, removing it does not seem to be a big deal.",
    "created_at": "2022-11-27T02:45:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488060",
    "user": "@kiwifb"
}
```

Yes, it is ready.Our consensus at #34668 is that the point of this particular example is unclear. So, removing it does not seem to be a big deal.



---

archive/issue_comments_488061.json:
```json
{
    "body": "I'm hitting the same error (`ufunc 'isfinite' not supported`) also in some of my own plotting code.",
    "created_at": "2022-11-27T05:04:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488061",
    "user": "@mkoeppe"
}
```

I'm hitting the same error (`ufunc 'isfinite' not supported`) also in some of my own plotting code.



---

archive/issue_comments_488062.json:
```json
{
    "body": "Possibly related: #29210 scipy.optimize.newton does not accept Sage input anymore",
    "created_at": "2022-11-27T05:07:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488062",
    "user": "@mkoeppe"
}
```

Possibly related: #29210 scipy.optimize.newton does not accept Sage input anymore



---

archive/issue_comments_488063.json:
```json
{
    "body": "Yes, I am now wondering if it is an issue that matplotlib (and scipy) may need to adapt to new stuff in numpy. But we cannot leave the plot in, since it breaks building the doc.",
    "created_at": "2022-11-27T05:11:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488063",
    "user": "@kiwifb"
}
```

Yes, I am now wondering if it is an issue that matplotlib (and scipy) may need to adapt to new stuff in numpy. But we cannot leave the plot in, since it breaks building the doc.



---

archive/issue_comments_488064.json:
```json
{
    "body": "Replying to [comment:5 Fran\u00e7ois Bissey]:\n> Yes, it is ready. Our consensus at #34668 is that the point of this particular example is unclear. \n\nIt is clear. We can use symbolic values as tick marks. It is a useful feature. I may use it (though I never did :)\n\n> So, removing it does not seem to be a big deal.\n\nRemoving a feature to upgrade a package is a big deal.\n\nI investigated the real cause of the failure. Fortunately I found it. It is a kind of bug in matplotlib 3.6. I reported it to upstream:\n\nhttps://github.com/matplotlib/matplotlib/issues/24557\n\nLet's see how they react before we proceed.",
    "created_at": "2022-11-28T02:31:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488064",
    "user": "@kwankyu"
}
```

Replying to [comment:5 François Bissey]:
> Yes, it is ready. Our consensus at #34668 is that the point of this particular example is unclear. 

It is clear. We can use symbolic values as tick marks. It is a useful feature. I may use it (though I never did :)

> So, removing it does not seem to be a big deal.

Removing a feature to upgrade a package is a big deal.

I investigated the real cause of the failure. Fortunately I found it. It is a kind of bug in matplotlib 3.6. I reported it to upstream:

https://github.com/matplotlib/matplotlib/issues/24557

Let's see how they react before we proceed.



---

archive/issue_comments_488065.json:
```json
{
    "body": "In the upstream discussion https://github.com/matplotlib/matplotlib/issues/24557#issuecomment-1329891836, they suggested to make our symbolic objects behave more `float`-like: \n\n> Can you add `isfinite` support to `Expression` (or a `ConstExpression` which may or may not already exist)? It seems to me that being able to ask if an expression is finite is something you should be able to ask.\n\nor numpy-array-like:\n\n> Is it possible for sagemath to provide a `.__array__ `method to convert to numpy arrays? \n\nI will investigate the former possibility. We have\n\n```python\nsage: a = sqrt(2)\nsage: a.is_infinity()\nFalse\n```\n \nbut I don't know how to \"add `isfinite` support\" to satisfy numpy...",
    "created_at": "2022-11-29T01:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488065",
    "user": "@kwankyu"
}
```

In the upstream discussion https://github.com/matplotlib/matplotlib/issues/24557#issuecomment-1329891836, they suggested to make our symbolic objects behave more `float`-like: 

> Can you add `isfinite` support to `Expression` (or a `ConstExpression` which may or may not already exist)? It seems to me that being able to ask if an expression is finite is something you should be able to ask.

or numpy-array-like:

> Is it possible for sagemath to provide a `.__array__ `method to convert to numpy arrays? 

I will investigate the former possibility. We have

```python
sage: a = sqrt(2)
sage: a.is_infinity()
False
```
 
but I don't know how to "add `isfinite` support" to satisfy numpy...



---

archive/issue_comments_488066.json:
```json
{
    "body": "\n```\nsage: np.isfinite(2)\nTrue\n```\n\nSo Sage integers are numbers from the perspective of numpy. How does it do it?",
    "created_at": "2022-11-29T05:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488066",
    "user": "@kwankyu"
}
```


```
sage: np.isfinite(2)
True
```

So Sage integers are numbers from the perspective of numpy. How does it do it?



---

archive/issue_comments_488067.json:
```json
{
    "body": "BTW, \n\n```\nsage: np.can_cast(type(2), float, 'safe')\nFalse\n```\n\nStrange...",
    "created_at": "2022-11-29T05:55:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488067",
    "user": "@kwankyu"
}
```

BTW, 

```
sage: np.can_cast(type(2), float, 'safe')
False
```

Strange...



---

archive/issue_comments_488068.json:
```json
{
    "body": "I don't know if that's the mechanism why it works, but our `Integer`s are registered with the numbers ABC - https://docs.python.org/3/library/numbers.html",
    "created_at": "2022-11-29T06:00:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488068",
    "user": "@mkoeppe"
}
```

I don't know if that's the mechanism why it works, but our `Integer`s are registered with the numbers ABC - https://docs.python.org/3/library/numbers.html



---

archive/issue_comments_488069.json:
```json
{
    "body": "Replying to [comment:13 Matthias K\u00f6ppe]:\n> I don't know if that's the mechanism why it works, but our `Integer`s are registered with the numbers ABC - https://docs.python.org/3/library/numbers.html\n\nI tried that, but doesn't work. Not sure I missed something...",
    "created_at": "2022-11-29T07:51:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488069",
    "user": "@kwankyu"
}
```

Replying to [comment:13 Matthias Köppe]:
> I don't know if that's the mechanism why it works, but our `Integer`s are registered with the numbers ABC - https://docs.python.org/3/library/numbers.html

I tried that, but doesn't work. Not sure I missed something...



---

archive/issue_comments_488070.json:
```json
{
    "body": "Voil\u00e0, I found it. It is\n\nhttps://numpy.org/doc/stable/reference/arrays.interface.html",
    "created_at": "2022-11-29T08:27:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488070",
    "user": "@kwankyu"
}
```

Voilà, I found it. It is

https://numpy.org/doc/stable/reference/arrays.interface.html



---

archive/issue_comments_488071.json:
```json
{
    "body": "and https://numpy.org/doc/stable/reference/arrays.dtypes.html\n\nThen\n\n```python\nclass Symbolic(object):\n    __array_interface__ = {'typestr': 'f'} \n    \n    def __init__(self, a, b):\n        self.num = a\n        self.den = b\n        \n    def __str__(self):\n        return '{}/{}'.format(self.num, self.den)\n        \n    def __float__(self):\n        return float(self.num / self.den)\n    \nimport matplotlib.pyplot as plt\nimport numpy as np\nimport sympy as sym\nfrom matplotlib.ticker import FixedLocator, NullLocator, FuncFormatter\n\n# make data\nx = np.linspace(0, 3, 100)\ny = 2 * x + 1\n\n# plot\nfig, ax = plt.subplots()\n\nax.plot(x, y, linewidth=2.0)\n\na = Symbolic(1,2)\n\nax.xaxis.set_major_locator(FixedLocator([a, 1, 2, 3]))\nax.xaxis.set_minor_locator(NullLocator())\nax.xaxis.set_major_formatter(FuncFormatter(lambda x, pos: str(x)))\n\nplt.show()\n```\n\nworks. Moreover\n\n```python\n>>> a = Symbolic(2,3)\n>>> np.isfinite(a)\nTrue\n>>> np.array(a)\narray(0.6666667, dtype=float32)\n```\n\nHence so we now know how to make `Expression` float-like (from the perspective of numpy).\n\nTo implement this mechanism for `Expression` may require major restructuring, since  the scope of `Expression` is much more broad beyond constant expression. As suggested in the upstream discussion, we may need `ConstantExpression` that would hold only constant values, and make that float-like or complex-like. I feel this would be a grand work out of my capacity though. Symbolic expression experts may do it. But the first question is if this work is worth to do. If so, this would need a separate ticket.",
    "created_at": "2022-11-29T19:49:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488071",
    "user": "@kwankyu"
}
```

and https://numpy.org/doc/stable/reference/arrays.dtypes.html

Then

```python
class Symbolic(object):
    __array_interface__ = {'typestr': 'f'} 
    
    def __init__(self, a, b):
        self.num = a
        self.den = b
        
    def __str__(self):
        return '{}/{}'.format(self.num, self.den)
        
    def __float__(self):
        return float(self.num / self.den)
    
import matplotlib.pyplot as plt
import numpy as np
import sympy as sym
from matplotlib.ticker import FixedLocator, NullLocator, FuncFormatter

# make data
x = np.linspace(0, 3, 100)
y = 2 * x + 1

# plot
fig, ax = plt.subplots()

ax.plot(x, y, linewidth=2.0)

a = Symbolic(1,2)

ax.xaxis.set_major_locator(FixedLocator([a, 1, 2, 3]))
ax.xaxis.set_minor_locator(NullLocator())
ax.xaxis.set_major_formatter(FuncFormatter(lambda x, pos: str(x)))

plt.show()
```

works. Moreover

```python
>>> a = Symbolic(2,3)
>>> np.isfinite(a)
True
>>> np.array(a)
array(0.6666667, dtype=float32)
```

Hence so we now know how to make `Expression` float-like (from the perspective of numpy).

To implement this mechanism for `Expression` may require major restructuring, since  the scope of `Expression` is much more broad beyond constant expression. As suggested in the upstream discussion, we may need `ConstantExpression` that would hold only constant values, and make that float-like or complex-like. I feel this would be a grand work out of my capacity though. Symbolic expression experts may do it. But the first question is if this work is worth to do. If so, this would need a separate ticket.



---

archive/issue_comments_488072.json:
```json
{
    "body": "Does `__array_interface__` have to be a class constant, or could it be a `lazy_attribute`?",
    "created_at": "2022-11-29T19:54:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488072",
    "user": "@mkoeppe"
}
```

Does `__array_interface__` have to be a class constant, or could it be a `lazy_attribute`?



---

archive/issue_comments_488073.json:
```json
{
    "body": "It can be `lazy_attributes` or `property`.\n\nBut I realized a major problem. By the mechanism, `Symbolic` is simply converted to floats, and you see `0.5` in the plot instead of `1/2`. So this defeats the original purpose! Now it seems to me that we cannot retain the feature (supporting symbolic ticks)...",
    "created_at": "2022-11-29T20:01:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488073",
    "user": "@kwankyu"
}
```

It can be `lazy_attributes` or `property`.

But I realized a major problem. By the mechanism, `Symbolic` is simply converted to floats, and you see `0.5` in the plot instead of `1/2`. So this defeats the original purpose! Now it seems to me that we cannot retain the feature (supporting symbolic ticks)...



---

archive/issue_comments_488074.json:
```json
{
    "body": "Replying to [comment:18 Kwankyu Lee]:\n> By the mechanism, `Symbolic` is simply converted to floats, and you see `0.5` in the plot instead of `1/2`. So this defeats the original purpose! Now it seems to me that we cannot retain the feature (supporting symbolic ticks)...\n\nThe rescue is to use matplotlib's `FixedFormatter` to provide strings for the tick values separately. This would amount to reimplementing sage's `tick_formatter=\"latex\"`.\n\nAnyway, implementing this together with `ConstantExpression` seems a daunting task apart from the \"worth to do\" question.\n\nI don't know how frequently the symbolic tick mark feature is used by sage users. If no one uses it :) then perhaps we may turn off this feature while we upgrade matplotlib to 3.6.",
    "created_at": "2022-11-29T21:41:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488074",
    "user": "@kwankyu"
}
```

Replying to [comment:18 Kwankyu Lee]:
> By the mechanism, `Symbolic` is simply converted to floats, and you see `0.5` in the plot instead of `1/2`. So this defeats the original purpose! Now it seems to me that we cannot retain the feature (supporting symbolic ticks)...

The rescue is to use matplotlib's `FixedFormatter` to provide strings for the tick values separately. This would amount to reimplementing sage's `tick_formatter="latex"`.

Anyway, implementing this together with `ConstantExpression` seems a daunting task apart from the "worth to do" question.

I don't know how frequently the symbolic tick mark feature is used by sage users. If no one uses it :) then perhaps we may turn off this feature while we upgrade matplotlib to 3.6.



---

archive/issue_comments_488075.json:
```json
{
    "body": "OK. So, it is currently broken and will take some time and efforts to put it right, if there is a will.\n\nIn the meantime, the branch removes just a plot showcasing the capability because it breaks building the documentation in sage-on-distros which already have matplotlib 3.6.x available.\nShould we comment the plotting code and add reference to a ticket with work in progress or just remove it until things are ready?",
    "created_at": "2022-11-29T21:53:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488075",
    "user": "@kiwifb"
}
```

OK. So, it is currently broken and will take some time and efforts to put it right, if there is a will.

In the meantime, the branch removes just a plot showcasing the capability because it breaks building the documentation in sage-on-distros which already have matplotlib 3.6.x available.
Should we comment the plotting code and add reference to a ticket with work in progress or just remove it until things are ready?



---

archive/issue_comments_488076.json:
```json
{
    "body": "How about just commenting them out mentioning this ticket?\n\nBut no one uses it? I really don't know. How about posting on sage-devel to prevent some one later to complain that his/her code doesn't work anymore...",
    "created_at": "2022-11-29T22:03:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488076",
    "user": "@kwankyu"
}
```

How about just commenting them out mentioning this ticket?

But no one uses it? I really don't know. How about posting on sage-devel to prevent some one later to complain that his/her code doesn't work anymore...



---

archive/issue_comments_488077.json:
```json
{
    "body": "I definitely use this feature (comment:6); -1 on removing the test",
    "created_at": "2022-11-29T22:06:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488077",
    "user": "@mkoeppe"
}
```

I definitely use this feature (comment:6); -1 on removing the test



---

archive/issue_comments_488078.json:
```json
{
    "body": "Replying to [comment:22 Matthias K\u00f6ppe]:\n> I definitely use this feature (comment:6); -1 on removing the test\n\n+1. \n\nMeanwhile I learned enough matplotlib to make up a simple fix for this ticket.",
    "created_at": "2022-11-30T04:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488078",
    "user": "@kwankyu"
}
```

Replying to [comment:22 Matthias Köppe]:
> I definitely use this feature (comment:6); -1 on removing the test

+1. 

Meanwhile I learned enough matplotlib to make up a simple fix for this ticket.



---

archive/issue_comments_488079.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-11-30T04:51:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488079",
    "user": "@kwankyu"
}
```

New commits:



---

archive/issue_comments_488080.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-30T12:40:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488080",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488081.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-11-30T23:26:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488081",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_488082.json:
```json
{
    "body": "I can confirm that this also fixes the issue in my plotting code. Thanks a lot for working on it!",
    "created_at": "2022-12-01T02:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488082",
    "user": "@mkoeppe"
}
```

I can confirm that this also fixes the issue in my plotting code. Thanks a lot for working on it!



---

archive/issue_comments_488083.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-12-01T02:43:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488083",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_488084.json:
```json
{
    "body": "Thanks. I also checked the branch with #34796 that upgrades matplotlib to 3.6. It works well.",
    "created_at": "2022-12-01T03:44:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488084",
    "user": "@kwankyu"
}
```

Thanks. I also checked the branch with #34796 that upgrades matplotlib to 3.6. It works well.



---

archive/issue_comments_488085.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-12-11T11:11:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/34456",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/34456#issuecomment-488085",
    "user": "@vbraun"
}
```

Resolution: fixed
