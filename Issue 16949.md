# Issue 16949: LatticePoset: faster is_modular

Issue created by migration from https://trac.sagemath.org/ticket/17186

Original creator: jmantysalo

Original creation time: 2014-10-21 10:51:10

CC:  ncohen

Checking if a lattice is modular can be done with rank function. Same applies to [upper|lower]_semimodular.



---

Comment by jmantysalo created at 2014-10-21 11:00:44

For a proof see Enumerative combinatoric, pp. 286-287.
----
New commits:


---

Comment by jmantysalo created at 2014-10-21 11:00:44

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-10-21 15:45:42

Changing status from needs_review to needs_info.


---

Comment by ncohen created at 2014-10-21 15:45:42

Hello,

I was not able to find this proof at pages 286-287 of any of the two volumes of Enumerative Combinatorics. And it would be cool to have a correct reference to write in the function's code.

I also found a reference there, but they use <= when you use <.

https://www.math.ku.edu/~jmartin/courses/math796-S08/notes0201.pdf

By the way I do not understand why `rank_dict` should be a `dict`, as you use it to associate things to integers between 0 and n-1... A list does that already, and faster.

Nathann


---

Comment by jmantysalo created at 2014-10-21 16:32:15

I don't have physical book, this was on http://www-math.mit.edu/~rstan/ec/ec1.pdf

Definition says "for all ... => ...", and my code converts this to "if ... < ... return False". Should I convert this to "return all(... for a in... for b in...)"?

Changing rank_dict to array would need changing some parts of `hasse_diagram.py`.


---

Comment by ncohen created at 2014-10-21 16:35:36

> I don't have physical book, this was on http://www-math.mit.edu/~rstan/ec/ec1.pdf

Okay.

> Definition says "for all ... => ...", and my code converts this to "if ... < ... return False". Should I convert this to "return all(... for a in... for b in...)"?

I see. Sorry for that.

> Changing rank_dict to array would need changing some parts of `hasse_diagram.py`.

It is weird that it got implemented like that in the first place. There is some speed to get for free there. 

Anyway. I will review that patch in a second.

Nathann


---

Comment by ncohen created at 2014-10-21 16:58:30

Hello again !

This patch is good. Could you please mention in the function's documentation the result that you use to check the property, and if possible refer to the book ?

Thanks,

Nathann


---

Comment by git created at 2014-10-21 19:02:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-21 19:06:43

Changing status from needs_info to needs_review.


---

Comment by jmantysalo created at 2014-10-21 19:06:43

There was a minor error, `is_ranked` should be `is_graded`. Also there is now some other minor changes.

I'm not happy with examples, but at least the code is now much faster.


---

Comment by ncohen created at 2014-10-22 09:00:12

> There was a minor error, `is_ranked` should be `is_graded`.

Isn't it exactly the same for lattices ?

> Also there is now some other minor changes.

Hmmm... Well, take a look at commit "Correction from is_ranked to is_graded; some changes on docs". You will see what is the effect of changing the order in which the functions appear for the reviewer `:-P`

> I'm not happy with examples, but at least the code is now much faster.

Well, it seems good to me (even though the examples were weak from the start) but I would like to have your opinion on this ranked/graded thing first, because I do not understand how it could make your code faster if the two are equivalent `O_o`

Nathann


---

Comment by git created at 2014-10-22 09:40:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-22 09:43:34

Arghs, of course. Corrected `is_graded` -> `is_ranked`.

Same change should be made for `is_distributive()`. Or actually, `lattices.py` should  define it's own `is_graded` and save thousands of picoseconds.


---

Comment by ncohen created at 2014-10-22 09:45:33

Yooooooo !

> Arghs, of course. Corrected `is_graded` -> `is_ranked`.
> 
> Same change should be made for `is_distributive()`. Or actually, `lattices.py` should  define it's own `is_graded` and save thousands of picoseconds.

Hmmm... But then I wonder: when did you observe a difference in speed ? When you changed the formulation used in the loop (which makes sense) or when you changed graded to ranked (which would be alarming) ?

Nathann


---

Comment by jmantysalo created at 2014-10-22 10:09:55

Nothing to be worry about: Speed difference happened when I changed the whole algorithm.


---

Comment by ncohen created at 2014-10-22 10:12:37

Oh, cool. Then I wait for the tests to pass and I switch the ticket to `positive_review`. Thanks `:-)`

Nathann


---

Comment by ncohen created at 2014-10-22 10:57:33

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2014-10-22 14:38:44

Two very minor things that if you don't want to change, you don't have to.

1 - Instead of a comment, I'd put the reference in the docstring

```
ALGORITHM:

Based on pp. 286-287 of Enumerative Combinatorics, Vol 1 [EnumComb1]_.
```

perhaps with some detail of the algorithm.

2 - Use `all`. It could be (marginally) faster, and makes it a little easier to read IMO.

```diff
- for a in range(0, n):
-     for b in range(a+1, n):
-         if ( H._rank_dict[a]+H._rank_dict[b] !=
-              H._rank_dict[H._meet[a,b]] + H._rank_dict[H._join[a,b]] ):
-             return False
- return True
+ return all(H._rank_dict[a] + H._rank_dict[b]
+            == H._rank_dict[H._meet[a,b]] + H._rank_dict[H._join[a,b]]
+            for a in range(n) for b in range(a+1, n))
```



---

Comment by jmantysalo created at 2014-10-22 16:45:44

Good ideas from tscrim. I didn't happen to think that in `all(for x... for y)` I can refer to `x` when making loop on `y`. It is of course easier to read code that mirrors closely the mathematical definition.

A question: Should I mention same book on all three functions, or only once?


---

Comment by jmantysalo created at 2014-10-22 16:45:44

Changing status from positive_review to needs_work.


---

Comment by ncohen created at 2014-10-22 16:48:57

> A question: Should I mention same book on all three functions, or only once?

We have to find the info if we look for it. Either copy/paste three times if it is not very long, or say in two functions that the explanation is in the third one.

Nathann


---

Comment by tscrim created at 2014-10-22 19:08:11

I'd at least put a reference link to the book `[EnumComb1]_` in all three.


---

Comment by git created at 2014-10-23 06:35:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-23 06:35:39

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-10-23 09:01:09

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-24 10:14:37

Resolution: fixed
