# Issue 14550: Update ATLAS to stable version 3.10.1

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2013-06-17 12:21:29

Assignee: jdemeyer

Updated *spkg*:
 1. [http://boxen.math.washington.edu/home/jpflori/spkg/atlas-3.10.1.p0.spkg](http://boxen.math.washington.edu/home/jpflori/spkg/atlas-3.10.1.p0.spkg).

*Apply*
 1. [attachment:10508_root.patch] to the SAGE_ROOT repository 
 2. [attachment:trac_10508_update_atlas_docs.rebased.patch] to the Sage repository.

*Remove* the lapack and blas packages.


---

Comment by jdemeyer created at 2013-06-17 13:04:45

When removing `3DNow`, it starts using `SSE1` and `SSE2`, which shouldn't happen either. But this also happens with the old ATLAS spkg, so at least it's not a regression.


---

Comment by vbraun created at 2013-06-17 14:37:41

You should use `isa_ext=('None',)` if you want to explictly disable it, see `ATLAS_ISAEXT`.

The given extensions are not mandatory but are supposed to let ATLAS try them. Whether or not they end up being used is up to the ATLAS build system and how well they perform. Though it seems that you found a bug with ancient cpus, which is unsurprising since I'm pretty sure that nobody else than us builds ATLAS on museum pieces.


---

Comment by jdemeyer created at 2013-06-17 20:39:45

Replying to [comment:5 vbraun]:
> You should use `isa_ext=('None',)` if you want to explictly disable it, see `ATLAS_ISAEXT`.
Done in linked spkg, not yet tested.


---

Attachment


---

Attachment


---

Comment by jdemeyer created at 2013-06-18 12:58:45

spkg diff


---

Comment by jdemeyer created at 2013-06-19 06:54:34

Changing status from new to needs_review.


---

Attachment


---

Comment by vbraun created at 2013-06-19 07:18:58

On 64 bit intel chips we should definitely enable SSE2

Edit: misread the patch, the SSE2 is there but there is no 64-bit x86SSE264 archdef. But I guess thats ok, we wil just run through the tuning. There is no 32-bit archdef for ancient 64-bit intel chips


---

Comment by vbraun created at 2013-06-19 07:20:47

And the real question: does it improve the build time on ancient i386 chips without SSE? The only real improvement would be if the pure x87 archdef would be used and is actually faster to compile than the full tuning.


---

Comment by jdemeyer created at 2013-06-19 07:49:19

Volker, you obviously understand this stuff better than me, so if you want to make a reviewer patch, go ahead.

My main concern is that `configure_base()` should produce a generic binary, meaning it runs on all processors of a given architecture.

(although note that the oldest i386-architecture processor that we test Sage on is a Pentium 4, which has SSE and SSE2)


---

Comment by vbraun created at 2013-06-19 14:54:34

There is no way to make a binary that will run on all x86 cpus ever made. For starters, the original x86 didn't even have x87. Its an evolving instruction set, and we should aim at "everything within the last X years" and not the most dumb binary that we can possibly build. Otherwise we'll just make false claims since nobody is going to be able to test that the binary actually works.

The only reason for removing the 3DNow would be if that makes build time faster since the naming scheme for the "generic i386 archdef" is without it. Which is why I'm asking if it actually helps. And for that I guess we'll have to time builds on cicero, maybe I'll get around to it after the 22nd when you are gone.


---

Comment by jdemeyer created at 2013-06-19 14:59:34

Replying to [comment:14 vbraun]:
> The only reason for removing the 3DNow
As far as I know, 3DNow is AMD-only, so you would be excluding all Intel chips...


---

Comment by jpflori created at 2013-06-19 15:14:41

Indeed, that's what i found as well, so enabling 3DNow was a bad idea.
I suggest to use:
* the x86x87 target with no ISA extension on 32 bits, it should cover most CPUs except for the ones which have been even discarded from museum,
* x86 plus SSE2 for 64 bits.
Note ATLAS provide archdefs for the former and Volker added archdefs for the latter.


---

Comment by jpflori created at 2013-06-19 15:21:30

So basically I completely agree with what Jeroen did.

How are the generic and non-generic build going on?


---

Comment by jpflori created at 2013-06-19 15:22:43

(About the x86x87 target, ATLAS doc at http://math-atlas.sourceforge.net/atlas_install/node28.html states:

```
(I believe this is all Intel architectures from PentiumPRO onwards, and any AMD platform since at least the original Athlon)
```

I would feel this is quite old enough.


---

Comment by vbraun created at 2013-06-19 16:29:20

I agree that the change is correct **if it actually uses the archdef now**. So there is some testing to be done.

In the absence of archdefs we should still enable 3Dnow (and SSE in a few years). x86x87 is already an isa extension over stone-age x86. And "enabling" means: try to build the kernel. Whether or not it is actually used by ATLAS depends on whether it actually compiles, runs, and performs well. Not that I think that there is any particular 3dnow asm in ATLAS, but in the near future this will be important for SSE.


---

Comment by jdemeyer created at 2013-06-20 06:43:28

Replying to [comment:19 vbraun]:
> we should still enable 3Dnow (and SSE in a few years).
That makes no sense at all. Intel Pentium 4 (quite old but not stone-age) has SSE and SSE2 but not 3DNow.

> Not that I think that there is any particular 3dnow asm in ATLAS, but in the near future this will be important for SSE.
There surely is, otherwise I wouldn't be seeing all those "Illegal Instruction" errors.


---

Comment by jpflori created at 2013-06-20 16:17:24

Changing status from needs_review to needs_work.


---

Comment by jpflori created at 2013-06-20 16:17:24

In spkg-install, the "archdef_dir = PATCH_DIR" line for the base target on x86 64 bits should be removed.
I've moved the tarballs into a ARCH subdir and reenabled copying of archdefs tarballs into ATLAS proper dir, so it should find them without tweaking archdef_dir.
Or you could disable the copying and set archdef_dir...

By the way, for the fast target we could also refactor the archdef_dir setting and isa_ext, potentially setting isa_ext = ('None',) by default as for the base target.

Question for Volker, how to tell for sure that archdefs are used? apart from a shorter building time?

Apart from this, should we wait for the patchbots reports before putting this to positive_review?
Or the other way around?


---

Comment by vbraun created at 2013-06-20 17:35:21

Replying to [comment:20 jdemeyer]:
> There surely is, otherwise I wouldn't be seeing all those "Illegal Instruction" errors.

I don't think so. Unless the build host supports 3dnow there is no way that such a kernel would end up in the atlas library. The illegal instructions are because the previous atlas version (which we are still shipping) erroneously did not respect the given limits to the ISA.


---

Comment by vbraun created at 2013-06-20 17:37:22

Replying to [comment:21 jpflori]:
> Question for Volker, how to tell for sure that archdefs are used? apart from a shorter building time?

You can probably read the log, but the only way I would really trust is to measure the build time.


---

Comment by jdemeyer created at 2013-06-21 06:19:31

Replying to [comment:22 vbraun]:
> I don't think so. Unless the build host supports 3dnow there is no way that such a kernel would end up in the atlas library. The illegal instructions are because the previous atlas version (which we are still shipping) erroneously did not respect the given limits to the ISA.

You can think what you want, but the fact is that the build of ATLAS-3.10.1 on `cicero` failed with `3DNow` (with `Illegal Instruction` messages in the build log) but succeeded without `3DNow` (without `Illegal Instruction` messages in the build log).


---

Comment by vbraun created at 2013-07-07 13:27:39

For the record, I built ATLAS with

```
SAGE_ATLAS_ARCH=x86x87,3DNow
```

and I do get a working install which passes the Sage doctests. So, just to spell it out again, the ISA extension settings just tell ATLAS which ones it is allowed to try, not which ones end up in the ATLAS library. Its normal to get SIGILL during the atlas tuning.

I also verified that it goes through a full tuning which takes a very long time. Presumably that just doesn't work on cicero, or when you tried it the build system couldn't get stable timings.


---

Comment by vbraun created at 2013-07-07 13:45:18

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2013-07-07 14:04:46

Both the fast and base targets for 32-bit intel did not make use of the existing archdefs because of the isa extension mismatch in the filename. Fixed now.


---

Comment by jpflori created at 2013-07-07 17:57:20

Great that you provided a proper spkg-src script.
I'll try to review the spkg tomorrow.

And about 3DNow (I saw you did not put it in back), we don't want to put it in base or fast anyway because it's AMD only, so if you happen to build a dist tarball of Sage, typically by setting the FAT option, on a computer with 3DNow, it will get in and later segfault if you run it on an Intel computer.


---

Comment by vbraun created at 2013-07-07 21:28:47

Replying to [comment:28 jpflori]:
> And about 3DNow, we don't want to put it in base or fast anyway because it's AMD only

Kind of a moot point since we don't distribute binaries built on such an old machine. Also, `SAGE_FAT_BINARY` is "base" so the 3DNow would be fair game for the "fast" target. Except that, there, we already require SSE2.


---

Comment by vbraun created at 2013-07-08 14:16:53

When I build the 32-bit base/fast versions in my 32-bit virtual machine then I get doctest errors in Sage. Might be something wrong with my VM, though.


---

Comment by vbraun created at 2013-07-08 17:35:59

The doctest failures go away if I disable threading, so perhaps this breaks because I'm building on an quad-core i7. Unless sombody objects, I'd say we disable threading on 32-bit intel base/fast targets. This should probably be done independent of this issue because the "generic" library shouldn't have multithreaded thresholds being derived from the latest CPUs with lots of cores.


---

Comment by jpflori created at 2013-07-08 19:02:55

I don't really like the idea...
Please also see #14605, the way threading is dealt with is kindof completely broken right now.


---

Comment by vbraun created at 2013-07-08 19:07:31

Tell me about it.. I took your `threads.patch` to make it build at all.

But IMHO its much more important to get an ATLAS update in Sage than fixing threading bugs. So if that means we have to disable it on 32-bit then that sucks but is still better than the current state.


---

Comment by vbraun created at 2013-07-08 19:19:23

PS: The updated spkg makes the thread limit configurable via, for example,

```
SAGE_ATLAS_ARCH=threads=2,fast
}}} 
Setting the limit to 0 disables threading. Specifying the thread limit is completely optional. This is useful for testing.


---

Comment by vbraun created at 2013-07-09 17:00:52

In fact, the threaded ATLAS doesn't work on x86_64 either. I must have run the doctests in the wrong Sage install the other day?


---

Comment by vbraun created at 2013-07-09 17:43:47

My bad, liblinbox was linked with the system atlas (version 3.8.4). Mixing its threading symbols with ATLAS-3.10.1 is instant disaster.


---

Comment by jpflori created at 2013-07-09 20:44:48

Replying to [comment:29 vbraun]:
> Replying to [comment:28 jpflori]:
> > And about 3DNow, we don't want to put it in base or fast anyway because it's AMD only
> 
> Kind of a moot point since we don't distribute binaries built on such an old machine. Also, `SAGE_FAT_BINARY` is "base" so the 3DNow would be fair game for the "fast" target. Except that, there, we already require SSE2. 
It does not tackle the problem that 3DNow is AMD only...
I could imagine someone wanting to distribute a sage bdist with a "fast" but still somehow portable ATLAS.
You can still argue that in that case he can very well remove 3DNow himself if he wants ot play with fire...

I just don't like to add non-universal extensions to predifined targets although I completely agree that if we consider that someone who builds with fast should only expect it to work on the machine where it was built then trying 3DNow makes sense.

Anyway, does using 3DNow in addition of SSE or SSE2 gives any speedup?
I guess not, so let's forget about 3DNow for "fast" because we have SSE2 and for "base" because we don't want people to end up distributing AMD only binaries (though it's highly unlikely, I agree)...


---

Comment by jpflori created at 2013-07-09 20:50:53

Replying to [comment:34 vbraun]:
> PS: The updated spkg makes the thread limit configurable via, for example,
> {{{
> SAGE_ATLAS_ARCH=threads=2,fast
> }}} 
> Setting the limit to 0 disables threading. Specifying the thread limit is completely optional. This is useful for testing.
Great.


---

Comment by jpflori created at 2013-07-09 20:59:25

Replying to [comment:33 vbraun]:
> Tell me about it.. I took your `threads.patch` to make it build at all.
> 
> But IMHO its much more important to get an ATLAS update in Sage than fixing threading bugs. So if that means we have to disable it on 32-bit then that sucks but is still better than the current state.
Is this really because of the VM (or the OS?) being 32 bits?
It seems strange.
Or did you also get mixed symbols?

Anyway, I agree the base target should disable threading.
For the fast one, if we go for "the "fast" target should only run on the machine where it is built" interpretation, then it's kind of bad. But if threading is indeed broken on all 32 bits OSes, then we don't have a choice.
If we want to consider that the "fast" build is also "generic" and could be redistributed, then disabling threading is completely ok, till we decide that recent enough computers have more than one core :)


---

Comment by jpflori created at 2013-07-09 21:01:03

Replying to [comment:31 vbraun]:
> This should probably be done independent of this issue because the "generic" library shouldn't have multithreaded thresholds being derived from the latest CPUs with lots of cores.
You mean reenabling threading on 32 bits intel?
(In case it was not broken just because of mixed symbols of course.)


---

Comment by vbraun created at 2013-07-09 21:36:02

System ATLAS is (at least on Fedora) libatlas.so.3 and we install libatlas.so.2. Since I rebuilt various packages mixing system atlas (using SAGE_ATLAS_LIB) and self-compiled atlas, I ended up with a mix of symbols. I've changed our versioning to use .3 as well. Upstream doesn't version the library but since it is ATLAS 3.x most distributors will probably opt for .3.

I agree that there is no point in 3DNow on SSE-enabled processors. Its not used anywhere now.

I think that was the problem with 32-bit, too. But I'm still running tests. Will re-enable "fast" threads on 32-bit if it works...

I've changed the threads option to colon

```
SAGE_ATLAS_ARCH=threads:2,static,fast
```

and added the optional "static" to also install static libraries (though built with -fPIC, really only useful for debugging)

Finally, I'm also installing upstream's new ATLAS shared library (libsatlas.so / libtatlas.so). Eventually we'll want to switch Sage over to those, so we might just as well install them already.


---

Comment by jpflori created at 2013-07-09 21:40:48

Great only good news.
I also kind of disliked the multiple equal signs to control threading.


---

Comment by jpflori created at 2013-07-09 21:43:02

Note that having a static atlas is useful for Cygwin as libtool won't build the shared library there.


---

Comment by jpflori created at 2013-07-09 21:47:31

In particular, I suggest that if static is enabled, then don't let the whole spkg-install script fail if building the shared library failed, but building (and installing) the static one did not.


---

Comment by vbraun created at 2013-07-09 22:05:30

Does the Cygwin build actually get that far? ATLAS configure has a bunch of Cygwin-related settings and we don't touch any of that stuff.


---

Comment by vbraun created at 2013-07-10 03:16:22

I do get the error reported on #14753

```
sage -t --long sage/matrix/matrix_double_dense.pyx
**********************************************************************
File "sage/matrix/matrix_double_dense.pyx", line 3809, in sage.matrix.matrix_double_dense.Matrix_double_dense.is_positive_definite
Failed example:
    H.is_positive_definite()
Expected:
    True
Got:
    False
**********************************************************************
```

also with Fedora's version of ATLAS-3.8.4. I'm not sure that the test is actually numerically well-conditioned, it does:

```
sage: R = random_matrix(CDF, 200)
sage: H = R.conjugate_transpose()*R
sage: import scipy.linalg
sage: scipy.linalg.cholesky(H.numpy(), lower=1)
```

Depending on the distribution of `random_matrix` this may be ill-conditioned: http://stackoverflow.com/questions/12322431/generating-a-pseduo-random-positive-definite-matrix. Conditioning numbers are around `10^6` - `10^7` so its not great but not terribly bad either.


---

Attachment

Script to build atlas with base, fast, and default settings


---

Comment by jpflori created at 2013-07-10 07:23:35

Replying to [comment:45 vbraun]:
> Does the Cygwin build actually get that far? ATLAS configure has a bunch of Cygwin-related settings and we don't touch any of that stuff.
Last time I tried it finished.

I could even build shared libraries by replacing libtool calls to gcc calls for linking.


---

Comment by vbraun created at 2013-07-10 12:40:38

for review only


---

Attachment

I built base, fast, and the default (no `SAGE_ATLAS_ARCH`) on a variety of machines and `make ptestlong` succeeds in all cases. Wall time to build ATLAS:

```
                  |    base     |     fast    |    default
------------------+-------------+-------------+--------------
My Thinkpad W530  |  20m52.259s |  14m34.608s |  13m52.420s
Fedora 19 x86_64  |             |             |
------------------+-------------+-------------+--------------
Virtual Machine   |  22m16.444s |  22m23.433s | 244m25.015s
Fedora 19 i686    |             |             |
------------------+-------------+-------------+--------------
cicero on skynet  |  38m49.345s |  38m50.003s |  38m24.546s
                  |             |             |
```



---

Comment by jpflori created at 2013-07-15 13:19:35

The new patches introduce a typo:

```
raise ValuError
```


I guess you could also get rid of "autom4te.cache" in spkg-src.

Maybe document the new options threads and static.

Otherwise everything looks fine, I'm testing it right now.


---

Comment by vbraun created at 2013-07-16 20:14:53

Updated spkg, diff is

```
diff -r 4c3c4795e2b6 -r d32570dc368b spkg-install
--- a/spkg-install	Sun Jul 07 01:00:12 2013 -0400
+++ b/spkg-install	Tue Jul 16 16:13:17 2013 -0400
`@``@` -232,7 +232,7 `@``@`
             INSTALL_STATIC_LIBRARIES = True
         elif opt in ATLAS_MACHTYPE + ('fast', 'base'):
             if arch is not None:
-                raise ValuError('multiple architectures specified: {0} and {1}'.format(arch, opt))
+                raise ValueError('multiple architectures specified: {0} and {1}'.format(arch, opt))
             arch = opt
         elif opt in ATLAS_ISAEXT:
             if isa_ext is None:
diff -r 4c3c4795e2b6 -r d32570dc368b spkg-src
--- a/spkg-src	Sun Jul 07 01:00:12 2013 -0400
+++ b/spkg-src	Tue Jul 16 16:13:17 2013 -0400
`@``@` -49,6 +49,7 `@``@`
 cp -rp "$SPKG_ROOT"/patches/ATLAS-lib .
 cd ATLAS-lib
 autoreconf -fiv
+rm -rf autom4te.cache
 
 
 ### Finished creating the src/ directory
```



---

Comment by jpflori created at 2013-07-18 09:59:55

Document new options.


---

Attachment

I'm happy with Volker changes.

If he agrees with my changes to the doc, let's put this as positive review.


---

Comment by vbraun created at 2013-07-18 13:21:13

Thanks, looks good to me.


---

Comment by vbraun created at 2013-07-18 13:21:13

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-08-02 14:19:34

Resolution: fixed


---

Comment by jdemeyer created at 2013-08-14 16:17:59

See #15045 for a blocker follow-up.
