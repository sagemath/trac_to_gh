# Issue 13124: matplotlib do not handle unicode properly from command line

Issue created by migration from https://trac.sagemath.org/ticket/13296

Original creator: slabbe

Original creation time: 2012-07-26 16:01:07

Assignee: jason, was

CC:  kcrisman ddrake

Keywords: unicode, matplotlib

Using sage-5.2.rc0, unicode letter é gets replaced by "Ã©" in matplotlib plot:


```
sage: text(u'an accent : é', (1,1), color='red')
```


With #13161 the same problem appears for axes labels :


```
sage: t = text(u'an accent : é', (1,1), color='red')
sage: t.axes_labels([u'an accent : é', 'Y'])       # broken without #13161
sage: t
```


But, as mentionned in ticket #13161, if the same code is written in a file without encoding, then unicode gets printed perfectly :


```
# this is file.sage
t = text(u'an accent : é', (1,1), color='red')
t.axes_labels([u'an accent : é', 'Y'])       # broken without #13161
```


Is perfect :


```
sage: attach file.sage
sage: t
```


What is the difference between a file and the command line?


---

Comment by ppurka created at 2012-07-29 10:42:18

Not surprised why `attach file.sage` works. According to a note in `sage/misc/interpreter.py`, Sage defaults to `utf-8` if no encoding is detected.

```
    - We default to UTF-8 encoding even though PEP 263 says that
      Python files should default to ASCII.
```


But `sage file.sage` doesn't work. Probably the functions in `interpreter.py` don't get called?


---

Comment by slabbe created at 2012-07-30 13:24:57

Replying to [comment:5 ppurka]:
> According to a note in `sage/misc/interpreter.py`, Sage defaults to `utf-8` if no encoding is detected.

Using sage-5.2.rc0, I don't see this note. It diseappeared? or appeared later?
 
> But `sage file.sage` doesn't work. Probably the functions in `interpreter.py` don't get called?

But if the encoding is declared in `file.sage` :


```
# -*- coding: utf-8 -*-
# this is file.sage
t = text(u'an accent : é', (1,1), color='red')
t.axes_labels([u'an accent : é', 'Y'])       # broken without #13161
t.show()
```


then `sage file.sage` works perfectly : the accent "é" gets properly written. So the problem seems to be from the command line...


---

Comment by ppurka created at 2012-07-30 13:42:59

Replying to [comment:6 slabbe]:
> Replying to [comment:5 ppurka]:
> > According to a note in `sage/misc/interpreter.py`, Sage defaults to `utf-8` if no encoding is detected.
> 
> Using sage-5.2.rc0, I don't see this note. It diseappeared? or appeared later?

It's there in line 336 of `$SAGE_ROOT/devel/sage/sage/misc/interpreter.py`. 


> > But `sage file.sage` doesn't work. Probably the functions in `interpreter.py` don't get called?
> 
> But if the encoding is declared in `file.sage` :

Of course, it works then. All that the functions in `interpreter.py` do is put the string `-*- coding: utf-8 -*-` in the beginning of the python file they create. After that it "just works." Which is why I said that perhaps the necessary functions in the `interpreter.py` are not called when Sage is run in command line.


---

Comment by slabbe created at 2012-07-30 14:00:00

> > Using sage-5.2.rc0, I don't see this note. It diseappeared? or appeared later?
> 
> It's there in line 336 of `$SAGE_ROOT/devel/sage/sage/misc/interpreter.py`. 

My fault, I am using sage-5.2.rc0 with #12719 which changed this file.

> > > But `sage file.sage` doesn't work. Probably the functions in `interpreter.py` don't get called?
> > 
> > But if the encoding is declared in `file.sage` :
> 
> Of course, it works then. All that the functions in `interpreter.py` do is put the string `-*- coding: utf-8 -*-` in the beginning of the python file they create. After that it "just works." Which is why I said that perhaps the necessary functions in the `interpreter.py` are not called when Sage is run in command line.

Sorry, I misunderstood the "doesn't work". Thanks for the clarifications.

So now, we need to understand how to put the string `-*- coding: utf-8 -*-` somewhere for the commande line?

Sébastien


---

Comment by ppurka created at 2012-07-30 14:05:11

Replying to [comment:8 slabbe]:
> So now, we need to understand how to put the string `-*- coding: utf-8 -*-` somewhere for the commande line?

Essentially, yes. I suppose (haven't looked at it completely) sage creates a python file and then runs that under python. If so, all that would be needed to be done is make sure that this file that is created always has a header that says the encoding is utf8.


---

Comment by jhpalmieri created at 2012-07-30 17:30:17

> So now, we need to understand how to put the string -*- coding: utf-8 -*- somewhere for the commande line? 

I'm not sure this is a good idea: we shouldn't change Python's default behavior without a really good reason. If you want to use accents in a Python string, then I think you need to specify the encoding explicitly (see http://docs.python.org/howto/unicode.html, in particular [this section](http://docs.python.org/howto/unicode.html#unicode-literals-in-python-source-code)). So you should do

```
sage: text(unicode('an accent : é', encoding='utf-8'), (1,1), color='red')
```

This command works for me. Indeed,

```
sage: s = unicode('an accent : é', encoding='utf-8')
sage: ss = u'an accent : é'
sage: s == ss
False
```

and I think that the `s` version is the right way to do it. Alternatively, you can use unicode escape sequences, as in

```
text(u'an accent : \xe9', (1,1), color='red')
```

I'm not at all a unicode expert, though.

Anyway, I suggest instead adding some documentation. See the attached patch.


---

Comment by jhpalmieri created at 2012-07-30 17:31:27

Changing status from new to needs_review.


---

Attachment

Great, thanks for the documentation link. I just read all of it. I now see the difference between unicode and utf-8, which I was seeing vaguely as synonyms.

Surprisingly, whereas Sage returns `False`, in Python 2.6 and 2.7, `ss == s` returns `True`:


```python
>>> s = unicode('an accent : é', encoding='utf-8')
>>> ss = u'an accent : é'
>>> s == ss
True
```


That means utf-8 is the default encoding in Python 2.7 for unicode strings. In more details:


```python
Python 2.7.2 (default, May 30 2012, 14:00:43) 
[GCC 4.6.3] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> 'é'
'\xc3\xa9'
>>> u'é'
u'\xe9'
>>> unicode('é', encoding='utf-8')
u'\xe9'
```


But, in sage-5.0, latin1 seems to be the default encoding for unicode strings :


```python
sage: 'é'
'\xc3\xa9'
sage: u'é'
u'\xc3\xa9'
sage: unicode('é', encoding='latin1')
u'\xc3\xa9'
sage: unicode('é', encoding='utf-8')
u'\xe9'
```


I did not look at the patch yet.


---

Comment by slabbe created at 2012-07-30 19:09:12

Also, I just realized that in sage-5.2.rc0 with the new ipython at #12719, the default encoding seems to be utf-8, so that this ticket would be fixed by #12719 in its actual state :


```
sage: u'é'
u'\xe9'
```



---

Comment by slabbe created at 2012-07-30 19:48:41

I looked at the patch. All tests passed on `sage/plot/text.py`. If the behavior


```
sage: u'é'
u'\xc3\xa9'
```


is OK, I think the new documentation is a good fix and this ticket deserve a positive review. But, if we prefer the Python default way :


```
>>> u'é'
u'\xe9'
```


then I believe we need one more patch... What do you think?


---

Comment by jhpalmieri created at 2012-07-30 20:55:53

It looks like it's IPython:

```
$ sage --ipython
Python 2.7.3 (default, Jul 26 2012, 17:22:39) 
Type "copyright", "credits" or "license" for more information.

IPython 0.10.2 -- An enhanced Interactive Python.
?         -> Introduction and overview of IPython's features.
%quickref -> Quick reference.
help      -> Python's own help system.
object?   -> Details about 'object'. ?object also works, ?? prints more.

In [1]: s = unicode('an accent : é', encoding='utf-8')

In [2]: ss = u'an accent : é'

In [3]: s == ss
Out[3]: False

In [4]: s
Out[4]: u'an accent : \xe9'

In [5]: ss
Out[5]: u'an accent : \xc3\xa9'
```



---

Comment by jhpalmieri created at 2012-07-30 21:13:46

Replying to [comment:15 jhpalmieri]:
> It looks like it's IPython

and the problem is no longer there with the IPython spkg from #12719. In fact, the `text` commands in the ticket description work fine for me, with #12719 in place. So maybe this ticket should be marked as invalid, and we'll just wait until #12719?


---

Comment by ppurka created at 2012-07-31 05:58:50

I agree. If ipython fixes this magically, then we should just close this ticket as invalid and get #12719 merged.


---

Comment by slabbe created at 2012-07-31 12:59:25

I updated the title of the ticket and the description for what we learned so far, i.e. it is not a problem in matplotlib.


---

Comment by slabbe created at 2012-07-31 13:10:32

The problem is fixed in IPython 0.13 (see ticket #12719) :


```
Python 2.7.3 (default, Jul 19 2012, 21:24:57) 
Type "copyright", "credits" or "license" for more information.

IPython 0.13 -- An enhanced Interactive Python.
?         -> Introduction and overview of IPython's features.
%quickref -> Quick reference.
help      -> Python's own help system.
object?   -> Details about 'object', use 'object??' for extra details.

In [1]: 'é'
Out[1]: '\xc3\xa9'

In [2]: u'é'
Out[2]: u'\xe9'
```


and was also fixed in IPython 0.12.1 :


```
Python 2.7.2 (default, May  9 2012, 21:52:56) 
Type "copyright", "credits" or "license" for more information.

IPython 0.12.1 -- An enhanced Interactive Python.
?         -> Introduction and overview of IPython's features.
%quickref -> Quick reference.
help      -> Python's own help system.
object?   -> Details about 'object', use 'object??' for extra details.

In [1]: 'é'
Out[1]: '\xc3\xa9'

In [2]: u'é'
Out[2]: u'\xe9'
```


For now, I think we don't know how long will take #12719 (yesterday, William Stein found serious bug with it and discouraged its use). So if it takes one or two Sage version before merging #12719, maybe meanwhile we can find a way to change the default encoding of ipython from 'latin1' to 'utf-8' ?


---

Comment by jhpalmieri created at 2012-07-31 14:47:09

I don't think the default encoding is `latin1`; instead, I think that IPython does some preprocessing on strings, and that preprocessing converts `u'an accent : é'` into something different – I think it replaces it by `u'an accent : é'.encode('utf-8')`. In any case, I think fixing this the right way will involve patching IPython.


---

Comment by jdemeyer created at 2013-03-06 15:33:05

Should this be closed now that IPython has been updated?


---

Comment by jhpalmieri created at 2013-03-06 18:12:05

Yes, the problems in the ticket description seem to be solved now.


---

Comment by jdemeyer created at 2013-03-06 20:30:50

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-03-06 21:01:27

Resolution: worksforme
