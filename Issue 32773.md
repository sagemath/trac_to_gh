# Issue 32773: Update bliss to 0.77

archive/issues_032773.json:
```json
{
    "body": "CC:  @mkoeppe @kiwifb\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/33010\n\n",
    "created_at": "2021-12-10T17:50:02Z",
    "labels": [
        "PLEASE CHANGE",
        "major"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Update bliss to 0.77",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32773",
    "user": "@antonio-rojas"
}
```
CC:  @mkoeppe @kiwifb



Issue created by migration from https://trac.sagemath.org/ticket/33010





---

archive/issue_comments_467344.json:
```json
{
    "body": "Changing component from PLEASE CHANGE to packages: optional.",
    "created_at": "2021-12-10T18:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467344",
    "user": "@antonio-rojas"
}
```

Changing component from PLEASE CHANGE to packages: optional.



---

archive/issue_comments_467345.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2021-12-10T18:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467345",
    "user": "@antonio-rojas"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_467346.json:
```json
{
    "body": "The `automorphism_group_gens_from_edge_list` method still needs porting to the new `find_automorphisms` signature. Its `report` parameter no longer takes a `user_param` argument, so it can't be used to update the sage automorphism list. Some cython experts should take a look.\n----\nNew commits:",
    "created_at": "2021-12-10T18:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467346",
    "user": "@antonio-rojas"
}
```

The `automorphism_group_gens_from_edge_list` method still needs porting to the new `find_automorphisms` signature. Its `report` parameter no longer takes a `user_param` argument, so it can't be used to update the sage automorphism list. Some cython experts should take a look.
----
New commits:



---

archive/issue_comments_467347.json:
```json
{
    "body": "+1 for dropping my fork. I have archived it now: https://github.com/mkoeppe/bliss",
    "created_at": "2021-12-10T18:51:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467347",
    "user": "@mkoeppe"
}
```

+1 for dropping my fork. I have archived it now: https://github.com/mkoeppe/bliss



---

archive/issue_comments_467348.json:
```json
{
    "body": "Does the new cmake build system not have a working install target?\n\nIf it doesn't, please use `sdh_install` instead of `install` so that the installation is staged correctly",
    "created_at": "2021-12-10T18:53:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467348",
    "user": "@mkoeppe"
}
```

Does the new cmake build system not have a working install target?

If it doesn't, please use `sdh_install` instead of `install` so that the installation is staged correctly



---

archive/issue_comments_467349.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-10T18:59:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467349",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467350.json:
```json
{
    "body": "Working on a patch to fix the install. Since it is cmake and not autoconf there is no need to regenerate anything. It makes downstream packagers life easier in that regard.",
    "created_at": "2021-12-13T01:43:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467350",
    "user": "@kiwifb"
}
```

Working on a patch to fix the install. Since it is cmake and not autoconf there is no need to regenerate anything. It makes downstream packagers life easier in that regard.



---

archive/issue_comments_467351.json:
```json
{
    "body": "While working on my patch, I noticed you forgot the C header header `bliss_C.h` in your installation. I missed it on my first pass too.\n\nBut I believe it is now ready\n\n```\ndiff --git a/CMakeLists.txt b/CMakeLists.txt\nindex 01ed093..9d3085d 100644\n--- a/CMakeLists.txt\n+++ b/CMakeLists.txt\n@@ -62,3 +62,27 @@ if(USE_GMP)\n   target_link_libraries(bliss-executable ${GMP_LIBRARIES})\n endif(USE_GMP)\n set_target_properties(bliss-executable PROPERTIES OUTPUT_NAME bliss)\n+\n+include(GNUInstallDirs)\n+\n+set(\n+  BLISS_HEADERS\n+  src/bliss_C.h\n+  src/uintseqhash.hh\n+  src/abstractgraph.hh\n+  src/stats.hh\n+  src/digraph.hh\n+  src/defs.hh\n+  src/heap.hh\n+  src/graph.hh\n+  src/partition.hh\n+  src/kqueue.hh\n+  src/utils.hh\n+  src/orbit.hh\n+  src/timer.hh\n+  src/bignum.hh\n+)\n+\n+install(TARGETS bliss-executable RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})\n+install(TARGETS bliss LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR})\n+install(FILES ${BLISS_HEADERS} DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/bliss)\n```\n",
    "created_at": "2021-12-13T02:48:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467351",
    "user": "@kiwifb"
}
```

While working on my patch, I noticed you forgot the C header header `bliss_C.h` in your installation. I missed it on my first pass too.

But I believe it is now ready

```
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 01ed093..9d3085d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -62,3 +62,27 @@ if(USE_GMP)
   target_link_libraries(bliss-executable ${GMP_LIBRARIES})
 endif(USE_GMP)
 set_target_properties(bliss-executable PROPERTIES OUTPUT_NAME bliss)
+
+include(GNUInstallDirs)
+
+set(
+  BLISS_HEADERS
+  src/bliss_C.h
+  src/uintseqhash.hh
+  src/abstractgraph.hh
+  src/stats.hh
+  src/digraph.hh
+  src/defs.hh
+  src/heap.hh
+  src/graph.hh
+  src/partition.hh
+  src/kqueue.hh
+  src/utils.hh
+  src/orbit.hh
+  src/timer.hh
+  src/bignum.hh
+)
+
+install(TARGETS bliss-executable RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})
+install(TARGETS bliss LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR})
+install(FILES ${BLISS_HEADERS} DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/bliss)
```




---

archive/issue_comments_467352.json:
```json
{
    "body": "Indeed, I completely missed that, and it seems that `bliss_C.h` does provide the old `find_automorphisms` API, so it might make porting easier. OTOH, there is no C API for `canonical form`, and I don't know how feasible it is to mix C and C++ in the same pyx file.",
    "created_at": "2021-12-13T11:45:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467352",
    "user": "@antonio-rojas"
}
```

Indeed, I completely missed that, and it seems that `bliss_C.h` does provide the old `find_automorphisms` API, so it might make porting easier. OTOH, there is no C API for `canonical form`, and I don't know how feasible it is to mix C and C++ in the same pyx file.



---

archive/issue_comments_467353.json:
```json
{
    "body": "Replying to [comment:9 arojas]:\n> Indeed, I completely missed that, and it seems that `bliss_C.h` does provide the old `find_automorphisms` API, so it might make porting easier. OTOH, there is no C API for `canonical form`, and I don't know how feasible it is to mix C and C++ in the same pyx file.\n\nUnfortunately it seems that `bliss_C.h` only implements `find_automorphisms` for graphs, not for digraphs, so it is not enough. This still needs porting work.",
    "created_at": "2021-12-13T19:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467353",
    "user": "@antonio-rojas"
}
```

Replying to [comment:9 arojas]:
> Indeed, I completely missed that, and it seems that `bliss_C.h` does provide the old `find_automorphisms` API, so it might make porting easier. OTOH, there is no C API for `canonical form`, and I don't know how feasible it is to mix C and C++ in the same pyx file.

Unfortunately it seems that `bliss_C.h` only implements `find_automorphisms` for graphs, not for digraphs, so it is not enough. This still needs porting work.



---

archive/issue_comments_467354.json:
```json
{
    "body": "It's fine. We don't need to absolutely use it, but some other downstream packages may want it. I'll refresh the branch.",
    "created_at": "2021-12-13T20:55:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467354",
    "user": "@kiwifb"
}
```

It's fine. We don't need to absolutely use it, but some other downstream packages may want it. I'll refresh the branch.



---

archive/issue_comments_467355.json:
```json
{
    "body": "Do we want to provide a .pc file? Debian will probably want to add a man page again when they pick it up (policy for anything installed under `/usr/bin/`).",
    "created_at": "2021-12-13T21:22:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467355",
    "user": "@kiwifb"
}
```

Do we want to provide a .pc file? Debian will probably want to add a man page again when they pick it up (policy for anything installed under `/usr/bin/`).



---

archive/issue_comments_467356.json:
```json
{
    "body": "New commits:",
    "created_at": "2021-12-13T21:28:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467356",
    "user": "@kiwifb"
}
```

New commits:



---

archive/issue_comments_467357.json:
```json
{
    "body": "I have done some patch inspection on Gentoo and Matthias' repo. I don't think anything much has made it in the new upstream. However some changes in the code makes it hard to figure out where some patches should be applied now - if they are still needed.",
    "created_at": "2021-12-13T21:56:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467357",
    "user": "@kiwifb"
}
```

I have done some patch inspection on Gentoo and Matthias' repo. I don't think anything much has made it in the new upstream. However some changes in the code makes it hard to figure out where some patches should be applied now - if they are still needed.



---

archive/issue_comments_467358.json:
```json
{
    "body": "The latest commit reimplements the old `find_automorphisms` API in a separate header. With this branch Sage builds fine and all tests in `sage.graphs.bliss` pass.\n\nThis is a band-aid solution and I don't expect it to be merged as it is, but at least it can be useful for distros that ship an updated bliss until someone looks into porting the cython code properly.\n\nAlso, this segfaults when bliss is built with GMP support (which is not the case in Sage), but that might be an upstream issue.\n----\nNew commits:",
    "created_at": "2021-12-26T13:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467358",
    "user": "@antonio-rojas"
}
```

The latest commit reimplements the old `find_automorphisms` API in a separate header. With this branch Sage builds fine and all tests in `sage.graphs.bliss` pass.

This is a band-aid solution and I don't expect it to be merged as it is, but at least it can be useful for distros that ship an updated bliss until someone looks into porting the cython code properly.

Also, this segfaults when bliss is built with GMP support (which is not the case in Sage), but that might be an upstream issue.
----
New commits:



---

archive/issue_comments_467359.json:
```json
{
    "body": "Replying to [comment:17 arojas]:\n> Also, this segfaults when bliss is built with GMP support (which is not the case in Sage), but that might be an upstream issue.\n\nIndeed, the following segfaults when bliss is compiled with GMP:\n\n```\n#include <bliss/graph.hh>\n\nint main() {\n  bliss::Graph *g = new bliss::Graph(2);\n  bliss::Stats s;\n  g->canonical_form(s);\n  return 0;\n}\n```\n\nUnfortunately they don't seem to have a bug tracker.",
    "created_at": "2021-12-26T14:48:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467359",
    "user": "@antonio-rojas"
}
```

Replying to [comment:17 arojas]:
> Also, this segfaults when bliss is built with GMP support (which is not the case in Sage), but that might be an upstream issue.

Indeed, the following segfaults when bliss is compiled with GMP:

```
#include <bliss/graph.hh>

int main() {
  bliss::Graph *g = new bliss::Graph(2);
  bliss::Stats s;
  g->canonical_form(s);
  return 0;
}
```

Unfortunately they don't seem to have a bug tracker.



---

archive/issue_comments_467360.json:
```json
{
    "body": "The GMP issue is not new. This is exactly why the sage package is built without GMP support. I probably should ask the GMP support option to be removed in Gentoo since it is buggy.",
    "created_at": "2021-12-26T19:14:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467360",
    "user": "@kiwifb"
}
```

The GMP issue is not new. This is exactly why the sage package is built without GMP support. I probably should ask the GMP support option to be removed in Gentoo since it is buggy.



---

archive/issue_comments_467361.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-12-26T21:57:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467361",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_467362.json:
```json
{
    "body": "Replying to [comment:17 arojas]:\n> This is a band-aid solution and I don't expect it to be merged as it is\n\nin order to successfully use [e5539c5](https://git.sagemath.org/sage.git/commit?id=e5539c563cb285a2455849bd9b56933c7da97b99) today, I had to update **bliss.pyx**-related part of it:\n\n```diff\n--- a/src/sage/graphs/bliss.pyx\n+++ b/src/sage/graphs/bliss.pyx\n@@ -1,3 +1,4 @@\n+# cython: language_level=3\n # distutils: language = c++\n # distutils: libraries = bliss\n # sage_setup: distribution = sagemath-bliss\n@@ -47,22 +48,31 @@\n     cdef cppclass Graph(AbstractGraph):\n         Graph(const unsigned int)\n         void add_edge(const unsigned int, const unsigned int)\n-        void find_automorphisms(Stats&, void (*)(void* , unsigned int,\n-                    const unsigned int*), void*)\n         void change_color(const unsigned int, const unsigned int);\n-        const unsigned int* canonical_form(Stats&, void (*)(void*,unsigned int,\n+        const unsigned int* canonical_form(Stats&, void (*)(unsigned int,\n                     const unsigned int*), void*)\n \n+cdef extern from \"bliss/digraph.hh\" namespace \"bliss\":\n+\n+    cdef cppclass Stats:\n+        pass\n+\n+    cdef cppclass AbstractGraph:\n+        pass\n+\n     cdef cppclass Digraph(AbstractGraph):\n         Digraph(const unsigned int)\n         void add_edge(const unsigned int, const unsigned int)\n-        void find_automorphisms(Stats&, void (*)(void* , unsigned int,\n-                    const unsigned int*), void*)\n         void change_color(const unsigned int, const unsigned int);\n-        const unsigned int* canonical_form(Stats&, void (*)(void*,unsigned int,\n+        const unsigned int* canonical_form(Stats&, void (*)(unsigned int,\n                     const unsigned int*), void*)\n         unsigned int get_hash()\n \n+cdef extern from \"bliss_find_automorphisms.h\":\n+\n+    void bliss_find_automorphisms(Graph*, void (*)(void*, unsigned int, const unsigned int*), void*, Stats&)\n+    void bliss_find_automorphisms(Digraph*, void (*)(void*, unsigned int, const unsigned int*), void*, Stats&)\n+\n \n cdef int encoding_numbits(int n):\n     r\"\"\"\n@@ -124,7 +134,7 @@\n \n     sig_free(done)\n \n-cdef void empty_hook(void *user_param , unsigned int n, const unsigned int *aut):\n+cdef void empty_hook(unsigned int n, const unsigned int *aut):\n     return\n \n #####################################################\n@@ -640,11 +650,11 @@\n \n     if directed:\n         d = bliss_digraph_from_labelled_edges(Vnr, Lnr, Vout, Vin, labels, partition)\n-        d.find_automorphisms(s, add_gen, <void*>data)\n+        bliss_find_automorphisms(d, add_gen, <void*>data, s)\n         del d\n     else:\n         g = bliss_graph_from_labelled_edges(Vnr, Lnr, Vout, Vin, labels, partition)\n-        g.find_automorphisms(s, add_gen, <void*>data)\n+        bliss_find_automorphisms(g, add_gen, <void*>data, s)\n         del g\n \n     return [[cyc for cyc in gen if cyc[0] is not None] for gen in gens]\n```\n",
    "created_at": "2022-02-03T21:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467362",
    "user": "@sheerluck"
}
```

Replying to [comment:17 arojas]:
> This is a band-aid solution and I don't expect it to be merged as it is

in order to successfully use [e5539c5](https://git.sagemath.org/sage.git/commit?id=e5539c563cb285a2455849bd9b56933c7da97b99) today, I had to update **bliss.pyx**-related part of it:

```diff
--- a/src/sage/graphs/bliss.pyx
+++ b/src/sage/graphs/bliss.pyx
@@ -1,3 +1,4 @@
+# cython: language_level=3
 # distutils: language = c++
 # distutils: libraries = bliss
 # sage_setup: distribution = sagemath-bliss
@@ -47,22 +48,31 @@
     cdef cppclass Graph(AbstractGraph):
         Graph(const unsigned int)
         void add_edge(const unsigned int, const unsigned int)
-        void find_automorphisms(Stats&, void (*)(void* , unsigned int,
-                    const unsigned int*), void*)
         void change_color(const unsigned int, const unsigned int);
-        const unsigned int* canonical_form(Stats&, void (*)(void*,unsigned int,
+        const unsigned int* canonical_form(Stats&, void (*)(unsigned int,
                     const unsigned int*), void*)
 
+cdef extern from "bliss/digraph.hh" namespace "bliss":
+
+    cdef cppclass Stats:
+        pass
+
+    cdef cppclass AbstractGraph:
+        pass
+
     cdef cppclass Digraph(AbstractGraph):
         Digraph(const unsigned int)
         void add_edge(const unsigned int, const unsigned int)
-        void find_automorphisms(Stats&, void (*)(void* , unsigned int,
-                    const unsigned int*), void*)
         void change_color(const unsigned int, const unsigned int);
-        const unsigned int* canonical_form(Stats&, void (*)(void*,unsigned int,
+        const unsigned int* canonical_form(Stats&, void (*)(unsigned int,
                     const unsigned int*), void*)
         unsigned int get_hash()
 
+cdef extern from "bliss_find_automorphisms.h":
+
+    void bliss_find_automorphisms(Graph*, void (*)(void*, unsigned int, const unsigned int*), void*, Stats&)
+    void bliss_find_automorphisms(Digraph*, void (*)(void*, unsigned int, const unsigned int*), void*, Stats&)
+
 
 cdef int encoding_numbits(int n):
     r"""
@@ -124,7 +134,7 @@
 
     sig_free(done)
 
-cdef void empty_hook(void *user_param , unsigned int n, const unsigned int *aut):
+cdef void empty_hook(unsigned int n, const unsigned int *aut):
     return
 
 #####################################################
@@ -640,11 +650,11 @@
 
     if directed:
         d = bliss_digraph_from_labelled_edges(Vnr, Lnr, Vout, Vin, labels, partition)
-        d.find_automorphisms(s, add_gen, <void*>data)
+        bliss_find_automorphisms(d, add_gen, <void*>data, s)
         del d
     else:
         g = bliss_graph_from_labelled_edges(Vnr, Lnr, Vout, Vin, labels, partition)
-        g.find_automorphisms(s, add_gen, <void*>data)
+        bliss_find_automorphisms(g, add_gen, <void*>data, s)
         del g
 
     return [[cyc for cyc in gen if cyc[0] is not None] for gen in gens]
```




---

archive/issue_comments_467363.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-28T19:32:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32773",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32773#issuecomment-467363",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:
