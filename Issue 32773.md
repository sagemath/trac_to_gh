# Issue 32773: Update bliss to 0.77

Issue created by migration from https://trac.sagemath.org/ticket/33010

Original creator: arojas

Original creation time: 2021-12-10 17:50:02

CC:  mkoeppe fbissey




---

Comment by arojas created at 2021-12-10 18:42:26

Changing component from PLEASE CHANGE to packages: optional.


---

Comment by arojas created at 2021-12-10 18:42:26

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2021-12-10 18:42:26

The `automorphism_group_gens_from_edge_list` method still needs porting to the new `find_automorphisms` signature. Its `report` parameter no longer takes a `user_param` argument, so it can't be used to update the sage automorphism list. Some cython experts should take a look.
----
New commits:


---

Comment by mkoeppe created at 2021-12-10 18:51:40

+1 for dropping my fork. I have archived it now: https://github.com/mkoeppe/bliss


---

Comment by mkoeppe created at 2021-12-10 18:53:56

Does the new cmake build system not have a working install target?

If it doesn't, please use `sdh_install` instead of `install` so that the installation is staged correctly


---

Comment by git created at 2021-12-10 18:59:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2021-12-13 01:43:32

Working on a patch to fix the install. Since it is cmake and not autoconf there is no need to regenerate anything. It makes downstream packagers life easier in that regard.


---

Comment by fbissey created at 2021-12-13 02:48:27

While working on my patch, I noticed you forgot the C header header `bliss_C.h` in your installation. I missed it on my first pass too.

But I believe it is now ready

```
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 01ed093..9d3085d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -62,3 +62,27 @@ if(USE_GMP)
   target_link_libraries(bliss-executable ${GMP_LIBRARIES})
 endif(USE_GMP)
 set_target_properties(bliss-executable PROPERTIES OUTPUT_NAME bliss)
+
+include(GNUInstallDirs)
+
+set(
+  BLISS_HEADERS
+  src/bliss_C.h
+  src/uintseqhash.hh
+  src/abstractgraph.hh
+  src/stats.hh
+  src/digraph.hh
+  src/defs.hh
+  src/heap.hh
+  src/graph.hh
+  src/partition.hh
+  src/kqueue.hh
+  src/utils.hh
+  src/orbit.hh
+  src/timer.hh
+  src/bignum.hh
+)
+
+install(TARGETS bliss-executable RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})
+install(TARGETS bliss LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR})
+install(FILES ${BLISS_HEADERS} DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/bliss)
```



---

Comment by arojas created at 2021-12-13 11:45:58

Indeed, I completely missed that, and it seems that `bliss_C.h` does provide the old `find_automorphisms` API, so it might make porting easier. OTOH, there is no C API for `canonical form`, and I don't know how feasible it is to mix C and C++ in the same pyx file.


---

Comment by arojas created at 2021-12-13 19:58:12

Replying to [comment:9 arojas]:
> Indeed, I completely missed that, and it seems that `bliss_C.h` does provide the old `find_automorphisms` API, so it might make porting easier. OTOH, there is no C API for `canonical form`, and I don't know how feasible it is to mix C and C++ in the same pyx file.

Unfortunately it seems that `bliss_C.h` only implements `find_automorphisms` for graphs, not for digraphs, so it is not enough. This still needs porting work.


---

Comment by fbissey created at 2021-12-13 20:55:00

It's fine. We don't need to absolutely use it, but some other downstream packages may want it. I'll refresh the branch.


---

Comment by fbissey created at 2021-12-13 21:22:13

Do we want to provide a .pc file? Debian will probably want to add a man page again when they pick it up (policy for anything installed under `/usr/bin/`).


---

Comment by fbissey created at 2021-12-13 21:28:07

New commits:


---

Comment by fbissey created at 2021-12-13 21:56:23

I have done some patch inspection on Gentoo and Matthias' repo. I don't think anything much has made it in the new upstream. However some changes in the code makes it hard to figure out where some patches should be applied now - if they are still needed.


---

Comment by arojas created at 2021-12-26 13:12:47

The latest commit reimplements the old `find_automorphisms` API in a separate header. With this branch Sage builds fine and all tests in `sage.graphs.bliss` pass.

This is a band-aid solution and I don't expect it to be merged as it is, but at least it can be useful for distros that ship an updated bliss until someone looks into porting the cython code properly.

Also, this segfaults when bliss is built with GMP support (which is not the case in Sage), but that might be an upstream issue.
----
New commits:


---

Comment by arojas created at 2021-12-26 14:48:51

Replying to [comment:17 arojas]:
> Also, this segfaults when bliss is built with GMP support (which is not the case in Sage), but that might be an upstream issue.

Indeed, the following segfaults when bliss is compiled with GMP:

```
#include <bliss/graph.hh>

int main() {
  bliss::Graph *g = new bliss::Graph(2);
  bliss::Stats s;
  g->canonical_form(s);
  return 0;
}
```

Unfortunately they don't seem to have a bug tracker.


---

Comment by fbissey created at 2021-12-26 19:14:08

The GMP issue is not new. This is exactly why the sage package is built without GMP support. I probably should ask the GMP support option to be removed in Gentoo since it is buggy.


---

Comment by git created at 2021-12-26 21:57:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @sheerluck created at 2022-02-03 21:05:51

Replying to [comment:17 arojas]:
> This is a band-aid solution and I don't expect it to be merged as it is

in order to successfully use [e5539c5](https://git.sagemath.org/sage.git/commit?id=e5539c563cb285a2455849bd9b56933c7da97b99) today, I had to update **bliss.pyx**-related part of it:

```diff
--- a/src/sage/graphs/bliss.pyx
+++ b/src/sage/graphs/bliss.pyx
@@ -1,3 +1,4 @@
+# cython: language_level=3
 # distutils: language = c++
 # distutils: libraries = bliss
 # sage_setup: distribution = sagemath-bliss
@@ -47,22 +48,31 @@
     cdef cppclass Graph(AbstractGraph):
         Graph(const unsigned int)
         void add_edge(const unsigned int, const unsigned int)
-        void find_automorphisms(Stats&, void (*)(void* , unsigned int,
-                    const unsigned int*), void*)
         void change_color(const unsigned int, const unsigned int);
-        const unsigned int* canonical_form(Stats&, void (*)(void*,unsigned int,
+        const unsigned int* canonical_form(Stats&, void (*)(unsigned int,
                     const unsigned int*), void*)
 
+cdef extern from "bliss/digraph.hh" namespace "bliss":
+
+    cdef cppclass Stats:
+        pass
+
+    cdef cppclass AbstractGraph:
+        pass
+
     cdef cppclass Digraph(AbstractGraph):
         Digraph(const unsigned int)
         void add_edge(const unsigned int, const unsigned int)
-        void find_automorphisms(Stats&, void (*)(void* , unsigned int,
-                    const unsigned int*), void*)
         void change_color(const unsigned int, const unsigned int);
-        const unsigned int* canonical_form(Stats&, void (*)(void*,unsigned int,
+        const unsigned int* canonical_form(Stats&, void (*)(unsigned int,
                     const unsigned int*), void*)
         unsigned int get_hash()
 
+cdef extern from "bliss_find_automorphisms.h":
+
+    void bliss_find_automorphisms(Graph*, void (*)(void*, unsigned int, const unsigned int*), void*, Stats&)
+    void bliss_find_automorphisms(Digraph*, void (*)(void*, unsigned int, const unsigned int*), void*, Stats&)
+
 
 cdef int encoding_numbits(int n):
     r"""
@@ -124,7 +134,7 @@
 
     sig_free(done)
 
-cdef void empty_hook(void *user_param , unsigned int n, const unsigned int *aut):
+cdef void empty_hook(unsigned int n, const unsigned int *aut):
     return
 
 #####################################################
@@ -640,11 +650,11 @@
 
     if directed:
         d = bliss_digraph_from_labelled_edges(Vnr, Lnr, Vout, Vin, labels, partition)
-        d.find_automorphisms(s, add_gen, <void*>data)
+        bliss_find_automorphisms(d, add_gen, <void*>data, s)
         del d
     else:
         g = bliss_graph_from_labelled_edges(Vnr, Lnr, Vout, Vin, labels, partition)
-        g.find_automorphisms(s, add_gen, <void*>data)
+        bliss_find_automorphisms(g, add_gen, <void*>data, s)
         del g
 
     return [[cyc for cyc in gen if cyc[0] is not None] for gen in gens]
```



---

Comment by git created at 2022-02-28 19:32:27

Branch pushed to git repo; I updated commit sha1. New commits:
