# Issue 11529: Add spkg-check to Mercurial

Issue created by migration from Trac.

Original creator: kcrisman

Original creation time: 2011-08-18 15:05:16

Assignee: tbd

CC:  jason ryan kini jhpalmieri leif

Mercurial was recently upgraded at #10594.  It was mentioned there that it has self-tests.  We should enable those to be checked with `SAGE_CHECK` and an spkg-check script.


---

Comment by leif created at 2011-08-18 15:34:46

For the record: The new Mercurial spkg didn't make it into Sage 4.7.*1*.


---

Comment by kcrisman created at 2011-08-18 15:39:31

Replying to [comment:2 leif]:
> For the record: The new Mercurial spkg didn't make it into Sage 4.7.*1*.
Correct, and I didn't mean to imply that.   In theory, this wouldn't even necessarily depend on that, if the invocation for the self-tests are the same in both versions.  I'll put that in dependencies nonetheless.


---

Comment by leif created at 2011-08-18 15:43:56

P.S.:

We might actually (always) run the test suite from `spkg-install` instead (_before_ we install Mercurial), since it is a central component and -- more important -- installing it, afterwards realizing some tests fail, doesn't make much sense.


---

Comment by kcrisman created at 2011-08-18 15:47:50

> We might actually (always) run the test suite from `spkg-install` instead (_before_ we install Mercurial), since it is a central component and -- more important -- installing it, afterwards realizing some tests fail, doesn't make much sense.

I think we do this for a few packages, right?  Either one would be a fine solution to this ticket.


---

Comment by leif created at 2011-08-18 15:49:54

Replying to [comment:4 leif]:
> We might actually (always) run the test suite from `spkg-install` instead (_before_ we install Mercurial), since it is a central component and -- more important -- installing it, afterwards realizing some tests fail, doesn't make much sense.

... since the user would probably end up with a broken, perhaps broadly unusable Sage installation.

(Of course he/she should still be able to manually reinstall a previous Mercurial version though, but I think avoiding the need for that is desirable.)


---

Comment by leif created at 2011-08-18 15:56:27

Replying to [comment:5 kcrisman]:
> I think we do this for a few packages, right?  Either one would be a fine solution to this ticket.

The overall design w.r.t. `SAGE_CHECK` and `spkg-check` is a bit suboptimal. The only spkg where we unconditionally run the test suite from `spkg-install` I'm currently aware of is MPFR; there might be very few others, since we changed that in a couple of spkgs a while ago.

(I'm not sure what you mean by _either one_; just adding an `spkg-check` vs. running the test suite from `spkg-install`?)


---

Comment by kcrisman created at 2011-08-18 16:01:20

Replying to [comment:7 leif]:
> Replying to [comment:5 kcrisman]:
> > I think we do this for a few packages, right?  Either one would be a fine solution to this ticket.
> 
> The overall design w.r.t. `SAGE_CHECK` and `spkg-check` is a bit suboptimal. The only spkg where we unconditionally run the test suite from `spkg-install` I'm currently aware of is MPFR; there might be very few others, since we changed that in a couple of spkgs a while ago.
> 
> (I'm not sure what you mean by _either one_; just adding an `spkg-check` vs. running the test suite from `spkg-install`?)
Yes, either of those would be fine, unless the spkg-install version added significantly to the Sage build time.


---

Comment by jhpalmieri created at 2011-08-19 01:07:46

From the src directory, I ran "make" and then "time make tests".  On an OS X box:

```
# Ran 407 tests, 35 skipped, 32 failed.
make: *** [tests] Error 1

real	22m55.609s
user	10m16.167s
sys	8m57.330s
```

On sage.math:

```
# Ran 407 tests, 25 skipped, 2 failed.
make: *** [tests] Error 1

real	13m28.549s
user	7m48.570s
sys	2m27.840s
```

I haven't looked at the output to try to figure out what the failures were, but in any case, this testing process takes _much_ longer than the build process.  So I think that we should put this into an `spkg-check` file, not into `spkg-install`.  It would be then be annoying to have another spkg (along with python) which is known to fail self-tests on standard platforms.


---

Comment by kcrisman created at 2011-08-19 01:21:37

Agreed - definitely let's not make this standard.


---

Comment by leif created at 2011-08-19 02:31:33

Replying to [comment:10 kcrisman]:
> Agreed - definitely let's not make this standard.

... or modify the tests run "by default" by patching the Makefile; this of course requires sorting out which tests fail where (and probably why), so room for a follow-up I guess.


---

Comment by jhpalmieri created at 2011-08-19 16:20:13

Replying to [comment:11 leif]:
> Replying to [comment:10 kcrisman]:
> > Agreed - definitely let's not make this standard.
> 
> ... or modify the tests run "by default" by patching the Makefile; this of course requires sorting out which tests fail where (and probably why), so room for a follow-up I guess.

My point for making it non-standard wasn't the failures, it was the time required.  To install the spkg takes under 5 seconds on my OS X box, whereas running self-tests takes 23 minutes.  We can't add this much time to the default Sage installation, especially since Mercurial seems to function just fine -- the failures don't seem to be too important.  In my opinion, if we want to make some tests standard, we have to just run a few absolutely crucial ones so we don't add too much time; the full test suite is way too large to include every time.

If we can identify which tests fail and why, and if those particular tests aren't important for our uses, then I agree that (probably on a follow-up) we should document those failures, so people know they may not be getting a fully functional Mercurial installation, and skip those tests.  (It would be nice to do the same for the Python spkg...)


---

Comment by jhpalmieri created at 2011-08-19 16:28:33

Actually, rather than editing the Makefile, we can do `make test-foo` for various values of `foo`.


---

Comment by jhpalmieri created at 2014-01-31 19:36:16

Let's close this, since we no longer distribute Mercurial.


---

Comment by jhpalmieri created at 2014-01-31 19:36:16

Changing status from new to needs_review.


---

Comment by jhpalmieri created at 2014-01-31 19:36:22

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-02-01 21:35:10

Resolution: fixed


---

Comment by vbraun created at 2014-02-01 21:35:28

Resolution changed from fixed to wontfix
