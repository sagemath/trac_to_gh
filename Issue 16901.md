# Issue 16901: LatticePoset: complements() is broken

Issue created by migration from Trac.

Original creator: jmantysalo

Original creation time: 2014-10-12 12:02:32

CC:  ncohen

Complement of an element of lattice, if it exists, is not necessarily unique. Hence returning an array from `complements()` seems to be totally wrong. Right way is to return a dict of lists if called without arguments and a list if called with one element as argument.


---

Comment by git created at 2014-10-13 08:28:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-13 08:30:26

Because `complements()` make sense for lattices, not for posets in general, I think that function can be removed from `hasse_diagram.py`. Otherwise I didn't even think about good algorithm etc.


---

Comment by jmantysalo created at 2014-10-13 08:30:26

Changing status from new to needs_review.


---

Comment by ncohen created at 2014-10-13 09:04:18

Hello !

- depreceated -> deprecated

- `Use FiniteLattices::complements()` -- this is not C++ ! Plus the message should probably be "complements() is only defined on LatticePoset" or something. I mean, an error message telling the user that he should change the poset's type itself.

- Given how broken that function is, perhaps it is better to raise an exception rather than a warning.. What do you think ? Besides, that function is defined in `HasseDiagram` which are not really meant to be used directly anyway.

- (Do as you like but) the "comps" loop could have been rewritten as

```
return {self._vertex_to_element(u):map(self._vertex_to_element,l)
        for u,l in c.iteritems()
        if l}
```


- Why do you test `cardinality==0` instead of `if x not in self` ?

- `for x in self.list()` can also be written `for x in self`

Nathann


---

Comment by jmantysalo created at 2014-10-13 13:11:14

Replying to [comment:5 ncohen]:

> - depreceated -> deprecated
> - `for x in self.list()` can also be written `for x in self`

Done this.

> - (Do as you like but) the "comps" loop could have been rewritten as - -

This says `AttributeError: 'list' object has no attribute 'iteritems'`.

> - Why do you test `cardinality==0` instead of `if x not in self` ?

Running `meet()` or `join()` will check that element belongs to the lattice, the only exception is empty lattice. (Well, partly because of that the code is non-optimal. But at least it works.)

> - `Use FiniteLattices::complements()` -- this is not C++ ! Plus the message should probably be "complements() is only defined on LatticePoset" or something. I mean, an error message telling the user that he should change the poset's type itself.
> 
> - Given how broken that function is, perhaps it is better to raise an exception rather than a warning.. What do you think ? Besides, that function is defined in `HasseDiagram` which are not really meant to be used directly anyway.

I don't know. Can function from `HasseDiagram` be directly deleted without deprecating it first? For now I changed phrasing in the message.


---

Comment by git created at 2014-10-13 13:11:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-10-13 13:15:29

Yo !

> > - (Do as you like but) the "comps" loop could have been rewritten as - -
> 
> This says `AttributeError: 'list' object has no attribute 'iteritems'`.

`O_o`

`comps` seems to be a dictionary in your code, not a list `O_o`

> Running `meet()` or `join()` will check that element belongs to the lattice, the only exception is empty lattice. (Well, partly because of that the code is non-optimal. But at least it works.)

`O_o`

Well, it would still be clearer to check 'element in self' rather than the cardinality `O_o`

> I don't know. Can function from `HasseDiagram` be directly deleted without deprecating it first? For now I changed phrasing in the message.

We can keep it like that, it does not matter much. One year from now we will remove it, no harm done I guess.

Nathann


---

Comment by git created at 2014-10-13 13:57:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-10-13 22:10:23

All tests pass !

Thanks,

Nathann


---

Comment by ncohen created at 2014-10-13 22:10:23

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-14 21:38:01

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2014-10-14 21:38:01

Int/string have no stable sort order:

```
sage -t --long src/sage/combinat/posets/lattices.py
**********************************************************************
File "src/sage/combinat/posets/lattices.py", line 433, in sage.combinat.posets.lattices.FiniteLatticePoset.complements
Failed example:
    L.complements()
Expected:
    {0: [1], 1: [0], 'a': ['b', 'c'], 'b': ['c', 'a'], 'c': ['b', 'a']}
Got:
    {'a': ['b', 'c'], 'b': ['c', 'a'], 'c': ['b', 'a'], 0: [1], 1: [0]}
**********************************************************************
```



---

Comment by git created at 2014-10-15 04:43:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-15 04:45:16

Addedd "# random" to doctest.


---

Comment by jmantysalo created at 2014-10-15 04:45:16

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-10-15 07:55:02

Hmmmmmm.... The problem with 'random' flags is that it basically means that the output is not tested. Could you write a real doctest in a "TEST" section ? Something that tests that what the output claims to be complements indeed yield the top as their meet and the bottom as their join ?

Otherwise this function actually is not tested.

Nathann


---

Comment by jmantysalo created at 2014-10-15 07:58:32

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-10-15 08:18:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-10-15 08:18:23

Something like this?


---

Comment by ncohen created at 2014-10-15 08:39:22

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-10-15 08:39:22

No, that would not work. Here is the reason:

1) The order in which elements are listed when you iterate upon the elements of a dictionary is architecture-dependent. If you write a doctest that just 'displays' the content of a dictionary, it will break on some machines. The problem is not only the order of the lists of complements.

2) Actually, there is in Sage a 'hack' that reorders the entry of a dictionary before they are displayed. I expect that it uses a 'sort' or something, which works fine if you have only integers or only strings as keys to your dictionary. On the other hand, Volker says that comparing int and strings can be architecture dependent, as it is probably done according to the memory locations

3) I believe that "random order" should be just "random"

I added a commit which does some non-architecture-dependent checks on the output of the function. Tell me what you think, and you can set the ticket to `positive_review` if you agree with it !

Thanks,

Nathann
----
New commits:


---

Comment by jmantysalo created at 2014-10-15 08:51:02

Replying to [comment:18 ncohen]:

> 1) The order in which elements are listed when you iterate upon the elements of a dictionary is architecture-dependent. If you write a doctest that just 'displays' the content of a dictionary, it will break on some machines. The problem is not only the order of the lists of complements.

What??? Is `sorted('a', 42)` architecture-dependent? I understand that `print {'a':'b', 42:43}` is, but that is different thing.

> 2) Actually, there is in Sage a 'hack' that reorders the entry of a dictionary before they are displayed.

OK, I understand the basic idea behind it. Maybe Volker will tell the actual code doing this.

> 3) I believe that "random order" should be just "random"

Documentation says if comment _contains_ strgin "random", then it will not be tested. So one could write for example "Slightly random due numerical approximations". But not an important thing.

> I added a commit which does some non-architecture-dependent checks on the output of the function. Tell me what you think, and you can set the ticket to `positive_review` if you agree with it !

Works. Thanks.

(Actually I think posets might have real test suite. Maybe later...)


---

Comment by jmantysalo created at 2014-10-15 08:51:02

Changing status from needs_review to positive_review.


---

Comment by ncohen created at 2014-10-15 08:57:01

Yo !

> What??? Is `sorted('a', 42)` architecture-dependent? I understand that `print {'a':'b', 42:43}` is, but that is different thing.

Oh sorry, perhaps not architecture dependent but 'unreliable'. It may even change on the same computer I guess, but I have no idea. Volker will know. In Sage, however, I was told that dictionaries output is sorted first, so that should be equivalent as far as doctests are concerned.

> Documentation says if comment _contains_ strgin "random", then it will not be tested. So one could write for example "Slightly random due numerical approximations". But not an important thing.

Yeah but then people come and say that you should not put too many words there, because your 'random order' doctest will also be tested if you do --optional=order

Nathann


---

Comment by jmantysalo created at 2014-10-15 10:01:37

OK, comments from Nathann read and understood.


---

Comment by vbraun created at 2014-10-15 10:29:53

The order in `sorted(['a', 42])` is random (depends on memory location). `sorted(['a', '42'])` is not. Dictionaries are sorted by key in the displayhook, so if you don't mix strings and ints as keys then they are always printed he same. 

Possible solutions 
* don't mix string and int as keys
* Doctest equality of dicts `L.complements() == {...}` instead of the dict repr


---

Comment by jmantysalo created at 2014-10-15 10:41:54

Thanks Volker. From the user perspective I think that `do_something() --> some_output` is much better example than `do_something()==some_output --> True`.

I was thinking about usual convention of having `0` and `1` as bottom and top element of a lattice. Maybe `'0'` instead of `0` is better. I will think this later (but polishind documentation on posets will go before lattices). For now this can be as it is.


---

Comment by vbraun created at 2014-10-15 18:12:32

Resolution: fixed
