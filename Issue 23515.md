# Issue 23515: Use different history file for unit tests

Issue created by migration from Trac.

Original creator: slelievre

Original creation time: 2017-08-30 13:32:34

CC:  @tobiasdiez jhpalmieri mjo mkoeppe slelievre

Reported on sage-support [0]:

> After rebuilding and running sage, these three things appeared when I press the up key:
> 
> {{{
> sage: trace('print(factor(10))'); print(3+97)
> sage: print([sys.stdin.isatty(), sys.stdout.isatty()])
> sage: 3^33
> }}}
>
> I have no idea what to make of that. I never typed any of those.

[0] https://groups.google.com/d/topic/sage-support/OXhmYOt0ULg/discussion


---

Comment by roed created at 2017-09-03 17:56:47

Changing component from PLEASE CHANGE to doctest framework.


---

Comment by jhpalmieri created at 2017-09-03 18:42:33

Will this do it?

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 1e8abd1f2d..f5fc8e039c 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
`@``@` -27,7 +27,7 `@``@` import six
 import sage.misc.flatten
 from sage.structure.sage_object import SageObject
 from sage.env import DOT_SAGE, SAGE_LIB, SAGE_SRC
-from sage.misc.temporary_file import tmp_dir
+from sage.misc.temporary_file import tmp_dir, tmp_filename
 from cysignals.signals import AlarmInterrupt, init_cysignals
 
 from .sources import FileDocTestSource, DictAsObject
`@``@` -1206,12 +1206,14 `@``@` def run_doctests(module, options=None):
     # Determine whether we're in doctest mode
     save_dtmode = sage.doctest.DOCTEST_MODE
 
+    IP = get_ipython()
+    IP.history_manager.hist_file = tmp_filename()
+
     # We need the following if we're not in DOCTEST_MODE
     # Tell IPython to avoid colors: it screws up the output checking.
     if not save_dtmode:
         if options.debug:
             raise ValueError("You should not try to run doctests with a debugger from within Sage: IPython objects to embedded shells")
-        IP = get_ipython()
         old_color = IP.colors
         IP.run_line_magic('colors', 'NoColor')
         old_config_color = IP.config.TerminalInteractiveShell.colors
```



---

Comment by jhpalmieri created at 2017-09-04 02:02:58

To answer my own question, no, this won't do it. The file `DOT_SAGE/ipython-5.0.0/profile_default/history.sqlite` is still modified when doctesting `sage/misc/trace.py`, and the command history is modified accordingly.


---

Comment by slelievre created at 2019-05-20 10:41:44

Related: 

- #26409: Use custom DOT_SAGE for testing


---

Comment by slelievre created at 2019-05-20 10:46:00

Change milestone to sage-wishlist for a few tickets whose previous milestone is closed.


---

Comment by slelievre created at 2021-02-22 01:19:17

Changing type from PLEASE CHANGE to defect.


---

Comment by mjo created at 2021-02-22 01:57:01

Is it math? No? Delete it!
