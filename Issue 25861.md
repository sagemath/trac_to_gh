# Issue 25861: using Dokchitser setting direct from pari

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2018-08-20 14:30:01

CC:  cremona davidlowry

to replace using the compute_L.gp script

not yet working.. help is welcome


---

Comment by chapoton created at 2018-08-20 14:30:26

Changing keywords from "" to "dokchitser".


---

Comment by git created at 2018-08-20 14:30:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-20 18:28:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-08-20 22:19:10

Good idea! It's something that I always wanted to do but never found the time...

Some immediate comments:

1. Regarding

```
"""
Dokchitser's L-functions Calculator from Pari

AUTHORS:

- Tim Dokchitser (2002): original PARI code and algorithm (and the
  documentation below is based on Dokchitser's docs).

- William Stein (2006-03-08): Sage interface

"""
```


To what extent is this related to code from Dokchitser or Stein? If the answer is "not at all", then the author block, the copyright block, the name of the module and the name of the class `Dokchitser_Pari` should be fixed.

2. Assigning `self.pari = Pari()` looks strange as there is really one PARI running. Better be honest about that and use a single global `pari` variable (you can import it from `sage.libs.pari`).

3. `self.pari('default(realprecision, %s)')` is a bad idea for multiple reasons. The proper way to deal with precisions in library mode is either to set the precision argument for every function call or to use inexact inputs.

4. Avoid using global PARI variables like in the `pari_precode` example `tau(n)=...`. Remember that there is only one global PARI instance, so global variables are global state! If you want functions, why not use actual functions (using the `->` syntax)?


---

Comment by git created at 2018-08-21 09:05:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-21 09:16:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-21 09:22:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-08-21 09:48:38

Some more comments:

5. You can replace `pari.FUNCTION(pari(FOO))` by `pari.FUNCTION(FOO)`.

6. It is still not clear to me why you keeping using "dokchitser" (I may be missing something, but then it should be clarified)

7. Using the `.sage()` method is often not the best way to convert a PARI object to Sage because you loose information about the parent. For example:

```
sage: x = RR.pi()
sage: parix = pari(x)
sage: parent(parix.sage())
Real Field with 64 bits of precision
```

It would be better to replace `parix.sage()` by `RR(parix)` in this case.


---

Comment by chapoton created at 2018-08-21 10:05:53

Replying to [comment:9 jdemeyer]:
> Some more comments:
> 
> 5. You can replace `pari.FUNCTION(pari(FOO))` by `pari.FUNCTION(FOO)`.

will do

> 6. It is still not clear to me why you keeping using "dokchitser" (I may be missing something, but then it should be clarified)

There are Dokchitser's algorithms (described in a famous article in Experimental Math) and Dokchitser's implementation of them (that we use so far). Pari is using (maybe an enhanced version of) the algorithms of Dokchitser or at least similar basic ideas.


---

Comment by git created at 2018-08-21 10:08:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-21 12:00:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-08-21 12:04:20

New commits:


---

Comment by jdemeyer created at 2018-08-21 12:15:06

Replying to [comment:10 chapoton]:
> Pari is using (maybe an enhanced version of) the algorithms of Dokchitser or at least similar basic ideas.

I don't think that is sufficient reason to use the name "Dokchitser". Personally, I think it is especially confusing because we also have Dokchitser's GP scripts (where he is the actual author). I would rather name the module `lfunctions_pari.py` or something along those lines.


---

Comment by chapoton created at 2018-08-21 15:03:21

here is a new branch, with squashed commits

What is still lacking is a correct handling of precision

To people of lmfdb, is this something of interest for you ?
----
New commits:


---

Comment by git created at 2018-08-21 15:20:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-21 15:56:59

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-08-21 15:58:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2018-08-21 18:48:48

Replying to [comment:15 chapoton]:
> What is still lacking is a correct handling of precision

Every function where precision matters takes a `precision` argument. For example

```
sage: pari(1).sin(precision=64).sage()
0.841470984807896507
sage: pari(1).sin(precision=256).sage()
0.8414709848078965066525023216302989996225630607983710656727517099919104043912
```



---

Comment by jdemeyer created at 2018-08-21 19:01:48

It would be nice to support calling `lfuncreate` in `LFunction.__init__`. Something like

```
        if isinstance(lfun, lfun_generic):
            # preparation using Dokchitser data
            self._L = lfun.lfun()
        elif isinstance(lfun, Gen):
            # already some Pari lfun
            self._L = lfun
        else:
            # create a PARI lfunction from input data
            self._L = pari.lfuncreate(lfun)
```

This would remove the need for `lfun_elliptic_curve()` and `lfun_number_field()`.


---

Comment by jdemeyer created at 2018-08-21 19:03:57

Note that PARI functions also act as methods. So you could replace

```
pari.lfun(self._L, s)
```

by the simpler

```
self._L.lfun(s)
```



---

Comment by chapoton created at 2018-08-21 19:17:10

Concerning precision, this is not so easy..

```
sage: from sage.lfunctions.lfunctions_pari import *
sage: lf = lfun_number_field(QQ)
sage: pari.lfun(lf, 2)
1.64493406684823
sage: pari.lfun(lf, 2, precision=200)
1.64493406684823
sage: pari.lfun(lf, ComplexField(200)(2))
1.64493406684823
```



I also have a difficulty with passing a function as you suggested.


---

Comment by jdemeyer created at 2018-08-21 19:24:54

Replying to [comment:23 chapoton]:
> Concerning precision, this is not so easy..

Don't confuse the printed output by PARI with the actual output. Try again adding `.sage()` to those examples.


---

Comment by git created at 2018-08-21 19:27:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-08-21 19:29:59

Replying to [comment:23 chapoton]:
> I also have a difficulty with passing a function as you suggested.

Are you getting the error `incorrect type in vecan_closure [wrong arity] (t_CLOSURE)`? That could be considered a `cypari2` bug.


---

Comment by jdemeyer created at 2018-08-21 19:44:16

Support for functions in `cypari2` is still incomplete, but this hack works for me:

```
sage: def zeta_coeffs(n):
....:     return [1 for i in range(n)]
sage: zeta = pari.lfuncreate([pari("f -> (n -> f(n))")(zeta_coeffs), 1, [0], 1, 1, 1, 1])
```


It's quite important to keep a reference to the function `zeta_coeffs`, otherwise this will crash.


---

Comment by git created at 2018-08-21 19:50:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-23 19:33:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-08-23 19:34:55

some things that remain to be done:

* be able to have L function for Dirichlet characters
* fix the doctest with Ramanujan tau, how to handle that ?
* make sure that poles and residues are handled correctly


---

Comment by git created at 2018-08-24 18:34:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-25 07:04:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-08-25 07:50:58

according to K. Belabas, one should rather wait for pari 2.11


---

Comment by git created at 2018-08-25 14:05:54

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-08-28 06:43:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-08-29 15:58:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-03 12:09:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-04 19:39:55

Still not able to make that work:

```
+        sage: from sage.lfunctions.lfunctions_pari import lfun_generic, LFunction
+        sage: lf = lfun_generic(conductor=1, gammaV=[0,1], weight=12, eps=1)
+        sage: tau = pari('n->(5*sigma(n,3)+7*sigma(n,5))*n/12 - 35*sum(k=1,n-1,(6*k-4*(n-k))*sigma(k,3)*sigma(n-k,5))')
+        sage: lf.init_coeffs(tau)
+        sage: L = LFunction(lf)
```



---

Comment by jdemeyer created at 2018-09-04 19:50:15

To make it easier for me to help, it would be good to say why it doesn't work. I don't want to recompile this branch this branch every time just to answer your comments.


---

Comment by chapoton created at 2018-09-04 20:24:54

Well.

```
sage: from sage.lfunctions.lfunctions_pari import lfun_generic, LFunction
sage: lf = lfun_generic(conductor=1, gammaV=[0,1], weight=12, eps=1)
sage: tau = pari('n->(5*sigma(n,3)+7*sigma(n,5))*n/12 - 35*sum(k=1,n-1,(6*k-4*(n
....: -k))*sigma(k,3)*sigma(n-k,5))')
sage: lf.init_coeffs(tau)
sage: L = LFunction(lf)
```

All this works, or seems to. But here is the traceback.

```
sage: L(5)
---------------------------------------------------------------------------
PariError                                 Traceback (most recent call last)
<ipython-input-6-fd3c681015b7> in <module>()
----> 1 L(Integer(5))

/home/chapoton/sage/local/lib/python2.7/site-packages/sage/lfunctions/lfunctions_pari.pyc in __call__(self, s)
    635             pass
    636         try:
--> 637             value = pari.lfun(self._L, s, precision=self.prec).sage()
    638         except NameError:
    639             raise ArithmeticError('pole here')

cypari2/auto_instance.pxi in cypari2.pari_instance.Pari_auto.lfun()

cypari2/handle_error.pyx in cypari2.handle_error._pari_err_handle()

PariError: incorrect type in vecan_closure (t_INT)
```

Not clear to me where this "t_INT" could come from. And the failure appears only at a late stage..


---

Comment by jdemeyer created at 2018-09-04 20:52:31

The function is supposed to return a vector with `n` components, not a single number. See the docs for `lfuncreate`.

So you should conceptually replace `n->f(n)` by `n->vector(n, k, f(k))`.


---

Comment by git created at 2018-09-05 15:44:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-08 19:52:21

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-09-08 20:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 08:20:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 09:38:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 13:59:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-09 17:44:15

ok, bot is green. Maybe ready for a first review ?


---

Comment by cremona created at 2018-09-09 18:49:43

Just a few quick comments to start with, as I have not yet built the code or looked in detail at the new interface:

   1. In the example for a Dirichlet L-function can you add the display of L itself to show the effect of its having been renamed?

   2. The docstring for delta_lseries is surely wrong: only one of the options interfaces with the (soon to be obsolete?) code of Tim Dok.  And why is the default not the new pari version?  Same for Dedekind Zeta.

   3. Should we have some examples computed with both gp and pari to show how they compare?


---

Comment by git created at 2018-09-09 19:20:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 19:23:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-09-09 19:25:24

Replying to [comment:52 cremona]:
> Just a few quick comments to start with, as I have not yet built the code or looked in detail at the new interface:
> 
>    1. In the example for a Dirichlet L-function can you add the display of L itself to show the effect of its having been renamed?

Sure, done.

>    2. The docstring for delta_lseries is surely wrong: only one of the options interfaces with the (soon to be obsolete?) code of Tim Dok.  And why is the default not the new pari version?  Same for Dedekind Zeta.

Fixed the docstring of delta_lseries

Concerning the switch to "pari" by default, maybe this new interface is not yet mature enough.
 
>    3. Should we have some examples computed with both gp and pari to show how they compare?

But this is already the case, I think.


---

Comment by git created at 2018-09-09 19:36:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 19:47:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2018-09-09 19:59:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2018-09-09 20:04:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-09-10 10:19:45

As I mentioned before, try to avoid using the `.sage()` method for PARI objects, as it doesn't give control over the resulting parent. In general, an explicit conversion like

```
R(pari_object)
```

should be preferred over

```
pari_object.sage()
```



---

Comment by jdemeyer created at 2018-09-10 10:23:48

In other words: the `.sage()` method exists mostly for convenience, not for correctness.


---

Comment by jdemeyer created at 2018-09-10 10:25:16

The changes to `src/sage/schemes/elliptic_curves/ell_generic.py` look independent from the rest of this ticket, could they be split off?


---

Comment by chapoton created at 2018-09-10 12:31:18

I have separated the change in pari conversion of elliptic curves over number fields (#26232).


---

Comment by git created at 2018-09-10 12:39:47

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-09-10 12:40:34

Not using ".sage()" seems to result in 3 or 4 less digits...


---

Comment by cremona created at 2018-09-10 13:13:58

I agree with `@`jdemeyer that using x.sage() is dangerous.  I am right now writing code which gets some quite complicated data back from gp functions and am having to write customised conversion functions.


---

Comment by git created at 2018-09-20 19:14:24

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-09-21 15:26:59

the remaining failing doctest is due to the dependency to #26232


---

Comment by git created at 2018-10-05 08:47:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-10-10 06:48:57

Replacing the last .sage() seems to result in 3 less digits in the results. Should I do that nevertheless ?

```
Failed example:
    L(2)
Expected:
    1.64493406684822644
Got:
    1.64493406684823
```



---

Comment by cremona created at 2018-10-10 08:07:21

Do you mean that it shows fewer decimals with .sage() than without?  When converting to/from pari remember that Sage allows any bit precision but pari only allows multiples of 32 (or something like that).  So often the underlying pari computation is more precise than necessary.


---

Comment by git created at 2018-10-10 19:45:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2018-11-09 13:09:22

Any other comment on this proposal ? I feel that this is not quite polished, but maybe already useful. I would appreciate feedback.


---

Comment by chapoton created at 2019-02-18 16:49:17

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2019-02-25 09:28:35

Rebased to 8.7.beta5 (fixed trivial merge conflict).
----
New commits:


---

Comment by jdemeyer created at 2019-02-25 10:08:54

I have various comments, but it's probably easier for both of us if I just add an extra commit.


---

Comment by chapoton created at 2019-02-25 12:22:16

Yes, for sure. Please do.


---

Comment by git created at 2019-02-25 16:06:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2019-02-25 16:07:38

This is very much work in progress. I'm currently working on cypari2 to add support for `__floordiv__` (for some reason, this was missing) and closures of a given arity. That will help for this ticket.


---

Comment by jdemeyer created at 2019-02-25 16:07:44

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2019-03-08 19:21:58

Changing keywords from "dokchitser" to "dokchitser, lseries, zeta".


---

Comment by chapoton created at 2019-03-16 17:25:34

`@`jdemeyer, is the cypari part now ok ? I have seen the floordiv was added.


---

Comment by jdemeyer created at 2019-03-16 20:12:37

Yes indeed, I added some functionality to cypari2.


---

Comment by chapoton created at 2019-03-17 08:51:23

I have fixed some of the doctests. But I am slightly worried by the increase in the number of required coefficients.
----
New commits:


---

Comment by jdemeyer created at 2019-03-17 10:04:10

One thing to note is that the default precision with the PARI implementation is 53, but it was 64 with the GP scripts.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by git created at 2019-04-16 10:07:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2019-04-16 10:07:50

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-04-16 10:07:50

doctests fixed, back to needs review


---

Comment by chapoton created at 2019-04-16 11:41:15

and the bot is now green


---

Comment by tscrim created at 2019-04-17 22:56:46

A comment and a question:

`RANK 1 ELLIPTIC CURVE:` -> `.. RUBRIC:: Rank 1 elliptic curve` (see, e.g., `combinat/root_system/cartan_type.py`)

Should `init_coeffs` be exposed to the user as a public function? If so, should it be allowed to be run multiple times?


---

Comment by git created at 2019-04-24 11:57:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-05-22 15:42:45

Can we please try to move on here ? This seems to me to be a progress over the current situation, even if a tiny one.

I think one can keep `init_coeffs` as a public method, to be used as explained:

```
+        Initialisation of a :pari:`lfun` from motivic data.
+
+        This can happen either in one stage or in two stages: the coefficients
+        can be given using the ``init`` keyword, or entered using
+        the :meth:`init_coeffs`.
```


There remains something not very clear about the handling of poles and residues.

I would like to get more feedback from lmfdb or pari people.


---

Comment by git created at 2019-06-25 14:38:18

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by chapoton created at 2019-07-13 11:34:55

bot is morally green


---

Comment by tscrim created at 2019-07-13 17:13:21

Sorry for taking time to get back to this.

I do not quite understand the necessity of the `init_coeffs` method. I feel like there would be more standard ways to refactor that out (for example, just allowing initialization as normal). Or is this meant to be something done more lazily? You could also remove the `__init` attribute by just setting `self._L = None` in the `__init__` and checking against that.

A little bit better doc formatting IMO:

```diff
-    Create a PARI `L`-function (:pari:`lfun` instance) with
+    Create a PARI `L`-function (:pari:`lfun` instance) with::
 
-    ``lfun_generic(conductor, gammaV, weight, eps, poles, residues, init)``
+        lfun_generic(conductor, gammaV, weight, eps, poles, residues, init)
```


This seems dubious to me:

```python
    values_on_gens = (chi(x) for x in pari_gens)

    # now compute the input for pari (list of exponents)
    P = chi.parent()
    if is_ComplexField(P.base_ring()):
        zeta = P.zeta()
        zeta_argument = zeta.argument()
        v = [int(round(x.argument() / zeta_argument))
             for x in values_on_gens()]   # <<<---- This part here
    else:
        dlog = P._zeta_dlog
        v = [dlog[x] for x in values_on_gens]
```

with `value_on_gens` being a generator object, I don't think it should be callable.

`check_functional_equation` could use some more standard docstring formatting.

Otherwise everything else LGTM. A lot of these points I do not care about too much (since I doubt I will ever use this code because it is outside my research area), but I still feel it is worth a quick moment of thought.


---

Comment by git created at 2019-07-14 08:46:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2019-08-21 01:55:55

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-08-21 01:55:55

Thanks. LGTM. (Sorry, I didn't notice the update.)


---

Comment by kcrisman created at 2019-08-21 02:13:25

Regarding the Dirichlet L-functions, see also #16477.  Does this ticket supersede it or at least implement some of it?  (Maybe it only does it for Dirichlet characters and not general arithmetic functions.)


---

Comment by vbraun created at 2019-08-29 20:02:17

Resolution: fixed
