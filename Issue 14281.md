# Issue 14281: Creation of a polynomial over QQbar

archive/issues_014281.json:
```json
{
    "body": "Assignee: @malb\n\nCC:  @burcin\n\nKeywords: QQbar, polynomial\n\nHere is the issue: there is no problem buildind a polynomial over AA:\n\n\n```\nsage: R = AA[x]                       \nsage: P = R(x^6+x^5+x^4-x^3+x^2-x+2/5)\n```\n\n\nBut the same operation does not work on QQbar:\n\n\n```\nsage: S = QQbar[x]\nsage: Q = S(x^6+x^5+x^4-x^3+x^2-x+2/5)\nTraceback (most recent call last)\n...\nNotImplementedError: symbol\n```\n\n\nHovewer, this workaround works:\n\n\n```\nsage: Q = P.change_ring(QQbar)\n```\n\n\nWeird isn't it ?\n\nIssue created by migration from https://trac.sagemath.org/ticket/14485\n\n",
    "created_at": "2013-04-24T21:59:52Z",
    "labels": [
        "component: commutative algebra",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-7.2",
    "title": "Creation of a polynomial over QQbar",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14281",
    "user": "https://trac.sagemath.org/admin/accounts/users/tmonteil"
}
```
Assignee: @malb

CC:  @burcin

Keywords: QQbar, polynomial

Here is the issue: there is no problem buildind a polynomial over AA:


```
sage: R = AA[x]                       
sage: P = R(x^6+x^5+x^4-x^3+x^2-x+2/5)
```


But the same operation does not work on QQbar:


```
sage: S = QQbar[x]
sage: Q = S(x^6+x^5+x^4-x^3+x^2-x+2/5)
Traceback (most recent call last)
...
NotImplementedError: symbol
```


Hovewer, this workaround works:


```
sage: Q = P.change_ring(QQbar)
```


Weird isn't it ?

Issue created by migration from https://trac.sagemath.org/ticket/14485





---

archive/issue_comments_179745.json:
```json
{
    "body": "The weirdness is really just limited to the difference in behaviour between these:\n\n```\nsage: AA['x'](var('x'))\nx\nsage: QQbar['x'](var('x'))\nNotImplementedError: symbol\n```\n\nThe thing that's failing in the latter case is\n\n```\nQQbar._element_constructor_(x)\n```\n\nand\n\n```\nAA._element_constructor_(x)\n```\n\nfails in exactly the same way. That suggest that in the case of `AA['x']` something is tried before resorting to the thing that fails for `QQbar['x']`.\n\nFor instance,\n\n```\nAA['y'](var('x'))\nQQbar['y'](var('x'))\n```\n\nboth (rightly) fail,but with significantly different tracebacks. This might give some indication of what is tried for `AA` but not for `QQbar`.",
    "created_at": "2013-04-24T22:42:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179745",
    "user": "https://github.com/nbruin"
}
```

The weirdness is really just limited to the difference in behaviour between these:

```
sage: AA['x'](var('x'))
x
sage: QQbar['x'](var('x'))
NotImplementedError: symbol
```

The thing that's failing in the latter case is

```
QQbar._element_constructor_(x)
```

and

```
AA._element_constructor_(x)
```

fails in exactly the same way. That suggest that in the case of `AA['x']` something is tried before resorting to the thing that fails for `QQbar['x']`.

For instance,

```
AA['y'](var('x'))
QQbar['y'](var('x'))
```

both (rightly) fail,but with significantly different tracebacks. This might give some indication of what is tried for `AA` but not for `QQbar`.



---

archive/issue_comments_179746.json:
```json
{
    "body": "The thing that goes wrong is the following:\n\n```\nsage: S=QQbar['x']\nsage: S.base_ring().has_coerce_map_from(SR)\nTrue\n```\n\nOnce this is found, it's clear how an element of `SR` should be converted into `QQbar['x']`: `SR` already coerces into `QQbar` itself, so we should just convert the element into a \"constant polynomial\".\n\nExcept, of course, that `SR` doesn't really coerce into `QQbar`: Only \"constant\" expressions might (and even then, of course `pi` doesn't), and `x` of course isn't one of those. So the proper solution is probably to NOT install a coercion from SR to QQbar, because it isn't a coercion anyway. It's only a partial map. Doing so is probably going to be painful for something else.\n\nThis problem doesn't arise for `AA` because it's pretty clear that not even algebraic elements fit in `AA`, so no coercion is installed.",
    "created_at": "2013-04-24T23:19:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179746",
    "user": "https://github.com/nbruin"
}
```

The thing that goes wrong is the following:

```
sage: S=QQbar['x']
sage: S.base_ring().has_coerce_map_from(SR)
True
```

Once this is found, it's clear how an element of `SR` should be converted into `QQbar['x']`: `SR` already coerces into `QQbar` itself, so we should just convert the element into a "constant polynomial".

Except, of course, that `SR` doesn't really coerce into `QQbar`: Only "constant" expressions might (and even then, of course `pi` doesn't), and `x` of course isn't one of those. So the proper solution is probably to NOT install a coercion from SR to QQbar, because it isn't a coercion anyway. It's only a partial map. Doing so is probably going to be painful for something else.

This problem doesn't arise for `AA` because it's pretty clear that not even algebraic elements fit in `AA`, so no coercion is installed.



---

archive/issue_comments_179747.json:
```json
{
    "body": "Attachment [trac_14485.patch](tarball://root/attachments/some-uuid/ticket14485/trac_14485.patch) by @nbruin created at 2013-04-24 23:31:42\n\nDon't pretend there is a coercion from the symbolic ring into QQbar",
    "created_at": "2013-04-24T23:31:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179747",
    "user": "https://github.com/nbruin"
}
```

Attachment [trac_14485.patch](tarball://root/attachments/some-uuid/ticket14485/trac_14485.patch) by @nbruin created at 2013-04-24 23:31:42

Don't pretend there is a coercion from the symbolic ring into QQbar



---

archive/issue_comments_179748.json:
```json
{
    "body": "Changing priority from major to minor.",
    "created_at": "2013-04-24T23:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179748",
    "user": "https://github.com/nbruin"
}
```

Changing priority from major to minor.



---

archive/issue_comments_179749.json:
```json
{
    "body": "OK, solving a ticket by deleting two lines is just too appealing to pass by. Of course, there is are all kinds of things that fail this way, e.g.\n\n```\nQQbar(1)+sqrt(2)\n```\n\ndoesn't work anymore, but `QQbar(1)+QQbar(sqrt(2))` of course still does.",
    "created_at": "2013-04-24T23:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179749",
    "user": "https://github.com/nbruin"
}
```

OK, solving a ticket by deleting two lines is just too appealing to pass by. Of course, there is are all kinds of things that fail this way, e.g.

```
QQbar(1)+sqrt(2)
```

doesn't work anymore, but `QQbar(1)+QQbar(sqrt(2))` of course still does.



---

archive/issue_comments_179750.json:
```json
{
    "body": "I was going to report another problem caused by the bogus coercion from `SR`:\n\n```\nsage: CC.has_coerce_map_from(QQbar)\nTrue\nsage: QQbar.has_coerce_map_from(SR)\nTrue\nsage: CC.has_coerce_map_from(SR)\nFalse\n```\n\nSo I'm all in favor of removing it, even if it breaks stuff that should never have worked in the first place.\n\nWe might want to put (or actually put back?) a coercion in the other direction, since symbolic expressions can embed elements of `QQbar`. But `SR` has coerce maps from `RR`, `CC`, `RLF`, etc., which yield other coercions from `QQbar` by composition. Can we consider that all these maps are the same because they only differ in the \"precision\" of the result? Or should all coercions from inexact rings to `QQbar` be removed? (Note that the coercion from `QQ` to `SR` has exactly the same problem.)",
    "created_at": "2013-12-28T14:41:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179750",
    "user": "https://github.com/mezzarobba"
}
```

I was going to report another problem caused by the bogus coercion from `SR`:

```
sage: CC.has_coerce_map_from(QQbar)
True
sage: QQbar.has_coerce_map_from(SR)
True
sage: CC.has_coerce_map_from(SR)
False
```

So I'm all in favor of removing it, even if it breaks stuff that should never have worked in the first place.

We might want to put (or actually put back?) a coercion in the other direction, since symbolic expressions can embed elements of `QQbar`. But `SR` has coerce maps from `RR`, `CC`, `RLF`, etc., which yield other coercions from `QQbar` by composition. Can we consider that all these maps are the same because they only differ in the "precision" of the result? Or should all coercions from inexact rings to `QQbar` be removed? (Note that the coercion from `QQ` to `SR` has exactly the same problem.)



---

archive/issue_comments_179751.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-03-25T12:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179751",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_179752.json:
```json
{
    "body": "As it turns out, it is possible to remove the coercion from `SR` to `QQbar` without breaking too many things. Moreover, most of the workarounds I had to add are there to deal with the case of `I` and will no longer be necessary once #5355 (or #12715) and/or #18036 are fixed (but I suggest we *dont't* wait fix this to happen).\n----\nNew commits:",
    "created_at": "2016-03-25T12:13:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179752",
    "user": "https://github.com/mezzarobba"
}
```

As it turns out, it is possible to remove the coercion from `SR` to `QQbar` without breaking too many things. Moreover, most of the workarounds I had to add are there to deal with the case of `I` and will no longer be necessary once #5355 (or #12715) and/or #18036 are fixed (but I suggest we *dont't* wait fix this to happen).
----
New commits:



---

archive/issue_comments_179753.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-03-25T12:18:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179753",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_179754.json:
```json
{
    "body": "Patchbot: `sage -t --long src/sage/graphs/matchpoly.pyx  # 1 doctest failed`",
    "created_at": "2016-03-26T09:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179754",
    "user": "https://github.com/rwst"
}
```

Patchbot: `sage -t --long src/sage/graphs/matchpoly.pyx  # 1 doctest failed`



---

archive/issue_comments_179755.json:
```json
{
    "body": "Thanks for the notice. It works here, as well as with the other patchbots. I have no idea at all what is going on.\n\nJeroen, that `sage4` is one of your patchbots, isn't it? Would you mind having a quick look at the failing test?",
    "created_at": "2016-03-26T11:52:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179755",
    "user": "https://github.com/mezzarobba"
}
```

Thanks for the notice. It works here, as well as with the other patchbots. I have no idea at all what is going on.

Jeroen, that `sage4` is one of your patchbots, isn't it? Would you mind having a quick look at the failing test?



---

archive/issue_comments_179756.json:
```json
{
    "body": "You should get rid of the function `_late_import` since it is not used anymore. And it would be better to simplify the code of `_coerce_map_from_` as\n\n```\nreturn from_par == ZZ or from_par == QQ or from_par == int or \\\n       from_par == long or from_par == AA or from_par == QQbar\n```\n\nMoreover, I am not sure if coercion from `int/long` is necessary here since a conversion would exists through `ZZ`.",
    "created_at": "2016-04-05T17:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179756",
    "user": "https://github.com/videlec"
}
```

You should get rid of the function `_late_import` since it is not used anymore. And it would be better to simplify the code of `_coerce_map_from_` as

```
return from_par == ZZ or from_par == QQ or from_par == int or \
       from_par == long or from_par == AA or from_par == QQbar
```

Moreover, I am not sure if coercion from `int/long` is necessary here since a conversion would exists through `ZZ`.



---

archive/issue_comments_179757.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-04-05T17:24:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179757",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_179758.json:
```json
{
    "body": "Replying to [comment:16 vdelecroix]:\n> You should get rid of the function `_late_import` since it is not used anymore.\n\nIndeed, I didn't notice, thanks!\n\n> And it would be better to simplify the code of `_coerce_map_from_` as\n> {{{\n> return from_par == ZZ or from_par == QQ or from_par == int or \\\n>        from_par == long or from_par == AA or from_par == QQbar\n> }}}\n\nThe original style made sense to me so I refrained from making unnecessary changes, but if you prefer this version, fine. I also replaced the `==` with `is`.\n\n> Moreover, I am not sure if coercion from `int/long` is necessary here since a conversion would exists through `ZZ`.\n\n`AlgebraicNumber_base.__init__` also has a code path for `int` and `long` initializers, but they end up being converted to `ZZ`, so I guess it won't hurt to remove these cases. Done.",
    "created_at": "2016-04-06T06:58:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179758",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:16 vdelecroix]:
> You should get rid of the function `_late_import` since it is not used anymore.

Indeed, I didn't notice, thanks!

> And it would be better to simplify the code of `_coerce_map_from_` as
> {{{
> return from_par == ZZ or from_par == QQ or from_par == int or \
>        from_par == long or from_par == AA or from_par == QQbar
> }}}

The original style made sense to me so I refrained from making unnecessary changes, but if you prefer this version, fine. I also replaced the `==` with `is`.

> Moreover, I am not sure if coercion from `int/long` is necessary here since a conversion would exists through `ZZ`.

`AlgebraicNumber_base.__init__` also has a code path for `int` and `long` initializers, but they end up being converted to `ZZ`, so I guess it won't hurt to remove these cases. Done.



---

archive/issue_comments_179759.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-04-06T07:18:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179759",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_179760.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2016-04-06T08:40:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179760",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_179761.json:
```json
{
    "body": "While working on something else I saw the following comment in `symbolic/functions.pyx` line 473\n\n```\n# There is no natural coercion from QQbar to the symbolic ring\n# in order to support\n#     sage: QQbar(sqrt(2)) + sqrt(3)\n#     3.146264369941973?\n# to work around this limitation, we manually convert\n# elements of QQbar to symbolic expressions here     \n```\n",
    "created_at": "2016-04-06T13:58:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179761",
    "user": "https://github.com/videlec"
}
```

While working on something else I saw the following comment in `symbolic/functions.pyx` line 473

```
# There is no natural coercion from QQbar to the symbolic ring
# in order to support
#     sage: QQbar(sqrt(2)) + sqrt(3)
#     3.146264369941973?
# to work around this limitation, we manually convert
# elements of QQbar to symbolic expressions here     
```




---

archive/issue_comments_179762.json:
```json
{
    "body": "Replying to [comment:20 vdelecroix]:\n> While working on something else I saw the following comment in `symbolic/functions.pyx` line 473\n> {{{\n> # There is no natural coercion from QQbar to the symbolic ring\n> # in order to support\n> #     sage: QQbar(sqrt(2)) + sqrt(3)\n> #     3.146264369941973?\n> # to work around this limitation, we manually convert\n> # elements of QQbar to symbolic expressions here     \n> }}}\n\nThe patches on this ticket remove this comment and the corresponding code. I think people now agree that even if it was more or less intentional, trying to support this was a bad idea.",
    "created_at": "2016-04-06T14:52:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179762",
    "user": "https://github.com/mezzarobba"
}
```

Replying to [comment:20 vdelecroix]:
> While working on something else I saw the following comment in `symbolic/functions.pyx` line 473
> {{{
> # There is no natural coercion from QQbar to the symbolic ring
> # in order to support
> #     sage: QQbar(sqrt(2)) + sqrt(3)
> #     3.146264369941973?
> # to work around this limitation, we manually convert
> # elements of QQbar to symbolic expressions here     
> }}}

The patches on this ticket remove this comment and the corresponding code. I think people now agree that even if it was more or less intentional, trying to support this was a bad idea.



---

archive/issue_comments_179763.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2016-04-06T17:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179763",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_179764.json:
```json
{
    "body": "let it be!",
    "created_at": "2016-04-06T17:08:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179764",
    "user": "https://github.com/videlec"
}
```

let it be!



---

archive/issue_comments_179765.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2016-04-08T22:40:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179765",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_179766.json:
```json
{
    "body": "Replying to [comment:21 mmezzarobba]:\n> Replying to [comment:20 vdelecroix]:\n> > While working on something else I saw the following comment in `symbolic/functions.pyx` line 473\n> > {{{\n> > # There is no natural coercion from QQbar to the symbolic ring\n> > # in order to support\n> > #     sage: QQbar(sqrt(2)) + sqrt(3)\n> > #     3.146264369941973?\n> > # to work around this limitation, we manually convert\n> > # elements of QQbar to symbolic expressions here     \n> > }}}\n> \n> The patches on this ticket remove this comment and the corresponding code. I think people now agree that even if it was more or less intentional, trying to support this was a bad idea.\nSee also #17790, #18832, #20312",
    "created_at": "2016-04-09T06:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14281",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14281#issuecomment-179766",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:21 mmezzarobba]:
> Replying to [comment:20 vdelecroix]:
> > While working on something else I saw the following comment in `symbolic/functions.pyx` line 473
> > {{{
> > # There is no natural coercion from QQbar to the symbolic ring
> > # in order to support
> > #     sage: QQbar(sqrt(2)) + sqrt(3)
> > #     3.146264369941973?
> > # to work around this limitation, we manually convert
> > # elements of QQbar to symbolic expressions here     
> > }}}
> 
> The patches on this ticket remove this comment and the corresponding code. I think people now agree that even if it was more or less intentional, trying to support this was a bad idea.
See also #17790, #18832, #20312
