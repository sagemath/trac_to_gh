# Issue 28867: Add to tox.ini a homebrew toxenv (with a fresh install not in /usr/local)

Issue created by migration from https://trac.sagemath.org/ticket/29104

Original creator: mkoeppe

Original creation time: 2020-01-29 15:48:19

CC:  dimpase jhpalmieri @mwageringel vbraun tscrim

#29053 adds `tox.ini` to support testing the sage distribution in isolated environments via docker.

This ticket adds a toxenv for testing with an isolated installation of homebrew on macOS (not using docker).


---

Comment by mkoeppe created at 2020-01-29 19:05:00

Last 10 new commits:


---

Comment by git created at 2020-01-29 20:01:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-29 20:11:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-29 21:15:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-01-30 04:33:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-30 04:35:23

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-02-05 17:52:49

Is this ticket MacOS-specific?


---

Comment by mkoeppe created at 2020-02-05 18:32:28

Hmm, I haven’t tried linuxbrew. Might be worth checking


---

Comment by dimpase created at 2020-02-05 18:34:37

I'll fire up my vintage OSX 10.13 macbookair...


---

Comment by git created at 2020-02-06 14:26:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-02-07 21:44:24

I tried this:

```
tox -p auto -e local-homebrew-macos-standard
```

and got

```
...
[sagelib-9.1.beta2] user	0m10.244s
[sagelib-9.1.beta2] sys	0m3.812s

real	0m16.288s
user	0m10.956s
sys	0m4.047s
Sage build/upgrade complete!
✔ OK local-homebrew-macos-standard in 1 minute, 14.362 seconds
_________________________________________________________________________________________________ summary __________________________________________________________________________________________________
  local-homebrew-macos-standard: commands succeeded
  congratulations :)
```


not tests were run, it seems, is this normal?


---

Comment by mkoeppe created at 2020-02-08 22:44:54

The default packages set in `tox.ini` are only `fflas_ffpack scipy r`, and those (and their dependencies) are checked.
I don't know why it's actually building sagelib, but I hope to fix bizarre build behavior like this in #29113.


---

Comment by git created at 2020-02-16 20:44:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-04 00:55:04

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-03-08 20:53:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-08 20:54:17

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-03-08 21:02:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-11 19:35:31

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @mwageringel created at 2020-03-11 20:35:53

- mpc should be `libmpc`
- `tachyon` does not seem to be the package we use
- `pari` cannot currently be used by Sage because the pari packages are not in Homebrew
- `glpk` 4.65 should not be used by Sage as long as it is not patched by Homebrew, see #24824

I also have these Homebrew packages installed:

```
cmake freetype gcc git libpng pcre pkg-config openssl xz zeromq
```

Some of these might already be installed automatically as dependencies of others.

Additionally there are:

```
sagemath/science/flint sagemath/science/arb
```

Though, I am not sure about how `flint` in homebrew-core is different from this one.


---

Comment by git created at 2020-03-11 20:37:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-11 20:55:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-11 20:56:23

https://github.com/sagemath/homebrew-science/commits/master

adds NTL support for flint, and also ensbles TLS.

we can cook up more of these formulae, theain obstacle for me there was that they ate in Ruby.
----
New commits:


---

Comment by mkoeppe created at 2020-03-11 21:06:03


```
==> Installing sagemath/science/arb
==> Downloading https://homebrew.bintray.com/bottles-science/arb-2.16.0.sierra.bottle.tar.gz
##O=#  #                                                                      
curl: (22) The requested URL returned error: 404 Not Found
Error: Failed to download resource "arb"
Download failed: https://homebrew.bintray.com/bottles-science/arb-2.16.0.sierra.bottle.tar.gz
Warning: Bottle installation failed: building from source.
==> Downloading https://github.com/fredrik-johansson/arb/archive/2.16.0.tar.gz
==> Downloading from https://codeload.github.com/fredrik-johansson/arb/tar.gz/2.16.0
######################################################################## 100.0%
```



---

Comment by git created at 2020-03-11 21:07:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-03-11 21:10:02

Replying to [comment:30 mkoeppe]:
> {{{
> ==> Installing sagemath/science/arb
> ==> Downloading https://homebrew.bintray.com/bottles-science/arb-2.16.0.sierra.bottle.tar.gz
> ##O=#  #                                                                      
> curl: (22) The requested URL returned error: 404 Not Found
> Error: Failed to download resource "arb"
> Download failed: https://homebrew.bintray.com/bottles-science/arb-2.16.0.sierra.bottle.tar.gz
> Warning: Bottle installation failed: building from source.
> ==> Downloading https://github.com/fredrik-johansson/arb/archive/2.16.0.tar.gz
> ==> Downloading from https://codeload.github.com/fredrik-johansson/arb/tar.gz/2.16.0
> ######################################################################## 100.0%
> }}}
yes, this is expected. No binaries.


---

Comment by git created at 2020-03-11 21:29:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-11 21:59:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-11 22:15:18


```
Checking whether SageMath should install SPKG openblas...
checking BLAS library... openblas
checking whether any of gfortran is installed or will be installed as SPKG... no
checking for openblas >= 0.2.20... yes
checking for library containing cblas_dgemm... no
checking for cblas... no
checking for library containing ... no
checking for lapack... no
configure: no suitable system package found for SPKG openblas
```

The tests for `cblas_dgemm` etc. do not seem to use `OPENBLAS_LIBS` at all!


---

Comment by @mwageringel created at 2020-03-11 22:49:33

Replying to [comment:29 dimpase]:
> https://github.com/sagemath/homebrew-science/commits/master
> 
> adds NTL support for flint, and also ensbles TLS.
> 
> we can cook up more of these formulae, theain obstacle for me there was that they ate in Ruby.

There seems to be a conflict between `flint` and `sagemath/science/flint`, as `sagemath/science/arb` installs `flint` from homebrew-core as a dependency (which has been added to Homebrew very recently). I am using

```
brew install sagemath/science/flint
brew install --ignore-dependencies sagemath/science/arb
```

as a workaround now, but the arb formula probably needs to be updated.


---

Comment by git created at 2020-03-11 23:03:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-11 23:10:07

This line (introduced in #29071):

```
        AC_FC_FREEFORM([AC_FC_FUNC([dgeqrf])])
```

is not executed at all because `AC_FC_FREEFORM` is `AC_DEFUN_ONCE` and is called already in `gfortran/spkg-configure.m4`

As a result:

```
Checking whether SageMath should install SPKG openblas...
checking BLAS library... openblas
checking whether any of gfortran is installed or will be installed as SPKG... no
checking for openblas >= 0.2.20... yes
checking for cblas_dgemm... yes
checking for ... no
checking for lapack... no
configure: no suitable system package found for SPKG openblas
```



---

Comment by git created at 2020-03-11 23:45:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-11 23:53:30

Not accepted by configure yet: `glpk`, `r`


---

Comment by mkoeppe created at 2020-03-11 23:55:38

(resolved)


---

Comment by dimpase created at 2020-03-11 23:58:36

Replying to [comment:39 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[52ef59e](https://git.sagemath.org/sage.git/commit/?id=52ef59ed13d878e1a0de0bec999a9d23a442ca6f)||`build/pkgs/openblas/spkg-configure.m4: Do not use AC_FC_FUNC.`||

why? If `AC_FC_FREEFORM` can only be called once, we can move
the call to `AC_FC_FUNC` to the very place it's called.
How about

```diff
--- a/build/pkgs/gfortran/spkg-configure.m4
+++ b/build/pkgs/gfortran/spkg-configure.m4
@@ -6,7 +6,10 @@ SAGE_SPKG_CONFIGURE([gfortran], [
     # This helps verify the compiler works too, so if some idiot sets FC to
     # /usr/bin/ls, we will at least know it's not a working Fortran
     # compiler.
-    AC_FC_FREEFORM([SAGE_HAVE_FC_FREEFORM=yes], [
+    AC_FC_FREEFORM([
+        SAGE_HAVE_FC_FREEFORM=yes
+        AC_FC_FUNC([dgeqrf])
+       ], [
        AC_MSG_NOTICE([Your Fortran compiler does not accept free-format source code])
         AC_MSG_NOTICE([which means the compiler is either seriously broken, or])
         AC_MSG_NOTICE([is too old to build Sage.])
diff --git a/build/pkgs/openblas/spkg-configure.m4 b/build/pkgs/openblas/spkg-configure.m4
index c37db649be..ecc7540ee9 100644
--- a/build/pkgs/openblas/spkg-configure.m4
+++ b/build/pkgs/openblas/spkg-configure.m4
@@ -9,7 +9,6 @@ SAGE_SPKG_CONFIGURE([openblas], [
              dnl openblas does not work as cblas; try to use system's cblas as is
              PKG_CHECK_MODULES([CBLAS], [cblas], [], [sage_spkg_install_openblas=yes])
           ])
-       AC_FC_FREEFORM([AC_FC_FUNC([dgeqrf])])
        AC_SEARCH_LIBS([$dgeqrf], [openblas], [dnl openblas works as lapack
              sage_install_lapack_pc=yes
              ], [
```



---

Comment by mkoeppe created at 2020-03-12 00:00:44

OK... let me try


---

Comment by dimpase created at 2020-03-12 00:07:04

Replying to [comment:43 mkoeppe]:
> OK... let me try

it appears to work with gfortan etc installed:

```
-----------------------------------------------------------------------------
Checking whether SageMath should install SPKG openblas...
checking BLAS library... openblas
checking whether any of gfortran is installed or will be installed as SPKG... no
checking for OPENBLAS... yes
checking for library containing cblas_dgemm... -lopenblas
checking for library containing dgeqrf_... none required
configure: will use system package and not install SPKG openblas
```


but perhaps it would be throwing up a surprise if there wasn't any.


---

Comment by git created at 2020-03-12 00:11:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-12 00:26:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-12 00:44:58

matplotlib install fails:

```
    REQUIRED DEPENDENCIES AND EXTENSIONS
                     numpy: yes [not found. pip may install it below.]
          install_requires: yes [handled by setuptools]
                    libagg: yes [pkg-config information for 'libagg' could not
                            be found. Using local copy.]
                  freetype: yes [version 2.10.1]
                       png: no  [The C/C++ header for libpng (png.h) could not
                            be found.  You may need to install the development
                            package.]
                     qhull: yes [pkg-config information for 'libqhull' could not
                            be found. Using local copy.]
...
                            * The following required packages can not be built:
                            * png
                            * Try installing png with `brew install libpng` and
                            * pkg-config with `brew install pkg-config`
Cleaning up...

  }}}


---

Comment by mkoeppe created at 2020-03-12 00:47:07

cysignals testsuite fails:

```
  [cysignals-1.10.2]   ulimit 2>/dev/null -s 1024; sage-python23 -B rundoctests.py src/cysignals/*.pyx
  [cysignals-1.10.2]   Doctesting 5 files.
  [cysignals-1.10.2]   Traceback (most recent call last):
  [cysignals-1.10.2]     File "rundoctests.py", line 74, in <module>
  [cysignals-1.10.2]       resource.setrlimit(resource.RLIMIT_STACK, (stacksize, stacksize))
  [cysignals-1.10.2]   ValueError: current limit exceeds maximum limit
  [cysignals-1.10.2]   make[4]: *** [check-doctest] Error 1
  [cysignals-1.10.2]   cd example && sage-python23 setup.py clean build
 }}}


---

Comment by git created at 2020-03-12 02:23:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-03-12 02:35:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-12 02:46:07

Ready for review.


---

Comment by mkoeppe created at 2020-03-12 03:26:32

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2020-03-12 03:43:37

The AC_FC_FUNC business broke all `-minimal` targets
(https://github.com/mkoeppe/sage/actions/runs/54084841)


---

Comment by git created at 2020-03-12 03:53:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-12 03:58:11

New tests at https://github.com/mkoeppe/sage/actions/runs/54093138


---

Comment by mkoeppe created at 2020-03-12 03:58:27

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-03-12 16:12:32

Needs review


---

Comment by mkoeppe created at 2020-03-13 21:09:26

Both `homebrew-macos-minimal` (logs: https://github.com/mkoeppe/sage/suites/515691370/artifacts/2830410) and `homebrew-macos-standard` (logs: https://github.com/mkoeppe/sage/suites/515691370/artifacts/2830411)  now build correctly all the way to `sagelib`.


---

Comment by mkoeppe created at 2020-03-13 23:40:54

Some doctest failures similar to this:

```
File "src/sage/structure/element.pyx", line 3945, in sage.structure.element.EuclideanDomainElement._mod_
Failed example:
    cython('''
    from sage.structure.element cimport EuclideanDomainElement
    cdef class MyElt(EuclideanDomainElement):
        def quo_rem(self, other):
            return self._parent.var('quo,rem')
    ''')
Expected nothing
Got:
    ld: warning: directory not found for option '-L/Users/runner/runners/2.165.2/work/sage/sage/.tox/local-homebrew-macos-minimal/homebrew/opt/readline/lib'
```



---

Comment by git created at 2020-03-14 20:21:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-15 03:36:35

Replying to [comment:59 mkoeppe]:
> Some doctest failures similar to this: [...readline...]
These are now fixed. Very few remaining doctest failures and timeouts for `homebrew-macos-minimal` (https://github.com/mkoeppe/sage/runs/508217498):

```
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
sage -t src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t src/sage/plot/plot3d/base.pyx  # Timed out
sage -t src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
sage -t src/sage/plot/plot3d/shapes2.py  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
```


`homebrew-macos-standard` (https://github.com/mkoeppe/sage/runs/508217500) has many more doctest failures.
Looks like there is some problem with singular.
Some messages from singular:   `univariate factorization depends on NTL(missing)`

In that build, Sage is using the homebrew NTL:

```
Checking whether SageMath should install SPKG ntl...
checking installing gmp/mpir? ... no
checking NTL/ZZ.h usability... yes
checking NTL/ZZ.h presence... yes
checking for NTL/ZZ.h... yes
checking whether we can link a program using NTL... yes
checking NTL version >= 10.3... 11.4.3
configure: will use system package and not install SPKG ntl
using ntl library from the system
```

... but Singular does not find it ....

```
checking for NTL >= 5.0... not found
configure: WARNING: Unable to find NTL (which is strongly recommended) on your machine: please use --with-ntl=PATH_TO_DIR_CONTAINING_LIB_AND_INCLUDE (see also ./configure --help if you do not understand what we are talking about)
```



---

Comment by git created at 2020-03-15 04:58:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-15 05:00:18

New tests at https://github.com/mkoeppe/sage/actions/runs/55944733


---

Comment by mkoeppe created at 2020-03-15 15:50:45

With #29335 merged, Singular finds homebrew's NTL but then I get the following linker error (https://github.com/mkoeppe/sage/runs/508693083):

```
  [singular-4.1.1p2.p0]   ld: illegal thread local variable reference to regular symbol __ZN3NTL13ErrorCallbackE for architecture x86_64
  [singular-4.1.1p2.p0]   clang: error: linker command failed with exit code 1 (use -v to see invocation)
  [singular-4.1.1p2.p0]   make[8]: *** [libSingular.la] Error 1
```



---

Comment by dimpase created at 2020-03-15 15:56:18

this is about absence of coherence on TLS between Singular and Flint.


---

Comment by mkoeppe created at 2020-03-15 18:37:38

Replying to [comment:66 dimpase]:
> this is about absence of coherence on TLS between Singular and Flint.
OK, is there a way to enable use of TLS with Singular?


---

Comment by git created at 2020-03-15 18:52:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-16 19:13:07

Build logs for `homebrew-macos-standard` at https://github.com/mkoeppe/sage/runs/511533264


---

Comment by git created at 2020-03-16 19:13:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-16 20:12:15

Replying to [comment:70 mkoeppe]:
> Build logs for `homebrew-macos-standard` at https://github.com/mkoeppe/sage/runs/511533264

```
  [sagelib-9.1.beta7]   ld: illegal thread local variable reference to regular symbol __ZN3NTL20ZZXFac_InitNumPrimesE for architecture x86_64
  [sagelib-9.1.beta7]   clang: error: linker command failed with exit code 1 (use -v to see invocation)
```



---

Comment by mkoeppe created at 2020-03-16 20:40:17

I guess this means that another library is picking up the system installation of NTL...


---

Comment by git created at 2020-03-16 20:43:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-16 20:44:38

New test: https://github.com/mkoeppe/sage/runs/512132585


---

Comment by @mwageringel created at 2020-03-16 20:47:45

Replying to [comment:36 gh-mwageringel]:
> There seems to be a conflict between `flint` and `sagemath/science/flint`, as `sagemath/science/arb` installs `flint` from homebrew-core as a dependency (which has been added to Homebrew very recently). I am using
> {{{
> brew install sagemath/science/flint
> brew install --ignore-dependencies sagemath/science/arb
> }}}
> as a workaround now, but the arb formula probably needs to be updated.

As can be seen in the build logs above, `sagemath/science/arb` installs `flint` from homebrew-core as a dependency. Later, `sagemath/science/flint` is installed only because of `brew upgrade`. This only seems to work because of the coincidence that `sagemath/science/flint` has a higher version number than `flint`, currently. However, `sagemath/science/arb` is only compiled with `flint` (without ntl support) – it is not recompiled after installing `sagemath/science/flint`.

I have opened a [pull request](https://github.com/sagemath/homebrew-science/pull/1) to resolve this.


---

Comment by @mwageringel created at 2020-03-16 20:55:02

Replying to [comment:75 mkoeppe]:
> New test: https://github.com/mkoeppe/sage/runs/512132585

If you remove ntl, you probably also need to remove flint and arb, as they depend on it.


---

Comment by git created at 2020-03-16 21:12:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-16 21:23:22

Thank you!


---

Comment by mkoeppe created at 2020-03-16 21:27:27

New tests at https://github.com/mkoeppe/sage/runs/512243289


---

Comment by dimpase created at 2020-03-18 02:06:25

I had no idea that a ticket about homebrew would be touching fedora-related stuff, and in this I essentially created a duplicate of that work on #29352

It's much better to create separate tickets for unrelated problems - not the least as it gives them a chance of being discovered.


---

Comment by mkoeppe created at 2020-03-18 02:32:32

OK. What can I do to facilitate review?


---

Comment by dimpase created at 2020-03-18 02:37:25

I cannot review MacOS-related things - I don't have access to the needed OS.
But I would be happy to look at the other things that got silently bundled here.


---

Comment by mkoeppe created at 2020-03-18 02:40:08

OK, then let me move the fedora.txt files to #29352
and the other linux .txt files to a new ticket.


---

Comment by mkoeppe created at 2020-03-18 16:45:19

Replying to [comment:84 mkoeppe]:
> OK, then let me move the fedora.txt files to #29352
> and the other linux .txt files to a new ticket.
Actually, as noted on #29352, most of the files were added in #29273.


---

Comment by mkoeppe created at 2020-03-18 16:46:16

`@`gh-mwageringel Would you be able to review this ticket?


---

Comment by @mwageringel created at 2020-03-18 17:10:52

Replying to [comment:86 mkoeppe]:
> `@`gh-mwageringel Would you be able to review this ticket?
Yes, I will look into that. Though, I only have access to macOS 10.13.6.


---

Comment by mkoeppe created at 2020-03-18 17:13:41

Tests ran at https://github.com/mkoeppe/sage/actions/runs/57924835

`local-homebrew-macos-minimal` (https://github.com/mkoeppe/sage/runs/515508463) and `local-homebrew-macos-standard` (https://github.com/mkoeppe/sage/runs/515508474): 

All packages (except for experimental package `polymake`) build, doctests:

```
----------------------------------------------------------------------
sage -t src/sage/game_theory/normal_form_game.py  # 5 doctests failed
sage -t src/sage/dynamics/arithmetic_dynamics/projective_ds.py  # Timed out
sage -t src/sage/interfaces/gap.py  # 1 doctest failed
sage -t src/sage/knots/link.py  # 1 doctest failed
sage -t src/sage/manifolds/differentiable/degenerate_submanifold.py  # Timed out
sage -t src/sage/manifolds/differentiable/tensorfield.py  # Timed out
sage -t src/sage/plot/plot3d/base.pyx  # Timed out
sage -t src/sage/plot/plot3d/implicit_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/parametric_plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/plot3d.py  # Timed out
sage -t src/sage/plot/plot3d/shapes.pyx  # Timed out
sage -t src/sage/rings/padics/padic_lattice_element.py  # 3 doctests failed
sage -t src/sage/plot/plot3d/shapes2.py  # Timed out
sage -t src/sage/rings/function_field/function_field.py  # Timed out
sage -t src/sage/schemes/elliptic_curves/ell_number_field.py  # Timed out
----------------------------------------------------------------------
```



---

Comment by mkoeppe created at 2020-03-18 17:15:13

Replying to [comment:88 gh-mwageringel]:
> Replying to [comment:86 mkoeppe]:
> > `@`gh-mwageringel Would you be able to review this ticket?
> Yes, I will look into that. 
Thanks!

> Though, I only have access to macOS 10.13.6.
That's actually great, for some broader coverage. I'm testing on 10.15.3, and also the [GitHub](GitHub) runners are on Catalina.


---

Comment by dimpase created at 2020-03-18 18:15:35

lots of timeouts in tests, probably an overloaded host, or too aggressive parallelisation.


---

Comment by mkoeppe created at 2020-03-18 18:21:01

Yes, this is using 12 threads


---

Comment by jhpalmieri created at 2020-03-18 18:44:40

I'm in the middle of trying this. A few comments:

- patch: this should use homebrew's patch
- pcre: same
- boost: is there a way to convince Sage to use homebrew's boost as a replacement for boost-cropped? (See #29100?)
- ntl: being discussed on another ticket, but my Sage builds on OS X regularly use homebrew's ntl without problems.


---

Comment by jhpalmieri created at 2020-03-18 18:48:02

Defaulting to 12 threads seems like a bad idea. Shouldn't the user be able to configure this?


---

Comment by dimpase created at 2020-03-18 18:52:06

I presume Github Actions run on a real Mac hardware, and 12 threads is probably only meaningful on a rather high end host, used exclusively.


---

Comment by jhpalmieri created at 2020-03-18 18:54:26

ntl failed to build. This is on OS X 10.15.3.

```
make setup3
g++ -std=gnu++11 -I../include -I.  -O2 -g  -fno-common -march=native -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/local/lib -Wl,-rpath,/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/local/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/homebrew/opt/readline/lib -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/homebrew/lib  -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/local/include  -o gen_gmp_aux gen_gmp_aux.cpp -L/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/local/lib  -lgmp  -lm
./gen_gmp_aux > ../include/NTL/gmp_aux.h 
NTL_GMP_LIP flag set
GMP version check (6.1.2/6.2.0)
*** version number mismatch: inconsistency between gmp.h and libgmp
/bin/sh: line 1: 18441 Abort trap: 6           ./gen_gmp_aux > ../include/NTL/gmp_aux.h
make[5]: *** [setup3] Error 134
make[4]: *** [setup-phase] Error 2
make[4]: Target `all' not remade because of errors.
```



---

Comment by mkoeppe created at 2020-03-18 18:57:12

Replying to [comment:96 jhpalmieri]:
> ntl failed to build. This is on OS X 10.15.3.

This happens when you have a different (older) version of gmp in your /usr/local homebrew.
The isolation is unfortunately not perfect. Badly written configure scripts of packages pick up stuff from /usr/local


---

Comment by mkoeppe created at 2020-03-18 18:58:44

Replying to [comment:94 jhpalmieri]:
> Defaulting to 12 threads seems like a bad idea. Shouldn't the user be able to configure this?
Good idea. WIll do


---

Comment by mkoeppe created at 2020-03-18 18:59:42

Replying to [comment:95 dimpase]:
> I presume Github Actions run on a real Mac hardware, and 12 threads is probably only meaningful on a rather high end host, used exclusively.
Well, for the build I'm using high parallelization on purpose in order to catch possible parallelization bugs in the scripts.


---

Comment by git created at 2020-03-18 19:28:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-18 19:33:08

Replying to [comment:93 jhpalmieri]:
> I'm in the middle of trying this. A few comments:
> 
> - pcre: same

This one actually works for me (both locally and on the [GitHub](GitHub) runner). Please post the logs if it doesn't work for you


---

Comment by git created at 2020-03-18 19:42:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-03-18 19:45:40

Replying to [comment:102 mkoeppe]:
> Replying to [comment:93 jhpalmieri]:
> > I'm in the middle of trying this. A few comments:
> > 
> > - pcre: same
> 
> This one actually works for me (both locally and on the [GitHub](GitHub) runner). Please post the logs if it doesn't work for you

Sorry, it looks okay to me. I must have misread config.log.


---

Comment by jhpalmieri created at 2020-03-18 22:33:55

Flint fails to build for me. I ran `brew upgrade`, cleaned everything out, and tried again, and it still fails.

```
g++ -std=gnu++11 -fPIC -fno-common -pedantic -Wall -O2 -funroll-loops -g -mpopcnt  -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/local/var/tmp/sage/build/flint-2.5.2.p5/src -I/usr/local/include -I/usr/local/include -I/Users/palmieri/Desktop/Sage_stuff/sage_builds/TESTING/sage-9.1.beta7/.tox/local-homebrew-macos-standard/local/include -c interfaces/NTL-interface.cpp -o build/interfaces/NTL-interface.lo
ld: illegal thread local variable reference to regular symbol __ZN3NTL8ZZ_pInfoE for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
make[6]: *** [libflint-13.5.2.dylib] Error 1
make[6]: Target `shared' not remade because of errors.
make[5]: *** [library] Error 2
make[5]: Target `all' not remade because of errors.
make[4]: *** [verbose] Error 2
```



---

Comment by mkoeppe created at 2020-03-18 22:35:46

Is homebrew ntl installed on this system?


---

Comment by mkoeppe created at 2020-03-18 22:36:58

(in /usr/local)


---

Comment by jhpalmieri created at 2020-03-18 22:39:59

Replying to [comment:106 mkoeppe]:
> Is homebrew ntl installed on this system?

Yes. Do I need to delete it?

By the way, should `prefix` be added to `.gitignore`?


---

Comment by mkoeppe created at 2020-03-18 22:42:02

Replying to [comment:108 jhpalmieri]:
> Replying to [comment:106 mkoeppe]:
> > Is homebrew ntl installed on this system?
> 
> Yes. Do I need to delete it?

Please try if this helps.
If it does, we should fix something in the FLINT build scripts

> By the way, should `prefix` be added to `.gitignore`?

Yes, will do.


---

Comment by git created at 2020-03-18 22:43:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2020-03-18 22:47:49

Is there a command like `make distclean` that will get rid of the stuff that Sage has built but keep the homebrew stuff? I don't really want to wait for gcc to build again. (`make distclean` doesn't touch `prefix`.)


---

Comment by mkoeppe created at 2020-03-18 22:55:22

At the moment, nothing better than `rm -rf prefix/*`


---

Comment by jhpalmieri created at 2020-03-19 00:31:35

Replying to [comment:109 mkoeppe]:
> Replying to [comment:108 jhpalmieri]:
> > Replying to [comment:106 mkoeppe]:
> > > Is homebrew ntl installed on this system?
> > 
> > Yes. Do I need to delete it?
> 
> Please try if this helps.
> If it does, we should fix something in the FLINT build scripts

After doing `brew uninstall ntl`, flint now builds.


---

Comment by git created at 2020-03-19 19:18:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-03-19 19:19:45

Rebased - no longer on top of #29339.


---

Comment by jhpalmieri created at 2020-03-19 22:55:06

Except for the issue with FLINT not building with a pre-existing NTL, it works for me.


---

Comment by mkoeppe created at 2020-03-19 23:02:05

Let's fix the FLINT issue on a follow-up ticket.


---

Comment by mkoeppe created at 2020-03-20 02:58:19

Replying to [comment:98 mkoeppe]:
> Replying to [comment:94 jhpalmieri]:
> > Defaulting to 12 threads seems like a bad idea. Shouldn't the user be able to configure this?
> Good idea. WIll do
I'll do this in #29146


---

Comment by mkoeppe created at 2020-03-20 03:09:18

Replying to [comment:117 mkoeppe]:
> Let's fix the FLINT issue on a follow-up ticket.
This issue is probably the same as #27708/#28409.


---

Comment by mkoeppe created at 2020-03-20 03:09:56

Ready for review


---

Comment by dimpase created at 2020-03-20 04:26:04

Replying to [comment:99 mkoeppe]:
> Replying to [comment:95 dimpase]:
> > I presume Github Actions run on a real Mac hardware, and 12 threads is probably only meaningful on a rather high end host, used exclusively.
> Well, for the build I'm using high parallelization on purpose in order to catch possible parallelization bugs in the scripts.

One can split building into `make built` and `make ptest`, with the latter, much more memory hungry, run with lower value of `-j`.


---

Comment by git created at 2020-03-20 16:01:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-03-20 16:02:31

OK I've made it more configurable already on this ticket.
And I have added documentation


---

Comment by jhpalmieri created at 2020-03-20 18:40:47

`@`gh-mwageringel, `@`dimpase: do you think more needs to be done here, or can we proceed with a positive review? I'm happy with it.


---

Comment by dimpase created at 2020-03-20 18:48:47

I'm 8 timezones away from my MacOS machine. 

I'd like more details/pointers on how the Github Actions testing is done - for  [this](https://github.com/mkoeppe/sage/runs/416298393?check_suite_focus=true) looks to me like "all sufficiently advanced technology is indistinguishable from magic" kind of thing :-)


---

Comment by mkoeppe created at 2020-03-20 19:12:48

This ticket does no [GitHub](GitHub) Actions testing. This is all introduced in #29087.


---

Comment by dimpase created at 2020-03-20 19:26:41

how does one get the data I linked in comment:126 then?


---

Comment by mkoeppe created at 2020-03-20 19:29:05

By merging #29087 and pushing the branch to a [GitHub](GitHub) repository.


---

Comment by mkoeppe created at 2020-03-20 19:30:27

If the [GitHub](GitHub) Actions interface is overwhelming, just download the "Artifacts". They are tar.gz files of build logs.


---

Comment by dimpase created at 2020-03-20 19:35:29

Replying to [comment:129 mkoeppe]:
> By merging #29087 and pushing the branch to a [GitHub](GitHub) repository.

yes,but that's  how one triggers this - I'm asking rather about how stuff works, inside. Locally and then somehow pushing the logs to [GitHub](GitHub)?


---

Comment by mkoeppe created at 2020-03-20 19:42:52

I don't push logs to [GitHub](GitHub). 

#29087 adds `.github/workflows/tox.yml` (https://git.sagemath.org/sage.git/diff/.github/workflows/tox.yml?id=576a18834a16ff05cd6894172a55e86bcc95d407&id2=be1e22c441d9332fd0bf4a3066e1964deddaf8c7) which gets run on every commit pushed to [GitHub](GitHub) and on every pull request. 

The job `tox-local-homebrew-macos` defined in that file provisions a macOS host, checks out the branch and runs `tox -e local-homebrew-macos-standard` there. Then it packages up logs and makes them available as an artifact.


---

Comment by dimpase created at 2020-03-20 19:52:29

and where is that MacOS host getting provisioned?


---

Comment by mkoeppe created at 2020-03-20 19:54:01

GitHub takes care of that, I think it's using Azure.


---

Comment by @mwageringel created at 2020-03-20 22:05:26

Replying to [comment:125 jhpalmieri]:
> `@`gh-mwageringel, `@`dimpase: do you think more needs to be done here, or can we proceed with a positive review? I'm happy with it.

I have not tested this locally, but as you have done that, I am happy with this too.

One last question though: As far as I can see, readline is not installed into /usr/local. Why do you not run into conflicts with macOS's system "readline"/libedit, as in #29000?


---

Comment by mkoeppe created at 2020-03-20 22:20:27

These tests use their own homebrew installation in a prefix `.tox/local-homebrew-macos-standard/homebrew/`, and sets up environment variables using the new script `.homebrew-build-env`. This sets LDFLAGS and CPPFLAGS for the readline installed into `opt` under the homebrew prefix.


---

Comment by @mwageringel created at 2020-03-20 22:31:02

The problem in #29000 occured despite passing LDFLAGS and CPPFLAGS to `configure`, so I guess setting these also during `make` would avoid that problem, as a workaround.


---

Comment by mkoeppe created at 2020-03-20 22:33:32

I think the problem description of #29000 needs some more precision.


---

Comment by dimpase created at 2020-03-21 02:10:15

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-03-21 02:10:15

OK, looks good to me.


---

Comment by mkoeppe created at 2020-03-21 02:16:16

Thanks everyone!


---

Comment by vbraun created at 2020-03-29 00:24:12

Resolution: fixed
