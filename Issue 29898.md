# Issue 29898: Use /bin/sh where possible for sage-* scripts

archive/issues_029898.json:
```json
{
    "body": "CC:  @mkoeppe @dimpase @embray @kiwifb\n\nSeveral scripts in src/bin execute with bash unnecessarily, for example:\n\n\n```\n$ cat src/bin/sage-python \n#!/usr/bin/env bash\nsage -python \"$@\"\n```\n\n\nThat can be trivially changed to `/bin/sh` to speed up execution on systems where `/bin/sh` is a faster (non-bash) shell. Many other scripts in `src/bin` are similarly easy, as we have somehow avoided the bash test syntax in most places.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30135\n\n",
    "created_at": "2020-07-13T21:46:52Z",
    "labels": [
        "scripts",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Use /bin/sh where possible for sage-* scripts",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/29898",
    "user": "@orlitzky"
}
```
CC:  @mkoeppe @dimpase @embray @kiwifb

Several scripts in src/bin execute with bash unnecessarily, for example:


```
$ cat src/bin/sage-python 
#!/usr/bin/env bash
sage -python "$@"
```


That can be trivially changed to `/bin/sh` to speed up execution on systems where `/bin/sh` is a faster (non-bash) shell. Many other scripts in `src/bin` are similarly easy, as we have somehow avoided the bash test syntax in most places.

Issue created by migration from https://trac.sagemath.org/ticket/30135





---

archive/issue_comments_424691.json:
```json
{
    "body": "low-hanging fruit only",
    "created_at": "2020-07-15T01:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424691",
    "user": "@orlitzky"
}
```

low-hanging fruit only



---

archive/issue_comments_424692.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-07-15T01:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424692",
    "user": "@orlitzky"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_424693.json:
```json
{
    "body": "\n```\n--- a/bootstrap\n+++ b/bootstrap\n@@ -206,6 +206,7 @@ mkdir config 2>/dev/null\n # Get autotools from our own package into PATH (Trac #21214).\n```\n\nwe got rid of our autotools copy, so this comment makes no sense any more",
    "created_at": "2020-07-15T11:59:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424693",
    "user": "@dimpase"
}
```


```
--- a/bootstrap
+++ b/bootstrap
@@ -206,6 +206,7 @@ mkdir config 2>/dev/null
 # Get autotools from our own package into PATH (Trac #21214).
```

we got rid of our autotools copy, so this comment makes no sense any more



---

archive/issue_comments_424694.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-07-15T15:16:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424694",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_424695.json:
```json
{
    "body": "Not sure if I agree with these changes. Essentially it is forcing sage developers to know about portable shell programming if they want to make changes to the shell scripts. \nDoing so for `configure` and the `make` rules was fine -- because there it is indeed the tradition that these are portable shell scripts. But for other random shell scripts I think it needs to be accessible to casual shell scripters to make changes.",
    "created_at": "2020-07-15T19:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424695",
    "user": "@mkoeppe"
}
```

Not sure if I agree with these changes. Essentially it is forcing sage developers to know about portable shell programming if they want to make changes to the shell scripts. 
Doing so for `configure` and the `make` rules was fine -- because there it is indeed the tradition that these are portable shell scripts. But for other random shell scripts I think it needs to be accessible to casual shell scripters to make changes.



---

archive/issue_comments_424696.json:
```json
{
    "body": "I don't think it's such  a big deal to ask for portable shell commands - I think either a person either won't touch shell scripts at all, or actually make sure things are portable.\n\nNot all systems even come with bash by default.",
    "created_at": "2020-07-15T20:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424696",
    "user": "@dimpase"
}
```

I don't think it's such  a big deal to ask for portable shell commands - I think either a person either won't touch shell scripts at all, or actually make sure things are portable.

Not all systems even come with bash by default.



---

archive/issue_comments_424697.json:
```json
{
    "body": "Replying to [comment:6 dimpase]:\n> Not all systems even come with bash by default.  \n\nWe do not seem to support any such system at the moment.\n\n\n```\n$ grep bash build/pkgs/*.txt\n```\n",
    "created_at": "2020-07-15T20:54:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424697",
    "user": "@mkoeppe"
}
```

Replying to [comment:6 dimpase]:
> Not all systems even come with bash by default.  

We do not seem to support any such system at the moment.


```
$ grep bash build/pkgs/*.txt
```




---

archive/issue_comments_424698.json:
```json
{
    "body": "FreeBSD is pretty close to getting support.\n\nAlso, isn't macOS switching to zsh?",
    "created_at": "2020-07-15T20:59:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424698",
    "user": "@dimpase"
}
```

FreeBSD is pretty close to getting support.

Also, isn't macOS switching to zsh?



---

archive/issue_comments_424699.json:
```json
{
    "body": "Replying to [comment:6 dimpase]:\n> I think either a person either won't touch shell scripts at all, or actually make sure things are portable.\n\nI don't think so. \nhttps://www.gnu.org/software/autoconf/manual/autoconf-2.69/html_node/Portable-Shell.html",
    "created_at": "2020-07-15T21:00:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424699",
    "user": "@mkoeppe"
}
```

Replying to [comment:6 dimpase]:
> I think either a person either won't touch shell scripts at all, or actually make sure things are portable.

I don't think so. 
https://www.gnu.org/software/autoconf/manual/autoconf-2.69/html_node/Portable-Shell.html



---

archive/issue_comments_424700.json:
```json
{
    "body": "Given that we depend on hundreds of packages, the dependence on bash is trivial, I would think.",
    "created_at": "2020-07-15T21:03:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424700",
    "user": "@mkoeppe"
}
```

Given that we depend on hundreds of packages, the dependence on bash is trivial, I would think.



---

archive/issue_comments_424701.json:
```json
{
    "body": "Replying to [comment:8 dimpase]:\n> isn't macOS switching to zsh?\n\nzsh is the new default interactive shell. But I don't think that /bin/bash is going to be removed any time soon.",
    "created_at": "2020-07-15T21:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424701",
    "user": "@mkoeppe"
}
```

Replying to [comment:8 dimpase]:
> isn't macOS switching to zsh?

zsh is the new default interactive shell. But I don't think that /bin/bash is going to be removed any time soon.



---

archive/issue_comments_424702.json:
```json
{
    "body": "Replying to [comment:11 mkoeppe]:\n> Replying to [comment:8 dimpase]:\n> > isn't macOS switching to zsh?\n> \n> zsh is the new default interactive shell. But I don't think that /bin/bash is going to be removed any time soon.\n> \n\nTrue, but remember that this is bash-3 not 4+. So some features you may expect are not available (bash arrays comes to mind).",
    "created_at": "2020-07-15T21:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424702",
    "user": "@kiwifb"
}
```

Replying to [comment:11 mkoeppe]:
> Replying to [comment:8 dimpase]:
> > isn't macOS switching to zsh?
> 
> zsh is the new default interactive shell. But I don't think that /bin/bash is going to be removed any time soon.
> 

True, but remember that this is bash-3 not 4+. So some features you may expect are not available (bash arrays comes to mind).



---

archive/issue_comments_424703.json:
```json
{
    "body": "I also recall a bash scare some years ago, when there was some bad bug found in bash, and people were switching to dash, etc.",
    "created_at": "2020-07-15T21:09:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424703",
    "user": "@dimpase"
}
```

I also recall a bash scare some years ago, when there was some bad bug found in bash, and people were switching to dash, etc.



---

archive/issue_comments_424704.json:
```json
{
    "body": "I remember that too, but I don't think it is relevant",
    "created_at": "2020-07-15T21:11:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424704",
    "user": "@mkoeppe"
}
```

I remember that too, but I don't think it is relevant



---

archive/issue_comments_424705.json:
```json
{
    "body": "I think it is a good idea to use fewer features (of bash) - often as I look at Sage scripts code it appears that the 50 different ways one can do the same thing in bash contribute to the mess rather than help.",
    "created_at": "2020-07-15T21:32:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424705",
    "user": "@dimpase"
}
```

I think it is a good idea to use fewer features (of bash) - often as I look at Sage scripts code it appears that the 50 different ways one can do the same thing in bash contribute to the mess rather than help.



---

archive/issue_comments_424706.json:
```json
{
    "body": "To my surprise, almost all shell script in sage is already (mostly) POSIX compatible after 15+ years of churn. Empirically we seem to be able to write the stuff.\n\nMy motivation for this is twofold:\n\n1. Bash is not a standard language. We don't depend on a particular version of bash, so you get whatever version happens to be installed. The available features change between major versions of bash, so if you write a script using something specific to bash-4.x, it won't run on a machine with bash-3.x, and at best you get an error.\n2. Many other shells are much faster than bash. For anyone interested in the startup time of sage, we're wasting precious seconds launching the world's most monstrous shell to call one-liners (that are already POSIX compatible) repeatedly. Changing it is a free lunch.",
    "created_at": "2020-07-15T22:22:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424706",
    "user": "@orlitzky"
}
```

To my surprise, almost all shell script in sage is already (mostly) POSIX compatible after 15+ years of churn. Empirically we seem to be able to write the stuff.

My motivation for this is twofold:

1. Bash is not a standard language. We don't depend on a particular version of bash, so you get whatever version happens to be installed. The available features change between major versions of bash, so if you write a script using something specific to bash-4.x, it won't run on a machine with bash-3.x, and at best you get an error.
2. Many other shells are much faster than bash. For anyone interested in the startup time of sage, we're wasting precious seconds launching the world's most monstrous shell to call one-liners (that are already POSIX compatible) repeatedly. Changing it is a free lunch.



---

archive/issue_comments_424707.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-07-16T16:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424707",
    "user": "@dimpase"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_424708.json:
```json
{
    "body": "what is the current default /bin/sh on macOS 10.15?",
    "created_at": "2020-07-16T16:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424708",
    "user": "@dimpase"
}
```

what is the current default /bin/sh on macOS 10.15?



---

archive/issue_comments_424709.json:
```json
{
    "body": "I'm not sure about macOS, but the default on OpenBSD is already ksh and will never be bash due to its license. I've been testing with ksh/dash, but eventually we will need CI tests to ensure that no regressions slip in.",
    "created_at": "2020-07-16T17:00:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424709",
    "user": "@orlitzky"
}
```

I'm not sure about macOS, but the default on OpenBSD is already ksh and will never be bash due to its license. I've been testing with ksh/dash, but eventually we will need CI tests to ensure that no regressions slip in.



---

archive/issue_comments_424710.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2020-07-16T17:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424710",
    "user": "@dimpase"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_424711.json:
```json
{
    "body": "Replying to [comment:17 dimpase]:\n> what is the current default /bin/sh on macOS 10.15?\n\n```\n$ /bin/sh --version\nGNU bash, version 3.2.57(1)-release (x86_64-apple-darwin19)\nCopyright (C) 2007 Free Software Foundation, Inc.\n```\n",
    "created_at": "2020-07-16T17:07:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424711",
    "user": "@mkoeppe"
}
```

Replying to [comment:17 dimpase]:
> what is the current default /bin/sh on macOS 10.15?

```
$ /bin/sh --version
GNU bash, version 3.2.57(1)-release (x86_64-apple-darwin19)
Copyright (C) 2007 Free Software Foundation, Inc.
```




---

archive/issue_comments_424712.json:
```json
{
    "body": "It's fine to make this change. I was somehow concerned that we currently wouldn't have a platform that tests this with anything other than bash, but of course we do - Debian.",
    "created_at": "2020-07-16T17:09:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424712",
    "user": "@mkoeppe"
}
```

It's fine to make this change. I was somehow concerned that we currently wouldn't have a platform that tests this with anything other than bash, but of course we do - Debian.



---

archive/issue_comments_424713.json:
```json
{
    "body": "Replying to [comment:21 mkoeppe]:\n> It's fine to make this change. I was somehow concerned that we currently wouldn't have a platform that tests this with anything other than bash, but of course we do - Debian.\n\nDash on debian suffices to test these standalone scripts, but not the build system. Debian disables the POSIX lineno support in dash,\n\n  https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=842242\n\nto purposely cripple it during `./configure`. The intended end result is that autoconf decides that `/bin/sh` is broken and uses bash to run `./configure` and thus `make`, since `make` runs with `SHELL` set to whatever `./configure` used.\n\nI, at least, will probably notice if the build system is ever broken, but it would be nice to have it automated anyway. Dash on arch/Gentoo should work normally, and eventually we should have an OpenBSD system too.",
    "created_at": "2020-07-16T17:23:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424713",
    "user": "@orlitzky"
}
```

Replying to [comment:21 mkoeppe]:
> It's fine to make this change. I was somehow concerned that we currently wouldn't have a platform that tests this with anything other than bash, but of course we do - Debian.

Dash on debian suffices to test these standalone scripts, but not the build system. Debian disables the POSIX lineno support in dash,

  https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=842242

to purposely cripple it during `./configure`. The intended end result is that autoconf decides that `/bin/sh` is broken and uses bash to run `./configure` and thus `make`, since `make` runs with `SHELL` set to whatever `./configure` used.

I, at least, will probably notice if the build system is ever broken, but it would be nice to have it automated anyway. Dash on arch/Gentoo should work normally, and eventually we should have an OpenBSD system too.



---

archive/issue_comments_424714.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-07-28T22:32:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/29898",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/29898#issuecomment-424714",
    "user": "@vbraun"
}
```

Resolution: fixed
