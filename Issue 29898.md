# Issue 29898: Use /bin/sh where possible for sage-* scripts

Issue created by migration from https://trac.sagemath.org/ticket/30135

Original creator: mjo

Original creation time: 2020-07-13 21:46:52

CC:  mkoeppe dimpase embray fbissey

Several scripts in src/bin execute with bash unnecessarily, for example:


```
$ cat src/bin/sage-python 
#!/usr/bin/env bash
sage -python "$@"
```


That can be trivially changed to `/bin/sh` to speed up execution on systems where `/bin/sh` is a faster (non-bash) shell. Many other scripts in `src/bin` are similarly easy, as we have somehow avoided the bash test syntax in most places.


---

Comment by mjo created at 2020-07-15 01:41:53

low-hanging fruit only


---

Comment by mjo created at 2020-07-15 01:41:53

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-07-15 11:59:49


```
--- a/bootstrap
+++ b/bootstrap
@@ -206,6 +206,7 @@ mkdir config 2>/dev/null
 # Get autotools from our own package into PATH (Trac #21214).
```

we got rid of our autotools copy, so this comment makes no sense any more


---

Comment by git created at 2020-07-15 15:16:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-07-15 19:45:54

Not sure if I agree with these changes. Essentially it is forcing sage developers to know about portable shell programming if they want to make changes to the shell scripts. 
Doing so for `configure` and the `make` rules was fine -- because there it is indeed the tradition that these are portable shell scripts. But for other random shell scripts I think it needs to be accessible to casual shell scripters to make changes.


---

Comment by dimpase created at 2020-07-15 20:47:45

I don't think it's such  a big deal to ask for portable shell commands - I think either a person either won't touch shell scripts at all, or actually make sure things are portable.

Not all systems even come with bash by default.


---

Comment by mkoeppe created at 2020-07-15 20:54:48

Replying to [comment:6 dimpase]:
> Not all systems even come with bash by default.  

We do not seem to support any such system at the moment.


```
$ grep bash build/pkgs/*.txt
```



---

Comment by dimpase created at 2020-07-15 20:59:12

FreeBSD is pretty close to getting support.

Also, isn't macOS switching to zsh?


---

Comment by mkoeppe created at 2020-07-15 21:00:03

Replying to [comment:6 dimpase]:
> I think either a person either won't touch shell scripts at all, or actually make sure things are portable.

I don't think so. 
https://www.gnu.org/software/autoconf/manual/autoconf-2.69/html_node/Portable-Shell.html


---

Comment by mkoeppe created at 2020-07-15 21:03:05

Given that we depend on hundreds of packages, the dependence on bash is trivial, I would think.


---

Comment by mkoeppe created at 2020-07-15 21:04:25

Replying to [comment:8 dimpase]:
> isn't macOS switching to zsh?

zsh is the new default interactive shell. But I don't think that /bin/bash is going to be removed any time soon.


---

Comment by fbissey created at 2020-07-15 21:06:22

Replying to [comment:11 mkoeppe]:
> Replying to [comment:8 dimpase]:
> > isn't macOS switching to zsh?
> 
> zsh is the new default interactive shell. But I don't think that /bin/bash is going to be removed any time soon.
> 

True, but remember that this is bash-3 not 4+. So some features you may expect are not available (bash arrays comes to mind).


---

Comment by dimpase created at 2020-07-15 21:09:04

I also recall a bash scare some years ago, when there was some bad bug found in bash, and people were switching to dash, etc.


---

Comment by mkoeppe created at 2020-07-15 21:11:57

I remember that too, but I don't think it is relevant


---

Comment by dimpase created at 2020-07-15 21:32:55

I think it is a good idea to use fewer features (of bash) - often as I look at Sage scripts code it appears that the 50 different ways one can do the same thing in bash contribute to the mess rather than help.


---

Comment by mjo created at 2020-07-15 22:22:20

To my surprise, almost all shell script in sage is already (mostly) POSIX compatible after 15+ years of churn. Empirically we seem to be able to write the stuff.

My motivation for this is twofold:

1. Bash is not a standard language. We don't depend on a particular version of bash, so you get whatever version happens to be installed. The available features change between major versions of bash, so if you write a script using something specific to bash-4.x, it won't run on a machine with bash-3.x, and at best you get an error.
2. Many other shells are much faster than bash. For anyone interested in the startup time of sage, we're wasting precious seconds launching the world's most monstrous shell to call one-liners (that are already POSIX compatible) repeatedly. Changing it is a free lunch.


---

Comment by dimpase created at 2020-07-16 16:44:19

Changing status from needs_review to needs_info.


---

Comment by dimpase created at 2020-07-16 16:44:19

what is the current default /bin/sh on macOS 10.15?


---

Comment by mjo created at 2020-07-16 17:00:31

I'm not sure about macOS, but the default on OpenBSD is already ksh and will never be bash due to its license. I've been testing with ksh/dash, but eventually we will need CI tests to ensure that no regressions slip in.


---

Comment by dimpase created at 2020-07-16 17:05:23

Changing status from needs_info to positive_review.


---

Comment by mkoeppe created at 2020-07-16 17:07:57

Replying to [comment:17 dimpase]:
> what is the current default /bin/sh on macOS 10.15?

```
$ /bin/sh --version
GNU bash, version 3.2.57(1)-release (x86_64-apple-darwin19)
Copyright (C) 2007 Free Software Foundation, Inc.
```



---

Comment by mkoeppe created at 2020-07-16 17:09:45

It's fine to make this change. I was somehow concerned that we currently wouldn't have a platform that tests this with anything other than bash, but of course we do - Debian.


---

Comment by mjo created at 2020-07-16 17:23:44

Replying to [comment:21 mkoeppe]:
> It's fine to make this change. I was somehow concerned that we currently wouldn't have a platform that tests this with anything other than bash, but of course we do - Debian.

Dash on debian suffices to test these standalone scripts, but not the build system. Debian disables the POSIX lineno support in dash,

  https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=842242

to purposely cripple it during `./configure`. The intended end result is that autoconf decides that `/bin/sh` is broken and uses bash to run `./configure` and thus `make`, since `make` runs with `SHELL` set to whatever `./configure` used.

I, at least, will probably notice if the build system is ever broken, but it would be nice to have it automated anyway. Dash on arch/Gentoo should work normally, and eventually we should have an OpenBSD system too.


---

Comment by vbraun created at 2020-07-28 22:32:28

Resolution: fixed
