# Issue 15964: default precision for symbolic power series from SR.series()

Issue created by migration from Trac.

Original creator: rws

Original creation time: 2014-04-22 06:32:09

Keywords: series precision

Both Laurent and power series ring elements have a default precision of 20. OTOH, symbolic series expansions need the precision set:

```
sage: R.<t> = LaurentSeriesRing(QQ)
sage: 1/(1-t)
1 + t + t^2 + t^3 + t^4 + t^5 + t^6 + t^7 + t^8 + t^9 + t^10 + t^11 + t^12 + t^13 + t^14 + t^15 + t^16 + t^17 + t^18 + t^19 + O(t^20)
sage: var('x')
x
sage: ex=1/(1-x)
sage: ex.series(x)
...
TypeError: series() takes exactly 2 positional arguments (1 given)
```

This ticket proposes to unify the behaviour by allowing the following:

```
sage: ex.series(x)
1 + 1*x + 1*x^2 + 1*x^3 + 1*x^4 + 1*x^5 + 1*x^6 + 1*x^7 + 1*x^8 + 1*x^9 + 1*x^10 + 1*x^11 + 1*x^12 + 1*x^13 + 1*x^14 + 1*x^15 + 1*x^16 + 1*x^17 + 1*x^18 + 1*x^19 + Order(x^20)
```

As this is about reducing surprise for the user both algebra and symbolic series default precision should have the same value, so the ticket should also implement such a global value.


---

Comment by rws created at 2015-01-01 16:10:30

New commits:


---

Comment by rws created at 2015-01-01 16:10:30

Changing status from new to needs_review.


---

Comment by cheuberg created at 2015-01-04 07:42:05

I do not think that `order=-1` is a good default value, as it changes previous behaviour:

Prior to this patch:


```
sage: f = sin(x)^(-2)
....: f.series(x, -1)
1*x^(-2) + Order(1/x)
```


After this patch:

```
sage: f = sin(x)^(-2)
....: f.series(x, -1)
1*x^(-2) + 1/3 + 1/15*x^2 + 2/189*x^4 + 1/675*x^6 + 2/10395*x^8 + 1382/58046625*x^10 + 4/1403325*x^12 + 3617/10854718875*x^14 + 87734/2292899734125*x^16 + 349222/80596287646875*x^18 + Order(x^20)
```


Furthermore, I'd like to see doctests testing the new behaviour.

Finally, `sage.misc.defaults` could be added to the reference manual such that the documentation of all _three_ modified methods (symbolic, power, Laurent) could link to that place for setting the default precision.


---

Comment by git created at 2015-01-04 17:13:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-01-04 17:15:40

Done. Unfortunately this is Cython so I had to pick a value that signals default, changed to -65535 now.

Please add your realname to Reviewers.


---

Comment by cheuberg created at 2015-01-06 07:03:52

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2015-01-06 07:03:52

Replying to [comment:7 rws]:
> Done. Unfortunately this is Cython so I had to pick a value that signals default, changed to -65535 now.

I think that replacing `int order=-65535` by `order=None` would lead to clearer code at a negligible performance penalty.

Further comments:
* The docstrings of `series_precision` and `set_series_precision` should have `EXAMPLE` sections.
* The parameter `default_prec` of the Laurent series classes should be explained; the only explanation now is in `def default_prec(self)` which should be rephrased anyway ("Set ..." is not correct).
* I'd like to see doctests showing examples on how to construct series with different values for `set_series_precision`
* `:meth:`set_series_precision`` is a dead link.


---

Comment by git created at 2015-01-06 16:48:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-01-06 16:49:53

The default for order is now `None`. The `misc` functions now have examples. The description of `def default_prec(self)` was corrected. I think the `LaurentSeriesRing` method `set_default_prec` should be deprecated as is already hinted. Done.

The general improvement of Laurent series documentation is ticket #12259.

I don't think doctests showing examples on how to construct series with different values for `set_series_precision` should be added. I don't want to encourage frequent usage of the global setting to set single series precisions.

If the link is dead you should do `make doc-clean; make doc`. It will not suffice to `sage -docbuild` since a file was added.


---

Comment by rws created at 2015-01-06 16:49:53

Changing status from needs_work to needs_review.


---

Comment by cheuberg created at 2015-01-06 17:41:04

Changing status from needs_review to needs_work.


---

Comment by cheuberg created at 2015-01-06 17:41:04

For now, just three comments, I'll have a closer look later.


```
File "src/sage/symbolic/expression.pyx", line 3542, in sage.symbolic.expression.Expression.series
Failed example:
    f.series(x)
Exception raised:
    Traceback (most recent call last):
      File "/local/sage/sage-6.5.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/local/sage/sage-6.5.beta4/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.symbolic.expression.Expression.series[9]>", line 1, in <module>
        f.series(x)
      File "sage/symbolic/expression.pyx", line 3584, in sage.symbolic.expression.Expression.series (build/cythonized/sage/symbolic/expression.cpp:20710)
        x = self._gobj.series(symbol0._gobj, order, 0)
    TypeError: an integer is required
```

The reason is that `prec` is set but never used.

Replying to [comment:10 rws]:
> I don't think doctests showing examples on how to construct series with different values for `set_series_precision` should be added. I don't want to encourage frequent usage of the global setting to set single series precisions.

I concur that we should not encourage the actual frequent usage of the global settings.
However, I'd prefer it to be at least be covered by a test in a "TESTS" section, just to be sure to avoid small errors as the issue outlined above.

> 
> If the link is dead you should do `make doc-clean; make doc`. It will not suffice to `sage -docbuild` since a file was added.

I think that the problem is rather the `meth` instead of `func`.


---

Comment by cheuberg created at 2015-01-06 18:21:35

The deprecation of `set_series_precision` leads to four failing doctests elsewhere:

```
sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/hyperelliptic_padic_field.py", line 74, in sage.schemes.hyperelliptic_curves.hyperelliptic_padic_field.HyperellipticCurve_padic_field.local_analytic_interpolation
Failed example:
    x,y,z = HK.local_analytic_interpolation(P,Q)
Expected nothing
Got:
    doctest:512: DeprecationWarning: This method is deprecated.
    See http://trac.sagemath.org/16201 for details.
**********************************************************************
sage -t src/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/hyperelliptic_generic.py", line 490, in sage.schemes.hyperelliptic_curves.hyperelliptic_generic.HyperellipticCurve_generic.local_coordinates_at_infinity
Failed example:
    x,y = H.local_coordinates_at_infinity(10)
Expected nothing
Got:
    doctest:512: DeprecationWarning: This method is deprecated.
    See http://trac.sagemath.org/16201 for details.
**********************************************************************
sage -t src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py
**********************************************************************
File "src/sage/schemes/hyperelliptic_curves/monsky_washnitzer.py", line 3580, in sage.schemes.hyperelliptic_curves.monsky_washnitzer.MonskyWashnitzerDifferential.coleman_integral
Failed example:
    w.coleman_integral(P,2*P)
Expected:
    O(5^6)
Got:
    doctest:512: DeprecationWarning: This method is deprecated.
    See http://trac.sagemath.org/16201 for details.
    O(5^6)
**********************************************************************
sage -t src/sage/rings/morphism.pyx
**********************************************************************
File "src/sage/rings/morphism.pyx", line 249, in sage.rings.morphism
Failed example:
    R.set_default_prec(10)
Expected nothing
Got:
    doctest:1: DeprecationWarning: This method is deprecated.
    See http://trac.sagemath.org/16201 for details.
**********************************************************************
```



---

Comment by git created at 2015-01-07 09:48:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-01-07 09:48:55

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-01-07 09:48:55

All done.


---

Comment by cheuberg created at 2015-01-08 13:58:21

All Doctests (`make ptestlong`) pass; code looks ok; thanks.

The changes in `hyperelliptic_generic.py` demonstrate that there is a default precision of `20`, too, which is not covered by this ticket. For the ReSt formatting errors in that file, see #17599.


---

Comment by cheuberg created at 2015-01-08 13:58:21

Changing status from needs_review to positive_review.


---

Comment by rws created at 2015-01-08 15:14:51

Thanks for the review.


---

Comment by rws created at 2015-01-10 16:54:44

Replying to [comment:15 cheuberg]:
> The changes in `hyperelliptic_generic.py` demonstrate that there is a default precision of `20`, too, which is not covered by this ticket.

That is now #17613.


---

Comment by jdemeyer created at 2015-01-11 22:04:22

This is wrongly indented:

```
TESTS:

    Check if changing global series precision does it right::
```

It should be

```
TESTS:

Check if changing global series precision does it right::
```



---

Comment by jdemeyer created at 2015-01-11 22:04:22

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-01-12 07:12:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by rws created at 2015-01-12 07:14:17

Changing status from needs_work to needs_review.


---

Comment by rws created at 2015-01-13 16:07:25

Jeroen, can you please have a quick look again, so that we can finish it?


---

Comment by cheuberg created at 2015-01-13 18:55:59

Changing status from needs_review to positive_review.


---

Comment by cheuberg created at 2015-01-13 18:55:59

The wrong indentation has been fixed.


---

Comment by vbraun created at 2015-01-15 08:41:50

Resolution: fixed
