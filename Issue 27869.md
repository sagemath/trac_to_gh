# Issue 27869: Memory corruption possibly related to libgap

archive/issues_027869.json:
```json
{
    "body": "Keywords: gap libgap combinat\n\nThis is a follow-up to #27681 which is now closed, as it fixed one issue related to libgap and pexpect gap possibly interacting in bad ways.\n\nHowever, the original issue, which for a while I could not reproduce, seems to be coming up again.  For example if I run just:\n\n\n```\n$ ./sage -t --long src/sage/combinat/tableau.py\n```\n\n\nI get\n\n\n```\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-07-03-13-48-33-78ca2800.\nGit branch: u/embray/docker-python3\nUsing --optional=build,dochtml,memlimit,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage\nDoctesting 1 file.\nsage -t --long src/sage/combinat/tableau.py\n**********************************************************************\nFile \"src/sage/combinat/tableau.py\", line 7751, in sage.combinat.tableau.StandardTableaux_size.cardinality\nFailed example:\n    StandardTableaux(50).cardinality()  # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.tableau.StandardTableaux_size.cardinality[4]>\", line 1, in <module>\n        StandardTableaux(Integer(50)).cardinality()  # long time\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3691)\n        return self.get_object()(*args, **kwds)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)\n        return cls.classcall(cls, *args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7584, in __classcall_private__\n        return StandardTableaux_size(n)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)\n        w = self.f(*args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7693, in __init__\n        facade=True, keepkey=False)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py\", line 288, in __init__\n        self._facade_for = tuple(family)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py\", line 1062, in __iter__\n        yield self[i]\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py\", line 1078, in __getitem__\n        return self.function(i)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)\n        w = self.f(*args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n    MemoryError\n**********************************************************************\nFile \"src/sage/combinat/tableau.py\", line 8572, in sage.combinat.tableau.IncreasingTableaux.__init__\nFailed example:\n    TestSuite(S).run()  # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1118, in compile_and_execute\n        self.update_digests(example)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1009, in update_digests\n        digest.update(str_to_bytes(reduce_hex(gen), 'ascii'))\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/parsing.py\", line 442, in reduce_hex\n        from operator import xor\n    MemoryError\nProcess DocTestWorker-1:\nTraceback (most recent call last):\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/multiprocessing/process.py\", line 267, in _bootstrap\n    self.run()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2149, in run\n    task(self.options, self.outtmpfile, msgpipe, self.result_queue)\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2508, in __call__\n    result_queue.put(result, False)\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/multiprocessing/queues.py\", line 107, in put\n    self._start_thread()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/multiprocessing/queues.py\", line 195, in _start_thread\n    self._thread.start()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/threading.py\", line 736, in start\n    _start_new_thread(self.__bootstrap, ())\nerror: can't start new thread\n    Bad exit: 1\n```\n\n\nThere is something about `sage.combinat.tableau` that the problem is always occurring there, though I'm not sure why.  It's usually crashing on the same tests, but not always with the exact same traceback, suggesting some pseudo-deterministic memory corruption.\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/28106\n\n",
    "created_at": "2019-07-03T14:05:11Z",
    "labels": [
        "interfaces",
        "critical",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "Memory corruption possibly related to libgap",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/27869",
    "user": "@embray"
}
```
Keywords: gap libgap combinat

This is a follow-up to #27681 which is now closed, as it fixed one issue related to libgap and pexpect gap possibly interacting in bad ways.

However, the original issue, which for a while I could not reproduce, seems to be coming up again.  For example if I run just:


```
$ ./sage -t --long src/sage/combinat/tableau.py
```


I get


```
too many failed tests, not using stored timings
Running doctests with ID 2019-07-03-13-48-33-78ca2800.
Git branch: u/embray/docker-python3
Using --optional=build,dochtml,memlimit,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t --long src/sage/combinat/tableau.py
**********************************************************************
File "src/sage/combinat/tableau.py", line 7751, in sage.combinat.tableau.StandardTableaux_size.cardinality
Failed example:
    StandardTableaux(50).cardinality()  # long time
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.tableau.StandardTableaux_size.cardinality[4]>", line 1, in <module>
        StandardTableaux(Integer(50)).cardinality()  # long time
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3691)
        return self.get_object()(*args, **kwds)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)
        return cls.classcall(cls, *args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7584, in __classcall_private__
        return StandardTableaux_size(n)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)
        w = self.f(*args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7693, in __init__
        facade=True, keepkey=False)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py", line 288, in __init__
        self._facade_for = tuple(family)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py", line 1062, in __iter__
        yield self[i]
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py", line 1078, in __getitem__
        return self.function(i)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)
        w = self.f(*args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
    MemoryError
**********************************************************************
File "src/sage/combinat/tableau.py", line 8572, in sage.combinat.tableau.IncreasingTableaux.__init__
Failed example:
    TestSuite(S).run()  # long time
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1118, in compile_and_execute
        self.update_digests(example)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1009, in update_digests
        digest.update(str_to_bytes(reduce_hex(gen), 'ascii'))
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/parsing.py", line 442, in reduce_hex
        from operator import xor
    MemoryError
Process DocTestWorker-1:
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
    self.run()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2149, in run
    task(self.options, self.outtmpfile, msgpipe, self.result_queue)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2508, in __call__
    result_queue.put(result, False)
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/multiprocessing/queues.py", line 107, in put
    self._start_thread()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/multiprocessing/queues.py", line 195, in _start_thread
    self._thread.start()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/threading.py", line 736, in start
    _start_new_thread(self.__bootstrap, ())
error: can't start new thread
    Bad exit: 1
```


There is something about `sage.combinat.tableau` that the problem is always occurring there, though I'm not sure why.  It's usually crashing on the same tests, but not always with the exact same traceback, suggesting some pseudo-deterministic memory corruption.



Issue created by migration from https://trac.sagemath.org/ticket/28106





---

archive/issue_comments_393593.json:
```json
{
    "body": "On #27681 it was reported that the error doesn't occur when running the tests with `--serial`, but my experience is different.  I still get:\n\n\n```\n$ ./sage -t --serial --long src/sage/combinat/tableau.py\ntoo many failed tests, not using stored timings\nRunning doctests with ID 2019-07-03-13-55-40-8a0bf5f9.\nGit branch: u/embray/docker-python3\nUsing --optional=build,dochtml,memlimit,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage\nDoctesting 1 file.\nsage -t --long src/sage/combinat/tableau.py\n**********************************************************************\nFile \"src/sage/combinat/tableau.py\", line 7751, in sage.combinat.tableau.StandardTableaux_size.cardinality\nFailed example:\n    StandardTableaux(50).cardinality()  # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.tableau.StandardTableaux_size.cardinality[4]>\", line 1, in <module>\n        StandardTableaux(Integer(50)).cardinality()  # long time\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3691)\n        return self.get_object()(*args, **kwds)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)\n        return cls.classcall(cls, *args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7584, in __classcall_private__\n        return StandardTableaux_size(n)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)\n        w = self.f(*args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7693, in __init__\n        facade=True, keepkey=False)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py\", line 288, in __init__\n        self._facade_for = tuple(family)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py\", line 1062, in __iter__\n        yield self[i]\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py\", line 1078, in __getitem__\n        return self.function(i)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)\n        w = self.f(*args, **kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7869, in __init__\n        super(StandardTableaux_shape, self).__init__(category=FiniteEnumeratedSets())\n      File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 6052, in __init__\n        self.max_entry = None\n    MemoryError\n----------------------------------------------------------------------\nDoctests interrupted: 0/1 files tested\n----------------------------------------------------------------------\nTotal time for all tests: 59.6 seconds\n    cpu time: 0.0 seconds\n    cumulative wall time: 0.0 seconds\nTraceback (most recent call last):\n  File \"/home/embray/src/sagemath/sage/src/bin/sage-runtests\", line 179, in <module>\n    err = DC.run()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 1232, in run\n    self.run_doctests()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/control.py\", line 933, in run_doctests\n    self.dispatcher.dispatch()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 2008, in dispatch\n    self.serial_dispatch()\n  File \"/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1671, in serial_dispatch\n    output = bytes_to_str(outtmpfile.read())\nMemoryError\n```\n\n\nSince this is a pretty random issue, it possible that running with `--serial` just happened to make it go away in their case.",
    "created_at": "2019-07-03T14:09:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393593",
    "user": "@embray"
}
```

On #27681 it was reported that the error doesn't occur when running the tests with `--serial`, but my experience is different.  I still get:


```
$ ./sage -t --serial --long src/sage/combinat/tableau.py
too many failed tests, not using stored timings
Running doctests with ID 2019-07-03-13-55-40-8a0bf5f9.
Git branch: u/embray/docker-python3
Using --optional=build,dochtml,memlimit,mpir,notedown,pandoc_attributes,python2,rst2ipynb,sage
Doctesting 1 file.
sage -t --long src/sage/combinat/tableau.py
**********************************************************************
File "src/sage/combinat/tableau.py", line 7751, in sage.combinat.tableau.StandardTableaux_size.cardinality
Failed example:
    StandardTableaux(50).cardinality()  # long time
Exception raised:
    Traceback (most recent call last):
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.tableau.StandardTableaux_size.cardinality[4]>", line 1, in <module>
        StandardTableaux(Integer(50)).cardinality()  # long time
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3691)
        return self.get_object()(*args, **kwds)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)
        return cls.classcall(cls, *args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7584, in __classcall_private__
        return StandardTableaux_size(n)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)
        w = self.f(*args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7693, in __init__
        facade=True, keepkey=False)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py", line 288, in __init__
        self._facade_for = tuple(family)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py", line 1062, in __iter__
        yield self[i]
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/sets/family.py", line 1078, in __getitem__
        return self.function(i)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1735)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1003, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6011)
        w = self.f(*args, **kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2185)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7869, in __init__
        super(StandardTableaux_shape, self).__init__(category=FiniteEnumeratedSets())
      File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 6052, in __init__
        self.max_entry = None
    MemoryError
----------------------------------------------------------------------
Doctests interrupted: 0/1 files tested
----------------------------------------------------------------------
Total time for all tests: 59.6 seconds
    cpu time: 0.0 seconds
    cumulative wall time: 0.0 seconds
Traceback (most recent call last):
  File "/home/embray/src/sagemath/sage/src/bin/sage-runtests", line 179, in <module>
    err = DC.run()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 1232, in run
    self.run_doctests()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/control.py", line 933, in run_doctests
    self.dispatcher.dispatch()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 2008, in dispatch
    self.serial_dispatch()
  File "/home/embray/src/sagemath/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1671, in serial_dispatch
    output = bytes_to_str(outtmpfile.read())
MemoryError
```


Since this is a pretty random issue, it possible that running with `--serial` just happened to make it go away in their case.



---

archive/issue_comments_393594.json:
```json
{
    "body": "At this point I'm not even certain it has anything to with libgap.  That's just the context in which this first started appearing for me.  It could also be a CPython bug.",
    "created_at": "2019-07-03T14:24:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393594",
    "user": "@embray"
}
```

At this point I'm not even certain it has anything to with libgap.  That's just the context in which this first started appearing for me.  It could also be a CPython bug.



---

archive/issue_comments_393595.json:
```json
{
    "body": "Sometimes I forget that on Linux we run the tests by default with `--memlimit=3300` which sets `RLIMIT_AS`.\n\nI wonder if that's all it is.",
    "created_at": "2019-07-03T14:43:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393595",
    "user": "@embray"
}
```

Sometimes I forget that on Linux we run the tests by default with `--memlimit=3300` which sets `RLIMIT_AS`.

I wonder if that's all it is.



---

archive/issue_comments_393596.json:
```json
{
    "body": "Yep, the crash is just occurring upon hitting the 3300MB memlimit.  Simple and mundane as that.\n\nIt could still be indirectly related to libgap.  When investigating this earlier in #27681 we thought it might have something to do with GAP workspaces.  This is because I first discovered the problem while working on #18267, in which libgap is used much more extensively directly in sage (as opposed to pexpect gap which is running outside the main sage process and so doesn't hit this memory limit as easily).  It also seemed to go away if I deleted my existing GAP workspaces.\n\nIt could be that in the previous case, merely loading a pre-existing GAP workspace was enough to push over the memory limit.",
    "created_at": "2019-07-03T15:16:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393596",
    "user": "@embray"
}
```

Yep, the crash is just occurring upon hitting the 3300MB memlimit.  Simple and mundane as that.

It could still be indirectly related to libgap.  When investigating this earlier in #27681 we thought it might have something to do with GAP workspaces.  This is because I first discovered the problem while working on #18267, in which libgap is used much more extensively directly in sage (as opposed to pexpect gap which is running outside the main sage process and so doesn't hit this memory limit as easily).  It also seemed to go away if I deleted my existing GAP workspaces.

It could be that in the previous case, merely loading a pre-existing GAP workspace was enough to push over the memory limit.



---

archive/issue_comments_393597.json:
```json
{
    "body": "Of note:  With the default of `--memlimit=3300`, roughly 2GB of virtual memory are already reserved by various things just while importing Sage.  Of that, about 250MB is used just by Python and various loaded modules.  825 MB (i.e. `virtual_memory_limit() // 4`) are reserved by Pari, which is loaded no matter what.  The rest I can't easily account for yet...\n\nWhile running the tests, libgap reserves initially what amounts to `virtual_memory_limit() // 10`, or only 330 MB, but the 2 GB I mentioned previously doesn't even include libgap.\n\nI wonder, if nothing else, as long as we're capping the virtual memory limit for doctests, the default amount reserved for Pari should be lower.",
    "created_at": "2019-07-03T15:56:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393597",
    "user": "@embray"
}
```

Of note:  With the default of `--memlimit=3300`, roughly 2GB of virtual memory are already reserved by various things just while importing Sage.  Of that, about 250MB is used just by Python and various loaded modules.  825 MB (i.e. `virtual_memory_limit() // 4`) are reserved by Pari, which is loaded no matter what.  The rest I can't easily account for yet...

While running the tests, libgap reserves initially what amounts to `virtual_memory_limit() // 10`, or only 330 MB, but the 2 GB I mentioned previously doesn't even include libgap.

I wonder, if nothing else, as long as we're capping the virtual memory limit for doctests, the default amount reserved for Pari should be lower.



---

archive/issue_comments_393598.json:
```json
{
    "body": "One little thing we can do that happens to be good-enough for this case, it seems, is to further limit the amount of workspace Pari allocates by default, just when running the test suite.\n\nSince many tests won't require that much memory for Pari this seems sensible.\n\nIn the case of this particular test the other issue is just reducing the amount of memory used when instantiating large Tableaux classes.  I have opened #28114 for that.",
    "created_at": "2019-07-04T14:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393598",
    "user": "@embray"
}
```

One little thing we can do that happens to be good-enough for this case, it seems, is to further limit the amount of workspace Pari allocates by default, just when running the test suite.

Since many tests won't require that much memory for Pari this seems sensible.

In the case of this particular test the other issue is just reducing the amount of memory used when instantiating large Tableaux classes.  I have opened #28114 for that.



---

archive/issue_comments_393599.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-07-04T14:39:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393599",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_393600.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2019-07-04T14:39:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393600",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_393601.json:
```json
{
    "body": "I am a little split on this. I agree that we don't really need it for the doctests, but I don't like making the behavior different than what is done within a Sage session. Or is there something special with Cygwin and/or the doctest framework going on here?",
    "created_at": "2019-07-08T13:20:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393601",
    "user": "@tscrim"
}
```

I am a little split on this. I agree that we don't really need it for the doctests, but I don't like making the behavior different than what is done within a Sage session. Or is there something special with Cygwin and/or the doctest framework going on here?



---

archive/issue_comments_393602.json:
```json
{
    "body": "This problem can also be observed with a doctest for `divisors()` in `sage/rings/integer.pyx`. See #28162.\n\nI tried the branch here, but it does not solve the issue for me. Both the tests in `tableau.py` and `integer.pyx` still fail.\n\nOn the other hand, raising the `memlimit` from 3300 to 3400 makes the tests pass for both of the files, without this branch even. If I understand the change correctly, it should decrease memory usage by much more than 100 MB, so I am not sure what is going on.",
    "created_at": "2019-07-11T20:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393602",
    "user": "@mwageringel"
}
```

This problem can also be observed with a doctest for `divisors()` in `sage/rings/integer.pyx`. See #28162.

I tried the branch here, but it does not solve the issue for me. Both the tests in `tableau.py` and `integer.pyx` still fail.

On the other hand, raising the `memlimit` from 3300 to 3400 makes the tests pass for both of the files, without this branch even. If I understand the change correctly, it should decrease memory usage by much more than 100 MB, so I am not sure what is going on.



---

archive/issue_comments_393603.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-07-13T09:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393603",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_393604.json:
```json
{
    "body": "I'm also hitting this on the buildbot, unsurprisingly.\n\nIMHO its reasonable to provide less memory specifically for doctests, if only to encourage authors to limit resource usage when writing tests.",
    "created_at": "2019-07-13T09:40:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393604",
    "user": "@vbraun"
}
```

I'm also hitting this on the buildbot, unsurprisingly.

IMHO its reasonable to provide less memory specifically for doctests, if only to encourage authors to limit resource usage when writing tests.



---

archive/issue_comments_393605.json:
```json
{
    "body": "I'm still running sometimes out of memory\n\n```\nUsing --optional=4ti2,benzene,buckygen,build,cmake,database_cremona_ellcurve,database_jones_numfield,database_kohel,database_mutation_class,database_odlyzko_zeta,database_stein_watkins,database_stein_watkins_mini,database_symbolic_data,deformation,dochtml,e_antic,gambit,latte_int,libogg,lidia,lrslib,memlimit,mpir,normaliz,ore_algebra,pari_elldata,pari_galpol,pari_nftables,pari_seadata,plantri,python2,qhull,saclib,sage,tides,topcom\nDoctesting entire Sage library.\nSorting sources by runtime so that slower doctests are run first....\nDoctesting 3816 files using 16 threads.\n**********************************************************************\nFile \"src/sage/combinat/tableau.py\", line 7698, in sage.combinat.tableau.StandardTableaux_size.cardinality\nFailed example:\n    StandardTableaux(50).cardinality()  # long time\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 681, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1105, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.combinat.tableau.StandardTableaux_size.cardinality[4]>\", line 1, in <module>\n        StandardTableaux(Integer(50)).cardinality()  # long time\n      File \"sage/misc/lazy_import.pyx\", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3697)\n        return self.get_object()(*args, **kwds)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)\n        return cls.classcall(cls, *args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7531, in __classcall_private__\n        return StandardTableaux_size(n)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1002, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6017)\n        w = self.f(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2191)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7640, in __init__\n        facade=True, keepkey=False)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py\", line 288, in __init__\n        self._facade_for = tuple(family)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/sets/family.py\", line 1062, in __iter__\n        yield self[i]\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/sets/family.py\", line 1078, in __getitem__\n        return self.function(i)\n      File \"sage/misc/classcall_metaclass.pyx\", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)\n        return cls.classcall(cls, *args, **kwds)\n      File \"sage/misc/cachefunc.pyx\", line 1002, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6017)\n        w = self.f(*args, **kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py\", line 1027, in __classcall__\n        instance = typecall(cls, *args, **options)\n      File \"sage/misc/classcall_metaclass.pyx\", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2191)\n        return (<PyTypeObject*>type).tp_call(cls, args, kwds)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 7816, in __init__\n        super(StandardTableaux_shape, self).__init__(category=FiniteEnumeratedSets())\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py\", line 6000, in __init__\n        Tableaux.__init__(self, **kwds)\n      File \"sage/structure/parent.pyx\", line 296, in sage.structure.parent.Parent.__init__ (build/cythonized/sage/structure/parent.c:4589)\n        CategoryObject.__init__(self, category, base)\n      File \"sage/structure/category_object.pyx\", line 115, in sage.structure.category_object.CategoryObject.__init__ (build/cythonized/sage/structure/category_object.c:2053)\n        self._init_category_(category)\n      File \"sage/structure/parent.pyx\", line 339, in sage.structure.parent.Parent._init_category_ (build/cythonized/sage/structure/parent.c:5059)\n        self.__class__ = dynamic_class(\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py\", line 335, in dynamic_class\n        return dynamic_class_internal(name, bases, cls, reduction, doccls, prepend_cls_bases)\n    MemoryError\n**********************************************************************\n```\n",
    "created_at": "2019-07-13T11:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393605",
    "user": "@vbraun"
}
```

I'm still running sometimes out of memory

```
Using --optional=4ti2,benzene,buckygen,build,cmake,database_cremona_ellcurve,database_jones_numfield,database_kohel,database_mutation_class,database_odlyzko_zeta,database_stein_watkins,database_stein_watkins_mini,database_symbolic_data,deformation,dochtml,e_antic,gambit,latte_int,libogg,lidia,lrslib,memlimit,mpir,normaliz,ore_algebra,pari_elldata,pari_galpol,pari_nftables,pari_seadata,plantri,python2,qhull,saclib,sage,tides,topcom
Doctesting entire Sage library.
Sorting sources by runtime so that slower doctests are run first....
Doctesting 3816 files using 16 threads.
**********************************************************************
File "src/sage/combinat/tableau.py", line 7698, in sage.combinat.tableau.StandardTableaux_size.cardinality
Failed example:
    StandardTableaux(50).cardinality()  # long time
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 681, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1105, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.combinat.tableau.StandardTableaux_size.cardinality[4]>", line 1, in <module>
        StandardTableaux(Integer(50)).cardinality()  # long time
      File "sage/misc/lazy_import.pyx", line 354, in sage.misc.lazy_import.LazyImport.__call__ (build/cythonized/sage/misc/lazy_import.c:3697)
        return self.get_object()(*args, **kwds)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)
        return cls.classcall(cls, *args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7531, in __classcall_private__
        return StandardTableaux_size(n)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1002, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6017)
        w = self.f(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2191)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7640, in __init__
        facade=True, keepkey=False)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/sets/disjoint_union_enumerated_sets.py", line 288, in __init__
        self._facade_for = tuple(family)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/sets/family.py", line 1062, in __iter__
        yield self[i]
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/sets/family.py", line 1078, in __getitem__
        return self.function(i)
      File "sage/misc/classcall_metaclass.pyx", line 335, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1741)
        return cls.classcall(cls, *args, **kwds)
      File "sage/misc/cachefunc.pyx", line 1002, in sage.misc.cachefunc.CachedFunction.__call__ (build/cythonized/sage/misc/cachefunc.c:6017)
        w = self.f(*args, **kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/unique_representation.py", line 1027, in __classcall__
        instance = typecall(cls, *args, **options)
      File "sage/misc/classcall_metaclass.pyx", line 506, in sage.misc.classcall_metaclass.typecall (build/cythonized/sage/misc/classcall_metaclass.c:2191)
        return (<PyTypeObject*>type).tp_call(cls, args, kwds)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 7816, in __init__
        super(StandardTableaux_shape, self).__init__(category=FiniteEnumeratedSets())
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/combinat/tableau.py", line 6000, in __init__
        Tableaux.__init__(self, **kwds)
      File "sage/structure/parent.pyx", line 296, in sage.structure.parent.Parent.__init__ (build/cythonized/sage/structure/parent.c:4589)
        CategoryObject.__init__(self, category, base)
      File "sage/structure/category_object.pyx", line 115, in sage.structure.category_object.CategoryObject.__init__ (build/cythonized/sage/structure/category_object.c:2053)
        self._init_category_(category)
      File "sage/structure/parent.pyx", line 339, in sage.structure.parent.Parent._init_category_ (build/cythonized/sage/structure/parent.c:5059)
        self.__class__ = dynamic_class(
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/structure/dynamic_class.py", line 335, in dynamic_class
        return dynamic_class_internal(name, bases, cls, reduction, doccls, prepend_cls_bases)
    MemoryError
**********************************************************************
```




---

archive/issue_comments_393606.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2019-07-13T11:57:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393606",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_393607.json:
```json
{
    "body": "I still see this on my Fedora desktop, as I run tests with `--long` on. There seems to be something Fedora-specific here.",
    "created_at": "2019-07-13T12:09:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393607",
    "user": "@dimpase"
}
```

I still see this on my Fedora desktop, as I run tests with `--long` on. There seems to be something Fedora-specific here.



---

archive/issue_comments_393608.json:
```json
{
    "body": "Can we just reduce `StandardTableaux(50)` to something smaller here?\n\nThis is on Debian fwiw.",
    "created_at": "2019-07-13T12:12:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393608",
    "user": "@vbraun"
}
```

Can we just reduce `StandardTableaux(50)` to something smaller here?

This is on Debian fwiw.



---

archive/issue_comments_393609.json:
```json
{
    "body": "hmm, but it is fast (for me, on Debian 10):\n\n```\nsage: timeit(\"StandardTableaux(50).cardinality()\")\n5 loops, best of 3: 169 \u03bcs per loop\n```\n\nIt is not constructing this huge set for sure...",
    "created_at": "2019-07-13T12:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393609",
    "user": "@dimpase"
}
```

hmm, but it is fast (for me, on Debian 10):

```
sage: timeit("StandardTableaux(50).cardinality()")
5 loops, best of 3: 169 s per loop
```

It is not constructing this huge set for sure...



---

archive/issue_comments_393610.json:
```json
{
    "body": "Replying to [comment:14 dimpase]:\n> hmm, but it is fast (for me, on Debian 10):\n> {{{\n> sage: timeit(\"StandardTableaux(50).cardinality()\")\n> 5 loops, best of 3: 169 \u03bcs per loop\n> }}}\n> It is not constructing this huge set for sure...\n\nWhich is the point of this doctest, the set is huge and it is using an actual computation. However, `StandardPartitions` does need to compute the partitions of 50 as part of the `__init__` as part of this line:\n\n```\nFamily(Partitions_n(n), StandardTableaux_shape),\n```\n\nNow the `Family` is created lazily; however, this gets expanded by the call `self._facade_for = tuple(family)` in the `DisjointUnionEnumeratedSets.__init__`. So we construct a set of size\n\n```\nsage: Partitions(50).cardinality()\n204226\n```\n\ninstead of\n\n```\nsage: ST = StandardTableaux(50)\nsage: ST.cardinality()\n27886995605342342839104615869259776\n```\n\nNow unfortunately I do not see a simple way to keep that family done lazily. However, changing it to 40 should still do an appropriate test but uses far less memory:\n\n```\nsage: Partitions(40).cardinality()\n37338\nsage: StandardTableaux(40).cardinality()\n72682301192087742711233536\n```\n",
    "created_at": "2019-07-13T13:35:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393610",
    "user": "@tscrim"
}
```

Replying to [comment:14 dimpase]:
> hmm, but it is fast (for me, on Debian 10):
> {{{
> sage: timeit("StandardTableaux(50).cardinality()")
> 5 loops, best of 3: 169 s per loop
> }}}
> It is not constructing this huge set for sure...

Which is the point of this doctest, the set is huge and it is using an actual computation. However, `StandardPartitions` does need to compute the partitions of 50 as part of the `__init__` as part of this line:

```
Family(Partitions_n(n), StandardTableaux_shape),
```

Now the `Family` is created lazily; however, this gets expanded by the call `self._facade_for = tuple(family)` in the `DisjointUnionEnumeratedSets.__init__`. So we construct a set of size

```
sage: Partitions(50).cardinality()
204226
```

instead of

```
sage: ST = StandardTableaux(50)
sage: ST.cardinality()
27886995605342342839104615869259776
```

Now unfortunately I do not see a simple way to keep that family done lazily. However, changing it to 40 should still do an appropriate test but uses far less memory:

```
sage: Partitions(40).cardinality()
37338
sage: StandardTableaux(40).cardinality()
72682301192087742711233536
```




---

archive/issue_comments_393611.json:
```json
{
    "body": "The current branch does not work as intended because `DOCTEST_MODE` is not set yet when Pari is initialized. Perhaps it could be set earlier on, in sage-runtests?",
    "created_at": "2019-07-24T09:31:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393611",
    "user": "@mwageringel"
}
```

The current branch does not work as intended because `DOCTEST_MODE` is not set yet when Pari is initialized. Perhaps it could be set earlier on, in sage-runtests?



---

archive/issue_comments_393612.json:
```json
{
    "body": "Replying to [comment:15 tscrim]:\n> Now unfortunately I do not see a simple way to keep that family done lazily.\n\nThe following seems to work. All tests pass for me.\n\n```diff\n--- a/src/sage/categories/facade_sets.py\n+++ b/src/sage/categories/facade_sets.py\n@@ -177,7 +177,9 @@ class FacadeSets(CategoryWithAxiom):\n             if parents is True:\n                 return True\n             from sage.structure.element import parent\n-            return parent(element) in parents\n+            # parents is a tuple or (finite lazy) family of Parent types;\n+            # LazyFamily does not implement __contains__, so we iterate over it\n+            return parent(element) in iter(parents)\n\n         def __contains__(self, element):\n             \"\"\"\n--- a/src/sage/sets/disjoint_union_enumerated_sets.py\n+++ b/src/sage/sets/disjoint_union_enumerated_sets.py\n@@ -285,7 +285,7 @@ class DisjointUnionEnumeratedSets(UniqueRepresentation, Parent):\n         self._facade  = facade\n         if facade:\n             if family in FiniteEnumeratedSets():\n-                self._facade_for = tuple(family)\n+                self._facade_for = family\n             else:\n                 # This allows the test suite to pass its tests by essentially\n                 #   stating that this is a facade for any parent. Technically\n@@ -576,8 +576,8 @@ class DisjointUnionEnumeratedSets(UniqueRepresentation, Parent):\n                 raise ValueError(\"cannot coerce `%s` in the parent `%s`\"%(el[1], P))\n\n         # Check first to see if the parent of el is in the family\n-        if (isinstance(el, Element) and isinstance(self._facade_for, tuple)\n-            and el.parent() in self._facade_for):\n+        if (isinstance(el, Element) and self._facade_for is not True\n+            and el.parent() in iter(self._facade_for)):\n             return el\n\n         for P in self._family:\n```\n\nThis change does not have the potential to solve the memory problems in integer.pyx, but it could be useful regardless of the memory issues. With this we could even test for `StandardTableaux(500).cardinality()` instead, which only takes a few milliseconds.",
    "created_at": "2019-07-24T14:49:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393612",
    "user": "@mwageringel"
}
```

Replying to [comment:15 tscrim]:
> Now unfortunately I do not see a simple way to keep that family done lazily.

The following seems to work. All tests pass for me.

```diff
--- a/src/sage/categories/facade_sets.py
+++ b/src/sage/categories/facade_sets.py
@@ -177,7 +177,9 @@ class FacadeSets(CategoryWithAxiom):
             if parents is True:
                 return True
             from sage.structure.element import parent
-            return parent(element) in parents
+            # parents is a tuple or (finite lazy) family of Parent types;
+            # LazyFamily does not implement __contains__, so we iterate over it
+            return parent(element) in iter(parents)

         def __contains__(self, element):
             """
--- a/src/sage/sets/disjoint_union_enumerated_sets.py
+++ b/src/sage/sets/disjoint_union_enumerated_sets.py
@@ -285,7 +285,7 @@ class DisjointUnionEnumeratedSets(UniqueRepresentation, Parent):
         self._facade  = facade
         if facade:
             if family in FiniteEnumeratedSets():
-                self._facade_for = tuple(family)
+                self._facade_for = family
             else:
                 # This allows the test suite to pass its tests by essentially
                 #   stating that this is a facade for any parent. Technically
@@ -576,8 +576,8 @@ class DisjointUnionEnumeratedSets(UniqueRepresentation, Parent):
                 raise ValueError("cannot coerce `%s` in the parent `%s`"%(el[1], P))

         # Check first to see if the parent of el is in the family
-        if (isinstance(el, Element) and isinstance(self._facade_for, tuple)
-            and el.parent() in self._facade_for):
+        if (isinstance(el, Element) and self._facade_for is not True
+            and el.parent() in iter(self._facade_for)):
             return el

         for P in self._family:
```

This change does not have the potential to solve the memory problems in integer.pyx, but it could be useful regardless of the memory issues. With this we could even test for `StandardTableaux(500).cardinality()` instead, which only takes a few milliseconds.



---

archive/issue_comments_393613.json:
```json
{
    "body": "Hmm...I thought I had some reason for not doing that when I looked at it for comment:15, but the logic all seems to checkout. There is one small behavior change: If it was given a finite iterator before, it would know it is a finite enumerated set, but now that doesn't happen (infinite iterators would loop forever before)\n\n```\nsage: iter([1,2,3,4,5]) in FiniteEnumeratedSets()\nFalse\n```\n\nSo I think that is a safe change.",
    "created_at": "2019-07-26T20:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393613",
    "user": "@tscrim"
}
```

Hmm...I thought I had some reason for not doing that when I looked at it for comment:15, but the logic all seems to checkout. There is one small behavior change: If it was given a finite iterator before, it would know it is a finite enumerated set, but now that doesn't happen (infinite iterators would loop forever before)

```
sage: iter([1,2,3,4,5]) in FiniteEnumeratedSets()
False
```

So I think that is a safe change.



---

archive/issue_comments_393614.json:
```json
{
    "body": "Replying to [comment:18 tscrim]:\n> There is one small behavior change: If it was given a finite iterator before, it would know it is a finite enumerated set, but now that doesn't happen (infinite iterators would loop forever before)\n\nI am not sure what you mean by the change in behavior. Could you give an example? The variable `family` is always a `Family` here, not an iterator, which is asserted by the `__classcall_private__` in `DisjointUnionEnumeratedSets`.\n\nHowever on second thought, instead of calling `iter`, it would be clearer to implement `__contains__` for lazy families, which could then choose an appropriate behavior depending on whether the family is finite or not. When given a different kind of family, `__contains__` could potentially do something more efficient than iterating. Currently, all other subclasses of `Family` already implement it, except for `LazyFamily`. This has the effect that the default implementation from `Parent` is called for lazy families, producing a very uninformative error message.\n\nI could prepare a branch for this. Should I create a new ticket for that or put it here?",
    "created_at": "2019-07-27T14:53:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393614",
    "user": "@mwageringel"
}
```

Replying to [comment:18 tscrim]:
> There is one small behavior change: If it was given a finite iterator before, it would know it is a finite enumerated set, but now that doesn't happen (infinite iterators would loop forever before)

I am not sure what you mean by the change in behavior. Could you give an example? The variable `family` is always a `Family` here, not an iterator, which is asserted by the `__classcall_private__` in `DisjointUnionEnumeratedSets`.

However on second thought, instead of calling `iter`, it would be clearer to implement `__contains__` for lazy families, which could then choose an appropriate behavior depending on whether the family is finite or not. When given a different kind of family, `__contains__` could potentially do something more efficient than iterating. Currently, all other subclasses of `Family` already implement it, except for `LazyFamily`. This has the effect that the default implementation from `Parent` is called for lazy families, producing a very uninformative error message.

I could prepare a branch for this. Should I create a new ticket for that or put it here?



---

archive/issue_comments_393615.json:
```json
{
    "body": "Replying to [comment:19 gh-mwageringel]:\n> Replying to [comment:18 tscrim]:\n> > There is one small behavior change: If it was given a finite iterator before, it would know it is a finite enumerated set, but now that doesn't happen (infinite iterators would loop forever before)\n> \n> I am not sure what you mean by the change in behavior. Could you give an example? The variable `family` is always a `Family` here, not an iterator, which is asserted by the `__classcall_private__` in `DisjointUnionEnumeratedSets`.\n\nI mean the same input will result in a different object being created (i.e., the behavior) with your branch if it was given an iterator/generator. You are not just changing things that affect only `DisjointUnionEnumeratedSets`. The `family` change in `facade_sets` can affect many other things. Granted, doing things this way is arguably safer, but I am just pointing out a difference here.\n\n> However on second thought, instead of calling `iter`, it would be clearer to implement `__contains__` for lazy families, which could then choose an appropriate behavior depending on whether the family is finite or not. When given a different kind of family, `__contains__` could potentially do something more efficient than iterating. Currently, all other subclasses of `Family` already implement it, except for `LazyFamily`. This has the effect that the default implementation from `Parent` is called for lazy families, producing a very uninformative error message.\n> \n> I could prepare a branch for this. Should I create a new ticket for that or put it here?\n\nPlease do so. Be aware, a lazy family may not know if it finite or not (a priori, I haven't checked this is actually true in the code). So that part might end up being more of a can of worms, but I don't know until someone actually does it.",
    "created_at": "2019-07-27T20:14:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393615",
    "user": "@tscrim"
}
```

Replying to [comment:19 gh-mwageringel]:
> Replying to [comment:18 tscrim]:
> > There is one small behavior change: If it was given a finite iterator before, it would know it is a finite enumerated set, but now that doesn't happen (infinite iterators would loop forever before)
> 
> I am not sure what you mean by the change in behavior. Could you give an example? The variable `family` is always a `Family` here, not an iterator, which is asserted by the `__classcall_private__` in `DisjointUnionEnumeratedSets`.

I mean the same input will result in a different object being created (i.e., the behavior) with your branch if it was given an iterator/generator. You are not just changing things that affect only `DisjointUnionEnumeratedSets`. The `family` change in `facade_sets` can affect many other things. Granted, doing things this way is arguably safer, but I am just pointing out a difference here.

> However on second thought, instead of calling `iter`, it would be clearer to implement `__contains__` for lazy families, which could then choose an appropriate behavior depending on whether the family is finite or not. When given a different kind of family, `__contains__` could potentially do something more efficient than iterating. Currently, all other subclasses of `Family` already implement it, except for `LazyFamily`. This has the effect that the default implementation from `Parent` is called for lazy families, producing a very uninformative error message.
> 
> I could prepare a branch for this. Should I create a new ticket for that or put it here?

Please do so. Be aware, a lazy family may not know if it finite or not (a priori, I haven't checked this is actually true in the code). So that part might end up being more of a can of worms, but I don't know until someone actually does it.



---

archive/issue_comments_393616.json:
```json
{
    "body": "I opened #28273 implementing this. I created a new ticket for this, as Erik's approach tried here is justified in its own right.\n\nReplying to [comment:20 tscrim]:\n> I mean the same input will result in a different object being created (i.e., the behavior) with your branch if it was given an iterator/generator. You are not just changing things that affect only `DisjointUnionEnumeratedSets`. The `family` change in `facade_sets` can affect many other things. Granted, doing things this way is arguably safer, but I am just pointing out a difference here.\n\nOk, I see. Indeed the change in `facade_sets` could affect other things \u2013 though within the Sage library it should not affect anything, as `_facade_for` is always a tuple, currently. This assumption could easily break in the future though, so I think it is safer to do things as in #28273, which does not touch facade_sets.py at all.",
    "created_at": "2019-07-28T13:20:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393616",
    "user": "@mwageringel"
}
```

I opened #28273 implementing this. I created a new ticket for this, as Erik's approach tried here is justified in its own right.

Replying to [comment:20 tscrim]:
> I mean the same input will result in a different object being created (i.e., the behavior) with your branch if it was given an iterator/generator. You are not just changing things that affect only `DisjointUnionEnumeratedSets`. The `family` change in `facade_sets` can affect many other things. Granted, doing things this way is arguably safer, but I am just pointing out a difference here.

Ok, I see. Indeed the change in `facade_sets` could affect other things  though within the Sage library it should not affect anything, as `_facade_for` is always a tuple, currently. This assumption could easily break in the future though, so I think it is safer to do things as in #28273, which does not touch facade_sets.py at all.



---

archive/issue_comments_393617.json:
```json
{
    "body": "Replying to [comment:8 tscrim]:\n> I am a little split on this. I agree that we don't really need it for the doctests, but I don't like making the behavior different than what is done within a Sage session. Or is there something special with Cygwin and/or the doctest framework going on here?\n\nYes, the fact that the doctest framework, by default, puts a low cap on virtual memory allocation allowed by the process, which would not normally be the case unless the user is manually setting those limits.\n\nTherefore the large vmem allocation normally allowed for PARI's initial stack needs to be scaled back that much more when running the doctests in order to leave room for other things.",
    "created_at": "2019-08-02T09:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393617",
    "user": "@embray"
}
```

Replying to [comment:8 tscrim]:
> I am a little split on this. I agree that we don't really need it for the doctests, but I don't like making the behavior different than what is done within a Sage session. Or is there something special with Cygwin and/or the doctest framework going on here?

Yes, the fact that the doctest framework, by default, puts a low cap on virtual memory allocation allowed by the process, which would not normally be the case unless the user is manually setting those limits.

Therefore the large vmem allocation normally allowed for PARI's initial stack needs to be scaled back that much more when running the doctests in order to leave room for other things.



---

archive/issue_comments_393618.json:
```json
{
    "body": "Replying to [comment:16 gh-mwageringel]:\n> The current branch does not work as intended because `DOCTEST_MODE` is not set yet when Pari is initialized. Perhaps it could be set earlier on, in sage-runtests?\n\nI see, that is true.  It's been several weeks since I last looked at this, but this change seemed to work for me, but now I can't be sure why.  I must have been doing something differently at the time.",
    "created_at": "2019-08-02T10:47:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393618",
    "user": "@embray"
}
```

Replying to [comment:16 gh-mwageringel]:
> The current branch does not work as intended because `DOCTEST_MODE` is not set yet when Pari is initialized. Perhaps it could be set earlier on, in sage-runtests?

I see, that is true.  It's been several weeks since I last looked at this, but this change seemed to work for me, but now I can't be sure why.  I must have been doing something differently at the time.



---

archive/issue_comments_393619.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-08-02T12:56:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393619",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_393620.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2019-08-02T12:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393620",
    "user": "@embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_393621.json:
```json
{
    "body": "I rebased the branch on current develop, and added a fix to ensure that pari was not being initialized so much earlier than intended during import of the doctest sub-package.",
    "created_at": "2019-08-02T12:57:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393621",
    "user": "@embray"
}
```

I rebased the branch on current develop, and added a fix to ensure that pari was not being initialized so much earlier than intended during import of the doctest sub-package.



---

archive/issue_comments_393622.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-08-05T18:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393622",
    "user": "@mwageringel"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_393623.json:
```json
{
    "body": "Now there are several doctest failures as a result of the reduced Pari stack size, see the patchbot, so I am setting back to needs work. I have only had a brief look, but some of them seem hard to solve.\n\nAlso, considering that relying on a specific load order could be a bit fragile, would it be possible to add a doctest or an assertion to check that Pari is loaded after `DOCTEST_MODE` is set?",
    "created_at": "2019-08-05T18:39:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393623",
    "user": "@mwageringel"
}
```

Now there are several doctest failures as a result of the reduced Pari stack size, see the patchbot, so I am setting back to needs work. I have only had a brief look, but some of them seem hard to solve.

Also, considering that relying on a specific load order could be a bit fragile, would it be possible to add a doctest or an assertion to check that Pari is loaded after `DOCTEST_MODE` is set?



---

archive/issue_comments_393624.json:
```json
{
    "body": "Replying to [comment:26 gh-mwageringel]:\n> Also, considering that relying on a specific load order could be a bit fragile, would it be possible to add a doctest or an assertion to check that Pari is loaded after `DOCTEST_MODE` is set?\n\nI thought about that but I'm not sure exactly a good way to do that.  It might be necessary to add some kind of pari_initialized flag.",
    "created_at": "2019-08-06T12:53:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393624",
    "user": "@embray"
}
```

Replying to [comment:26 gh-mwageringel]:
> Also, considering that relying on a specific load order could be a bit fragile, would it be possible to add a doctest or an assertion to check that Pari is loaded after `DOCTEST_MODE` is set?

I thought about that but I'm not sure exactly a good way to do that.  It might be necessary to add some kind of pari_initialized flag.



---

archive/issue_comments_393625.json:
```json
{
    "body": "I wonder what the absolute minimum PARI stack size needed is.  We shouldn't go below that, sure, but it's not really clear what the limit is here...",
    "created_at": "2019-08-06T13:01:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393625",
    "user": "@embray"
}
```

I wonder what the absolute minimum PARI stack size needed is.  We shouldn't go below that, sure, but it's not really clear what the limit is here...



---

archive/issue_comments_393626.json:
```json
{
    "body": "Pari initialisation has 2 parameters, one is stack size, another some kind of \u201cminimal prime\u201d. I had to deal with it my recent branch on #28242...",
    "created_at": "2019-08-06T13:43:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393626",
    "user": "@dimpase"
}
```

Pari initialisation has 2 parameters, one is stack size, another some kind of minimal prime. I had to deal with it my recent branch on #28242...



---

archive/issue_comments_393627.json:
```json
{
    "body": "Replying to [comment:10 vbraun]:\n> IMHO its reasonable to provide less memory specifically for doctests, if only to encourage authors to limit resource usage when writing tests.\n\nI added that limit. My main motivation was to prevent accidents where Sage doctests would trash a machine by using all memory (that happened to me multiple times). The limit of 3300 MB was simply chosen as the smallest number that made all doctests pass at the time when that limit was imposed.",
    "created_at": "2019-08-06T15:34:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393627",
    "user": "@jdemeyer"
}
```

Replying to [comment:10 vbraun]:
> IMHO its reasonable to provide less memory specifically for doctests, if only to encourage authors to limit resource usage when writing tests.

I added that limit. My main motivation was to prevent accidents where Sage doctests would trash a machine by using all memory (that happened to me multiple times). The limit of 3300 MB was simply chosen as the smallest number that made all doctests pass at the time when that limit was imposed.



---

archive/issue_comments_393628.json:
```json
{
    "body": "Replying to [comment:22 embray]:\n> Therefore the large vmem allocation normally allowed for PARI's initial stack needs to be scaled back that much more when running the doctests in order to leave room for other things.\n\nI don't like adding yet another special case for doctests. Why not simply increase the 3300 MB memory limit a bit?",
    "created_at": "2019-08-06T15:42:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393628",
    "user": "@jdemeyer"
}
```

Replying to [comment:22 embray]:
> Therefore the large vmem allocation normally allowed for PARI's initial stack needs to be scaled back that much more when running the doctests in order to leave room for other things.

I don't like adding yet another special case for doctests. Why not simply increase the 3300 MB memory limit a bit?



---

archive/issue_comments_393629.json:
```json
{
    "body": "Replying to [comment:22 embray]:\n> Therefore the large vmem allocation normally allowed for PARI's initial stack needs to be scaled back that much more when running the doctests in order to leave room for other things.\n\nI wouldn't be surprised if some tests (in particular `heegner.py`) used most of the available PARI stack. So I doubt that there is much room for making the PARI stack smaller during doctests.",
    "created_at": "2019-08-06T15:50:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393629",
    "user": "@jdemeyer"
}
```

Replying to [comment:22 embray]:
> Therefore the large vmem allocation normally allowed for PARI's initial stack needs to be scaled back that much more when running the doctests in order to leave room for other things.

I wouldn't be surprised if some tests (in particular `heegner.py`) used most of the available PARI stack. So I doubt that there is much room for making the PARI stack smaller during doctests.



---

archive/issue_comments_393630.json:
```json
{
    "body": "Replying to [comment:30 jdemeyer]:\n> Replying to [comment:10 vbraun]:\n> > IMHO its reasonable to provide less memory specifically for doctests, if only to encourage authors to limit resource usage when writing tests.\n> \n> I added that limit. My main motivation was to prevent accidents where Sage doctests would trash a machine by using all memory (that happened to me multiple times). The limit of 3300 MB was simply chosen as the smallest number that made all doctests pass at the time when that limit was imposed.\n\nIt just doesn't seem \"fair\", in a sense, that we impose a default hard limit on virtual memory allocation, and then have a large chunk of that eaten up by Pari, even when most of it isn't needed for most other tests.\n\nWhen Pari runs out of memory isn't there some way to \"catch\" that, increase its stack, and re-try the operation?  Perhaps tests/code that are expected to eat up the Pari stack should actually explicitly do that (it would be good to test that anyways).",
    "created_at": "2019-08-12T11:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393630",
    "user": "@embray"
}
```

Replying to [comment:30 jdemeyer]:
> Replying to [comment:10 vbraun]:
> > IMHO its reasonable to provide less memory specifically for doctests, if only to encourage authors to limit resource usage when writing tests.
> 
> I added that limit. My main motivation was to prevent accidents where Sage doctests would trash a machine by using all memory (that happened to me multiple times). The limit of 3300 MB was simply chosen as the smallest number that made all doctests pass at the time when that limit was imposed.

It just doesn't seem "fair", in a sense, that we impose a default hard limit on virtual memory allocation, and then have a large chunk of that eaten up by Pari, even when most of it isn't needed for most other tests.

When Pari runs out of memory isn't there some way to "catch" that, increase its stack, and re-try the operation?  Perhaps tests/code that are expected to eat up the Pari stack should actually explicitly do that (it would be good to test that anyways).



---

archive/issue_comments_393631.json:
```json
{
    "body": "Replying to [comment:33 embray]:\n> It just doesn't seem \"fair\", in a sense, that we impose a default hard limit on virtual memory allocation, and then have a large chunk of that eaten up by Pari, even when most of it isn't needed for most other tests.\n\nI really don't understand at all what the word \"fair\" (even you put it in quotes) means here. This isn't about fairness, it's about solving a practical problem, namely preventing excessive memory usage by doctests. As I said: the limit of 3300 MB is chosen pretty arbitrarily and I wouldn't mind increasing it.\n\n> When Pari runs out of memory isn't there some way to \"catch\" that, increase its stack, and re-try the operation?\n\nSure, it probably could be done, but why bother? It's much easier to just allocate a large virtual stack. I just don't see the problem with that.",
    "created_at": "2019-08-13T09:06:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393631",
    "user": "@jdemeyer"
}
```

Replying to [comment:33 embray]:
> It just doesn't seem "fair", in a sense, that we impose a default hard limit on virtual memory allocation, and then have a large chunk of that eaten up by Pari, even when most of it isn't needed for most other tests.

I really don't understand at all what the word "fair" (even you put it in quotes) means here. This isn't about fairness, it's about solving a practical problem, namely preventing excessive memory usage by doctests. As I said: the limit of 3300 MB is chosen pretty arbitrarily and I wouldn't mind increasing it.

> When Pari runs out of memory isn't there some way to "catch" that, increase its stack, and re-try the operation?

Sure, it probably could be done, but why bother? It's much easier to just allocate a large virtual stack. I just don't see the problem with that.



---

archive/issue_comments_393632.json:
```json
{
    "body": "Its also the only bound on actual ram usage during tests, and we should try to keep that manageable especially since tests tend to be run in parallel and cpu core count is increasing faster than ram prices are declining. Also, something <= 4gb is going to be the upper bound on 32-bit anyways.",
    "created_at": "2019-08-13T09:42:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393632",
    "user": "@vbraun"
}
```

Its also the only bound on actual ram usage during tests, and we should try to keep that manageable especially since tests tend to be run in parallel and cpu core count is increasing faster than ram prices are declining. Also, something <= 4gb is going to be the upper bound on 32-bit anyways.



---

archive/issue_comments_393633.json:
```json
{
    "body": "Replying to [comment:34 jdemeyer]:\n> Replying to [comment:33 embray]:\n> > It just doesn't seem \"fair\", in a sense, that we impose a default hard limit on virtual memory allocation, and then have a large chunk of that eaten up by Pari, even when most of it isn't needed for most other tests.\n> \n> I really don't understand at all what the word \"fair\" (even you put it in quotes) means here. This isn't about fairness, it's about solving a practical problem, namely preventing excessive memory usage by doctests. As I said: the limit of 3300 MB is chosen pretty arbitrarily and I wouldn't mind increasing it.\n> \n> > When Pari runs out of memory isn't there some way to \"catch\" that, increase its stack, and re-try the operation?\n> \n> Sure, it probably could be done, but why bother? It's much easier to just allocate a large virtual stack. I just don't see the problem with that.\n\nThat's what I'm talking about: Normally it's fine to just allocate a large stack for PARI. But RLIMIT_AS limits the amount of virtual address space available to the process, and a large chunk of that gets used, without exception, for the PARI stack even for tests that don't need it so much, thus creating stricter limitations on what those tests are allowed to do.  This is what I mean by \"fair\".",
    "created_at": "2019-08-13T10:03:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393633",
    "user": "@embray"
}
```

Replying to [comment:34 jdemeyer]:
> Replying to [comment:33 embray]:
> > It just doesn't seem "fair", in a sense, that we impose a default hard limit on virtual memory allocation, and then have a large chunk of that eaten up by Pari, even when most of it isn't needed for most other tests.
> 
> I really don't understand at all what the word "fair" (even you put it in quotes) means here. This isn't about fairness, it's about solving a practical problem, namely preventing excessive memory usage by doctests. As I said: the limit of 3300 MB is chosen pretty arbitrarily and I wouldn't mind increasing it.
> 
> > When Pari runs out of memory isn't there some way to "catch" that, increase its stack, and re-try the operation?
> 
> Sure, it probably could be done, but why bother? It's much easier to just allocate a large virtual stack. I just don't see the problem with that.

That's what I'm talking about: Normally it's fine to just allocate a large stack for PARI. But RLIMIT_AS limits the amount of virtual address space available to the process, and a large chunk of that gets used, without exception, for the PARI stack even for tests that don't need it so much, thus creating stricter limitations on what those tests are allowed to do.  This is what I mean by "fair".



---

archive/issue_comments_393634.json:
```json
{
    "body": "I've since seen various other instances of this issue, not so much on my own machine, but others seem to be encountering it in various tests.  Although I can't prove myself that this is the reason (they would have to demonstrate that the failing tests are hitting the VM limit, or that the problems go away with `--memlimit=0`.\n\nBut ISTM we need to do *something* about this.  If not in the PARI interface I could also see about reducing the amount libgap needs to allocate, as I believe it's the increased usage of libgap in permutation groups that is largely responsible for the increase in issues like this.",
    "created_at": "2019-09-04T10:31:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393634",
    "user": "@embray"
}
```

I've since seen various other instances of this issue, not so much on my own machine, but others seem to be encountering it in various tests.  Although I can't prove myself that this is the reason (they would have to demonstrate that the failing tests are hitting the VM limit, or that the problems go away with `--memlimit=0`.

But ISTM we need to do *something* about this.  If not in the PARI interface I could also see about reducing the amount libgap needs to allocate, as I believe it's the increased usage of libgap in permutation groups that is largely responsible for the increase in issues like this.



---

archive/issue_comments_393635.json:
```json
{
    "body": "Why aren't we just doing the obvious thing and increasing the limit from 3300MB to 3400MB? There is nothing magical about that 3300MB limit, it's mostly an arbitrary number.",
    "created_at": "2019-09-04T18:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393635",
    "user": "@jdemeyer"
}
```

Why aren't we just doing the obvious thing and increasing the limit from 3300MB to 3400MB? There is nothing magical about that 3300MB limit, it's mostly an arbitrary number.



---

archive/issue_comments_393636.json:
```json
{
    "body": "Sure, I obviously wouldn't mind increasing the limit.  I just wonder how sustainable that is.  Perhaps a few more tests should be marked `# optional - memlimit` if this becomes a frequent problem.\n\nIt also makes me wonder if there aren't memory leaks that should be investigated.",
    "created_at": "2019-09-18T12:27:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393636",
    "user": "@embray"
}
```

Sure, I obviously wouldn't mind increasing the limit.  I just wonder how sustainable that is.  Perhaps a few more tests should be marked `# optional - memlimit` if this becomes a frequent problem.

It also makes me wonder if there aren't memory leaks that should be investigated.



---

archive/issue_comments_393637.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393637",
    "user": "@embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_393638.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-02-13T20:51:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393638",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_393639.json:
```json
{
    "body": "Ticket #31395 removed `memlimit` for doctests.",
    "created_at": "2021-04-06T11:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393639",
    "user": "@slel"
}
```

Ticket #31395 removed `memlimit` for doctests.



---

archive/issue_comments_393640.json:
```json
{
    "body": "Replying to [comment:44 slelievre]:\n> Ticket #31395 removed `memlimit` for doctests.\n\nShould we close this then?",
    "created_at": "2021-04-09T19:50:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393640",
    "user": "@mwageringel"
}
```

Replying to [comment:44 slelievre]:
> Ticket #31395 removed `memlimit` for doctests.

Should we close this then?



---

archive/issue_comments_393641.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2021-04-09T19:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393641",
    "user": "@mwageringel"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_393642.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-04-09T20:21:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393642",
    "user": "@dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_393643.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2021-06-24T20:15:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/27869",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/27869#issuecomment-393643",
    "user": "@mkoeppe"
}
```

Resolution: invalid
