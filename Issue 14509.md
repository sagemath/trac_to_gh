# Issue 14509: Update to IPython 1.0

archive/issues_014509.json:
```json
{
    "body": "Assignee: jdemeyer\n\nCC:  roed\n\nIPython 1.0 will be released soon (their plan is by mid-July 2013).\n\nI'll post an spkg when it gets released.  In the meantime, the patches below work with the current master (IPython commit 3db168c4bfb0391c9a58fa069796550ae2a9fc09).  Changes in IPython resulted in massive cleanup of the custom Sage transformations.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14713\n\n",
    "created_at": "2013-06-10T10:57:14Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "title": "Update to IPython 1.0",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14509",
    "user": "jason"
}
```
Assignee: jdemeyer

CC:  roed

IPython 1.0 will be released soon (their plan is by mid-July 2013).

I'll post an spkg when it gets released.  In the meantime, the patches below work with the current master (IPython commit 3db168c4bfb0391c9a58fa069796550ae2a9fc09).  Changes in IPython resulted in massive cleanup of the custom Sage transformations.

Issue created by migration from https://trac.sagemath.org/ticket/14713





---

archive/issue_comments_184131.json:
```json
{
    "body": "Attachment",
    "created_at": "2013-06-10T10:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184131",
    "user": "jason"
}
```

Attachment



---

archive/issue_comments_184132.json:
```json
{
    "body": "Updated patch",
    "created_at": "2013-08-09T15:27:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184132",
    "user": "vbraun"
}
```

Updated patch



---

archive/issue_comments_184133.json:
```json
{
    "body": "Attachment\n\nEverything works except a failure in `sage/doctest/forker.py` when running the doctest through the `sage0` interface. The pexpect log contains the traceback\n\n```\nMultipleInstanceError                     Traceback (most recent call last)\n<ipython-input-12-54a61f46e9ab> in <module>()\n----> 1 DTR.run(DT, clear_globs=False)\n\n/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.pyc in run(self, test, compileflags, out, clear_globs)\n    623         self.no_failure_yet = True\n    624         try:\n--> 625             return self._run(test, compileflags, out)\n    626         finally:\n    627             self._fakeout.stop_spoofing()\n\n/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.pyc in _run(self, test, compileflags, out)\n    535             elif outcome is FAILURE:\n    536                 if not quiet:\n--> 537                     self.report_failure(out, test, example, got, test.globs)\n    538                 failures += 1\n    539             elif outcome is BOOM:\n\n/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.pyc in report_failure(self, out, test, example, got, globs)\n   1112                     prompt_config.in_template = 'debug: '\n   1113                     prompt_config.in2_template = '.....: '\n-> 1114                     embed(config=cfg, banner1='', user_ns=dict(globs))\n   1115                 except KeyboardInterrupt:a\n\n   1116                     # Assume this is a *real* interrupt. We need to\n\n/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/IPython/terminal/embed.pyc in embed(**kwargs)\n    298         config.InteractiveShellEmbed = config.TerminalInteractiveShell\n    299         kwargs['config'] = config\n--> 300     shell = InteractiveShellEmbed.instance(**kwargs)\n    301     shell(header=header, stack_depth=2, compile_flags=compile_flags)\n\n/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/IPython/config/configurable.pyc in instance(cls, *args, **kwargs)\n    358             raise MultipleInstanceError(\n    359                 'Multiple incompatible subclass instances of '\n--> 360                 '%s are being created.' % cls.__name__\n    361             )\n    362 \n\nMultipleInstanceError: Multiple incompatible subclass instances of InteractiveShellEmbed are being created.\n```\n",
    "created_at": "2013-08-09T15:37:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184133",
    "user": "vbraun"
}
```

Attachment

Everything works except a failure in `sage/doctest/forker.py` when running the doctest through the `sage0` interface. The pexpect log contains the traceback

```
MultipleInstanceError                     Traceback (most recent call last)
<ipython-input-12-54a61f46e9ab> in <module>()
----> 1 DTR.run(DT, clear_globs=False)

/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.pyc in run(self, test, compileflags, out, clear_globs)
    623         self.no_failure_yet = True
    624         try:
--> 625             return self._run(test, compileflags, out)
    626         finally:
    627             self._fakeout.stop_spoofing()

/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.pyc in _run(self, test, compileflags, out)
    535             elif outcome is FAILURE:
    536                 if not quiet:
--> 537                     self.report_failure(out, test, example, got, test.globs)
    538                 failures += 1
    539             elif outcome is BOOM:

/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/sage/doctest/forker.pyc in report_failure(self, out, test, example, got, globs)
   1112                     prompt_config.in_template = 'debug: '
   1113                     prompt_config.in2_template = '.....: '
-> 1114                     embed(config=cfg, banner1='', user_ns=dict(globs))
   1115                 except KeyboardInterrupt:a

   1116                     # Assume this is a *real* interrupt. We need to

/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/IPython/terminal/embed.pyc in embed(**kwargs)
    298         config.InteractiveShellEmbed = config.TerminalInteractiveShell
    299         kwargs['config'] = config
--> 300     shell = InteractiveShellEmbed.instance(**kwargs)
    301     shell(header=header, stack_depth=2, compile_flags=compile_flags)

/home/vbraun/opt/sage-5.11.rc0/local/lib/python2.7/site-packages/IPython/config/configurable.pyc in instance(cls, *args, **kwargs)
    358             raise MultipleInstanceError(
    359                 'Multiple incompatible subclass instances of '
--> 360                 '%s are being created.' % cls.__name__
    361             )
    362 

MultipleInstanceError: Multiple incompatible subclass instances of InteractiveShellEmbed are being created.
```




---

archive/issue_comments_184134.json:
```json
{
    "body": "I've been continuing work on this in my ipython-1.0 branch on github: https://github.com/jasongrout/sage/tree/ipython-1.0\n\nI ran into some changes in IPython system_raw exit code that caused us problems.  I posted about it here: http://mail.scipy.org/pipermail/ipython-dev/2013-August/012102.html  But IPython 1.0 is released without this being resolved, so I think we ought to just update our doctests that are failing because of it.\n\nI am also doing some experimental work on \"string decorators\" on that branch, inspired by what William did in sage cloud.  However, it's still at a preview stage.  I can turn it off by default, though, and we can continue to work on it.",
    "created_at": "2013-08-09T17:57:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184134",
    "user": "jason"
}
```

I've been continuing work on this in my ipython-1.0 branch on github: https://github.com/jasongrout/sage/tree/ipython-1.0

I ran into some changes in IPython system_raw exit code that caused us problems.  I posted about it here: http://mail.scipy.org/pipermail/ipython-dev/2013-August/012102.html  But IPython 1.0 is released without this being resolved, so I think we ought to just update our doctests that are failing because of it.

I am also doing some experimental work on "string decorators" on that branch, inspired by what William did in sage cloud.  However, it's still at a preview stage.  I can turn it off by default, though, and we can continue to work on it.



---

archive/issue_comments_184135.json:
```json
{
    "body": "The exit code thing has already been resolved in #14810",
    "created_at": "2013-08-09T18:05:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184135",
    "user": "vbraun"
}
```

The exit code thing has already been resolved in #14810



---

archive/issue_comments_184136.json:
```json
{
    "body": "+1 to this.  I'm using ipython 1.0 with the patches from the git repo for cloud.sagemath very soon.\nHere's how:\n\n\n```\ncd devel/sage/\nwget https://github.com/jasongrout/sage/commit/fdbe79ef7ed0ca0fa6c712c4c580ba34de1a1166.patch\nwget https://github.com/jasongrout/sage/commit/c1ad5805558b15694d783bbb5c77296f2d492b2e.patch\npatch --ignore-whitespace -p2 < fdbe79ef7ed0ca0fa6c712c4c580ba34de1a1166.patch\npatch --ignore-whitespace -p2 < c1ad5805558b15694d783bbb5c77296f2d492b2e.patch\ncd ../..\n./sage -b\nrm -rf local/lib/python/site-packages/IPython* local/lib/python/site-package/ipython*\n./sage -sh\neasy_install ipython\n```\n\n\nThey work.\n\n\nFor convenience, here is a single hg patch:\n\n   http://wstein.org/home/wstein/tmp/trac-14713.patch",
    "created_at": "2013-09-01T16:45:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184136",
    "user": "was"
}
```

+1 to this.  I'm using ipython 1.0 with the patches from the git repo for cloud.sagemath very soon.
Here's how:


```
cd devel/sage/
wget https://github.com/jasongrout/sage/commit/fdbe79ef7ed0ca0fa6c712c4c580ba34de1a1166.patch
wget https://github.com/jasongrout/sage/commit/c1ad5805558b15694d783bbb5c77296f2d492b2e.patch
patch --ignore-whitespace -p2 < fdbe79ef7ed0ca0fa6c712c4c580ba34de1a1166.patch
patch --ignore-whitespace -p2 < c1ad5805558b15694d783bbb5c77296f2d492b2e.patch
cd ../..
./sage -b
rm -rf local/lib/python/site-packages/IPython* local/lib/python/site-package/ipython*
./sage -sh
easy_install ipython
```


They work.


For convenience, here is a single hg patch:

   http://wstein.org/home/wstein/tmp/trac-14713.patch



---

archive/issue_comments_184137.json:
```json
{
    "body": "Just for the record: some of my students often get hit by some bracktraces not being printed out properly when using %attach. This looks like https://github.com/ipython/ipython/issues/2512.\n\nNothing critical, but they will appreciate the upgrade :-)\n\nThanks!",
    "created_at": "2014-02-05T10:49:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184137",
    "user": "nthiery"
}
```

Just for the record: some of my students often get hit by some bracktraces not being printed out properly when using %attach. This looks like https://github.com/ipython/ipython/issues/2512.

Nothing critical, but they will appreciate the upgrade :-)

Thanks!



---

archive/issue_comments_184138.json:
```json
{
    "body": "2.0 will probably be released within the month or so.  I'm tracking the changes on IPython master so it will be an easy upgrade.",
    "created_at": "2014-02-05T14:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184138",
    "user": "jason"
}
```

2.0 will probably be released within the month or so.  I'm tracking the changes on IPython master so it will be an easy upgrade.



---

archive/issue_comments_184139.json:
```json
{
    "body": "Nice. Thanks for the update!",
    "created_at": "2014-02-05T14:42:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184139",
    "user": "nthiery"
}
```

Nice. Thanks for the update!



---

archive/issue_comments_184140.json:
```json
{
    "body": "Sure, no problem.  I'm tracking the changes because I'm running (close to) IPython master for the Sage cell server.  My current patches are here: https://github.com/jasongrout/sage/commits/sagecell (up through change d662bf2655dcdc04100a8f29ccb88b790377b46a or so)",
    "created_at": "2014-02-05T18:34:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184140",
    "user": "jason"
}
```

Sure, no problem.  I'm tracking the changes because I'm running (close to) IPython master for the Sage cell server.  My current patches are here: https://github.com/jasongrout/sage/commits/sagecell (up through change d662bf2655dcdc04100a8f29ccb88b790377b46a or so)



---

archive/issue_comments_184141.json:
```json
{
    "body": "I see no reason to wait for IPython 2.0. There are still some issues that stem from the issue found in #14961.",
    "created_at": "2014-02-15T00:27:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184141",
    "user": "ohanar"
}
```

I see no reason to wait for IPython 2.0. There are still some issues that stem from the issue found in #14961.



---

archive/issue_comments_184142.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-02-15T00:29:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184142",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_184143.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-02-17T00:41:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184143",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_184144.json:
```json
{
    "body": "There is a single doctest that fails (in `src/sage/misc/interpreter.py`), but it doesn't match the behavior of running the test from the sage command line.\n\nAlso, we need some doctests for `sage.misc.interpreter.SagePreparseTransformer.reset`. Since I don't know the preparser code (and the `reset` keyword is documented as \"a boolean\"), it would be great if someone knowledgeable about this could fill in something here.\n\n`@`jason\nI deleted the note about the prun_magics.patch since you deleted it in https://github.com/jasongrout/sage/commit/d662bf2655dcdc04100a8f29ccb88b790377b46a. Do we still need this?",
    "created_at": "2014-02-17T00:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184144",
    "user": "ohanar"
}
```

There is a single doctest that fails (in `src/sage/misc/interpreter.py`), but it doesn't match the behavior of running the test from the sage command line.

Also, we need some doctests for `sage.misc.interpreter.SagePreparseTransformer.reset`. Since I don't know the preparser code (and the `reset` keyword is documented as "a boolean"), it would be great if someone knowledgeable about this could fill in something here.

`@`jason
I deleted the note about the prun_magics.patch since you deleted it in https://github.com/jasongrout/sage/commit/d662bf2655dcdc04100a8f29ccb88b790377b46a. Do we still need this?



---

archive/issue_comments_184145.json:
```json
{
    "body": "Replying to [comment:13 ohanar]:\n> I see no reason to wait for IPython 2.0. There are still some issues that stem from the issue found in #14961.\n\nI strongly agree with not waiting for IPython 2.0.  They also make some controversial modal changes to the IPython notebook, and I want to see how those shake out in wider testing before switching (i.e., it might be best to wait for 2.1).",
    "created_at": "2014-03-01T18:23:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184145",
    "user": "was"
}
```

Replying to [comment:13 ohanar]:
> I see no reason to wait for IPython 2.0. There are still some issues that stem from the issue found in #14961.

I strongly agree with not waiting for IPython 2.0.  They also make some controversial modal changes to the IPython notebook, and I want to see how those shake out in wider testing before switching (i.e., it might be best to wait for 2.1).



---

archive/issue_comments_184146.json:
```json
{
    "body": "How is this supposed to actually work?\n\n\n```\nAttempting to download package ipython-1.2.0\n>>> Trying to download http://www.sagemath.org/packages/upstream/ipython/ipython-1.2.0.tar.gz\n[Traceback (most recent call last):\n  File \"<stdin>\", line 35, in <module>\n  File \"/usr/local/sage/sage-6.2/local/lib/python/urllib.py\", line 240, in retrieve\n    fp = self.open(url, data)\n  File \"/usr/local/sage/sage-6.2/local/lib/python/urllib.py\", line 208, in open\n    return getattr(self, name)(url)\n  File \"/usr/local/sage/sage-6.2/local/lib/python/urllib.py\", line 359, in open_http\n    return self.http_error(url, fp, errcode, errmsg, headers)\n  File \"/usr/local/sage/sage-6.2/local/lib/python/urllib.py\", line 376, in http_error\n    return self.http_error_default(url, fp, errcode, errmsg, headers)\n  File \"<stdin>\", line 17, in http_error_default\nIOError: [Errno 404] Not Found: '//www.sagemath.org/packages/upstream/ipython/ipython-1.2.0.tar.gz'\nError: failed to download package ipython-1.2.0\nmake[2]: *** [/usr/local/sage/sage-6.2/local/var/lib/sage/installed/ipython-1.2.0] Error 1\nmake[2]: Leaving directory `/usr/local/sage/sage-6.2/build'\nmake[1]: *** [all] Error 2\nmake[1]: Leaving directory `/usr/local/sage/sage-6.2/build'\n \nreal    24m14.305s\n```\n\n\nObviously, I can get around this.  However, I'm concerned about this entire approach to development...",
    "created_at": "2014-03-01T20:15:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184146",
    "user": "was"
}
```

How is this supposed to actually work?


```
Attempting to download package ipython-1.2.0
>>> Trying to download http://www.sagemath.org/packages/upstream/ipython/ipython-1.2.0.tar.gz
[Traceback (most recent call last):
  File "<stdin>", line 35, in <module>
  File "/usr/local/sage/sage-6.2/local/lib/python/urllib.py", line 240, in retrieve
    fp = self.open(url, data)
  File "/usr/local/sage/sage-6.2/local/lib/python/urllib.py", line 208, in open
    return getattr(self, name)(url)
  File "/usr/local/sage/sage-6.2/local/lib/python/urllib.py", line 359, in open_http
    return self.http_error(url, fp, errcode, errmsg, headers)
  File "/usr/local/sage/sage-6.2/local/lib/python/urllib.py", line 376, in http_error
    return self.http_error_default(url, fp, errcode, errmsg, headers)
  File "<stdin>", line 17, in http_error_default
IOError: [Errno 404] Not Found: '//www.sagemath.org/packages/upstream/ipython/ipython-1.2.0.tar.gz'
Error: failed to download package ipython-1.2.0
make[2]: *** [/usr/local/sage/sage-6.2/local/var/lib/sage/installed/ipython-1.2.0] Error 1
make[2]: Leaving directory `/usr/local/sage/sage-6.2/build'
make[1]: *** [all] Error 2
make[1]: Leaving directory `/usr/local/sage/sage-6.2/build'
 
real    24m14.305s
```


Obviously, I can get around this.  However, I'm concerned about this entire approach to development...



---

archive/issue_comments_184147.json:
```json
{
    "body": "You need to put the tarball manually in the `upstream` directory until the ticket is reviewed.",
    "created_at": "2014-03-01T20:18:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184147",
    "user": "vbraun"
}
```

You need to put the tarball manually in the `upstream` directory until the ticket is reviewed.



---

archive/issue_comments_184148.json:
```json
{
    "body": "Replying to [comment:19 vbraun]:\n> You need to put the tarball manually in the `upstream` directory until the ticket is reviewed. \n\nThat's what I did.   It would be nice if the code that tries to grab the upstream from sagemath.org could also try other locations specified in the package, e.g., in this case https://pypi.python.org/packages/source/i/ipython/ipython-1.2.0.tar.gz...\n\nI hope our longterm plan is that the process is:\n\n```\n   git <checkout a branch somehow>\n   make\n```\n\nand it works, rather than\n\n```\n   git <checkout a branch somehow>\n   make\n   # see download failure -- track down packages -- put in upstream directory\n   make\n   # see more download failures -- track down packages -- put in upstream directory, etc.\n```\n\n\n?",
    "created_at": "2014-03-01T20:34:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184148",
    "user": "was"
}
```

Replying to [comment:19 vbraun]:
> You need to put the tarball manually in the `upstream` directory until the ticket is reviewed. 

That's what I did.   It would be nice if the code that tries to grab the upstream from sagemath.org could also try other locations specified in the package, e.g., in this case https://pypi.python.org/packages/source/i/ipython/ipython-1.2.0.tar.gz...

I hope our longterm plan is that the process is:

```
   git <checkout a branch somehow>
   make
```

and it works, rather than

```
   git <checkout a branch somehow>
   make
   # see download failure -- track down packages -- put in upstream directory
   make
   # see more download failures -- track down packages -- put in upstream directory, etc.
```


?



---

archive/issue_comments_184149.json:
```json
{
    "body": "The pypi url is not in the git branch. There are also some projects where you need to click through some html to get a temporary download link *cough* *sourceforge* *cough*. Really we need a common place where people can upload the tarballs.",
    "created_at": "2014-03-01T20:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184149",
    "user": "vbraun"
}
```

The pypi url is not in the git branch. There are also some projects where you need to click through some html to get a temporary download link *cough* *sourceforge* *cough*. Really we need a common place where people can upload the tarballs.



---

archive/issue_comments_184150.json:
```json
{
    "body": "+1 to moving to 1.2 now.  I'm not running any extra patches beyond my 1.0 patches to get IPython master working.  So if you merge this, I can stop maintaining the patches, even though I'm running master :).\n\nAnd +1 to william's suggestion of having alternate URLs, since we are verifying the checksum anyway.",
    "created_at": "2014-03-01T21:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184150",
    "user": "jason"
}
```

+1 to moving to 1.2 now.  I'm not running any extra patches beyond my 1.0 patches to get IPython master working.  So if you merge this, I can stop maintaining the patches, even though I'm running master :).

And +1 to william's suggestion of having alternate URLs, since we are verifying the checksum anyway.



---

archive/issue_comments_184151.json:
```json
{
    "body": "Note that IPython 1.2.1 is out, which fixes a bug they noticed just after 1.2",
    "created_at": "2014-03-01T21:15:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184151",
    "user": "jason"
}
```

Note that IPython 1.2.1 is out, which fixes a bug they noticed just after 1.2



---

archive/issue_comments_184152.json:
```json
{
    "body": "*IMPORTANT*  This patch introduces this code in the middle of ```src/bin/sage-env``` *before* the path, etc., is properly set up:\n\n```\nif [ -x \"$SAGE_LOCAL/bin/ipython\" ]; then\n    export IPYTHONDIR=\"$DOT_SAGE/ipython-\"`ipython --version`\nelse\n    # IPython is not yet installed\n    export IPYTHONDIR=\"$DOT_SAGE/ipython-\"`sed 's+\\.p[0-9]*$++' \"$SAGE_ROOT\"/build/pkgs/ipython/package-version.txt`\nfi\n```\n\n\nThe result is that in a system with multiple version of Ipython (e.g., using python2.7.3 also) you'll get a big nasty ```ImportError: cannot import name MAXREPEAT``` error/traceback whenever you try to start sage (or use ```sage -sh```).    Moving the above IPYTHONDIR stuff to the bottom of the sage-env fixes the problem. \n\nThat said, it's kind of disturbing to be starting up ipython when doing \"sage -sh\", since that's actually a lot of overhead.",
    "created_at": "2014-03-02T00:02:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184152",
    "user": "was"
}
```

*IMPORTANT*  This patch introduces this code in the middle of ```src/bin/sage-env``` *before* the path, etc., is properly set up:

```
if [ -x "$SAGE_LOCAL/bin/ipython" ]; then
    export IPYTHONDIR="$DOT_SAGE/ipython-"`ipython --version`
else
    # IPython is not yet installed
    export IPYTHONDIR="$DOT_SAGE/ipython-"`sed 's+\.p[0-9]*$++' "$SAGE_ROOT"/build/pkgs/ipython/package-version.txt`
fi
```


The result is that in a system with multiple version of Ipython (e.g., using python2.7.3 also) you'll get a big nasty ```ImportError: cannot import name MAXREPEAT``` error/traceback whenever you try to start sage (or use ```sage -sh```).    Moving the above IPYTHONDIR stuff to the bottom of the sage-env fixes the problem. 

That said, it's kind of disturbing to be starting up ipython when doing "sage -sh", since that's actually a lot of overhead.



---

archive/issue_comments_184153.json:
```json
{
    "body": "Replying to [comment:23 jason]:\n> Note that IPython 1.2.1 is out, which fixes a bug they noticed just after 1.2\n\nThe upstream tarball is: https://pypi.python.org/packages/source/i/ipython/ipython-1.2.1.tar.gz",
    "created_at": "2014-03-02T00:06:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184153",
    "user": "was"
}
```

Replying to [comment:23 jason]:
> Note that IPython 1.2.1 is out, which fixes a bug they noticed just after 1.2

The upstream tarball is: https://pypi.python.org/packages/source/i/ipython/ipython-1.2.1.tar.gz



---

archive/issue_comments_184154.json:
```json
{
    "body": "I know patches are stupid, but in case anybody cares, here's the patch to move the ipython version environ stuff and update the version of the tarball: http://wstein.org/tmp/ipython-1.2.1.patch",
    "created_at": "2014-03-02T00:28:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184154",
    "user": "was"
}
```

I know patches are stupid, but in case anybody cares, here's the patch to move the ipython version environ stuff and update the version of the tarball: http://wstein.org/tmp/ipython-1.2.1.patch



---

archive/issue_comments_184155.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-04T01:55:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184155",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_184156.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-03-04T02:05:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184156",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_184157.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-03-04T02:05:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184157",
    "user": "ohanar"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_184158.json:
```json
{
    "body": "You changed the preparser to a stateless transformer, but the preparse function *does* have state---it keeps track of the quote state, right?",
    "created_at": "2014-03-04T04:09:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184158",
    "user": "jason"
}
```

You changed the preparser to a stateless transformer, but the preparse function *does* have state---it keeps track of the quote state, right?



---

archive/issue_comments_184159.json:
```json
{
    "body": "Replying to [comment:32 jason]:\n> You changed the preparser to a stateless transformer, but the preparse function *does* have state---it keeps track of the quote state, right?\nYes, although that seems like a hack that was only needed in old versions of ipython. Now ipython doesn't push an open ended quote state to the transformers, so the preparser doesn't actually need to keep track of this anymore.\n\nI think there is a lot that can be done to clean up the preparser in general, but I think that is better fit for another ticket.",
    "created_at": "2014-03-04T04:35:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184159",
    "user": "ohanar"
}
```

Replying to [comment:32 jason]:
> You changed the preparser to a stateless transformer, but the preparse function *does* have state---it keeps track of the quote state, right?
Yes, although that seems like a hack that was only needed in old versions of ipython. Now ipython doesn't push an open ended quote state to the transformers, so the preparser doesn't actually need to keep track of this anymore.

I think there is a lot that can be done to clean up the preparser in general, but I think that is better fit for another ticket.



---

archive/issue_comments_184160.json:
```json
{
    "body": "I've read all of this code pretty carefully, used it for months (in various incarnations by Jason and Andrew), and think upgrading to IPython 1.2.1 should be a very high priority for Sage.   I'm running a clean build and round of doctests, and if they succeed, then this should get a positive review!",
    "created_at": "2014-03-04T04:51:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184160",
    "user": "was"
}
```

I've read all of this code pretty carefully, used it for months (in various incarnations by Jason and Andrew), and think upgrading to IPython 1.2.1 should be a very high priority for Sage.   I'm running a clean build and round of doctests, and if they succeed, then this should get a positive review!



---

archive/issue_comments_184161.json:
```json
{
    "body": "I'll do some checking too.  My worry is not that the preparser could be cleaned up (it certainly could, but that's another issue), but that changing from a coroutine transformer to a stateless transformer is introducing bugs.  I'm not sure why that change was made.  Could you perhaps explain why it's not a coroutine transformer still?",
    "created_at": "2014-03-04T16:19:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184161",
    "user": "jason"
}
```

I'll do some checking too.  My worry is not that the preparser could be cleaned up (it certainly could, but that's another issue), but that changing from a coroutine transformer to a stateless transformer is introducing bugs.  I'm not sure why that change was made.  Could you perhaps explain why it's not a coroutine transformer still?



---

archive/issue_comments_184162.json:
```json
{
    "body": "oh, I see you did have an explanation.  I'll look into it to make sure.",
    "created_at": "2014-03-04T16:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184162",
    "user": "jason"
}
```

oh, I see you did have an explanation.  I'll look into it to make sure.



---

archive/issue_comments_184163.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-03-04T16:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184163",
    "user": "was"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_184164.json:
```json
{
    "body": "Builds fine and all tests pass. The issues I pointed out above have also been addressed.",
    "created_at": "2014-03-04T16:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184164",
    "user": "was"
}
```

Builds fine and all tests pass. The issues I pointed out above have also been addressed.



---

archive/issue_comments_184165.json:
```json
{
    "body": "and I'm still building...",
    "created_at": "2014-03-04T16:55:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184165",
    "user": "jason"
}
```

and I'm still building...



---

archive/issue_comments_184166.json:
```json
{
    "body": "Giving a partial string as a command messes up the parser because the state is not reset, like `\"asdf`.  I'm figuring out how to exploit it.",
    "created_at": "2014-03-04T17:25:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184166",
    "user": "jason"
}
```

Giving a partial string as a command messes up the parser because the state is not reset, like `"asdf`.  I'm figuring out how to exploit it.



---

archive/issue_comments_184167.json:
```json
{
    "body": "All right +1.  IPython *does* push open-ended quotes into the preparser if the line is a syntax error (like `\"a`).  However, the preparser is now always called with `reset=True` (the default), so the state doesn't carry over to the next line.\n\nHere is a more complete explanation for it being okay to have a stateless transformation---it relies on two facts that are true right now:\n* we've switched the preparser to be an IPython python_line_transform (which assembles multiline strings into single lines)\n* the preparser has a default of reset=True, which means every time it is called, the state is discarded\n\nIf either of those changes, trouble would probably show up.\n\nOther than that detail, this looks pretty much like the code I've been running on the sage cell server for nearly 6 months, so +1.",
    "created_at": "2014-03-04T18:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184167",
    "user": "jason"
}
```

All right +1.  IPython *does* push open-ended quotes into the preparser if the line is a syntax error (like `"a`).  However, the preparser is now always called with `reset=True` (the default), so the state doesn't carry over to the next line.

Here is a more complete explanation for it being okay to have a stateless transformation---it relies on two facts that are true right now:
* we've switched the preparser to be an IPython python_line_transform (which assembles multiline strings into single lines)
* the preparser has a default of reset=True, which means every time it is called, the state is discarded

If either of those changes, trouble would probably show up.

Other than that detail, this looks pretty much like the code I've been running on the sage cell server for nearly 6 months, so +1.



---

archive/issue_comments_184168.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-03-05T09:36:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184168",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_184169.json:
```json
{
    "body": "Blocker follow-up at #15972",
    "created_at": "2014-03-18T10:04:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184169",
    "user": "jdemeyer"
}
```

Blocker follow-up at #15972



---

archive/issue_comments_184170.json:
```json
{
    "body": "Random test failures due to history corruption at #16372",
    "created_at": "2014-05-17T14:47:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14509",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14509#issuecomment-184170",
    "user": "vbraun"
}
```

Random test failures due to history corruption at #16372
