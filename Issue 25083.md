# Issue 25083: Make ZeroDivisionError format more flexible

archive/issues_025083.json:
```json
{
    "body": "Apparently there are at least two formats for `ZeroDivisionError`s out there. Sage expects\n\n```\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    ...\n    ZeroDivisionError: rational division by zero\n```\n\nwhile I get (with nix):\n\n```\n<BLANKLINE>\n    ZeroDivisionErrorTraceback (most recent call last)\n    ...\n    ZeroDivisionError: rational division by zero\n```\n\nI'm not sure what is causing this difference. Apparently [debian has the same problem](https://salsa.debian.org/science-team/sagemath/blob/e063adfe71044302f7777bd1d4794f6b8ca31c8d/debian/patches/u2-fix-trivial-test-cases.patch#L47).\n\nThis patch makes the doctests accept both formats.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25320\n\n",
    "created_at": "2018-05-09T21:51:40Z",
    "labels": [
        "component: porting"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.3",
    "title": "Make ZeroDivisionError format more flexible",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25083",
    "user": "https://github.com/timokau"
}
```
Apparently there are at least two formats for `ZeroDivisionError`s out there. Sage expects

```
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    ...
    ZeroDivisionError: rational division by zero
```

while I get (with nix):

```
<BLANKLINE>
    ZeroDivisionErrorTraceback (most recent call last)
    ...
    ZeroDivisionError: rational division by zero
```

I'm not sure what is causing this difference. Apparently [debian has the same problem](https://salsa.debian.org/science-team/sagemath/blob/e063adfe71044302f7777bd1d4794f6b8ca31c8d/debian/patches/u2-fix-trivial-test-cases.patch#L47).

This patch makes the doctests accept both formats.

Issue created by migration from https://trac.sagemath.org/ticket/25320





---

archive/issue_comments_352599.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-09T21:51:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352599",
    "user": "https://github.com/timokau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_352600.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-05-10T07:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352600",
    "user": "https://github.com/seblabbe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_352601.json:
```json
{
    "body": "There is a log file in the commit.",
    "created_at": "2018-05-10T07:32:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352601",
    "user": "https://github.com/seblabbe"
}
```

There is a log file in the commit.



---

archive/issue_comments_352602.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-05-10T08:45:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352602",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352603.json:
```json
{
    "body": "Oh  sorry, I should've reviewed before pushing. Removed.",
    "created_at": "2018-05-10T08:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352603",
    "user": "https://github.com/timokau"
}
```

Oh  sorry, I should've reviewed before pushing. Removed.



---

archive/issue_comments_352604.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-05-10T08:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352604",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352605.json:
```json
{
    "body": "You need a patched version of https://github.com/chrippa/backports.shutil_get_terminal_size",
    "created_at": "2018-06-06T15:02:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352605",
    "user": "https://github.com/jdemeyer"
}
```

You need a patched version of https://github.com/chrippa/backports.shutil_get_terminal_size



---

archive/issue_comments_352606.json:
```json
{
    "body": "It seems like this patch was only included to fix this formatting error (#20599). This is a bit meta, but is there a general patching policy for sage?\n\nSage patches a lot of its dependencies and often has very good reasons to do so. But sometimes it is not strictly necessary. That makes life hard for packagers and also for the people maintaining the sage spkgs. In my opinion patching dependencies should be a last resort, only if there is pretty much no other option.",
    "created_at": "2018-06-06T15:13:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352606",
    "user": "https://github.com/timokau"
}
```

It seems like this patch was only included to fix this formatting error (#20599). This is a bit meta, but is there a general patching policy for sage?

Sage patches a lot of its dependencies and often has very good reasons to do so. But sometimes it is not strictly necessary. That makes life hard for packagers and also for the people maintaining the sage spkgs. In my opinion patching dependencies should be a last resort, only if there is pretty much no other option.



---

archive/issue_comments_352607.json:
```json
{
    "body": "Replying to [comment:9 gh-timokau]:\n> This is a bit meta, but is there a general patching policy for sage?\n\n\nThere is no such policy. But it might be a good topic for discussion on `sage-packaging` (do you know about that mailing list?)",
    "created_at": "2018-06-06T15:21:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352607",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:9 gh-timokau]:
> This is a bit meta, but is there a general patching policy for sage?


There is no such policy. But it might be a good topic for discussion on `sage-packaging` (do you know about that mailing list?)



---

archive/issue_comments_352608.json:
```json
{
    "body": "Yes I do, but to my understanding the purpose of that list is packagers working together to solve packaging issues right? Such a policy would benefit packagers, but upstream developers would need to be the ones actually deciding on it and adhering to it. So I don't think discussing that on sage-packaging is very useful.\n\nMaybe sage-devel, if there is no more proper place to discuss that?",
    "created_at": "2018-06-06T15:44:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352608",
    "user": "https://github.com/timokau"
}
```

Yes I do, but to my understanding the purpose of that list is packagers working together to solve packaging issues right? Such a policy would benefit packagers, but upstream developers would need to be the ones actually deciding on it and adhering to it. So I don't think discussing that on sage-packaging is very useful.

Maybe sage-devel, if there is no more proper place to discuss that?



---

archive/issue_comments_352609.json:
```json
{
    "body": "I have posted on sage-devel about this (https://groups.google.com/forum/#!topic/sage-devel/-lBph6WWg5E), so this ticket can go back to topic.",
    "created_at": "2018-06-06T16:49:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352609",
    "user": "https://github.com/timokau"
}
```

I have posted on sage-devel about this (https://groups.google.com/forum/#!topic/sage-devel/-lBph6WWg5E), so this ticket can go back to topic.



---

archive/issue_comments_352610.json:
```json
{
    "body": "Your patch looks good to me. I think a ` # see #25320 for the apparently unnecessary ...` or something similar would be nice to make sure that nobody takes this out on the next refactoring.\n\nFeel free to set this to positive review once you added a comment, or also if you don't deem it necessary.",
    "created_at": "2018-06-07T19:25:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352610",
    "user": "https://github.com/saraedum"
}
```

Your patch looks good to me. I think a ` # see #25320 for the apparently unnecessary ...` or something similar would be nice to make sure that nobody takes this out on the next refactoring.

Feel free to set this to positive review once you added a comment, or also if you don't deem it necessary.



---

archive/issue_comments_352611.json:
```json
{
    "body": "Yeah I thought about that but I wasn't sure how to add comments to the doctests.\n\nSimply a `sage: # my comment` line? That would also show up in the generated docs right?",
    "created_at": "2018-06-07T20:11:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352611",
    "user": "https://github.com/timokau"
}
```

Yeah I thought about that but I wasn't sure how to add comments to the doctests.

Simply a `sage: # my comment` line? That would also show up in the generated docs right?



---

archive/issue_comments_352612.json:
```json
{
    "body": "Yes, I think that's acceptable.",
    "created_at": "2018-06-11T08:04:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352612",
    "user": "https://github.com/saraedum"
}
```

Yes, I think that's acceptable.



---

archive/issue_comments_352613.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-11T09:47:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352613",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352614.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-11T09:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352614",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352615.json:
```json
{
    "body": "Okay, I added such a comment.\n\n---\nNew commits:",
    "created_at": "2018-06-11T09:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352615",
    "user": "https://github.com/timokau"
}
```

Okay, I added such a comment.

---
New commits:



---

archive/issue_comments_352616.json:
```json
{
    "body": "Well thank you for this. I couldn't figure which part was causing the breakage in sage-on-gentoo.",
    "created_at": "2018-06-11T22:19:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352616",
    "user": "https://github.com/kiwifb"
}
```

Well thank you for this. I couldn't figure which part was causing the breakage in sage-on-gentoo.



---

archive/issue_comments_352617.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-06-12T20:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352617",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_352618.json:
```json
{
    "body": "```\n**********************************************************************\nFile \"src/sage/repl/interpreter.py\", line 77, in sage.repl.interpreter\nFailed example:\n    shell.run_cell('1/0') # see #25320 for the reason of the `...` in this test\nExpected:\n    ZeroDivisionError...Traceback (most recent call last)\n    <ipython-input-...> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    .../sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()\n       ...        if type(left) is type(right):\n       ...            if mpz_sgn((<Integer>right).value) == 0:\n    -> ...                  raise ZeroDivisionError(\"rational division by zero\")\n       ...            x = <Rational> Rational.__new__(Rational)\n       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\nGot:\n    ---------------------------------------------------------------------------\n    ZeroDivisionError                         Traceback (most recent call last)\n    <ipython-input-1-72ac74c5f414> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13287)()\n       1923         if type(left) is type(right):\n       1924             if mpz_sgn((<Integer>right).value) == 0:\n    -> 1925                 raise ZeroDivisionError(\"rational division by zero\")\n       1926             x = <Rational> Rational.__new__(Rational)\n       1927             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\n**********************************************************************\n```",
    "created_at": "2018-06-12T20:45:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352618",
    "user": "https://github.com/vbraun"
}
```

```
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    shell.run_cell('1/0') # see #25320 for the reason of the `...` in this test
Expected:
    ZeroDivisionError...Traceback (most recent call last)
    <ipython-input-...> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    .../sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()
       ...        if type(left) is type(right):
       ...            if mpz_sgn((<Integer>right).value) == 0:
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13287)()
       1923         if type(left) is type(right):
       1924             if mpz_sgn((<Integer>right).value) == 0:
    -> 1925                 raise ZeroDivisionError("rational division by zero")
       1926             x = <Rational> Rational.__new__(Rational)
       1927             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
```



---

archive/issue_comments_352619.json:
```json
{
    "body": "Sorry!\n\nThe issue seems to be the missing initial `...` at\n\n```\nExpected:\n    ZeroDivisionError...Traceback (most recent call last)\n```\n\nwhile the test code is:\n\n```\nsage: shell.run_cell('1/0') # see #25320 for the reason of the `...` in this test\n...\nZeroDivisionError...Traceback (most recent call last)\n```\n\nDoes anybody know why the `...` in the first line is ignored? (Or why this wasn't caught by my local tests).",
    "created_at": "2018-06-12T21:00:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352619",
    "user": "https://github.com/timokau"
}
```

Sorry!

The issue seems to be the missing initial `...` at

```
Expected:
    ZeroDivisionError...Traceback (most recent call last)
```

while the test code is:

```
sage: shell.run_cell('1/0') # see #25320 for the reason of the `...` in this test
...
ZeroDivisionError...Traceback (most recent call last)
```

Does anybody know why the `...` in the first line is ignored? (Or why this wasn't caught by my local tests).



---

archive/issue_comments_352620.json:
```json
{
    "body": "Not sure. Also Volker is only quoting one failure, does that mean that the other one passes or did he imply it was also failing? A pity, that's the first time in a long time this doctest doesn't fail on me in sage-on-gentoo.",
    "created_at": "2018-06-12T21:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352620",
    "user": "https://github.com/kiwifb"
}
```

Not sure. Also Volker is only quoting one failure, does that mean that the other one passes or did he imply it was also failing? A pity, that's the first time in a long time this doctest doesn't fail on me in sage-on-gentoo.



---

archive/issue_comments_352621.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-13T12:05:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352621",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352622.json:
```json
{
    "body": "Okay I could reproduce the error locally. No idea why I didn't notice that before, I must have messed up somewhere.\n\nApparently python will interpret those `...` at the beginning as line-continuation characters[1]. I've updated the patch with a solution for this, but its not very pretty: Print a leading dummy line.\n\nIn my opinion the best solution would be to just remove the backports patch in sage. One patch less is one problem less and this patch seems to bring little to none advantage. But judging by the mailing list discussion, `@`jdemeyer probably disagrees?\n\n[1] https://stackoverflow.com/questions/5812833/can-i-have-an-ellipsis-at-the-beginning-of-the-line-in-a-python-doctest\n\n---\nNew commits:",
    "created_at": "2018-06-13T12:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352622",
    "user": "https://github.com/timokau"
}
```

Okay I could reproduce the error locally. No idea why I didn't notice that before, I must have messed up somewhere.

Apparently python will interpret those `...` at the beginning as line-continuation characters[1]. I've updated the patch with a solution for this, but its not very pretty: Print a leading dummy line.

In my opinion the best solution would be to just remove the backports patch in sage. One patch less is one problem less and this patch seems to bring little to none advantage. But judging by the mailing list discussion, `@`jdemeyer probably disagrees?

[1] https://stackoverflow.com/questions/5812833/can-i-have-an-ellipsis-at-the-beginning-of-the-line-in-a-python-doctest

---
New commits:



---

archive/issue_comments_352623.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-13T12:07:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352623",
    "user": "https://github.com/timokau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_352624.json:
```json
{
    "body": "Replying to [comment:23 gh-timokau]:\n> In my opinion the best solution would be to just remove the backports patch in sage.\n\n\nWhy? It's not the fault of Sage that upstream doesn't make a new release (EDIT: actually, that upstream is dead). One could also argue that your distro should just apply that patch to `backports.shutil_get_terminal_size` since it fixes an actual bug.\n\n> One patch less is one problem less and this patch seems to bring little to none advantage.\n\n\nI consider correctly formatting exceptions a good feature to have.",
    "created_at": "2018-06-13T13:10:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352624",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:23 gh-timokau]:
> In my opinion the best solution would be to just remove the backports patch in sage.


Why? It's not the fault of Sage that upstream doesn't make a new release (EDIT: actually, that upstream is dead). One could also argue that your distro should just apply that patch to `backports.shutil_get_terminal_size` since it fixes an actual bug.

> One patch less is one problem less and this patch seems to bring little to none advantage.


I consider correctly formatting exceptions a good feature to have.



---

archive/issue_comments_352625.json:
```json
{
    "body": "Replying to [comment:24 jdemeyer]:\n> Replying to [comment:23 gh-timokau]:\n> > In my opinion the best solution would be to just remove the backports patch in sage.\n\n> \n> Why? It's not the fault of Sage that upstream doesn't make a new release (EDIT: actually, that upstream is dead). One could also argue that your distro should just apply that patch to `backports.shutil_get_terminal_size` since it fixes an actual bug.\n\n\nIts not, but I still think it doesn't matter whose fault it is. Instead we should choose the most practical solution. But by now we're just repeating our arguments -- I'm just going to accept that dropping the patch is not an option.\n\nYeah the owner hasn't had any [GitHub](GitHub) activity in ages. Best case would be if somebody would just fork it. Looks like there is not much maintenance needed besides reviewing the occasional patch. However I don't really feel comfortable running a python library project myself, as I have no knowledge about the ecosystem (setup.py, pypy etc).\n\n> > One patch less is one problem less and this patch seems to bring little to none advantage.\n\n> \n> I consider correctly formatting exceptions a good feature to have.\n\n\nIts kinda nice but at least in my mind not even remotely worth the trouble. The wrong format still conveys all the same information and doesn't really loose any clarity.",
    "created_at": "2018-06-13T20:18:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352625",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:24 jdemeyer]:
> Replying to [comment:23 gh-timokau]:
> > In my opinion the best solution would be to just remove the backports patch in sage.

> 
> Why? It's not the fault of Sage that upstream doesn't make a new release (EDIT: actually, that upstream is dead). One could also argue that your distro should just apply that patch to `backports.shutil_get_terminal_size` since it fixes an actual bug.


Its not, but I still think it doesn't matter whose fault it is. Instead we should choose the most practical solution. But by now we're just repeating our arguments -- I'm just going to accept that dropping the patch is not an option.

Yeah the owner hasn't had any [GitHub](GitHub) activity in ages. Best case would be if somebody would just fork it. Looks like there is not much maintenance needed besides reviewing the occasional patch. However I don't really feel comfortable running a python library project myself, as I have no knowledge about the ecosystem (setup.py, pypy etc).

> > One patch less is one problem less and this patch seems to bring little to none advantage.

> 
> I consider correctly formatting exceptions a good feature to have.


Its kinda nice but at least in my mind not even remotely worth the trouble. The wrong format still conveys all the same information and doesn't really loose any clarity.



---

archive/issue_comments_352626.json:
```json
{
    "body": "Just to talk about something else: it's a bit strange that exactly the same test appears in two places. Maybe the test inside `run_cell` could be replaced by something not raising exceptions, say\n\n```\nsage: from sage.repl.interpreter import get_test_shell\nsage: shell = get_test_shell()\nsage: rc = shell.run_cell('2^50')\n1125899906842624\nsage: rc is None\nTrue\nsage: shell.quit()\n```",
    "created_at": "2018-06-14T09:36:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352626",
    "user": "https://github.com/jdemeyer"
}
```

Just to talk about something else: it's a bit strange that exactly the same test appears in two places. Maybe the test inside `run_cell` could be replaced by something not raising exceptions, say

```
sage: from sage.repl.interpreter import get_test_shell
sage: shell = get_test_shell()
sage: rc = shell.run_cell('2^50')
1125899906842624
sage: rc is None
True
sage: shell.quit()
```



---

archive/issue_comments_352627.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> Just to talk about something else: it's a bit strange that exactly the same test appears in two places. Maybe the test inside `run_cell` could be replaced by something not raising exceptions, say\n> \n> ```\n> sage: from sage.repl.interpreter import get_test_shell\n> sage: shell = get_test_shell()\n> sage: rc = shell.run_cell('2^50')\n> 1125899906842624\n> sage: rc is None\n> True\n> sage: shell.quit()\n> ```\n\n\nStrange that it appears in two places? sage is littered with identical (and I mean identical) tests often in different files. The only thing peculiar about those two is proximity.",
    "created_at": "2018-06-14T09:39:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352627",
    "user": "https://github.com/kiwifb"
}
```

Replying to [comment:26 jdemeyer]:
> Just to talk about something else: it's a bit strange that exactly the same test appears in two places. Maybe the test inside `run_cell` could be replaced by something not raising exceptions, say
> 
> ```
> sage: from sage.repl.interpreter import get_test_shell
> sage: shell = get_test_shell()
> sage: rc = shell.run_cell('2^50')
> 1125899906842624
> sage: rc is None
> True
> sage: shell.quit()
> ```


Strange that it appears in two places? sage is littered with identical (and I mean identical) tests often in different files. The only thing peculiar about those two is proximity.



---

archive/issue_comments_352628.json:
```json
{
    "body": "Replying to [comment:27 fbissey]:\n> sage is littered with identical (and I mean identical) tests often in different files.\n\n\nI know. I think it's because of the \"coverage\" policy that every function should have tests. If people cannot come up with good tests, they just copy an existing test to satisfy the `sage-coverage` tool. It's a good example of a well-intentioned tool having unintended side effects.",
    "created_at": "2018-06-14T09:44:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352628",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:27 fbissey]:
> sage is littered with identical (and I mean identical) tests often in different files.


I know. I think it's because of the "coverage" policy that every function should have tests. If people cannot come up with good tests, they just copy an existing test to satisfy the `sage-coverage` tool. It's a good example of a well-intentioned tool having unintended side effects.



---

archive/issue_comments_352629.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-14T10:00:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352629",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_352630.json:
```json
{
    "body": "Replying to [comment:26 jdemeyer]:\n> Just to talk about something else: it's a bit strange that exactly the same test appears in two places. Maybe the test inside `run_cell` could be replaced by something not raising exceptions, say\n> \n> ```\n> sage: from sage.repl.interpreter import get_test_shell\n> sage: shell = get_test_shell()\n> sage: rc = shell.run_cell('2^50')\n> 1125899906842624\n> sage: rc is None\n> True\n> sage: shell.quit()\n> ```\n\n\nI agree, that'll improve the test (doctests with textual output are inherently brittle) and solve half of this problem.\n\nWhat about the other one? Could we maybe replace that with another exception that is well-behaved, regardless of the backport patch level?\n\nI skimmed through the source and the patch to get an idea, but I can't figure out how the backport even influences the ZeroDivisionError formatting, let alone how the `master.patch` fixes it.\n\n---\nNew commits:\n|                                                                                                                                          |                                                 |\n|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|\n|[d24dd41](https://git.sagemath.org/sage.git/commit?id=d24dd41d1634b3f0cd1707a69c6d545ae8a6b97a)|`Make the ZeroDivisionError format more flexible`|\n---\nNew commits:",
    "created_at": "2018-06-14T10:00:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352630",
    "user": "https://github.com/timokau"
}
```

Replying to [comment:26 jdemeyer]:
> Just to talk about something else: it's a bit strange that exactly the same test appears in two places. Maybe the test inside `run_cell` could be replaced by something not raising exceptions, say
> 
> ```
> sage: from sage.repl.interpreter import get_test_shell
> sage: shell = get_test_shell()
> sage: rc = shell.run_cell('2^50')
> 1125899906842624
> sage: rc is None
> True
> sage: shell.quit()
> ```


I agree, that'll improve the test (doctests with textual output are inherently brittle) and solve half of this problem.

What about the other one? Could we maybe replace that with another exception that is well-behaved, regardless of the backport patch level?

I skimmed through the source and the patch to get an idea, but I can't figure out how the backport even influences the ZeroDivisionError formatting, let alone how the `master.patch` fixes it.

---
New commits:
|                                                                                                                                          |                                                 |
|------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------|
|[d24dd41](https://git.sagemath.org/sage.git/commit?id=d24dd41d1634b3f0cd1707a69c6d545ae8a6b97a)|`Make the ZeroDivisionError format more flexible`|
---
New commits:



---

archive/issue_comments_352631.json:
```json
{
    "body": "Replying to [comment:30 gh-timokau]:\n> another exception that is well-behaved\n\n\nThe issue is not with the specific exception, but with how IPython formats exceptions in general.",
    "created_at": "2018-06-14T10:10:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352631",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:30 gh-timokau]:
> another exception that is well-behaved


The issue is not with the specific exception, but with how IPython formats exceptions in general.



---

archive/issue_comments_352632.json:
```json
{
    "body": "Oh so the backport just reports a wrong terminal size and IPython formats the exception to fit into that size? That makes sense.\n\nWhat do you think about that dummy-line \"fix\"?",
    "created_at": "2018-06-14T10:31:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352632",
    "user": "https://github.com/timokau"
}
```

Oh so the backport just reports a wrong terminal size and IPython formats the exception to fit into that size? That makes sense.

What do you think about that dummy-line "fix"?



---

archive/issue_comments_352633.json:
```json
{
    "body": "`@`jdemeyer do you think that fix is acceptable?",
    "created_at": "2018-06-30T16:44:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352633",
    "user": "https://github.com/timokau"
}
```

`@`jdemeyer do you think that fix is acceptable?



---

archive/issue_comments_352634.json:
```json
{
    "body": "Replying to [comment:33 gh-timokau]:\n> `@`jdemeyer do you think that fix is acceptable?\n\n\nOf course not. As I mentioned on the mailing list, I don't like \"fixing\" doctests. That's just hiding the problem.",
    "created_at": "2018-06-30T16:49:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352634",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:33 gh-timokau]:
> `@`jdemeyer do you think that fix is acceptable?


Of course not. As I mentioned on the mailing list, I don't like "fixing" doctests. That's just hiding the problem.



---

archive/issue_comments_352635.json:
```json
{
    "body": "Considering what is causing this issue (backports.shutil_get_terminal size failing to do the one thing it is supposed to do), I now agree that the patch should be applied. I will propose it for inclusion in nix.\n\nI still think that the sage doctests shouldn't fail because of this. The \"problem\" here is not essential to sages functionality. But thats not my call so if you don't want any version of this ticket in sage feel free to close this. If you want this ticket resolved but in a different way, I'll gladly implement any suggestions.\n\nThanks again for reviewing!",
    "created_at": "2018-06-30T17:27:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352635",
    "user": "https://github.com/timokau"
}
```

Considering what is causing this issue (backports.shutil_get_terminal size failing to do the one thing it is supposed to do), I now agree that the patch should be applied. I will propose it for inclusion in nix.

I still think that the sage doctests shouldn't fail because of this. The "problem" here is not essential to sages functionality. But thats not my call so if you don't want any version of this ticket in sage feel free to close this. If you want this ticket resolved but in a different way, I'll gladly implement any suggestions.

Thanks again for reviewing!



---

archive/issue_comments_352636.json:
```json
{
    "body": "I won't actively oppose the patch on this ticket. If other people think it's OK, then I'm fine with it.\n\nPersonally, I think you should just add this patch to the sagemath in your distribution.",
    "created_at": "2018-07-01T07:37:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352636",
    "user": "https://github.com/jdemeyer"
}
```

I won't actively oppose the patch on this ticket. If other people think it's OK, then I'm fine with it.

Personally, I think you should just add this patch to the sagemath in your distribution.



---

archive/issue_comments_352637.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-07-03T15:38:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352637",
    "user": "https://github.com/saraedum"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_352638.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-07-08T13:05:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352638",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_063481.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2018-07-08T13:05:27Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25083#event-63481"
}
```



---

archive/issue_comments_352639.json:
```json
{
    "body": "This is not working for me on Arch: the test is still failing (with unpatched shutil_get_terminal_size)",
    "created_at": "2018-10-28T09:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352639",
    "user": "https://github.com/antonio-rojas"
}
```

This is not working for me on Arch: the test is still failing (with unpatched shutil_get_terminal_size)



---

archive/issue_comments_352640.json:
```json
{
    "body": "Should have reacted earlier, but yes the final version of that ticket didn't fix everything.\n\n```\nsage -t --long /usr/lib64/python2.7/site-packages/sage/repl/interpreter.py\n**********************************************************************\nFile \"/usr/lib64/python2.7/site-packages/sage/repl/interpreter.py\", line 77, in sage.repl.interpreter\nFailed example:\n    print(\"dummy line\"); shell.run_cell('1/0') # see #25320 for the reason of the `...` and the dummy line in this test\nExpected:\n    dummy line\n    ...\n    ZeroDivisionError...Traceback (most recent call last)\n    <ipython-input-...> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    .../sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()\n       ...        if type(left) is type(right):\n       ...            if mpz_sgn((<Integer>right).value) == 0:\n    -> ...                  raise ZeroDivisionError(\"rational division by zero\")\n       ...            x = <Rational> Rational.__new__(Rational)\n       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\nGot:\n    dummy line\n    <BLANKLINE>\n    ZeroDivisionErrorTraceback (most recent call last)\n    <ipython-input-1-72ac74c5f414> in <module>()\n    ----> 1 Integer(1)/Integer(0)\n    <BLANKLINE>\n    /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:13336)()\n       1914         if type(left) is type(right):\n       1915             if mpz_sgn((<Integer>right).value) == 0:\n    -> 1916                 raise ZeroDivisionError(\"rational division by zero\")\n       1917             x = <Rational> Rational.__new__(Rational)\n       1918             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)\n    <BLANKLINE>\n    ZeroDivisionError: rational division by zero\n**********************************************************************\n```\nbut during development it was - at some point.",
    "created_at": "2018-10-28T09:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25083",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25083#issuecomment-352640",
    "user": "https://github.com/kiwifb"
}
```

Should have reacted earlier, but yes the final version of that ticket didn't fix everything.

```
sage -t --long /usr/lib64/python2.7/site-packages/sage/repl/interpreter.py
**********************************************************************
File "/usr/lib64/python2.7/site-packages/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    print("dummy line"); shell.run_cell('1/0') # see #25320 for the reason of the `...` and the dummy line in this test
Expected:
    dummy line
    ...
    ZeroDivisionError...Traceback (most recent call last)
    <ipython-input-...> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    .../sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()
       ...        if type(left) is type(right):
       ...            if mpz_sgn((<Integer>right).value) == 0:
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    dummy line
    <BLANKLINE>
    ZeroDivisionErrorTraceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /usr/lib64/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (/dev/shm/portage/sci-mathematics/sage-9999/work/sage-9999/src-python2_7/build/cythonized/sage/rings/integer.c:13336)()
       1914         if type(left) is type(right):
       1915             if mpz_sgn((<Integer>right).value) == 0:
    -> 1916                 raise ZeroDivisionError("rational division by zero")
       1917             x = <Rational> Rational.__new__(Rational)
       1918             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
```
but during development it was - at some point.
