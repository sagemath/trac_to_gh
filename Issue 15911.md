# Issue 15911: Really enable cython caching

archive/issues_015911.json:
```json
{
    "body": "CC:  robertwb vbraun\n\nIn order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16148\n\n",
    "created_at": "2014-04-12T11:19:28Z",
    "labels": [
        "build",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Really enable cython caching",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15911",
    "user": "jdemeyer"
}
```
CC:  robertwb vbraun

In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.

Issue created by migration from https://trac.sagemath.org/ticket/16148





---

archive/issue_comments_206691.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-04-12T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206691",
    "user": "jdemeyer"
}
```

New commits:



---

archive/issue_comments_206692.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-04-12T11:59:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206692",
    "user": "jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_206693.json:
```json
{
    "body": "The cycache fix looks good to me.\n\nI don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order. If they are printed to stderr then unbuffered stdout is wrong, it should be line buffered to avoid half-written lines.",
    "created_at": "2014-04-13T13:54:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206693",
    "user": "vbraun"
}
```

The cycache fix looks good to me.

I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order. If they are printed to stderr then unbuffered stdout is wrong, it should be line buffered to avoid half-written lines.



---

archive/issue_comments_206694.json:
```json
{
    "body": "Replying to [comment:3 vbraun]:\n> I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order.\nCython mixes print statements with shell commands. Usually, if you do\n\n```\nprint \"Python message\"\nos.system(\"echo hello\")\n```\n\nthen the \"hello\" will usually be output before the \"Python message\" if output is not to a terminal (output to a terminal is unbuffered by default).",
    "created_at": "2014-04-13T15:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206694",
    "user": "jdemeyer"
}
```

Replying to [comment:3 vbraun]:
> I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order.
Cython mixes print statements with shell commands. Usually, if you do

```
print "Python message"
os.system("echo hello")
```

then the "hello" will usually be output before the "Python message" if output is not to a terminal (output to a terminal is unbuffered by default).



---

archive/issue_comments_206695.json:
```json
{
    "body": "Ok, I see we are using `os.system` to launch. Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level. Though the lower-level libc buffering is line buffered by default and that probably saves us.",
    "created_at": "2014-04-13T19:43:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206695",
    "user": "vbraun"
}
```

Ok, I see we are using `os.system` to launch. Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level. Though the lower-level libc buffering is line buffered by default and that probably saves us.



---

archive/issue_comments_206696.json:
```json
{
    "body": "Replying to [comment:6 vbraun]:\n> Ok, I see we are using `os.system` to launch.\nWhere \"we\" is also Cython, not just Sage.\n\n> Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level.\nHow could unbuffered mode lead to truncated lines?\n\n> Though the lower-level libc buffering is line buffered by default and that probably saves us.\nI think it's the same level, Python doesn't do it own buffering.",
    "created_at": "2014-04-14T06:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206696",
    "user": "jdemeyer"
}
```

Replying to [comment:6 vbraun]:
> Ok, I see we are using `os.system` to launch.
Where "we" is also Cython, not just Sage.

> Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level.
How could unbuffered mode lead to truncated lines?

> Though the lower-level libc buffering is line buffered by default and that probably saves us.
I think it's the same level, Python doesn't do it own buffering.



---

archive/issue_comments_206697.json:
```json
{
    "body": "Replying to jdemeyer:\n\n> How could unbuffered mode lead to truncated lines?\nNot truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\\n222\\n` vs. `111111111\\n2222222\\n`\n\n> Python doesn't do it own buffering.\nTo be precise, it did until your patch turned it off. But `os.fdopen(,,0)` does not call libc setvbuf.",
    "created_at": "2014-04-14T08:49:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206697",
    "user": "vbraun"
}
```

Replying to jdemeyer:

> How could unbuffered mode lead to truncated lines?
Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\n222\n` vs. `111111111\n2222222\n`

> Python doesn't do it own buffering.
To be precise, it did until your patch turned it off. But `os.fdopen(,,0)` does not call libc setvbuf.



---

archive/issue_comments_206698.json:
```json
{
    "body": "Replying to [comment:8 vbraun]:\n> But `os.fdopen(,,0)` does not call libc setvbuf.\nI admit I have not read Python's sources, but why do you think so?",
    "created_at": "2014-04-14T12:42:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206698",
    "user": "jdemeyer"
}
```

Replying to [comment:8 vbraun]:
> But `os.fdopen(,,0)` does not call libc setvbuf.
I admit I have not read Python's sources, but why do you think so?



---

archive/issue_comments_206699.json:
```json
{
    "body": "Replying to [comment:8 vbraun]:\n> Replying to jdemeyer:\n> \n> > How could unbuffered mode lead to truncated lines?\n> Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\\n222\\n` vs. `111111111\\n2222222\\n`\nThat can happen with or without buffering. This is an OS-level issue, which libc's buffering doesn't solve.",
    "created_at": "2014-04-14T12:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206699",
    "user": "jdemeyer"
}
```

Replying to [comment:8 vbraun]:
> Replying to jdemeyer:
> 
> > How could unbuffered mode lead to truncated lines?
> Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\n222\n` vs. `111111111\n2222222\n`
That can happen with or without buffering. This is an OS-level issue, which libc's buffering doesn't solve.



---

archive/issue_comments_206700.json:
```json
{
    "body": "Ok, `os.fdopen` does call `setvbuf`. Cool.",
    "created_at": "2014-04-14T13:07:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206700",
    "user": "vbraun"
}
```

Ok, `os.fdopen` does call `setvbuf`. Cool.



---

archive/issue_comments_206701.json:
```json
{
    "body": "Replying to [comment:11 vbraun]:\n> Ok, `os.fdopen` does call `setvbuf`. Cool.\nSide comment: this is something which changed in Python 3, where the libc FILE I/O is no longer used.",
    "created_at": "2014-04-15T09:53:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206701",
    "user": "jdemeyer"
}
```

Replying to [comment:11 vbraun]:
> Ok, `os.fdopen` does call `setvbuf`. Cool.
Side comment: this is something which changed in Python 3, where the libc FILE I/O is no longer used.



---

archive/issue_comments_206702.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-04-15T23:19:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206702",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_206703.json:
```json
{
    "body": "Replying to [ticket:16148 jdemeyer]:\n> this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`)\n\n\\o/  Thank you very much, it has been annoying me for years.",
    "created_at": "2014-04-27T09:17:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206703",
    "user": "leif"
}
```

Replying to [ticket:16148 jdemeyer]:
> this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`)

\o/  Thank you very much, it has been annoying me for years.



---

archive/issue_comments_206704.json:
```json
{
    "body": "\n```\nCython.Compiler.Main.default_options['cache'] = True\n```\n\nis probably the wrong thing; it should be passed in `options` to `cythonize()`.\n\nBut essentially `cythonize()` appears to be broken w.r.t. this, since it does:\n\n```python\n    ...\n    c_options = CompilationOptions(**options)\n    ...\n    options = c_options    \n    ...\n    if hasattr(options, 'cache'):\n        if not os.path.exists(options.cache):\n            os.makedirs(options.cache)\n```\n\nand one may end up with\n\n```\nFile \"/scratch/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py\", line 739, in cythonize\nif not os.path.exists(options.cache):\nFile \"/scratch/sage/local/lib/python/genericpath.py\", line 18, in exists\nos.stat(path)\nTypeError: coercing to Unicode: need string or buffer, bool found\n```\n\nas reported on sage-devel.",
    "created_at": "2014-05-02T14:32:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206704",
    "user": "leif"
}
```


```
Cython.Compiler.Main.default_options['cache'] = True
```

is probably the wrong thing; it should be passed in `options` to `cythonize()`.

But essentially `cythonize()` appears to be broken w.r.t. this, since it does:

```python
    ...
    c_options = CompilationOptions(**options)
    ...
    options = c_options    
    ...
    if hasattr(options, 'cache'):
        if not os.path.exists(options.cache):
            os.makedirs(options.cache)
```

and one may end up with

```
File "/scratch/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 739, in cythonize
if not os.path.exists(options.cache):
File "/scratch/sage/local/lib/python/genericpath.py", line 18, in exists
os.stat(path)
TypeError: coercing to Unicode: need string or buffer, bool found
```

as reported on sage-devel.



---

archive/issue_comments_206705.json:
```json
{
    "body": "Is it possible that cython caching is broken again? At least it does not work for me anymore (i.e., when switching back and forth between branches I do not see a speedup.) Do I have to do anything (create cache directories?) to make it work or should it work out of the box?",
    "created_at": "2015-08-15T18:34:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206705",
    "user": "saraedum"
}
```

Is it possible that cython caching is broken again? At least it does not work for me anymore (i.e., when switching back and forth between branches I do not see a speedup.) Do I have to do anything (create cache directories?) to make it work or should it work out of the box?



---

archive/issue_comments_206706.json:
```json
{
    "body": "See #17851",
    "created_at": "2015-08-15T18:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15911",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15911#issuecomment-206706",
    "user": "vbraun"
}
```

See #17851
