# Issue 15911: Really enable cython caching

Issue created by migration from https://trac.sagemath.org/ticket/16148

Original creator: jdemeyer

Original creation time: 2014-04-12 11:19:28

CC:  robertwb vbraun

In order to speed up Cythonization, we should use a cache. Ticket #15430 tried to make this the default, but due to some bug, it never actually worked.


---

Comment by jdemeyer created at 2014-04-12 11:59:38

New commits:


---

Comment by jdemeyer created at 2014-04-12 11:59:38

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-04-13 13:54:41

The cycache fix looks good to me.

I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order. If they are printed to stderr then unbuffered stdout is wrong, it should be line buffered to avoid half-written lines.


---

Comment by jdemeyer created at 2014-04-13 15:22:21

Replying to [comment:3 vbraun]:
> I don't understand your comment about order, if cython messages are printed to stdout then flushing stdout does not change their order.
Cython mixes print statements with shell commands. Usually, if you do

```
print "Python message"
os.system("echo hello")
```

then the "hello" will usually be output before the "Python message" if output is not to a terminal (output to a terminal is unbuffered by default).


---

Comment by vbraun created at 2014-04-13 19:43:51

Ok, I see we are using `os.system` to launch. Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level. Though the lower-level libc buffering is line buffered by default and that probably saves us.


---

Comment by jdemeyer created at 2014-04-14 06:38:16

Replying to [comment:6 vbraun]:
> Ok, I see we are using `os.system` to launch.
Where "we" is also Cython, not just Sage.

> Still, we should be using line buffering and not unbuffered mode to avoid truncated lines on the Python stream level.
How could unbuffered mode lead to truncated lines?

> Though the lower-level libc buffering is line buffered by default and that probably saves us.
I think it's the same level, Python doesn't do it own buffering.


---

Comment by vbraun created at 2014-04-14 08:49:02

Replying to jdemeyer:

> How could unbuffered mode lead to truncated lines?
Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\n222\n` vs. `111111111\n2222222\n`

> Python doesn't do it own buffering.
To be precise, it did until your patch turned it off. But `os.fdopen(,,0)` does not call libc setvbuf.


---

Comment by jdemeyer created at 2014-04-14 12:42:54

Replying to [comment:8 vbraun]:
> But `os.fdopen(,,0)` does not call libc setvbuf.
I admit I have not read Python's sources, but why do you think so?


---

Comment by jdemeyer created at 2014-04-14 12:53:00

Replying to [comment:8 vbraun]:
> Replying to jdemeyer:
> 
> > How could unbuffered mode lead to truncated lines?
> Not truncated, but different processe's output would not necessarily be separated by newlines `1111222222111111\n222\n` vs. `111111111\n2222222\n`
That can happen with or without buffering. This is an OS-level issue, which libc's buffering doesn't solve.


---

Comment by vbraun created at 2014-04-14 13:07:23

Ok, `os.fdopen` does call `setvbuf`. Cool.


---

Comment by jdemeyer created at 2014-04-15 09:53:28

Replying to [comment:11 vbraun]:
> Ok, `os.fdopen` does call `setvbuf`. Cool.
Side comment: this is something which changed in Python 3, where the libc FILE I/O is no longer used.


---

Comment by vbraun created at 2014-04-15 23:19:42

Resolution: fixed


---

Comment by leif created at 2014-04-27 09:17:40

Replying to [ticket:16148 jdemeyer]:
> this ticket also fixes the silly precision in timing output (`time = 2.35585808754 seconds`)

\o/  Thank you very much, it has been annoying me for years.


---

Comment by leif created at 2014-05-02 14:32:23


```
Cython.Compiler.Main.default_options['cache'] = True
```

is probably the wrong thing; it should be passed in `options` to `cythonize()`.

But essentially `cythonize()` appears to be broken w.r.t. this, since it does:

```python
    ...
    c_options = CompilationOptions(**options)
    ...
    options = c_options    
    ...
    if hasattr(options, 'cache'):
        if not os.path.exists(options.cache):
            os.makedirs(options.cache)
```

and one may end up with

```
File "/scratch/sage/local/lib/python2.7/site-packages/Cython/Build/Dependencies.py", line 739, in cythonize
if not os.path.exists(options.cache):
File "/scratch/sage/local/lib/python/genericpath.py", line 18, in exists
os.stat(path)
TypeError: coercing to Unicode: need string or buffer, bool found
```

as reported on sage-devel.


---

Comment by saraedum created at 2015-08-15 18:34:43

Is it possible that cython caching is broken again? At least it does not work for me anymore (i.e., when switching back and forth between branches I do not see a speedup.) Do I have to do anything (create cache directories?) to make it work or should it work out of the box?


---

Comment by vbraun created at 2015-08-15 18:43:19

See #17851
