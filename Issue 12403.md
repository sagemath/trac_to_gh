# Issue 12403: Generic p-adic log and exp

Issue created by migration from https://trac.sagemath.org/ticket/12575

Original creator: mmasdeu

Original creation time: 2012-02-23 18:24:29

Assignee: roed

CC:  roed

Keywords: exp, log, padic

Here is a patch which seems to fix a number of problems with the p-adic logarithm and exponential.

They are generic functions that should work with all of current p-adic types.

We get run times about x20/x80 faster than the current implementation (in the cases where the current implementation worked).


---

Comment by was created at 2012-02-23 19:43:01

This code breaks stuff elsewhere, e.g., when p=2.  See this traceback I got by running "sage -t":

```
sage -t  devel/sage/sage/rings/finite_rings/integer_mod.pyx
**********************************************************************
File "/mnt/usb1/scratch/wstein/sage-5.0.beta2-sage.math.washington.edu-x86_64-Linux/devel/sage-main/sage/rings/finite_rings/integer_mod.pyx", line 1043:
    sage: mod(225,2^5*3^2).nth_root(4, all=True)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/usb1/scratch/wstein/sage-5.0.beta2-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py", line 1231, in run_one_test
        self.run_one_example(test, example, filename, compileflags)
      File "/mnt/usb1/scratch/wstein/sage-5.0.beta2-sage.math.washington.edu-x86_64-Linux/local/bin/sagedoctest.py", line 38, in run_one_example
        OrigDocTestRunner.run_one_example(self, test, example, filename, compileflags)
      File "/mnt/usb1/scratch/wstein/sage-5.0.beta2-sage.math.washington.edu-x86_64-Linux/local/bin/ncadoctest.py", line 1172, in run_one_example
        compileflags, 1) in test.globs
      File "<doctest __main__.example_26[7]>", line 1, in <module>
        mod(Integer(225),Integer(2)**Integer(5)*Integer(3)**Integer(2)).nth_root(Integer(4), all=True)###line 1043:
    sage: mod(225,2^5*3^2).nth_root(4, all=True)
      File "integer_mod.pyx", line 1121, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.nth_root (sage/rings/finite_rings/integer_mod.c:9981)
        L.append(mod(self, p**k).nth_root(n, all=True, algorithm=algorithm))
      File "integer_mod.pyx", line 1194, in sage.rings.finite_rings.integer_mod.IntegerMod_abstract.nth_root (sage/rings/finite_rings/integer_mod.c:11789)
        plog = R(self).log()
      File "padic_generic_element.pyx", line 1115, in sage.rings.padics.padic_generic_element.pAdicGenericElement.log (sage/rings/padics/padic_generic_element.c:8542)
      File "padic_generic_element.pyx", line 1138, in sage.rings.padics.padic_generic_element.pAdicGenericElement._log (sage/rings/padics/padic_generic_element.c:8827)
      File "element.pyx", line 1799, in sage.structure.element.RingElement.__div__ (sage/structure/element.c:13262)
      File "coerce.pyx", line 797, in sage.structure.coerce.CoercionModel_cache_maps.bin_op (sage/structure/coerce.c:7500)
    TypeError: unsupported operand parent(s) for '/': '2-adic Ring of fixed modulus 2^5' and 'Rational Field'
**********************************************************************
```



---

Comment by mmasdeu created at 2012-02-27 15:51:41

This time the even-nest prime is not to blame: the problem still came (as we discussed with David in SageDays36) from not being able to construct a parent of a p-adic with increased precision (in a generic way). This should be resolved when templates get implemented.

Meanwhile, I have tweaked it so that it works. It now passes all the tests in devel/sage/sage/rings.


---

Comment by mmasdeu created at 2012-02-27 15:53:13

Changing status from new to needs_review.


---

Comment by roed created at 2012-02-29 03:25:31

Changing type from PLEASE CHANGE to enhancement.


---

Comment by davidloeffler created at 2012-03-07 08:34:03

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2012-03-07 08:34:03

Applying this patch and building gives a Sphinx error message:

```
docstring of sage.rings.padics.padic_generic_element:1: ERROR: Unexpected indentation.
```



---

Attachment

Apply over previous patch


---

Comment by davidloeffler created at 2012-03-07 11:39:36

Apply trac_12575_exp_logs.patch, trac_12575_fix_docs.patch

(for the patchbot). 

The patch I've just uploaded corrects dozens of Sphinx formatting issues in `padic_generic_element`, so the documentation actually builds correctly and looks half right (neither of which were true before). But still this can't go in as is: the documentation of `_log` needs to explain what it actually does and how it relates to `log`; and some explanation of how the `prec` parameter is handled in _naive_shifted_log is needed -- the code does some calculations with the prec argument that were not at all obvious to me. So we need a third patch (on top of the two that are already here).


---

Comment by mmasdeu created at 2012-03-13 02:28:40

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2012-03-13 02:28:40

I addressed the issues you raised. The _naive_shifted_log() has been renamed to _shifted_log(), I think that it is better. Also I have eliminated the _log() function since at the end of the developing it had become too short. I included that code in the log() itself. All is included in one patch.


---

Comment by davidloeffler created at 2012-03-13 08:44:04

There is still work to be done here. The `log` and `_shifted_log` methods take a "prec" argument, but the docstring does not explain anything about this: in particular, whether it is to be interpreted as an absolute or relative precision (absolute, I presume?), how it is normalized when the extension is ramified, and how it interacts with the absolute/relative prec of self and the precision settings of self.parent. There also need to be doctests that test the functions being used with different values of this argument.


---

Comment by davidloeffler created at 2012-03-13 08:44:04

Changing status from needs_review to needs_work.


---

Comment by mmasdeu created at 2012-03-13 15:58:27

I have added some doctests and documentation as suggested.


---

Comment by mmasdeu created at 2012-03-13 15:58:27

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2012-03-14 10:08:23

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2012-03-14 10:08:23

This patch doesn't apply. It looks like you might have done a new patch to be applied *on top of* the old patch, but accidentally overwritten the old patch when you uploaded it -- the new [attachment:trac_12575_exp_logs.patch] consists entirely of docstring fixes.


---

Comment by mmasdeu created at 2012-03-20 20:06:46

OK, I messed up (and I blame for it (my inexperience with ?) mercurial queues). After some manual cherry picking I got a patch that can be applied against 5.0beta8 and passes the tests. I might have messed some of the doc formatting, if you spot any regression let me know and I'll fix it.

I will the previous (completely broken) patch with a (presumably working, now) new one.

Replying to [comment:10 davidloeffler]:
> This patch doesn't apply. It looks like you might have done a new patch to be applied *on top of* the old patch, but accidentally overwritten the old patch when you uploaded it -- the new [attachment:trac_12575_exp_logs.patch] consists entirely of docstring fixes.


---

Comment by mmasdeu created at 2012-03-20 20:06:46

Changing status from needs_work to needs_review.


---

Comment by mmasdeu created at 2012-03-20 20:07:42

Apply this patch only


---

Attachment


---

Comment by roed created at 2012-03-21 06:57:58

Changing priority from minor to major.


---

Comment by kedlaya created at 2012-03-29 17:56:23

Patchbot says doctests now pass, but there is still a "plugin failed" error. I learned from roed what this usually means, and indeed in the shortlog one finds:

```
Ticket number not in first line of comments: trac_12575_exp_logs.patch
```

Fix this and presumably a positive review will follow!


---

Comment by davidloeffler created at 2012-03-29 18:01:55

The problem is not the ticket number but trailing whitespace on code lines (which the patchbot seems to dislike, for some reason).

```
========== plugins.trailing_whitespace ==========
trac_12575_exp_logs.patch
    trac_12575_exp_logs.patch:993 +    $
    trac_12575_exp_logs.patch:996 +    $
    trac_12575_exp_logs.patch:999 +    $
    trac_12575_exp_logs.patch:1003 +    $
    trac_12575_exp_logs.patch:1006 +    $
    trac_12575_exp_logs.patch:1009 +    $
    trac_12575_exp_logs.patch:1014 +    $
    trac_12575_exp_logs.patch:1020 +    $
    trac_12575_exp_logs.patch:1026 +    $
    trac_12575_exp_logs.patch:1031 +    $
    trac_12575_exp_logs.patch:1034 +    $
    trac_12575_exp_logs.patch:1037 +    $
    trac_12575_exp_logs.patch:1041 +    $
    trac_12575_exp_logs.patch:1044 +    $
    trac_12575_exp_logs.patch:1047 +    $
    trac_12575_exp_logs.patch:1056 +    $
    trac_12575_exp_logs.patch:1070 +    $
    trac_12575_exp_logs.patch:1088 +    $
    trac_12575_exp_logs.patch:1103 +    $
    trac_12575_exp_logs.patch:1104 +    $
    trac_12575_exp_logs.patch:1112 +    $
    trac_12575_exp_logs.patch:1120 +    $
    trac_12575_exp_logs.patch:1127 +    $
    trac_12575_exp_logs.patch:1130 +    $
    trac_12575_exp_logs.patch:1139 +    $
    trac_12575_exp_logs.patch:1261 +        integer -- the additive order of self          $
    trac_12575_exp_logs.patch:1429 +        $
    trac_12575_exp_logs.patch:1496 +        r""" $
Trailing whitespace inserted on 2 non-empty lines.
Traceback (most recent call last):
  File "/storage/masiao/sage-5.0.beta10-patchbot/local/bin/patchbot/patchbot.py", line 276, in test_a_ticket
    plugin(ticket, **kwds)
  File "/storage/masiao/sage-5.0.beta10-patchbot/local/bin/patchbot/plugins.py", line 49, in trailing_whitespace
    raise ValueError(msg)
ValueError: Trailing whitespace inserted on 2 non-empty lines.
plugins.trailing_whitespace -- 0 seconds
========== end plugins.trailing_whitespace ==========
```



---

Comment by davidloeffler created at 2012-03-29 18:08:36

mmasdeu's patch, but with whitespace removed


---

Attachment

Apply trac_12575_exp_logs-nowhitespace.patch

(for patchbot)


---

Comment by mmasdeu created at 2012-09-09 23:10:06

I have modified the patch so that it works with the newer versions (the method is_unit() got changed into is_padic_unit() and that prevented the patch from apply seamelessly).

Please could someone review it? I have been using this functionality for the past six months and it works fine. They are useful functions to have and the review should be very quick...


---

Comment by syazdani created at 2013-02-02 03:55:45

fixes log and exp.


---

Attachment

Added doctest for add_bigoh. Fixed some precision issues in _shifted_log.


---

Comment by saraedum created at 2013-02-13 17:36:23

Changing assignee from roed to saraedum.


---

Attachment

I'm working on a review patch for this ticket.


---

Attachment

fixes several issues, added docstrings


---

Comment by saraedum created at 2013-02-14 02:13:29

Remove assignee saraedum.


---

Comment by saraedum created at 2013-02-14 02:13:29

I found several issues. I added a patch which should fix them:

* log sometimes didn't work in the capped-absolute case (especially over extension fields)
* the bound `max_term` in `_exp` was incorrect which made `exp` and `log` not inverse to each other in some cases
* the capped-absolute/fixed-mod implementation of `exp` somehow didn't get some of the digits right (I tried to find out why, but couldn't figure it out). I rewrote `_exp` which is now shorter and works in the cases that didn't work before. In particular it doesn't lift the input to the integers anymore. Is there a reason why we should work over the integers?
* I believe that the check for convergence of the exponential series was incorrect.

Apart from that, I tried to simplify the code in a few places and turned the cached values into actual `cached_methods` -- if someone dislikes that latter change, I don't mind undoing it.


---

Comment by roed created at 2013-03-17 02:35:12

Rebased against #13299


---

Attachment


---

Attachment

apply trac_12575_exp_logs-nowhitespace.2.patch trac_12575_log_fix.patch trac_12575_doctest.patch trac_12575_review.patch 12575_review_review.patch


---

Attachment

Can get a positive review if my last review patch is ok.


---

Comment by saraedum created at 2013-03-18 22:17:04

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-03-22 12:21:21

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-03-22 12:21:21

You should never use

```
except:
```


*Always* "except" specific exceptions, or if you really need to, catch

```
except StandardError:
```

which in particular does not catch `KeyboardInterrupt`.


---

Comment by saraedum created at 2013-03-22 18:43:01

Changing status from needs_work to positive_review.


---

Comment by saraedum created at 2013-03-22 18:43:01

We probably should have commented on that. Notice that subsequent patches rewrite most code from the early patches. In particular, the `except:` is removed in the second patch.


---

Comment by jdemeyer created at 2013-03-26 22:30:07

Resolution: fixed
