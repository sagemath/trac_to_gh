# Issue 19972: Failing conversion QQbar -> RIF

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2016-03-14 20:29:44

On sage-6.7.rc1 the following fails

```
sage: a = QQbar(2).sqrt()
sage: RIF(a)
Traceback (most recent call last):
...
TypeError: unable to convert 1.4142135623730950488? to real interval
```



---

Comment by vdelecroix created at 2016-03-15 02:00:47

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2016-03-15 02:00:47

New commits:


---

Comment by git created at 2016-03-15 02:01:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2016-03-15 03:31:05

I think a better solution would be to do

```python
def interval(self, field):
    target = RR(1.0) >> field.prec()
    val = self.interval_diameter(target)
    from sage.rings.real_mpfi import RealIntervalField_class
    if isinstance(field, RealIntervalField_class) and self.imag().is_zero():
        val = self.real().interval_diameter(target)
    return field(val)
```

(I would probably even put the import at the namespace level too.) That way we do not generate the error and catch it, which is a slow operation compared to an `isinstance` check:

```
sage: def foo():
....:     try:
....:         raise ValueError
....:     except ValueError:
....:         pass    
sage: %timeit foo()
The slowest run took 22.94 times longer than the fastest. This could mean that an intermediate result is being cached.
1000000 loops, best of 3: 832 ns per loop
sage: def bar():
....:     return isinstance(RIF, type(RIF))
sage: %timeit bar()
The slowest run took 27.02 times longer than the fastest. This could mean that an intermediate result is being cached.
10000000 loops, best of 3: 185 ns per loop
```

(This test is also somewhat unfair to the `isinstance` check.) I could see this conversion being used in a tight loop in many computations. (We also loose about 20ns just for having that try-except block.)


---

Comment by jdemeyer created at 2016-03-15 07:15:11

Why not replace

```
val = self.real().interval_diameter(target)
```

by

```
val = val.real()
```



---

Comment by git created at 2016-03-15 13:49:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2016-03-15 13:50:28

Replying to [comment:3 tscrim]:
> I think a better solution would be to do
> [...]

The operation `self.imag().is_zero()` is potentially costly ("exactification"). But we can check it on the interval instead. This is what contains the last commit.
 
> (I would probably even put the import at the namespace level too.) That way we do not generate the error and catch it, which is a slow operation compared to an `isinstance` check:
> ...

Done.


---

Comment by tscrim created at 2016-03-15 14:47:58

LGTM modulo running tests. If the patchbot returns green, then you can set this to a positive review (unless Jeroen, you have any more comments).


---

Comment by tscrim created at 2016-03-15 15:38:00

One other thing, you're missing a colon before `trac` here: `Check that trac:`20209` is fixed::`


---

Comment by git created at 2016-03-15 17:02:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2016-03-15 23:10:16

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2016-03-15 23:10:16

Thanks.


---

Comment by vbraun created at 2016-03-17 20:44:36

Resolution: fixed
