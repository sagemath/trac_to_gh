# Issue 16140: back up environment on sage startup

Issue created by migration from https://trac.sagemath.org/ticket/16377

Original creator: rws

Original creation time: 2014-05-19 15:37:20

Keywords: shell, start, sandbox

The original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.


---

Comment by rws created at 2014-05-19 16:12:07

Changing status from new to needs_review.


---

Comment by rws created at 2014-05-19 16:12:07

New commits:


---

Comment by jhpalmieri created at 2014-05-19 16:42:59

You should never assume that the user can write to `SAGE_ROOT`.


---

Comment by rws created at 2014-05-19 16:50:21

Ah thanks, DOT_SAGE would be indeed better.


---

Comment by git created at 2014-05-20 08:43:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-05-22 14:54:22

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-05-22 14:54:22

There are several issues:
1. Re-entrancy: when running different Sage processes, the environment of only 1 will be kept.
2. Quoting: The textual output of `env` is not suitable, since `\n` characters in environment variables cannot be reconstructed correctly. Assuming you need this for Python, why not use Python to store the environment in a Python pickle for example?
3. Why did you copy the `DOT_SAGE` stuff to `src/bin/sage`? Why not simply store the environment inside `sage-env`?
4. Your code does not support `--nodotsage`.

And could you please state more precisely which problem this solves?


---

Comment by jdemeyer created at 2014-05-22 20:43:20

I can't say I understand completely what [https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw](https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw) talks about, but this ticket looks like the wrong solution for that problem.

The patchbot simply should not run/compile Sage in a different source tree from what the `SAGE_*` environment variables point to.

I don't want to say that this ticket is pointless, but it should not be used to fix the patchbot issue you're having.


---

Comment by jdemeyer created at 2014-05-22 20:46:21

To fix the patchbot issue, why not run the patchbot outside of the Sage environment, as an ordinary Python program?


---

Comment by rws created at 2014-05-23 08:35:55

Thanks for the insight. That appears indeed to be the right solution. So the documentation on http://patchbot.sagemath.org/ that wants the user to use `sage -patchbot` should be changed.


---

Comment by rws created at 2014-05-23 08:35:55

Changing status from needs_work to positive_review.


---

Comment by rws created at 2014-05-23 08:50:27

Consequently, a ticket is needed to remove the `-patchbot` argument to Sage.


---

Comment by vbraun created at 2014-05-23 11:34:00

The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the "Source sage-env" step, so it is done before the environment is changed. In another ticket, please ;-)


---

Comment by vbraun created at 2014-05-23 11:34:14

Resolution: invalid


---

Comment by rws created at 2014-05-24 07:00:37

Replying to [comment:12 vbraun]:
> The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the "Source sage-env" step, so it is done before the environment is changed. In another ticket, please ;-)

This is now #16390
