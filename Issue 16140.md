# Issue 16140: back up environment on sage startup

archive/issues_016140.json:
```json
{
    "body": "Keywords: shell, start, sandbox\n\nThe original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.\n\nIssue created by migration from https://trac.sagemath.org/ticket/16377\n\n",
    "created_at": "2014-05-19T15:37:20Z",
    "labels": [
        "component: scripts"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-duplicate/invalid/wontfix",
    "title": "back up environment on sage startup",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/16140",
    "user": "https://github.com/rwst"
}
```
Keywords: shell, start, sandbox

The original environment unclobbered by Sage might be needed by subprocesses (e.g. patchbot) so just save it somewhere at the very start.

Issue created by migration from https://trac.sagemath.org/ticket/16377





---

archive/issue_comments_210440.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-05-19T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210440",
    "user": "https://github.com/rwst"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_210441.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-05-19T16:12:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210441",
    "user": "https://github.com/rwst"
}
```

New commits:



---

archive/issue_comments_210442.json:
```json
{
    "body": "You should never assume that the user can write to `SAGE_ROOT`.",
    "created_at": "2014-05-19T16:42:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210442",
    "user": "https://github.com/jhpalmieri"
}
```

You should never assume that the user can write to `SAGE_ROOT`.



---

archive/issue_comments_210443.json:
```json
{
    "body": "Ah thanks, DOT_SAGE would be indeed better.",
    "created_at": "2014-05-19T16:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210443",
    "user": "https://github.com/rwst"
}
```

Ah thanks, DOT_SAGE would be indeed better.



---

archive/issue_comments_210444.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2014-05-20T08:43:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210444",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_210445.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-05-22T14:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210445",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_210446.json:
```json
{
    "body": "There are several issues:\n1. Re-entrancy: when running different Sage processes, the environment of only 1 will be kept.\n2. Quoting: The textual output of `env` is not suitable, since `\\n` characters in environment variables cannot be reconstructed correctly. Assuming you need this for Python, why not use Python to store the environment in a Python pickle for example?\n3. Why did you copy the `DOT_SAGE` stuff to `src/bin/sage`? Why not simply store the environment inside `sage-env`?\n4. Your code does not support `--nodotsage`.\n\nAnd could you please state more precisely which problem this solves?",
    "created_at": "2014-05-22T14:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210446",
    "user": "https://github.com/jdemeyer"
}
```

There are several issues:
1. Re-entrancy: when running different Sage processes, the environment of only 1 will be kept.
2. Quoting: The textual output of `env` is not suitable, since `\n` characters in environment variables cannot be reconstructed correctly. Assuming you need this for Python, why not use Python to store the environment in a Python pickle for example?
3. Why did you copy the `DOT_SAGE` stuff to `src/bin/sage`? Why not simply store the environment inside `sage-env`?
4. Your code does not support `--nodotsage`.

And could you please state more precisely which problem this solves?



---

archive/issue_comments_210447.json:
```json
{
    "body": "I can't say I understand completely what [https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw](https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw) talks about, but this ticket looks like the wrong solution for that problem.\n\nThe patchbot simply should not run/compile Sage in a different source tree from what the `SAGE_*` environment variables point to.\n\nI don't want to say that this ticket is pointless, but it should not be used to fix the patchbot issue you're having.",
    "created_at": "2014-05-22T20:43:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210447",
    "user": "https://github.com/jdemeyer"
}
```

I can't say I understand completely what [https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw](https://groups.google.com/forum/?hl=en#!topic/sage-devel/1dpr0__-ssw) talks about, but this ticket looks like the wrong solution for that problem.

The patchbot simply should not run/compile Sage in a different source tree from what the `SAGE_*` environment variables point to.

I don't want to say that this ticket is pointless, but it should not be used to fix the patchbot issue you're having.



---

archive/issue_comments_210448.json:
```json
{
    "body": "To fix the patchbot issue, why not run the patchbot outside of the Sage environment, as an ordinary Python program?",
    "created_at": "2014-05-22T20:46:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210448",
    "user": "https://github.com/jdemeyer"
}
```

To fix the patchbot issue, why not run the patchbot outside of the Sage environment, as an ordinary Python program?



---

archive/issue_comments_210449.json:
```json
{
    "body": "Thanks for the insight. That appears indeed to be the right solution. So the documentation on http://patchbot.sagemath.org/ that wants the user to use `sage -patchbot` should be changed.",
    "created_at": "2014-05-23T08:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210449",
    "user": "https://github.com/rwst"
}
```

Thanks for the insight. That appears indeed to be the right solution. So the documentation on http://patchbot.sagemath.org/ that wants the user to use `sage -patchbot` should be changed.



---

archive/issue_comments_210450.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2014-05-23T08:35:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210450",
    "user": "https://github.com/rwst"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_210451.json:
```json
{
    "body": "Consequently, a ticket is needed to remove the `-patchbot` argument to Sage.",
    "created_at": "2014-05-23T08:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210451",
    "user": "https://github.com/rwst"
}
```

Consequently, a ticket is needed to remove the `-patchbot` argument to Sage.



---

archive/issue_comments_210452.json:
```json
{
    "body": "The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the \"Source sage-env\" step, so it is done before the environment is changed. In another ticket, please ;-)",
    "created_at": "2014-05-23T11:34:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210452",
    "user": "https://github.com/vbraun"
}
```

The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the "Source sage-env" step, so it is done before the environment is changed. In another ticket, please ;-)



---

archive/issue_comments_210453.json:
```json
{
    "body": "Resolution: invalid",
    "created_at": "2014-05-23T11:34:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210453",
    "user": "https://github.com/vbraun"
}
```

Resolution: invalid



---

archive/issue_events_015695.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2014-05-23T11:34:14Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/16140#event-15695"
}
```



---

archive/issue_comments_210454.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the \"Source sage-env\" step, so it is done before the environment is changed. In another ticket, please ;-)\n\nThis is now #16390",
    "created_at": "2014-05-24T07:00:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/16140",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/16140#issuecomment-210454",
    "user": "https://github.com/rwst"
}
```

Replying to [comment:12 vbraun]:
> The handling of the `-patchbot` switch in `src/bin/sage` needs to be moved above the "Source sage-env" step, so it is done before the environment is changed. In another ticket, please ;-)

This is now #16390
