# Issue 29079: Require ./configure before make

Issue created by migration from https://trac.sagemath.org/ticket/29316

Original creator: mkoeppe

Original creation time: 2020-03-11 18:47:25

CC:  dimpase vbraun jhpalmieri

With #27351, `configure` suggests a list of system packages to install.
The printed messages are easy to miss if users rely on `make` to invoke `configure`.

In this ticket, we make it an error to invoke `make` on an un-`configure`d source tree.


---

Comment by jhpalmieri created at 2020-04-18 20:55:09

I just started a discussion about this on sage-devel. This ticket could be expanded, or could be part of a family of tickets, which move all calls to `./configure` out of `Makefile`. Then this would solve #29310 and maybe some other tickets with `./configure` running too frequently.


---

Comment by nbruin created at 2020-04-18 21:13:51

Ah, ok. Now I see there's actually a rationale for having it an error to run make without configure because you WANT it to be a manual process. It remains that there are plenty of sub-configures run by sage's make anyway.


---

Comment by dimpase created at 2020-04-19 01:18:05

Replying to [comment:3 nbruin]:
> Ah, ok. Now I see there's actually a rationale for having it an error to run make without configure because you WANT it to be a manual process. It remains that there are plenty of sub-configures run by sage's make anyway.

sub-configures prepare other makefiles, not the main makefile, so this is not recursive, as opposed to what we have at the top level now, where we basically run `make && ./configure` in a loop until we reach a stable point, from which we can `make`.  
----
New commits:


---

Comment by dimpase created at 2020-04-19 14:50:17

I'd have left SAGE_PORT stuff in place.


---

Comment by mkoeppe created at 2020-04-19 14:55:23

SAGE_PORT does not work at all anyway because if configure exits with an error, all the required config files are not written!


---

Comment by mkoeppe created at 2020-04-19 14:59:39

If you prefer, we can push the SAGE_PORT removal to another ticket and merge in 9.1 already


---

Comment by dimpase created at 2020-04-19 15:49:08

OK, can we have it in 9.1?


---

Comment by dimpase created at 2020-04-19 15:49:08

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-04-19 15:54:40

I actually meant to merge the SAGE_PORT removal in 9.1
and "require ./configure before make" in 9.2.


---

Comment by dimpase created at 2020-04-19 16:01:39

any reason to delay "./configure before make" ?


---

Comment by jhpalmieri created at 2020-04-19 18:24:28

It's a change in how developers work, and I think it would be better to have a full beta cycle to test it and get people used to it.


---

Comment by mkoeppe created at 2020-04-19 18:37:22

I agree with John. I've created #29533 for SAGE_PORT.


---

Comment by mkoeppe created at 2020-04-19 18:45:06

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-04-21 00:44:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-04-21 00:45:31

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-04-22 17:52:29

It works with a fresh tarball, but I'm a little surprised that after `make distclean`, running `make` does not produce the error message. I guess `make distclean` doesn't delete `config.status`. Should it?


---

Comment by mkoeppe created at 2020-04-23 03:43:17

Replying to [comment:19 jhpalmieri]:
> I guess `make distclean` doesn't delete `config.status`. 

Yes, our `distclean` is non-standard in this regard. There is a target `bdist-clean` that deletes that extra file.

> Should it?

Hard to tell. I am not sure about the intended meaning of `misc-clean`, `bdist-clean`, `distclean`, `bootstrap-clean`, `maintainer-clean`, `fast-rebuild-clean`, as well as `micro_release`. Perhaps `@`vbraun could weigh in here.


---

Comment by dimpase created at 2020-04-23 15:07:44

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-04-23 15:07:44

It's a step in the right direction. Adjusting make targets is another story.


---

Comment by jhpalmieri created at 2020-04-23 21:44:05

I basically agree, but the last line in this passage from the top-level `README.md` must be changed:

```
The `configure` script itself, if it is not already built, can be generated by
running the `bootstrap` script (the latter requires _GNU autotools_ being installed).
The top-level `Makefile` also takes care of this automatically.
```

Maybe this whole section of `README.md` should be changed? I don't know if there are other parts of the documentation we also need to change.

I can certainly delete the line, but someone who knows autotools, configure files, etc., should really read this section and make any necessary changes.


---

Comment by jhpalmieri created at 2020-04-23 21:44:05

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2020-04-24 02:35:34

Another spot: in the installation guide it says

```
#. Optional:  Run the configure script to set some options that
   influence the build process.
```

(Item 6 at http://doc.sagemath.org/html/en/installation/source.html#step-by-step-installation-procedure.)

We can probably just delete the word "Optional" here.


---

Comment by git created at 2020-06-14 13:41:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-14 13:42:58

Replying to [comment:22 jhpalmieri]:
> the last line in this passage from the top-level `README.md` must be changed:
> {{{
> The `configure` script itself, if it is not already built, can be generated by
> running the `bootstrap` script (the latter requires _GNU autotools_ being installed).
> The top-level `Makefile` also takes care of this automatically.
> }}}
> Maybe this whole section of `README.md` should be changed? 

Done.


---

Comment by mkoeppe created at 2020-06-14 13:43:25

Replying to [comment:23 jhpalmieri]:
> Another spot: in the installation guide it says
> {{{
> #. Optional:  Run the configure script to set some options that
>    influence the build process.
> }}}
> (Item 6 at http://doc.sagemath.org/html/en/installation/source.html#step-by-step-installation-procedure.)
> 
> We can probably just delete the word "Optional" here.

Apparently this was already done by another ticket.


---

Comment by mkoeppe created at 2020-06-14 13:43:37

Changing status from needs_work to needs_review.


---

Comment by dimpase created at 2020-06-15 08:20:36

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-06-15 08:20:36

lgtm


---

Comment by mkoeppe created at 2020-06-15 15:33:51

Thank you!


---

Comment by vbraun created at 2020-06-22 22:34:22

Resolution: fixed
