# Issue 19441: Linking of Pynac to GMP

Issue created by migration from https://trac.sagemath.org/ticket/19678

Original creator: tscrim

Original creation time: 2015-12-07 19:08:50

Assignee: tscrim

CC:  gouezel jpflori rws

Keywords: pynac, linking

When building on Cygwin32, I get the following error:

```
.libs/libpynac_la-numeric.o: In function `ZN5GiNaC7numericD2Ev':
/home/Travis/sage/local/var/tmp/sage/build/pynac-0.5.2/src/ginac/numeric.cpp:621:
 undefined reference to `_imp____gmpq_clear'
```

This indicated to me there is a linking issue with Pynac to GMP. Full log is [here](http://trac.sagemath.org/attachment/ticket/19663/pynac-0.5.2.log) on #19663.


---

Comment by leif created at 2015-12-13 13:42:14

Note that this is unrelated to the change in #19606 (merged before #19312, which reverted it).


---

Comment by tscrim created at 2015-12-13 15:02:28

I was trying to build on Cygwin with 6.10.beta7, which contains both #19606 and #19312.


---

Comment by leif created at 2015-12-13 15:20:27

The `.pc` file also lacks `-lgmp`.


---

Comment by leif created at 2015-12-13 15:20:27

Changing keywords from "pynac, linking" to "pynac, underlinking".


---

Comment by leif created at 2015-12-13 15:57:00

FWIW, Pynac's `configure` doesn't check for libgmp, just for its header.

In GiNaC's Makefile we still have

```make
#The -no-undefined breaks Pynac on OS X 10.4.  See #9135
if CYGWIN
libpynac_la_LDFLAGS = -version-info $(LT_VERSION_INFO) -no-undefined
else
libpynac_la_LDFLAGS = -version-info $(LT_VERSION_INFO)
endif
```


though, so it must fail on Cygwin (unless we link to libgmp there).




The libtool versioning (0.0.0) IMHO doesn't make sense either.


---

Comment by gouezel created at 2015-12-13 19:12:05

Changing status from new to needs_review.


---

Comment by gouezel created at 2015-12-13 19:12:05

Added linking to gmp on Cygwin in the makefile. With this, compilation on cygwin works properly.
----
New commits:


---

Comment by leif created at 2015-12-13 19:59:24

Hmmm, do we want to link with GMP on Cygwin only?

It would have been sufficient to add `-lgmp` to `LIBS` in `configure`[`.ac`], either manually or by calling`AC_CHECK_LIB()` (but upstream should decide; not sure why they don't do this already).


---

Comment by gouezel created at 2015-12-13 20:24:15

I agree it is probably safe to link everywhere to GMP. I was scared by the comment `The -no-undefined breaks Pynac on OS X 10.4.  See #9135`, since it is also usually safe to add `no-undefined` everywhere. As I have no OS X to test, I opted for the safest solution. Anyway, I agree upstream should decide.


---

Comment by rws created at 2015-12-14 07:16:40

It's an oversight. I have opened https://github.com/pynac/pynac/issues/102. Thanks for the suggestions.


---

Comment by leif created at 2015-12-14 07:30:30

Replying to [comment:9 rws]:
> It's an oversight. I have opened https://github.com/pynac/pynac/issues/102. Thanks for the suggestions.

Should we wait for an upstream patch or merge as is?


---

Comment by rws created at 2015-12-14 07:36:13

Please don't wait. I'm in minimum maintenance mode (accept patches, do urgent releases).


---

Comment by leif created at 2015-12-14 07:49:50

I'd prefer to not just add it on Cygwin; on the other hand, the component is still (just) "Porting: Cygwin", and the current patch doesn't affect other systems (so doesn't need further testing on MacOS X, say).

Thoughts (by others than Ralph)?


---

Comment by jdemeyer created at 2015-12-14 09:01:56

Replying to [comment:12 leif]:
> the component is still (just) "Porting: Cygwin"

Fixed :-)


---

Comment by jdemeyer created at 2015-12-14 09:01:56

Changing component from porting: Cygwin to packages: standard.


---

Comment by gouezel created at 2015-12-18 08:44:23

New branch linking to gmp on all platforms, adding the proper test in configure.

The patch itself is one line

```
AC_CHECK_LIB(gmp, __gmpz_init, , AC_MSG_ERROR([This package needs libgmp]))
```

in `configure.ac` (this is the patch in `patches/build/`). The patch generated by autotools, however, is much bigger since my versions of the tools do not match with the versions previously used by pynac (my versions are more recent, so it should be for the better).
----
New commits:


---

Comment by jdemeyer created at 2015-12-18 09:30:05

The change to `configure.ac` looks sensible.

Is upstream (`@`rws) willing to make a new release for this? Then we don't need the patching.


---

Comment by leif created at 2015-12-18 09:36:49

Replying to [comment:15 gouezel]:
> New branch linking to gmp on all platforms, adding the proper test in configure.

Thanks.  If I had the time, I would have done the same in a pull request...

`@`jdemeyer:  Simply set upstream to "Fixed upstream, but not in a stable release". ;-)


---

Comment by leif created at 2015-12-18 09:40:55

P.S.:  Of course a patch using the same autotools versions is preferable.


---

Comment by fbissey created at 2015-12-18 09:46:59

I already submitted a PR upstream (two actually, the `.pc` was also sick) and they have been merged. Not sure when Ralph will want to do a release.


---

Comment by rws created at 2015-12-18 13:44:27

The search lib command is already merged. I'll add the `config.h.in` patch. Maybe I'll do a release at the weekend. Note that I do not have a means for testing it but you seem to have had success with these patches.


---

Comment by rws created at 2015-12-18 13:48:30

Ah that gets generated, so I can do the release today, as well.


---

Comment by rws created at 2015-12-18 14:43:41

Please test #19744 on Cygwin.


---

Comment by tscrim created at 2015-12-18 15:03:40

This has been superseded by #19744, correct?


---

Comment by rws created at 2015-12-18 15:20:05

Replying to [comment:23 tscrim]:
> This has been superseded by #19744, correct?
Yes, thanks.


---

Comment by tscrim created at 2015-12-18 15:31:38

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-12-18 18:43:35

Replying to [comment:20 rws]:
> The search lib command is already merged. I'll add the `config.h.in` patch. Maybe I'll do a release at the weekend. Note that I do not have a means for testing it but you seem to have had success with these patches.
That was not really useful but it doesn't hurt and is consistent with common practise I guess.


---

Comment by vbraun created at 2015-12-19 09:37:06

Resolution: fixed
