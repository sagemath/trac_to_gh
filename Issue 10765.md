# Issue 10765: Make python support SAGE_SPKG_INSTALL_DOCS

Issue created by migration from https://trac.sagemath.org/ticket/10831

Original creator: jason

Original creation time: 2011-02-23 02:43:33

Assignee: tbd

This is a bit tricky since we need sphinx and other things installed before we can build the docs, but sphinx and the other things depend on python.  To resolve this circular dependency, we try to import sphinx.  If we can't import sphinx, then we exit without error with a message that you should install sphinx and related tools first and then try building the docs again.  This means that in order to use the environment variable, you have to install the python spkg twice, since we don't have an option to just build docs without building python.  But maybe that's worth it for someone that just wants the python docs.


---

Comment by jason created at 2011-02-23 03:33:37

Changing status from new to needs_review.


---

Comment by drkirkby created at 2011-03-01 15:38:48

Changing status from needs_review to needs_info.


---

Comment by drkirkby created at 2011-03-01 15:38:48

See comments on #10828

I wonder if it might be sensible to create a new package called - python-documentation-1.0.spkg in order to resolve this circular dependency problem.

That new python-documentation-1.0.spkg gets built after both python and sphinx are built. This package then copies the contents of the python package from the python.spkg, extracts it, then builds only the documentation - not all of Python if at all possible. 

Otherwise, the build will fail for sure for everyone, which is off-putting to newcomers, even if old hands know how to get around the problem. The ability to type 'make' then go away and leave it will be lost if the build fails on this each time. 

dave


---

Comment by drkirkby created at 2011-03-01 15:50:30

I see your note that's its impossible to build just the docs for Python. 

Another option, which would be quicker is to 
 * If  `SAGE_SPKG_INSTALL_DOCS=yes`, build and install Python, but tar up the build and stick that in a temporary directory somewhere. 
 * After sphinx and whatever else are built, extract that tar file, and just build the documentation. 

Somehow I think we should automate this, so Python's documentation gets built without manual intervention. It can't be rocket science to do this. If the worst comes to the worst, just build Python twice if `SAGE_SPKG_INSTALL_DOCS=yes`


Dave


---

Comment by jason created at 2011-03-01 16:01:13

Yes, I suppose worst-case is just adding a python-docs target to the deps file that builds python again after sphinx is installed.  A slightly better case is adding a python-docs target that defines an environment variable SAGE_PYTHON_BUILD=no or something and then re-installs the python spkg.  Then modify the python spkg to check for that variable and not actually build python if that variable is no.


---

Comment by drkirkby created at 2011-03-02 02:07:50

Replying to [comment:4 jason]:
> Yes, I suppose worst-case is just adding a python-docs target to the deps file that builds python again after sphinx is installed. 

That's quite easy to do. 

> A slightly better case is adding a python-docs target that defines an environment variable SAGE_PYTHON_BUILD=no or something and then re-installs the python spkg.  Then modify the python spkg to check for that variable and not actually build python if that variable is no.

Ideally though we don't want the user to have to mess with that environment variable. I think this can be automated. 

As long as there's not an issue with hard-coded paths (which may make the documentation useless if Sage is moved), then I think a temporary tar file is the best solution, as it will save a lot of time. Python is a big package to build twice if it is unnecessary. 

This needs a bit of thought, and its late here, so I'm going to bed. 

Dave


---

Comment by jason created at 2011-03-02 14:15:30

Changing status from needs_info to needs_work.


---

Comment by jason created at 2011-03-02 14:18:13

Replying to [comment:5 drkirkby]:
> Replying to [comment:4 jason]:
> > Yes, I suppose worst-case is just adding a python-docs target to the deps file that builds python again after sphinx is installed. 
> 
> That's quite easy to do. 
> 
> > A slightly better case is adding a python-docs target that defines an environment variable SAGE_PYTHON_BUILD=no or something and then re-installs the python spkg.  Then modify the python spkg to check for that variable and not actually build python if that variable is no.
> 
> Ideally though we don't want the user to have to mess with that environment variable. I think this can be automated. 

Yep.  I'm thinking that the python-docs target will 

  * Check to see if SAGE_SPKG_INSTALL_DOCS=yes, and if so:
  * set the SAGE_SPKG_PYTHON_BUILD=no variable and then reinstall the python spkg (which will then just build the docs, but not python).

The user won't ever have to deal with that environment variable---it's all behind the scenes.


---

Comment by jason created at 2011-03-02 14:19:15

(note that the makefile wouldn't export SAGE_SPKG_PYTHON_BUILD, but would do the equivalent of ``SAGE_SPKG_PYTHON_BUILD=no sage -i python``


---

Comment by jason created at 2011-03-03 18:14:55

I'm a little lost in the deps file.  I've attached a patch which I think does what we want (add a new target that reinstalls the python spkg, but with a local variable set so that python isn't actually rebuilt).  Comments, David?


---

Attachment

Apply to deps (probably needs to be redone after #9433)


---

Comment by jason created at 2011-03-03 18:28:15

apply to the spkg/install file


---

Attachment

Okay, I think I made the necessary changes to the deps and install file.  The assumption is that the file `docs_python....spkg` is a symbolic link to the python spkg.  Is this solution a good way to do things?


---

Comment by jason created at 2011-04-14 13:54:01

See #11197 for building docs after Sage is built.


---

Comment by mkoeppe created at 2021-12-02 01:12:33

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-12-02 01:12:33

outdated, should close


---

Comment by dimpase created at 2021-12-02 23:36:00

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-03 18:41:01

Resolution: invalid
