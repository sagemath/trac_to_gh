# Issue 31439: Hash of mpmath complex numbers produces OverFlowError

Issue created by migration from https://trac.sagemath.org/ticket/31676

Original creator: soehms

Original creation time: 2021-04-16 13:11:16

CC:  malb vdelecroix

Keywords: mpmath complex hash

The issue is decribed by the following example:


```python
sage: from mpmath import mpc
sage: hash(mpc(1, -1))
---------------------------------------------------------------------------
OverflowError                             Traceback (most recent call last)
<ipython-input-2-ff647837f542> in <module>
----> 1 hash(mpc(Integer(1), -Integer(1)))

~/devel/sage/local/lib/python3.9/site-packages/sage/libs/mpmath/ext_main.pyx in sage.libs.mpmath.ext_main.mpc.__hash__ (build/cythonized/sage/libs/mpmath/ext_main.c:27881)()
   2496             True
   2497         """
-> 2498         return libmp.mpc_hash(self._mpc_)
   2499
   2500     def __neg__(s):

OverflowError: Python int too large to convert to C ssize_t
```




---

Comment by soehms created at 2021-04-16 13:16:15

Changing status from new to needs_review.


---

Comment by soehms created at 2021-04-16 13:16:15

Its seems that `__hash__` cannot return a Python3 `int` which is not an `int` in Python2. Therefore, my solution is to take the `hash` of the result of `libmp.mpc_hash`.
----
New commits:


---

Comment by dimpase created at 2021-04-18 08:45:09

Can someone who knows something about hash functions comment on the quality of the resulting hash function? We don't want too many collisions....


---

Comment by tscrim created at 2021-04-19 02:05:44

All it is doing is using Python's hashing of a long `int` into a `ssize_t` sized int, which has to be a good hash function (at least, I highly doubt we could do better than the Python developers for this).


---

Comment by tscrim created at 2021-04-19 02:05:44

Changing status from needs_review to positive_review.


---

Comment by soehms created at 2021-04-19 07:42:15

Thanks!


---

Comment by vbraun created at 2021-06-06 13:18:01

Resolution: fixed
