# Issue 24285: py3: bug in pynac numeric.cpp with PyObject_RichCompareBool

Issue created by migration from https://trac.sagemath.org/ticket/24522

Original creator: embray

Original creation time: 2018-01-11 17:24:22

CC:  rws

Keywords: pynac

There are a number of methods in pynac's numeric module that don't check for error results from `PyObject_RichCompareBool`.  This leads to unhandled exceptions that, on Python 2, were somewhat by luck being cleared via `PyObject_Clear()` later in the call stack.  Maybe this was somewhat by design but it doesn't feel that way.

On Python 3 we're less lucky--the interpreter asserts `PyErr_Occurred` in more places and we don't get so lucky.  That, at least, seems to be the source of the difference.  I need to investigate a little more though.


---

Comment by embray created at 2018-01-11 17:24:29

Changing type from PLEASE CHANGE to defect.


---

Comment by embray created at 2018-01-12 10:29:07

Yes, this still looks like what I described.  On Python 3 the exception leaks out, and slightly later on a call to `PyObject_IsInstance` in turn calls the type's `__instancecheck__` which goes through `_PyObject_FastCallDict` which in turn asserts `PyErr_Occurred`.

On Python 3 there is no `_PyObject_FastCallDict`, no assertion checks on `PyErr_Occurred` in the relevant code path, and eventually that error gets cleared.


---

Comment by jdemeyer created at 2018-01-12 13:11:31

Changing component from python3 to packages: standard.


---

Comment by jdemeyer created at 2018-01-12 13:11:31

Set assignee to jdemeyer.


---

Comment by embray created at 2018-01-12 17:41:47

I have an upstream fix for this ready--just need to make a PR...


---

Comment by embray created at 2018-01-15 18:30:01

Thanks!  This is low priority for now, as it only affects a few things on Python 3.  We can close this along with the next update to pynac in Sage.


---

Comment by embray created at 2018-01-15 18:30:01

Changing priority from major to minor.


---

Comment by chapoton created at 2018-03-14 16:06:32

Can we close this now ?


---

Comment by chapoton created at 2018-03-14 16:06:32

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-03-14 16:13:04

Resolution: duplicate
