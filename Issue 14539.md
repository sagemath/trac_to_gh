# Issue 14539: SymbolicFunction gives errors when using unbounded methods

archive/issues_014539.json:
```json
{
    "body": "Assignee: @burcin\n\nbefore this patch:\n\n\n```\nsage: function('radius', var('G'), evalf_func=Graph.radius)                             \nradius(G)\nsage: function('wiener_index', var('G'), evalf_func=Graph.wiener_index)\nException AttributeError: \"'builtin_function_or_method' object has no attribute 'func_code'\" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored\nException AttributeError: \"'builtin_function_or_method' object has no attribute 'func_code'\" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored\nwiener_index(G)\n```\n\n\nAfter this patch:\n\n\n```\nsage: function('radius', var('G'), evalf_func=Graph.radius)\nradius(G)\nsage: function('wiener_index', var('G'), evalf_func=Graph.wiener_index)\nwiener_index(G)\n```\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/14743\n\n",
    "created_at": "2013-06-14T20:36:00Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "SymbolicFunction gives errors when using unbounded methods",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14539",
    "user": "@nvcleemp"
}
```
Assignee: @burcin

before this patch:


```
sage: function('radius', var('G'), evalf_func=Graph.radius)                             
radius(G)
sage: function('wiener_index', var('G'), evalf_func=Graph.wiener_index)
Exception AttributeError: "'builtin_function_or_method' object has no attribute 'func_code'" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored
Exception AttributeError: "'builtin_function_or_method' object has no attribute 'func_code'" in 'sage.symbolic.function.SymbolicFunction._hash_' ignored
wiener_index(G)
```


After this patch:


```
sage: function('radius', var('G'), evalf_func=Graph.radius)
radius(G)
sage: function('wiener_index', var('G'), evalf_func=Graph.wiener_index)
wiener_index(G)
```


Issue created by migration from https://trac.sagemath.org/ticket/14743





---

archive/issue_comments_184571.json:
```json
{
    "body": "Attachment [trac_14743_symbolic_function.patch](tarball://root/attachments/some-uuid/ticket14743/trac_14743_symbolic_function.patch) by @nvcleemp created at 2013-06-14 20:40:07",
    "created_at": "2013-06-14T20:40:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184571",
    "user": "@nvcleemp"
}
```

Attachment [trac_14743_symbolic_function.patch](tarball://root/attachments/some-uuid/ticket14743/trac_14743_symbolic_function.patch) by @nvcleemp created at 2013-06-14 20:40:07



---

archive/issue_comments_184572.json:
```json
{
    "body": "The test from the description should probably also be added to this patch, but I didn't know where to add it. Any suggestions?",
    "created_at": "2013-06-14T20:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184572",
    "user": "@nvcleemp"
}
```

The test from the description should probably also be added to this patch, but I didn't know where to add it. Any suggestions?



---

archive/issue_comments_184573.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-06-14T20:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184573",
    "user": "@nvcleemp"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_184574.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-06-18T00:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184574",
    "user": "@burcin"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_184575.json:
```json
{
    "body": "Can you give an example of where this would be useful? Are you trying to construct symbolic functions where the custom methods are compiled (hence have no `func_code` attribute)?\n\nThis patch causes problems in the way we detect if a new symbolic function is being created:\n\n\n```\nsage: f = function('f', evalf_func=Graph.wiener_index)\nsage: f(5)\nf(5)\nsage: f(5).n()\nTypeError: unbound method wiener_index() must be called with Graph instance as first argument (got ComplexNumber instance instead)\nsage: f = function('f', evalf_func=Expression.is_one) \nsage: f(5).n()                                       \nTypeError: unbound method wiener_index() must be called with Graph instance as first argument (got ComplexNumber instance instead)\n```\n\n\nNote that the second error message still refers to `wiener_index()`.\n\nThe documentation for `SymbolicFunction` states:\n\n\n```\n    This is the basis for user defined symbolic functions. We try to pickle or\n    hash the custom methods, so subclasses must be defined in Python not Cython.\n```\n\n\nSo using compiled (Cython) methods for the custom evaluation methods is not supported. If you describe your application we can think about a different solution.",
    "created_at": "2013-06-18T00:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184575",
    "user": "@burcin"
}
```

Can you give an example of where this would be useful? Are you trying to construct symbolic functions where the custom methods are compiled (hence have no `func_code` attribute)?

This patch causes problems in the way we detect if a new symbolic function is being created:


```
sage: f = function('f', evalf_func=Graph.wiener_index)
sage: f(5)
f(5)
sage: f(5).n()
TypeError: unbound method wiener_index() must be called with Graph instance as first argument (got ComplexNumber instance instead)
sage: f = function('f', evalf_func=Expression.is_one) 
sage: f(5).n()                                       
TypeError: unbound method wiener_index() must be called with Graph instance as first argument (got ComplexNumber instance instead)
```


Note that the second error message still refers to `wiener_index()`.

The documentation for `SymbolicFunction` states:


```
    This is the basis for user defined symbolic functions. We try to pickle or
    hash the custom methods, so subclasses must be defined in Python not Cython.
```


So using compiled (Cython) methods for the custom evaluation methods is not supported. If you describe your application we can think about a different solution.



---

archive/issue_comments_184576.json:
```json
{
    "body": "Well, it's not really my application. :-) I was trying to find a fix for this issue: https://github.com/IndependenceNumberProject/inp/issues/10\n\nThis issue is about this file: https://github.com/IndependenceNumberProject/inp/blob/master/conjecture.py",
    "created_at": "2013-06-18T05:19:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184576",
    "user": "@nvcleemp"
}
```

Well, it's not really my application. :-) I was trying to find a fix for this issue: https://github.com/IndependenceNumberProject/inp/issues/10

This issue is about this file: https://github.com/IndependenceNumberProject/inp/blob/master/conjecture.py



---

archive/issue_comments_184577.json:
```json
{
    "body": "I suspect that if people try to define a symbolic function that gets evaluated via an unbound method, they are doing the wrong thing: An unbound method expects a \"self\" argument and expects that to be of a very particular type (and usually not a \"symbolic expression\"). Symbolic functions, on the other hand only get symbolic expressions as arguments, and need to be extremely tolerant (or at least careful) in handling the different types of objects that might come wrapped in such a package. Symbolic functions are only for calculus-type applications. For most other situations one should use python functions/methods straight away.\n\nI would say that the proper fix is to check that the documentation contains information along these lines, not to make it easier to use the wrong tool for the job.",
    "created_at": "2013-06-18T06:58:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184577",
    "user": "@nbruin"
}
```

I suspect that if people try to define a symbolic function that gets evaluated via an unbound method, they are doing the wrong thing: An unbound method expects a "self" argument and expects that to be of a very particular type (and usually not a "symbolic expression"). Symbolic functions, on the other hand only get symbolic expressions as arguments, and need to be extremely tolerant (or at least careful) in handling the different types of objects that might come wrapped in such a package. Symbolic functions are only for calculus-type applications. For most other situations one should use python functions/methods straight away.

I would say that the proper fix is to check that the documentation contains information along these lines, not to make it easier to use the wrong tool for the job.



---

archive/issue_comments_184578.json:
```json
{
    "body": "Hmm, OK, then there should indeed be some more documentation documenting this. The author of inp and I discussed this a bit and we both agreed that the symbolics stuff was rather obscure, but it never occurred to us, that we might be doing something that is not meant to work.",
    "created_at": "2013-06-18T08:03:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184578",
    "user": "@nvcleemp"
}
```

Hmm, OK, then there should indeed be some more documentation documenting this. The author of inp and I discussed this a bit and we both agreed that the symbolics stuff was rather obscure, but it never occurred to us, that we might be doing something that is not meant to work.



---

archive/issue_comments_184579.json:
```json
{
    "body": "There could be done more than docs improvement to prevent this. It should be possible to list the superclasses of the `evalf_f` method's class using `inspect.getmro`, and then through `inspect.getfile` their source files, where the \".so\" ending points to non-Python code. See also the code for `sage_getfile`. Maybe there is even a direct method recognizing subclasses of Cython extensions.",
    "created_at": "2015-02-04T15:27:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14539",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14539#issuecomment-184579",
    "user": "@rwst"
}
```

There could be done more than docs improvement to prevent this. It should be possible to list the superclasses of the `evalf_f` method's class using `inspect.getmro`, and then through `inspect.getfile` their source files, where the ".so" ending points to non-Python code. See also the code for `sage_getfile`. Maybe there is even a direct method recognizing subclasses of Cython extensions.
