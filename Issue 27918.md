# Issue 27918: Check for formality of GCDA's

Issue created by migration from https://trac.sagemath.org/ticket/28155

Original creator: mmarco

Original creation time: 2019-07-10 12:33:43

CC:  jhpalmieri slelievre dimpase tscrim




---

Comment by mmarco created at 2019-07-10 12:41:13

New commits:


---

Comment by mmarco created at 2019-07-17 10:55:34

Changing component from PLEASE CHANGE to algebra.


---

Comment by mmarco created at 2019-07-17 10:55:34

Changing type from PLEASE CHANGE to enhancement.


---

Comment by git created at 2019-07-23 12:11:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-19 11:41:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-09-19 11:42:12

Changing status from new to needs_review.


---

Comment by mmarco created at 2019-09-19 11:42:12

New commits:


---

Comment by mmarco created at 2019-09-19 11:42:12

Changing component from algebra to algebraic topology.


---

Comment by tscrim created at 2019-09-19 12:17:04

It looks good overall. Here are my comments:

You do not need to create the entire list here:

```diff
-return sum([a * b for (a, b) in zip(cohomcoefs, C.basis().values())])
+return sum(a * b for (a, b) in zip(cohomcoefs, C.basis().values()))
```

Also, is that expected to work if `C.basis()` is empty (if that even occurs)?

Similar here

```diff
-if any([N1[n] != N2[n] for n in range(1, i + 1)]):
+if any(N1[n] != N2[n] for n in range(1, i + 1)):
```

and here

```diff
-if all([c.is_coboundary() for c in tocheck]):
+if all(c.is_coboundary() for c in tocheck):
```


Sage follows python convention of errors starting with lower case:

```
-raise NotImplementedError("The implemented criteria cannot determine formality")
+raise NotImplementedError("the implemented criteria cannot determine formality")
```


Our conventions for `INPUT:` docstrings:

```diff
-        - ``i`` -- integer; the degree up to which the formality is checked.
+        - ``i`` -- integer; the degree up to which the formality is checked
 
         - ``max_iterations`` -- integer (default: `3`); the maximum number of
-          iterations used in the computation of the minimal model.
+          iterations used in the computation of the minimal model
```


```diff
         - ``max_degree`` -- integer (default: `3`); the degree up to which the
-          numerical invariants are computed.
+          numerical invariants are computed
 
         - ``max_iterations`` -- integer (default: `3`); the maximum number of iterations
-          used to compute the minimal model, if it is not already cached.
+          used to compute the minimal model, if it is not already cached
```


It is not always a good idea to strictly follow PEP8 when writing code. It leads to things like this:

```
                                     ['x{}'.format(i)
                                         for i in range(len(chgens))],
```

where the break makes it harder to read the code. Not that this will cause me to hold up the ticket once everything else is done, but it might be worthwhile to go through and consider on the changes you made.


---

Comment by git created at 2019-09-20 09:16:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-09-20 09:17:03

I made the suggested changes.


> Also, is that expected to work if `C.basis()` is empty (if that even occurs)?
> 

It is expected to return the zero element of a trivial cohomology group. It did return zero as an integer. I have forced a conversion to the corresponding cohomology group, and added a corresponding test.

----
New commits:


---

Comment by tscrim created at 2019-09-20 12:30:51

Thank you. One last thing to address is the pyflakes (see the patchbot). For instance, since you do not use the minimal model, you can just do this:

```diff
-MH = H.minimal_model(i, max_iterations)
+H.minimal_model(i, max_iterations)
```



---

Comment by git created at 2019-09-20 14:23:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-09-20 21:17:50

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2019-09-20 21:17:50

Thank you.


---

Comment by chapoton created at 2019-09-30 08:12:27

moving milestone to 9.0 (after release of 8.9)


---

Comment by vbraun created at 2019-10-03 17:48:05

I'm getting a lot of 

```
File "src/sage/algebras/commutative_dga.py", line 2888, in sage.algebras.commutative_dga.DifferentialGCAlgebra.Element.cohomology_class
Failed example:
    a.cohomology_class()
Expected:
    B[[e1*e3*e5]] - 3*B[[e2*e3*e5]]
Got:
    -3*B[[e2*e3*e5]] + B[[e1*e3*e5]]
**********************************************************************
1 item had failures:
   1 of  11 in sage.algebras.commutative_dga.DifferentialGCAlgebra.Element.cohomology_class
    [600 tests, 1 failure, 26.78 s]
----------------------------------------------------------------------
sage -t --long src/sage/algebras/commutative_dga.py  # 1 doctest failed
----------------------------------------------------------------------

```



---

Comment by vbraun created at 2019-10-03 17:48:05

Changing status from positive_review to needs_work.


---

Comment by jhpalmieri created at 2019-10-03 18:31:27

Oddly enough, I see this intermittently with Python 2 but not at all with Python 3. In a Python 2 Sage session:

```
sage: A.<e1,e2,e3,e4,e5> = GradedCommutativeAlgebra(QQ)
sage: B = A.cdg_algebra({e5:e1*e2+e3*e4})
sage: B.inject_variables()
Defining e1, e2, e3, e4, e5
sage: a = e1*e3*e5-3*e2*e3*e5
sage: a.cohomology_class()
B[[e1*e3*e5]] - 3*B[[e2*e3*e5]]
sage: a.cohomology_class()
-3*B[[e2*e3*e5]] + B[[e1*e3*e5]]}}}


---

Comment by git created at 2019-10-15 09:07:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-10-15 09:11:08

It seems to be a problem with `CohomologyClass`. I did it `CachedRepresentation`, which seems to solve the problem of returning different representations in the same session. However, I still get errors every time I run the testsuite.

Is there any flag or environment variable that could affect the order in which the basis of a `CombinatorialFreeModule`are represented depending on the fact that we are in an interactive shell or running the testsuite?
----
New commits:


---

Comment by git created at 2019-10-15 10:16:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-10-15 10:17:04

Ok, I think I solved it.
----
New commits:


---

Comment by mmarco created at 2019-10-15 10:17:04

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2019-10-15 17:20:26

Using `CachedRepresentation` should not be necessary, since you're using `sorting_key=...`, and this seems to be borne out in some testing that I did. So I think it should be removed.


---

Comment by mmarco created at 2019-10-15 17:42:56

I found that ithout `CachedRepresentation` , each time that the cohomology class of an element is computed, we get a different object. In particular, when we create the cohomology group, it takes as basis the specific instances of the cohomology classes of the generators that were created in that particular call. Hence, when we call it again, we get a different group.


That is, without `CachedRepresentation` we get this:


```
sage: A.<e1,e2,e3,e4,e5> = GradedCommutativeAlgebra(QQ)
sage: B = A.cdg_algebra({e5:e1*e2+e3*e4})
sage: B.inject_variables()
Defining e1, e2, e3, e4, e5
sage: a = e1*e3*e5-3*e2*e3*e5
sage: C = B.cohomology(3)
sage: a.cohomology_class() in C
False
```


Even if the parent of `a.cohomology_class()` should be `C` :


```
sage: C
Free module generated by {[e1*e2*e5 - e3*e4*e5], [e1*e3*e5], [e2*e3*e5], [e1*e4*e5], [e2*e4*e5]} over Rational Field
sage: a.cohomology_class().parent()
Free module generated by {[e1*e2*e5 - e3*e4*e5], [e1*e3*e5], [e2*e3*e5], [e1*e4*e5], [e2*e4*e5]} over Rational Field
```


They look the same, but are different objects because they have been created with different  generators.

Indeed:


```
sage: B.cohomology(3) is B.cohomology(3)
False
sage: B.cohomology(3) == B.cohomology(3)
False
```



---

Comment by jhpalmieri created at 2019-10-15 18:46:39

Can you add some of these as doctests, then?


---

Comment by git created at 2019-10-16 09:06:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmarco created at 2019-10-16 09:07:00

Doctests added.


---

Comment by jhpalmieri created at 2019-10-16 17:50:25

Thank you. I've made a few small docstring fixes. If you're happy with my changes, please set to positive review on my behalf.
----
Last 10 new commits:


---

Comment by mmarco created at 2019-10-16 17:52:18

Changing status from needs_review to positive_review.


---

Comment by mmarco created at 2019-10-16 17:52:18

Thank you!


---

Comment by vbraun created at 2019-10-21 22:43:55

Resolution: fixed


---

Comment by jhpalmieri created at 2022-09-24 17:38:21

I am now annoyed at the requirement that generators have to be entered in increasing order of degree. If the code cares that much about the ordering, it should sort itself and save its preferred ordering, but why should a user who has an algebra with a natural ordering of the generators have to manually reorder them to fit the code? This seems backward to me.


---

Comment by jhpalmieri created at 2022-09-24 18:53:56

Following up in #34582.
