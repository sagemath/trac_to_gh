# Issue 24351: py3: several long/int related fixes

archive/issues_024351.json:
```json
{
    "body": "CC:  @jdemeyer @fchapoton\n\nThese fix a number of major crashes related to handling of Python `int`s on Python 3, especially in cases that were trying to cram them into C `long`s.\n\nIssue created by migration from https://trac.sagemath.org/ticket/24588\n\n",
    "created_at": "2018-01-23T12:32:15Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.2",
    "title": "py3: several long/int related fixes",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/24351",
    "user": "https://github.com/embray"
}
```
CC:  @jdemeyer @fchapoton

These fix a number of major crashes related to handling of Python `int`s on Python 3, especially in cases that were trying to cram them into C `long`s.

Issue created by migration from https://trac.sagemath.org/ticket/24588





---

archive/issue_comments_340698.json:
```json
{
    "body": "I think this uses `integer_check_long` more or less as intended, but Jeroen will probably want to make sure, as its author.",
    "created_at": "2018-01-23T12:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340698",
    "user": "https://github.com/embray"
}
```

I think this uses `integer_check_long` more or less as intended, but Jeroen will probably want to make sure, as its author.



---

archive/issue_comments_340699.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-01-23T12:33:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340699",
    "user": "https://github.com/embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_340700.json:
```json
{
    "body": "Several quick comments:\n\n1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.\n\n2. In `integer_mod.pyx` you write\n\n```\nelif (isinstance(value, int) and\n      integer_check_long_py(value, &longval, &err) and not err):\n```\n\nAnd you sure that you need the `isinstance(value, int)` check? Part of the point of `integer_check_long_py` is that there is no need for explicit type checking.\n\n3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?",
    "created_at": "2018-01-23T13:21:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340700",
    "user": "https://github.com/jdemeyer"
}
```

Several quick comments:

1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.

2. In `integer_mod.pyx` you write

```
elif (isinstance(value, int) and
      integer_check_long_py(value, &longval, &err) and not err):
```

And you sure that you need the `isinstance(value, int)` check? Part of the point of `integer_check_long_py` is that there is no need for explicit type checking.

3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?



---

archive/issue_comments_340701.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-01-23T13:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340701",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340702.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n> Several quick comments:\n> \n> 1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.\n\nYes, I think when I wrote that one bit I just forgot I was in a Cython module.",
    "created_at": "2018-01-23T13:34:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340702",
    "user": "https://github.com/embray"
}
```

Replying to [comment:2 jdemeyer]:
> Several quick comments:
> 
> 1. In Cython, don't use `six` unless you have a very good reason. Cython supports `long(x)` both on Python 2 and Python 3.

Yes, I think when I wrote that one bit I just forgot I was in a Cython module.



---

archive/issue_comments_340703.json:
```json
{
    "body": "Replying to [comment:2 jdemeyer]:\n\n> 3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?\n\nI believe so. In Python 2 we need both `__long__` and `__int__`, but on Python 3 if you have both defined Cython will take `__int__` (really it should take `__long__`).  But it seems to be confused.  However, if you have just `__long__` it will use it correctly.",
    "created_at": "2018-01-23T13:46:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340703",
    "user": "https://github.com/embray"
}
```

Replying to [comment:2 jdemeyer]:

> 3. In `rational.pyx`, do you really need `IF PY_MAJOR_VERSION <= 2:`?

I believe so. In Python 2 we need both `__long__` and `__int__`, but on Python 3 if you have both defined Cython will take `__int__` (really it should take `__long__`).  But it seems to be confused.  However, if you have just `__long__` it will use it correctly.



---

archive/issue_comments_340704.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-23T13:56:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340704",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340705.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-01-23T13:56:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340705",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340706.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-01-23T17:36:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340706",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340707.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-09T15:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340707",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340708.json:
```json
{
    "body": "does not apply",
    "created_at": "2018-02-09T15:47:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340708",
    "user": "https://github.com/fchapoton"
}
```

does not apply



---

archive/issue_comments_340709.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-02-12T10:41:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_340710.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-12T10:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340710",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340711.json:
```json
{
    "body": "Well, it does now...",
    "created_at": "2018-02-12T10:41:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340711",
    "user": "https://github.com/embray"
}
```

Well, it does now...



---

archive/issue_comments_340712.json:
```json
{
    "body": "1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does \"nor can it be coerced to an int\" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).\n\n2. In `integer.pyx` and `rational.pyx`, you have\n\n```\n        if type(a) is not int:\n            raise ValueError(\"must be a Python int object\")\n\n        do_something_with(PyInt_AS_LONG(a))\n```\n\nFirst of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.\n\n3. Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`.\n\n4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.\n\n5. In `src/sage/structure/coerce_actions.pyx`, I would replace\n\n```\nif integer_check_long(nn, &n_long, &err) and not err:\n```\n\nby\n\n```\ninteger_check_long(nn, &n_long, &err)\nif not err:\n```\n",
    "created_at": "2018-02-12T11:18:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340712",
    "user": "https://github.com/jdemeyer"
}
```

1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does "nor can it be coerced to an int" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).

2. In `integer.pyx` and `rational.pyx`, you have

```
        if type(a) is not int:
            raise ValueError("must be a Python int object")

        do_something_with(PyInt_AS_LONG(a))
```

First of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.

3. Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`.

4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.

5. In `src/sage/structure/coerce_actions.pyx`, I would replace

```
if integer_check_long(nn, &n_long, &err) and not err:
```

by

```
integer_check_long(nn, &n_long, &err)
if not err:
```




---

archive/issue_comments_340713.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-12T11:18:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340713",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340714.json:
```json
{
    "body": "> Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`\n\nCan you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.  Why for `Integer` and not `Rational`?",
    "created_at": "2018-02-12T11:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340714",
    "user": "https://github.com/embray"
}
```

> Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`

Can you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.  Why for `Integer` and not `Rational`?



---

archive/issue_comments_340715.json:
```json
{
    "body": "Also, I'm not entirely convinced by the logic in `integer_mod.pyx`. It seems that the type of the result should *only* depend on the parent, not on the input number.",
    "created_at": "2018-02-12T11:24:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340715",
    "user": "https://github.com/jdemeyer"
}
```

Also, I'm not entirely convinced by the logic in `integer_mod.pyx`. It seems that the type of the result should *only* depend on the parent, not on the input number.



---

archive/issue_comments_340716.json:
```json
{
    "body": "Replying to [comment:14 embray]:\n> > Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`\n> \n> Can you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.\n\nFor `Integer`, we add a specific hacked `tp_new` slot. See `fast_tp_new` in `integer.pyx`. This bypasses the Cython-generated `tp_new`, so Cython might optimize `Integer.__new__(Integer)` wrongly. This is not the case for `Rational`.",
    "created_at": "2018-02-12T11:25:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340716",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:14 embray]:
> > Don't use `PY_NEW(Rational)`. Just use `Rational.__new__(Rational)`
> 
> Can you explain this a little more?  I used to have the latter but I changed it because in the past you've told me to use `PY_NEW`, but for `Integer`.

For `Integer`, we add a specific hacked `tp_new` slot. See `fast_tp_new` in `integer.pyx`. This bypasses the Cython-generated `tp_new`, so Cython might optimize `Integer.__new__(Integer)` wrongly. This is not the case for `Rational`.



---

archive/issue_comments_340717.json:
```json
{
    "body": "Replying to [comment:12 jdemeyer]:\n> 1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does \"nor can it be coerced to an int\" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).\n\nI think originally this `integer_check_long` which tries `__index__` and some other conversions if possible.  But I changed it--I don't remember exactly why.\n\n> 2. In `integer.pyx` and `rational.pyx`, you have\n> {{{\n>         if type(a) is not int:\n>             raise ValueError(\"must be a Python int object\")\n> \n>         do_something_with(PyInt_AS_LONG(a))\n> }}}\n> First of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.\n\nIn both these cases this is code that will only ever be used on Python 2, because I also added a `long_to_<F>` map.  If anything the `int_to_<F>` could be omitted completely on Python 2 with a compile-time `IF` but I didn't because it at least does build on Python 3, but never get used.  What do you think?\n\nI added the check very deliberately because, as you can read in the commit messages, the previous code did not have the check supposedly for \"efficiency\" because in practice the code is never run except through the coercion model where the appropriate type checks have already been made. However, in testing, the code is still tested directly.  And this is unsafe--on Python 2 it happened that it could work okay, but in fact it can actually lead to a segfault.  Keeping the check is good, and not having it was a needless micro-optimization.  I agree, in retrospect, it should be a `TypeError`.\n\n\n> 4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.\n\nIndeed--there's no need for the `Integer` there.\n\n> 5. In `src/sage/structure/coerce_actions.pyx`, I would replace\n> {{{\n> if integer_check_long(nn, &n_long, &err) and not err:\n> }}}\n> by\n> {{{\n> integer_check_long(nn, &n_long, &err)\n> if not err:\n> }}}\n\nI don't care much either way.",
    "created_at": "2018-02-12T11:36:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340717",
    "user": "https://github.com/embray"
}
```

Replying to [comment:12 jdemeyer]:
> 1. In `src/sage/rings/finite_rings/integer_mod.pyx`, what does "nor can it be coerced to an int" in the error message mean? You're *only* checking for `int`/`long`, not for something that can be coerced to an int (whatever that would mean).

I think originally this `integer_check_long` which tries `__index__` and some other conversions if possible.  But I changed it--I don't remember exactly why.

> 2. In `integer.pyx` and `rational.pyx`, you have
> {{{
>         if type(a) is not int:
>             raise ValueError("must be a Python int object")
> 
>         do_something_with(PyInt_AS_LONG(a))
> }}}
> First of all, the check for `int` seems wrong since it will also pass the `int == long` type on Python 3. Second, the exception should be a `TypeError`. Since there was no check before, maybe you shouldn't add a check.

In both these cases this is code that will only ever be used on Python 2, because I also added a `long_to_<F>` map.  If anything the `int_to_<F>` could be omitted completely on Python 2 with a compile-time `IF` but I didn't because it at least does build on Python 3, but never get used.  What do you think?

I added the check very deliberately because, as you can read in the commit messages, the previous code did not have the check supposedly for "efficiency" because in practice the code is never run except through the coercion model where the appropriate type checks have already been made. However, in testing, the code is still tested directly.  And this is unsafe--on Python 2 it happened that it could work okay, but in fact it can actually lead to a segfault.  Keeping the check is good, and not having it was a needless micro-optimization.  I agree, in retrospect, it should be a `TypeError`.


> 4. `int_toRR` could be made more efficient by directly using an `mpz_t` instead of an `Integer`.

Indeed--there's no need for the `Integer` there.

> 5. In `src/sage/structure/coerce_actions.pyx`, I would replace
> {{{
> if integer_check_long(nn, &n_long, &err) and not err:
> }}}
> by
> {{{
> integer_check_long(nn, &n_long, &err)
> if not err:
> }}}

I don't care much either way.



---

archive/issue_comments_340718.json:
```json
{
    "body": "I wonder if we couldn't add the same hack for Rational, for consistency's sake if nothing else.  Because that's completely non-obvious.  But that's an orthogonal issue.",
    "created_at": "2018-02-12T11:42:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340718",
    "user": "https://github.com/embray"
}
```

I wonder if we couldn't add the same hack for Rational, for consistency's sake if nothing else.  Because that's completely non-obvious.  But that's an orthogonal issue.



---

archive/issue_comments_340719.json:
```json
{
    "body": "It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.",
    "created_at": "2018-02-12T11:43:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340719",
    "user": "https://github.com/embray"
}
```

It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.



---

archive/issue_comments_340720.json:
```json
{
    "body": "General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?",
    "created_at": "2018-02-12T11:45:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340720",
    "user": "https://github.com/embray"
}
```

General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?



---

archive/issue_comments_340721.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-12T11:47:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340721",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340722.json:
```json
{
    "body": "Replying to [comment:20 embray]:\n> General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?\n\nI guess the difference is mathematical: a `Morphism` must be a morphism (this means in particular that it is defined everywhere). Coercions are required to be morphisms, conversions may be maps which are not morphisms.\n\nBut I don't know how this mathematical difference is relevant for the implementation.",
    "created_at": "2018-02-12T11:56:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340722",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:20 embray]:
> General question: What is the difference between `Morphism` and `Map` and why is one used in some cases and the other in other cases?

I guess the difference is mathematical: a `Morphism` must be a morphism (this means in particular that it is defined everywhere). Coercions are required to be morphisms, conversions may be maps which are not morphisms.

But I don't know how this mathematical difference is relevant for the implementation.



---

archive/issue_comments_340723.json:
```json
{
    "body": "Right, I know what these terms mean in mathematics but it's really unclear how or why they're being used in certain cases in Sage...",
    "created_at": "2018-02-12T14:14:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340723",
    "user": "https://github.com/embray"
}
```

Right, I know what these terms mean in mathematics but it's really unclear how or why they're being used in certain cases in Sage...



---

archive/issue_comments_340724.json:
```json
{
    "body": "Replying to [comment:19 embray]:\n> It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.\n\nIn second thought, I'll leave this as-is for now, just in this case.  Reason being that the existing class does not override `__init__` and requires passing in the domain and codomain as arguments anyways (this is in contrast with, say, `int_to_Q` whose `__init__` bakes these in).  It would be good to change this for consistency's sake, and there's probably no problem with changing this since it's really an internal implementation detail.  But for now, since `int_toRR` is defined the way it is, there's no good reason to have separate `int` and `long` maps.\n\nStill need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.",
    "created_at": "2018-02-12T14:26:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340724",
    "user": "https://github.com/embray"
}
```

Replying to [comment:19 embray]:
> It occurs to me I should actually add a separate `long_toRR` as I did for in integer and rational.

In second thought, I'll leave this as-is for now, just in this case.  Reason being that the existing class does not override `__init__` and requires passing in the domain and codomain as arguments anyways (this is in contrast with, say, `int_to_Q` whose `__init__` bakes these in).  It would be good to change this for consistency's sake, and there's probably no problem with changing this since it's really an internal implementation detail.  But for now, since `int_toRR` is defined the way it is, there's no good reason to have separate `int` and `long` maps.

Still need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.



---

archive/issue_comments_340725.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-02-12T15:03:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340725",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_340726.json:
```json
{
    "body": "Not totally sure about this last change, but I *think* it's better.",
    "created_at": "2018-02-12T15:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340726",
    "user": "https://github.com/embray"
}
```

Not totally sure about this last change, but I *think* it's better.



---

archive/issue_comments_340727.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-02-12T15:04:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340727",
    "user": "https://github.com/embray"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_340728.json:
```json
{
    "body": "Replying to [comment:24 embray]:\n> Still need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.\n\nI would just keep them.",
    "created_at": "2018-02-12T20:41:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340728",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:24 embray]:
> Still need your opinion on what to do with the `int_to_<F>` maps that are only relevant to Python 2.

I would just keep them.



---

archive/issue_comments_340729.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-02-13T15:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340729",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_340730.json:
```json
{
    "body": "1. Why `long(x)` here? Surely, `int(x)` makes more sense:\n\n```\n        if not isinstance(x, (int, long)):\n            x = long(x)\n```\n\n\n2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.\n\n3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)",
    "created_at": "2018-02-13T15:37:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340730",
    "user": "https://github.com/jdemeyer"
}
```

1. Why `long(x)` here? Surely, `int(x)` makes more sense:

```
        if not isinstance(x, (int, long)):
            x = long(x)
```


2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.

3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)



---

archive/issue_comments_340731.json:
```json
{
    "body": "Replying to [comment:28 jdemeyer]:\n> 1. Why `long(x)` here? Surely, `int(x)` makes more sense:\n> {{{\n>         if not isinstance(x, (int, long)):\n>             x = long(x)\n> }}}\n\nHonestly, neither is quite right.  You certainly don't want `int()` since that could overflow on Python 2.  The problem with the original design of this class it wants to be able to accept anything in its domain that can be converted to an int.  But this has problems if you want it to work for long too.  I don't know that there's actually any code that relies on its current behavior though so maybe that should just be changed.\n\n> 2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.\n\nOops, of course.\n \n> 3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)\n\nWell, the solution there is just consistent with the existing logic of that class.  I'm not sure it makes a whole lot of sense either.  I would propose to leave it as-is for now (because it fixes any Python 3 specific bugs) but you could open a separate ticket if you think the logic is wrong in general.",
    "created_at": "2018-02-14T16:28:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340731",
    "user": "https://github.com/embray"
}
```

Replying to [comment:28 jdemeyer]:
> 1. Why `long(x)` here? Surely, `int(x)` makes more sense:
> {{{
>         if not isinstance(x, (int, long)):
>             x = long(x)
> }}}

Honestly, neither is quite right.  You certainly don't want `int()` since that could overflow on Python 2.  The problem with the original design of this class it wants to be able to accept anything in its domain that can be converted to an int.  But this has problems if you want it to work for long too.  I don't know that there's actually any code that relies on its current behavior though so maybe that should just be changed.

> 2. After `mpz_init(x_mpz)` you need `mpz_clear(x_mpz)`.

Oops, of course.
 
> 3. [comment:15] (I would suggest to deal with that in a separate ticket, you know me)

Well, the solution there is just consistent with the existing logic of that class.  I'm not sure it makes a whole lot of sense either.  I would propose to leave it as-is for now (because it fixes any Python 3 specific bugs) but you could open a separate ticket if you think the logic is wrong in general.



---

archive/issue_comments_340732.json:
```json
{
    "body": "`int(x)` doesn't overflow. It just returns a `long` instance:\n\n```\nsage: int(float(1e100))\n10000000000000000159028911097599180468360808563945281389781327557747838772170381060813469985856815104L\n```\n",
    "created_at": "2018-02-14T16:31:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340732",
    "user": "https://github.com/jdemeyer"
}
```

`int(x)` doesn't overflow. It just returns a `long` instance:

```
sage: int(float(1e100))
10000000000000000159028911097599180468360808563945281389781327557747838772170381060813469985856815104L
```




---

archive/issue_comments_340733.json:
```json
{
    "body": "Replying to [comment:29 embray]:\n> I would propose to leave it as-is for now\n\nWhat's the point of replacing wrong code with different wrong code?",
    "created_at": "2018-02-15T06:35:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340733",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:29 embray]:
> I would propose to leave it as-is for now

What's the point of replacing wrong code with different wrong code?



---

archive/issue_comments_340734.json:
```json
{
    "body": "The answer is right in both the title and \"component\" of the ticket: \"py3:\".\n\nThis is far from the only \"wrong\" or at least \"bad\" code I've encountered in Sage in the course of making Python 3 (some of it is downright atrocious).  The focus of this changeset is to merely fix the bugs on Python 3.\n\n> `int(x)` doesn't overflow\n\nI was imprecise. The problem isn't that `int(x)` itself will overflow.  The behavior you cite is due to how `float.__int__` is implemented.  Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.",
    "created_at": "2018-02-15T16:21:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340734",
    "user": "https://github.com/embray"
}
```

The answer is right in both the title and "component" of the ticket: "py3:".

This is far from the only "wrong" or at least "bad" code I've encountered in Sage in the course of making Python 3 (some of it is downright atrocious).  The focus of this changeset is to merely fix the bugs on Python 3.

> `int(x)` doesn't overflow

I was imprecise. The problem isn't that `int(x)` itself will overflow.  The behavior you cite is due to how `float.__int__` is implemented.  Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.



---

archive/issue_comments_340735.json:
```json
{
    "body": "Replying to [comment:32 embray]:\n> Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.\n\nBut `int(x)` is used in so many places in Sage and in Python. I feel like we should have noticed any bugs there...",
    "created_at": "2018-02-15T16:25:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340735",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:32 embray]:
> Not all the `__int__` in Sage return `long` objects (for Python 2) where it should.  Maybe that should be fixed (I can't remember a specific example), but it's safer to ask explicitly for a long.

But `int(x)` is used in so many places in Sage and in Python. I feel like we should have noticed any bugs there...



---

archive/issue_comments_340736.json:
```json
{
    "body": "In this case I could change it and see how things go.  You're right--my only justifications in this case are vague hand-waving. I don't think there's a specific issue it addresses.  Although I will say that the use of `int(x)` in many places *does* have bugs, and they just don't show up because that code normally involves smaller numbers.",
    "created_at": "2018-02-15T16:28:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340736",
    "user": "https://github.com/embray"
}
```

In this case I could change it and see how things go.  You're right--my only justifications in this case are vague hand-waving. I don't think there's a specific issue it addresses.  Although I will say that the use of `int(x)` in many places *does* have bugs, and they just don't show up because that code normally involves smaller numbers.



---

archive/issue_comments_340737.json:
```json
{
    "body": "Looks like there's one test I forgot to update after [45a005d6](https://git.sagemath.org/sage.git/commit/?id=45a005d6c12d1fc7aa946f4635067f79067baeb8).  Thought I had all those but apparently not.",
    "created_at": "2018-02-15T16:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340737",
    "user": "https://github.com/embray"
}
```

Looks like there's one test I forgot to update after [45a005d6](https://git.sagemath.org/sage.git/commit/?id=45a005d6c12d1fc7aa946f4635067f79067baeb8).  Thought I had all those but apparently not.



---

archive/issue_comments_340738.json:
```json
{
    "body": "I will\n\n1. add the few minor fixes which are still needed\n\n2. revert the changes to `integer_mod.pyx` and open a new ticket for that\n\n3. give positive review to this ticket",
    "created_at": "2018-02-16T08:50:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340738",
    "user": "https://github.com/jdemeyer"
}
```

I will

1. add the few minor fixes which are still needed

2. revert the changes to `integer_mod.pyx` and open a new ticket for that

3. give positive review to this ticket



---

archive/issue_comments_340739.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2018-02-16T09:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340739",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_340740.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2018-02-16T09:07:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340740",
    "user": "https://github.com/jdemeyer"
}
```

Last 10 new commits:



---

archive/issue_comments_340741.json:
```json
{
    "body": "I had already fixed those things...\n\nI'm not sure why this change:\n\n\n```\n-        elif err == ERR_OVERFLOW:\n+        elif isinstance(x, long):\n```\n\n\nWhy a relatively slow `isinstance` when the whole point of `ERR_OVERFLOW` is that the value was already an int/long too big to fit in a C long?  At any rate, there's now an unused `cimport` of `ERR_OVERFLOW`...",
    "created_at": "2018-02-16T10:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340741",
    "user": "https://github.com/embray"
}
```

I had already fixed those things...

I'm not sure why this change:


```
-        elif err == ERR_OVERFLOW:
+        elif isinstance(x, long):
```


Why a relatively slow `isinstance` when the whole point of `ERR_OVERFLOW` is that the value was already an int/long too big to fit in a C long?  At any rate, there's now an unused `cimport` of `ERR_OVERFLOW`...



---

archive/issue_comments_340742.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2018-02-16T10:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340742",
    "user": "https://github.com/embray"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_340743.json:
```json
{
    "body": "Replying to [comment:39 embray]:\n> I had already fixed those things...\n\nBut not in a branch on this ticket.\n\n> I'm not sure why this change:\n> \n> {{{\n> -        elif err == ERR_OVERFLOW:\n> +        elif isinstance(x, long):\n> }}}\n\n> Why a relatively slow `isinstance`\n\nFirst of all, it's not at all slow. This uses `PyLong_Check()` which has an optimized code path:\n\n```C\n#define PyLong_Check(op) \\\n        PyType_FastSubclass(Py_TYPE(op), Py_TPFLAGS_LONG_SUBCLASS)\n```\n\nThis shouldn't take any measurable time.\n\nThe reason that I changed it is because I want to check the actual condition that I need: it must be an actual Python `long` since that is what `mpz_set_pylong` takes (without checking). It is really just an extra safety check.",
    "created_at": "2018-02-16T13:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340743",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:39 embray]:
> I had already fixed those things...

But not in a branch on this ticket.

> I'm not sure why this change:
> 
> {{{
> -        elif err == ERR_OVERFLOW:
> +        elif isinstance(x, long):
> }}}

> Why a relatively slow `isinstance`

First of all, it's not at all slow. This uses `PyLong_Check()` which has an optimized code path:

```C
#define PyLong_Check(op) \
        PyType_FastSubclass(Py_TYPE(op), Py_TPFLAGS_LONG_SUBCLASS)
```

This shouldn't take any measurable time.

The reason that I changed it is because I want to check the actual condition that I need: it must be an actual Python `long` since that is what `mpz_set_pylong` takes (without checking). It is really just an extra safety check.



---

archive/issue_comments_340744.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2018-02-16T13:58:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340744",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_340745.json:
```json
{
    "body": "I think by the time I pushed my fixes you changed it to your branch.\n\nI see now, upon closer inspection, that `integer_check_long_py` does *not* set `err = ERR_TYPE` if it was not passed an int/long.  So indeed in that case this additional check would be needed.  But I think that's a defect in `integer_check_long_py`.  It has *already* checked whether or not the argument is a `long`, so if it fails that check (as well as the `int` check) it should set `err=ERR_TYPE`.  Then the additional `isinstance(...)` (fast or not--it's not micro-optimization I'm concerned with here) is unnecessary.",
    "created_at": "2018-02-21T11:49:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340745",
    "user": "https://github.com/embray"
}
```

I think by the time I pushed my fixes you changed it to your branch.

I see now, upon closer inspection, that `integer_check_long_py` does *not* set `err = ERR_TYPE` if it was not passed an int/long.  So indeed in that case this additional check would be needed.  But I think that's a defect in `integer_check_long_py`.  It has *already* checked whether or not the argument is a `long`, so if it fails that check (as well as the `int` check) it should set `err=ERR_TYPE`.  Then the additional `isinstance(...)` (fast or not--it's not micro-optimization I'm concerned with here) is unnecessary.



---

archive/issue_comments_340746.json:
```json
{
    "body": "While you're at it, one (small) gripe I have with `integer_check_long(_py)` is that it requires a non-NULL err argument at all.  There are times I've used it where I didn't need the `err` value at all, and it would be nice if it could accept a NULL pointer (and in that case just not set the error).",
    "created_at": "2018-02-21T11:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340746",
    "user": "https://github.com/embray"
}
```

While you're at it, one (small) gripe I have with `integer_check_long(_py)` is that it requires a non-NULL err argument at all.  There are times I've used it where I didn't need the `err` value at all, and it would be nice if it could accept a NULL pointer (and in that case just not set the error).



---

archive/issue_comments_340747.json:
```json
{
    "body": "To be honest, it was not easy to decide the API for `integer_check_long(_py)`. My idea was to look at various use cases and then maybe reconsider how the API should be done.\n\nBut that shouldn't affect the status of this ticket.",
    "created_at": "2018-02-21T13:21:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340747",
    "user": "https://github.com/jdemeyer"
}
```

To be honest, it was not easy to decide the API for `integer_check_long(_py)`. My idea was to look at various use cases and then maybe reconsider how the API should be done.

But that shouldn't affect the status of this ticket.



---

archive/issue_comments_340748.json:
```json
{
    "body": "Replying to [comment:42 embray]:\n> There are times I've used it where I didn't need the `err` value at all\n\nThen the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.",
    "created_at": "2018-02-22T08:39:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340748",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:42 embray]:
> There are times I've used it where I didn't need the `err` value at all

Then the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.



---

archive/issue_comments_340749.json:
```json
{
    "body": "Replying to [comment:44 jdemeyer]:\n> Replying to [comment:42 embray]:\n> > There are times I've used it where I didn't need the `err` value at all\n> \n> Then the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.\n\nPerhaps you're right. I definitely remember times during development where I wanted this, but I think maybe it was only while testing things and ignoring the error value.  Unless a specific example comes up again I won't worry about it.\n\nThe other thing I would still change.  It doesn't make sense to have a superfluous `isinstance(..., long)` there.  A small fix to `integer_check_long_py` would make more sense.",
    "created_at": "2018-02-22T16:04:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340749",
    "user": "https://github.com/embray"
}
```

Replying to [comment:44 jdemeyer]:
> Replying to [comment:42 embray]:
> > There are times I've used it where I didn't need the `err` value at all
> 
> Then the only information that you have is that the object is an integer of some sort where you don't care about its value. To me, that sounds unlikely so I wonder where it came up.

Perhaps you're right. I definitely remember times during development where I wanted this, but I think maybe it was only while testing things and ignoring the error value.  Unless a specific example comes up again I won't worry about it.

The other thing I would still change.  It doesn't make sense to have a superfluous `isinstance(..., long)` there.  A small fix to `integer_check_long_py` would make more sense.



---

archive/issue_comments_340750.json:
```json
{
    "body": "Replying to [comment:45 embray]:\n> It doesn't make sense to have a superfluous `isinstance(..., long)` there.\n\nI think it does make sense. It doesn't hurt and it's a safety net against calling `mpz_set_pylong` with a non-`long` which could potentially segfault Python.",
    "created_at": "2018-02-22T16:07:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340750",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:45 embray]:
> It doesn't make sense to have a superfluous `isinstance(..., long)` there.

I think it does make sense. It doesn't hurt and it's a safety net against calling `mpz_set_pylong` with a non-`long` which could potentially segfault Python.



---

archive/issue_comments_340751.json:
```json
{
    "body": "Please re-read #24588#comment:41.\n\nThe (as you wrote, somewhat loose to begin with) API for `integer_check_long_py` doesn't make a whole lot of sense. It already checks `isinstance(x, long)` and should probably set the relevant error in that case.",
    "created_at": "2018-02-22T16:22:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340751",
    "user": "https://github.com/embray"
}
```

Please re-read #24588#comment:41.

The (as you wrote, somewhat loose to begin with) API for `integer_check_long_py` doesn't make a whole lot of sense. It already checks `isinstance(x, long)` and should probably set the relevant error in that case.



---

archive/issue_comments_340752.json:
```json
{
    "body": "The following small change is all I'm suggesting.  This brings the API for `integer_check_long_py` more in line with the general `integer_check_long`, which to me makes much more sense, especially since it seems `integer_check_long_py` is more useful on its own than you maybe initially intended.  You are willing to take it, or leave it if you still disagree.\n----\nNew commits:",
    "created_at": "2018-02-22T17:11:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340752",
    "user": "https://github.com/embray"
}
```

The following small change is all I'm suggesting.  This brings the API for `integer_check_long_py` more in line with the general `integer_check_long`, which to me makes much more sense, especially since it seems `integer_check_long_py` is more useful on its own than you maybe initially intended.  You are willing to take it, or leave it if you still disagree.
----
New commits:



---

archive/issue_comments_340753.json:
```json
{
    "body": "I don't agree entirely with this change:\n\n```diff\n@@ -176,10 +176,11 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:\n             err[0] = ERR_OVERFLOW\n         return 1\n     elif PyIndex_Check(x):\n-        err[0] = ERR_INDEX\n+        err[0] = 0\n         try:\n             x = PyNumber_Index(x)\n         except TypeError:\n+            err[0] = ERR_INDEX\n             return 0\n         return integer_check_long_py(x, value, err)\n     else:\n```\n\nIt seems safer and more natural to set `err[0] = ERR_INDEX` whenever any exception in `__index__` occurs. In any case, setting `err[0] = 0` is pointless because `integer_check_long_py()` is now guaranteed to set `err[0]` to some value.\n\nI just reverted that. If you agree, you can set positive review.",
    "created_at": "2018-02-23T09:12:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340753",
    "user": "https://github.com/jdemeyer"
}
```

I don't agree entirely with this change:

```diff
@@ -176,10 +176,11 @@ cdef inline bint integer_check_long(x, long* value, int* err) except -1:
             err[0] = ERR_OVERFLOW
         return 1
     elif PyIndex_Check(x):
-        err[0] = ERR_INDEX
+        err[0] = 0
         try:
             x = PyNumber_Index(x)
         except TypeError:
+            err[0] = ERR_INDEX
             return 0
         return integer_check_long_py(x, value, err)
     else:
```

It seems safer and more natural to set `err[0] = ERR_INDEX` whenever any exception in `__index__` occurs. In any case, setting `err[0] = 0` is pointless because `integer_check_long_py()` is now guaranteed to set `err[0]` to some value.

I just reverted that. If you agree, you can set positive review.



---

archive/issue_comments_340754.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-02-23T14:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340754",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_340755.json:
```json
{
    "body": "Yep, I think I was misunderstanding what `ERR_INDEX` was supposed to be. Finally we've reached an agreement :)\n----\nNew commits:",
    "created_at": "2018-02-23T14:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340755",
    "user": "https://github.com/embray"
}
```

Yep, I think I was misunderstanding what `ERR_INDEX` was supposed to be. Finally we've reached an agreement :)
----
New commits:



---

archive/issue_comments_340756.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-02-25T20:00:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/24351",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/24351#issuecomment-340756",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
