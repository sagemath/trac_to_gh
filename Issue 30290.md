# Issue 30290: Create PEP 503 simple repository for wheels built during installation

archive/issues_030290.json:
```json
{
    "body": "CC:  @slel @tobiasdiez @embray @jhpalmieri\n\nAs a follow-up to #29500 (Install all Python packages via `pip wheel`, store wheels in `$SAGE_LOCAL/var/lib/sage/wheels`):\n\nWe create a PEP 503 compliant Simple Repository index in `$SAGE_SPKG_WHEELS`. Then users can create their virtual environment using tools such as `pipenv` `[This is the Trac macro *source* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#source-macro)` or `pip install --index-url`.\n\n-------\n\nReferences:\n\n- https://github.com/pytorch/pytorch/issues/25639 \"Implement pep 503 Simple Repository API for deployment\"\n\n- https://pypi.org/project/piprepo/ - create PEP 503 package repo\n\n- https://stackoverflow.com/questions/45744937/how-do-install-packages-from-a-local-python-package-index\n\n- https://pipenv-fork.readthedocs.io/en/latest/advanced.html#specifying-package-indexes\n\nIssue created by migration from https://trac.sagemath.org/ticket/30527\n\n",
    "created_at": "2020-09-08T05:28:59Z",
    "labels": [
        "build",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-wishlist",
    "title": "Create PEP 503 simple repository for wheels built during installation",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30290",
    "user": "@mkoeppe"
}
```
CC:  @slel @tobiasdiez @embray @jhpalmieri

As a follow-up to #29500 (Install all Python packages via `pip wheel`, store wheels in `$SAGE_LOCAL/var/lib/sage/wheels`):

We create a PEP 503 compliant Simple Repository index in `$SAGE_SPKG_WHEELS`. Then users can create their virtual environment using tools such as `pipenv` `[This is the Trac macro *source* that was inherited from the migration](https://trac.sagemath.org/wiki/WikiMacros#source-macro)` or `pip install --index-url`.

-------

References:

- https://github.com/pytorch/pytorch/issues/25639 "Implement pep 503 Simple Repository API for deployment"

- https://pypi.org/project/piprepo/ - create PEP 503 package repo

- https://stackoverflow.com/questions/45744937/how-do-install-packages-from-a-local-python-package-index

- https://pipenv-fork.readthedocs.io/en/latest/advanced.html#specifying-package-indexes

Issue created by migration from https://trac.sagemath.org/ticket/30527





---

archive/issue_comments_431847.json:
```json
{
    "body": "`piprepo` can be used for this task, but it has excessive dependencies",
    "created_at": "2020-09-08T05:36:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431847",
    "user": "@mkoeppe"
}
```

`piprepo` can be used for this task, but it has excessive dependencies



---

archive/issue_comments_431848.json:
```json
{
    "body": "There is also pypiserver, see eg https://stackoverflow.com/a/51528588/873661 for how to use it with pipenv",
    "created_at": "2020-09-08T09:04:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431848",
    "user": "@tobiasdiez"
}
```

There is also pypiserver, see eg https://stackoverflow.com/a/51528588/873661 for how to use it with pipenv



---

archive/issue_comments_431849.json:
```json
{
    "body": "Well, we don't want to run a server for this, but following this link I found https://github.com/wolever/pip2pi",
    "created_at": "2020-09-08T17:40:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431849",
    "user": "@mkoeppe"
}
```

Well, we don't want to run a server for this, but following this link I found https://github.com/wolever/pip2pi



---

archive/issue_comments_431850.json:
```json
{
    "body": "Yeah I agree, a server is not required (although the overhead of creating a simple server on listing on localhost should be pretty minimal). If pip2pi works with pipenv and pip, then that's perfect!",
    "created_at": "2020-09-08T19:35:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431850",
    "user": "@tobiasdiez"
}
```

Yeah I agree, a server is not required (although the overhead of creating a simple server on listing on localhost should be pretty minimal). If pip2pi works with pipenv and pip, then that's perfect!



---

archive/issue_comments_431851.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-09-08T22:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431851",
    "user": "@mkoeppe"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_431852.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-09-08T22:57:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431852",
    "user": "@mkoeppe"
}
```

New commits:



---

archive/issue_comments_431853.json:
```json
{
    "body": "What is the reason that sage needs to build wheels for standard packages, and not just downloads them from pypi?\n\nIs it because some packages have patches applied? In this case, I would propose to migrate these patches to proper forks of the packages which are then published to pypi including their wheel. This has a few advantages, mainly that the build of sage is speedup and simplified, and that the wider python community can profit from these patches.\n\nWhat do you think?",
    "created_at": "2020-09-09T07:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431853",
    "user": "@tobiasdiez"
}
```

What is the reason that sage needs to build wheels for standard packages, and not just downloads them from pypi?

Is it because some packages have patches applied? In this case, I would propose to migrate these patches to proper forks of the packages which are then published to pypi including their wheel. This has a few advantages, mainly that the build of sage is speedup and simplified, and that the wider python community can profit from these patches.

What do you think?



---

archive/issue_comments_431854.json:
```json
{
    "body": "Replying to [comment:10 gh-tobiasdiez]:\n> What is the reason that sage needs to build wheels for standard packages, and not just downloads them from pypi?\n\nSage-the-distribution is a deployment mechanism.  Compiling all packages from source gives us full control and eliminates possible ABI problems from mixing prebuilt wheels that were compiled on different systems. Building from source also has advantages such as generating architecture-specific code (see #27122). \n\n> Is it because some packages have patches applied?\n\nIn some cases, yes, in other cases, just specific configuration.\n\n> In this case, I would propose to migrate these patches to proper forks of the packages which are then published to pypi including their wheel. This has a few advantages, mainly that the build of sage is speedup and simplified, and that the wider python community can profit from these patches.\n\nWe don't have intentions to take over maintenance of these packages. Whenever possible, we send our patches upstream. In many cases, it is just a matter of mismatched release schedules, and we have to keep patches only for a limited time until upstream makes a new stable release including a particular patch. For example, consider the `numpy` patch added in #29766. It is actually from upstream, but not included in any stable release. But we need the patch because we want Sage-the-distribution to support a particular platform.",
    "created_at": "2020-09-09T15:20:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431854",
    "user": "@mkoeppe"
}
```

Replying to [comment:10 gh-tobiasdiez]:
> What is the reason that sage needs to build wheels for standard packages, and not just downloads them from pypi?

Sage-the-distribution is a deployment mechanism.  Compiling all packages from source gives us full control and eliminates possible ABI problems from mixing prebuilt wheels that were compiled on different systems. Building from source also has advantages such as generating architecture-specific code (see #27122). 

> Is it because some packages have patches applied?

In some cases, yes, in other cases, just specific configuration.

> In this case, I would propose to migrate these patches to proper forks of the packages which are then published to pypi including their wheel. This has a few advantages, mainly that the build of sage is speedup and simplified, and that the wider python community can profit from these patches.

We don't have intentions to take over maintenance of these packages. Whenever possible, we send our patches upstream. In many cases, it is just a matter of mismatched release schedules, and we have to keep patches only for a limited time until upstream makes a new stable release including a particular patch. For example, consider the `numpy` patch added in #29766. It is actually from upstream, but not included in any stable release. But we need the patch because we want Sage-the-distribution to support a particular platform.



---

archive/issue_comments_431855.json:
```json
{
    "body": "Thanks for the detailed explanation. Makes things clearer for me now.\n\n> Compiling all packages from source gives us full control and eliminates possible ABI problems from mixing prebuilt wheels that were compiled on different systems. Building from source also has advantages such as generating architecture-specific code\n\nBut isn't the concept of compile-once-reuse-often the main point of wheels? By design, it's the responsibility of the the maintainer (= publisher of the wheel) that the wheel is useable and optimized for the particular platforms they are published. This also make sense since she is the export of the code of the library.\n\nI feel none of the advantages of wheels outlined in https://www.python.org/dev/peps/pep-0427/ can really prove effective if wheels are rebuilt from code every time.\n> The wheel binary package format frees installers from having to know about the build system, saves time by amortizing compile time over many installations, and removes the need to install a build system in the target environment.\n\nIn my opinion, the build process of sage would immensely profit from all these advantages.\n\n\nAnyway, this discussion is somewhat orthogonal to this ticket (sorry!). So concerning the changes, the code looks good to me. I'm only wondering if the pip2 support in the uninstallation script is really necessary (since only python3 is supported now). However, I don't feel familiar enough with the build script to change the status to positive review.",
    "created_at": "2020-09-09T16:13:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431855",
    "user": "@tobiasdiez"
}
```

Thanks for the detailed explanation. Makes things clearer for me now.

> Compiling all packages from source gives us full control and eliminates possible ABI problems from mixing prebuilt wheels that were compiled on different systems. Building from source also has advantages such as generating architecture-specific code

But isn't the concept of compile-once-reuse-often the main point of wheels? By design, it's the responsibility of the the maintainer (= publisher of the wheel) that the wheel is useable and optimized for the particular platforms they are published. This also make sense since she is the export of the code of the library.

I feel none of the advantages of wheels outlined in https://www.python.org/dev/peps/pep-0427/ can really prove effective if wheels are rebuilt from code every time.
> The wheel binary package format frees installers from having to know about the build system, saves time by amortizing compile time over many installations, and removes the need to install a build system in the target environment.

In my opinion, the build process of sage would immensely profit from all these advantages.


Anyway, this discussion is somewhat orthogonal to this ticket (sorry!). So concerning the changes, the code looks good to me. I'm only wondering if the pip2 support in the uninstallation script is really necessary (since only python3 is supported now). However, I don't feel familiar enough with the build script to change the status to positive review.



---

archive/issue_comments_431856.json:
```json
{
    "body": "Replying to [comment:12 gh-tobiasdiez]:\n> But isn't the concept of compile-once-reuse-often the main point of wheels? By design, it's the responsibility of the the maintainer (= publisher of the wheel) that the wheel is useable and optimized for the particular platforms they are published. This also make sense since she is the export of the code of the library.\n\nIn practice, wheels are offered on PyPI with the broadest possible platform compatibility, typically using https://github.com/pypa/manylinux -- this is the opposite of \"optimized\".",
    "created_at": "2020-09-09T16:24:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431856",
    "user": "@mkoeppe"
}
```

Replying to [comment:12 gh-tobiasdiez]:
> But isn't the concept of compile-once-reuse-often the main point of wheels? By design, it's the responsibility of the the maintainer (= publisher of the wheel) that the wheel is useable and optimized for the particular platforms they are published. This also make sense since she is the export of the code of the library.

In practice, wheels are offered on PyPI with the broadest possible platform compatibility, typically using https://github.com/pypa/manylinux -- this is the opposite of "optimized".



---

archive/issue_comments_431857.json:
```json
{
    "body": "Replying to [comment:12 gh-tobiasdiez]:\n> I'm only wondering if the pip2 support in the uninstallation script is really necessary (since only python3 is supported now). \n\nYes, this should be removed, but I prefer to keep tickets narrowly focused. A separate ticket can do this.",
    "created_at": "2020-09-09T16:25:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431857",
    "user": "@mkoeppe"
}
```

Replying to [comment:12 gh-tobiasdiez]:
> I'm only wondering if the pip2 support in the uninstallation script is really necessary (since only python3 is supported now). 

Yes, this should be removed, but I prefer to keep tickets narrowly focused. A separate ticket can do this.



---

archive/issue_comments_431858.json:
```json
{
    "body": "Replying to [comment:12 gh-tobiasdiez]:\n> But isn't the concept of compile-once-reuse-often the main point of wheels? \n\nWheels are a format for deployment. Public distribution of wheels on a package index is one use case. Here on this ticket we use it for local deployment -- users can installs these wheels into their venvs.",
    "created_at": "2020-09-09T16:28:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431858",
    "user": "@mkoeppe"
}
```

Replying to [comment:12 gh-tobiasdiez]:
> But isn't the concept of compile-once-reuse-often the main point of wheels? 

Wheels are a format for deployment. Public distribution of wheels on a package index is one use case. Here on this ticket we use it for local deployment -- users can installs these wheels into their venvs.



---

archive/issue_comments_431859.json:
```json
{
    "body": "Replying to [comment:12 gh-tobiasdiez]:\n> I feel none of the advantages of wheels outlined in https://www.python.org/dev/peps/pep-0427/ can really prove effective if wheels are rebuilt from code every time. [...]\n> In my opinion, the build process of sage would immensely profit from all these advantages.\n\nI prefer to think about this not as a question of improving \"the\" build process of sage, but to offer more options for building sage. This is for example also the purpose of the modularization plan outlined in #29705 - make modularized parts of the Sage library deployable via PyPI.",
    "created_at": "2020-09-09T16:51:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431859",
    "user": "@mkoeppe"
}
```

Replying to [comment:12 gh-tobiasdiez]:
> I feel none of the advantages of wheels outlined in https://www.python.org/dev/peps/pep-0427/ can really prove effective if wheels are rebuilt from code every time. [...]
> In my opinion, the build process of sage would immensely profit from all these advantages.

I prefer to think about this not as a question of improving "the" build process of sage, but to offer more options for building sage. This is for example also the purpose of the modularization plan outlined in #29705 - make modularized parts of the Sage library deployable via PyPI.



---

archive/issue_comments_431860.json:
```json
{
    "body": "Replying to [comment:14 mkoeppe]:\n> Replying to [comment:12 gh-tobiasdiez]:\n> > I'm only wondering if the pip2 support in the uninstallation script is really necessary (since only python3 is supported now). \n> \n> Yes, this should be removed, but I prefer to keep tickets narrowly focused. A separate ticket can do this.\n\nIt's added in the new file `sage-pip-uninstall`.",
    "created_at": "2020-09-09T16:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431860",
    "user": "@tobiasdiez"
}
```

Replying to [comment:14 mkoeppe]:
> Replying to [comment:12 gh-tobiasdiez]:
> > I'm only wondering if the pip2 support in the uninstallation script is really necessary (since only python3 is supported now). 
> 
> Yes, this should be removed, but I prefer to keep tickets narrowly focused. A separate ticket can do this.

It's added in the new file `sage-pip-uninstall`.



---

archive/issue_comments_431861.json:
```json
{
    "body": "Ok, I'll clean it up - but in #29500 (dependency of this ticket)",
    "created_at": "2020-09-09T17:19:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431861",
    "user": "@mkoeppe"
}
```

Ok, I'll clean it up - but in #29500 (dependency of this ticket)



---

archive/issue_comments_431862.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-09T17:27:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431862",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431863.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-09-21T22:11:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431863",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431864.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-11-11T02:38:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431864",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_431865.json:
```json
{
    "body": "Rebased, needs review",
    "created_at": "2020-11-11T02:39:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431865",
    "user": "@mkoeppe"
}
```

Rebased, needs review



---

archive/issue_comments_431866.json:
```json
{
    "body": "LGTM!",
    "created_at": "2020-11-27T11:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431866",
    "user": "@tobiasdiez"
}
```

LGTM!



---

archive/issue_comments_431867.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-11-27T11:00:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431867",
    "user": "@tobiasdiez"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_431868.json:
```json
{
    "body": "Thank you!",
    "created_at": "2020-11-27T18:33:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431868",
    "user": "@mkoeppe"
}
```

Thank you!



---

archive/issue_comments_431869.json:
```json
{
    "body": "Looks like some script is silently ignoring errors (and there is an error, too):\n\n```\n$ ./sage -i pip2pi\n[...]\n[sagelib-9.3.beta2] Finished cleaning, time: 0.15 seconds.\n[sagelib-9.3.beta2] \n[sagelib-9.3.beta2] real\t0m2.307s\n[sagelib-9.3.beta2] user\t0m1.765s\n[sagelib-9.3.beta2] sys\t0m0.539s\ntouch \"/home/release/Sage/local/var/lib/sage/installed/sagelib-9.3.beta2\"\nmake[1]: Leaving directory '/home/release/Sage/build/make'\n\nreal\t0m4.280s\nuser\t0m3.292s\nsys\t0m0.942s\nTraceback (most recent call last):\n  File \"/home/release/Sage/local/bin/dir2pi\", line 8, in <module>\n    sys.exit(dir2pi())\n  File \"/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py\", line 308, in dir2pi\n    return _dir2pi(option, argv)\n  File \"/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py\", line 377, in _dir2pi\n    cgi.escape(pkg_dir_name),\nAttributeError: module 'cgi' has no attribute 'escape'\nSage build/upgrade complete!\n```\n\nAlso docbuild fails on buildbots but not on my machine with\n\n```\n[dochtml] [spkg     ] building [inventory]: targets for 271 source files that are out of date\n[dochtml] [spkg     ] updating environment: [new config] 271 added, 0 changed, 0 removed\n[dochtml] [spkg     ] /Users/buildbot-sage/slave/sage_git/build/src/doc/en/reference/spkg/pip2pi.rst: WARNING: document isn't included in any toctree\n[dochtml] [spkg     ] The inventory files are in local/share/doc/sage/inventory/en/reference/spkg.\n[dochtml] Error building the documentation.\n[dochtml] Traceback (most recent call last):\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/runpy.py\", line 194, in _run_module_as_main\n[dochtml]     return _run_code(code, main_globals, None,\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/runpy.py\", line 87, in _run_code\n[dochtml]     exec(code, run_globals)\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__main__.py\", line 2, in <module>\n[dochtml]     main()\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py\", line 1730, in main\n[dochtml]     builder()\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py\", line 343, in _wrapper\n[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py\", line 569, in _wrapper\n[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py\", line 555, in _build_everything_except_bibliography\n[dochtml]     build_many(build_ref_doc, non_references)\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py\", line 295, in build_many\n[dochtml]     _build_many(target, args, processes=NUM_THREADS)\n[dochtml]   File \"/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/utils.py\", line 289, in build_many\n[dochtml]     raise worker_exc.original_exception\n[dochtml] OSError: /Users/buildbot-sage/slave/sage_git/build/src/doc/en/reference/spkg/pip2pi.rst: WARNING: document isn't included in any toctree\nmake[1]: *** [doc-html-mathjax] Error 1\n```\n",
    "created_at": "2020-12-05T11:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431869",
    "user": "@vbraun"
}
```

Looks like some script is silently ignoring errors (and there is an error, too):

```
$ ./sage -i pip2pi
[...]
[sagelib-9.3.beta2] Finished cleaning, time: 0.15 seconds.
[sagelib-9.3.beta2] 
[sagelib-9.3.beta2] real	0m2.307s
[sagelib-9.3.beta2] user	0m1.765s
[sagelib-9.3.beta2] sys	0m0.539s
touch "/home/release/Sage/local/var/lib/sage/installed/sagelib-9.3.beta2"
make[1]: Leaving directory '/home/release/Sage/build/make'

real	0m4.280s
user	0m3.292s
sys	0m0.942s
Traceback (most recent call last):
  File "/home/release/Sage/local/bin/dir2pi", line 8, in <module>
    sys.exit(dir2pi())
  File "/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py", line 308, in dir2pi
    return _dir2pi(option, argv)
  File "/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py", line 377, in _dir2pi
    cgi.escape(pkg_dir_name),
AttributeError: module 'cgi' has no attribute 'escape'
Sage build/upgrade complete!
```

Also docbuild fails on buildbots but not on my machine with

```
[dochtml] [spkg     ] building [inventory]: targets for 271 source files that are out of date
[dochtml] [spkg     ] updating environment: [new config] 271 added, 0 changed, 0 removed
[dochtml] [spkg     ] /Users/buildbot-sage/slave/sage_git/build/src/doc/en/reference/spkg/pip2pi.rst: WARNING: document isn't included in any toctree
[dochtml] [spkg     ] The inventory files are in local/share/doc/sage/inventory/en/reference/spkg.
[dochtml] Error building the documentation.
[dochtml] Traceback (most recent call last):
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/runpy.py", line 194, in _run_module_as_main
[dochtml]     return _run_code(code, main_globals, None,
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/runpy.py", line 87, in _run_code
[dochtml]     exec(code, run_globals)
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__main__.py", line 2, in <module>
[dochtml]     main()
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 1730, in main
[dochtml]     builder()
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 343, in _wrapper
[dochtml]     getattr(get_builder(document), 'inventory')(*args, **kwds)
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 569, in _wrapper
[dochtml]     self._build_everything_except_bibliography(lang, format, *args, **kwds)
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 555, in _build_everything_except_bibliography
[dochtml]     build_many(build_ref_doc, non_references)
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/__init__.py", line 295, in build_many
[dochtml]     _build_many(target, args, processes=NUM_THREADS)
[dochtml]   File "/Users/buildbot-sage/slave/sage_git/build/local/lib/python3.8/site-packages/sage_setup/docbuild/utils.py", line 289, in build_many
[dochtml]     raise worker_exc.original_exception
[dochtml] OSError: /Users/buildbot-sage/slave/sage_git/build/src/doc/en/reference/spkg/pip2pi.rst: WARNING: document isn't included in any toctree
make[1]: *** [doc-html-mathjax] Error 1
```




---

archive/issue_comments_431870.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2020-12-05T11:49:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431870",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_431871.json:
```json
{
    "body": "Replying to [comment:27 vbraun]:\n> Looks like some script is silently ignoring errors (and there is an error, too):\n> {{{\n> $ ./sage -i pip2pi\n> [...]\n> [sagelib-9.3.beta2] Finished cleaning, time: 0.15 seconds.\n> [sagelib-9.3.beta2] \n> [sagelib-9.3.beta2] real\t0m2.307s\n> [sagelib-9.3.beta2] user\t0m1.765s\n> [sagelib-9.3.beta2] sys\t0m0.539s\n> touch \"/home/release/Sage/local/var/lib/sage/installed/sagelib-9.3.beta2\"\n> make[1]: Leaving directory '/home/release/Sage/build/make'\n> \n> real\t0m4.280s\n> user\t0m3.292s\n> sys\t0m0.942s\n> Traceback (most recent call last):\n>   File \"/home/release/Sage/local/bin/dir2pi\", line 8, in <module>\n>     sys.exit(dir2pi())\n>   File \"/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py\", line 308, in dir2pi\n>     return _dir2pi(option, argv)\n>   File \"/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py\", line 377, in _dir2pi\n>     cgi.escape(pkg_dir_name),\n> AttributeError: module 'cgi' has no attribute 'escape'\n> Sage build/upgrade complete!\n> }}}\n\nLooks like this package is not ready for Python 3.8, https://github.com/wolever/pip2pi/issues/111",
    "created_at": "2020-12-05T18:59:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431871",
    "user": "@mkoeppe"
}
```

Replying to [comment:27 vbraun]:
> Looks like some script is silently ignoring errors (and there is an error, too):
> {{{
> $ ./sage -i pip2pi
> [...]
> [sagelib-9.3.beta2] Finished cleaning, time: 0.15 seconds.
> [sagelib-9.3.beta2] 
> [sagelib-9.3.beta2] real	0m2.307s
> [sagelib-9.3.beta2] user	0m1.765s
> [sagelib-9.3.beta2] sys	0m0.539s
> touch "/home/release/Sage/local/var/lib/sage/installed/sagelib-9.3.beta2"
> make[1]: Leaving directory '/home/release/Sage/build/make'
> 
> real	0m4.280s
> user	0m3.292s
> sys	0m0.942s
> Traceback (most recent call last):
>   File "/home/release/Sage/local/bin/dir2pi", line 8, in <module>
>     sys.exit(dir2pi())
>   File "/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py", line 308, in dir2pi
>     return _dir2pi(option, argv)
>   File "/home/release/Sage/local/lib64/python3.8/site-packages/libpip2pi/commands.py", line 377, in _dir2pi
>     cgi.escape(pkg_dir_name),
> AttributeError: module 'cgi' has no attribute 'escape'
> Sage build/upgrade complete!
> }}}

Looks like this package is not ready for Python 3.8, https://github.com/wolever/pip2pi/issues/111



---

archive/issue_comments_431872.json:
```json
{
    "body": "https://github.com/wolever/pip2pi/pull/106",
    "created_at": "2020-12-05T19:00:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431872",
    "user": "@mkoeppe"
}
```

https://github.com/wolever/pip2pi/pull/106



---

archive/issue_comments_431873.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-06T04:49:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431873",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431874.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-12-06T04:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431874",
    "user": "@mkoeppe"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_431875.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-12-06T04:57:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431875",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_431876.json:
```json
{
    "body": "Replying to [comment:27 vbraun]:\n> Also docbuild fails on buildbots but not on my machine with\n> {{{\n> [dochtml] [spkg     ] /Users/buildbot-sage/slave/sage_git/build/src/doc/en/reference/spkg/pip2pi.rst: WARNING: document isn't included in any toctree\n> }}}\nTo debug this on the affected buildbots, it should be checked whether the file `index.rst` in the same directory is generated correctly by `bootstrap`.",
    "created_at": "2020-12-06T04:59:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431876",
    "user": "@mkoeppe"
}
```

Replying to [comment:27 vbraun]:
> Also docbuild fails on buildbots but not on my machine with
> {{{
> [dochtml] [spkg     ] /Users/buildbot-sage/slave/sage_git/build/src/doc/en/reference/spkg/pip2pi.rst: WARNING: document isn't included in any toctree
> }}}
To debug this on the affected buildbots, it should be checked whether the file `index.rst` in the same directory is generated correctly by `bootstrap`.



---

archive/issue_comments_431877.json:
```json
{
    "body": "Changing keywords from \"\" to \"sd111\".",
    "created_at": "2020-12-06T17:45:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431877",
    "user": "@mkoeppe"
}
```

Changing keywords from "" to "sd111".



---

archive/issue_comments_431878.json:
```json
{
    "body": "Waiting for review",
    "created_at": "2020-12-22T06:29:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431878",
    "user": "@mkoeppe"
}
```

Waiting for review



---

archive/issue_comments_431879.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431879",
    "user": "@mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_431880.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431880",
    "user": "@mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_431881.json:
```json
{
    "body": "I tried `make pip2pi` (after rebasing to the latest beta), and although the package built, I got an error message afterwards:\n\n```\n[pip2pi-0.8.1] Finished installing pip2pi-0.8.1\n\nreal\t0m33.466s\nuser\t0m3.670s\nsys\t0m1.412s\nTraceback (most recent call last):\n  File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/bin/dir2pi\", line 8, in <module>\n    sys.exit(dir2pi())\n  File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/lib/python3.9/site-packages/libpip2pi/commands.py\", line 312, in dir2pi\n    return _dir2pi(option, argv)\n  File \"/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/lib/python3.9/site-packages/libpip2pi/commands.py\", line 340, in _dir2pi\n    raise ValueError(\"no such directory: %r\" %(pkgdir, ))\nValueError: no such directory: ''\nError updating PEP 503 simple repository index\nmake: *** [pip2pi] Error 1\n```\n",
    "created_at": "2021-09-30T18:40:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431881",
    "user": "@jhpalmieri"
}
```

I tried `make pip2pi` (after rebasing to the latest beta), and although the package built, I got an error message afterwards:

```
[pip2pi-0.8.1] Finished installing pip2pi-0.8.1

real	0m33.466s
user	0m3.670s
sys	0m1.412s
Traceback (most recent call last):
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/bin/dir2pi", line 8, in <module>
    sys.exit(dir2pi())
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/lib/python3.9/site-packages/libpip2pi/commands.py", line 312, in dir2pi
    return _dir2pi(option, argv)
  File "/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta2/local/lib/python3.9/site-packages/libpip2pi/commands.py", line 340, in _dir2pi
    raise ValueError("no such directory: %r" %(pkgdir, ))
ValueError: no such directory: ''
Error updating PEP 503 simple repository index
make: *** [pip2pi] Error 1
```




---

archive/issue_comments_431882.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-09-30T18:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431882",
    "user": "@mkoeppe"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_431883.json:
```json
{
    "body": "Thanks for testing. Looks like this now needs updating to the recent build system changes (probably the SAGE_LOCAL/SAGE_VENV split). There's no urgency to this ticket because I learned that one can use `--find-links` instead of `--index-url`. So I've changed the milestone",
    "created_at": "2021-09-30T18:43:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30290",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30290#issuecomment-431883",
    "user": "@mkoeppe"
}
```

Thanks for testing. Looks like this now needs updating to the recent build system changes (probably the SAGE_LOCAL/SAGE_VENV split). There's no urgency to this ticket because I learned that one can use `--find-links` instead of `--index-url`. So I've changed the milestone
