# Issue 33502: Migrate gitpod to conda

Issue created by migration from https://trac.sagemath.org/ticket/33739

Original creator: @tobiasdiez

Original creation time: 2022-04-21 11:13:05

CC:  mkoeppe dimpase isuruf

The current solution to prebuild the gitpod docker image using github actions does not work nicely, since prebuilds triggered shortly after a new release still use the old gitpod image (and it may take up to a few days until the new image is available). This is especially notable for the `develop` branch, which is the default entry point if you want to start a new branch on gitpod.

In this ticket, we migrate the gitpod config to use the conda environment, which is now generally stable enough for serious development (e.g. almost all tests pass). As a positive side effect, the gitpod config simplifies and startup times are considerably reduced.


---

Comment by git created at 2022-04-21 11:26:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2022-04-21 11:28:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @tobiasdiez created at 2022-04-21 12:11:19

Changing status from new to needs_review.


---

Comment by git created at 2022-05-09 22:54:38

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by @tobiasdiez created at 2022-05-10 19:24:54

This is now using the latest version of #33740, so ready for review again.


---

Comment by mkoeppe created at 2022-05-10 19:32:47

I don't know if it's a good idea to make this change because it means that gitpod can no longer be used for trying out package updates in the Sage distribution.

Too bad that Gitpod has decided that a project can only have one Gitpod configuration - an obvious design limitation


---

Comment by @tobiasdiez created at 2022-05-11 09:05:11

Can you not install the updated package manually using `make xyz`? But yes, there are a few things that might be harder to test in a conda environment. On the other hand, you also got a few new tools at your hand. For example, you can easily install specific versions of dependencies using conda.

I think its also not a good idea to optimize gitpod for package update tickets, they should only be a small subset of all tickets. And for those the conda-based gitpod works more reliable and has shorter startup times.


---

Comment by mkoeppe created at 2022-05-11 16:57:30

Replying to [comment:9 gh-tobiasdiez]:
> Can you not install the updated package manually using `make xyz`? 

As the documentation says - 
 "Note that ``make`` is not used at all. All dependencies
 (including all Python packages) are provided by conda. [...] this will invalidate the 
 use of any Sage-the-distribution commands such as ``sage -i``. Do not use them."


---

Comment by mkoeppe created at 2022-05-11 18:27:11

I think the way forward could be to work on the devcontainer ticket (#33671). There can be multiple devcontainers (we could have them for all the platforms that we generate Docker images for). This would be a good replacement for what gitpod right now offers in terms of testing package upgrades.

When done, I agree that switching gitpod to conda is a good idea. 

Also consider that both the conda stuff and the gitpod stuff are new -- for onboarding current developers, right now I think it's better if gitpod shows them something that is more familiar.


---

Comment by @tobiasdiez created at 2022-05-11 19:37:33

Replying to [comment:11 mkoeppe]:
> I think the way forward could be to work on the devcontainer ticket (#33671). There can be multiple devcontainers (we could have them for all the platforms that we generate Docker images for). This would be a good replacement for what gitpod right now offers in terms of testing package upgrades.

How would devcontainer help here? Gitpod doesn't support them yet and its not clear yet when they will and in which form; the linked github issue reads more like that the are considering this as a alternative syntax for their gitpod.yml file and not that they would offer prebuilds for all defined devcontainers.


---

Comment by @tobiasdiez created at 2022-05-11 19:38:18

Replying to [comment:10 mkoeppe]:
> Replying to [comment:9 gh-tobiasdiez]:
> > Can you not install the updated package manually using `make xyz`? 
> 
> As the documentation says - 
>  "Note that ``make`` is not used at all. All dependencies
>  (including all Python packages) are provided by conda. [...] this will invalidate the 
>  use of any Sage-the-distribution commands such as ``sage -i``. Do not use them."
>  

I just run `make pari` in the conda-based gitpod and it worked just fine.


---

Comment by mkoeppe created at 2022-05-11 19:43:21

Replying to [comment:12 gh-tobiasdiez]:
> Replying to [comment:11 mkoeppe]:
> > I think the way forward could be to work on the devcontainer ticket (#33671). There can be multiple devcontainers (we could have them for all the platforms that we generate Docker images for). This would be a good replacement for what gitpod right now offers in terms of testing package upgrades.
> 
> How would devcontainer help here?

If done right, it would make working on package upgrades almost as convenient as using gitpod. Sure, using local compilation (unless we orchestrate devcontainer prebuild), but convenient


---

Comment by @tobiasdiez created at 2022-05-11 20:38:20

Replying to [comment:14 mkoeppe]:
> Replying to [comment:12 gh-tobiasdiez]:
> > Replying to [comment:11 mkoeppe]:
> > > I think the way forward could be to work on the devcontainer ticket (#33671). There can be multiple devcontainers (we could have them for all the platforms that we generate Docker images for). This would be a good replacement for what gitpod right now offers in terms of testing package upgrades.
> > 
> > How would devcontainer help here?
> 
> If done right, it would make working on package upgrades almost as convenient as using gitpod. Sure, using local compilation (unless we orchestrate devcontainer prebuild), but convenient
> 

Even with a conda-based gitpod, you can simply deactivate the conda environment and run `configure && make`. This is pretty much a disposable devcontainer without prebuild.


---

Comment by mkoeppe created at 2022-05-11 20:59:38

Replying to [comment:15 gh-tobiasdiez]:
> Even with a conda-based gitpod, you can simply deactivate the conda environment and run `configure && make`. 

That's true, of course

> This is pretty much a disposable devcontainer without prebuild.

Well no, because it wouldn't even have a SAGE_LOCAL. So it offers nothing over just building the whole thing locally


---

Comment by @tobiasdiez created at 2022-05-12 10:04:52

The advantage would be that you can run whatever commands you want without worrying how it affects the rest of your system / the main installation of sage.

Anyway, I still think that package updates are only a small subset of all tickets and making them temporarily slightly less convenient to test with gitpod is a price worth paying if gitpod gets more useful for the rest of the tickets. Moreover, as you mention, gitpod support is new so developers can easily go back to whatever they were using before to test package updates until further improvements like #33671 are implemented.

It would be nice if this ticket could be merged before the sagedays so that I don't have to wait 5mins during my talk until the workspace started.


---

Comment by git created at 2022-05-13 22:15:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-15 15:09:08

Is it really starting up faster?


---

Comment by mkoeppe created at 2022-05-15 15:19:47

Regression: The SageMath jupyter kernel cannot be selected (Command Palette - Create: New Jupyter Notebook, then "Select Kernel" in the upper right corner)


---

Comment by mkoeppe created at 2022-05-15 16:54:44

Changing status from needs_review to needs_work.


---

Comment by @tobiasdiez created at 2022-05-15 18:24:12

Replying to [comment:19 mkoeppe]:
> Is it really starting up faster?

yes for me its <1 min until the workspace is started.


---

Comment by mkoeppe created at 2022-05-15 18:26:25

I haven't timed it but here it took much longer than that. I'll use the timer to get more data later.


---

Comment by @tobiasdiez created at 2022-05-15 18:26:48

Replying to [comment:20 mkoeppe]:
> Regression: The SageMath jupyter kernel cannot be selected (Command Palette - Create: New Jupyter Notebook, then "Select Kernel" in the upper right corner)

I can select the correct "venv" there, what are you missing?


---

Comment by mkoeppe created at 2022-05-15 18:34:10

Missing the "SageMath" kernel (not the IPython kernel).


---

Comment by @tobiasdiez created at 2022-05-15 19:48:07

How is this supposed to work? I found `src/sage_setup/command/sage_install.py` which installs the jupyter kernel but is only referenced in the `install` hook in `setup.py` and thus not invoked for editable installs. So this doesn't seem specific to the conda or github setup. What do I miss?


---

Comment by mkoeppe created at 2022-05-15 19:50:36

I think currently it is working because sagelib is first installed without `--enable-editable` in the image.


---

Comment by mkoeppe created at 2022-05-15 19:52:18

Let's add it in #33855.


---

Comment by git created at 2022-05-16 20:44:57

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-16 20:45:16

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-16 23:13:14

Of course by itself #33855 doesn't fix it -- the same line in spkg-install needs to be run manually...


---

Comment by mkoeppe created at 2022-05-16 23:13:14

Changing status from needs_review to needs_work.


---

Comment by git created at 2022-05-18 16:57:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2022-05-18 16:57:37

Rolled back the merge and merged the new version of #33855.


---

Comment by mkoeppe created at 2022-05-18 16:57:37

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-05-18 19:16:34

Now the kernel is available


---

Comment by mkoeppe created at 2022-05-18 19:26:48

I haven't tested it thoroughly, but it looks like a nice improvement. It does start faster than the previous solution using our huge prebuilt Docker images.


---

Comment by mkoeppe created at 2022-05-18 19:26:48

Changing status from needs_review to positive_review.


---

Comment by @tobiasdiez created at 2022-05-18 20:04:38

Thanks!


---

Comment by vbraun created at 2022-05-22 16:33:00

Merge failure on top of:

054e8ed8d9 Trac #33316: Drop support for GCC < 6.3 in Sage 9.7

fa3b529c41 Trac #25833: Upgrade to MathJax 3 and configure Sage

e2ebf445d0 Trac #33825: Use pytest-xdist to run pytest in parallel

b4009625f3 Trac #33824: make gens and orbits of PermutationGroup immutable

af23627f18 Trac #33809: some pathlib in combinat and groups

955b5d994c Trac #33803: Fixes for the distributions sagemath-objects, sagemath-categories

3e6b41f7d6 Trac #33799: Replace SAGE_TMP in doctests of sage.misc.{persist,ostools}, sage.doctest, sage.repl

a3fd7185e3 Trac #33797: sage.misc.temporary_file: Remove use of SAGE_TMP

2ca053010a Trac #33794: modules/fp_graded/morphism.py test failure

7037fba482 Trac #33793: sage.misc.cython: Replace use of SPYX_TMP by a new cached function in sage.misc.temporary_file

d1152701c4 Trac #33787: Installation manual: Update section "system-wide install"

0ae55652cf Trac #33782: ci-cygwin: Update python version

833f53d1cc Trac #33779: Remove use of SAGE_TMP in sage.interfaces.latte

b376a8d71c Trac #33771: SSLContext needs an argument

df168c8112 Trac #33763: Refactor src/sage/docs

9597eafded Trac #33748: make accessing coefficients of finite-field elements easier

f02236f5b6 Trac #33744: Compute bases/circuits in MatroidUnion

8943dc07fc Trac #33743: Faster random tree generator

773ec37bec Trac #33740: Add conda dev environment

5e65c16108 Trac #33734: variety() for polynomial systems over ℚ using msolve

8e7dcca8d3 Trac #33733: allow to use flint for Stirling numbers

6f4efb0bf3 Updated [SageMath](SageMath) version to 9.7.beta0



merge was not clean: conflicts in .github/workflows/tox.yml


---

Comment by vbraun created at 2022-05-22 16:33:00

Changing status from positive_review to needs_work.


---

Comment by git created at 2022-05-27 19:34:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-05-27 19:34:38

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2022-05-29 11:29:09

Resolution: fixed
