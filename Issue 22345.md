# Issue 22345: Install python packages into py2 + py3

archive/issues_022345.json:
```json
{
    "body": "CC:  chapoton jdemeyer\n\nNow that we build both python2 and python3 we should install sage dependencies in both.\n\nIssue created by migration from https://trac.sagemath.org/ticket/22582\n\n",
    "created_at": "2017-03-11T10:46:42Z",
    "labels": [
        "python3",
        "major",
        "bug"
    ],
    "title": "Install python packages into py2 + py3",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/22345",
    "user": "vbraun"
}
```
CC:  chapoton jdemeyer

Now that we build both python2 and python3 we should install sage dependencies in both.

Issue created by migration from https://trac.sagemath.org/ticket/22582





---

archive/issue_comments_310622.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-03-18T15:51:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310622",
    "user": "vbraun"
}
```

New commits:



---

archive/issue_comments_310623.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-03-18T16:06:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310623",
    "user": "vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_310624.json:
```json
{
    "body": "\n```\n+    echo \"Skipping SageNB since it is not Python compatible\"\n```\n\nthis should say \"not Python3 compatible\"",
    "created_at": "2017-03-30T07:22:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310624",
    "user": "chapoton"
}
```


```
+    echo "Skipping SageNB since it is not Python compatible"
```

this should say "not Python3 compatible"



---

archive/issue_comments_310625.json:
```json
{
    "body": "ok, I did the small change I suggested\n----\nNew commits:",
    "created_at": "2017-04-01T20:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310625",
    "user": "chapoton"
}
```

ok, I did the small change I suggested
----
New commits:



---

archive/issue_comments_310626.json:
```json
{
    "body": "Thanks, sounds good to me.",
    "created_at": "2017-04-01T20:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310626",
    "user": "vbraun"
}
```

Thanks, sounds good to me.



---

archive/issue_comments_310627.json:
```json
{
    "body": "This looks good to me. But I do not quite dare to set a positive review, because I have not  tested that it does not break anything. Should I nevertheless set to positive, assuming that the buildbots will reveal any problem ?",
    "created_at": "2017-04-01T21:02:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310627",
    "user": "chapoton"
}
```

This looks good to me. But I do not quite dare to set a positive review, because I have not  tested that it does not break anything. Should I nevertheless set to positive, assuming that the buildbots will reveal any problem ?



---

archive/issue_comments_310628.json:
```json
{
    "body": "That would be the idea...",
    "created_at": "2017-04-01T21:52:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310628",
    "user": "vbraun"
}
```

That would be the idea...



---

archive/issue_comments_310629.json:
```json
{
    "body": "ok, then let us try",
    "created_at": "2017-04-02T08:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310629",
    "user": "chapoton"
}
```

ok, then let us try



---

archive/issue_comments_310630.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-02T08:20:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310630",
    "user": "chapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310631.json:
```json
{
    "body": "If I combine this ticket and its dependency, with SAGE_PYTHON3=yes, I get a failure on building cysignals:\n\n```\n[cysignals-1.3.2] config.status: executing build/src/cysignals/__init__.pxd commands\n[cysignals-1.3.2] Traceback (most recent call last):\n[cysignals-1.3.2]   File \"setup.py\", line 7, in <module>\n[cysignals-1.3.2]     from Cython.Build.Dependencies import cythonize\n[cysignals-1.3.2] ImportError: No module named Cython.Build.Dependencies\n[cysignals-1.3.2] Error: could not determine package name\n[cysignals-1.3.2] Error installing cysignals ... exiting\n```\n",
    "created_at": "2017-04-02T15:28:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310631",
    "user": "chapoton"
}
```

If I combine this ticket and its dependency, with SAGE_PYTHON3=yes, I get a failure on building cysignals:

```
[cysignals-1.3.2] config.status: executing build/src/cysignals/__init__.pxd commands
[cysignals-1.3.2] Traceback (most recent call last):
[cysignals-1.3.2]   File "setup.py", line 7, in <module>
[cysignals-1.3.2]     from Cython.Build.Dependencies import cythonize
[cysignals-1.3.2] ImportError: No module named Cython.Build.Dependencies
[cysignals-1.3.2] Error: could not determine package name
[cysignals-1.3.2] Error installing cysignals ... exiting
```




---

archive/issue_comments_310632.json:
```json
{
    "body": "This is because of \n\n```\n$ python setup.py --name\nTraceback (most recent call last):\n  File \"setup.py\", line 7, in <module>\n    from Cython.Build.Dependencies import cythonize\n```\n\ninside sage-pip-install. Cython is only installed into python3",
    "created_at": "2017-04-02T18:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310632",
    "user": "vbraun"
}
```

This is because of 

```
$ python setup.py --name
Traceback (most recent call last):
  File "setup.py", line 7, in <module>
    from Cython.Build.Dependencies import cythonize
```

inside sage-pip-install. Cython is only installed into python3



---

archive/issue_comments_310633.json:
```json
{
    "body": "Changing status from positive_review to needs_review.",
    "created_at": "2017-04-02T19:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310633",
    "user": "git"
}
```

Changing status from positive_review to needs_review.



---

archive/issue_comments_310634.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:",
    "created_at": "2017-04-02T19:50:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310634",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:



---

archive/issue_comments_310635.json:
```json
{
    "body": "If I try the latest branches for this ticket and its dependency with SAGE_PYTHON3=yes, it fails now on numpy:\n\n```\n[numpy-1.11.1.p0] Traceback (most recent call last):\n[numpy-1.11.1.p0]   File \"/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py\", line 3, in <module>\n[numpy-1.11.1.p0]     import pkgconfig, os\n[numpy-1.11.1.p0] ImportError: No module named pkgconfig\n```\n\nEDIT:\nThis is preceded by\n\n```\n[pkgconfig-1.2.2.p0] Successfully installed pkgconfig-1.2.2.p0\n```\n",
    "created_at": "2017-04-03T14:57:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310635",
    "user": "chapoton"
}
```

If I try the latest branches for this ticket and its dependency with SAGE_PYTHON3=yes, it fails now on numpy:

```
[numpy-1.11.1.p0] Traceback (most recent call last):
[numpy-1.11.1.p0]   File "/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py", line 3, in <module>
[numpy-1.11.1.p0]     import pkgconfig, os
[numpy-1.11.1.p0] ImportError: No module named pkgconfig
```

EDIT:
This is preceded by

```
[pkgconfig-1.2.2.p0] Successfully installed pkgconfig-1.2.2.p0
```




---

archive/issue_comments_310636.json:
```json
{
    "body": "Works for me... complete logs?",
    "created_at": "2017-04-03T17:09:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310636",
    "user": "vbraun"
}
```

Works for me... complete logs?



---

archive/issue_comments_310637.json:
```json
{
    "body": "Exact same thing with \"make build\" and SAGE_PYTHON3=yes on another computer. I did not use \"make dist-clean\". Which logs do you wanna see? The numpy log:\n\n```\nFound local metadata for numpy-1.11.1.p0\nUsing cached file /home/chapoton/sage3/upstream/numpy-1.11.1.tar.gz\nnumpy-1.11.1.p0\n====================================================\nSetting up build directory for numpy-1.11.1.p0\nFinished extraction\nApplying patches from ../patches...\nApplying ../patches/numpy-1.10.1-asarray_conversion.patch\npatching file numpy/core/function_base.py\nApplying ../patches/numpy-1.10.2-no-hardcode-blas.patch\npatching file numpy/distutils/system_info.py\nHunk #1 succeeded at 1685 (offset -5 lines).\nHunk #2 succeeded at 1718 (offset -4 lines).\nApplying ../patches/numpy-1.11.1-newlib-xlocale.patch\npatching file numpy/core/setup_common.py\npatching file numpy/core/src/multiarray/numpyos.c\n****************************************************\nHost system:\nLinux icj-laptop 4.8.0-45-generic #48-Ubuntu SMP Fri Mar 24 11:46:39 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\n****************************************************\nC compiler: gcc\nC compiler version:\nUsing built-in specs.\nCOLLECT_GCC=gcc\nCOLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/6/lto-wrapper\nTarget: x86_64-linux-gnu\nConfigured with: ../src/configure -v --with-pkgversion='Ubuntu 6.2.0-5ubuntu12' --with-bugurl=file:///usr/share/doc/gcc-6/README.Bugs --enable-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-6 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-6-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-6-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-6-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu\nThread model: posix\ngcc version 6.2.0 20161005 (Ubuntu 6.2.0-5ubuntu12) \n****************************************************\nTraceback (most recent call last):\n  File \"/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py\", line 3, in <module>\n    import pkgconfig, os\nImportError: No module named pkgconfig\n\nreal\t0m0.021s\nuser\t0m0.008s\nsys\t0m0.008s\n************************************************************************\nError installing package numpy-1.11.1.p0\n************************************************************************\n```\n",
    "created_at": "2017-04-03T20:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310637",
    "user": "chapoton"
}
```

Exact same thing with "make build" and SAGE_PYTHON3=yes on another computer. I did not use "make dist-clean". Which logs do you wanna see? The numpy log:

```
Found local metadata for numpy-1.11.1.p0
Using cached file /home/chapoton/sage3/upstream/numpy-1.11.1.tar.gz
numpy-1.11.1.p0
====================================================
Setting up build directory for numpy-1.11.1.p0
Finished extraction
Applying patches from ../patches...
Applying ../patches/numpy-1.10.1-asarray_conversion.patch
patching file numpy/core/function_base.py
Applying ../patches/numpy-1.10.2-no-hardcode-blas.patch
patching file numpy/distutils/system_info.py
Hunk #1 succeeded at 1685 (offset -5 lines).
Hunk #2 succeeded at 1718 (offset -4 lines).
Applying ../patches/numpy-1.11.1-newlib-xlocale.patch
patching file numpy/core/setup_common.py
patching file numpy/core/src/multiarray/numpyos.c
****************************************************
Host system:
Linux icj-laptop 4.8.0-45-generic #48-Ubuntu SMP Fri Mar 24 11:46:39 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
****************************************************
C compiler: gcc
C compiler version:
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/6/lto-wrapper
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu 6.2.0-5ubuntu12' --with-bugurl=file:///usr/share/doc/gcc-6/README.Bugs --enable-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-6 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-6-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-6-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-6-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 6.2.0 20161005 (Ubuntu 6.2.0-5ubuntu12) 
****************************************************
Traceback (most recent call last):
  File "/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py", line 3, in <module>
    import pkgconfig, os
ImportError: No module named pkgconfig

real	0m0.021s
user	0m0.008s
sys	0m0.008s
************************************************************************
Error installing package numpy-1.11.1.p0
************************************************************************
```




---

archive/issue_comments_310638.json:
```json
{
    "body": "same thing after \"make distclean\"",
    "created_at": "2017-04-04T12:01:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310638",
    "user": "chapoton"
}
```

same thing after "make distclean"



---

archive/issue_comments_310639.json:
```json
{
    "body": "in fact, this already happens with just #22608 applied..",
    "created_at": "2017-04-04T19:10:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310639",
    "user": "chapoton"
}
```

in fact, this already happens with just #22608 applied..



---

archive/issue_comments_310640.json:
```json
{
    "body": "Python 3 comes with pip, why do you want to install it!?\n\n```\n$ sage -sh -c \"python3 -m pip\"\n```\n\nWhat should be done is a proper shortcut `pip3 -> python3 -m pip`.",
    "created_at": "2017-04-04T21:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310640",
    "user": "vdelecroix"
}
```

Python 3 comes with pip, why do you want to install it!?

```
$ sage -sh -c "python3 -m pip"
```

What should be done is a proper shortcut `pip3 -> python3 -m pip`.



---

archive/issue_comments_310641.json:
```json
{
    "body": "I tried to test this on OS X and ran into the problem that Sage's Python3 build is broken on OS X. See #22756.",
    "created_at": "2017-04-04T21:40:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310641",
    "user": "jhpalmieri"
}
```

I tried to test this on OS X and ran into the problem that Sage's Python3 build is broken on OS X. See #22756.



---

archive/issue_comments_310642.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2017-04-07T08:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310642",
    "user": "vdelecroix"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_310643.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> Python 3 comes with pip, why do you want to install it!?\n> {{{\n> $ sage -sh -c \"python3 -m pip\"\n> }}}\n> What should be done is a proper shortcut `pip3 -> python3 -m pip`.\n\nping?",
    "created_at": "2017-04-07T08:37:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310643",
    "user": "vdelecroix"
}
```

Replying to [comment:21 vdelecroix]:
> Python 3 comes with pip, why do you want to install it!?
> {{{
> $ sage -sh -c "python3 -m pip"
> }}}
> What should be done is a proper shortcut `pip3 -> python3 -m pip`.

ping?



---

archive/issue_comments_310644.json:
```json
{
    "body": "I think the patch to the `README.rst` file in `fpylll` is not necessary in Sage 8.0.beta1: fpylll version 0.2.4dev does not have those non-ascii characters. (Or at least python3 does not complain about 0.2.4dev the way it does for 0.2.3dev.)",
    "created_at": "2017-04-07T14:49:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310644",
    "user": "jhpalmieri"
}
```

I think the patch to the `README.rst` file in `fpylll` is not necessary in Sage 8.0.beta1: fpylll version 0.2.4dev does not have those non-ascii characters. (Or at least python3 does not complain about 0.2.4dev the way it does for 0.2.3dev.)



---

archive/issue_comments_310645.json:
```json
{
    "body": "Replying to [comment:21 vdelecroix]:\n> Python 3 comes with pip, why do you want to install it!?\n> {{{\n> $ sage -sh -c \"python3 -m pip\"\n> }}}\n> What should be done is a proper shortcut `pip3 -> python3 -m pip`.\n\nIf I just install Sage's `python3` and its dependencies, then `python3 -m pip` tells me `No module named pip`, probably because I'm on OS X without `openssl`. That's an advantage to Sage's `pip`: it doesn't require Python's `ssl` module. So I say we should install it even with Python 3.",
    "created_at": "2017-04-07T16:04:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310645",
    "user": "jhpalmieri"
}
```

Replying to [comment:21 vdelecroix]:
> Python 3 comes with pip, why do you want to install it!?
> {{{
> $ sage -sh -c "python3 -m pip"
> }}}
> What should be done is a proper shortcut `pip3 -> python3 -m pip`.

If I just install Sage's `python3` and its dependencies, then `python3 -m pip` tells me `No module named pip`, probably because I'm on OS X without `openssl`. That's an advantage to Sage's `pip`: it doesn't require Python's `ssl` module. So I say we should install it even with Python 3.



---

archive/issue_comments_310646.json:
```json
{
    "body": "Replying to [comment:16 chapoton]:\n> If I try the latest branches for this ticket and its dependency with SAGE_PYTHON3=yes, it fails now on numpy:\n> {{{\n> [numpy-1.11.1.p0] Traceback (most recent call last):\n> [numpy-1.11.1.p0]   File \"/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py\", line 3, in <module>\n> [numpy-1.11.1.p0]     import pkgconfig, os\n> [numpy-1.11.1.p0] ImportError: No module named pkgconfig\n> }}}\n> EDIT:\n> This is preceded by\n> {{{\n> [pkgconfig-1.2.2.p0] Successfully installed pkgconfig-1.2.2.p0\n> }}}\n\nI see the same error. I think the problem is a race condition between `python2` and `python3`: whichever one is built second creates a symlink `local/bin/python`, and that version of python is used to execute the script `build/pkgs/numpy/lapack_conf.py`. In my case, the link points to `python2`, which is not the right one if you have `SAGE_PYTHON3=yes`.",
    "created_at": "2017-04-08T02:54:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310646",
    "user": "jhpalmieri"
}
```

Replying to [comment:16 chapoton]:
> If I try the latest branches for this ticket and its dependency with SAGE_PYTHON3=yes, it fails now on numpy:
> {{{
> [numpy-1.11.1.p0] Traceback (most recent call last):
> [numpy-1.11.1.p0]   File "/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py", line 3, in <module>
> [numpy-1.11.1.p0]     import pkgconfig, os
> [numpy-1.11.1.p0] ImportError: No module named pkgconfig
> }}}
> EDIT:
> This is preceded by
> {{{
> [pkgconfig-1.2.2.p0] Successfully installed pkgconfig-1.2.2.p0
> }}}

I see the same error. I think the problem is a race condition between `python2` and `python3`: whichever one is built second creates a symlink `local/bin/python`, and that version of python is used to execute the script `build/pkgs/numpy/lapack_conf.py`. In my case, the link points to `python2`, which is not the right one if you have `SAGE_PYTHON3=yes`.



---

archive/issue_comments_310647.json:
```json
{
    "body": "pip2/3 has the right shebang pointing to the corresponding python\n\n```\n(sage-sh) vbraun@volker:git$ head -1 local/bin/pip?\n==> local/bin/pip2 <==\n#!/home/vbraun/Code/sage.git/local/bin/python2\n\n==> local/bin/pip3 <==\n#!/home/vbraun/Code/sage.git/local/bin/python3\n```\n\nSo it is already a shortcut for corresponding-python-version -m pip",
    "created_at": "2017-04-08T11:18:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310647",
    "user": "vbraun"
}
```

pip2/3 has the right shebang pointing to the corresponding python

```
(sage-sh) vbraun@volker:git$ head -1 local/bin/pip?
==> local/bin/pip2 <==
#!/home/vbraun/Code/sage.git/local/bin/python2

==> local/bin/pip3 <==
#!/home/vbraun/Code/sage.git/local/bin/python3
```

So it is already a shortcut for corresponding-python-version -m pip



---

archive/issue_comments_310648.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-08T14:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310648",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310649.json:
```json
{
    "body": "Fixed...",
    "created_at": "2017-04-08T14:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310649",
    "user": "vbraun"
}
```

Fixed...



---

archive/issue_comments_310650.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-04-08T14:39:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310650",
    "user": "vbraun"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_310651.json:
```json
{
    "body": "This doesn't fix the race condition, so sometimes `python` will point to `python2`, sometimes to `python3`. This will affect any packages that use `python setup.py` in their `spkg-install`, for example:\n\n```\n$ grep -R 'python setup' build/pkgs\n./gambit/spkg-install:python setup.py --no-user-cfg build install\n./numpy/spkg-install:sage-python setup.py \\\n./pillow/spkg-install:python setup.py \\\n./pycrypto/spkg-check:python setup.py test\n./python_igraph/spkg-check:python setup.py check\n./scons/spkg-install:python setup.py --no-user-cfg install\n```\n\nThere are going to be other potential issues. See for example zn_poly's spkg-install:\n\n```\n# use 2to3 if we are running on python3\nif python -c 'import sys; sys.exit(sys.version_info.major != 3)'; then\n    2to3 -n -w --no-diffs makemakefile.py\nfi\n```\n\nI think either we need to not create the symlink pointing to python3 in the python3 spkg-install and fix any resulting issues, or (my preference) we need to make sure the symlink points to the correct python by creating the appropriate symlink also in the *python2* spkg-install, in case it gets built second.\n\nEdit: run\n\n```\ngrep -R -w python build/pkgs --include spkg-install\n```\n\nto see instances of `python` in spkg-install scripts. There will be more instances in spkg-check or other scripts, like matplotlib's make-setup-config.py. Having the symlink always point to python2 will require fixing all of these, and it will also make Sage harder to maintain.",
    "created_at": "2017-04-08T15:38:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310651",
    "user": "jhpalmieri"
}
```

This doesn't fix the race condition, so sometimes `python` will point to `python2`, sometimes to `python3`. This will affect any packages that use `python setup.py` in their `spkg-install`, for example:

```
$ grep -R 'python setup' build/pkgs
./gambit/spkg-install:python setup.py --no-user-cfg build install
./numpy/spkg-install:sage-python setup.py \
./pillow/spkg-install:python setup.py \
./pycrypto/spkg-check:python setup.py test
./python_igraph/spkg-check:python setup.py check
./scons/spkg-install:python setup.py --no-user-cfg install
```

There are going to be other potential issues. See for example zn_poly's spkg-install:

```
# use 2to3 if we are running on python3
if python -c 'import sys; sys.exit(sys.version_info.major != 3)'; then
    2to3 -n -w --no-diffs makemakefile.py
fi
```

I think either we need to not create the symlink pointing to python3 in the python3 spkg-install and fix any resulting issues, or (my preference) we need to make sure the symlink points to the correct python by creating the appropriate symlink also in the *python2* spkg-install, in case it gets built second.

Edit: run

```
grep -R -w python build/pkgs --include spkg-install
```

to see instances of `python` in spkg-install scripts. There will be more instances in spkg-check or other scripts, like matplotlib's make-setup-config.py. Having the symlink always point to python2 will require fixing all of these, and it will also make Sage harder to maintain.



---

archive/issue_comments_310652.json:
```json
{
    "body": "* Its easiest to just switch the python symlink at build time\nvs \n* pep 394 says: *The more general python command should be installed whenever any version of Python 2 is installed and should invoke the same version of Python as the python2 command*\n* switching the python symlink introduces state (so you can't build other packages with and without SAGE_PYTHON3)\n* distributions may or may not have python symlink to python2 \nI have a slight perference for the latter, tough I'm open for discussing this\n\nNot all of the occurences of python in build/ are issues; Ideally such scripts are version-independent and work with either the system python or Sage's python2/3. \n* matplotlib/make-setup-config.py needlessly depends on six and could easily be version-independent\n* Calls to \"python setup.py\" should be replaced with sage-pip-install anyways",
    "created_at": "2017-04-08T16:15:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310652",
    "user": "vbraun"
}
```

* Its easiest to just switch the python symlink at build time
vs 
* pep 394 says: *The more general python command should be installed whenever any version of Python 2 is installed and should invoke the same version of Python as the python2 command*
* switching the python symlink introduces state (so you can't build other packages with and without SAGE_PYTHON3)
* distributions may or may not have python symlink to python2 
I have a slight perference for the latter, tough I'm open for discussing this

Not all of the occurences of python in build/ are issues; Ideally such scripts are version-independent and work with either the system python or Sage's python2/3. 
* matplotlib/make-setup-config.py needlessly depends on six and could easily be version-independent
* Calls to "python setup.py" should be replaced with sage-pip-install anyways



---

archive/issue_comments_310653.json:
```json
{
    "body": "Should `SAGE_PYTHON3` only have an effect at build time, or should it also control run time behavior? I guess it has to control run time behavior, at least as things are currently, many all of the relevant python packages get installed only to `local/lib/python$VERSION/site-packages/`. The symlink makes this easier (even trivial?) to implement.\n\nI am not quite persuaded by PEP 394, since we're not really installing Python for general use; we're installing it for use within a specific environment, the Sage build environment.\n\nAlso, I agree that cleaning up things like `python setup.py --> sage-pip-install` would be great. For what it's worth, note that running `matplotlib/make-setup-config.py` with python3 led to the discovery of a minor bug -- see #22772.",
    "created_at": "2017-04-08T16:34:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310653",
    "user": "jhpalmieri"
}
```

Should `SAGE_PYTHON3` only have an effect at build time, or should it also control run time behavior? I guess it has to control run time behavior, at least as things are currently, many all of the relevant python packages get installed only to `local/lib/python$VERSION/site-packages/`. The symlink makes this easier (even trivial?) to implement.

I am not quite persuaded by PEP 394, since we're not really installing Python for general use; we're installing it for use within a specific environment, the Sage build environment.

Also, I agree that cleaning up things like `python setup.py --> sage-pip-install` would be great. For what it's worth, note that running `matplotlib/make-setup-config.py` with python3 led to the discovery of a minor bug -- see #22772.



---

archive/issue_comments_310654.json:
```json
{
    "body": "Just to confirm that there are problems: I tested the current branch (+ #22756, #22765, #22772 so everything works on OS X), plus I added a dependency to make sure `python3` got built before `python2`. Then with `SAGE_PYTHON3=yes`, pillow gets installed in `python2.7/site-packages/`, not in `python3.5/site-packages/`.",
    "created_at": "2017-04-08T16:37:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310654",
    "user": "jhpalmieri"
}
```

Just to confirm that there are problems: I tested the current branch (+ #22756, #22765, #22772 so everything works on OS X), plus I added a dependency to make sure `python3` got built before `python2`. Then with `SAGE_PYTHON3=yes`, pillow gets installed in `python2.7/site-packages/`, not in `python3.5/site-packages/`.



---

archive/issue_comments_310655.json:
```json
{
    "body": "The numpy builds also fails with the error `ImportError: No module named numpy`, I think because of this in spkg-install:\n\n```\n# Touch all includes such that dependency checking works properly:\n# the timestamp of the includes should be *now*, not the time when\n# the numpy package was created.\npython <<EOF\nimport os\nos.chdir(os.environ[\"SAGE_ROOT\"])  # Import numpy from safe location\nimport numpy\nos.chdir(numpy.get_include())\nos.system(\"touch numpy/*\")\nEOF\n```\n\nEasy enough to fix with your proposal: change `python` to `sage_python`.",
    "created_at": "2017-04-08T17:08:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310655",
    "user": "jhpalmieri"
}
```

The numpy builds also fails with the error `ImportError: No module named numpy`, I think because of this in spkg-install:

```
# Touch all includes such that dependency checking works properly:
# the timestamp of the includes should be *now*, not the time when
# the numpy package was created.
python <<EOF
import os
os.chdir(os.environ["SAGE_ROOT"])  # Import numpy from safe location
import numpy
os.chdir(numpy.get_include())
os.system("touch numpy/*")
EOF
```

Easy enough to fix with your proposal: change `python` to `sage_python`.



---

archive/issue_comments_310656.json:
```json
{
    "body": "Its a bit premature to worry about how to run sage-on-python3, but one possibility would be to have a specific sage3 command. Using an environment variable doesn't sound clean to me.",
    "created_at": "2017-04-08T17:09:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310656",
    "user": "vbraun"
}
```

Its a bit premature to worry about how to run sage-on-python3, but one possibility would be to have a specific sage3 command. Using an environment variable doesn't sound clean to me.



---

archive/issue_comments_310657.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-04-08T18:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310657",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_310658.json:
```json
{
    "body": "I'm not sure which approach is the best; I'd like to hear other views. In any case, this needs work.",
    "created_at": "2017-04-08T18:03:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310658",
    "user": "jhpalmieri"
}
```

I'm not sure which approach is the best; I'd like to hear other views. In any case, this needs work.



---

archive/issue_comments_310659.json:
```json
{
    "body": "Replying to [comment:35 vbraun]:\n> Its a bit premature to worry about how to run sage-on-python3, but one possibility would be to have a specific sage3 command. Using an environment variable doesn't sound clean to me.\n\nWhy not try to plan ahead?\n\nAs things stand, to run sage-on-python3, you would have to build with `SAGE_PYTHON3=yes` first, in which case sage-on-python2 will not work. So the build-time and run-time choices of Python version have to match up. I guess we could build everything for both Python 2 and 3, but that seems like a waste of space.",
    "created_at": "2017-04-08T18:07:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310659",
    "user": "jhpalmieri"
}
```

Replying to [comment:35 vbraun]:
> Its a bit premature to worry about how to run sage-on-python3, but one possibility would be to have a specific sage3 command. Using an environment variable doesn't sound clean to me.

Why not try to plan ahead?

As things stand, to run sage-on-python3, you would have to build with `SAGE_PYTHON3=yes` first, in which case sage-on-python2 will not work. So the build-time and run-time choices of Python version have to match up. I guess we could build everything for both Python 2 and 3, but that seems like a waste of space.



---

archive/issue_comments_310660.json:
```json
{
    "body": "I also think we should merge the functools change soon, so in case this ticket takes a while, see #22770. Same for the sagenb change: #22787. Both of those are obstacles to building with `SAGE_PYTHON3=yes` right now, and I think are independent of this ticket.\n\nIf this ticket gets positively reviewed and merged soon, we can ignore the others, but in case this takes a while, we can at least fix those changes.",
    "created_at": "2017-04-08T21:16:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310660",
    "user": "jhpalmieri"
}
```

I also think we should merge the functools change soon, so in case this ticket takes a while, see #22770. Same for the sagenb change: #22787. Both of those are obstacles to building with `SAGE_PYTHON3=yes` right now, and I think are independent of this ticket.

If this ticket gets positively reviewed and merged soon, we can ignore the others, but in case this takes a while, we can at least fix those changes.



---

archive/issue_comments_310661.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-08T22:15:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310661",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310662.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-08T22:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310662",
    "user": "vbraun"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_310663.json:
```json
{
    "body": "This now works for me (builds up to sagelib), with python -> python2 regardless of SAGE_PYTHON3, hopefully race-free. \n\nThe only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac",
    "created_at": "2017-04-08T22:45:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310663",
    "user": "vbraun"
}
```

This now works for me (builds up to sagelib), with python -> python2 regardless of SAGE_PYTHON3, hopefully race-free. 

The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac



---

archive/issue_comments_310664.json:
```json
{
    "body": "Except that sagenb doesn't build on python2 since it trips over the /lib/python/ symlink missing",
    "created_at": "2017-04-09T09:15:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310664",
    "user": "vbraun"
}
```

Except that sagenb doesn't build on python2 since it trips over the /lib/python/ symlink missing



---

archive/issue_comments_310665.json:
```json
{
    "body": "Does anyone else have any opinions on whether `SAGE_PYTHON3=yes` should lead to the creation of a symlink `python -> python3`?",
    "created_at": "2017-04-12T20:09:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310665",
    "user": "jhpalmieri"
}
```

Does anyone else have any opinions on whether `SAGE_PYTHON3=yes` should lead to the creation of a symlink `python -> python3`?



---

archive/issue_comments_310666.json:
```json
{
    "body": "I have not followed in detail all the tickets around the one here. In my opinion, setting $SAGE_PYTHON3 to yes should do all what is needed at the build level so that, one day, when all our cython and python files compiles, sage will start with py3. I agree that the legacy sagenb can be desactivated when SAGE_PYTHON3 is yes.",
    "created_at": "2017-04-12T20:32:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310666",
    "user": "chapoton"
}
```

I have not followed in detail all the tickets around the one here. In my opinion, setting $SAGE_PYTHON3 to yes should do all what is needed at the build level so that, one day, when all our cython and python files compiles, sage will start with py3. I agree that the legacy sagenb can be desactivated when SAGE_PYTHON3 is yes.



---

archive/issue_comments_310667.json:
```json
{
    "body": "I have a separate question for Volker: was the name `build/bin/sage-python` chosen intentionally to shadow the already existing `local/bin/sage-python`? That could lead to unintended (or intended?) consequences. Maybe it would be clearer to call it something like `build/bin/sage-python2-or-3`.",
    "created_at": "2017-04-12T20:49:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310667",
    "user": "jhpalmieri"
}
```

I have a separate question for Volker: was the name `build/bin/sage-python` chosen intentionally to shadow the already existing `local/bin/sage-python`? That could lead to unintended (or intended?) consequences. Maybe it would be clearer to call it something like `build/bin/sage-python2-or-3`.



---

archive/issue_comments_310668.json:
```json
{
    "body": "IMHO we shouldn't tie our python3 support to where the python symlink points to. Pep 394 is pretty clear what it should be now, and it implies that it'll change in the future. Meaning that distributions will change over time; If we want Sage to be package-able then its just an additional unnecessary hurdle. Instead, do what everybody else does and have a sage3 launch script (or symlink to sage and look at argv[0]).\n\nI didn't think about local/bin/sage-python, though I don't think there is a conflict. In fact, local/bin/sage-python seems to serve no useful purpose. Its only used from src/bin/sage-run to launch python from a shell script from python...",
    "created_at": "2017-04-12T20:58:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310668",
    "user": "vbraun"
}
```

IMHO we shouldn't tie our python3 support to where the python symlink points to. Pep 394 is pretty clear what it should be now, and it implies that it'll change in the future. Meaning that distributions will change over time; If we want Sage to be package-able then its just an additional unnecessary hurdle. Instead, do what everybody else does and have a sage3 launch script (or symlink to sage and look at argv[0]).

I didn't think about local/bin/sage-python, though I don't think there is a conflict. In fact, local/bin/sage-python seems to serve no useful purpose. Its only used from src/bin/sage-run to launch python from a shell script from python...



---

archive/issue_comments_310669.json:
```json
{
    "body": "I agree that `local/bin/sage-python` serves no useful purpose. There is a conflict, though, because `build/bin/sage-python` will get run instead -- at least in my version of Sage, `build/bin` comes earlier in `PATH` than `src/bin` or `local/bin` -- and so the effect will be different depending on the setting of `SAGE_PYTHON3`.",
    "created_at": "2017-04-12T21:15:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310669",
    "user": "jhpalmieri"
}
```

I agree that `local/bin/sage-python` serves no useful purpose. There is a conflict, though, because `build/bin/sage-python` will get run instead -- at least in my version of Sage, `build/bin` comes earlier in `PATH` than `src/bin` or `local/bin` -- and so the effect will be different depending on the setting of `SAGE_PYTHON3`.



---

archive/issue_comments_310670.json:
```json
{
    "body": "does not apply",
    "created_at": "2017-04-16T07:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310670",
    "user": "chapoton"
}
```

does not apply



---

archive/issue_comments_310671.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-04-16T07:04:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310671",
    "user": "chapoton"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_310672.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-16T21:17:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310672",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310673.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-18T18:18:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310673",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310674.json:
```json
{
    "body": "I fixed the merge problems. I also renamed `build/bin/sage-python` to `build/bin/sage-python23` to avoid shadowing `local/bin/sage-python` -- the script in `local/bin` should not depend on the value of `SAGE_PYTHON3`, the way the script in `build/bin` should.\n\nI am willing to give this a positive review, as long as this renaming is okay. A future ticket can deal with removing `local/bin/sage-python`.",
    "created_at": "2017-04-18T18:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310674",
    "user": "jhpalmieri"
}
```

I fixed the merge problems. I also renamed `build/bin/sage-python` to `build/bin/sage-python23` to avoid shadowing `local/bin/sage-python` -- the script in `local/bin` should not depend on the value of `SAGE_PYTHON3`, the way the script in `build/bin` should.

I am willing to give this a positive review, as long as this renaming is okay. A future ticket can deal with removing `local/bin/sage-python`.



---

archive/issue_comments_310675.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-18T18:21:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310675",
    "user": "jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_310676.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-18T19:52:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310676",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310677.json:
```json
{
    "body": "Oops, one more change: we need to build the Sage library with `sage-python23`, not with `python`.",
    "created_at": "2017-04-18T19:53:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310677",
    "user": "jhpalmieri"
}
```

Oops, one more change: we need to build the Sage library with `sage-python23`, not with `python`.



---

archive/issue_comments_310678.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-18T20:24:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310678",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310679.json:
```json
{
    "body": "Some more changes: some `spkg-check` scripts were using `python` and should use `sage-python23` instead: if we're building with it, we should test with it. Some optional packages also needed some modifications. I haven't tested these changes yet.\n\nA few questions:\n\n- when we build `git`, we pass the configure option `--with-python=\"$SAGE_LOCAL\"/bin/python`. Does this matter? Does anyone use Sage's git as opposed to the system git?\n\n- in the IPython `spkg-install` script, there is a test to see if `python` is version 3 or not:\n\n```\n# add symlink if we are running on python3\nif python -c 'import sys; sys.exit(sys.version_info.major != 3)'; then\n    cd \"$SAGE_LOCAL\"/bin\n    rm -f ipython\n    ln -s ipython3 ipython\nfi\n```\n\n Keep this as is, or test instead whether `SAGE_PYTHON3=yes`, or delete the whole block?",
    "created_at": "2017-04-18T20:26:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310679",
    "user": "jhpalmieri"
}
```

Some more changes: some `spkg-check` scripts were using `python` and should use `sage-python23` instead: if we're building with it, we should test with it. Some optional packages also needed some modifications. I haven't tested these changes yet.

A few questions:

- when we build `git`, we pass the configure option `--with-python="$SAGE_LOCAL"/bin/python`. Does this matter? Does anyone use Sage's git as opposed to the system git?

- in the IPython `spkg-install` script, there is a test to see if `python` is version 3 or not:

```
# add symlink if we are running on python3
if python -c 'import sys; sys.exit(sys.version_info.major != 3)'; then
    cd "$SAGE_LOCAL"/bin
    rm -f ipython
    ln -s ipython3 ipython
fi
```

 Keep this as is, or test instead whether `SAGE_PYTHON3=yes`, or delete the whole block?



---

archive/issue_comments_310680.json:
```json
{
    "body": "I made another change in commit [dc46ea2](https://git.sagemath.org/sage.git/commit/?id=dc46ea2dfa97be79d7ef8ddbe9130d4c717acc3d): we do not need to create a symlink `local/bin/python` pointing to `python2`: the python2 installation takes care of that automatically. The python3 installation does not create such a link, so we actually don't need to build python2 before python3. So we should remove python2 from the list of dependencies for python3.",
    "created_at": "2017-04-18T20:52:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310680",
    "user": "jhpalmieri"
}
```

I made another change in commit [dc46ea2](https://git.sagemath.org/sage.git/commit/?id=dc46ea2dfa97be79d7ef8ddbe9130d4c717acc3d): we do not need to create a symlink `local/bin/python` pointing to `python2`: the python2 installation takes care of that automatically. The python3 installation does not create such a link, so we actually don't need to build python2 before python3. So we should remove python2 from the list of dependencies for python3.



---

archive/issue_comments_310681.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-18T20:52:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310681",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310682.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-18T21:14:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310682",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310683.json:
```json
{
    "body": "Replying to [comment:40 vbraun]:\n> The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac\n\nShould we open up a ticket for this?",
    "created_at": "2017-04-18T21:20:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310683",
    "user": "jhpalmieri"
}
```

Replying to [comment:40 vbraun]:
> The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac

Should we open up a ticket for this?



---

archive/issue_comments_310684.json:
```json
{
    "body": "Replying to [comment:58 jhpalmieri]:\n> Replying to [comment:40 vbraun]:\n> > The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac\n> \n> Should we open up a ticket for this?\n\nWell, it seems that brial got installed in local/lib/python3.5/site-packages (during my latest build of sage with SAGE_PYTHON3=yes)",
    "created_at": "2017-04-19T14:31:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310684",
    "user": "chapoton"
}
```

Replying to [comment:58 jhpalmieri]:
> Replying to [comment:40 vbraun]:
> > The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac
> 
> Should we open up a ticket for this?

Well, it seems that brial got installed in local/lib/python3.5/site-packages (during my latest build of sage with SAGE_PYTHON3=yes)



---

archive/issue_comments_310685.json:
```json
{
    "body": "Replying to [comment:59 chapoton]:\n> Replying to [comment:58 jhpalmieri]:\n> > Replying to [comment:40 vbraun]:\n> > > The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac\n> > \n> > Should we open up a ticket for this?\n> \n> Well, it seems that brial got installed in local/lib/python3.5/site-packages (during my latest build of sage with SAGE_PYTHON3=yes)\n\nWith no symlink `local/lib/python` pointing to `local/lib/python3.5`? As Volker points out, brial's file `configure.ac` has the line\n\n```\nAM_PATH_PYTHON([2.7])\n```\n\nFor me, brial gets installed in `local/lib/python2.7/site-packages`, regardless of the variable `SAGE_PYTHON3`, if I'm building with this branch and the one from #22764.",
    "created_at": "2017-04-19T16:47:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310685",
    "user": "jhpalmieri"
}
```

Replying to [comment:59 chapoton]:
> Replying to [comment:58 jhpalmieri]:
> > Replying to [comment:40 vbraun]:
> > > The only thing that still ends up being installed with SAGE_PYTHON3=yes into lib/python2.7 is brial, which has a hardcoded python2.7 in its configure.ac
> > 
> > Should we open up a ticket for this?
> 
> Well, it seems that brial got installed in local/lib/python3.5/site-packages (during my latest build of sage with SAGE_PYTHON3=yes)

With no symlink `local/lib/python` pointing to `local/lib/python3.5`? As Volker points out, brial's file `configure.ac` has the line

```
AM_PATH_PYTHON([2.7])
```

For me, brial gets installed in `local/lib/python2.7/site-packages`, regardless of the variable `SAGE_PYTHON3`, if I'm building with this branch and the one from #22764.



---

archive/issue_comments_310686.json:
```json
{
    "body": "I am building with #22764 and #22756 (and other changes, including #22305 and #22775)",
    "created_at": "2017-04-19T16:52:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310686",
    "user": "chapoton"
}
```

I am building with #22764 and #22756 (and other changes, including #22305 and #22775)



---

archive/issue_comments_310687.json:
```json
{
    "body": "I'm trying again...",
    "created_at": "2017-04-19T17:08:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310687",
    "user": "jhpalmieri"
}
```

I'm trying again...



---

archive/issue_comments_310688.json:
```json
{
    "body": "I still only see `brial` installed in `local/lib/python2.7/...`. I wonder what's going on.",
    "created_at": "2017-04-19T22:42:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310688",
    "user": "jhpalmieri"
}
```

I still only see `brial` installed in `local/lib/python2.7/...`. I wonder what's going on.



---

archive/issue_comments_310689.json:
```json
{
    "body": "Are you using a different version of brial?",
    "created_at": "2017-04-19T22:44:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310689",
    "user": "jhpalmieri"
}
```

Are you using a different version of brial?



---

archive/issue_comments_310690.json:
```json
{
    "body": "Just to be clear, I am not using the present branch (#22582) in my build.",
    "created_at": "2017-04-20T07:41:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310690",
    "user": "chapoton"
}
```

Just to be clear, I am not using the present branch (#22582) in my build.



---

archive/issue_comments_310691.json:
```json
{
    "body": "My guess is that without using this branch, you have a link `local/bin/python` pointing to `python3`, so that is what gets used when installing brial.",
    "created_at": "2017-04-20T20:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310691",
    "user": "jhpalmieri"
}
```

My guess is that without using this branch, you have a link `local/bin/python` pointing to `python3`, so that is what gets used when installing brial.



---

archive/issue_comments_310692.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-20T20:36:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310692",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310693.json:
```json
{
    "body": "With this change, brial is built with the appropriate version of Python, as determined by `SAGE_PYTHON3`. In particular, it gets installed into `local/lib/python3.5/site-packages` if `SAGE_PYTHON3=yes`.",
    "created_at": "2017-04-20T23:19:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310693",
    "user": "jhpalmieri"
}
```

With this change, brial is built with the appropriate version of Python, as determined by `SAGE_PYTHON3`. In particular, it gets installed into `local/lib/python3.5/site-packages` if `SAGE_PYTHON3=yes`.



---

archive/issue_comments_310694.json:
```json
{
    "body": "By the way, this issue with brial is an illustration of possible difficulties if we don't create a symlink `python -> python3` when `SAGE_PYTHON3=yes`. I am willing to keep the symlink `python -> python2`, but it may create build problems which may be hard to debug.",
    "created_at": "2017-04-21T18:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310694",
    "user": "jhpalmieri"
}
```

By the way, this issue with brial is an illustration of possible difficulties if we don't create a symlink `python -> python3` when `SAGE_PYTHON3=yes`. I am willing to keep the symlink `python -> python2`, but it may create build problems which may be hard to debug.



---

archive/issue_comments_310695.json:
```json
{
    "body": "IMHO user issues will be even harder to debug if everybody has the python symlink pointing somewhere else, always depending on whether they originally (and potentially a long time ago) installed python with or without SAGE_PYTHON3. \n\nChanges LGTM...",
    "created_at": "2017-04-22T20:07:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310695",
    "user": "vbraun"
}
```

IMHO user issues will be even harder to debug if everybody has the python symlink pointing somewhere else, always depending on whether they originally (and potentially a long time ago) installed python with or without SAGE_PYTHON3. 

Changes LGTM...



---

archive/issue_comments_310696.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-04-24T20:45:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310696",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_310697.json:
```json
{
    "body": "Rebased. Anyone object to a positive review?",
    "created_at": "2017-04-24T20:46:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310697",
    "user": "jhpalmieri"
}
```

Rebased. Anyone object to a positive review?



---

archive/issue_comments_310698.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-25T15:51:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310698",
    "user": "jhpalmieri"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_310699.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-29T23:30:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310699",
    "user": "vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_310700.json:
```json
{
    "body": "Being just a bit more detailed in ticket description would have saved me the trouble of doing #22895... Oh well.",
    "created_at": "2017-04-30T10:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310700",
    "user": "dimpase"
}
```

Being just a bit more detailed in ticket description would have saved me the trouble of doing #22895... Oh well.



---

archive/issue_comments_310701.json:
```json
{
    "body": "Changing keywords from \"\" to \"numpy, pip, python\".",
    "created_at": "2017-04-30T10:18:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310701",
    "user": "dimpase"
}
```

Changing keywords from "" to "numpy, pip, python".



---

archive/issue_comments_310702.json:
```json
{
    "body": "What is the numpy tarball to be used here? It's not mentioned anywhere on the ticket. https://pypi.python.org/pypi/numpy only provides a link to zip file (that's what I used on #22895).",
    "created_at": "2017-04-30T11:05:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310702",
    "user": "dimpase"
}
```

What is the numpy tarball to be used here? It's not mentioned anywhere on the ticket. https://pypi.python.org/pypi/numpy only provides a link to zip file (that's what I used on #22895).



---

archive/issue_comments_310703.json:
```json
{
    "body": "The tarball for this ticket is on the mirrors. In general, tarballs for numpy can be found at https://github.com/numpy/numpy/releases",
    "created_at": "2017-05-01T07:57:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310703",
    "user": "vbraun"
}
```

The tarball for this ticket is on the mirrors. In general, tarballs for numpy can be found at https://github.com/numpy/numpy/releases



---

archive/issue_comments_310704.json:
```json
{
    "body": "(Google pointed me to this ticket, so I'm leaving this comment to help, in case someone encounters this.)\n\nI ran into the same problem while updating to 9.0beta8 (including the update to python3).\n\nForce installing python3 with\n\n```\nsage -f python3\n```\n\n(as pointed out above) solved it in my case. I did run `make dist-clean` and `./configure` in case anyone wonders.\n\nReplying to [comment:16 chapoton]:\n> If I try the latest branches for this ticket and its dependency with SAGE_PYTHON3=yes, it fails now on numpy:\n> {{{\n> [numpy-1.11.1.p0] Traceback (most recent call last):\n> [numpy-1.11.1.p0]   File \"/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py\", line 3, in <module>\n> [numpy-1.11.1.p0]     import pkgconfig, os\n> [numpy-1.11.1.p0] ImportError: No module named pkgconfig\n> }}}\n> EDIT:\n> This is preceded by\n> {{{\n> [pkgconfig-1.2.2.p0] Successfully installed pkgconfig-1.2.2.p0\n> }}}",
    "created_at": "2019-12-06T11:59:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/22345",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/22345#issuecomment-310704",
    "user": "@kliem"
}
```

(Google pointed me to this ticket, so I'm leaving this comment to help, in case someone encounters this.)

I ran into the same problem while updating to 9.0beta8 (including the update to python3).

Force installing python3 with

```
sage -f python3
```

(as pointed out above) solved it in my case. I did run `make dist-clean` and `./configure` in case anyone wonders.

Replying to [comment:16 chapoton]:
> If I try the latest branches for this ticket and its dependency with SAGE_PYTHON3=yes, it fails now on numpy:
> {{{
> [numpy-1.11.1.p0] Traceback (most recent call last):
> [numpy-1.11.1.p0]   File "/home/chapoton/sage3/local/var/tmp/sage/build/numpy-1.11.1.p0/lapack_conf.py", line 3, in <module>
> [numpy-1.11.1.p0]     import pkgconfig, os
> [numpy-1.11.1.p0] ImportError: No module named pkgconfig
> }}}
> EDIT:
> This is preceded by
> {{{
> [pkgconfig-1.2.2.p0] Successfully installed pkgconfig-1.2.2.p0
> }}}
