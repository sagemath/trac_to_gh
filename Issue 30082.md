# Issue 30082: wrong intersection of polytopes

Issue created by migration from https://trac.sagemath.org/ticket/30319

Original creator: vdelecroix

Original creation time: 2020-08-08 10:23:58

CC:  jipilab mkoeppe dimpase vbraun

As reported in [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/514hUpM7pBY), the intersection of polytopes is sometimes very wrong

```
a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])
b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])
c = a.intersection(b)
```

Here `c` should have been empty but is equal to `b`.


---

Comment by mkoeppe created at 2020-08-08 15:10:31

Changing priority from major to critical.


---

Comment by @kliem created at 2020-08-10 10:04:40

Looks like a `cdd` bug.


```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])
sage: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])
sage: a = a.change_ring(RDF)
sage: new_eqns = a.equations() + b.equations()
sage: new_ieqs = a.inequalities() + b.inequalities()
sage: Polyhedron(eqns=new_eqns, ieqs=new_ieqs[1:2]+new_ieqs[4:5], verbose=True)
---- CDD input -----
H-representation
linearity 2 1 2
begin
 5 4 real
 0.0 0.0 1.0 1.0
 -1.0 0.0 1.0 1.0
 -1.0 2.0 -1.0 0.0
 -1.0 4.0 -2.0 0.0
 1 0 0 0
end

---- CDD output -----
Canonicalize the matrix.
Implicit linearity rows are:

Redundant rows are:1 3 5 

Nonredundant representation:
The new row positions are as follows (orig:new).
Each redundant row has the new number 0.
Each deleted duplicated row has a number nagative of the row that
represents its equivalence class.
 1:0 2:1 3:0 4:2 5:0
H-representation
linearity 1  1
begin
 2 4 real
 -1  0  1  1
 -1  4 -2  0
end

size = 5 x 4
Number Type = real

---- CDD input -----
Canonicalize the matrix.
Implicit linearity rows are:

Redundant rows are:1 3 5 

Nonredundant representation:
The new row positions are as follows (orig:new).
Each redundant row has the new number 0.
Each deleted duplicated row has a number nagative of the row that
represents its equivalence class.
 1:0 2:1 3:0 4:2 5:0
H-representation
linearity 1  1
begin
 2 4 real
 -1  0  1  1
 -1  4 -2  0
end

---- CDD output -----
The second representation:
V-representation
linearity 1  3
begin
 3 4 real
  0  1  0  0
  1  7.500000000E-01  1  0
  0 -5.000000000E-01 -1  1
end

Vertex incidence
ecd_file: Incidence of generators and inequalities
begin
  3    3
 1 -2 : 2 
 2 -2 : 3 
 3 -3 : 
end

Vertex adjacency
ead_file: Adjacency of generators
begin
  3    3
 1 1 : 2 
 2 1 : 1 
 3 0 : 
end

The first (input) representation
H-representation
linearity 1  1
begin
 2 4 real
 -1  0  1  1
 -1  4 -2  0
end

Facet incidence
icd_file: Incidence of inequalities and generators
begin
  3    3
 1 -3 : 
 2 -2 : 1 
 3 -2 : 2 
end

Facet adjacency
iad_file: Adjacency of inequalities
begin
  3    3
 1 -2 : 1 
 2 -2 : 2 
 3 -2 : 3 
end

size = 2 x 4
Number Type = real

---- CDD input -----
The second representation:
V-representation
linearity 1  3
begin
 3 4 real
  0  1  0  0
  1  7.500000000E-01  1  0
  0 -5.000000000E-01 -1  1
end
---- CDD output -----
The second representation:
H-representation
linearity 1  3
begin
 3 4 real
  1  0  0  0
 -1  4 -2  0
 -1  0  1  1
end

size = 3 x 4
Number Type = real

A 2-dimensional polyhedron in RDF^3 defined as the convex hull of 1 vertex, 1 ray, 1 line
```


For some reason `cdd` thinks that row `1` is redundant. If you drop an inequality, everything is fine.


---

Comment by tmonteil created at 2020-08-14 10:28:34

Could someone please report it upstream (i do not have a github account) ?


---

Comment by @kliem created at 2020-08-14 11:38:10

https://github.com/cddlib/cddlib/issues/45


---

Comment by dimpase created at 2020-09-21 07:24:11

Note that with data in comment:2 one has

```
sage: Polyhedron(eqns=new_eqns)                                                                                                      
The empty polyhedron in RDF^3
```

so the emptiness should have been detected earlier.


---

Comment by @kliem created at 2020-09-21 07:51:56

Are you proposing that we test whether the equations are infeasible ourselves as a workaround?

Sounds like a workaround that should work for us.

Is `cdd` specifically excluding this case?


---

Comment by @kliem created at 2020-09-21 08:00:31

Something like


```
new_eqns_matrix = matrix(new_eqns)
feasible_directions = new_eqns_matrix.right_kernel_matrix()
if feasible_directions.column(0).is_zero():
    initialize_empty_polyhedron()
```


should work.


---

Comment by dimpase created at 2020-09-21 08:59:59

On the other hand, with RDF data and the internal representation used by `cdd`, it is not so hard to come up with (ugly) examples on which it can fail to produce a meaningful answer.

I'd say that computing `c` like in the ticket description should throw an error, 
as `a` is exact and `b` is not.
Or at the very least print a warning like

```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]],base_ring=RDF) 
....: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])                                                         
sage: a.intersection(b)                                                                                                              
/mnt/opt/Sage/sage-dev/local/lib/python3.8/site-packages/sage/geometry/polyhedron/backend_cdd.py:151: UserWarning: This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.
  warn("This polyhedron data is numerically complicated; cdd could not convert between the inexact V and H representation without loss of data. The resulting object might show inconsistencies.")
A 2-dimensional polyhedron in RDF^3 defined as the convex hull of 3 vertices
```



---

Comment by dimpase created at 2020-09-21 09:06:16

it's also weird that no warning is printed in this case:

```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]])
....: b = Polyhedron([[0.0, -0.5, 1.5], [1.0, -0.5, 1.5], [1.0, 1.5, -0.5]])      
....: b.intersection(a)                                  
A 2-dimensional polyhedron in RDF^3 defined as the convex hull of 3 vertices
```

as if seeing the exact `a` to intersect `b` with convinces cdd that everything should be fine.


---

Comment by @kliem created at 2020-09-21 09:07:02

The behavior of coercing base rings is the correct and expected behaviour, I would say.

The failure of `cdd` has nothing to do with inexactness:


```
sage: a = Polyhedron([[0, -1, 1], [1, -1, 1], [1, 1, -1]], backend='cdd')                                                                                                           
sage: b = Polyhedron([[0, -1/2, 3/2], [1, -1/2, 3/2], [1, 3/2, -1/2]], backend='cdd')                                                                                               
sage: a.intersection(b)                                                                                                                                                             
A 2-dimensional polyhedron in QQ^3 defined as the convex hull of 3 vertices
```



---

Comment by @kliem created at 2020-09-21 09:09:10

`cdd` for some reason determines that one of the equations is redundant. After this the calculation is correct. For this reason, no warning is printed. Because converting from Vrepresention to Hrepresentation works.

The output of `cdd` is numerical consistent, but incorrect.


---

Comment by dimpase created at 2020-09-21 11:05:14

Replying to [comment:10 gh-kliem]:
> The behavior of coercing base rings is the correct and expected behaviour, I would say.
> 
> The failure of `cdd` has nothing to do with inexactness:

OK, I see, you're right - I thought it's an inexactness issue, such as computing rank of an RDF matrix, sorry.


---

Comment by dimpase created at 2020-12-09 16:06:00

The fix is in 
https://github.com/cddlib/cddlib/releases/tag/0.94m

let's upgrade


---

Comment by @kliem created at 2020-12-09 16:10:36

How important do we consider this bug. Should we reject older system installs?


---

Comment by @kliem created at 2020-12-09 16:13:29

Ok, it warned me because of a conflict, but I did not expect it to change the description back.


---

Comment by @kliem created at 2020-12-09 16:45:02

There is a bug in latte_int with the new header location that needs fixing yet:

https://github.com/latte-int/latte/issues/15


---

Comment by @kliem created at 2020-12-09 18:31:34

`@`mkoeppe

There is already a patch for latte, but I'm incapable of creating a patch for latte-int not latte-integral.


---

Comment by @kliem created at 2020-12-09 18:33:33

New commits:


---

Comment by dimpase created at 2020-12-15 20:04:17

Replying to [comment:17 gh-kliem]:
> How important do we consider this bug. Should we reject older system installs?
A good idea, I think.


---

Comment by mkoeppe created at 2020-12-15 20:17:24

I agree as well.


---

Comment by @kliem created at 2021-03-18 06:05:45

It seems that the system cdd will also leak into singular:

`Singular/m4/gfanlib-check.m4`:

```
  AC_CHECK_HEADERS([setoper.h cdd/setoper.h cddlib/setoper.h])
  if test "x$ac_cv_header_setoper_h" = xno -a "x$ac_cv_header_cdd_setoper_h" = xno -a "x$ac_cv_header_cddlib_setoper_h" = xno
  then
    if test "x$ENABLE_GFANLIB" = "xyes"; then
      AC_MSG_ERROR([Error, setoper.h is missing!])
    fi
```



---

Comment by @kliem created at 2021-03-18 06:29:00

Singular always prefers `<cdd/....h>` over `<cddlib/....h`. This means that on debian a system cdd will always be prefered, if I'm not mistaken.

I don't know if this leads to any problems?

We could patch singular to modify the preference to `<cddlib/....h>` over `<cdd/....h>`. If we set up the path correctly, then sage's cdd will be prefered, even if there is a system cdd that is also in `<cdd/....h>`. Right??

This would be preferable in general I think (for singular as well). If there is a seperate install of cdd, it will always be in `cddlib/`.


---

Comment by mkoeppe created at 2021-03-18 06:32:36

I suppose we can also just install a few symlinks in cddlib's spkg-install.
Then we could finish the present ticket without having to wait for all the dependencies.
Later, in a followup ticket when packages have been updated, we could eliminate the symlinks again.


---

Comment by @kliem created at 2021-03-18 06:56:35

We could to that with the symlinks and singular will pull in the correct library then, I think (at least if my assumption that the path is an ordered list and we lock for headers from sage first is correct).

I don't think we have to wait on singular. It's been leaking all along prefering the `cdd` system one over sage's header. It also checks for `cddlib`, so it won't fail.


---

Comment by @kliem created at 2021-03-18 07:54:04

gfan only checks plain cdd.h

In fact it looks to me, like gfan wouldn't be able to pick up a systems cdd at all (because the headers are in the subfolder cddlib resp. cdd). So that is actually a bug in the install system. Because if you have cdd installed in your system, but gfan not, then you won't be able to build gfan.


---

Comment by @kliem created at 2021-03-18 07:55:38

We should also update topcom's configure patch to match t, the updated version of latte. This should be easy, as we completely control topcom's configure


---

Comment by @kliem created at 2021-03-18 08:01:14

Polymake is a different topic.

According to this https://github.com/polymake/polymake/blob/c2a326f240b11a06e1b1d5fd1c2ca7278bbe60a2/bundled/cdd/support/configure.pl

we probably need to specify the path to cdd. But I wouldn't know how to make this work for the systems cdd. But then again, I don't understand perl at all.


---

Comment by @kliem created at 2021-03-18 08:03:23

I think if we only make sure things don't get worse as they have been, this ticket is very much doable.

We probably need a follow up ticket to fix gfan to work with systems cdd.

Edit: I see, we ignore system cdd installs, if headers are in a subfolder. This is why I have cdd installed in both the system and in sage as well. I guess with the current ticket, we know exactly what we need to do, to be able to drop this.


---

Comment by git created at 2021-03-18 20:24:56

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-03-18 20:27:24

Do you know how to test for the cddlib bug in spkg-configure.m4?


---

Comment by @kliem created at 2021-03-18 20:31:28

Replying to [comment:35 git]:
> Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:
> ||[308274d](https://git.sagemath.org/sage.git/commit/?id=308274d2e56ccd1cb75e471f5d59b8e0ad0111d9)||`update cddlib`||
> ||[ed3ed2a](https://git.sagemath.org/sage.git/commit/?id=ed3ed2a20f98f534d13b461d7b476fbc776928a1)||`build/pkgs/cddlib/spkg-install.in: Install symlinks for cddlib/*.h`||

I'm a bit confused on why you deleted the work issues. Did you forget to push something?


---

Comment by @kliem created at 2021-03-18 20:43:21

Create a file

test.ine

with


```
H-representation
linearity 2 1 2
begin
 5 4 real
 0.0 0.0 1.0 1.0
 -1.0 0.0 1.0 1.0
 -1.0 2.0 -1.0 0.0
 -1.0 4.0 -2.0 0.0
 1 0 0 0
end
```


and run `cddexec --redcheck <test.ine`.

The line `Redundant rows are` should not contain a `1`.


---

Comment by mkoeppe created at 2021-03-18 20:49:33

Replying to [comment:37 gh-kliem]:
> I'm a bit confused on why you deleted the work issues. Did you forget to push something?

I thought the result of our discussion was that by installing the symlinks, we do not have to fix anything in the other packages.


---

Comment by mkoeppe created at 2021-03-18 20:50:44

Or is there a package that no longer finds a prefix-less system cdd?


---

Comment by @kliem created at 2021-03-18 21:29:39

I see.

Ok, then technically the latte upgrade isn't a decency anymore.


---

Comment by git created at 2021-03-18 22:00:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-03-18 22:23:57

OK... the new configure check works correctly on `homebrew-macos-standard` (result: `yes` - but then the package is rejected because the headers are in the new place) and on `ubuntu-focal-standard` (result: `no`).


---

Comment by mkoeppe created at 2021-03-18 22:23:57

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-03-24 00:29:49

Let's please get this fix into 9.3


---

Comment by dimpase created at 2021-03-25 18:42:11

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-03-25 18:42:11

ok


---

Comment by @kliem created at 2021-03-25 18:52:32

Thank you.


---

Comment by mkoeppe created at 2021-03-25 19:10:30

Thanks!


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Changing priority from critical to blocker.


---

Comment by mkoeppe created at 2021-03-29 23:54:39

Setting priority to blocker to bring this ticket to the attention of the release bot.


---

Comment by vbraun created at 2021-04-01 19:45:17

Resolution: fixed
