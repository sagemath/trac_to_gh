# Issue 32522: ./configure --disable-doc

Issue created by migration from https://trac.sagemath.org/ticket/32759

Original creator: mkoeppe

Original creation time: 2021-10-24 22:45:48

CC:  @tobiasdiez dimpase jhpalmieri tmonteil

This switch will disable the docbuild and installation of its many dependencies (sphinx...)

Split out from #31396.


---

Comment by git created at 2021-10-25 00:28:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-25 01:56:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-25 01:56:47

Changing status from new to needs_review.


---

Comment by git created at 2021-10-25 02:37:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-10-29 23:18:18

If `--disable-doc` is given, then should `doc` be removed from the `all-start` target, so that `make` doesn't try to build the docs?


---

Comment by jhpalmieri created at 2021-10-29 23:27:13

Also, after I used `./configure --disable-doc`, packages like `alabaster` and `sphinxcontrib-...` were built anyway.


---

Comment by mkoeppe created at 2021-10-29 23:27:56

Replying to [comment:9 jhpalmieri]:
> If `--disable-doc` is given, then should `doc` be removed from the `all-start` target, so that `make` doesn't try to build the docs?

Yes, that's a good idea.


---

Comment by jhpalmieri created at 2021-10-29 23:31:02

`config.log` says (for example)

```
configure:45112: result: sphinx-4.2.0:                                standard, but disabled using configure option
```

but maybe the problem is that I ran `make` instead of `make build`?


---

Comment by mkoeppe created at 2021-10-29 23:50:14

Yes, probably the `all-start` target pulled in the doc dependencies.


---

Comment by git created at 2021-11-09 01:28:29

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-11-09 01:29:30

Replying to [comment:11 mkoeppe]:
> Replying to [comment:9 jhpalmieri]:
> > If `--disable-doc` is given, then should `doc` be removed from the `all-start` target, so that `make` doesn't try to build the docs?
> 
> Yes, that's a good idea.

This is implemented now, via #31356


---

Comment by git created at 2021-11-10 22:54:23

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2021-11-10 22:54:39

Rebased on top of updated #31356


---

Comment by jhpalmieri created at 2021-11-11 04:04:31

Should we expect doctests to pass with `./configure --disable-doc`? I get

```
src/sage/misc/sagedoc.py  # 8 doctests failed
src/sage_docbuild/utils.py  # 5 doctests failed
src/sage_docbuild/__init__.py  # 38 doctests failed
src/sage_docbuild/sphinxbuild.py  # 13 doctests failed
src/sage/docs/conf.py  # 1 doctest failed
```

which is not surprising, but should they be tagged so that they are only tested when `sagemath_doc_html` is built?


---

Comment by mkoeppe created at 2021-11-11 04:12:20

`git grep 'dochtml'` shows that we already seem to have an optional tag for this kind of thing.

We should probably replace it by `# optional - sagemath_doc_html` and add the missing ones for the failing doctests.


---

Comment by jhpalmieri created at 2021-11-11 04:20:26

Right, and then in the top-level `Makefile`, this line needs to be changed:

```
TESTALL_FLAGS = --optional=sage,dochtml,optional,external,build
```

and maybe the last line in this block from `src/sage/doctest/control.py`:

```
            if have_git:
                self.files.append(opj(SAGE_SRC, 'sage_setup'))
                self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
```

Perhaps define `have_docs` appropriately and have a separate `if have_docs` block. Either that or tag everything in `sage_docbuild`.


---

Comment by jhpalmieri created at 2021-11-11 04:29:41

Something like this?

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 858d8cb567..8dbb693e22 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -727,13 +727,14 @@ class DocTestController(SageObject):
             Doctesting ...
         """
         opj = os.path.join
-        from sage.env import SAGE_SRC, SAGE_DOC_SRC, SAGE_ROOT, SAGE_ROOT_GIT
+        from sage.env import SAGE_SRC, SAGE_DOC_SRC, SAGE_DOC, SAGE_ROOT, SAGE_ROOT_GIT
         # SAGE_ROOT_GIT can be None on distributions which typically
         # only have the SAGE_LOCAL install tree but not SAGE_ROOT
         if SAGE_ROOT_GIT is not None:
             have_git = os.path.isdir(SAGE_ROOT_GIT)
         else:
             have_git = False
+        have_docs = os.path.isdir(opj(SAGE_DOC, 'html', 'en', 'tutorial'))
 
         def all_files():
             self.files.append(opj(SAGE_SRC, 'sage'))
@@ -742,7 +743,8 @@ class DocTestController(SageObject):
             # don't make sense to run outside a build environment
             if have_git:
                 self.files.append(opj(SAGE_SRC, 'sage_setup'))
-                self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
+                if have_docs:
+                    self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
             self.files.append(SAGE_DOC_SRC)
 
         if self.options.all or (self.options.new and not have_git):
```



---

Comment by mkoeppe created at 2021-11-11 04:36:57

I think it would make more sense to just test whether `opj(SAGE_SRC, 'sage_docbuild')` exists.

Same for `sage_setup`.

I think we can get rid of the `have_git` logic


---

Comment by jhpalmieri created at 2021-11-11 04:46:37

By the way, with `make distclean && ./configure --disable-doc && make build`, the various sphinx packages are still being built.


---

Comment by git created at 2021-11-11 05:12:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-11-11 05:12:39

Replying to [comment:18 mkoeppe]:
> Rebased on top of updated #31356

... I had lost most of the commits in this rebase.

Fixed.


---

Comment by jhpalmieri created at 2021-11-11 05:18:01

Replying to [comment:23 mkoeppe]:
> I think it would make more sense to just test whether `opj(SAGE_SRC, 'sage_docbuild')` exists.
> 
> Same for `sage_setup`.
> 
> I think we can get rid of the `have_git` logic

Either that or test whether we can import `sage_docbuild`. I think the directory will exist (in a source distribution) regardless, but we don't want to test if we haven't at least built `sage_docbuild`. That seems cleaner than tagging everything in those files `optional - sage_docbuild`.


---

Comment by mkoeppe created at 2021-11-11 05:21:58

I think the doctesting logic is that the source tree (in SAGE_ROOT/src) is preferred over installed sources, which are only used for falling back (for example for use in downstream packaging). But I agree, when falling back to installed sources, then importing `sage_docbuild` and using its `__path__` is the right solution


---

Comment by jhpalmieri created at 2021-11-11 05:24:57

My point is that the typical doctest in `sage_docbuild/*` starts with `from sage_docbuild import ...`, so we shouldn't bother to test (as part of `make testall` etc.) if we can't import `sage_docbuild`. So I suggest something like:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 858d8cb567..2bf0a4beb4 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -740,9 +740,13 @@ class DocTestController(SageObject):
             # Don't run these tests when not in the git repository; they are
             # of interest for building sage, but not for runtime behavior and
             # don't make sense to run outside a build environment
-            if have_git:
+            if os.path.isdir(opj(SAGE_SRC, 'sage_setup')):
                 self.files.append(opj(SAGE_SRC, 'sage_setup'))
+            try:
+                import sage_docbuild
                 self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
+            except ImportError:
+                pass
             self.files.append(SAGE_DOC_SRC)
 
         if self.options.all or (self.options.new and not have_git):
```



---

Comment by mkoeppe created at 2021-11-11 05:26:25

Ah ok, I agree. Same for `sage_setup` then, I think


---

Comment by git created at 2021-11-11 05:28:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 05:35:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-11 05:35:54

Is it possible that `SAGE_DOC_SRC` might be missing? We could do this:

```diff
diff --git a/src/sage/doctest/control.py b/src/sage/doctest/control.py
index 858d8cb567..86dbd24d1a 100644
--- a/src/sage/doctest/control.py
+++ b/src/sage/doctest/control.py
@@ -737,13 +737,22 @@ class DocTestController(SageObject):
 
         def all_files():
             self.files.append(opj(SAGE_SRC, 'sage'))
-            # Don't run these tests when not in the git repository; they are
-            # of interest for building sage, but not for runtime behavior and
-            # don't make sense to run outside a build environment
-            if have_git:
+            # Only test sage_setup and sage_docbuild if the relevant
+            # imports work. They may not work if not in a build
+            # environment or if the documentation build has been
+            # disabled.
+            try:
+                import sage_setup
                 self.files.append(opj(SAGE_SRC, 'sage_setup'))
+            except ImportError:
+                pass
+            try:
+                import sage_docbuild
                 self.files.append(opj(SAGE_SRC, 'sage_docbuild'))
-            self.files.append(SAGE_DOC_SRC)
+            except ImportError:
+                pass
+            if os.path.isdir(SAGE_DOC_SRC):
+                self.files.append(SAGE_DOC_SRC)
 
         if self.options.all or (self.options.new and not have_git):
             self.log("Doctesting entire Sage library.")
```

----
New commits:


---

Comment by jhpalmieri created at 2021-11-11 05:37:22

Can we autodetect `sagemath_doc_html` as an optional tag to add for testing?


---

Comment by mkoeppe created at 2021-11-11 05:40:31

Yes, I think it should be autodetected already because `sagemath_doc_html` is just an installed package


---

Comment by mkoeppe created at 2021-11-11 05:41:22

Replying to [comment:33 jhpalmieri]:
> Is it possible that `SAGE_DOC_SRC` might be missing?
Yes, I think so, for example in downstream packaging of sage


---

Comment by jhpalmieri created at 2021-11-11 05:42:11

Replying to [comment:35 mkoeppe]:
> Yes, I think it should be autodetected already because `sagemath_doc_html` is just an installed package

Does that mean we shouldn't manually add it to `TESTALL_FLAGS` and let it happen automatically?


---

Comment by mkoeppe created at 2021-11-11 05:52:06

Yes, that's a good point


---

Comment by mkoeppe created at 2021-11-11 05:53:54

Not sure how to implement `TESTALL_NODOC_FLAGS` then 

```
TESTALL_FLAGS = --optional=sage,sagemath_doc_html,optional,external,build
TESTALL_NODOC_FLAGS = --optional=sage,optional,external,build
```



---

Comment by mkoeppe created at 2021-11-11 05:54:50

(introduced in #31084)


---

Comment by jhpalmieri created at 2021-11-11 06:05:31

Deprecate the `nodoc` targets and tell people to use `./configure --disable-doc` instead?

Or leave it with the two `FLAGS` being identical? Running `make ptest-nodoc` runs `make build` and so shouldn't build `sagemath_doc_html`, so it shouldn't run tests with that flag, while `make ptest` runs `make` and so will build `sagemath_doc_html`.


---

Comment by mkoeppe created at 2021-11-11 06:12:28

Thanks for the analysis, I like the 2nd option


---

Comment by git created at 2021-11-11 06:14:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 06:16:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-11 06:17:29

Could you push the change from comment:33 to the ticket please?


---

Comment by mkoeppe created at 2021-11-11 18:01:08

Replying to [comment:19 jhpalmieri]:
> Should we expect doctests to pass with `./configure --disable-doc`? I get
> {{{
> src/sage/misc/sagedoc.py  # 8 doctests failed [...]
> }}}

Not sure what to do with these ones. What's happening here is that `sage.misc.sagedoc.detex` has a run-time dependency on Sphinx.
----
New commits:


---

Comment by mkoeppe created at 2021-11-11 18:21:03

Replying to [comment:35 mkoeppe]:
> Yes, I think it should be autodetected already because `sagemath_doc_html` is just an installed package
Actually, at the moment this is not true because `sage.doctest.control` only looks at the optional packages.
----
New commits:


---

Comment by jhpalmieri created at 2021-11-11 19:47:44

What mechanism adds `sage.geometry.polyhedron` and `sage_spkg` to the list of tags?


---

Comment by git created at 2021-11-11 20:40:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-11 20:41:37

It's happening in the lines of code in the middle of which I have just inserted a test for `sphinx`


---

Comment by mkoeppe created at 2021-11-11 20:42:23

In #32174 I am hoping to unify all that


---

Comment by git created at 2021-11-11 20:51:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 20:54:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 21:17:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-11 21:24:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-11 21:58:16

By the way, this fails:

```
make distclean
./configure --disable-doc
make
make doc-html
```

I think the error boils down to

```
[reference] intersphinx inventory '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/share/doc/pplpy/objects.inv' not fetchable due to <class 'FileNotFoundError'>: [Errno 2] No such file or directory: '/Users/palmieri/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta5/local/share/doc/pplpy/objects.inv'
```

The problem is that `pplpy` doesn't build its documentation the first time, and then it doesn't get rebuilt when `make doc-html` is run. I don't know how to fix this.


---

Comment by jhpalmieri created at 2021-11-11 22:50:28

With `make distclean && ./configure && make ptestlong`, I get two doctest failures:

```
File "src/sage/all.py", line 31, in sage.all
Failed example:
    [inspect.getmodule(f).__name__ for f in frames if is_not_allowed(f)]
Expected:
    []
Got:
    ['pytz', 'importlib.resources']
```

and

```
File "src/sage/misc/sagedoc.py", line 31, in sage.misc.sagedoc
Failed example:
    "sphinx" in sys.modules
Expected:
    False
Got:
    True
```



---

Comment by mkoeppe created at 2021-11-11 23:14:16

Replying to [comment:59 jhpalmieri]:
> The problem is that `pplpy` doesn't build its documentation the first time, and then it doesn't get rebuilt when `make doc-html` is run. I don't know how to fix this.

We can introduce a separate package `pplpy_doc`, something that would actually also make sense for the upstream Python package.


---

Comment by git created at 2021-11-11 23:37:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-12 00:12:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-12 00:31:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-12 00:34:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-12 00:38:55

Replying to [comment:60 jhpalmieri]:
> With `make distclean && ./configure && make ptestlong`, I get two doctest failures:
> {{{
> File "src/sage/all.py", line 31, in sage.all
> Failed example:
>     [inspect.getmodule(f).__name__ for f in frames if is_not_allowed(f)]
> Expected:
>     []
> Got:
>     ['pytz', 'importlib.resources']
> }}}

I've updated this doctest for the stuff that is pulled in by the doctest framework via Sphinx.

> and
> {{{
> File "src/sage/misc/sagedoc.py", line 31, in sage.misc.sagedoc
> Failed example:
>     "sphinx" in sys.modules
> Expected:
>     False
> Got:
>     True
> }}}

Fixed by starting a fresh interpreter for this test. Had to pull in 2 tickets that fixed issues with recursive invocation of sage


---

Comment by git created at 2021-11-12 03:08:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-12 03:39:41

With `--disable-doc`, `make doc-html` goes through but ends with

```
touch: /var/lib/sage/installed/sagemath_doc_html-none: No such file or directory
make[2]: *** [sagemath_doc_html-SAGE_DOCS-no-deps] Error 1
```



---

Comment by mkoeppe created at 2021-11-12 04:49:30

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2021-11-12 18:47:44

For reasons I don't understand, my computer is now refusing to build the plots in the documentation — it keeps hanging in `references/plotting`. After fighting with this for a while, I've given in and am resuming testing using `export SAGE_DOCBUILD_OPTS=' --no-plot'`.

(Not related to this ticket: this happens with the `develop` branch, too.)


---

Comment by git created at 2021-11-12 18:49:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-12 18:50:24

Replying to [comment:70 mkoeppe]:
> With `--disable-doc`, `make doc-html` goes through but ends with
> {{{
> touch: /var/lib/sage/installed/sagemath_doc_html-none: No such file or directory
> make[2]: *** [sagemath_doc_html-SAGE_DOCS-no-deps] Error 1
> }}}

Fixed now by explicitly raising a clear error.

Do we want `make doc`, `make doc-html` to work when `--disable-doc` has been configured?


---

Comment by jhpalmieri created at 2021-11-12 19:12:29

Replying to [comment:74 mkoeppe]:
> Do we want `make doc`, `make doc-html` to work when `--disable-doc` has been configured?

Good question, I don't know. Should the following work? Does it work?

```
make distclean
./configure --disable-doc
make
./configure --enable-doc # without make distclean or similar
make doc-html
```



---

Comment by jhpalmieri created at 2021-11-12 19:24:33

Replying to [comment:75 jhpalmieri]:
> Replying to [comment:74 mkoeppe]:
> > Do we want `make doc`, `make doc-html` to work when `--disable-doc` has been configured?
> 
> Good question, I don't know.

I think I would be happy if it didn't work but if there were a clear error message.

```
% make doc
...
Error: Sage build configured with --disable-doc, so building the documentation will not work. To fix this, ...
```



---

Comment by mkoeppe created at 2021-11-12 19:58:56

Replying to [comment:75 jhpalmieri]:
> Should the following work? Does it work?
> {{{
> make distclean
> ./configure --disable-doc
> make
> ./configure --enable-doc # without make distclean or similar
> make doc-html
> }}}

Yes, I think this works


---

Comment by git created at 2021-11-12 20:11:47

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-12 20:12:28

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-11-12 23:22:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-13 00:03:02

With `./configure --disable-docs && make`, I'm getting

```
[pplpy-0.8.6] Finished installing pplpy-0.8.6
make --no-print-directory pplpy_doc-SAGE_DOCS-no-deps
Error: The installation tree SAGE_DOCS has been disabled
This Sage build is configured with configure --disable-doc, so building the documentation will not work.
make[4]: *** [pplpy_doc-SAGE_DOCS-no-deps] Error 1
make[3]: *** [/var/lib/sage/installed/pplpy_doc-0.8.6] Error 2
make[3]: *** Waiting for unfinished jobs....
```

This even happens after I made this change:

```diff
diff --git a/configure.ac b/configure.ac
index cec63aa918..fab7171839 100644
--- a/configure.ac
+++ b/configure.ac
@@ -475,7 +475,7 @@ AC_ARG_ENABLE([doc],
   AS_HELP_STRING([--disable-doc],
                  [disable build of the Sage documentation and packages depending on it]), [
     dnl Disable packages needed for docbuilding
-    for pkg in sage_docbuild alabaster babel snowballstemmer idna urllib3 certifi charset_normalizer requests imagesize sphinx sphinxcontrib_devhelp sphinxcontrib_jsmath sphinxcontrib_serializinghtml sphinxcontrib_applehelp sphinxcontrib_htmlhelp sphinxcontrib_qthelp sphinxcontrib_websupport; do
+    for pkg in sage_docbuild alabaster babel snowballstemmer idna urllib3 certifi charset_normalizer requests imagesize sphinx sphinxcontrib_devhelp sphinxcontrib_jsmath sphinxcontrib_serializinghtml sphinxcontrib_applehelp sphinxcontrib_htmlhelp sphinxcontrib_qthelp sphinxcontrib_websupport pplpy_doc; do
       AS_VAR_SET([SAGE_ENABLE_$pkg], [$enableval])
     done
     dnl Disable the docbuild by disabling the install tree for documentation
```



---

Comment by jhpalmieri created at 2021-11-13 00:44:40

It seems to be okay now. Maybe I need to run `./bootstrap` or something similar (although the old `config.log` said that it wasn't building `pplpy_doc`.)


---

Comment by mkoeppe created at 2021-11-13 00:45:50

Yes, it sounds like `bootstrap` wasn't run.


---

Comment by git created at 2021-11-13 01:17:04

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2021-11-13 01:17:43

Merged #29039 to resolve a merge conflict


---

Comment by mkoeppe created at 2021-11-13 01:26:47

Possibly the last commit also fixed comment:81


---

Comment by jhpalmieri created at 2021-11-13 16:36:53

Everything builds for me, but my computer continues to misbehave, so I am not getting meaningful output on doctests. This is with OS X Monterey, and I have merged #32852. Many doctests involving plotting are timing out, so I get lots of doctest failures, and I don't know why. I tried a few sample plots interactively and they work.


---

Comment by mkoeppe created at 2021-11-13 19:47:07

Running some tests with `EXTRA_CONFIGURE_ARGS="--disable-doc" tox -e docker-ubuntu-focal-standard`.

Build went through but I am getting these failures on `make ptestlong`:

```
sage -t --long --random-seed=28205743117922504880455715083835945768 src/doc/en/tutorial/conf.py
    ModuleNotFoundError in doctesting framework
**********************************************************************
Traceback (most recent call last):
  File "/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/forker.py", line 2465, in __call__
    doctests, extras = self._run(runner, options, results)
  File "/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/forker.py", line 2513, in _run
    doctests, extras = self.source.create_doctests(sage_namespace)
  File "/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/sources.py", line 733, in create_doctests
    load(filename, namespace) # errors raised here will be caught in DocTestTask
  File "/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/repl/load.py", line 252, in load
    exec(code, globals)
  File "./conf.py", line 12, in <module>
  File "/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/docs/conf.py", line 3, in <module>
    import sphinx
ModuleNotFoundError: No module named 'sphinx'

File "src/doc/en/thematic_tutorials/sandpile.rst", line 1457, in doc.en.thematic_tutorials.sandpile
Failed example:
    Sandpile.help()
[formatting details]
```



---

Comment by git created at 2021-11-13 20:02:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-13 20:08:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-13 22:57:23

A few more failures

```
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/databases/findstat.py  # 94 doctests failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/doctest/test.py  # 7 doctests failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/doctest/sources.py  # 1 doctest failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/misc/bindable_class.py  # 2 doctests failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/misc/sagedoc.py  # 1 doctest failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/misc/sphinxify.py  # 7 doctests failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/misc/sageinspect.py  # 1 doctest failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/repl/ipython_tests.py  # 2 doctests failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/sandpiles/sandpile.py  # 1 doctest failed
sage -t --long --random-seed=184472493071993940636041244744568712523 src/sage/tests/lazy_imports.py  # 1 doctest failed
```



---

Comment by mkoeppe created at 2021-11-13 22:59:50

The `findstat` failures are:

```
      File "/sage/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/databases/findstat.py", line 240, in <module>
        import requests
    ModuleNotFoundError: No module named 'requests'
```



---

Comment by git created at 2021-11-13 23:08:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-13 23:14:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-13 23:19:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-13 23:34:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-14 03:00:04

On an Ubuntu virtual machine, I'm getting doctest failures (with `./configure --disable-doc`) because the `alabaster` package is not installed:

```
File "src/sage/misc/package.py", line 388, in sage.misc.package.installed_packages
Failed example:
    sorted(installed_packages().keys())  # optional - build
Expected:
    [...'alabaster', ...'sage_conf', ...]
Got:
    ['appnope',
     'arb',
     'argcomplete',
     'argon2_cffi',
     'attrs',
     'backcall',
     'bleach',
     'cddlib',
     'certifi',
     'cffi',
     'charset_normalizer',
     'combinatorial_designs',
     'conway_polynomials',
     'cvxopt',
     'cycler',
     'cypari',
     'cysignals',
     'cython',
     'dateutil',
     'debugpy',
     'decorator',
     'defusedxml',
     'docutils',
     'ecl',
     'eclib',
     'elliptic_curves',
     'entrypoints',
     'flint',
     'flit_core',
     'fplll',
     'fpylll',
     'gap',
     'gengetopt',
     'giac',
     'gmpy2',
     'graphs',
     'html5lib',
     'idna',
     'importlib_metadata',
     'importlib_resources',
     'ipykernel',
     'ipython',
     'ipython_genutils',
     'ipywidgets',
     'jedi',
     'jinja2',
     'jmol',
     'jsonschema',
     'jupyter_client',
     'jupyter_core',
     'jupyter_jsmol',
     'jupyterlab_pygments',
     'kiwisolver',
     'lcalc',
     'linbox',
     'markupsafe',
     'mathjax',
     'matplotlib',
     'matplotlib_inline',
     'maxima',
     'memory_allocator',
     'mistune',
     'mpmath',
     'nbclient',
     'nbconvert',
     'nbformat',
     'nest_asyncio',
     'networkx',
     'notebook',
     'numpy',
     'packaging',
     'pandocfilters',
     'pari',
     'pari_galdata',
     'pari_seadata_small',
     'parso',
     'pexpect',
     'pickleshare',
     'pillow',
     'pip',
     'pkgconfig',
     'pluggy',
     'polytopes_db',
     'pplpy',
     'prometheus_client',
     'prompt_toolkit',
     'ptyprocess',
     'py',
     'pybind11',
     'pycparser',
     'pycygwin',
     'pygments',
     'pyparsing',
     'pyrsistent',
     'pytz',
     'pyzmq',
     'ratpoints',
     'requests',
     'rpy2',
     'sage_conf',
     'sage_setup',
     'sagelib',
     'sagenb_export',
     'sagetex',
     'scipy',
     'send2trash',
     'setuptools',
     'setuptools_scm',
     'setuptools_wheel',
     'simplegeneric',
     'singular',
     'six',
     'sympy',
     'terminado',
     'testpath',
     'thebe',
     'threejs',
     'tomli',
     'tornado',
     'traitlets',
     'typing_extensions',
     'tzlocal',
     'urllib3',
     'vcversioner',
     'wcwidth',
     'webencodings',
     'wheel',
     'widgetsnbextension',
     'zipp']
**********************************************************************
File "src/sage/misc/package.py", line 390, in sage.misc.package.installed_packages
Failed example:
    installed_packages()['alabaster']  # optional - build, random
Exception raised:
    Traceback (most recent call last):
      File "/home/john/Sage/sage-9.5.beta5/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/forker.py", line 694, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/john/Sage/sage-9.5.beta5/local/var/lib/sage/venv-python3.8/lib/python3.8/site-packages/sage/doctest/forker.py", line 1088, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.package.installed_packages[1]>", line 1, in <module>
        installed_packages()['alabaster']  # optional - build, random
    KeyError: 'alabaster'
*********************************************************************
```



---

Comment by jhpalmieri created at 2021-11-14 03:03:10

Also, and maybe this is just how it will have to be, if I use `./configure --disable-doc` and then `make` and then `make doc`, it installs `sphinx` and various other packages, prints a good error message when trying to install `pplpy_doc`, but of continues to install whatever it's in the middle of, so the error message gets buried.


---

Comment by git created at 2021-11-14 03:14:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-14 03:18:07

Replying to [comment:98 jhpalmieri]:
> Also, and maybe this is just how it will have to be, if I use `./configure --disable-doc` and then `make` and then `make doc`, it installs `sphinx` and various other packages, prints a good error message when trying to install `pplpy_doc`, but of continues to install whatever it's in the middle of, so the error message gets buried.

I think it would be too complicated to check for disable-doc earlier


---

Comment by mkoeppe created at 2021-11-14 18:57:52

Replying to [comment:97 jhpalmieri]:
> On an Ubuntu virtual machine, I'm getting doctest failures (with `./configure --disable-doc`) because the `alabaster` package is not installed

This was also the last failure on my test with macOS, fixed in 1807446 above.


---

Comment by git created at 2021-11-14 19:06:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jhpalmieri created at 2021-11-15 03:37:38

`make doc` now builds both html and pdf, whereas before it just built html. How many people will this surprise?


---

Comment by git created at 2021-11-15 03:54:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-15 03:55:09

Thanks for catching this; an unnecessary change


---

Comment by jhpalmieri created at 2021-11-16 04:00:29

This part obviously works, but let me see if I understand the syntax:

```
$(1)-$(4)-no-deps:
	+@if [ -z '$$($(4))' ]; then \
	    echo "Error: The installation tree $(4) has been disabled" 2>&1; \
	    echo "$$($(4)_DISABLED_MESSAGE)" 2>&1; \
	    exit 1; \
```

Is the following right? In the case of this ticket, `$(4)` is `SAGE_DOCS`, and then `$$($(4))` evaluates the Makefile variable `SAGE_DOCS`, which will be empty if docs have been disabled.


---

Comment by mkoeppe created at 2021-11-16 04:40:31

That's right.


---

Comment by jhpalmieri created at 2021-11-16 05:15:40

Okay, let's merge it.


---

Comment by jhpalmieri created at 2021-11-16 05:15:40

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-11-16 05:18:26

Thank you!


---

Comment by git created at 2021-12-12 17:56:48

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2021-12-12 17:56:48

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2021-12-12 17:57:11

Changing status from needs_review to positive_review.


---

Comment by git created at 2021-12-23 21:22:00

Changing status from positive_review to needs_review.


---

Comment by git created at 2021-12-23 21:22:00

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2021-12-23 21:22:30

Merged latest beta to resolve merge conflicts.


---

Comment by jhpalmieri created at 2021-12-23 23:15:06

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2021-12-24 00:07:02

Thanks!


---

Comment by tornaria created at 2021-12-26 23:42:35

There seems to be a merge gone wrong in `src/sage/doctest/control.py`.


---

Comment by mkoeppe created at 2021-12-26 23:43:59

Changing status from positive_review to needs_work.


---

Comment by git created at 2021-12-26 23:52:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-12-26 23:53:08

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-12-29 19:33:03

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-12-31 10:30:17

Changing priority from major to blocker.


---

Comment by dimpase created at 2021-12-31 10:30:17

this fixes pdf building in the latest beta, hence blocker


---

Comment by vbraun created at 2022-01-01 20:15:52

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-01-01 20:15:52

Still broken for me

```
$ make doc-clean
$ make doc-pdf
[...]
[sagemath_doc_pdf-none] LaTeX2e <2020-10-01> patch level 4
[sagemath_doc_pdf-none] L3 programming layer <2021-05-07>
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/oberdiek/hypcap.sty))))
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/titlesec/titlesec.sty [91
[sagemath_doc_pdf-none] (./sphinxlatexnumfig.sty (./sphinxmanual.cls])
[sagemath_doc_pdf-none] (./sphinxmessages.sty
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/generic/babel/babel.sty) (./sphinxlatexlists.sty)
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/amsfonts/umsb.fd)
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/generic/babel/babel.def
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/jknapltx/ursfs.fd))) (./sphinxpackagefootnote.sty
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] (./sphinxlatexstyletext.sty
[sagemath_doc_pdf-none] Document Class: sphinxmanual 2019/12/01 v2.3.0 Document class (Sphinx manual)
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/base/report.cls))
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/jknapltx/mathrsfs.sty) (./sphinxlatexobjects.sty
[sagemath_doc_pdf-none] Document Class: report 2020/04/10 v1.4m Standard LaTeX document class
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/base/size10.clo
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/generic/babel/txtbabel.def) [1 (./sphinxlatexindbibtoc.sty){/usr/share/texli
[sagemath_doc_pdf-none] ve/texmf-var/fonts/map/pdftex/updmap/pdftex.map)))
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] LaTeX Warning: File `{../../../../../local/share/doc/sage/doctrees/en/reference
[sagemath_doc_pdf-none] /plot_directive/sage/combinat/crystals/mv_polytopes-1}.pdf' not found on input 
[sagemath_doc_pdf-none] line 47273.
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] LaTeX Warning: File `{../../../../../local/share/doc/sage/doctrees/en/reference
[sagemath_doc_pdf-none] /plot_directive/sage/combinat/crystals/mv_polytopes-1}.pdf' not found on input 
[sagemath_doc_pdf-none] line 47273.
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] ! Package pdftex.def Error: File `../../../../../local/share/doc/sage/doctrees/
[sagemath_doc_pdf-none] en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1.pdf' not foun
[sagemath_doc_pdf-none] d: using draft setting.
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] See the pdftex.def package documentation for explanation.
[sagemath_doc_pdf-none] Type  H <return>  for immediate help.
[sagemath_doc_pdf-none]  ...                                              
[sagemath_doc_pdf-none]                                                   
[sagemath_doc_pdf-none] l.47273 .../combinat/crystals/mv_polytopes-1}.pdf}
[sagemath_doc_pdf-none]                                                   
[sagemath_doc_pdf-none] ? Latexmk: Index file 'constructions.idx' was written
[sagemath_doc_pdf-none] 
[sagemath_doc_pdf-none] (/usr/share/texlive/texmf-dist/tex/latex/base/makeidx.sty))))
[sagemath_doc_pdf-none] ! Emergency stop.
```

Also this runs in `/home/release/Sage/local/share/doc/sage/latex/en/reference/combinat` and `../../../../../local/share/doc/sage/doctrees/en/reference/plot_directive/sage/combinat/crystals/mv_polytopes-1` is missing `../../..`, how can that ever work?


---

Comment by mkoeppe created at 2022-01-01 20:20:26

How is this `needs_work` for this ticket if it's already broken in 9.5.beta9?


---

Comment by mkoeppe created at 2022-01-01 20:46:46

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2022-01-01 21:11:12

Note that since #29310, you need to use `make doc-uninstall` to get rid of the stuff in `local/share/doc/sage`.


---

Comment by vbraun created at 2022-01-01 23:21:01

So `make doc-clean` doesn't clean any more? We tell people (in the console output, among other places, to run that if they are having trouble with incremental doc builds.

This ticket was supposed to fix #33076 but apparently didn't (or, possibly, the ...-clean targets are totally broken). Are incremental builds still supported?


---

Comment by mkoeppe created at 2022-01-01 23:37:01

Replying to [comment:128 vbraun]:
> This ticket was supposed to fix #33076 but apparently didn't 

I don't think anyone has been able to reproduce the failure that you reported in #33076.


---

Comment by mkoeppe created at 2022-01-01 23:39:18

Replying to [comment:128 vbraun]:
> So `make doc-clean` doesn't clean any more? 

Wasn't me, but I think it was intended as a step in the direction of fixing the "clean" vs. "uninstall" confusion in the Sage build system. More in #21775 and #29097.


---

Comment by jhpalmieri created at 2022-01-01 23:48:43

Replying to [comment:128 vbraun]:
> So `make doc-clean` doesn't clean any more? We tell people (in the console output, among other places, to run that if they are having trouble with incremental doc builds.

That's a good point: see #33104.


---

Comment by jhpalmieri created at 2022-01-01 23:56:08

Replying to [comment:128 vbraun]:
> So `make doc-clean` doesn't clean any more? We tell people (in the console output, among other places, to run that if they are having trouble with incremental doc builds.

After #29310, `make doc-clean` removes the autogenerated stuff in `src/doc/en/reference`, and `make doc-uninstall` removes the built documentation.


---

Comment by jhpalmieri created at 2022-01-01 23:57:16

See also #29097#comment:9.


---

Comment by mkoeppe created at 2022-01-01 23:58:31

Of course a bit of weirdness there is that the inventories / pickles are both input and output for the docbuild.


---

Comment by vbraun created at 2022-01-02 00:52:49

I did a full rebuild after `git clean -f -d -x` and pdf docs still don't build, same failure.


---

Comment by dimpase created at 2022-01-02 09:19:13

Replying to [comment:135 vbraun]:
> I did a full rebuild after `git clean -f -d -x` and pdf docs still don't build, same failure.

What OS etc are you running this on? Any manually tweaked TeX stuff?


---

Comment by vbraun created at 2022-01-02 11:47:08

I'm running Fedora 35, standard OS-wide latex installation. Also the path is wrong inside the TeX file, so the issue is already there before TeX runs.


---

Comment by vbraun created at 2022-01-02 17:20:54

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2022-01-02 17:20:54

Tests fail


---

Comment by mkoeppe created at 2022-01-02 22:10:32

Changing status from needs_work to positive_review.


---

Comment by mkoeppe created at 2022-01-02 22:10:32

Which ones.


---

Comment by git created at 2022-01-02 22:59:39

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-01-02 22:59:39

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2022-01-02 23:01:32

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-01-09 10:47:16

Resolution: fixed
