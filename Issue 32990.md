# Issue 32990: SystemError: calling remove_from_pari_stack() inside sig_on() in expression.pyx

archive/issues_032990.json:
```json
{
    "body": "This isn't reproducible, but googling that `SystemError` shows that similar problems have been reported occasionally:\n\n\n```\nsage -t --long --warn-long 0.0 --random-seed=2017217892802240981152103666301684491 src/sage/symbolic/expression.pyx\n**********************************************************************\nFile \"src/sage/symbolic/expression.pyx\", line 9875, in sage.symbolic.expression.Expression.log_gamma\nFailed example:\n    set_verbose(-1); plot(lambda x: SR(x).log_gamma(), -7,8, plot_points=1000).show()\nException raised:\n...\n      File \"sage/symbolic/expression.pyx\", line 9893, in sage.symbolic.expression.Expression.log_gamma (build/cythonized/sage/symbolic/expression.cpp:77808)\n        sig_on()\n    SystemError: calling remove_from_pari_stack() inside sig_on()\n```\n\n\nTests run on 9.5.rc3.\n\nIssue created by migration from https://trac.sagemath.org/ticket/33227\n\n",
    "created_at": "2022-01-25T00:19:32Z",
    "labels": [
        "symbolics",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.6",
    "title": "SystemError: calling remove_from_pari_stack() inside sig_on() in expression.pyx",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32990",
    "user": "@orlitzky"
}
```
This isn't reproducible, but googling that `SystemError` shows that similar problems have been reported occasionally:


```
sage -t --long --warn-long 0.0 --random-seed=2017217892802240981152103666301684491 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 9875, in sage.symbolic.expression.Expression.log_gamma
Failed example:
    set_verbose(-1); plot(lambda x: SR(x).log_gamma(), -7,8, plot_points=1000).show()
Exception raised:
...
      File "sage/symbolic/expression.pyx", line 9893, in sage.symbolic.expression.Expression.log_gamma (build/cythonized/sage/symbolic/expression.cpp:77808)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
```


Tests run on 9.5.rc3.

Issue created by migration from https://trac.sagemath.org/ticket/33227





---

archive/issue_comments_470512.json:
```json
{
    "body": "This is random but not at all rare...",
    "created_at": "2022-03-27T09:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470512",
    "user": "@vbraun"
}
```

This is random but not at all rare...



---

archive/issue_comments_470513.json:
```json
{
    "body": "Changing keywords from \"\" to \"random_fail\".",
    "created_at": "2022-03-27T09:58:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470513",
    "user": "@vbraun"
}
```

Changing keywords from "" to "random_fail".



---

archive/issue_comments_470514.json:
```json
{
    "body": "`log_gamma` evaluation calls C++ `lgamma` which calls back into Python, so it must not be wrapped in a `sig_on/sig_off` block \n\n```\nconst numeric numeric::lgamma(PyObject* parent) const {\n        int prec = precision(*this, parent);\n        PyObject* field = CBF(prec+15);\n        PyObject* ret = CallBallMethod0Arg(field, const_cast<char*>(\"log_gamma\"), *this);\n        Py_DECREF(field);\n\n        numeric rnum(ret);\n        return ex_to<numeric>(rnum.evalf(0, parent));\n```\n",
    "created_at": "2022-03-27T14:09:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470514",
    "user": "@vbraun"
}
```

`log_gamma` evaluation calls C++ `lgamma` which calls back into Python, so it must not be wrapped in a `sig_on/sig_off` block 

```
const numeric numeric::lgamma(PyObject* parent) const {
        int prec = precision(*this, parent);
        PyObject* field = CBF(prec+15);
        PyObject* ret = CallBallMethod0Arg(field, const_cast<char*>("log_gamma"), *this);
        Py_DECREF(field);

        numeric rnum(ret);
        return ex_to<numeric>(rnum.evalf(0, parent));
```




---

archive/issue_comments_470515.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2022-03-27T14:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470515",
    "user": "@vbraun"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_470516.json:
```json
{
    "body": "New commits:",
    "created_at": "2022-03-27T14:21:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470516",
    "user": "@vbraun"
}
```

New commits:



---

archive/issue_comments_470517.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-03-27T15:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470517",
    "user": "@fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_470518.json:
```json
{
    "body": "ok",
    "created_at": "2022-03-27T15:51:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470518",
    "user": "@fchapoton"
}
```

ok



---

archive/issue_comments_470519.json:
```json
{
    "body": "I guess we could `sig_check()` afterwards instead? But I'm not sure that it's needed.",
    "created_at": "2022-03-27T18:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470519",
    "user": "@orlitzky"
}
```

I guess we could `sig_check()` afterwards instead? But I'm not sure that it's needed.



---

archive/issue_comments_470520.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-03-30T22:33:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32990",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32990#issuecomment-470520",
    "user": "@vbraun"
}
```

Resolution: fixed
