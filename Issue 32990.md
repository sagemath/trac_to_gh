# Issue 32990: SystemError: calling remove_from_pari_stack() inside sig_on() in expression.pyx

Issue created by migration from https://trac.sagemath.org/ticket/33227

Original creator: mjo

Original creation time: 2022-01-25 00:19:32

This isn't reproducible, but googling that `SystemError` shows that similar problems have been reported occasionally:


```
sage -t --long --warn-long 0.0 --random-seed=2017217892802240981152103666301684491 src/sage/symbolic/expression.pyx
**********************************************************************
File "src/sage/symbolic/expression.pyx", line 9875, in sage.symbolic.expression.Expression.log_gamma
Failed example:
    set_verbose(-1); plot(lambda x: SR(x).log_gamma(), -7,8, plot_points=1000).show()
Exception raised:
...
      File "sage/symbolic/expression.pyx", line 9893, in sage.symbolic.expression.Expression.log_gamma (build/cythonized/sage/symbolic/expression.cpp:77808)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
```


Tests run on 9.5.rc3.


---

Comment by vbraun created at 2022-03-27 09:58:47

This is random but not at all rare...


---

Comment by vbraun created at 2022-03-27 09:58:47

Changing keywords from "" to "random_fail".


---

Comment by vbraun created at 2022-03-27 14:09:32

`log_gamma` evaluation calls C++ `lgamma` which calls back into Python, so it must not be wrapped in a `sig_on/sig_off` block 

```
const numeric numeric::lgamma(PyObject* parent) const {
        int prec = precision(*this, parent);
        PyObject* field = CBF(prec+15);
        PyObject* ret = CallBallMethod0Arg(field, const_cast<char*>("log_gamma"), *this);
        Py_DECREF(field);

        numeric rnum(ret);
        return ex_to<numeric>(rnum.evalf(0, parent));
```



---

Comment by vbraun created at 2022-03-27 14:21:41

Changing status from new to needs_review.


---

Comment by vbraun created at 2022-03-27 14:21:41

New commits:


---

Comment by chapoton created at 2022-03-27 15:51:21

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2022-03-27 15:51:21

ok


---

Comment by mjo created at 2022-03-27 18:27:17

I guess we could `sig_check()` afterwards instead? But I'm not sure that it's needed.


---

Comment by vbraun created at 2022-03-30 22:33:25

Resolution: fixed
