# Issue 29174: make sagelib a script package

Issue created by migration from https://trac.sagemath.org/ticket/29411

Original creator: mkoeppe

Original creation time: 2020-03-26 19:02:19

CC:  embray vdelecroix mjo dimpase jhpalmieri fbissey




---

Comment by mkoeppe created at 2020-05-16 04:18:55

New commits:


---

Comment by mkoeppe created at 2020-05-16 05:05:48

Not quite done yet. Next step is to get rid of `src/Makefile.in`, moving the contents into the `spkg-install` and `spkg-clean` scripts.


---

Comment by mkoeppe created at 2020-05-16 05:30:59

The `clean` target should perhaps be transformed into `setup.py clean`, reference: https://github.com/pypa/setuptools/issues/1347


---

Comment by git created at 2020-05-16 07:24:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-16 07:27:32

Replying to [comment:7 mkoeppe]:
> The `clean` target should perhaps be transformed into `setup.py clean`, reference: https://github.com/pypa/setuptools/issues/1347
That's already noted in #21508, will not happen on the present ticket


---

Comment by mkoeppe created at 2020-05-16 07:36:46

TBD: sagelib rebuilds are no longer triggered because it now goes through a non-phony target


---

Comment by git created at 2020-05-16 15:56:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-16 19:50:09

Changing status from new to needs_review.


---

Comment by fbissey created at 2020-05-16 21:31:10

Not quite what I had in mind but this is a step in the right direction. It makes sagelib less special in the build system. I believe the dependency part is OK. The makefile bits deserve a bit scrutiny and field testing.


---

Comment by jhpalmieri created at 2020-05-16 21:52:01

The old `src/Makefile.in` and now the new `build/pkgs/sagelib/spkg-install` has this in it:

```
Hoping that #20382 will make this unnecessary.
```

#20382 has been merged, so perhaps this should be clarified, although not necessarily on this ticket.


---

Comment by mkoeppe created at 2020-05-16 22:01:55

Right, this is now #28815.


---

Comment by git created at 2020-05-16 22:04:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-17 03:35:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-05-17 03:36:42

Ready for review.


---

Comment by git created at 2020-05-17 03:48:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-05-17 03:54:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-05-17 20:06:56

please remove `gcc` from the modified comment in `src/setup.py` - it's a misleading artefact from the past, where gcc was needed to build Sage.


---

Comment by git created at 2020-05-17 20:11:10

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2020-05-17 20:24:32

What is the point of `FORCE` target - to always (re)build sagelib, right?
But is it needed?


---

Comment by mkoeppe created at 2020-05-17 20:45:25

Yes, without it, sagelib would not be rebuilt when source files change.


---

Comment by dimpase created at 2020-05-17 20:57:43

hmm, but why not honestly list deps in a makefile?


---

Comment by mkoeppe created at 2020-05-17 21:00:42

Well, instead of the dependency on FORCE that is listed in `build/pkgs/sagelib/dependencies`, we could make it a dependency on `$(SAGE_SRC) $(SAGE_SRC)/* $(SAGE_SRC)/*/* $(SAGE_SRC)/*/*/* $(SAGE_SRC)/*/*/*/*`, but I don't think this is better


---

Comment by mkoeppe created at 2020-05-17 21:36:55

In other words, we do not have dependency tracking at all for sagelib. Neither of `distutils`, `setuptools`, `cython` seem to have a mechanism for generating dependencies like `gcc -M`. This would be certainly be nice to have; in particular if it included dependencies on "system" headers and libraries, so that sagelib could automatically rebuild when system headers/libraries change (as in, most recently, https://groups.google.com/d/msg/sage-release/A53tGGsJNLg/uA01oUugAQAJ). But that's outside of the scope of this ticket.


---

Comment by dimpase created at 2020-05-17 21:44:59

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-05-17 21:44:59

OK, makes sense.


---

Comment by mkoeppe created at 2020-05-17 23:04:01

Thanks!


---

Comment by mkoeppe created at 2020-05-19 01:25:22

I have created #29711 (sagelib setup.py: Dependencies on header files of packages).


---

Comment by git created at 2020-05-22 05:21:12

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-05-22 05:21:12

Changing status from positive_review to needs_review.


---

Comment by mkoeppe created at 2020-05-22 05:21:44

Redone on top of new version of #29098


---

Comment by mkoeppe created at 2020-05-22 05:21:44

Changing status from needs_review to positive_review.


---

Comment by embray created at 2020-05-28 15:40:27

Oh, I was just thinking about this.  Thanks for picking up the work.  This is something I've been wanting to do for years.


---

Comment by vbraun created at 2020-05-30 21:01:24

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2020-05-30 21:01:24

I'm getting this on kucalk buildbot

```
make[3]: Entering directory '/var/lib/buildbot/slave/sage_git/build/build/make'
cd '/var/lib/buildbot/slave/sage_git/build' && source '/var/lib/buildbot/slave/sage_git/build/src/bin/sage-env' && source '/var/lib/buildbot/slave/sage_git/build/build/bin/sage-build-env-config' && sage-logger -p '/var/lib/buildbot/slave/sage_git/build/build/pkgs/sagelib/spkg-install' '/var/lib/buildbot/slave/sage_git/build/logs/pkgs/sagelib-9.1.rc5.log'
[sagelib-9.1.rc5] /var/lib/buildbot/slave/sage_git/build/local/bin/pkg-config: line 16: /doesnotexist/bin/pkgconf: No such file or directory
[sagelib-9.1.rc5] ************************************************************************
[sagelib-9.1.rc5] Traceback (most recent call last):
[sagelib-9.1.rc5]   File "setup.py", line 72, in <module>
[sagelib-9.1.rc5]     from module_list import ext_modules, library_order
[sagelib-9.1.rc5]   File "/var/lib/buildbot/slave/sage_git/build/src/module_list.py", line 14, in <module>
[sagelib-9.1.rc5]     cblas_pc = pkgconfig.parse('cblas')
[sagelib-9.1.rc5]   File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 248, in parse
[sagelib-9.1.rc5]     _raise_if_not_exists(package)
[sagelib-9.1.rc5]   File "/var/lib/buildbot/slave/sage_git/build/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
[sagelib-9.1.rc5]     raise PackageNotFoundError(package)
[sagelib-9.1.rc5] pkgconfig.pkgconfig.PackageNotFoundError: cblas not found
[sagelib-9.1.rc5] ************************************************************************
[sagelib-9.1.rc5] Error building the Sage library
[sagelib-9.1.rc5] ************************************************************************
[sagelib-9.1.rc5] Please email sage-devel (http://groups.google.com/group/sage-devel)
[sagelib-9.1.rc5] explaining the problem and including the relevant part of the log file
[sagelib-9.1.rc5]   /var/lib/buildbot/slave/sage_git/build/logs/pkgs/sagelib-9.2.beta0.log
[sagelib-9.1.rc5] Describe your computer, operating system, etc.
[sagelib-9.1.rc5] ************************************************************************
[sagelib-9.1.rc5] 
[sagelib-9.1.rc5] real	0m0.117s
[sagelib-9.1.rc5] user	0m0.100s
[sagelib-9.1.rc5] sys	0m0.012s
```



---

Comment by git created at 2020-06-02 03:02:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-02 03:04:00

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-06-02 03:06:03

(simplification in follow-up ticket: #29779 pkg-config installed from SPKG pkgconf should not depend on environment variable SAGE_LOCAL)


---

Comment by dimpase created at 2020-06-02 09:07:29

`kucalk buildbot` -> I read on sage-devel that people suspect it to be running with 
`--with-python=2`, which of course is meaningless with Sage 9.2+.
Perhaps we should make `--with-python=2` trigger an error?


---

Comment by mkoeppe created at 2020-06-02 16:31:02

Replying to [comment:41 dimpase]:
> `kucalk buildbot` -> I read on sage-devel that people suspect it to be running with 
> `--with-python=2`, which of course is meaningless with Sage 9.2+.
> Perhaps we should make `--with-python=2` trigger an error? 
#29669 makes it an error already.

But the above is unrelated to python 2 vs python 3. This error showed up on systems where no system pkg-config is available. Fixed by 1cfed7c.


---

Comment by git created at 2020-06-04 00:52:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-04 18:09:30

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-06-04 18:15:25

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-04 18:16:35

Merged in #29793 to resolve a merge conflict. Needs review


---

Comment by mkoeppe created at 2020-06-04 18:16:35

Changing status from needs_work to needs_review.


---

Comment by git created at 2020-06-07 20:27:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-07 20:28:03

Ah, that's why this was failing on [GitHub](GitHub) runs!


---

Comment by mkoeppe created at 2020-06-10 20:21:59

Ready for review...


---

Comment by dimpase created at 2020-06-12 08:54:46

why do I see `[sagelib-9.1.rc5]` while building, even though

```
$ cat VERSION.txt 
SageMath version 9.2.beta0, Release Date: 2020-05-28
```



---

Comment by mkoeppe created at 2020-06-12 10:59:30

When this ticket is merged, `src/bin/sage-update-version` will update `build/pkgs/sagelib/package-version.txt`, where this comes from


---

Comment by dimpase created at 2020-06-12 14:12:26

OK


---

Comment by dimpase created at 2020-06-12 14:12:26

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-06-12 17:35:47

Thanks!


---

Comment by dimpase created at 2020-06-15 12:25:05

rebased over rebased #29793
----
Last 10 new commits:


---

Comment by git created at 2020-06-25 07:36:51

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-06-25 07:36:51

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by mkoeppe created at 2020-06-25 07:37:33

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2020-06-25 07:37:33

Pushed to wrong ticket, sorry


---

Comment by git created at 2020-06-25 07:38:38

Changing status from positive_review to needs_review.


---

Comment by git created at 2020-06-25 07:38:38

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. This was a forced push. New commits:


---

Comment by mkoeppe created at 2020-06-25 07:39:44

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-07-02 21:30:21

Resolution: fixed


---

Comment by dimpase created at 2020-07-12 09:24:55

this has caused a [breakage of jupyter notebook/server](https://groups.google.com/forum/?utm_medium=email&utm_source=footer#!msg/sage-devel/mWTD0_iBwKc/SDZa965UAQAJ). Apparently some of its dependencies get  "blessed"
by `./sage -b`, but no longer get blessed by `make build`.

----

Running 'make build' on that ticket's commit in the develop branch (0bcd001f760ff724832c32b4f65fa575fd82e000 make sagelib a script package) produces the error for me whereas doing so on the immediately previous commit (10fb62408a9761bf91a95d9eb7d7f16a104924c7 Trac #29289: Remove support for installing old-style SPKGs, deprecated in Sage 6.9) does not. Interestingly, it's been sort of hit-and-miss on whether the error shows up when doing just a './sage -b'.


On Saturday, July 11, 2020 at 5:26:02 PM UTC-7, Paul Masson wrote:

    Just built a ticket based on 9.2.beta3 and the same problem occurs.

    On Saturday, July 11, 2020 at 4:09:56 PM UTC-7, Paul Masson wrote:

        After a successful incremental build from 9.2.beta2, trying to start a new notebook results in the browser console error "Failed to load resource: the server responded with a status of 404 (Not Found)" when trying to fetch Mathjax from http://localhost:8888/nbextensions/mathjax/MathJax.js. Has anyone other than Dima seen this also?

        This appears to be a serious server configuration error. I don't see any ticket in either this beta or the previous one that would cause this. Am I missing some new configuration step? Sage built and runs just fine.


---

Comment by mkoeppe created at 2020-07-12 18:52:33

This is now #30123


---

Comment by jhpalmieri created at 2020-07-16 03:13:32

This broke `sage -b`: it wants to run `make` in a directory with no `Makefile`.
