# Issue 29628: Modularization of sagelib: Break out a separate package sage-objects

Issue created by migration from https://trac.sagemath.org/ticket/29865

Original creator: mkoeppe

Original creation time: 2020-06-15 04:26:08

CC:  vdelecroix tscrim mjo nthiery @timokau chapoton @tobiasdiez klee vbraun

#29864 provides a prototype implementation of separate distutils packages implementing namespace packages using the example `sage-tdlib`.

On top of it, this ticket experiments with breaking out the fundamental package `sage-objects`, outlined in Meta-ticket #29705.


---

Comment by git created at 2020-06-15 07:09:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-15 07:47:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-15 16:17:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-15 19:24:21

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-15 19:25:28

`import sage.structure.all` succeeds now


---

Comment by git created at 2020-06-15 19:50:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-15 19:52:43

Some of the Python modules in `sage.categories` seem to be sensitive to import order.

```
$ build/pkgs/sage_objects/src/.tox/python/bin/python -c 'import sage.categories.map'
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "sage/categories/map.pyx", line 1, in init sage.categories.map (build/cythonized/sage/categories/map.c:16980)
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sage_objects/src/.tox/python/lib/python3.7/site-packages/sage/structure/__init__.py", line 2, in <module>
    import sage.structure.element
  File "sage/structure/parent.pxd", line 12, in init sage.structure.element (build/cythonized/sage/structure/element.c:34583)
  File "sage/categories/map.pxd", line 4, in init sage.structure.parent (build/cythonized/sage/structure/parent.c:27689)
AttributeError: module 'sage.categories.map' has no attribute 'Map'
```

vs.

```
$ build/pkgs/sage_objects/src/.tox/python/bin/python -c 'import sage.structure.all, sage.categories.map'
# succeeds
```



---

Comment by git created at 2020-06-15 20:24:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-15 20:26:20


```
$ build/pkgs/sage_objects/src/.tox/python/bin/python -c 'import sage.structure.all, sage.categories.all'
# succeeds
```

but does not succeed without importing `sage.structure.all` first...


---

Comment by mkoeppe created at 2020-06-15 20:39:40


```
build/pkgs/sage_objects/src/.tox/python/bin/python -c 'import sage.structure.all, sage.categories.all, sage.categories.facade_sets; sage.categories.facade_sets.FacadeSets().example()'
Traceback (most recent call last):
  File "<string>", line 1, in <module>
  File "sage/misc/classcall_metaclass.pyx", line 322, in sage.misc.classcall_metaclass.ClasscallMetaclass.__call__ (build/cythonized/sage/misc/classcall_metaclass.c:1717)
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sage_objects/src/.tox/python/lib/python3.7/site-packages/sage/categories/category_with_axiom.py", line 1993, in __classcall__
    (base_category_class, axiom) = cls._base_category_class_and_axiom
  File "sage/misc/lazy_attribute.pyx", line 699, in sage.misc.lazy_attribute.lazy_class_attribute.__get__ (build/cythonized/sage/misc/lazy_attribute.c:2894)
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sage_objects/src/.tox/python/lib/python3.7/site-packages/sage/categories/category_with_axiom.py", line 1933, in _base_category_class_and_axiom
    base_category_class, axiom = base_category_class_and_axiom(cls)
  File "/Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/build/pkgs/sage_objects/src/.tox/python/lib/python3.7/site-packages/sage/categories/category_with_axiom.py", line 1790, in base_category_class_and_axiom
    assert getattr(base_category_class, axiom, None) is cls, \
  File "sage/misc/lazy_import.pyx", line 498, in sage.misc.lazy_import.LazyImport.__get__ (build/cythonized/sage/misc/lazy_import.c:4236)
  File "sage/misc/lazy_import.pyx", line 188, in sage.misc.lazy_import.LazyImport.get_object (build/cythonized/sage/misc/lazy_import.c:2340)
  File "sage/misc/lazy_import.pyx", line 217, in sage.misc.lazy_import.LazyImport._get_object (build/cythonized/sage/misc/lazy_import.c:2482)
RuntimeError: resolving lazy import FacadeSets during startup
```



---

Comment by git created at 2020-06-15 21:43:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-16 01:01:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-06-16 01:32:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-16 01:55:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-16 02:17:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-16 12:20:27

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2020-06-16 12:26:05

As part of this ticket I made a number of changes to import statements throughout `sage.categories`.
https://git.sagemath.org/sage.git/diff/src/sage/categories/?id=5ec60422cff0e536e913c8e6306de45147b2f129&id2=e2dcdeeabb578c37bcf0361c0be3079315e9252c

Should I put them on a separate ticket to facilitate review?


---

Comment by mkoeppe created at 2020-06-16 19:00:12

Replying to [comment:32 mkoeppe]:
> As part of this ticket I made a number of changes to import statements throughout `sage.categories`.
> https://git.sagemath.org/sage.git/diff/src/sage/categories/?id=5ec60422cff0e536e913c8e6306de45147b2f129&id2=e2dcdeeabb578c37bcf0361c0be3079315e9252c
> 
> Should I put them on a separate ticket to facilitate review?
This is now #29873


---

Comment by mjo created at 2020-06-16 19:58:15

Can all of the functions/methods in sage-objects be run after a pip install, or is it only the import that works? (The existing doctests use various things from sage.all, so no one expects those to work.)


---

Comment by mkoeppe created at 2020-06-16 20:03:29

This is unknown. Activating a part of the testsuite that can/does work, and finding the best way to test this, is TBD. 
I hope some of it can be done through mocking (see #29874).


---

Comment by mkoeppe created at 2020-06-18 02:37:42

Changing status from needs_review to needs_work.


---

Comment by git created at 2020-06-18 03:43:44

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-06-18 04:53:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-18 05:09:15

Tests run at https://github.com/mkoeppe/sage/actions/runs/139194878


---

Comment by git created at 2020-06-18 18:41:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-19 17:34:15

https://github.com/mkoeppe/sage/runs/785565655:

```
  [sage_objects-9.1.rc5]     File "setup.py", line 6, in <module>
  [sage_objects-9.1.rc5]       from sage_setup.command.sage_build_cython import sage_build_cython
  [sage_objects-9.1.rc5]     File "/sage/build/pkgs/sage_objects/src/sage_setup/command/sage_build_cython.py", line 19, in <module>
  [sage_objects-9.1.rc5]       from sage_setup.library_order import library_order
  [sage_objects-9.1.rc5]     File "/sage/build/pkgs/sage_objects/src/sage_setup/library_order.py", line 54, in <module>
  [sage_objects-9.1.rc5]       m4ri_pc = pkgconfig.parse('m4ri')
  [sage_objects-9.1.rc5]     File "/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 248, in parse
  [sage_objects-9.1.rc5]       _raise_if_not_exists(package)
  [sage_objects-9.1.rc5]     File "/sage/local/lib/python3.7/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
  [sage_objects-9.1.rc5]       raise PackageNotFoundError(package)
  [sage_objects-9.1.rc5]   pkgconfig.pkgconfig.PackageNotFoundError: m4ri not found
  [sage_objects-9.1.rc5] Full log file: /sage/logs/pkgs/sage_objects-9.1.rc5.log
```



---

Comment by mkoeppe created at 2020-06-19 17:35:26

Also, of course, installation of `sage_objects` breaks other things in the tests:

```
(build/cythonized/sage/plot/plot3d/shapes.c:12604)
  File "sage/ext/interpreters/wrapper_rdf.pxd", line 7, in init sage.plot.plot3d.parametric_surface (build/cythonized/sage/plot/plot3d/parametric_surface.c:12057)
ModuleNotFoundError: No module named 'sage.ext.interpreters.wrapper_rdf'
```



---

Comment by git created at 2020-06-20 01:34:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-20 05:59:19

I'll probably make `sage-objects` smaller by only including `sage.categories.category` rather than all of `sage.categories`;
and add a package `sage-categories` that is larger than the current version, including also `sage.rings.ring` and similar abstract classes.
(On this ticket, `sage-categories` would just be a larger package whose MANIFEST.in is a superset of that of `sage-objects`. It will be done by dependencies later.)


---

Comment by git created at 2020-06-20 06:01:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-20 14:45:03

This will need #29916 (`sage.structure`: Replace import of `sage.categories.all` by more specific imports)


---

Comment by git created at 2020-06-20 19:27:31

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-06-20 20:02:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-20 21:42:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-21 01:17:42

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-06-22 23:23:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by mkoeppe created at 2020-06-22 23:24:56

Doctesting sage-objects now "works" thanks to #29922.
Of course, most doctests fail because all the concrete classes that are used in the examples are not defined. And the preparsed language also requires `Integer` and `RealNumber`, which we do not have.


---

Comment by mkoeppe created at 2020-06-23 00:36:59

Replying to [comment:54 mkoeppe]:
> I'll probably make `sage-objects` smaller by only including `sage.categories.category` rather than all of `sage.categories`;

this is done (but I temporarily added modules to do doctesting)

> and add a package `sage-categories` that is larger than the current version, including also `sage.rings.ring` and similar abstract classes.

This is probably best to do if we can include `Integer` as well, so that depends on #29911 (remove ntl dependency)


---

Comment by git created at 2020-06-28 01:05:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-06-29 05:45:51

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-06-29 18:38:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-06-29 18:39:15

Before we can add `sage.rings.integer`, we need #30022 (`sage.rings.integer`, `rational`: Remove compile-time dependency on `cypari2` and `flint`).


---

Comment by git created at 2020-06-29 18:52:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-07-26 05:36:53

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2020-07-26 05:48:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-09-08 22:05:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2020-09-08 22:17:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-27 22:26:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-10-27 23:18:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-12-06 17:42:11

Changing keywords from "" to "sd111".


---

Comment by embray created at 2021-02-03 13:40:53

Big +1 from me.  This would be very useful for #31297 and for gappy in general.


---

Comment by embray created at 2021-02-03 14:01:19

Replying to [comment:54 mkoeppe]:
> I'll probably make `sage-objects` smaller by only including `sage.categories.category` rather than all of `sage.categories`;
> and add a package `sage-categories` that is larger than the current version, including also `sage.rings.ring` and similar abstract classes.
> (On this ticket, `sage-categories` would just be a larger package whose MANIFEST.in is a superset of that of `sage-objects`. It will be done by dependencies later.)

Okay.  I was going to say, it seems like sage-objects still depends too heavily on too much of `sage.categories`.  For my purposes I would want it to be as light-weight as possible.

I think it might also be worth it to further divide `SageObject`, `Parent`, and `Element` into some `SageObjectBase`, `ParentBase`, and `ElementBase` that only provide the minimal C-level type structs necessary to bootstrap the rest of the hierarchy.

For `SageObject` this is trivial because its type struct is empty.  For `Parent` and `Element` the `Base` classes need to consist primarily of any cdef attributes which define the type struct.  Anything else is optional and can be bolted on in a subclass.


---

Comment by git created at 2021-02-03 18:33:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-02-03 18:41:44

Yes, I also hope that `sagemath-objects` can be eventually be made even smaller. But the coercion system pulls in quite a bit of the category system (in particular via pushout)


---

Comment by nthiery created at 2021-02-03 21:05:28

This is really cool :-)

I won't alas have time to seriously follow the discussion. But
if at some point it can be useful, I certainly can free myself
for a live discussion.


---

Comment by mkoeppe created at 2021-02-03 21:10:09

Thanks, Nicolas!


---

Comment by git created at 2021-02-03 21:16:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-03 21:40:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-03 21:42:27

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-02-03 22:03:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-02-03 22:33:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dimpase created at 2021-04-22 09:17:33

what's the status here?


---

Comment by mkoeppe created at 2021-04-22 16:07:06

It works but I will want to update it according to the proposed new layout for embedded source trees (#31577)


---

Comment by git created at 2021-06-25 21:47:41

Branch pushed to git repo; I updated commit sha1. This was a forced push. Last 10 new commits:


---

Comment by git created at 2021-06-25 22:06:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-25 22:13:37

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-06-25 22:28:34

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-06-25 22:31:16

Changing status from needs_work to needs_review.


---

Comment by git created at 2021-08-12 21:27:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-12 21:57:10

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-08-12 23:41:54

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-08-12 23:53:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-12 23:57:09


```
    File "setup.py", line 24, in <module>
      from sage.env import SAGE_VERSION
  ModuleNotFoundError: No module named 'sage'
```



---

Comment by git created at 2021-08-13 00:13:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-13 00:14:17


```
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-build-_o5ymrt1/sage_setup/library_order.py", line 14, in <module>
      aliases = cython_aliases()
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-build-_o5ymrt1/sage/env.py", line 451, in cython_aliases
      import pkgconfig
  ModuleNotFoundError: No module named 'pkgconfig'
```



---

Comment by git created at 2021-08-13 00:32:17

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 00:55:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-08-13 01:19:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-13 01:20:45


```
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-f9779kgd/overlay/lib/python3.9/site-packages/sage_setup/command/sage_build_cython.py", line 208, in run
      from ..library_order import library_order
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-f9779kgd/overlay/lib/python3.9/site-packages/sage_setup/library_order.py", line 14, in <module>
      aliases = cython_aliases()
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-build-8_9lsvo_/sage/env.py", line 472, in cython_aliases
      aliases[var + "CFLAGS"] = pkgconfig.cflags(lib).split()
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-f9779kgd/overlay/lib/python3.9/site-packages/pkgconfig/pkgconfig.py", line 144, in cflags
      _raise_if_not_exists(package)
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-f9779kgd/overlay/lib/python3.9/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
      raise PackageNotFoundError(package)
  pkgconfig.pkgconfig.PackageNotFoundError: fflas-ffpack not found
```



---

Comment by git created at 2021-08-13 02:18:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-08-13 02:27:57

More of the same:

```
    File "/usr/local/Cellar/python@3.9/3.9.6/Frameworks/Python.framework/Versions/3.9/lib/python3.9/distutils/dist.py", line 985, in run_command
      cmd_obj.run()
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-build-z0x28qby/sage_setup/command/sage_build_cython.py", line 225, in run
      aliases=cython_aliases(),
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-req-build-z0x28qby/sage/env.py", line 472, in cython_aliases
      aliases[var + "CFLAGS"] = pkgconfig.cflags(lib).split()
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-ti7oa28i/overlay/lib/python3.9/site-packages/pkgconfig/pkgconfig.py", line 144, in cflags
      _raise_if_not_exists(package)
    File "/private/var/folders/38/wnh4gf1552g_crsjnv2vmmww0000gp/T/pip-build-env-ti7oa28i/overlay/lib/python3.9/site-packages/pkgconfig/pkgconfig.py", line 103, in _raise_if_not_exists
      raise PackageNotFoundError(package)
  pkgconfig.pkgconfig.PackageNotFoundError: fflas-ffpack not found
```



---

Comment by git created at 2021-08-28 05:01:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2021-08-28 05:03:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-03 01:07:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-19 00:43:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-09-26 21:23:14

Branch pushed to git repo; I updated commit sha1. Last 10 new commits:


---

Comment by git created at 2021-09-28 15:16:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-12 18:16:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-12 18:18:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-10-29 07:17:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-12 23:46:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-14 05:27:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-16 03:57:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-19 17:24:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-19 17:28:37

Let's get this in please


---

Comment by klee created at 2021-11-25 05:42:31

This command 

```
./bootstrap && ./sage -sh -c '(cd build/pkgs/sagemath_objects/src && tox -v -v -e py39)'
```

results in lots of doctest failures. This is expected. Right?

Then this command

```
pkgs/sagemath-objects/.tox/py39/bin/sage
```

should run the sage with only modules installed by `sagemath-objects`. But then still with this sage, I get

```
sage: GF(9)
Finite Field in z2 of size 3^2
```

Is this normal? What code would fail?


---

Comment by mkoeppe created at 2021-11-25 06:31:39

Replying to [comment:145 klee]:
> This command 
> {{{
> ./bootstrap && ./sage -sh -c '(cd build/pkgs/sagemath_objects/src && tox -v -v -e py39)'
> }}}
> results in lots of doctest failures. This is expected. Right?

Yes.


---

Comment by mkoeppe created at 2021-11-25 06:33:32

Replying to [comment:145 klee]:
> Then this command
> {{{
> pkgs/sagemath-objects/.tox/py39/bin/sage
> }}}
> should run the sage with only modules installed by `sagemath-objects`. But then still with this sage, I get
> {{{
> sage: GF(9)
> Finite Field in z2 of size 3^2
> }}}
> Is this normal? What code would fail?

There was something wrong with which helper scripts are shipped as part of *sagemath-objects*. I am working on a fix


---

Comment by klee created at 2021-11-25 07:03:39

After testing with the two experimental distributions, I could confirm that there are no other doctest failures with the main sage than it already had on develop branch. Hence the two experimental distributions are at least safe to have.

Anyway the failed doctests are

```
sage -t --warn-long 70.5 --random-seed=328015936148055540834358934757959169042 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 325, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    4
**********************************************************************
File "src/sage/tests/cmdline.py", line 330, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    2
```



---

Comment by mkoeppe created at 2021-11-25 18:42:30

Replying to [comment:147 mkoeppe]:
> There was something wrong with which helper scripts are shipped as part of *sagemath-objects*. I am working on a fix

Opened #32933 as part of the fix


---

Comment by mkoeppe created at 2021-11-26 02:08:43

Changing status from needs_review to needs_work.


---

Comment by git created at 2021-11-26 02:17:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-11-26 02:18:27

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2021-11-26 02:18:27

It now correctly fails:

```
$ pkgs/sagemath-objects/.tox/py39/bin/sage -c 'GF(9)'
Traceback (most recent call last):
  File "/Users/mkoeppe/s/sage/sage-rebasing/pkgs/sagemath-objects/.tox/py39/bin/sage-eval", line 4, in <module>
    from sage.all import *
ModuleNotFoundError: No module named 'sage.all'
```



---

Comment by git created at 2021-11-26 02:32:00

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2021-11-26 02:44:14

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2021-11-26 04:55:07

I guess this is normal

```
$ pkgs/sagemath-objects/.tox/py39/bin/sage
Traceback (most recent call last):
  File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-objects/.tox/py39/bin/sage-ipython", line 9, in <module>
    from sage.misc.banner import banner
ModuleNotFoundError: No module named 'sage.misc.banner'
```

but this works well

```
$ pkgs/sagemath-objects/.tox/py39/bin/python3 
Python 3.9.7 (default, Oct 13 2021, 06:45:31) 
[Clang 13.0.0 (clang-1300.0.29.3)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.structure.sage_object import SageObject
>>> SageObject()
<sage.structure.sage_object.SageObject object at 0x10c977f60>
>>> a = SageObject()
>>> a.category()
Category of objects
>>> a
<sage.structure.sage_object.SageObject object at 0x10c977f50>
>>> a.dumps()
b'x\x9ck`J.NLO\xd5+.)*M.)-\x02\xb2\x80\xdc\xf8\xfc\xa4\xac\xd4\xe4\x12\xae` \xdb\x1f\xc2,d\xd0l,d\xd4\x03\x00\xb7P\x10\xef'
>>> a.parent()
<class 'sage.structure.sage_object.SageObject'>
```



---

Comment by klee created at 2021-11-26 05:12:46

Likewise this works well

```
$ pkgs/sagemath-categories/.tox/py39/bin/python3
Python 3.9.7 (default, Oct 13 2021, 06:45:31) 
[Clang 13.0.0 (clang-1300.0.29.3)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> from sage.categories.category import Category
>>> from sage.categories.algebras import Algebras
>>> Algebras(QQ)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
NameError: name 'QQ' is not defined
>>> Algebras(ZZ)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
NameError: name 'ZZ' is not defined
>>> from sage.categories.groups import Groups
>>> Groups()
Category of groups
>>> c = Groups()
>>> c.example()
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/Users/kwankyu/GitHub/sage-dev/pkgs/sagemath-categories/.tox/py39/lib/python3.9/site-packages/sage/categories/groups.py", line 48, in example
    from sage.rings.rational_field import QQ
ModuleNotFoundError: No module named 'sage.rings.rational_field'
>>> from sage.rings.infinity import infinity    
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'sage.rings.infinity'
>>> from sage.rings.integer_ring import ZZ     
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
ModuleNotFoundError: No module named 'sage.rings.integer_ring'
>>> from sage.categories.rings import Rings
>>> r = Rings()
>>> r
Category of rings
>>> r.example()
NotImplemented
```

It seems that there is not much to do with just categories with no constructible objects. This is of course expected.


---

Comment by mkoeppe created at 2021-11-26 05:20:31

In #32432 I am adding a few more things to `sagemath-categories` so that some runtime testing becomes possible


---

Comment by klee created at 2021-11-26 05:53:44

After I started to experiment with the branch of this ticket, I get

```
$ sage -tp --all
...
...
sage -t --warn-long 67.3 --random-seed=176797787270485350725074395342233660735 src/doc/ja/a_tour_of_sage/conf.py
    [0 tests, 0.00 s]
----------------------------------------------------------------------
sage -t --warn-long 67.3 --random-seed=176797787270485350725074395342233660735 src/sage/tests/cmdline.py  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 1819.6 seconds
    cpu time: 11313.2 seconds
    cumulative wall time: 13913.3 seconds
============================================================================ test session starts ============================================================================
platform darwin -- Python 3.9.7, pytest-6.2.5, py-1.10.0, pluggy-1.0.0
rootdir: /Users/kwankyu/GitHub/sage-dev/src, configfile: tox.ini
collected 10 items / 1 error / 9 selected                                                                                                                                   

================================================================================== ERRORS ===================================================================================
____________________________________________________________ ERROR collecting sage/structure/sage_object_test.py ____________________________________________________________
ImportError while importing test module '/Users/kwankyu/GitHub/sage-dev/src/sage/structure/sage_object_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
src/sage/structure/sage_object_test.py:3: in <module>
    from .sage_object import SageObject
E   ImportError: attempted relative import with no known parent package
========================================================================== short test summary info ==========================================================================
ERROR src/sage/structure/sage_object_test.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================================================= 1 error in 5.75s ==============================================================================
```


I have the doctest failures of `src/sage/tests/cmdline.py` on develop branch. So they seem not related with the present branch.

Then what are these messages starting with ===.... test session starts ...===, which shows some failure?


---

Comment by mkoeppe created at 2021-11-26 05:59:12

Replying to [comment:158 klee]:
> Then what are these messages starting with ===.... test session starts ...===, which shows some failure?

At the end of `sage -t`, `pytest` is run; this is from #31003 and follow-up tickets. Tickets #32892 and #31924 are for fixing some of these unsightly messages


---

Comment by klee created at 2021-11-26 06:07:36

Would you explain this line from `tox.ini`?

```
[testenv]
deps = -rrequirements.txt 
```

What does `-r` do?


---

Comment by mkoeppe created at 2021-11-26 06:09:04

It instructs `pip` to install the packages listed in the file `requirements.txt`


---

Comment by klee created at 2021-11-26 06:21:09

I tested with the branch of this ticket, perhaps from a user point of view. I finds it works well, as advertised in the description. So I am positive with the branch.

But I am not capable of reading the code, most of which looks to me cryptic, to give any useful comments. So I leave this task to other reviewer well versed with sage build system and python build tools.

However, if no one gives more comments, then I will set positive review once we have a green bot, as this ticket needs to be closed before sage 9.5 release.


---

Comment by mkoeppe created at 2021-11-26 06:26:48

Thank you!


---

Comment by slelievre created at 2021-11-26 18:48:25

Files in `build/pkgs/sagemath_categories`,
`build/pkgs/sagemath_objects`,
`pkgs/sage-conf_pypi`, `pkgs/sagemath-categories`,
`pkgs/sagemath-objects`,
could ideally end with a newline,
even when they only have one line.


---

Comment by mkoeppe created at 2021-11-26 19:06:54

The files for which the diff shows this:

```
diff --git a/build/pkgs/sagemath_categories/SPKG.rst b/build/pkgs/sagemath_categories/SPKG.rst
new file mode 120000
index 00000000..b4545b4
--- /dev/null
+++ b/build/pkgs/sagemath_categories/SPKG.rst
@@ -0,0 +1 @@
+src/README.rst
\ No newline at end of file
```

are actually symbolic links, and adding a newline is not an option.


---

Comment by slelievre created at 2021-11-26 19:27:39

Never mind then! Sorry for the noise.


---

Comment by klee created at 2021-11-27 10:11:53

Changing status from needs_review to positive_review.


---

Comment by klee created at 2021-11-27 10:11:53

Okay. Let's get this in.


---

Comment by mkoeppe created at 2021-11-27 16:50:55

Thanks!


---

Comment by klee created at 2022-01-03 02:33:58

Why this is not yet merged?


---

Comment by vbraun created at 2022-01-31 23:31:48

Resolution: fixed
