# Issue 25428: threejs viewer broken after Sage 8.3.beta3

Issue created by migration from Trac.

Original creator: egourgoulhon

Original creation time: 2018-06-26 11:49:35

CC:  embray jdemeyer arojas fbissey

Keywords: threejs

Since Sage 8.3.beta3, running the command

```
show(sphere(), viewer='threejs', online=True)
```

in a Jupyter notebook displays nothing. It was fine in Sage <= 8.3.beta2. 
Note that the option `online=True` is required by tools like http://nbviewer.jupyter.org/.

It seems that the issue is due to the following change introduced in #25040 (which has been merged in Sage 8.3.beta3):

```
sage: installed_packages()['threejs']
'r80.p0'
```

while in Sage <= 8.3.beta2, one has

```
sage: installed_packages()['threejs']
'r80'
```

Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py` and it turns out that https://cdn.rawgit.com/mrdoob/three.js/r80/build/three.min.js is a valid url, while https://cdn.rawgit.com/mrdoob/three.js/r80.p0/build/three.min.js is not.


---

Comment by jdemeyer created at 2018-06-26 11:53:02

Replying to [ticket:25665 egourgoulhon]:
> Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`

That's a really bad idea for multiple reasons.


---

Comment by egourgoulhon created at 2018-06-26 12:02:49

Replying to [comment:2 jdemeyer]:
> Replying to [ticket:25665 egourgoulhon]:
> > Indeed the value of `installed_packages()['threejs']` is used to form the url in lines 749-750 of `src/sage/repl/rich_output/display_manager.py`
> 
> That's a really bad idea for multiple reasons.

Yes probably. I guess that was to ensure compatibility between the version of threejs actually used by Sage. By the way, in the directory `upstream`, we have `threejs-r80.tar.gz`, so where does the `.p0` come from?


---

Comment by novoselt created at 2018-06-26 19:03:32

That was indeed to ensure that the same version is used. If there is a better way - please implement it! And an obvious way to get rid of patched suffixes for this particular case is to just use the part of the version before the dot.


---

Comment by chapoton created at 2018-07-01 07:59:10

Changing status from new to needs_review.


---

Comment by chapoton created at 2018-07-01 07:59:10

New commits:


---

Comment by fbissey created at 2018-07-01 08:14:27

The use of is `installed_packages` at runtime in sage is of course one of my pet hates. I don't have an alternative to offer at the present time. In fact I am just realising how this bit is broken in sage-on-gentoo right now (I don't offer an offline option either). Where could I find a list of valid versions for the online cdn? Is there something like "latest"?


---

Comment by egourgoulhon created at 2018-07-01 09:43:36

Thanks for the fix!


---

Comment by egourgoulhon created at 2018-07-01 09:43:36

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-07-07 01:34:46

Resolution: fixed
