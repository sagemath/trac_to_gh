# Issue 30026: declare_union yields wrong results

archive/issues_030026.json:
```json
{
    "body": "CC:  @egourgoulhon @tscrim\n\nKeywords: sets, union\n\n\n```\nsage: M = Manifold(3, 'M')\nsage: U = M.open_subset('U'); V = M.open_subset('V'); W = M.open_subset('W')\nsage: M.declare_union(U, V, W)\n---------------------------------------------------------------------------\nTypeError                                 Traceback (most recent call last)\n<ipython-input-3-c7f527dcc1ea> in <module>()\n----> 1 M.declare_union(U, V, W)\n\nTypeError: declare_union() takes 3 positional arguments but 4 were given\nsage: M.declare_union(U, V.union(W))\nsage: U.union(V).union(W)\nOpen subset U_union_V_union_W of the 3-dimensional differentiable manifold M\nsage: U.union(V.union(W))\n3-dimensional differentiable manifold M\n```\n\n\nI propose to allow more than two arguments for `declare_union`. Furthermore, something went wrong with the commutativity of the union. This should be investigated, too.\n\nIssue created by migration from https://trac.sagemath.org/ticket/30263\n\n",
    "created_at": "2020-08-01T07:11:42Z",
    "labels": [
        "manifolds",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "declare_union yields wrong results",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/30026",
    "user": "@mjungmath"
}
```
CC:  @egourgoulhon @tscrim

Keywords: sets, union


```
sage: M = Manifold(3, 'M')
sage: U = M.open_subset('U'); V = M.open_subset('V'); W = M.open_subset('W')
sage: M.declare_union(U, V, W)
---------------------------------------------------------------------------
TypeError                                 Traceback (most recent call last)
<ipython-input-3-c7f527dcc1ea> in <module>()
----> 1 M.declare_union(U, V, W)

TypeError: declare_union() takes 3 positional arguments but 4 were given
sage: M.declare_union(U, V.union(W))
sage: U.union(V).union(W)
Open subset U_union_V_union_W of the 3-dimensional differentiable manifold M
sage: U.union(V.union(W))
3-dimensional differentiable manifold M
```


I propose to allow more than two arguments for `declare_union`. Furthermore, something went wrong with the commutativity of the union. This should be investigated, too.

Issue created by migration from https://trac.sagemath.org/ticket/30263





---

archive/issue_comments_426825.json:
```json
{
    "body": "Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-04-07T19:29:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426825",
    "user": "@mkoeppe"
}
```

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_426826.json:
```json
{
    "body": "Unions of several subsets also appear in another form - as open covers (which are merely lists of subsets and not manifold subsets in their own right). One might ask whether this could be unified as well.",
    "created_at": "2021-04-18T17:02:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426826",
    "user": "@mkoeppe"
}
```

Unions of several subsets also appear in another form - as open covers (which are merely lists of subsets and not manifold subsets in their own right). One might ask whether this could be unified as well.



---

archive/issue_comments_426827.json:
```json
{
    "body": "An issue with the existing code is that through a sequence of `declare_union` calls, it is possible to obtain a situation in which two subsets must be the same, although `declare_union` makes a (not very effective) attempt to stop the user from doing so (by checking whether the two arguments are the same).\n\nIn terms of the poset of subsets that is defined by the `_subsets` (and `_supersets`) attributes (which is visualized by the code from #31680), this is quite problematic. \n\nThis could be solved by introducing equivalence classes of subsets - for example by keeping the `_subsets` relation acyclic and introducing an `_equal_sets` attribute; loops that update subsets will have to be modified.\nThe elements of the poset introduced in #31680 then would be equivalence classes of subsets rather than subsets.",
    "created_at": "2021-04-21T19:50:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426827",
    "user": "@mkoeppe"
}
```

An issue with the existing code is that through a sequence of `declare_union` calls, it is possible to obtain a situation in which two subsets must be the same, although `declare_union` makes a (not very effective) attempt to stop the user from doing so (by checking whether the two arguments are the same).

In terms of the poset of subsets that is defined by the `_subsets` (and `_supersets`) attributes (which is visualized by the code from #31680), this is quite problematic. 

This could be solved by introducing equivalence classes of subsets - for example by keeping the `_subsets` relation acyclic and introducing an `_equal_sets` attribute; loops that update subsets will have to be modified.
The elements of the poset introduced in #31680 then would be equivalence classes of subsets rather than subsets.



---

archive/issue_comments_426828.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-04-24T02:49:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426828",
    "user": "@mkoeppe"
}
```

Last 10 new commits:



---

archive/issue_comments_426829.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T20:35:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426829",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426830.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-24T21:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426830",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426831.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T00:33:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426831",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426832.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-04-25T06:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426832",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_426833.json:
```json
{
    "body": "Last 10 new commits:",
    "created_at": "2021-05-03T05:51:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/30026",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/30026#issuecomment-426833",
    "user": "@mkoeppe"
}
```

Last 10 new commits:
