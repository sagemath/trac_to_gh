# Issue 14005: Interface to maxima / ecl broken

Issue created by migration from Trac.

Original creator: pipedream

Original creation time: 2013-03-01 14:13:50

Assignee: tbd

Keywords: maxima ecl

From: https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/jIjYSSCPrrY

Initial symptom:
sage: integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)           
2*log(2)
sage: integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)


A closer look:
sage: from sage.interfaces.maxima_lib import sr_to_max
sage: sr_to_max(integral(e^(-abs(x))/cosh(x),x,-infinity,infinity))
<ECL: ((MTIMES) ((%LOG) 2) 2)>
sage: sr_to_max(integral(e^(-abs(x))/cosh(x),x,-infinity,infinity))
---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)


---

Comment by pipedream created at 2013-03-01 14:15:08

Replying to [ticket:14209 pipedream]:
> From: https://groups.google.com/forum/?fromgroups=#!topic/sage-devel/jIjYSSCPrrY
> 
> Initial symptom:
> sage: integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)           
> 2*log(2)
> sage: integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)
> ---------------------------------------------------------------------------
> ValueError                                Traceback (most recent call last)
> 
> 
> A closer look:
> sage: from sage.interfaces.maxima_lib import sr_to_max
> sage: sr_to_max(integral(e^(-abs(x))/cosh(x),x,-infinity,infinity))
> <ECL: ((MTIMES) ((%LOG) 2) 2)>
> sage: sr_to_max(integral(e^(-abs(x))/cosh(x),x,-infinity,infinity))
> ---------------------------------------------------------------------------
> ValueError                                Traceback (most recent call last)
>


---

Comment by kcrisman created at 2013-03-01 16:05:40

Changing component from PLEASE CHANGE to calculus.


---

Comment by kcrisman created at 2013-03-01 16:05:40

Changing assignee from tbd to burcin.


---

Comment by nbruin created at 2013-03-01 18:49:15

Just a couple of notes:
 - we patch maxima to throw an error rather than print "Principal Value".
 - internally, maxima has a flag that gets set if Principal Value has already been printed, to prevent it from being printed repeatedly.
 - this flag also gets used to suppress the "Principal Value" warning in certain cases where their integration code apparently knows it's safe to take a principal value.
 - so we don't throw an error if maxima wouldn't print the warning.

It would seem something about this setting gets messed up. My guess it's the way maxima deals internally with the doubly infinite integral:

```
sage: integrate(exp(-abs(x))/cosh(x),x,-oo,0)
log(2)
sage: integrate(exp(-abs(x))/cosh(x),x,0,oo)
log(2)
sage: integrate(exp(-abs(x))/cosh(x),x,-oo,0)
log(2)
sage: integrate(exp(-abs(x))/cosh(x),x,0,oo)
log(2)
sage: integrate(exp(-abs(x))/cosh(x),x,-oo,oo)
2*log(2)
sage: integrate(exp(-abs(x))/cosh(x),x,0,oo)
log(2)
sage: integrate(exp(-abs(x))/cosh(x),x,-oo,0)
ValueError: Integral is divergent.
sage: integrate(exp(-abs(x))/cosh(x),x,0,oo)
log(2)
```

At this point it can hardly be anything in the way we translate things for maxima. It's got to be in the internals in maxima. They may have changed something internally in maxima that doesn't jive well with our patch (see `maxima_lib.py`):

```
ecl_eval('(defun principal nil (cond ($noprincipal (diverg)) ((not pcprntd) (merror "Divergent Integral"))))')
```

For instance, in sage 4.7.1, which uses maxima 5.23.2, this problem does not arise. 

In fact, when you look at the message that is returned, it's:

```
ECL says: Error executing code in Maxima: defint: integral is divergent.
```

which is the error message that gets generated by `diverg`. So it seems the second time around, this code is executed with `$noprincipal` set.

BEWARE: both `noprincipal` and `pcprntd` are "special" variables, which means they are dynamically scoped. That's different from what you're probably used to.

Furthermore, the definition of `diverg` is:

```
(defun diverg nil
  (cond (*nodiverg (throw 'divergent 'divergent))
	(t (merror (intl:gettext "defint: integral is divergent.")))))
```

which shows the behaviour can be influenced by yet another special variable, `*nodiverg`. In `defint.lisp` this really gets used: they sometimes prefer a condition thrown that they catch rather than generate an `merror`. If you compare the `defint.lisp` between 5.26.0 and 5.29.1 (sage 5.0 uses the former and does not have this problem. sage 5.7 uses the latter), you'll find some changes that look like they might change behaviour around such constructs, but I wasn't able to detect a smoking gun. And of course the problem may lie in a different file and/or a bug in how the new ECL handles dynamic variables (which is unlikely and would be disconcerting, because they form a basic component of CL)


---

Comment by nbruin created at 2013-03-02 03:31:23

I don't think it has anything to do with `principal` or with `diverg`. I think there is an assumption on `x` that sticks around so that `abs(x)` gets simplified to `x`. Of course, `integrate(exp(-abs(x))/cosh(x),x,-oo,oo)` really is divergent. Evidence:

```
sage: maxima_calculus.eval("facts()")
'[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing)]'
sage: integrate(exp(-abs(x))/cosh(x),x,-oo,oo)
2*log(2)
sage: maxima_calculus.eval("facts()")
'[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing),x>0]'
```

Indeed, if we subsequently do

```
sage: maxima_calculus.eval("forget(x>0)")
'[x>0]'
sage: integrate(exp(-abs(x))/cosh(x),x,-oo,oo)
2*log(2)
```

we see the damage is undone (and redone with the second line of course).

The fact that we have a problem here and maxima itself doesn't seem to have a problem suggests that we are handling contexts differently from what maxima is doing. See maxima's documentation.

maxima's `defint.lisp` contains plenty of `assume` commands, but very little seems to have changed in how they're used. I don't know where the change comes from.


---

Comment by kcrisman created at 2013-03-02 04:10:31

> {{{
> sage: maxima_calculus.eval("facts()")
> '[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing)]'
> sage: integrate(exp(-abs(x))/cosh(x),x,-oo,oo)
> 2*log(2)
> sage: maxima_calculus.eval("facts()")
> '[kind(sinh,one_to_one),kind(log,one_to_one),kind(tanh,one_to_one),kind(log,increasing),x>0]'
> }}}
Yeah, that sounds like a bug or something.  Huh.


---

Comment by nbruin created at 2013-03-02 05:38:36

Cool. It's not our fault. It's an error in `abs_integrate.mac`, which we load:

```
Maxima 5.29.1 http://maxima.sourceforge.net
using Lisp ECL 12.12.1
Distributed under the GNU Public License. See the file COPYING.
Dedicated to the memory of William Schelter.
The function bug_report() provides bug reporting information.
(%i1) load(abs_integrate);
defint(exp(-abs(x))/cosh(x),x,minf,inf);
defint(exp(-abs(x))/cosh(x),x,minf,inf);
(%o1) /usr/local/sage/5.7/local/share/maxima/5.29.1/share/contrib/integration/\
abs_integrate.mac
(%i2) (%o2)                              2 log(2)
(%i3) 
defint: integral is divergent.
 -- an error. To debug this try: debugmode(true);
```

This is now [maxima #2557](https://sourceforge.net/p/maxima/bugs/2557/).


---

Comment by kcrisman created at 2013-03-15 18:51:38

There has been a fair amount of activity on this, see the [thread starting here](http://www.math.utexas.edu/pipermail/maxima/2013/032109.html) on the Maxima list.


---

Comment by robert_dodier created at 2013-03-23 04:55:32

Maxima bug #2557 [1] fixed by commit 4b8a98648d4 [2]. Thanks for the bug report.

[1] https://sourceforge.net/p/maxima/bugs/2557/
[2] https://sourceforge.net/p/maxima/code/ci/4b8a98648d4da26805ea3238eee216611245e14a/


---

Comment by kcrisman created at 2013-03-23 12:46:05

This will be in the upcoming 5.30.  Needs patch to verify at that time.


---

Comment by pbruin created at 2014-05-17 14:04:35

This is indeed fixed upstream and after #13973 we get

```
sage: sage: integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)           
2*log(2)
sage: sage: integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)
2*log(2)
```



---

Comment by kcrisman created at 2014-05-30 13:10:36

Changing status from new to needs_review.


---

Comment by kcrisman created at 2014-05-30 13:10:36

Again, my apologies for all the dependencies, not knowing how to do this so it doesn't depend on previous stuff - I'm still in the hg queue mode.
----
Last 10 new commits:


---

Comment by kcrisman created at 2014-05-30 13:11:04

Just commit 54d0609 matters.


---

Comment by tscrim created at 2014-05-30 13:50:07

LGTM (as well `:p`)


---

Comment by tscrim created at 2014-05-30 13:50:07

Changing status from needs_review to positive_review.


---

Comment by pbruin created at 2014-05-30 14:01:31

Doctests fail on my system:

```
sage -t --long src/sage/symbolic/integration/integral.py
**********************************************************************
File "src/sage/symbolic/integration/integral.py", line 684, in sage.symbolic.int
egration.integral.integrate
Failed example:
    integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)
Exception raised:
    Traceback (most recent call last):
    ...
    ValueError: Integral is divergent.
**********************************************************************
File "src/sage/symbolic/integration/integral.py", line 686, in sage.symbolic.int
egration.integral.integrate
Failed example:
    integral(e^(-abs(x))/cosh(x),x,-infinity,infinity)
Exception raised:
    Traceback (most recent call last):
    ...
    ValueError: Integral is divergent.
**********************************************************************
```

There is no error when running the example directly from the Sage prompt.  Maybe a bad assumption made elsewhere in `integral.py` is creeping in?  [Edit: it seems to be caused by "assume(x>0)" a few lines above.]


---

Comment by pbruin created at 2014-05-30 14:01:31

Changing status from positive_review to needs_work.


---

Comment by pbruin created at 2014-05-30 14:11:03

Integrating over _x_ in *R* after assuming _x_ > 0 is problematic in Maxima:

```
$ sage --maxima
...
(%i1) load(abs_integrate)$

(%i2) defint(exp(-abs(x))/cosh(x),x,minf,inf);
(%o2)                              2 log(2)
(%i3) assume(x>0);
(%o3)                               [x > 0]
(%i4) defint(exp(-abs(x))/cosh(x),x,minf,inf);

defint: integral is divergent.
 -- an error. To debug this try: debugmode(true);
```

The easiest solution is to put `forget(x > 0)` at the end of the doctest with `assume(x > 0)`.


---

Comment by kcrisman created at 2014-05-30 16:03:30

> The easiest solution is to put `forget(x > 0)` at the end of the doctest with `assume(x > 0)`.
Sorry, I didn't run tests because it worked in my local Sage, as you say.  Certainly if we assumed this above we should forget it - preferably immediately after the assumption - that is the usual practice here.

Anyway, I'll update this momentarily.


---

Comment by git created at 2014-05-30 16:17:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by kcrisman created at 2014-05-30 16:18:50

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2014-05-30 16:24:13

Changing status from needs_review to positive_review.


---

Comment by kcrisman created at 2014-05-30 16:36:21

Thanks.


---

Comment by vbraun created at 2014-06-02 12:54:38

Resolution: fixed
