# Issue 21233: py3: remove xrange in some pyx files

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2016-09-11 19:33:48

as a step towards python3


---

Comment by chapoton created at 2016-09-11 19:34:43

New commits:


---

Comment by chapoton created at 2016-09-11 19:34:43

Changing status from new to needs_review.


---

Comment by tscrim created at 2016-09-11 22:28:52

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2016-09-12 12:04:15

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2016-09-12 12:04:15

Has this been benchmarked?


---

Comment by chapoton created at 2016-09-12 12:07:42

in #21375, we have agreed that range imported from six.moves is just as fast as xrange.


---

Comment by jdemeyer created at 2016-09-12 12:11:14

Replying to [comment:4 chapoton]:
> in #21375, we have agreed that range imported from six.moves is just as fast as xrange.

...for Python code. Which means nothing for this ticket.


---

Comment by jdemeyer created at 2016-09-12 12:12:25

As a general rule, when making changes to Cython code, you should be a lot more careful with performance. Often, Cython code is meant to be fast and making harmless changes like this ticket could potentially be disastrous for performance.


---

Comment by jdemeyer created at 2016-09-12 12:12:45

Anyway, I am doing some tests right now.


---

Comment by jdemeyer created at 2016-09-12 12:30:41

In Cython, it depends on whether the loop variable is _typed_ or _untyped_. Typed means something like

```
cdef long i
for i in range(...):
    ...
```


For _untyped_ variables, Cython does no special optimization. In this case, you can do the same as for Python.

For _typed_ variables, `range()` is the same as `xrange()`. But `six.moves.range` is a lot slower.


---

Comment by jdemeyer created at 2016-09-12 12:31:28

An additional comment: is several cases, you add `from six.moves import range` but you never actually use `range` (only in doctests). You should not add these unneeded imports.


---

Comment by jdemeyer created at 2016-09-12 12:36:47

Regarding [comment:8]: it's slightly more complicated than that because Cython also does automatic type inference. So in a loop like

```
def some_loop(long n):
    for i in range(n):
        ...
```

Cython is clever enough to understand that `i` is a `long` because `n` is a `long`. In this case, the rules for typed ranges apply.


---

Comment by jdemeyer created at 2016-09-12 12:41:42

Finally, let me add that Cython understands `xrange()`. So there is not even a need to get rid of `xrange()` in Cython files.

So a concrete suggestion for this ticket would be:

- keep the replacements `range()` -> `list(range())`.

- keep all changes to doctests.

- undo the changes to `xrange()` in Cython code.

- remove all imports of `six.moves.range` in Cython code.


I'm sorry to set a positive_review ticket back to needs_work, but I really feel that this ticket was done too quickly. Remember that Cython and Python are different programming languages (which happen to have a similar syntax for convenience).


---

Comment by jdemeyer created at 2016-09-12 12:41:42

Changing status from needs_info to needs_work.


---

Comment by chapoton created at 2016-09-12 12:55:10

should I transform `list(range())` to `list(xrange())` ?


---

Comment by git created at 2016-09-12 12:56:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2016-09-12 13:29:32

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-09-12 13:36:47

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-09-12 13:36:47

ok, should be good now


---

Comment by tscrim created at 2016-09-12 14:07:14

I am sorry about this Jeroen, I forgot about that and take full responsibility. Thank you for catching this.


---

Comment by jdemeyer created at 2016-09-12 14:50:19

Replying to [comment:12 chapoton]:
> should I transform `list(range())` to `list(xrange())` ?

No, there is nothing wrong with `list(range(n))`.


---

Comment by jdemeyer created at 2016-09-12 14:55:20

Sorry, I spoke too soon. Cython's `xrange()` is like `six.moves.range()`. So yes, you should use `list(xrange(n))`.


---

Comment by jdemeyer created at 2016-09-12 14:58:24

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-09-12 14:58:24

In the PARI doctests, replace `xrange` by `six.moves.range`.


---

Comment by git created at 2016-09-12 15:23:21

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-09-13 10:22:29

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2016-09-13 12:28:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-15 06:43:27

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2016-09-15 06:43:27

See patchbot


---

Comment by git created at 2016-09-15 07:01:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2016-09-15 07:08:22

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2016-09-15 07:08:22

`@`jdemeyer, I replaced back the xrange by range in the doctests of pari.


---

Comment by tscrim created at 2016-09-15 14:08:29

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-09-17 15:25:37

Resolution: fixed
