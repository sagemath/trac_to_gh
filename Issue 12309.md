# Issue 12309: Fix branch_current_hg()

Issue created by migration from Trac.

Original creator: jdemeyer

Original creation time: 2012-02-09 11:01:54

Assignee: jason

This is just horrible code (`sage/misc/misc.py`):

```
def branch_current_hg():
    """
    Return the current hg Mercurial branch name. If the branch is
    'main', which is the default branch, then just '' is returned.
    """
    try:
        s = os.popen('ls -l %s/devel/sage'%os.environ['SAGE_ROOT']).read()
    except IOError:
        # this happens when running sage under gdb on macs
        return 'gdb'
    if 'No such file or directory' in s:
        raise RuntimeError, "unable to determine branch?!"
    # do ls -l and look for a symlink, which `ls` represents by a '->'
    i = s.rfind('->')
    if i == -1:
        raise RuntimeError, "unable to determine branch?!"
    s = s[i+2:]
    i = s.find('-')
    if i == -1:
        return ''
    br = s[i+1:].strip()
    return br
```


For one, this clearly needs an "lstat" instead of parsing "ls" output.  The "gdb" is also broken, since the string "gdb" doesn't contain "->".


---

Comment by jdemeyer created at 2012-02-09 13:10:38

Changing status from new to needs_review.


---

Comment by aapitzsch created at 2012-02-09 14:08:48

Could you use

```
raise RuntimeError("Unable to determine branch")
```

to have less work in the future (when we are moving to Python 3).


---

Attachment

Replying to [comment:4 aapitzsch]:
> Could you use
> {{{
> raise RuntimeError("Unable to determine branch")
> }}}
> to have less work in the future (when we are moving to Python 3).

Done.


---

Comment by aapitzsch created at 2012-02-09 18:43:00

Looks good.


---

Comment by aapitzsch created at 2012-02-09 18:43:00

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2012-02-11 09:43:45

Resolution: fixed
