# Issue 20969: Add improved process shutdown code for PALPreader._iterate_list

archive/issues_020969.json:
```json
{
    "body": "CC:  gouezel @jdemeyer @vbraun\n\nKeywords: palp subprocess\n\nThis is to fix the tests in `sage.geometry.polyhedron.palp_database`, which were irregularly failing on Cygwin.  I don't think there's really anything Cygwin-specific about the issue, actually.  It just tends to exhibit itself on Cygwin because process shutdown takes longer, giving a wider window for the race condition described below.\n\nThis method had some code to force the PALP process to shut down at the end of iteration, rather than waiting for it to complete naturally.   However, this was failing randomly, at least on Windows, due to a race condition where the process could end between calling `poll()` and calling `terminate()` (and/or `kill()`)--the `terminate()` call would in turn cause an `OSError` (\"No such process\").\n\nThe newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.\n\nSince the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.\n\nIssue created by migration from https://trac.sagemath.org/ticket/21206\n\n",
    "created_at": "2016-08-10T14:37:38Z",
    "labels": [
        "porting: Cygwin",
        "minor",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.0",
    "title": "Add improved process shutdown code for PALPreader._iterate_list",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/20969",
    "user": "@embray"
}
```
CC:  gouezel @jdemeyer @vbraun

Keywords: palp subprocess

This is to fix the tests in `sage.geometry.polyhedron.palp_database`, which were irregularly failing on Cygwin.  I don't think there's really anything Cygwin-specific about the issue, actually.  It just tends to exhibit itself on Cygwin because process shutdown takes longer, giving a wider window for the race condition described below.

This method had some code to force the PALP process to shut down at the end of iteration, rather than waiting for it to complete naturally.   However, this was failing randomly, at least on Windows, due to a race condition where the process could end between calling `poll()` and calling `terminate()` (and/or `kill()`)--the `terminate()` call would in turn cause an `OSError` ("No such process").

The newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.

Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.

Issue created by migration from https://trac.sagemath.org/ticket/21206





---

archive/issue_comments_290166.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2016-08-10T14:38:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290166",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_290167.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2016-08-10T14:38:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290167",
    "user": "@embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_290168.json:
```json
{
    "body": "Duplicate of #17864?",
    "created_at": "2016-08-10T14:59:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290168",
    "user": "@jdemeyer"
}
```

Duplicate of #17864?



---

archive/issue_comments_290169.json:
```json
{
    "body": "At least it's related to #17864, but the descriptions of both tickets seem to indicate a differnt cause.",
    "created_at": "2016-08-10T15:03:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290169",
    "user": "@jdemeyer"
}
```

At least it's related to #17864, but the descriptions of both tickets seem to indicate a differnt cause.



---

archive/issue_comments_290170.json:
```json
{
    "body": "0.1 seconds is a ridiculously short time to wait. You might as well send `SIGKILL` directly...",
    "created_at": "2016-08-10T15:04:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290170",
    "user": "@jdemeyer"
}
```

0.1 seconds is a ridiculously short time to wait. You might as well send `SIGKILL` directly...



---

archive/issue_comments_290171.json:
```json
{
    "body": "This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.\n\nSince it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).",
    "created_at": "2016-08-10T15:09:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290171",
    "user": "@jdemeyer"
}
```

This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.

Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).



---

archive/issue_comments_290172.json:
```json
{
    "body": "Just a pointer: you should have a look at the code for killing `SagePtyProcess` in `src/sage/interfaces/sagespawn.pyx`",
    "created_at": "2016-08-10T15:18:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290172",
    "user": "@jdemeyer"
}
```

Just a pointer: you should have a look at the code for killing `SagePtyProcess` in `src/sage/interfaces/sagespawn.pyx`



---

archive/issue_comments_290173.json:
```json
{
    "body": "Okay on all of the above.  I don't know about #17864--this seems to fix any problem I had with this on Cygwin.",
    "created_at": "2016-08-10T15:45:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290173",
    "user": "@embray"
}
```

Okay on all of the above.  I don't know about #17864--this seems to fix any problem I had with this on Cygwin.



---

archive/issue_comments_290174.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2016-08-11T09:57:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290174",
    "user": "@embray"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_290175.json:
```json
{
    "body": "For the purposes of PALP, would it be possible to just do a normal process termination? That is, work around the Cygwin bug but don't do stuff like sending `SIGKILL` in case the process does not terminate within a given time.",
    "created_at": "2016-08-12T08:19:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290175",
    "user": "@jdemeyer"
}
```

For the purposes of PALP, would it be possible to just do a normal process termination? That is, work around the Cygwin bug but don't do stuff like sending `SIGKILL` in case the process does not terminate within a given time.



---

archive/issue_comments_290176.json:
```json
{
    "body": "I know this needs other work, but when I build the docs with this fix applied I get:\n\n\n```\n[dochtml] OSError: [geometry ] /home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/geometry/polyhedron/palp_database.py:docstring of sage.geometry.polyhedron.palp_database.terminate:31: WARNING: Block quote ends without a blank line; unexpected unindent.\n```\n\n\nI can't for the life of me figure out what this needs.  If I look at other docstrings there are plenty that have a blockquote at the end of the docstring with no newline.  But even when I add an additional newline it still complains.  Anyone seen this before?",
    "created_at": "2016-08-16T15:47:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290176",
    "user": "@embray"
}
```

I know this needs other work, but when I build the docs with this fix applied I get:


```
[dochtml] OSError: [geometry ] /home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/geometry/polyhedron/palp_database.py:docstring of sage.geometry.polyhedron.palp_database.terminate:31: WARNING: Block quote ends without a blank line; unexpected unindent.
```


I can't for the life of me figure out what this needs.  If I look at other docstrings there are plenty that have a blockquote at the end of the docstring with no newline.  But even when I add an additional newline it still complains.  Anyone seen this before?



---

archive/issue_comments_290177.json:
```json
{
    "body": "About `SIGALRM`: I have some ideas to improve `cysignals` to better cooperate with other libraries. Remember that `cysignals` was originally written just for Sage without much regard for more general usage.",
    "created_at": "2016-08-17T07:54:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290177",
    "user": "@jdemeyer"
}
```

About `SIGALRM`: I have some ideas to improve `cysignals` to better cooperate with other libraries. Remember that `cysignals` was originally written just for Sage without much regard for more general usage.



---

archive/issue_comments_290178.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> But even when I add an additional newline it still complains.  Anyone seen this before?\n\n\n```\n\"\"\"\n[...]\nsignal(SIGTERM, SIG_IGN)\\n\n[...]\n\"\"\"\n```\n\nYou need to use a `r\"\"\"` string to make the `\\n` literal instead of an actual newline.",
    "created_at": "2016-08-17T07:56:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290178",
    "user": "@jdemeyer"
}
```

Replying to [comment:12 embray]:
> But even when I add an additional newline it still complains.  Anyone seen this before?


```
"""
[...]
signal(SIGTERM, SIG_IGN)\n
[...]
"""
```

You need to use a `r"""` string to make the `\n` literal instead of an actual newline.



---

archive/issue_comments_290179.json:
```json
{
    "body": "Replying to [comment:14 jdemeyer]:\n> You need to use a `r\"\"\"` string to make the `\\n` literal instead of an actual newline.\n\nAh! Thanks for catching that.  Subtle(-ish).\n\nAs for SIGALRM I think that was about another ticket--I don't think there's really an issue with SIGALRM here, unless I'm missing something.  I'd be interested to hear your thoughts though.",
    "created_at": "2016-08-17T08:03:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290179",
    "user": "@embray"
}
```

Replying to [comment:14 jdemeyer]:
> You need to use a `r"""` string to make the `\n` literal instead of an actual newline.

Ah! Thanks for catching that.  Subtle(-ish).

As for SIGALRM I think that was about another ticket--I don't think there's really an issue with SIGALRM here, unless I'm missing something.  I'd be interested to hear your thoughts though.



---

archive/issue_comments_290180.json:
```json
{
    "body": "Replying to [comment:6 jdemeyer]:\n> This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.\n> \n> Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).\n\nI'm fine with this, but should I keep a `sage.parallel.safefork` alias for backwards compatibility?  And if so, what is the best way to deprecate it?",
    "created_at": "2016-11-24T11:28:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290180",
    "user": "@embray"
}
```

Replying to [comment:6 jdemeyer]:
> This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.
> 
> Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).

I'm fine with this, but should I keep a `sage.parallel.safefork` alias for backwards compatibility?  And if so, what is the best way to deprecate it?



---

archive/issue_comments_290181.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2016-11-29T13:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290181",
    "user": "@embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_290182.json:
```json
{
    "body": "As suggested I combined the `terminate` context manager and the `ContainChildren` context manager into a single module called `sage.interfaces.process` (to me that still seems like an odd place for it but I don't have a better suggestion).\n\nStill an open question is what to do with `sage.parallel.safefork` and it should be kept for backwards compatibility?\n----\nNew commits:",
    "created_at": "2016-11-29T13:37:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290182",
    "user": "@embray"
}
```

As suggested I combined the `terminate` context manager and the `ContainChildren` context manager into a single module called `sage.interfaces.process` (to me that still seems like an odd place for it but I don't have a better suggestion).

Still an open question is what to do with `sage.parallel.safefork` and it should be kept for backwards compatibility?
----
New commits:



---

archive/issue_comments_290183.json:
```json
{
    "body": "Any comments on this?  Per Jeroen's suggestion I moved the contents of `sage.parallel.safefork` into a new `sage.interfaces.process` module.  The open question for me is whether there should be a deprecation process for `sage.parallel.safefork` or if it can just be dropped entirely?",
    "created_at": "2017-01-03T11:30:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290183",
    "user": "@embray"
}
```

Any comments on this?  Per Jeroen's suggestion I moved the contents of `sage.parallel.safefork` into a new `sage.interfaces.process` module.  The open question for me is whether there should be a deprecation process for `sage.parallel.safefork` or if it can just be dropped entirely?



---

archive/issue_comments_290184.json:
```json
{
    "body": "For me, there is no need to deprecate anything...",
    "created_at": "2017-01-03T15:55:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290184",
    "user": "@jdemeyer"
}
```

For me, there is no need to deprecate anything...



---

archive/issue_comments_290185.json:
```json
{
    "body": "I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.",
    "created_at": "2017-01-03T15:58:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290185",
    "user": "@jdemeyer"
}
```

I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.



---

archive/issue_comments_290186.json:
```json
{
    "body": "The docstring formatting of `terminate` is messed up: there is a stray `\"\"\"`.",
    "created_at": "2017-01-03T16:00:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290186",
    "user": "@jdemeyer"
}
```

The docstring formatting of `terminate` is messed up: there is a stray `"""`.



---

archive/issue_comments_290187.json:
```json
{
    "body": "If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.",
    "created_at": "2017-01-03T16:02:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290187",
    "user": "@jdemeyer"
}
```

If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.



---

archive/issue_comments_290188.json:
```json
{
    "body": "I also suggest to add the delay between closing the streams and the first killing attempt. So the result would be:\n\n1. Close streams\n\n2. Wait\n\n3. Send `SIGTERM`\n\n4. Wait\n\n5. Send `SIGKILL`",
    "created_at": "2017-01-03T16:05:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290188",
    "user": "@jdemeyer"
}
```

I also suggest to add the delay between closing the streams and the first killing attempt. So the result would be:

1. Close streams

2. Wait

3. Send `SIGTERM`

4. Wait

5. Send `SIGKILL`



---

archive/issue_comments_290189.json:
```json
{
    "body": "Replying to [comment:20 jdemeyer]:\n> I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.\n\nI think you're right--there's no point in resending the signal.  Either it gets handled (eventually) or is blocked forever in which case we move on to the next signal.",
    "created_at": "2017-01-03T16:28:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290189",
    "user": "@embray"
}
```

Replying to [comment:20 jdemeyer]:
> I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.

I think you're right--there's no point in resending the signal.  Either it gets handled (eventually) or is blocked forever in which case we move on to the next signal.



---

archive/issue_comments_290190.json:
```json
{
    "body": "Replying to [comment:19 jdemeyer]:\n> For me, there is no need to deprecate anything...\n\nI ask because Sage does not have a well defined API.  I bet there are some things that if they were renamed/moved it would be a big problem.  Other things less so.  I have no way of knowing.",
    "created_at": "2017-01-03T16:29:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290190",
    "user": "@embray"
}
```

Replying to [comment:19 jdemeyer]:
> For me, there is no need to deprecate anything...

I ask because Sage does not have a well defined API.  I bet there are some things that if they were renamed/moved it would be a big problem.  Other things less so.  I have no way of knowing.



---

archive/issue_comments_290191.json:
```json
{
    "body": "Replying to [comment:21 jdemeyer]:\n> The docstring formatting of `terminate` is messed up: there is a stray `\"\"\"`.\n\nOops, not sure how that got there.  Must have been a stray paste last time I saved the file--it was weeks ago but I seem to recall confirming that all the tests were running and passing.",
    "created_at": "2017-01-03T16:32:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290191",
    "user": "@embray"
}
```

Replying to [comment:21 jdemeyer]:
> The docstring formatting of `terminate` is messed up: there is a stray `"""`.

Oops, not sure how that got there.  Must have been a stray paste last time I saved the file--it was weeks ago but I seem to recall confirming that all the tests were running and passing.



---

archive/issue_comments_290192.json:
```json
{
    "body": "Replying to [comment:22 jdemeyer]:\n> If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.\n\nIt's not really poll() itself that has a problem, but I see what you're saying.  If the point is to immediately terminate the process rather than let it finish (assuming it hasn't already finished) then I agree, there's no reason to call poll() or wait() in the first place.  I think I kept it just going off the original code this was based on.  You still need the try/except block regardless.\n\nAlternatively, the context manager could take a timeout argument allowing the process a little more time to finish on its own, but I don't see it being needed right now.",
    "created_at": "2017-01-03T16:42:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290192",
    "user": "@embray"
}
```

Replying to [comment:22 jdemeyer]:
> If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.

It's not really poll() itself that has a problem, but I see what you're saying.  If the point is to immediately terminate the process rather than let it finish (assuming it hasn't already finished) then I agree, there's no reason to call poll() or wait() in the first place.  I think I kept it just going off the original code this was based on.  You still need the try/except block regardless.

Alternatively, the context manager could take a timeout argument allowing the process a little more time to finish on its own, but I don't see it being needed right now.



---

archive/issue_comments_290193.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-04-11T16:12:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290193",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_290194.json:
```json
{
    "body": "Finally updated this--I think this addresses your last comments.  I kept the `poll()` call because I want to check if the process actually ended before making other attempts.",
    "created_at": "2017-04-11T16:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290194",
    "user": "@embray"
}
```

Finally updated this--I think this addresses your last comments.  I kept the `poll()` call because I want to check if the process actually ended before making other attempts.



---

archive/issue_comments_290195.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2017-04-11T16:21:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290195",
    "user": "@embray"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_290196.json:
```json
{
    "body": "Do you have a reference for this claim about `SIGHUP`?\n\n\n```\nit also first closes all standard I/O pipes, which should send a SIGHUP.\n```\n\n\nWriting to a closed pipe can give `SIGPIPE` but I don't think that just closing a pipe would send any signal.",
    "created_at": "2017-04-12T08:13:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290196",
    "user": "@jdemeyer"
}
```

Do you have a reference for this claim about `SIGHUP`?


```
it also first closes all standard I/O pipes, which should send a SIGHUP.
```


Writing to a closed pipe can give `SIGPIPE` but I don't think that just closing a pipe would send any signal.



---

archive/issue_comments_290197.json:
```json
{
    "body": "You're right, that should probably say SIGPIPE.  It *would* be SIGHUP if this were a tty but that's not the case here (I think I was working on pexect more recently so that's probably what I was thinking about).",
    "created_at": "2017-04-12T14:27:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290197",
    "user": "@embray"
}
```

You're right, that should probably say SIGPIPE.  It *would* be SIGHUP if this were a tty but that's not the case here (I think I was working on pexect more recently so that's probably what I was thinking about).



---

archive/issue_comments_290198.json:
```json
{
    "body": "The `time.sleep()` is a inefficient. If the process exits after 1ms, we still have to wait 999ms to notice it.\n\nI suggest to improve this with a `SIGCHLD` handler. I have recently added code to `cysignals` to temporarily change a signal handler, so I could use that to implement the `SIGCHLD` trick.",
    "created_at": "2017-04-12T20:11:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290198",
    "user": "@jdemeyer"
}
```

The `time.sleep()` is a inefficient. If the process exits after 1ms, we still have to wait 999ms to notice it.

I suggest to improve this with a `SIGCHLD` handler. I have recently added code to `cysignals` to temporarily change a signal handler, so I could use that to implement the `SIGCHLD` trick.



---

archive/issue_comments_290199.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-04-12T20:11:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290199",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_290200.json:
```json
{
    "body": "Working on this...",
    "created_at": "2017-04-13T08:50:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290200",
    "user": "@jdemeyer"
}
```

Working on this...



---

archive/issue_comments_290201.json:
```json
{
    "body": "Okay.  I see what you're saying though and I agree.",
    "created_at": "2017-04-13T09:29:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290201",
    "user": "@embray"
}
```

Okay.  I see what you're saying though and I agree.



---

archive/issue_comments_290202.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-04-13T14:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290202",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_290203.json:
```json
{
    "body": "New commits:",
    "created_at": "2017-04-13T14:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290203",
    "user": "@jdemeyer"
}
```

New commits:



---

archive/issue_comments_290204.json:
```json
{
    "body": "Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?",
    "created_at": "2017-04-14T08:46:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290204",
    "user": "@embray"
}
```

Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?



---

archive/issue_comments_290205.json:
```json
{
    "body": "Replying to [comment:38 embray]:\n> Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?\n\nThe `t <= 4.0` part is to check that the sleep inside the `with terminate(sp, interval=5.0):` block was actually interrupted. If the interrupt didn't work, at least 5 seconds would have passed.\n\nThe `or t` part is a neat trick I learned from Robert Bradshaw. In case of a doctest failure (where `t <= 4.0` would be `False`), you see the actual value of `t` instead of just `False`.",
    "created_at": "2017-04-15T12:05:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290205",
    "user": "@jdemeyer"
}
```

Replying to [comment:38 embray]:
> Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?

The `t <= 4.0` part is to check that the sleep inside the `with terminate(sp, interval=5.0):` block was actually interrupted. If the interrupt didn't work, at least 5 seconds would have passed.

The `or t` part is a neat trick I learned from Robert Bradshaw. In case of a doctest failure (where `t <= 4.0` would be `False`), you see the actual value of `t` instead of just `False`.



---

archive/issue_comments_290206.json:
```json
{
    "body": "I see--it was the `or t` I didn't get.  That makes sense for a doctest.  Works for me.",
    "created_at": "2017-04-17T12:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290206",
    "user": "@embray"
}
```

I see--it was the `or t` I didn't get.  That makes sense for a doctest.  Works for me.



---

archive/issue_comments_290207.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2017-04-17T12:38:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290207",
    "user": "@embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_290208.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-17T12:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290208",
    "user": "@embray"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290209.json:
```json
{
    "body": "Except--the cysignals in Sage currently does not have a `.pysignals` module.",
    "created_at": "2017-04-17T12:49:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290209",
    "user": "@embray"
}
```

Except--the cysignals in Sage currently does not have a `.pysignals` module.



---

archive/issue_comments_290210.json:
```json
{
    "body": "Replying to [comment:41 embray]:\n> Except--the cysignals in Sage currently does not have a `.pysignals` module.\n\nWell, that's why I added #22695 as dependency.",
    "created_at": "2017-04-17T16:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290210",
    "user": "@jdemeyer"
}
```

Replying to [comment:41 embray]:
> Except--the cysignals in Sage currently does not have a `.pysignals` module.

Well, that's why I added #22695 as dependency.



---

archive/issue_comments_290211.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-04-17T16:34:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290211",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_290212.json:
```json
{
    "body": "Okay I didn't see that, I'll test that in bit.",
    "created_at": "2017-04-19T09:36:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290212",
    "user": "@embray"
}
```

Okay I didn't see that, I'll test that in bit.



---

archive/issue_comments_290213.json:
```json
{
    "body": "Reviewer name missing...",
    "created_at": "2017-04-21T22:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290213",
    "user": "@vbraun"
}
```

Reviewer name missing...



---

archive/issue_comments_290214.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2017-04-21T22:35:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290214",
    "user": "@vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_290215.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-04-23T13:38:13Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290215",
    "user": "@jdemeyer"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_290216.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-04-25T17:40:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/20969",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/20969#issuecomment-290216",
    "user": "@vbraun"
}
```

Resolution: fixed
