# Issue 20969: Add improved process shutdown code for PALPreader._iterate_list

Issue created by migration from https://trac.sagemath.org/ticket/21206

Original creator: embray

Original creation time: 2016-08-10 14:37:38

CC:  gouezel jdemeyer vbraun

Keywords: palp subprocess

This is to fix the tests in `sage.geometry.polyhedron.palp_database`, which were irregularly failing on Cygwin.  I don't think there's really anything Cygwin-specific about the issue, actually.  It just tends to exhibit itself on Cygwin because process shutdown takes longer, giving a wider window for the race condition described below.

This method had some code to force the PALP process to shut down at the end of iteration, rather than waiting for it to complete naturally.   However, this was failing randomly, at least on Windows, due to a race condition where the process could end between calling `poll()` and calling `terminate()` (and/or `kill()`)--the `terminate()` call would in turn cause an `OSError` ("No such process").

The newly added `terminate()` context manager does effectively the same thing as the old code, but also makes sure to close any streams, and handles the aforementioned race condition better.

Since the `terminate()` context manager is fairly generic, there is probably a better long-term home for it than here.


---

Comment by git created at 2016-08-10 14:38:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by embray created at 2016-08-10 14:38:26

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2016-08-10 14:59:11

Duplicate of #17864?


---

Comment by jdemeyer created at 2016-08-10 15:03:27

At least it's related to #17864, but the descriptions of both tickets seem to indicate a differnt cause.


---

Comment by jdemeyer created at 2016-08-10 15:04:08

0.1 seconds is a ridiculously short time to wait. You might as well send `SIGKILL` directly...


---

Comment by jdemeyer created at 2016-08-10 15:09:46

This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.

Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).


---

Comment by jdemeyer created at 2016-08-10 15:18:09

Just a pointer: you should have a look at the code for killing `SagePtyProcess` in `src/sage/interfaces/sagespawn.pyx`


---

Comment by embray created at 2016-08-10 15:45:17

Okay on all of the above.  I don't know about #17864--this seems to fix any problem I had with this on Cygwin.


---

Comment by embray created at 2016-08-11 09:57:15

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2016-08-12 08:19:20

For the purposes of PALP, would it be possible to just do a normal process termination? That is, work around the Cygwin bug but don't do stuff like sending `SIGKILL` in case the process does not terminate within a given time.


---

Comment by embray created at 2016-08-16 15:47:21

I know this needs other work, but when I build the docs with this fix applied I get:


```
[dochtml] OSError: [geometry ] /home/embray/src/sagemath/sage-cygwin/local/lib/python2.7/site-packages/sage/geometry/polyhedron/palp_database.py:docstring of sage.geometry.polyhedron.palp_database.terminate:31: WARNING: Block quote ends without a blank line; unexpected unindent.
```


I can't for the life of me figure out what this needs.  If I look at other docstrings there are plenty that have a blockquote at the end of the docstring with no newline.  But even when I add an additional newline it still complains.  Anyone seen this before?


---

Comment by jdemeyer created at 2016-08-17 07:54:17

About `SIGALRM`: I have some ideas to improve `cysignals` to better cooperate with other libraries. Remember that `cysignals` was originally written just for Sage without much regard for more general usage.


---

Comment by jdemeyer created at 2016-08-17 07:56:33

Replying to [comment:12 embray]:
> But even when I add an additional newline it still complains.  Anyone seen this before?


```
"""
[...]
signal(SIGTERM, SIG_IGN)\n
[...]
"""
```

You need to use a `r"""` string to make the `\n` literal instead of an actual newline.


---

Comment by embray created at 2016-08-17 08:03:36

Replying to [comment:14 jdemeyer]:
> You need to use a `r"""` string to make the `\n` literal instead of an actual newline.

Ah! Thanks for catching that.  Subtle(-ish).

As for SIGALRM I think that was about another ticket--I don't think there's really an issue with SIGALRM here, unless I'm missing something.  I'd be interested to hear your thoughts though.


---

Comment by embray created at 2016-11-24 11:28:40

Replying to [comment:6 jdemeyer]:
> This `terminate()` context thing obviously does not belong in `palp_database.py`, it could be used more generally.
> 
> Since it seems vaguely related to `src/sage/parallel/safefork.pyx`, I would actually propose to move your new code and `safefork.pyx` to a single file, say `src/sage/interfaces/process.pyx` (or whatever you want to call it).

I'm fine with this, but should I keep a `sage.parallel.safefork` alias for backwards compatibility?  And if so, what is the best way to deprecate it?


---

Comment by embray created at 2016-11-29 13:37:13

Changing status from needs_work to needs_info.


---

Comment by embray created at 2016-11-29 13:37:13

As suggested I combined the `terminate` context manager and the `ContainChildren` context manager into a single module called `sage.interfaces.process` (to me that still seems like an odd place for it but I don't have a better suggestion).

Still an open question is what to do with `sage.parallel.safefork` and it should be kept for backwards compatibility?
----
New commits:


---

Comment by embray created at 2017-01-03 11:30:55

Any comments on this?  Per Jeroen's suggestion I moved the contents of `sage.parallel.safefork` into a new `sage.interfaces.process` module.  The open question for me is whether there should be a deprecation process for `sage.parallel.safefork` or if it can just be dropped entirely?


---

Comment by jdemeyer created at 2017-01-03 15:55:18

For me, there is no need to deprecate anything...


---

Comment by jdemeyer created at 2017-01-03 15:58:15

I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.


---

Comment by jdemeyer created at 2017-01-03 16:00:09

The docstring formatting of `terminate` is messed up: there is a stray `"""`.


---

Comment by jdemeyer created at 2017-01-03 16:02:41

If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.


---

Comment by jdemeyer created at 2017-01-03 16:05:21

I also suggest to add the delay between closing the streams and the first killing attempt. So the result would be:

1. Close streams

2. Wait

3. Send `SIGTERM`

4. Wait

5. Send `SIGKILL`


---

Comment by embray created at 2017-01-03 16:28:27

Replying to [comment:20 jdemeyer]:
> I think the `retries` argument is over-thinking it. Better send the signal once and wait 3 seconds instead of sending the signal 3 times and waiting 1 second every time.

I think you're right--there's no point in resending the signal.  Either it gets handled (eventually) or is blocked forever in which case we move on to the next signal.


---

Comment by embray created at 2017-01-03 16:29:53

Replying to [comment:19 jdemeyer]:
> For me, there is no need to deprecate anything...

I ask because Sage does not have a well defined API.  I bet there are some things that if they were renamed/moved it would be a big problem.  Other things less so.  I have no way of knowing.


---

Comment by embray created at 2017-01-03 16:32:50

Replying to [comment:21 jdemeyer]:
> The docstring formatting of `terminate` is messed up: there is a stray `"""`.

Oops, not sure how that got there.  Must have been a stray paste last time I saved the file--it was weeks ago but I seem to recall confirming that all the tests were running and passing.


---

Comment by embray created at 2017-01-03 16:42:20

Replying to [comment:22 jdemeyer]:
> If `sp.poll()` is racy, why call it at all? You could EAFP this and just call `send_signal` directly.

It's not really poll() itself that has a problem, but I see what you're saying.  If the point is to immediately terminate the process rather than let it finish (assuming it hasn't already finished) then I agree, there's no reason to call poll() or wait() in the first place.  I think I kept it just going off the original code this was based on.  You still need the try/except block regardless.

Alternatively, the context manager could take a timeout argument allowing the process a little more time to finish on its own, but I don't see it being needed right now.


---

Comment by git created at 2017-04-11 16:12:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2017-04-11 16:21:16

Finally updated this--I think this addresses your last comments.  I kept the `poll()` call because I want to check if the process actually ended before making other attempts.


---

Comment by embray created at 2017-04-11 16:21:16

Changing status from needs_info to needs_review.


---

Comment by jdemeyer created at 2017-04-12 08:13:34

Do you have a reference for this claim about `SIGHUP`?


```
it also first closes all standard I/O pipes, which should send a SIGHUP.
```


Writing to a closed pipe can give `SIGPIPE` but I don't think that just closing a pipe would send any signal.


---

Comment by embray created at 2017-04-12 14:27:45

You're right, that should probably say SIGPIPE.  It _would_ be SIGHUP if this were a tty but that's not the case here (I think I was working on pexect more recently so that's probably what I was thinking about).


---

Comment by jdemeyer created at 2017-04-12 20:11:26

The `time.sleep()` is a inefficient. If the process exits after 1ms, we still have to wait 999ms to notice it.

I suggest to improve this with a `SIGCHLD` handler. I have recently added code to `cysignals` to temporarily change a signal handler, so I could use that to implement the `SIGCHLD` trick.


---

Comment by jdemeyer created at 2017-04-12 20:11:49

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-04-13 08:50:43

Working on this...


---

Comment by embray created at 2017-04-13 09:29:52

Okay.  I see what you're saying though and I agree.


---

Comment by jdemeyer created at 2017-04-13 14:32:00

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-04-13 14:32:00

New commits:


---

Comment by embray created at 2017-04-14 08:46:27

Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?


---

Comment by jdemeyer created at 2017-04-15 12:05:20

Replying to [comment:38 embray]:
> Fine by me.  The only thing I don't get is the `t <= 4.0 or t` in the tests you added.  What's that about?

The `t <= 4.0` part is to check that the sleep inside the `with terminate(sp, interval=5.0):` block was actually interrupted. If the interrupt didn't work, at least 5 seconds would have passed.

The `or t` part is a neat trick I learned from Robert Bradshaw. In case of a doctest failure (where `t <= 4.0` would be `False`), you see the actual value of `t` instead of just `False`.


---

Comment by embray created at 2017-04-17 12:38:31

I see--it was the `or t` I didn't get.  That makes sense for a doctest.  Works for me.


---

Comment by embray created at 2017-04-17 12:38:31

Changing status from needs_review to positive_review.


---

Comment by embray created at 2017-04-17 12:49:10

Changing status from positive_review to needs_work.


---

Comment by embray created at 2017-04-17 12:49:10

Except--the cysignals in Sage currently does not have a `.pysignals` module.


---

Comment by jdemeyer created at 2017-04-17 16:34:46

Replying to [comment:41 embray]:
> Except--the cysignals in Sage currently does not have a `.pysignals` module.

Well, that's why I added #22695 as dependency.


---

Comment by jdemeyer created at 2017-04-17 16:34:46

Changing status from needs_work to positive_review.


---

Comment by embray created at 2017-04-19 09:36:31

Okay I didn't see that, I'll test that in bit.


---

Comment by vbraun created at 2017-04-21 22:35:45

Reviewer name missing...


---

Comment by vbraun created at 2017-04-21 22:35:45

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2017-04-23 13:38:13

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-04-25 17:40:12

Resolution: fixed
