# Issue 12793: X.Kaehler_cone().lattice() is not a lattice

archive/issues_012793.json:
```json
{
    "body": "Assignee: @aghitza\n\nCC:  @vbraun\n\nKeywords: toric\n\nIn Sage-5.0 we have\n\n```\nsage: toric_varieties.P2().Kaehler_cone().lattice()\nThe toric rational divisor class group of a 2-d CPR-Fano toric variety covered by 3 affine patches\nsage: _.base_ring()\nRational Field\n```\n\nwhich is wrong since this lattice is not a lattice.\n\nIssue created by migration from https://trac.sagemath.org/ticket/12965\n\n",
    "created_at": "2012-05-17T18:50:38Z",
    "labels": [
        "algebraic geometry",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-5.2",
    "title": "X.Kaehler_cone().lattice() is not a lattice",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/12793",
    "user": "@novoselt"
}
```
Assignee: @aghitza

CC:  @vbraun

Keywords: toric

In Sage-5.0 we have

```
sage: toric_varieties.P2().Kaehler_cone().lattice()
The toric rational divisor class group of a 2-d CPR-Fano toric variety covered by 3 affine patches
sage: _.base_ring()
Rational Field
```

which is wrong since this lattice is not a lattice.

Issue created by migration from https://trac.sagemath.org/ticket/12965





---

archive/issue_comments_153534.json:
```json
{
    "body": "Hi Volker,\n\nAny thoughts on what would be the proper way to fix it? Modify `Cone` constructor to take as the lattice of a cone in a vector space the integral span of the basis and normalize/convert rays to live in this span?\n\nIt seems to be correct, but it screws up printing where these rays live in - this integral span shows as row span of the identity matrix without mention of any class groups. It also means that rays cannot be lifted to divisors, without first converting them to the rational class group explicitly.\n\nA half-way solution is to use span of the basis for normalization of rays, but let rays be still elements of the rational divisor class group. However, in this case, it seems that rays of a cone in the N-lattice must have N_R as their parent and if we let rays live in the extension all the customization work of toric lattices becomes irrelevant.\n\nSo I am inclining to the first solution - if `Cone` gets a rational vector space V for the lattice, it actually works with `span(ZZ, V.gens())`.\n\nLet me know what you think!",
    "created_at": "2012-05-17T19:10:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153534",
    "user": "@novoselt"
}
```

Hi Volker,

Any thoughts on what would be the proper way to fix it? Modify `Cone` constructor to take as the lattice of a cone in a vector space the integral span of the basis and normalize/convert rays to live in this span?

It seems to be correct, but it screws up printing where these rays live in - this integral span shows as row span of the identity matrix without mention of any class groups. It also means that rays cannot be lifted to divisors, without first converting them to the rational class group explicitly.

A half-way solution is to use span of the basis for normalization of rays, but let rays be still elements of the rational divisor class group. However, in this case, it seems that rays of a cone in the N-lattice must have N_R as their parent and if we let rays live in the extension all the customization work of toric lattices becomes irrelevant.

So I am inclining to the first solution - if `Cone` gets a rational vector space V for the lattice, it actually works with `span(ZZ, V.gens())`.

Let me know what you think!



---

archive/issue_comments_153535.json:
```json
{
    "body": "Another thought: instead of rational divisor class group have free divisor class group (does it have an actual name?) which is just the class group without torsion. As I understand, this is exactly the Z-span of the basis of the current one.",
    "created_at": "2012-05-17T19:19:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153535",
    "user": "@novoselt"
}
```

Another thought: instead of rational divisor class group have free divisor class group (does it have an actual name?) which is just the class group without torsion. As I understand, this is exactly the Z-span of the basis of the current one.



---

archive/issue_comments_153536.json:
```json
{
    "body": "Attachment [trac_12965_rational_class_group_lattice.patch](tarball://root/attachments/some-uuid/ticket12965/trac_12965_rational_class_group_lattice.patch) by @novoselt created at 2012-05-29 00:08:35\n\nHere is a more or less minimal solution, just a ZZ-module with the same elements.",
    "created_at": "2012-05-29T00:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153536",
    "user": "@novoselt"
}
```

Attachment [trac_12965_rational_class_group_lattice.patch](tarball://root/attachments/some-uuid/ticket12965/trac_12965_rational_class_group_lattice.patch) by @novoselt created at 2012-05-29 00:08:35

Here is a more or less minimal solution, just a ZZ-module with the same elements.



---

archive/issue_comments_153537.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2012-05-29T00:08:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153537",
    "user": "@novoselt"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_153538.json:
```json
{
    "body": "Changing keywords from \"toric\" to \"toric, sd40.5\".",
    "created_at": "2012-05-29T00:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153538",
    "user": "@novoselt"
}
```

Changing keywords from "toric" to "toric, sd40.5".



---

archive/issue_comments_153539.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2012-06-29T13:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153539",
    "user": "@vbraun"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_153540.json:
```json
{
    "body": "Looks good to me!",
    "created_at": "2012-06-29T13:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153540",
    "user": "@vbraun"
}
```

Looks good to me!



---

archive/issue_comments_153541.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2012-07-07T22:30:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/12793",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/12793#issuecomment-153541",
    "user": "@jdemeyer"
}
```

Resolution: fixed
