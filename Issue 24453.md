# Issue 24453: Install Cython source files

Issue created by migration from https://trac.sagemath.org/ticket/24690

Original creator: jdemeyer

Original creation time: 2018-02-08 13:40:52

CC:  fbissey embray mkoeppe

The various Cython files (`.pyx`, `.pxd`, `.pxi`) from the Sage library should be _installed_ in `site-packages`. In fact, we already do this for `.pxd` and `.pxi` files.

Tickets #21480 and #24681 discuss reasons why we should do that: it allows displaying the traceback of Cython source files without accessing `SAGE_SRC`, which is a good thing for distributions.


---

Comment by jdemeyer created at 2018-02-08 13:49:36

Changing status from new to needs_review.


---

Comment by jdemeyer created at 2018-02-08 13:49:36

New commits:


---

Comment by fbissey created at 2018-02-08 18:53:16

Looks like something I had in sage-on-gentoo for several years.


---

Comment by fbissey created at 2018-02-08 18:53:16

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2018-02-10 12:13:26

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2018-02-10 12:13:26

Test fails, see patchbot


---

Comment by git created at 2018-02-10 12:42:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2018-02-10 12:47:58

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2018-02-10 13:18:14

This is breaking patchbots.


---

Comment by jdemeyer created at 2018-02-10 13:18:14

Changing priority from major to blocker.


---

Comment by fbissey created at 2018-02-10 20:21:24

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2018-02-10 20:21:24

Replying to [comment:7 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[68022a4](https://git.sagemath.org/sage.git/commit/?id=68022a4d114951c39f63962c4b35b3feed405f93)||`Sources in traceback are no longer in src`||

Stupid me, I always thought this failure was linked to something else that I couldn't identify. But then it looks like I have a different issue on top of this one (i.e. this test fails in sage-on-gentoo because of two things and this will only fix one). No wonder I couldn't find a single cause to the issue.


---

Comment by vbraun created at 2018-02-11 13:03:57

Resolution: fixed


---

Comment by embray created at 2018-02-12 10:25:44

This happened faster than I could comment, but certainly +1 from me.


---

Comment by embray created at 2018-02-14 16:43:30

This broke some patchbots:


```
sage -t --long src/sage/repl/interpreter.py
**********************************************************************
File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
Failed example:
    shell.run_cell('1/0')
Expected:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-...> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()
       ...        if type(left) is type(right):
       ...            if mpz_sgn((<Integer>right).value) == 0:
    -> ...                  raise ZeroDivisionError("rational division by zero")
       ...            x = <Rational> Rational.__new__(Rational)
       ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
Got:
    ---------------------------------------------------------------------------
    ZeroDivisionError                         Traceback (most recent call last)
    <ipython-input-1-72ac74c5f414> in <module>()
    ----> 1 Integer(1)/Integer(0)
    <BLANKLINE>
    /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13246)()
       1909         if type(left) is type(right):
       1910             if mpz_sgn((<Integer>right).value) == 0:
    -> 1911                 raise ZeroDivisionError("rational division by zero")
       1912             x = <Rational> Rational.__new__(Rational)
       1913             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
    <BLANKLINE>
    ZeroDivisionError: rational division by zero
**********************************************************************
1 item had failures:
   1 of   5 in sage.repl.interpreter
    [131 tests, 1 failure, 2.42 s]
```


the new location of the source files means this string comparison failed slightly...


---

Comment by fbissey created at 2018-02-14 20:19:14

Replying to [comment:13 embray]:
> This broke some patchbots:
> 
> {{{
> sage -t --long src/sage/repl/interpreter.py
> **********************************************************************
> File "src/sage/repl/interpreter.py", line 77, in sage.repl.interpreter
> Failed example:
>     shell.run_cell('1/0')
> Expected:
>     ---------------------------------------------------------------------------
>     ZeroDivisionError                         Traceback (most recent call last)
>     <ipython-input-...> in <module>()
>     ----> 1 Integer(1)/Integer(0)
>     <BLANKLINE>
>     .../src/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (.../cythonized/sage/rings/integer.c:...)()
>        ...        if type(left) is type(right):
>        ...            if mpz_sgn((<Integer>right).value) == 0:
>     -> ...                  raise ZeroDivisionError("rational division by zero")
>        ...            x = <Rational> Rational.__new__(Rational)
>        ...            mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
>     <BLANKLINE>
>     ZeroDivisionError: rational division by zero
> Got:
>     ---------------------------------------------------------------------------
>     ZeroDivisionError                         Traceback (most recent call last)
>     <ipython-input-1-72ac74c5f414> in <module>()
>     ----> 1 Integer(1)/Integer(0)
>     <BLANKLINE>
>     /home/sage-patchbot/sage/local/lib/python2.7/site-packages/sage/rings/integer.pyx in sage.rings.integer.Integer.__div__ (build/cythonized/sage/rings/integer.c:13246)()
>        1909         if type(left) is type(right):
>        1910             if mpz_sgn((<Integer>right).value) == 0:
>     -> 1911                 raise ZeroDivisionError("rational division by zero")
>        1912             x = <Rational> Rational.__new__(Rational)
>        1913             mpq_div_zz(x.value, (<Integer>left).value, (<Integer>right).value)
>     <BLANKLINE>
>     ZeroDivisionError: rational division by zero
> **********************************************************************
> 1 item had failures:
>    1 of   5 in sage.repl.interpreter
>     [131 tests, 1 failure, 2.42 s]
> }}}
> 
> the new location of the source files means this string comparison failed slightly...

That was fixed in the latest commit. You must be looking at old reports.


---

Comment by embray created at 2018-02-15 16:54:17

Actually I'm not sure that's exactly it.  I think that what's happening is that any patchbots that tested this ticket now have the `.pyx` files installed into their `site-packages`, but when they switch branches again to test older tickets, it's not deleting those `.pyx` files (after all, the old branches don't know what they should be there in the first place) so those patchbots are failing.

I suppose there's not much we can do about that other than be aware of the problem, and eventually it will normalize...
