# Issue 29122: dense + sparse matrix should be dense

Issue created by migration from https://trac.sagemath.org/ticket/29359

Original creator: @mwageringel

Original creation time: 2020-03-18 17:35:00

When adding or subtracting a dense matrix and a sparse matrix, the resulting matrix is sparse in some cases.

```
sage: a = matrix.random(ZZ, 3, sparse=False)
sage: b = matrix.random(ZZ, 3, sparse=True)
sage: (a + b).is_sparse()  # correct
False
sage: (a.change_ring(QQ) + b).is_sparse()  # correct
False
sage: (a.change_ring(QQ) + b.change_ring(QQ)).is_sparse()  # correct
False
sage: (a + b.change_ring(QQ)).is_sparse()  # should also be False
True
```

This seems to happen when the rings are different and the common coercion parent of the rings is the ring of the sparse matrix.



---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by @mwageringel created at 2020-07-05 20:48:18

The problem here seems to be that there is a coercion from the dense matrix space to the sparse one, so the sparse matrix space is discovered as a common parent:


```
sage: a = matrix.random(ZZ, 3, sparse=False)
sage: b = matrix.random(QQ, 3, sparse=True)
sage: b.parent().has_coerce_map_from(a.parent())
True
sage: coercion_model.common_parent(a, b)
Full MatrixSpace of 3 by 3 sparse matrices over Rational Field
```


It would be better if the pushout were used here, as it correctly results in a dense matrix space:


```
sage: sage.categories.pushout.pushout(a.parent(), b.parent())
Full MatrixSpace of 3 by 3 dense matrices over Rational Field
```



---

Comment by chapoton created at 2020-12-13 09:12:36

more information:

```
sage: cm.explain(A,B,operator.mul)                                              
Action discovered.
    Left action by Full MatrixSpace of 3 by 3 dense matrices over Integer Ring on Full MatrixSpace of 3 by 3 sparse matrices over Rational Field
Result lives in Full MatrixSpace of 3 by 3 dense matrices over Rational Field
Full MatrixSpace of 3 by 3 dense matrices over Rational Field

sage: cm.explain(A,B,operator.add)                                              
Coercion on left operand via
    Coercion map:
      From: Full MatrixSpace of 3 by 3 dense matrices over Integer Ring
      To:   Full MatrixSpace of 3 by 3 sparse matrices over Rational Field
Arithmetic performed after coercions.
Result lives in Full MatrixSpace of 3 by 3 sparse matrices over Rational Field
Full MatrixSpace of 3 by 3 sparse matrices over Rational Field
```



---

Comment by mkoeppe created at 2021-02-13 20:51:01

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.
