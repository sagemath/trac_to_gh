# Issue 27117: Add assume() warning against chained comparisons

Issue created by migration from https://trac.sagemath.org/ticket/27354

Original creator: mjo

Original creation time: 2019-02-25 23:42:45

CC:  kcrisman jdemeyer rws @mwageringel egourgoulhon

Evan O'Dorney reported that `assume(0 < x < 1)` doesn't work the way you'd expect it to:

https://groups.google.com/forum/#!topic/sage-devel/-OdekKRf504

He's right, but this is probably unfixable. The chained comparison is translated by python into an "and" statement, and those aren't valid assumptions. Some other weird stuff takes place, too, and you wind up with junk. We should warn about this in the `assume()` documentation.



---

Comment by mjo created at 2019-02-25 23:48:17

I need to force-push a better commit message but the docs are there.
----
New commits:


---

Comment by git created at 2019-02-26 01:01:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2019-02-26 01:02:54

Changing status from new to needs_review.


---

Comment by kcrisman created at 2019-02-26 02:52:27

Overall this looks very nice.  I'd add a `forget()` at the end just to be oll korrect.  Also, do we want the warning block to be the first thing people see?  I'm not sure what the regulations are on where that could be added, but probably it shouldn't be the very first thing, before one reads even how to use `assume()` in the first place.


---

Comment by git created at 2019-02-26 19:10:19

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2019-02-26 19:17:55

Better? Now that there are some input/output docs, the warning isn't the first thing that the user will see. I realize that the INPUT block is highly confusing, but so is the interface it describes =)


---

Comment by kcrisman created at 2019-02-27 02:03:42

`if we are given junk` - nice.

Actually, really nice improvement, thank you!  I don't see any obvious problems and I think your markup is correct, so once the patchbot says yes let's go.  It is weird that I can't even figure out how to trigger that (untested and hence broken) exception in the current code.


---

Comment by mjo created at 2019-02-27 03:30:00

Replying to [comment:7 kcrisman]:
> It is weird that I can't even figure out how to trigger that (untested and hence broken) exception in the current code.

I don't think you can. I'll bet that it should have been `except AttributeError` all along, but nobody noticed because it wasn't tested.


---

Comment by jdemeyer created at 2019-02-27 06:20:36

1. I find this explanation not very clear:

```
Don't use python's chained comparison notation in assumptions.
The expression ``0 < x < 1``, is translated literally in python
to ``(0 < x) and (x < 1)``, but the value of ``x < 1`` is always
false when ``x`` is a symbolic variable. By an unlucky coincidence
no error is raised, but needless to say, you don't wind up with
the assumptions that you wanted.
```


I would write something like

```
Python's chained comparison notation like ``assume(0 < x < 1)`` does not work.
This is because Python literally translates the expression ``0 < x < 1``
to ``(0 < x) and (x < 1)``. Since the value of ``0 < x`` is typically
false, the expression ``0 < x < 1`` evaluates to ``0 < x``.
```


2. Also this

```
Since both ``0 < x`` and
``1 < x`` are false, the conjunction is false, and is thus itself
equivalent to ``0 < x``. So, the simplification of ``0 < x < 1``
to ``0 < x`` by python is admissible
```

is a bit strangely written. The fact that `0 < x < 1` equals `0 < x` is not an "admissible simplification", it's part of the Python language that `0 < x < 1` gets interpreted as `(0 < x) and (x < 1)` and that `X and Y` is `X` whenever `X` is false.

3. Use 4 spaces for indentation, also in that `.. WARNING::` block.

4. Why are we changing

```
        sage: var('n, P, r, r2')
        (n, P, r, r2)
```

to

```
sage: n,P,r,r2 = SR.var('n, P, r, r2')
```



---

Comment by jdemeyer created at 2019-02-27 06:20:36

Changing status from needs_review to needs_work.


---

Comment by git created at 2019-02-27 15:26:40

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-02-27 15:55:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mjo created at 2019-02-27 16:03:55

Replying to [comment:9 jdemeyer]:
> 1. I find this explanation not very clear:
> 
> 2. Also this

I was trying to weasel out of explaining exactly what's going on =P

The python docs are a bit ambiguous, since they say that `x and y` means "if x is false, then x, else y." In our case, `x` is **not** false -- it's a symbolic expression such that `bool(x)` is false. But I guess that still gets simplified to `x`, and that's why you get a junk result rather than an error.

In any case, I've tried to make the explanation in the WARNING block 
more precise, so that I don't need to waffle about it in the test case.


> 
> 3. Use 4 spaces for indentation, also in that `.. WARNING::` block.

Fixed.


> 4. Why are we changing

Using `var()` to inject names into the global scope is a bad practice, so I think we should avoid it in EXAMPLES where possible. It didn't belong in that commit, though, so I've separated it out.


---

Comment by mjo created at 2019-02-27 16:03:55

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2019-02-27 16:10:14

Replying to [comment:12 mjo]:
> `x` is **not** false -- it's a symbolic expression such that `bool(x)` is false.

From Python's point of view, that's just the same. I wouldn't call it a simplification, it's just asking for the boolean value of a Python object (this object being the expression `0 < x`).

> Using `var()` to inject names into the global scope is a bad practice, so I think we should avoid it in EXAMPLES where possible.

That's news to me. Is there a general consensus that using `var()` is a bad idea? Without such a consensus, I would rather not make those changes here.


---

Comment by mjo created at 2019-02-27 16:29:37

Replying to [comment:13 jdemeyer]:
> 
> > Using `var()` to inject names into the global scope is a bad practice, so I think we should avoid it in EXAMPLES where possible.
> 
> That's news to me. Is there a general consensus that using `var()` is a bad idea? Without such a consensus, I would rather not make those changes here.

It's banned in the sage library because it causes non-local bugs. If I write


```
def foo():
    var('x')
    return baz(bar(x))
```


and then later call `foo`, it's going to clobber whatever `x` already exists. Unless you're familiar with the _implementation_ of `foo`, you won't know what happened. Instead, I should be writing


```
def foo():
    x = SR.var('x')
    return baz(bar(x))
```


Now it's safe to call `foo` even when I have my own `x` in scope. One of these is always safe, and the other isn't. I don't know about consensus, but since `SR.var()` is strictly better, I think we should teach people the safe thing instead.


---

Comment by embray created at 2019-03-25 10:56:15

Ticket retargeted after milestone closed (if you don't believe this ticket is appropriate for the Sage 8.8 release please retarget manually)


---

Comment by embray created at 2019-07-03 11:37:56

Moving tickets from the Sage 8.8 milestone that have been actively worked on in the last six months to the next release milestone (optimistically).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mjo created at 2020-04-09 14:00:25

CC'ing a few other people with recent commits under `src/sage/symbolic/`. There's only one line of code changed here (dropped a try/catch, explained in the commit message)... the rest is just additional documentation and tests.


---

Comment by kcrisman created at 2020-04-09 14:11:33

I'm okay with the code change, as explained above, but I don't know exactly what is new since the time I said "if patchbot says yes then it's fine".  I guess you could even add an example documenting that 

> The two types can be combined, but a symbolic inequality cannot appear in the middle of a list of variables.

but given how long this has been here maybe it's better to just let it go.

I'd still want patchbot and/or another human to be happy, though.


---

Comment by kcrisman created at 2020-04-09 14:12:44

By the way, I'm okay with not using `SR.var` in testing code, since that is supposed to code people might actually use, but I am also okay with the versions you have for the reasons you state.


---

Comment by mjo created at 2020-04-09 15:35:16

I think the patchbots are OK? There was significant discussion since you said "once the patchbot says yes let's go", enough so that I wouldn't feel comfortable marking this positive-review on your behalf.


---

Comment by kcrisman created at 2020-04-09 15:46:18

Unfortunately since there were forced pushes I'm not sure what is exactly different in the commits.  But I think that what you have is pretty comprehensive, and I think you responded adequately in the new commits to Jeroen's question.  I guess it would be good for one other person to confirm that since I can't literally test this right now (or for the foreseeable future) but I think that you were pretty comprehensive so I am okay with a positive review, for my part.


---

Comment by mjo created at 2020-04-09 15:50:49

Ah, try the "(Commits)" link next to the branch name in the ticket properties. Each one should make sense on its own. That way you don't have to worry about the forced pushes.


---

Comment by kcrisman created at 2020-04-09 16:00:12

Oh, it all makes sense (and I've used those links plenty of times) - what I meant was that I don't know what has changed since my previous review since, presumably, the individual commits are also different from what they were before.  Anyway, I have no problems with this branch.


---

Comment by @mwageringel created at 2020-04-09 17:15:17

Changing status from needs_review to positive_review.


---

Comment by @mwageringel created at 2020-04-09 17:15:17

The changes look good to me as well, so I am setting this to positive.


---

Comment by mjo created at 2020-04-09 18:39:55

Thanks!


---

Comment by vbraun created at 2020-04-12 15:34:27

Resolution: fixed
