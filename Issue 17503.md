# Issue 17503: Division of modules by basering elements should not pass to the fraction field.

archive/issues_017503.json:
```json
{
    "body": "```\nsage: cm = sage.structure.element.get_coercion_model()\nsage: cm.bin_op(GF(5)['x'].gen(), 7, operator.div).parent()\n\ufe21dd186f73-dcbf-4799-a7c7-5ad880512d60\ufe21{\"stdout\":\"Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5\\n\"}\ufe21\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/17740\n\n",
    "created_at": "2015-02-06T10:37:49Z",
    "labels": [
        "component: coercion",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.5",
    "title": "Division of modules by basering elements should not pass to the fraction field.",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/17503",
    "user": "https://github.com/robertwb"
}
```
```
sage: cm = sage.structure.element.get_coercion_model()
sage: cm.bin_op(GF(5)['x'].gen(), 7, operator.div).parent()
︡dd186f73-dcbf-4799-a7c7-5ad880512d60︡{"stdout":"Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5\n"}︡
```

Issue created by migration from https://trac.sagemath.org/ticket/17740





---

archive/issue_comments_233458.json:
```json
{
    "body": "Can we also address here why asking the coercion system to do this operation does not lead to the same result as when we just do the computation?\n\n```\nsage: parent(GF(5)['x'].gen()/7)\nUnivariate Polynomial Ring in x over Finite Field of size 5\n```\nThere may be good reasons for this (performance?) so I'm not immediately suggesting that we change the code to use the same path in both cases, but we should document that and why we're not.\n\n---\nNew commits:",
    "created_at": "2015-02-06T16:14:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233458",
    "user": "https://github.com/nbruin"
}
```

Can we also address here why asking the coercion system to do this operation does not lead to the same result as when we just do the computation?

```
sage: parent(GF(5)['x'].gen()/7)
Univariate Polynomial Ring in x over Finite Field of size 5
```
There may be good reasons for this (performance?) so I'm not immediately suggesting that we change the code to use the same path in both cases, but we should document that and why we're not.

---
New commits:



---

archive/issue_comments_233459.json:
```json
{
    "body": "It was probably added because coercion simply didn't used to do the right thing. I've filed #17741 about removing the redundant __div__ which may uncover surprises.",
    "created_at": "2015-02-06T18:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233459",
    "user": "https://github.com/robertwb"
}
```

It was probably added because coercion simply didn't used to do the right thing. I've filed #17741 about removing the redundant __div__ which may uncover surprises.



---

archive/issue_comments_233460.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2015-02-06T18:28:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233460",
    "user": "https://github.com/robertwb"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_233461.json:
```json
{
    "body": "My main concern is that your solution ignore iteration\n\n```\nsage: cm.get_action(GF(5)['x']['y'], ZZ, operator.div)\nRight inverse action by Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5 on Univariate Polynomial Ring in y over Univariate Polynomial Ring in x over Finite Field of size 5\nwith precomposition on right by Composite map:\n  From: Integer Ring\n  To:   Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5\n  Defn:   Natural morphism:\n          From: Integer Ring\n          To:   Finite Field of size 5\n        then\n          Polynomial base injection morphism:\n          From: Finite Field of size 5\n          To:   Univariate Polynomial Ring in x over Finite Field of size 5\n        then\n          Ring Coercion morphism:\n          From: Univariate Polynomial Ring in x over Finite Field of size 5\n          To:   Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5\n```\n\nI think that `GF(5)['x,y']` and `GF(5)['x']['y']` should behave similarly.\n\nVincent",
    "created_at": "2015-02-06T20:45:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233461",
    "user": "https://github.com/videlec"
}
```

My main concern is that your solution ignore iteration

```
sage: cm.get_action(GF(5)['x']['y'], ZZ, operator.div)
Right inverse action by Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5 on Univariate Polynomial Ring in y over Univariate Polynomial Ring in x over Finite Field of size 5
with precomposition on right by Composite map:
  From: Integer Ring
  To:   Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5
  Defn:   Natural morphism:
          From: Integer Ring
          To:   Finite Field of size 5
        then
          Polynomial base injection morphism:
          From: Finite Field of size 5
          To:   Univariate Polynomial Ring in x over Finite Field of size 5
        then
          Ring Coercion morphism:
          From: Univariate Polynomial Ring in x over Finite Field of size 5
          To:   Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5
```

I think that `GF(5)['x,y']` and `GF(5)['x']['y']` should behave similarly.

Vincent



---

archive/issue_comments_233462.json:
```json
{
    "body": "Yes, I've actually been thinking about that as well, and I'm not sure exactly how best to handle this. GF(5)['x']['y'] is a GF(5)-module but represented as a GF(5)['x']-module. Or, put otherwise, (most) elements of ZZ have an inverse in GF(5); we want to take the most conservative inverse possible.\n\nI used to be very against partial coercions like QQ -> GF(p), but I'm not as sure anymore.",
    "created_at": "2015-02-06T22:43:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233462",
    "user": "https://github.com/robertwb"
}
```

Yes, I've actually been thinking about that as well, and I'm not sure exactly how best to handle this. GF(5)['x']['y'] is a GF(5)-module but represented as a GF(5)['x']-module. Or, put otherwise, (most) elements of ZZ have an inverse in GF(5); we want to take the most conservative inverse possible.

I used to be very against partial coercions like QQ -> GF(p), but I'm not as sure anymore.



---

archive/issue_comments_233463.json:
```json
{
    "body": "Note that this behavior is not new\n\n```\nsage: parent(GF(5)['x']['y'].gen() / 2)\nUnivariate Polynomial Ring in y over Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5\n```\n\nMore generally, given an R-module M and an element in R0 such that R0 -> R1 -> ... -> Rn -> R, where along this chain should the multiplicative inverse be calculated? Maybe the first (last?) Ri that is already field? Starts to feel a bit ad-hoc...",
    "created_at": "2015-02-07T05:18:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233463",
    "user": "https://github.com/robertwb"
}
```

Note that this behavior is not new

```
sage: parent(GF(5)['x']['y'].gen() / 2)
Univariate Polynomial Ring in y over Fraction Field of Univariate Polynomial Ring in x over Finite Field of size 5
```

More generally, given an R-module M and an element in R0 such that R0 -> R1 -> ... -> Rn -> R, where along this chain should the multiplicative inverse be calculated? Maybe the first (last?) Ri that is already field? Starts to feel a bit ad-hoc...



---

archive/issue_comments_233464.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-08T07:59:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233464",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233465.json:
```json
{
    "body": "OK, I've implemented the above behavior.",
    "created_at": "2015-02-08T08:00:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233465",
    "user": "https://github.com/robertwb"
}
```

OK, I've implemented the above behavior.



---

archive/issue_comments_233466.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2015-02-08T10:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233466",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_233467.json:
```json
{
    "body": "I wrote trivial commits while I was reading the code. One thing to mention: in the documentation you should use `:trac:`17440`` instead of `#17440`.\n\nOne last question: in `coerce.pyx`, you wrote\n\n```\ntry:\n    return ~right_mul\nexcept TypeError: # action may not be invertible\n    self._record_exception()\n```\nShouldn't we catch only `CoercionException`?\n\n---\nNew commits:",
    "created_at": "2015-02-08T10:48:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233467",
    "user": "https://github.com/videlec"
}
```

I wrote trivial commits while I was reading the code. One thing to mention: in the documentation you should use `:trac:`17440`` instead of `#17440`.

One last question: in `coerce.pyx`, you wrote

```
try:
    return ~right_mul
except TypeError: # action may not be invertible
    self._record_exception()
```
Shouldn't we catch only `CoercionException`?

---
New commits:



---

archive/issue_comments_233468.json:
```json
{
    "body": "Changing status from needs_info to needs_work.",
    "created_at": "2015-02-08T11:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233468",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_info to needs_work.



---

archive/issue_comments_233469.json:
```json
{
    "body": "And something is broken:\n\n```\nsage -t schemes/toric/divisor.py\n**********************************************************************\nFile \"schemes/toric/divisor.py\", line 35, in sage.schemes.toric.divisor\nFailed example:\n    (1/2)*Dx + Dy/3 - Dz\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 6 affine patches' and 'Integer Ring'\n**********************************************************************\nFile \"schemes/toric/divisor.py\", line 40, in sage.schemes.toric.divisor\nFailed example:\n    (Dx/2).parent()\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 6 affine patches' and 'Integer Ring'\n**********************************************************************\nFile \"schemes/toric/divisor.py\", line 866, in sage.schemes.toric.divisor.ToricDivisor_generic.is_Weil\nFailed example:\n    (D/2).is_Weil()\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 3 affine patches' and 'Integer Ring'\n**********************************************************************\nFile \"schemes/toric/divisor.py\", line 893, in sage.schemes.toric.divisor.ToricDivisor_generic.is_QQ_Weil\nFailed example:\n    (D/2).is_QQ_Weil()\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 3 affine patches' and 'Integer Ring'\n**********************************************************************\n3 items had failures:\n   2 of  42 in sage.schemes.toric.divisor\n   1 of   5 in sage.schemes.toric.divisor.ToricDivisor_generic.is_QQ_Weil\n   1 of   5 in sage.schemes.toric.divisor.ToricDivisor_generic.is_Weil\n    [363 tests, 4 failures, 2.53 s]\n----------------------------------------------------------------------\nsage -t schemes/toric/divisor.py  # 4 doctests failed\n----------------------------------------------------------------------\n```",
    "created_at": "2015-02-08T11:09:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233469",
    "user": "https://github.com/videlec"
}
```

And something is broken:

```
sage -t schemes/toric/divisor.py
**********************************************************************
File "schemes/toric/divisor.py", line 35, in sage.schemes.toric.divisor
Failed example:
    (1/2)*Dx + Dy/3 - Dz
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 6 affine patches' and 'Integer Ring'
**********************************************************************
File "schemes/toric/divisor.py", line 40, in sage.schemes.toric.divisor
Failed example:
    (Dx/2).parent()
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 6 affine patches' and 'Integer Ring'
**********************************************************************
File "schemes/toric/divisor.py", line 866, in sage.schemes.toric.divisor.ToricDivisor_generic.is_Weil
Failed example:
    (D/2).is_Weil()
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 3 affine patches' and 'Integer Ring'
**********************************************************************
File "schemes/toric/divisor.py", line 893, in sage.schemes.toric.divisor.ToricDivisor_generic.is_QQ_Weil
Failed example:
    (D/2).is_QQ_Weil()
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: unsupported operand parent(s) for '/': 'Group of toric ZZ-Weil divisors on 2-d CPR-Fano toric variety covered by 3 affine patches' and 'Integer Ring'
**********************************************************************
3 items had failures:
   2 of  42 in sage.schemes.toric.divisor
   1 of   5 in sage.schemes.toric.divisor.ToricDivisor_generic.is_QQ_Weil
   1 of   5 in sage.schemes.toric.divisor.ToricDivisor_generic.is_Weil
    [363 tests, 4 failures, 2.53 s]
----------------------------------------------------------------------
sage -t schemes/toric/divisor.py  # 4 doctests failed
----------------------------------------------------------------------
```



---

archive/issue_comments_233470.json:
```json
{
    "body": "Replying to [comment:11 vdelecroix]:\n> And something is broken:\n> \n> ```\n> sage -t schemes/toric/divisor.py\n> ```\n\n\nThe problematic line is `module_action = type(self)(K, self.codomain())` in `coerce_action.pyx`\n\n```\nsage: dP6 = toric_varieties.dP6()\nsage: Dx,Du,Dy,Dv,Dz,Dw = dP6.toric_divisor_group().gens()\nsage: A = RightModuleAction(ZZ, Dx.parent())\nsage: ~A\nTraceback (most recent call last):\n...\n    472             print \"self.codomain = {}\".format(self.codomain())\n--> 473             module_action = type(self)(K, self.codomain())\n    474             connecting = K.coerce_map_from(self.G)\n...\nCoercionException: No common base\n```",
    "created_at": "2015-02-08T11:26:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233470",
    "user": "https://github.com/videlec"
}
```

Replying to [comment:11 vdelecroix]:
> And something is broken:
> 
> ```
> sage -t schemes/toric/divisor.py
> ```


The problematic line is `module_action = type(self)(K, self.codomain())` in `coerce_action.pyx`

```
sage: dP6 = toric_varieties.dP6()
sage: Dx,Du,Dy,Dv,Dz,Dw = dP6.toric_divisor_group().gens()
sage: A = RightModuleAction(ZZ, Dx.parent())
sage: ~A
Traceback (most recent call last):
...
    472             print "self.codomain = {}".format(self.codomain())
--> 473             module_action = type(self)(K, self.codomain())
    474             connecting = K.coerce_map_from(self.G)
...
CoercionException: No common base
```



---

archive/issue_comments_233471.json:
```json
{
    "body": "Fixed these failing tests. \n\nAlso, no, we don't want to only catch `CoercionException` there.\n\n---\nNew commits:",
    "created_at": "2015-02-11T05:13:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233471",
    "user": "https://github.com/robertwb"
}
```

Fixed these failing tests. 

Also, no, we don't want to only catch `CoercionException` there.

---
New commits:



---

archive/issue_comments_233472.json:
```json
{
    "body": "Still some failing doctests... (the last one only concerns the more recent 6-5.rc0)\n\nFile `rings/quotient_ring_element.py`\n\n```\nline 360, in sage.rings.quotient_ring_element.QuotientRingElement._div_\nFailed example:\n    1/cuberoot\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: self must be an integral domain.\n**********************************************************************\nline 362, in sage.rings.quotient_ring_element.QuotientRingElement._div_\nFailed example:\n    1/a\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: self must be an integral domain.\n**********************************************************************\nFile \"src/sage/rings/quotient_ring_element.py\", line 370, in sage.rings.quotient_ring_element.QuotientRingElement._div_\nFailed example:\n    1 / S(x1 + x2)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ArithmeticError: Division failed. The numerator is not a multiple of the denominator.\nGot:\n    Traceback (most recent call last):\n    ...\n    TypeError: self must be an integral domain.\n```\n\n\nFile `rings/padics/local_generic_element.pyx`\n\n```\nline 63, in sage.rings.padics.local_generic_element.LocalGenericElement._div_\nFailed example:\n    R = Zp(7, 4, 'fixed-mod'); 1/R(7)\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: cannot invert non-unit\nGot:\n    Traceback (most recent call last):\n    ...\n    TypeError: This implementation of the p-adic ring does not support fields of fractions.\n```\n\nFile `rings/padics/padic_ZZ_pX_FM_element.pyx`\n\n```\nline 88, in sage.rings.padics.padic_ZZ_pX_FM_element\nFailed example:\n    1/a\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: This implementation of the p-adic ring does not support fields of fractions.\n**********************************************************************\nline 875, in sage.rings.padics.padic_ZZ_pX_FM_element.pAdicZZpXFMElement._div_\nFailed example:\n    1 / W(14) == ~W(14)\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: This implementation of the p-adic ring does not support fields of fractions.\n**********************************************************************\nline 877, in sage.rings.padics.padic_ZZ_pX_FM_element.pAdicZZpXFMElement._div_\nFailed example:\n    1 / w\nExpected:\n    Traceback (most recent call last):\n    ...\n    ValueError: cannot invert non-unit\nGot:\n    Traceback (most recent call last):\n    ...\n    TypeError: This implementation of the p-adic ring does not support fields of fractions.\n**********************************************************************\nline 885, in sage.rings.padics.padic_ZZ_pX_FM_element.pAdicZZpXFMElement._div_\nFailed example:\n    1/(t+t^2)\nException raised:\n    Traceback (most recent call last):\n    ...\n    TypeError: This implementation of the p-adic ring does not support fields of fraction.\n```\n\nIn `modular/modform_hecketriangle/graded_ring_element.py`:\n\n```\nsage -t --long src/sage/modular/modform_hecketriangle/graded_ring_element.py\n**********************************************************************\nline 887, in sage.modular.modform_hecketriangle.graded_ring_element.FormsRingElement._div_\nFailed example:\n    ((E4.as_ring_element())^(-2)).parent() == (E4^(-2)).parent()\nException raised:\n    Traceback (most recent call last):\n    ...\n    NotImplementedError: No way to prove that ModularFormsRing(n=8) over Integer Ring is an integral domain!\n**********************************************************************\nline 889, in sage.modular.modform_hecketriangle.graded_ring_element.FormsRingElement._div_\nFailed example:\n    (MR(x)^(-3)).parent()\nException raised:\n    Traceback (most recent call last):\n    ...\n    NotImplementedError: No way to prove that QuasiMeromorphicModularFormsRing(n=8) over Integer Ring is an integral domain!\n```",
    "created_at": "2015-02-11T10:53:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233472",
    "user": "https://github.com/videlec"
}
```

Still some failing doctests... (the last one only concerns the more recent 6-5.rc0)

File `rings/quotient_ring_element.py`

```
line 360, in sage.rings.quotient_ring_element.QuotientRingElement._div_
Failed example:
    1/cuberoot
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: self must be an integral domain.
**********************************************************************
line 362, in sage.rings.quotient_ring_element.QuotientRingElement._div_
Failed example:
    1/a
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: self must be an integral domain.
**********************************************************************
File "src/sage/rings/quotient_ring_element.py", line 370, in sage.rings.quotient_ring_element.QuotientRingElement._div_
Failed example:
    1 / S(x1 + x2)
Expected:
    Traceback (most recent call last):
    ...
    ArithmeticError: Division failed. The numerator is not a multiple of the denominator.
Got:
    Traceback (most recent call last):
    ...
    TypeError: self must be an integral domain.
```


File `rings/padics/local_generic_element.pyx`

```
line 63, in sage.rings.padics.local_generic_element.LocalGenericElement._div_
Failed example:
    R = Zp(7, 4, 'fixed-mod'); 1/R(7)
Expected:
    Traceback (most recent call last):
    ...
    ValueError: cannot invert non-unit
Got:
    Traceback (most recent call last):
    ...
    TypeError: This implementation of the p-adic ring does not support fields of fractions.
```

File `rings/padics/padic_ZZ_pX_FM_element.pyx`

```
line 88, in sage.rings.padics.padic_ZZ_pX_FM_element
Failed example:
    1/a
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: This implementation of the p-adic ring does not support fields of fractions.
**********************************************************************
line 875, in sage.rings.padics.padic_ZZ_pX_FM_element.pAdicZZpXFMElement._div_
Failed example:
    1 / W(14) == ~W(14)
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: This implementation of the p-adic ring does not support fields of fractions.
**********************************************************************
line 877, in sage.rings.padics.padic_ZZ_pX_FM_element.pAdicZZpXFMElement._div_
Failed example:
    1 / w
Expected:
    Traceback (most recent call last):
    ...
    ValueError: cannot invert non-unit
Got:
    Traceback (most recent call last):
    ...
    TypeError: This implementation of the p-adic ring does not support fields of fractions.
**********************************************************************
line 885, in sage.rings.padics.padic_ZZ_pX_FM_element.pAdicZZpXFMElement._div_
Failed example:
    1/(t+t^2)
Exception raised:
    Traceback (most recent call last):
    ...
    TypeError: This implementation of the p-adic ring does not support fields of fraction.
```

In `modular/modform_hecketriangle/graded_ring_element.py`:

```
sage -t --long src/sage/modular/modform_hecketriangle/graded_ring_element.py
**********************************************************************
line 887, in sage.modular.modform_hecketriangle.graded_ring_element.FormsRingElement._div_
Failed example:
    ((E4.as_ring_element())^(-2)).parent() == (E4^(-2)).parent()
Exception raised:
    Traceback (most recent call last):
    ...
    NotImplementedError: No way to prove that ModularFormsRing(n=8) over Integer Ring is an integral domain!
**********************************************************************
line 889, in sage.modular.modform_hecketriangle.graded_ring_element.FormsRingElement._div_
Failed example:
    (MR(x)^(-3)).parent()
Exception raised:
    Traceback (most recent call last):
    ...
    NotImplementedError: No way to prove that QuasiMeromorphicModularFormsRing(n=8) over Integer Ring is an integral domain!
```



---

archive/issue_comments_233473.json:
```json
{
    "body": "Hello Robert,\n\nHere is a one-line commit that fixes all doctest issues. I am wondering why these did not appear in the first time... Tell me what you think.\n\nVincent\n\n---\nNew commits:",
    "created_at": "2015-02-14T13:31:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233473",
    "user": "https://github.com/videlec"
}
```

Hello Robert,

Here is a one-line commit that fixes all doctest issues. I am wondering why these did not appear in the first time... Tell me what you think.

Vincent

---
New commits:



---

archive/issue_comments_233474.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-14T13:31:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233474",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233475.json:
```json
{
    "body": "I don't think self is the right thing to return by default, but here's a similar fix.\n\n---\nNew commits:",
    "created_at": "2015-02-15T09:22:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233475",
    "user": "https://github.com/robertwb"
}
```

I don't think self is the right thing to return by default, but here's a similar fix.

---
New commits:



---

archive/issue_comments_233476.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-15T11:21:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233476",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_233477.json:
```json
{
    "body": "Changing status from positive_review to needs_info.",
    "created_at": "2015-02-15T16:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233477",
    "user": "https://github.com/videlec"
}
```

Changing status from positive_review to needs_info.



---

archive/issue_comments_233478.json:
```json
{
    "body": "Now, I am not sure anymore that your solution is better. The implementation of `division_parent` tries to execute `~parent.one()`. But the default implementation of `__invert__` of an element `x` in `sage.structure.element` is precisely to call `1/x` (and soonly `x.parent().one()/x` with #17692). Hence using `division_parent` should lead to some infinite recursions that we curiously do not see here. No?\n\nEDIT: This is fine, because in `x.parent().one()/x` the numerator and denominator have the same type... and so no coercion is involved and `__div__` is called directly.",
    "created_at": "2015-02-15T16:22:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233478",
    "user": "https://github.com/videlec"
}
```

Now, I am not sure anymore that your solution is better. The implementation of `division_parent` tries to execute `~parent.one()`. But the default implementation of `__invert__` of an element `x` in `sage.structure.element` is precisely to call `1/x` (and soonly `x.parent().one()/x` with #17692). Hence using `division_parent` should lead to some infinite recursions that we curiously do not see here. No?

EDIT: This is fine, because in `x.parent().one()/x` the numerator and denominator have the same type... and so no coercion is involved and `__div__` is called directly.



---

archive/issue_comments_233479.json:
```json
{
    "body": "Changing status from needs_info to positive_review.",
    "created_at": "2015-02-15T16:30:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233479",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_info to positive_review.



---

archive/issue_comments_233480.json:
```json
{
    "body": "Yes, indeed this should go in with #17692 to prevent possible infinite recursion. Thanks for the review!",
    "created_at": "2015-02-17T04:41:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233480",
    "user": "https://github.com/robertwb"
}
```

Yes, indeed this should go in with #17692 to prevent possible infinite recursion. Thanks for the review!



---

archive/issue_comments_233481.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-02-17T20:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233481",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_233482.json:
```json
{
    "body": "Merge conflict, possibly #17694",
    "created_at": "2015-02-17T20:52:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233482",
    "user": "https://github.com/vbraun"
}
```

Merge conflict, possibly #17694



---

archive/issue_comments_233483.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2015-02-18T11:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233483",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_233484.json:
```json
{
    "body": "Hi Robert,\n\nThere was only a trivial conflict in `sage/rings/ring.pyx`. I did merge with sage-6.6.beta0 in my last commit. I let you set the positive review if this is fine.\n\nVincent\n\n---\nNew commits:",
    "created_at": "2015-02-18T11:37:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233484",
    "user": "https://github.com/videlec"
}
```

Hi Robert,

There was only a trivial conflict in `sage/rings/ring.pyx`. I did merge with sage-6.6.beta0 in my last commit. I let you set the positive review if this is fine.

Vincent

---
New commits:



---

archive/issue_comments_233485.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2015-02-24T13:27:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233485",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_233486.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2015-02-24T13:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233486",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_233487.json:
```json
{
    "body": "All long tests pass. Put back in positive review.",
    "created_at": "2015-02-24T13:56:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233487",
    "user": "https://github.com/videlec"
}
```

All long tests pass. Put back in positive review.



---

archive/issue_comments_233488.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2015-02-25T00:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233488",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_233489.json:
```json
{
    "body": "I'm getting this on OSX:\n\n```\nsage -t --long src/sage/structure/coerce_actions.pyx\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 419, in sage.structure.coerce_actions.ModuleAction.__invert__\nFailed example:\n    A = ~RightModuleAction(ZZ, GF(5)['x']); A\nException raised:\n    Traceback (most recent call last):\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 488, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 850, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.structure.coerce_actions.ModuleAction.__invert__[10]>\", line 1, in <module>\n        A = ~RightModuleAction(ZZ, GF(Integer(5))['x']); A\n      File \"sage/structure/coerce_actions.pyx\", line 464, in sage.structure.coerce_actions.ModuleAction.__invert__ (build/cythonized/sage/structure/coerce_actions.c:7385)\n        module_action = type(self)(K, self.codomain())\n      File \"sage/structure/coerce_actions.pyx\", line 376, in sage.structure.coerce_actions.ModuleAction.codomain (build/cythonized/sage/structure/coerce_actions.c:6711)\n        return self.underlying_set()\n      File \"sage/categories/action.pyx\", line 186, in sage.categories.action.Action.underlying_set (build/cythonized/sage/categories/action.c:4087)\n        raise RuntimeError, \"This action acted on a set that became garbage collected\"\n    RuntimeError: This action acted on a set that became garbage collected\n**********************************************************************\nFile \"src/sage/structure/coerce_actions.pyx\", line 424, in sage.structure.coerce_actions.ModuleAction.__invert__\nFailed example:\n    A(x, 2)\nExpected:\n    3*x\nGot:\n    1/2*x\n**********************************************************************\n1 item had failures:\n   2 of  15 in sage.structure.coerce_actions.ModuleAction.__invert__\n    [90 tests, 2 failures, 0.47 s]\n```\nIn all these doctests you need to hold domain/codomain explicitly alive.",
    "created_at": "2015-02-25T00:19:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233489",
    "user": "https://github.com/vbraun"
}
```

I'm getting this on OSX:

```
sage -t --long src/sage/structure/coerce_actions.pyx
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 419, in sage.structure.coerce_actions.ModuleAction.__invert__
Failed example:
    A = ~RightModuleAction(ZZ, GF(5)['x']); A
Exception raised:
    Traceback (most recent call last):
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 488, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/Users/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 850, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.structure.coerce_actions.ModuleAction.__invert__[10]>", line 1, in <module>
        A = ~RightModuleAction(ZZ, GF(Integer(5))['x']); A
      File "sage/structure/coerce_actions.pyx", line 464, in sage.structure.coerce_actions.ModuleAction.__invert__ (build/cythonized/sage/structure/coerce_actions.c:7385)
        module_action = type(self)(K, self.codomain())
      File "sage/structure/coerce_actions.pyx", line 376, in sage.structure.coerce_actions.ModuleAction.codomain (build/cythonized/sage/structure/coerce_actions.c:6711)
        return self.underlying_set()
      File "sage/categories/action.pyx", line 186, in sage.categories.action.Action.underlying_set (build/cythonized/sage/categories/action.c:4087)
        raise RuntimeError, "This action acted on a set that became garbage collected"
    RuntimeError: This action acted on a set that became garbage collected
**********************************************************************
File "src/sage/structure/coerce_actions.pyx", line 424, in sage.structure.coerce_actions.ModuleAction.__invert__
Failed example:
    A(x, 2)
Expected:
    3*x
Got:
    1/2*x
**********************************************************************
1 item had failures:
   2 of  15 in sage.structure.coerce_actions.ModuleAction.__invert__
    [90 tests, 2 failures, 0.47 s]
```
In all these doctests you need to hold domain/codomain explicitly alive.



---

archive/issue_comments_233490.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2015-02-25T07:41:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233490",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_233491.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2015-02-25T08:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233491",
    "user": "https://github.com/videlec"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_233492.json:
```json
{
    "body": "Right. We should not kill our parents ;-)\n\nIt is strange that I did not get these in the first place... All doctest pass.\n\nVincent",
    "created_at": "2015-02-25T08:13:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233492",
    "user": "https://github.com/videlec"
}
```

Right. We should not kill our parents ;-)

It is strange that I did not get these in the first place... All doctest pass.

Vincent



---

archive/issue_comments_233493.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2015-02-26T07:11:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233493",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_050733.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2015-02-26T07:11:07Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/17503#event-50733"
}
```



---

archive/issue_comments_233494.json:
```json
{
    "body": "Thanks for following up on this. Looks good to me.",
    "created_at": "2015-02-26T07:48:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/17503",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/17503#issuecomment-233494",
    "user": "https://github.com/robertwb"
}
```

Thanks for following up on this. Looks good to me.
