# Issue 21679: KeyError in graphviz_string the second time after adding a vertex

Issue created by migration from https://trac.sagemath.org/ticket/21916

Original creator: jepperlein

Original creation time: 2016-11-21 14:48:56

CC:  slabbe

This works:

```python
g = graphs.PetersenGraph()
g.add_vertex("a")
print g.graphviz_string()
```


This doesn't:

```python
g = graphs.PetersenGraph()
key = g._keys_for_vertices()
g.add_vertex("a")
print g.graphviz_string()

---------------------------------------------------------------------------
KeyError                                  Traceback (most recent call last)
<ipython-input-36-67d7816cb08c> in <module>()
      2 key = g._keys_for_vertices()
      3 g.add_vertex("a")
----> 4 print g.graphviz_string()

/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/misc/decorators.pyc in wrapper(*args, **kwds)
    552                 options['__original_opts'] = kwds
    553             options.update(kwds)
--> 554             return func(*args, **options)
    555 
    556         #Add the options specified by @options to the signature of the wrapped

/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in graphviz_string(self, **options)
  19219                 node_options = " [label=\"%s\"]" %quoted_str(v)
  19220 
> 19221             s += '  %s %s;\n'%(key(v),node_options)
  19222 
  19223         s += "\n"

/home/jubal/Arbeit/sage/local/lib/python2.7/site-packages/sage/graphs/generic_graph.pyc in get_label(vertex)
  18811             label[v] = 'node_{0}'.format(i)
  18812         def get_label(vertex):
> 18813             return label[vertex]
  18814         return get_label
  18815 

KeyError: 'a'
```



---

Comment by jepperlein created at 2016-11-21 14:49:25

Changing keywords from "" to "days79".


---

Comment by slabbe created at 2016-11-23 22:17:01

The only method that is using `cached_method` in the `generic_graph.py` file is the method `__hash__` and this methods works only if the graph is immutable. Therefore, to my opinion, I believe it was a bug that the method `_keys_for_vertices` was cached.

Needs review!
----
New commits:


---

Comment by slabbe created at 2016-11-23 22:17:01

Changing status from new to needs_review.


---

Comment by git created at 2016-11-23 22:50:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by dcoudert created at 2016-12-11 10:55:15

I tried this patch on top of 7.5.beta6 and it works well (and passes all tests).
Good to go.


---

Comment by dcoudert created at 2016-12-11 10:55:15

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2016-12-13 23:55:40

Resolution: fixed
