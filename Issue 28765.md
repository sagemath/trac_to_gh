# Issue 28765: spkg-configure.m4 for sqlite

Issue created by migration from https://trac.sagemath.org/ticket/29002

Original creator: mjo

Original creation time: 2020-01-13 15:14:49

CC:  embray dimpase â€‹isuruf

SQLite is another package that many people will have installed (firefox uses it, for example) and that has few dependencies in Sage (only readline). It also provides a pkgconfig file in the versions I checked, so it should be pretty easy to detect.


---

Comment by mjo created at 2020-01-13 15:20:42

I don't think we need such a new version, but 3.29.0 (from 2019-07-10) is the oldest one in Gentoo that I can test against. Should we accept versions back to 3.27 or 3.16 (or further) for Debian?
----
New commits:


---

Comment by mjo created at 2020-01-13 15:20:42

Changing status from new to needs_review.


---

Comment by dimpase created at 2020-01-14 12:05:24

I'm testing this with sqlite 3.20 on Fedora 26 now. (My Debian system has 3.27).


---

Comment by dimpase created at 2020-01-14 14:41:22

could you make the minimal version 3.20? Otherwise, all good. (I modified the version being 3.20 and tested with such sqlite)

On Fedora the packages are named `sqlite` and `sqlite-devel` - these ought to be listed in the corresponding docs - perhaps on another ticket.


---

Comment by dimpase created at 2020-01-14 14:41:22

Changing status from needs_review to positive_review.


---

Comment by git created at 2020-01-14 15:15:46

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2020-01-14 15:15:46

Changing status from positive_review to needs_review.


---

Comment by mjo created at 2020-01-14 15:17:47

Done, but the commit hook set this back to needs_review.


---

Comment by dimpase created at 2020-01-14 15:32:58

Changing status from needs_review to positive_review.


---

Comment by chapoton created at 2020-01-14 20:04:26

missing author full name please


---

Comment by mjo created at 2020-01-14 21:34:49

Sorry, I'm new at this.


---

Comment by mkoeppe created at 2020-01-15 16:57:58

This does not accept the system sqlite3 on macOS because we are installing readline -- but that is irrelevant because the system sqlite3 is linked against libedit, not readline.


---

Comment by mkoeppe created at 2020-01-15 16:57:58

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2020-01-15 17:02:36


```
egret:~/s/sage/sage-rebasing/worktree-venv (t/27824/public/27824-python3-spkg-configure *$)$ otool -L /usr/lib/libsqlite3.dylib 
/usr/lib/libsqlite3.dylib:
	/usr/lib/libsqlite3.dylib (compatibility version 9.0.0, current version 308.4.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.0.0)
egret:~/s/sage/sage-rebasing/worktree-venv (t/27824/public/27824-python3-spkg-configure *$)$ otool -L /usr/bin/sqlite3 
/usr/bin/sqlite3:
	/usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)
	/usr/lib/libedit.3.dylib (compatibility version 2.0.0, current version 3.0.0)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1281.0.0)
```



---

Comment by mkoeppe created at 2020-01-15 17:14:33

Is the executable `sqlite3` used at all in Sage? That is the only thing that depends on readline on Linux.
On Debian, `libsqlite3.so` and `/usr/bin/sqlite3` are provided by different packages.


---

Comment by dimpase created at 2020-01-15 17:17:08

how does pkg-config even know about MacOS's sqlite3?


---

Comment by mkoeppe created at 2020-01-15 17:18:37

Replying to [comment:12 mkoeppe]:
> Is the executable `sqlite3` used at all in Sage? 
Apart from providing the shortcut `sage -sqlite`, apparently not.

Should the spkg-configure check for the availability of the binary?


---

Comment by mkoeppe created at 2020-01-15 17:20:13

Replying to [comment:13 dimpase]:
> how does pkg-config even know about MacOS's sqlite3? 
homebrew's pkg-config knows it.


---

Comment by dimpase created at 2020-01-15 17:23:49

then what does prevent one from having a homebrew-installed readline?


---

Comment by mkoeppe created at 2020-01-15 17:27:48

Anything regarding readline is irrelevant for macOS's sqlite.


---

Comment by mkoeppe created at 2020-01-15 17:36:58

By the way, I don't quite get the point of SAGE_SPKG_DEPCHECK here at all. If we install our own readline, how is that relevant for the functioning of the system's sqlite3 package?


---

Comment by mjo created at 2020-01-15 17:46:22

For now, the sage sqlite package depends on readline, so the dep check is the right thing to do.

But, if sage doesn't care whether or not sqlite was built with readline support, then why don't we build it without readline support and remove the dependency from the spkg? Afterwards we would drop the dep check here, too, and everything would work out.

Personally, I would say that's a good idea, but I know there's a dissenting opinion that sage should install an independently-usable sqlite package, and that we should insist that the version on the system is comparable to the spkg.


---

Comment by mkoeppe created at 2020-01-15 17:55:04

Replying to [comment:19 mjo]:
> For now, the sage sqlite package depends on readline, so the dep check is the right thing to do.

To my understanding, PKG_CHECK_MODULES is used to guard specifically against link-time confusion of libraries and their dependencies. 

> But, if sage doesn't care whether or not sqlite was built with readline support, then why don't we build it without readline support and remove the dependency from the spkg? Afterwards we would drop the dep check here, too, and everything would work out.

Actually, the `sqlite3` on macOS is fully functional - it just provides command line editing through `libedit`, not `libreadline`.


---

Comment by mkoeppe created at 2020-01-15 17:59:36

By the way, on macOS, I get 

```
pkg-config --modversion sqlite3
3.8.10.2
```

Is that too old?


---

Comment by mkoeppe created at 2020-01-15 18:01:33

I would propose the following change (updated):

```diff
diff --git a/build/pkgs/sqlite/spkg-configure.m4 b/build/pkgs/sqlite/spkg-configure.m4
index 00bf6cb14a..44c37e57cb 100644
--- a/build/pkgs/sqlite/spkg-configure.m4
+++ b/build/pkgs/sqlite/spkg-configure.m4
@@ -1,8 +1,7 @@
 SAGE_SPKG_CONFIGURE([sqlite], [
-  SAGE_SPKG_DEPCHECK([readline], [
     PKG_CHECK_MODULES([SQLITE],
-                      [sqlite3 >= 3.20.0],
-                      [],
+                      [sqlite3 >= 3.8.10],
+                      [AC_CHECK_PROG([SQLITE3], sqlite3, [],
+                        [AC_MSG_WARN([libsqlite3 is found, so we do not install the sqlite spkg, but sqlite3 is not found, so "sage -sqlite3" will not work])])],
                       [sage_spkg_install_sqlite=yes])
-  ])
 ])

```



---

Comment by mkoeppe created at 2020-01-15 18:28:21

I note that the previous update tickets for the sqlite spkg were only motivated by build system issues, or because "it's time to upgrade". So I don't think the version has to be very new to work for any of our code. For example:
- #27303 - Upgrade sqlite3 to 3.27.1
- #22687- update sqlite to version 3.17
- #16098 - Update sqlite to 3.8.4.3


---

Comment by dimpase created at 2020-01-15 18:36:21

AC_CHECK_PROG is not used correctly in comment:22 - 3rd and 4rd parameters of it are values to be assigned to the variable from the 1st parameter, not actions to be performed...


---

Comment by mjo created at 2020-01-15 18:38:01

Replying to [comment:21 mkoeppe]:
> By the way, on macOS, I get 
> {{{
> pkg-config --modversion sqlite3
> 3.8.10.2
> }}}
> Is that too old?

Yeah, the lower bound is at 3.20 right now.


>I would propose the following change (updated)

Ok, I agree. The dependency on readline *replaces* a dependency on editline (you have to pick one), so simply dropping the dependency from the sqlite package is not the option I thought it was. Moreover, readline/editline accomplish the same thing, so the dep check is counterproductive here.

I don't think we even need to check for the sqlite3 executable. Zero people will run the system sqlite using sage -sqlite3, and even fewer than zero people read the ./configure output.


---

Comment by dimpase created at 2020-01-15 18:43:59

cryptominisat package plays with SQL, in fact it can generate some SQL data, and sqlite3 is listed as its dependency.


---

Comment by mjo created at 2020-01-15 18:46:06

Replying to [comment:26 dimpase]:
> cryptominisat package plays with SQL, in fact it can generate some SQL data, and sqlite3 is listed as its dependency.
> 

Right, and we still have the pkg-config check to ensure that sqlite3 is installed. Are there any distros that install it *without* the CLI? I doubt it... and that's the only reason we would need an extra check for it.


---

Comment by mkoeppe created at 2020-01-15 18:47:45

Replying to [comment:25 mjo]:
> Replying to [comment:21 mkoeppe]:
> > {{{
> > pkg-config --modversion sqlite3
> > 3.8.10.2
> > }}}
> > Is that too old?
> 
> Yeah, the lower bound is at 3.20 right now.

I can see that - but my question is why.


---

Comment by mjo created at 2020-01-15 18:51:10

Replying to [comment:28 mkoeppe]:
> 
> I can see that - but my question is why.

Mainly just because the further back in time we go, the less valid my testing with v3.29 becomes. New commits incoming.


---

Comment by mkoeppe created at 2020-01-15 18:52:44

Replying to [comment:27 mjo]:
>  Are there any distros that install it *without* the CLI? I doubt it... and that's the only reason we would need an extra check for it.
Yes, if one installs `libsqlite3-dev` on Debian, the CLI is not installed.


---

Comment by mkoeppe created at 2020-01-15 18:53:45

Replying to [comment:29 mjo]:
> Replying to [comment:28 mkoeppe]:
> > 
> > I can see that - but my question is why.
> 
> Mainly just because the further back in time we go, the less valid my testing with v3.29 becomes. New commits incoming.
Tests of what? I can test on macOS if necessary. I think we should support the default libsqlite that is shipped with the current XCode on macOS.


---

Comment by git created at 2020-01-15 18:53:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-15 18:56:58

Replying to [comment:26 dimpase]:
> cryptominisat package plays with SQL, in fact it can generate some SQL data, and sqlite3 is listed as its dependency.
> 
But no specific version of sqlite is tested for in cryptominisat's build system, as far as I can see.


---

Comment by mjo created at 2020-01-15 18:58:10

Replying to [comment:30 mkoeppe]:
> Yes, if one installs `libsqlite3-dev` on Debian, the CLI is not installed.

JFC. Should we fall back to the spkg if no CLI is found, then? I think Dima's point is that people will want to run the sqlite CLI in one way or another, to e.g. look at the cryptominisat data.


---

Comment by mkoeppe created at 2020-01-15 19:08:25

Replying to [comment:34 mjo]:
> Should we fall back to the spkg if no CLI is found, then? I think Dima's point is that people will want to run the sqlite CLI in one way or another, to e.g. look at the cryptominisat data.
Fine with me.


---

Comment by mjo created at 2020-01-15 19:11:21

Hmmm, can you try a full build on macOS against the system sqlite now? Since the spkg python also links against readline, I'm not 100% sure there won't be collisions between the readline symbols from python and the editline symbols from sqlite. Hopefully the linkage is isolated to the CLI and it won't matter.


---

Comment by mkoeppe created at 2020-01-15 19:28:29

As you can see in comment 11, the library is not linked against `libedit`, only the executable is.


---

Comment by dimpase created at 2020-01-15 19:57:47

I think I'm fine with not checking for existence of sqlite3 executable at all.


---

Comment by dimpase created at 2020-01-15 19:58:17

Changing status from needs_work to positive_review.


---

Comment by mjo created at 2020-01-16 02:10:16

Ok, I think it's safe too. If anyone shows up to complain later, the leg work is already done. We just have to add an additional AC_CHECK_PROG for sqlite3 and install the spkg if not found.


---

Comment by embray created at 2020-01-17 14:34:25

Changing status from positive_review to needs_work.


---

Comment by embray created at 2020-01-17 14:34:25

I agree that the sqlite3 CLI should not be required.  But this doesn't seem to work for me; my Ubuntu doesn't install a sqlite.pc?  Couldn't we also fall back on a AC_CHECK_LIB?


---

Comment by dimpase created at 2020-01-17 14:35:49

Erik, isn't your Ubuntu past EOL?


---

Comment by mkoeppe created at 2020-01-17 14:39:27

Replying to [comment:42 embray]:
> I agree that the sqlite3 CLI should not be required.  But this doesn't seem to work for me; my Ubuntu doesn't install a sqlite.pc?  Couldn't we also fall back on a AC_CHECK_LIB?
Which Ubuntu is that?


---

Comment by mkoeppe created at 2020-01-17 14:40:18

But I think I would also be in favor of falling back to AC_CHECK_LIB, in fact. MacOS (without homebrew) has sqlite3 but no sqlite.pc.


---

Comment by mkoeppe created at 2020-01-17 15:43:10

Unfortunately AX_LIB_SQLITE3 from autoconf-archive is not good, it tries to parse header files to find out the version.


---

Comment by embray created at 2020-01-17 16:01:24

What's wrong with that?  In any case, I'd be okay for a fallback to not check the version.  Having pkgconfig and a version check is definitely preferable as a first pass...


---

Comment by embray created at 2020-01-17 16:02:25

Replying to [comment:44 mkoeppe]:
> Replying to [comment:42 embray]:
> > I agree that the sqlite3 CLI should not be required.  But this doesn't seem to work for me; my Ubuntu doesn't install a sqlite.pc?  Couldn't we also fall back on a AC_CHECK_LIB?
> Which Ubuntu is that?

I'm testing this on bionic (18.04).


---

Comment by embray created at 2020-01-17 16:04:40

Replying to [comment:48 embray]:
> Replying to [comment:44 mkoeppe]:
> > Replying to [comment:42 embray]:
> > > I agree that the sqlite3 CLI should not be required.  But this doesn't seem to work for me; my Ubuntu doesn't install a sqlite.pc?  Couldn't we also fall back on a AC_CHECK_LIB?
> > Which Ubuntu is that?
> 
> I'm testing this on bionic (18.04).

My bad, it turns out I didn't have libsqlite3-dev installed (thought I did).  After that I have the .pc file.  Still would be nice to have a fallback though if possible.


---

Comment by dimpase created at 2020-01-17 16:05:53

One can write an `AC_RUN_IFELSE` test that calls `sqlite3_libversion_number()`.


---

Comment by dimpase created at 2020-01-17 16:06:32

although it's probably an overkill.


---

Comment by mkoeppe created at 2020-01-17 16:09:14

Replying to [comment:47 embray]:
> What's wrong with that? 
Everything. It cannot reliably succeed to parse the correct file that would be used by the compiler.
And it did fail on macOS for exactly that reason.


---

Comment by mkoeppe created at 2020-01-17 16:09:54

Replying to [comment:50 dimpase]:
> One can write an `AC_RUN_IFELSE` test that calls `sqlite3_libversion_number()`.
That's the correct solution, I can work on this if you're not faster.


---

Comment by embray created at 2020-01-17 16:12:34

Replying to [comment:52 mkoeppe]:
> Replying to [comment:47 embray]:
> > What's wrong with that? 
> Everything. It cannot reliably succeed to parse the correct file that would be used by the compiler.
> And it did fail on macOS for exactly that reason.

Ah, of course.  My brain went completely past literally parsing the header file directly to parsing the output of a test program that prints the value of a macro sqlite3.h or something :)


---

Comment by mjo created at 2020-01-17 16:14:34

Does the MacOS version (without homebrew) also install the library and development headers? Otherwise we'd be adding a fallback for nobody.

If we wind up digging through headers and libraries anyway, the pkg-config check becomes redundant.


---

Comment by dimpase created at 2020-01-17 16:16:49

Replying to [comment:53 mkoeppe]:
> Replying to [comment:50 dimpase]:
> > One can write an `AC_RUN_IFELSE` test that calls `sqlite3_libversion_number()`.
> That's the correct solution, I can work on this if you're not faster.

please go ahead, I have to write a paper and presentations now :-)

We certainly already have examples of using `AC_RUN_IFELSE`, e.g. in
`build/pkgs/ntl/spkg-configure.m4`


---

Comment by mkoeppe created at 2020-01-17 16:21:02

Replying to [comment:55 mjo]:
> Does the MacOS version (without homebrew) also install the library and development headers? 

Yes. Part of XCode.


---

Comment by mkoeppe created at 2020-01-17 22:44:22

This now works on macOS with current XCode even if no homebrew is in PATH.
----
New commits:


---

Comment by mkoeppe created at 2020-01-17 22:44:22

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2020-01-17 22:48:19

By the way, the check using pkgconfig is a bit questionable because Python, as far as I can see, does not actually use pkgconfig to find the library, and the results obtained by `PKG_CHECK_MODULES`, the variables `SQLITE_CFLAGS` and `SQLITE_LIBS`, are not passed to Python's build system.


---

Comment by mkoeppe created at 2020-01-17 22:57:40

But that is not a problem at least on macOS with homebrew. By default it provides the pc for the system-installed library, `/usr/local/Homebrew/Library/Homebrew/os/mac/pkgconfig/10.15/sqlite3.pc`, which is 3.8.10.2. The homebrew-provided library is installed "keg-only" and informs at installation that "For pkg-config to find sqlite you may need to set:`export PKG_CONFIG_PATH="/usr/local/opt/sqlite/lib/pkgconfig"`. That provides 3.30.1.


---

Comment by dimpase created at 2020-01-17 23:27:04

why are you using sqlite3_libversion() rather than sqlite3_libversion_number() ?
the latter returns `int` you are assembling by hand from the output of sqlite3_libversion()...


---

Comment by mkoeppe created at 2020-01-17 23:35:20

No, I'm converting the required version from its components.


---

Comment by mjo created at 2020-01-18 00:37:32

Replying to [comment:60 mkoeppe]:
> By the way, the check using pkgconfig is a bit questionable because Python, as far as I can see, does not actually use pkgconfig to find the library, ...

Everything we do in these spkg-configure files is a bit questionable =)

Basically we're trying to fake the checks that already (or should already) take place in the upstream packages, but as simply and with as little code as possible. A "perfect" implementation of spkg-configure for libfoo would copy/paste every upstream check for libfoo. But that's crazy, so we try to get away with something less than perfect, but still functional. If it works in 95% of cases and is harmless in the others, that's a win.

...which brings me to your custom version check. I believe that it works, but it's way too complicated for what we need to do. Keep in mind that we don't really care about the version of sqlite3. I only bothered to check it with pkg-config because it's trivial to do with pkg-config. As far as I can tell, you can cover the known cases with a combination of `AC_CHECK_HEADER([sqlite3.h],...)` and `AC_SEARCH_LIBS([(sqlite3_libversion],[sqlite3],...)`. That's still not perfect, because it doesn't check for every function that python uses, but if it works for the people CC'ed on this ticket it will probably work for everyone.

There's no reason to keep the PKG_CHECK_MODULES around at that point. If the first test works sometimes and the second test works all the time, why try both?


---

Comment by git created at 2020-01-18 01:17:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-18 01:20:21

Thanks for the discussion. I have removed the PKG_CHECK_MODULES.

Regarding the version check, I am following the recommendations of upstream: https://www.sqlite.org/c3ref/libversion.html


---

Comment by mjo created at 2020-01-18 01:47:16

My point about the version check is that your program is currently doing four things:

  1. Ensuring that sqlite3.h is in the include path.
  2. Ensuring that the `sqlite3_libversion()` function is in the `sqlite3` library.
  3. Doing some math to see if the version of sqlite3 is newer than 3.8.7.
  4. Setting `LIBS+=" -lsqlite3"` if everything worked out, or setting `sage_spkg_install_sqlite=yes` if it didn't.

That's all good, but the third item is superfluous since we don't really care what version of sqlite3 you have (so long as it works). And if you remove the version check, then items 1, 2, and 4 can all be accomplished with AC_CHECK_HEADER and AC_SEARCH_LIBS in three or four lines.


---

Comment by mkoeppe created at 2020-01-18 02:22:23

Replying to [comment:67 mjo]:
> ... we don't really care what version of sqlite3 you have (so long as it works)

The version of sqlite3 for a python build was an issue as recently as 2017 here:
https://bugs.python.org/issue29098

I don't have time to determine a more precise bound. But we do need to check *some* lower bound for the version (or test features of sqlite3).


---

Comment by mjo created at 2020-01-18 02:41:19

Replying to [comment:68 mkoeppe]:
> Replying to [comment:67 mjo]:
> > ... we don't really care what version of sqlite3 you have (so long as it works)
> 
> The version of sqlite3 for a python build was an issue as recently as 2017 here:
> https://bugs.python.org/issue29098

They changed that code so that older versions of sqlite will work.

> I don't have time to determine a more precise bound. But we do need to check *some* lower bound for the version (or test features of sqlite3).

Why? Python itself doesn't even bother.


---

Comment by mkoeppe created at 2020-01-18 02:50:41

Replying to [comment:69 mjo]:
> Replying to [comment:68 mkoeppe]:
> > Replying to [comment:67 mjo]:
> > > ... we don't really care what version of sqlite3 you have (so long as it works)
> > 
> > The version of sqlite3 for a python build was an issue as recently as 2017 here:
> > https://bugs.python.org/issue29098
> 
> They changed that code so that older versions of sqlite will work.

Which versions do?


---

Comment by mjo created at 2020-01-18 02:54:47

Replying to [comment:70 mkoeppe]:
> > 
> > They changed that code so that older versions of sqlite will work.
> 
> Which versions do?

Python doesn't do a version check, and doesn't document any version bounds, so presumably all of them.

Put another way: if we find a version that makes it past _our_ version-less check but that breaks python... then that's a python bug.


---

Comment by mkoeppe created at 2020-01-18 02:58:49

But it is not the goal of sage-the-distribution to provoke python bugs.

We vendor a version of sqlite so that the vendored python can build.


---

Comment by mjo created at 2020-01-18 03:16:42

Replying to [comment:72 mkoeppe]:
> But it is not the goal of sage-the-distribution to provoke python bugs.
> 


You make it sound so negative =)

**If** there's a version of sqlite that doesn't work with python, and **if** someone tries to build sage with it (both unlikely), then we report the bug upstream. At that point -- depending on the upstream fix -- we either do nothing or amend this spkg-configure with a lower bound.

Otherwise, we're just making things complicated for no ostensible reason. Since nobody is going to test every 3.x version of sqlite, we're still ultimately guessing at the lower version bound. My guess just happens to be 3.0.0.

If it's wrong, we can change it, but 3.0.0 is more likely to be correct than any other untested bound, and simplifies this check as a bonus.


---

Comment by dimpase created at 2020-01-18 09:31:49

I think one reason for these checks is to make supporting sage(lib) a bearable job. We don't want to bog down in corner cases on museum-grade OSes, just cause they might carry a museum-grade version of sqlite3.

So I am for keeping a version check. 

One other thing - for better of worse, spkg-configure.m4 in other packages undefine local m4 variables they happen to define, whereas here it does not happen.
They use `m4_pushdef/m4_popdef` pair of macros for these purposes.
Can we keep to the same style here?


---

Comment by mjo created at 2020-01-18 15:40:53

Replying to [comment:74 dimpase]:
> I think one reason for these checks is to make supporting sage(lib) a bearable job. We don't want to bog down in corner cases on museum-grade OSes, just cause they might carry a museum-grade version of sqlite3.
> 
> So I am for keeping a version check. 
> 

That's a bit ironic considering that four people have wasted hours replacing


```
SAGE_SPKG_CONFIGURE([sqlite], [
  PKG_CHECK_MODULES([SQLITE],
                    [sqlite3 >= 3.8.7],
                    [],
                    [sage_spkg_install_sqlite=yes])
])
```


with


```
SAGE_SPKG_CONFIGURE([sqlite], [
  m4_define([sqlite3_min_version_major], [3])
  m4_define([sqlite3_min_version_minor], [8])
  m4_define([sqlite3_min_version_micro], [7])
  m4_define([sqlite3_min_version], [sqlite3_min_version_major.sqlite3_min_version_minor.sqlite3_min_version_micro])
  AC_MSG_CHECKING([libsqlite3 >= sqlite3_min_version])
                     dnl https://www.sqlite.org/c3ref/libversion.html
                     dnl https://www.sqlite.org/c3ref/c_source_id.html
                     SQLITE_SAVED_LIBS="$LIBS"
                     LIBS="$LIBS -lsqlite3"
                     AC_RUN_IFELSE([
                       AC_LANG_PROGRAM([[
                                         #include <sqlite3.h>
                                         #include <assert.h>
                                         #include <stdlib.h>
                                         #include <string.h>
                                       ]],
                                       [[
                                         assert( strcmp(sqlite3_libversion(),SQLITE_VERSION)==0 );
                                         if (SQLITE_VERSION_NUMBER < ]]sqlite3_min_version_major[[*1000000 + ]]sqlite3_min_version_minor[[*1000 + ]]sqlite3_min_version_micro[[)
                                           exit(1);
                                         else
                                           exit(0);
                                       ]])
                       ],
                       [AC_MSG_RESULT([yes])],
                       [AC_MSG_RESULT([no])
                        LIBS="$SQLITE_SAVED_LIBS"
                        sage_spkg_install_sqlite=yes])
])
```


to support one version of sqlite on one proprietary OS whose maintainers went out of their way to delete an important file from the package.

sagelib doesn't even use sqlite, it's a dependency of a dependency


---

Comment by mkoeppe created at 2020-01-18 18:17:56

Replying to [comment:75 mjo]:
>  considering that four people have wasted hours 

Excuse me, m4 and autotools are my hobby.


---

Comment by mkoeppe created at 2020-01-18 18:18:45

Replying to [comment:74 dimpase]:
> spkg-configure.m4 in other packages undefine local m4 variables they happen to define, whereas here it does not happen.
> They use `m4_pushdef/m4_popdef` pair of macros for these purposes.
> Can we keep to the same style here?

Good idea, will do.


---

Comment by git created at 2020-01-18 18:31:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2020-01-18 18:32:03

Ready for review.


---

Comment by dimpase created at 2020-01-19 20:40:56

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2020-01-19 20:40:56

lgtm


---

Comment by mkoeppe created at 2020-01-19 21:30:27

Thank you!


---

Comment by embray created at 2020-01-22 12:34:15

Replying to [comment:76 mkoeppe]:
> Replying to [comment:75 mjo]:
> >  considering that four people have wasted hours 
> 
> Excuse me, m4 and autotools are my hobby.

HAHA :)

I'm also +1 for keeping the version check; personally I would lower the minimum version 3.0.0 until/unless a stronger minimum is actually determined.  But 3.8.7 is still old-enough that it should be satisfied on most system so I'm okay with it.


---

Comment by mkoeppe created at 2020-01-22 15:04:11

Replying to [comment:84 embray]:
>  I would lower the minimum version 3.0.0 until/unless a stronger minimum is actually determined.  But 3.8.7 is still old-enough that it should be satisfied on most system so I'm okay with it.

3.0.0 was released in 2004. https://www.sqlite.org/chronology.html


---

Comment by vbraun created at 2020-01-22 20:43:53

Resolution: fixed


---

Comment by embray created at 2020-01-28 11:47:56

It turns out there are some tests that fail if the sqlite3 executable is not installed:


```
sage -t --long --warn-long 78.2 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 608, in sage.tests.cmdline.test_executable
Failed example:
    out.startswith("3.")
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 610, in sage.tests.cmdline.test_executable
Failed example:
    err
Expected:
    ''
Got:
    '/home/sage/sage/src/bin/sage: line 546: exec: sqlite3: not found\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 612, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    127
**********************************************************************
1 item had failures:
   3 of 236 in sage.tests.cmdline.test_executable
    [235 tests, 3 failures, 45.53 s]
----------------------------------------------------------------------
sage -t --long --warn-long 78.2 src/sage/tests/cmdline.py  # 3 doctests failed
----------------------------------------------------------------------
```


So, technically it is a regression of `sage -sqlite3` does not work.  I don't think this is very important functionality and it would probably be better if it were slowly deprecated (I think the same should be the case for most `sage -<program name>`--rather, that most of those should be undocumented, and that there should be a generic interface for running executables that might be installed in the Sage distribution).

In the meantime, I'm leaning towards we need to check for it...


---

Comment by charpent created at 2020-01-30 11:24:16

Replying to [comment:87 embray]:
> It turns out there are some tests that fail if the sqlite3 executable is not installed:

[ Snip... ]

> So, technically it is a regression of `sage -sqlite3` does not work.

Indeed. I just got bitten by this (trying to ebuild 9.1.beta2 from scratch rather than upgrading).

>  I don't think this is very important functionality and it would probably be better if it were slowly deprecated (I think the same should be the case for most `sage -<program name>`--rather, that most of those should be undocumented, and that there should be a generic interface for running executables that might be installed in the Sage distribution).

I tend to disagree : an unsuspecting user might have a hard time to understand why "our" version replaces the one he/she installed in his/her system if he/she runs out utility that installs system shortcuts for Sage-installed programs  ...

> 
> In the meantime, I'm leaning towards we need to check for it...

Indeed. But since `sqlite` is so widely used, we might alsoi depend on the relevant packages (easy for Unices, possibly not so easy for Windows (Madison ?), and possible Apple shenanigans...).

BTW, our move to reduce the size of Sage-the-distribution should reopen the question of what are our minimal dependencies. I would have no problem to depend on `sqlite`, more on `Maxima` (Lisp interpreters !) and even more on `R` (size, dependencies on OpenSSL, etc...)

Should that be disciussed on [sage-devel](https://groups.google.com/forum/#!forum/sage-devel) ?

In the meantime, should we open a new ticket ?


---

Comment by dimpase created at 2020-01-30 11:45:36

Replying to [comment:88 charpent]:
> Replying to [comment:87 embray]:
> > It turns out there are some tests that fail if the sqlite3 executable is not installed:
> 
> [ Snip... ]
> 
> > So, technically it is a regression of `sage -sqlite3` does not work.
> 
> Indeed. I just got bitten by this (trying to ebuild 9.1.beta2 from scratch rather than upgrading).
> 
> >  I don't think this is very important functionality and it would probably be better if it were slowly deprecated (I think the same should be the case for most `sage -<program name>`--rather, that most of those should be undocumented, and that there should be a generic interface for running executables that might be installed in the Sage distribution).
> 
> I tend to disagree : an unsuspecting user might have a hard time to understand why "our" version replaces the one he/she installed in his/her system if he/she runs out utility that installs system shortcuts for Sage-installed programs  ...
> 
In the long run there should be no sqlite or libsqlite bundled into Sage.


> > 
> > In the meantime, I'm leaning towards we need to check for it...
> 
> Indeed. But since `sqlite` is so widely used, we might alsoi depend on the relevant packages (easy for Unices, possibly not so easy for Windows (Madison ?), and possible Apple shenanigans...).
> 
> BTW, our move to reduce the size of Sage-the-distribution should reopen the question of what are our minimal dependencies. I would have no problem to depend on `sqlite`, more on `Maxima` (Lisp interpreters !) and even more on `R` (size, dependencies on OpenSSL, etc...)
> 
I won't worry too much about R, as it's already more or less sorted.
Maxima/ECL is harder, as it's tigher integrated into Sage, and as ECL is moving very slowly nowadays (and with significant changes to come).




> Should that be disciussed on [sage-devel](https://groups.google.com/forum/#!forum/sage-devel) ?
> 
> In the meantime, should we open a new ticket ?

yes, please, for deprecating/removing `sage -FOO` functionality for `FOO=sqlite` and other values like this, right?

>


---

Comment by mkoeppe created at 2020-01-30 16:02:21

`@`embray Thanks for spotting this and for opening the follow-up ticket:
- #29092 sqlite3 CLI executable should be checked for at configure time
I agree that this needs to be fixed.


---

Comment by mkoeppe created at 2020-01-30 16:13:34

I have opened:
- #29111 Specify a subset of sage command line options that are supported by sagelib - rather than sage-the-distribution
