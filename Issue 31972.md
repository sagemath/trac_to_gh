# Issue 31972: Allow evaluation of morphisms of affine schemes on points over different rings

Issue created by migration from https://trac.sagemath.org/ticket/32209

Original creator: pbruin

Original creation time: 2021-07-16 11:56:53

In SageMath 9.3, consider the following setting:

```
sage: S.<x,y> = AffineSpace(ZZ, 2)
sage: T.<u,v> = AffineSpace(ZZ, 2)
sage: h = T.hom([u + v, u * v], S); h
Scheme morphism:
  From: Affine Space of dimension 2 over Integer Ring
  To:   Affine Space of dimension 2 over Integer Ring
  Defn: Defined on coordinates by sending (u, v) to
        (u + v, u*v)
```

The morphism `h` cannot be evaluated on points over *F*<sub>4</sub>:

```
sage: F.<a> = GF(4)
sage: P = T(F)(1, a)
sage: h(P)
Traceback (most recent call last):
...
TypeError: not in prime subfield
sage: h.change_ring(F)(P)
Traceback (most recent call last):
...
TypeError: (1, a) fails to convert into the map's domain Affine Space of dimension 2 over Finite Field in a of size 2^2,but a `pushforward` method is not properly implemented
```

There is no error when the coordinates are in the prime field, but the coordinates of the resulting point are in *Z* instead of *F*<sub>4</sub>:

```
sage: Q = T(F)(1, 0)
sage: Q.domain()
Spectrum of Finite Field in a of size 2^2
sage: h(Q)
(1, 0)
sage: h(Q).domain()
Spectrum of Integer Ring
```




---

Comment by pbruin created at 2021-07-17 12:10:11

Changing status from new to needs_review.


---

Comment by lorenz created at 2021-08-31 08:19:22

Changing status from needs_review to needs_work.


---

Comment by lorenz created at 2021-08-31 08:19:22

With the patch, a morphism of affine schemes now happily returns values at points which clearly do not lie in its domain:


```sage
sage: S.<x,y> = AffineSpace(ZZ, 2)
sage: T.<u,v> = AffineSpace(ZZ, 2)
sage: C = Curve(x**2+y**2-1)
sage: f = C.hom([x,y],T)
sage: P = S([123,456])
sage: f.domain().defining_polynomial()(*P)
223064
sage: f(P)
(123, 456)
```


The following change should fix this according to my very limited testing. It is inspired by the projective case (which did already seem to detect points outside the domain).


```diff
--- b/src/sage/schemes/affine/affine_morphism.py
+++ b/src/sage/schemes/affine/affine_morphism.py
@@ -262,7 +262,7 @@ class SchemeMorphism_polynomial_affine_space(SchemeMorphism_polynomial):
         """
         from sage.schemes.affine.affine_point import SchemeMorphism_point_affine
         if check:
-            if not isinstance(x, SchemeMorphism_point_affine):
+            if not isinstance(x, SchemeMorphism_point_affine) or self.domain() != x.codomain():
                 try:
                     x = self.domain()(x)
                 except (TypeError, NotImplementedError):
```



---

Comment by git created at 2022-02-03 12:46:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by pbruin created at 2022-02-03 12:47:52

Changing status from needs_work to needs_review.


---

Comment by pbruin created at 2022-02-03 12:47:52

Thanks for noticing!  This looks like a good fix to me.


---

Comment by lorenz created at 2022-02-04 11:03:03

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-02-12 22:05:38

Resolution: fixed
