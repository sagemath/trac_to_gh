# Issue 31972: Allow evaluation of morphisms of affine schemes on points over different rings

archive/issues_031972.json:
```json
{
    "body": "In SageMath 9.3, consider the following setting:\n\n```\nsage: S.<x,y> = AffineSpace(ZZ, 2)\nsage: T.<u,v> = AffineSpace(ZZ, 2)\nsage: h = T.hom([u + v, u * v], S); h\nScheme morphism:\n  From: Affine Space of dimension 2 over Integer Ring\n  To:   Affine Space of dimension 2 over Integer Ring\n  Defn: Defined on coordinates by sending (u, v) to\n        (u + v, u*v)\n```\n\nThe morphism `h` cannot be evaluated on points over **F**<sub>4</sub>:\n\n```\nsage: F.<a> = GF(4)\nsage: P = T(F)(1, a)\nsage: h(P)\nTraceback (most recent call last):\n...\nTypeError: not in prime subfield\nsage: h.change_ring(F)(P)\nTraceback (most recent call last):\n...\nTypeError: (1, a) fails to convert into the map's domain Affine Space of dimension 2 over Finite Field in a of size 2^2,but a `pushforward` method is not properly implemented\n```\n\nThere is no error when the coordinates are in the prime field, but the coordinates of the resulting point are in **Z** instead of **F**<sub>4</sub>:\n\n```\nsage: Q = T(F)(1, 0)\nsage: Q.domain()\nSpectrum of Finite Field in a of size 2^2\nsage: h(Q)\n(1, 0)\nsage: h(Q).domain()\nSpectrum of Integer Ring\n```\n\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32209\n\n",
    "created_at": "2021-07-16T11:56:53Z",
    "labels": [
        "algebraic geometry",
        "major",
        "bug"
    ],
    "title": "Allow evaluation of morphisms of affine schemes on points over different rings",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/31972",
    "user": "pbruin"
}
```
In SageMath 9.3, consider the following setting:

```
sage: S.<x,y> = AffineSpace(ZZ, 2)
sage: T.<u,v> = AffineSpace(ZZ, 2)
sage: h = T.hom([u + v, u * v], S); h
Scheme morphism:
  From: Affine Space of dimension 2 over Integer Ring
  To:   Affine Space of dimension 2 over Integer Ring
  Defn: Defined on coordinates by sending (u, v) to
        (u + v, u*v)
```

The morphism `h` cannot be evaluated on points over **F**<sub>4</sub>:

```
sage: F.<a> = GF(4)
sage: P = T(F)(1, a)
sage: h(P)
Traceback (most recent call last):
...
TypeError: not in prime subfield
sage: h.change_ring(F)(P)
Traceback (most recent call last):
...
TypeError: (1, a) fails to convert into the map's domain Affine Space of dimension 2 over Finite Field in a of size 2^2,but a `pushforward` method is not properly implemented
```

There is no error when the coordinates are in the prime field, but the coordinates of the resulting point are in **Z** instead of **F**<sub>4</sub>:

```
sage: Q = T(F)(1, 0)
sage: Q.domain()
Spectrum of Finite Field in a of size 2^2
sage: h(Q)
(1, 0)
sage: h(Q).domain()
Spectrum of Integer Ring
```



Issue created by migration from https://trac.sagemath.org/ticket/32209





---

archive/issue_comments_456842.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-17T12:10:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456842",
    "user": "pbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_456843.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2021-08-31T08:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456843",
    "user": "lorenz"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_456844.json:
```json
{
    "body": "With the patch, a morphism of affine schemes now happily returns values at points which clearly do not lie in its domain:\n\n\n```sage\nsage: S.<x,y> = AffineSpace(ZZ, 2)\nsage: T.<u,v> = AffineSpace(ZZ, 2)\nsage: C = Curve(x**2+y**2-1)\nsage: f = C.hom([x,y],T)\nsage: P = S([123,456])\nsage: f.domain().defining_polynomial()(*P)\n223064\nsage: f(P)\n(123, 456)\n```\n\n\nThe following change should fix this according to my very limited testing. It is inspired by the projective case (which did already seem to detect points outside the domain).\n\n\n```diff\n--- b/src/sage/schemes/affine/affine_morphism.py\n+++ b/src/sage/schemes/affine/affine_morphism.py\n@@ -262,7 +262,7 @@ class SchemeMorphism_polynomial_affine_space(SchemeMorphism_polynomial):\n         \"\"\"\n         from sage.schemes.affine.affine_point import SchemeMorphism_point_affine\n         if check:\n-            if not isinstance(x, SchemeMorphism_point_affine):\n+            if not isinstance(x, SchemeMorphism_point_affine) or self.domain() != x.codomain():\n                 try:\n                     x = self.domain()(x)\n                 except (TypeError, NotImplementedError):\n```\n",
    "created_at": "2021-08-31T08:19:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456844",
    "user": "lorenz"
}
```

With the patch, a morphism of affine schemes now happily returns values at points which clearly do not lie in its domain:


```sage
sage: S.<x,y> = AffineSpace(ZZ, 2)
sage: T.<u,v> = AffineSpace(ZZ, 2)
sage: C = Curve(x**2+y**2-1)
sage: f = C.hom([x,y],T)
sage: P = S([123,456])
sage: f.domain().defining_polynomial()(*P)
223064
sage: f(P)
(123, 456)
```


The following change should fix this according to my very limited testing. It is inspired by the projective case (which did already seem to detect points outside the domain).


```diff
--- b/src/sage/schemes/affine/affine_morphism.py
+++ b/src/sage/schemes/affine/affine_morphism.py
@@ -262,7 +262,7 @@ class SchemeMorphism_polynomial_affine_space(SchemeMorphism_polynomial):
         """
         from sage.schemes.affine.affine_point import SchemeMorphism_point_affine
         if check:
-            if not isinstance(x, SchemeMorphism_point_affine):
+            if not isinstance(x, SchemeMorphism_point_affine) or self.domain() != x.codomain():
                 try:
                     x = self.domain()(x)
                 except (TypeError, NotImplementedError):
```




---

archive/issue_comments_456845.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2022-02-03T12:46:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456845",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_456846.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2022-02-03T12:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456846",
    "user": "pbruin"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_456847.json:
```json
{
    "body": "Thanks for noticing!  This looks like a good fix to me.",
    "created_at": "2022-02-03T12:47:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456847",
    "user": "pbruin"
}
```

Thanks for noticing!  This looks like a good fix to me.



---

archive/issue_comments_456848.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2022-02-04T11:03:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456848",
    "user": "lorenz"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_456849.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2022-02-12T22:05:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/31972",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/31972#issuecomment-456849",
    "user": "vbraun"
}
```

Resolution: fixed
