# Issue 29336: qepcad build fails on slackware-14.2-maximal

Issue created by migration from https://trac.sagemath.org/ticket/29573

Original creator: mkoeppe

Original creation time: 2020-04-25 00:01:14

CC:  dimpase


```
g++ -O3 -g -Wl,-rpath,/sage/local/lib -I/sage/local/lib/saclib/include  -I. saclib/GCSI.c saclib/FAIL.c \
  qepcad.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/sfext/sfexto.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/lift2D/lift2Do.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/newadj/newadjo.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/adj2d/adj2do.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/rend/rendo.a /sage/local/lib/saclib/lib/saclibo.a -lreadline -lrt  qepcad.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/sfext/sfexto.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/lift2D/lift2Do.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/newadj/newadjo.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/adj2d/adj2do.a /sage/local/var/tmp/sage/build/qepcad-B.1.72/src/extensions/rend/rendo.a /sage/local/lib/saclib/lib/saclibo.a -lreadline -lrt  -o qepcad
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `tgetnum'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `tgetent'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `tgetstr'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `tgoto'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `UP'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `BC'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `tputs'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `PC'
/usr/lib64/gcc/x86_64-slackware-linux/5.5.0/../../../../lib64/libreadline.so: undefined reference to `tgetflag'
collect2: error: ld returned 1 exit status
```



---

Comment by mkoeppe created at 2020-04-25 03:34:19

Looks like libreadline is underlinked on slackware

```
sh-4.3# ldd /usr/lib64/libreadline.so*
/usr/lib64/libreadline.so:
	linux-vdso.so.1 (0x00007ffc743df000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f2303446000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f2303a58000)
/usr/lib64/libreadline.so.5:
	linux-vdso.so.1 (0x00007fff86f96000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f58cbdde000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f58cc3e5000)
/usr/lib64/libreadline.so.5.2:
	linux-vdso.so.1 (0x00007ffe4a7db000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f7b24b17000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f7b2511e000)
/usr/lib64/libreadline.so.6:
	linux-vdso.so.1 (0x00007ffd00ff8000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f40c3854000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f40c3e66000)
/usr/lib64/libreadline.so.6.3:
	linux-vdso.so.1 (0x00007fffb9253000)
	libc.so.6 => /lib64/libc.so.6 (0x00007f1818931000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f1818f43000)
sh-4.3# ls /usr/lib64/libreadline.*  
/usr/lib64/libreadline.so  /usr/lib64/libreadline.so.5	/usr/lib64/libreadline.so.5.2  /usr/lib64/libreadline.so.6  /usr/lib64/libreadline.so.6.3
sh-4.3# ls -l /usr/lib64/libreadline.*
lrwxrwxrwx 1 root root     16 Apr 23 17:05 /usr/lib64/libreadline.so -> libreadline.so.6
lrwxrwxrwx 1 root root     18 Mar 29  2019 /usr/lib64/libreadline.so.5 -> libreadline.so.5.2
-rwxr-xr-x 1 root root 249328 Aug 15  2015 /usr/lib64/libreadline.so.5.2
lrwxrwxrwx 1 root root     18 Apr 23 17:05 /usr/lib64/libreadline.so.6 -> libreadline.so.6.3
-rwxr-xr-x 1 root root 291680 Nov  7  2015 /usr/lib64/libreadline.so.6.3
sh-4.3# nm -D /usr/lib64/libreadline.so.5 | grep tgetnum
                 U tgetnum
sh-4.3# nm -D /usr/lib64/libreadline.so.6 | grep tgetnum
                 U tgetnum
sh-4.3# nm -D /usr/lib64/libncurses | grep tgetnum
libncurses++.so       libncurses++.so.5     libncurses++.so.5.9   libncurses++w.so      libncurses++w.so.5    libncurses++w.so.5.9  libncurses.so         libncurses.so.5       libncursesw.so        libncursesw.so.5
sh-4.3# nm -D /usr/lib64/libncurses | grep tgetnum
libncurses++.so       libncurses++.so.5     libncurses++.so.5.9   libncurses++w.so      libncurses++w.so.5    libncurses++w.so.5.9  libncurses.so         libncurses.so.5       libncursesw.so        libncursesw.so.5
sh-4.3# nm -D /usr/lib64/libncurses.so | grep tgetnum
000000000002fe70 T tgetnum
```



---

Comment by dimpase created at 2020-04-25 04:37:55

Is there pkg-config support for readline on Slackware, and if yes, does it correctly list libs ot link against?


---

Comment by mkoeppe created at 2020-04-25 04:45:12

Neither a .pc file nor a .la file


---

Comment by dimpase created at 2020-04-25 05:16:59

OK, so this is underlinking that needs to be tested in readline's spkg-configure. And the name of the library has to be found from `ac_cv_search_wresize` set by `AC_SEARCH_LIBS` in ncurses' spkg-configure, or the result of ` pkg-config --libs ncurses` (this to be done on #29000).


---

Comment by dimpase created at 2020-04-25 05:32:33

Do we already have a ready to use docker image with Sage on Slackware, or this is still not complete?


---

Comment by mkoeppe created at 2020-04-25 05:56:18

Yes, see ticket description for the command line for pulling it!


---

Comment by dimpase created at 2020-04-25 06:14:14

$ docker run -it docker.pkg.github.com/mkoeppe/sage/sage-docker-slackware-14.2-maximal-with-targets-optional:9.1.rc0-66177-gcf8d125574
Unable to find image 'docker.pkg.github.com/mkoeppe/sage/sage-docker-slackware-14.2-maximal-with-targets-optional:9.1.rc0-66177-gcf8d125574' locally
docker: Error response from daemon: Get https://docker.pkg.github.com/v2/mkoeppe/sage/sage-docker-slackware-14.2-maximal-with-targets-optional/manifests/9.1.rc0-66177-gcf8d125574: no basic auth credentials.


---

Comment by mkoeppe created at 2020-04-25 06:15:33

From the doc added:

```
+The ``docker`` workflows automatically push images to
+``docker.pkg.github.com``.  You find them in the Packages tab of your
+GitHub repository.
+
+In order to pull them for use on your computer, you need to first
+visit https://github.com/settings/tokens/new to generate a Personal
+Access Token providing the ``read:packages`` scope.  Then log in using
+your GitHub user name and the Personal Access Token::
+
+  $ docker login docker.pkg.github.com
+
+Now you can pull the image and run it::
+
+  $ docker pull docker.pkg.github.com/mkoeppe/sage/sage-docker-fedora-31-standard-configured:f4bd671
+  $ docker run -it docker.pkg.github.com/mkoeppe/sage/sage-docker-fedora-31-standard-configured:f4bd671 bash
```



---

Comment by mkoeppe created at 2020-04-25 06:16:46

(from #29530)


---

Comment by dimpase created at 2020-04-25 06:41:27

No idea what to do with that GH token, it's not clear where is has to go, whether one need an external helper to deal with credential store etc. A bloody mess...

Could it be that you have not authorised 3rd parties to pull that image?


---

Comment by dimpase created at 2020-04-25 06:47:28

I can log in to docker with my login and password. I have no idea what "log in using
your [GitHub](GitHub) user name and the Personal Access Token" entails. That token has to go somewhere, but where?


---

Comment by mkoeppe created at 2020-04-25 06:48:01

I used `docker login docker.pkg.github.com --username mkoeppe --password-stdin`


---

Comment by mkoeppe created at 2020-04-25 06:49:32

Replying to [comment:12 dimpase]:
> Could it be that you have not authorised 3rd parties to pull that image?

No, I think this is public


---

Comment by dimpase created at 2020-04-25 07:00:22


```
dimpase@penguin:~/sage$ docker login docker.pkg.github.com
Authenticating with existing credentials...
WARNING! Your password will be stored unencrypted in /home/dimpase/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
dimpase@penguin:~/sage$ docker pull docker.pkg.github.com/mkoeppe/sage/sage-docker-slackware-14.2-maximal-with-targets-optional:9.1.rc0-66177-gcf8d125574
Error response from daemon: unauthorized: Your request could not be authenticated by the GitHub Packages service. Please ensure your access token is valid and has the appropriate scopes configured.
```



---

Comment by mkoeppe created at 2020-04-25 07:01:37

And your "existing credentials" are the new Personal Access Token?


---

Comment by mkoeppe created at 2020-04-25 07:02:46

Otherwise please try again with `docker login docker.pkg.github.com --username dimpase --password-stdin` and paste your PAT


---

Comment by dimpase created at 2020-04-25 07:05:54

Replying to [comment:18 mkoeppe]:
> Otherwise please try again with `docker login docker.pkg.github.com --username dimpase --password-stdin` and paste your PAT

they are not new, but I don't get the logic of getting a new PAT, the relationship between GH and docker is totally opaque....


---

Comment by mkoeppe created at 2020-04-25 07:07:15

github is running its own docker registry, which I use here instead of DockerHub


---

Comment by mkoeppe created at 2020-04-25 07:08:16

I don't get either why authentication is necessary to access a public resource, but that's a fact


---

Comment by dimpase created at 2020-04-25 07:36:43


```
$ docker login docker.pkg.github.com
username: dimpase
password: <pasted PAT>

...
Login Succeeded
$ docker pull docker.pkg.github.com/mkoeppe/sage/sage-docker-slackware-14.2-maximal-with-targets-optional:9.1.rc0-66177-gcf8d125574
Error response from daemon: unauthorized: Your token has not been granted the required scopes to execute this query. The 'name' field requires one of the following scopes: ['read:packages'], but your token has only been granted the: [''] scopes. Please modify your token's scopes at: https://github.com/settings/tokens.
```



---

Comment by dimpase created at 2020-04-25 07:38:12

By the way, `docker login docker.pkg.github.com` with `--username` etc never gave me a prompt. (This is on Debian buster).


---

Comment by dimpase created at 2020-04-25 07:42:05

Please add something about the need to `Select scopes` (and the correct ones) while creating/updating GH PAT. (We're reviewing #29530 here :-))

after this change, I am able to `docker pull`, at least.


---

Comment by mkoeppe created at 2020-04-25 15:36:16

So you succeeded after selecting the scopre `read:packages`? Or something else?


---

Comment by dimpase created at 2020-04-25 16:50:57

Yes, I was able to pull and run the container.


---

Comment by mkoeppe created at 2020-04-25 17:20:56

OK great, I'll extend the documentation of #29530


---

Comment by mkoeppe created at 2020-04-25 17:48:00

Done, please review


---

Comment by dimpase created at 2020-05-02 14:08:23

Replying to [comment:3 mkoeppe]:
> Looks like libreadline is underlinked on slackware
> {{{
> sh-4.3# ldd /usr/lib64/libreadline.so*
> /usr/lib64/libreadline.so:
> 	linux-vdso.so.1 (0x00007ffc743df000)
> 	libc.so.6 => /lib64/libc.so.6 (0x00007f2303446000)
> 	/lib64/ld-linux-x86-64.so.2 (0x00007f2303a58000)
> /usr/lib64/libreadline.so.5:
> 	linux-vdso.so.1 (0x00007fff86f96000)
> 	libc.so.6 => /lib64/libc.so.6 (0x00007f58cbdde000)
> 	/lib64/ld-linux-x86-64.so.2 (0x00007f58cc3e5000)
> /usr/lib64/libreadline.so.5.2:
> 	linux-vdso.so.1 (0x00007ffe4a7db000)
> 	libc.so.6 => /lib64/libc.so.6 (0x00007f7b24b17000)
> 	/lib64/ld-linux-x86-64.so.2 (0x00007f7b2511e000)
> /usr/lib64/libreadline.so.6:
> 	linux-vdso.so.1 (0x00007ffd00ff8000)
> 	libc.so.6 => /lib64/libc.so.6 (0x00007f40c3854000)
> 	/lib64/ld-linux-x86-64.so.2 (0x00007f40c3e66000)
> /usr/lib64/libreadline.so.6.3:
> 	linux-vdso.so.1 (0x00007fffb9253000)
> 	libc.so.6 => /lib64/libc.so.6 (0x00007f1818931000)
> 	/lib64/ld-linux-x86-64.so.2 (0x00007f1818f43000)
> sh-4.3# ls /usr/lib64/libreadline.*  
> /usr/lib64/libreadline.so  /usr/lib64/libreadline.so.5	/usr/lib64/libreadline.so.5.2  /usr/lib64/libreadline.so.6  /usr/lib64/libreadline.so.6.3
> sh-4.3# ls -l /usr/lib64/libreadline.*
> lrwxrwxrwx 1 root root     16 Apr 23 17:05 /usr/lib64/libreadline.so -> libreadline.so.6
> lrwxrwxrwx 1 root root     18 Mar 29  2019 /usr/lib64/libreadline.so.5 -> libreadline.so.5.2
> -rwxr-xr-x 1 root root 249328 Aug 15  2015 /usr/lib64/libreadline.so.5.2
> lrwxrwxrwx 1 root root     18 Apr 23 17:05 /usr/lib64/libreadline.so.6 -> libreadline.so.6.3
> -rwxr-xr-x 1 root root 291680 Nov  7  2015 /usr/lib64/libreadline.so.6.3
> sh-4.3# nm -D /usr/lib64/libreadline.so.5 | grep tgetnum
>                  U tgetnum
> sh-4.3# nm -D /usr/lib64/libreadline.so.6 | grep tgetnum
>                  U tgetnum
> sh-4.3# nm -D /usr/lib64/libncurses | grep tgetnum
> libncurses++.so       libncurses++.so.5     libncurses++.so.5.9   libncurses++w.so      libncurses++w.so.5    libncurses++w.so.5.9  libncurses.so         libncurses.so.5       libncursesw.so        libncursesw.so.5
> sh-4.3# nm -D /usr/lib64/libncurses | grep tgetnum
> libncurses++.so       libncurses++.so.5     libncurses++.so.5.9   libncurses++w.so      libncurses++w.so.5    libncurses++w.so.5.9  libncurses.so         libncurses.so.5       libncursesw.so        libncursesw.so.5
> sh-4.3# nm -D /usr/lib64/libncurses.so | grep tgetnum
> 000000000002fe70 T tgetnum
> }}}

how about readline 8, as in https://mirrors.slackware.com/slackware/slackware-current/source/l/readline/

Note that it is supposed to link with ltinfo, cf
https://mirror.bytemark.co.uk/slackware/slackware-current/source/l/readline/readline.SlackBuild


---

Comment by dimpase created at 2020-05-02 14:10:39

As a fixup, we can remove

build/pkgs/readline/distros/slackware.txt


---

Comment by dimpase created at 2020-05-02 18:44:52

or we can add a check that system readline is not underlinked.


---

Comment by dimpase created at 2020-05-03 18:45:54

Replying to [comment:31 dimpase]:
> or we can add a check that system readline is not underlinked.

I tried this with AC_SEARCH_LIBS, but I'm getting

```
configure:16165: checking for library containing tgetnum
configure:16196: gcc -o conftest -g -O2    conftest.c -lreadline -lcurl -lcliquer -lbz2 -lflint -l
mpfr -lgmp -lm  -lntl >&5
/usr/bin/ld: /tmp/ccm3Jhhm.o: undefined reference to symbol 'tgetnum@@NCURSES6_TINFO_5.0.19991023'
/usr/bin/ld: //lib/x86_64-linux-gnu/libtinfo.so.6: error adding symbols: DSO missing from command 
line
```


not sure what this is.


---

Comment by mkoeppe created at 2020-05-03 18:54:31

Try adding -ltinfo?


---

Comment by dimpase created at 2020-05-03 19:14:16

but this is meant to **test** whether libreadline is linked with libtinfo...


---

Comment by mkoeppe created at 2020-05-04 03:02:59

Don't you just need to test whether linking a test program with `-lreadline` works, and whether linking it with `-lreadline -ltinfo` works?


---

Comment by dimpase created at 2020-05-04 05:59:23

Replying to [comment:35 mkoeppe]:
> Don't you just need to test whether linking a test program with `-lreadline` works, 

but this succeeds on slackware - after all this is what AC_SEARCH_LIBS is doing.

Perhaps the test already has tinfo in LIBS?


> and whether linking it with `-lreadline -ltinfo` works?


---

Comment by mkoeppe created at 2020-05-05 17:44:06

Are you still working on this?


---

Comment by mkoeppe created at 2021-03-24 02:04:25

Sage development has entered the release candidate phase for 9.3. Setting a new milestone for this ticket based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2022-08-01 20:32:16

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2022-08-01 20:32:16

We no longer support this platform, should close


---

Comment by slelievre created at 2022-08-25 16:51:19

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-09-01 02:30:35

Resolution: invalid
