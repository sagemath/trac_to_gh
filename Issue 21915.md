# Issue 21915: speed up generic polynomials a little

Issue created by migration from https://trac.sagemath.org/ticket/22152

Original creator: mmezzarobba

Original creation time: 2017-01-08 10:21:24

CC:  cremona nbruin simonking

Before:

```
sage: sage: QQi.<i> = QuadraticField(-1)
....: sage: Pol.<x> = QQi[]
....: sage: pol = x + i + 1
sage: %timeit pol*pol
The slowest run took 26.56 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 12.7 µs per loop
sage: %timeit pol**5
10000 loops, best of 3: 55.1 µs per loop
sage: %timeit pol._mul_trunc_(pol, 3)
The slowest run took 7.09 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 14.7 µs per loop
```

After:

```
sage: sage: QQi.<i> = QuadraticField(-1)
....: sage: Pol.<x> = QQi[]
....: sage: pol = x + i + 1
sage: %timeit pol*pol
The slowest run took 8.00 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 8.14 µs per loop
sage: %timeit pol**5
10000 loops, best of 3: 34.3 µs per loop
sage: %timeit pol._mul_trunc_(pol, 3)
The slowest run took 8.56 times longer than the fastest. This could mean that an intermediate result is being cached.
100000 loops, best of 3: 6.88 µs per loop
```



---

Comment by mmezzarobba created at 2017-01-08 14:09:27

Changing status from new to needs_review.


---

Comment by git created at 2017-01-11 15:38:27

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mmezzarobba created at 2017-01-11 15:47:29

The tests in `rings/` pass; I haven't yet run the whole test suite.


---

Comment by git created at 2017-01-11 15:55:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-01-11 18:07:49

Looks good overall. From a quick look through the code, it seems like the inputs to the `do_*` methods always take lists as inputs. Likewise, should we make `list` a `cpdef` method that guarantees a list being returned? This might get us some extra speed as well.


---

Comment by mmezzarobba created at 2017-01-11 20:24:39

Replying to [comment:5 tscrim]:
> Looks good overall. From a quick look through the code, it seems like the inputs to the `do_*` methods always take lists as inputs. Likewise, should we make `list` a `cpdef` method that guarantees a list being returned? This might get us some extra speed as well.

Thanks for the suggestion. Adding type annotations to `do_*` and brutally replacing `def list(...)` by `cdef list list(...)` everywhere actually seems to make things slower, though the difference is small. I didn't try to investigate any further. And I must confess that it is not at all clear to me what implications those `cdef` have with the relatively complex hierarchy of subclasses that override `list()` (sometimes from Cython, sometimes from Python, sometimes with additional arguments).


---

Comment by tscrim created at 2017-01-11 21:30:42

You might be loosing some speed by variables not being cdef'ed as a list. Did you happen to save your current branch? I can play around with it later tonight to see if I can get some extra speed out of it.


---

Comment by mmezzarobba created at 2017-01-12 08:43:38

I noticed a small problem with the last commit: it would cause terrible regression for cases like polynomials over large matrix spaces evaluated at scalars. I'll push a fix in a minute.

Replying to [comment:7 tscrim]:
> You might be loosing some speed by variables not being cdef'ed as a list. Did you happen to save your current branch?

Yes, see `u/mmezzarobba/speed_up_generic_polynomials-alt`.


---

Comment by git created at 2017-01-12 08:43:48

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by tscrim created at 2017-01-12 21:45:10

I went through and made all of the `def list(self)` methods into `cpdef list list(self, bint copy=True)` to take advantage of the times when we don't have to copy the list and to specify the output type. This didn't give as much of a speed bump as I was expecting. I also made some other improvements by using `get_unsafe` and other things. Here are my timings:

Current branch:

```
625 loops, best of 3: 6.68 µs per loop
625 loops, best of 3: 29.2 µs per loop
625 loops, best of 3: 6.77 µs per loop
625 loops, best of 3: 739 ns per loop
625 loops, best of 3: 699 ns per loop
625 loops, best of 3: 3.3 µs per loop
625 loops, best of 3: 2.23 µs per loop
625 loops, best of 3: 10.4 µs per loop
125 loops, best of 3: 7.11 ms per loop
125 loops, best of 3: 7.1 ms per loop
625 loops, best of 3: 13.2 µs per loop
625 loops, best of 3: 247 µs per loop
625 loops, best of 3: 46.7 µs per loop
```

vs my new branch

```
625 loops, best of 3: 6.5 µs per loop
625 loops, best of 3: 28.6 µs per loop
625 loops, best of 3: 6.64 µs per loop
625 loops, best of 3: 739 ns per loop
625 loops, best of 3: 737 ns per loop
625 loops, best of 3: 3.13 µs per loop
625 loops, best of 3: 2.19 µs per loop
625 loops, best of 3: 10.6 µs per loop
125 loops, best of 3: 6.88 ms per loop
125 loops, best of 3: 6.84 ms per loop
625 loops, best of 3: 13.4 µs per loop
625 loops, best of 3: 240 µs per loop
625 loops, best of 3: 44.4 µs per loop
```


The small timings have too much variation to say there is a definitive regression. However, the arithmetic operations have improved.

Something else I noticed that probably could get us some speed is requiring _all_ polynomials to have a `_new_constant_poly`. Currently only the dense ones have such a method. Shall we do that here?
----
New commits:


---

Comment by mmezzarobba created at 2017-01-13 11:06:37

Thanks for the improvements! I cleaned up the branch a little (rebased, squashed my "wip" commit into the following one) without changing the code.

Regarding `_new_constant_poly()` for sparse polynomials: I really don't think I'll have time to make further changes until Feb. 8 at best, though I'll do my best to review yours if you make some. In any case I'm happy with the current branch; you can set the ticket to positive review if you agree, assuming the patchbot doesn't find anything to complain about.
----
New commits:


---

Comment by tscrim created at 2017-01-13 19:14:54

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2017-01-13 19:14:54

Let's get this into Sage now and do further optimizations on a followup ticket.


---

Comment by vbraun created at 2017-01-21 17:59:14

Merge conflict...


---

Comment by vbraun created at 2017-01-21 17:59:14

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-01-21 19:24:45

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-21 19:27:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2017-01-22 10:25:13

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2017-01-22 10:28:09

Rebased.


---

Comment by mmezzarobba created at 2017-01-22 10:28:09

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2017-01-23 23:05:49

merge conflict...


---

Comment by vbraun created at 2017-01-23 23:05:49

Changing status from positive_review to needs_work.


---

Comment by mmezzarobba created at 2017-01-25 08:46:42

Replying to [comment:20 vbraun]:
> merge conflict...

Again? With which branch? This ticket's branch (as of `c4b9000`) is based on the current `trac:develop`.


---

Comment by git created at 2017-01-26 13:17:57

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mmezzarobba created at 2017-01-26 13:18:26

Rebased again, on top of 7.6.beta1.


---

Comment by mmezzarobba created at 2017-01-26 13:18:26

Changing status from needs_work to positive_review.


---

Comment by tscrim created at 2017-01-28 17:39:10

I am getting the same doctest failure as the patchbot:

```
sage -t --long src/sage/schemes/elliptic_curves/padics.py
**********************************************************************
File "src/sage/schemes/elliptic_curves/padics.py", line 1058, in sage.schemes.elliptic_curves.padics.padic_sigma
Failed example:
    for N in range(3, max_N):                     # long time
       sigma = E.padic_sigma(p, N, E2=E2)         # long time
       assert sigma == max_sigma
Exception raised:
    Traceback (most recent call last):
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 498, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/travis/sage-build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 861, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.schemes.elliptic_curves.padics.padic_sigma[19]>", line 3, in <module>
        assert sigma == max_sigma
    AssertionError
**********************************************************************
1 item had failures:
   1 of  21 in sage.schemes.elliptic_curves.padics.padic_sigma
    [197 tests, 1 failure, 11.79 s]
----------------------------------------------------------------------
sage -t --long src/sage/schemes/elliptic_curves/padics.py  # 1 doctest failed
----------------------------------------------------------------------
```

I almost certainly did something wrong with my round of improvements. This will require some digging.


---

Comment by tscrim created at 2017-01-28 17:39:10

Changing status from positive_review to needs_work.


---

Comment by tscrim created at 2017-01-28 22:46:02

This was introduced by me in [3532b34](https://git.sagemath.org/sage.git/commit/?id=3532b340bff5061b0262ae84953c51b5406d8a2a). Now to figure out exactly what the problem is...


---

Comment by tscrim created at 2017-01-28 23:10:31

Okay, so the problem was in the change I made to the `__iter__` in that iterating over the list is not the same as iterating up to the degree. I don't understand why this results in different behavior. However, for now, I think we can just let it be.
----
New commits:


---

Comment by tscrim created at 2017-01-28 23:10:31

Changing status from needs_work to needs_review.


---

Comment by mmezzarobba created at 2017-01-29 10:25:59

Replying to [comment:26 tscrim]:
> Okay, so the problem was in the change I made to the `__iter__` in that iterating over the list is not the same as iterating up to the degree. I don't understand why this results in different behavior.

Since the failure has to do with p-adics, I suspect the reason may be that:

```
sage: Pol.<x> = Qp(5)[]
sage: pol = 1 + O(5)*x
sage: pol.degree()
0
sage: list(pol)
[1 + O(5^20), O(5)]
```

I don't know if this is intentional, nor why the implementation of p-adics take this convention. (I'd have expected `degree()` to check that the coefficients are nonzero using `__nonzero__()`, and `__nonzero__()` to return true except when its argument is _exactly_ zero, like it does for some other inexact parents.) But perhaps we need to check that our other changes don't break things like this.


---

Comment by tscrim created at 2017-01-29 14:25:04

I don't think we made any other functional changes as `get_unsafe` has to be consistent with `__getitem__` (for non-slices). Everything else is extending current behavior or passing type info to Cython.

I'm not sure if that is intentional either. We might need to ask someone more familiar with the p-adics. Although that could be something we push to another ticket too.


---

Comment by mmezzarobba created at 2017-01-31 19:19:42

Changing status from needs_review to positive_review.


---

Comment by mmezzarobba created at 2017-01-31 19:19:42

Agreed.


---

Comment by vbraun created at 2017-02-02 22:09:28

Resolution: fixed


---

Comment by mmezzarobba created at 2017-02-06 14:37:01

Looks like we have another problem:

```
sage: Pol = ZZ['x']['y']['z']
....: d = Pol.gens_dict_recursive()
....: x, y, z = d['x'], d['y'], d['z']
....: v = QQ(0)
....: (x*z)(x=v)
<BOOM>
```



---

Comment by tscrim created at 2017-02-06 15:12:50

This is something very special about it being 0 with the coercion.


---

Comment by tscrim created at 2017-02-06 15:15:58

This also works for `p = x*z`:

```
sage: p(1)(x=v)
0
```



---

Comment by tscrim created at 2017-02-06 15:50:29

Followup on #22317.
