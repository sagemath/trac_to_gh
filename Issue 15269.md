# Issue 15269: Fix another "recursion depth exceeded" in memory deallocation for weak dictionaries

archive/issues_015269.json:
```json
{
    "body": "CC:  sage-combinat @vbraun @jdemeyer simonking\n\nSee: http://trac.sagemath.org/ticket/10963?replyto=174#comment:159 and follow up for details\n\nThis is a follow up to #13394 #15069, and a blocker for #10963.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/15506\n\n",
    "created_at": "2013-12-10T06:27:39Z",
    "labels": [
        "performance",
        "blocker",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.1",
    "title": "Fix another \"recursion depth exceeded\" in memory deallocation for weak dictionaries",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15269",
    "user": "@nthiery"
}
```
CC:  sage-combinat @vbraun @jdemeyer simonking

See: http://trac.sagemath.org/ticket/10963?replyto=174#comment:159 and follow up for details

This is a follow up to #13394 #15069, and a blocker for #10963.


Issue created by migration from https://trac.sagemath.org/ticket/15506





---

archive/issue_comments_196309.json:
```json
{
    "body": "This should do the trick for `WeakValueDictionary`. Merge #15367 to get the same benefit for `MonoDict` and `TripleDict`.\n\nCode that verifies the problem has been solved:\n\n```\nsage: class A: pass\nsage: from sage.misc.weak_dict import WeakValueDictionary\nsage: a=A(); prev=a;\nsage: M=WeakValueDictionary()\nsage: for i in range(10^3+10): newA = A(); M[newA] = prev; prev = newA\nsage: del a\n```\n\nThis used to fail, but with the code on this branch it works.\n----\nNew commits:",
    "created_at": "2013-12-10T08:10:59Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196309",
    "user": "@nbruin"
}
```

This should do the trick for `WeakValueDictionary`. Merge #15367 to get the same benefit for `MonoDict` and `TripleDict`.

Code that verifies the problem has been solved:

```
sage: class A: pass
sage: from sage.misc.weak_dict import WeakValueDictionary
sage: a=A(); prev=a;
sage: M=WeakValueDictionary()
sage: for i in range(10^3+10): newA = A(); M[newA] = prev; prev = newA
sage: del a
```

This used to fail, but with the code on this branch it works.
----
New commits:



---

archive/issue_comments_196310.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2013-12-10T08:21:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196310",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_196311.json:
```json
{
    "body": "Oops... while we're at it, we should merge #15432 as well. Do I need to merge #15367 into this branch as well or do we leave that separate?",
    "created_at": "2013-12-10T08:24:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196311",
    "user": "@nbruin"
}
```

Oops... while we're at it, we should merge #15432 as well. Do I need to merge #15367 into this branch as well or do we leave that separate?



---

archive/issue_comments_196312.json:
```json
{
    "body": "That was quick :-) Thank you Nils!\n\nIs there a reason for not putting the above code that verifies the solution as a doctest?\n\nOther than that, what shall we do? Backport this ticket and its dependencies to mercurial, or move #10963 to git?",
    "created_at": "2013-12-10T08:29:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196312",
    "user": "@nthiery"
}
```

That was quick :-) Thank you Nils!

Is there a reason for not putting the above code that verifies the solution as a doctest?

Other than that, what shall we do? Backport this ticket and its dependencies to mercurial, or move #10963 to git?



---

archive/issue_comments_196313.json:
```json
{
    "body": "Replying to [comment:5 nthiery]:\n> Is there a reason for not putting the above code that verifies the solution as a doctest?\nNo, if you want to add a doctest, go ahead.\n> Backport this ticket and its dependencies to mercurial, or move #10963 to git?\nI have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.",
    "created_at": "2013-12-10T08:34:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196313",
    "user": "@nbruin"
}
```

Replying to [comment:5 nthiery]:
> Is there a reason for not putting the above code that verifies the solution as a doctest?
No, if you want to add a doctest, go ahead.
> Backport this ticket and its dependencies to mercurial, or move #10963 to git?
I have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.



---

archive/issue_comments_196314.json:
```json
{
    "body": "Replying to [comment:6 nbruin]:\n> Replying to [comment:5 nthiery]:\n> > Is there a reason for not putting the above code that verifies the solution as a doctest?\n> No, if you want to add a doctest, go ahead.\n\n\n> > Backport this ticket and its dependencies to mercurial, or move #10963 to git?\n> I have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.\n\nI am fine with both, as long as it goes quickly. Volker, Jeroen, what do you think from a release management point of view?",
    "created_at": "2013-12-10T08:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196314",
    "user": "@nthiery"
}
```

Replying to [comment:6 nbruin]:
> Replying to [comment:5 nthiery]:
> > Is there a reason for not putting the above code that verifies the solution as a doctest?
> No, if you want to add a doctest, go ahead.


> > Backport this ticket and its dependencies to mercurial, or move #10963 to git?
> I have no preference. Given that you'd have to backport #15367 as well, I think you'd better bite the bullet and go with git.

I am fine with both, as long as it goes quickly. Volker, Jeroen, what do you think from a release management point of view?



---

archive/issue_comments_196315.json:
```json
{
    "body": "I don't see a good reason to force this ticket in Sage 5.13. So it should not be a blocker and should be postponed to Sage 6.0 which means git.",
    "created_at": "2013-12-10T08:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196315",
    "user": "@jdemeyer"
}
```

I don't see a good reason to force this ticket in Sage 5.13. So it should not be a blocker and should be postponed to Sage 6.0 which means git.



---

archive/issue_comments_196316.json:
```json
{
    "body": "Changing priority from blocker to major.",
    "created_at": "2013-12-10T08:46:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196316",
    "user": "@jdemeyer"
}
```

Changing priority from blocker to major.



---

archive/issue_comments_196317.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2013-12-16T23:13:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196317",
    "user": "@nbruin"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_196318.json:
```json
{
    "body": "can we get this reviewed? ;-)",
    "created_at": "2013-12-17T20:17:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196318",
    "user": "@vbraun"
}
```

can we get this reviewed? ;-)



---

archive/issue_comments_196319.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> can we get this reviewed? ;-)\n\nI suppose this is independent of the patch:\n\n```\nFile \"src/sage/dev/sagedev.py\", line 89, in sage.dev.sagedev.SageDev\nFailed example:\n    dev._sagedev\nException raised:\n    Traceback (most recent call last):\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 480, in _run\n        self.execute(example, compiled, test.globs)\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 839, in execute\n        exec compiled in globs\n      File \"<doctest sage.dev.sagedev.SageDev[0]>\", line 1, in <module>\n        dev._sagedev\n      File \"lazy_import.pyx\", line 312, in sage.misc.lazy_import.LazyImport.__getattr__ (sage/misc/lazy_import.c:2402)\n      File \"lazy_import.pyx\", line 248, in sage.misc.lazy_import.LazyImport._get_object (sage/misc/lazy_import.c:1885)\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev_wrapper.py\", line 250, in <module>\n        dev = SageDevWrapper(SageDev())\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev.py\", line 171, in __init__\n        self.__branch_to_ticket = SavingDict(ticket_file)\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py\", line 116, in __init__\n        self._write()\n      File \"/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py\", line 236, in _write\n        assert os.path.abspath(self._filename).startswith(SAGE_TMP), error\n    AssertionError: write attempt to a saving_dict in a doctest\n```\n",
    "created_at": "2013-12-17T20:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196319",
    "user": "@simon-king-jena"
}
```

Replying to [comment:12 vbraun]:
> can we get this reviewed? ;-)

I suppose this is independent of the patch:

```
File "src/sage/dev/sagedev.py", line 89, in sage.dev.sagedev.SageDev
Failed example:
    dev._sagedev
Exception raised:
    Traceback (most recent call last):
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.execute(example, compiled, test.globs)
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 839, in execute
        exec compiled in globs
      File "<doctest sage.dev.sagedev.SageDev[0]>", line 1, in <module>
        dev._sagedev
      File "lazy_import.pyx", line 312, in sage.misc.lazy_import.LazyImport.__getattr__ (sage/misc/lazy_import.c:2402)
      File "lazy_import.pyx", line 248, in sage.misc.lazy_import.LazyImport._get_object (sage/misc/lazy_import.c:1885)
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev_wrapper.py", line 250, in <module>
        dev = SageDevWrapper(SageDev())
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/sagedev.py", line 171, in __init__
        self.__branch_to_ticket = SavingDict(ticket_file)
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py", line 116, in __init__
        self._write()
      File "/tmp/tmpo1ll9a-sage-git-temp-15506/local/lib/python2.7/site-packages/sage/dev/saving_dict.py", line 236, in _write
        assert os.path.abspath(self._filename).startswith(SAGE_TMP), error
    AssertionError: write attempt to a saving_dict in a doctest
```




---

archive/issue_comments_196320.json:
```json
{
    "body": "Is it really needed to additionally import this during startup:\n\n```\n+New:\n+    sage.combinat.binary_recurrence_sequences\n+    sage.libs.pari.handle_error\n+    sage.misc.weak_dict\n```\n\nI am particularly talking about binary recurrence sequences.",
    "created_at": "2013-12-17T20:23:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196320",
    "user": "@simon-king-jena"
}
```

Is it really needed to additionally import this during startup:

```
+New:
+    sage.combinat.binary_recurrence_sequences
+    sage.libs.pari.handle_error
+    sage.misc.weak_dict
```

I am particularly talking about binary recurrence sequences.



---

archive/issue_comments_196321.json:
```json
{
    "body": "Has this really been introduced by this branch:\n\n```\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:37 +    sage: R100 = RealField(100) # pr\u00c3\u00a9cision : 100 bits.$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:43 +    sage: Rdefaut = RealField()  # pr\u00c3\u00a9cision par d\u00c3\u00a9faut de 53 bits$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:64 +    sage: x = 1.0         # x appartient \u00c3  RealField()$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:65 +    sage: x = 0.1e+1      # idem : x appartient \u00c3  RealField()$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:67 +    sage: x = RDF(1)      # x est un flottant double pr\u00c3\u00a9cision machine$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:68 +    sage: x = RDF(1.)     # idem : x est un flottant double pr\u00c3\u00a9cision$\n    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:72 +    sage: x = R(1)        # x est un flottant de pr\u00c3\u00a9cision 20 bits$\n```\n\nOr is this from #14320?",
    "created_at": "2013-12-17T20:25:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196321",
    "user": "@simon-king-jena"
}
```

Has this really been introduced by this branch:

```
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:37 +    sage: R100 = RealField(100) # prÃ©cision : 100 bits.$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:43 +    sage: Rdefaut = RealField()  # prÃ©cision par dÃ©faut de 53 bits$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:64 +    sage: x = 1.0         # x appartient Ã  RealField()$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:65 +    sage: x = 0.1e+1      # idem : x appartient Ã  RealField()$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:67 +    sage: x = RDF(1)      # x est un flottant double prÃ©cision machine$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:68 +    sage: x = RDF(1.)     # idem : x est un flottant double prÃ©cision$
    0015-Trac-14320-More-doctests-from-the-book-Calcul-math-m.patch:72 +    sage: x = R(1)        # x est un flottant de prÃ©cision 20 bits$
```

Or is this from #14320?



---

archive/issue_comments_196322.json:
```json
{
    "body": "Concerning additional imports and Calcul-math things:\n\nNone of that is directly effected by commits on this ticket, so it has to from the state of \"master\" on which this branch is based.\n\nThis ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)",
    "created_at": "2013-12-17T21:07:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196322",
    "user": "@nbruin"
}
```

Concerning additional imports and Calcul-math things:

None of that is directly effected by commits on this ticket, so it has to from the state of "master" on which this branch is based.

This ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)



---

archive/issue_comments_196323.json:
```json
{
    "body": "Replying to [comment:16 nbruin]:\n> Concerning additional imports and Calcul-math things:\n> \n> None of that is directly effected by commits on this ticket, so it has to from the state of \"master\" on which this branch is based.\n\nOK, so, it is a bug in the plugins.\n\n> This ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)\n\nAnd now I am really confused.\n\nIn #15432, you introduce a weak reference from the callback to the weak value dictionary. Namely, on #15432, you point out that when passing the weak value dictionary to the callback via a closure then there are examples requiring many garbage collections to clear a weak value dictionary.\n\nNow, you revert this change. Can you explain why you did so? Doesn't this re-introduce the problem that you fixed in #15432? If not: Why not? And why did you merge #15432 into this branch? What is left from #15432 in the HEAD of this branch?",
    "created_at": "2013-12-18T16:51:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196323",
    "user": "@simon-king-jena"
}
```

Replying to [comment:16 nbruin]:
> Concerning additional imports and Calcul-math things:
> 
> None of that is directly effected by commits on this ticket, so it has to from the state of "master" on which this branch is based.

OK, so, it is a bug in the plugins.

> This ticket is only meant to change `weak_dict.pyx` and does not introduce any import statements there. Feel free to use the commits here to build a new branch based on a different tree if there are things in the way (note that #15432 has been merged in the branch here; without it there's only one commit here)

And now I am really confused.

In #15432, you introduce a weak reference from the callback to the weak value dictionary. Namely, on #15432, you point out that when passing the weak value dictionary to the callback via a closure then there are examples requiring many garbage collections to clear a weak value dictionary.

Now, you revert this change. Can you explain why you did so? Doesn't this re-introduce the problem that you fixed in #15432? If not: Why not? And why did you merge #15432 into this branch? What is left from #15432 in the HEAD of this branch?



---

archive/issue_comments_196324.json:
```json
{
    "body": "Hm. I just tested that the problematic behaviour (namely: Numerous garbage collection cycles required to clear the dict) does not occur with your branch. Could it perhaps be the case that I was (again) reading in a wrong way the diff shown by trac?",
    "created_at": "2013-12-18T16:56:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196324",
    "user": "@simon-king-jena"
}
```

Hm. I just tested that the problematic behaviour (namely: Numerous garbage collection cycles required to clear the dict) does not occur with your branch. Could it perhaps be the case that I was (again) reading in a wrong way the diff shown by trac?



---

archive/issue_comments_196325.json:
```json
{
    "body": "Replying to [comment:17 SimonKing]:\n> And why did you merge #15432 into this branch?\nI figured that this was the new way to express a \"dependency\" on another ticket. It results in the branch I would have ended up with if I had started this ticket based on the branch there.\n\n> What is left from #15432 in the HEAD of this branch?\n\nEverything, I think. I really just merged and it did so without conflict. Certainly all the commits listed at #15432 show up in the history here.",
    "created_at": "2013-12-18T17:11:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196325",
    "user": "@nbruin"
}
```

Replying to [comment:17 SimonKing]:
> And why did you merge #15432 into this branch?
I figured that this was the new way to express a "dependency" on another ticket. It results in the branch I would have ended up with if I had started this ticket based on the branch there.

> What is left from #15432 in the HEAD of this branch?

Everything, I think. I really just merged and it did so without conflict. Certainly all the commits listed at #15432 show up in the history here.



---

archive/issue_comments_196326.json:
```json
{
    "body": "Then perhaps I was misreading what trac showed me as diff.\n\nI now took #15432, merged with master, and compare it with the branch from here, merged with master.\n\nThese are the differences I see with `git diff ticket/15432 ticket/15506`:\n\n- You put certain to-be-deleted things into tuples, in order to use Python's trashcan.\n- You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.\n\nSo, are these the changes I have to review here?\n\nBest regards,\nSimon",
    "created_at": "2013-12-18T17:25:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196326",
    "user": "@simon-king-jena"
}
```

Then perhaps I was misreading what trac showed me as diff.

I now took #15432, merged with master, and compare it with the branch from here, merged with master.

These are the differences I see with `git diff ticket/15432 ticket/15506`:

- You put certain to-be-deleted things into tuples, in order to use Python's trashcan.
- You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.

So, are these the changes I have to review here?

Best regards,
Simon



---

archive/issue_comments_196327.json:
```json
{
    "body": "Replying to [comment:20 SimonKing]:\n\n> These are the differences I see with `git diff ticket/15432 ticket/15506`:\n> \n> - You put certain to-be-deleted things into tuples, in order to use Python's trashcan.\n\nCorrect (isn't it a list rather than a tuple? Doesn't matter for our purposes, though).\n\n> - You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.\n\nThat's from #15432. It's more than speed: it also saves us from having to keep a weakened reference in the IterationContext, so it makes it easier to avoid circular references. I was actually surprised to see the complication that a context produced here.\n\nIn addition to these changes, #15432 also introduces an WeakKeyDictionary eraser class to make it possible to keep a weak reference (and avoid circular references).\n\nI'd recommend just reviewing all of this here and be done with it (unless you feel any of this is controversial of course)",
    "created_at": "2013-12-18T18:24:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196327",
    "user": "@nbruin"
}
```

Replying to [comment:20 SimonKing]:

> These are the differences I see with `git diff ticket/15432 ticket/15506`:
> 
> - You put certain to-be-deleted things into tuples, in order to use Python's trashcan.

Correct (isn't it a list rather than a tuple? Doesn't matter for our purposes, though).

> - You *remove* the `_IterationContext` and replace it by cdef methods. So, instead of a context, you have `try: self._enter_iter() ... finally: self._exit_iter()`. I suppose that's for speed.

That's from #15432. It's more than speed: it also saves us from having to keep a weakened reference in the IterationContext, so it makes it easier to avoid circular references. I was actually surprised to see the complication that a context produced here.

In addition to these changes, #15432 also introduces an WeakKeyDictionary eraser class to make it possible to keep a weak reference (and avoid circular references).

I'd recommend just reviewing all of this here and be done with it (unless you feel any of this is controversial of course)



---

archive/issue_comments_196328.json:
```json
{
    "body": "Simon, are you still reviewing this and #15432? The list of commits in question is http://git.sagemath.org/sage.git/log/?h=u%2Fnbruin%2Fticket%2F15506&qt=range&q=develop..u%2Fnbruin%2Fticket%2F15506",
    "created_at": "2013-12-22T17:02:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196328",
    "user": "@vbraun"
}
```

Simon, are you still reviewing this and #15432? The list of commits in question is http://git.sagemath.org/sage.git/log/?h=u%2Fnbruin%2Fticket%2F15506&qt=range&q=develop..u%2Fnbruin%2Fticket%2F15506



---

archive/issue_comments_196329.json:
```json
{
    "body": "Since #15432 is a dependency, I'll review this first. I am building the #15432-branch right now (after merging the develop branch).",
    "created_at": "2013-12-22T17:11:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196329",
    "user": "@simon-king-jena"
}
```

Since #15432 is a dependency, I'll review this first. I am building the #15432-branch right now (after merging the develop branch).



---

archive/issue_comments_196330.json:
```json
{
    "body": "Am I right that I don't need to push a merge with my review-commit from #15432, since there is no merge conflict?",
    "created_at": "2013-12-23T21:14:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196330",
    "user": "@simon-king-jena"
}
```

Am I right that I don't need to push a merge with my review-commit from #15432, since there is no merge conflict?



---

archive/issue_comments_196331.json:
```json
{
    "body": "Yes, if there is no conflict then you don't have to merge.",
    "created_at": "2013-12-23T21:15:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196331",
    "user": "@vbraun"
}
```

Yes, if there is no conflict then you don't have to merge.



---

archive/issue_comments_196332.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2013-12-23T22:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196332",
    "user": "@simon-king-jena"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_196333.json:
```json
{
    "body": "I have added the example from commit:2 as a doc test (otherwise the fix wouldn't be tested against).\n\nAll tests pass (including the new one), and the code makes sense. I only wonder if we can use Python's trashcan in a different more efficient way (such as to avoid the creation of a list of length two during deletion of a dictionary item). But I think this ticket is about fixing a bug in the first place, and if we see the need for yet more efficiency, we can open another ticket.\n\nI.e.: Positive review.",
    "created_at": "2013-12-23T22:50:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196333",
    "user": "@simon-king-jena"
}
```

I have added the example from commit:2 as a doc test (otherwise the fix wouldn't be tested against).

All tests pass (including the new one), and the code makes sense. I only wonder if we can use Python's trashcan in a different more efficient way (such as to avoid the creation of a list of length two during deletion of a dictionary item). But I think this ticket is about fixing a bug in the first place, and if we see the need for yet more efficiency, we can open another ticket.

I.e.: Positive review.



---

archive/issue_comments_196334.json:
```json
{
    "body": "Yeah, that's a nice Chrismas present :-) Thanks Simon, thanks Nils!",
    "created_at": "2013-12-24T07:33:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196334",
    "user": "@nthiery"
}
```

Yeah, that's a nice Chrismas present :-) Thanks Simon, thanks Nils!



---

archive/issue_comments_196335.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2013-12-24T20:24:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15269",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15269#issuecomment-196335",
    "user": "@vbraun"
}
```

Resolution: fixed
