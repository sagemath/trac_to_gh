# Issue 12777: Better congruence testing for odd arithmetic subgroups

Issue created by migration from https://trac.sagemath.org/ticket/12949

Original creator: davidloeffler

Original creation time: 2012-05-15 11:55:49

Assignee: craigcitro

CC:  vdelecroix

This patch relates to the ` is_congruence() ` method of arithmetic subgroups of SL2Z (described in terms of permutations, cf. ` sage.modular.arithgroup.arithgroup_perm`). For even subgroups (containing -1), there is a very fast algorithm due to Tim Hsu, but for odd subgroups we were using a much, much slower brute-force algorithm.

My student Thomas Hamilton checked in his MMath thesis that Hsu's algorithm also works for odd subgroups with minor modifications. This patch implements this generalized Hsu algorithm, resulting in a speedup of about three orders of magnitude in all the examples I tried.


---

Comment by davidloeffler created at 2012-05-15 15:06:47

Changing status from new to needs_review.


---

Comment by davidloeffler created at 2012-05-15 15:48:10

Vincent: I'm ccing you on this ticket, since it was you who originally suggested that Hsu's algorithm should work for odd subgroups too (http://trac.sagemath.org/sage_trac/ticket/11598#comment:3)


---

Comment by vdelecroix created at 2013-06-04 16:10:21

Hello,

Sorry to answer lately. This is quite nice that it works!

I am starting the review...


---

Comment by vdelecroix created at 2013-06-04 16:37:18

I would prefer to keep both implementations (naive one vs checking relations with default to the latter one of course ;-). Then you may add a dedicated test comparing the results in `sage.modular.arithgroup.tests`. Otherwise the new implementation is well documented and everything works.

Is your result available to read ? A dissertation is a legitimate reference, but one may want to read it.

Why did you remove the reference of the article of Alexey G. Gorinov ? I do not claim that it is not a good idea but just that it was not the purpose of the ticket.


---

Comment by vdelecroix created at 2013-06-04 16:37:18

Changing status from needs_review to needs_work.


---

Comment by davidloeffler created at 2013-06-24 16:22:26

Changing status from needs_work to needs_info.


---

Comment by davidloeffler created at 2013-06-24 16:22:26

Dear Vincent,

Nice to hear from you; sorry it's taken me so long to look at this in turn...

- I didn't remove the reference to Gorinov. I just moved it a little higher in the list so the references were listed in alphabetical order.

- Hamilton's dissertation isn't available publicly anywhere, sadly; Warwick doesn't maintain an archive of MMath dissertations, although it does for MSc and PhD degrees. If you want to check the result, I have a copy I can send to you personally, if you like.

- I'm not quite sure what you're suggesting re keeping both algorithms. At the moment we have one (fast) algorithm for even subgroups only, and another (much slower) algorithm for odd subgroups. It seems silly to distinguish needlessly between even/odd -- would you be happier with a setup where we have both algorithms available for both types of subgroups (with the fast one the default, of course)?


---

Comment by vdelecroix created at 2013-06-24 17:35:03

Hi,

Replying to [comment:5 davidloeffler]:
> - I didn't remove the reference to Gorinov. I just moved it a little higher in the list so the references were listed in alphabetical order.

My mistake.
 
> - Hamilton's dissertation isn't available publicly anywhere, sadly; Warwick doesn't maintain an archive of MMath dissertations, although it does for MSc and PhD degrees. If you want to check the result, I have a copy I can send to you personally, if you like.

I would appreciate a copy but this is not the point. If you mention the Math dissertation as a reference for the algorithm it should be available for anyone. What about arXiv ?

> - I'm not quite sure what you're suggesting re keeping both algorithms. At the moment we have one (fast) algorithm for even subgroups only, and another (much slower) algorithm for odd subgroups. It seems silly to distinguish needlessly between even/odd -- would you be happier with a setup where we have both algorithms available for both types of subgroups (with the fast one the default, of course)?

You are right. It would be better to keep the fast algorithm only and to implement the naive test within the `Test` class and check that the answers coincide.

Best
Vincent


---

Comment by davidloeffler created at 2013-06-25 08:49:44

I'd need Hamilton's permission to put the work on the arxiv, I'll see if that can be got.


---

Comment by davidloeffler created at 2013-07-05 10:07:51

Dear Vincent,

Hamilton gave his permission for the work to be put on the Arxiv, so here's a new patch that references the Arxiv preprint. There is also a test in "tests.py" which compares `is_congruence` against `congruence_closure`, and a slight tweak to the congruence subgroup initialization code that makes the test run a little faster.

Best regards, David


---

Comment by davidloeffler created at 2013-07-05 10:07:51

Changing status from needs_info to needs_review.


---

Comment by vdelecroix created at 2013-07-05 12:01:13

patchbot is unhappy on 5.11.beta3. Is that normal?


---

Comment by davidloeffler created at 2013-07-05 14:12:31

Rebased to 5.11.beta3


---

Attachment

It conflicted with #14014. I've rebased it.


---

Comment by vdelecroix created at 2013-07-05 16:06:21

Great! I am really happy that it was possible to put it on arxiv. Everything looks fine except for the tests: `sage -t` on sage.modular.arithgroup.tests was around 10sec and is now 576.57sec which is not reasonable. When testing the congruence try to set index_max to a much smaller value. You should also add some `# long time` wherever appropriate.

I also notice that
 * the Test class should be clean up (there is no reason to use `print` and there should be more occurences of tests inside the documentation)
 * there is a broken link in the documentation (see [this sage-devel thread](https://groups.google.com/forum/#!topic/sage-devel/bnHspWvX3D4))
... but this ticket has nothing to do with it ;-)

Best,
Vincent


---

Comment by vdelecroix created at 2013-07-05 16:07:45

Changing status from needs_review to needs_work.


---

Attachment

Apply over previous patch


---

Comment by davidloeffler created at 2013-07-21 20:39:07

Here's a new patch. The link now points to a copy Kurth's homepage as mirrored on an archive website. I kept the randomized test as it was, but flagged it with "long"; the problem is that if you reduce the index too far, then you only ever get one of a very small set of subgroups and so it's not really a worthwhile test. 

I also corrected a tiny parity issue in the test routine (there are no odd subgroups of index 2 mod 4, and it was pure luck that the default parameters for the test routine don't provoke this error).


---

Comment by davidloeffler created at 2013-07-21 20:39:07

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2013-07-25 11:10:56

Apply trac_12949.patch trac_12949-fixlink.patch​

(for patchbot)


---

Comment by davidloeffler created at 2013-07-25 18:18:02

This conflicts (in a very minor way) with #12233, which now has a positive review, so I rebased it.

Apply trac_12949-rebased.patch​


---

Comment by davidloeffler created at 2013-07-25 19:14:11

Rebased to apply cleanly over #12233


---

Attachment


---

Comment by chapoton created at 2013-09-21 18:06:29

for the *patchbots*

apply trac_12949-rebased-v2.patch


---

Comment by vdelecroix created at 2013-10-19 23:17:58

Hi,

Good for me! Thanks.

Vincent


---

Comment by vdelecroix created at 2013-10-19 23:17:58

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2013-10-21 06:28:50


```
dochtml.log:[arithgrou] /scratch/release/merger/sage-5.13.beta2/local/lib/python2.7/site-packages/sage/modular/arithgroup/arithgroup_perm.py:docstring of sage.modular.arithgroup.arithgroup_perm:82: WARNING: Bullet list ends without a blank line; unexpected unindent.
```



---

Comment by jdemeyer created at 2013-10-21 06:28:50

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2013-10-21 19:50:06

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2013-10-21 19:50:06

New patch, where I have corrected the doc issue.


---

Comment by chapoton created at 2013-10-22 11:44:34

for the *patchbots*:

apply trac_12949-rebased-v2.patch


---

Comment by davidloeffler created at 2013-10-24 07:34:16

Changing status from needs_review to positive_review.


---

Comment by davidloeffler created at 2013-10-24 07:34:16

I'm happy with the new patch, and doctests pass -- I'll reinstate the positive review. Thanks, Frédéric!


---

Comment by jdemeyer created at 2013-10-24 16:15:18

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2013-10-24 16:15:18

Problem with the documentation:

```
dochtml.log:[arithgrou] /scratch/release/merger/sage-5.13.beta2/local/lib/python2.7/site-packages/sage/modular/arithgroup/arithgroup_perm.py:docstring of sage.modular.arithgroup.arithgroup_perm:82: WARNING: Bullet list ends without a blank line; unexpected unindent.
```


One more small remark: shouldn't the test methods (e.g. `test_cong_closure`) be private (i.e. `_test_cong_closure`)?


---

Comment by chapoton created at 2013-10-24 16:58:07

rebased again on 5.12.beta5


---

Attachment

sorry. Now the doc should really be okay. I have not taken care of the test methods. Anyway, the file tests itself is not really for everybody..


---

Comment by chapoton created at 2013-10-24 18:06:13

apply trac_12949-rebased-v2.patch


---

Comment by chapoton created at 2014-02-21 12:54:22

Here is a git branch.

This ticket has once been positive reviewed..
----
New commits:


---

Comment by chapoton created at 2014-02-21 12:56:18

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-02-21 13:01:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-03-20 21:33:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2014-05-02 10:09:12

Hello,

I merged with 6.1.rc1 (trivial conflicts). All test pass and documentation builds. I set it back to positive review.

Vincent
----
New commits:


---

Comment by vdelecroix created at 2014-05-02 10:09:12

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-05-06 23:03:15

Resolution: fixed


---

Comment by vbraun created at 2014-05-07 06:35:00

Resolution changed from fixed to 


---

Comment by vbraun created at 2014-05-07 06:35:00

Changing status from closed to new.


---

Comment by vbraun created at 2014-05-07 06:35:00

Does this ticket really need super-long doctests to test things that absolutely cannot be tested by smaller parameters? Maximum time should be a few seconds, not minutes. There is no point in running huge computations if they don't test anyting that is already tested with smaller tests. Times out on slower buildbots.


---

Comment by davidloeffler created at 2015-03-16 12:06:37

I've uploaded a new version without the time-wasting tests.

(For some reason, this ticket had been linked to a Git branch which "git trac" refused to read, so I just spent the entire morning re-applying the changes by hand.)
----
New commits:


---

Comment by davidloeffler created at 2015-03-16 12:06:37

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-03-20 15:19:00

Hello,

Replace `ZZ(~Zmod(N)(2))` with `ZZ(2).inverse_mod(N)` (several occurrences).

Do you know why `L.order()` returns a Python int and not an Sage Integer? It looks like a bug to me as for example

```
sage: type(Zmod(5)(3).order())
<type 'sage.rings.integer.Integer'>
```


Vincent


---

Comment by vdelecroix created at 2015-03-20 15:19:00

Changing status from needs_review to needs_work.


---

Comment by git created at 2015-03-30 09:06:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by davidloeffler created at 2015-03-30 09:14:46

Changing status from needs_work to needs_review.


---

Comment by davidloeffler created at 2015-03-30 09:14:46

I made the changes you suggested. I agree that the return type of "order" for perm group elements looks like a bug, so I changed that, although it has nothing really to do with this ticket.


---

Comment by vdelecroix created at 2015-03-30 11:07:04

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-03-30 11:07:04

Good!


---

Comment by vbraun created at 2015-04-15 16:39:13

Resolution: fixed
