# Issue 18720: ehrhart_polynomial should be made available for polytopes defined over QQ

Issue created by migration from Trac.

Original creator: mkoeppe

Original creation time: 2015-07-27 17:27:37

CC:  jipilab selia

Keywords: latte

... because they can happen to be lattice polytopes. An exception should be raised when they are not.

See http://trac.sagemath.org/ticket/18812#comment:33




---

Comment by jipilab created at 2018-04-12 14:32:23

This should also be done through the backend `normaliz` with the version coming after 3.5.3. The call to get the `ehrhart_polynomial` in normaliz will be facilitated and would be nice to have too.

The upgrade to normaliz 3.5.3 is here: #22984.


---

Comment by Winfried created at 2018-07-05 09:23:06

Normaliz and PyNormaliz have the computation goal EhrhartQuasipolynomial since Normaliz version 3.6.0.


---

Comment by selia created at 2019-07-23 16:08:30

New commits:


---

Comment by selia created at 2019-07-23 16:08:30

Changing keywords from "latte" to "latte, days100".


---

Comment by git created at 2019-07-23 16:53:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 06:06:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 06:12:08

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-07-24 08:09:39

Let's start with `ZZ`.

In `base_ZZ.py` (structure looks great):

 - You can correct the doctests later (this might save time)
 - `ehrhart_polynomial`: empty line after INPUT, and period at the end of engine description.
 - Eventually replace the third input by the description in the `_latte` method.
 - the current check `if self.is_empty():` located at the beginning of `_ehrhart_polynomial_latte` could be moved to the public `ehrhart_polynomial`.

In `backend_normaliz.py`:

 - looks good!

 - I am tempted to simply make the definition of the two `_ehrhart_polynomial_normaliz` as alias:


```
    _ehrhart_polynomial_normaliz = _ehrhart_quasi_polynomial_normaliz
```


 - The check `if self.is_empty():` of `_ehrhart_quasi_normaliz` can be safely removed since the function should not be reached if it is empty since it is dealt with in the front function. I believe the same could also be checked for compactness in the front function (in `base_ZZ` and `base_QQ`).


---

Comment by git created at 2019-07-24 09:27:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 10:02:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 10:27:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 11:20:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 12:28:52

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 14:55:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 15:19:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 16:04:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-24 16:12:22

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-25 13:54:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-25 14:39:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-07-25 14:43:11

Ok, I give up, it is not nice to try to make latte have the option to specify the variable. It involves changing the interface, and perhaps not in the scope of this ticket.

I reverted the changes involving that around the `_latte` functions. It should be back to normal. So, I suggest that the `variable=` be only a `normaliz` engine option and not a `latte` one. Normaliz returns the data without the use of a variable, this is why it makes it easy to provide the option for the user to choose it since we have to choose one anyway.


---

Comment by jipilab created at 2019-07-25 14:45:14

... if one really wants to make it also possible for latte, the option to change the base ring variable is then a valid choice. But I would add a comment next to it saying:


```
# TO DO: replace this change of variable by creating the appropriate polynomial ring in the latte interface.
```



---

Comment by git created at 2019-07-26 12:33:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-26 15:48:50

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-07-26 16:00:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-07-30 22:34:01

Here are some small edits to be done:

 - You can forget my previous comment abour the heading space added.

 - No spaces are needed between equality in the definition of a function:


```diff
- def _ehrhart_quasipolynomial_normaliz(self,variable = 't'):
+ def _ehrhart_quasipolynomial_normaliz(self,variable='t'):
```


 - The output should be related to the data structure, without much details of what they are. The text with details should then be moved after the one-line description of the function to explain the output.


```diff
        OUTPUT:

-        If it is a polynomial, returns the polynomial. Otherwise, returns a
-        tuple of rational polynomials whose length is the quasi-period of the
-        quasi-polynomial and each rational polynomial describes a residue class.

+        A polynomial or tuple of polynomials.
```


 - Most examples in doctests with text explanations should be moved to the public function without underscore so that they are accessible to the users. Then the examples of the private functions should show that they work as needed and that raising Errors are done appropriately.

 - Some formating of variables are missing (see http://doc.sagemath.org/html/en/developer/coding_basics.html):


```diff
- * None (default): When no input is given the Ehrhart polynomial
+ * ``None`` (default): When no input is given the Ehrhart polynomial
```


 - it is conventional to use lower cases for objects:


```diff
- sage: Line_Seg = Polyhedron(vertices=[[0],[1/2]],backend='normaliz')
+ sage: line_seg = Polyhedron(vertices=[[0],[1/2]],backend='normaliz')
```



---

Comment by git created at 2019-07-31 18:07:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-08-20 18:12:59

ready for review ?


---

Comment by chapoton created at 2019-08-20 18:34:20

The branch is red, and the required rebase on the latest develop branch is not trivial.


---

Comment by jipilab created at 2019-08-20 19:14:26

I forgot that we could have put it to needs review to get some bot feedback already, but it was still quite under constant development.

Once the merge conflict is resolved, it could benefit from some bot-runs before another round of review.

As this function is a good example of interfacing of normaliz, I would say it is worth to make it a robust and clean model for other eventual methods using normaliz. It is in quite good shape, once it is on needs review, I would check again if we covered all the intricate cases of backends and base rings...


---

Comment by git created at 2019-08-27 11:59:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-08-27 13:30:46

Could you merge the latest sage version into your branch? There is a conflict...

Then, I guess it would ready for review.


---

Comment by git created at 2019-09-05 15:46:01

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jipilab created at 2019-09-05 15:48:00

Changing status from new to needs_review.


---

Comment by jipilab created at 2019-09-06 06:41:54

Okay!

From the patchbot:

 - 2 failing doctests in `backend_normaliz`
 - 2 functions are missing doctests in `base_ZZ`
 - pyflakes error in `base_ZZ`
 - the documentation of `base_QQ` does not build: 


```
OSError: /home/worker/sage-patchbot/local/lib/python2.7/site-packages/sage/geometry/polyhedron/base_QQ.py:docstring of sage.geometry.polyhedron.base_QQ.Polyhedron_QQ.ehrhart_quasipolynomial:69: WARNING: Inline literal start-string without end-string.
```



---

Comment by jipilab created at 2019-09-06 06:41:54

Changing status from needs_review to needs_work.


---

Comment by jipilab created at 2019-09-11 15:30:40

One more thing: we should consider making some of these methods cached so as to not recompute everything every time...


---

Comment by chapoton created at 2019-09-16 08:07:07

empty TESTS section should be removed:

```
+        TESTS::
+        """
```



---

Comment by git created at 2019-09-20 12:23:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-20 12:52:09

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by selia created at 2019-09-20 14:18:37

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2019-09-20 19:16:01

doc still does not build:

```
sage.geometry.polyhedron.base_QQ.Polyhedron_QQ.ehrhart_quasipolynomial:110: WARNING: Inline literal start-string without end-string
```

maybe because of a missing empty line after `.. WARNING::`


---

Comment by jipilab created at 2019-09-23 07:22:42

And there is one superfluous import, see the pyflake error.

There is also the coverage to take care of ...


---

Comment by git created at 2019-09-23 11:57:34

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2019-09-23 23:29:23

You might also still have some doc problems

```
         -  ``variable`` -- string (default: 't'); The variable in which the
-              Ehrhart polynomial should be expressed.
+           Ehrhart polynomial should be expressed
 
         - ``engine`` -- string; The backend to use. Allowed values are:
 
-            * ``None`` (default); When no input is given the Ehrhart polynomial
-              is computed using LattE Integrale (optional)
+          * ``None`` (default); When no input is given the Ehrhart polynomial
+            is computed using LattE Integrale (optional)
```

and similar. My understanding is sphinx likes things to be aligned with the first non-whitespace character after the `-` (or `*`) in a list.


---

Comment by chapoton created at 2019-09-24 07:18:50

The following is not good:

```
TypeError: The backend of ``self`` should be 'normaliz'
```

There should be no such formatting inside doctests themselves.


---

Comment by git created at 2019-09-24 08:48:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2019-09-24 11:22:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-09-24 12:20:39

and some failing doctests, one missing optional and some misplaced optional


---

Comment by chapoton created at 2019-09-24 14:51:04

and doc still does not build. The offending line seems to be

```
``backend``='normaliz'::
```

in line 490, which should rather be

```
``backend='normaliz'``::
```



---

Comment by git created at 2019-09-24 15:16:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-09-24 18:05:48

There remains the same backtick problem in the other file `base_ZZ.py` in the line 400

```
``engine``='latte' and then with ``engine``='normaliz'.
```


and still the pyflakes warnings: do not write `engine is 'latte'` but `engine == 'latte'`. See patchbot pyflakes plugins for the 4 exact lines where you should fix that.

and still the failing doctests due to missing or misplaced `# optional` tags.


---

Comment by git created at 2019-10-04 07:47:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2019-10-04 07:47:48

I have fixed my own comments. There remains only one failing doctest in

```
src/sage/geometry/polyhedron/base_ZZ.py
```

, that you should take care of.


---

Comment by chapoton created at 2019-10-13 19:49:05

one last effort is required..


---

Comment by jipilab created at 2019-10-14 06:01:16

We're on it! :) The semester starts today, and we'll have more time to look into sage.


---

Comment by git created at 2019-10-14 09:18:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-10-14 09:23:21

Needs review again. It should be good to go now.

The failing doctest due to a missing optional package was a superfluous indirect doctest, so I removed it. I don't think it needed testing there. If you disagree, I could put it back with the optional tag.


---

Comment by chapoton created at 2019-10-14 12:06:11

typo "integeral"

sinon, c'est bon : positive review


---

Comment by git created at 2019-10-14 12:18:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jipilab created at 2019-10-14 12:18:38

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2019-10-20 22:16:54

Resolution: fixed
