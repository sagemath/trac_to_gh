# Issue 32470: flit_core: Update to 3.4.0

Issue created by migration from https://trac.sagemath.org/ticket/32707

Original creator: mkoeppe

Original creation time: 2021-10-17 17:38:01

CC:  vbraun dimpase jhpalmieri

https://flit.readthedocs.io/en/latest/history.html#version-3-4


---

Comment by mkoeppe created at 2021-10-17 17:58:30

Last 10 new commits:


---

Comment by git created at 2021-10-17 18:03:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-17 18:03:48

Changing status from new to needs_review.


---

Comment by vbraun created at 2021-10-17 22:46:56

Is this the expected output?

```
ERROR: Could not find a version that satisfies the requirement tomli (from flit-core) (from versions: none)
ERROR: No matching distribution found for tomli
Warning: installing with "python3 -m pip install --verbose --no-index --find-links=/home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels --disable-pip-version-check --isolated --no-cache-dir" failed. Retrying, adding "--no-deps --ignore-installed --ignore-requires-python"
Using pip 21.2.4 from /home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pip (python 3.9)
Looking in links: /home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels
Processing /home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/flit_core-3.4.0/inst/home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/wheels/flit_core-3.4.0-py3-none-any.whl
Installing collected packages: flit-core
Successfully installed flit-core-3.4.0
Warning: The installation needed to use "--no-deps --ignore-installed --ignore-requires-python" to succeed. This means that a dependencies file in build/pkgs/ needs to be updated. Please report this to sage-devel@googlegroups.com, including the build log of this package.
```



---

Comment by vbraun created at 2021-10-17 22:48:05

tox still depends on toml:

```
build/pkgs/tox/dependencies:$(PYTHON) packaging six filelock pluggy py toml virtualenv importlib_metadata | $(PYTHON_TOOLCHAIN)
```



---

Comment by mkoeppe created at 2021-10-17 23:29:53

Replying to [comment:8 vbraun]:
> Is this the expected output?
> {{{
> Warning: The installation needed to use "--no-deps --ignore-installed --ignore-requires-python" to succeed. This means that a dependencies file in build/pkgs/ needs to be updated. Please report this to sage-devel`@`googlegroups.com, including the build log of this package.
> }}}
Yes


---

Comment by git created at 2021-10-17 23:33:43

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-10-17 23:34:19

Replying to [comment:9 vbraun]:
> tox still depends on toml:
> {{{
> build/pkgs/tox/dependencies:$(PYTHON) packaging six filelock pluggy py toml virtualenv importlib_metadata | $(PYTHON_TOOLCHAIN)
> }}}
Thanks for catching this


---

Comment by vbraun created at 2021-10-18 20:25:05

Ok its a bit sub-optimal to tell people to complain on sage-devel upon successful installation, but hopefully nobody looks into the log.

However, building the source tarball fails because tox still depends on toml:

```
sage -sdist
[...]
[threejs-r122.p0] Using cached file /home/release/Sage/upstream/threejs-sage-r122.tar.gz
make[1]: Nothing to be done for 'tomli'.
make[1]: Nothing to be done for 'tornado'.
make[1]: *** No rule to make target 'toml', needed by '/home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/installed/tox-3.24.3'.  Stop.
make: *** [Makefile:2336: download-for-sdist] Error 2
```



---

Comment by mkoeppe created at 2021-10-18 20:52:59

Did you run `bootstrap`?


---

Comment by vbraun created at 2021-10-18 20:54:16

Yes, did run bootstrap. The content of the source tarball hopefully doesn't depend on which system libraries are available.

Also just got this while trying the latest version

```
****************************************************
Uninstalling existing 'pyparsing'
Warning: File '/home/release/Sage/local/var/lib/sage/wheels/pyparsing-2.4.7-py2.py3-none-any.whl' not found
Warning: Directory '/home/release/Sage/local/var/lib/sage/wheels' not found
Running pip-uninstall script for 'pyparsing'
Found existing installation: pyparsing 2.4.7
Uninstalling pyparsing-2.4.7:
  Successfully uninstalled pyparsing-2.4.7
Removing stamp file '/home/release/Sage/local/var/lib/sage/venv-python3.9/var/lib/sage/installed/pyparsing-2.4.7'
Installing pyparsing-2.4.7
Processing /home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/pyparsing-2.4.7/src
    Running command python setup.py egg_info
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/pyparsing-2.4.7/src/setup.py", line 18, in <module>
        setup(# Distribution meta-data
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/__init__.py", line 153, in setup
        return distutils.core.setup(**attrs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/_distutils/core.py", line 108, in setup
        _setup_distribution = dist = klass(attrs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/dist.py", line 450, in __init__
        _Distribution.__init__(
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/_distutils/dist.py", line 293, in __init__
        self.finalize_options()
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/dist.py", line 827, in finalize_options
        for ep in sorted(loaded, key=by_order):
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/setuptools/dist.py", line 826, in <lambda>
        loaded = map(lambda e: e.load(), filtered)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 2449, in load
        self.require(*args, **kwargs)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 2472, in require
        items = working_set.resolve(reqs, env, installer, extras=self.extras)
      File "/home/release/Sage/local/var/lib/sage/venv-python3.9/lib64/python3.9/site-packages/pkg_resources/__init__.py", line 772, in resolve
        raise DistributionNotFound(req, requirers)
    pkg_resources.DistributionNotFound: The 'tomli>=1.0.0' distribution was not found and is required by the application
WARNING: Discarding file:///home/release/Sage/local/var/lib/sage/venv-python3.9/var/tmp/sage/build/pyparsing-2.4.7/src. Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
**************************************************************************************************************************************************************
Error building a wheel for pyparsing-2.4.7
**************************************************************************************************************************************************************
```



---

Comment by mkoeppe created at 2021-10-18 21:00:04

Replying to [comment:15 vbraun]:
> Ok its a bit sub-optimal to tell people to complain on sage-devel upon successful installation, but hopefully nobody looks into the log.

Yes, we can address this in #32715.


---

Comment by mkoeppe created at 2021-10-18 21:06:55

Replying to [comment:17 vbraun]:
> Yes, did run bootstrap. The content of the source tarball hopefully doesn't depend on which system libraries are available.

Asking because it looks like what a make run would look like after the `toml` package has been removed.


---

Comment by mkoeppe created at 2021-10-18 21:12:32

I recommend to use `make dist` instead of directly using `./sage --sdist`, which takes care of regenerating the Makefile.


---

Comment by mkoeppe created at 2021-10-18 21:24:24

Replying to [comment:17 vbraun]:
> Also just got this while trying the latest version
> {{{
> ****************************************************
> Uninstalling existing 'pyparsing'
> Warning: File '/home/release/Sage/local/var/lib/sage/wheels/pyparsing-2.4.7-py2.py3-none-any.whl' not found
> Warning: Directory '/home/release/Sage/local/var/lib/sage/wheels' not found
> Running pip-uninstall script for 'pyparsing'
> Found existing installation: pyparsing 2.4.7
> }}}
Best to get rid of this messed up worktree


---

Comment by vbraun created at 2021-10-18 22:46:12

The pyparsing error says that tomli is required, but its not listed as a dependency

```
[release@zen Sage]$ cat build/pkgs/pyparsing/dependencies 
$(PYTHON) | setuptools pip wheel
```

I think thats a real dependency error


---

Comment by mkoeppe created at 2021-10-18 22:50:04

There's nothing in pyparsing that refers to tomli.

I think in your worktree, you have for some reason a broken installation record of pip packages.

Can you reproduce this in a from scratch build?


---

Comment by vbraun created at 2021-10-19 20:29:13

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-10-19 20:30:37

Resolution: fixed


---

Comment by vbraun created at 2021-10-24 08:48:46

I'm still getting very frequent `pkg_resources.DistributionNotFound: The 'xxx>=20.0' distribution was not found and is required by the application` errors with incremental builds with some packaging-related pip packages. Basically have to do a `make distclean` every day now. Something is messed up there...


---

Comment by vbraun created at 2021-10-24 09:13:47

I've created #32751 for this issue


---

Comment by vbraun created at 2021-11-07 10:09:41

The issue is not fixed, I still see very frequent `pkg_resources.DistributionNotFound: The 'xxx>=20.0' distribution was not found and is required by the application` errors during incremental builds
