# Issue 34171: Speedup Conversion from integers to Gaussian Integers

Issue created by migration from https://trac.sagemath.org/ticket/34408

Original creator: saraedum

Original creation time: 2022-08-22 09:42:45

CC:  slelievre

Currently, when converting an integer to the Gaussian integers, a costly check is performed, whether the integer is actually an order element:


```
sage: G = GaussianIntegers()
sage: %timeit G(2)
141 µs ± 423 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
```


The culprit seems to be the following check in `_element_constructor_` in `order.py`:


```
        if not embedding(x) in self._module_rep:
            raise TypeError("Not an element of the order.")
```


This check is not necessary for integers which are contained in every order.

Removing this check speeds this up substantially (we should of course not remove this check but maybe only skip it for integers):


```
sage: G = GaussianIntegers()
sage: %timeit G(2)
1.8 µs ± 24.8 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)
```



---

Comment by saraedum created at 2022-08-22 09:43:38

The check for containment of a Gaussian integers in the integers also seems to be slow, see #9540.


---

Comment by saraedum created at 2022-08-22 09:46:41

We could imagine three ways to fix this:

- Add a `check=True` argument to be able to skip this check (however, this only fixes the slowness for the experts who know about this flag.)
- Explicitly skip this check for integers.
- Define a coercion map from the integers that uses a faster path.


---

Comment by tscrim created at 2022-08-22 10:00:03

The absolute fastest will be (3), which can be applied at the level of `Order` (perhaps just `absolute`?). However, with only one indirection, you could simply add a check to the `_element_constructor_` for the special case when the input is in `ZZ` (or its parent is `ZZ`). While this would then be applied to all elements, it would mean there is no difference in performance between `G(2)` and `G(4/2)`. This would not be the case for doing a custom coercion map.
