# Issue 18200: Fix PolyBoRi and Python 3

Issue created by migration from https://trac.sagemath.org/ticket/18437

Original creator: ohanar

Original creation time: 2015-05-18 07:59:48

CC:  malb

Right now PolyBoRi relies on scons (which is still Python 2 only), and has some Python 2 specific syntax in its bindings. These issues will need to be resolved before Sage can support Python 3.


---

Comment by ohanar created at 2015-05-18 08:07:22

Reposted from #15530:

fyi, I started working on an autotools based build system for polybori at https://github.com/ohanar/PolyBoRi/tree/autotools. I'll probably work on it a bit more next weekend during SD 64.25, but the important bits (the c++ libraries) are currently working with only a couple of hacks. What remains (for sage at least) is just a little cleanup and throwing in the bit of the python bindings we use.

----

I also don't know how we should handle this with regards to upstream, since upstream is dead. I certainly don't want to take over maintenance for polybori, but we'll probably need to make some sort of fork.


---

Comment by fbissey created at 2015-05-18 08:23:27

I think there are two separate issues:
 1) polybori is using a internal copy of a third party package that may not be dead upstream (I think it has updates once in a while): cudd.
 2) the python bindings

We could package the libraries properly and then have a separate python binding package, unless `polybori` is altering its upstream significantly beyond the build system. The python binding could be moved in sage making it "a collective" responsibility.


---

Comment by fbissey created at 2015-05-18 08:29:04

Current version of `cudd` in `polybori` is 2.5.0 but upstream at http://vlsi.colorado.edu/~fabio/ has a version 2.5.1 - it is somewhat alive.


---

Comment by ohanar created at 2015-05-18 08:37:58

Replying to [comment:2 fbissey]:
> I think there are two separate issues:
>  1) polybori is using a internal copy of a third party package that may not be dead upstream (I think it has updates once in a while): cudd.
>  2) the python bindings
> 
> We could package the libraries properly and then have a separate python binding package, unless `polybori` is altering its upstream significantly beyond the build system. The python binding could be moved in sage making it "a collective" responsibility.

Polybori has made some real modifications to cudd (I don't think that they are too significant though). From looking at the code it seems like they at least tried to support using an unmodified version, however I don't know if it actually works. Also, cudd's build system looks to be a joke (e.g. assumes `sizeof(void *) == 4` unless you explicitly tell it otherwise), so I don't know how much I would trust it.


---

Comment by fbissey created at 2015-05-18 08:46:55

Doesn't sound good. Autotooling something like that is definitely a good idea. But that puts the burden of maintenance on us. Mind you in Gentoo we have patches to autotool all the individual components of `suitesparse` independently of upstream, so it has been/is being done.


---

Comment by ohanar created at 2015-05-18 21:07:55

So I looked a bit more into how exactly polybori modifies cudd, and other than the build system changes, it appears to be just one of two things:

1. Prefixing the symbols to not collide with another installation of cudd
2. stripping out code that polybori doesn't use (there is only one case that polybori makes any meaningful changes to do this).

Given this, I don't think it would be hard to make polybori work with a vanilla version of cudd. Also, since upstream cudd is not completely dead, the author might be receptive to a better build system if we provide it.


---

Comment by ohanar created at 2015-05-24 05:38:07

I contacted the author of Cudd on Tuesday and have yet to hear back from him. Given that, I think I would prefer not packaging Cudd separately, since maintaining one autotools based system (for polybori) is easier than two (for polybori and for cudd).

I've posted a branch, which uses the tarball at https://github.com/ohanar/PolyBoRi/releases/download/0.8.4/polybori-0.8.4.tar.gz. It doesn't include any of the python bindings, nor any of the tests, so beyond the build system, it is a bit of a fork of polybori. (Maybe we should rename it to something like cropped-polybori.)
----
New commits:


---

Comment by ohanar created at 2015-05-24 05:38:07

Changing status from new to needs_review.


---

Comment by fbissey created at 2015-05-24 06:18:12

I can easily test the new stuff in Gentoo. I can even test your stuff from git master if that helps.


---

Comment by git created at 2015-05-24 06:20:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2015-05-24 06:23:48

Yes, I that would be good (at the very least to make sure that I haven't somehow made things work with old artifacts lying around). Point in fact, I just realized that I pushed a little prematurely, as I forgot to include a few headers in the dist. The new tarball is https://github.com/ohanar/PolyBoRi/releases/download/0.8.5/polybori-0.8.5.tar.bz2.

I'm actually using the autotools branch, but at the moment the tip is the new release I just cut. Since this is new, I can squash the history at some point if desired.


---

Comment by jdemeyer created at 2015-05-24 07:10:40

Exactly what does this patch do? It looks like you're moving part of `polybori` into the Sage library, why that?


---

Comment by jdemeyer created at 2015-05-24 07:10:45

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-05-24 07:15:04

Extraordinary measures (forking polybori???) need extraordinary justification...


---

Comment by fbissey created at 2015-05-24 07:17:26

Upstream being dead is ample justification. We had that conversation elsewhere and decided that it was the way to go.


---

Comment by jdemeyer created at 2015-05-24 07:22:09

Replying to [comment:15 fbissey]:
> We had that conversation elsewhere
Pointers please...


---

Comment by fbissey created at 2015-05-24 07:32:49

We had some talk over at http://trac.sagemath.org/ticket/15530#comment:32 but I think the confirmation that Alexander and Michael had completely abandoned ship were posted on a thread on sage-devel. I'll dig that up.


---

Comment by fbissey created at 2015-05-24 07:36:08

From sage-devel "Python 3 focused Sage Days" thread:
Hi, here's a reply from a PolyBoRi developer:

----------  Forwarded Message  ----------

Subject: Re: [Polybori-discuss] Fwd: Re: [sage-devel] Re: Python 3 focused 
Sage	Days
Date: Saturday 10 Jan 2015, 22:19:16
From: Alexander Dreyer <adreyer`@`t-online.de>
To: Martin Albrecht <martinralbrecht`@`googlemail.com>, Polybori Discuss 
<polybori-discuss`@`lists.sourceforge.net>

Hi Martin,
Unfortunately, Andrew's right, PolyBoRi died when its developers left the 
scientific community. I'm not sure, what's the best way for SAGE to deal with 
it. Porting PolyBoRi's py files shouldn't be a big deal, and Sage already uses  
it's own Cython-bindings for the data structures. What remains is scons. 
Perhaps, it's easier to set up a setup.py or another build system than 
removing PolyBoRi from all the crypto modules. (You probably know the 
dependencies better than me.) For working around lots of scons issues, most of 
the SConstruct file is plain python anyway.

Best regards,
 Alexander


---

Comment by jdemeyer created at 2015-05-24 08:45:31

Even if upstream `polybori` is dead and even if you fork it, that still doesn't mean it should be moved to the Sage library.


---

Comment by fbissey created at 2015-05-24 10:57:57

Fair point. The question then is "does anyone care to have to install sage to get polybori instead of having it as stand alone package?". If it has users as a stand alone package then it should be kept split. If not, that's at the discretion of whoever actually maintains the code.


---

Comment by jdemeyer created at 2015-05-24 12:56:21

Replying to [comment:20 fbissey]:
> Fair point. The question then is "does anyone care to have to install sage to get polybori instead of having it as stand alone package?".
I don't think that's "the question".

All the packaging effort in Sage is really converging towards separating packages from the Sage library proper.

At the very least, moving `polybori` in the Sage library is a sufficiently big change that it should be discussed on `sage-devel`.


---

Comment by jdemeyer created at 2015-05-24 12:58:04

If you really decide to move `polybori` to the Sage library, then I think that

1. moving `polybori` to the Sage library and
2. making it Python 3 compatible

should be two different tickets.


---

Comment by jdemeyer created at 2015-05-24 13:03:31

And `build/pkgs/polybori/SPKG.txt` needs to be updated.


---

Comment by ohanar created at 2015-05-24 16:00:01

I haven't actually gone through the bindings and made sure they are python 3 compatible -- I just fixed their doctests to work in the sage environment. It is easy enough for me to break out the new package into a different ticket.

I think we should rename the fork to say cropped-polybori, to avoid confusion.


---

Comment by ohanar created at 2015-05-25 23:29:31

I broke off the bindings portion to #18506.
----
New commits:


---

Comment by git created at 2015-06-08 03:07:36

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-06-08 03:08:48

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2015-06-08 03:11:14

Changing status from needs_info to needs_review.


---

Comment by ohanar created at 2015-06-08 03:11:14

I updated the polybori autotools to include the python bindings.


---

Comment by jdemeyer created at 2015-06-08 05:50:24

Changing status from needs_review to needs_info.


---

Comment by jdemeyer created at 2015-06-08 05:50:24

I think this needs more explanation/documentation. Surely `build/pkgs/polybori/SPKG.txt` will need to be updated. In particular explain how you obtained the tarball.


---

Comment by jdemeyer created at 2015-06-08 05:55:52

Is this commit [https://github.com/ohanar/PolyBoRi/commit/a91362c5be91b2fb23f8acf609852381b78b15a4](https://github.com/ohanar/PolyBoRi/commit/a91362c5be91b2fb23f8acf609852381b78b15a4) part of the tarball on this commit? I would prefer to see it as a patch in `build/pkgs/polybori/patches` (and on a different ticket).


---

Comment by ohanar created at 2015-06-09 04:16:27

Replying to [comment:31 jdemeyer]:
> Is this commit [https://github.com/ohanar/PolyBoRi/commit/a91362c5be91b2fb23f8acf609852381b78b15a4](https://github.com/ohanar/PolyBoRi/commit/a91362c5be91b2fb23f8acf609852381b78b15a4) part of the tarball on this commit?

Yes.

> I would prefer to see it as a patch in `build/pkgs/polybori/patches` (and on a different ticket).

I would not. As I see it there are three routes we could go with polybori:

1. We adopt the route that we took with Pynac (as a fork of Ginac). Our fork might in the future become tightly coupled with Sage, but we maintain it as a separate package outside of Sage.

2. We make a minimal fork, only include the minimal changes necessary to build polybori without scons. If more substantive changes are needed, we include those in the Sage library.

3. A hybrid approach: maintain a minimal fork, and a maintain a set of patches for more substantive changes.


I really dislike option 3 (which seems to be the one you are voting for). It seems like it just adds the unnecessary work of maintain patches, with no real benefit. Upon reflection, I would vote for 1, since it allows us make changes to the c++ source if we need to in the future.

If we go with option 1, I would rename this ticket to "Switch from polybori to XXXX", where XXXX is our fork of polybori (still needs a name, I haven't been 100% happy with anything I've come up with). In that case, I view it as perfectly acceptable for there to be additional changes to the fork, such as the Python 3 changes I made.

----

Also, `@`fbissey. The author of cudd got back to me finally, he said he was already planning on making a new release sometime this summer which uses autotools. Until then, I think I'll continue bundling it with polybori.


---

Comment by jdemeyer created at 2015-06-09 09:06:44

There is also the issue of not doing too much on a single ticket. If you make a ticket which is _only_ about compiling polybori with autotools, I'll be happy to review it. Anything more will only make the review process more difficult.


---

Comment by jdemeyer created at 2015-06-09 12:35:50

Replying to [comment:32 ohanar]:
> 1. We adopt the route that we took with Pynac (as a fork of Ginac). Our fork might in the future become tightly coupled with Sage, but we maintain it as a separate package outside of Sage.

One thing I don't like is that this will mean essentially unreviewed code in Sage.

From a practical point of view, there is not much difference between code in the Sage library and code in some upstream project which is only used in Sage.

But the code in the Sage library is supposed to be reviewed, while code in upstream projects is normally not reviewed (if people are using upstream outside of Sage, that means at least that the code is tested).

To be honest, I also don't have an optimal solution. Maybe that's why you should ask for feedback on `sage-devel`.


---

Comment by fbissey created at 2015-06-11 01:43:29

Posted on sage-devel for feed back: https://groups.google.com/forum/#!topic/sage-devel/9Uhnvm3wef8


---

Comment by ohanar created at 2015-08-24 01:05:15

Changing status from needs_info to needs_review.


---

Comment by ohanar created at 2015-08-24 01:05:15

I finally got back to this. This switches us to BRiAl (the successor/fork to polybori, as discussed in the sage-devel thread), and includes the new autotools based build system. I will repurpose  #18506. for the second version of BRiAl (to be released), which will include some python 3 syntax fixes.
----
New commits:


---

Comment by fbissey created at 2015-08-24 01:40:20

Cool to see some move on this! `spkg-install` still has messages about `polybori`, it is especially important to update those not too confuse new-comers.

I see that the library name hasn't changed upstream (`libpolybori*`), that would be something to consider although it is not a show stopper for this.

I notice `ipython` has been dropped from the list of dependencies, is it on purpose?


---

Comment by fbissey created at 2015-08-24 02:28:58

Do I understand well that `libgd` is looked for if `libpng` is not there? It is all a bit strange. If `m4ri` doesn't have support for `png` I guess `have_libpng` will be empty and then `libgd` will be checked. The line 

```
        AC_DEFINE([PBORI_HAVE_GD],[],[has gd png support])
```

is a bit misleading as if you arrive there, you have `libgd` support which may or may not have `png` included in it.

Also why shouldn't the compilation abort if `m4ri_png=yes` but you cannot find `libpng`? As far as I can tell `m4ri` won't use `libgd` for libpng unless you abuse the configuration options, so that whole structure looks very strange.

I guess on closer look I have an issue with the way m4ri/m4rie/polybory deal with some of their optional dependencies, and that may be something to look into in the future. For starter if `m4ri` is compiled with `png` support, the used `libpng` should be included in output of `pkg-config m4ri --libs`.


---

Comment by ohanar created at 2015-08-24 02:49:36

Replying to [comment:38 fbissey]:
> Cool to see some move on this! `spkg-install` still has messages about `polybori`, it is especially important to update those not too confuse new-comers.

Sure, I'll do that shortly.

> 
> I see that the library name hasn't changed upstream (`libpolybori*`), that would be something to consider although it is not a show stopper for this.

I didn't want to have to deal with this on the sage side of things at the moment, so I didn't change this. There are a ton of places that the polybori name is used throughout the source code, and it would be a pain to change them, although changing the library name and headers shouldn't be too bad.

> 
> I notice `ipython` has been dropped from the list of dependencies, is it on purpose?

It shouldn't have been a dependency in the first place from what I can tell.


---

Comment by ohanar created at 2015-08-24 02:51:41

Replying to [comment:39 fbissey]:

I basically just took the sconstruct logic and moved it into configure.ac (with the appropriate language translation). I don't claim it is good logic.


---

Comment by git created at 2015-08-24 02:53:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-08-24 02:53:30

I say we save my last comment for future work because I think `m4ri` configure script needs surgery first.
----
New commits:
----
New commits:


---

Comment by fbissey created at 2015-08-24 04:31:22

I just greped the sage source code for traces of `polybori` import. Since it now installs in `brial` unless I missed a mechanism the followings need to be updated

```
Mirage:sage fbissey$ grep -r "from polybori" *
rings/polynomial/multi_polynomial_sequence.py:        from polybori import gauss_on_polys
rings/polynomial/multi_polynomial_sequence.py:        from polybori.ll import eliminate,ll_encode,ll_red_nf_redsb
rings/polynomial/multi_polynomial_sequence.py:            from polybori.interred import interred as inter_red
rings/polynomial/pbori.pyx:    sage: from polybori import *
rings/polynomial/pbori.pyx:        #from polybori.interpolate import interpolate_smallest_lex
rings/polynomial/pbori.pyx:        sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:        sage: from polybori import BooleanMonomialMonoid, BooleanMonomial
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid, BooleanMonomial
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:            sage: from polybori import BooleSet
rings/polynomial/pbori.pyx:        sage: from polybori import BooleanPolynomial
rings/polynomial/pbori.pyx:        from polybori.parallel import _encode_polynomial
rings/polynomial/pbori.pyx:            sage: from polybori import BooleSet
rings/polynomial/pbori.pyx:        from polybori import red_tail
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:        from polybori.gbcore import groebner_basis
rings/polynomial/pbori.pyx:        from polybori import red_tail
rings/polynomial/pbori.pyx:        sage: from polybori import BooleSet
rings/polynomial/pbori.pyx:        sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import BooleSet
rings/polynomial/pbori.pyx:            sage: from polybori import BooleSet
rings/polynomial/pbori.pyx:        sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import groebner_basis
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanPolynomialVector
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import groebner_basis
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import GroebnerStrategy
rings/polynomial/pbori.pyx:            sage: from polybori import BooleanMonomialMonoid
rings/polynomial/pbori.pyx:        sage: from polybori import *
rings/polynomial/pbori.pyx:        sage: from polybori import *
rings/polynomial/pbori.pyx:        sage: from polybori import map_every_x_to_x_plus_one
rings/polynomial/pbori.pyx:        sage: from polybori import zeros
rings/polynomial/pbori.pyx:        sage: from polybori.interpolate import *
rings/polynomial/pbori.pyx:        sage: from polybori.interpolate import *
rings/polynomial/pbori.pyx:        sage: from polybori import ll_red_nf_redsb
rings/polynomial/pbori.pyx:        sage: from polybori import ll_red_nf_noredsb
rings/polynomial/pbori.pyx:        sage: from polybori import ll_red_nf_noredsb_single_recursive_call
rings/polynomial/pbori.pyx:        sage: from polybori import if_then_else
rings/polynomial/pbori.pyx:        sage: from polybori import top_index
rings/polynomial/pbori.pyx:        sage: from polybori import *
rings/polynomial/pbori.pyx:        sage: from polybori import substitute_variables
rings/polynomial/pbori.pyx:        sage: from polybori import substitute_variables
rings/polynomial/pbori.pyx:        sage: from polybori import random_set, set_random_seed
rings/polynomial/pbori.pyx:        sage: from polybori import random_set, set_random_seed
rings/polynomial/pbori.pyx:# todo: merge with pickling from polybori.parallel
rings/polynomial/pbori.pyx:# todo: merge with pickling from polybori.parallel
rings/polynomial/pbori.pyx:    from polybori.parallel import _decode_polynomial
rings/polynomial/pbori.pyx:# todo: merge with pickling from polybori.parallel
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import BooleConstant
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
rings/polynomial/pbori.pyx:            sage: from polybori import *
sat/converters/__init__.py:from polybori import CNFEncoder as PolyBoRiCNFEncoder
```



---

Comment by git created at 2015-08-24 18:23:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2015-08-24 18:24:24

New commits:


---

Comment by fbissey created at 2015-08-24 18:37:33

One last thing. I think we should implement a removal of old `polybori` install like in the old `polybori` spkg and while we are at it cleaning of a previous `brial` install in case of updating or re-install. We should do it before the call to `configure`.


---

Comment by git created at 2015-08-24 18:51:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-08-24 19:55:52

I think it is ready for testing. One more thing that I just spotted

```
              libraries=['polybori', 'polybori_groebner', 'm4ri', 'gd', 'png12'],
```

shouldn't include `gd` we have removed the dependency in polybori and a check in sage-on-gentoo (all compiled with `-Wl,-as-needed`) shows that it is not used in `pbori.so`, there is only one instance of a direct linking to `libgd` in the whole sage, I'll check where it is coming from.


---

Comment by fbissey created at 2015-08-24 20:05:33

`matrix_mod2_dense` is where there is a direct linking to `gd` and it is explicit in `module_list.py`. The other 2 instances `sage.modules.vector_mod2_dense` and `sage.rings.polynomial.pbori` (whose `libraries`'s line was the object of my previous comment) are probably linked to the presence of `m4ri` and can be removed. Actually the presence in matrix_mod2_dense is curious and should be further investigated but that's not this ticket.


---

Comment by git created at 2015-08-24 20:10:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-08-25 00:27:51

Ok just tested a build from scratch with the branch. The python bindings are being installed in `SAGE_LOCAL/lib64/python2.7/site-packages` that `lib64` is a bit of a problem. We'll have to dig in the configuration script as `libpolybori*` is installed correctly under `SAGE_LOCAL/lib`.


---

Comment by fbissey created at 2015-08-25 02:34:40

Adding 

```
AC_SUBST(pythondir)
```

in `configure.ac` (yes in lower case see http://www.gnu.org/software/automake/manual/html_node/Python.html) seem to have solved the problem. That or my autotools did a better job. I am successfully building the doc now, which is where things fell apart the first time.


---

Comment by fbissey created at 2015-08-25 02:56:24

Amusing, `polybori` was the last dependency pulling `scons`. Consequently my build from scratch doesn't include `scons` and the associated tests are failing. If we have an associated ticket for `scons` demotion to optional or removal it will depend on this one and vice-versa.

```
sage -t --long --warn-long 116.1 src/sage/tests/cmdline.py
**********************************************************************
File "src/sage/tests/cmdline.py", line 578, in sage.tests.cmdline.test_executable
Failed example:
    out.find("SCons") >= 0
Expected:
    True
Got:
    False
**********************************************************************
File "src/sage/tests/cmdline.py", line 580, in sage.tests.cmdline.test_executable
Failed example:
    err
Expected:
    ''
Got:
    'Traceback (most recent call last):\n  File "/usr/lib/python-exec/python2.7/scons", line 188, in <module>\n    import SCons.Script\nImportError: No module named SCons.Script\n'
**********************************************************************
File "src/sage/tests/cmdline.py", line 582, in sage.tests.cmdline.test_executable
Failed example:
    ret
Expected:
    0
Got:
    1
**********************************************************************
```



---

Comment by fbissey created at 2015-08-25 03:18:47

OK I have failing tests because `cnf.py` is not installed. It is the only one missing, I am guessing this is because it is not listed in `pyroot/Makefile.am` as I see it on github. However it is listed in the tarball you are linking from github. How did this happen? I cannot see a commit touching `pyroot/Makefile.am` other than the one moving it in `pyroot`.


---

Comment by fbissey created at 2015-08-25 03:28:37

And it wasn't included in the tarball for 0.8.4.


---

Comment by ohanar created at 2015-08-25 03:31:06

Replying to [comment:55 fbissey]:
> OK I have failing tests because `cnf.py` is not installed. It is the only one missing, I am guessing this is because it is not listed in `pyroot/Makefile.am` as I see it on github. However it is listed in the tarball you are linking from github. How did this happen? I cannot see a commit touching `pyroot/Makefile.am` other than the one moving it in `pyroot`.

Yes, I fixed that for 0.8.4.1, look at the tag on github. I probably had a staging commit that didn't include `cnf.py`, and somehow that is on the master branch.


---

Comment by fbissey created at 2015-08-25 03:34:29

OK see it under the tag but of course when I worked on the lib/lib64 I was working from master.


---

Comment by ohanar created at 2015-08-25 03:38:05

scons was already demoted to optional, but since we still had standard packages depending on it, it was in practice standard so these doctest errors weren't caught.

I fixed master with a force push (to reflect the correct commit). If you want to send a pull request fixing the lib64/lib issue, please do. I don't see it on OS X (obviously) and I don't have access to a decent linux box at the moment either.


---

Comment by fbissey created at 2015-08-25 04:48:33

Will send the pull request in a few hours when I can properly focus again.


---

Comment by jdemeyer created at 2015-08-25 06:29:53

Replying to [comment:54 fbissey]:
> {{{
> sage -t --long --warn-long 116.1 src/sage/tests/cmdline.py
> **********************************************************************
> File "src/sage/tests/cmdline.py", line 578, in sage.tests.cmdline.test_executable
> Failed example:
>     out.find("SCons") >= 0
> Expected:
>     True
> Got:
>     False
> **********************************************************************
> File "src/sage/tests/cmdline.py", line 580, in sage.tests.cmdline.test_executable
> Failed example:
>     err
> Expected:
>     ''
> Got:
>     'Traceback (most recent call last):\n  File "/usr/lib/python-exec/python2.7/scons", line 188, in <module>\n    import SCons.Script\nImportError: No module named SCons.Script\n'
> **********************************************************************
> File "src/sage/tests/cmdline.py", line 582, in sage.tests.cmdline.test_executable
> Failed example:
>     ret
> Expected:
>     0
> Got:
>     1
> **********************************************************************
> }}}
positive_review to a new ticket which just removes those 3 tests.


---

Comment by fbissey created at 2015-08-25 09:26:45

Replying to [comment:59 ohanar]:
> I fixed master with a force push (to reflect the correct commit). If you want to send a pull request fixing the lib64/lib issue, please do. I don't see it on OS X (obviously) and I don't have access to a decent linux box at the moment either.

Done. I may just take care of Jeroen's request - I will take it literally.


---

Comment by fbissey created at 2015-08-25 09:57:00

#19085 filled and we should depend on it.


---

Comment by git created at 2015-08-26 00:54:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-08-26 02:05:37

Building from scratch on a clean machine...


---

Comment by fbissey created at 2015-08-26 03:46:01

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2015-08-26 03:46:01

I think we are ready to go!


---

Comment by vbraun created at 2015-08-26 14:16:26

http://build.sagemath.org/release/builders/%20%20slow%20AIMS%20%20%28Debian%207%2032%20bit%29%20incremental/builds/71/steps/compile/logs/stdio


---

Comment by vbraun created at 2015-08-26 14:16:26

Changing status from positive_review to needs_work.


---

Comment by ohanar created at 2015-08-26 18:43:23

I'm guessing this issue comes down to not including the SIMD cflags of m4ri. I can't seem to figure out how to extract these from `<m4ri/m4ri_config.h>` using autotools. `@`fbissey any ideas?


---

Comment by fbissey created at 2015-08-26 19:55:00

If that's the case, yes I do have an idea. But I'll look at the log more in depth first. It looks like missing sse2 instruction but the build is i486 so it shouldn't have them either.


---

Comment by fbissey created at 2015-08-26 21:46:05

I think I know what to do, expect a pull request shortly.


---

Comment by malb created at 2015-08-27 08:06:23

Here is what I do in M4RIE 

  https://bitbucket.org/malb/m4rie/src/HEAD/m4/ax_m4ri_flags.m4?at=master

but I think this should be replaced by pkg-config like this

  https://autotools.io/pkgconfig/pkg_check_modules.html


---

Comment by fbissey created at 2015-08-27 08:38:16

Funny, I wrote what I called a vile hack but at some point it was looking very very close to that. I just didn't have the step to use `cat` afterwards. For some reason I didn't want to go that way.


---

Comment by git created at 2015-08-27 23:45:02

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ohanar created at 2015-08-27 23:46:12

Changing status from needs_work to needs_review.


---

Comment by ohanar created at 2015-08-27 23:46:12

ok, hopefully now fixed


---

Comment by fbissey created at 2015-08-28 01:09:09

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2015-08-28 12:12:14

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2015-08-28 12:12:14

Isn't this a typo?

```diff
+ $(INST)/$(BRAIL) \
```



---

Comment by fbissey created at 2015-08-28 12:22:13

Replying to [comment:78 jdemeyer]:
> Isn't this a typo?
> {{{
> #!diff
> + $(INST)/$(BRAIL) \
> }}}
Looks like one. I wonder how I got it to build "without that problem" on two different machines.


---

Comment by jdemeyer created at 2015-08-28 12:34:16

Replying to [comment:79 fbissey]:
> Looks like one. I wonder how I got it to build "without that problem" on two different machines.
`$(INST)/$(BRAIL)` becomes `$(INST)/` which is an existing directory...

The problem would start if you upgrade `$(BRIAL)`, then the Sage library would not be automatically rebuilt.


---

Comment by vbraun created at 2015-08-28 14:01:01

Here is a build failure because the dependencies are not correct, looks like the Sage library is built before brial:

http://build.sagemath.org/release/builders/%20%20slow%20Oxford%20ARM%20%28Ubuntu%2012.10%29%20incremental/builds/182/steps/compile/logs/stdio


---

Comment by git created at 2015-08-28 20:31:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by fbissey created at 2015-08-28 20:47:46

OK, positive review - take 3.


---

Comment by fbissey created at 2015-08-28 20:47:46

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-08-29 23:56:40

Resolution: fixed
