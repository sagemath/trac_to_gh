# Issue 23810: Polyhedron.affine_hull() raises AssertionError

archive/issues_023810.json:
```json
{
    "body": "CC:  @mkoeppe @mo271 @videlec @jplab\n\nThe method `affine_hull` of `Polyhedron` fails.\n\n```\nsage: P1 = Polyhedron(vertices=([[-1, 1], [0, -1], [0, 0], [-1, -1]]))\nsage: P2 = Polyhedron(vertices=[[1, 1], [1, -1], [0, -1], [0, 0]])\nsage: P = P1.intersection(P2)\nsage: A, b = P.affine_hull(as_affine_map=True, orthonormal=True, extend=True)\nAssertionError\n```\n\nThis is because the order of the vertices of P is changed by the translation by zero vector.\n\n```\nsage: P.vertices()\n(A vertex at (0, 0), A vertex at (0, -1))\nsage: P.translation(vector([0,0])).vertices()\n(A vertex at (0, -1), A vertex at (0, 0))\n```\n\nIssue created by migration from https://trac.sagemath.org/ticket/24047\n\n",
    "created_at": "2017-10-14T22:08:07Z",
    "labels": [
        "component: geometry",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.1",
    "title": "Polyhedron.affine_hull() raises AssertionError",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/23810",
    "user": "https://github.com/yuan-zhou"
}
```
CC:  @mkoeppe @mo271 @videlec @jplab

The method `affine_hull` of `Polyhedron` fails.

```
sage: P1 = Polyhedron(vertices=([[-1, 1], [0, -1], [0, 0], [-1, -1]]))
sage: P2 = Polyhedron(vertices=[[1, 1], [1, -1], [0, -1], [0, 0]])
sage: P = P1.intersection(P2)
sage: A, b = P.affine_hull(as_affine_map=True, orthonormal=True, extend=True)
AssertionError
```

This is because the order of the vertices of P is changed by the translation by zero vector.

```
sage: P.vertices()
(A vertex at (0, 0), A vertex at (0, -1))
sage: P.translation(vector([0,0])).vertices()
(A vertex at (0, -1), A vertex at (0, 0))
```

Issue created by migration from https://trac.sagemath.org/ticket/24047





---

archive/issue_comments_333200.json:
```json
{
    "body": "1) It would be bettter to sort the V and H generators so that this kind of troubles never appear (and equality test would be even faster)\n\n2) The `translation` method is stupidly written\n\n```\n    displacement = vector(displacement)\n    new_vertices = [x.vector()+displacement for x in self.vertex_generator()]\n    new_rays = self.rays()\n    new_lines = self.lines()\n    new_ring = self.parent()._coerce_base_ring(displacement)\n    return Polyhedron(vertices=new_vertices, rays=new_rays, lines=new_lines, base_ring=new_ring)\n```\nwe should not recompute anything!",
    "created_at": "2017-10-16T11:32:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333200",
    "user": "https://github.com/videlec"
}
```

1) It would be bettter to sort the V and H generators so that this kind of troubles never appear (and equality test would be even faster)

2) The `translation` method is stupidly written

```
    displacement = vector(displacement)
    new_vertices = [x.vector()+displacement for x in self.vertex_generator()]
    new_rays = self.rays()
    new_lines = self.lines()
    new_ring = self.parent()._coerce_base_ring(displacement)
    return Polyhedron(vertices=new_vertices, rays=new_rays, lines=new_lines, base_ring=new_ring)
```
we should not recompute anything!



---

archive/issue_comments_333201.json:
```json
{
    "body": "Replying to [comment:2 vdelecroix]:\n> we should not recompute anything!\n\n\nThat would require #22701 - Setting up a Polyhedron from both Vrep and Hrep.",
    "created_at": "2017-10-16T20:58:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333201",
    "user": "https://github.com/mkoeppe"
}
```

Replying to [comment:2 vdelecroix]:
> we should not recompute anything!


That would require #22701 - Setting up a Polyhedron from both Vrep and Hrep.



---

archive/issue_comments_333202.json:
```json
{
    "body": "`@`Moritz: You told me you would have a fix for this? It consists in what exactly?",
    "created_at": "2017-10-21T09:23:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333202",
    "user": "https://github.com/jplab"
}
```

`@`Moritz: You told me you would have a fix for this? It consists in what exactly?



---

archive/issue_comments_333203.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2017-10-23T09:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333203",
    "user": "https://github.com/mo271"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_333204.json:
```json
{
    "body": "This should fix at least the reported bug; it simply chooses the zero, instead of relying on the fact that it is the first in the list. \n\n---\nNew commits:",
    "created_at": "2017-10-23T09:21:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333204",
    "user": "https://github.com/mo271"
}
```

This should fix at least the reported bug; it simply chooses the zero, instead of relying on the fact that it is the first in the list. 

---
New commits:



---

archive/issue_comments_333205.json:
```json
{
    "body": "You have some tab characters (should be 4 spaces) and your indentation level is wrong:\n\n```\n       Check that :trac:`24047` is fixed::\n \n            sage: P1 = Polyhedron(vertices=([[-1, 1], [0, -1], [0, 0], [-1, -1]]))\n            sage: P2 = Polyhedron(vertices=[[1, 1], [1, -1], [0, -1], [0, 0]])\n            sage: P = P1.intersection(P2)\n            sage: A, b = P.affine_hull(as_affine_map=True, orthonormal=True, extend=True)\n```",
    "created_at": "2017-10-23T13:22:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333205",
    "user": "https://github.com/tscrim"
}
```

You have some tab characters (should be 4 spaces) and your indentation level is wrong:

```
       Check that :trac:`24047` is fixed::
 
            sage: P1 = Polyhedron(vertices=([[-1, 1], [0, -1], [0, 0], [-1, -1]]))
            sage: P2 = Polyhedron(vertices=[[1, 1], [1, -1], [0, -1], [0, 0]])
            sage: P = P1.intersection(P2)
            sage: A, b = P.affine_hull(as_affine_map=True, orthonormal=True, extend=True)
```



---

archive/issue_comments_333206.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-10-23T13:22:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333206",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_333207.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2017-10-23T13:34:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333207",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_333208.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2017-10-23T13:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333208",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_333209.json:
```json
{
    "body": "uups, I used a different editor, which changed spaces by tabs..\nShould be fixed now.",
    "created_at": "2017-10-23T13:40:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333209",
    "user": "https://github.com/mo271"
}
```

uups, I used a different editor, which changed spaces by tabs..
Should be fixed now.



---

archive/issue_comments_333210.json:
```json
{
    "body": "`that we really Q really` -> `that Q really`?\n\nOtherwise, it looks good to me and the bot is happy so I would put it as positive review once the small mistake above is corrected.\n\nThanks for the quick fix!",
    "created_at": "2017-11-10T15:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333210",
    "user": "https://github.com/jplab"
}
```

`that we really Q really` -> `that Q really`?

Otherwise, it looks good to me and the bot is happy so I would put it as positive review once the small mistake above is corrected.

Thanks for the quick fix!



---

archive/issue_comments_333211.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2017-11-10T15:38:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333211",
    "user": "https://github.com/jplab"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_333212.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2017-11-10T15:59:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333212",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_333213.json:
```json
{
    "body": "Changing status from needs_work to positive_review.",
    "created_at": "2017-11-10T16:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333213",
    "user": "https://github.com/mo271"
}
```

Changing status from needs_work to positive_review.



---

archive/issue_comments_333214.json:
```json
{
    "body": "thanks for the review, JP!",
    "created_at": "2017-11-10T16:04:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333214",
    "user": "https://github.com/mo271"
}
```

thanks for the review, JP!



---

archive/issue_comments_333215.json:
```json
{
    "body": "reviewer name, please",
    "created_at": "2017-11-15T12:21:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333215",
    "user": "https://github.com/fchapoton"
}
```

reviewer name, please



---

archive/issue_events_061120.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2017-12-11T01:03:30Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/23810#event-61120"
}
```



---

archive/issue_comments_333216.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2017-12-11T01:03:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/23810",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/23810#issuecomment-333216",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
