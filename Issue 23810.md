# Issue 23810: Polyhedron.affine_hull() raises AssertionError

Issue created by migration from https://trac.sagemath.org/ticket/24047

Original creator: yzh

Original creation time: 2017-10-14 22:08:07

CC:  mkoeppe moritz vdelecroix jipilab

The method `affine_hull` of `Polyhedron` fails.

```
sage: P1 = Polyhedron(vertices=([[-1, 1], [0, -1], [0, 0], [-1, -1]]))
sage: P2 = Polyhedron(vertices=[[1, 1], [1, -1], [0, -1], [0, 0]])
sage: P = P1.intersection(P2)
sage: A, b = P.affine_hull(as_affine_map=True, orthonormal=True, extend=True)
AssertionError
```


This is because the order of the vertices of P is changed by the translation by zero vector.

```
sage: P.vertices()
(A vertex at (0, 0), A vertex at (0, -1))
sage: P.translation(vector([0,0])).vertices()
(A vertex at (0, -1), A vertex at (0, 0))
```



---

Comment by vdelecroix created at 2017-10-16 11:32:00

1) It would be bettter to sort the V and H generators so that this kind of troubles never appear (and equality test would be even faster)

2) The `translation` method is stupidly written

```
    displacement = vector(displacement)
    new_vertices = [x.vector()+displacement for x in self.vertex_generator()]
    new_rays = self.rays()
    new_lines = self.lines()
    new_ring = self.parent()._coerce_base_ring(displacement)
    return Polyhedron(vertices=new_vertices, rays=new_rays, lines=new_lines, base_ring=new_ring)
```

we should not recompute anything!


---

Comment by mkoeppe created at 2017-10-16 20:58:38

Replying to [comment:2 vdelecroix]:
> we should not recompute anything!

That would require #22701 - Setting up a Polyhedron from both Vrep and Hrep.


---

Comment by jipilab created at 2017-10-21 09:23:01

`@`Moritz: You told me you would have a fix for this? It consists in what exactly?


---

Comment by moritz created at 2017-10-23 09:21:50

Changing status from new to needs_review.


---

Comment by moritz created at 2017-10-23 09:21:50

This should fix at least the reported bug; it simply chooses the zero, instead of relying on the fact that it is the first in the list. 
----
New commits:


---

Comment by tscrim created at 2017-10-23 13:22:21

You have some tab characters (should be 4 spaces) and your indentation level is wrong:

```
       Check that :trac:`24047` is fixed::
 
            sage: P1 = Polyhedron(vertices=([[-1, 1], [0, -1], [0, 0], [-1, -1]]))
            sage: P2 = Polyhedron(vertices=[[1, 1], [1, -1], [0, -1], [0, 0]])
            sage: P = P1.intersection(P2)
            sage: A, b = P.affine_hull(as_affine_map=True, orthonormal=True, extend=True)
```



---

Comment by tscrim created at 2017-10-23 13:22:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-10-23 13:34:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by moritz created at 2017-10-23 13:40:44

Changing status from needs_work to needs_review.


---

Comment by moritz created at 2017-10-23 13:40:44

uups, I used a different editor, which changed spaces by tabs..
Should be fixed now.


---

Comment by jipilab created at 2017-11-10 15:38:34

`that we really Q really` -> `that Q really`?

Otherwise, it looks good to me and the bot is happy so I would put it as positive review once the small mistake above is corrected.

Thanks for the quick fix!


---

Comment by jipilab created at 2017-11-10 15:38:34

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-11-10 15:59:32

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by moritz created at 2017-11-10 16:04:01

Changing status from needs_work to positive_review.


---

Comment by moritz created at 2017-11-10 16:04:01

thanks for the review, JP!


---

Comment by chapoton created at 2017-11-15 12:21:33

reviewer name, please


---

Comment by vbraun created at 2017-12-11 01:03:30

Resolution: fixed
