# Issue 33699: Remove runtime dependency on sage_docbuild introduced in #33763

Issue created by migration from https://trac.sagemath.org/ticket/33936

Original creator: mkoeppe

Original creation time: 2022-05-29 18:40:02

CC:  klee jhpalmieri arojas

(from #33763#comment:19)


---

Comment by mkoeppe created at 2022-06-10 00:38:15

New commits:


---

Comment by mkoeppe created at 2022-06-10 00:53:50

This one setting is what is needed to pass the doctests of `sage.misc.sagedoc`.
Not sure what else is needed


---

Comment by klee created at 2022-06-10 01:46:51

I was waiting for the next beta that is merged with #33922, before I start to work on this ticket.

I think many more settings in `sage_docbuild/conf.py` need to move into `sage/misc/sagedoc_conf.py`, in anticipation of #33682.


---

Comment by git created at 2022-06-17 03:21:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-17 03:22:22

Changing status from new to needs_review.


---

Comment by git created at 2022-06-17 03:38:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-17 03:41:16

I moved more settings which seem to have been used by `sphinxify`.


---

Comment by mkoeppe created at 2022-06-17 19:09:04

I'm not very comfortable with the use of the `os.environ` variables in sagedoc_conf. I think it would be best if this was done in the docbuild only


---

Comment by klee created at 2022-06-18 08:47:30

Replying to [comment:13 mkoeppe]:
> I'm not very comfortable with the use of the `os.environ` variables in sagedoc_conf. I think it would be best if this was done in the docbuild only

`os.environ` is used in two places: 

(1) in `skip_member()`: `skip_member()` skips problematic members of a module.

(2) in `setup()` to decide whether or not to include `skip_TESTS_block()`: `skip_TESTS_block()` skips `TESTS:` blocks.

For (1), `SAGE_CHECK_NESTED` and `SAGE_DOC_UNDERSCORE` environment variables are used

For (2), `SAGE_SKIP_TESTS_BLOCKS` environment variables is used.

If we decide on the defaults to these 3 variables, then we can remove them from `sagedoc_conf`. What would be reasonable defaults?


---

Comment by klee created at 2022-06-18 10:21:19

Replying to [comment:14 klee]:
> If we decide on the defaults to these 3 variables, then we can remove them from `sagedoc_conf`. What would be reasonable defaults? 

We may remove `skip_member()` altogether, and include `skip_TESTS_block()`.


---

Comment by git created at 2022-06-18 10:22:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-06-19 20:36:43

Replying to [comment:16 git]:
> Branch pushed to git repo; I updated commit sha1. New commits:
> ||[c2766bf](https://git.sagemath.org/sage.git/commit/?id=c2766bf33ecbd487f39eace9a8cc9ddb2102a0d2)||`Move skip_member() to sage_docbuild`||

It's not completely moved it seems


```
sage: integrate?
---------------------------------------------------------------------------
NameError                                 Traceback (most recent call last)
Input In [1], in <cell line: 1>()
----> 1 get_ipython().run_line_magic('pinfo', 'integrate')

[...]

File /usr/lib/python3.10/site-packages/sage/misc/sagedoc_conf.py:160, in setup(app)
    158 app.connect('autodoc-process-docstring', process_inherited)
    159 app.connect('autodoc-process-docstring', skip_TESTS_block)
--> 160 app.connect('autodoc-skip-member', skip_member)
    161 app.add_transform(SagemathTransform)

NameError: name 'skip_member' is not defined
```



---

Comment by git created at 2022-06-20 00:28:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-20 00:30:03

Replying to [comment:17 arojas]:
> It's not completely moved it seems

Obviously my mistake. Fixed now.


---

Comment by mkoeppe created at 2022-06-25 22:02:13


```
+    assert app.srcdir.startswith(SAGE_DOC_SRC)
```

I think this is not a good change because `sage -docbuild` is also used by user packages


---

Comment by git created at 2022-06-26 10:31:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by klee created at 2022-06-26 10:33:15

Replying to [comment:20 mkoeppe]:
> {{{
> +    assert app.srcdir.startswith(SAGE_DOC_SRC)
> }}}
> I think this is not a good change because `sage -docbuild` is also used by user packages 

Okay. Removed `assert` and restored `if`.


---

Comment by mkoeppe created at 2022-06-29 23:20:30

positive review from my side


---

Comment by klee created at 2022-06-30 00:29:46

Thank you.


---

Comment by klee created at 2022-06-30 00:29:46

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-07-09 22:33:58

Resolution: fixed
