# Issue 26918: Simplify libGAP error handling

Issue created by migration from https://trac.sagemath.org/ticket/27155

Original creator: jdemeyer

Original creation time: 2019-01-28 08:43:15

CC:  vbraun embray

In various places in the libGAP interface, there is code of the form

```
        try:
            ...
        except RuntimeError as msg:
            raise ValueError('libGAP: '+str(msg))
```

It's not clear to me why we need to catch and re-raise an exception here.

Instead, we are raising this exception in our `error_handler`, so we can just use a custom exception class.


---

Comment by git created at 2019-01-28 10:42:26

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jdemeyer created at 2019-01-28 10:42:56

Changing status from new to needs_review.


---

Comment by git created at 2019-01-28 10:57:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-28 11:47:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2019-01-28 11:59:00

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2019-01-28 13:01:43

Thanks for tracking that down--I didn't realize that about `PyErr_Fetch`; I was careless there about reference counts and just assume for some reason that it returned borrowed references.  Except the documentation is quite clear about this:

> If it is set, it will be cleared and you own a reference to each object retrieved. 

The `GapError` stuff looks good too--at one point I think I considered doing something similar, but at the time was trying to avoid too many changes like this one where there would be hundreds of little find/replaces obscuring the more important changes.


---

Comment by embray created at 2019-01-28 13:01:43

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2019-02-05 15:18:42

To the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.


---

Comment by vbraun created at 2019-02-05 23:10:47

I got this with all three....

```
**********************************************************************
File "src/sage/modular/abvar/torsion_subgroup.py", line 46, in sage.modular.abvar.torsion_subgroup
Failed example:
    for N in range(1,38):
       for A in J0(N).new_subvariety().decomposition():
           T = A.rational_torsion_subgroup()
           print('%-5s%-5s%-5s%-5s'%(N, A.dimension(), T.divisor_of_order(), T.multiple_of_order()))
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.abvar.torsion_subgroup[9]>", line 2, in <module>
        for A in J0(N).new_subvariety().decomposition():
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar.py", line 4441, in new_subvariety
        A = self.modular_symbols()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar.py", line 4198, in modular_symbols
        M = self._modular_symbols().modular_symbols_of_sign(sign)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar_ambient_jacobian.py", line 111, in _modular_symbols
        self.__modsym = ModularSymbols(self.__group, weight=2).cuspidal_submodule()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/modsym.py", line 358, in ModularSymbols
        group.level(),sign, base_ring, custom_init=custom_init)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 2772, in __init__
        custom_init=custom_init, category=category)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 2495, in __init__
        custom_init=custom_init, category=category)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 189, in __init__
        rank = self.rank()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 1559, in rank
        self.__rank = len(self.manin_basis())
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 279, in manin_basis
        self.compute_presentation()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 313, in compute_presentation
        self.base_ring())
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py", line 452, in compute_presentation
        B, basis = gens_to_basis_matrix(syms, R, mod, field, sparse)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py", line 313, in gens_to_basis_matrix
        height_guess=1)
      File "sage/matrix/matrix_rational_sparse.pyx", line 545, in sage.matrix.matrix_rational_sparse.Matrix_rational_sparse.echelon_form (build/cythonized/sage/matrix/matrix_rational_sparse.c:7025)
        E, pivots = self._echelon_form_multimodular(height_guess, proof=proof)
      File "sage/matrix/matrix_rational_sparse.pyx", line 572, in sage.matrix.matrix_rational_sparse.Matrix_rational_sparse._echelon_form_multimodular (build/cythonized/sage/matrix/matrix_rational_sparse.c:7517)
        E, pivots = matrix_rational_echelon_form_multimodular(self,
      File "sage/matrix/misc.pyx", line 419, in sage.matrix.misc.matrix_rational_echelon_form_multimodular (build/cythonized/sage/matrix/misc.c:7659)
        E = L.rational_reconstruction(prod)
      File "sage/matrix/matrix_integer_sparse.pyx", line 358, in sage.matrix.matrix_integer_sparse.Matrix_integer_sparse.rational_reconstruction (build/cythonized/sage/matrix/matrix_integer_sparse.cpp:6987)
        return matrix_integer_sparse_rational_reconstruction(self, N)
      File "sage/matrix/misc.pyx", line 182, in sage.matrix.misc.matrix_integer_sparse_rational_reconstruction (build/cythonized/sage/matrix/misc.c:4929)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
**********************************************************************
1 item had failures:
   1 of  13 in sage.modular.abvar.torsion_subgroup
    [86 tests, 1 failure, 4.33 s]
----------------------------------------------------------------------
sage -t --long src/sage/modular/abvar/torsion_subgroup.py  # 1 doctest failed
----------------------------------------------------------------------
```

For my sanity I would prefer to do any further work on a separate ticket after the three are merged, though.


---

Comment by jdemeyer created at 2019-02-06 06:14:00

Replying to [comment:12 vbraun]:
> I got this with all three....

That's #27224.


---

Comment by vbraun created at 2019-02-06 10:39:17

Resolution: fixed
