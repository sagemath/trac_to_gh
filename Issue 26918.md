# Issue 26918: Simplify libGAP error handling

archive/issues_026918.json:
```json
{
    "body": "CC:  @vbraun @embray\n\nIn various places in the libGAP interface, there is code of the form\n\n```\n        try:\n            ...\n        except RuntimeError as msg:\n            raise ValueError('libGAP: '+str(msg))\n```\n\nIt's not clear to me why we need to catch and re-raise an exception here.\n\nInstead, we are raising this exception in our `error_handler`, so we can just use a custom exception class.\n\nIssue created by migration from https://trac.sagemath.org/ticket/27155\n\n",
    "created_at": "2019-01-28T08:43:15Z",
    "labels": [
        "component: interfaces"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.7",
    "title": "Simplify libGAP error handling",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26918",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @vbraun @embray

In various places in the libGAP interface, there is code of the form

```
        try:
            ...
        except RuntimeError as msg:
            raise ValueError('libGAP: '+str(msg))
```

It's not clear to me why we need to catch and re-raise an exception here.

Instead, we are raising this exception in our `error_handler`, so we can just use a custom exception class.

Issue created by migration from https://trac.sagemath.org/ticket/27155





---

archive/issue_comments_378344.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-28T10:42:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378344",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378345.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2019-01-28T10:42:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378345",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_378346.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-28T10:57:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378346",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378347.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-28T11:47:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378347",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378348.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2019-01-28T11:59:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378348",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_378349.json:
```json
{
    "body": "Thanks for tracking that down--I didn't realize that about `PyErr_Fetch`; I was careless there about reference counts and just assume for some reason that it returned borrowed references.  Except the documentation is quite clear about this:\n\n> If it is set, it will be cleared and you own a reference to each object retrieved. \n\nThe `GapError` stuff looks good too--at one point I think I considered doing something similar, but at the time was trying to avoid too many changes like this one where there would be hundreds of little find/replaces obscuring the more important changes.",
    "created_at": "2019-01-28T13:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378349",
    "user": "https://github.com/embray"
}
```

Thanks for tracking that down--I didn't realize that about `PyErr_Fetch`; I was careless there about reference counts and just assume for some reason that it returned borrowed references.  Except the documentation is quite clear about this:

> If it is set, it will be cleared and you own a reference to each object retrieved. 

The `GapError` stuff looks good too--at one point I think I considered doing something similar, but at the time was trying to avoid too many changes like this one where there would be hundreds of little find/replaces obscuring the more important changes.



---

archive/issue_comments_378350.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2019-01-28T13:01:43Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378350",
    "user": "https://github.com/embray"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_378351.json:
```json
{
    "body": "To the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.",
    "created_at": "2019-02-05T15:18:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378351",
    "user": "https://github.com/jdemeyer"
}
```

To the release manager: tickets #26992, #27155 and #27140 should be merged together to avoid test failures.



---

archive/issue_comments_378352.json:
```json
{
    "body": "I got this with all three....\n\n```\n**********************************************************************\nFile \"src/sage/modular/abvar/torsion_subgroup.py\", line 46, in sage.modular.abvar.torsion_subgroup\nFailed example:\n    for N in range(1,38):\n       for A in J0(N).new_subvariety().decomposition():\n           T = A.rational_torsion_subgroup()\n           print('%-5s%-5s%-5s%-5s'%(N, A.dimension(), T.divisor_of_order(), T.multiple_of_order()))\nException raised:\n    Traceback (most recent call last):\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 671, in _run\n        self.compile_and_execute(example, compiler, test.globs)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py\", line 1095, in compile_and_execute\n        exec(compiled, globs)\n      File \"<doctest sage.modular.abvar.torsion_subgroup[9]>\", line 2, in <module>\n        for A in J0(N).new_subvariety().decomposition():\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar.py\", line 4441, in new_subvariety\n        A = self.modular_symbols()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar.py\", line 4198, in modular_symbols\n        M = self._modular_symbols().modular_symbols_of_sign(sign)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar_ambient_jacobian.py\", line 111, in _modular_symbols\n        self.__modsym = ModularSymbols(self.__group, weight=2).cuspidal_submodule()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/modsym.py\", line 358, in ModularSymbols\n        group.level(),sign, base_ring, custom_init=custom_init)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py\", line 2772, in __init__\n        custom_init=custom_init, category=category)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py\", line 2495, in __init__\n        custom_init=custom_init, category=category)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py\", line 189, in __init__\n        rank = self.rank()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py\", line 1559, in rank\n        self.__rank = len(self.manin_basis())\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py\", line 279, in manin_basis\n        self.compute_presentation()\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py\", line 313, in compute_presentation\n        self.base_ring())\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py\", line 452, in compute_presentation\n        B, basis = gens_to_basis_matrix(syms, R, mod, field, sparse)\n      File \"/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py\", line 313, in gens_to_basis_matrix\n        height_guess=1)\n      File \"sage/matrix/matrix_rational_sparse.pyx\", line 545, in sage.matrix.matrix_rational_sparse.Matrix_rational_sparse.echelon_form (build/cythonized/sage/matrix/matrix_rational_sparse.c:7025)\n        E, pivots = self._echelon_form_multimodular(height_guess, proof=proof)\n      File \"sage/matrix/matrix_rational_sparse.pyx\", line 572, in sage.matrix.matrix_rational_sparse.Matrix_rational_sparse._echelon_form_multimodular (build/cythonized/sage/matrix/matrix_rational_sparse.c:7517)\n        E, pivots = matrix_rational_echelon_form_multimodular(self,\n      File \"sage/matrix/misc.pyx\", line 419, in sage.matrix.misc.matrix_rational_echelon_form_multimodular (build/cythonized/sage/matrix/misc.c:7659)\n        E = L.rational_reconstruction(prod)\n      File \"sage/matrix/matrix_integer_sparse.pyx\", line 358, in sage.matrix.matrix_integer_sparse.Matrix_integer_sparse.rational_reconstruction (build/cythonized/sage/matrix/matrix_integer_sparse.cpp:6987)\n        return matrix_integer_sparse_rational_reconstruction(self, N)\n      File \"sage/matrix/misc.pyx\", line 182, in sage.matrix.misc.matrix_integer_sparse_rational_reconstruction (build/cythonized/sage/matrix/misc.c:4929)\n        sig_on()\n    SystemError: calling remove_from_pari_stack() inside sig_on()\n**********************************************************************\n1 item had failures:\n   1 of  13 in sage.modular.abvar.torsion_subgroup\n    [86 tests, 1 failure, 4.33 s]\n----------------------------------------------------------------------\nsage -t --long src/sage/modular/abvar/torsion_subgroup.py  # 1 doctest failed\n----------------------------------------------------------------------\n```\n\nFor my sanity I would prefer to do any further work on a separate ticket after the three are merged, though.",
    "created_at": "2019-02-05T23:10:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378352",
    "user": "https://github.com/vbraun"
}
```

I got this with all three....

```
**********************************************************************
File "src/sage/modular/abvar/torsion_subgroup.py", line 46, in sage.modular.abvar.torsion_subgroup
Failed example:
    for N in range(1,38):
       for A in J0(N).new_subvariety().decomposition():
           T = A.rational_torsion_subgroup()
           print('%-5s%-5s%-5s%-5s'%(N, A.dimension(), T.divisor_of_order(), T.multiple_of_order()))
Exception raised:
    Traceback (most recent call last):
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 671, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 1095, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.abvar.torsion_subgroup[9]>", line 2, in <module>
        for A in J0(N).new_subvariety().decomposition():
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar.py", line 4441, in new_subvariety
        A = self.modular_symbols()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar.py", line 4198, in modular_symbols
        M = self._modular_symbols().modular_symbols_of_sign(sign)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/abvar/abvar_ambient_jacobian.py", line 111, in _modular_symbols
        self.__modsym = ModularSymbols(self.__group, weight=2).cuspidal_submodule()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/modsym.py", line 358, in ModularSymbols
        group.level(),sign, base_ring, custom_init=custom_init)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 2772, in __init__
        custom_init=custom_init, category=category)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 2495, in __init__
        custom_init=custom_init, category=category)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 189, in __init__
        rank = self.rank()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 1559, in rank
        self.__rank = len(self.manin_basis())
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 279, in manin_basis
        self.compute_presentation()
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 313, in compute_presentation
        self.base_ring())
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py", line 452, in compute_presentation
        B, basis = gens_to_basis_matrix(syms, R, mod, field, sparse)
      File "/var/lib/buildbot/slave/sage_git/build/local/lib/python2.7/site-packages/sage/modular/modsym/relation_matrix.py", line 313, in gens_to_basis_matrix
        height_guess=1)
      File "sage/matrix/matrix_rational_sparse.pyx", line 545, in sage.matrix.matrix_rational_sparse.Matrix_rational_sparse.echelon_form (build/cythonized/sage/matrix/matrix_rational_sparse.c:7025)
        E, pivots = self._echelon_form_multimodular(height_guess, proof=proof)
      File "sage/matrix/matrix_rational_sparse.pyx", line 572, in sage.matrix.matrix_rational_sparse.Matrix_rational_sparse._echelon_form_multimodular (build/cythonized/sage/matrix/matrix_rational_sparse.c:7517)
        E, pivots = matrix_rational_echelon_form_multimodular(self,
      File "sage/matrix/misc.pyx", line 419, in sage.matrix.misc.matrix_rational_echelon_form_multimodular (build/cythonized/sage/matrix/misc.c:7659)
        E = L.rational_reconstruction(prod)
      File "sage/matrix/matrix_integer_sparse.pyx", line 358, in sage.matrix.matrix_integer_sparse.Matrix_integer_sparse.rational_reconstruction (build/cythonized/sage/matrix/matrix_integer_sparse.cpp:6987)
        return matrix_integer_sparse_rational_reconstruction(self, N)
      File "sage/matrix/misc.pyx", line 182, in sage.matrix.misc.matrix_integer_sparse_rational_reconstruction (build/cythonized/sage/matrix/misc.c:4929)
        sig_on()
    SystemError: calling remove_from_pari_stack() inside sig_on()
**********************************************************************
1 item had failures:
   1 of  13 in sage.modular.abvar.torsion_subgroup
    [86 tests, 1 failure, 4.33 s]
----------------------------------------------------------------------
sage -t --long src/sage/modular/abvar/torsion_subgroup.py  # 1 doctest failed
----------------------------------------------------------------------
```

For my sanity I would prefer to do any further work on a separate ticket after the three are merged, though.



---

archive/issue_comments_378353.json:
```json
{
    "body": "Replying to [comment:12 vbraun]:\n> I got this with all three....\n\nThat's #27224.",
    "created_at": "2019-02-06T06:14:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378353",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:12 vbraun]:
> I got this with all three....

That's #27224.



---

archive/issue_comments_378354.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2019-02-06T10:39:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26918#issuecomment-378354",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_067419.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2019-02-06T10:39:17Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/26918",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/26918#event-67419"
}
```
