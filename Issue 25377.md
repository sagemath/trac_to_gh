# Issue 25377: 2 internet doctest failing in misc/persist.pyx

Issue created by migration from Trac.

Original creator: slabbe

Original creation time: 2018-06-19 20:37:51

CC:  vklein

With 8.3.beta6,


```
sage -t --long --optional=sage,internet src/sage/misc/persist.pyx
```


gives


```
sage -t --long src/sage/misc/persist.pyx
**********************************************************************
File "src/sage/misc/persist.pyx", line 78, in sage.misc.persist.load
Failed example:
    s = load(u)                                                  # optional - internet
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.persist.load[1]>", line 1, in <module>
        s = load(u)                                                  # optional - internet
      File "sage/misc/persist.pyx", line 139, in sage.misc.persist.load (build/cythonized/sage/misc/persist.c:2409)

...

      File "/home/slabbe/GitBox/sage/local/lib/python2.7/socket.py", line 559, in create_connection
        for res in getaddrinfo(host, port, 0, SOCK_STREAM):
    IOError: [Errno socket error] [Errno -2] Name or service not known
**********************************************************************
File "src/sage/misc/persist.pyx", line 81, in sage.misc.persist.load
Failed example:
    s                                                            # optional - internet
Exception raised:
    Traceback (most recent call last):
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 573, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/slabbe/GitBox/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 983, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.misc.persist.load[2]>", line 1, in <module>
        s                                                            # optional - internet
    NameError: name 's' is not defined
**********************************************************************
1 item had failures:
   2 of  20 in sage.misc.persist.load
    [99 tests, 2 failures, 1.14 s]
----------------------------------------------------------------------
sage -t --long src/sage/misc/persist.pyx  # 2 doctests failed
----------------------------------------------------------------------
Total time for all tests: 2.2 seconds
    cpu time: 0.6 seconds
    cumulative wall time: 1.1 seconds
External software detected for doctesting: internet
```



---

Comment by slabbe created at 2018-08-25 13:28:33

The failing doctest is:

```
        sage: u = 'http://sage.math.washington.edu/home/was/db/test.sobj'
        sage: s = load(u)                                                  # optional - internet
        Attempting to load remote file: http://sage.math.washington.edu/home/was/db/test.sobj
        Loading: [.]
        sage: s                                                            # optional - internet
        'hello SAGE'
```


The link is broken:


```
$ wget http://sage.math.washington.edu/home/was/db/test.sobj
--2018-08-25 15:26:08--  http://sage.math.washington.edu/home/was/db/test.sobj
Résolution de sage.math.washington.edu (sage.math.washington.edu)… échec : Nom ou service inconnu.
wget : impossible de résoudre l’adresse de l’hôte «sage.math.washington.edu»
```



---

Comment by slabbe created at 2018-09-01 08:55:13

New commits:


---

Comment by slabbe created at 2018-09-01 08:59:32

I updated the adress of the file in the doctest.

Unfortunately, there is now another error:


```
sage: u = 'http://www.sagemath.org/files/test.sobj'
sage: load(u)
Attempting to load remote file: http://www.sagemath.org/files/test.sobj
Loading: []
Traceback (most recent call last)
...
UnpicklingError: invalid load key, '<'.
```


maybe because the way I suggested Harald to create the file test.sobj was wrong? Strange because if I `wget` the file and `load` from present working directory then it works.

Help needed!


---

Comment by git created at 2019-02-28 08:50:35

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by slabbe created at 2019-02-28 08:52:46

The fix I proposed months ago now works! Maybe because of #25535, the problem `invalid load key` disappeared. Needs review!


---

Comment by slabbe created at 2019-02-28 08:52:46

Changing status from new to needs_review.


---

Comment by slabbe created at 2019-02-28 08:52:46

Changing keywords from "" to "thursdaysbdx".


---

Comment by vklein created at 2019-02-28 08:54:07

Set assignee to vklein.


---

Comment by vklein created at 2019-02-28 09:14:07

Remove assignee vklein.


---

Comment by vklein created at 2019-02-28 09:14:18

Changing status from needs_review to positive_review.


---

Comment by vklein created at 2019-02-28 09:14:18

Looks good to me.


---

Comment by vbraun created at 2019-03-02 09:39:24

Resolution: fixed
