# Issue 19207: sage.misc.functional.log(float(3)) raises an AttributeError

Issue created by migration from https://trac.sagemath.org/ticket/19444

Original creator: slabbe

Original creation time: 2015-10-21 08:07:02

CC:  tscrim jdemeyer jhpalmieri

`import_statements` suggest to import `log` this way:


```
sage: import_statements('log')
# **Warning**: distinct objects with name 'log' in:
#   - sage.functions.log
#   - math
#   - sage.functions
#   - sage.misc.functional
from sage.misc.functional import log
```


While those works:


```
sage: math.log(float(3))
1.0986122886681098
sage: sage.functions.log.log(float(3))
1.0986122886681098
```


This one raises an `AttributeError`:


```
sage: sage.misc.functional.log(float(3))
Traceback (most recent call last):
...
AttributeError: 'sage.rings.real_double.RealDoubleElement' object has no attribute '_log_base'
```


A subquestion is why do we have two implementations of `log`?


---

Comment by chapoton created at 2017-09-03 19:59:07

Changing status from new to needs_review.


---

Comment by chapoton created at 2017-09-03 19:59:07

Done. This should be an easy review.

NOTA BENE: Getting rid of this log function (in favor of the one in functions.log) should be done in another ticket. I tried to do that, but sutmbled on the infamous import hell (import cycles everywhere).
----
New commits:


---

Comment by vdelecroix created at 2017-09-03 21:09:01

This implementation is very weak. How can you assume that this is supposed to be the real logarithm?

```
sage: sage.misc.functional.log(complex(3j))
Traceback (most recent call last):
...
TypeError: can't convert complex to float
```

versus

```
sage: sage.misc.functional.log(CDF(0,3))
1.0986122886681098 + 1.5707963267948966*I
```



---

Comment by chapoton created at 2017-09-04 05:56:51

There is no need to make another perfect log, there is one already in functions.log, which is the one we provide as "log" in the global namespace. We should fix the issue raised here. And later get rid of this function, which is only used 10 times or so.


---

Comment by vdelecroix created at 2017-09-04 06:06:36

What is the point of fixing an issue on a useless function? If I open a ticket for the complex case will you fix it ;-? If useless, the log from functional would better be deprecated and this ticket closed as invalid.

Anyway, the complaint is about `import_statements` that is not fixed by your branch.


---

Comment by vdelecroix created at 2017-09-04 06:11:27

And indeed, there is something wrong with `find_objects_from_name`

```
sage: 
sage: from sage.misc.dev_tools import find_objects_from_name
sage: find_objects_from_name('log')
[<function log at ...>,
 <function log at ...>,
 log,
 <built-in function log>,
 <module 'sage.functions.log' from '/opt/sage/local/lib/python2.7/site-packages/sage/functions/log.pyc'>]
```

The above is wrong since `log` is in the global namespace and the answer should have been the log from the global namespace...


---

Comment by vdelecroix created at 2017-09-04 06:14:27

And indeed, `globals()` is restricted to the module where the function is defined... so that its usage is wrong.


---

Comment by vdelecroix created at 2017-09-04 06:42:21

See #23779 for the fix to `import_statements`


---

Comment by git created at 2017-09-04 07:03:39

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by chapoton created at 2017-09-04 07:04:25

ok, done


---

Comment by git created at 2017-09-04 11:23:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by slabbe created at 2017-09-04 12:07:45

If it turns out that for some reason I have used the bad log function in my code and I now get the following error message:

```
DeprecationWarning: this version of log is no longer used
```

I will not understand and I will lose time to understand what is happening.

I much prefer

```
DeprecationWarning: function sage.misc.functional.log is deprecated, use sage.functions.log or log from the global sage namespace instead
```



---

Comment by slabbe created at 2017-09-04 12:07:45

Changing status from needs_review to needs_work.


---

Comment by git created at 2017-09-04 12:10:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-04 12:11:10

Done


---

Comment by chapoton created at 2017-09-04 12:11:10

Changing status from needs_work to needs_review.


---

Comment by jdemeyer created at 2017-09-04 12:16:15

This is wrong:

```diff
-        k = int(ceil(log(n,2)))
+        k = int(ceil(RDF(n).log(2)))
```

Do not use floating-point computations when you want an exact answer.

An exception to this would be MPFR (used in Sage by `RR`) because that does give a guarantee of exactness if possible.

So, you should either use `ZZ` or `RR` to do this computation.


---

Comment by jdemeyer created at 2017-09-04 12:16:26

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2017-09-04 12:21:51

I would replace `ceil(log(n,2))` by `(ZZ(n) - 1).nbits()` which is guaranteed to be correct and reasonably fast.


---

Comment by git created at 2017-09-04 18:48:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-04 20:14:44

ok ; but now there remains an RDF in "src/sage/rings/finite_rings/element_ntl_gf2e.pyx"


---

Comment by git created at 2017-09-06 11:50:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-06 11:50:41

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2017-09-06 11:50:41

should be good now


---

Comment by jdemeyer created at 2017-09-06 11:53:32

In the light of `__future__ division`, it is better to use `// 8` instead of `/ 8`.


---

Comment by git created at 2017-09-06 14:05:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2017-09-06 14:05:41

done


---

Comment by chapoton created at 2017-09-06 16:21:21

bot is morally green


---

Comment by slabbe created at 2017-09-11 13:19:26

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-09-15 07:47:39

Resolution: fixed
