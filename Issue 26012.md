# Issue 26012: port Sage to FreeBSD 12

Issue created by migration from https://trac.sagemath.org/ticket/26249

Original creator: dimpase

Original creation time: 2018-09-11 16:03:18

CC:  mkoeppe

In FreeBSD 12 the long-standing incompleteness of its libm has been helped. This simplifies a lot, compared to #22679.

We will not try to work around the toolchain [problem related to gfortran/libgcc_s](https://wiki.freebsd.org/libgcc%20problem). Instead, we just [add a line](https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=208120#c14) at the end of `/etc/libmap.conf` as
follows:

```
libgcc_s.so.1 /usr/local/lib/gcc7/libgcc_s.so.1
```



---

Comment by dimpase created at 2018-11-28 14:19:23

This scipy [problem](https://trac.sagemath.org/ticket/22679#comment:93) is still there.
(while this works with the system's python2)
It's a matter of comparing the patches used there with what we do in Sage. Perhaps they disable multithreading...


---

Comment by embray created at 2018-11-29 09:32:10

I'm currently overextended as always and don't have any deep personal motivation to work on FreeBSD support, but I would definitely like to have it if we can so if there's anything I can help with here I'll make a FreeBSD 12 VM so I can have it to play around on.


---

Comment by dimpase created at 2018-11-29 10:19:18

Replying to [comment:12 embray]:
> I'm currently overextended as always and don't have any deep personal motivation to work on FreeBSD support, but I would definitely like to have it if we can so if there's anything. I can help with here I'll make a FreeBSD 12 VM so I can have it to play around on.

I can give you access to the FreeBSD 12.0 VM I am running on GCE, this would be easier, I guess. (12.0 is still in beta/RC cycle, so installation is not straightforward, you basically need to build it from source).


---

Comment by @dimpase created at 2019-01-20 22:41:45

currently testing what we have here (with Sage 8.6) on the released FreeBSD 12.0


---

Comment by dimpase created at 2019-02-10 09:56:24

the next issue we hit is Python3 on Sage 8.7.beta3: https://bugs.python.org/issue6299
(pyexpat module does not build)


---

Comment by dimpase created at 2019-02-11 09:54:01

Replying to [comment:15 dimpase]:
> the next issue we hit is Python3 on Sage 8.7.beta3: https://bugs.python.org/issue6299
> (pyexpat module does not build)

for the time being, working around this by not installing setuptools and pip for py3


---

Comment by embray created at 2019-06-14 14:54:19

As the Sage-8.8 release milestone is pending, we should delete the sage-8.8 milestone for tickets that are not actively being worked on or that still require significant work to move forward.  If you feel that this ticket should be included in the next Sage release at the soonest please set its milestone to the next release milestone (sage-8.9).


---

Comment by dimpase created at 2019-08-31 21:37:09

to use flang (which is a possibility on FreeBSD at least), one needs

```diff
--- a/build/pkgs/numpy/spkg-install
+++ b/build/pkgs/numpy/spkg-install
@@ -18,7 +18,7 @@ export FFLAGS="$FFLAGS -fPIC"
 export FCFLAGS="$FCFLAGS -fPIC"
 
 export NUMPY_FCONFIG="config_fc --noopt --noarch"
-
+export LDFLAGS="$LDFLAGS -lexecinfo" # needed for flang
 ################################################
 
 sage-python23 setup.py \
```

due to it being somewhat underlinked.


---

Comment by dimpase created at 2019-08-31 21:42:49

As I have to abandon the FreeBSD VM I've been using, I've pushed the current WIP branch
to https://github.com/lwhsu/sagemath/commits/wip31082019

TBC on another FreeBSD machine.


---

Comment by @thierry-FreeBSD created at 2020-03-26 16:50:41

A work-in-progress has been submitted to the FreeBSD Phabricator:

https://reviews.freebsd.org/D24195

Its aim is to upgrade the existing port to 9.0.

Do not hesitate to comment or modify!


---

Comment by dimpase created at 2020-03-26 17:00:54

I think it'd be much better to use the work done on 
#27330 - you don't even need to build a special Python version, but use one on the system!
(And, of course, use autoconf, don't mess around with generated ./configure)


---

Comment by @thierry-FreeBSD created at 2020-03-26 17:38:32

I used the external packages when this is possible with the released Sage 9.0. This version still builds the bundled Python. I guess that the progress done with #27330 will be available in the next release?

Thanks for your comment, I'll try to use autoconf.


---

Comment by dimpase created at 2020-03-26 17:46:51

A large part of #27330 is already in 9.0.
But yes, I think it's much better to wait for 9.1, or actually start using 9.1.betas 
(we're near the first release candidate).

IIRC FreeBSD has quite a few packages available, although they aren't always built
with pre-reqs needed for Sage, e.g. Flint is not built with NTL support.


---

Comment by @thierry-FreeBSD created at 2020-03-26 21:07:59

Great! I'll try to work on 9.1 ASAP.

You are right about Flint: the ports used Cmake, and the NTL option is not available in CMakeLists.txt (and it is not even enabled by default with configure).

But we can change that, and I just sent a PR to fix it:

https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=245085


---

Comment by @thierry-FreeBSD created at 2020-03-27 15:05:51

And I just added a port for Cliquer, from your autotoolized version:

https://www.freshports.org/math/cliquer/


---

Comment by dimpase created at 2020-03-28 03:01:22

Thanks. I suggest that every Sage library/package mentioned in #27330 be made a FreeBSD port (some of them are), this should be enough to finish this task.

We have plans to turn Sage into a "normal" pip-installable Python library, but this probably won't happen before the end of the year.


---

Comment by @thierry-FreeBSD created at 2020-03-28 19:09:42

I recently also added eclib, m4ri, gf2x, gp2c and the Pari packages (elldata, galdata, galpol, nftables and seadata).

And still going on!


---

Comment by @thierry-FreeBSD created at 2020-04-08 10:57:53

Some news: I have just updated the WIP-port to 9.1.beta9: it is available at
https://reviews.freebsd.org/D24195

Every possible packages listed in #27330 are used as external packages, thanks for that!

Unfortunately, there remain some problems, mostly caused by staging (DESTDIR): a lot of libraries are referring to the directory where they have been built: e.g.

Error: 'lib/python3.7/site-packages/PIL/_imagingft.so' is referring to /usr/ports/math/sage/work/stage
Error: 'lib/libldl.so.2.2.6' is referring to /usr/ports/math/sage/work/stage

Is there some possibility to let them refer to relative directories?
How would you set SAGE_LOCAL?


---

Comment by @thierry-FreeBSD created at 2020-04-10 16:58:24

To be more precise: I have played with SAGE_LOCAL and SAGE_DESTDIR.

The logical choice seemed to set SAGE_LOCAL=$PREFIX and SAGE_DESTDIR=$STAGEDIR, but this is not the case.


---

Comment by @thierry-FreeBSD created at 2020-04-10 17:58:50

Actually, to be more positive, it mostly works!

Looking for the root of the problem, only 29 libraries are not fully staged - but of course, thereafter the other binaries using one of this library become affected.

ATM (with 9.1.beta9), my list of affected libraries is:

libamd.so.2 => /usr/ports/math/sage/work/stage/usr/local/lib/libamd.so.2

libbraiding.so.0 => /usr/ports/math/sage/work/stage/usr/local/lib/libbraiding.so.0

libbrial_groebner.so.3 => /usr/ports/math/sage/work/stage/usr/local/lib/libbrial_groebner.so.3

libbrial.so.3 => /usr/ports/math/sage/work/stage/usr/local/lib/libbrial.so.3

libbtf.so.1 => /usr/ports/math/sage/work/stage/usr/local/lib/libbtf.so.1

libcamd.so.2 => /usr/ports/math/sage/work/stage/usr/local/lib/libcamd.so.2

libccolamd.so.2 => /usr/ports/math/sage/work/stage/usr/local/lib/libccolamd.so.2

libcddgmp.so.0 => /usr/ports/math/sage/work/stage/usr/local/lib/libcddgmp.so.0

libcholmod.so.3 => /usr/ports/math/sage/work/stage/usr/local/lib/libcholmod.so.3

libcolamd.so.2 => /usr/ports/math/sage/work/stage/usr/local/lib/libcolamd.so.2

libecl.so.16.1 => /usr/ports/math/sage/work/stage/usr/local/lib/libecl.so.16.1

libfactory-4.1.1.so => /usr/ports/math/sage/work/stage/usr/local/lib/libfactory-4.1.1.so

libfflas.so.1 => /usr/ports/math/sage/work/stage/usr/local/lib/libfflas.so.1

libffpack.so.1 => /usr/ports/math/sage/work/stage/usr/local/lib/libffpack.so.1

libgap.so.0 => /usr/ports/math/sage/work/stage/usr/local/lib/libgap.so.0

libgc.so.1 => /usr/ports/math/sage/work/stage/usr/local/lib/libgc.so.1

libhomfly.so.0 => /usr/ports/math/sage/work/stage/usr/local/lib/libhomfly.so.0

libiml.so.1 => /usr/ports/math/sage/work/stage/usr/local/lib/libiml.so.1

liblinbox.so.0 => /usr/ports/math/sage/work/stage/usr/local/lib/liblinbox.so.0

liblrcalc.so.1 => /usr/ports/math/sage/work/stage/usr/local/lib/liblrcalc.so.1

libomalloc-0.9.6.so => /usr/ports/math/sage/work/stage/usr/local/lib/libomalloc-0.9.6.so

libpolys-4.1.1.so => /usr/ports/math/sage/work/stage/usr/local/lib/libpolys-4.1.1.so

libppl.so.14 => /usr/ports/math/sage/work/stage/usr/local/lib/libppl.so.14

libpynac.so.18 => /usr/ports/math/sage/work/stage/usr/local/lib/libpynac.so.18

libsingular_resources-4.1.1.so => /usr/ports/math/sage/work/stage/usr/local/lib/libsingular_resources-4.1.1.so

libSingular-4.1.1.so => /usr/ports/math/sage/work/stage/usr/local/lib/libSingular-4.1.1.so

libsuitesparseconfig.so.5 => /usr/ports/math/sage/work/stage/usr/local/lib/libsuitesparseconfig.so.5

libumfpack.so.5 => /usr/ports/math/sage/work/stage/usr/local/lib/libumfpack.so.5

libzn_poly-0.9.so => /usr/ports/math/sage/work/stage/usr/local/lib/libzn_poly-0.9.so

Some of them like libgc, brial, or fflas-ffpack should be fixed RSN (thanks to #27330 ).

I guess that the most problematic case is libsuitesparseconfig.so, which is widely used.


---

Comment by dimpase created at 2020-04-11 15:54:10

I cc Matthias, who has been doing a lot of work on improving Sage's installation.
He'd be able to understand the issue better than me, hopefully.


---

Comment by @thierry-FreeBSD created at 2020-04-11 18:50:45

The problem is documented in build/pkgs/suitesparse/patches/03-buildflags.patch:

"Note that -L$(INSTALL_LIB) cannot be removed from LDFLAGS unless the package 
is broken into components. It is necessary as the components are progressively
installed in INSTALL_LIB one after the other."

It has been reported in #28832 and fixed for OS X with -install_name, but this does not fix it for FreeBSD. I'll have to try other patches - unless suiteparse could be used from a system package? It is not yet listed in #27330 but would be awesome!


---

Comment by dimpase created at 2020-04-13 03:42:40

Now we have #29502 for suitesparse - not done yet.


---

Comment by @thierry-FreeBSD created at 2020-04-17 19:54:24

Some news: after #29502 for suitesparse and #29024 for singular, only 13 libraries (+ of course the modules built around them!) cause problems with staging: libbraiding libbrial_groebner libbrial libecl libfflas libffpack libgap libgc libhomfly liblinbox libppl libpynac libzn_poly-0.

Among them, all are listed in #27330 (with or without a ticket), but libpynac. We do not even have pynac in the FreeBSD ports tree (but we have math/GiNaC) => it will be my next target.


---

Comment by @thierry-FreeBSD created at 2020-04-29 16:48:35

After giac (#29541) and pynac (#29542), I tried to use a system package for ECL (lang/ecl) and Maxima (math/maxima), but without success for the moment: see #29617. To be tried again when ECL will be upgraded (#22191)!

Meanwhile, our ports must be patched:

- lang/ecl: add a symbolic link for $PREFIX/lib/ecl

- math/maxima: this one is more tricky, because now ECL is not even supported and must be added, and to get a useful package we need to replace the default from SBCL to ECL (or create a slave port?)

They are not submitted yet, but if someone want to work on #29617 the patches are available at
- https://people.freebsd.org/~thierry/lang_ecl.diff
- https://people.freebsd.org/~thierry/math_maxima.diff


---

Comment by dimpase created at 2020-04-30 07:40:14

Replying to [comment:39 gh-thierry-FreeBSD]:
> After giac (#29541) and pynac (#29542), I tried to use a system package for ECL (lang/ecl) and Maxima (math/maxima), but without success for the moment: see #29617. To be tried again when ECL will be upgraded (#22191)!
> 
> Meanwhile, our ports must be patched:
> 
> - lang/ecl: add a symbolic link for $PREFIX/lib/ecl
> 
> - math/maxima: this one is more tricky, because now ECL is not even supported and must be added, and to get a useful package we need to replace the default from SBCL to ECL (or create a slave port?)

there are many free Common Lisp implementations, I suppose there can be lang/cl as a "main" package with a number of slaves, perhaps SBCL as a standard one.


---

Comment by mkoeppe created at 2020-04-30 20:19:55

I'd recommend to add system package information for FreeBSD. See #29354 where this is done for Slackware (except for the bits that use docker)


---

Comment by @thierry-FreeBSD created at 2020-05-04 21:00:02

Well, every package listed in #27330 have a corresponding package from the FreeBSD ports tree and a spkg-configure.m4 to use it!

Next step: try to solve the problem with bad staging (non-respect of $DESTDIR) for the libraries built by Sage.


---

Comment by mkoeppe created at 2020-05-05 02:03:10

Replying to [comment:42 gh-thierry-FreeBSD]:
> Well, every package listed in #27330 have a corresponding package from the FreeBSD ports tree and a spkg-configure.m4 to use it!

Yes, and the trick is to put the names of these packages in a freebsd.txt file to record the correspondence of spkg to FreeBSD port.


---

Comment by @thierry-FreeBSD created at 2020-05-05 07:12:21

OK, I'll do it!


---

Comment by @thierry-FreeBSD created at 2020-05-05 17:34:01

Replying to [comment:44 gh-thierry-FreeBSD]:
> OK, I'll do it!

Done in #29653.


---

Comment by mkoeppe created at 2020-05-08 16:45:05

Next, if you're serious about FreeBSD support, I would recommend setting up testing infrastructure with our tox.ini and virtualbox (https://www.freebsd.org/doc/handbook/virtualization-guest-virtualbox.html) or a similar solution so that Sage developers and our CI infrastructure have a chance of testing on that platform.


---

Comment by @thierry-FreeBSD created at 2020-05-10 13:13:56

Replying to [comment:46 mkoeppe]:
> I would recommend setting up testing infrastructure with our tox.ini and virtualbox (https://www.freebsd.org/doc/handbook/virtualization-guest-virtualbox.html) or a similar solution so that Sage developers and our CI infrastructure have a chance of testing on that platform. 
> 

Thanks, this is interesting - but at this point a bit premature: there is no compilation error, but Sage is not yet ready for FreeBSD, even if we are making progress.


---

Comment by @thierry-FreeBSD created at 2020-05-31 14:49:24

Well, we are almost done!

It is not yet committable in the FreeBSD ports tree, because there are some pre-requisites (isl to be upgraded, and two possible forks for ECL and Maxima if no better solution is found).

See https://reviews.freebsd.org/D24195 for details.


---

Comment by dimpase created at 2020-05-31 15:27:26

for ecl I suggest to use a not yet merged
https://trac.sagemath.org/ticket/22191

which looks good on Linux and OpenBSD.

also a new release of Flint is coming.


---

Comment by @thierry-FreeBSD created at 2020-05-31 15:57:33

Thanks! I'm just in discussion with the maintainers of these two ports (ECL and Maxima). Let's check this version.


---

Comment by dimpase created at 2020-05-31 16:07:06

ecl obviously must be upgraded to the latest release (maxima currently packaged with Sage works well with it, too).

which bugs of maxima one prefers, is another question. :-)

our experience with updating maxima is that each new release has serious regressions.


---

Comment by dimpase created at 2020-05-31 16:26:32

here is Flint update ticket
https://trac.sagemath.org/ticket/29719

it is awaiting upstream putting in
finishing touches here:
https://github.com/wbhart/flint2/issues/753


---

Comment by @thierry-FreeBSD created at 2020-05-31 17:35:22

I guess that it is safer to get Sage 9.1 into our ports tree with the current dependencies.

We'll look to upgrade these afterwards!


---

Comment by @thierry-FreeBSD created at 2020-06-17 10:14:18

We are done, 9.1 is in the tree:
https://www.freshports.org/math/sage/

and we are working on the upgrade of ECL to 20.4.24:
https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=247283


---

Comment by dimpase created at 2020-06-17 11:37:08

Replying to [comment:54 gh-thierry-FreeBSD]:
> We are done, 9.1 is in the tree:
> https://www.freshports.org/math/sage/

This is great!

I guess we should make the Sagemath source FreeBSD-friendly, so that one can build
Sage from source using the standard ./configure + make route, right? This would need

* adding data for the needed packages, that is, there should be
  `build/pkgs/*/distros/freebsd.txt` files added with package names.

* adding pre-reqs data: `build/pkgs/freebsd.txt` and `build/pkgs/freebsd-bootstrap.txt`

* import patches you added in FreeBSD to Sage (if any)


---

Comment by @thierry-FreeBSD created at 2020-06-17 12:17:05

The most important patch concerns configure.ac: without it, you cannot even run configure!

I submitted it with the system package information in #29653, but it has been rejected.

The other patches are mostly specific and related to the ports system, caused by differences in directories, but shouldn't be necessary for those trying to build Sage by themselves with the bundled packages.

mkoeppe asked me to set up a testing infrastructure. I'm not familiar at all with that, but I'll try to do it (any pointers appreciated!).


---

Comment by dimpase created at 2020-06-17 13:34:47

I will look at #29653 - it needs a rebase over the latest 9.2.beta1 

regarding testing - is docker ported to FreeBSD?

Anyway, one can set a patchbot, for this one just needs a FreeBSD host that will pull branches and build/test them.


---

Comment by @thierry-FreeBSD created at 2020-06-17 13:53:43

There exists a port of docker: https://www.freshports.org/sysutils/docker (but I never used it!).


---

Comment by @lwhsu created at 2020-06-17 15:51:05

I don't think docker port is production ready at the moment. I suggest the faster way would be having a github mirror and use hosted CI service: https://wiki.freebsd.org/HostedCI


---

Comment by dimpase created at 2020-06-19 10:59:52

Replying to [comment:54 gh-thierry-FreeBSD]:
> We are done, 9.1 is in the tree:
> https://www.freshports.org/math/sage/

I've revived a VM with FreeBSD, it's running 12.1-RELEASE-p6

How do I get the new port in there? Do I need a system update (if yes, to what?)?
Or it's easier?
I've run portsnap, and still see old stuff for sage in /usr/ports/math/sage.


---

Comment by @thierry-FreeBSD created at 2020-06-19 11:30:23

You did the right thing!

- 12.1-RELEASE-p6 is OK

- `portsnap fetch update' is a well supported method - but I do not know how long it takes to be refreshed. I guess that if you try again is 1h or 2 it should be fine.


---

Comment by @lwhsu created at 2020-06-19 11:32:42

Replying to [comment:61 dimpase]:
> Replying to [comment:54 gh-thierry-FreeBSD]:
> > We are done, 9.1 is in the tree:
> > https://www.freshports.org/math/sage/
> 
> I've revived a VM with FreeBSD, it's running 12.1-RELEASE-p6
> 
> How do I get the new port in there? Do I need a system update (if yes, to what?)?
> Or it's easier?
> I've run portsnap, and still see old stuff for sage in /usr/ports/math/sage.

I guess there are two possibilities, one is portsnap is not updated yet (unlikely, IIRC it updates hourly), the other is it's tracking quarterly branch, and 9.1 is only in latest branch now.  I haven't used portsnap for a while so I might also be wrong.

To get the latest ports tree in real-time, you can try to use svn to checkout from:

https://svn.freebsd.org/ports/head

or git from

https://github.com/freebsd/freebsd-ports


---

Comment by dimpase created at 2020-06-19 11:51:39

Replying to [comment:62 gh-thierry-FreeBSD]:
> You did the right thing!
> 
> - 12.1-RELEASE-p6 is OK
> 
> - `portsnap fetch update' is a well supported method - but I do not know how long it takes to be refreshed. I guess that if you try again is 1h or 2 it should be fine.

OK, thanks, seems to be in progress now, after I did `portsnap fetch update` (my first try was ``portsnap fetch` - probably they are not the same thing)


lwhsu - did you see my email about CI? (just checking)


---

Comment by @lwhsu created at 2020-06-19 14:18:20

Replying to [comment:64 dimpase]:
> Replying to [comment:62 gh-thierry-FreeBSD]:
> > You did the right thing!
> > 
> > - 12.1-RELEASE-p6 is OK
> > 
> > - `portsnap fetch update' is a well supported method - but I do not know how long it takes to be refreshed. I guess that if you try again is 1h or 2 it should be fine.
> 
> OK, thanks, seems to be in progress now, after I did `portsnap fetch update` (my first try was ``portsnap fetch` - probably they are not the same thing)

Yes there are two steps. One if for fetching the content and the other one is for actually updating the ports tree.  See portsnap(8)
 
> lwhsu - did you see my email about CI? (just checking)

Yes, please forgive me for needing longer to response.
