# Issue 32350: upgrade gsl to version 2.7

Issue created by migration from https://trac.sagemath.org/ticket/32587

Original creator: dimpase

Original creation time: 2021-09-29 19:57:58

CC:  mjo tmonteil

a complication is a change in API, see
https://groups.google.com/g/sage-devel/c/yQ67Wy0gp58/m/jr6f7xtcBQAJ

Some distro's, e.g. Gentoo, now have GSL 2.7 as the default.


---

Comment by lorenz created at 2021-10-01 05:10:34

Here's an attempt. It seemed to build successfully, but I haven't run any tests so far.
----
New commits:


---

Comment by lorenz created at 2021-10-01 05:10:34

Changing status from new to needs_review.


---

Comment by lorenz created at 2021-10-01 09:50:35

I just ran `make ptestlong` with this branch on a fresh Debian 11; all tests passed.


---

Comment by mkoeppe created at 2021-10-01 16:54:20

Do the changes to the library also work with an older GSL?


---

Comment by lorenz created at 2021-10-01 17:28:58

They should: The new code simply uses the macros provided by GSL itself (in `gsl_complex.h`) to work with the `gsl_complex` struct, and those macros haven't changed (they are only `#ifdef`'d to something else). That said, I haven't tested it.


---

Comment by mkoeppe created at 2021-10-01 17:37:10

In this case, I would recommend the following. Split this ticket into two:
- one ticket for updating the library so that it can work with system GSL 2.7.
  Because this ticket will not include a change to packages, the patchbot will run on it.
- a follow-up ticket that does the upgrade of the package.

With each of the tickets, we can run portability testing on GH Actions (https://doc.sagemath.org/html/en/developer/portability_testing.html) to make sure that it still works with system GSL on all supported platforms. If necessary, we may need to adjust `build/pkgs/gsl/spkg-configure.m4`. Currently we accept all GSL >= 2.4.


---

Comment by lorenz created at 2021-10-02 02:30:35

Alright, all the code changes are now in #32607.

Remaining diff in this branch (after #32607):â€‚https://git.sagemath.org/sage.git/diff?id2=6633bc4ddd66e982fc3484f399cf62e50e36fd61&id=e4a133fa586409dc28c3ee5702d11d77c385d761


---

Comment by dimpase created at 2021-10-02 10:54:17

I'm a bit confused, as Sage with system's GLS 2.7 (as on Gentoo Linux) appears to work without
any changes in the source.


---

Comment by mjo created at 2021-10-02 12:20:55

Replying to [comment:8 dimpase]:
> I'm a bit confused, as Sage with system's GLS 2.7 (as on Gentoo Linux) appears to work without
> any changes in the source.

Probably the `USE=deprecated` that is on by default.


---

Comment by jhpalmieri created at 2021-10-22 21:45:59

From #31621: can we also make the following changes?

- change gsl's `spkg-install.in` as follows:

```diff
diff --git a/build/pkgs/gsl/spkg-install.in b/build/pkgs/gsl/spkg-install.in
index 179b78963a..ef156a7a5c 100644
--- a/build/pkgs/gsl/spkg-install.in
+++ b/build/pkgs/gsl/spkg-install.in
@@ -1,5 +1,5 @@
 cd src
 
-sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm"
+sdh_configure LIBS="`pkg-config --libs-only-l cblas` -lm" LDFLAGS="$LDFLAGS `pkg-config --libs-only-L cblas`"
 sdh_make
 sdh_make_install
```

 As it stands, on OSX + homebrew, `./configure --with-system-gsl=no` fails when building `gsl` with the error

```
configure: error: in `/Users/jpalmier/Desktop/Sage/sage_builds/TESTING/sage-9.5.beta1/local/var/tmp/sage/build/gsl-2.6/src':
configure: error: C compiler cannot create executables
```

 and the `config.log` file says `ld: library not found for -lopenblas`.

- Also, I think `pkgconf` should be an order-only dependency for gsl:

```diff
diff --git a/build/pkgs/gsl/dependencies b/build/pkgs/gsl/dependencies
index 052eb4373d..576809127c 100644
--- a/build/pkgs/gsl/dependencies
+++ b/build/pkgs/gsl/dependencies
@@ -1,4 +1,4 @@
-$(BLAS)
+$(BLAS) | pkgconf
 
 ----------
 All lines of this file are ignored except the first.
```

 since the package installation scripts use `pkg-config`.


---

Comment by lorenz created at 2021-10-23 06:50:39

Replying to [comment:10 jhpalmieri]:
> From #31621: can we also make the following changes?

Feel free to modify this branch as you please. I don't think I'm familiar enough with Sage's build system to dive any deeper into this...


---

Comment by dimpase created at 2021-10-23 09:09:19

comment:10 actually gives you diffs you can apply (click on "Unified")

I am travelling and probably won't get around to do this before tomorrow


---

Comment by git created at 2021-10-23 17:47:22

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by jhpalmieri created at 2021-10-23 17:48:23

Here are my proposed changes. (Dima actually proposed the change to `spkg-install.in`, to give credit where it's due.)


---

Comment by slelievre created at 2021-10-25 14:49:02

Changing keywords from "" to "upgrade, gsl".


---

Comment by git created at 2021-10-28 06:49:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-10-28 06:49:43

... as suggested in #31621#comment:58


---

Comment by dimpase created at 2021-11-01 13:35:30

Changing status from needs_review to positive_review.


---

Comment by dimpase created at 2021-11-01 13:35:30

lgtm


---

Comment by vbraun created at 2021-11-02 22:55:47

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2021-11-02 22:55:47

Merge conflict


---

Comment by git created at 2021-11-03 02:54:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by lorenz created at 2021-11-03 02:57:12

Changing status from needs_work to needs_review.


---

Comment by lorenz created at 2021-11-03 02:57:12

Trivial merge.


---

Comment by mkoeppe created at 2021-11-03 03:11:41

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-11-12 21:27:44

Resolution: fixed
