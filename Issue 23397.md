# Issue 23397: A base class for integral quadratic forms seen as modules with a bilinear form.

Issue created by migration from https://trac.sagemath.org/ticket/23634

Original creator: sbrandhorst

Original creation time: 2017-08-17 14:23:14

Keywords: sd91

An integral lattice is a free abelian group L together with a non-degenerate integer valued bilinear form L x L --> ZZ.

In sage a lattice should consist of:
- an ambient QQ vector space with an inner product matrix
- a distinguished ZZ-basis (with possibly rational entries)

Integral lattices and quadratic forms are mathematically basically the same.
For me the difference in thinking is that lattices live in an ambient space.
Thus, one can have several lattices in an ambient space and compare their mutual relations (containment, embedding etc.)

Probably it should be derived from 
sage.modules.free_quadratic_module.FreeQuadraticModule_submodule_with_basis_pi

New methods should include 
- discriminant groups and forms
- over and sublattices 
- Orthogonal groups
- direct sums
- is_even 
- is_primitive sublattice
- orthogonal complements
- the dual "lattice"


---

Comment by git created at 2017-08-18 07:01:04

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2017-08-24 14:07:39

Changing status from new to needs_review.


---

Comment by roed created at 2017-08-29 12:46:22

Changing status from needs_review to needs_work.


---

Comment by roed created at 2017-08-29 12:46:22

Since lattices are parents, they should be unique (for given defining data).  I would suggest using `sage.structure.factory.Factory`, but you may be able to get away with `sage.structure.unique_representation.UniqueRepresentation` instead.


---

Comment by sbrandhorst created at 2017-09-14 15:09:08

Changing status from needs_work to needs_info.


---

Comment by sbrandhorst created at 2017-09-14 15:09:08

The very similar classes of submodules

sage.modules.free_module.FreeModule_submodule_field
sage.modules.free_module.FreeModule_submodule_pid
sage.modules.free_module_integer.FreeModule_submodule_with_basis_integer
sage.modules.free_quadratic_module.FreeQuadraticModule_submodule_pid

are not unique. In my view lattices are submodules of an ambient space (with certain restrictions), too. 
Can you make a case why this class should be unique while they are not?
Note that our lattices are equipped with a distinguished basis. This could change during the runtime.
This seems to conflict with the uniqueness of the objects?


---

Comment by roed created at 2017-09-30 02:31:21

Okay.  I'll look at the code again.  There's some trouble with an internal server error, so I'm trying to see if a comment changes anything.


---

Comment by roed created at 2017-09-30 02:31:21

Changing status from needs_info to needs_review.


---

Comment by git created at 2017-09-30 19:30:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2017-09-30 22:10:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-09-30 22:10:45

I'm happy with it; Simon, you should take a look at my changes.


---

Comment by git created at 2017-09-30 22:44:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2017-09-30 22:52:13

Changing status from needs_review to positive_review.


---

Comment by sbrandhorst created at 2017-09-30 22:52:13

Looks good!


---

Comment by git created at 2017-10-01 02:44:02

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-10-01 02:44:02

Changing status from positive_review to needs_review.


---

Comment by sbrandhorst created at 2017-10-01 04:57:49

All doctests pass & the documentation builds.


---

Comment by sbrandhorst created at 2017-10-01 04:57:49

Changing status from needs_review to positive_review.


---

Comment by git created at 2017-10-01 05:02:55

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2017-10-01 05:02:55

Changing status from positive_review to needs_review.


---

Comment by roed created at 2017-10-01 05:07:52

Changing status from needs_review to positive_review.


---

Comment by roed created at 2017-10-01 05:07:52

Thanks for fixing those!


---

Comment by sbrandhorst created at 2017-10-01 16:13:00

The documentation for IntegralLattice is wrong.


---

Comment by sbrandhorst created at 2017-10-01 16:13:00

Changing status from positive_review to needs_work.


---

Comment by git created at 2017-10-01 17:25:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2017-10-01 19:43:51

Changing status from needs_work to needs_review.


---

Comment by git created at 2017-10-01 20:01:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by roed created at 2017-10-01 20:46:22

Positive review if you're happy with my changes.
----
New commits:


---

Comment by sbrandhorst created at 2017-10-01 21:43:51

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2017-10-04 23:32:30


```
sage -t --long --warn-long 64.6 src/sage/modules/free_quadratic_module_integer_symmetric.py
**********************************************************************
File "src/sage/modules/free_quadratic_module_integer_symmetric.py", line 112, in sage.modules.free_quadratic_module_integer_symmetric.FreeQuadraticModule_integer_symmetric.__init__
Failed example:
    TestSuite(L).run()
Expected nothing
Got:
      Failure in _test_pickling:
      Traceback (most recent call last):
        File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/misc/sage_unittest.py", line 294, in run
          test_method(tester = tester)
        File "sage/structure/sage_object.pyx", line 683, in sage.structure.sage_object.SageObject._test_pickling (build/cythonized/sage/structure/sage_object.c:5952)
          tester.assertEqual(loads(dumps(self)), self)
        File "/mnt/disk/home/release/Sage/local/lib/python2.7/unittest/case.py", line 513, in assertEqual
          assertion_func(first, second, msg=msg)
        File "/mnt/disk/home/release/Sage/local/lib/python2.7/unittest/case.py", line 506, in _baseAssertEqual
          raise self.failureException(msg)
      AssertionError: (1, 0) != (1, 0)
      ------------------------------------------------------------
      The following tests failed: _test_pickling
    Failure in _test_elements
    The following tests failed: _test_elements
**********************************************************************
File "src/sage/modules/free_quadratic_module_integer_symmetric.py", line 340, in sage.modules.free_quadratic_module_integer_symmetric.FreeQuadraticModule_integer_symmetric.orthogonal_complement
Failed example:
    L.orthogonal_complement(S)
Exception raised:
    Traceback (most recent call last):
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 515, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 885, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modules.free_quadratic_module_integer_symmetric.FreeQuadraticModule_integer_symmetric.orthogonal_complement[3]>", line 1, in <module>
        L.orthogonal_complement(S)
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/modules/free_quadratic_module_integer_symmetric.py", line 365, in orthogonal_complement
        return self.sublattice(self.intersection(K).basis())
      File "/mnt/disk/home/release/Sage/local/lib/python2.7/site-packages/sage/modules/free_module.py", line 2550, in intersection
        raise ArithmeticError("self and other must be embedded in the same ambient space.")
    ArithmeticError: self and other must be embedded in the same ambient space.
**********************************************************************
2 items had failures:
   1 of   4 in sage.modules.free_quadratic_module_integer_symmetric.FreeQuadraticModule_integer_symmetric.__init__
   1 of   7 in sage.modules.free_quadratic_module_integer_symmetric.FreeQuadraticModule_integer_symmetric.orthogonal_complement
    [65 tests, 2 failures, 0.64 s]
----------------------------------------------------------------------
sage -t --long --warn-long 64.6 src/sage/modules/free_quadratic_module_integer_symmetric.py  # 2 doctests failed
----------------------------------------------------------------------
```



---

Comment by vbraun created at 2017-10-04 23:32:30

Changing status from positive_review to needs_work.


---

Comment by sbrandhorst created at 2017-10-05 09:41:36

I cannot reproduce this :-(. Can someone else?

```
./sage -t --long --warn-long 64.6 src/sage/modules/free_quadratic_module_integer_symmetric.py
Running doctests with ID 2017-10-05-11-26-06-7db5d712.
Git branch: t/23634/a_base_class_for_integral_quadratic_forms_seen_as_modules_with_a_bilinear_form_
Using --optional=atlas,ccache,mpir,python2,sage
Doctesting 1 file.
sage -t --long --warn-long 64.6 src/sage/modules/free_quadratic_module_integer_symmetric.py
    [65 tests, 1.21 s]
----------------------------------------------------------------------
All tests passed!
----------------------------------------------------------------------
Total time for all tests: 1.3 seconds
    cpu time: 0.9 seconds
    cumulative wall time: 1.2 seconds
```



---

Comment by tscrim created at 2017-10-05 15:18:08

I get the failures when I test it with #23915.


---

Comment by git created at 2017-10-06 08:17:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2017-10-06 08:43:31


```
sage: from sage.modules.free_quadratic_module_integer_symmetric import *
sage: L=IntegralLattice(Matrix(ZZ,2,2,[0,1,1,0]))
sage: x=L.an_element()
sage: x == loads(dumps(x))
True
sage: x == loads(dumps(x))
False
sage: x == loads(dumps(x))
True
sage: x == loads(dumps(x))
True
```

Uhm. Is loads(dumps(x)) non-deterministic? This bug confuses me.


---

Comment by git created at 2017-10-06 09:21:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2017-10-06 09:25:51

Changing status from needs_work to needs_review.


---

Comment by sbrandhorst created at 2017-10-06 09:25:51

Lets see what the patchbot says.


---

Comment by tscrim created at 2017-10-06 18:14:05

Why not just use `richcmp(lx, rx, op)`?

Also, instead of

```
self._inner_product_is_dot_product()==True
```

you should just do `self._inner_product_is_dot_product()`.


---

Comment by git created at 2017-10-06 18:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by sbrandhorst created at 2017-10-06 18:54:59

Good point. Changed that.
----
New commits:


---

Comment by roed created at 2017-10-06 23:42:03

Changing status from needs_review to positive_review.


---

Comment by roed created at 2017-10-06 23:42:03

Looks good to me.  The failure in `geometry/cone.py` seems to have resulted from an out-of-memory problem.


---

Comment by vbraun created at 2017-10-15 09:22:23

Resolution: fixed
