# Issue 16701: Sage debug version

Issue created by migration from Trac.

Original creator: SimonKing

Original creation time: 2014-09-05 14:07:35

CC:  jpflori vbraun malb

Keywords: debug singular cygwin64

When building sage with `SAGE_DEBUG=yes`, then it turns out that the debug and the cygwin64 patches to the Singular spkg are in conflict. Hence, the built fails. Let's fix it!


---

Comment by SimonKing created at 2014-09-05 19:51:39

The function `choose_patches()` of singular's spkg-install removes most of the files in `$SRC/omalloc/` if we are in debug mode. However, the cygwin64 patch tries to patch some files in that folder.

In addition to that, the cygwin64 patch says

```
+ifeq ($(SINGUNAME),x86_64-Win)
+SO_SUFFIX = dll
+MODULE_SUFFIX    = dll
+LIBSINGULAR_FLAGS = -shared
+LIBSINGULAR_LIBS = -lsingfac -lsingcf -lntl -lreadline -lgmp -lomalloc 
+endif
+
```

So, if one would try to build the debug version in 64 bit cygwin, then one had -lomalloc, but that would not work, since omalloc is disabled on purpose, for the debug version.

What to do? In principle, we could put an alternative version of the cygwin64 patch into the patches/conditional folder, and if we are in debug version, we could let `choose_patches()` replace the regular cygwin patch version by the conditional version.

I will try to solve the problem accordingly, however, I have no windows box. Hence, someone else needs to test if a debug version of singular works in cygwin.


---

Comment by SimonKing created at 2014-09-05 19:56:26

PS: Instead of omalloc, the debug version's memory manager is called xalloc. This is a hint for a debug version in cygwin: Perhaps it needs to say `-lxalloc` rather than `-lomalloc`?


---

Comment by SimonKing created at 2014-09-05 20:02:05

Unfortunately, one important debug patch, namely `singular_xalloc.patch`, fails to apply.


---

Comment by SimonKing created at 2014-09-05 20:46:41

Replying to [comment:3 SimonKing]:
> Unfortunately, one important debug patch, namely `singular_xalloc.patch`, fails to apply.

The good news is that many of the failing patches went upstream!


---

Comment by SimonKing created at 2014-09-05 20:58:15

I modified the patches so that they apply. However, the built fails, as the function `omalloc0` is used in one place, but is not defined when using xalloc instead of omalloc. I guess I have to ask Hans SchÃ¶nemann for advice.


---

Comment by vbraun created at 2014-09-10 19:09:23

IMHO we shouldn't waste time on a Cygwin debug version. Thats for way down the road. If it doesn't work now, so be it.


---

Comment by SimonKing created at 2014-09-10 19:34:29

Replying to [comment:6 vbraun]:
> IMHO we shouldn't waste time on a Cygwin debug version. Thats for way down the road. If it doesn't work now, so be it.

Cygwin itself is not in the game. Only the cygwin PATCH currently constitutes a problem. It is not a big deal to solve it: I modified the patches _and_ spkg-install so that building the debug version starts (i.e., so that all patches and changes apply).

Meanwhile Hans gave me a hint on where to get a missing function. After fixing that, the debug version will hopefully build.


---

Comment by SimonKing created at 2014-09-10 20:40:02

With Hans' hint, building the debug version went a bit further. However, building still fails, with "cannot find -lomalloc_ndebug".

OOOOPS! Looking for `-lomalloc_ndebug` in our patches, I see that the `sage_debug.patch` looks like this:

```diff
diff -ru src/kernel/Makefile.in src.debug/kernel/Makefile.in
--- src/kernel/Makefile.in      2012-04-17 21:00:08.000000000 +0200
+++ src.debug/kernel/Makefile.in        2012-07-12 16:51:29.923359810 +0200
`@``@` -49,7 +49,7 `@``@`
 CXXFLAGS       = `@`CXXFLAGS`@` ${PIPE} 
 CXXTEMPLFLAGS  = `@`CXXTEMPLFLAGS`@`
 CPPFLAGS       = -I${srcdir} -I.. -I`@`prefix`@`  `@`CPPFLAGS`@` 
-DEFS           = -DNDEBUG -DOM_NDEBUG -D`@`SING_UNAME`@` `@`DEFS`@`
+DEFS           = -DOM_NDEBUG -D`@`SING_UNAME`@` `@`DEFS`@`
 LDFLAGS                = `@`LDFLAGS`@`
 LD_DYN_FLAGS   = `@`LD_DYN_FLAGS`@`
 SFLAGS         = `@`SFLAGS`@`
`@``@` -64,7 +64,7 `@``@`
 LIBS           = -lm `@`NEED_LIBS`@` 
 else
 # for the 2-0-* versions under Windows, we don't need gdbm, readline and ncurses
-LIBS           = -lsingfac -lsingcf -lntl -lgmp -lreadline -lncurses -lomalloc_ndebug
+LIBS           = -lsingfac -lsingcf -lntl -lgmp -lreadline -lncurses -lomalloc
 #LIBS          = -lsingfac -lsingcf -lgmp
 endif
 MP_LIBS                = `@`MP_LIBS`@`
```

Isn't the diff file formatted wrongly? I am talking about the paths "src/kernel" and "src.debug/kernel", which do not exist.


---

Comment by SimonKing created at 2014-09-10 20:54:39

Concerning ndebug: There is quite a number of files in `upstream/singular-3.1.6/latest/` mentioning `-lomalloc_ndebug`. Probably we should change all of them to only mention `-lomalloc`.


---

Comment by SimonKing created at 2014-09-10 21:04:28

I have pushed my changes, so that someone else may have a change to see how to solve the `-lomalloc_ndebug` problem.
----
New commits:


---

Comment by vbraun created at 2014-09-10 22:24:14

Patches are applied with `-p1`, so the first path component is stripped off.


---

Comment by SimonKing created at 2014-09-11 10:09:57

Replying to [comment:12 vbraun]:
> Patches are applied with `-p1`, so the first path component is stripped off.

OK, but I think it doesn't hurt that in the latest commit I change the path names according to what is done in the other patches (source path `a/...` versus target path `b/...`).

I got more Info from Hans. There is a debug version of omalloc, but it would still be omalloc. Hence, valgrind would not see details but would only see large pages allocated. So, he recommends to stick with xalloc (which is a compatibility layer on top of malloc).

If we would have Singular 4-x in Sage (we only have 3-1-6), xalloc would be part of the sources. Hence, all our current patching for the debug version wouldn't be needed.

As for `-lomalloc_ndebug`: Hans suggests to change the makefile so that a module `libomalloc_ndebug.so` rather than `libomalloc.so` is created. To my understanding, it would also allow to remove other parts of our patches, where we replace `-lomalloc_ndebug` by `-lomalloc`.


---

Comment by vbraun created at 2014-09-11 12:10:00

libm4ri fails its self-tests when debug is on, this is #16966.


---

Comment by git created at 2014-09-11 12:10:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-09-11 12:16:00

Meanwhile I got Singular's xalloc version (which is better for valgrinding than the debug version of omalloc) to build. Now I am trying to build the rest of Sage, but expect that I will soon run into the issue tracked at #16966...

In the latest commit I added one missing function (which is empty in the debug version) and I changed the module name from `libomalloc.so` into `libomalloc_ndebug.so`. It may seem strange for someone that the DEBUG version is named `..._ndebug`. If that's a problem then (s)he may change it, so that it still works...

I am trying to continue building, potentially with m4ri in non-debug mode. I guess for now one can say that it needs review.


---

Comment by SimonKing created at 2014-09-11 12:16:00

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-09-11 12:17:39

For the record, m4ri builds fine if you don't set `SAGE_CHECK=yes`


---

Comment by vbraun created at 2014-09-11 12:42:13

I get `/usr/bin/ld: cannot find -lomalloc` when building from scratch...


---

Comment by SimonKing created at 2014-09-11 15:18:58

Replying to [comment:18 vbraun]:
> I get `/usr/bin/ld: cannot find -lomalloc` when building from scratch...

It has built for me (without `SAGE_CHECK=yes`), but I suppose that `libomalloc` was present from previous attempts to build. So, let's try "make distclean" and try again...


---

Comment by SimonKing created at 2014-09-11 15:18:58

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-09-11 22:21:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-09-11 22:24:03

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2014-09-11 22:24:03

After make distclean I could reproduce the build errors.

The latest commit provides a solution. Perhaps you don't like it, for aesthetic reasons ("the debug version uses a module called omalloc_ndebug"), but it works. I also had to resolve a conflict with `cygwin_64.patch` to achieve it.


---

Comment by vbraun created at 2014-09-11 23:16:18

I'll give it a spin.

IMHO we don't have to win beauty contests with the debug version...


---

Comment by vbraun created at 2014-09-12 12:47:58

Still doesn't build for me:

```
g++ -O0 -g  -fPIC -I.. -I/home/vbraun/Sage/git-develop/local -pipe -I. -I.. -I/home/vbraun/Sage/git-develop/local -I/home/vbraun/Sage/git-develop/local/include -I/home/vbraun/Sage/git-develop/local/include   -fno-implicit-templates -I.. -I/home/vbraun/Sage/git-develop/local -Dx86_64_Linux -DHAVE_CONFIG_H \
  -o Singular \
  tesths.cc iparith.o mpsr_Tok.o claptmpl.o\
  grammar.o scanner.o attrib.o blackbox.o eigenval_ip.o extra.o fehelp.o feOpt.o ipassign.o ipconv.o ipid.o iplib.o ipprint.o ipshell.o newstruct.o lists.o sdb.o fglm.o interpolation.o silink.o ssiLink.o s_buff.o subexpr.o janet.o wrapper.o libparse.o sing_win.o gms.o pcv.o maps_ip.o walk.o walk_ip.o cntrlc.o misc_ip.o calcSVD.o pipeLink.o Minor.o MinorProcessor.o MinorInterface.o bigintm.o pyobject_setup.o denom_list.o minpoly.o countedref.o semaphore.o slInit_Dynamic.o -rdynamic -L/home/vbraun/Sage/git-develop/local/kernel -L../kernel -lkernel_g -L/home/vbraun/Sage/git-develop/local/lib  -L/home/vbraun/Sage/git-develop/local/lib -lflint -lmpfr -lmpir  -ldl -lm -lsingfac -lsingcf -lflint -lmpfr -lntl -lgmp -lreadline -ltermcap -lnsl -lm  -lnsl -lbsd  -lomalloc -lpthread  ../kernel/mmalloc.o 
/usr/bin/ld: cannot find -lomalloc
collect2: error: ld returned 1 exit status
make[1]: *** [Singular] Error 1
make[1]: Leaving directory `/home/vbraun/Sage/git-develop/local/var/tmp/sage/build/singular-3.1.6.p3/src/latest/Singular'
make: *** [install-nolns] Error 1
Unable to build and install Singular
Error building Singular (error in build_singular).
```



---

Comment by SimonKing created at 2014-09-12 12:57:53

Replying to [comment:23 vbraun]:
> Still doesn't build for me:

Seriously? It did build for me, even though I did `make distclean` after making the makefile make `omalloc_ndebug` instead of `omalloc`.

> {{{
> g++ -O0 -g  -fPIC -I.. -I/home/vbraun/Sage/git-develop/local -pipe -I. -I.. -I/home/vbraun/Sage/git-develop/local -I/home/vbraun/Sage/git-develop/local/include -I/home/vbraun/Sage/git-develop/local/include   -fno-implicit-templates -I.. -I/home/vbraun/Sage/git-develop/local -Dx86_64_Linux -DHAVE_CONFIG_H \
>   -o Singular \
>   tesths.cc iparith.o mpsr_Tok.o claptmpl.o\...
> }}}

The name `tesths.cc` suggests that this is for testing. So, did you build with `SAGE_CHECK` and `SAGE_DEBUG` together?


---

Comment by vbraun created at 2014-09-12 13:00:15

Are you using 32bit? I did not enable `SAGE_CHECKS`.


---

Comment by SimonKing created at 2014-09-12 13:06:32

Replying to [comment:25 vbraun]:
> Are you using 32bit? I did not enable `SAGE_CHECKS`.

No, I am on 64 bit. Is the file you mentioned only built on 32 bit??
----
New commits:


---

Comment by SimonKing created at 2014-09-12 13:07:47

OK, the change sounds reasonable.


---

Comment by vbraun created at 2014-09-12 13:08:08

No, I'm on x86 too. The issue comes from the `test "$ac_cv_sizeof_voidp" != 4;` so I thought it might be a bitwidth thing.


---

Comment by SimonKing created at 2014-09-12 13:16:08

By the way: I did not run the full test suite yet (now I am rebuilding from scratch), but found a surprisingly high number of test errors, given that not so long time ago the debug version passed _all_ tests.


---

Comment by vbraun created at 2014-09-12 14:56:06

Most failures seem to be from non-commutative stuff...


---

Comment by vbraun created at 2014-09-12 15:22:45

For example:

```
(gdb) break dReportError
Breakpoint 1 at 0x7fffcc699a71: file dError.c, line 28.
(gdb) cont
Continuing.

sage: F.<x,y,z> = FreeAlgebra(QQ, implementation='letterplace')
sage: I = F*[x*y+y*z,x^2+x*y-y*x-y^2]*F
sage: Q.<a,b,c> = F.quo(I); Q
Quotient of Free Associative Unital Algebra on 3 generators (x, y, z) over Rational Field by the ideal (x*y + y*z, x*x + x*y - y*x - y*y)
sage: a^3

Breakpoint 1, dReportError (fmt=0x7fffcc8b2679 "S_2_R[%d]=%d != T[%d].i_r=%d\n") at dError.c:28
28	dError.c: No such file or directory.
(gdb) bt
#0  dReportError (fmt=0x7fffcc8b2679 "S_2_R[%d]=%d != T[%d].i_r=%d\n") at dError.c:28
#1  0x00007fffcc5b860a in kTest_TS (strat=0x2d09920) at kutil.cc:861
#2  0x00007fffcc5b0598 in bbaShift (F=0x18d0638, Q=0x0, w=0x0, hilb=0x0, strat=0x2d09920, uptodeg=3, lV=3)
    at kstd2.cc:1724
#3  0x00007fffcc5a79ed in kStdShift (F=0x18d0638, Q=0x0, h=isHomog, w=0x0, hilb=0x0, syzComp=0, 
    newIdeal=0, vw=0x0, uptodeg=3, lV=3) at kstd1.cc:1912
#4  0x00007fffcc5b09ce in freegb (I=0x18d0638, uptodeg=3, lVblock=3) at kstd2.cc:1823
#5  0x00007fffcc4e2301 in jjSYSTEM (res=0x2d06588, args=0x18d0548) at extra.cc:1370
#6  0x00007fffcc4a06b5 in iiExprArithM (res=0x2d06588, a=0x18d0548, op=496) at iparith.cc:8321
#7  0x00007fffcb9c3eb9 in __pyx_f_4sage_4libs_8singular_8function_17KernelCallHandler_handle_call (
    __pyx_v_self=0x7fffb80d2880, __pyx_v_argument_list=0x7fffb80d1860, __pyx_optional_args=0x7fffffff7ef0)
    at build/cythonized/sage/libs/singular/function.cpp:12083
[...]
(gdb) cy bt
[...]
#78 0x00007ffff7cd7b2d in _reduce_() at /home/vbraun/Sage/git-develop/local/lib/python2.7/site-packages/sage/rings/quotient_ring_element.py:118
       118            self.__rep = I.reduce(self.__rep)
#83 0x00007fffb5ae04ce in reduce() at /home/vbraun/Sage/git-develop/src/sage/algebras/letterplace/letterplace_ideal.pyx:306
       306        def reduce(self, G):
#87 0x00007fffb5f90e45 in normal_form() at /home/vbraun/Sage/git-develop/src/sage/algebras/letterplace/free_algebra_element_letterplace.pyx:733
       733        def normal_form(self,I):
#93 0x00007fffb5ad9bb4 in groebner_basis() at /home/vbraun/Sage/git-develop/src/sage/algebras/letterplace/letterplace_ideal.pyx:187
---Type <return> to continue, or q <return> to quit---
       187        def groebner_basis(self, degbound=None):
#96 0x00007fffcb9c5095 in __call__() at /home/vbraun/Sage/git-develop/src/sage/libs/singular/function.pyx:1185
      1185        def __call__(self, *args, ring=None, bint interruptible=True, attributes=None):
#98 0x00007fffcb9ca76b in call_function() at /home/vbraun/Sage/git-develop/src/sage/libs/singular/function.pyx:1462
      1462                _res = self.call_handler.handle_call(argument_list, si_ring)
#99 0x00007fffcb9c3d15 in handle_call() at /home/vbraun/Sage/git-develop/src/sage/libs/singular/function.pyx:1093
      1093                iiExprArithM(res, argument_list.args, self.cmd_n)
#100 0x00007fffcc4a029d in iiExprArithM()

```



---

Comment by vbraun created at 2014-09-12 17:15:57

I can reproduce some failures just in Singular, so I've asked here: https://groups.google.com/d/msg/libsingular-devel/4fL9NKCVGw0/mlOd_vzNSG8J


---

Comment by git created at 2014-09-12 20:39:07

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-13 18:44:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-13 18:47:52

I think some internal Singular checks that get enabled with `NDEBUG` are too strict, I've added a patch removing these. I also almost despaired in `fast_map` until I noticed that `idTest` incorrectly assumes that `currRing` is set.

Now `make ptest` passes.


---

Comment by git created at 2014-09-13 20:21:31

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-13 20:24:33

Computing the invariants of an order-480 group after an order-48 group really only checks that you have a fast computer.

This fixes the last timeout in the `make ptestlong` for me.


---

Comment by SimonKing created at 2014-09-13 20:46:15

Hi Volker, I am not happy with the two commits to reduce size of doctests.

It is said in the doc that `below we do the Fateman benchmark over the finite field of order 32003`, but I guess with your changes the statement becomes wrong, it isn't the Fateman benchmark if the exponent is only 10 and not 20.

Also I don't see why a test that is marked "long" anyway should be removed just because the debug version slows it down too much.

By the way, how long does this test take in non-debug version? It is stated that it used to take 12 seconds, four years ago. And 12 seconds is totally fine for a long test, IMHO.


---

Comment by vbraun created at 2014-09-13 20:51:19

They are doctests, not benchmarks. Don't confuse the two. Really, showing off what size of a problem you can do in doctests is just an overall drag on development as people have to wait longer and longer for tests. IMHO 12 seconds is already on the long side, you should aim for <=5 for long tests.

Put differently, would you rather 
a) have a buildbot with `SAGE_DEBUG`, or 
b) doctest a huge computation and then discard the result because it can't do anything useful with the timings obtained.


---

Comment by SimonKing created at 2014-09-13 20:52:59

Replying to [comment:42 vbraun]:
> They are doctests, not benchmarks. Don't confuse the two. Really, showing off what size of a problem you can do in doctests is just an overall drag on development as people have to wait longer and longer for tests. IMHO 12 seconds is already on the long side, you should aim for <=5 for long tests.
> 
> Put differently, would you rather 
> a) have a buildbot with `SAGE_DEBUG`, or 
> b) doctest a huge computation and then discard the result because it can't do anything useful with the timings obtained.

I'd rather have c): A buildbot with `SAGE_DEBUG` that only runs the tests that are not marked long.


---

Comment by vbraun created at 2014-09-13 20:54:38

I disagree. Doctests are not benchmarks. Doctests coverage is more important than benchvertising. We should have a framework for benchmarks in addition to doctests, but stuffing benchmarks into doctests is counterproductive.


---

Comment by SimonKing created at 2014-09-14 07:57:10

I can not tell why the patchbot scripts are complaining. In any case, I get the following test failures:


```
sage -t src/sage/stats/hmm/hmm.pyx
    [118 tests, 2 failures, 1.70 s]
...
sage -t src/sage/gsl/probability_distribution.pyx
    [207 tests, 3 failures, 11.09 s]
...
sage -t src/sage/plot/plot3d/transform.pyx
    [25 tests, 1 failure, 6.27 s]
```


Unfortunately it doesn't say what the failure is. Why does it not?


---

Comment by vbraun created at 2014-09-14 11:25:03

Try `sage -t --verbose`. Also, I've never seen a failure to report whats wrong. Can you post the full log?


---

Comment by SimonKing created at 2014-09-14 13:04:44

Replying to [comment:46 vbraun]:
> Try `sage -t --verbose`.


```
**********************************************************************
File "src/sage/stats/hmm/hmm.pyx", line 282, in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel
Failed example:
    m
Expected:
    Discrete Hidden Markov Model with 2 States and 2 Emissions
    Transition matrix:
    [1.0134345614...e-70               1.0]
    [              1.0 3.997435271...e-19]
    Emission matrix:
    [7.3802215662...e-54               1.0]
    [              1.0  3.99743526...e-19]
    Initial probabilities: [0.0000, 1.0000]
Got:
    Discrete Hidden Markov Model with 2 States and 2 Emissions
    Transition matrix:
    [1.0134345614745788e-70                    1.0]
    [                   1.0 3.9974352713558623e-19]
    Emission matrix:
    [ 7.380221566254936e-54                    1.0]
    [                   1.0 3.9974352626002193e-19]
    Initial probabilities: [0.0000, 1.0000]
**********************************************************************
File "src/sage/stats/hmm/hmm.pyx", line 1236, in sage.stats.hmm.hmm.DiscreteHiddenMarkovModel.baum_welch
Failed example:
    m.baum_welch(v)
Expected:
    (-66.7823606592935..., 100)
Got:
    (-66.7823606592936, 100)
```


```
**********************************************************************
File "src/sage/gsl/probability_distribution.pyx", line 364, in sage.gsl.probability_distribution.RealDistribution
Failed example:
    T.cum_distribution_function_inv(.5)
Expected:
    3.532230067546424
Got:
    3.5322300675464247
**********************************************************************
File "src/sage/gsl/probability_distribution.pyx", line 402, in sage.gsl.probability_distribution.RealDistribution
Failed example:
    T.distribution_function(0)
Expected:
    0.3183098861837906
Got:
    0.3183098861837905
Trying (line 404):    T.cum_distribution_function(1)
Expecting:
    0.7499999999999998
**********************************************************************
File "src/sage/gsl/probability_distribution.pyx", line 404, in sage.gsl.probability_distribution.RealDistribution
Failed example:
    T.cum_distribution_function(1)
Expected:
    0.7499999999999998
Got:
    0.75
```


```
*********************************************************************
File "src/sage/plot/plot3d/transform.pyx", line 179, in sage.plot.plot3d.transform.rotate_arbitrary
Failed example:
    rotate_arbitrary((1,1,1), 2*pi/3) * vector(RDF, (1,2,3))  # rel tol 1e-15
Expected:
    (1.9999999999999996, 2.9999999999999996, 0.9999999999999999)
Got:
    (2.000000000000001, 3.0000000000000013, 1.000000000000001)
Tolerance exceeded in 1 of 3:
    0.9999999999999999 vs 1.000000000000001, tolerance 1e-15 > 1e-15
```


> Also, I've never seen a failure to report whats wrong.

Yes, but I have always seen a failure to report what has failed.

But here, there is simply nothing in the log. It simply says that some tests failed, but not WHICH test failed, not what was the expected output and the actual output, not whether there has been a crash. Absolutely nothing.

> Can you post the full log?

Not before Monday (bandwidth).

Anyway, the verbose output above indicates that we have numerical noise, not related with Singular. By the way, if that's relevant: In my local branch I have merged your gdb branch from #16978.


---

Comment by vbraun created at 2014-09-15 21:16:19

Hans sent a patch for one of the debug build issues to libsingular-devel, I've added it and removed my patch that disabled various checks. If he manages to fix the rest then we might not need my patch...
----
New commits:


---

Comment by vbraun created at 2014-09-15 21:16:19

Changing status from needs_review to needs_work.


---

Comment by git created at 2014-09-16 16:20:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-09-18 12:27:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-09-22 15:02:09

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-09-22 15:02:09

I've reported the failures on libsingular-devel and Hans posted patches for all of them. Branch now compiles/doctests fine for me without disabling any debug statements.


---

Comment by SimonKing created at 2014-09-22 15:11:21

Replying to [comment:52 vbraun]:
> I've reported the failures on libsingular-devel and Hans posted patches for all of them. Branch now compiles/doctests fine for me without disabling any debug statements.

Excellent!


---

Comment by SimonKing created at 2014-09-22 15:29:33

Replying to [comment:52 vbraun]:
> I've reported the failures on libsingular-devel and Hans posted patches for all of them. Branch now compiles/doctests fine for me without disabling any debug statements.

The branch did not change since four days. So, is it the case that the branch contains all of Hans' patches, or do you need to push another commit?


---

Comment by vbraun created at 2014-09-22 15:38:20

I was just busy elsewhere...


---

Comment by vbraun created at 2014-09-26 22:35:21

imho there is little to review here... it works, and most of the patches come straight from upstream.


---

Comment by SimonKing created at 2014-09-30 12:30:41

I'll try to review it, although I am one of the authors...


---

Comment by jdemeyer created at 2014-09-30 15:06:22

Replying to [comment:47 SimonKing]:
> But here, there is simply nothing in the log. It simply says that some tests failed, but not WHICH test failed, not what was the expected output and the actual output, not whether there has been a crash. Absolutely nothing.
I have heard occasional rumours that this happens sometimes, but I have no idea how to reproduce it.
----
New commits:


---

Comment by jdemeyer created at 2014-09-30 20:33:38

Changing status from needs_review to positive_review.


---

Comment by SimonKing created at 2014-09-30 20:40:56

Thank you, Jeroen. I would have needed to run tests overnight to finish the review. But I do think that the patched patches look OK.


---

Comment by SimonKing created at 2014-10-01 04:59:19

The `conway_polynomials` package fails to build, even though I have `SAGE_UPGRADING` set to `yes`. [See logs](http://sage.math.washington.edu/home/SimonKing/logs/conway_polynomials-0.4.p0.log)

Is there a problem with the debug? Or is it a problem with "make" and dependency checking?


---

Comment by SimonKing created at 2014-10-01 04:59:19

Changing status from positive_review to needs_info.


---

Comment by jdemeyer created at 2014-10-01 06:25:34

Did you build everything with this ticket applied and with `SAGE_DEBUG=yes`?


---

Comment by git created at 2014-10-01 07:24:33

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-10-01 07:37:32

Replying to [comment:62 SimonKing]:
> Is there a problem with the debug?
Looks like a genuine bug to me in libm4ri. I don't know why they need `sizeof(mzd_t) == 64`, but that equality is only true on 64-bit systems. Since two of the fields in `mzd_t` are pointers, this would give only 56 bytes on 32-bit systems.

I'll try to reproduce it and report upstream if it is confirmed.


---

Comment by git created at 2014-10-01 08:17:45

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-10-01 09:12:54

Replying to [comment:65 jdemeyer]:
> Replying to [comment:62 SimonKing]:
> > Is there a problem with the debug?
> Looks like a genuine bug to me in libm4ri. I don't know why they need `sizeof(mzd_t) == 64`, but that equality is only true on 64-bit systems. Since two of the fields in `mzd_t` are pointers, this would give only 56 bytes on 32-bit systems.
> 
> I'll try to reproduce it and report upstream if it is confirmed.

Would be surprising to me. After all, in an earlier debug version on this ticket, Sage did build. Now it doesn't. Anyway, I will try with your latest commit.


---

Comment by jdemeyer created at 2014-10-01 09:21:51

Replying to [comment:67 SimonKing]:
> Would be surprising to me. After all, in an earlier debug version on this ticket, Sage did build.
Was that after #16981?


---

Comment by SimonKing created at 2014-10-01 09:43:33

Replying to [comment:68 jdemeyer]:
> Replying to [comment:67 SimonKing]:
> > Would be surprising to me. After all, in an earlier debug version on this ticket, Sage did build.
> Was that after #16981?

No idea. And I actually doubt that M4RI is to blame. After all, the error occurs in the line

```
>    4    from sage.all import save
```

when installing the Conway polynomial package.


---

Comment by SimonKing created at 2014-10-01 09:45:55

Note that in addition to the install log that I posted earlier, there also is a [Crash Log](http://sage.math.washington.edu/home/SimonKing/logs/sage_crash_XN6UDt.log) that is the result of the failing import.


---

Comment by jdemeyer created at 2014-10-01 09:50:37

Replying to [comment:69 SimonKing]:
> the error occurs in the line
> {{{
> >    4    from sage.all import save
> }}}
> when installing the Conway polynomial package.
That's just the top of the traceback. Importing `sage.all` does a lot of things. The full traceback clearly shows that the problem is in m4ri:

```
Stack backtrace
---------------
[...]
#8  0xb72e9d07 in __assert_fail () from /lib/libc.so.6
No symbol table info available.
#9  0xb18e62f1 in mzd_init (r=7, c=7) at m4ri/mzd.c:151
        __PRETTY_FUNCTION__ = "mzd_init"
#10 0xb19270c4 in __pyx_pf_4sage_6matrix_17matrix_mod2_dense_17Matrix_mod2_dense___cinit__ (__pyx_v_self=0xad884034, __pyx_v_parent=0xace7b2f4, 
    __pyx_v_entries=0xad874fbc, __pyx_v_copy=0xb76a48ec <_Py_ZeroStruct>, 
    __pyx_v_coerce=0xb76a4900 <_Py_TrueStruct>, 
    __pyx_v_alloc=0xb76a4900 <_Py_TrueStruct>)
    at build/cythonized/sage/matrix/matrix_mod2_dense.c:3313
        __pyx_r = 1245376913
        __pyx_t_1 = 0x0
        __pyx_t_2 = 0x0
        __pyx_t_3 = 0x0
        __pyx_t_4 = 0
        __pyx_t_5 = 0x0
        __pyx_t_6 = 1
        __pyx_lineno = 0
        __pyx_filename = 0x0
        __pyx_clineno = 0
[...]
```



---

Comment by jdemeyer created at 2014-10-01 09:57:07

Changing status from needs_info to needs_review.


---

Comment by SimonKing created at 2014-10-01 10:04:15

Changing status from needs_review to needs_work.


---

Comment by SimonKing created at 2014-10-01 10:04:15

The build problem that I obtain is with the latest commit (53b73dbfaf33d8e28840d5b6ad91ce1bf941cffa), hence, it needs work.


---

Comment by jdemeyer created at 2014-10-01 10:06:26

Are you really really sure? The patch fixes the problem for me. Don't forget to rebuild m4ri!


---

Comment by jdemeyer created at 2014-10-01 10:06:26

Changing status from needs_work to needs_review.


---

Comment by SimonKing created at 2014-10-01 10:16:04

Replying to [comment:74 jdemeyer]:
> Are you really really sure? The patch fixes the problem for me. Don't forget to rebuild m4ri!

Then we come back to my question above: Is it a problem with dependency checking? I did `make` with `SAGE_UPGRADING=yes`, and it didn't work.


---

Comment by SimonKing created at 2014-10-01 10:17:50

For the record: Now I explicitly did `sage -i m4ri` before doing `make` again. Let's see if it works this time.


---

Comment by SimonKing created at 2014-10-01 10:28:47

It does start. Now let us wait for the tests...


---

Comment by jdemeyer created at 2014-10-01 10:49:07

Replying to [comment:75 SimonKing]:
> Is it a problem with dependency checking?
Not really. You built a broken version of m4ri before and that broken version will not automatically be updated when doing "make". However, as long as you don't first build a broken version with `SAGE_DEBUG=yes` without applying this patch, there is no problem.

One could argue that there is a problem with dependency checking in the sense that `SAGE_DEBUG=yes` does not automatically cause everything to get rebuilt. But that's really a different issue.


---

Comment by SimonKing created at 2014-10-01 10:53:30

Next, I was bitten again by the infamous "incremental documentation builds sometimes cause spurious". Sigh.


---

Comment by vbraun created at 2014-10-01 11:47:19

hashdist also takes build switches / environment variables into account for the dependency calculation, fwiw.

Until then I think its reasonable to require a "make distclean" to switch between debug and non-debug build.


---

Comment by jdemeyer created at 2014-10-01 11:51:42

Replying to [comment:80 vbraun]:
> hashdist
Is this another of the many proposals to change the Sage build system with something else? I feel like I have seen too many of these...


---

Comment by SimonKing created at 2014-10-01 12:28:11

So far there is one error, and it seems to be a serious problem, namely a segmentation fault:

```
sage -t src/sage/modular/modsym/space.py
**********************************************************************
File "src/sage/modular/modsym/space.py", line 930, in sage.modular.modsym.space.ModularSymbolsSpace._q_expansion_module
Failed example:
    ModularSymbols(11, 2, base_ring=GF(4,'a')).cuspidal_submodule()._q_expansion_module(prec=4, algorithm="hecke")
Exception raised:
    Traceback (most recent call last):
      File "/home/king/Sage/debug/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 486, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/king/Sage/debug/sage/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 849, in compile_and_execute
        exec(compiled, globs)
      File "<doctest sage.modular.modsym.space.ModularSymbolsSpace._q_expansion_module[0]>", line 1, in <module>
        ModularSymbols(Integer(11), Integer(2), base_ring=GF(Integer(4),'a')).cuspidal_submodule()._q_expansion_module(prec=Integer(4), algorithm="hecke")
      File "/home/king/Sage/debug/sage/local/lib/python2.7/site-packages/sage/modular/modsym/ambient.py", line 1392, in cuspidal_submodule
        S = self.boundary_map().kernel()
      File "/home/king/Sage/debug/sage/local/lib/python2.7/site-packages/sage/modules/matrix_morphism.py", line 649, in kernel
        V = self.matrix().kernel()
      File "sage/matrix/matrix2.pyx", line 3755, in sage.matrix.matrix2.Matrix.left_kernel (build/cythonized/sage/matrix/matrix2.c:23920)
      File "sage/matrix/matrix2.pyx", line 3596, in sage.matrix.matrix2.Matrix.right_kernel (build/cythonized/sage/matrix/matrix2.c:23371)
      File "sage/matrix/matrix2.pyx", line 3244, in sage.matrix.matrix2.Matrix.right_kernel_matrix (build/cythonized/sage/matrix/matrix2.c:22751)
      File "sage/matrix/matrix2.pyx", line 6119, in sage.matrix.matrix2.Matrix.echelon_form (build/cythonized/sage/matrix/matrix2.c:42445)
      File "sage/matrix/matrix_mod2e_dense.pyx", line 946, in sage.matrix.matrix_mod2e_dense.Matrix_mod2e_dense.echelonize (build/cythonized/sage/matrix/matrix_mod2e_dense.c:7938)
      File "sage/ext/c_lib.pyx", line 97, in sage.ext.c_lib.sig_raise_exception (build/cythonized/sage/ext/c_lib.c:1168)
    SignalError: Segmentation fault
**********************************************************************
1 item had failures:
   1 of   3 in sage.modular.modsym.space.ModularSymbolsSpace._q_expansion_module
    [313 tests, 1 failure, 43.51 s]
```



---

Comment by SimonKing created at 2014-10-01 12:29:45

Replying to [comment:80 vbraun]:
> Until then I think its reasonable to require a "make distclean" to switch between debug and non-debug build.

I did _not_ switch between debug and non-debug build. I have one sage git repository which I have never touched without `SAGE_DEBUG` being set to `yes`. Nevertheless, things got wrong.


---

Comment by jdemeyer created at 2014-10-01 12:33:14

Replying to [comment:83 SimonKing]:
> Nevertheless, things got wrong.
...while testing a ticket in development. You cannot do development without things breaking now and then. The goal is that the end result of a ticket works, there are no guarantees about what happens in between.


---

Comment by vbraun created at 2014-10-01 12:35:51

Martin, can you comment on the 64-bit alignment issue in m4ri?


---

Comment by jdemeyer created at 2014-10-01 12:37:42

Replying to [comment:82 SimonKing]:
> So far there is one error, and it seems to be a serious problem, namely a segmentation fault:
Works for me. The problem seems to be in `m4rie`, did you remember to rebuild with `SAGE_UPGRADING=yes` after rebuilding `mpir`?


---

Comment by SimonKing created at 2014-10-01 12:40:00

Replying to [comment:86 jdemeyer]:
> Replying to [comment:82 SimonKing]:
> > So far there is one error, and it seems to be a serious problem, namely a segmentation fault:
> Works for me. Did you remember to rebuild with `SAGE_UPGRADING=yes` after rebuilding `mpir`?

I currently have `SAGE_UPGRADING=yes` by default.


---

Comment by SimonKing created at 2014-10-01 12:42:27

Replying to [comment:84 jdemeyer]:
> Replying to [comment:83 SimonKing]:
> > Nevertheless, things got wrong.
> ...while testing a ticket in development. You cannot do development without things breaking now and then. The goal is that the end result of a ticket works, there are no guarantees about what happens in between.

OK, but I think that dependency checking should work, regardless whether it is a debug or a non-debug built.

Anyway, meanwhile I got loads of other errors. I will next try `make distclean` and `make`, with `SAGE_DEBUG=yes` and unsetting `SAGE_UPGRADING`.


---

Comment by jdemeyer created at 2014-10-01 12:47:55

Replying to [comment:88 SimonKing]:
> OK, but I think that dependency checking should work, regardless whether it is a debug or a non-debug built.
Dependency checking works (modulo #17072).

The problem is that building with `SAGE_DEBUG=yes` didn't work before, but the problem with `m4ri` wasn't seen at build-time of `m4ri`. Therefore, the build system thinks that the build of `m4ri` was successful, even though it was completely broken. This is a very specific set of circumstances, I don't think it requires a fix to the build system.


---

Comment by jdemeyer created at 2014-10-01 13:20:10

Simon, just to be sure, I will try to reproduce your bug on a 32-bit system:

```
$ export SAGE_UPGRADING=yes SAGE_DEBUG=yes
$ git checkout 0fb627916b73a741be1d942b0d94fd0046dc2536
$ make    # should fail in conway_polynomials
$ git checkout 53b73dbfaf33d8e28840d5b6ad91ce1bf941cffa
$ ./sage -f m4ri
$ make ptest
```



---

Comment by SimonKing created at 2014-10-01 13:29:05

Replying to [comment:90 jdemeyer]:
> Simon, just to be sure, I will try to reproduce your bug on a 32-bit system:
> {{{
> $ export SAGE_UPGRADING=yes SAGE_DEBUG=yes
> $ git checkout 0fb627916b73a741be1d942b0d94fd0046dc2536
> $ make    # should fail in conway_polynomials
> $ git checkout 53b73dbfaf33d8e28840d5b6ad91ce1bf941cffa
> $ ./sage -f m4ri
> $ make ptest
> }}}

I am on 64 bit, if I am not mistaken.


---

Comment by jdemeyer created at 2014-10-01 13:32:18

Replying to [comment:91 SimonKing]:
> I am on 64 bit, if I am not mistaken.
Your [comment:62 previous error] was on a 32-bit system.


---

Comment by SimonKing created at 2014-10-01 13:44:39

Replying to [comment:92 jdemeyer]:
> Replying to [comment:91 SimonKing]:
> > I am on 64 bit, if I am not mistaken.
> Your [comment:62 previous error] was on a 32-bit system.

I did all tests related with this ticket on the same machine, namely my `OpenSuse` laptop, and I am pretty sure that it is x86_64. Although I can currently not recall how to find out the architecture. In any case, `cat /proc/cpuinfo` tells me that I have two Intel(R) Core(TM)2 Duo.


---

Comment by jdemeyer created at 2014-10-01 13:51:11

Replying to [comment:93 SimonKing]:
> I did all tests related with this ticket on the same machine, namely my `OpenSuse` laptop, and I am pretty sure that it is x86_64.
Perhaps the hardware is 64-bit, but the kernel in the logs you posted is 32-bit.

> Although I can currently not recall how to find out the architecture.
`uname -m` prints the "machine hardware name" which is probably what you want.


---

Comment by SimonKing created at 2014-10-01 14:02:52


```
uname -m
i686
```

whatever that means.


---

Comment by vbraun created at 2014-10-01 14:40:31

That means 32-bit with a certain set of ISA extensions beyond the i386 (requires Pentium Pro / Pentium II and newer). If you have < 4GB then this is would be the recommended installation.


---

Comment by SimonKing created at 2014-10-01 14:47:21

Replying to [comment:96 vbraun]:
> That means 32-bit with a certain set of ISA extensions beyond the i386 (requires Pentium Pro / Pentium II and newer). If you have < 4GB then this is would be the recommended installation.

Interesting. Currently I have 4 GB. Can I change the installation without to much hassle when upgrading the memory in future?


---

Comment by vbraun created at 2014-10-01 14:51:13

I don't think any distro supports architecture changes. Just install x86_64 on a separate partition / btrfs volume and mound your /home.


---

Comment by SimonKing created at 2014-10-01 22:48:54

After make distclean, make test did almost work. I got no timeouts, and the following errors:

```
sage -t src/sage/stats/hmm/hmm.pyx  # 2 doctests failed
sage -t src/sage/schemes/elliptic_curves/period_lattice_region.pyx  # 1 doctest failed
sage -t src/sage/gsl/probability_distribution.pyx  # 3 doctests failed
sage -t src/sage/plot/plot3d/transform.pyx  # 1 doctest failed
```


Unfortunately, I again encounter the problem that the test log does not indicate what tests went wrong, it just gives the number of failing tests.


---

Comment by jdemeyer created at 2014-10-02 07:06:24

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-10-02 08:33:25

There is a very strange thing happening on this 32-bit system. When running doctests with `make ptest`, a lot of tests fail. When running those tests indivually, most of them pass (except for the ones [comment:99 mentioned by Simon]). So there is certainly something fishy going on.

This might be due to [https://savannah.gnu.org/bugs/?22010](https://savannah.gnu.org/bugs/?22010), I'm upgrading `make` to see if that fixes it.


---

Comment by jdemeyer created at 2014-10-02 08:59:24

I am investigating the doctest failures reported by Simon, hang on...


---

Comment by git created at 2014-10-02 12:01:03

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by SimonKing created at 2014-10-02 12:21:52

Can you elaborate on the "periodic lattice" commit?


---

Comment by jdemeyer created at 2014-10-02 12:24:27

Replying to [comment:105 SimonKing]:
> Can you elaborate on the "periodic lattice" commit?
See #17088


---

Comment by SimonKing created at 2014-10-02 12:30:00

Replying to [comment:106 jdemeyer]:
> Replying to [comment:105 SimonKing]:
> > Can you elaborate on the "periodic lattice" commit?
> See #17088

OK. Running tests now. Hope it will work this time...


---

Comment by jdemeyer created at 2014-10-02 13:15:03

I still get random segmentation faults with long tests in `src/sage/matrix/matrix_integer_dense_hnf.py`


---

Comment by jdemeyer created at 2014-10-02 13:23:24

If you're interested in debugging on Linux: see also #17089.


---

Comment by SimonKing created at 2014-10-02 13:26:00

Replying to [comment:108 jdemeyer]:
> I still get random segmentation faults with long tests in `src/sage/matrix/matrix_integer_dense_hnf.py`

O_o...

I thought the point of a debug version is that all segmentation faults will be non-random, reproducible and accompanied by a useful C backtrace.


---

Comment by jdemeyer created at 2014-10-02 13:30:22

Replying to [comment:110 SimonKing]:
> accompanied by a useful C backtrace.
...at least we have this (modulo #17089)


---

Comment by jdemeyer created at 2014-10-02 13:41:35

The command which crashes is

```
sage: from sage.matrix.matrix_integer_dense_hnf import benchmark_hnf; benchmark_hnf([50,100],32)
```



---

Comment by SimonKing created at 2014-10-02 13:42:27

I wonder whether random segmentation faults in the debug version should prevent this ticket from getting a positive review. After all, if segmentation faults show up then probably there is a problem in the non-debug version as well. This ticket is not about fixing the segmentation fault, but it is about providing the means to analyse segmentation fault.


---

Comment by jdemeyer created at 2014-10-02 14:02:13

Replying to [comment:113 SimonKing]:
> This ticket is not about fixing the segmentation fault, but it is about providing the means to analyse segmentation fault.
Exactly, the segfault issue is #17090.


---

Comment by jdemeyer created at 2014-10-02 14:02:13

Changing status from needs_work to needs_review.


---

Comment by vbraun created at 2014-10-02 16:26:35

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-10-02 16:26:35

lgtm


---

Comment by vbraun created at 2014-10-05 22:39:11

Resolution: fixed
