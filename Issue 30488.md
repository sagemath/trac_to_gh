# Issue 30488: macOS: spkg-install: Remove outdated "Building with clang" branches

Issue created by migration from https://trac.sagemath.org/ticket/30725

Original creator: mkoeppe

Original creation time: 2020-10-05 02:07:31

CC:  jhpalmieri dimpase @kliem @zlscherr fbissey slabbe


```
$ git grep MACOSX_VERSION
build/pkgs/curl/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then
build/pkgs/curl/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang and --with-darwinssl."
build/pkgs/pari/spkg-install.in:MACOSX_VERSION=`uname -r | awk -F. '{print $1}'`
build/pkgs/pari/spkg-install.in:if [ $MACOSX_VERSION -ge 14 ]; then
build/pkgs/psutil/spkg-install.in:if [ "$UNAME" = "Darwin" ] && [ $MACOSX_VERSION -ge 16 ]; then
build/pkgs/psutil/spkg-install.in:    echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
build/pkgs/python3/spkg-build.in:    if [ $MACOSX_VERSION -ge 16 ]; then
build/pkgs/python3/spkg-build.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 14 ]; then
build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Configuring R without aqua support."
build/pkgs/r/spkg-install.in:    if [ $MACOSX_VERSION -ge 16 ]; then
build/pkgs/r/spkg-install.in:        echo "OS X 10.$[$MACOSX_VERSION-4] Building with clang."
```



---

Comment by mkoeppe created at 2021-01-16 17:59:21

Changing priority from minor to blocker.


---

Comment by fbissey created at 2021-01-18 01:47:04

Those bits should have gone when I "normalised" clang for building sage on OS X. We were probably planing to remove them at a later stage and forgot.

Well, the opportunity is clearly now.
----
New commits:


---

Comment by mkoeppe created at 2021-01-18 01:58:50

Also several of these packages have been updated since and are able to build with an actual gcc on macOS. We have tickets for some packages where this is still broken: #29613 (givaro)


---

Comment by git created at 2021-01-18 05:26:51

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-01-18 05:27:20

Changing status from new to needs_review.


---

Comment by mkoeppe created at 2021-01-18 07:01:35

I have tested the configuration in the ticket description successfully.

But testing with the `gcc-10` from homebrew, I am still running into issues with macOS header files that are not compatible with gcc.

```
  [cmake-3.18.2] installing. Log file: /Users/mkoeppe/s/sage/sage-rebasing/worktree-algebraic-2018-spring/logs/pkgs/cmake-3.18.2.log
  [cmake-3.18.2] error installing, exit status 1. End of log file:
  [cmake-3.18.2]   /Library/Developer/CommandLineTools/SDKs/MacOSX10.15.sdk/System/Library/Frameworks/ImageIO.framework/Headers/CGImageAnimation.h:42:15: error: expected unqualified-id before '^' token
  [cmake-3.18.2]      42 | typedef void (^CGImageSourceAnimationBlock)(size_t index, CGImageRef image, bool* stop);
  [cmake-3.18.2]         |               ^
```



---

Comment by @kliem created at 2021-01-18 07:03:46

Btw, to prevent breackage because of `-march=native`, one can also `export CFLAGS=CFLAGS_NON_NATIVE` etc. right after setting the compiler to clang.


---

Comment by mkoeppe created at 2021-01-18 07:08:20

Changing status from needs_review to needs_work.


---

Comment by mkoeppe created at 2021-01-18 07:08:20

Yes, if simple fixes such as package upgrades don't fix it, that's what we should do.


---

Comment by mkoeppe created at 2021-01-18 07:50:50

Upgrade of cmake to 3.19.3 (#31258) does not fix this


---

Comment by dimpase created at 2021-01-18 16:39:04

I don't understand - I presume one still cannot build all of Sage on macOS using "real" gcc.

Why is this a blocker?


---

Comment by mkoeppe created at 2021-01-18 17:32:24

Replying to [comment:19 dimpase]:
> I don't understand - I presume one still cannot build all of Sage on macOS using "real" gcc.

Yes, this is what the experiment with `cmake` has just revealed.

> Why is this a blocker?

When Apple's compiler is invoked as `clang` instead of `gcc`, it does not understand the same flags. So #27122 leads to build errors.


---

Comment by mkoeppe created at 2021-01-18 18:31:50

The `curl` build also fails:

```
vtls/darwinssl.c: In function 'show_verbose_server_cert':
vtls/darwinssl.c:2711:6: error: 'SecTrustEvaluateAsync' undeclared (first use in this function); did you mean 'SecTrustEvaluate'?
 2711 |   if(SecTrustEvaluateAsync != NULL) {
      |      ^~~~~~~~~~~~~~~~~~~~~
      |      SecTrustEvaluate
```

An update to current curl (#31260) does not fix this. Either version works fine with clang.


---

Comment by git created at 2021-01-18 18:37:07

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by mkoeppe created at 2021-01-18 18:37:44

Replying to [comment:16 gh-kliem]:
> Btw, to prevent breackage because of `-march=native`, one can also `export CFLAGS=CFLAGS_NON_NATIVE` etc. right after setting the compiler to clang.

I have backed out the previous attempt and will use this approach now.


---

Comment by dimpase created at 2021-01-18 18:39:38

Are you saying that `CC=clang CXX=clang++ ./configure && make` does not work any more on macOS - or it does, but not setting CC and CXX breaks down? 

Invoking Apple's clang as gcc is a kludge that sooner or later should become a problem, are you saying  it already is one?


---

Comment by mkoeppe created at 2021-01-18 18:49:49

Replying to [comment:26 dimpase]:
> Are you saying that `CC=clang CXX=clang++ ./configure && make` does not work any more on macOS - or it does,

It does work - in this case, these compilers will be tested for what flags they accept.

> but not setting CC and CXX breaks down? 

That's right. The issue arises from the `spkg-install` scripts changing the compiler to `clang` and continuing to use CFLAGS that have been determined by the configure script for a different compiler (`/usr/bin/gcc`).


---

Comment by dimpase created at 2021-01-18 19:07:03

Oh, so on macOS `/usr/bin/gcc` has become a _different_ from `/usr/bin/clang` (or whatever the path is) front-end to "real" clang? Thanks, Apple, this is a great help.


---

Comment by mkoeppe created at 2021-01-18 19:08:29

Yes, they have different interfaces.


---

Comment by fbissey created at 2021-01-18 19:09:52

It is more like `/usr/bin/gcc` is a front end that can filter command line options specific to gcc. This is not a new behavior. And this is a problem now that we have committed to some specific gcc options.


---

Comment by git created at 2021-01-18 19:29:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2021-01-18 19:29:59

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2021-01-20 10:16:17

R does not use `-march=native` anyway.
`python/spkg-build.in` is set up a bit different. `$CFLAGS` contains other stuff and `$EXTRA_CFLAGS` is contains the old `$CFLAGS`, so we need to set `$EXTRA_CFLAGS`.

Anyway, I think the main problem is that we run `testcfags.sh` before setting the compiler.
We might as well run this for `$CFLAGS` as well after possibly changing the compiler.
----
New commits:


---

Comment by mkoeppe created at 2021-01-20 20:50:48

Replying to [comment:35 gh-kliem]:
> R does not use `-march=native` anyway.

... is it ignoring CFLAGS?


---

Comment by @kliem created at 2021-01-20 20:59:19

No, it already uses `CFLAGS_NON_NATIVE`.

```
 10 # #29170: Compilation errors caused by a silently failing configure check
 11 # "for type of 'hidden' Fortran character lengths"
 12 # on ubuntu-bionic-minimal, ubuntu-eoan/focal-minimal, debian-buster/bullseye/sid-minimal,
 13 # linuxmint-19.3-minimal, archlinux-latest-minimal
 14 CFLAGS="$CFLAGS_NON_NATIVE -fPIC"
 15 FCFLAGS="$FCFLAGS_NON_NATIVE -fPIC"
```



---

Comment by mkoeppe created at 2021-01-20 21:00:28

Ah, OK, thanks


---

Comment by @kliem created at 2021-01-20 21:00:45

R was one of the things that crashed or didn't build with `-march=native` (don't remember), so I disalbed it in #27122.


---

Comment by @kliem created at 2021-01-21 07:36:18

My tests finished. Not very sucessfull though. Looks like zlib failed for many mac runs.

Also ubuntu-bionic-minimal and debian-buster-minimal failed because somehow ssl wasn't available and the pytest failed (or the server did not reply).

Anyway. There are several different ways to fix `python3/spkg-build.in` of course.


---

Comment by mkoeppe created at 2021-01-21 22:58:14

Replying to [comment:41 gh-kliem]:
> My tests finished. Not very sucessfull though. Looks like zlib failed for many mac runs.
> 
> Also ubuntu-bionic-minimal and debian-buster-minimal failed because somehow ssl wasn't available and the pytest failed (or the server did not reply).

One needs to merge a few tickets that fix up the GH Actions runs.


---

Comment by mkoeppe created at 2021-01-21 22:59:32

Replying to [comment:41 gh-kliem]:
> There are several different ways to fix `python3/spkg-build.in` of course.

Are you satisfied with the version that you pushed?


---

Comment by @kliem created at 2021-01-22 06:54:29

Replying to [comment:43 mkoeppe]:
> Replying to [comment:41 gh-kliem]:
> > There are several different ways to fix `python3/spkg-build.in` of course.
> 
> Are you satisfied with the version that you pushed?

Yes.


---

Comment by @kliem created at 2021-01-22 06:54:57

And I'm also happy with your changes.

I'm just waiting on an okay, that this fixes things.


---

Comment by @zlscherr created at 2021-01-22 22:02:06

Is this supposed to fix issues around using /usr/bin/python3 on Big Sur? With this ticket if I configure with-python=/usr/bin/python3 and then do make Cython I still get



```
gcc -Wno-unused-result -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -iwithsysroot/System/Library/Frameworks/System.framework/PrivateHeaders -iwithsysroot/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/Headers -arch arm64 -arch x86_64 -O2 -g -march=native -I/Users/zscherr/sage/develop/local/include -I/Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.8/include/python3.8 -c /private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-rpwm0h2y/Cython/Plex/Scanners.c -o build/temp.macosx-10.14.6-x86_64-3.8/private/var/folders/5f/z870t4kd5dlctkcrs984nh8r0000gn/T/pip-req-build-rpwm0h2y/Cython/Plex/Scanners.o
  clang: error: the clang compiler does not support '-march=native'
  error: command 'gcc' failed with exit status 1
```



---

Comment by @kliem created at 2021-01-22 22:20:13

Does it go away, if you additionally pull in #31228?

This one just disables `-march=native` regardless, if the compiler of system python does not understand it. What might be more clever, is to just disable `-march=native` in the definition of `sdh_pip_install`.


---

Comment by mkoeppe created at 2021-01-22 22:42:31

Replying to [comment:47 gh-zlscherr]:
> Is this supposed to fix issues around using /usr/bin/python3 on Big Sur? 
No, it's only a first step


---

Comment by @zlscherr created at 2021-01-22 23:55:48

Replying to [comment:48 gh-kliem]:
> Does it go away, if you additionally pull in #31228?
> 
> This one just disables `-march=native` regardless, if the compiler of system python does not understand it. What might be more clever, is to just disable `-march=native` in the definition of `sdh_pip_install`.

Thanks! Yes, with this ticket and #31228 I can get python packages (at least cython) to build again using system python.  I'll continue to check to make sure everything builds.


---

Comment by @kliem created at 2021-01-23 10:07:11

I think this is good to go.


---

Comment by @kliem created at 2021-01-23 10:07:11

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2021-01-31 20:53:57

Resolution: fixed
