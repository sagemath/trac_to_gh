# Issue 29134: little tweak in mac-app

Issue created by migration from https://trac.sagemath.org/ticket/29371

Original creator: chapoton

Original creation time: 2020-03-19 20:23:37

CC:  dimpase @maverickwoo @shlokatadistance iandrus slelievre vbraun

about grep command line options

as suggested by https://groups.google.com/forum/#!topic/sage-support/gf0aR8b_vk0


---

Comment by chapoton created at 2020-03-19 20:24:15

Changing status from new to needs_review.


---

Comment by chapoton created at 2020-03-19 20:24:15

New commits:


---

Comment by jhpalmieri created at 2020-03-20 03:53:54

I don't know how to test this because I can't produce a functioning app with or without this patch.


---

Comment by chapoton created at 2020-03-20 07:53:12

Well, this seems to be innocuous enough.

The proposer on sage-support could be the reviewer, but I cannot answer him there.


---

Comment by dimpase created at 2020-03-20 08:09:44

Perhaps Volker can review it.


---

Comment by slelievre created at 2020-03-20 15:20:12

Changing keywords from "" to "macOS, app".


---

Comment by slelievre created at 2020-03-20 15:20:12

Cc a few extra "macOS" people.


---

Comment by @Shlokatadistance created at 2020-03-21 20:14:42

Hello, following the discussion from https://groups.google.com/forum/#!topic/sage-support/gf0aR8b_vk0, I had reported this previously about how it was breaking from the paths. it worked once with a temporary fix and the second time when I granted complete permissions to sagemath. I am however skeptical of the latter because it was rather odd for an application explicitly needing complete and direct drive access


---

Comment by @rana-aerea created at 2020-03-23 16:49:05

Thank you for accepting my proposal.
I managed to compile sage-9.0 + sag-9.0/src/mac-app and the version with the proposal it took 6 hours.
I tested running the both version.
The older version is slightly slower.
Alternatively, I tested the code of pipes.


```sh
myhome$ cat sage.log | grep -i --context 1 'Notebook is running at' | grep --line-buffered -o -e "http://.*" 
grep: Notebook is running at: No such file or directory 
myhome$ cat sage.log | grep -i --line-buffered --context=1 'Notebook is running at' | grep --line-buffered -o -e "http://.*"  
..... 
http://localhost:8888/?token=XXX...X
```


The previous code is an error and the proposal detects the address. (ticket being hidden by XXX...X.

I compare two versions  in new local account.


---

Comment by @maverickwoo created at 2020-03-24 04:44:38

Sorry, this was my fault in #28661.  On my Mac, I use GNU grep and I forgot about that when testing that revision. I confirm the equal sign in `--context=1` is indeed required. My apologies!

However, I am not sure why `--line-buffered` is needed here even though having it shouldn't break things.


---

Comment by chapoton created at 2020-03-24 07:30:31

so, who will dare to give a positive review, ladies and gentlemen ?


---

Comment by @rana-aerea created at 2020-03-24 09:51:08

I am working on it.

My trial:

Step 1. Create a new account where no initialization is done for Jupyter.

Step 2. Copy updated SageMath-9.0 and reference version (original SageMath-9.0) to some location accessible to the new account.

Step 3. Compare the two versions in new account.

Current Status:
The two versions I compiled both have absolute pathnames somewhere in them.

Copying SageMath-9.0.app from the disk image did not change this situation.

The problem is that the path  (in bash script and somewhere I do not know)) points to the same new version.
(!echo in Jupyter notebook shows missing of subdirectory of build directory and the subdirectory of the copied application.)

I will make two copies of the source tree of Sagemath and compile them again.
I think I can make some part of the comparison.
But I am afraid my environment differs from the user's environment.

If someone tells me how to make a relocatable copy of SageMath-9.0 or SageMath-9.1 and make a packages which resemble the distribution, I can do a better test.

Partial Information I got so far:

Original SageMath-9.0 has a incompatibility problem with insertion of new debugging messages.
Indeed, it was unable to invoke jupyter server when I inserted two or three instances of echo commands.

```python
# @rana-aerea
# debugging code
echo >&2 -e "PATH=$PATH" ;
# echo >&2 -e "SAGE_ROOT=$SAGE_ROOT" ;
echo >&2 -e "CWD=`pwd`" ;
```

(I have no intension to include the three debugging messages in the distribution.)

Another observation is the log file misses all messages after the first one of these debugging information.

Right now, coping of the updated version from the disk image finished.
I added the same three commands of echo to SageMath-9.0/sage. I activated the second one, too.
I double clicked this version.
In sage.log, I found the path, the SAGE_ROOT and the current working directory and more messages.
This is a side evidence of some function of the option "--line buffered".
I do not see version information of sage itself.

I continue my test. I think I can report the result in 24 hours.


---

Comment by dimpase created at 2020-03-25 15:17:25

binary distributions of Sage are made using
https://github.com/sagemath/binary-pkg


---

Comment by @rana-aerea created at 2020-03-25 15:23:28

Step 1: Delete sage.log
Step 2: Invoke two copies one at a time. Open a Jupiter notebook and shutdown the kernel. Then view log.
(Guest account and the account of compilation.)

Result:
In both accounts, the comparison has the same conclusion.
The original version printed only one line of message in the sage.log.
The updated version printed several messages until the last message complaining kernel not found.

The conclusion of the review is "go".

Thank you for the message on binary distributions.
I will study it and solve the problem of signature.


---

Comment by chapoton created at 2020-03-25 17:08:53

if you agree with the ticket, you should set the status to "Positive Review" and put your real name in the "Author" box of the ticket (use the Modify ticket button)


---

Comment by chapoton created at 2020-03-28 20:39:20

so nobody dares to give a positive review ? Damn...


---

Comment by jhpalmieri created at 2020-03-28 21:29:40

Changing status from needs_review to positive_review.


---

Comment by jhpalmieri created at 2020-03-28 21:29:40

Okay, fine.


---

Comment by @rana-aerea created at 2020-03-29 07:51:53

I apologize for very slow response.
I succeeded in compiling relocatable version of Sagemath.
The next thing I must do is to reflect the change in relocatable version.


---

Comment by @rana-aerea created at 2020-03-29 15:00:13

I manage to produce disk-image-file of SageMath-9.1beta9 with the  proposed code of this ticket.
The resulting program solves the first bug reported in sage-support group 
"Sage 9.0 macOS Jupyter Server failed to start" ( https://groups.google.com/forum/#!topic/sage-support/gf0aR8b_vk0 ).

The bug was this: the pipes "sage ... | tee ... | grep ... | grep ... " got stuck after the second last stage of pipes terminated by error.
This caused tee to terminate. The termination occurred when the buffer was full.
Then, the first stage also terminated in a way we cannot understand form the source code of the bash script sage.

If someone is aware of suppressing logs for saving Mac application from strange failure, I ask him/her/them to enable logging.


---

Comment by @rana-aerea created at 2020-03-29 15:02:22

The update now fixes the bug reported by Dr. Murray Eisenberg in "Sage 9.0 macOS Jupyter Server failed to start" ( https://groups.google.com/forum/#!topic/sage-support/gf0aR8b_vk0 ).


---

Comment by vbraun created at 2020-04-05 08:30:32

Resolution: fixed
