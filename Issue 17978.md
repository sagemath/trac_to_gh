# Issue 17978: Huge speed up for hash of quadratic number field elements

Issue created by migration from Trac.

Original creator: vdelecroix

Original creation time: 2015-04-15 23:58:40

CC:  ncohen

Before

```
sage: L.<a> = QuadraticField(-7)
sage: b = a - 13/7
sage: timeit("hash(b)")
625 loops, best of 3: 54 Âµs per loop
```

After

```
sage: L.<a> = QuadraticField(-7)
sage: b = a - 13/7
sage: timeit("hash(b)")
625 loops, best of 3: 97.7 ns per loop
```

... looks like a x500 speed up :-)


---

Comment by vdelecroix created at 2015-04-15 23:59:38

Changing status from new to needs_review.


---

Comment by vdelecroix created at 2015-04-15 23:59:38

New commits:


---

Comment by jdemeyer created at 2015-04-16 06:03:12

Is there a reason why the hash _should_ be the same as the one for the polynomial?


---

Comment by vdelecroix created at 2015-04-16 08:10:00

Replying to [comment:2 jdemeyer]:
> Is there a reason why the hash _should_ be the same as the one for the polynomial?

No idea. But it make sense. It was the previous implementation. I did not want to break anything.

On the other hand, it does not take the parent into account and 'sqrt(2) + 3/2' and 'sqrt(3) + 3/2' would have the same hash.

What do you think?


---

Comment by git created at 2015-04-16 19:37:04

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by vdelecroix created at 2015-04-16 19:37:35

Simpler implementation that is not the one of polynomials (based on 6.7.beta1).


---

Comment by ncohen created at 2015-04-16 20:18:18

Hello,

Can you tell where this `42082631` comes from? Also, is it true that `mpz_pythonhash(self.b)` is zero when `self.b` is 0 ? It must hold if you want the hash of this element and the hash defined on Q to match.


---

Comment by vdelecroix created at 2015-04-16 20:35:20

Replying to [comment:8 ncohen]:
> Hello,
> 
> Can you tell where this `42082631` comes from?

This is to avoid conflicts for small values of `a` and `b`. It avoids conflicts between `a=1, b=-1` and `a=b=0`.

> Also, is it true that `mpz_pythonhash(self.b)` is zero when `self.b` is 0 ?

Yes. This is the same algorithm as Python hash for `int/long`.


---

Comment by ncohen created at 2015-04-16 21:06:08

Changing status from needs_review to positive_review.


---

Comment by vdelecroix created at 2015-04-16 21:15:31

Thanks Nathann!


---

Comment by git created at 2015-04-18 15:02:33

Changing status from positive_review to needs_review.


---

Comment by git created at 2015-04-18 15:02:33

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by ncohen created at 2015-04-18 16:18:42

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2015-04-19 01:52:05

Resolution: fixed
