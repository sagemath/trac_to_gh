# Issue 25126: Add '--simple-prompt' argument for sage

Issue created by migration from Trac.

Original creator: @mmmm1998

Original creation time: 2018-05-14 16:16:47

CC:  slelievre embray jdemeyer charpent dimpase

Keywords: ipython

IPython accept --simple-prompt argument, that change prompt_toolkit to raw_input for input handler.

It very usufull, if sage could pass this argument to ipython, likewise -gthread, -qthread, -q4thread, -wthread and -pylab arguments, because there is program Cantor - frontend for mathematical packages and this feature will fix broken Sage backend for Cantor.

I could attach format patch with my suggestion for changing the sage, if it needed.

P.S. I am not too familiar with trac, so if I have created ticket incorrect or I even shouldn't to create a ticket for this suggestion, please, correct me.


---

Attachment

Format patch


---

Comment by chapoton created at 2018-05-14 16:48:48

I have made a proper git branch.
----
New commits:


---

Comment by chapoton created at 2018-05-14 16:48:48

Changing status from new to needs_review.


---

Comment by slelievre created at 2018-05-15 14:09:26

Changing keywords from "ipython" to "Cantor, ipython".


---

Comment by slelievre created at 2018-05-15 14:09:26

Changing type from PLEASE CHANGE to enhancement.


---

Comment by slelievre created at 2018-05-15 14:09:26

It would be nice to fix the Sage backend for Cantor!


---

Comment by chapoton created at 2018-06-26 10:02:37

review, somebody ?


---

Comment by mmezzarobba created at 2018-06-26 11:52:18

Changing status from needs_review to needs_work.


---

Comment by mmezzarobba created at 2018-06-26 11:52:18


```
$ ./sage --simple-prompt
/home/marc/co/sage/src/bin/sage: line 1067: [: missing `]'
```



---

Comment by git created at 2018-06-26 11:54:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2018-06-26 11:54:44

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2018-06-26 11:54:44

oops, fixed


---

Comment by embray created at 2018-06-26 12:09:00

This seems fine in principle, though, I would call it just `-simple-prompt` with a single hyphen since, although inconsistent with IPython, is at least consistent with how the existing arguments are spelled in Sage (which itself is a somewhat unfortunate historical convention).  I would actually like to completely redo Sage's CLI, but priorities priorities...

Now, as for this change, other than the single hyphen thing this is fine since it's consistent with what's already done.  But I hadn't looked at this bit of code before and I find it rather suspicious in the first place.  I don't like that there's some hard-coded list of arguments that happen to be arguments recognized as belonging to IPython in order to determine that the user is trying to invoke an interactive prompt, because as you've pointed out here it does not scale--it's just an arbitrary subset of IPython arguments, and does not inherit new IPython arguments or additional ones that one might want to use.  Let me take a closer look at this problem and think about it a bit...


---

Comment by mmezzarobba created at 2018-06-26 12:22:30

The `--simple-prompt` option now works, but this does not seem to be enough to fix the Sage backend in Cantor. (On my system, the backend now starts, but it still fails to evaluate expressions.)


---

Comment by embray created at 2018-06-26 12:41:00

In fact, with the exception of `--pylab` (which itself is deprecated) most of those options don't work anymore:


```
$ ./sage -gthread
...
[SageTerminalApp] CRITICAL | Unrecognized flag: '-gthread'
```



---

Comment by embray created at 2018-06-26 12:44:19

How does the Sage backend in Cantor work?  Is it like, pexpect-based or something?  I would suggest that it not be.  Sage is, ultimately, a Python library, so there's no need to use it through Sage's interactive prompt, in order to pass input and receive output.  That said, I have no idea how Cantor's backends work in general.


---

Comment by embray created at 2018-06-26 13:09:05

This preserves the existing (still rather kludgy) CLI semantics, while not hard-coding a limited subset of IPython CLI options.  This means you can also pass `--simple-prompt` which works as expected.
----
New commits:


---

Comment by embray created at 2018-06-26 13:09:20

Oops, based on wrong branch.


---

Comment by git created at 2018-06-26 13:09:49

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by embray created at 2018-06-26 13:10:05

Rebased on develop.


---

Comment by embray created at 2018-06-26 13:29:03

I forgot to mention, this also drops the existing support for passing an `.spkg` file as the first argument.  Legacy spkgs are deprecated anyways, and AFAICT it's not actually explicitly documented anywhere that you can do that in the first place.  Even the [docs](http://doc.sagemath.org/html/en/developer/packaging_old_spkgs.html) for old-style spkgs mention running `sage -p foo.spkg` but not `sage foo.spkg`.  So I think this is justifiable.


---

Comment by chapoton created at 2018-06-26 14:30:08

Indeed, better this way. Looks good to me.


---

Comment by chapoton created at 2018-06-26 14:30:08

Changing status from needs_review to positive_review.


---

Comment by @mmmm1998 created at 2018-06-26 17:15:45

Replying to [comment:12 embray]:
> How does the Sage backend in Cantor work?  Is it like, pexpect-based or something?  I would suggest that it not be.  Sage is, ultimately, a Python library, so there's no need to use it through Sage's interactive prompt, in order to pass input and receive output.  That said, I have no idea how Cantor's backends work in general.

Now, Sage backend use KPtyProcess. Common in Cantor we use QProcess or C API, but in Sage case we have bash script, which run sage program by using `exac`, and, as I know, QProcess don't work with bash `exac`, so it's just a necessity.


---

Comment by embray created at 2018-06-27 14:14:29

I wouldn't go through the `sage` shell script, but rather directly through a Python interpreter.  You just have to make sure to pre-parse the input to convert it from Sage's Python syntax superset to pure Python.  The `sage-preparse` script in `src/bin/` demonstrates how Sage does this for entire files, but it can also be done for individual expressions and statements before passing it along to the normal Python interpreter.  If I have more time later perhaps I can look at the code for the Cantor backend.


---

Comment by embray created at 2018-06-27 14:14:45

I'm curious how things like plots and images works though.


---

Comment by vbraun created at 2018-07-08 10:46:54

See patchbot


---

Comment by vbraun created at 2018-07-08 10:46:54

Changing status from positive_review to needs_work.


---

Comment by embray created at 2018-07-09 09:52:31

This is a little tricky to get just right.  While I believe it's desirable to be able to pass any IPython option on to Sage, we can't easily "pre-parse" those options without digging directly into IPython's command-line parsing.  This will be a bit easier to deal with if/when I redo the `sage` CLI, which does badly need to be modernized.

In the meantime this still has the "correct" behavior, but it causes Sage to "partially" start up (it displays the banner and everything) and then outputs `Unrecognized flag --zzfoobar` preceded by the entire _ipython_ help message, which would be confusing to users who don't necessarily understand that ipython is underlying the `sage` CLI.

Let me see if I can do something a bit better in the meantime...


---

Comment by embray created at 2018-07-09 10:03:14

I think it should be easy to reorganize `sage-ipython` a little bit, as well as enhance `sage.repl.interpreter` so that we can make command-line parsing happen earlier, and display `sage --help` instead of the `ipython --help`.  I would also add a `sage --help-ipython` as a shortcut to display all options accepted by the underlying IPython REPL.


---

Comment by vdelecroix created at 2018-08-03 19:20:18

update milestone 8.3 -> 8.4


---

Comment by mkoeppe created at 2020-08-11 15:52:10

Changing priority from major to critical.


---

Comment by jhpalmieri created at 2020-08-11 16:47:38

I looked at the old commits, and I am concerned that they are too ambitious: they would pass any unrecognized command-line flag to ipython. Here is a more modest proposal:

```diff
diff --git a/src/bin/sage b/src/bin/sage
index ce325f5d03..bc192ab6e5 100755
--- a/src/bin/sage
+++ b/src/bin/sage
`@``@` -1045,7 +1045,7 `@``@` if [ "$1" = '-omega' -o "$1" = "--omega" ]; then
     exec sage-omega "$`@`"
 fi
 
-if [ "$1" = '-gthread' -o "$1" = '-qthread' -o "$1" = '-q4thread' -o "$1" = '-wthread' -o "$1" = '-pylab' ]; then
+if [ "$1" = '-gthread' -o "$1" = '-qthread' -o "$1" = '-q4thread' -o "$1" = '-wthread' -o "$1" = '-pylab' -o "$1" = '--simple-prompt' -o "$1" = '-simple-prompt' ]; then
     # Intentionally no "shift" here
     interactive_sage "$`@`"
 fi
```

(The new option should also be listed in the help message.)


---

Comment by jhpalmieri created at 2020-08-11 17:00:47

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2020-08-11 17:00:47

Here is an actual branch. The more ambitious changes can happen on another ticket, but we should get this done quickly to fix the emacs problem. (Any problem with emacs has a critical priority, at least.)
----
New commits:


---

Comment by charpent created at 2020-08-11 17:06:37

Thank you, John.

Now, the question is to adopt your patch or to use it as a stopgap until more ambitious (and more reasoned) changes to Sage-s arguments implement long-awaited features can be (carefully) validated...


---

Comment by charpent created at 2020-08-11 17:09:03

Replying to [comment:30 jhpalmieri]:
> [ Snip... ] (Any problem with emacs has a critical priority, at least.)

Seconded. With extreme energy...


---

Comment by charpent created at 2020-08-11 17:25:07

Replying to [comment:30 jhpalmieri]:
> Here is an actual branch. The more ambitious changes can happen on another ticket, but we should get this done quickly to fix the emacs problem. (Any problem with emacs has a critical priority, at least.)
> ----
> New commits:
> ||[3b8b2bd](https://git.sagemath.org/sage.git/commit?id=3b8b2bd0eb414b41a21f38c7a1a6bb667a432294)||`trac 25363: implement "sage --simple-prompt"`||

OK. It does what the label says : the `sage-shell-mode` session is functional again. Now running `ptestlong` by principle.

Stay tuned.


---

Comment by jhpalmieri created at 2020-08-11 17:27:22

Replying to [comment:31 charpent]:
> Thank you, John.
> 
> Now, the question is to adopt your patch or to use it as a stopgap until more ambitious (and more reasoned) changes to Sage-s arguments implement long-awaited features can be (carefully) validated...

See also #21.


---

Comment by charpent created at 2020-08-11 18:29:08

Replying to [comment:34 jhpalmieri]:

> See also #21.

Both typesetting and plots work (tested in *simple* cases...).

I'm currently scratching my head to figure how to patch `sage-shell-mode` (and possibly `ob-sagemath` to support Sage>9.2.beta8 without loosing support for Sage<=9.2.beta7 (9.2.beta8 itself is a lost cause...). While `ptestlong` runs (and heats the cosmos...).


---

Comment by charpent created at 2020-08-11 18:45:33

Replying to [comment:36 charpent]:
> Replying to [comment:34 jhpalmieri]:
> 
> > See also #21.
> 
> Both typesetting and plots work (tested in *simple* cases...).
> 
> I'm currently scratching my head to figure how to patch `sage-shell-mode` (and possibly `ob-sagemath` to support Sage>9.2.beta8 without loosing support for Sage<=9.2.beta7 (9.2.beta8 itself is a lost cause...). While `ptestlong` runs (and heats the cosmos...).

However, `quit()` is no longer enough to close Sage : `emacs` hangs after printing `Process Sage interrompre` two lines below the `Exiting Sage (CPU time 0m12.27s, Wall time 20m30.50s).` message.

Back to the old drawing board...


---

Comment by jhpalmieri created at 2020-08-11 18:57:08

Emacs does not hang for me after running `quit()`. I could switch to another buffer, back to the Sage buffer, and run Sage again:

```
sage: quit()
Exiting Sage (CPU time 0m0.47s, Wall time 0m24.00s).

Process Sage finished
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2.beta8, Release Date: 2020-08-10               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: 3+5
8
sage: 
```

This also worked after I turned off my `.emacs` file (the moral equivalent of `emacs -q`). Could something in your emacs setup be interfering?


---

Comment by charpent created at 2020-08-11 19:27:57

Replying to [comment:37 charpent]:

[ ... ]

> However, `quit()` is no longer enough to close Sage : `emacs` hangs after printing `Process Sage interrompre` two lines below the `Exiting Sage (CPU time 0m12.27s, Wall time 20m30.50s).` message.
> 
> Back to the old drawing board...


I was a tad pessimistic : `emacs` doesn't really hangs, and can be left by `C-x C-c`, without need for `kill`.


---

Comment by charpent created at 2020-08-11 20:02:01

This passes `ptestlong` with results identical to those already reported since 9.2.beta5.

==>`positive_review`


---

Comment by charpent created at 2020-08-11 20:02:01

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2020-08-14 22:23:53

Resolution: fixed
