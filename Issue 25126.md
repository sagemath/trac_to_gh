# Issue 25126: Add '--simple-prompt' argument for sage

archive/issues_025126.json:
```json
{
    "body": "CC:  @slel @embray @jdemeyer @EmmanuelCharpentier @dimpase\n\nKeywords: ipython\n\nIPython accept --simple-prompt argument, that change prompt_toolkit to raw_input for input handler.\n\nIt very usufull, if sage could pass this argument to ipython, likewise -gthread, -qthread, -q4thread, -wthread and -pylab arguments, because there is program Cantor - frontend for mathematical packages and this feature will fix broken Sage backend for Cantor.\n\nI could attach format patch with my suggestion for changing the sage, if it needed.\n\nP.S. I am not too familiar with trac, so if I have created ticket incorrect or I even shouldn't to create a ticket for this suggestion, please, correct me.\n\nIssue created by migration from https://trac.sagemath.org/ticket/25363\n\n",
    "created_at": "2018-05-14T16:16:47Z",
    "labels": [
        "component: scripts"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "Add '--simple-prompt' argument for sage",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/25126",
    "user": "https://github.com/mmmm1998"
}
```
CC:  @slel @embray @jdemeyer @EmmanuelCharpentier @dimpase

Keywords: ipython

IPython accept --simple-prompt argument, that change prompt_toolkit to raw_input for input handler.

It very usufull, if sage could pass this argument to ipython, likewise -gthread, -qthread, -q4thread, -wthread and -pylab arguments, because there is program Cantor - frontend for mathematical packages and this feature will fix broken Sage backend for Cantor.

I could attach format patch with my suggestion for changing the sage, if it needed.

P.S. I am not too familiar with trac, so if I have created ticket incorrect or I even shouldn't to create a ticket for this suggestion, please, correct me.

Issue created by migration from https://trac.sagemath.org/ticket/25363





---

archive/issue_comments_353211.json:
```json
{
    "body": "Attachment [0001-Add-new-option-for-ipython-simple-prompt.patch](tarball://root/attachments/some-uuid/ticket25363/0001-Add-new-option-for-ipython-simple-prompt.patch) by @mmmm1998 created at 2018-05-14 16:17:31\n\nFormat patch",
    "created_at": "2018-05-14T16:17:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353211",
    "user": "https://github.com/mmmm1998"
}
```

Attachment [0001-Add-new-option-for-ipython-simple-prompt.patch](tarball://root/attachments/some-uuid/ticket25363/0001-Add-new-option-for-ipython-simple-prompt.patch) by @mmmm1998 created at 2018-05-14 16:17:31

Format patch



---

archive/issue_comments_353212.json:
```json
{
    "body": "I have made a proper git branch.\n----\nNew commits:",
    "created_at": "2018-05-14T16:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353212",
    "user": "https://github.com/fchapoton"
}
```

I have made a proper git branch.
----
New commits:



---

archive/issue_comments_353213.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-05-14T16:48:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353213",
    "user": "https://github.com/fchapoton"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_353214.json:
```json
{
    "body": "Changing keywords from \"ipython\" to \"Cantor, ipython\".",
    "created_at": "2018-05-15T14:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353214",
    "user": "https://github.com/slel"
}
```

Changing keywords from "ipython" to "Cantor, ipython".



---

archive/issue_comments_353215.json:
```json
{
    "body": "Changing type from PLEASE CHANGE to enhancement.",
    "created_at": "2018-05-15T14:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353215",
    "user": "https://github.com/slel"
}
```

Changing type from PLEASE CHANGE to enhancement.



---

archive/issue_comments_353216.json:
```json
{
    "body": "It would be nice to fix the Sage backend for Cantor!",
    "created_at": "2018-05-15T14:09:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353216",
    "user": "https://github.com/slel"
}
```

It would be nice to fix the Sage backend for Cantor!



---

archive/issue_comments_353217.json:
```json
{
    "body": "review, somebody ?",
    "created_at": "2018-06-26T10:02:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353217",
    "user": "https://github.com/fchapoton"
}
```

review, somebody ?



---

archive/issue_comments_353218.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-06-26T11:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353218",
    "user": "https://github.com/mezzarobba"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_353219.json:
```json
{
    "body": "\n```\n$ ./sage --simple-prompt\n/home/marc/co/sage/src/bin/sage: line 1067: [: missing `]'\n```\n",
    "created_at": "2018-06-26T11:52:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353219",
    "user": "https://github.com/mezzarobba"
}
```


```
$ ./sage --simple-prompt
/home/marc/co/sage/src/bin/sage: line 1067: [: missing `]'
```




---

archive/issue_comments_353220.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-06-26T11:54:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353220",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_353221.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-06-26T11:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353221",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_353222.json:
```json
{
    "body": "oops, fixed",
    "created_at": "2018-06-26T11:54:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353222",
    "user": "https://github.com/fchapoton"
}
```

oops, fixed



---

archive/issue_comments_353223.json:
```json
{
    "body": "This seems fine in principle, though, I would call it just `-simple-prompt` with a single hyphen since, although inconsistent with IPython, is at least consistent with how the existing arguments are spelled in Sage (which itself is a somewhat unfortunate historical convention).  I would actually like to completely redo Sage's CLI, but priorities priorities...\n\nNow, as for this change, other than the single hyphen thing this is fine since it's consistent with what's already done.  But I hadn't looked at this bit of code before and I find it rather suspicious in the first place.  I don't like that there's some hard-coded list of arguments that happen to be arguments recognized as belonging to IPython in order to determine that the user is trying to invoke an interactive prompt, because as you've pointed out here it does not scale--it's just an arbitrary subset of IPython arguments, and does not inherit new IPython arguments or additional ones that one might want to use.  Let me take a closer look at this problem and think about it a bit...",
    "created_at": "2018-06-26T12:09:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353223",
    "user": "https://github.com/embray"
}
```

This seems fine in principle, though, I would call it just `-simple-prompt` with a single hyphen since, although inconsistent with IPython, is at least consistent with how the existing arguments are spelled in Sage (which itself is a somewhat unfortunate historical convention).  I would actually like to completely redo Sage's CLI, but priorities priorities...

Now, as for this change, other than the single hyphen thing this is fine since it's consistent with what's already done.  But I hadn't looked at this bit of code before and I find it rather suspicious in the first place.  I don't like that there's some hard-coded list of arguments that happen to be arguments recognized as belonging to IPython in order to determine that the user is trying to invoke an interactive prompt, because as you've pointed out here it does not scale--it's just an arbitrary subset of IPython arguments, and does not inherit new IPython arguments or additional ones that one might want to use.  Let me take a closer look at this problem and think about it a bit...



---

archive/issue_comments_353224.json:
```json
{
    "body": "The `--simple-prompt` option now works, but this does not seem to be enough to fix the Sage backend in Cantor. (On my system, the backend now starts, but it still fails to evaluate expressions.)",
    "created_at": "2018-06-26T12:22:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353224",
    "user": "https://github.com/mezzarobba"
}
```

The `--simple-prompt` option now works, but this does not seem to be enough to fix the Sage backend in Cantor. (On my system, the backend now starts, but it still fails to evaluate expressions.)



---

archive/issue_comments_353225.json:
```json
{
    "body": "In fact, with the exception of `--pylab` (which itself is deprecated) most of those options don't work anymore:\n\n\n```\n$ ./sage -gthread\n...\n[SageTerminalApp] CRITICAL | Unrecognized flag: '-gthread'\n```\n",
    "created_at": "2018-06-26T12:41:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353225",
    "user": "https://github.com/embray"
}
```

In fact, with the exception of `--pylab` (which itself is deprecated) most of those options don't work anymore:


```
$ ./sage -gthread
...
[SageTerminalApp] CRITICAL | Unrecognized flag: '-gthread'
```




---

archive/issue_comments_353226.json:
```json
{
    "body": "How does the Sage backend in Cantor work?  Is it like, pexpect-based or something?  I would suggest that it not be.  Sage is, ultimately, a Python library, so there's no need to use it through Sage's interactive prompt, in order to pass input and receive output.  That said, I have no idea how Cantor's backends work in general.",
    "created_at": "2018-06-26T12:44:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353226",
    "user": "https://github.com/embray"
}
```

How does the Sage backend in Cantor work?  Is it like, pexpect-based or something?  I would suggest that it not be.  Sage is, ultimately, a Python library, so there's no need to use it through Sage's interactive prompt, in order to pass input and receive output.  That said, I have no idea how Cantor's backends work in general.



---

archive/issue_comments_353227.json:
```json
{
    "body": "This preserves the existing (still rather kludgy) CLI semantics, while not hard-coding a limited subset of IPython CLI options.  This means you can also pass `--simple-prompt` which works as expected.\n----\nNew commits:",
    "created_at": "2018-06-26T13:09:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353227",
    "user": "https://github.com/embray"
}
```

This preserves the existing (still rather kludgy) CLI semantics, while not hard-coding a limited subset of IPython CLI options.  This means you can also pass `--simple-prompt` which works as expected.
----
New commits:



---

archive/issue_comments_353228.json:
```json
{
    "body": "Oops, based on wrong branch.",
    "created_at": "2018-06-26T13:09:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353228",
    "user": "https://github.com/embray"
}
```

Oops, based on wrong branch.



---

archive/issue_comments_353229.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-06-26T13:09:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353229",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_353230.json:
```json
{
    "body": "Rebased on develop.",
    "created_at": "2018-06-26T13:10:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353230",
    "user": "https://github.com/embray"
}
```

Rebased on develop.



---

archive/issue_comments_353231.json:
```json
{
    "body": "I forgot to mention, this also drops the existing support for passing an `.spkg` file as the first argument.  Legacy spkgs are deprecated anyways, and AFAICT it's not actually explicitly documented anywhere that you can do that in the first place.  Even the [docs](http://doc.sagemath.org/html/en/developer/packaging_old_spkgs.html) for old-style spkgs mention running `sage -p foo.spkg` but not `sage foo.spkg`.  So I think this is justifiable.",
    "created_at": "2018-06-26T13:29:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353231",
    "user": "https://github.com/embray"
}
```

I forgot to mention, this also drops the existing support for passing an `.spkg` file as the first argument.  Legacy spkgs are deprecated anyways, and AFAICT it's not actually explicitly documented anywhere that you can do that in the first place.  Even the [docs](http://doc.sagemath.org/html/en/developer/packaging_old_spkgs.html) for old-style spkgs mention running `sage -p foo.spkg` but not `sage foo.spkg`.  So I think this is justifiable.



---

archive/issue_comments_353232.json:
```json
{
    "body": "Indeed, better this way. Looks good to me.",
    "created_at": "2018-06-26T14:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353232",
    "user": "https://github.com/fchapoton"
}
```

Indeed, better this way. Looks good to me.



---

archive/issue_comments_353233.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-06-26T14:30:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353233",
    "user": "https://github.com/fchapoton"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_353234.json:
```json
{
    "body": "Replying to [comment:12 embray]:\n> How does the Sage backend in Cantor work?  Is it like, pexpect-based or something?  I would suggest that it not be.  Sage is, ultimately, a Python library, so there's no need to use it through Sage's interactive prompt, in order to pass input and receive output.  That said, I have no idea how Cantor's backends work in general.\n\nNow, Sage backend use KPtyProcess. Common in Cantor we use QProcess or C API, but in Sage case we have bash script, which run sage program by using `exac`, and, as I know, QProcess don't work with bash `exac`, so it's just a necessity.",
    "created_at": "2018-06-26T17:15:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353234",
    "user": "https://github.com/mmmm1998"
}
```

Replying to [comment:12 embray]:
> How does the Sage backend in Cantor work?  Is it like, pexpect-based or something?  I would suggest that it not be.  Sage is, ultimately, a Python library, so there's no need to use it through Sage's interactive prompt, in order to pass input and receive output.  That said, I have no idea how Cantor's backends work in general.

Now, Sage backend use KPtyProcess. Common in Cantor we use QProcess or C API, but in Sage case we have bash script, which run sage program by using `exac`, and, as I know, QProcess don't work with bash `exac`, so it's just a necessity.



---

archive/issue_comments_353235.json:
```json
{
    "body": "I wouldn't go through the `sage` shell script, but rather directly through a Python interpreter.  You just have to make sure to pre-parse the input to convert it from Sage's Python syntax superset to pure Python.  The `sage-preparse` script in `src/bin/` demonstrates how Sage does this for entire files, but it can also be done for individual expressions and statements before passing it along to the normal Python interpreter.  If I have more time later perhaps I can look at the code for the Cantor backend.",
    "created_at": "2018-06-27T14:14:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353235",
    "user": "https://github.com/embray"
}
```

I wouldn't go through the `sage` shell script, but rather directly through a Python interpreter.  You just have to make sure to pre-parse the input to convert it from Sage's Python syntax superset to pure Python.  The `sage-preparse` script in `src/bin/` demonstrates how Sage does this for entire files, but it can also be done for individual expressions and statements before passing it along to the normal Python interpreter.  If I have more time later perhaps I can look at the code for the Cantor backend.



---

archive/issue_comments_353236.json:
```json
{
    "body": "I'm curious how things like plots and images works though.",
    "created_at": "2018-06-27T14:14:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353236",
    "user": "https://github.com/embray"
}
```

I'm curious how things like plots and images works though.



---

archive/issue_comments_353237.json:
```json
{
    "body": "See patchbot",
    "created_at": "2018-07-08T10:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353237",
    "user": "https://github.com/vbraun"
}
```

See patchbot



---

archive/issue_comments_353238.json:
```json
{
    "body": "Changing status from positive_review to needs_work.",
    "created_at": "2018-07-08T10:46:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353238",
    "user": "https://github.com/vbraun"
}
```

Changing status from positive_review to needs_work.



---

archive/issue_comments_353239.json:
```json
{
    "body": "This is a little tricky to get just right.  While I believe it's desirable to be able to pass any IPython option on to Sage, we can't easily \"pre-parse\" those options without digging directly into IPython's command-line parsing.  This will be a bit easier to deal with if/when I redo the `sage` CLI, which does badly need to be modernized.\n\nIn the meantime this still has the \"correct\" behavior, but it causes Sage to \"partially\" start up (it displays the banner and everything) and then outputs `Unrecognized flag --zzfoobar` preceded by the entire *ipython* help message, which would be confusing to users who don't necessarily understand that ipython is underlying the `sage` CLI.\n\nLet me see if I can do something a bit better in the meantime...",
    "created_at": "2018-07-09T09:52:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353239",
    "user": "https://github.com/embray"
}
```

This is a little tricky to get just right.  While I believe it's desirable to be able to pass any IPython option on to Sage, we can't easily "pre-parse" those options without digging directly into IPython's command-line parsing.  This will be a bit easier to deal with if/when I redo the `sage` CLI, which does badly need to be modernized.

In the meantime this still has the "correct" behavior, but it causes Sage to "partially" start up (it displays the banner and everything) and then outputs `Unrecognized flag --zzfoobar` preceded by the entire *ipython* help message, which would be confusing to users who don't necessarily understand that ipython is underlying the `sage` CLI.

Let me see if I can do something a bit better in the meantime...



---

archive/issue_comments_353240.json:
```json
{
    "body": "I think it should be easy to reorganize `sage-ipython` a little bit, as well as enhance `sage.repl.interpreter` so that we can make command-line parsing happen earlier, and display `sage --help` instead of the `ipython --help`.  I would also add a `sage --help-ipython` as a shortcut to display all options accepted by the underlying IPython REPL.",
    "created_at": "2018-07-09T10:03:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353240",
    "user": "https://github.com/embray"
}
```

I think it should be easy to reorganize `sage-ipython` a little bit, as well as enhance `sage.repl.interpreter` so that we can make command-line parsing happen earlier, and display `sage --help` instead of the `ipython --help`.  I would also add a `sage --help-ipython` as a shortcut to display all options accepted by the underlying IPython REPL.



---

archive/issue_comments_353241.json:
```json
{
    "body": "update milestone 8.3 -> 8.4",
    "created_at": "2018-08-03T19:20:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353241",
    "user": "https://github.com/videlec"
}
```

update milestone 8.3 -> 8.4



---

archive/issue_comments_353242.json:
```json
{
    "body": "Changing priority from major to critical.",
    "created_at": "2020-08-11T15:52:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353242",
    "user": "https://github.com/mkoeppe"
}
```

Changing priority from major to critical.



---

archive/issue_comments_353243.json:
```json
{
    "body": "I looked at the old commits, and I am concerned that they are too ambitious: they would pass any unrecognized command-line flag to ipython. Here is a more modest proposal:\n\n```diff\ndiff --git a/src/bin/sage b/src/bin/sage\nindex ce325f5d03..bc192ab6e5 100755\n--- a/src/bin/sage\n+++ b/src/bin/sage\n@@ -1045,7 +1045,7 @@ if [ \"$1\" = '-omega' -o \"$1\" = \"--omega\" ]; then\n     exec sage-omega \"$@\"\n fi\n \n-if [ \"$1\" = '-gthread' -o \"$1\" = '-qthread' -o \"$1\" = '-q4thread' -o \"$1\" = '-wthread' -o \"$1\" = '-pylab' ]; then\n+if [ \"$1\" = '-gthread' -o \"$1\" = '-qthread' -o \"$1\" = '-q4thread' -o \"$1\" = '-wthread' -o \"$1\" = '-pylab' -o \"$1\" = '--simple-prompt' -o \"$1\" = '-simple-prompt' ]; then\n     # Intentionally no \"shift\" here\n     interactive_sage \"$@\"\n fi\n```\n\n(The new option should also be listed in the help message.)",
    "created_at": "2020-08-11T16:47:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353243",
    "user": "https://github.com/jhpalmieri"
}
```

I looked at the old commits, and I am concerned that they are too ambitious: they would pass any unrecognized command-line flag to ipython. Here is a more modest proposal:

```diff
diff --git a/src/bin/sage b/src/bin/sage
index ce325f5d03..bc192ab6e5 100755
--- a/src/bin/sage
+++ b/src/bin/sage
@@ -1045,7 +1045,7 @@ if [ "$1" = '-omega' -o "$1" = "--omega" ]; then
     exec sage-omega "$@"
 fi
 
-if [ "$1" = '-gthread' -o "$1" = '-qthread' -o "$1" = '-q4thread' -o "$1" = '-wthread' -o "$1" = '-pylab' ]; then
+if [ "$1" = '-gthread' -o "$1" = '-qthread' -o "$1" = '-q4thread' -o "$1" = '-wthread' -o "$1" = '-pylab' -o "$1" = '--simple-prompt' -o "$1" = '-simple-prompt' ]; then
     # Intentionally no "shift" here
     interactive_sage "$@"
 fi
```

(The new option should also be listed in the help message.)



---

archive/issue_comments_353244.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-08-11T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353244",
    "user": "https://github.com/jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_353245.json:
```json
{
    "body": "Here is an actual branch. The more ambitious changes can happen on another ticket, but we should get this done quickly to fix the emacs problem. (Any problem with emacs has a critical priority, at least.)\n----\nNew commits:",
    "created_at": "2020-08-11T17:00:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353245",
    "user": "https://github.com/jhpalmieri"
}
```

Here is an actual branch. The more ambitious changes can happen on another ticket, but we should get this done quickly to fix the emacs problem. (Any problem with emacs has a critical priority, at least.)
----
New commits:



---

archive/issue_comments_353246.json:
```json
{
    "body": "Thank you, John.\n\nNow, the question is to adopt your patch or to use it as a stopgap until more ambitious (and more reasoned) changes to Sage-s arguments implement long-awaited features can be (carefully) validated...",
    "created_at": "2020-08-11T17:06:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353246",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Thank you, John.

Now, the question is to adopt your patch or to use it as a stopgap until more ambitious (and more reasoned) changes to Sage-s arguments implement long-awaited features can be (carefully) validated...



---

archive/issue_comments_353247.json:
```json
{
    "body": "Replying to [comment:30 jhpalmieri]:\n> [ Snip... ] (Any problem with emacs has a critical priority, at least.)\n\nSeconded. With extreme energy...",
    "created_at": "2020-08-11T17:09:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353247",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:30 jhpalmieri]:
> [ Snip... ] (Any problem with emacs has a critical priority, at least.)

Seconded. With extreme energy...



---

archive/issue_comments_353248.json:
```json
{
    "body": "Replying to [comment:30 jhpalmieri]:\n> Here is an actual branch. The more ambitious changes can happen on another ticket, but we should get this done quickly to fix the emacs problem. (Any problem with emacs has a critical priority, at least.)\n> ----\n> New commits:\n> ||[3b8b2bd](https://git.sagemath.org/sage.git/commit?id=3b8b2bd0eb414b41a21f38c7a1a6bb667a432294)||`trac 25363: implement \"sage --simple-prompt\"`||\n\nOK. It does what the label says : the `sage-shell-mode` session is functional again. Now running `ptestlong` by principle.\n\nStay tuned.",
    "created_at": "2020-08-11T17:25:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353248",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:30 jhpalmieri]:
> Here is an actual branch. The more ambitious changes can happen on another ticket, but we should get this done quickly to fix the emacs problem. (Any problem with emacs has a critical priority, at least.)
> ----
> New commits:
> ||[3b8b2bd](https://git.sagemath.org/sage.git/commit?id=3b8b2bd0eb414b41a21f38c7a1a6bb667a432294)||`trac 25363: implement "sage --simple-prompt"`||

OK. It does what the label says : the `sage-shell-mode` session is functional again. Now running `ptestlong` by principle.

Stay tuned.



---

archive/issue_comments_353249.json:
```json
{
    "body": "Replying to [comment:31 charpent]:\n> Thank you, John.\n> \n> Now, the question is to adopt your patch or to use it as a stopgap until more ambitious (and more reasoned) changes to Sage-s arguments implement long-awaited features can be (carefully) validated...\n\nSee also #21.",
    "created_at": "2020-08-11T17:27:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353249",
    "user": "https://github.com/jhpalmieri"
}
```

Replying to [comment:31 charpent]:
> Thank you, John.
> 
> Now, the question is to adopt your patch or to use it as a stopgap until more ambitious (and more reasoned) changes to Sage-s arguments implement long-awaited features can be (carefully) validated...

See also #21.



---

archive/issue_comments_353250.json:
```json
{
    "body": "Replying to [comment:34 jhpalmieri]:\n\n> See also #21.\n\nBoth typesetting and plots work (tested in *simple* cases...).\n\nI'm currently scratching my head to figure how to patch `sage-shell-mode` (and possibly `ob-sagemath` to support Sage>9.2.beta8 without loosing support for Sage<=9.2.beta7 (9.2.beta8 itself is a lost cause...). While `ptestlong` runs (and heats the cosmos...).",
    "created_at": "2020-08-11T18:29:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353250",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:34 jhpalmieri]:

> See also #21.

Both typesetting and plots work (tested in *simple* cases...).

I'm currently scratching my head to figure how to patch `sage-shell-mode` (and possibly `ob-sagemath` to support Sage>9.2.beta8 without loosing support for Sage<=9.2.beta7 (9.2.beta8 itself is a lost cause...). While `ptestlong` runs (and heats the cosmos...).



---

archive/issue_comments_353251.json:
```json
{
    "body": "Replying to [comment:36 charpent]:\n> Replying to [comment:34 jhpalmieri]:\n> \n> > See also #21.\n> \n> Both typesetting and plots work (tested in *simple* cases...).\n> \n> I'm currently scratching my head to figure how to patch `sage-shell-mode` (and possibly `ob-sagemath` to support Sage>9.2.beta8 without loosing support for Sage<=9.2.beta7 (9.2.beta8 itself is a lost cause...). While `ptestlong` runs (and heats the cosmos...).\n\nHowever, `quit()` is no longer enough to close Sage : `emacs` hangs after printing `Process Sage interrompre` two lines below the `Exiting Sage (CPU time 0m12.27s, Wall time 20m30.50s).` message.\n\nBack to the old drawing board...",
    "created_at": "2020-08-11T18:45:33Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353251",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:36 charpent]:
> Replying to [comment:34 jhpalmieri]:
> 
> > See also #21.
> 
> Both typesetting and plots work (tested in *simple* cases...).
> 
> I'm currently scratching my head to figure how to patch `sage-shell-mode` (and possibly `ob-sagemath` to support Sage>9.2.beta8 without loosing support for Sage<=9.2.beta7 (9.2.beta8 itself is a lost cause...). While `ptestlong` runs (and heats the cosmos...).

However, `quit()` is no longer enough to close Sage : `emacs` hangs after printing `Process Sage interrompre` two lines below the `Exiting Sage (CPU time 0m12.27s, Wall time 20m30.50s).` message.

Back to the old drawing board...



---

archive/issue_comments_353252.json:
```json
{
    "body": "Emacs does not hang for me after running `quit()`. I could switch to another buffer, back to the Sage buffer, and run Sage again:\n\n```\nsage: quit()\nExiting Sage (CPU time 0m0.47s, Wall time 0m24.00s).\n\nProcess Sage finished\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 SageMath version 9.2.beta8, Release Date: 2020-08-10               \u2502\n\u2502 Using Python 3.7.3. Type \"help()\" for help.                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250f\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2513\n\u2503 Warning: this is a prerelease version, and it may be unstable.     \u2503\n\u2517\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u251b\nsage: 3+5\n8\nsage: \n```\n\nThis also worked after I turned off my `.emacs` file (the moral equivalent of `emacs -q`). Could something in your emacs setup be interfering?",
    "created_at": "2020-08-11T18:57:08Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353252",
    "user": "https://github.com/jhpalmieri"
}
```

Emacs does not hang for me after running `quit()`. I could switch to another buffer, back to the Sage buffer, and run Sage again:

```
sage: quit()
Exiting Sage (CPU time 0m0.47s, Wall time 0m24.00s).

Process Sage finished
┌────────────────────────────────────────────────────────────────────┐
│ SageMath version 9.2.beta8, Release Date: 2020-08-10               │
│ Using Python 3.7.3. Type "help()" for help.                        │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: 3+5
8
sage: 
```

This also worked after I turned off my `.emacs` file (the moral equivalent of `emacs -q`). Could something in your emacs setup be interfering?



---

archive/issue_comments_353253.json:
```json
{
    "body": "Replying to [comment:37 charpent]:\n\n[ ... ]\n\n> However, `quit()` is no longer enough to close Sage : `emacs` hangs after printing `Process Sage interrompre` two lines below the `Exiting Sage (CPU time 0m12.27s, Wall time 20m30.50s).` message.\n> \n> Back to the old drawing board...\n\n\nI was a tad pessimistic : `emacs` doesn't really hangs, and can be left by `C-x C-c`, without need for `kill`.",
    "created_at": "2020-08-11T19:27:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353253",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Replying to [comment:37 charpent]:

[ ... ]

> However, `quit()` is no longer enough to close Sage : `emacs` hangs after printing `Process Sage interrompre` two lines below the `Exiting Sage (CPU time 0m12.27s, Wall time 20m30.50s).` message.
> 
> Back to the old drawing board...


I was a tad pessimistic : `emacs` doesn't really hangs, and can be left by `C-x C-c`, without need for `kill`.



---

archive/issue_comments_353254.json:
```json
{
    "body": "This passes `ptestlong` with results identical to those already reported since 9.2.beta5.\n\n==>`positive_review`",
    "created_at": "2020-08-11T20:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353254",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

This passes `ptestlong` with results identical to those already reported since 9.2.beta5.

==>`positive_review`



---

archive/issue_comments_353255.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-11T20:02:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353255",
    "user": "https://github.com/EmmanuelCharpentier"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_023416.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2020-08-14T22:23:53Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/25126#event-23416"
}
```



---

archive/issue_comments_353256.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-14T22:23:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/25126",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/25126#issuecomment-353256",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
