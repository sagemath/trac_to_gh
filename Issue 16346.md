# Issue 16346: clean up fmpz_t and fmpz_poly_t declarations

Issue created by migration from https://trac.sagemath.org/ticket/16583

Original creator: malb

Original creation time: 2014-06-28 17:14:18

Keywords: sd59

Update fmpz.pxi and fmpz_poly.pxi so that Cython doesn't complain about referenced before assigment any more.


---

Comment by malb created at 2014-06-28 17:15:34

New commits:


---

Comment by malb created at 2014-06-28 17:15:34

Changing status from new to needs_review.


---

Comment by chapoton created at 2014-07-21 18:42:23

This needs to be rebased, there is a conflict..


---

Comment by chapoton created at 2014-07-21 18:42:23

Changing status from needs_review to needs_work.


---

Comment by chapoton created at 2014-07-21 18:42:55

and a typo in the second commit, by the way.


---

Comment by git created at 2014-07-22 14:12:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-07-22 14:13:06

rebased & fixed typo


---

Comment by chapoton created at 2014-07-25 11:28:13

Is this related to #13532 ?


---

Comment by malb created at 2014-07-25 15:35:47

Yep, it removes some of those warnings. The big TODO is to fix mpz_t, though, which is a lot of work.


---

Comment by chapoton created at 2014-08-26 17:09:38

I rebased on 6.4.beta1, hopefully in a correct way
----
New commits:


---

Comment by git created at 2014-08-26 17:12:01

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by malb created at 2014-08-27 08:57:42

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-08-27 08:57:42

I guess this should be 'needs review'. Your rebasing looks good.


---

Comment by jdemeyer created at 2014-08-27 20:52:23

In `src/sage/libs/flint/fmpz_poly.pxd`, what's the reason you remove the declaration for `fmpz_poly_reverse` but not `fmpz_poly_revert_series`? I think both can be removed.


---

Comment by jdemeyer created at 2014-08-27 21:03:38

Looks good. If you agree with my reviewer patch, then it's positive_review for me.
----
New commits:


---

Comment by malb created at 2014-08-27 21:14:20

looks good.


---

Comment by malb created at 2014-08-27 21:14:20

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-08-27 21:17:12

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2014-08-27 21:17:12

Sorry, just found an issue. In `fmpq_poly.pxd`, there still is

```
    ctypedef void * fmpz_t
    ctypedef void * fmpq_poly_t
```

I'll create a patch.


---

Comment by git created at 2014-08-27 21:43:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jdemeyer created at 2014-08-27 21:43:29

Changing status from needs_work to needs_review.


---

Comment by malb created at 2014-08-28 08:19:48

Looks good.


---

Comment by malb created at 2014-08-28 08:19:48

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-08-28 15:46:25

Some doctests still import `fmpq_poly.pxd`:

```
sage -t --long src/sage/misc/cython.py
**********************************************************************
File "src/sage/misc/cython.py", line 254, in sage.misc.cython.pyx_preparse
Failed example:
    module = sage.misc.cython.import_test("trac11680")  # long time (7s on sage.math, 2012)
Exception raised:
    Traceback (most recent call last):
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 480, in _run
        self.compile_and_execute(example, compiler, test.globs)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/doctest/forker.py", line 843, in compile_and_execute
        exec compiled in globs
      File "<doctest sage.misc.cython.pyx_preparse[9]>", line 1, in <module>
        module = sage.misc.cython.import_test("trac11680")  # long time (7s on sage.math, 2012)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 805, in import_test
        return compile_and_load(TESTS[name])
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 757, in compile_and_load
        return cython_import(file, create_local_c_file=False)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/server/support.py", line 447, in cython_import
        **kwds)
      File "/home/buildslave-sage/slave/sage_git/build/local/lib/python2.7/site-packages/sage/misc/cython.py", line 493, in cython
        raise RuntimeError("Error converting {} to C:\n{}\n{}".format(filename, log, err))
    RuntimeError: Error converting /home/buildslave-sage/slave/sage_git/dot_sage/temp/desktop/29631/tmp_i0rQYs.pyx to C:


    Error compiling Cython file:
    ------------------------------------------------------------
    ...
    #cinclude $SAGE_SRC/sage/libs/flint $SAGE_LOCAL/include/FLINT
    #clib flint

    from sage.rings.rational cimport Rational
    from sage.rings.polynomial.polynomial_rational_flint cimport Polynomial_rational_flint
    from sage.libs.flint.fmpq_poly cimport (fmpq_poly_get_coeff_mpq, fmpq_poly_set_coeff_mpq,
    ^
    ------------------------------------------------------------

    _home_buildslave_sage_slave_sage_git_dot_sage_temp_desktop_29631_tmp_i0rQYs_pyx_0.pyx:13:0: 'sage.libs.flint.fmpq_poly.pxd' not found
```



---

Comment by vbraun created at 2014-08-28 15:46:25

Changing status from positive_review to needs_work.


---

Comment by jdemeyer created at 2014-08-28 19:04:10

Changing status from needs_work to needs_review.


---

Comment by git created at 2014-08-28 19:04:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-08-28 20:52:40

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2014-09-03 08:40:03

I have also done the same fixes for `mpz_t` at #16910 + #15946, it would be good if somebody could review these.


---

Comment by vbraun created at 2014-09-06 11:02:51

Resolution: fixed


---

Comment by jpflori created at 2014-10-13 16:12:43

Sorry to dig into "old" stuff, but I was suggested to use pxd files rather than pxi files and see the changes here went the other way around...
Any strong reason to have done that?


---

Comment by vbraun created at 2014-10-13 16:32:43

Generally speaking, Cython got better at what can be cimported over time (pxd). So there is less reason to rely on textual inclusion (pxi). If in doubt (and if it works ;-) then use pxd.


---

Comment by jpflori created at 2014-10-13 17:17:49

Ok, then I'll take the chance to open a ticket to migrate all of flint stuff to pxd files.


---

Comment by jdemeyer created at 2014-10-13 18:23:16

See #16428.
