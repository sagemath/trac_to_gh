# Issue 26547: Add ability to inform the doctest runner of known failures

archive/issues_026547.json:
```json
{
    "body": "CC:  vbraun chapoton\n\nAdds a simple feature for specifying test files that contain \"known failures\" i.e. they are expected to fail, so if they do the entire test run should not be counted as a failure (that is, it should still return 0).  This is part of a more flexible alternative to #26740.\n\nWhen tests fail in a file marked as a known-failure the only difference is that in the test result summary it is noted when failures were expected, and the test runner returns 0 unless there were other unexpected failures.\n\nIf a test marked as known-failure happens to succeed unexpected this is also noted in the summary, but is not counted as a failure.\n\nThis feature is still very simplistic: all it states is that some test file is expected to fail, not *how* it is expected to fail.  That might be useful to add later for better specificity.\n\nKnown failures are also listed file-by-file; there is no support yet for marking whole directories as known-failures and/or wildcards.  Those are also possibilities for future enhancements.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26784\n\n",
    "created_at": "2018-11-28T14:35:42Z",
    "labels": [
        "doctest framework",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.8",
    "title": "Add ability to inform the doctest runner of known failures",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26547",
    "user": "embray"
}
```
CC:  vbraun chapoton

Adds a simple feature for specifying test files that contain "known failures" i.e. they are expected to fail, so if they do the entire test run should not be counted as a failure (that is, it should still return 0).  This is part of a more flexible alternative to #26740.

When tests fail in a file marked as a known-failure the only difference is that in the test result summary it is noted when failures were expected, and the test runner returns 0 unless there were other unexpected failures.

If a test marked as known-failure happens to succeed unexpected this is also noted in the summary, but is not counted as a failure.

This feature is still very simplistic: all it states is that some test file is expected to fail, not *how* it is expected to fail.  That might be useful to add later for better specificity.

Known failures are also listed file-by-file; there is no support yet for marking whole directories as known-failures and/or wildcards.  Those are also possibilities for future enhancements.

Issue created by migration from https://trac.sagemath.org/ticket/26784





---

archive/issue_comments_373203.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-28T14:38:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373203",
    "user": "embray"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_373204.json:
```json
{
    "body": "Weird doctest failures on my docker patchbot, but I don't think they're related to this as I didn't get anything like that locally.  Instead it looks like some incremental build problem on the patchbot.  I may need to rebuild it.",
    "created_at": "2018-11-29T09:18:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373204",
    "user": "embray"
}
```

Weird doctest failures on my docker patchbot, but I don't think they're related to this as I didn't get anything like that locally.  Instead it looks like some incremental build problem on the patchbot.  I may need to rebuild it.



---

archive/issue_comments_373205.json:
```json
{
    "body": "Documentation fails to build: change `\"\"\"` to `r\"\"\"` in `doctest.test`. Regarding\n\n```\nsage -t --warn-long 0.0 simple_success.rst # 4 doctests passed (known failure)\n```\n\nit looks to me like there are only 3 doctests in that file: the 3 lines beginning with `sage:`. Why does it say 4?",
    "created_at": "2018-12-12T23:26:52Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373205",
    "user": "jhpalmieri"
}
```

Documentation fails to build: change `"""` to `r"""` in `doctest.test`. Regarding

```
sage -t --warn-long 0.0 simple_success.rst # 4 doctests passed (known failure)
```

it looks to me like there are only 3 doctests in that file: the 3 lines beginning with `sage:`. Why does it say 4?



---

archive/issue_comments_373206.json:
```json
{
    "body": "Retargeting some of my tickets (somewhat optimistically for now).",
    "created_at": "2018-12-28T14:10:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373206",
    "user": "embray"
}
```

Retargeting some of my tickets (somewhat optimistically for now).



---

archive/issue_comments_373207.json:
```json
{
    "body": "It says 4 because there's an automatic \"implicit\" doctest that checks if cysignals is in a sane state.",
    "created_at": "2018-12-28T16:17:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373207",
    "user": "embray"
}
```

It says 4 because there's an automatic "implicit" doctest that checks if cysignals is in a sane state.



---

archive/issue_comments_373208.json:
```json
{
    "body": "I generally don't like code like\n\n```\n                    try:\n                        with open(filename) as fobj:\n                            known_failures.update(\n                                os.path.abspath(l.strip()) for l in fobj)\n                    except IOError as exc:\n                        raise ValueError('could not open known failures file '\n                                         '\"{}\": {}'.format(filename, exc))\n```\n\nsince it hides information about the original exception. I suggest to remove the `try`/`except`.",
    "created_at": "2019-01-09T09:40:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373208",
    "user": "jdemeyer"
}
```

I generally don't like code like

```
                    try:
                        with open(filename) as fobj:
                            known_failures.update(
                                os.path.abspath(l.strip()) for l in fobj)
                    except IOError as exc:
                        raise ValueError('could not open known failures file '
                                         '"{}": {}'.format(filename, exc))
```

since it hides information about the original exception. I suggest to remove the `try`/`except`.



---

archive/issue_comments_373209.json:
```json
{
    "body": "I find it a bit strange that you're handing reporting of known failures both in `forker.py` and in `reporting.py`. It would seem more logical to report known failures only in `reporting.py` in this message:\n\n```\nlog(\"    [%s, %s%.2f s]\" % (total, \"%s, \"%(count_noun(f, \"failure\")) if f else \"\", wall))\n```\n",
    "created_at": "2019-01-09T09:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373209",
    "user": "jdemeyer"
}
```

I find it a bit strange that you're handing reporting of known failures both in `forker.py` and in `reporting.py`. It would seem more logical to report known failures only in `reporting.py` in this message:

```
log("    [%s, %s%.2f s]" % (total, "%s, "%(count_noun(f, "failure")) if f else "", wall))
```




---

archive/issue_comments_373210.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2019-01-09T09:48:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373210",
    "user": "jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_373211.json:
```json
{
    "body": "The whole point of catching an exception and raising a new one is to give a more informative exception and context around it: It will still tell you why the exception occurred \"File not found\" or whatever.  This is for users: there's nothing really interesting in the original exception that is \"hidden\" that a developer can't find out with a debugger.  However, I'm not sure why I even bothered in this case either, but it's harmless. \n\nFor the second comment I don't know why it \"would seem more logical\".  Why not both?  When I was working on this I found it more informative as to what was happening that way.",
    "created_at": "2019-01-09T14:37:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373211",
    "user": "embray"
}
```

The whole point of catching an exception and raising a new one is to give a more informative exception and context around it: It will still tell you why the exception occurred "File not found" or whatever.  This is for users: there's nothing really interesting in the original exception that is "hidden" that a developer can't find out with a debugger.  However, I'm not sure why I even bothered in this case either, but it's harmless. 

For the second comment I don't know why it "would seem more logical".  Why not both?  When I was working on this I found it more informative as to what was happening that way.



---

archive/issue_comments_373212.json:
```json
{
    "body": "Changing status from needs_work to needs_info.",
    "created_at": "2019-01-09T14:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373212",
    "user": "embray"
}
```

Changing status from needs_work to needs_info.



---

archive/issue_comments_373213.json:
```json
{
    "body": "Replying to [comment:8 embray]:\n> The whole point of catching an exception and raising a new one is to give a more informative exception and context around it: It will still tell you why the exception occurred \"File not found\" or whatever.  This is for users: there's nothing really interesting in the original exception that is \"hidden\" that a developer can't find out with a debugger.  However, I'm not sure why I even bothered in this case either, but it's harmless. \n\nActually in this case I can see why I did it.  That method already raises a `ValueError` if some option has an invalid value, so in this case it's treating a known_failures file that cannot be opened (for whatever reason) as an invalid value.",
    "created_at": "2019-01-09T14:42:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373213",
    "user": "embray"
}
```

Replying to [comment:8 embray]:
> The whole point of catching an exception and raising a new one is to give a more informative exception and context around it: It will still tell you why the exception occurred "File not found" or whatever.  This is for users: there's nothing really interesting in the original exception that is "hidden" that a developer can't find out with a debugger.  However, I'm not sure why I even bothered in this case either, but it's harmless. 

Actually in this case I can see why I did it.  That method already raises a `ValueError` if some option has an invalid value, so in this case it's treating a known_failures file that cannot be opened (for whatever reason) as an invalid value.



---

archive/issue_comments_373214.json:
```json
{
    "body": "Moving all my in-progress tickets to 8.8 milestone.",
    "created_at": "2019-03-25T10:43:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373214",
    "user": "embray"
}
```

Moving all my in-progress tickets to 8.8 milestone.



---

archive/issue_comments_373215.json:
```json
{
    "body": "Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).",
    "created_at": "2019-06-14T14:50:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373215",
    "user": "embray"
}
```

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).



---

archive/issue_comments_373216.json:
```json
{
    "body": "Ticket retargeted after milestone closed",
    "created_at": "2019-12-30T14:48:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373216",
    "user": "embray"
}
```

Ticket retargeted after milestone closed



---

archive/issue_comments_373217.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373217",
    "user": "mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_373218.json:
```json
{
    "body": "Setting new milestone based on a cursory review of ticket status, priority, and last modification date.",
    "created_at": "2021-03-15T22:07:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373218",
    "user": "mkoeppe"
}
```

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.



---

archive/issue_comments_373219.json:
```json
{
    "body": "Setting a new milestone for this ticket based on a cursory review.",
    "created_at": "2021-07-19T00:44:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373219",
    "user": "mkoeppe"
}
```

Setting a new milestone for this ticket based on a cursory review.



---

archive/issue_comments_373220.json:
```json
{
    "body": "Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.",
    "created_at": "2021-12-18T19:53:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26547",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26547#issuecomment-373220",
    "user": "mkoeppe"
}
```

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
