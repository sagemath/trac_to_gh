# Issue 26547: Add ability to inform the doctest runner of known failures

Issue created by migration from https://trac.sagemath.org/ticket/26784

Original creator: embray

Original creation time: 2018-11-28 14:35:42

CC:  vbraun chapoton

Adds a simple feature for specifying test files that contain "known failures" i.e. they are expected to fail, so if they do the entire test run should not be counted as a failure (that is, it should still return 0).  This is part of a more flexible alternative to #26740.

When tests fail in a file marked as a known-failure the only difference is that in the test result summary it is noted when failures were expected, and the test runner returns 0 unless there were other unexpected failures.

If a test marked as known-failure happens to succeed unexpected this is also noted in the summary, but is not counted as a failure.

This feature is still very simplistic: all it states is that some test file is expected to fail, not _how_ it is expected to fail.  That might be useful to add later for better specificity.

Known failures are also listed file-by-file; there is no support yet for marking whole directories as known-failures and/or wildcards.  Those are also possibilities for future enhancements.


---

Comment by embray created at 2018-11-28 14:38:39

Changing status from new to needs_review.


---

Comment by embray created at 2018-11-29 09:18:32

Weird doctest failures on my docker patchbot, but I don't think they're related to this as I didn't get anything like that locally.  Instead it looks like some incremental build problem on the patchbot.  I may need to rebuild it.


---

Comment by jhpalmieri created at 2018-12-12 23:26:52

Documentation fails to build: change `"""` to `r"""` in `doctest.test`. Regarding

```
sage -t --warn-long 0.0 simple_success.rst # 4 doctests passed (known failure)
```

it looks to me like there are only 3 doctests in that file: the 3 lines beginning with `sage:`. Why does it say 4?


---

Comment by embray created at 2018-12-28 14:10:15

Retargeting some of my tickets (somewhat optimistically for now).


---

Comment by embray created at 2018-12-28 16:17:50

It says 4 because there's an automatic "implicit" doctest that checks if cysignals is in a sane state.


---

Comment by jdemeyer created at 2019-01-09 09:40:25

I generally don't like code like

```
                    try:
                        with open(filename) as fobj:
                            known_failures.update(
                                os.path.abspath(l.strip()) for l in fobj)
                    except IOError as exc:
                        raise ValueError('could not open known failures file '
                                         '"{}": {}'.format(filename, exc))
```

since it hides information about the original exception. I suggest to remove the `try`/`except`.


---

Comment by jdemeyer created at 2019-01-09 09:48:53

I find it a bit strange that you're handing reporting of known failures both in `forker.py` and in `reporting.py`. It would seem more logical to report known failures only in `reporting.py` in this message:

```
log("    [%s, %s%.2f s]" % (total, "%s, "%(count_noun(f, "failure")) if f else "", wall))
```



---

Comment by jdemeyer created at 2019-01-09 09:48:53

Changing status from needs_review to needs_work.


---

Comment by embray created at 2019-01-09 14:37:40

The whole point of catching an exception and raising a new one is to give a more informative exception and context around it: It will still tell you why the exception occurred "File not found" or whatever.  This is for users: there's nothing really interesting in the original exception that is "hidden" that a developer can't find out with a debugger.  However, I'm not sure why I even bothered in this case either, but it's harmless. 

For the second comment I don't know why it "would seem more logical".  Why not both?  When I was working on this I found it more informative as to what was happening that way.


---

Comment by embray created at 2019-01-09 14:42:50

Changing status from needs_work to needs_info.


---

Comment by embray created at 2019-01-09 14:42:50

Replying to [comment:8 embray]:
> The whole point of catching an exception and raising a new one is to give a more informative exception and context around it: It will still tell you why the exception occurred "File not found" or whatever.  This is for users: there's nothing really interesting in the original exception that is "hidden" that a developer can't find out with a debugger.  However, I'm not sure why I even bothered in this case either, but it's harmless. 

Actually in this case I can see why I did it.  That method already raises a `ValueError` if some option has an invalid value, so in this case it's treating a known_failures file that cannot be opened (for whatever reason) as an invalid value.


---

Comment by embray created at 2019-03-25 10:43:18

Moving all my in-progress tickets to 8.8 milestone.


---

Comment by embray created at 2019-06-14 14:50:27

Tickets still needing working or clarification should be moved to the next release milestone at the soonest (please feel free to revert if you think the ticket is close to being resolved).


---

Comment by embray created at 2019-12-30 14:48:17

Ticket retargeted after milestone closed


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2021-03-15 22:07:04

Setting new milestone based on a cursory review of ticket status, priority, and last modification date.


---

Comment by mkoeppe created at 2021-07-19 00:44:56

Setting a new milestone for this ticket based on a cursory review.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.
