# Issue 11358: PARI initialization of finite field elements mangles Mod

Issue created by migration from https://trac.sagemath.org/ticket/11530

Original creator: rbeezer

Original creation time: 2011-06-21 20:09:47

Assignee: AlexGhitza


```
sage: F.<d> = GF(3^2)
sage: d._pari_()
Mod(d, Mod(1, 3)*d^2 + Mod(2, 3)*d + Mod(2, 3))
sage: d._pari_init_("m")
'Mom(m, Mom(1, 3)*m^2 + Mom(2, 3)*m + Mom(2, 3))'
sage: d._pari_init_("p")
'Mop(p, Mop(1, 3)*p^2 + Mop(2, 3)*p + Mop(2, 3))'
sage: d._pari_init_("b")
'Mob(b, Mob(1, 3)*b^2 + Mob(2, 3)*b + Mob(2, 3))'
```


More care needs to be taken with a search and replace, maybe it should come earlier in `sage.rings.finite_rings.element_givaro.FiniteField_givaroElement._pari_init_`.


---

Comment by SimonKing created at 2011-06-22 06:14:38

My patch completely avoids the string replacement.

If a variable name is given, it replaces `self.parent()._finite_field_ext_pari_modulus_as_str()` by `repr(self.parent().modulus()._pari_with_name(var))`, and `self.polynomial()` allows to change the variable name as well, so, I use `self.polynomial(var)` instead.

Of course I added a test, and the tests of `sage/rings/finite_rings/element_givaro.pyx` pass. I didn't run full tests, yet, but I think it is ready for review.


---

Comment by SimonKing created at 2011-06-22 06:14:38

Changing status from new to needs_review.


---

Comment by SimonKing created at 2011-06-22 06:14:38

Changing keywords from "" to "_pari_init_, variable name, finite field".


---

Attachment

Do _pari_init_ without string replacement


---

Comment by SimonKing created at 2011-06-22 06:35:05

The correct patch is only posted _now_: Previously, I had forgotten to commit my changes. So, please reload my patch if you had downloaded it before reading these lines...


---

Comment by jdemeyer created at 2011-06-22 07:09:16

Annoying:

```
sage: F.<d> = GF(127^3)
sage: d._pari_()
Mod(Mod(1, 127)*a, Mod(1, 127)*a^3 + Mod(3, 127)*a + Mod(124, 127))
sage: d._pari_init_("x")
Traceback (most recent call last)

/usr/local/src/sage-4.7.1.alpha3/<ipython console> in <module>()

TypeError: _pari_init_() takes exactly 1 argument (2 given)
```


Patch looks good to me, though (still need to test).


---

Comment by SimonKing created at 2011-06-22 07:20:48

Replying to [comment:3 jdemeyer]:
> Annoying:

Indeed. So, should we take care of non-Givaro finite field elements as well? Here or on a different ticket?

Cheers,
Simon


---

Comment by rbeezer created at 2011-06-22 15:41:20

Replying to [comment:5 SimonKing]:
> Indeed. So, should we take care of non-Givaro finite field elements as well? Here or on a different ticket?

There is also a _finite_field_ext_pari_modulus_as_str() method for the NTL finite fields of characteristic 2, which in my patch was just as easy to fix.  Not sure why Jeroen's error shows up for order 127^3.  My patch does string replacement, but passes all long tests.

Have to go for a bit, I'll post more details in a few hours, but right now I'd say a second ticket is probably not needed.

Rob


---

Comment by rbeezer created at 2011-06-22 15:50:38

Appears "big" fields do not have a _finite_field_ext_pari_modulus_as_str() method at all.

I have a tweak to Simon's patch that may be just a bit cleaner and work for all fields.  In a bit.


---

Comment by rbeezer created at 2011-06-22 18:43:10

Simon's patch, with minor modifications


---

Attachment

v2 patch is a tweak of Simon's nice patch.  Passes all tests in sage/rings.  I think this will allow totally removing the two versions of `_finite_field_ext_pari_modulus_as_str()`.  I am going to test the removal with a test of the full Sage library.

Without search and replace, we get a 2x speedup.  I have not posted my search/replace patch since it seems useless now.

Timings, all in microseconds, of the two commands below.


```
sage: F.<a>=GF(3^5)
sage: a._pari_init_()
sage: a._pari_init_('b')

                        var=None       var='b'
4.7 status quo            779            780
Rob search/replace        782            787
Simon                     781            381
Simon + Rob (v2)          369            381
```


So it appears better coding will get us speed improvements.  Imagine that!


---

Comment by rbeezer created at 2011-06-22 18:58:13

Replying to [comment:3 jdemeyer]:
> Annoying:
> {{{
> sage: F.<d> = GF(127^3)
> sage: d._pari_()
> Mod(Mod(1, 127)*a, Mod(1, 127)*a^3 + Mod(3, 127)*a + Mod(124, 127))
> sage: d._pari_init_("x")
> Traceback (most recent call last)
> 
> /usr/local/src/sage-4.7.1.alpha3/<ipython console> in <module>()
> 
> TypeError: _pari_init_() takes exactly 1 argument (2 given)
> }}}

The `_pari_init_()` method of `sage.rings.finite_rings.element_ext_pari.FiniteField_ext_pariElement` is not designed to take a new variable.  Should it be?

I found this problem originally when trying to factor a polynomial with coefficients from `GF(3^5)`.  It looks to me like a factorization of a polynomial over `GF(127^3)` takes a different path, since the polynomial is of a different type, and therefore does not call `_pari_init_()` to change a variable name.

Is this failure a non-issue?


---

Comment by rbeezer created at 2011-06-22 19:51:55

With v2 patch, and both instances of `_finite_field_ext_pari_modulus_as_str()` commented-out, all long tests pass.

(a) Does the v2 patch look acceptable?  It is uniformly faster and seems to fix the original problem.

(b) Do we need to address Jeroen's annoyance above?

(c) Should we trash both `_finite_field_ext_pari_modulus_as_str()`?

I can manufacture a final patch, with Simon's name on it, if desired.  We could then call on Jeroen for a review.

Rob


---

Comment by SimonKing created at 2011-06-23 15:06:03

Replying to [comment:10 rbeezer]:
> I can manufacture a final patch, with Simon's name on it, if desired.  We could then call on Jeroen for a review.

Yes, please. I am currently unable to work.


---

Attachment


---

Comment by rbeezer created at 2011-06-23 22:46:02

Replying to [comment:11 SimonKing]:
> Yes, please. I am currently unable to work.

Done in v3 patch.  Patch has Simon's name on it, but I've added myself as an author.  

Highlights:

  1.  Some expansion of the docstring - trying to be sure to test fields of characteristic 2 and elements that are not just the generator alone.
  1.  Eliminated two versions of `_finite_field_ext_pari_modulus_as_str()` since they are not needed and comments indicate they are not even very desirable.

Patch passes all long tests on 4.7.1.alpha2.

Rob


---

Comment by jdemeyer created at 2011-06-24 14:07:12

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2011-06-24 14:07:12

Wny not make lines 370--371 more consistent and write

```
g = str(self.parent().modulus()._pari_with_name(var))
f = str(self.polynomial()._pari_with_name(var))
```


I guess you could even omit the "str()" since that will be done anyway in the formatting on line 372.


---

Attachment


---

Comment by rbeezer created at 2011-06-24 18:19:15

Changing status from needs_work to needs_review.


---

Comment by rbeezer created at 2011-06-24 18:19:15

Good idea, Jeroen.  `self.polynomial()._pari_with_name(var)` hits the coefficients of an element with a `Mod`, so the behavior changes.  Perhaps not a problem, but also perhaps not worth the risk either.  Makes a couple of other doctests fail, but maybe just for `_pari_` for finite field elements.

Therefore the v4 patch basically just strips the `str()` and `repr()` and lets the `format()` take care of string formatting.  Passes all tests in sage/rings.

I will run long tests in the next 12 hours when my machine is free, but I think it is safe to review now, and I'll post about long tests either way.


---

Comment by jdemeyer created at 2011-06-24 19:58:43

Replying to [comment:15 rbeezer]:
> Good idea, Jeroen.  `self.polynomial()._pari_with_name(var)` hits the coefficients of an element with a `Mod`, so the behavior changes.

Wow, nice catch!

The current behaviour is totally wrong, the coefficients *must* be hit by a `Mod`, otherwise we can get wrong results!  I remember fixing another instance of this bug (#10486).


---

Comment by jdemeyer created at 2011-06-24 19:58:43

Changing status from needs_review to needs_work.


---

Comment by rbeezer created at 2011-06-24 20:28:41

OK, I'll make it so, and fix about 4 doctests (and perhaps more code fixes will become obvious via the failing doctests).

I haven't spent enough time with this code to know that the coefficients _must_ be hit by Mod - thanks for the advice.

Probably have something up this evening (Seattle time).


---

Comment by rbeezer created at 2011-06-25 00:37:08

Changing status from needs_work to needs_review.


---

Attachment

v5 patch:

Consistent commands, as suggested.

Dead code removal ("modulus_as_str" routines).

Corrected doctests.

Upgraded docstrings.

Passes tests in sage/rings.

Will likely run full tests over dinner and report back.


---

Comment by rbeezer created at 2011-06-25 01:55:36

Passes all long tests, so should be all ready for review.


---

Comment by jdemeyer created at 2011-06-25 08:38:05

Changing status from needs_review to positive_review.


---

Comment by jdemeyer created at 2011-06-25 08:38:05

The new code looks good, the results are what they should be.  There are sufficiently many example.  I will thrust you on the "Passes all long tests" part.


---

Comment by rbeezer created at 2011-06-25 14:37:19

Replying to [comment:20 jdemeyer]:
> The new code looks good, the results are what they should be.  There are sufficiently many example.  I will thrust you on the "Passes all long tests" part.

Thanks, Jeroen, for your help on this one.


---

Comment by jdemeyer created at 2011-07-24 11:17:22

Resolution: fixed
