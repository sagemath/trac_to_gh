# Issue 32489: quaternion ideals' .scale() incorrectly copies cached left and right orders

Issue created by migration from https://trac.sagemath.org/ticket/32726

Original creator: lorenz

Original creation time: 2021-10-20 06:52:32

CC:  pbruin

The method `QuaternionFractionalIdeal_rational.scale()` simply copies over the existing left and right orders of `self` to the scaled ideal. This is incorrect when the scaling factor does not lie in the center of the algebra, as demonstrated by this example:


```sage
sage: Quat.<i,j,k> = QuaternionAlgebra(-1,-19)
sage: a = 1+2*i+3*j+4*k
sage: I = Quat.maximal_order().unit_ideal()
sage: I.right_order()
Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)
sage: I.scale(a).right_order()
Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/2*j, 1/2*i + 1/2*k, j, k)
sage: J = Quat.ideal(I.scale(a).basis(), check=False)
sage: J == I.scale(a)
True
sage: J.right_order()
Order of Quaternion Algebra (-1, -19) with base ring Rational Field with basis (1/2 + 1/10*j + 109/5*k, 1/48*i + 1/120*j + 8411/240*k, 1/5*j + 218/5*k, 120*k)
```



---

Comment by lorenz created at 2021-10-20 08:36:45

Changing status from new to needs_review.


---

Comment by lorenz created at 2021-10-21 02:59:57

Bumping priority since this bug can lead to mathematical errors.


---

Comment by lorenz created at 2021-10-21 02:59:57

Changing priority from minor to major.


---

Comment by mkoeppe created at 2021-12-18 19:53:12

Stalled in `needs_review` or `needs_info`; likely won't make it into Sage 9.5.


---

Comment by git created at 2022-01-18 09:03:23

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mjo created at 2022-01-23 21:50:24

This looks OK to me but I'm not an expert so I have two questions:

1. I guess scaling on the right doesn't affect the left order, and vice-versa?
2. Is it OK to assume that the base ring is `QQ`?


---

Comment by lorenz created at 2022-01-24 02:40:59

Thanks for having a look.

1. Yes; the left order of `I` is `{x in the algebra | x·I ⊆ I}`. Scaling happens element-wise, so these inclusions are preserved under right scaling. Similarly on the other side.
2. Yes; the class `QuaternionFractionalIdeal_rational` is specific to `QQ`.


---

Comment by mjo created at 2022-01-24 12:49:31

LGTM then, thanks.


---

Comment by mjo created at 2022-01-24 12:49:31

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2022-01-31 23:31:19

Resolution: fixed
