# Issue 16514: Singular build fail OSX109

Issue created by migration from https://trac.sagemath.org/ticket/16751

Original creator: vbraun

Original creation time: 2014-08-02 12:21:10

CC:  jkeitel fbissey jdemeyer




---

Comment by vbraun created at 2014-08-02 12:27:00

As reported at https://groups.google.com/d/msg/sage-release/1CFpQblf8FE/YLr4t2Mw7mMJ


---

Comment by vbraun created at 2014-08-02 12:27:00

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by vbraun created at 2014-08-02 12:27:00

Changing type from PLEASE CHANGE to defect.


---

Comment by vbraun created at 2014-08-02 12:27:00

Changing priority from major to critical.


---

Comment by vbraun created at 2014-08-02 12:41:09

There was a `--without-flint` in the libfac configuration, that doesn't sound right.
----
New commits:


---

Comment by jkeitel created at 2014-08-02 12:59:34

Hi Volker,

that alone doesn't work yet. Wasn't Francois on the right track? The Singular config.log keeps saying


```
/Users/kabel/sage/sage/local/include/flint/flint.h:74:2: error: #error GMP 5.0.0 or MPIR 2.6.0 or later are required
/Users/kabel/sage/sage/local/include/flint/flint.h:78:2: error: #error MPFR 3.0.0 or later is required
```


The whole (new) config.log file is here: http://wwwth.mpp.mpg.de/members/jkeitel/config2.log


---

Comment by git created at 2014-08-02 14:04:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vbraun created at 2014-08-02 14:07:52

Changing status from new to needs_review.


---

Comment by vbraun created at 2014-08-02 14:07:52

Yes, looking at the configure its pretty clear that this is bad. New commit should fix it. This is gone in Singular-4 as far as I can tell.


---

Comment by leif created at 2014-08-02 14:10:05

Reposting here, since apparently G00gle doesn't like it (meanwhile tried twice):


```
Jan Keitel wrote:
> Okay, found them:
>
> gmp: 4.3.1
> mpfr: 2.4.1
> mpc: 0.8.1

These shouldn't get picked up (in this case, only the header files matter anyway),
since $SAGE_LOCAL/{include,lib} come first in the -I and -L directives:

configure:8898: gcc -o conftest -O2 -g  -fPIC -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/Users/kabel/sage/sage/local/include -I/Users/kabel/sage/sage/local/include  -I/usr/local/include -L/Users/kabel/sage/sage/local/lib -L/Users/kabel/sage/sage/local/lib -L/usr/local/lib conftest.c -lntl -lgmp -lreadline -ltermcap -lm -L/Users/kabel/sage/sage/local/lib -lflint -lmpfr -lmpir >&5
In file included from /Users/kabel/sage/sage/local/include/flint/fmpz.h:38:0,
                 from conftest.c:94:
/Users/kabel/sage/sage/local/include/flint/flint.h:74:2: error: #error GMP 5.0.0 or MPIR 2.6.0 or later are required
/Users/kabel/sage/sage/local/include/flint/flint.h:78:2: error: #error MPFR 3.0.0 or later is required
configure:8898: $? = 1


It would be interesting to see GCC's verbose output (in particular, the list of
include folders) as well as the preprocessed source of that conftest.c, but I
guess it's not that easy to add the appropriate flags there.


> Is there a way to force the sage installation not to use the globally
> installed versions?

It shouldn't at all.  You could move or remove them temporarily though.

```



---

Comment by jkeitel created at 2014-08-02 14:13:39

Well, if there's any other information that I can provide, please let me know. In the meantime I've pulled the updated branch and am compiling again. So far it's looking good.


---

Comment by leif created at 2014-08-02 14:35:09

Replying to [comment:9 jkeitel]:
> Well, if there's any other information that I can provide, please let me know. In the meantime I've pulled the updated branch and am compiling again. So far it's looking good.

Provided Volker's patch solves the issue, probably not worth the effort.

Otherwise I'd say it's a compiler bug, if we can trust what's in `config.log` (i.e., the shown command line leading to the failure).


---

Comment by jkeitel created at 2014-08-02 14:48:55

Yep, it works. Thank you!

I'd like to give this a positive review, but I don't think I'm the right guy to do that, because I can't tell whether it breaks something else. Francois, leif? ;-)


---

Comment by leif created at 2014-08-02 15:16:53

Changing status from needs_review to positive_review.


---

Comment by leif created at 2014-08-02 15:16:53

Replying to [comment:11 jkeitel]:
> I'd like to give this a positive review, but I don't think I'm the right guy to do that, because I can't tell whether it breaks something else. Francois, leif? ;-)

In theory at least, the patch could of course break things on other systems (where pieces not shipped with Sage are located in `/usr/local/`, and in case that's not searched by default), but there are easy work-arounds for that case, and I think that'd be for another ticket if someone gets hit.  (Probably the buildbots will also tell.)

I still don't get why apparently `/usr/local/include/gmp.h` gets included although `-I${SAGE_LOCAL}/include` precedes `-I/usr/local/include`, according to `config.log`...


---

Comment by leif created at 2014-08-02 15:39:16

Failing `configure` test (checking for FLINT).


---

Attachment

Replying to [comment:12 leif]:
> I still don't get why apparently `/usr/local/include/gmp.h` gets included although `-I${SAGE_LOCAL}/include` precedes `-I/usr/local/include`, according to `config.log`...

Jan, you may try whether

```sh
gcc -o conftest -O2 -g  -fPIC -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/Users/kabel/sage/sage/local/include -I/Users/kabel/sage/sage/local/include  -I/usr/local/include -L/Users/kabel/sage/sage/local/lib -L/Users/kabel/sage/sage/local/lib  -L/usr/local/lib conftest.c -lntl -lomalloc_ndebug -lomalloc -lsingfac -lsingcf -lgmp -lreadline -ltermcap -lm   -L/Users/kabel/sage/sage/local/lib -lflint -lmpfr -lmpir
```

or simply

```sh
gcc -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/usr/local/include -c conftest.c
```

also fails for you, in a Sage subshell (`./sage --sh`).

I've attached the [attachment:conftest.c corresponding conftest.c].


---

Comment by jkeitel created at 2014-08-02 15:59:35

Yep, they both do:


```
(sage-sh) kabel@Aloiss-MacBook-Air-2:sage$ gcc -o conftest -O2 -g  -fPIC -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/Users/kabel/sage/sage/local/include -I/Users/kabel/sage/sage/local/include  -I/usr/local/include -L/Users/kabel/sage/sage/local/lib -L/Users/kabel/sage/sage/local/lib  -L/usr/local/lib conftest.c -lntl -lomalloc_ndebug -lomalloc -lsingfac -lsingcf -lgmp -lreadline -ltermcap -lm   -L/Users/kabel/sage/sage/local/lib -lflint -lmpfr -lmpir
In file included from /Users/kabel/sage/sage/local/include/flint/fmpz.h:38:0,
                 from conftest.c:99:
/Users/kabel/sage/sage/local/include/flint/flint.h:74:2: error: #error GMP 5.0.0 or MPIR 2.6.0 or later are required
/Users/kabel/sage/sage/local/include/flint/flint.h:78:2: error: #error MPFR 3.0.0 or later is required
```



```
kabel@Aloiss-MacBook-Air-2:sage$ gcc -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/usr/local/include -c conftest.c
In file included from /Users/kabel/sage/sage/local/include/flint/fmpz.h:38:0,
                 from conftest.c:99:
/Users/kabel/sage/sage/local/include/flint/flint.h:74:2: error: #error GMP 5.0.0 or MPIR 2.6.0 or later are required
/Users/kabel/sage/sage/local/include/flint/flint.h:78:2: error: #error MPFR 3.0.0 or later is required
```



---

Comment by leif created at 2014-08-02 16:20:34

Replying to [comment:14 jkeitel]:
> Yep, they both do.

Ouch.  Could you paste the output of

```sh
gcc -v -save-temps -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/usr/local/include -c conftest.c
```

and attach the generated `conftest.i`?


---

Attachment


---

Comment by jkeitel created at 2014-08-02 16:26:24

Sure:


```
(sage-sh) kabel@Aloiss-MacBook-Air-2:sage$ gcc -v -save-temps -I/Users/kabel/sage/sage/local/include/flint -I/Users/kabel/sage/sage/local/include -I/usr/local/include -c conftest.c
Using built-in specs.
COLLECT_GCC=gcc
Target: x86_64-apple-darwin13.3.0
Configured with: ../src/configure --prefix=/Users/kabel/sage/sage/local --with-local-prefix=/Users/kabel/sage/sage/local --with-gmp=/Users/kabel/sage/sage/local --with-mpfr=/Users/kabel/sage/sage/local --with-mpc=/Users/kabel/sage/sage/local --with-system-zlib --disable-multilib --disable-nls  
Thread model: posix
gcc version 4.7.3 (GCC) 
COLLECT_GCC_OPTIONS='-mmacosx-version-min=10.9' '-v' '-save-temps' '-I' '/Users/kabel/sage/sage/local/include/flint' '-I' '/Users/kabel/sage/sage/local/include' '-I' '/usr/local/include' '-c' '-mtune=core2'
 /Users/kabel/sage/sage/local/libexec/gcc/x86_64-apple-darwin13.3.0/4.7.3/cc1 -E -quiet -v -I /Users/kabel/sage/sage/local/include/flint -I /Users/kabel/sage/sage/local/include -I /usr/local/include -D__DYNAMIC__ conftest.c -fPIC -mmacosx-version-min=10.9 -mtune=core2 -fpch-preprocess -o conftest.i
ignoring nonexistent directory "/Users/kabel/sage/sage/local/lib/gcc/x86_64-apple-darwin13.3.0/4.7.3/../../../../x86_64-apple-darwin13.3.0/include"
ignoring duplicate directory "/Users/kabel/sage/sage/local/include"
  as it is a non-system directory that duplicates a system directory
ignoring duplicate directory "/Users/kabel/sage/sage/local/include"
  as it is a non-system directory that duplicates a system directory
#include "..." search starts here:
#include <...> search starts here:
 /Users/kabel/sage/sage/local/include/flint
 /usr/local/include
 /Users/kabel/sage/sage/local/lib/gcc/x86_64-apple-darwin13.3.0/4.7.3/include
 /Users/kabel/sage/sage/local/include
 /Users/kabel/sage/sage/local/lib/gcc/x86_64-apple-darwin13.3.0/4.7.3/include-fixed
 /usr/include
 /System/Library/Frameworks
 /Library/Frameworks
End of search list.
In file included from /Users/kabel/sage/sage/local/include/flint/fmpz.h:38:0,
                 from conftest.c:99:
/Users/kabel/sage/sage/local/include/flint/flint.h:74:2: error: #error GMP 5.0.0 or MPIR 2.6.0 or later are required
/Users/kabel/sage/sage/local/include/flint/flint.h:78:2: error: #error MPFR 3.0.0 or later is required
```



---

Comment by leif created at 2014-08-02 16:42:54

Ah ok, thanks.

So it's pretty specific to "Sage's" GCC, which treats `$SAGE_LOCAL/include` as a system include folder, but not `/usr/local/include`.

One day we should [instead] fix the GCC spkg then... :P


---

Comment by leif created at 2014-08-02 16:42:54

Changing keywords from "" to "FLINT MacOS".


---

Comment by fbissey created at 2014-08-02 20:01:22

I like it when people figure things while I am sleeping :)


---

Comment by vbraun created at 2014-08-04 13:46:32

Resolution: fixed
