# Issue 17117: change name of interval_iterator for posets

Issue created by migration from Trac.

Original creator: chapoton

Original creation time: 2014-11-16 20:35:58

CC:  jmantysalo

Keywords: poset, interval

The current "interval_iterator" only iterates over strict intervals.

This is confusing and not coherent with the natural and well-established mathematical convention that includes all singletons [x,x] in the set of intervals.

I propose to rename that method to "strict_interval_iterator", deprecate it and then maybe later redirect it to the current "relations_iterator", that does the job.

I also introduce a new method "interval_number" that just counts the intervals.


---

Comment by chapoton created at 2014-11-16 21:12:41

New commits:


---

Comment by chapoton created at 2014-11-16 21:12:41

Changing status from new to needs_review.


---

Comment by git created at 2014-11-16 21:16:59

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by ncohen created at 2014-11-17 15:27:19

Don't you prefer to add a flag `strict=False` in the function ?.. The name `strict_interval_iterator` is not that natural to find when you do not know it exists..

Nathann


---

Comment by git created at 2014-11-17 16:53:15

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by jmantysalo created at 2014-11-18 08:43:42

Isn't `relations_iterator()` already function you are looking for?

(But of course this should be documented and docs linked to each other.)


---

Comment by jmantysalo created at 2014-11-18 08:50:39

If `lequal_matrix` has already been computed, then I guess that faster way to compute number of intervals is to sum up the elements of matrix.


---

Comment by chapoton created at 2014-11-18 19:51:14

Concerning speed: using

```
def interval_number1(self):
    return sum(sum(u for u in self.lequal_matrix()))
```

is much slower, even when the lequal matrix is precomputed.


---

Comment by ncohen created at 2014-11-19 04:14:49

Is it the same if you call `P._hasse_diagram.lequal_matrix` instead ? The poset function creates a copy before returning it.

Nathann


---

Comment by chapoton created at 2014-11-19 19:39:49

Yes, the same. Still slower by summing over the matrix.

For a poset with 429 elements, with lequal_matrix precomputed, first with `_hasse_diagram.lequal_matrix`:

```
sage: %timeit interval_number1(P)
10 loops, best of 3: 84.3 ms per loop
```

then with search in hasse diagram:

```
sage: %timeit interval_number(P)
10 loops, best of 3: 40.3 ms per loop
```



---

Comment by ncohen created at 2014-11-20 04:11:28

Okayokay. Then BFS.

I set this patch to `needs_work` as the naming problem has to be dealt with. Your `interval_iterator` is already named `relations_iterator` (you can add a 'strict' flag there too if you want), and you should probably rename your `iterval_number` to `relations_number`.

By the way perhaps you may want to change the code of `interval_iterator`. I don't quite see how it works but I would say that your code is faster.

Nathann


---

Comment by ncohen created at 2014-11-20 04:11:28

Changing status from needs_review to needs_work.


---

Comment by jmantysalo created at 2014-11-20 11:32:06

Replying to [comment:10 chapoton]:

> Yes, the same. Still slower by summing over the matrix.

Confirmed with 1024-element Boolean lattice. We must make Nathann to optimize matrix code also, not only static graph backend. `:=)`. Actually I don't know if Sage has good support for matrices over booleans or plain ints. It seems unnecessary to have a matrix of `Integer`s when you only store zeros and ones.

Why you do `hd = self.hasse_diagram()`? Would be faster to say `hd = self._hasse_diagram`.


---

Comment by ncohen created at 2014-11-20 12:42:29

Yo !

> Confirmed with 1024-element Boolean lattice. We must make Nathann to optimize matrix code also, not only static graph backend. `:=)`. Actually I don't know if Sage has good support for matrices over booleans or plain ints. It seems unnecessary to have a matrix of `Integer`s when you only store zeros and ones.

Well, I needed that at some point: sage/misc/binary_matrix.pxi

Nathann


---

Comment by jmantysalo created at 2014-11-21 11:16:57

Replying to [comment:13 ncohen]:

> Well, I needed that at some point: sage/misc/binary_matrix.pxi

A place for improvement in `hasse_diagram.py`?

`_leq_matrix` is directly referenced only twice. I don't know if it would be faster to invert it for getting möbius function matrix by converting it to scipy or numpy matrix. And at least memory would be saved if we save bits when we need bits and not integers. Actually we could have upper triangle of matrix to be lequal-matrix and lower triangle to be möbius-matrix.

And bit matrix could count ones by `POPCNT` instruction. `:=)`.

...and sorry for off-topic.


---

Comment by ncohen created at 2014-11-21 16:20:28

(answered by email as I have been told repeatedly to stop polluting threads)


---

Comment by git created at 2014-11-21 16:43:26

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-11-21 16:53:53

Hello,

I did some work, in particular using always 'relations_' instead of 'intervals_' (which are still there as simple aliases) and introducing an alternative algorithm in 'relations_iterator'. It indeed seems to be faster than the existing matrix search. Either it can be kept as the only algo, or we can propose the choice with the previous algorithm ?


---

Comment by ncohen created at 2014-11-21 17:00:55

Hello !

Right now the code looks weird as you added a 'algorithm' flag without documentation. Also, it seems that one algorithm can only be used when strict is False, which is not really justified (enumerating all [x,x] intervals can be done manually).

And I still do not see the point of this `chains().elements_of_depth_iterator(2)`.

About keeping different algorithms: given that this algorithm is not very complicated I would personally keep only one (we don't need two to double-check the result) but it depends on the developper I guess, so do as you like. It just needs to be documented if you keep everything.

Also: is there any reason why you seem to avoid using the algorithm of `relations_numbers` in `relations_iterator` ?

Nathann


---

Comment by ncohen created at 2014-11-21 17:07:14

Correction: considering the code of `p.chains().elements_of_depth_iterator(2)` I don't think that we should call that. It works, but `depth=2` it is overkill.

Nathann


---

Comment by git created at 2014-11-21 19:44:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2014-11-21 19:47:51

Changing status from needs_work to needs_review.


---

Comment by ncohen created at 2014-11-22 04:34:32

Helloooooooo !

Well, there was a couple of things I thought needed fixing:

1) Adding the aliases in the index of functions

2) Not build a list only to compute its length

I also removed a comment in the doc about the ordering of the intervals which does not hold anymore.

If you agree with the commit at public/17354, you can change the ticket's status.

Thanks,

Nathann


---

Comment by chapoton created at 2014-11-22 08:05:59

Your changes are ok. Thanks for the review. I put this into positive review.
----
New commits:


---

Comment by chapoton created at 2014-11-22 08:05:59

Changing status from needs_review to positive_review.


---

Comment by vbraun created at 2014-11-23 19:59:54

Resolution: fixed
