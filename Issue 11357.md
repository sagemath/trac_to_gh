# Issue 11357: Rooted trees

Issue created by migration from Trac.

Original creator: hivert

Original creation time: 2011-06-21 20:00:20

Assignee: hivert

CC:  sage-combinat tscrim darij

Keywords: rooted trees, Cayley

Implement combinatorial rooted trees also know as Cayley trees

Patch in preparation on sage-combinat


---

Comment by hivert created at 2011-11-21 17:00:33

Changing status from new to needs_review.


---

Comment by dkrenn created at 2012-02-26 00:02:00

Changing status from needs_review to needs_work.


---

Attachment

Patch cannot be applied. If this is just because of the unfinished #10194 (I don't know the current status of that), then it can be set back to "need review".


---

Comment by chapoton created at 2014-04-16 10:17:33

Florent, is this the latest patch from the sage-combinat queue ? If not, it would be good to refresh, so that one can start working on it here.


---

Comment by chapoton created at 2014-04-20 09:28:32

I have made a branch from the latest sage-combinat patch, plus some details corrected.
----
New commits:


---

Comment by git created at 2014-04-21 08:01:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-21 08:15:16

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-04-21 08:22:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-02 19:35:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-08 18:12:19

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-08 20:11:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2014-06-09 07:32:39

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-01-06 17:27:58

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-02-16 15:54:46

Changing status from needs_work to needs_review.


---

Comment by chapoton created at 2015-02-16 15:54:46

I have removed the dependency to the ticket #10194. Now progress is possible here.

There is current interest in this matter, see https://groups.google.com/forum/#!topic/sage-combinat-devel/oi4VtGr1g5A
----
New commits:


---

Comment by darij created at 2015-02-16 17:09:37

These are (rooted) trees modulo permutation of children, right? I'm asking because I don't see much of a documentation here.

(Let me add that I have never seen them called "Cayley trees" in my life. This notation contradicts http://en.wikipedia.org/wiki/Bethe_lattice and http://mathworld.wolfram.com/CayleyTree.html .)


---

Comment by tscrim created at 2015-02-16 19:35:49

Replying to [comment:18 darij]:
> These are (rooted) trees modulo permutation of children, right? I'm asking because I don't see much of a documentation here.

From looking at the code and the `normalize()` doctest, that is right (i.e., they are not ordered/planer trees). I think we need to expand the documentation before this can get into Sage.

> (Let me add that I have never seen them called "Cayley trees" in my life. This notation contradicts http://en.wikipedia.org/wiki/Bethe_lattice and http://mathworld.wolfram.com/CayleyTree.html .)

+1 from me to removing this terminology (at least for now since Cayley trees aren't implemented).


---

Comment by git created at 2015-02-16 20:15:37

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-16 21:18:51

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-02-17 05:51:30

OK. Are you sure `on_fly` is a good idea? It behaves nondeterministically:

```
sage: OT = OrderedTree
sage: OT([[[],[]], [[],[],[]]]).normalize()
[[[], []], [[], [], []]]
sage: OT([[[],[],[]], [[],[]]]).normalize()
[[[], []], [[], [], []]]
sage: 
Exiting Sage (CPU time 0m0.29s, Wall time 1m31.05s).
skraeling`@`angband ~/sage $ ./sage
┌────────────────────────────────────────────────────────────────────┐
│ Sage Version 6.5.rc1, Release Date: 2015-02-08                     │
│ Type "notebook()" for the browser-based notebook interface.        │
│ Type "help()" for help.                                            │
└────────────────────────────────────────────────────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Warning: this is a prerelease version, and it may be unstable.     ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
sage: OT = OrderedTree
sage: OT([[[],[],[]], [[],[]]]).normalize()
[[[], [], []], [[], []]]
sage: OT([[[],[]], [[],[],[]]]).normalize()
[[[], [], []], [[], []]]
```

Is this what we want? And does it behave well in regard to the other features of our tree classes, such as the `clone` context manager?

If we just want a comparison method for normalization, we can compare two trees "lexicographically" by number of children, number of children of the leftmost child, etc.. If we want an actual ranker, then this is not enough...

Also, the doc of `LabelledRootedTrees` says that this class is a parent stub to be inherited from by classes of labelled rooted trees with specific properties; but the `unlabelled_trees` and `cardinality` methods look like they are specific to the class of *all* labelled rooted trees. Shouldn't they go into `LabelledRootedTrees_all`?


---

Comment by git created at 2015-02-17 13:39:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-17 14:12:46

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-02-17 14:19:50

Hello,

concerning the ranker, I do not care about the possible non-deterministic aspect. There is no clear canonical way to generate and number all rooted trees, so there is no best choice.

concerning the methods of `LabelledRootedTrees`, well, there is no `LabelledRootedTrees_all`. And I do not think one need that for now.

At some point later, it would be good to have classes for labelled rooted trees with labels in a fixed set. So far, all possible labels are allowed. This is needed for operads.

It is true that the content of this ticket is rather minimalistic. But it is enough for #15635, which is my main motivation.


---

Comment by darij created at 2015-02-17 21:07:12

OK, I am not saying that this nondeterminism is bad, but I think it is avoidable in this specific setting. When it comes to building combinatorial Hopf algebras, I don't want to have to harden all the doctests because a change somewhere else might lead to all trees getting rotated. What do you think about my deterministic normalization method in public/combinat/11529 ?


---

Comment by darij created at 2015-02-17 21:07:23

New commits:


---

Comment by chapoton created at 2015-02-18 08:22:20

This proposal of yours will not work (at least in its current state) for labelled rooted trees. Besides, if I remember well (this is already a few years old), the recursive approach was tried and rejected for being slower than the ranker approach.


---

Comment by git created at 2015-02-18 15:58:54

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-18 15:59:53

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by darij created at 2015-02-18 16:01:50

Ah, I see. I've reinstated your definition of normalization, while keeping mine as a method for doctesting pruposes.


---

Comment by darij created at 2015-02-19 04:52:32


```
+        with self.clone() as t:
+            t.append(other)
+            resu = t
+        return resu
```

Why not remove the "resu = t" line and just return t? I'm wondering because I'm not sure if my understanding of the clone context manager is correct.

Also, is it OK if I split `LabelledRootedTrees` into an abstract base class and a concrete class?


---

Comment by chapoton created at 2015-02-19 10:19:46

Replying to [comment:32 darij]:
> {{{
> +        with self.clone() as t:
> +            t.append(other)
> +            resu = t
> +        return resu
> }}}
> Why not remove the "resu = t" line and just return t? I'm wondering because I'm not sure if my understanding of the clone context manager is correct.

Yes, I guess one can return t. I am not very sure either to understand the clone mantra.

> Also, is it OK if I split `LabelledRootedTrees` into an abstract base class and a concrete class?

Yes, please do as you want, but try to keep things simple enough for me :)


---

Comment by git created at 2015-02-19 21:57:53

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-19 22:15:49

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-02-19 22:18:44

Is this:

```
        tst = (children.__class__ is self.__class__
               and children.parent() == parent)
        if not tst:
            children = [self.__class__(parent, x) for x in children]
```

supposed to catch the case of `children` being a rooted tree? Because I'm not sure I understand the logic. `childen` is a list; maybe you want `x.__class__ for x in children` instead of `children.__class__`?

Also, as usual, I don't understand the classcall metaclass magic, so I am just reading past it.


---

Comment by git created at 2015-02-19 22:20:55

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-02-20 06:14:11

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-02-20 06:16:11

OK, almost positive_review. I leave the following functions to someone who understands our OOP better:

- `RootedTree.__classcall_private__`

- `RootedTree.__init__` (see also http://trac.sagemath.org/ticket/11529#comment:37 )

- `RootedTree.normalize`

- `LabelledRootedTree.__classcall_private__`


---

Comment by tscrim created at 2015-02-20 06:58:24

I will try to take a look at them over the weekend (unless someone beats me to it).


---

Comment by chapoton created at 2015-02-23 19:44:13

Changing keywords from "rooted trees, Cayley" to "rooted trees".


---

Comment by git created at 2015-02-27 20:23:40

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-02-27 20:25:50

I made some minor changes, so if you're happy with them, then positive review since the class heirachy looks good. (Sorry it's almost the following weekend.)


---

Comment by darij created at 2015-02-27 21:32:17

The changes look OK to me (except I still don't understand the

```
if not (children.__class__ is self.__class__
        and children.parent() == parent):
```

check). What about you, Frederic?

Thank you for looking at this, Travis!


---

Comment by tscrim created at 2015-02-28 06:45:34

Replying to [comment:46 darij]:
> The changes look OK to me (except I still don't understand the
> {{{
> if not (children.__class__ is self.__class__
>         and children.parent() == parent):
> }}}
> check).

That is making sure that the children are also rooted subtrees of the same parent (you can think of it like a linked list, but instead of a separate class for nodes, it links to a smaller list).

> Thank you for looking at this, Travis!

The least I could do.


---

Comment by darij created at 2015-02-28 07:24:24

But isn't `children` a list by the moment this check is happening?


---

Comment by tscrim created at 2015-02-28 07:28:53

Replying to [comment:48 darij]:
> But isn't `children` a list by the moment this check is happening?

You're right; this check is worthless. An artifact of refactoring out #10194 perhaps?


---

Comment by darij created at 2015-02-28 07:33:09

Maybe. Would you suggest fixing it or just blanket casting `children` to the appropriate class?


---

Comment by tscrim created at 2015-02-28 07:40:21

I'd comment out the `if` and do the blanket casting. Want me to do it?


---

Comment by darij created at 2015-02-28 07:47:27

Yeah, I'm slowly going to bed so I'd rather not fire up the virtual machine. Feel free to set this to positive_review then!


---

Comment by git created at 2015-02-28 07:50:30

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by tscrim created at 2015-02-28 07:51:08

Changing status from needs_review to positive_review.


---

Comment by tscrim created at 2015-02-28 07:51:08

Done, thanks.


---

Comment by vbraun created at 2015-03-12 23:52:55

just as a general PSA, i'm not merging tickets that are milestone: sage-pending


---

Comment by vbraun created at 2015-03-12 23:53:27

sorry, wrong ticket ;-)


---

Comment by chapoton created at 2015-03-25 20:08:37

Follow-up ticket at #15635


---

Comment by darij created at 2015-04-15 02:21:41

Hello Volker :)


---

Comment by vbraun created at 2015-04-15 16:19:56

Don't make pre-git tickets a dependency if you want auutomatic merging to work...


---

Comment by vbraun created at 2015-04-15 16:21:29

Conflict, probably with #18179


---

Comment by vbraun created at 2015-04-15 16:21:29

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-04-15 16:48:29

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-04-15 16:48:41

I don't see any conflict, but here is a merge for convenience.
----
New commits:


---

Comment by darij created at 2015-04-15 16:48:41

Changing status from needs_work to positive_review.


---

Comment by vbraun created at 2015-04-15 21:13:30

Changing status from positive_review to needs_work.


---

Comment by vbraun created at 2015-04-15 21:13:30

If you didn't get a conflict then the conflict was elsewhere. Try 6.7.beta1


---

Comment by git created at 2015-04-15 21:41:20

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-04-15 22:20:55

Changing status from needs_work to positive_review.


---

Comment by chapoton created at 2015-04-18 07:00:48

Changing status from positive_review to needs_work.


---

Comment by chapoton created at 2015-04-18 07:00:48

Damn, there is a failing doctest !


---

Comment by chapoton created at 2015-04-18 20:17:23

I am working on that..


---

Comment by git created at 2015-04-19 09:16:43

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-04-19 09:19:01

ok, I have got rid of ranker, so that the order is now deterministic.

Maybe it will be slow, but speed can be taken care later on.

I have tried to use cached_method for the sort_key function, but it does not interact well with the ClonableTree setup.

The patchbot should be happy, let us see.


---

Comment by chapoton created at 2015-04-19 09:19:01

Changing status from needs_work to needs_review.


---

Comment by git created at 2015-04-19 15:38:18

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-04-19 17:35:20

Stupid question: If a class inherits both from `LabelledOrderedTree` and another subclass of `OrderedTree`, then is there a way to tell which class's `sort_key` method it will get? Because if it gets it from `OrderedTree`, then its normalization won't work properly (`sort_key` will ignore the labels).

Same for methods such as `left_right_symmetry`.


---

Comment by chapoton created at 2015-04-20 19:33:28

Well, I do not know. Do you think that it matters for the present ticket ?

By the way, do you you want to keep the "dendrographical" stuff ?


---

Comment by darij created at 2015-04-20 19:39:22

I am slightly biased towards keeping things that work -- or do you see the dendrographical stuff as broken in some way? (When we get to combinatorial Hopf algerbas based on trees and transfers between different bases, every order will be useful...)

I don't know if the double inheritance (MRO) issue is a problem; this is why I'm asking. I would default to adding some warnings into the docstring, but I know of some people that are allergic to my warnings, and some other people who might find them not sufficient, so I prefer to ask...


---

Comment by chapoton created at 2015-04-20 19:54:54

No problem, let us keep the 'dendrographical' stuff. The name sounds somewhat funny to me.

I am not sure I see the point on warning about issues that look not very likely to be met  in the near future. But if you want to add them, I will not resist.

My aim now is to have this ticket in, as soon as possible, so that I can start to work on
the algebraic follow-up ticket #15635.


---

Comment by git created at 2015-04-20 20:51:38

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-20 21:18:41

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2015-04-20 21:26:42

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-04-20 21:28:06

Done. Are you OK with my changes?

I've added documentation for the pitfall I have mentioned in comment:72. Generally, I think Sage is lacking many warnings and implementation notes that would make it easier (or even possible) to extend from the existing classes as opposed to implementing new things from scratch because one doesn't understand the old classes' structure. In many cases, they would also help the reviewers review the patches (although in the current case this was simple enough).

I'm also waiting for #15635 to be ready, but alas I cannot help with the coercion :(


---

Comment by chapoton created at 2015-04-21 18:53:52

ok, the bot is happy. Darij, I agree with your changes (even if they make me think about the keyword "verbosity").

So, please put that into positive review, if you want ?


---

Comment by darij created at 2015-04-21 21:05:16

Changing status from needs_review to positive_review.


---

Comment by darij created at 2015-04-21 21:05:16

Thank you!


---

Comment by vbraun created at 2015-04-22 01:22:18

On 32-bit:

```
sage -t --long src/sage/combinat/rooted_tree.py
**********************************************************************
File "src/sage/combinat/rooted_tree.py", line 259, in sage.combinat.rooted_tree.RootedTree.__hash__
Failed example:
    hash(RT([[],[[]]]))  # indirect doctest
Expected:
    2578595415271398032
Got:
    1119083152
**********************************************************************
File "src/sage/combinat/rooted_tree.py", line 891, in sage.combinat.rooted_tree.LabelledRootedTree.__hash__
Failed example:
    hash(lb)  # indirect doctest
Expected:
    686798862222558969
Got:
    652936953
**********************************************************************
2 items had failures:
   1 of   3 in sage.combinat.rooted_tree.LabelledRootedTree.__hash__
   1 of   3 in sage.combinat.rooted_tree.RootedTree.__hash__
    [155 tests, 2 failures, 1.79 s]
```



---

Comment by vbraun created at 2015-04-22 01:22:18

Changing status from positive_review to needs_work.


---

Comment by git created at 2015-04-22 02:16:13

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by darij created at 2015-04-22 02:16:42

Changing status from needs_work to positive_review.


---

Comment by darij created at 2015-04-22 02:16:42

Good call -- I don't know how I missed them.


---

Comment by chapoton created at 2015-04-22 06:30:39

No, no ! This hash should be different for 32 and 64 bits !


---

Comment by chapoton created at 2015-04-22 06:30:39

Changing status from positive_review to needs_work.


---

Comment by darij created at 2015-04-22 06:31:46

You mean "should be" or "is"? What is going on here? Why should a hash (computed via sort_key) be machine-dependent?


---

Comment by chapoton created at 2015-04-22 06:36:41

The hash *is* different.
See many places, for example:

```
            sage: F = CombinatorialFreeModule(QQ, ['a','b','c'])
            sage: B = F.basis()
            sage: f = B['a'] + 3*B['c']
            sage: hash(f)
            6429418278783588506           # 64-bit
            726440090                     # 32-bit
```



---

Comment by darij created at 2015-04-22 06:37:06

Oh! Should it be marked #random?


---

Comment by chapoton created at 2015-04-22 06:38:59

No, it should have the two possible answers as in the example above.


---

Comment by git created at 2015-04-22 06:41:12

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by chapoton created at 2015-04-22 06:49:28

good for me on 64-bit


---

Comment by chapoton created at 2015-04-22 06:49:28

Changing status from needs_work to positive_review.


---

Comment by darij created at 2015-04-22 06:50:13

Thank you!


---

Comment by tscrim created at 2015-04-22 07:02:21

The easier test to make sure the hash is working is to do something like `hash(x) == hash(x)` (unless of course you're expecting a specific value, like `hash(1) == 1`), and it doesn't cause trivial doctest failures for changes to the hash function, but it probably doesn't really matter here.


---

Comment by hivert created at 2015-04-22 07:21:33

Replying to [comment:93 tscrim]:
> The easier test to make sure the hash is working is to do something like `hash(x) == hash(x)` (unless of course you're expecting a specific value, like `hash(1) == 1`), and it doesn't cause trivial doctest failures for changes to the hash function, but it probably doesn't really matter here.

If you use the same `x` then you are not testing anything serious. A good test would be  `hash(x) == hash(y)` with `x` and `y` two distinct but equal objects. 

Florent which is coming back to Sage after a long absence. 

By the way : Tanks to all of you for finishing this one !


---

Comment by chapoton created at 2015-04-22 08:48:47

Hello Florent. Glad to see you back.

To finish this ticket, I had to get rid of the dependency to #10194.
If I could suggest something, that would be to take care of #10194. It would certainly
help several people, that have based many of their tickets on that one.


---

Comment by vbraun created at 2015-04-23 03:22:00

Resolution: fixed
