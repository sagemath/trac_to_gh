# Issue 32075: faster abelian_group() method for elliptic curves over finite fields

archive/issues_032075.json:
```json
{
    "body": "CC:  @JohnCremona @kwankyu @defeo\n\nKeywords: elliptic curves, group structure, finite field\n\nThis patch improves the computation of a basis of the group of rational points for elliptic curves over finite fields.\n\nThe algorithm works as follows:\n* Call `gens()` to obtain a generating set; this in turn calls into PARI which factors the group order and uses pairings to determine the group structure.\n* Let `P` denote the point of larger order `n\u2081`; we will extend `P` to a basis `(P,Q')` where `Q'` has order `n\u2082 = #E/n\u2081`.\n* Remove all unneeded prime factors from the order of `Q`, i.e., multiply by the part of `n\u2081` that's coprime to `n\u2082`.\n* Find an appropriate multiple `[x]P` such that `Q' := Q-[x]P` has order `n\u2082`; this involves a (typically easy) discrete-logarithm computation.\n* As desired, `(P,Q')` is then a basis of the group of rational points of E.\n\nBenchmarks: I ran `.abelian_group()` on thousands of random elliptic curves over prime and extension fields with sizes between 8 and 160 bits using both Sage 9.3 and the new implementation, and the new algorithm was between 30% and 50% faster on average (for all sizes).\n\nIn addition, there are cases for which the new algorithm is *dramatically* faster. For example:\n\n**Sage 9.3:**\n\n```\nsage: for e in [7,17,31,61,127]:\n....:     E = EllipticCurve(GF((2**e-1)**2), [1,0])\n....:     %time E.abelian_group()\n....:\nCPU times: user 20.7 ms, sys: 66 \u00b5s, total: 20.7 ms\nWall time: 20.8 ms\nAdditive abelian group isomorphic to Z/128 + Z/128 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 127^2\nCPU times: user 342 ms, sys: 45 \u00b5s, total: 342 ms\nWall time: 342 ms\nAdditive abelian group isomorphic to Z/131072 + Z/131072 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 131071^2\nCPU times: user 1min 23s, sys: 103 ms, total: 1min 23s\nWall time: 1min 23s\nAdditive abelian group isomorphic to Z/2147483648 + Z/2147483648 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 2147483647^2\n#### (continues to run for a long time, then dies from lack of memory)\n```\n\n\n**New code:**\n\n```\nsage: for e in [7,17,31,61,127]:\n....:     E = EllipticCurve(GF((2**e-1)**2), [1,0])\n....:     %time E.abelian_group()\n....:\nCPU times: user 3.78 ms, sys: 0 ns, total: 3.78 ms\nWall time: 3.78 ms\nAdditive abelian group isomorphic to Z/128 + Z/128 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 127^2\nCPU times: user 7.75 ms, sys: 0 ns, total: 7.75 ms\nWall time: 7.77 ms\nAdditive abelian group isomorphic to Z/131072 + Z/131072 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 131071^2\nCPU times: user 12 ms, sys: 0 ns, total: 12 ms\nWall time: 12 ms\nAdditive abelian group isomorphic to Z/2147483648 + Z/2147483648 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 2147483647^2\nCPU times: user 29.7 ms, sys: 0 ns, total: 29.7 ms\nWall time: 29.8 ms\nAdditive abelian group isomorphic to Z/2305843009213693952 + Z/2305843009213693952 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 2305843009213693951^2\nCPU times: user 280 ms, sys: 0 ns, total: 280 ms\nWall time: 280 ms\nAdditive abelian group isomorphic to Z/170141183460469231731687303715884105728 + Z/170141183460469231731687303715884105728 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 170141183460469231731687303715884105727^2\n```\n\n\nThe only curves for which the new algorithm is *not* polynomial-time (after factoring the order) are curves whose group of rational points has `\u2113^\u221e`-torsion isomorphic to `\u2124/\u2113^r \u00d7 \u2124/\u2113^s` where `r > s > 0` for some prime `\u2113`. In that case, the cost includes a factor `\u0398(\u221a\u2113)`. I don't think I know how to construct such curves for large `\u2113`.\n\n\nIssue created by migration from https://trac.sagemath.org/ticket/32312\n\n",
    "created_at": "2021-07-30T11:11:24Z",
    "labels": [
        "component: elliptic curves",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.5",
    "title": "faster abelian_group() method for elliptic curves over finite fields",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/32075",
    "user": "https://github.com/yyyyx4"
}
```
CC:  @JohnCremona @kwankyu @defeo

Keywords: elliptic curves, group structure, finite field

This patch improves the computation of a basis of the group of rational points for elliptic curves over finite fields.

The algorithm works as follows:
* Call `gens()` to obtain a generating set; this in turn calls into PARI which factors the group order and uses pairings to determine the group structure.
* Let `P` denote the point of larger order `n₁`; we will extend `P` to a basis `(P,Q')` where `Q'` has order `n₂ = #E/n₁`.
* Remove all unneeded prime factors from the order of `Q`, i.e., multiply by the part of `n₁` that's coprime to `n₂`.
* Find an appropriate multiple `[x]P` such that `Q' := Q-[x]P` has order `n₂`; this involves a (typically easy) discrete-logarithm computation.
* As desired, `(P,Q')` is then a basis of the group of rational points of E.

Benchmarks: I ran `.abelian_group()` on thousands of random elliptic curves over prime and extension fields with sizes between 8 and 160 bits using both Sage 9.3 and the new implementation, and the new algorithm was between 30% and 50% faster on average (for all sizes).

In addition, there are cases for which the new algorithm is *dramatically* faster. For example:

**Sage 9.3:**

```
sage: for e in [7,17,31,61,127]:
....:     E = EllipticCurve(GF((2**e-1)**2), [1,0])
....:     %time E.abelian_group()
....:
CPU times: user 20.7 ms, sys: 66 µs, total: 20.7 ms
Wall time: 20.8 ms
Additive abelian group isomorphic to Z/128 + Z/128 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 127^2
CPU times: user 342 ms, sys: 45 µs, total: 342 ms
Wall time: 342 ms
Additive abelian group isomorphic to Z/131072 + Z/131072 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 131071^2
CPU times: user 1min 23s, sys: 103 ms, total: 1min 23s
Wall time: 1min 23s
Additive abelian group isomorphic to Z/2147483648 + Z/2147483648 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 2147483647^2
#### (continues to run for a long time, then dies from lack of memory)
```


**New code:**

```
sage: for e in [7,17,31,61,127]:
....:     E = EllipticCurve(GF((2**e-1)**2), [1,0])
....:     %time E.abelian_group()
....:
CPU times: user 3.78 ms, sys: 0 ns, total: 3.78 ms
Wall time: 3.78 ms
Additive abelian group isomorphic to Z/128 + Z/128 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 127^2
CPU times: user 7.75 ms, sys: 0 ns, total: 7.75 ms
Wall time: 7.77 ms
Additive abelian group isomorphic to Z/131072 + Z/131072 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 131071^2
CPU times: user 12 ms, sys: 0 ns, total: 12 ms
Wall time: 12 ms
Additive abelian group isomorphic to Z/2147483648 + Z/2147483648 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 2147483647^2
CPU times: user 29.7 ms, sys: 0 ns, total: 29.7 ms
Wall time: 29.8 ms
Additive abelian group isomorphic to Z/2305843009213693952 + Z/2305843009213693952 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 2305843009213693951^2
CPU times: user 280 ms, sys: 0 ns, total: 280 ms
Wall time: 280 ms
Additive abelian group isomorphic to Z/170141183460469231731687303715884105728 + Z/170141183460469231731687303715884105728 embedded in Abelian group of points on Elliptic Curve defined by y^2 = x^3 + x over Finite Field in z2 of size 170141183460469231731687303715884105727^2
```


The only curves for which the new algorithm is *not* polynomial-time (after factoring the order) are curves whose group of rational points has `ℓ^∞`-torsion isomorphic to `ℤ/ℓ^r × ℤ/ℓ^s` where `r > s > 0` for some prime `ℓ`. In that case, the cost includes a factor `Θ(√ℓ)`. I don't think I know how to construct such curves for large `ℓ`.


Issue created by migration from https://trac.sagemath.org/ticket/32312





---

archive/issue_comments_457436.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2021-07-30T11:12:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457436",
    "user": "https://github.com/yyyyx4"
}
```

Changing status from new to needs_review.



---

archive/issue_events_085697.json:
```json
{
    "actor": "https://github.com/mkoeppe",
    "created_at": "2021-08-10T17:30:20Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "milestone": "sage-9.5",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32075#event-85697"
}
```



---

archive/issue_comments_457437.json:
```json
{
    "body": "I cannot attest to the validity of the algorithm, but it is implemented as defined as far as I can tell and it passes doctests.\n\nIs this something that is guaranteed to happen or is it for controlling user input?\n\n```\nassert len(gens) <= 2\n```\n\n\nAlso, it would be better to write this on two lines:\n\n```diff\n-S, T = n//nQ * P, n2 * Q\n+S = n//nQ * P\n+T = n2 * Q\n```\n\n\nIn the doc, you should use `\\ZZ` instead of `\\mathbb Z` for uniformity.\n\nDo you have a reference for this algorithm you could add to the doc?",
    "created_at": "2021-08-15T00:20:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457437",
    "user": "https://github.com/tscrim"
}
```

I cannot attest to the validity of the algorithm, but it is implemented as defined as far as I can tell and it passes doctests.

Is this something that is guaranteed to happen or is it for controlling user input?

```
assert len(gens) <= 2
```


Also, it would be better to write this on two lines:

```diff
-S, T = n//nQ * P, n2 * Q
+S = n//nQ * P
+T = n2 * Q
```


In the doc, you should use `\ZZ` instead of `\mathbb Z` for uniformity.

Do you have a reference for this algorithm you could add to the doc?



---

archive/issue_comments_457438.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-15T07:35:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457438",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457439.json:
```json
{
    "body": "Replying to [comment:7 tscrim]:\n> Is this something that is guaranteed to happen or is it for controlling user input?\n> {{{\n> assert len(gens) <= 2\n> }}}\n\nThis is guaranteed by the documentation and current implementation of `self.gens()`. Unless someone changes the meaning of `gens()` in a mathematically nonsensical way in the future, it will always hold. I suppose the `assert` is realistically useless, but it does make explicit an assumption of the following code.\n\n> Do you have a reference for this algorithm you could add to the doc?\n\nI pretty much made this one up while writing the code. Does anyone know a reference? This is a generic-group algorithm, so it's probably a special case of something in Sutherland's thesis (or elsewhere), but the specifics here are tailored to the output of `gens()`.",
    "created_at": "2021-08-15T07:37:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457439",
    "user": "https://github.com/yyyyx4"
}
```

Replying to [comment:7 tscrim]:
> Is this something that is guaranteed to happen or is it for controlling user input?
> {{{
> assert len(gens) <= 2
> }}}

This is guaranteed by the documentation and current implementation of `self.gens()`. Unless someone changes the meaning of `gens()` in a mathematically nonsensical way in the future, it will always hold. I suppose the `assert` is realistically useless, but it does make explicit an assumption of the following code.

> Do you have a reference for this algorithm you could add to the doc?

I pretty much made this one up while writing the code. Does anyone know a reference? This is a generic-group algorithm, so it's probably a special case of something in Sutherland's thesis (or elsewhere), but the specifics here are tailored to the output of `gens()`.



---

archive/issue_comments_457440.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-15T07:40:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457440",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457441.json:
```json
{
    "body": "Replying to [comment:9 lorenz]:\n> Replying to [comment:7 tscrim]:\n> > Is this something that is guaranteed to happen or is it for controlling user input?\n> > {{{\n> > assert len(gens) <= 2\n> > }}}\n> \n> This is guaranteed by the documentation and current implementation of `self.gens()`. Unless someone changes the meaning of `gens()` in a mathematically nonsensical way in the future, it will always hold. I suppose the `assert` is realistically useless, but it does make explicit an assumption of the following code.\n\nThat was my understanding from looking at the previous code, but I figured I should double-check.\n\n> > Do you have a reference for this algorithm you could add to the doc?\n> \n> I pretty much made this one up while writing the code. Does anyone know a reference? This is a generic-group algorithm, so it's probably a special case of something in Sutherland's thesis (or elsewhere), but the specifics here are tailored to the output of `gens()`.\n\nThis is outside of my area of expertise. Could you add a bit about the algorithm in to the documentation? Also, is this random still? It looks quite deterministic.",
    "created_at": "2021-08-16T00:27:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457441",
    "user": "https://github.com/tscrim"
}
```

Replying to [comment:9 lorenz]:
> Replying to [comment:7 tscrim]:
> > Is this something that is guaranteed to happen or is it for controlling user input?
> > {{{
> > assert len(gens) <= 2
> > }}}
> 
> This is guaranteed by the documentation and current implementation of `self.gens()`. Unless someone changes the meaning of `gens()` in a mathematically nonsensical way in the future, it will always hold. I suppose the `assert` is realistically useless, but it does make explicit an assumption of the following code.

That was my understanding from looking at the previous code, but I figured I should double-check.

> > Do you have a reference for this algorithm you could add to the doc?
> 
> I pretty much made this one up while writing the code. Does anyone know a reference? This is a generic-group algorithm, so it's probably a special case of something in Sutherland's thesis (or elsewhere), but the specifics here are tailored to the output of `gens()`.

This is outside of my area of expertise. Could you add a bit about the algorithm in to the documentation? Also, is this random still? It looks quite deterministic.



---

archive/issue_comments_457442.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2021-08-16T06:55:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457442",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_457443.json:
```json
{
    "body": "Replying to [comment:11 tscrim]:\n> Could you add a bit about the algorithm in to the documentation? Also, is this random still? It looks quite deterministic.\n\nDone, and yes: It calls into `.gens()`, which is randomized. I've tried making this a little bit clearer in the newest commit.",
    "created_at": "2021-08-16T06:57:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457443",
    "user": "https://github.com/yyyyx4"
}
```

Replying to [comment:11 tscrim]:
> Could you add a bit about the algorithm in to the documentation? Also, is this random still? It looks quite deterministic.

Done, and yes: It calls into `.gens()`, which is randomized. I've tried making this a little bit clearer in the newest commit.



---

archive/issue_comments_457444.json:
```json
{
    "body": "Thank you. LGTM.",
    "created_at": "2021-08-16T12:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457444",
    "user": "https://github.com/tscrim"
}
```

Thank you. LGTM.



---

archive/issue_comments_457445.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2021-08-16T12:18:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457445",
    "user": "https://github.com/tscrim"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_457446.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2021-09-05T21:38:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/32075#issuecomment-457446",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_085698.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2021-09-05T21:38:45Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/32075",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/32075#event-85698"
}
```
