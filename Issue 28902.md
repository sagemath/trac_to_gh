# Issue 28902: *.pxi files might not be Python3-ready

archive/issues_028902.json:
```json
{
    "body": "CC:  @fchapoton\n\nThis manifests itself in `%%cython` magic, e.g.\n\n```\nsage: %%cython\n....: include \"sage/data_structures/bitset.pxi\"\n```\n\nleads to \n\n```\nRuntimeError: Error compiling Cython file:\n------------------------------------------------------------\n...\n    \"\"\"\n    if size <= 0:\n        raise ValueError(\"bitset capacity must be greater than 0\")\n\n    bits.size = size\n    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1\n                                                     ^\n------------------------------------------------------------\n\n/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/data_structures/bitset.pxi:84:54: Cannot assign type 'double' to 'mp_size_t'\n...\n```\n\n\nthis was reported on sage-support\n\nIssue created by migration from https://trac.sagemath.org/ticket/29139\n\n",
    "created_at": "2020-02-02T11:49:37Z",
    "labels": [
        "component: python3",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-9.2",
    "title": "*.pxi files might not be Python3-ready",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/28902",
    "user": "https://github.com/dimpase"
}
```
CC:  @fchapoton

This manifests itself in `%%cython` magic, e.g.

```
sage: %%cython
....: include "sage/data_structures/bitset.pxi"
```

leads to 

```
RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...
    """
    if size <= 0:
        raise ValueError("bitset capacity must be greater than 0")

    bits.size = size
    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
                                                     ^
------------------------------------------------------------

/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/data_structures/bitset.pxi:84:54: Cannot assign type 'double' to 'mp_size_t'
...
```


this was reported on sage-support

Issue created by migration from https://trac.sagemath.org/ticket/29139





---

archive/issue_comments_408685.json:
```json
{
    "body": "\n```diff\n--- a/src/sage/data_structures/bitset.pxi\n+++ b/src/sage/data_structures/bitset.pxi\n@@ -81,7 +81,7 @@ cdef inline bint bitset_init(bitset_t bits, mp_bitcnt_t size) except -1:\n         raise ValueError(\"bitset capacity must be greater than 0\")\n \n     bits.size = size\n-    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1\n+    bits.limbs = (size - 1) // (8 * sizeof(mp_limb_t)) + 1\n     bits.bits = <mp_limb_t*>check_calloc(bits.limbs, sizeof(mp_limb_t))\n \n cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:\n@@ -96,7 +96,7 @@ cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:\n     if size <= 0:\n         raise ValueError(\"bitset capacity must be greater than 0\")\n \n-    cdef mp_size_t limbs_new = (size - 1) / (8 * sizeof(mp_limb_t)) + 1\n+    cdef mp_size_t limbs_new = (size - 1) // (8 * sizeof(mp_limb_t)) + 1\n     bits.bits = <mp_limb_t*>check_reallocarray(bits.bits, limbs_new, sizeof(mp_limb_t))\n     bits.size = size\n     bits.limbs = limbs_new\n```\n\nallow the command in the ticket description to pass, and the tests still pass.",
    "created_at": "2020-02-02T19:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408685",
    "user": "https://github.com/dimpase"
}
```


```diff
--- a/src/sage/data_structures/bitset.pxi
+++ b/src/sage/data_structures/bitset.pxi
@@ -81,7 +81,7 @@ cdef inline bint bitset_init(bitset_t bits, mp_bitcnt_t size) except -1:
         raise ValueError("bitset capacity must be greater than 0")
 
     bits.size = size
-    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
+    bits.limbs = (size - 1) // (8 * sizeof(mp_limb_t)) + 1
     bits.bits = <mp_limb_t*>check_calloc(bits.limbs, sizeof(mp_limb_t))
 
 cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:
@@ -96,7 +96,7 @@ cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:
     if size <= 0:
         raise ValueError("bitset capacity must be greater than 0")
 
-    cdef mp_size_t limbs_new = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
+    cdef mp_size_t limbs_new = (size - 1) // (8 * sizeof(mp_limb_t)) + 1
     bits.bits = <mp_limb_t*>check_reallocarray(bits.bits, limbs_new, sizeof(mp_limb_t))
     bits.size = size
     bits.limbs = limbs_new
```

allow the command in the ticket description to pass, and the tests still pass.



---

archive/issue_comments_408686.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2020-02-04T09:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408686",
    "user": "https://github.com/kliem"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_408687.json:
```json
{
    "body": "Changing keywords from \"\" to \"bitset, floor division\".",
    "created_at": "2020-02-04T09:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408687",
    "user": "https://github.com/kliem"
}
```

Changing keywords from "" to "bitset, floor division".



---

archive/issue_comments_408688.json:
```json
{
    "body": "Clearly, floor division was intended at that place.\n----\nNew commits:",
    "created_at": "2020-02-04T09:06:36Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408688",
    "user": "https://github.com/kliem"
}
```

Clearly, floor division was intended at that place.
----
New commits:



---

archive/issue_comments_408689.json:
```json
{
    "body": "At least one more error with floor division.",
    "created_at": "2020-02-04T09:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408689",
    "user": "https://github.com/kliem"
}
```

At least one more error with floor division.



---

archive/issue_comments_408690.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2020-02-04T09:19:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408690",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_408691.json:
```json
{
    "body": "Could you check (with %%cython magic) all the *.pxi files for this sort of problem?",
    "created_at": "2020-02-04T10:00:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408691",
    "user": "https://github.com/dimpase"
}
```

Could you check (with %%cython magic) all the *.pxi files for this sort of problem?



---

archive/issue_comments_408692.json:
```json
{
    "body": "Yes, I'm doing it right now.",
    "created_at": "2020-02-04T10:04:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408692",
    "user": "https://github.com/kliem"
}
```

Yes, I'm doing it right now.



---

archive/issue_comments_408693.json:
```json
{
    "body": "Why does this happen? The variable `size` in the code has type `mp_bitcnt_t` which is a gmp typedef for `unsigned long`. The code thus only involves C types, so the `/`-division should return an integer. Changing this to `//`-division does not look like the correct solution to me, as it just cures a symptom.\n\nThe underlying problem might be in the `%%cython` magic itself.",
    "created_at": "2020-02-04T17:26:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408693",
    "user": "https://github.com/mwageringel"
}
```

Why does this happen? The variable `size` in the code has type `mp_bitcnt_t` which is a gmp typedef for `unsigned long`. The code thus only involves C types, so the `/`-division should return an integer. Changing this to `//`-division does not look like the correct solution to me, as it just cures a symptom.

The underlying problem might be in the `%%cython` magic itself.



---

archive/issue_comments_408694.json:
```json
{
    "body": "The problem is in the magic, no question about it, as \"normal\", non-interactive, use of these files is indeed OK. I proposed here a \"cheap\" way of fixing the problem, by merely making the code Python3-compatible. \n\nFeel free to dig into `%%cython`.",
    "created_at": "2020-02-04T17:38:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408694",
    "user": "https://github.com/dimpase"
}
```

The problem is in the magic, no question about it, as "normal", non-interactive, use of these files is indeed OK. I proposed here a "cheap" way of fixing the problem, by merely making the code Python3-compatible. 

Feel free to dig into `%%cython`.



---

archive/issue_comments_408695.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-02-05T09:31:05Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408695",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_408696.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2020-02-05T09:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408696",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_408697.json:
```json
{
    "body": "As mentioned, I found a few more instances.\n\nI looked into all `.pxi` files. However the files with corresponding header are really hard to test, e.g.\n\n`/matrix/matrix_modn_dense_template_header.pxi`\n`/matrix/matrix_modn_dense_template.pxi`\n\nIt is assumed that the header is included into a `pxd` file and the other into the corresponding `pyx` file. So I guess it is really not meant to work with `%%cython`.\n\nI got the test down to a few warnings but that was about it. Also it is annoying to search for the correct things to import first, as some of the `pxi` files assume lots of imports already.",
    "created_at": "2020-02-05T09:37:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408697",
    "user": "https://github.com/kliem"
}
```

As mentioned, I found a few more instances.

I looked into all `.pxi` files. However the files with corresponding header are really hard to test, e.g.

`/matrix/matrix_modn_dense_template_header.pxi`
`/matrix/matrix_modn_dense_template.pxi`

It is assumed that the header is included into a `pxd` file and the other into the corresponding `pyx` file. So I guess it is really not meant to work with `%%cython`.

I got the test down to a few warnings but that was about it. Also it is annoying to search for the correct things to import first, as some of the `pxi` files assume lots of imports already.



---

archive/issue_comments_408698.json:
```json
{
    "body": "The issue can be reproduced by cythonizing this file\n\n```\n# file division.pyx\ncdef int a = -6\ncdef int b = 5\ncdef int c = 0\nc = a / b\n```\n\nwith this setup using `sage -python`:\n\n```\nfrom distutils.core import Extension\nfrom Cython.Build import cythonize\next = Extension(\"division\", sources=[\"division.pyx\"])\nres = cythonize([ext], compiler_directives=dict(language_level=3))\n```\n\n\nThe problem is a missing compiler directive `cdivision=True`, which enforces C semantics instead of Python semantics for division. The [Cython docs](https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives) say:\n\n> cdivision (True / False)\n>\n> If set to False, Cython will adjust the remainder and quotient operators C types to match those of Python ints (which differ when the operands have opposite signs) and raise a ZeroDivisionError when the right operand is 0. This has up to a 35% speed penalty. If set to True, no checks are performed. See CEP 516. Default is False.\n\nI am rather surprised that this does not mention anything about the division operator returning double instead of int with Python 3, so I can only assume that this tries to match Python 3 semantics now.\n\nThe directive is also set in `src/setup.py` for all of Sage, so I suggest to solve this by setting it in `sage.misc.cython` as well (and the other compiler directives might be worth checking, too):\n\n```diff\n--- a/src/sage/misc/cython.py\n+++ b/src/sage/misc/cython.py\n@@ -315,7 +315,8 @@ def cython(filename, verbose=0, compile_message=False,\n                     libraries=standard_libs,\n                     library_dirs=standard_libdirs)\n\n-    directives = dict(language_level=sys.version_info[0])\n+    directives = dict(language_level=sys.version_info[0],\n+                      cdivision=True)\n\n     try:\n         # Change directories to target_dir so that Cython produces the correct\n```\n\n\nIn the example above, the value of `c` changes from `-2` (Python floor) to `-1` (C truncation towards 0).\n\nThe compiler directive can also be set directly:\n\n```\nsage: %%cython\n....: # cython: cdivision=True\n....: include \"sage/data_structures/bitset.pxi\"\n```\n",
    "created_at": "2020-02-05T22:15:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408698",
    "user": "https://github.com/mwageringel"
}
```

The issue can be reproduced by cythonizing this file

```
# file division.pyx
cdef int a = -6
cdef int b = 5
cdef int c = 0
c = a / b
```

with this setup using `sage -python`:

```
from distutils.core import Extension
from Cython.Build import cythonize
ext = Extension("division", sources=["division.pyx"])
res = cythonize([ext], compiler_directives=dict(language_level=3))
```


The problem is a missing compiler directive `cdivision=True`, which enforces C semantics instead of Python semantics for division. The [Cython docs](https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives) say:

> cdivision (True / False)
>
> If set to False, Cython will adjust the remainder and quotient operators C types to match those of Python ints (which differ when the operands have opposite signs) and raise a ZeroDivisionError when the right operand is 0. This has up to a 35% speed penalty. If set to True, no checks are performed. See CEP 516. Default is False.

I am rather surprised that this does not mention anything about the division operator returning double instead of int with Python 3, so I can only assume that this tries to match Python 3 semantics now.

The directive is also set in `src/setup.py` for all of Sage, so I suggest to solve this by setting it in `sage.misc.cython` as well (and the other compiler directives might be worth checking, too):

```diff
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -315,7 +315,8 @@ def cython(filename, verbose=0, compile_message=False,
                     libraries=standard_libs,
                     library_dirs=standard_libdirs)

-    directives = dict(language_level=sys.version_info[0])
+    directives = dict(language_level=sys.version_info[0],
+                      cdivision=True)

     try:
         # Change directories to target_dir so that Cython produces the correct
```


In the example above, the value of `c` changes from `-2` (Python floor) to `-1` (C truncation towards 0).

The compiler directive can also be set directly:

```
sage: %%cython
....: # cython: cdivision=True
....: include "sage/data_structures/bitset.pxi"
```




---

archive/issue_comments_408699.json:
```json
{
    "body": "I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?\n\nFor a start, you could do the change proposed plus enable `cdivision_warnings` and see if all doctests still pass. Long term this might be desirable, but it seems like a lot of work to me. Note that python division is still available for python objects:\n\n\n```\nsage: cython('''\n....: # cython: cdivision=True\n....: def test(a,b): return a/b\n....: ''')\nsage: test(2,3)\n2/3\n```\n\n\nI think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.",
    "created_at": "2020-02-06T07:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408699",
    "user": "https://github.com/kliem"
}
```

I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?

For a start, you could do the change proposed plus enable `cdivision_warnings` and see if all doctests still pass. Long term this might be desirable, but it seems like a lot of work to me. Note that python division is still available for python objects:


```
sage: cython('''
....: # cython: cdivision=True
....: def test(a,b): return a/b
....: ''')
sage: test(2,3)
2/3
```


I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.



---

archive/issue_comments_408700.json:
```json
{
    "body": "Replying to [comment:12 gh-kliem]:\n> I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?\n\nThe directive is already enabled for all of Sage, so I was suggesting to do the same for the `%%cython`-magic, for compatibility with the Sage library. Of course, Sage's default (`cdivision=True`) is different from Cython's default. We can only adhere to one of them when setting the default for the `%%cython`-magic, and both values have their justification. For use with code from the Sage library, it is desirable to enable it, but for use with external Cython code, this can be unexpected as it is not Cython's default.\n\nOne could argue that it is the responsibility of the user of the `%%cython`-magic to ensure that those compiler directives are set that are needed for the included code.\n\nThis also extends to other directives. For example, Sage is compiled with `language_level=\"3str\"`, but the `%%cython`-magic sets it to `2` or `3` depending on the Python version. I think it is wrong to assume that including code from the Sage library will just work without adjusting this setting.\n\n> I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.\n\nIndeed, we could add all compiler directives to the top of every Cython file. I am not sure if this is desirable from a maintainability point of view, as this duplicates code in a lot of places. Though, at least this has the advantage that one cannot accidentally compile a file with the wrong semantics.\n\nTo be honest, I do not know what the best thing to do here is.",
    "created_at": "2020-02-07T22:33:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408700",
    "user": "https://github.com/mwageringel"
}
```

Replying to [comment:12 gh-kliem]:
> I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?

The directive is already enabled for all of Sage, so I was suggesting to do the same for the `%%cython`-magic, for compatibility with the Sage library. Of course, Sage's default (`cdivision=True`) is different from Cython's default. We can only adhere to one of them when setting the default for the `%%cython`-magic, and both values have their justification. For use with code from the Sage library, it is desirable to enable it, but for use with external Cython code, this can be unexpected as it is not Cython's default.

One could argue that it is the responsibility of the user of the `%%cython`-magic to ensure that those compiler directives are set that are needed for the included code.

This also extends to other directives. For example, Sage is compiled with `language_level="3str"`, but the `%%cython`-magic sets it to `2` or `3` depending on the Python version. I think it is wrong to assume that including code from the Sage library will just work without adjusting this setting.

> I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.

Indeed, we could add all compiler directives to the top of every Cython file. I am not sure if this is desirable from a maintainability point of view, as this duplicates code in a lot of places. Though, at least this has the advantage that one cannot accidentally compile a file with the wrong semantics.

To be honest, I do not know what the best thing to do here is.



---

archive/issue_comments_408701.json:
```json
{
    "body": "I don't think we should add compiler directives to every cython file.\n\nAnyway, my \"fix\" is merely a suggestion. If you or anyone wants to go down a different road that's totally fine with me. Just add your own branch and remove me as author. That's totally fine with me.",
    "created_at": "2020-02-10T09:01:31Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408701",
    "user": "https://github.com/kliem"
}
```

I don't think we should add compiler directives to every cython file.

Anyway, my "fix" is merely a suggestion. If you or anyone wants to go down a different road that's totally fine with me. Just add your own branch and remove me as author. That's totally fine with me.



---

archive/issue_comments_408702.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-04-01T15:11:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408702",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_408703.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-01T15:14:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408703",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_408704.json:
```json
{
    "body": "I removed long or meaningless doctest and undid some changes.\n\nI checked that I added floor division only in files, where floor division was used at least once before. So I think those changes should be made in order to make those files consistent.\n\n(I just wrote some code, where I needed `bitset.pxi` and it is annoying that you cannot include it unless you set `# cython: cdivion=True`, which creates other problems.)",
    "created_at": "2020-04-01T15:20:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408704",
    "user": "https://github.com/kliem"
}
```

I removed long or meaningless doctest and undid some changes.

I checked that I added floor division only in files, where floor division was used at least once before. So I think those changes should be made in order to make those files consistent.

(I just wrote some code, where I needed `bitset.pxi` and it is annoying that you cannot include it unless you set `# cython: cdivion=True`, which creates other problems.)



---

archive/issue_comments_408705.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-04-01T20:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408705",
    "user": "https://github.com/mwageringel"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_408706.json:
```json
{
    "body": "Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.\n\nReplacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.",
    "created_at": "2020-04-01T20:19:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408706",
    "user": "https://github.com/mwageringel"
}
```

Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.

Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.



---

archive/issue_comments_408707.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-02T07:09:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408707",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_408708.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-04-02T07:12:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408708",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_408709.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2020-04-02T07:13:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408709",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_408710.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-04-02T07:13:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408710",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_408711.json:
```json
{
    "body": "Thanks. I finally understood the problem, I think.\n\nIn bitset.pxi this change is certainly justified as there is a check that `not size <= 0` just before that. Other than that there is only floor division in `bitset.pxi` (and given the nature of that file, it's not surprising). So this can be included no matter whether `cdivision` is set true or not. `binary_matrix.pxi` doesn't do any division and just includes `bitset.pxi`.\n\n`point_c.pxi` does exactly one division and that is of floats.\n\n`algebra_elements.pxi` does exactly one floor division.\n\nReplying to [comment:18 gh-mwageringel]:\n> Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.\n> \n> Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.",
    "created_at": "2020-04-02T07:20:46Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408711",
    "user": "https://github.com/kliem"
}
```

Thanks. I finally understood the problem, I think.

In bitset.pxi this change is certainly justified as there is a check that `not size <= 0` just before that. Other than that there is only floor division in `bitset.pxi` (and given the nature of that file, it's not surprising). So this can be included no matter whether `cdivision` is set true or not. `binary_matrix.pxi` doesn't do any division and just includes `bitset.pxi`.

`point_c.pxi` does exactly one division and that is of floats.

`algebra_elements.pxi` does exactly one floor division.

Replying to [comment:18 gh-mwageringel]:
> Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.
> 
> Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.



---

archive/issue_comments_408712.json:
```json
{
    "body": "Sorry if this was not very clear before. This is the effect of `cdivision` on the division operations of integers:\n\n| cdivision     | False         | True                            |\n|:---------------:|:---------------:|:---------------------------------:|\n| `/`           | true division   |  truncating division towards 0    |\n| `//`          | floor division  |  truncating division towards 0    |\nSince sagelib is compiled with `cdivision=True`, the `//` operator is a priori different from floor division (which would be used by the cython magic).\n\nPersonally, I do not feel comfortable with giving this a positive review as compiling a file with two different `cdivision` directives does not make sense to me. If anyone else wants to review this though, please go ahead.",
    "created_at": "2020-04-03T19:08:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408712",
    "user": "https://github.com/mwageringel"
}
```

Sorry if this was not very clear before. This is the effect of `cdivision` on the division operations of integers:

| cdivision     | False         | True                            |
|:---------------:|:---------------:|:---------------------------------:|
| `/`           | true division   |  truncating division towards 0    |
| `//`          | floor division  |  truncating division towards 0    |
Since sagelib is compiled with `cdivision=True`, the `//` operator is a priori different from floor division (which would be used by the cython magic).

Personally, I do not feel comfortable with giving this a positive review as compiling a file with two different `cdivision` directives does not make sense to me. If anyone else wants to review this though, please go ahead.



---

archive/issue_comments_408713.json:
```json
{
    "body": "Thanks for the comment.\n\nHowever, the problem is not clear to me. (I'm totally fine with removing any tests from the ticket.)\n\nAt least in `bitset.pxi` there is only division of positive integers and anything else doesn't make sense. So in this case `/` with `cdivivision=True` and `//` either way are the same, aren't they?\n\nThe other thing we could do is just leave a comment in the beginning of `bitset.pxi` that one should set `cdivision=True` in order to include this file.",
    "created_at": "2020-04-03T19:41:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408713",
    "user": "https://github.com/kliem"
}
```

Thanks for the comment.

However, the problem is not clear to me. (I'm totally fine with removing any tests from the ticket.)

At least in `bitset.pxi` there is only division of positive integers and anything else doesn't make sense. So in this case `/` with `cdivivision=True` and `//` either way are the same, aren't they?

The other thing we could do is just leave a comment in the beginning of `bitset.pxi` that one should set `cdivision=True` in order to include this file.



---

archive/issue_comments_408714.json:
```json
{
    "body": "The main question is: Should Sage support compiling its pxi files with both cdivision settings?\n\nIf yes, then your changes are needed. I think you are probably right in that `bitsets.pxi` only uses division on integers that are positive, so this could work. My main concern is that the tests cannot sufficiently check whether this works correctly, so even though this works today, it could easily break in the future without getting noticed. Still, the new tests are better than nothing, so I would keep them in this case.\n\nIf no, then it is not necessary to replace `/` by `//` as they behave the same. In fact, I would argue it is better to keep the `/` in this case because the compile time error, when using the wrong cdivision setting, is a prominent indication that one's compilation setup needs adjusting.\n\nPreviously, I assumed that including the cython directive at the top the file could be used to enforce the correct setting, but I have just tried it and it does not seem to work for pxi files.",
    "created_at": "2020-04-04T11:16:30Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408714",
    "user": "https://github.com/mwageringel"
}
```

The main question is: Should Sage support compiling its pxi files with both cdivision settings?

If yes, then your changes are needed. I think you are probably right in that `bitsets.pxi` only uses division on integers that are positive, so this could work. My main concern is that the tests cannot sufficiently check whether this works correctly, so even though this works today, it could easily break in the future without getting noticed. Still, the new tests are better than nothing, so I would keep them in this case.

If no, then it is not necessary to replace `/` by `//` as they behave the same. In fact, I would argue it is better to keep the `/` in this case because the compile time error, when using the wrong cdivision setting, is a prominent indication that one's compilation setup needs adjusting.

Previously, I assumed that including the cython directive at the top the file could be used to enforce the correct setting, but I have just tried it and it does not seem to work for pxi files.



---

archive/issue_comments_408715.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2020-04-04T12:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408715",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_408716.json:
```json
{
    "body": "I'm seeing the advantage of the solution you suggested in comment 11.\n\nIf I load a file into sage, I want it to behave exactly like if it would have been compiled in sage from the start. At the moment this is not the case.\n\nHowever, we would probably have to post a thread on sage-devel to see if anyone speaks up against it.",
    "created_at": "2020-04-04T13:03:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408716",
    "user": "https://github.com/kliem"
}
```

I'm seeing the advantage of the solution you suggested in comment 11.

If I load a file into sage, I want it to behave exactly like if it would have been compiled in sage from the start. At the moment this is not the case.

However, we would probably have to post a thread on sage-devel to see if anyone speaks up against it.



---

archive/issue_comments_408717.json:
```json
{
    "body": "Yes, feel free to post about this on sage-devel.",
    "created_at": "2020-04-05T12:49:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408717",
    "user": "https://github.com/mwageringel"
}
```

Yes, feel free to post about this on sage-devel.



---

archive/issue_comments_408718.json:
```json
{
    "body": "Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.",
    "created_at": "2020-05-01T04:28:42Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408718",
    "user": "https://github.com/mkoeppe"
}
```

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.



---

archive/issue_comments_408719.json:
```json
{
    "body": "Have the open questions here been resolved?",
    "created_at": "2020-08-11T17:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408719",
    "user": "https://github.com/mkoeppe"
}
```

Have the open questions here been resolved?



---

archive/issue_comments_408720.json:
```json
{
    "body": "Changing status from needs_review to needs_info.",
    "created_at": "2020-08-11T20:41:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408720",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_review to needs_info.



---

archive/issue_comments_408721.json:
```json
{
    "body": "New commits:",
    "created_at": "2020-08-21T19:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408721",
    "user": "https://github.com/kliem"
}
```

New commits:



---

archive/issue_comments_408722.json:
```json
{
    "body": "Changing status from needs_info to needs_review.",
    "created_at": "2020-08-21T19:00:15Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408722",
    "user": "https://github.com/kliem"
}
```

Changing status from needs_info to needs_review.



---

archive/issue_comments_408723.json:
```json
{
    "body": "Could you make the new doctest self-contained, in the sense that it has the correct cimports etc\n(I suppose it passes as a doctest due to previous calls to `cython()`)\n\n```\nsage: cython(''' \n....: cdef size_t foo = 3/2 \n....: ''') \n---------------------------------------------------------------------------\nCompileError                              Traceback (most recent call last)\n...\nRuntimeError: Error compiling Cython file:\n------------------------------------------------------------\n...\n\ncdef size_t foo = Integer(3)/Integer(2)\n                 ^\n------------------------------------------------------------\n\n_home_dima__sage_temp_hilbert_8791_tmp_xcshejsd_pyx_0.pyx:2:18: undeclared name not builtin: Integer\n```\n",
    "created_at": "2020-08-22T11:40:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408723",
    "user": "https://github.com/dimpase"
}
```

Could you make the new doctest self-contained, in the sense that it has the correct cimports etc
(I suppose it passes as a doctest due to previous calls to `cython()`)

```
sage: cython(''' 
....: cdef size_t foo = 3/2 
....: ''') 
---------------------------------------------------------------------------
CompileError                              Traceback (most recent call last)
...
RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...

cdef size_t foo = Integer(3)/Integer(2)
                 ^
------------------------------------------------------------

_home_dima__sage_temp_hilbert_8791_tmp_xcshejsd_pyx_0.pyx:2:18: undeclared name not builtin: Integer
```




---

archive/issue_comments_408724.json:
```json
{
    "body": "i.e. please do\n\n```\nsage: cython(''' \n....: from sage.rings.integer cimport Integer \n....: cdef size_t foo = 3/2 \n....: ''')                                                                                                                           \n```\n",
    "created_at": "2020-08-22T11:54:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408724",
    "user": "https://github.com/dimpase"
}
```

i.e. please do

```
sage: cython(''' 
....: from sage.rings.integer cimport Integer 
....: cdef size_t foo = 3/2 
....: ''')                                                                                                                           
```




---

archive/issue_comments_408725.json:
```json
{
    "body": "This looks like #30417.\n\nThis shouldn't be parsed as `Integer(3)/Integer(2)`.",
    "created_at": "2020-08-22T12:59:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408725",
    "user": "https://github.com/kliem"
}
```

This looks like #30417.

This shouldn't be parsed as `Integer(3)/Integer(2)`.



---

archive/issue_comments_408726.json:
```json
{
    "body": "Imagine all your cython integers being parsed as sage integers. This would be awful.\n\nThe failure of #30417 only happens in the normal sage shell not during doctesting.",
    "created_at": "2020-08-22T13:07:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408726",
    "user": "https://github.com/kliem"
}
```

Imagine all your cython integers being parsed as sage integers. This would be awful.

The failure of #30417 only happens in the normal sage shell not during doctesting.



---

archive/issue_comments_408727.json:
```json
{
    "body": "OK, good point.",
    "created_at": "2020-08-22T14:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408727",
    "user": "https://github.com/dimpase"
}
```

OK, good point.



---

archive/issue_comments_408728.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2020-08-22T14:14:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408728",
    "user": "https://github.com/dimpase"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_408729.json:
```json
{
    "body": "Should I remove the dependency? Thinking about it, this ticket doesn't really depend on #30417, although you cannot reproduce the doctest yet in the interactive shell.",
    "created_at": "2020-08-22T16:03:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408729",
    "user": "https://github.com/kliem"
}
```

Should I remove the dependency? Thinking about it, this ticket doesn't really depend on #30417, although you cannot reproduce the doctest yet in the interactive shell.



---

archive/issue_comments_408730.json:
```json
{
    "body": "#30417 is a blocker, anyway, so it's OK to remove it from deps, regardless.",
    "created_at": "2020-08-22T19:39:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408730",
    "user": "https://github.com/dimpase"
}
```

#30417 is a blocker, anyway, so it's OK to remove it from deps, regardless.



---

archive/issue_events_026729.json:
```json
{
    "actor": "@vbraun",
    "created_at": "2020-08-26T21:17:47Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/28902#event-26729"
}
```



---

archive/issue_comments_408731.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2020-08-26T21:17:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/28902",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/28902#issuecomment-408731",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed
