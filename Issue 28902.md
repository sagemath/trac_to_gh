# Issue 28902: *.pxi files might not be Python3-ready

Issue created by migration from https://trac.sagemath.org/ticket/29139

Original creator: dimpase

Original creation time: 2020-02-02 11:49:37

CC:  chapoton

This manifests itself in `%%cython` magic, e.g.

```
sage: %%cython
....: include "sage/data_structures/bitset.pxi"
```

leads to 

```
RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...
    """
    if size <= 0:
        raise ValueError("bitset capacity must be greater than 0")

    bits.size = size
    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
                                                     ^
------------------------------------------------------------

/home/dimpase/sage-src/local/lib/python3.7/site-packages/sage/data_structures/bitset.pxi:84:54: Cannot assign type 'double' to 'mp_size_t'
...
```


this was reported on sage-support


---

Comment by dimpase created at 2020-02-02 19:33:24


```diff
--- a/src/sage/data_structures/bitset.pxi
+++ b/src/sage/data_structures/bitset.pxi
@@ -81,7 +81,7 @@ cdef inline bint bitset_init(bitset_t bits, mp_bitcnt_t size) except -1:
         raise ValueError("bitset capacity must be greater than 0")
 
     bits.size = size
-    bits.limbs = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
+    bits.limbs = (size - 1) // (8 * sizeof(mp_limb_t)) + 1
     bits.bits = <mp_limb_t*>check_calloc(bits.limbs, sizeof(mp_limb_t))
 
 cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:
@@ -96,7 +96,7 @@ cdef inline int bitset_realloc(bitset_t bits, mp_bitcnt_t size) except -1:
     if size <= 0:
         raise ValueError("bitset capacity must be greater than 0")
 
-    cdef mp_size_t limbs_new = (size - 1) / (8 * sizeof(mp_limb_t)) + 1
+    cdef mp_size_t limbs_new = (size - 1) // (8 * sizeof(mp_limb_t)) + 1
     bits.bits = <mp_limb_t*>check_reallocarray(bits.bits, limbs_new, sizeof(mp_limb_t))
     bits.size = size
     bits.limbs = limbs_new
```

allow the command in the ticket description to pass, and the tests still pass.


---

Comment by @kliem created at 2020-02-04 09:06:36

Changing status from new to needs_review.


---

Comment by @kliem created at 2020-02-04 09:06:36

Changing keywords from "" to "bitset, floor division".


---

Comment by @kliem created at 2020-02-04 09:06:36

Clearly, floor division was intended at that place.
----
New commits:


---

Comment by @kliem created at 2020-02-04 09:19:57

At least one more error with floor division.


---

Comment by @kliem created at 2020-02-04 09:19:57

Changing status from needs_review to needs_work.


---

Comment by dimpase created at 2020-02-04 10:00:21

Could you check (with %%cython magic) all the *.pxi files for this sort of problem?


---

Comment by @kliem created at 2020-02-04 10:04:37

Yes, I'm doing it right now.


---

Comment by @mwageringel created at 2020-02-04 17:26:21

Why does this happen? The variable `size` in the code has type `mp_bitcnt_t` which is a gmp typedef for `unsigned long`. The code thus only involves C types, so the `/`-division should return an integer. Changing this to `//`-division does not look like the correct solution to me, as it just cures a symptom.

The underlying problem might be in the `%%cython` magic itself.


---

Comment by dimpase created at 2020-02-04 17:38:14

The problem is in the magic, no question about it, as "normal", non-interactive, use of these files is indeed OK. I proposed here a "cheap" way of fixing the problem, by merely making the code Python3-compatible. 

Feel free to dig into `%%cython`.


---

Comment by git created at 2020-02-05 09:31:05

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-02-05 09:37:25

Changing status from needs_work to needs_review.


---

Comment by @kliem created at 2020-02-05 09:37:25

As mentioned, I found a few more instances.

I looked into all `.pxi` files. However the files with corresponding header are really hard to test, e.g.

`/matrix/matrix_modn_dense_template_header.pxi`
`/matrix/matrix_modn_dense_template.pxi`

It is assumed that the header is included into a `pxd` file and the other into the corresponding `pyx` file. So I guess it is really not meant to work with `%%cython`.

I got the test down to a few warnings but that was about it. Also it is annoying to search for the correct things to import first, as some of the `pxi` files assume lots of imports already.


---

Comment by @mwageringel created at 2020-02-05 22:15:53

The issue can be reproduced by cythonizing this file

```
# file division.pyx
cdef int a = -6
cdef int b = 5
cdef int c = 0
c = a / b
```

with this setup using `sage -python`:

```
from distutils.core import Extension
from Cython.Build import cythonize
ext = Extension("division", sources=["division.pyx"])
res = cythonize([ext], compiler_directives=dict(language_level=3))
```


The problem is a missing compiler directive `cdivision=True`, which enforces C semantics instead of Python semantics for division. The [Cython docs](https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives) say:

> cdivision (True / False)
>
> If set to False, Cython will adjust the remainder and quotient operators C types to match those of Python ints (which differ when the operands have opposite signs) and raise a ZeroDivisionError when the right operand is 0. This has up to a 35% speed penalty. If set to True, no checks are performed. See CEP 516. Default is False.

I am rather surprised that this does not mention anything about the division operator returning double instead of int with Python 3, so I can only assume that this tries to match Python 3 semantics now.

The directive is also set in `src/setup.py` for all of Sage, so I suggest to solve this by setting it in `sage.misc.cython` as well (and the other compiler directives might be worth checking, too):

```diff
--- a/src/sage/misc/cython.py
+++ b/src/sage/misc/cython.py
@@ -315,7 +315,8 @@ def cython(filename, verbose=0, compile_message=False,
                     libraries=standard_libs,
                     library_dirs=standard_libdirs)

-    directives = dict(language_level=sys.version_info[0])
+    directives = dict(language_level=sys.version_info[0],
+                      cdivision=True)

     try:
         # Change directories to target_dir so that Cython produces the correct
```


In the example above, the value of `c` changes from `-2` (Python floor) to `-1` (C truncation towards 0).

The compiler directive can also be set directly:

```
sage: %%cython
....: # cython: cdivision=True
....: include "sage/data_structures/bitset.pxi"
```



---

Comment by @kliem created at 2020-02-06 07:03:41

I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?

For a start, you could do the change proposed plus enable `cdivision_warnings` and see if all doctests still pass. Long term this might be desirable, but it seems like a lot of work to me. Note that python division is still available for python objects:


```
sage: cython('''
....: # cython: cdivision=True
....: def test(a,b): return a/b
....: ''')
sage: test(2,3)
2/3
```


I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.


---

Comment by @mwageringel created at 2020-02-07 22:33:24

Replying to [comment:12 gh-kliem]:
> I don't think we should set this for all of sage for the reason you mentioned. How can we assure that no one had the intention of using floor division instead of cdivision?

The directive is already enabled for all of Sage, so I was suggesting to do the same for the `%%cython`-magic, for compatibility with the Sage library. Of course, Sage's default (`cdivision=True`) is different from Cython's default. We can only adhere to one of them when setting the default for the `%%cython`-magic, and both values have their justification. For use with code from the Sage library, it is desirable to enable it, but for use with external Cython code, this can be unexpected as it is not Cython's default.

One could argue that it is the responsibility of the user of the `%%cython`-magic to ensure that those compiler directives are set that are needed for the included code.

This also extends to other directives. For example, Sage is compiled with `language_level="3str"`, but the `%%cython`-magic sets it to `2` or `3` depending on the Python version. I think it is wrong to assume that including code from the Sage library will just work without adjusting this setting.

> I think it is more reasonable to do this change to cython files manually with `# cython: cdivision=True` as mentioned above. This includes not doing this change to *.pxi files, as the compiler directive is just pasted as well when including the file.

Indeed, we could add all compiler directives to the top of every Cython file. I am not sure if this is desirable from a maintainability point of view, as this duplicates code in a lot of places. Though, at least this has the advantage that one cannot accidentally compile a file with the wrong semantics.

To be honest, I do not know what the best thing to do here is.


---

Comment by @kliem created at 2020-02-10 09:01:31

I don't think we should add compiler directives to every cython file.

Anyway, my "fix" is merely a suggestion. If you or anyone wants to go down a different road that's totally fine with me. Just add your own branch and remove me as author. That's totally fine with me.


---

Comment by @kliem created at 2020-04-01 15:11:48

New commits:


---

Comment by git created at 2020-04-01 15:14:56

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-04-01 15:20:21

I removed long or meaningless doctest and undid some changes.

I checked that I added floor division only in files, where floor division was used at least once before. So I think those changes should be made in order to make those files consistent.

(I just wrote some code, where I needed `bitset.pxi` and it is annoying that you cannot include it unless you set `# cython: cdivion=True`, which creates other problems.)


---

Comment by @mwageringel created at 2020-04-01 20:19:49

Changing status from needs_review to needs_info.


---

Comment by @mwageringel created at 2020-04-01 20:19:49

Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.

Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.


---

Comment by git created at 2020-04-02 07:09:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by git created at 2020-04-02 07:12:14

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by git created at 2020-04-02 07:13:12

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:


---

Comment by @kliem created at 2020-04-02 07:13:53

Changing status from needs_info to needs_review.


---

Comment by @kliem created at 2020-04-02 07:20:46

Thanks. I finally understood the problem, I think.

In bitset.pxi this change is certainly justified as there is a check that `not size <= 0` just before that. Other than that there is only floor division in `bitset.pxi` (and given the nature of that file, it's not surprising). So this can be included no matter whether `cdivision` is set true or not. `binary_matrix.pxi` doesn't do any division and just includes `bitset.pxi`.

`point_c.pxi` does exactly one division and that is of floats.

`algebra_elements.pxi` does exactly one floor division.

Replying to [comment:18 gh-mwageringel]:
> Adding doctests like these implies that the Cython code compiles the same regardless of whether `cdivision` is set or not, that is, division must never be done between integers of opposite signs. Unless we are absolutely certain this is the case, we should not add these tests to the documentation. If you really want these includes to work, adding the cython directive to the top of those files would be an option.
> 
> Replacing `/` by `//` in itself is fine as it does not affect Sage behavior at all, but one has to be aware that, when used with the `%%cython` magic, this potentially replaces compile time errors by silent errors at runtime, if there are divisions between integers of opposite signs.


---

Comment by @mwageringel created at 2020-04-03 19:08:20

Sorry if this was not very clear before. This is the effect of `cdivision` on the division operations of integers:

| cdivision     | False         | True                            |
|:---------------:|:---------------:|:---------------------------------:|
| `/`           | true division   |  truncating division towards 0    |
| `//`          | floor division  |  truncating division towards 0    |
Since sagelib is compiled with `cdivision=True`, the `//` operator is a priori different from floor division (which would be used by the cython magic).

Personally, I do not feel comfortable with giving this a positive review as compiling a file with two different `cdivision` directives does not make sense to me. If anyone else wants to review this though, please go ahead.


---

Comment by @kliem created at 2020-04-03 19:41:06

Thanks for the comment.

However, the problem is not clear to me. (I'm totally fine with removing any tests from the ticket.)

At least in `bitset.pxi` there is only division of positive integers and anything else doesn't make sense. So in this case `/` with `cdivivision=True` and `//` either way are the same, aren't they?

The other thing we could do is just leave a comment in the beginning of `bitset.pxi` that one should set `cdivision=True` in order to include this file.


---

Comment by @mwageringel created at 2020-04-04 11:16:30

The main question is: Should Sage support compiling its pxi files with both cdivision settings?

If yes, then your changes are needed. I think you are probably right in that `bitsets.pxi` only uses division on integers that are positive, so this could work. My main concern is that the tests cannot sufficiently check whether this works correctly, so even though this works today, it could easily break in the future without getting noticed. Still, the new tests are better than nothing, so I would keep them in this case.

If no, then it is not necessary to replace `/` by `//` as they behave the same. In fact, I would argue it is better to keep the `/` in this case because the compile time error, when using the wrong cdivision setting, is a prominent indication that one's compilation setup needs adjusting.

Previously, I assumed that including the cython directive at the top the file could be used to enforce the correct setting, but I have just tried it and it does not seem to work for pxi files.


---

Comment by git created at 2020-04-04 12:57:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @kliem created at 2020-04-04 13:03:20

I'm seeing the advantage of the solution you suggested in comment 11.

If I load a file into sage, I want it to behave exactly like if it would have been compiled in sage from the start. At the moment this is not the case.

However, we would probably have to post a thread on sage-devel to see if anyone speaks up against it.


---

Comment by @mwageringel created at 2020-04-05 12:49:11

Yes, feel free to post about this on sage-devel.


---

Comment by mkoeppe created at 2020-05-01 04:28:42

Moving tickets to milestone sage-9.2 based on a review of last modification date, branch status, and severity.


---

Comment by mkoeppe created at 2020-08-11 17:29:04

Have the open questions here been resolved?


---

Comment by @kliem created at 2020-08-11 20:41:39

Changing status from needs_review to needs_info.


---

Comment by @kliem created at 2020-08-21 19:00:15

New commits:


---

Comment by @kliem created at 2020-08-21 19:00:15

Changing status from needs_info to needs_review.


---

Comment by dimpase created at 2020-08-22 11:40:37

Could you make the new doctest self-contained, in the sense that it has the correct cimports etc
(I suppose it passes as a doctest due to previous calls to `cython()`)

```
sage: cython(''' 
....: cdef size_t foo = 3/2 
....: ''') 
---------------------------------------------------------------------------
CompileError                              Traceback (most recent call last)
...
RuntimeError: Error compiling Cython file:
------------------------------------------------------------
...

cdef size_t foo = Integer(3)/Integer(2)
                 ^
------------------------------------------------------------

_home_dima__sage_temp_hilbert_8791_tmp_xcshejsd_pyx_0.pyx:2:18: undeclared name not builtin: Integer
```



---

Comment by dimpase created at 2020-08-22 11:54:58

i.e. please do

```
sage: cython(''' 
....: from sage.rings.integer cimport Integer 
....: cdef size_t foo = 3/2 
....: ''')                                                                                                                           
```



---

Comment by @kliem created at 2020-08-22 12:59:45

This looks like #30417.

This shouldn't be parsed as `Integer(3)/Integer(2)`.


---

Comment by @kliem created at 2020-08-22 13:07:26

Imagine all your cython integers being parsed as sage integers. This would be awful.

The failure of #30417 only happens in the normal sage shell not during doctesting.


---

Comment by dimpase created at 2020-08-22 14:14:34

OK, good point.


---

Comment by dimpase created at 2020-08-22 14:14:34

Changing status from needs_review to positive_review.


---

Comment by @kliem created at 2020-08-22 16:03:41

Should I remove the dependency? Thinking about it, this ticket doesn't really depend on #30417, although you cannot reproduce the doctest yet in the interactive shell.


---

Comment by dimpase created at 2020-08-22 19:39:24

#30417 is a blocker, anyway, so it's OK to remove it from deps, regardless.


---

Comment by vbraun created at 2020-08-26 21:17:47

Resolution: fixed
