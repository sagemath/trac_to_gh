# Issue 26359: Replace expect r interface with rpy2

archive/issues_026359.json:
```json
{
    "body": "CC:  @kiwifb jdmeyer @embray\n\nUsing rpy2 instead of manually interacting with the r repl gives us many benefits, the biggest of which is that we don't have to maintain the details of the interface ourselves. This should solve the dputs issue in #25674 and make sage compatible with r 3.4.x as well as 3.5.x (not actually tested yet).\n\nThe interface currently still inherits from the Expect interface since untangling that seems non-trivial. It is a bit awkward to force rpy2's output into the output sage expects. That output also isn't documented (it seems like its basically \"whatever dput gave us\"). I've implemented conversions so that the doctests pass, but there are likely differences between the presentation of r objects that are not covered by the doctesting framework.\n\nIssue created by migration from https://trac.sagemath.org/ticket/26596\n\n",
    "created_at": "2018-10-29T23:25:13Z",
    "labels": [
        "packages: standard",
        "major",
        "enhancement"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-8.5",
    "title": "Replace expect r interface with rpy2",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/26359",
    "user": "@timokau"
}
```
CC:  @kiwifb jdmeyer @embray

Using rpy2 instead of manually interacting with the r repl gives us many benefits, the biggest of which is that we don't have to maintain the details of the interface ourselves. This should solve the dputs issue in #25674 and make sage compatible with r 3.4.x as well as 3.5.x (not actually tested yet).

The interface currently still inherits from the Expect interface since untangling that seems non-trivial. It is a bit awkward to force rpy2's output into the output sage expects. That output also isn't documented (it seems like its basically "whatever dput gave us"). I've implemented conversions so that the doctests pass, but there are likely differences between the presentation of r objects that are not covered by the doctesting framework.

Issue created by migration from https://trac.sagemath.org/ticket/26596





---

archive/issue_comments_371156.json:
```json
{
    "body": "New commits:",
    "created_at": "2018-10-29T23:27:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371156",
    "user": "@timokau"
}
```

New commits:



---

archive/issue_comments_371157.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-10-29T23:30:45Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371157",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_371158.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2018-11-01T20:28:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371158",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_371159.json:
```json
{
    "body": "All doctests pass now except a `Bad exit: 1` in `sage/combinat/tableau.py` that I can only reproduce when running the whole testsuite. I have no clue what may be causing this. As far as I can see, `tableau.py` doesn't use `r` in any way.\n\nImmediately before the exit the following tests (which are simply the last ones in the file) were run:\n\n\n```\nsage: [ T for T in IncreasingTableaux(3, (1,0,1)) ] ## line 9285 ##\n[[[1, 3], [3]]]\nsage: [ T for T in IncreasingTableaux(4, (1,0,1,1)) ] ## line 9287 ##\n[[[1, 3, 4], [3]],\n [[1, 3, 4], [4]],\n [[1, 3], [3, 4]],\n [[1, 3], [3], [4]],\n [[1, 4], [3], [4]]]\nsage: IT = IncreasingTableaux(4, (1,0,1,1)) ## line 9293 ##\nsage: IT[0].parent() is IT ## line 9294 ##\nTrue\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 9296 ##\n0\nsage: IT = IncreasingTableaux(4, (1,0,1,1)) ## line 9306 ##\nsage: all(it in IT for it in IT) ## line 9307 ##\nTrue\nsage: all(it in IT for it in IncreasingTableaux([2,2], (1,0,1,1))) ## line 9309 ##\nTrue\nsage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 9311 ##\n0\n```\n\n----\nNew commits:",
    "created_at": "2018-11-01T20:30:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371159",
    "user": "@timokau"
}
```

All doctests pass now except a `Bad exit: 1` in `sage/combinat/tableau.py` that I can only reproduce when running the whole testsuite. I have no clue what may be causing this. As far as I can see, `tableau.py` doesn't use `r` in any way.

Immediately before the exit the following tests (which are simply the last ones in the file) were run:


```
sage: [ T for T in IncreasingTableaux(3, (1,0,1)) ] ## line 9285 ##
[[[1, 3], [3]]]
sage: [ T for T in IncreasingTableaux(4, (1,0,1,1)) ] ## line 9287 ##
[[[1, 3, 4], [3]],
 [[1, 3, 4], [4]],
 [[1, 3], [3, 4]],
 [[1, 3], [3], [4]],
 [[1, 4], [3], [4]]]
sage: IT = IncreasingTableaux(4, (1,0,1,1)) ## line 9293 ##
sage: IT[0].parent() is IT ## line 9294 ##
True
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 9296 ##
0
sage: IT = IncreasingTableaux(4, (1,0,1,1)) ## line 9306 ##
sage: all(it in IT for it in IT) ## line 9307 ##
True
sage: all(it in IT for it in IncreasingTableaux([2,2], (1,0,1,1))) ## line 9309 ##
True
sage: sig_on_count() # check sig_on/off pairings (virtual doctest) ## line 9311 ##
0
```

----
New commits:



---

archive/issue_comments_371160.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-03T13:27:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371160",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371161.json:
```json
{
    "body": "I'm reasonably sure that this matches the old api now, I've compared the output of the available examples. Everything passes except the previously mentioned `tableau.py`. No idea about that.\n\nI would appreciate help debugging this and maybe some manual testing of the interface.",
    "created_at": "2018-11-03T13:29:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371161",
    "user": "@timokau"
}
```

I'm reasonably sure that this matches the old api now, I've compared the output of the available examples. Everything passes except the previously mentioned `tableau.py`. No idea about that.

I would appreciate help debugging this and maybe some manual testing of the interface.



---

archive/issue_comments_371162.json:
```json
{
    "body": "Okay I've figured out the `tableau.py` failure. It does reproduce when run individually after all, I just forgot to add the `--long` flag. Turns out it is caused by the `rpy2` imports taking up some memory. The test passes when using `--memlimit 3302` (2 megabytes over the default limit). Before my changes, it started failing with `3238` or less. So that's a 63MB increase.\n\nAny suggestions what to do about this? When and how are lazy imports used? I think `tableau.py` doesn't actually use `r.py` in any way.\n\nAlso we should improve error handling in case the memlimit is overstepped. Debugging this was not fun.",
    "created_at": "2018-11-04T22:06:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371162",
    "user": "@timokau"
}
```

Okay I've figured out the `tableau.py` failure. It does reproduce when run individually after all, I just forgot to add the `--long` flag. Turns out it is caused by the `rpy2` imports taking up some memory. The test passes when using `--memlimit 3302` (2 megabytes over the default limit). Before my changes, it started failing with `3238` or less. So that's a 63MB increase.

Any suggestions what to do about this? When and how are lazy imports used? I think `tableau.py` doesn't actually use `r.py` in any way.

Also we should improve error handling in case the memlimit is overstepped. Debugging this was not fun.



---

archive/issue_comments_371163.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-04T22:45:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371163",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371164.json:
```json
{
    "body": "Sorry for not making a better contribution to this thread but can you fix the English in the last commit\n\n```\n+    Simple numeric values are represented as vecotrs in R. So `1` would actually\n+    be an array of length 1. We convert all vectory of length 1 to simple values,\n+    weather or not they \"originally\" were simple values or not:\n```\n\n* line 1: vecotrs -> vectors\n* line 2: vectory -> vectors\n* line 3: weather -> whether",
    "created_at": "2018-11-04T22:53:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371164",
    "user": "@kiwifb"
}
```

Sorry for not making a better contribution to this thread but can you fix the English in the last commit

```
+    Simple numeric values are represented as vecotrs in R. So `1` would actually
+    be an array of length 1. We convert all vectory of length 1 to simple values,
+    weather or not they "originally" were simple values or not:
```

* line 1: vecotrs -> vectors
* line 2: vectory -> vectors
* line 3: weather -> whether



---

archive/issue_comments_371165.json:
```json
{
    "body": "Further from earlier commits\n\n```\n+    Set up a the converter used to convert from rpy2's\n+    representation of R objects to the one sage expects.\n```\n\nSet up a converter to go from rpy2's representation of R objects to the one sage expects.\n\n\n```\n+            # if not names are present, convert to a normal list or a single value\n```\n\nIf no names are present...",
    "created_at": "2018-11-04T23:03:09Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371165",
    "user": "@kiwifb"
}
```

Further from earlier commits

```
+    Set up a the converter used to convert from rpy2's
+    representation of R objects to the one sage expects.
```

Set up a converter to go from rpy2's representation of R objects to the one sage expects.


```
+            # if not names are present, convert to a normal list or a single value
```

If no names are present...



---

archive/issue_comments_371166.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-05T08:48:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371166",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371167.json:
```json
{
    "body": "Thanks for taking a look at it!",
    "created_at": "2018-11-05T08:49:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371167",
    "user": "@timokau"
}
```

Thanks for taking a look at it!



---

archive/issue_comments_371168.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-07T18:57:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371168",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371169.json:
```json
{
    "body": "I did some digging into the difference in precision. The difference is:\n\n\n```\nr('3 * 5.6').sage() # old interface\n16.8\nr('3 * 5.6').sage() # new interface\n16.799999999999997\n```\n\n\n\n```\nr('1/10.4').sage() # old interface\n0.09615384615384615\nr('1/10.4').sage() # new interface\n0.0961538461538461\n```\n\n\nThe first case seems problematic, but doesn't appear to occur very often. The reason for this is that `dput` by default does some magic formatting. The precise internal value we get with the new interface (probably because rpy2 directly uses the c interface) is equivalent to setting the `digits17` option[0] in dput.\nI did some digging into R's source code to see what it does when `digits17` is not set. Confusingly, in the C code that actually implements `dput`, the option is now called `DIGITS16`[1] (probably legacy reasons). If that is not set, it calls some `EncodeElement` which in turn[2] calls `formatReal`. I didn't find the source code for that.\n\nSo in conclusion since this is not a clear regression (more precision, sometimes genuine precision and sometimes rounding glitches) and I don't see an easy way to change it I think it is fine as-is.\n\n\n[0] https://rdrr.io/r/base/deparseOpts.html\n[1] https://github.com/wch/r-source/blob/trunk/src/main/deparse.c#L1743\n[2] https://github.com/wch/r-source/blob/trunk/src/main/printutils.c#L805",
    "created_at": "2018-11-07T20:45:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371169",
    "user": "@timokau"
}
```

I did some digging into the difference in precision. The difference is:


```
r('3 * 5.6').sage() # old interface
16.8
r('3 * 5.6').sage() # new interface
16.799999999999997
```



```
r('1/10.4').sage() # old interface
0.09615384615384615
r('1/10.4').sage() # new interface
0.0961538461538461
```


The first case seems problematic, but doesn't appear to occur very often. The reason for this is that `dput` by default does some magic formatting. The precise internal value we get with the new interface (probably because rpy2 directly uses the c interface) is equivalent to setting the `digits17` option[0] in dput.
I did some digging into R's source code to see what it does when `digits17` is not set. Confusingly, in the C code that actually implements `dput`, the option is now called `DIGITS16`[1] (probably legacy reasons). If that is not set, it calls some `EncodeElement` which in turn[2] calls `formatReal`. I didn't find the source code for that.

So in conclusion since this is not a clear regression (more precision, sometimes genuine precision and sometimes rounding glitches) and I don't see an easy way to change it I think it is fine as-is.


[0] https://rdrr.io/r/base/deparseOpts.html
[1] https://github.com/wch/r-source/blob/trunk/src/main/deparse.c#L1743
[2] https://github.com/wch/r-source/blob/trunk/src/main/printutils.c#L805



---

archive/issue_comments_371170.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-08T11:41:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371170",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371171.json:
```json
{
    "body": "Erik, since you relatively recently did #25907 do you have an idea about the memory issue described [comment:8 here]?\n\nOther than that, I'm now happy with this. I'll post an overview of the changes when [comment:8] is resolved.",
    "created_at": "2018-11-08T11:43:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371171",
    "user": "@timokau"
}
```

Erik, since you relatively recently did #25907 do you have an idea about the memory issue described [comment:8 here]?

Other than that, I'm now happy with this. I'll post an overview of the changes when [comment:8] is resolved.



---

archive/issue_comments_371172.json:
```json
{
    "body": "I can't imagine why merely importing rpy2 would cause such a large memory allocation.  That does not seem right.  Are you sure there isn't something more to it?",
    "created_at": "2018-11-08T13:18:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371172",
    "user": "@embray"
}
```

I can't imagine why merely importing rpy2 would cause such a large memory allocation.  That does not seem right.  Are you sure there isn't something more to it?



---

archive/issue_comments_371173.json:
```json
{
    "body": "Relatedly, I don't know why you made this change:\n\n\n```diff\ndiff --git a/src/sage/doctest/test.py b/src/sage/doctest/test.py\nindex 2f4f74c..c6c1bf9 100644\n--- a/src/sage/doctest/test.py\n+++ b/src/sage/doctest/test.py\n@@ -500,12 +500,13 @@ Test ``atexit`` support in the doctesting framework::\n     ....:     pass\n \n Test the ``--memlimit`` option and ``# optional - memlimit``\n-(but only on Linux)::\n+(but only on Linux). If this test fails, the memory needed to\n+run it may have increased. Try increasing the limit. ::\n \n     sage: from platform import system\n     sage: ok = True\n     sage: if system() == \"Linux\":\n-    ....:     P = subprocess.Popen([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--memlimit=2000\", \"memlimit.rst\"], stdout=subprocess.PIPE, **kwds)\n+    ....:     P = subprocess.Popen([\"sage\", \"-t\", \"--warn-long\", \"0\", \"--memlimit=2100\", \"memlimit.rst\"], stdout=subprocess.PIPE, **kwds)\n     ....:     out, err = P.communicate()\n     ....:     ok = (\"MemoryError: failed to allocate\" in out)\n     sage: ok or out\n```\n",
    "created_at": "2018-11-08T13:21:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371173",
    "user": "@embray"
}
```

Relatedly, I don't know why you made this change:


```diff
diff --git a/src/sage/doctest/test.py b/src/sage/doctest/test.py
index 2f4f74c..c6c1bf9 100644
--- a/src/sage/doctest/test.py
+++ b/src/sage/doctest/test.py
@@ -500,12 +500,13 @@ Test ``atexit`` support in the doctesting framework::
     ....:     pass
 
 Test the ``--memlimit`` option and ``# optional - memlimit``
-(but only on Linux)::
+(but only on Linux). If this test fails, the memory needed to
+run it may have increased. Try increasing the limit. ::
 
     sage: from platform import system
     sage: ok = True
     sage: if system() == "Linux":
-    ....:     P = subprocess.Popen(["sage", "-t", "--warn-long", "0", "--memlimit=2000", "memlimit.rst"], stdout=subprocess.PIPE, **kwds)
+    ....:     P = subprocess.Popen(["sage", "-t", "--warn-long", "0", "--memlimit=2100", "memlimit.rst"], stdout=subprocess.PIPE, **kwds)
     ....:     out, err = P.communicate()
     ....:     ok = ("MemoryError: failed to allocate" in out)
     sage: ok or out
```




---

archive/issue_comments_371174.json:
```json
{
    "body": "Replying to [comment:18 embray]:\n> I can't imagine why merely importing rpy2 would cause such a large memory allocation.  That does not seem right.  Are you sure there isn't something more to it?\n\nPretty sure. I removed all the changes except the import statements and it still failed.\n\nAnother change is that R is now always initialized (by setting its options) at startup (when `r = R()`) is assigned. I temporarily implemented some lazy initialization to try to work around it, but that didn't fix it either.\n\n\nThe other change is for the same reason, more memory required and the 2G limit is pretty tight.",
    "created_at": "2018-11-08T15:21:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371174",
    "user": "@timokau"
}
```

Replying to [comment:18 embray]:
> I can't imagine why merely importing rpy2 would cause such a large memory allocation.  That does not seem right.  Are you sure there isn't something more to it?

Pretty sure. I removed all the changes except the import statements and it still failed.

Another change is that R is now always initialized (by setting its options) at startup (when `r = R()`) is assigned. I temporarily implemented some lazy initialization to try to work around it, but that didn't fix it either.


The other change is for the same reason, more memory required and the 2G limit is pretty tight.



---

archive/issue_comments_371175.json:
```json
{
    "body": "When testing this on-distro with R 3.5 I encountered an interesting error:\n\n\n```\nmatrix(CDF, 0, 0).is_unitary(algorithm=\"orthonormal\")\n```\n\n\nwould segfault with `RRuntimeWarning: Error: BLAS/LAPACK routine 'ZGEES ' gave error code -6`. The `from rpy2 import robjects` line is the \"cause\" for this. That only happened when running the testsuite on-distro, not on sage-the-distro. However I reduced it to this:\n\n\n```\nfrom rpy2 import robjects; import scipy.linalg; import numpy as np; scipy.linalg.schur(np.empty(shape=[0,0]))\n```\n\n\nWhich will segfault sage-the-distro (or just `./sage -python` as well. I'll try it with the latest openblas master. Wondering how the rpy import may cause this. Maybe it always segfaults and rpy somehow hijacks error handling or something?",
    "created_at": "2018-11-09T22:31:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371175",
    "user": "@timokau"
}
```

When testing this on-distro with R 3.5 I encountered an interesting error:


```
matrix(CDF, 0, 0).is_unitary(algorithm="orthonormal")
```


would segfault with `RRuntimeWarning: Error: BLAS/LAPACK routine 'ZGEES ' gave error code -6`. The `from rpy2 import robjects` line is the "cause" for this. That only happened when running the testsuite on-distro, not on sage-the-distro. However I reduced it to this:


```
from rpy2 import robjects; import scipy.linalg; import numpy as np; scipy.linalg.schur(np.empty(shape=[0,0]))
```


Which will segfault sage-the-distro (or just `./sage -python` as well. I'll try it with the latest openblas master. Wondering how the rpy import may cause this. Maybe it always segfaults and rpy somehow hijacks error handling or something?



---

archive/issue_comments_371176.json:
```json
{
    "body": "Segfaults on archlinux with python2 or python3 as well.",
    "created_at": "2018-11-09T22:39:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371176",
    "user": "@timokau"
}
```

Segfaults on archlinux with python2 or python3 as well.



---

archive/issue_comments_371177.json:
```json
{
    "body": "I don't have the segfault (although I haven't tested the ticket yet) but we had an interesting discussion about a failing doctest that is extremely similar. https://github.com/cschwan/sage-on-gentoo/commit/1a5fefec74c222ee5d0673bb439c6d5a3b0c6e1e#commitcomment-30999803\n\ntl;dr \n\nThere is a subtle difference of behavior in xerblas as shipped by openblas (as a part of blas)  and netlib's lapack function of the same name (shipped as part of lapack). If you ship an integrated openblas with lapack included you get the base blas function from openblas (that's the one vanilla sage sees). If you have a separate lapack based on netlib you get to load netlib's xerblas first. You may find that if you preload openblas first the problem may go away.",
    "created_at": "2018-11-09T23:43:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371177",
    "user": "@kiwifb"
}
```

I don't have the segfault (although I haven't tested the ticket yet) but we had an interesting discussion about a failing doctest that is extremely similar. https://github.com/cschwan/sage-on-gentoo/commit/1a5fefec74c222ee5d0673bb439c6d5a3b0c6e1e#commitcomment-30999803

tl;dr 

There is a subtle difference of behavior in xerblas as shipped by openblas (as a part of blas)  and netlib's lapack function of the same name (shipped as part of lapack). If you ship an integrated openblas with lapack included you get the base blas function from openblas (that's the one vanilla sage sees). If you have a separate lapack based on netlib you get to load netlib's xerblas first. You may find that if you preload openblas first the problem may go away.



---

archive/issue_comments_371178.json:
```json
{
    "body": "Thank you! Saved me a lot of time. `LD_PRELOAD`'ing openblas does fix the segfault. I have no idea what blas library it is picking up instead though. Shouldn't be anything available except linbox maybe. `strace` shows access to the same so files (with `blas` or `lapack` in their name) before and after adding rpy. linbox doesn't seem to be used.\n\nYou're not getting the segfault in plain python either?",
    "created_at": "2018-11-10T11:56:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371178",
    "user": "@timokau"
}
```

Thank you! Saved me a lot of time. `LD_PRELOAD`'ing openblas does fix the segfault. I have no idea what blas library it is picking up instead though. Shouldn't be anything available except linbox maybe. `strace` shows access to the same so files (with `blas` or `lapack` in their name) before and after adding rpy. linbox doesn't seem to be used.

You're not getting the segfault in plain python either?



---

archive/issue_comments_371179.json:
```json
{
    "body": "With `LD_PRELOAD` and a slightly increased `--memlimit` for tests, all doctests pass with R 3.5 as well as 3.4.",
    "created_at": "2018-11-10T15:46:34Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371179",
    "user": "@timokau"
}
```

With `LD_PRELOAD` and a slightly increased `--memlimit` for tests, all doctests pass with R 3.5 as well as 3.4.



---

archive/issue_comments_371180.json:
```json
{
    "body": "Replying to [comment:24 gh-timokau]:\n> Thank you! Saved me a lot of time. `LD_PRELOAD`'ing openblas does fix the segfault. I have no idea what blas library it is picking up instead though. Shouldn't be anything available except linbox maybe. `strace` shows access to the same so files (with `blas` or `lapack` in their name) before and after adding rpy. linbox doesn't seem to be used.\n> \n> You're not getting the segfault in plain python either?\n\nOn your distro I am guessing you have distinct libraries for blas and lapack - vanilla sage just has a combined blas/cblas/lapack in a single library. The issue here is that both your blas and lapack libraries have a `xerbla_` symbol. If lapack is loaded first (and where you use lapack it usually will be) you'll use lapack version.\n\nSo here there is a subtle difference of behavior between `xerbla` implemented by openblas and netlib. And honestly I don't know which one is actually buggy or which one is not conforming. Netlib is supposed to be the reference but it is the one leading to a crash.",
    "created_at": "2018-11-11T21:05:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371180",
    "user": "@kiwifb"
}
```

Replying to [comment:24 gh-timokau]:
> Thank you! Saved me a lot of time. `LD_PRELOAD`'ing openblas does fix the segfault. I have no idea what blas library it is picking up instead though. Shouldn't be anything available except linbox maybe. `strace` shows access to the same so files (with `blas` or `lapack` in their name) before and after adding rpy. linbox doesn't seem to be used.
> 
> You're not getting the segfault in plain python either?

On your distro I am guessing you have distinct libraries for blas and lapack - vanilla sage just has a combined blas/cblas/lapack in a single library. The issue here is that both your blas and lapack libraries have a `xerbla_` symbol. If lapack is loaded first (and where you use lapack it usually will be) you'll use lapack version.

So here there is a subtle difference of behavior between `xerbla` implemented by openblas and netlib. And honestly I don't know which one is actually buggy or which one is not conforming. Netlib is supposed to be the reference but it is the one leading to a crash.



---

archive/issue_comments_371181.json:
```json
{
    "body": "As for crash with plain python\n\n```\nPython 2.7.15 (default, Sep 13 2018, 20:02:33) \n[GCC 8.2.0] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import numpy as np\n>>> import scipy.linalg\n>>> scipy.linalg.schur(np.empty(shape=[0,0]))\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/usr/lib64/python2.7/site-packages/scipy/linalg/decomp_schur.py\", line 139, in schur\n    result = gees(lambda x: None, a1, lwork=-1)\nValueError: On entry to DGEES parameter number 6 had an illegal value\n```\n\nIn the case of the crash you reproduce with \"sage-the-distro\" it would be interesting to check which blas/lapack R is linked too. If R is external you may have loaded blas/lapack external to sage-the-distro.",
    "created_at": "2018-11-11T21:10:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371181",
    "user": "@kiwifb"
}
```

As for crash with plain python

```
Python 2.7.15 (default, Sep 13 2018, 20:02:33) 
[GCC 8.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import numpy as np
>>> import scipy.linalg
>>> scipy.linalg.schur(np.empty(shape=[0,0]))
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/lib64/python2.7/site-packages/scipy/linalg/decomp_schur.py", line 139, in schur
    result = gees(lambda x: None, a1, lwork=-1)
ValueError: On entry to DGEES parameter number 6 had an illegal value
```

In the case of the crash you reproduce with "sage-the-distro" it would be interesting to check which blas/lapack R is linked too. If R is external you may have loaded blas/lapack external to sage-the-distro.



---

archive/issue_comments_371182.json:
```json
{
    "body": "Replying to [comment:26 fbissey]:\n> Replying to [comment:24 gh-timokau]:\n> > Thank you! Saved me a lot of time. `LD_PRELOAD`'ing openblas does fix the segfault. I have no idea what blas library it is picking up instead though. Shouldn't be anything available except linbox maybe. `strace` shows access to the same so files (with `blas` or `lapack` in their name) before and after adding rpy. linbox doesn't seem to be used.\n> > \n> > You're not getting the segfault in plain python either?\n> \n> On your distro I am guessing you have distinct libraries for blas and lapack - vanilla sage just has a combined blas/cblas/lapack in a single library. The issue here is that both your blas and lapack libraries have a `xerbla_` symbol. If lapack is loaded first (and where you use lapack it usually will be) you'll use lapack version.\n\nNo my distro uses `openblas` as lapack and blas. I've reported this upstream ([scipy](https://github.com/scipy/scipy/issues/9466), [rpy2](https://bitbucket.org/rpy2/rpy2/issues/491/importing-rpy2-before-scipy-leads-to). In the `rpy2` ticket there are some library traces, showing that only openblas is used on nixos. ArchLinux uses different libraries but the crash still occurs.",
    "created_at": "2018-11-11T21:24:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371182",
    "user": "@timokau"
}
```

Replying to [comment:26 fbissey]:
> Replying to [comment:24 gh-timokau]:
> > Thank you! Saved me a lot of time. `LD_PRELOAD`'ing openblas does fix the segfault. I have no idea what blas library it is picking up instead though. Shouldn't be anything available except linbox maybe. `strace` shows access to the same so files (with `blas` or `lapack` in their name) before and after adding rpy. linbox doesn't seem to be used.
> > 
> > You're not getting the segfault in plain python either?
> 
> On your distro I am guessing you have distinct libraries for blas and lapack - vanilla sage just has a combined blas/cblas/lapack in a single library. The issue here is that both your blas and lapack libraries have a `xerbla_` symbol. If lapack is loaded first (and where you use lapack it usually will be) you'll use lapack version.

No my distro uses `openblas` as lapack and blas. I've reported this upstream ([scipy](https://github.com/scipy/scipy/issues/9466), [rpy2](https://bitbucket.org/rpy2/rpy2/issues/491/importing-rpy2-before-scipy-leads-to). In the `rpy2` ticket there are some library traces, showing that only openblas is used on nixos. ArchLinux uses different libraries but the crash still occurs.



---

archive/issue_comments_371183.json:
```json
{
    "body": "Replying to [comment:27 fbissey]:\n> As for crash with plain python\n> {{{\n> Python 2.7.15 (default, Sep 13 2018, 20:02:33) \n> [GCC 8.2.0] on linux2\n> Type \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n> >>> import numpy as np\n> >>> import scipy.linalg\n> >>> scipy.linalg.schur(np.empty(shape=[0,0]))\n> Traceback (most recent call last):\n>   File \"<stdin>\", line 1, in <module>\n>   File \"/usr/lib64/python2.7/site-packages/scipy/linalg/decomp_schur.py\", line 139, in schur\n>     result = gees(lambda x: None, a1, lwork=-1)\n> ValueError: On entry to DGEES parameter number 6 had an illegal value\n> }}}\n> In the case of the crash you reproduce with \"sage-the-distro\" it would be interesting to check which blas/lapack R is linked too. If R is external you may have loaded blas/lapack external to sage-the-distro.\n\nI get the same if I do that, but what happens if you do `import rpy2.robjects` first?",
    "created_at": "2018-11-11T21:25:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371183",
    "user": "@timokau"
}
```

Replying to [comment:27 fbissey]:
> As for crash with plain python
> {{{
> Python 2.7.15 (default, Sep 13 2018, 20:02:33) 
> [GCC 8.2.0] on linux2
> Type "help", "copyright", "credits" or "license" for more information.
> >>> import numpy as np
> >>> import scipy.linalg
> >>> scipy.linalg.schur(np.empty(shape=[0,0]))
> Traceback (most recent call last):
>   File "<stdin>", line 1, in <module>
>   File "/usr/lib64/python2.7/site-packages/scipy/linalg/decomp_schur.py", line 139, in schur
>     result = gees(lambda x: None, a1, lwork=-1)
> ValueError: On entry to DGEES parameter number 6 had an illegal value
> }}}
> In the case of the crash you reproduce with "sage-the-distro" it would be interesting to check which blas/lapack R is linked too. If R is external you may have loaded blas/lapack external to sage-the-distro.

I get the same if I do that, but what happens if you do `import rpy2.robjects` first?



---

archive/issue_comments_371184.json:
```json
{
    "body": "sage's python and then system python\n\n```\nfbissey@moonloop ~/sandbox/git-fork/sage $ ./sage -python\nPython 2.7.15 (default, Oct 30 2018, 11:04:09) \n[GCC 8.2.0] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from rpy2 import robjects; import scipy.linalg; import numpy as np; scipy.linalg.schur(np.empty(shape=[0,0]))\n/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/rpy2/rinterface/__init__.py:185: RRuntimeWarning: Error: BLAS/LAPACK routine 'DGEES ' gave error code -6\n\n  warnings.warn(x, RRuntimeWarning)\n/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/rpy2/rinterface/__init__.py:185: RRuntimeWarning: Fatal error: unable to initialize the JIT\n\n\n  warnings.warn(x, RRuntimeWarning)\nSegmentation fault (core dumped)\nfbissey@moonloop ~/sandbox/git-fork/sage $ python\nPython 2.7.15 (default, Sep 13 2018, 20:02:33) \n[GCC 8.2.0] on linux2\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> from rpy2 import robjects; import scipy.linalg; import numpy as np; scipy.linalg.schur(np.empty(shape=[0,0]))\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\n  File \"/usr/lib64/python2.7/site-packages/scipy/linalg/decomp_schur.py\", line 139, in schur\n    result = gees(lambda x: None, a1, lwork=-1)\nValueError: On entry to DGEES parameter number 6 had an illegal value\n```\n",
    "created_at": "2018-11-11T21:27:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371184",
    "user": "@kiwifb"
}
```

sage's python and then system python

```
fbissey@moonloop ~/sandbox/git-fork/sage $ ./sage -python
Python 2.7.15 (default, Oct 30 2018, 11:04:09) 
[GCC 8.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from rpy2 import robjects; import scipy.linalg; import numpy as np; scipy.linalg.schur(np.empty(shape=[0,0]))
/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/rpy2/rinterface/__init__.py:185: RRuntimeWarning: Error: BLAS/LAPACK routine 'DGEES ' gave error code -6

  warnings.warn(x, RRuntimeWarning)
/home/fbissey/sandbox/git-fork/sage/local/lib/python2.7/site-packages/rpy2/rinterface/__init__.py:185: RRuntimeWarning: Fatal error: unable to initialize the JIT


  warnings.warn(x, RRuntimeWarning)
Segmentation fault (core dumped)
fbissey@moonloop ~/sandbox/git-fork/sage $ python
Python 2.7.15 (default, Sep 13 2018, 20:02:33) 
[GCC 8.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from rpy2 import robjects; import scipy.linalg; import numpy as np; scipy.linalg.schur(np.empty(shape=[0,0]))
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/lib64/python2.7/site-packages/scipy/linalg/decomp_schur.py", line 139, in schur
    result = gees(lambda x: None, a1, lwork=-1)
ValueError: On entry to DGEES parameter number 6 had an illegal value
```




---

archive/issue_comments_371185.json:
```json
{
    "body": "So you do get it with sage-the-distribution. Very interesting that you don't get it with system python, at least that shows that its not a fundamental r/rpy problem but somehow has to do with the setup. What blas/lapack libs are used there?",
    "created_at": "2018-11-11T21:45:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371185",
    "user": "@timokau"
}
```

So you do get it with sage-the-distribution. Very interesting that you don't get it with system python, at least that shows that its not a fundamental r/rpy problem but somehow has to do with the setup. What blas/lapack libs are used there?



---

archive/issue_comments_371186.json:
```json
{
    "body": "On the system openblas-0.3.3 for blas/cblas + netlib lapack 3.8.0 as a separate library. Standard openblas-0.2.20.p2 spkg for sage-the-distro.",
    "created_at": "2018-11-11T21:48:03Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371186",
    "user": "@kiwifb"
}
```

On the system openblas-0.3.3 for blas/cblas + netlib lapack 3.8.0 as a separate library. Standard openblas-0.2.20.p2 spkg for sage-the-distro.



---

archive/issue_comments_371187.json:
```json
{
    "body": "I would still like to investigate this, but right now I'm working on the GAP 4.10 integration which I believe has higher priority.",
    "created_at": "2018-11-12T10:48:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371187",
    "user": "@embray"
}
```

I would still like to investigate this, but right now I'm working on the GAP 4.10 integration which I believe has higher priority.



---

archive/issue_comments_371188.json:
```json
{
    "body": "Alright. To be clear the segfault is only marginally related (somehow doesn't even happen during the sage-the-distro doctests although the minimal example does reproduce on sage-the-distro python). I think the RAM increase is just because `R` is now initialized at startup while it was initialized lazily before. 60MB doesn't seem that much. To avoid that, we'd need to lazily import `rpy2` on first use but that would be a bit error prone.\n\nBy the way if gap 4.10 is a priority because of the debian freeze, this would probably be one too. I'm guessing they're using R 3.5, so R integration on debian should (still guessing here) be broken right now.",
    "created_at": "2018-11-12T11:04:04Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371188",
    "user": "@timokau"
}
```

Alright. To be clear the segfault is only marginally related (somehow doesn't even happen during the sage-the-distro doctests although the minimal example does reproduce on sage-the-distro python). I think the RAM increase is just because `R` is now initialized at startup while it was initialized lazily before. 60MB doesn't seem that much. To avoid that, we'd need to lazily import `rpy2` on first use but that would be a bit error prone.

By the way if gap 4.10 is a priority because of the debian freeze, this would probably be one too. I'm guessing they're using R 3.5, so R integration on debian should (still guessing here) be broken right now.



---

archive/issue_comments_371189.json:
```json
{
    "body": "Discussion about the segfault is mostly going on [on the rpy2 issue tracker on bitbucket](https://bitbucket.org/rpy2/rpy2/issues/491/importing-rpy2-before-scipy-leads-to).",
    "created_at": "2018-11-12T11:04:53Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371189",
    "user": "@timokau"
}
```

Discussion about the segfault is mostly going on [on the rpy2 issue tracker on bitbucket](https://bitbucket.org/rpy2/rpy2/issues/491/importing-rpy2-before-scipy-leads-to).



---

archive/issue_comments_371190.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-21T17:38:50Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371190",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371191.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2018-11-21T17:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371191",
    "user": "@timokau"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_371192.json:
```json
{
    "body": "I implemented some lazyness (as it was effectively done in the old expect interface). This solves the memory issues and also \"fixes\" the import order issue as long as one assumes that some blas library will always be used/imported somehow before r is used. That assumption is probably not unreasonable.\n\nAll doctests pass in sage-the-distro as well as on-distro. This is ready for review. I hope we can get this in by the 2018-12-01 deadline so that distros can finally use sage with a recent R.",
    "created_at": "2018-11-21T17:41:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371192",
    "user": "@timokau"
}
```

I implemented some lazyness (as it was effectively done in the old expect interface). This solves the memory issues and also "fixes" the import order issue as long as one assumes that some blas library will always be used/imported somehow before r is used. That assumption is probably not unreasonable.

All doctests pass in sage-the-distro as well as on-distro. This is ready for review. I hope we can get this in by the 2018-12-01 deadline so that distros can finally use sage with a recent R.



---

archive/issue_comments_371193.json:
```json
{
    "body": "Some notes on the differences:\n\n- slight difference in precision in some cases (see [comment:15])\n- `r('NA').sage()` will now actually return `NA` (of type `rpy2.rinterface.NALogicalType`) as opposed to `None` (which it did before)\n- `r('NaN').sage()` will now return `nan`, while it threw a `NameError` before\n- same thing with `Inf`: name error before, correct behaviour now\n- same thing with imaginary numbers: parsing error before, correct behaviour now\n- errors were ignored before (because some faulty pattern matching) and are actually handled now\n \t- that led to the discovery and fix of a bug: `is_string` was not overriden in `RElement`. Because of that dumping strings didn't work properly. See commit d979fdf70da0476b648d2f703fa7bf00cb9e3d03 for details.\n\nSo this brings bugfixes, compatibility to R 3.4 *and* R 3.5 and less maintenance burdon.",
    "created_at": "2018-11-21T20:12:17Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371193",
    "user": "@timokau"
}
```

Some notes on the differences:

- slight difference in precision in some cases (see [comment:15])
- `r('NA').sage()` will now actually return `NA` (of type `rpy2.rinterface.NALogicalType`) as opposed to `None` (which it did before)
- `r('NaN').sage()` will now return `nan`, while it threw a `NameError` before
- same thing with `Inf`: name error before, correct behaviour now
- same thing with imaginary numbers: parsing error before, correct behaviour now
- errors were ignored before (because some faulty pattern matching) and are actually handled now
 	- that led to the discovery and fix of a bug: `is_string` was not overriden in `RElement`. Because of that dumping strings didn't work properly. See commit d979fdf70da0476b648d2f703fa7bf00cb9e3d03 for details.

So this brings bugfixes, compatibility to R 3.4 *and* R 3.5 and less maintenance burdon.



---

archive/issue_comments_371194.json:
```json
{
    "body": "The patchbot report some strange errors but that one seems relevant to this ticket\n\n```\nsage -t --long src/sage/interfaces/r.py\n**********************************************************************\nFile \"src/sage/interfaces/r.py\", line 1428, in sage.interfaces.r.RElement.tilde\nFailed example:\n    d['DATA']['coefficients']['DATA'][1]\nExpected:\n    2\nGot:\n    2.0000000000000004\n```\n\nCan you double check?",
    "created_at": "2018-11-21T20:22:10Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371194",
    "user": "@kiwifb"
}
```

The patchbot report some strange errors but that one seems relevant to this ticket

```
sage -t --long src/sage/interfaces/r.py
**********************************************************************
File "src/sage/interfaces/r.py", line 1428, in sage.interfaces.r.RElement.tilde
Failed example:
    d['DATA']['coefficients']['DATA'][1]
Expected:
    2
Got:
    2.0000000000000004
```

Can you double check?



---

archive/issue_comments_371195.json:
```json
{
    "body": "I cannot reproduce that locally, but that is probably a result of the precision difference described in [comment:15]. Basically `R` gives us its exact results and their precision is probably a bit platform dependent. Not sure how best to deal with this. Add `# abs tol` in a lot of places? Introduce some rounding?",
    "created_at": "2018-11-21T23:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371195",
    "user": "@timokau"
}
```

I cannot reproduce that locally, but that is probably a result of the precision difference described in [comment:15]. Basically `R` gives us its exact results and their precision is probably a bit platform dependent. Not sure how best to deal with this. Add `# abs tol` in a lot of places? Introduce some rounding?



---

archive/issue_comments_371196.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2018-11-21T23:01:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371196",
    "user": "@timokau"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_371197.json:
```json
{
    "body": "For that particular one I would go with `# abs tol` but I wouldn't only put it in in actual reported case or where you have prior knowledge it could happen. Bots are there to find that kind of stuff.",
    "created_at": "2018-11-21T23:04:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371197",
    "user": "@kiwifb"
}
```

For that particular one I would go with `# abs tol` but I wouldn't only put it in in actual reported case or where you have prior knowledge it could happen. Bots are there to find that kind of stuff.



---

archive/issue_comments_371198.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. New commits:",
    "created_at": "2018-11-22T12:58:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371198",
    "user": "git"
}
```

Branch pushed to git repo; I updated commit sha1. New commits:



---

archive/issue_comments_371199.json:
```json
{
    "body": "I looked into `dput`s behaviour again. Turns out it actually doesn't do anything smart by default. It just rounds the number to 15 significant places. Not sure why I thought it did something smarter than that.\n\nSo I've just implemented that. This was the old behaviour. It should smooth out platform-dependent differences. Now all the tested parts of the interface should behave exactly as before (except those that were buggy before).",
    "created_at": "2018-11-22T12:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371199",
    "user": "@timokau"
}
```

I looked into `dput`s behaviour again. Turns out it actually doesn't do anything smart by default. It just rounds the number to 15 significant places. Not sure why I thought it did something smarter than that.

So I've just implemented that. This was the old behaviour. It should smooth out platform-dependent differences. Now all the tested parts of the interface should behave exactly as before (except those that were buggy before).



---

archive/issue_comments_371200.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2018-11-22T12:58:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371200",
    "user": "@timokau"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_371201.json:
```json
{
    "body": "Patchbot says `All tests passed!`! There are some pyflakes warnings, but not all of them are actually related to this ticket and those that are have to do with pyflakes apparently being confused by `lazy_import`.",
    "created_at": "2018-11-22T15:51:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371201",
    "user": "@timokau"
}
```

Patchbot says `All tests passed!`! There are some pyflakes warnings, but not all of them are actually related to this ticket and those that are have to do with pyflakes apparently being confused by `lazy_import`.



---

archive/issue_comments_371202.json:
```json
{
    "body": "If the patchbot is happy, I am happy.",
    "created_at": "2018-11-22T17:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371202",
    "user": "@kiwifb"
}
```

If the patchbot is happy, I am happy.



---

archive/issue_comments_371203.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2018-11-22T17:55:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371203",
    "user": "@kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_comments_371204.json:
```json
{
    "body": "Great, thanks! I have rebased this patch on 8.4 for distro maintainers that need compatibility with R 3.5: https://gist.github.com/timokau/144262860a5d777fa1700d25344fc5f2",
    "created_at": "2018-11-22T18:29:19Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371204",
    "user": "@timokau"
}
```

Great, thanks! I have rebased this patch on 8.4 for distro maintainers that need compatibility with R 3.5: https://gist.github.com/timokau/144262860a5d777fa1700d25344fc5f2



---

archive/issue_comments_371205.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2018-11-23T21:41:56Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371205",
    "user": "@vbraun"
}
```

Resolution: fixed



---

archive/issue_comments_371206.json:
```json
{
    "body": "I still need to play around with this a bit more, but if I find any issues I'll add them in follow-ups.  This is already much, much better though +1",
    "created_at": "2018-11-28T08:10:38Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371206",
    "user": "@embray"
}
```

I still need to play around with this a bit more, but if I find any issues I'll add them in follow-ups.  This is already much, much better though +1



---

archive/issue_comments_371207.json:
```json
{
    "body": "Thanks :) I just successfully built and tested 8.5.beta5 with R 3.5.",
    "created_at": "2018-11-28T10:05:35Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371207",
    "user": "@timokau"
}
```

Thanks :) I just successfully built and tested 8.5.beta5 with R 3.5.



---

archive/issue_comments_371208.json:
```json
{
    "body": "what is required from an installation of R do be used in Sage? executables+headers? something else?",
    "created_at": "2018-12-02T12:22:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371208",
    "user": "@dimpase"
}
```

what is required from an installation of R do be used in Sage? executables+headers? something else?



---

archive/issue_comments_371209.json:
```json
{
    "body": "I guess so, but I'm not sure. Why are you asking?",
    "created_at": "2018-12-02T15:00:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371209",
    "user": "@timokau"
}
```

I guess so, but I'm not sure. Why are you asking?



---

archive/issue_comments_371210.json:
```json
{
    "body": "In order to be able to use system-wide R, as we already do with e.g. patch, gcc - see #26286 for more, we'd need appropriate `spkg-configure.m4`.",
    "created_at": "2018-12-02T20:30:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371210",
    "user": "@dimpase"
}
```

In order to be able to use system-wide R, as we already do with e.g. patch, gcc - see #26286 for more, we'd need appropriate `spkg-configure.m4`.



---

archive/issue_comments_371211.json:
```json
{
    "body": "Well `R` is not called directly much. Except by `rpy` now. It is not linked to by any standard packages that I can see and that includes `rpy`. So we just need to make sure that the environment that may be set by the system `R` finds its way in the sage environmnet and that seem to be mainly `R_HOME`. R also installs some `.pc` files here and I guess they should be fully visible to pkg-config from the sage-environment - which I hope is already properly set up by default (if something is in the sage environment it should be seen first but system pc should still be discoverable if there isn't a match in the sage environment).",
    "created_at": "2018-12-02T20:40:01Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371211",
    "user": "@kiwifb"
}
```

Well `R` is not called directly much. Except by `rpy` now. It is not linked to by any standard packages that I can see and that includes `rpy`. So we just need to make sure that the environment that may be set by the system `R` finds its way in the sage environmnet and that seem to be mainly `R_HOME`. R also installs some `.pc` files here and I guess they should be fully visible to pkg-config from the sage-environment - which I hope is already properly set up by default (if something is in the sage environment it should be seen first but system pc should still be discoverable if there isn't a match in the sage environment).



---

archive/issue_comments_371212.json:
```json
{
    "body": "Perhaps the 1st step should be to check whether there is a system-wide pkg-config. Then we can just add SAGE_LOCAL to  PKG_CONFIG_PATH (or something along these lines), and don't install the Sage's one.",
    "created_at": "2018-12-03T19:46:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371212",
    "user": "@dimpase"
}
```

Perhaps the 1st step should be to check whether there is a system-wide pkg-config. Then we can just add SAGE_LOCAL to  PKG_CONFIG_PATH (or something along these lines), and don't install the Sage's one.



---

archive/issue_comments_371213.json:
```json
{
    "body": "Having Sage able to use a system R is definitely on my todo list.  The tricky part is that R is packaged a number of different ways on a number of different systems.  On most Linuxes it should be straightforward, but on OSX it's more complicated (is there an \"official\" R / RStudio installer for OSX? Or maybe they're using Homebrew?)  And on Windows it's complicated too--there is an R package for Cygwin I would like to be able to use if possible, but again a lot of people may want to integrate with their existing RStudio for Windows and that's again more complicated...",
    "created_at": "2018-12-05T09:08:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371213",
    "user": "@embray"
}
```

Having Sage able to use a system R is definitely on my todo list.  The tricky part is that R is packaged a number of different ways on a number of different systems.  On most Linuxes it should be straightforward, but on OSX it's more complicated (is there an "official" R / RStudio installer for OSX? Or maybe they're using Homebrew?)  And on Windows it's complicated too--there is an R package for Cygwin I would like to be able to use if possible, but again a lot of people may want to integrate with their existing RStudio for Windows and that's again more complicated...



---

archive/issue_comments_371214.json:
```json
{
    "body": "Replying to [comment:57 embray]:\n> Having Sage able to use a system R is definitely on my todo list.  The tricky part is that R is packaged a number of different ways on a number of different systems.  On most Linuxes it should be straightforward, but on OSX it's more complicated (is there an \"official\" R / RStudio installer for OSX? Or maybe they're using Homebrew?)  And on Windows it's complicated too--there is an R package for Cygwin I would like to be able to use if possible, but again a lot of people may want to integrate with their existing RStudio for Windows and that's again more complicated...\n\nFrom R project website, I gather they are doing a similar to Sage's thing (or even go further, by supplying Clang 6 too) on OSX: supply their own compilers for building from source...\n\n''\nNote: CRAN does not have Mac OS X systems and cannot check these binaries for viruses. Altough we take precautions when assembling binaries, please use the normal precautions with downloaded executables.''\n\n''Important note: R 3.5.0 El Capitan binaries are using Clang 6.0.0 and GNU Fortran 6.1 to provide OpenMP parallelization support and C++17 standard features. If you want to compile R packages from sources, please download GNU Fortran binary from the official GNU Fortran Binaries page - in particular OS X 10.11 gfortran 6.1. Alternatively, we are providing a copy here as well as Clang 6.0.0 binaries for OS X 10.11 and higher - see below for the download links. You can also try to use clang from Xcode, but it will be missing required features so your mileage may vary and it is not recommended.\n''",
    "created_at": "2018-12-05T12:04:24Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371214",
    "user": "@dimpase"
}
```

Replying to [comment:57 embray]:
> Having Sage able to use a system R is definitely on my todo list.  The tricky part is that R is packaged a number of different ways on a number of different systems.  On most Linuxes it should be straightforward, but on OSX it's more complicated (is there an "official" R / RStudio installer for OSX? Or maybe they're using Homebrew?)  And on Windows it's complicated too--there is an R package for Cygwin I would like to be able to use if possible, but again a lot of people may want to integrate with their existing RStudio for Windows and that's again more complicated...

From R project website, I gather they are doing a similar to Sage's thing (or even go further, by supplying Clang 6 too) on OSX: supply their own compilers for building from source...

''
Note: CRAN does not have Mac OS X systems and cannot check these binaries for viruses. Altough we take precautions when assembling binaries, please use the normal precautions with downloaded executables.''

''Important note: R 3.5.0 El Capitan binaries are using Clang 6.0.0 and GNU Fortran 6.1 to provide OpenMP parallelization support and C++17 standard features. If you want to compile R packages from sources, please download GNU Fortran binary from the official GNU Fortran Binaries page - in particular OS X 10.11 gfortran 6.1. Alternatively, we are providing a copy here as well as Clang 6.0.0 binaries for OS X 10.11 and higher - see below for the download links. You can also try to use clang from Xcode, but it will be missing required features so your mileage may vary and it is not recommended.
''



---

archive/issue_comments_371215.json:
```json
{
    "body": "I'm seeing this segfault now on Arch with R and (open)blas from the system.",
    "created_at": "2020-01-31T18:19:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/26359",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/26359#issuecomment-371215",
    "user": "@dimpase"
}
```

I'm seeing this segfault now on Arch with R and (open)blas from the system.
