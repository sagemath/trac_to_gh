# Issue 11649: sage-preparse: give 'safer' names to .py files

Issue created by migration from Trac.

Original creator: jhpalmieri

Original creation time: 2011-09-20 20:04:09

If you run "sage new.sage" on a script "new.sage", it creates a preparsed file "new.py".  Then when a file in the twisted package tries to import the "new" Python module, it ends up importing this preparsed file instead, which leads to problems which can be hard to track down.

I can think of three solutions:

 1. hope that users will know not to use names like "new.sage".  This is the current state of affairs, and it seems overly optimistic to me.
 2. give a warning, or fail outright with an error, if the name of the file is the same as that of a Python module.
 3. name the preparsed file something which is less likely to cause a clash, for example, turn "file.sage" into "file_preparsed.py".

The attached patch implements number 3.


---

Comment by jhpalmieri created at 2011-09-20 20:07:22

Changing status from new to needs_review.


---

Comment by leif created at 2011-09-20 21:31:16

I'd opt for either (2) or (3).

(3) is nicer from a user perspective, but _may_ have other side effects.

(2) should be easy to implement (`try: import ...`), without potentially breaking other code because of assumptions on the filename, so I tend to prefer this variant.




P.S.: Looks like the patch is not yet based on #9739. (Haven't tried.)

If we change the way `.sage` files are preparsed when doctesting, we might run into errors due to left-over `<file>.py` files from `attach()` or `load()`. Just a thought.


---

Comment by jhpalmieri created at 2011-09-28 00:06:49

Yet a fourth option, implemented in the "v2" patch: don't save the preparsed file at all.  Here are the changes in this patch:

 - sage-preparse is split into two scripts: sage-preparse-one-file, which preparses a single file and writes the output to stdout.  Then sage-preparse calls this, and saves the output to the appropriate place.  Note that for sage-preparse, the help message in sage-sage says that it should "preparse file.sage and produce corresponding file_sage.py".   This patch fixes both the behavior and the documentation: it saves to "file_sage.py", which should be a valid Python module name, instead of to "file.py" or "file.sage.py".  This should help to prevent name clashes.

 - Then sage-run calls sage-preparse-one-file and feeds the output into "sage-python -c <OUTPUT>", rather than feeding the preparsed py file as "sage-python <FILE>".

 - Independently of this patch, running "sage <file1.sage> <file2.sage> ..." acts just like running "sage <file1.sage>" -- it ignores the later arguments.  So the documentation has been altered to match this.

 - On the other hand, sage-preparse can handle multiple files as inputs, so change its description (at the top of the file) to match.

To do: add some tests to sage/tests/cmdline.py.


---

Comment by jhpalmieri created at 2011-09-28 03:47:41

The new patch adds some doctests (not very sophisticated ones, but we can expand on them later).


---

Comment by jhpalmieri created at 2011-11-22 19:45:29

This needs rebasing relative to #12069.  I'll get to it eventually.


---

Comment by jhpalmieri created at 2011-11-22 19:45:29

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2011-11-23 04:52:12

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2011-11-23 04:52:12

Okay, now rebased.


---

Comment by jhpalmieri created at 2012-03-21 21:29:18

Rebased to Sage 5.0.beta8 and #12069.


---

Comment by roed created at 2013-03-14 21:47:58

This needs to be rebased against #12415 (`sage-doctest` is no longer relevant).


---

Comment by roed created at 2013-03-14 21:47:58

Changing status from needs_review to needs_work.


---

Comment by jhpalmieri created at 2013-03-18 19:45:54

Now rebased.


---

Comment by jhpalmieri created at 2013-03-18 19:45:54

Changing status from needs_work to needs_review.


---

Comment by jhpalmieri created at 2013-03-18 19:46:11

root repo


---

Attachment

Sage library


---

Attachment

scripts repo


---

Comment by jdemeyer created at 2014-09-10 06:16:41

I don't like this patch because of #71. I regularly use the `.py` file when I get an exception to find out where the exception happened.


---

Comment by jdemeyer created at 2014-09-10 09:18:14

Changing status from needs_review to needs_work.


---

Comment by jdemeyer created at 2014-09-10 09:23:57

See also #16955.


---

Comment by jhpalmieri created at 2014-09-10 18:31:58

Should this be closed as "won't fix" because of #16955? Or is there a reason to preparse to stdout and pipe the results through sage?


---

Comment by jdemeyer created at 2014-09-10 21:04:39

Replying to [comment:19 jhpalmieri]:
> Or is there a reason to preparse to stdout and pipe the results through sage?
Not having preparsed `.py` files cluttered around.
