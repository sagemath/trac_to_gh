# Issue 11649: sage-preparse: give 'safer' names to .py files

archive/issues_011649.json:
```json
{
    "body": "If you run \"sage new.sage\" on a script \"new.sage\", it creates a preparsed file \"new.py\".  Then when a file in the twisted package tries to import the \"new\" Python module, it ends up importing this preparsed file instead, which leads to problems which can be hard to track down.\n\nI can think of three solutions:\n\n1. hope that users will know not to use names like \"new.sage\".  This is the current state of affairs, and it seems overly optimistic to me.\n2. give a warning, or fail outright with an error, if the name of the file is the same as that of a Python module.\n3. name the preparsed file something which is less likely to cause a clash, for example, turn \"file.sage\" into \"file_preparsed.py\".\n\nThe attached patch implements number 3.\n\nIssue created by migration from https://trac.sagemath.org/ticket/11821\n\n",
    "created_at": "2011-09-20T20:04:09Z",
    "labels": [
        "scripts",
        "major",
        "bug"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.4",
    "title": "sage-preparse: give 'safer' names to .py files",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/11649",
    "user": "@jhpalmieri"
}
```
If you run "sage new.sage" on a script "new.sage", it creates a preparsed file "new.py".  Then when a file in the twisted package tries to import the "new" Python module, it ends up importing this preparsed file instead, which leads to problems which can be hard to track down.

I can think of three solutions:

1. hope that users will know not to use names like "new.sage".  This is the current state of affairs, and it seems overly optimistic to me.
2. give a warning, or fail outright with an error, if the name of the file is the same as that of a Python module.
3. name the preparsed file something which is less likely to cause a clash, for example, turn "file.sage" into "file_preparsed.py".

The attached patch implements number 3.

Issue created by migration from https://trac.sagemath.org/ticket/11821





---

archive/issue_comments_131690.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2011-09-20T20:07:22Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131690",
    "user": "@jhpalmieri"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_131691.json:
```json
{
    "body": "I'd opt for either (2) or (3).\n\n(3) is nicer from a user perspective, but *may* have other side effects.\n\n(2) should be easy to implement (`try: import ...`), without potentially breaking other code because of assumptions on the filename, so I tend to prefer this variant.\n\n\n\n\nP.S.: Looks like the patch is not yet based on #9739. (Haven't tried.)\n\nIf we change the way `.sage` files are preparsed when doctesting, we might run into errors due to left-over `<file>.py` files from `attach()` or `load()`. Just a thought.",
    "created_at": "2011-09-20T21:31:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131691",
    "user": "@nexttime"
}
```

I'd opt for either (2) or (3).

(3) is nicer from a user perspective, but *may* have other side effects.

(2) should be easy to implement (`try: import ...`), without potentially breaking other code because of assumptions on the filename, so I tend to prefer this variant.




P.S.: Looks like the patch is not yet based on #9739. (Haven't tried.)

If we change the way `.sage` files are preparsed when doctesting, we might run into errors due to left-over `<file>.py` files from `attach()` or `load()`. Just a thought.



---

archive/issue_comments_131692.json:
```json
{
    "body": "Yet a fourth option, implemented in the \"v2\" patch: don't save the preparsed file at all.  Here are the changes in this patch:\n\n- sage-preparse is split into two scripts: sage-preparse-one-file, which preparses a single file and writes the output to stdout.  Then sage-preparse calls this, and saves the output to the appropriate place.  Note that for sage-preparse, the help message in sage-sage says that it should \"preparse file.sage and produce corresponding file_sage.py\".   This patch fixes both the behavior and the documentation: it saves to \"file_sage.py\", which should be a valid Python module name, instead of to \"file.py\" or \"file.sage.py\".  This should help to prevent name clashes.\n\n- Then sage-run calls sage-preparse-one-file and feeds the output into \"sage-python -c <OUTPUT>\", rather than feeding the preparsed py file as \"sage-python <FILE>\".\n\n- Independently of this patch, running \"sage <file1.sage> <file2.sage> ...\" acts just like running \"sage <file1.sage>\" -- it ignores the later arguments.  So the documentation has been altered to match this.\n\n- On the other hand, sage-preparse can handle multiple files as inputs, so change its description (at the top of the file) to match.\n\nTo do: add some tests to sage/tests/cmdline.py.",
    "created_at": "2011-09-28T00:06:49Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131692",
    "user": "@jhpalmieri"
}
```

Yet a fourth option, implemented in the "v2" patch: don't save the preparsed file at all.  Here are the changes in this patch:

- sage-preparse is split into two scripts: sage-preparse-one-file, which preparses a single file and writes the output to stdout.  Then sage-preparse calls this, and saves the output to the appropriate place.  Note that for sage-preparse, the help message in sage-sage says that it should "preparse file.sage and produce corresponding file_sage.py".   This patch fixes both the behavior and the documentation: it saves to "file_sage.py", which should be a valid Python module name, instead of to "file.py" or "file.sage.py".  This should help to prevent name clashes.

- Then sage-run calls sage-preparse-one-file and feeds the output into "sage-python -c <OUTPUT>", rather than feeding the preparsed py file as "sage-python <FILE>".

- Independently of this patch, running "sage <file1.sage> <file2.sage> ..." acts just like running "sage <file1.sage>" -- it ignores the later arguments.  So the documentation has been altered to match this.

- On the other hand, sage-preparse can handle multiple files as inputs, so change its description (at the top of the file) to match.

To do: add some tests to sage/tests/cmdline.py.



---

archive/issue_comments_131693.json:
```json
{
    "body": "The new patch adds some doctests (not very sophisticated ones, but we can expand on them later).",
    "created_at": "2011-09-28T03:47:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131693",
    "user": "@jhpalmieri"
}
```

The new patch adds some doctests (not very sophisticated ones, but we can expand on them later).



---

archive/issue_comments_131694.json:
```json
{
    "body": "This needs rebasing relative to #12069.  I'll get to it eventually.",
    "created_at": "2011-11-22T19:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131694",
    "user": "@jhpalmieri"
}
```

This needs rebasing relative to #12069.  I'll get to it eventually.



---

archive/issue_comments_131695.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2011-11-22T19:45:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131695",
    "user": "@jhpalmieri"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_131696.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2011-11-23T04:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131696",
    "user": "@jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_131697.json:
```json
{
    "body": "Okay, now rebased.",
    "created_at": "2011-11-23T04:52:12Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131697",
    "user": "@jhpalmieri"
}
```

Okay, now rebased.



---

archive/issue_comments_131698.json:
```json
{
    "body": "Rebased to Sage 5.0.beta8 and #12069.",
    "created_at": "2012-03-21T21:29:18Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131698",
    "user": "@jhpalmieri"
}
```

Rebased to Sage 5.0.beta8 and #12069.



---

archive/issue_comments_131699.json:
```json
{
    "body": "This needs to be rebased against #12415 (`sage-doctest` is no longer relevant).",
    "created_at": "2013-03-14T21:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131699",
    "user": "@roed314"
}
```

This needs to be rebased against #12415 (`sage-doctest` is no longer relevant).



---

archive/issue_comments_131700.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2013-03-14T21:47:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131700",
    "user": "@roed314"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_131701.json:
```json
{
    "body": "Now rebased.",
    "created_at": "2013-03-18T19:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131701",
    "user": "@jhpalmieri"
}
```

Now rebased.



---

archive/issue_comments_131702.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2013-03-18T19:45:54Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131702",
    "user": "@jhpalmieri"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_131703.json:
```json
{
    "body": "root repo",
    "created_at": "2013-03-18T19:46:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131703",
    "user": "@jhpalmieri"
}
```

root repo



---

archive/issue_comments_131704.json:
```json
{
    "body": "Attachment [trac_11821-root.patch](tarball://root/attachments/some-uuid/ticket11821/trac_11821-root.patch) by @jhpalmieri created at 2013-03-18 19:46:20\n\nSage library",
    "created_at": "2013-03-18T19:46:20Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131704",
    "user": "@jhpalmieri"
}
```

Attachment [trac_11821-root.patch](tarball://root/attachments/some-uuid/ticket11821/trac_11821-root.patch) by @jhpalmieri created at 2013-03-18 19:46:20

Sage library



---

archive/issue_comments_131705.json:
```json
{
    "body": "Attachment [trac_11821-preparse.v3.patch](tarball://root/attachments/some-uuid/ticket11821/trac_11821-preparse.v3.patch) by @jhpalmieri created at 2013-03-18 19:46:29\n\nscripts repo",
    "created_at": "2013-03-18T19:46:29Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131705",
    "user": "@jhpalmieri"
}
```

Attachment [trac_11821-preparse.v3.patch](tarball://root/attachments/some-uuid/ticket11821/trac_11821-preparse.v3.patch) by @jhpalmieri created at 2013-03-18 19:46:29

scripts repo



---

archive/issue_comments_131706.json:
```json
{
    "body": "I don't like this patch because of #71. I regularly use the `.py` file when I get an exception to find out where the exception happened.",
    "created_at": "2014-09-10T06:16:41Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131706",
    "user": "@jdemeyer"
}
```

I don't like this patch because of #71. I regularly use the `.py` file when I get an exception to find out where the exception happened.



---

archive/issue_comments_131707.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-09-10T09:18:14Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131707",
    "user": "@jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_131708.json:
```json
{
    "body": "See also #16955.",
    "created_at": "2014-09-10T09:23:57Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131708",
    "user": "@jdemeyer"
}
```

See also #16955.



---

archive/issue_comments_131709.json:
```json
{
    "body": "Should this be closed as \"won't fix\" because of #16955? Or is there a reason to preparse to stdout and pipe the results through sage?",
    "created_at": "2014-09-10T18:31:58Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131709",
    "user": "@jhpalmieri"
}
```

Should this be closed as "won't fix" because of #16955? Or is there a reason to preparse to stdout and pipe the results through sage?



---

archive/issue_comments_131710.json:
```json
{
    "body": "Replying to [comment:19 jhpalmieri]:\n> Or is there a reason to preparse to stdout and pipe the results through sage?\nNot having preparsed `.py` files cluttered around.",
    "created_at": "2014-09-10T21:04:39Z",
    "issue": "https://github.com/sagemath/sagetest/issues/11649",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/11649#issuecomment-131710",
    "user": "@jdemeyer"
}
```

Replying to [comment:19 jhpalmieri]:
> Or is there a reason to preparse to stdout and pipe the results through sage?
Not having preparsed `.py` files cluttered around.
