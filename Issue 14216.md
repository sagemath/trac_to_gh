# Issue 14216: Compositions with min_part=0 induces OOM

archive/issues_014216.json:
```json
{
    "body": "Assignee: sage-combinat\n\nCC:  nthiery\n\nTry the following after setting your ulimit\n\n```\n$ ulimit -v 2000000 # 2G max of virtual memory\n$ sage\n...\nsage: Compositions(2, min_part=0).list()\n...\nMemoryError:\n```\n\nI suspect the Compositions code goes into an infinite recursion or something which eats up all the memory on the system.\n\nThis memory error can be easily avoided by checking that the `length` keyword is nonempty or that the `max_length` (or `outer` -- it seems to affect the max length) is set by the user.\n\nIssue created by migration from https://trac.sagemath.org/ticket/14420\n\n",
    "created_at": "2013-04-06T10:27:58Z",
    "labels": [
        "combinatorics",
        "major",
        "bug"
    ],
    "title": "Compositions with min_part=0 induces OOM",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/14216",
    "user": "ppurka"
}
```
Assignee: sage-combinat

CC:  nthiery

Try the following after setting your ulimit

```
$ ulimit -v 2000000 # 2G max of virtual memory
$ sage
...
sage: Compositions(2, min_part=0).list()
...
MemoryError:
```

I suspect the Compositions code goes into an infinite recursion or something which eats up all the memory on the system.

This memory error can be easily avoided by checking that the `length` keyword is nonempty or that the `max_length` (or `outer` -- it seems to affect the max length) is set by the user.

Issue created by migration from https://trac.sagemath.org/ticket/14420





---

archive/issue_comments_178884.json:
```json
{
    "body": "You are actually asking for an infinite list:\n\n```\nsage: l = Compositions(2, min_part=0)\n/home/data/Sage-Install/sage-5.8/local/lib/python2.7/site-packages/sage/combinat/composition.py:1036: RuntimeWarning: Currently, setting min_part=0 produces Composition objects which violate internal assumptions.  Calling methods on these objects may produce errors or WRONG results!\n  warn(\"Currently, setting min_part=0 produces Composition objects which violate internal assumptions.  Calling methods on these objects may produce errors or WRONG results!\", RuntimeWarning)\nsage: it = iter(l)\nsage: it.next()\n[2]\nsage: it.next()\n[1, 1]\nsage: it.next()\n[1, 0, 1]\nsage: it.next()\n[1, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]\nsage: it.next()\n[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]\n...\n```\n\n\nSo what is needed is to detect if the set is finite or not and to set up the proper category `EnumeratedSet.Finite()` or `EnumeratedSet.Infinite()` as in\n\n```\nsage: Compositions().list()\n[...]\nNotImplementedError: infinite list\n```\n\n\nFlorent",
    "created_at": "2013-04-06T10:35:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14216#issuecomment-178884",
    "user": "hivert"
}
```

You are actually asking for an infinite list:

```
sage: l = Compositions(2, min_part=0)
/home/data/Sage-Install/sage-5.8/local/lib/python2.7/site-packages/sage/combinat/composition.py:1036: RuntimeWarning: Currently, setting min_part=0 produces Composition objects which violate internal assumptions.  Calling methods on these objects may produce errors or WRONG results!
  warn("Currently, setting min_part=0 produces Composition objects which violate internal assumptions.  Calling methods on these objects may produce errors or WRONG results!", RuntimeWarning)
sage: it = iter(l)
sage: it.next()
[2]
sage: it.next()
[1, 1]
sage: it.next()
[1, 0, 1]
sage: it.next()
[1, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]
sage: it.next()
[1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1]
...
```


So what is needed is to detect if the set is finite or not and to set up the proper category `EnumeratedSet.Finite()` or `EnumeratedSet.Infinite()` as in

```
sage: Compositions().list()
[...]
NotImplementedError: infinite list
```


Florent



---

archive/issue_comments_178885.json:
```json
{
    "body": "Replying to [comment:2 hivert]:\n> You are actually asking for an infinite list:\n\nIndeed. That was what I suspected. What I wanted to point out in this ticket is that it *should be* easy to detect that the list is infinite - just check for the value of `max_length` if `min_part=0`. If this case is handled automatically in the code then it will at least prevent Sage from bringing down the whole machine. I was able to kill the process by invoking `SysRq`, but not everyone knows the `SysRq` keycodes.",
    "created_at": "2013-04-07T14:53:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14216#issuecomment-178885",
    "user": "ppurka"
}
```

Replying to [comment:2 hivert]:
> You are actually asking for an infinite list:

Indeed. That was what I suspected. What I wanted to point out in this ticket is that it *should be* easy to detect that the list is infinite - just check for the value of `max_length` if `min_part=0`. If this case is handled automatically in the code then it will at least prevent Sage from bringing down the whole machine. I was able to kill the process by invoking `SysRq`, but not everyone knows the `SysRq` keycodes.



---

archive/issue_comments_178886.json:
```json
{
    "body": "There any many things in sage which go into infinite lists (ex. `Sequence((1..))`, `list(Partitions())`, ...). That aside, you're actually breaking an assumption of `Compositions` by setting `min_part=0`; `IntegerVectors` is what should be used. The documentation for `Compositions` states all of this, but perhaps that could be improved.",
    "created_at": "2013-04-09T19:22:02Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14216#issuecomment-178886",
    "user": "tscrim"
}
```

There any many things in sage which go into infinite lists (ex. `Sequence((1..))`, `list(Partitions())`, ...). That aside, you're actually breaking an assumption of `Compositions` by setting `min_part=0`; `IntegerVectors` is what should be used. The documentation for `Compositions` states all of this, but perhaps that could be improved.



---

archive/issue_comments_178887.json:
```json
{
    "body": "Shouldn't `IntegerVectors` be called directly from inside `Compositions` if `min_part=0` is passed as an argument? If we already have a solution which can handle this case of `min_part=0`, why are we still providing the big scary warning?\n\nOr, is it the case that `Compositions` is more general than `IntegerVectors`, even if we restrict ourselves to the case `min_part=0`?",
    "created_at": "2013-04-13T05:35:37Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14216#issuecomment-178887",
    "user": "ppurka"
}
```

Shouldn't `IntegerVectors` be called directly from inside `Compositions` if `min_part=0` is passed as an argument? If we already have a solution which can handle this case of `min_part=0`, why are we still providing the big scary warning?

Or, is it the case that `Compositions` is more general than `IntegerVectors`, even if we restrict ourselves to the case `min_part=0`?



---

archive/issue_comments_178888.json:
```json
{
    "body": "If it should do anything, it should adjust `min_part` to fit it's own internal assumptions. Nevertheless we still need this mentioned in the doc, but probably not so buried in it. I'm cc-ing Nicolas to get his opinion on this.",
    "created_at": "2013-04-13T13:06:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/14216",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/14216#issuecomment-178888",
    "user": "tscrim"
}
```

If it should do anything, it should adjust `min_part` to fit it's own internal assumptions. Nevertheless we still need this mentioned in the doc, but probably not so buried in it. I'm cc-ing Nicolas to get his opinion on this.
