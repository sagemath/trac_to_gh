# Issue 20869: class for flattening polynomial rings over polynomial rings

Issue created by migration from Trac.

Original creator: bhutz

Original creation time: 2016-07-27 15:34:39

CC:  vdelecroix

Given a polynomial ring QQ['a',b']['x','y'] construct a morphism and its inverse to the ring QQ['a','b','x','y']


---

Comment by bhutz created at 2016-07-27 15:36:31

Here is a first attempt to flesh this out. Please comment.
----
New commits:


---

Comment by vdelecroix created at 2016-07-27 15:47:05


```
For example ``QQ['a','b'],['x','y']`` flattens to ``QQ['a','b','c','d']``.
```

should I read ```QQ['a', 'b', 'x', 'y']```?


---

Comment by vdelecroix created at 2016-07-27 15:47:29

The error `ValueError("clash in variable names")` should be tested.


---

Comment by vdelecroix created at 2016-07-27 15:48:32

I am not sure we want that `FlatteningMorphism` in the global namespace.


---

Comment by bhutz created at 2016-07-27 15:51:16

Those are all simple enough. I also removed some terminating white space


---

Comment by vdelecroix created at 2016-07-27 15:54:27

Here is a recursive version of `_call_` that seems to be a little bit faster

```
    def _call2_(self, p):
        r"""
        TESTS::

            sage: R = QQ['x']['y']['s','t']
            sage: p = R('s*x + y*t + x^2*s + 1 + t')
            sage: f = FlatteningMorphism(R)
            sage: f._call2_(p)
            x^2*s + x*s + y*t + t + 1
        """
        p = {(): p}

        for ring in self._intermediate_rings:
            new_p = {}
            if is_PolynomialRing(ring):
                for mon,pp in p.iteritems():
                    assert pp.parent() == ring
                    for i,j in pp.dict().iteritems():
                        new_p[(i,)+(mon)] = j
            elif is_MPolynomialRing(ring):
                for mon,pp in p.iteritems():
                    assert pp.parent() == ring
                    for mmon,q in pp.dict().iteritems():
                        new_p[tuple(mmon)+mon] = q
            else:
                raise RuntimeError
            p = new_p

    return self.codomain()(p)
```



---

Comment by git created at 2016-07-27 15:54:28

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-07-27 15:55:43

To use `_call2_`, the constructor needs to be modified with

```
        intermediate_rings = []
        ... # AS BEFORE
        while is_PolynomialRing(ring) or is_MPolynomialRing(ring):
            intermediate_rings.append(ring)
            ... # AS BEFORE
        ... # AS BEFORE
        self._intermediate_rings = intermediate_rings
```



---

Comment by vdelecroix created at 2016-07-27 16:02:24

Do you think we want to support both version of `_call_`?


---

Comment by bhutz created at 2016-07-27 16:11:15

None of the examples that I've tried fail for _call2_? The more constructive call2 sits better with me as it is not relying on iterpreting a string as a polynomial.


---

Comment by vdelecroix created at 2016-07-27 16:14:10

Note that a similar `_call_` can be implemented for the section morphism.


---

Comment by git created at 2016-07-27 17:14:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2016-07-27 17:16:51

Changing status from new to needs_review.


---

Comment by bhutz created at 2016-07-27 17:16:51

changes made and a version of call2 for unflattening. Not quite as elegant as yours, but constructive.


---

Comment by vdelecroix created at 2016-07-27 18:05:57

Is it faster than string?


---

Comment by bhutz created at 2016-07-27 18:17:18

much faster for things like CC and str does not work for QQbar. It is slightly slower for QQ.


---

Comment by vdelecroix created at 2016-07-27 18:28:38

Replying to [comment:17 bhutz]:
> much faster for things like CC and str does not work for QQbar. It is slightly slower for QQ.

Would be good to add doctest for `QQbar`. By the way, the string method would also fail for something like the following (that would be good to doctest as well)

```
sage: K.<a> = NumberField(x^3 - 2)
sage: R = K['x','y']['a','b']
```



---

Comment by vdelecroix created at 2016-07-27 18:31:37

Strings are also bad for floating point

```
sage: a = RR(1 / 2**30)
sage: RR(str(a)) == a
False
```



---

Comment by git created at 2016-07-27 18:43:35

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by bhutz created at 2016-07-27 18:44:06

yes, those are good and caught an error in the codomain as well that I've corrected.


---

Comment by vdelecroix created at 2016-07-27 19:16:56

New commits:


---

Comment by vdelecroix created at 2016-07-27 19:18:11

In my commit
- simplified your `_call_` (and it is now faster)
- removed some trailing whitespaces
- add more intensive random doctests

Please review my changes. And if you are happy with them, you can set to positive review.


---

Comment by bhutz created at 2016-07-27 19:50:03

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2016-07-27 19:50:03

looks good to me. Thanks.


---

Comment by vdelecroix created at 2016-07-27 20:49:29

Changing status from positive_review to needs_work.


---

Comment by vdelecroix created at 2016-07-27 20:50:14

problem with the file mode... it is `-rwxr-xr-x` instead of `-rw-r--r--`.

(incidentally I have another commit to propose)


---

Comment by git created at 2016-07-27 20:51:44

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by vdelecroix created at 2016-07-27 20:52:44

Changing status from needs_work to needs_review.


---

Comment by bhutz created at 2016-07-27 20:56:40

Changing status from needs_review to positive_review.


---

Comment by bhutz created at 2016-07-27 20:56:40

those changes are fine with me. I pulled it down to test just to be safe, and all still runs fine.


---

Comment by vdelecroix created at 2016-07-27 20:59:36

Thanks!

I also think that in the future the `FlatteningMorphism` should support `QQ['a','b']['a','b']['a']['b']`. There is almost nothing to modify to make the target to be `QQ['x0','x1','x2','x3','x4','x5']` (I guess only the constructor).


---

Comment by bhutz created at 2016-07-27 21:29:15

You probably saw, I removed the original codomain argument. I was running into some difficulties there with _call_, but with the new version of _call_ it would probably actually be easy now.


---

Comment by vdelecroix created at 2016-07-27 21:31:26

Yep. It might also be that for some operation it is good to try in `QQ['a']['b']['c']['d']['e']` instead. In which case we might want to use `UnflattenMorphism` without using `FlattenMorphism`. See my recent post

    https://groups.google.com/forum/#!topic/sage-devel/CDLCb6OX4ns


---

Comment by bhutz created at 2016-07-28 11:42:28

Changing status from positive_review to needs_work.


---

Comment by bhutz created at 2016-07-28 11:42:28

unflatteningmorphism cannot be used by itself since _intermediate rings is defined through section. I'll fix that shortly.


---

Comment by vdelecroix created at 2016-07-28 12:03:06

You are free to open a *new* ticket for that issue. Do not change a ticket in `positive_review` to `needs_work`. Moreover when it is in that state since a long time and that there are other tickets based on it.


---

Comment by bhutz created at 2016-07-28 12:09:27

ok, so I should mark this back to positive, and then open a new ticket to fix the issue?


---

Comment by vdelecroix created at 2016-07-28 12:10:58

better, yes.


---

Comment by bhutz created at 2016-07-28 12:14:13

Changing status from needs_work to positive_review.


---

Comment by bhutz created at 2016-07-28 12:14:13

the issue is now #21113


---

Comment by vbraun created at 2016-08-10 22:27:19

Resolution: fixed
