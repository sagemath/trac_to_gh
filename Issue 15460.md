# Issue 15460: Upgrade MPC to latest upstream

archive/issues_015460.json:
```json
{
    "body": "CC:  @zimmermann6 thevenyp\n\nDrop-in upgrade.\n\n**Upstream**: [http://www.multiprecision.org/mpc/download/mpc-1.0.2.tar.gz](http://www.multiprecision.org/mpc/download/mpc-1.0.2.tar.gz)\n\nIssue created by migration from https://trac.sagemath.org/ticket/15697\n\n",
    "closed_at": "2014-02-01T19:39:16Z",
    "created_at": "2014-01-19T22:47:03Z",
    "labels": [
        "component: packages: standard",
        "minor"
    ],
    "milestone": "https://github.com/sagemath/sagetest/milestones/sage-6.2",
    "title": "Upgrade MPC to latest upstream",
    "type": "issue",
    "url": "https://github.com/sagemath/sagetest/issues/15460",
    "user": "https://github.com/jdemeyer"
}
```
CC:  @zimmermann6 thevenyp

Drop-in upgrade.

**Upstream**: [http://www.multiprecision.org/mpc/download/mpc-1.0.2.tar.gz](http://www.multiprecision.org/mpc/download/mpc-1.0.2.tar.gz)

Issue created by migration from https://trac.sagemath.org/ticket/15697





---

archive/issue_comments_199436.json:
```json
{
    "body": "Changing status from new to needs_review.",
    "created_at": "2014-01-19T23:02:21Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199436",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from new to needs_review.



---

archive/issue_comments_199437.json:
```json
{
    "body": "New commits:",
    "created_at": "2014-01-19T23:04:48Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199437",
    "user": "https://github.com/jdemeyer"
}
```

New commits:



---

archive/issue_comments_199438.json:
```json
{
    "body": "Is bz2 rather than gz if it is the only thing provided by upstream a hard requirement?",
    "created_at": "2014-01-20T21:58:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199438",
    "user": "https://github.com/kiwifb"
}
```

Is bz2 rather than gz if it is the only thing provided by upstream a hard requirement?



---

archive/issue_comments_199439.json:
```json
{
    "body": "Given that every other package in Sage (except for `bzip2` obviously) uses `.bz2`, I decided to recompress to `.bz2`. But I personally don't care much...",
    "created_at": "2014-01-21T09:25:40Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199439",
    "user": "https://github.com/jdemeyer"
}
```

Given that every other package in Sage (except for `bzip2` obviously) uses `.bz2`, I decided to recompress to `.bz2`. But I personally don't care much...



---

archive/issue_comments_199440.json:
```json
{
    "body": "I guess my concern is can the sage build system cope with gz. I might be a purist but I think we should as much as possible include stuff from upstream as is. It make things easier to include and baring incident like flint 2.4.1 we have the checksum from the upstream tarball rather than the one produced by a sage dev. This is stuff for sage-devel really.\n\nI have otherwise no concern with this upgrade.",
    "created_at": "2014-01-21T10:00:28Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199440",
    "user": "https://github.com/kiwifb"
}
```

I guess my concern is can the sage build system cope with gz. I might be a purist but I think we should as much as possible include stuff from upstream as is. It make things easier to include and baring incident like flint 2.4.1 we have the checksum from the upstream tarball rather than the one produced by a sage dev. This is stuff for sage-devel really.

I have otherwise no concern with this upgrade.



---

archive/issue_comments_199441.json:
```json
{
    "body": "Replying to [comment:6 fbissey]:\n> I guess my concern is can the sage build system cope with gz.\n\nYes, it can.",
    "created_at": "2014-01-21T10:03:06Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199441",
    "user": "https://github.com/jdemeyer"
}
```

Replying to [comment:6 fbissey]:
> I guess my concern is can the sage build system cope with gz.

Yes, it can.



---

archive/issue_comments_199442.json:
```json
{
    "body": "Fran\u00e7ois, for me it's fine to take the pure upstream `.gz`. It only requires changing the `tarball=` line in `build/pkgs/mpc/checksums.ini`.",
    "created_at": "2014-01-21T10:38:25Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199442",
    "user": "https://github.com/jdemeyer"
}
```

Fran√ßois, for me it's fine to take the pure upstream `.gz`. It only requires changing the `tarball=` line in `build/pkgs/mpc/checksums.ini`.



---

archive/issue_comments_199443.json:
```json
{
    "body": "While I raised the point I suddenly feel that it is not my place to make that decision. There should be guidelines agreed with other in this case.",
    "created_at": "2014-01-21T10:41:07Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199443",
    "user": "https://github.com/kiwifb"
}
```

While I raised the point I suddenly feel that it is not my place to make that decision. There should be guidelines agreed with other in this case.



---

archive/issue_comments_199444.json:
```json
{
    "body": "Changing status from needs_review to needs_work.",
    "created_at": "2014-01-24T08:51:11Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199444",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_review to needs_work.



---

archive/issue_comments_199445.json:
```json
{
    "body": "Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:",
    "created_at": "2014-01-24T08:58:51Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199445",
    "user": "https://trac.sagemath.org/admin/accounts/users/git"
}
```

Branch pushed to git repo; I updated commit sha1. This was a forced push. New commits:



---

archive/issue_comments_199446.json:
```json
{
    "body": "Changing status from needs_work to needs_review.",
    "created_at": "2014-01-24T09:05:23Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199446",
    "user": "https://github.com/jdemeyer"
}
```

Changing status from needs_work to needs_review.



---

archive/issue_comments_199447.json:
```json
{
    "body": "OK I said I would review packages :) The sheer reduction of patches alone justify this one.",
    "created_at": "2014-01-24T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199447",
    "user": "https://github.com/kiwifb"
}
```

OK I said I would review packages :) The sheer reduction of patches alone justify this one.



---

archive/issue_comments_199448.json:
```json
{
    "body": "Changing status from needs_review to positive_review.",
    "created_at": "2014-01-24T09:21:26Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199448",
    "user": "https://github.com/kiwifb"
}
```

Changing status from needs_review to positive_review.



---

archive/issue_events_046070.json:
```json
{
    "actor": "https://trac.sagemath.org/admin/accounts/users/vbraun_spam",
    "created_at": "2014-01-30T21:20:52Z",
    "event": "milestoned",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "milestone": "sage-6.2",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15460#event-46070"
}
```



---

archive/issue_comments_199449.json:
```json
{
    "body": "Resolution: fixed",
    "created_at": "2014-02-01T19:39:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199449",
    "user": "https://github.com/vbraun"
}
```

Resolution: fixed



---

archive/issue_events_046071.json:
```json
{
    "actor": "https://github.com/vbraun",
    "created_at": "2014-02-01T19:39:16Z",
    "event": "closed",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_event",
    "url": "https://github.com/sagemath/sagetest/issues/15460#event-46071"
}
```



---

archive/issue_comments_199450.json:
```json
{
    "body": "Just for the record:\n\n`configure` is still slightly broken w.r.t. `CC` and `CFLAGS`, since the \"hack\" currently ignores the setting of `CPP` (and instead tries `/lib/cpp` with `CPPFLAGS` first, which may not work, resulting in empty `CC` and `CFLAGS` settings from `gmp.h`, such that finally `gcc` is used, which may of course also fail).\n\nI'll *one day*<sup>TM</sup> report this upstream.",
    "created_at": "2014-04-25T14:38:16Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199450",
    "user": "https://github.com/nexttime"
}
```

Just for the record:

`configure` is still slightly broken w.r.t. `CC` and `CFLAGS`, since the "hack" currently ignores the setting of `CPP` (and instead tries `/lib/cpp` with `CPPFLAGS` first, which may not work, resulting in empty `CC` and `CFLAGS` settings from `gmp.h`, such that finally `gcc` is used, which may of course also fail).

I'll *one day*<sup>TM</sup> report this upstream.



---

archive/issue_comments_199451.json:
```json
{
    "body": "P.S.:  From `m4/mpc.m4`:\n\n```sh\n#\n# SYNOPSIS\n#\n#\n# MPC_GMP_CC_CFLAGS\n#\n# DESCRIPTION\n#\n# Checks if CC and CFLAGS can be extracted from gmp.h\n# essentially copied from mpfr\n#\nAC_DEFUN([MPC_GMP_CC_CFLAGS], [\n   AC_MSG_CHECKING(for CC and CFLAGS in gmp.h)\n   # AC_PROG_CPP triggers the search for a C compiler; use hack instead\n   for cpp in /lib/cpp gcc cc c99\n   do\n      test $cpp = /lib/cpp || cpp=\"$cpp -E\"\n      echo foo > conftest.c\n      if $cpp $CPPFLAGS conftest.c > /dev/null 2> /dev/null ; then\n         # Get CC\n         echo \"#include \\\"gmp.h\\\"\" >  conftest.c\n         echo \"MPFR_OPTION __GMP_CC\"           >> conftest.c\n         GMP_CC=`$cpp $CPPFLAGS conftest.c 2> /dev/null | $EGREP MPFR_OPTION | $SED -e 's/MPFR_OPTION //g;s/ *\" *//g'`\n         # Get CFLAGS\n         echo \"#include \\\"gmp.h\\\"\" >  conftest.c\n         echo \"MPFR_OPTION __GMP_CFLAGS\"           >> conftest.c\n         GMP_CFLAGS=`$cpp $CPPFLAGS conftest.c 2> /dev/null | $EGREP MPFR_OPTION | $SED -e 's/MPFR_OPTION //g;s/ *\" *//g'`\n         break\n      fi\n   done\n\n   if test \"x$GMP_CFLAGS\" = \"x__GMP_CFLAGS\" -o \"x$GMP_CC\" = \"x__GMP_CC\" ; then\n      AC_MSG_RESULT(no)\n      GMP_CC=\n      GMP_CFLAGS=\n   else\n      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])\n   fi\n\n   # Check for validity of CC and CFLAGS obtained from gmp.h\n   if test -n \"$GMP_CC$GMP_CFLAGS\" ; then\n      AC_MSG_CHECKING(for CC=$GMP_CC and CFLAGS=$GMP_CFLAGS)\n      echo \"int main (void) { return 0; }\" > conftest.c\n      if $GMP_CC $GMP_CFLAGS -o conftest conftest.c 2> /dev/null ; then\n         AC_MSG_RESULT(yes)\n         CC=$GMP_CC\n         CFLAGS=$GMP_CFLAGS\n      else\n         AC_MSG_RESULT(no)\n      fi\n   fi\n\n   rm -f conftest*\n])\n```\n\nI don't exactly recall what went wrong, but `configure` gave me something like\n\n```\nchecking for CC and CFLAGS in gmp.h ... yes CC= CFLAGS=\n```\n\nand finally `gcc` was used (instead of `$CC`, while the same setting was recorded in `gmp.h`).",
    "created_at": "2014-04-25T14:53:27Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199451",
    "user": "https://github.com/nexttime"
}
```

P.S.:  From `m4/mpc.m4`:

```sh
#
# SYNOPSIS
#
#
# MPC_GMP_CC_CFLAGS
#
# DESCRIPTION
#
# Checks if CC and CFLAGS can be extracted from gmp.h
# essentially copied from mpfr
#
AC_DEFUN([MPC_GMP_CC_CFLAGS], [
   AC_MSG_CHECKING(for CC and CFLAGS in gmp.h)
   # AC_PROG_CPP triggers the search for a C compiler; use hack instead
   for cpp in /lib/cpp gcc cc c99
   do
      test $cpp = /lib/cpp || cpp="$cpp -E"
      echo foo > conftest.c
      if $cpp $CPPFLAGS conftest.c > /dev/null 2> /dev/null ; then
         # Get CC
         echo "#include \"gmp.h\"" >  conftest.c
         echo "MPFR_OPTION __GMP_CC"           >> conftest.c
         GMP_CC=`$cpp $CPPFLAGS conftest.c 2> /dev/null | $EGREP MPFR_OPTION | $SED -e 's/MPFR_OPTION //g;s/ *" *//g'`
         # Get CFLAGS
         echo "#include \"gmp.h\"" >  conftest.c
         echo "MPFR_OPTION __GMP_CFLAGS"           >> conftest.c
         GMP_CFLAGS=`$cpp $CPPFLAGS conftest.c 2> /dev/null | $EGREP MPFR_OPTION | $SED -e 's/MPFR_OPTION //g;s/ *" *//g'`
         break
      fi
   done

   if test "x$GMP_CFLAGS" = "x__GMP_CFLAGS" -o "x$GMP_CC" = "x__GMP_CC" ; then
      AC_MSG_RESULT(no)
      GMP_CC=
      GMP_CFLAGS=
   else
      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])
   fi

   # Check for validity of CC and CFLAGS obtained from gmp.h
   if test -n "$GMP_CC$GMP_CFLAGS" ; then
      AC_MSG_CHECKING(for CC=$GMP_CC and CFLAGS=$GMP_CFLAGS)
      echo "int main (void) { return 0; }" > conftest.c
      if $GMP_CC $GMP_CFLAGS -o conftest conftest.c 2> /dev/null ; then
         AC_MSG_RESULT(yes)
         CC=$GMP_CC
         CFLAGS=$GMP_CFLAGS
      else
         AC_MSG_RESULT(no)
      fi
   fi

   rm -f conftest*
])
```

I don't exactly recall what went wrong, but `configure` gave me something like

```
checking for CC and CFLAGS in gmp.h ... yes CC= CFLAGS=
```

and finally `gcc` was used (instead of `$CC`, while the same setting was recorded in `gmp.h`).



---

archive/issue_comments_199452.json:
```json
{
    "body": "Ah, the problem arises when *none of* `/lib/cpp gcc cc c99` work (with `$CPPFLAGS`), since then `GMP_CC` and `GMP_CFLAGS` will remain **empty**, and / but\n\n```sh\ntest \"x$GMP_CFLAGS\" = \"x__GMP_CFLAGS\" -o \"x$GMP_CC\" = \"x__GMP_CC\"\n```\nyields `false`, and\n\n```sh\n      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])\n```\nis executed, but **not** what follows (since `test -n \"$GMP_CC$GMP_CFLAGS\"` yields `false`):\n\n```sh\n   # Check for validity of CC and CFLAGS obtained from gmp.h\n   if test -n \"$GMP_CC$GMP_CFLAGS\" ; then\n      AC_MSG_CHECKING(for CC=$GMP_CC and CFLAGS=$GMP_CFLAGS)\n      echo \"int main (void) { return 0; }\" > conftest.c\n      if $GMP_CC $GMP_CFLAGS -o conftest conftest.c 2> /dev/null ; then\n         AC_MSG_RESULT(yes)\n         CC=$GMP_CC\n         CFLAGS=$GMP_CFLAGS\n      else\n         AC_MSG_RESULT(no)\n      fi\n   fi\n```\n\n\n\n\nI ended up with\n\n```\n...\nchecking for egrep... /bin/grep -E\nchecking for a sed that does not truncate output... /bin/sed\nchecking for CC and CFLAGS in gmp.h... yes CC= CFLAGS=\nchecking for gcc... gcc\nchecking whether the C compiler works... no\nconfigure: error: in `$SAGE_BUILD_DIR/mpc-1.0.p0/src':\nconfigure: error: C compiler cannot create executables\nSee `config.log' for more details\nError configuring MPC.\n\nreal\t0m1.737s\nuser\t0m0.032s\nsys\t0m0.068s\n************************************************************************\nError installing package mpc-1.0.p0\n************************************************************************\n```\n(because `gcc` didn't work with `$CFLAGS` either, while `$CC` or `__GMP_CC` from `gmp.h` would have worked).\n\n(In the mpc-1.0.p0 spkg, we already use[d] the related [upstream patch](https://gforge.inria.fr/tracker/?func=detail&group_id=131&aid=14669&atid=607) (included in MPC 1.0.1) fixing [a slightly different issue](http://trac.sagemath.org/ticket/13290#comment:13) with `GMP_CC` and `GMP_CFLAGS`, so the same holds for MPC 1.0.2.)",
    "created_at": "2014-04-25T15:53:00Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199452",
    "user": "https://github.com/nexttime"
}
```

Ah, the problem arises when *none of* `/lib/cpp gcc cc c99` work (with `$CPPFLAGS`), since then `GMP_CC` and `GMP_CFLAGS` will remain **empty**, and / but

```sh
test "x$GMP_CFLAGS" = "x__GMP_CFLAGS" -o "x$GMP_CC" = "x__GMP_CC"
```
yields `false`, and

```sh
      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])
```
is executed, but **not** what follows (since `test -n "$GMP_CC$GMP_CFLAGS"` yields `false`):

```sh
   # Check for validity of CC and CFLAGS obtained from gmp.h
   if test -n "$GMP_CC$GMP_CFLAGS" ; then
      AC_MSG_CHECKING(for CC=$GMP_CC and CFLAGS=$GMP_CFLAGS)
      echo "int main (void) { return 0; }" > conftest.c
      if $GMP_CC $GMP_CFLAGS -o conftest conftest.c 2> /dev/null ; then
         AC_MSG_RESULT(yes)
         CC=$GMP_CC
         CFLAGS=$GMP_CFLAGS
      else
         AC_MSG_RESULT(no)
      fi
   fi
```




I ended up with

```
...
checking for egrep... /bin/grep -E
checking for a sed that does not truncate output... /bin/sed
checking for CC and CFLAGS in gmp.h... yes CC= CFLAGS=
checking for gcc... gcc
checking whether the C compiler works... no
configure: error: in `$SAGE_BUILD_DIR/mpc-1.0.p0/src':
configure: error: C compiler cannot create executables
See `config.log' for more details
Error configuring MPC.

real	0m1.737s
user	0m0.032s
sys	0m0.068s
************************************************************************
Error installing package mpc-1.0.p0
************************************************************************
```
(because `gcc` didn't work with `$CFLAGS` either, while `$CC` or `__GMP_CC` from `gmp.h` would have worked).

(In the mpc-1.0.p0 spkg, we already use[d] the related [upstream patch](https://gforge.inria.fr/tracker/?func=detail&group_id=131&aid=14669&atid=607) (included in MPC 1.0.1) fixing [a slightly different issue](http://trac.sagemath.org/ticket/13290#comment:13) with `GMP_CC` and `GMP_CFLAGS`, so the same holds for MPC 1.0.2.)



---

archive/issue_comments_199453.json:
```json
{
    "body": "I'm posting an answer from Andreas Enge, MPC developer:\n\n\nDoes the following patch solve the problem for you?\n\n```diff\n--- m4/mpc.m4   (revision 1450)\n+++ m4/mpc.m4   (working copy)\n@@ -1,6 +1,6 @@\n # mpc.m4\n #\n-# Copyright (C) 2008, 2009, 2010, 2011, 2012 INRIA\n+# Copyright (C) 2008, 2009, 2010, 2011, 2012, 2014 INRIA\n #\n # This file is part of GNU MPC.\n #\n@@ -127,9 +127,12 @@\n AC_DEFUN([MPC_GMP_CC_CFLAGS], [\n    AC_MSG_CHECKING(for CC and CFLAGS in gmp.h)\n    # AC_PROG_CPP triggers the search for a C compiler; use hack instead\n-   for cpp in /lib/cpp gcc cc c99\n+   for cpp in $CPP cpp gcc /lib/cpp cc c99\n    do\n-      test $cpp = /lib/cpp || cpp=\"$cpp -E\"\n+     case $cpp in\n+       *cpp*) ;;\n+       *) cpp=\"$cpp -E\" ;;\n+     esac\n       echo foo > conftest.c\n       if $cpp $CPPFLAGS conftest.c > /dev/null 2> /dev/null ; then\n          # Get CC\n```\n\nIt brings things a bit closer to mpfr and adds `$CPP` to the list of possible\npreprocessors.\n\nIf yes, I can push it to the mpc trunk.\n\nThanks in advance,\n\nAndreas",
    "created_at": "2014-05-09T11:53:47Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199453",
    "user": "https://github.com/jdemeyer"
}
```

I'm posting an answer from Andreas Enge, MPC developer:


Does the following patch solve the problem for you?

```diff
--- m4/mpc.m4   (revision 1450)
+++ m4/mpc.m4   (working copy)
@@ -1,6 +1,6 @@
 # mpc.m4
 #
-# Copyright (C) 2008, 2009, 2010, 2011, 2012 INRIA
+# Copyright (C) 2008, 2009, 2010, 2011, 2012, 2014 INRIA
 #
 # This file is part of GNU MPC.
 #
@@ -127,9 +127,12 @@
 AC_DEFUN([MPC_GMP_CC_CFLAGS], [
    AC_MSG_CHECKING(for CC and CFLAGS in gmp.h)
    # AC_PROG_CPP triggers the search for a C compiler; use hack instead
-   for cpp in /lib/cpp gcc cc c99
+   for cpp in $CPP cpp gcc /lib/cpp cc c99
    do
-      test $cpp = /lib/cpp || cpp="$cpp -E"
+     case $cpp in
+       *cpp*) ;;
+       *) cpp="$cpp -E" ;;
+     esac
       echo foo > conftest.c
       if $cpp $CPPFLAGS conftest.c > /dev/null 2> /dev/null ; then
          # Get CC
```

It brings things a bit closer to mpfr and adds `$CPP` to the list of possible
preprocessors.

If yes, I can push it to the mpc trunk.

Thanks in advance,

Andreas



---

archive/issue_comments_199454.json:
```json
{
    "body": "Replied off-trac:\n\n```\n...\nShould work for me (will test later),\nbut $cpp should be quoted in 'case $cpp in ...',\nand $CPP in the 'for' statement.\n\nYou could also go with\n\n    for cpp in \"$CPP\" cpp \"gcc -E\" /lib/cpp \"cc -E\" \"c99 -E\"\n\nand drop adding '-E' below.\n...\n```",
    "created_at": "2014-05-09T12:54:55Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199454",
    "user": "https://github.com/nexttime"
}
```

Replied off-trac:

```
...
Should work for me (will test later),
but $cpp should be quoted in 'case $cpp in ...',
and $CPP in the 'for' statement.

You could also go with

    for cpp in "$CPP" cpp "gcc -E" /lib/cpp "cc -E" "c99 -E"

and drop adding '-E' below.
...
```



---

archive/issue_comments_199455.json:
```json
{
    "body": "P.S.:\n\n```sh\n   if test \"x$GMP_CFLAGS\" = \"x__GMP_CFLAGS\" -o \"x$GMP_CC\" = \"x__GMP_CC\" ; then\n      AC_MSG_RESULT(no)\n      GMP_CC=\n      GMP_CFLAGS=\n   else\n      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])\n   fi\n```\ncould be changed to something like\n\n```sh\n   if test -z \"$GMP_CFLAGS$GMP_CC\" ; then\n      AC_MSG_RESULT([no, no working preprocessor found; CPP=$CPP CPPFLAGS=$CPPFLAGS])\n   elif test \"x$GMP_CFLAGS\" = \"x__GMP_CFLAGS\" -o \"x$GMP_CC\" = \"x__GMP_CC\" ; then\n      AC_MSG_RESULT(no)\n      GMP_CC=\n      GMP_CFLAGS=\n   else\n      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])\n   fi\n```",
    "created_at": "2014-05-09T13:16:32Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199455",
    "user": "https://github.com/nexttime"
}
```

P.S.:

```sh
   if test "x$GMP_CFLAGS" = "x__GMP_CFLAGS" -o "x$GMP_CC" = "x__GMP_CC" ; then
      AC_MSG_RESULT(no)
      GMP_CC=
      GMP_CFLAGS=
   else
      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])
   fi
```
could be changed to something like

```sh
   if test -z "$GMP_CFLAGS$GMP_CC" ; then
      AC_MSG_RESULT([no, no working preprocessor found; CPP=$CPP CPPFLAGS=$CPPFLAGS])
   elif test "x$GMP_CFLAGS" = "x__GMP_CFLAGS" -o "x$GMP_CC" = "x__GMP_CC" ; then
      AC_MSG_RESULT(no)
      GMP_CC=
      GMP_CFLAGS=
   else
      AC_MSG_RESULT(yes [CC=$GMP_CC CFLAGS=$GMP_CFLAGS])
   fi
```



---

archive/issue_comments_199456.json:
```json
{
    "body": "The GMP `CC` / `CFLAGS` issue with `cpp` (or rather `CPPFLAGS` not working with the ones from the list) is now [fixed upstream](https://gforge.inria.fr/scm/viewvc.php?view=rev&root=mpc&revision=1451) (MPC 1.1 branch); cf. [https://gforge.inria.fr/tracker/index.php?func=detail&aid=17410&group_id=131&atid=607](https://gforge.inria.fr/tracker/index.php?func=detail&aid=17410&group_id=131&atid=607).\n\nI'll perhaps open a follow-up ticket including that upstream patch, but it's a minor issue anyway (which apparently only hits *me* on occasion).",
    "created_at": "2014-05-12T16:13:44Z",
    "issue": "https://github.com/sagemath/sagetest/issues/15460",
    "type": "issue_comment",
    "url": "https://github.com/sagemath/sagetest/issues/15460#issuecomment-199456",
    "user": "https://github.com/nexttime"
}
```

The GMP `CC` / `CFLAGS` issue with `cpp` (or rather `CPPFLAGS` not working with the ones from the list) is now [fixed upstream](https://gforge.inria.fr/scm/viewvc.php?view=rev&root=mpc&revision=1451) (MPC 1.1 branch); cf. [https://gforge.inria.fr/tracker/index.php?func=detail&aid=17410&group_id=131&atid=607](https://gforge.inria.fr/tracker/index.php?func=detail&aid=17410&group_id=131&atid=607).

I'll perhaps open a follow-up ticket including that upstream patch, but it's a minor issue anyway (which apparently only hits *me* on occasion).
