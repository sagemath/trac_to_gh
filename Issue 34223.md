# Issue 34223: Fix tests with ipywidgets 8

Issue created by migration from https://trac.sagemath.org/ticket/34460

Original creator: arojas

Original creation time: 2022-08-30 18:44:44

CC:  mkoeppe fbissey tornaria @collares vbraun egourgoulhon




---

Comment by arojas created at 2022-08-30 18:51:18

New commits:


---

Comment by arojas created at 2022-08-30 18:51:18

Changing status from new to needs_review.


---

Comment by arojas created at 2022-08-30 18:51:18

Changing type from PLEASE CHANGE to enhancement.


---

Comment by arojas created at 2022-08-30 18:51:18

Changing component from PLEASE CHANGE to packages: standard.


---

Comment by @collares created at 2022-09-22 19:34:24

Not 100% sure this is related, but after upgrading jupyter-widgets and related packages I am seeing 21 failing tests in `src/sage/interacts/test_jupyter.rst`. They all have control sequences/escape characters such as:


```
sage -t --long --random-seed=250623221176838603645666806457165844244 /nix/store/39k0iiwx3wi7jikqnzbqh7hrrlpivm78-sage-src-9.7/src/sage/interacts/test_jupyter.rst
**********************************************************************
File "/nix/store/39k0iiwx3wi7jikqnzbqh7hrrlpivm78-sage-src-9.7/src/sage/interacts/test_jupyter.rst", line 180, in sage.interacts.test_jupyter
Failed example:
    test(interacts.calculus.bisection_method)
Expected:
    Interactive function <function bisection_method at ...> with 5 widgets
      title: HTMLText(value='<h2>Bisection method</h2>')
      f: EvalText(value='x^2-2', description='f(x)', layout=Layout(max_width='81em'))
      interval: IntRangeSlider(value=(0, 4), description='range', max=5, min=-5)
      d: IntSlider(value=3, description='$10^{-d}$ precision', max=8, min=1)
      maxn: IntSlider(value=10, description='max iterations', max=50)
    \(\text{Precision }h = 10^{-d}=10^{-3}=0.00100\)
    \({c = }1.4140625\)
    \({f(c) = }-0.00042724609375\)
    \(9 \text{ iterations}\)
Got:
    <CSI-2K>^M<CSI-2K>^M\(\text{Precision }h = 10^{-d}=10^{-3}=0.00100\)
    \({c = }1.4140625\)
    \({f(c) = }-0.00042724609375\)
    \(9 \text{ iterations}\)
    Interactive function <function bisection_method at 0x7fff88569630> with 5 widgets
      title: HTMLText(value='<h2>Bisection method</h2>')
      f: EvalText(value='x^2-2', description='f(x)', layout=Layout(max_width='81em'))
      interval: IntRangeSlider(value=(0, 4), description='range', max=5, min=-5)
      d: IntSlider(value=3, description='$10^{-d}$ precision', max=8, min=1)
      maxn: IntSlider(value=10, description='max iterations', max=50)
    \(\text{Precision }h = 10^{-d}=10^{-3}=0.00100\)
    \({c = }1.4140625\)
    \({f(c) = }-0.00042724609375\)
    \(9 \text{ iterations}\)
**********************************************************************
File "/nix/store/39k0iiwx3wi7jikqnzbqh7hrrlpivm78-sage-src-9.7/src/sage/interacts/test_jupyter.rst", line 192, in sage.interacts.test_jupyter
Failed example:
    test(interacts.calculus.riemann_sum)
Expected:
    Manual interactive function <function riemann_sum at ...> with 9 widgets
      title: HTMLText(value='<h2>Riemann integral with random sampling</h2>')
      f: EvalText(value='x^2+1', description='$f(x)=$', layout=Layout(max_width='41em'))
      n: IntSlider(value=5, description='# divisions', max=30, min=1)
      hr1: HTMLText(value='<hr>')
      interval_input: ToggleButtons(description='Integration interval', options=('from slider', 'from keyboard'), value='from slider')
      interval_s: IntRangeSlider(value=(0, 2), description='slider: ', max=10, min=-5)
      interval_g: Grid(value=[[0, 2]], children=(Label(value='keyboard: '), VBox(children=(EvalText(value='0', layout=Layout(max_width='5em')),)), VBox(children=(EvalText(value='2', layout=Layout(max_width='5em')),))))
      hr2: HTMLText(value='<hr>')
      list_table: Checkbox(value=False, description='List table')
    <small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=...\)
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} +
    1\,\mathrm{d}x=4.666666666666668\)
Got:
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.127671780067391\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.684039567609587\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.477886877874835\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=5.613881858984628\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=6.228858742666399\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.598306339045656\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.45910993544406\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=5.285792626236389\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=5.348125253390601\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=5.376388761226274\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=3.823901934033623\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=5.424469987768077\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=6.089305916730408\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.340945220537433\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=3.98349497390619\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.803422027740802\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.42705500648823\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=6.256746951601706\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=6.051441325477226\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=3.8867582141357317\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=5.553517548071945\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    <CSI-2K>^M<CSI-2K>^M<small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.313714559213407\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
    Manual interactive function <function riemann_sum at 0x7fff8856b880> with 9 widgets
      title: HTMLText(value='<h2>Riemann integral with random sampling</h2>')
      f: EvalText(value='x^2+1', description='$f(x)=$', layout=Layout(max_width='41em'))
      n: IntSlider(value=5, description='# divisions', max=30, min=1)
      hr1: HTMLText(value='<hr>')
      interval_input: ToggleButtons(description='Integration interval', options=('from slider', 'from keyboard'), value='from slider')
      interval_s: IntRangeSlider(value=(0, 2), description='slider: ', max=10, min=-5)
      interval_g: Grid(value=[[0, 2]], children=(Label(value='keyboard: '), VBox(children=(EvalText(value='0', layout=Layout(max_width='5em')),)), VBox(children=(EvalText(value='2', layout=Layout(max_width='5em')),))))
      hr2: HTMLText(value='<hr>')
      list_table: Checkbox(value=False, description='List table')
    <small>Adjust your data and click Update button. Click repeatedly for another random values.</small>
    Riemann sum: \(\displaystyle\sum_{i=1}^{5} f(\eta_i)(x_i-x_{i-1})=4.530774274990167\) 
    Exact value of the integral \(\displaystyle\int_{0}^{2}x^{2} + 1\,\mathrm{d}x=4.666666666666668\)
```

Looks like some code is not testing if the terminal is capable of processing those escape sequences.


---

Comment by @collares created at 2022-09-24 03:41:02

On ipywidgets 7, replacing `on_displayed` by `on_widget_constructed` causes test failures. Removing the `on_displayed` lines altogether, however, passes tests (I haven't checked the actual interactive widgets, though):

```diff
diff --git a/src/sage/combinat/cluster_algebra_quiver/interact.py b/src/sage/combinat/cluster_algebra_quiver/interact.py
index 1c88e613b4..f74039213c 100644
--- a/src/sage/combinat/cluster_algebra_quiver/interact.py
+++ b/src/sage/combinat/cluster_algebra_quiver/interact.py
@@ -107,8 +107,6 @@ def cluster_interact(self, fig_size=1, circular=True, kind='seed'):
     show_lastmutation.observe(refresh, 'value')
     which_plot.observe(refresh, 'value')
 
-    mut_buttons.on_widget_constructed(refresh)
-
     if kind == 'seed':
         top = widgets.HBox([show_seq, show_vars])
     else:
diff --git a/src/sage/repl/ipython_kernel/interact.py b/src/sage/repl/ipython_kernel/interact.py
index 4f96a212ab..23699601a3 100644
--- a/src/sage/repl/ipython_kernel/interact.py
+++ b/src/sage/repl/ipython_kernel/interact.py
@@ -124,10 +124,7 @@ class sage_interactive(interactive):
 
         self.__signature = sig.replace(parameters=params.values())
         super().__init__(f, options, **kwds)
-        if self.manual:
-            # In Sage, manual interacts are always run once
-            self.on_widget_constructed(self.update)
-        else:
+        if not self.manual:
             # In automatic mode, clicking on a ToggleButtons button
             # should also run the interact
             for widget in self.kwargs_widgets:
```


Calling `self.update()` instead of deleting the second `on_widget_constructed` prints an extra line and causes test failures on ipywidgets 7 (calling `refresh(None)` manually does not cause test failures, but it would be a bit asymmetrical to do so).

On ipywidgets 8, the 20 occurrences of "Interactive function" in `src/sage/interacts/test_jupyter.rst` need to be replaced by "...Interactive function", similar to other changes made in this branch. With this replacement and the above patch, there is a single test failure caused by a doctest warning appearing in the wrong order:


```
Failed example:
    test(interacts.statistics.coin)
Expected:
    ...Interactive function <function coin at ...> with 2 widgets
      n: IntSlider(value=1000, description='Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description='Plotting range (y)', max=1)
    doctest:...: UserWarning: Attempting to set identical bottom == top == 0.0 results in singular transformations; automatically expanding.
Got:
doctest:warning
[...]
    :
    UserWarning: Attempting to set identical bottom == top == 0.0 results in singular transformations; automatically expanding.
    Interactive function <function coin at 0x7fff8872f250> with 2 widgets
      n: IntSlider(value=1000, description='Number of Tosses', max=10000, min=2, step=100)
      interval: IntRangeSlider(value=(0, 0), description='Plotting range (y)', max=1)
```


(`[...]` indicates lines I deleted for brevity).


---

Comment by arojas created at 2022-09-24 08:02:49

Replying to [comment:5 Mauricio Collares]:
> On ipywidgets 7, replacing `on_displayed` by `on_widget_constructed` causes test failures.

Since this ticket missed 9.7 and is now aimed at 9.8, I think we can just turn it into an actual upgrate ticket and not worry about ipywidgets 7 compatibility.


> Removing the `on_displayed` lines altogether, however, passes tests (I haven't checked the actual interactive widgets, though):

I did test the widget, and removing `on_displayed` made the graph not be populated on load, until you click one of the buttons.

> On ipywidgets 8, the 20 occurrences of "Interactive function" in `src/sage/interacts/test_jupyter.rst` need to be replaced by "...Interactive function", similar to other changes made in this branch.

Thanks, I only test the installed bits so that explains why I missed those.

> With this replacement and the above patch, there is a single test failure caused by a doctest warning appearing in the wrong order:

Where is the `doctest:...` line in the expected output coming from? It's neither in the current code nor in this branch.


---

Comment by arojas created at 2022-09-24 08:20:02

Replying to [comment:6 Antonio Rojas]:
> Where is the `doctest:...` line in the expected output coming from? It's neither in the current code nor in this branch.

Nevermind, I was looking at the wrong file


---

Comment by git created at 2022-09-24 20:49:24

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by @collares created at 2022-09-25 01:42:49

Thank you for the update! I can confirm that tests now pass with ipywidgets 8.


---

Comment by fbissey created at 2022-09-25 04:15:32

Changing status from needs_review to positive_review.


---

Comment by fbissey created at 2022-09-25 04:15:32

Works for me too.


---

Comment by git created at 2022-09-25 06:38:50

Branch pushed to git repo; I updated commit sha1 and set ticket back to needs_review. New commits:


---

Comment by git created at 2022-09-25 06:38:50

Changing status from positive_review to needs_review.


---

Comment by git created at 2022-09-25 07:00:06

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by arojas created at 2022-09-25 07:02:03

What's the deal with `jupyterlab_widgets`? It should be updated too, but I don't see any version information in `build/pkgs/jupyterlab_widgets`


---

Comment by mkoeppe created at 2022-09-25 16:00:20

Currently `jupyterlab_widgets` is a pip package https://doc.sagemath.org/html/en/developer/packaging.html#package-source-types; version constraints would be in requirements.txt, but we have not set any. So it's just taking the most current version from PyPI.


---

Comment by arojas created at 2022-09-29 19:34:24

Latest changes in `build/pkgs` need review


---

Comment by fbissey created at 2022-09-29 19:54:44

Yes, I hadn't looked at the building side of it. After inspection it looks alright to me.


---

Comment by fbissey created at 2022-09-29 19:54:44

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-10-09 18:36:19

Changing status from positive_review to needs_work.


---

Comment by mkoeppe created at 2022-10-09 18:36:19

With this ticket, I am getting docbuild failures:

```
  [sagemath_doc_html-none]   pkg_resources.DistributionNotFound: The 'jupyterlab-widgets~=3.0' distribution was not found and is required by ipywidgets
  [sagemath_doc_html-none]   Traceback (most recent call last):
  [sagemath_doc_html-none]     File "/sage/local/var/lib/sage/venv-python3.10/bin/sage-venv-config", line 4, in <module>
  [sagemath_doc_html-none]       __import__('pkg_resources').require('sagemath-standard==9.8b1')
```

https://github.com/mkoeppe/sage/actions/runs/3209136265/jobs/5250533818


---

Comment by mkoeppe created at 2022-10-09 19:09:27

I think we need to make `jupyterlab_widgets` a standard package. This can now be a "wheel" package (#34450)


---

Comment by mkoeppe created at 2022-10-09 19:18:24

New commits:


---

Comment by git created at 2022-10-09 19:21:25

Branch pushed to git repo; I updated commit sha1. New commits:


---

Comment by mkoeppe created at 2022-10-09 19:22:01

Changing status from needs_work to needs_review.


---

Comment by mkoeppe created at 2022-10-18 02:09:52

Let's get this in please


---

Comment by egourgoulhon created at 2022-10-18 20:36:43

LGTM. In particular, I've tested it atop of Sage 9.8.beta2 with this notebook:

https://github.com/egourgoulhon/SageMathTest/blob/master/Notebooks/test_display.ipynb

both with Jupyter notebook and with Jupyterlab. 
I've installed Jupyterlab after merging the ticket branch via simply

```
sage -i jupyterlab
```

I thus confirm that, thanks to this ticket, there is no need to run `sage -i jupyterlab_widgets`.

NB: to run `%matplotlib widget` (cf. cell 20 of the above notebook), I had to install manually `ipympl` via `sage -pip install ipympl`.


---

Comment by egourgoulhon created at 2022-10-18 20:36:43

Changing status from needs_review to positive_review.


---

Comment by mkoeppe created at 2022-10-18 22:23:47

Thanks!


---

Comment by vbraun created at 2022-10-23 20:49:31

Resolution: fixed
